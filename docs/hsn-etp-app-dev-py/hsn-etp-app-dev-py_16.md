# 第十六章：微服务和企业应用集成

微服务架构的引入彻底改变了企业应用程序的视角。这些应用程序不再是大型的单体或提供特定领域问题解决功能的大型服务。相反，现在我们有小型的微服务，每个提供特定的功能集。

这些小型微服务通过网络相互通信，以提供与组织业务需求相对应的特定输出。

随着我们在本章中的深入，我们将看到传统的企业应用集成（EAI）的传统方法正在被微服务的使用所淘汰，微服务引入了新的集成模式，由小型、无状态的消息代理组成，而不是一个庞大而复杂的企业服务总线。

客户端之间的通信现在已经被 API 网关取代，API 网关提供了客户端和后端微服务之间的联合。

作为本章的读者，您将学习以下内容：

+   微服务和 EAI 景观的变化

+   企业服务总线的转变

+   以微服务架构思考 EAI

# 技术要求

这一章建立在第十一章 *采用微服务方法* 和 第十五章 *企业应用集成及其模式* 的内容之上。因此，阅读本章的内容并不需要特殊的硬件或软件，但对分布式消息代理和异步消息系统的一些了解将有助于在阅读本章时提供更广泛的背景。

# 微服务和不断变化的 EAI 景观

最近，组织开始转向一种新的应用程序开发方法。这种方法侧重于开发由多个提供单一功能并且提供良好的小型服务组成的应用程序。这些小型服务被称为微服务。

这些微服务模拟了企业领域的一个子集的功能。例如，基础设施中可能有一个负责处理用户凭据和身份验证的服务，另一个可能负责处理电子邮件的功能，还有另一个处理员工工资的服务。

所有这些服务通过消息传递的机制或通过使用服务暴露的 API 从一个服务向另一个服务发出 API 调用来进行网络通信，以实现特定的用例。

与传统应用程序相比，传统应用程序通常庞大，并且需要中间件来处理数据从一个应用程序支持的格式到另一个应用程序支持的格式的转换，然后安全地传输这些数据，微服务要求通过 API 直接与其他服务通信，或者通过小型消息代理将数据以消息的形式从一个微服务传输到另一个微服务。

这改变了企业应用集成的方式，因为现在基础设施中没有复杂的中间件解决方案，提供粘合层来连接基础设施内的不同应用程序。

因此，让我们看看为什么传统方法在微服务架构中不起作用，并尝试理解出现的新替代方案，以促进企业应用程序的集成。

# 微服务中传统 EAI 的挑战

在通过现代的小型微服务开发实践开发、将它们托管在企业基础设施上，然后将它们集成在一起进行通信的应用程序中，我们不能再使用我们在运行和维护大型单片应用程序或服务时熟悉的传统方法。让我们先花点时间了解为什么点对点集成在微服务的情况下可能行不通。

# 微服务的点对点集成

在微服务的点对点集成方法中，我们使微服务直接通过它们暴露的 API 相互交互。为了实现这一点，每个微服务都需要了解其他服务暴露的端点。这是完全可以的，但是如果微服务需要执行依赖于与其他五个微服务交互的操作会发生什么呢？

在这一点上，我们必须将五个不同微服务的端点嵌入到我们的微服务中。作为一项一次性任务，这是一个完全可以接受的解决方案。但是，由于微服务的性质，它们会随着时间不断发展。这现在导致我们不断更新我们的微服务，以反映更新的 API。

这只是其中一个挑战。通常，基于微服务架构的应用程序会随着时间的推移而增长，拥有超过 100 个在基础设施中运行的服务，这使得在不同的微服务之间实现点对点集成变得非常困难。

那么，现在我们知道了微服务不能通过点对点集成来集成，我们能否使用老式的企业服务总线？让我们来看看。

# 使用 ESB 集成微服务

企业服务总线通常提供一个中间总线，通过该总线，两个应用程序可以通过消息传递机制进行通信。这个 ESB 还有一个标准格式，可以在发送之前对消息进行编码。

现在，我们可以将我们的微服务连接到 ESB，然后这些服务可以通过传递消息进行通信。这种方法是完全可以的，也是有效的。但是，当微服务的数量开始在基础设施中增长时，真正的问题开始出现。一旦发生这种情况，ESB 就会因为传输的大量消息而开始承受沉重的负载。

ESB 无法扩展的另一个原因...

# 利用 API 网关集成微服务

在微服务架构中使用 API 网关提供了一种非常有趣的方法来解决微服务集成问题，同时也遵循了应用程序集成的模式之一，即通过使用联合网关。因此，让我们看看 API 网关如何帮助我们进行微服务集成的过程。

微服务架构中的 API 网关充当中心点，通过它，微服务可以与基础设施中的其他微服务进行交互。这个 API 网关提供以下特点：

+   **API 的受限暴露：** API 网关提供了仅从后端微服务中暴露一组受限 API 的功能，因此限制了暴露的功能。除此之外，API 网关还可以在基础设施中引入新的 API 端点，其中每个 API 端点可以映射到后端微服务的多个 API 端点。

+   **联合访问：** API 网关实现了微服务的联合访问。这是因为，如果任何两个服务想要相互交互，需要向 API 网关发出调用，API 网关将确实向其他微服务发出请求，并从微服务中提供结果。

+   **请求的转换：**API 网关还负责在微服务之间转换请求，如果它们都使用不同的数据表示机制。为了进行这种转换，API 网关通常实现了一个通用的数据格式，每个服务都可以使用它来处理与 API 网关的通信，这个概念通常由 ESB 实现。

通过使用 API 网关进行微服务集成，不同微服务之间的通信过程如下：

+   想象一下有两个微服务，*A*和*B*

+   微服务*A*希望通知微服务*B*某个事件已经发生，这是某个调用或其他外部事件的结果

+   微服务*A*调用 API 网关暴露的微服务*B*的端点

+   API 网关接收请求，对请求进行任何类型的转换，并将调用转发给微服务**B**

+   API 网关现在等待来自微服务*B*的响应返回

+   一旦响应返回，API 网关将响应转换为微服务*A*支持的格式，并将响应返回，完成循环

其他服务通常也会遵循这种过程。

使用 API 网关集成微服务相比传统方法提供了许多优势，如以下示例所示：

+   **提高安全性：**由于 API 网关限制了后端 API 的暴露，API 网关在不同微服务之间提供更好的安全性。通过在不同微服务和 API 网关之间的通信中实现简单的端到端加密，也可以增加安全性。

+   **更好的可扩展性：**API 网关通过使用负载均衡器允许动态扩展，提供比传统基于中间件的方法更好的可扩展性。多个 API 网关进程可以在负载均衡器后运行，最终分发到它们的请求。

+   **更容易维护：**与使用 API 网关集成的应用通常更容易维护，因为它们需要单独管理的 API 端点数量减少了。

这些都是一些很大的好处，看起来是集成基于微服务的应用的一个很好的方法。那么，我们不再需要 ESB 了吗？ESB 已经消失了吗？

答案是否定的。相反，随着微服务的出现，它已经发生了变化。让我们看看这种转变是什么样子的。

# ESB 的转变

随着微服务革命的出现，企业服务总线也发生了变化，现在已经被一些类似的解决方案所取代，但具有更好的可扩展性和去除单点故障的优势。

应用集成中的 ESB 曾经扮演着中央总线的角色，作为希望相互通信的应用之间的中介。ESB 通过引入通用数据格式并提供适配器来促进这种通信，应用可以通过这些适配器与 ESB 进行通信。

但 ESB 仍然存在两个主要缺点：

+   **可扩展性：** ESB 是一种沉重的中间件，需要专门化才能使用……

# 在微服务中重新思考 EAI

有了微服务的参与，他们拥有自己的工具和不同的要求，我们现在必须重新思考企业基础设施中的 EAI 方法。因此，让我们看看在考虑基于微服务的基础设施中的应用集成时需要注意的一些要点：

+   **扩展规划：**微服务基础架构内的应用不断发展，它们的集成需要以相同的方式进行规划。在考虑集成策略时，我们需要确保它能够支持我们应用的未来规模和应用可能需要的通信类型。

+   **定义 API：**微服务暴露的 API 在不同应用的集成中起着重要作用。在开始开发微服务之前，应该充分规划和记录其 API，以便与其他服务更顺畅地集成。

+   **保持数据格式标准：**不同微服务管理数据的数据格式应该标准化，只有少量格式，以便实现简单的集成和减少基础架构的复杂性。

# 总结

在本章的过程中，我们看了一下微服务作为企业应用开发方法的引入是如何彻底改变企业内部应用集成方式的。

我们看了一下当传统的企业应用集成方法应用到微服务架构时会失败，然后我们看了一下在引入 API 网关和分布式消息路由器后，EAI 的转变是如何发生的。

在本章结束时，我们看了一下随着我们转向基于微服务的方法，企业应用集成的规划发生了什么变化。

从这里，我们现在对不同方面有了一个概念...

# 问题

1.  微服务应用中点对点集成的瓶颈是什么？

1.  企业服务总线在微服务出现后发生了什么变化？

1.  微服务架构内的消息代理如何提供高可用性？
