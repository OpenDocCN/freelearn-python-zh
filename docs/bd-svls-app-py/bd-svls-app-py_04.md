# 第四章：部署无服务器 API

到目前为止，我们在学习无服务器应用程序和构建无服务器工程方面已经走了很长一段路。我们已经了解了无服务器范例的实际含义，AWS Lambda 函数的工作原理，了解了 AWS Lambda 的内部工作原理，以及对多个触发器的详细了解。我们还围绕尝试触发器并将它们部署为端到端无服务器流水线进行了几个迷你项目。

在本章中，您将学习如何使用 AWS Lambda 和 AWS API 网关服务构建高效可扩展的无服务器 API。我们将从了解 API 网关的工作原理开始，而不是直接构建无服务器 API。之后，我们将了解 API 网关和 AWS Lambda 如何相互集成。最后，作为本章学习的一部分，我们将创建和部署一个完全功能的无服务器 API。

本章涵盖以下主题：

+   API 方法和资源

+   设置集成

+   部署用于 API 执行的 Lambda 函数

+   处理身份验证和用户控制

# API 方法和资源

在本节中，我们将学习 AWS 的 API 服务，即 API 网关，并了解控制台中为创建 API 的用户提供的组件和设置。我们将浏览所有组件并更好地了解 API 网关。创建无服务器 API 的步骤如下：

1.  我们将从打开 API 网关控制台开始，它看起来像这样：

![](img/77983079-abbd-4875-851d-6e09321bdc6c.png)

1.  在 API 网关控制台上，单击“开始”按钮开始创建 API。它将带您进入一个 API 创建向导，弹出窗口上显示“创建示例 API”：

![](img/8453d058-8208-40d0-8c88-c518a75b43d0.png)

1.  单击“确定”按钮后，您将被重定向到一个页面，显示示例 API，从中您可以了解 API 响应的样子：

![](img/8a58f0ab-0c83-4c3b-a724-d6b68316d241.png)

我们在此示例中构建的 API 是用于宠物商店和维护商店内宠物的。通过浏览 API，您将看到 API 的各个部分是什么样子。API 如下所示：

![](img/1850eb9c-f409-44c6-a7a8-56e6754e29bf.png)

1.  单击末尾的“导入”按钮后，您将被重定向到我们刚刚创建的 PetStore（b7exp0d681）API 页面。具有所有组件的 API 页面如下所示：

![](img/314f78ff-589d-4cd6-b632-7989087b0f9c.png)

1.  该 API 中的资源是 GET 和 POST 资源，您可以在其中添加宠物并查看宠物，它们作为列表可用。我们创建的 API 的资源列表如下：

![](img/6cf3936a-cc2f-46cf-b706-090012aee0ea.png)

1.  通过单击第一个 GET 资源，我们可以看到从客户端到端点再返回客户端的详细执行流程。资源的执行流程如下所示：

![](img/f473698f-c3d1-4c97-a106-a7d2eebecb55.png)

1.  现在，如果我们单击 POST 资源，我们将找到与 POST 资源相似的模型执行流程。它看起来与 GET 资源非常相似，但是这里 API 端点被指定为 URL，因为我们正在尝试从中检索结果。执行模型如下所示：

![](img/0c4d2b07-3fa4-4230-ad87-fda3eb91fb73.png)

在 API 网关中，有一种称为 Stages 的东西，可以用作 API 的版本模型。实际上，Stages 的一些常见名称是**测试**，**开发**和**生产**。Stages 菜单如下所示：

![](img/862e05dd-969e-43ee-8d11-87e3174223fd.png)

1.  单击“创建”选项后，将打开一个阶段的创建向导。如下所示：

![](img/24dfbf47-6fa7-4e7a-bce3-c019246ad81c.png)

1.  您可以为阶段名称值选择任何名称，并根据您分配的名称和此阶段的目的添加阶段描述值。在此之前，您需要部署已创建的 API。这可以在“操作”下拉菜单中选择“部署 API”按钮来完成：

![](img/1f42a071-fc01-4eff-b37c-5f3c41c299d3.png)

1.  在下一个菜单中，您可以选择阶段名称和其他详细信息，然后最终单击“部署”按钮，这将使用特定阶段部署您的 API。如下所示：

![](img/f694b7f3-ae32-4f2e-9f5b-5bf35a054543.png)

部署的阶段如下所示：

![](img/13c5a18c-5468-4bce-9a6b-5b38c41659ca.png)

# 设置集成

现在，我们已经了解了 AWS API Gateway 服务的基本工作原理，我们将继续使用这些知识来构建一个涉及部署完全无服务器 API 的端到端项目。

在本节中，我们将从头开始构建和部署一个完全无服务器的 API 函数，并学习 AWS Lambda 与 AWS API Gateway 集成的内部和其他实现细节。我们将逐步构建无服务器 API。因此，请按照以下顺序进行操作。该过程如下：

1.  首先，我们将开始创建一个新的 API。这可以通过 Lambda 控制台完成，如下所示：

![](img/70ae1912-ad8b-499f-a057-7643a4028bb5.png)

1.  单击“+创建 API”按钮后，您将被重定向到 API 创建向导页面，在那里您将被要求输入您打算构建的 API 的名称和描述。目前，我已将名称输入为`TestLambdaAPI`。但是，您可以自由添加任何名称和描述。API 创建控制台如下所示：

![](img/547a9a71-871c-4385-b1e4-af300a8f7980.png)

1.  单击“创建 API”按钮后，您将被重定向到您创建的 API 页面。API 页面看起来类似于这样：

![](img/9062284a-2428-4469-b50b-b3d75a24e582.png)

1.  现在我们已经成功创建了一个 API，我们现在将继续在 API 中创建资源。您可以通过单击“操作”下拉菜单中的“创建资源”选项来执行此操作：

![](img/91bb7f8c-6aa0-42cd-9657-d7d3d26a801d.png)

1.  这将打开一个资源创建向导，在这里您可以添加我们打算构建的 API 资源的名称和资源路径。创建资源后，单击“创建资源”按钮，以便相应地创建 API 资源的设置。出于本教程的目的，我将其命名为`LambdaAPI`。但是，您可以随意命名。API 创建向导如下所示：

![](img/c1399e16-8ea2-4093-9731-40da3feafbd5.png)

您刚刚创建的资源现在在 API 控制台中处于活动状态；您可以在“资源”部分下看到它：

![](img/8d176ac4-5444-4d97-908b-377d008e9bf9.png)

1.  您可以创建资源的版本，甚至只是资源下的资源。让我们继续创建一个。为此，您需要单击已创建的资源，然后单击“操作”菜单中的下拉菜单中的“创建资源”选项：

![](img/7133db2c-ff1c-4d50-9f16-4ec673ec2f21.png)

1.  这将在我们已经创建的资源下打开一个类似的资源创建向导。您可以将该资源命名为`version1`或只是`v1`，这是一种常规的软件实践。我将其命名为`v1`。但是，您可以根据需要命名它：

![](img/ee774cc7-8eaa-4cfe-9b61-51654b86ffd6.png)

现在，我们在已有资源`/lambdaapi`下有一个名为`v1`的资源。我们可以在“资源”部分中看到这一点。因此，现在我们的 API 的资源层次结构如下：

![](img/3f05ee06-fdd4-4f28-9089-254cd78b0b5e.png)

1.  我们将为宠物商店创建一个无服务器 API，用于获取和查询宠物列表。因此，以下步骤将相应地对齐。API 应返回宠物的名称。因此，我们将为此创建一个新的宠物资源。我们将在`/v1`资源下创建一个资源：

![](img/942939eb-4f65-48bf-b506-3b0fb5a7bbb1.png)

1.  在将`/pets`资源添加到`/v1`资源下后，我们的 API 的层次结构如下：

![](img/c04c2044-ddb5-42ca-b54c-2ddd1236f97f.png)

1.  现在，我们将添加一个自定义资源，使我们能够查询 API。通过自定义，我们的意思是在向此 API 发送请求时，可以添加任何字符串到资源中，并且 API 会通过 Lambda 代码检查和查询该字符串后发送回一个请求。自定义资源可以与普通资源区分开，因为它们可以用大括号创建。以下截图将帮助您了解如何创建它们：

![](img/5664f793-4837-4cd6-856f-e83a0541f088.png)

1.  单击“创建资源”按钮后，将创建`/pets`的新自定义子资源。现在资源的层次结构如下：

![](img/48c41ba6-1303-4315-a62f-d2861059cf79.png)

1.  API 的整体结构如下，如下截图右上角所示：

![](img/783da33a-f27a-4981-965d-5d5fcf215529.png)

1.  现在，我们将为此自定义资源添加方法。因为我们只会查询宠物列表，所以我们只会添加 GET 方法。这可以通过单击{type}资源并在顶部面板的下拉“操作”菜单中单击“创建方法”来完成：

![](img/fc5dcff4-b616-48f4-a946-c1d94f887678.png)

1.  这将在{type}资源下创建一个小的下拉样式菜单，您可以从可用方法中选择一个方法：

![](img/f86516df-6431-4f81-8d74-837a5b629442.png)

1.  我们需要从可用选项中选择“GET”选项。这将如下所示：

![](img/7415aff4-6d63-4832-8736-fb8a7877e7e9.png)

1.  选择“GET”选项并单击旁边的小勾按钮后，我们将在我们的{type}资源下创建 GET 方法。现在的层次结构如下：

![](img/ef4c6cd9-0912-4457-8dec-95c6acf52921.png)

# 部署 Lambda 函数以执行 API

在本节中，我们将看一下部署 Lambda 函数的步骤：

1.  当您单击该方法时，还可以在 API 控制台的右侧看到 GET 方法的详细信息。详细信息如下：

![](img/6c67dfce-45f9-4648-8922-7b02b8eb568e.png)

1.  在 GET 方法控制台中，单击“Lambda 函数”选项。根据您的偏好选择任何一个地区。我选择了 us-east-1 作为地区，如下截图所示：

![](img/4ab15692-b5bf-4825-9b11-e15eef1bdd6f.png)

1.  正如预期的那样，它说我们在该地区没有 Lambda 函数。因此，我们需要继续创建一个。单击“创建 Lambda 函数”链接。这将带您到 Lambda 创建控制台，我们已经熟悉：

![](img/27281b9e-3209-4530-8784-256f386b2f18.png)

1.  从这里，从蓝图列表中选择关键字：hello-world-python 蓝图：

![](img/cc88530b-ba15-4927-8a60-a196fc2219da.png)

1.  在下一个控制台中，选择 Lambda 函数的基本信息，就像我们在之前的章节中所做的那样：

![](img/2983dee9-a909-4091-b017-3316de0044ef.png)

1.  添加相关细节后，单击橙色的“创建函数”按钮。这将带您到刚刚创建的 Lambda 函数的页面。代码可以从那里开始编辑：

![](img/96a0e196-367d-4920-8553-2a3e28bf186a.png)

1.  在函数的代码中，使用这段代码，而不是与蓝图一起提供的代码：

![](img/e675ac9d-79e7-4a7a-bb1f-b6decc56f2ce.png)

1.  我们现在已经调整了函数代码。现在，您可以继续保存函数：

![](img/aacde03a-2d88-4c33-8949-74da00fed010.png)

1.  现在，返回 API 网关控制台，转到 GET 方法页面。在此，在“us-east-1”区域的 Lambda 函数下，我开始获得刚刚创建的 Lambda 函数（无服务器 API）作为选项：

![](img/6e6d06af-02dc-4b95-ac11-a7e242aca617.png)

1.  单击“保存”后，您将看到一个弹出窗口，询问您是否确认授予 API 网关调用 Lambda 函数的权限，您可以单击“确定”来确认：

![](img/852f0f08-5d10-41e9-b073-94f4f2e49223.png)

1.  单击“确定”后，您将被重定向到 GET 方法的数据流页面，看起来像这样：

![](img/c1f73f62-da07-4029-a727-ee926996d125.png)

# 处理身份验证和用户控件

部署后，接下来我们将讨论如何处理身份验证和用户控件。步骤如下：

1.  现在我们已经成功创建了无服务器 API 的框架，我们现在将致力于使其成为一个完全功能的 API 所需的细节。我们将从应用映射模板开始。这可以在“集成请求”菜单中完成。单击“集成请求”链接将带您到一个看起来像这样的控制台：

![](img/5251a40d-48d2-48c1-a7af-f649a985fce3.png)

1.  如果您在同一控制台中向下滚动一点，您会注意到“Body Mapping Templates”部分在最后：

![](img/8f301f36-d13b-43be-8435-b925bd566be2.png)

1.  单击“Body Mapping Templates”将展开该特定部分中的可用选项：

![](img/f52aa43b-becc-406a-84e5-51ad7dab2f78.png)

1.  选择第二个选项，即“当未定义模板时（推荐）”。然后，单击“添加映射模板”选项，添加`application/json`，然后单击其旁边的小灰色勾号：

![](img/ef5353b2-1f3a-4e5e-acc0-e515394882af.png)

1.  单击其旁边的小灰色勾号后，“Body Mapping Templates”部分的空间将如下所示：

![](img/094fc096-36f9-4054-b7bd-b13d313773a6.png)

1.  现在，在模板文本框中，添加以下代码并单击文本框下方的“保存”按钮：

![](img/480207dc-5a03-4384-af3e-3b5c9bc224ba.png)

1.  因此，在所有这些步骤之后，生成的“Body Mapping Templates”部分将如下所示：

![](img/e9e666be-3cb8-4849-9ef0-18d743d2949b.png)

1.  现在，返回到方法执行页面，我们可以看到左侧的“测试”选项，下面是一个闪电符号：

![](img/ff995a15-e50f-49e0-b231-2780b4d09551.png)

1.  在“客户端”部分左侧的“测试”按钮上方和“雷电”选项上单击，将带您到一个页面，您可以在该页面上测试您刚刚创建的 API：

![](img/88b995a6-60cf-4c81-9957-29eda8e0c2b2.png)

1.  现在，在{type}下方的文本框中键入“异国情调”，然后单击底部的“测试”按钮。如果一切顺利，我们应该看到我们在 Lambda 函数的函数代码中输入的所有异国情调宠物的列表：

![](img/849e6fda-c63d-42d8-90be-e4a32cb2fd18.png)

1.  确实如此，我们确实得到了目录中所有异国情调的宠物的列表。因此，本章到此结束，您已经学会了如何从头开始构建一个完全成熟的无服务器 API，包括如何部署它。

1.  此外，如果您想添加额外的安全设置，如授权和 API 密钥要求，您可以在“方法请求”菜单中进行设置：

![](img/1387a18f-b76d-4345-a542-94ee7923f244.png)

# 总结

在本章中，我们学习了如何从头开始构建一个完全无服务器的 API。我们还学习了如何为 API 添加更多资源和方法，以及如何成功将其部署到多个开发阶段，并如何添加额外的安全设置，如授权和 API 密钥，以进行身份验证。

然后，我们学会了如何将 Lambda 函数与 API 网关的 API 服务关联起来，以处理 API 的计算任务。

在下一章中，我们将学习有关无服务器应用程序的日志记录和监控。在该章节中，我们将详细了解 AWS 的日志记录和监控服务，如 CloudWatch 指标、CloudWatch 日志和 CloudWatch 仪表板，并尝试为我们的无服务器应用程序设置它们。我们还将学习如何使用一些 AWS 服务从 AWS Lambda 创建日志记录和监控管道到这些监控工具。
