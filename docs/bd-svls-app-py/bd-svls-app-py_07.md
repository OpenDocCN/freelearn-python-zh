# 第七章：AWS Lambda 中的安全性

我们已经学会了如何在 AWS Lambda 中构建和配置无服务器函数。我们已经学会了如何使用第三方工具扩展它们。我们还仔细研究了微服务的工作原理以及如何在其中确保安全性，同时确保弹性和速度。

在本章中，我们将了解 AWS 环境中的安全性，牢记我们的 Lambda 函数。我们将了解 AWS VPC、安全组和子网等服务与 Lambda 函数相关的工作原理。

本章涵盖以下主题：

+   了解 AWS VPCs

+   了解 VPC 中的子网

+   在私有子网中保护 Lambda

+   控制对 Lambda 函数的访问

+   在 Lambda 中使用 STS 进行安全的基于会话的执行

# 了解 AWS 虚拟私有云（VPC）

在本节中，我们将了解 AWS VPC。VPC 是 AWS 环境安全层中非常常见的组件；它们是云中的隔离部分，用户可以在其中托管其服务并构建基础设施。VPC 是安全的第一层。我们将尝试以项目符号的形式了解 VPC 在 Lambda 函数的上下文中的情况，如下所示：

1.  VPC 可以在 AWS 的 VPC 服务仪表板中创建和修改，看起来像这样：

![](img/3c3762c6-8790-4917-83b0-be9140b15f4d.png)

1.  现在，让我们快速学习如何创建自己的 VPC。为此，请单击“创建 VPC”。您将看到一个弹出框，要求您为新 VPC 输入更多元信息：

![](img/05c269c0-509c-4726-884e-3d3d35591a58.png)

1.  名称标签框需要有 VPC 的名称。IPv4 CIDR 块是您为无类域间路由输入 IP 范围的地方。然后，您可以选择是否要 IPv6 CIDR 块。您还可以选择租户设置；这定义了您的 EC2 实例在 VPC 内的运行方式，以及相应的资源共享：

![](img/bfb7cd21-79f7-4ca8-b951-67ace4d70362.png)

1.  我们已成功创建了具有必要设置和`Test-VPC`名称的 VPC。我们可以在仪表板上看到所有相应的元设置：

![](img/8d2eafa5-fc67-4646-9bb3-ea6540b3ef71.png)

1.  您还可以查看 VPC 的摘要，其中包括 IPv4 设置、网络访问控制列表（ACL）设置、动态主机配置协议（DHCP）选项以及 DNS 设置，所有这些都可以根据我们的需求稍后进行配置。您还可以在“下一个 CIDR 块”选项卡下看到 IPv4 CIDR 块：

![](img/95d20d08-7ee2-46a2-9544-0a57761b849a.png)

1.  我们还可以创建 VPC 流日志，记录进出 VPC 的流量和数据移动。这将促进更好的日志管理，确保安全性和更好的监控。目前，流日志尚未设置：

![](img/a5b7913b-6f53-4929-9df0-02f3822ad360.png)

1.  要创建 VPC 流日志，您只需单击底部的“创建流日志”按钮。这将打开一个流日志创建向导，在其中您可以根据需要输入各种设置的详细信息。创建向导看起来像这样：

![](img/6ff42f25-88e5-4c11-8f2f-9951893653e0.png)

1.  一旦输入了所有细节，您可以继续并点击底部的“创建流日志”选项，这将使用所需的设置创建 VPC 流日志：

![](img/f657e092-032b-4488-a685-aa60fbbb6414.png)

1.  创建后，您可以在“流日志”选项卡下看到新创建的 VPC 流日志，如下所示：

![](img/c8f5cc05-8d7f-47d3-8e6f-1131ae27f94a.png)

1.  现在，让我们从 AWS Lambda 的角度了解 VPCs。就像任何其他 AWS 资源一样，Lambda 函数也可以托管在 VPC 内。您可以在 AWS Lambda 函数的“网络”部分中看到该设置。它看起来像这样：

![](img/f56b1d48-07c6-4632-a861-1dffa46dcfd4.png)

1.  从下拉列表中，您可以选择要托管 Lambda 函数的 VPC：

![](img/830ca55c-9173-4960-a2dd-b8ae008ab76e.png)

1.  选择 VPC 后，它将进一步要求您输入有关子网、安全组等的详细信息，如下面的屏幕截图所示。我们将在接下来的部分中了解它们，因此，我们稍后将为 Lambda 函数配置 VPC：

![](img/39fb6710-baff-401c-910a-e386c2af07e9.png)

# 了解 VPC 中的子网

在本节中，我们将学习和了解 AWS 子网，这些是 AWS VPC 的子部分。VPC 可以进一步划分为多个子网。这些子网可以根据架构的安全需求分为公共或私有。我们将从 AWS Lambda 函数的角度来看子网的概念。

我们将执行以下步骤：

1.  您可以通过 VPC 页面本身转到子网菜单。您需要在左侧的“您的 VPCs”选项下单击“子网”选项：

![](img/816d6fed-9461-4052-abf5-0ae138b16a8a.png)

1.  这将带您进入子网控制台，在那里您将看到一些已经存在的子网。这些是您所在区域每个可用区的默认子网：

![](img/46cc3156-ead4-4571-a4cd-7338e9c1b7ec.png)

1.  现在，要创建新的子网，您需要单击控制台左上角的蓝色“创建子网”按钮。在创建向导中，您将被要求输入以下详细信息-子网的名称、要放置的 VPC、可用区以及首选的 IPv4 CIDR 块。我已将此子网放在了我们在上一节中创建的 VPC 中：

![](img/e671fcdc-7f96-4d47-a99e-9d36d675418c.png)

1.  当您在创建向导的右下方单击“是，创建”按钮时，新的子网将被创建。您可以在控制台上的子网列表中看到它：

![](img/39f11fcc-ef44-4aed-8850-169adf828115.png)

1.  现在，我们将使用刚刚创建的 VPC 和子网填写 Lambda 函数的安全设置。目前，AWS Lambda 的网络设置如下：

![](img/ba7a0cd2-dc7a-4f33-bf3b-fac817f51bb1.png)

1.  在添加所需的设置后，即 VPC、子网和安全组的详细信息后，我们的 Lambda 函数的网络设置将如下所示：

![](img/f566c9d4-69a5-4d3d-b0a1-8b77bc44dc2c.png)

...![](img/452cf8d2-5e41-489c-85d5-84ab3fae0f98.png)

1.  设置 Lambda 函数的网络设置后，单击 Lambda 控制台右上角的橙色“保存”按钮，将这些设置保存到 Lambda 函数中。

# 在私有子网中保护 Lambda

**私有子网**是不对互联网开放的子网。它们的所有流量都通过同一 VPC 中的公共子网使用路由表的概念进行路由。让我们了解如何将我们的 Lambda 函数放在私有子网中以增加额外的安全层：

1.  在 AWS 控制台中创建的子网默认情况下不是私有的。让我们通过查看刚刚创建的子网的详细信息来评估和确认这一点：

![](img/9aa312f6-84ce-4f26-a6ae-0bd9838d5fef.png)

1.  单击“路由表”选项卡将显示子网的路由设置，基本上告诉我们允许进入子网的是什么类型的流量：

![](img/bcb498f4-e225-472c-998c-b38b7f44f5a8.png)

1.  在“网络 ACL”选项卡中，您可以看到为我们的子网分配的网络规则。在这里，我们可以看到子网对所有流量（0.0.0.0/0）都是开放的。因此，为了使我们的子网变为私有，我们需要修复这个问题：

![](img/1f89e289-50ab-457d-80c5-6e55a940d56e.png)

1.  通过单击控制台左侧的链接，转到网络 ACLs 控制台。您将进入以下页面：

![](img/3f01d910-b977-4ef2-af40-71052ce5a097.png)

1.  现在，单击“创建网络 ACL”蓝色按钮以创建新的 ACL。在创建向导中选择我们的 VPC，然后为 ACL 输入名称：

![](img/117d9fa7-b119-4019-bfe0-d5398ccfebb7.png)

1.  现在，在新 ACL 的入站规则中，添加以下规则。在“来源”部分，添加任何公共子网的 IPv4 设置，然后单击保存：

![](img/eec95e92-7393-49bf-b225-ce3c956cca57.png)

1.  现在，用新的 ACL 替换当前子网的 ACL，使我们的子网成为私有子网：

![](img/4634f40c-262b-46f6-bf21-4da5234d2118.png)

现在，我们的 Lambda 函数位于私有子网中，使其更加安全。

# 控制对 Lambda 函数的访问

我们已经了解了确保 Lambda 函数和无服务器架构安全所需的所有安全设置。因此，从安全角度设计基于无服务器系统的工程师应该牢记以下几点：

+   VPC 和子网设置可以添加到 Lambda 函数的“网络”部分。

+   建议将 Lambda 函数放置在至少两个子网中以实现容错目的。但这并非强制性要求。

+   如果您将 Lambda 函数放置在私有子网中，您需要确保私有子网从 VPC 中的公共子网中接收到适当的流量。如果没有，那么 Lambda 函数基本上被锁定了。

# 在 Lambda 中使用 STS 进行安全的基于会话的执行

在 Lambda 函数内访问其他 AWS 服务和组件时，您可以利用**AWS 的简单令牌服务**（**STS**）来确保基于会话的访问，这将在实质上增加一层额外的安全性。正如我们已经讨论过并学会如何在代码中使用 STS 凭据，我们将跳转到文档链接。

AWS STS 的官方文档将帮助您了解会话访问的工作原理：[`docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp.html`](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp.html)。

这是在 Python 代码中使用 STS 凭据的*Boto3 Python 文档*：[`boto3.readthedocs.io/en/latest/reference/services/sts.html`](http://boto3.readthedocs.io/en/latest/reference/services/sts.html)。

# 总结

在本章中，我们深入学习了 Lambda 函数中的安全性工作原理。我们了解了 VPC 和子网在 AWS 环境中的工作原理。我们学会了创建 VPC，并创建了公共和私有子网。这将让您更好地了解安全性是如何从整个 AWS 视角工作的。

我们还学会了如何将 Lambda 函数放置在我们在本章中创建的 VPC 和子网中。我们了解了如何在 VPC 和子网内处理和路由流量。

最后，我们还学会了如何通过基于会话的访问实现 Python 代码的更好安全性，从而将安全性置于开发人员的控制之下。

在下一章中，您将学习**无服务器应用程序模型**（**SAM**）以及如何编写 SAM 模型并通过它们部署 Lambda 应用程序。
