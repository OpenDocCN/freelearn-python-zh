# 第十一章。反模式

在上一章中，我们首先介绍了复合模式。你学习了设计模式如何协同工作来解决现实世界的实际问题。我们进一步探讨了模型-视图-控制器设计模式——复合模式之王。我们了解到，当需要组件之间的松散耦合以及数据存储方式与数据展示方式的分离时，会使用 MVC 模式。我们还研究了 MVC 模式的 UML 图，并了解了各个组件（模型、视图和控制器）之间是如何相互工作的。我们还看到了它是如何通过 Python 实现应用于现实世界的。我们讨论了 MVC 模式的好处，在 FAQ 部分对其进行了更多了解，并在章节末尾总结了讨论。

在本章中，我们将讨论反模式。这与本书中的其他所有章节都不同；在这里，我们将讨论作为架构师或软件工程师我们不应该做什么。我们将通过理论和实践示例来理解反模式是什么以及它们如何在软件设计或开发方面体现出来。

简而言之，在本章中我们将涵盖以下主题：

+   反模式的介绍

+   带有示例的反模式

+   开发过程中的常见陷阱

本章结束时，我们将总结整个讨论——请将此视为一个要点。

# 反模式的介绍

软件设计原则代表了一套规则或指南，帮助软件开发者在设计层面做出决策。根据罗伯特·马丁的观点，糟糕的设计有四个方面：

+   **不可移动性**：应用程序以这种方式开发，使其变得非常难以重用

+   **僵化性**：应用程序以这种方式开发，任何小的变化都可能反过来导致软件的许多部分移动

+   **脆弱性**：当前应用程序的任何变化都可能导致现有系统相对容易地崩溃

+   **粘性**：开发者通过在代码或环境中本身进行更改来避免困难的架构级别更改

如果应用上述糟糕设计的方面，会导致在软件架构或开发中不应实施的解决方案。

反模式是针对重复性问题解决方案的结果，其结果是无效的，并变得适得其反。这意味着什么？假设你遇到一个软件设计问题。你着手解决这个问题。然而，如果解决方案对设计有负面影响或导致应用程序中任何性能问题，又会怎样呢？因此，反模式是软件应用程序中常见的缺陷过程和实现。

反模式可能是以下情况的结果：

+   开发者不了解软件开发实践

+   开发者没有在正确上下文中应用设计模式

反模式可以证明是有益的，因为它们提供了以下机会：

+   认识到软件行业中的重复性问题，并为其中大多数问题提供详细的解决方案

+   开发工具以识别这些问题并确定潜在原因

+   描述可以在多个级别上采取的改进应用程序和架构的措施

反模式可以分为两大类：

1.  软件开发反模式

1.  软件架构反模式

# 软件开发反模式

当你开始为应用程序或项目进行软件开发时，你会考虑代码结构。这个结构与产品架构、设计、客户用例以及许多其他开发考虑因素保持一致。

通常，在软件开发过程中，由于以下原因，软件可能会偏离原始代码结构：

+   开发者的思维过程随着开发而发展

+   用例往往会根据客户反馈而变化

+   初始设计的数据结构可能会随着功能或可扩展性的考虑而发生变化

由于上述原因，软件通常需要进行重构。重构在很多情况下被赋予了负面含义，但事实上，重构是软件开发旅程中的关键部分之一，它为开发者提供了重新审视数据结构和思考可扩展性和不断变化的客户需求的机会。

以下示例为您提供了在软件开发和架构中观察到的不同反模式的概述。我们将仅涵盖其中的一些，包括原因、症状和后果。

## 意大利面代码

这是软件开发中最常见且最常听到的反模式。你知道意大利面是什么样的吗？如此复杂，不是吗？如果结构是临时开发的，软件的控制流也会变得混乱。意大利面代码难以维护和优化。

意大利面的典型原因包括以下：

+   对面向对象编程和分析的无知

+   未考虑的产品架构或设计

+   快速修复的心态

当以下几点成立时，你知道你陷入了意大利面困境：

+   结构的最小重用是可能的

+   维护工作过于繁重

+   扩展性和灵活性降低

## 黄金锤

在软件行业，你可能会看到许多例子，其中某个解决方案（技术、设计或模块）被用于许多地方，因为该解决方案在多个项目中都产生了效益。正如我们在本书中的例子所看到的那样，一个解决方案最适合在特定环境中使用，并应用于某些类型的问题。然而，团队或软件开发者往往会选择一个经过验证的解决方案，而不考虑它是否适合需求。这就是为什么它被称为“黄金锤”，一把适用于所有可能的钉子（解决所有问题的方案）。

黄金锤的典型原因包括以下：

+   这是一种来自高层（架构师或技术领导者）的建议，他们并不接近当前的问题

+   一个解决方案在过去带来了很多好处，但在具有不同上下文和需求的项目中

+   一家公司因为投入了资金培训员工或员工对这种技术感到舒适而陷入这种技术

金刚钻效应的后果如下：

+   一种解决方案被强迫应用于所有软件项目

+   产品不是通过特性来描述，而是通过开发中使用的科技来描述

+   在公司的走廊里，你会听到开发者们谈论，“那可能比使用这个更好。”

+   需求未完成且与用户期望不一致

## 洪流效应

这种反模式与死代码相关，或者是一段无法使用的代码，由于担心修改后可能会破坏其他部分，所以保留在软件应用中。随着时间的推移，这段代码继续留在软件中，并像熔岩变成硬岩一样固化其位置。这种情况可能发生在你开始开发软件以支持某个用例，但随着时间的推移，该用例本身发生变化的情况下。

洪流效应的原因包括以下几方面：

+   生产环境中大量的试错代码

+   单独编写的代码未经审查，且在没有培训的情况下转交给其他开发团队

+   软件架构或设计的初步想法已经体现在代码库中，但现在已经没有人理解它了

洪流效应的症状如下：

+   低代码覆盖率（如果有的话）对于已开发的测试

+   许多没有原因的注释代码

+   已废弃的接口，或者开发者试图绕过现有代码

## 复制粘贴或剪切粘贴编程

如你所知，这是最常见的反模式之一。经验丰富的开发者将他们的代码片段发布到网上（GitHub 或 Stack Overflow），这些代码片段是解决一些常见问题的解决方案。开发者经常直接复制这些片段并用于他们的应用程序，以推动应用程序的开发。在这种情况下，没有验证这是最优化代码，甚至没有验证代码实际上适合上下文。这导致软件应用缺乏灵活性，难以维护。

复制粘贴或剪切粘贴的原因如下：

+   新手开发者不习惯编写代码或不知道如何开发

+   快速修复错误或继续开发

+   由于需要代码结构或模块间的标准化，而导致的代码重复

+   缺乏长期思考或前瞻性

剪贴板或复制粘贴的后果包括以下几方面：

+   软件应用中类似类型的问题

+   维护成本增加和错误生命周期延长

+   代码库模块化程度低，相同的代码行数众多

+   继承了最初存在的问题

# 软件架构反模式

软件架构是整体系统架构的重要组成部分。虽然系统架构侧重于设计、工具和硬件等方面，但软件架构关注的是建模软件，这种软件被开发团队、测试团队、产品经理和其他利益相关者所理解。这种架构在确定实施的成功以及产品如何为顾客工作方面发挥着关键作用。

我们将讨论我们在现实世界中观察到的某些架构级反模式，这些反模式与软件开发和实施架构有关。

## 重新发明轮子

我们经常听到技术领导者谈论“不要重新发明轮子”。这本质上意味着什么？对一些人来说，这可能意味着代码或库的重用。实际上，它指的是架构的重用。例如，你已经解决了一个问题，并提出了一个架构级的解决方案。如果你在其他任何应用程序中遇到类似的问题，之前开发的思想过程（架构或设计）应该被重用。重新审视相同的问题并制定解决方案是没有意义的，这本质上就是重新发明轮子。

导致重新发明轮子的原因如下：

+   缺乏关于架构级问题和解决方案的中央文档或存储库

+   社区或公司内部技术领导者之间的沟通不足

+   从零开始构建是组织遵循的过程；基本上，不成熟的过程和松散的过程实施及遵守

这种反模式的后果包括以下内容：

+   解决一个标准问题有太多解决方案，其中许多没有经过深思熟虑

+   工程团队花费更多的时间和资源，导致超预算和更长的上市时间

+   封闭的系统架构（仅适用于单一产品的架构）、重复劳动和风险管理不佳

## 供应商锁定

如反模式名称所示，产品公司往往依赖于供应商提供的一些技术。这些技术与其系统紧密相连，以至于很难摆脱。

以下是供应商锁定的原因：

+   与供应商公司中的权威人士熟悉，以及可能在技术采购中享受折扣

+   根据营销和销售方案而不是技术评估来选择技术

+   即使当前项目不适合项目需求或要求，也在当前项目中使用经过验证的技术（经过验证表示在以前的经验中，使用这项技术的投资回报率非常高）

+   技术人员/开发者已经接受了使用这项技术的培训

供应商锁定带来的后果如下：

+   公司产品发布的发布周期和维护周期直接依赖于供应商的发布时间表

+   产品是围绕技术而非客户需求开发的

+   产品的上市时间不可靠，不符合客户的期望

## 委员会设计

有时，根据组织中的流程，一群人坐在一起设计特定的系统。由此产生的软件架构通常很复杂或不符合标准，因为它涉及太多的思维过程，而且可能没有正确技能集或设计产品经验的技术人员提出了想法。

委员会设计的原因如下：

+   组织中的流程涉及让架构或设计得到许多利益相关者的批准

+   没有单一的联系点或负责设计的架构师

+   由市场营销人员或技术人员而非客户反馈设定的设计优先级

观察到与此反模式相关的症状包括以下：

+   即使设计已经确定，开发人员和架构师之间也存在冲突的观点

+   过于复杂的设计，很难进行文档记录

+   任何对规格或设计的变更都需要经过多人的审查，从而导致实施延迟

# 摘要

总结本章内容，你学习了反模式（AntiPatterns）的定义、分类，以及它们与软件开发或软件架构的关系。我们探讨了常见反模式及其成因、症状和后果。我相信你会从中学到东西，并在你的项目中避免类似情况的发生。

就这样，朋友们，这是本书的最后一章。希望你喜欢它，并且这本书能帮助你提高技能。祝你们所有人好运！
