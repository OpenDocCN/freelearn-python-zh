# 前言

在软件开发过程中，错误是一个耗时的负担。Django 的内置测试框架和调试支持有助于减轻这一负担。本书将教你使用 Django 和 Python 工具快速高效地消除错误，并确保 Django 应用程序正常运行。

本书将逐步引导你开发一个完整的样本 Django 应用程序。你将学习如何最好地测试和调试模型、视图、URL 配置、模板和模板标签。本书将帮助你集成并利用 Python 和 Django 应用程序丰富的外部测试和调试工具环境。

本书从基本的测试概述开始。它将强调测试时需要注意的地方。你将了解到不同类型的测试，每种测试的优缺点，以及 Django 提供的测试扩展的细节，这些扩展简化了测试 Django 应用程序的任务。你将看到外部工具如何集成到 Django 的框架中，提供更复杂的测试功能。

在调试方面，本书说明了如何解释 Django 调试错误页面提供的大量调试信息，以及如何利用日志记录和其他外部工具来了解代码的运行情况。

这本书是一个逐步指南，教你如何使用 Django 的测试支持，并充分利用 Django 和 Python 调试工具。

# 本书内容

在第一章，“Django 测试概述”中，我们开始开发一个样本 Django 调查应用程序。描述并运行了 Django 自动生成的示例测试。介绍了运行测试的所有选项。

在第二章，“这段代码有效吗？深入了解 doctests”中，开发了样本应用程序使用的模型。通过示例说明了使用 doctests 来测试模型。讨论了 doctests 的优缺点。介绍了在 Django 应用程序中使用 doctests 的特定注意事项。

在第三章，“测试 1, 2, 3：基本单元测试”中，上一章实施的 doctests 被重新实施为单元测试，并根据上一章讨论的 doctests 的优缺点和注意事项进行评估。开发了需要使用测试数据的其他测试。演示了使用 fixture 文件加载此类数据。此外，还开发了一些不适合使用 fixture 文件的测试数据的测试。

在第四章，“变得更加花哨：Django 单元测试扩展”中，我们开始编写为应用程序提供网页的视图。测试的数量开始变得显著，因此本章首先展示了如何用一个 tests 目录替换单个`tests.py`文件，以便更好地组织测试。然后，开发了用于视图的测试，演示了 Django 提供的单元测试扩展如何简化测试 Web 应用程序的任务。通过开发本章中进行的管理自定义的测试，演示了测试表单行为。

第五章，“填空：集成 Django 和其他测试工具”，展示了 Django 如何支持将其他测试工具集成到其框架中。书中介绍了两个例子。第一个例子说明了如何使用附加应用程序来生成测试覆盖信息，而第二个例子演示了如何将`twill`测试工具（允许更轻松地测试表单行为）集成到 Django 应用程序测试中。

第六章，“Django 调试概述”，介绍了调试 Django 应用程序的主题。描述了所有与调试相关的设置。介绍了调试错误页面。描述了在调试打开时 Django 维护的数据库查询历史，以及开发服务器的功能，有助于调试。最后，详细介绍了在生产过程中（调试关闭时）发生的错误处理，并提到了确保捕获并发送有关此类错误信息的所有必要设置。

在第七章，“当车轮脱落时：理解 Django 调试页面”，继续开发示例应用程序，在这个过程中犯了一些典型的错误。这些错误导致了 Django 调试页面。描述了这些页面上提供的所有信息，并给出了在什么情况下最有帮助的部分的指导。深入讨论了几种不同类型的调试页面。

第八章，“当问题隐藏时：获取更多信息”，着重介绍了在问题不会导致调试错误页面的情况下如何获取有关代码行为的更多信息。它演示了开发模板标签以在呈现页面中嵌入视图的查询历史的过程，然后展示了如何使用 Django 调试工具栏来获取相同的信息，以及更多信息。最后，开发了一些日志记录工具。

第九章，“当您甚至不知道要记录什么时：使用调试器”，通过示例演示了如何使用 Python 调试器（pdb）来跟踪在没有调试页面出现甚至日志也无法帮助的情况下出现问题。通过示例演示了所有最有用的 pdb 命令。此外，我们还看到了如何使用 pdb 来确保对于受多进程竞争条件影响的代码的正确行为。

第十章，“当一切都失败时：寻求外部帮助”，描述了当迄今为止的技术都未能解决问题时该怎么办。可能是外部代码中的错误：提供了如何搜索以查看其他人是否有相同经历以及是否有任何修复的提示。可能是我们代码中的错误或对某些工作原理的误解；包括了提问的途径和写好问题的提示。

在第十一章，“当是时候上线了：转向生产”，我们将示例应用程序移入生产环境，使用 Apache 和`mod_wsgi`代替开发服务器。涵盖了在此步骤中遇到的几种常见问题。此外，还讨论了在开发过程中使用 Apache 与`mod_wsgi`的选项。

# 本书需要以下内容：

您需要一台运行 Django 1.1 版本的计算机——建议使用最新的 1.1.X 版本。您还需要一个编辑器来编辑代码文件和一个网络浏览器。您可以选择使用您最熟悉的操作系统、编辑和浏览工具，只要选择一个可以运行 Django 的操作系统。有关 Django 要求的更多信息，请参阅[`docs.djangoproject.com/en/1.1/intro/install/`](http://docs.djangoproject.com/en/1.1/intro/install/)。

供您参考，本书中的示例控制台输出和屏幕截图都来自一台运行以下内容的计算机：

+   Ubuntu 8.10

+   Python 2.5.2

+   Django 1.1（书中早期）和 1.1.1（书中后期）

+   Firefox 3.5.7

您可以使用 Django 支持的任何数据库。为了说明的目的，在本书的不同部分使用了不同的数据库（SQLite、MySQL、PostgreSQL）。您可能更愿意选择一个数据库来贯穿使用。

本书在特定的点使用了额外的软件。每当引入一个软件包时，都会包括有关在哪里获取它以进行安装的说明。供您参考，以下是本书中使用的额外软件包及其版本的列表：

+   第五章 *填补空白：集成 Django 和其他测试工具* 使用：

+   coverage 3.2

+   django_coverage 1.0.1

+   twill 0.9（和最新的开发级别）

+   第八章 *当问题隐藏时：获取更多信息* 使用：

+   django-debug-toolbar 0.8.0

+   第九章 *当你甚至不知道要记录什么：使用调试器* 使用：

+   pygooglechart 0.2.0

+   matplotlib 0.98.3

+   第十一章 *当是时候上线了：转向生产* 使用：

+   Apache 2.2

+   mod_wsgi 2.3

+   siege 2.6.6

请注意，当您开始阅读本书时，您不需要安装这些额外的软件包中的任何一个，它们可以在您想要开始使用它们的特定点上添加。列出的版本是书中显示的输出所使用的版本；预计稍后的版本也将起作用，尽管如果您使用更新的版本，产生的输出可能会略有不同。

# 本书的受众

如果您是一名 Django 应用程序开发人员，希望快速创建稳健的应用程序，并且长期易于维护，那么本书适合您。如果您希望聪明地学习如何充分利用 Django 丰富的测试和调试支持，并使开发变得轻松，那么本书是您的不二选择。

假定您具有 Python、Django 和基于数据库的 Web 应用程序的整体结构的基本知识。但是，代码示例已经得到充分解释，以便即使是对这个领域新手的初学者也可以从本书中学到很多知识。如果您是 Django 的新手，建议您在开始阅读本书之前先完成在线 Django 教程。

# 约定

在本书中，您将找到一些文本样式，用于区分不同类型的信息。以下是一些这些样式的示例，以及它们的含义解释。

文本中的代码词如下所示：“现在我们有了 Django 项目和应用的基本骨架：一个`settings.py`文件，一个`urls.py`文件，`manage.py`实用程序，以及一个包含模型、视图和测试的`.py`文件的`survey`目录。”

代码块设置如下：

```py
__test__ = {"doctest": """
Another way to test that 1 + 1 is equal to 2.

>>> 1 + 1 == 2
True
"""}
```

当我们希望引起您对代码块的特定部分的注意时，相关行或项目将以粗体显示：

```py
urlpatterns = patterns('', 
    # Example: 
    # (r'^marketr/', include('marketr.foo.urls')), 

    # Uncomment the admin/doc line below and add # 'django.contrib.admindocs' 
    # to INSTALLED_APPS to enable admin documentation: 
    # (r'^admin/doc/', include('django.contrib.admindocs.urls')), 

    # Uncomment the next line to enable the admin: 
    (r'^admin/', include(admin.site.urls)), 
 (r'', include('survey.urls')), 
) 
```

任何命令行输入或输出都以以下方式编写：

```py
kmt@lbox:/dj_projects$ django-admin.py startproject marketr

```

**新术语**和**重要单词**以粗体显示。您在屏幕上看到的单词，例如菜单或对话框中的单词，会以这样的方式出现在文本中：“此下拉框包含我们可以搜索的所有票据属性的完整列表，例如**报告人**、**所有者**、**状态**和**组件**。”

### 注意

警告或重要说明会以这样的方式出现在框中。

### 提示

提示和技巧会以这样的方式出现。
