# 前言

欢迎阅读《物联网的实用 Python 编程》。本书的重点是围绕树莓派、电子、计算机网络、Python 编程语言以及如何将所有这些元素结合起来构建复杂多样的物联网项目。

我们将从多个角度研究这些元素，比较和对比不同的选项，并讨论我们构建的电子电路背后的*如何*和*为什么*。当您阅读完本书时，您将拥有一个广泛的工具包，其中包括电子接口代码示例、网络代码示例和电子电路示例，您可以借鉴、调整和重新设计以满足自己的需求和项目。

我期待着与您一起踏上这段物联网之旅。

# 这本书是为谁写的

本书适用于应用程序开发人员、物联网专业人士和对利用 Python 编程语言构建物联网应用程序感兴趣的爱好者。它是为有一定经验的中高级软件工程师编写的，他们在桌面、Web 和移动开发方面经验丰富，但对电子、物理计算和物联网几乎没有接触。

# 本书涵盖了什么

第一章，*设置开发环境*，探讨了树莓派操作系统中的 Python 生态系统，并教您如何正确地为 Python 开发项目做好准备。您还将学习启动 Python 程序的替代方法，以及如何配置树莓派进行 GPIO 接口。

第二章，*开始使用 Python 和物联网*，教授了电子学和 Python 的 GPIO 接口的基础知识。您将构建并尝试使用 Python 控制的简单电子电路，并将这些知识结合起来，从头开始构建一个简单但完整的可通过互联网控制的物联网应用，使用 dweet.io 平台。

第三章，*使用 Flask 进行 RESTful API 和 Web 套接字进行网络连接*，探讨了如何使用两种方法在 Python 中构建网络服务器——RESTful API 和 Web 套接字。您将学习如何将这些服务器与 Python 和 HTML/JavaScript 用户界面结合使用，以便从 Web 浏览器控制网络上的电子电路。

第四章，*使用 MQTT、Python 和 Mosquitto MQTT Broker 进行网络连接*，教授使用消息队列遥测传输的网络连接方法，这是分布式物联网应用的热门选择。您将学习如何将 MQTT 与 Python 和 HTML/JavaScript 用户界面结合使用，以便从网络和 Web 浏览器控制电子电路。

第五章，*将树莓派连接到物理世界*，探讨了用于接口和控制电子的不同基于 Python 的软件选项和技术，使用树莓派的 GPIO 引脚。您还将构建并学习如何使用 ADS1115 模拟数字转换器模块来扩展树莓派的本机接口选项，并介绍**脉宽调制**（**PWM**），这是一个重要的电子和接口概念，您将在后续章节中使用。

第六章，*软件工程师的电子学 101*，教授核心电子概念和基础知识。您将学习常见电子和接口电路背后的基本*如何*和*为什么*，以及它们如何在实际中正确安全地与传感器和执行器进行接口。您还将学习数字和模拟电子学的区别，以及每种电子学如何适用于和影响接口电路要求。本章中学到的许多基础知识在后续章节中会以实际应用的形式呈现，因为我们将使用不同的电子元件和模块进行工作。

第七章《打开和关闭设备》教会你如何使用光耦、MOSFET 晶体管和继电器来使用树莓派和 Python 打开和关闭其他电路。你还将了解电路负载，如何测量电路负载，以及这如何影响在电路中选择和使用光耦、MOSFET 晶体管和继电器。

第八章《灯光、指示灯和信息显示》教会你如何使用 APA102 LED 灯带、RGB LED、OLED 显示屏和蜂鸣器结合 Python 创建视觉和声音定向电路和应用。

第九章《测量温度、湿度和光照水平》教会你如何使用树莓派和 Python 测量常见的环境属性。你将使用 DHT11/22 温湿度传感器构建电路，并学习使用光敏电阻（LDR）来检测光的存在或缺失。在本章中，你还将加深对模拟电子学的实际理解和经验，并应用基本原理构建湿度检测电路和应用。

第十章《使用舵机、电机和步进电机进行运动》教会你如何使用流行的机械设备和树莓派以及 Python 创建运动。你将学习如何使用 PWM 控制舵机以创建角度运动，使用 H 桥 IC 电路和电机控制其速度和旋转方向。此外，你还将学习如何调整 H 桥 IC 电路以与步进电机一起使用，以便在需要精确控制运动的项目中使用。

第十一章《测量距离和检测运动》教会你使用 HC-SR04 超声波距离传感器测量距离的原理，以及如何使用 HC-SR501 PIR 传感器在宏观尺度上检测运动。你还将学习如何使用比例式和开关式霍尔效应传感器来检测运动并在微观尺度上测量相对距离。

第十二章《高级 IoT 编程概念-线程、AsyncIO 和事件循环》是一个高级编程章节，探讨了构建复杂 Python 程序的替代方法。你将学习 Python 线程、异步 I/O、经典事件循环和发布-订阅模式，所有这些都在电子接口的背景下。到本章结束时，你将尝试并理解四种功能等效的应用程序，它们以四种非常不同的方式编写。

第十三章《IoT 可视化和自动化平台》是一次探索与 IoT 相关的在线服务和集成的旅程。你将基于第九章《测量温度、湿度和光照水平》中的 DHT11/22 温湿度电路创建两个环境监测应用。首先，你将利用第四章《使用 MQTT、Python 和 Mosquitto MQTT Broker 进行网络连接》中的 MQTT 理解，在 ThingSpeak.com 上创建在线仪表板，显示和绘制温度和湿度数据。然后，你还将应用第四章《使用 MQTT、Python 和 Mosquitto MQTT Broker 进行网络连接》中的 RESTful API 概念，并构建一个 If-This-Then-That（IFTTT.com）工作流 Applet，当温度升高或低于某一点时发送电子邮件给你。

第十四章，*将所有内容绑在一起-物联网圣诞树*，汇集了您在前几章学到的许多主题和概念，围绕一个连接到互联网的圣诞树的多方面示例。从电子学的角度来看，您将重新访问第八章中的 APA102 LED 灯带，*灯光、指示灯和信息显示*（这将是圣诞树的灯光），以及第十章中的舵机，*使用舵机、电机和步进电机进行运动*（用于提供摇晃或摇动树的机制）。从网络的角度来看，您将重新访问第二章中的 dweet.io，*使用 Python 和物联网开始*；第三章中的 RESTful-APIs，*使用 Flask 进行 RESTful API 和 Web Sockets 网络*；以及第四章中的 MQTT，*使用 Mosquitto MQTT Broker 进行 MQTT 网络*，并学习如何结合技术以实现需要桥接不同技术的复杂集成。最后，您将重新访问第十三章中的 IFTTT，*物联网可视化和自动化平台*，并创建两个 Applets，让您可以通过互联网控制树的灯光，并让树在互联网上摇晃或摇动。这三个 Applets 包括电子邮件控制，以及使用 Google 助手的语音激活控制。

# 为了充分利用本书

以下标题提供了您在本书中成功完成练习所需的硬件、软件、电子设备和外围设备的概述。

+   **硬件和软件**：本书中的所有练习和代码都是在以下硬件和软件版本上构建和测试的：

+   +   树莓派 4 型 B 型

+   树莓派 OS Buster（带桌面和推荐软件）

+   Python 版本 3.5

我假设您将使用等效的设置；但是，可以合理地期望代码示例在树莓派 3 型 B 型或不同版本的 Raspbian OS 或树莓派 OS 上工作，只要您的 Python 版本是 3.5 或更高。

如果您对您的 Python 版本不太确定，不用担心。在第一章中，*设置您的开发环境*，我们的第一个任务之一将是了解树莓派上的 Python，并确定可用的版本。

+   **电子零件和设备**：我们将在本书中使用许多电子零件。在每章的开头，我会列出您在该章节示例中需要的具体零件和数量。除了列出的零件外，还需要一个电子面包板和一些杜邦线/跳线。

为了方便起见，本书中使用的所有电子零件的目录表，它们被使用的章节，以及您需要的最小数量如下。如果您是新手购买电子零件，您还会在表格后找到一些提示，以帮助您开始：

| **零件名称** | **最小数量** | **描述/注释** | **用于章节** |
| --- | --- | --- | --- |
| 红色 LED | 2 * | 5mm 红色 LED。不同颜色的 LED 可能具有不同的电气特性。本书中的大多数示例将假定为红色 LED。 | 2, 3, 4, 5, 6, 7, 9, 12, 13 |
| 15Ω电阻 | 2 * | 颜色带（4 带电阻）将是棕色、绿色、黑色、银色/金色 | 8 |
| 200Ω电阻 | 2 * | 颜色带（4 带电阻）将是红色、黑色、棕色、银色/金色 | 2, 3, 4, 5, 6, 8, 9, 12, 13 |
| 1kΩ电阻 | 2 * | 颜色带（4 带电阻）将是棕色、棕色、红色、银色/金色 | 6, 7, 9, 8, 11 |
| 2kΩ电阻 | 2 * | 颜色带（4 带电阻）将是红色、黑色、红色、银色/金色 | 6, 11 |
| 10kΩ 电阻 | 1 * | 色带（4 带电阻）将是棕色，黑色，橙色，银色/金色 | 9, 13 |
| 51kΩ 电阻 | 1 * | 色带（4 带电阻）将是绿色，棕色，橙色，银色/金色 | 6 |
| 100kΩ 电阻 | 1 * | 色带（4 带电阻）将是棕色，黑色，黄色，银色/金色 | 7, 8, 9 |
| 瞬时按钮开关 | 1 | 要找到一个面包板友好的按钮开关，可以尝试搜索*大的触觉开关*。 | 1, 6, 12 |
| 10kΩ *线性* 电位计 | 2 | 用手指调节的较大电位计在书中的示例中更容易使用，而小电位计需要用螺丝刀调节。确保你有*线性*电位计（不是对数的）。 | 5, 6, 12 |
| 2N7000 MOSFET | 1 * | 这是一个逻辑电平兼容的 MOSFET 晶体管。 | 7, 8 |
| FQP30N06L 功率 MOSFET | 1 * | 可选。购买时，请确保零件号以 L 结尾，表示它是逻辑电平兼容的 MOSFET（否则，它将无法可靠地工作你的树莓派）。 | 7 |
| PC817 光耦 | 1 * | 也被称为光隔离器。 | 7 |
| SDR-5VDC-SL-C 继电器 | 1 | 这些继电器非常受欢迎，很容易找到；但是它们不适合面包板。你需要给它们焊接端子或导线，这样你就可以把它们插入你的面包板。 | 7 |
| 1N4001 二极管 | 1 * | 我们将使用二极管作为反冲电压抑制二极管，以保护其他电子元件免受电压峰值的影响。 | 7, 8 |
| 尺寸 R130 5 伏直流业余电机 | 2 | 尺寸 R130 只是一个建议。我们需要的是 5 伏兼容的直流电机，最好的是空载电流小于 800 毫安。虽然这些电机在拍卖网站上很容易找到，但它们的电流和工作电流可能记录不完整，所以你得碰运气。第七章，*打开和关闭东西*，将带你完成一个练习，测量你的电机的工作电流。 | 7, 10 |
| RGBLED，共阳极类型 | 1 * | 这是一种可以产生不同颜色的 LED。 | 8 |
| 无源蜂鸣器 | 1 | 一个可以在 5 伏时工作的*无源*蜂鸣器。 | 8 |
| SSD1306 OLED 显示屏 | 1 | 这是一个小型的单色像素显示屏。 | 8 |
| APA102 RGBLED 灯条 | 1 | 这是一条可寻址的 APA102 RGBLED 灯条。你只需要 LED 灯条，不需要为我们的练习购买电源或遥控器。请注意确保购买的是 APA102 LED，因为有不同（不兼容）类型的可寻址 LED 可用。 | 8, 14 |
| DHT11 或 DHT22 温湿度传感器 | 1 | DHT11 和 DHT22 是可以互换的。DHT22 稍微贵一些，但提供更高的精度，并且可以测量零下的温度。 | 9, 13 |
| LDR | 1 * | 光敏电阻 | 9 |
| MG90S 业余舵机 | 1 | 这只是一个建议。任何带有 3 根线（+，GND，信号）的 5 伏特业余舵机都应该合适。 | 10, 14 |
| L293D H 桥 IC | 1 * | 确保你购买的零件号以 D 结尾，表示 IC 包括嵌入式反冲电压抑制二极管。 | 10 |
| 28BYJ-48 步进电机 | 1 | 确保购买 5 伏的步进电机，齿轮比为 1:64。 | 10 |
| HC-SR501 PIR 传感器 | 1 | PIR 传感器可以检测运动。它是通过热来工作的，所以可以检测到人和动物的存在。 | 11 |
| HC-SR04 超声波距离传感器 | 1 | 超声波距离传感器利用声波估算距离。 | 11 |
| A3144 霍尔效应传感器 | 1 * | 这是一种非锁定开关型霍尔效应传感器，它在磁场存在时打开。 | 11 |
| AH3503 霍尔效应传感器 | 1 * | 这是一种比例式霍尔效应传感器，可以检测相对于磁场的接近程度。 | 11 |
| 磁铁 | 1 | 需要一个小磁铁用于霍尔效应传感器。 | 11 |
| ADS1115 模拟-数字（ADC）转换器模块 | 1 | 这个模块将允许我们将模拟元件与树莓派进行接口。 | 5, 9, 12 |
| 逻辑电平转换器/转换器模块 | 1 | 这个模块将允许我们将 5 伏电气元件与树莓派进行接口。搜索*逻辑电平转换器/转换器模块*，并在 4 或 8 通道时寻找双向（首选）模块。 | 6, 8, 14 |
| 面包板 | 1 | 我们所有的电子示例都将建立在面包板上。我建议购买两个全尺寸的面包板并将它们连接在一起 - 更多的面包板工作区将使电路建立更容易。 | 2 - 14 |
| 杜邦/跳线电缆 | 3 套* | 这些电缆用于在面包板上连接元件。我建议购买公对公，公对母和母对母类型的套装。 | 2 - 14 |
| 树莓派 GPIO 面包板转接板 | 1 | 这是可选的，但它将使你更容易地将树莓派的 GPIO 引脚与面包板进行接口。 | 2 - 14 |
| 数字万用表 | 1 | 作为指南，价格在 30-50 美元的数字万用表应该是完全合适的。避免使用最低廉和最便宜的万用表。 | 6, 7 |
| 外部电源供应 | 2 | 本书中的一些电路将需要比我们期望的树莓派提供更多的电源。作为最小来源，一个能够输出 1 安培的 3.3/5 伏面包板兼容电源供应将是合适的。你可能还想研究实验室电源供应作为更有能力和通用的替代方案。 | 7, 8, 9, 10, 14 |
| 焊接铁和焊锡 | 1 | 有时你需要把导线和端子焊接到元件上 - 例如，你很可能需要把端子焊接到你购买的 ADS1115 和逻辑电平转换器/转移模块上。你还需要把端子或导线焊接到你的 SDR-5VDC-SL-C 继电器上，这样你就可以把它插入面包板。 | |

**建议备用。这些是如果连接或供电不正确或在使用中可能会发生物理损坏（例如，腿断裂）的元件。*

这些零件之所以被选中，是因为它们的低价格和它们在 eBay.com、Bangood.com、AliExpress.com 和电子零售商等网站上的普遍可用性。

在购买之前，请考虑以下事项：

+   **最小数量**列是你在本书中需要的练习数量，但强烈建议你购买备用零件，特别是 LED、电阻和 MOSFET，因为这些元件很容易损坏。

+   你会发现许多零件需要大量购买。

+   搜索*电子元件入门套件*，并将其包含的内容与表中列出的零件进行比较。你可能可以在单个（并且打折）交易中购买许多零件。

+   许多可用的即插即用的*传感器模块入门套件*大部分情况下都不适用于本书中所介绍的电路和代码练习。我们的电子和代码示例的深度意味着我们需要使用核心电气元件。然而，在完成本书后，你将能够理解这些即插即用传感器模块是如何构建和工作的！

**如果你使用本书的数字版本，我们建议你自己输入代码或通过 GitHub 存储库（链接在下一节中提供）访问代码。这样做将有助于避免与复制和粘贴代码相关的任何潜在错误。*

## 下载示例代码文件

你可以从你在[www.packt.com](http://www.packt.com)的账户中下载本书的示例代码文件。如果你在其他地方购买了这本书，你可以访问[www.packtpub.com/support](https://www.packtpub.com/support)并注册，让文件直接发送到你的邮箱。

您可以按照以下步骤下载代码文件：

1.  登录或注册[www.packt.com](http://www.packt.com)。

1.  选择支持选项卡。

1.  单击“代码下载”。

1.  在搜索框中输入书名，然后按照屏幕上的说明操作。

文件下载后，请确保使用最新版本的解压缩或提取文件夹：

+   WinRAR/7-Zip for Windows

+   Zipeg/iZip/UnRarX for Mac

+   7-Zip/PeaZip for Linux

该书的代码包也托管在 GitHub 上，网址是[`github.com/PacktPublishing/Practical-Python-Programming-for-IoT`](https://github.com/PacktPublishing/Practical-Python-Programming-for-IoT)。如果代码有更新，将在现有的 GitHub 存储库上更新。

我们还有来自我们丰富的书籍和视频目录的其他代码包，可在[`github.com/PacktPublishing/`](https://github.com/PacktPublishing/)上找到。去看看吧！

## 代码演示

本书的代码演示视频可以在[`bit.ly/316OvNu`](https://bit.ly/316OvNu)上观看。

## 下载彩色图像

我们还提供了一个 PDF 文件，其中包含本书中使用的屏幕截图/图表的彩色图像。您可以在这里下载：[`static.packt-cdn.com/downloads/9781838982461_ColorImages.pdf`](https://static.packt-cdn.com/downloads/9781838982461_ColorImages.pdf)。

## 使用的约定

本书中使用了许多文本约定。

`CodeInText`：表示文本中的代码词、数据库表名、文件夹名、文件名、文件扩展名、路径名、虚拟 URL、用户输入和 Twitter 句柄。例如："让我们使用`gpio_pkg_check.py`和`pip`来检查 GPIO 包的可用性。"

代码块设置如下：

```py
# Global Variables ...  BROKER_HOST = "localhost"   # (2) BROKER_PORT = 1883 CLIENT_ID = "LEDClient" # (3) TOPIC = "led" # (4) client = None # MQTT client instance. See init_mqtt()   # (5) ...
```

当我们希望引起您对代码块的特定部分的注意时，相关的行或项目将以粗体显示：

```py
# Global Variables ...  **BROKER_HOST = "localhost"**   # (2) BROKER_PORT = 1883 CLIENT_ID = "LEDClient" # (3) TOPIC = "led" # (4) client = None # MQTT client instance. See init_mqtt()   # (5) ...
```

任何命令行输入或输出都以以下方式编写：

```py
$ python --version
Python 2.7.16
```

**粗体**：表示新术语、重要单词或您在屏幕上看到的单词。例如，菜单或对话框中的单词会以这种方式出现在文本中。例如："从您的 Raspbian 桌面，导航到 Raspberry 菜单|首选项|Raspberry Pi Configuration。"

警告或重要提示会出现在这样的样式中。提示和技巧会出现在这样的样式中。
