

# 第十一章：接下来是什么？

在这本书中，我们讨论了使用 Quart 框架编写的 Python 微服务的设计和开发。我们构建了一个单体应用程序作为工作基础，并介绍了从该架构迁移到最佳利用微服务的架构的策略，以及可能出现的潜在错误以及如何避免它们。我们还学习了如何使用基于容器的服务将我们的应用程序部署到云服务提供商。

然而，这并不是故事的结束，还有其他一些话题值得进一步了解。我们的自动化和工具总是有改进的空间，以帮助服务保持更新，还有更多关于性能和容量管理的问题需要回答，我们的监控和日志可以帮助解决这些问题，以及如何扩展和改变我们的部署架构以提高服务的可靠性和可用性的考虑。最后，我们需要记住——除非是为了爱好编写代码——软件本身并不是最终目标，我们必须履行对需要软件的人的承诺。

# 自动化

我们简要讨论了**Terraform**作为自动化创建基于云资源的方法，还有更多关于这个工具以及其他可以自动化运行服务的一些工作的工具需要学习。

要在实例内部进行配置，配置管理工具如**Ansible**、**Chef**和**Puppet**允许你复制文件、更改文件内容、安装软件包，并以可重复、可预测的方式设置计算机，使其符合你的喜好。

使用 HashiCorp 的**Packer**为你的环境构建操作系统镜像，它允许你使用上述配置管理工具创建操作系统镜像，用于 AWS、GCP、VMware 或 Docker 等许多其他环境。

即使你的基础设施很小，使用自动化来创建和维护它仍然很有价值。在发生灾难的情况下，你只需几条简短的命令就可以重新创建你整个应用程序套件，而不是几周痛苦的劳动。

在创建基础设施代码时，很容易不小心创建一个新的单体，负责创建和维护每个组件。如果这是一个深思熟虑的选择，那么它将工作得很好，但同时也值得记住将功能分离成更小的项目所带来的其他原则，比如权限分离和易于维护。以下是一些相关的链接：

+   Terraform: [`www.terraform.io/`](https://www.terraform.io/)

+   Ansible: [`www.ansible.com/`](https://www.ansible.com/)

+   Chef: [`www.chef.io/`](https://www.chef.io/)

+   Puppet: [`puppet.com/`](https://puppet.com/)

# 扩展

当应用程序需要做更多工作时，传统的方法是在更大的计算机上运行应用程序。给它更多的内存、更多的 CPU 核心，甚至更多的磁盘空间。这并不会增加应用程序的可靠性，因为它仍然依赖于单一计算机，而且一旦应用程序足够大，就没有足够的计算机可以运行它时，这会带来额外的复杂性。

将程序运行在更大型的计算机上被称为垂直扩展。相比之下，水平扩展则是使用许多小型计算机的方法。我们在讨论基于容器的服务部署以及增加我们使用的 Docker 集群实例数量时遇到了这个想法。为了以这种方式运行，应用程序必须有一个复制的、可扩展的当前状态的概念，以便客户端会话、购物车内容以及访客期望在网站的不同页面之间持久存在的任何其他内容。

微服务允许您更容易地扩展应用程序，尽管重要的是要记住，每个组件都会与其他微服务通信，并且一个区域的负载增加将对其他区域产生后果。

仔细监控将使您能够发现整个系统中的瓶颈，从而确定哪个区域最需要紧急工作，以便为系统提供更多容量。

# 内容分发网络

我们应用程序提供的一些内容并不经常改变，例如 HTML 页面、JavaScript、图像和视频流。**内容分发网络**（**CDNs**）旨在提供全球范围内分布的静态内容。它们可以作为您应用程序前端的层或与其并行工作，能够比定制化服务更快地向客户端提供可缓存的 内容。一些 CDNs 还允许您根据客户端及其网络质量动态调整图像和视频，或者提供针对分布式拒绝服务攻击的保护，使它们成为任何基于 Web 的服务的重要工具。

# 多云部署

在评估运行服务的风险时，很容易意识到您的组织完全依赖于一个云服务提供商。为了提高冗余性，一个常见的愿望是将服务部署到多个提供商，并将工作负载分散到 Azure、GCP、Amazon 和其他服务上。这听起来可能是个好主意，但它也引入了许多复杂性，因为不同的提供商有不同的功能集可用，需要独特的安全安排，并且无法共享存储和秘密管理。

虽然`Terraform`可以帮助处理这种情况，但通常更可行的是在同一提供者内追求多个区域，如果确实需要多个云提供者，可以根据它们之间的交互方式来区分它们运行的内容。将完全独立的服务放在其他地方要容易得多。这与战略方法和将单体拆分为微服务的做法有相似之处，因为成功的迁移需要不同组件之间的清晰接口和良好结构化的关注点和需求隔离。

# Lambda 函数

Lambda，或云函数，是一种无服务器部署类型，旨在用于小型、短暂的任务，可以非常快速地扩展和缩减。尽管在 2021 年，异步框架在这个领域支持有限，但它们与同步代码广泛结合使用，因为它们的运行方式意味着响应性由可以同时运行的实例数量控制。

# 扩展监控

在*第五章*，*拆分单体*中，我们讨论了监控和收集指标以记录应用程序正在做什么。测量可以讲述一些故事，并给出涉及计数、大小或时间流逝的画面。为了获取更多信息，我们可以使用日志服务来记录应用程序产生的消息。

如果你已经设置了一个 Linux 服务器，你可能熟悉通过`rsyslog`传递并通过位于`/var/log`中的文件结束的日志。在云服务中，尤其是在容器中，本地日志记录几乎没有什么用处，因为我们不得不调查所有运行的容器和云实例以发现发生了什么。相反，我们可以使用集中式日志服务。

可以使用 AWS CloudWatch 或 Google 的 Cloud Logging 等工具来完成这项工作，但也可以运行`Splunk`或`Logstash`等服务。后者是被称为`ELK`堆栈的流行开源工具组合的一部分，因为它包含了 Elasticsearch、Logstash 和 Kibana，用于收集、搜索和可视化日志数据。使用这些工具，系统和应用程序的所有日志最终都可以集中在一个地方，并便于检查。

使用结构化日志技术，注释所有日志条目以轻松确定哪个微服务产生了它们，从而更好地关联事件也是一件简单的事情。集中式日志服务将允许你连接一个组件中的错误和来自不同区域的报告之间的联系。同时，每个微服务更加隔离，这意味着它们对其他组件的影响应该通过设计的接口，而不是由于同一服务器上的资源限制或同一进程树中的副作用。

ELK 堆栈是收集大量日志和指标的一个很好的起点，你可以在[`www.elastic.co/what-is/elk-stack`](https://www.elastic.co/what-is/elk-stack)了解更多关于它的信息。

# 承诺

在编写软件时，我们通常不是孤立地工作，而是为了帮助我们的公司或开源项目实现目标。仅仅依靠我们的直觉来判断我们是否做得好往往具有误导性，因为我们的本能会受到人类所有不同偏见的影响。相反，我们必须进行测量——收集数据，观察模式，并分析数据。

为了展示我们的软件表现如何，无论是对我们自己还是对他人，我们可以考虑三个级别。第一个是我们可以测量的可能事物的列表，这些被称为**服务级别指标**（**SLIs**）。作为开发者，我们很容易列出与技术相关的 SLIs，例如：

+   API 响应时间（以毫秒为单位）

+   不同 HTTP 状态码的计数

+   每个请求中传输的字节数

然而，包含组织级别的指标同样至关重要，例如：

+   在线商店的结账过程需要多长时间

+   有多少潜在客户在结账过程中放弃购买

+   运行服务的财务成本，尤其是自动扩展和缩减的服务

当这两种类型的指标结合使用时，可以为组织提供非常有用的报告和仪表板，但你也不希望不断地检查事情——还有其他工作要做！**服务级别目标**（**SLO**）在**服务级别指标**（**SLI**）的基础上设置一个阈值或警报值，例如：

+   不到 1% 的 HTTP 状态码必须表示服务器错误

+   完成的结账操作率必须超过 75%

+   用户可以成功完成至少 99.9% 的请求而不会出现错误

如果未达到 SLO，我们应该怎么做？这就是**服务级别协议**（**SLA**）发挥作用的地方。SLA 是服务提供者和使用者之间的一种合同——无论是正式的还是非正式的——当 SLO 未达到时，它描述了应该发生什么。

这里有一个涵盖所有级别的示例：

+   服务级别指标：记录的 HTTP 500 错误数量

+   服务级别目标：HTTP 500 错误不应超过总请求的 1%

+   服务级别协议：当有站点可靠性工程师被通知，受影响的客户被通知时

创建 SLO 帮助开发人员和产品团队成员了解应用程序的重要之处，并让我们向所有相关人员展示应用程序正在做它应该做的事情。

# 摘要

作为软件开发者，我们永远不会停止提高我们的技能和知识，尝试新技术和架构，并建立在许多人的工作之上。我们职业的核心技能是以理性、有条理的方式处理情况，将问题的每一部分分解成可管理的块，并确保我们——以及对我们工作有利益相关的人——能够理解这一切。

微服务方法在系统设计中使用了相同的技巧，使得每个组件更容易进行推理和调查。像许多方法一样，当它经过仔细考虑而不是仅仅为了追随潮流时，它工作得非常好。

设计良好的应用程序需要知识、技能和经验的结合，我们希望这本书已经为你在工作中带来的专业知识做出了贡献，无论是付费工作、志愿服务还是爱好。
