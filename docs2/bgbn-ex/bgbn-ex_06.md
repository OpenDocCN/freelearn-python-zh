# 第六章：使用 BeagleBone 进行家庭自动化

在本章中，我们将学习如何使用 BeagleBone Black 构建家庭自动化系统。要开始，我们首先将学习关于互联网连接的家庭自动化系统以及它们是如何工作的。然后，我们将继续设置 Python Flask 库，它允许你使用 Python 在 BeagleBone Black 上运行 HTTP 服务器。

一旦我们在 Python 上使用 Flask 库运行服务器，我们将使用它来创建一个程序，你可以通过服务器创建的网页输入来打开和关闭 GPIO。这个 GPIO 引脚将用于打开和关闭一个电继电器来开关灯泡。

本章内容分为以下几部分：

+   前提条件

+   家庭自动化系统的结构

+   网络服务器简介

+   Python Flask 简介

+   在 BeagleBone 板上设置 Python Flask

+   使用 Flask 创建网络服务器

+   晶体管、继电器和电源开关

+   高级项目：互联网控制电源开关 – 从互联网控制交流灯泡

# 前提条件

本主题将涵盖本章中你需要哪些部分。你可以从任何电器店或在线购买。

## 需要的材料

+   1x BeagleBone Black

+   1x 带有最新版本 Debian 的 microSD 卡，用于从 microSD 卡启动 BeagleBone 板

+   1x 5V DC，2A 电源

+   1x 以太网线

+   1x 面包板

+   1x 继电器板

# 家庭自动化系统结构

本节将为你提供一个关于连接到互联网的家庭自动化系统的基本概念。在下面的图片中，你可以看到移动电话和物联网设备通过局域网路由器连接到互联网：

![家庭自动化系统结构](img/4602_06_01.jpg)

在本章中，我们也将使用 BeagleBone 板来做类似的事情，通过我们的家庭路由器连接到互联网，使用与 BeagleBone 板接口的继电器电路来控制交流灯泡。为此，我们将在 BeagleBone 板上设置一个 web 服务器。我们将在本章的下一个主题中看到如何做到这一点。

# 网络服务器简介

网络服务器是连接到互联网或内网的计算机，用于服务来自客户端计算机或移动设备的网络浏览器的请求。为了更好地理解这一点，请看下面的图片：

![网络服务器简介](img/4602_06_02.jpg)

因此，如图所示，web 服务器基本上是托管网页并基于从客户端设备上的网络浏览器发送的请求进行处理的计算机。客户端设备可以是 PC、笔记本电脑、移动电话、平板电脑或任何其他具有网络浏览器的设备，或者是一个可以发出 HTTP 请求的 Linux shell。

仔细看看下面的图片，以更好地理解这一点：

![网络服务器简介](img/4602_06_03.jpg)

现在您可以看到多个客户端通过互联网连接到多个服务器，这就是**万维网**（**WWW**），**TCP/IP 网络**。

什么是 TCP/IP？当你在浏览器中输入 URL 并按回车键时，究竟发生了什么？

看看下面的图片来了解更多信息：

![Web 服务器简介](img/4602_06_04.jpg)

类似地，在我们的系统中，我们有一个 Web 服务器，它执行前面图片中显示的所有过程。有一点不同，我们的网页将能够控制 AC 灯泡。现在，既然我们知道了 Web 服务器的工作原理，让我们继续在 BeagleBone 板上使用 Flask Python 设置一个 Web 服务器。

# Python-Flask 在 BeagleBone Black 上

Flask 是一个用于设置 Web 服务器的 Python 框架。在本主题中，我们将探讨如何使用 Python 在 BeagleBone Black 上设置 Web 服务器。要开始，我们需要在 BeagleBone Black 上从 Python 包索引安装 Python-Flask 包。以下步骤将指导您如何设置 Flask 并测试它，然后编写 Python 代码将其与继电器电路接口。我们将在下一主题中看到这一点，然后在本章的最后一个主题中，我们将看到从互联网控制 AC 灯泡的主要项目：

第 1 步：按照以下步骤安装 PIP：

+   `sudo apt-get install python-pip`：

    你应该能看到它已经被安装了，因为我们已经安装了最新的 Debian 版本，并且它已经在版本中可用。其他一些版本可能没有这个功能，如果没有可用，则会安装，如果当前操作系统中安装的版本有更新，则会升级。

    ![Python-Flask on BeagleBone Black](img/4602_06_05.jpg)

    PIP 安装并管理用 Python 编写的软件包。许多软件包可以在**Python 包索引**（**PyPI**）中找到。

第 2 步：按照以下步骤安装 Flask-Python 库：

+   `sudo pip install flask`![Python-Flask on BeagleBone Black](img/4602_06_06.jpg)

创建一个基本的 Web 应用程序来测试是否成功安装了包，如下所示：

第 1 步：在您的 BeagleBone Black 上创建一个目录：

+   `mkdir HomeAutomation`![Python-Flask on BeagleBone Black](img/4602_06_07.jpg)

第 2 步：切换到您创建的目录：

+   `cd HomeAutomation`![Python-Flask on BeagleBone Black](img/4602_06_08.jpg)

第 3 步：创建一个 Python 文件并编写以下代码来设置一个打印 Hello World 网页服务器的服务器：

+   `nano WebApp.py`![Python-Flask on BeagleBone Black](img/4602_06_09.jpg)

现在按照以下所示在您创建的文件中输入代码并保存：

![Python-Flask on BeagleBone Black](img/4602_06_10.jpg)

第 4 步：按照以下步骤运行 Python 程序：

+   `sudo python WebApp.py`![Python-Flask on BeagleBone Black](img/4602_06_11.jpg)

如果您看到的前面图片中的输出，那么您已经正确完成了前面的步骤，我们已经在 BeagleBone 板上启动并运行了一个服务器。

现在通过打开连接到同一局域网（与 BeagleBone 连接的局域网）的 PC 或手机上的网页来打开我们在 BeagleBone 板上运行的网络服务器。为了做到这一点，输入以下内容：`BeagleBone 板的 IP 地址:5000`，所以，在我的情况下，它将是浏览器地址栏上的 `192.168.1.20:5000`，其中 `5000` 是 Python-Flask 路由其连接的默认端口号。你可以将其更改为不同的端口号。在网络上了解更多关于不同网络服务器端口的详细信息。

当你从浏览器调用服务器时，你应该会看到类似下面的内容：

![Python-Flask 在 BeagleBone Black 上](img/4602_06_12.jpg)

你还将能够看到浏览器在 BeagleBone 服务器上发出的请求调用，如下面的截图所示：

![Python-Flask 在 BeagleBone Black 上](img/4602_06_13.jpg)

按 *Ctrl* + *C* 来停止它：

![Python-Flask 在 BeagleBone Black 上](img/4602_06_14.jpg)

现在我们用 Python-Flask 通过回显一行文本做了一件非常基础的事情。

让我们继续使用 HTML 布局做一些事情，使网页看起来更好。为此，在家庭自动化目录内创建一个名为 `templates` 的目录：

+   `mkdir templates`![Python-Flask 在 BeagleBone Black 上](img/4602_06_15.jpg)

切换到你创建的新模板目录，以便在其中创建和保存 HTML 文件：

+   `cd templates`![Python-Flask 在 BeagleBone Black 上](img/4602_06_16.jpg)

因此，这个目录将是您找到 HTML 和 CSS 文件的地方，通过这些文件可以将网络服务器路由到客户端设备浏览器的请求。

现在，让我们继续在这个目录内创建一个 HTML 页面，如下面的截图所示：

+   `nano index.html`![Python-Flask 在 BeagleBone Black 上](img/4602_06_17.jpg)

当你在 HTML 文件中输入内容完成，如图所示，你可以通过按 *Ctrl* + *X* 来保存文件。保存后，继续切换回家庭自动化目录：

+   `cd ..`![Python-Flask 在 BeagleBone Black 上](img/4602_06_18.jpg)

现在我们需要编写一个不同的程序来将网络服务器路由到我们创建的 HTML 文件。而不是从头开始编写，让我们修改之前创建的 `WebApp.py` 文件，并将其保存为 `WebAppFromTemplate.py`，因为大部分代码行都是相同的。如下面的截图所示：

![Python-Flask 在 BeagleBone Black 上](img/4602_06_19.jpg)

一旦你编辑了文件并将其保存为 `WebAppFromTemplate.py`，你可以继续运行以下代码：

+   `sudo python WebAppFromTemplate.py`

再次，让我们打开浏览器中的 URL 并检查输出。你应该会看到类似于下面图片所示的网页：

![Python-Flask 在 BeagleBone Black 上](img/4602_06_20.jpg)

现在您可以看到文本**Webpage from a template!**是使用 HTML 格式化的，并且您可以看到它作为一个基于 HTML 的网页。

和上次一样，您将看到浏览器为调试 shell 发出的 HTTP 调用：

![Python-Flask on BeagleBone Black](img/4602_06_21.jpg)

对于本章中我们控制来自互联网的交流灯泡的项目，我们应该在网页上放置按钮，而不是之前显示的纯文本。

为了在 HTML 页面上放置按钮，我们需要编写网页模板的 HTML 代码，同样，我们也应该编写 Python 代码来读取网页上按钮点击时的输入。我们可以使用这些输入通过 Python 代码来改变 BeagleBone Black 上 GPIO 的状态。

我们将在本章的项目部分详细探讨如何从 HTML 按钮点击输入中切换 GPIO 状态。在此之前，作为这个主题的最后一部分，让我们创建一个带有按钮输入的 HTML 页面，当这些输入被触发时读取它们，并打印出特定按钮被点击的文本。网页上将有两个按钮，它们将是**ON**和**OFF**。无论哪个按钮在网页上被点击，Python 代码都会打印出该按钮被点击的信息。让我们继续做吧。

首先，切换回模板文件夹，创建一个名为`main.html`的文件，其内容如以下截图所示：

![Python-Flask on BeagleBone Black](img/4602_06_22.jpg)

现在您可以看到它有两个带有 ID 的按钮元素。

完成创建此文件后，保存它并返回到智能家居目录，根据以下截图编辑文件`WebAppFromTemplate.py`，并将其保存为`ControlWebApp.py`：

![Python-Flask on BeagleBone Black](img/4602_06_23.jpg)

保存后，您可以继续运行程序，如下所示：

+   `sudo python ControlWebApp.py`![Python-Flask on BeagleBone Black](img/4602_06_24.jpg)

现在您可以打开网页，看看它的样子。您应该会看到以下截图类似的内容：

![Python-Flask on BeagleBone Black](img/4602_06_25.jpg)

当您点击**ON**按钮时，您应该会看到以下截图类似的内容：

![Python-Flask on BeagleBone Black](img/4602_06_26.jpg)

输出如下：

![Python-Flask on BeagleBone Black](img/4602_06_27.jpg)

当您点击**OFF**按钮时，您应该会看到以下截图类似的内容：

![Python-Flask on BeagleBone Black](img/4602_06_28.jpg)

因此，我们现在有一个程序可以打印出哪个按钮被点击了。我们只需要编写一个程序，在网页上按下按钮时，将 BeagleBone Black 上可用的 GPIO 的状态改变为高和低。我们将在本章的项目主题中这样做。在这样做之前，在本章的主题中，我们将学习继电器电路是如何工作的，以及我们如何使用从 BeagleBone Black 的 GPIO 引脚获得的非常低的电压来切换继电器电路。这样我们就能使用继电器来开关交流灯泡。

# 晶体管、继电器、电源开关

因此，基本上，要切换交流电器或任何电路，你需要一个开关，就像你在家里有的那样，你有一个开关来打开灯或风扇。涉及的基本电路看起来非常像下面的图片：

![晶体管、继电器、电源开关](img/4602_06_29.jpg)

因此，正如我们可以在前面的图片中看到的那样，如果你切换开关，它将打开和关闭电路。这反过来会使灯泡关闭和开启。但这在普通机械开关中是机械完成的。

每当我们想要执行相同的动作时，我们都会使用电控开关，这些开关位于电气继电器上。下面的图片显示了电气继电器在开启和关闭状态下的图像：

![晶体管、继电器、电源开关](img/4602_06_30.jpg)

在前面的图中，你可以看到，当电源从**3V**电源供给线圈时，线圈被激活并像磁铁一样拉动端子向下。这连接了另一个端子并闭合了电路，电流从**6V**电池流向直流灯。你可以在前面的图像中的图 2 中看到这个动作。而当线圈失电时，如图 1 所示，端子保持开放，这切断了电路并使其打开，因此灯处于关闭状态，因为没有电流通过电路。再次，在前面的例子中，你可以看到使用机械开关来切换低压供电（3V），而电气继电器则切换高压供电。

通常容易获得的继电器是 5V 直流供电的，其中线圈激活所需的电压是 5V，以及足够的电流供应。但 BeagleBone 板上可用的 GPIO 在 HIGH 状态下为 3.3V，在 LOW 状态下为 0V。我们将在其中间使用一个新的电子元件来切换低压供电，这个元件是晶体管。我不会深入讲解晶体管类型及其工作原理的细节。你可以浏览一下，详细了解它。但在基本术语中，当晶体管的基极供电时，它就是一个电子控制的开关，即导通通过集电极和发射极；当晶体管的基极为低，即关闭时，没有导通发生。

观察以下图表，了解当使用继电器为 AC 灯泡建立连接时，我们的电路将如何通过晶体管与继电器接口：

![晶体管、继电器、电源开关](img/4602_06_31.jpg)

因此，每当基极驱动器打开，即高电平时，它将打开继电器；而每当晶体管的基极关闭，或低电平时，它将关闭继电器，进而关闭 AC 灯泡。

您可以直接将晶体管的基极连接到 BeagleBone 板的 GPIO 上，这样当 GPIO 引脚为高电平时，晶体管将打开，当 GPIO 引脚为低电平时，晶体管将关闭。

有现成的继电器板，带有晶体管和继电器。您可以直接将这些与 BeagleBone 板或其他任何微控制器板接口，如下面图片所示：

![晶体管、继电器、电源开关](img/4602_06_32.jpg)

获得这些之一将使您的工作变得简单，但如果您想自己制作，也可以通过在互联网上搜索来实现。为了使下一步更容易，我获得了一个现成的模块，并将其接口连接到 BeagleBone Black 的 GPIO 上。连接相当直接，如前图所示。继电器模块的 D1 连接到 GPIO_60，即 P9_12，Vcc 连接到 BeagleBone Black 的 5V，继电器模块的 Gnd 引脚连接到继电器模块的 Gnd 引脚。通过继电器的 K1 NO 和 C 端子将 AC 灯泡的相线和零线连接到继电器，因为 D1 输入对应于模块中 K1 继电器的切换。

![晶体管、继电器、电源开关](img/4602_06_47.jpg)

您可以通过查看上面给出的电路图来获得更多关于电路连接的详细信息。

![晶体管、继电器、电源开关](img/4602_06_33.jpg)

一旦完成电路连接，使用我们在第二章中使用的闪烁代码来测试继电器是否能够打开和关闭，或者继续到下一个主题，编写从网页控制电路的代码。

# 高级项目：互联网控制电源开关 – 从互联网控制 AC 灯泡

现在我们已经从上一个主题中设置了电路，我们将用 Python 编写代码来从网页切换 GPIO 到高电平和低电平。您可以继续编写如下截图所示的代码：

![高级项目：互联网控制电源开关 – 从互联网控制 AC 灯泡](img/4602_06_34.jpg)

现在将文件保存为 `GPIOControlWebApp.py`。

让我们运行代码来开关灯泡，然后从 Android 平板电脑打开页面。该平板电脑连接到与 BeagleBone 板相同的 LAN Wi-Fi 路由器。点击开关按钮，您将在以下截图所示的 shell 终端中看到输出：

![高级项目：互联网控制电源开关 – 从互联网控制 AC 灯泡](img/4602_06_35.jpg)

灯泡将像以下图片所示那样开关：

![高级项目：互联网控制电源开关 – 从互联网控制 AC 灯泡](img/4602_06_36.jpg)

灯泡处于关闭状态

![高级项目：互联网控制电源开关 – 从互联网控制 AC 灯泡](img/4602_06_37.jpg)

灯泡处于开启状态

但现在，我们只是在我们的本地网络内，在我们的家庭路由器 LAN 网络中进行此操作，BeagleBone 板连接到这个网络。如果我们想通过手机上的 3G 连接来控制灯泡怎么办？在这种情况下，你需要将你的 BeagleBone Black 路由并从你的手机通过互联网连接到它，你的手机通过 3G 连接到互联网。如果你回到本章的 Web 服务器主题，你可以看到有很多路由器、DNS 网关在客户端和服务器之间连接到互联网的任一端。在我们的情况下，我们的 BeagleBone 板设备本身正在充当服务器。我们只是将路由器的端口转发设置好，将路由器公共 IP 地址收到的请求重定向到 BeagleBone Black 托管服务器的特定端口，即 5000，在我们的例子中，这是 Python-Flask 路由请求的默认端口。所以，让我们继续进行端口转发，通过互联网服务提供商分配给我们的路由器的公网 IP 地址来访问 BeagleBone 板上的 Web 服务器。

## 设置端口转发

按照以下步骤设置端口转发：

1.  正如我们在第一章*开始使用 BeagleBone*中做的那样，登录到你的路由器配置页面：![设置端口转发](img/4602_06_38.jpg)

1.  前往**高级**设置：![设置端口转发](img/4602_06_39.jpg)

1.  前往**高级设置**：![设置端口转发](img/4602_06_40.jpg)

1.  点击**端口转发**：![设置端口转发](img/4602_06_41.jpg)

1.  点击**添加自定义服务**。你将看到如下截图所示的页面：![设置端口转发](img/4602_06_42.jpg)

填写详细信息，然后通过点击**应用**来保存配置：

![设置端口转发](img/4602_06_43.jpg)![设置端口转发](img/4602_06_44.jpg)

完成这些操作后，去谷歌搜索“我的 IP 是什么？”这将检查你的公网 IP 地址，你应该会得到如下截图所示的输出：

![设置端口转发](img/4602_06_45.jpg)

一旦你有了这个，拿出你的手机并连接到 3G，使用这个公网 IP 地址加上端口号`5000`来访问你的 BeagleBone 板。这将允许你通过手机开关 AC 灯泡。你将看到一个如下截图所示的网页：

![设置端口转发](img/4602_06_46.jpg)

现在，你可以将网络链接`183.82.111.33:5000`提供给任何连接到互联网的人，以便他们可以访问你的 BeagleBone 板，并从世界任何地方控制灯泡。这样，你的家庭自动化系统就已经连接到互联网了。你也可以称之为在本章结束时你已经构建了自己的物联网项目。尝试自己控制两个电器，更改 HTML 网页的风格，并为网页添加颜色和控制图形，以学习和获得更多乐趣。

# 摘要

在本章中，我们学习了如何通过互联网设置我们自己的家庭自动化系统，其中空调灯泡可以从世界任何地方通过互联网进行控制。在构建它的过程中，我们学习了如何在 BeagleBone 板上使用 Python-Flask 网络框架设置一个网络服务器。然后我们还学习了如何使用继电器电路将交流电路与 BeagleBone 板连接起来，通过运行在 BeagleBone 板上的网络服务器来控制交流灯泡。通过这种方式，你已经在本章中构建了一个高级的物联网项目。在下一章中，我们将探讨如何将摄像头与 BeagleBone Black 连接起来，并在 BeagleBone Black 上使用 OpenCV 进行图像处理。
