- en: '10'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '10'
- en: Types of Orders and Their Simulation in Python
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 订单类型及其在Python中的模拟
- en: In the previous chapter, we considered a number of classical trading strategies
    usually employed in FX trading. All of them can be automated – that is, the decision
    to place a trade can be made based on quantitative data only, and placing a trade
    in the market can be done by an algorithm. So, we need now to find a proper way
    to place trades and control their execution.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 在上一章中，我们考虑了在FX交易中通常采用的一些经典交易策略。所有这些都可以自动化——也就是说，是否进行交易的决策可以仅基于定量数据，而将交易放入市场可以通过算法完成。因此，我们现在需要找到一种适当的方式来放置交易并控制其执行。
- en: 'We already mentioned (see [*Chapter 1*](B19145_01.xhtml#_idTextAnchor014),
    *Developing Trading Strategies – Why They Are Different*) that any trade, manual
    or automated, can be placed in the market by using an order: an instruction to
    the broker (or any other intermediary) to buy or sell. What could be simpler?
    However, the reality is always more complex. You may want to trade at a certain
    price, no worse than a certain price, no more than a specified amount of pips
    (points) from a certain price, and so on. Besides that, in the real market, there
    is real liquidity, which is always very far from infinite, so you may have your
    orders rejected, filled partially, or executed at the *wrong* prices, and many
    more unexpected and undesired things may happen if you are not prepared.'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 我们已经提到（见[*第1章*](B19145_01.xhtml#_idTextAnchor014)，*开发交易策略——为什么它们不同*），任何交易，无论是手动还是自动化，都可以通过使用订单在市场上进行：向经纪人（或任何其他中介）发出买入或卖出的指令。还有什么能比这更简单？然而，现实总是更复杂。你可能希望在某个价格进行交易，不低于某个价格，不超过从某个价格指定的pip（点）数，等等。除此之外，在真实市场中，存在真实的流动性，这总是非常远离无限，因此你的订单可能会被拒绝，部分成交，或者以*错误*的价格执行，以及许多其他未预料到和不受欢迎的事情，如果你没有做好准备的话。
- en: Now, it’s time we learn about the main types of orders typically supported by
    most FX liquidity pools, consider the difference in execution depending on the
    order type, understand the choice of order types depending on the goal, and get
    prepared to outline the architecture of an order simulation engine, which imitates
    possible execution issues and, along with the trade logic, helps you test and
    improve your strategy to fit the real-life conditions before putting real money
    at stake.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，是我们学习大多数FX流动性池通常支持的主要订单类型的时候了，考虑根据订单类型的不同执行差异，了解根据目标选择订单类型，并准备好概述订单模拟引擎的架构，该引擎模仿可能的执行问题，并随着交易逻辑一起，帮助你测试和改进你的策略，以便在实际投入真金白银之前适应现实生活条件。
- en: 'In this chapter, we will cover the following topics:'
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将涵盖以下主题：
- en: Order ticket – what you send is what you get
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 订单票据——你发送的即你得到的
- en: Market orders – the way to get maximum control over transactional risk
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 市场订单——控制交易风险的最大方式
- en: Limit orders – guaranteed price, but not execution
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 限价订单——保证价格，但不保证执行
- en: Time in force – better control over execution
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 有效期限——更好地控制执行
- en: Stop orders – maximum uncontrolled risk
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 止损订单——最大未受控风险
- en: Compound orders
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 复合订单
- en: Order ticket – what you send is what you get
  id: totrans-12
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 订单票据——你发送的即你得到的
- en: Let’s start with drafting a prototype of a general order ticket – something
    that is sent to a trading venue.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们从起草一份通用订单票据的原型开始——这是发送给交易场所的东西。
- en: Normally, orders are sent either as FIX messages (see [*Chapter 4*](B19145_04.xhtml#_idTextAnchor073),
    *Trading Application – What’s Inside?*) or in JSON format according to the venue’s
    specifications. As we also noted in [*Chapter 4*](B19145_04.xhtml#_idTextAnchor073),
    every venue has its own data and ordering interfaces, but the core properties
    of an order always remain the same.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 通常，订单以FIX消息（见[*第4章*](B19145_04.xhtml#_idTextAnchor073)，*交易应用——内部结构是什么？*）或根据场所规格的JSON格式发送。正如我们在[*第4章*](B19145_04.xhtml#_idTextAnchor073)中提到的，每个场所都有自己的数据和订单接口，但订单的核心属性始终是相同的。
- en: Actually, the list of these properties is quite logical. Let’s prepare an empty
    form and fill in its fields one by one.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 实际上，这些属性的列表相当合理。让我们准备一个空表单，并逐个填写其字段。
- en: 'First, each order should go out with an ID. Otherwise, how do we or the trading
    venue refer to it? If we trade live, then the trading venue will generate an order
    ID that we receive, but if we run a backtest and want to modify orders that had
    been sent earlier, we need an internally generated order ID. Anyway, number one
    in our order form is **Order ID**:'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，每个订单都应该附带一个ID。否则，我们或交易场所如何引用它？如果我们进行实时交易，那么交易场所将生成一个订单ID供我们接收，但如果我们运行回测并想要修改之前发送的订单，我们需要一个内部生成的订单ID。无论如何，在我们的订单表格中，第一项是**订单ID**：
- en: "![Figure \uFEFF10.1 – The first attribute of an order is Order ID](img/B19145_10_01.jpg)"
  id: totrans-17
  prefs: []
  type: TYPE_IMG
  zh: '![图10.1 – 订单的第一个属性是订单ID](img/B19145_10_01.jpg)'
- en: Figure 10.1 – The first attribute of an order is Order ID
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.1 – 订单的第一个属性是订单ID
- en: 'Next, we need to let the venue know which market we want to trade in. As always,
    please keep in mind that every trading venue has its own specification. For example,
    EURUSD can be sent as *EURUSD*, *EUR/USD*, *eur-usd*, and so on. So, check the
    venue’s documentation before actually sending orders. Let’s add the second record
    to the order ticket – **Instrument ID**:'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，我们需要让场所知道我们想要在哪个市场进行交易。一如既往，请记住，每个交易场所都有自己的规定。例如，EURUSD可以发送为*EURUSD*、*EUR/USD*、*eur-usd*等等。所以，在实际上发送订单之前，请检查场所的文档。让我们将第二个记录添加到订单单据中
    – **工具ID**：
- en: "![Figure \uFEFF10.2 – Instrument ID added](img/B19145_10_02.jpg)"
  id: totrans-20
  prefs: []
  type: TYPE_IMG
  zh: '![图10.2 – 添加了工具ID](img/B19145_10_02.jpg)'
- en: Figure 10.2 – Instrument ID added
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.2 – 添加了工具ID
- en: We also need to specify the amount we want to trade or the trading size. The
    trading size can be specified in lots (again, refer to the venue’s documentation
    regarding how much one lot is) or just in money.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 我们还需要指定我们想要交易的数量或交易大小。交易大小可以用手数（再次，请参考场所文档了解一手是多少）或直接用货币来指定。
- en: 'For example, with LMAX, an order to buy 1 lot of EUR USD would mean buying
    1,000 euros and selling the respective amount of the US dollars, and with Interactive
    Brokers, an order to sell 100,000 USD JPY would mean actually selling 100,000
    USD and buying the respective amount of the Japanese yen. Be careful when specifying
    the order size! Now, our order ticket consists of three records:'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，在LMAX，购买1手EUR USD的订单意味着购买1,000欧元并卖出相应数量的美元，而在Interactive Brokers，卖出100,000美元JPY的订单实际上意味着卖出100,000美元并买入相应数量的日元。在指定订单大小时要小心！现在，我们的订单单据由三个记录组成：
- en: "![Figure \uFEFF10.3 – Trading size specified in the order](img/B19145_10_03.jpg)"
  id: totrans-24
  prefs: []
  type: TYPE_IMG
  zh: '![图10.3 – 订单中指定的交易大小](img/B19145_10_03.jpg)'
- en: Figure 10.3 – Trading size specified in the order
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.3 – 订单中指定的交易大小
- en: 'And of course, we should specify the side of the trade: whether we want to
    buy or sell. Some venues just use *BUY* and *SELL* specifiers, while others suggest
    using *BID* and *ASK* to denote the side, so as you can see, the advice to consult
    the venue’s documentation is the only stable thing in algo trading. All in all,
    now we have four records in the order ticket:'
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，我们还应该指定交易的哪一方：我们是要买还是卖。一些场所仅使用*买*和*卖*指定符，而其他场所建议使用*买入价*和*卖出价*来表示方向，所以正如你所见，咨询场所文档是算法交易中唯一稳定的东西。总的来说，现在我们的订单单据上有四个记录：
- en: "![Figure \uFEFF10.4 – Specifying the side of the trade](img/B19145_10_04.jpg)"
  id: totrans-27
  prefs: []
  type: TYPE_IMG
  zh: '![图10.4 – 指定交易的哪一方](img/B19145_10_04.jpg)'
- en: Figure 10.4 – Specifying the side of the trade
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.4 – 指定交易的哪一方
- en: 'Are we ready to go? Seems so, but not really. The trading venue expects a few
    other parameters of our trade to be specified: we should say *how* we want the
    order to be executed, *at which price*, and *when*. The first of these three extra
    parameters is called the order type, and we normally distinguish between *market
    orders*, *limit orders*, and *stop orders*. There are also so-called **compound**
    or **conditional orders**, which essentially are combinations of these basic three
    order types, but they are not supported by all venues. So we will consider in
    detail only the three main types of orders.'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 我们准备好了吗？看起来是这样，但实际上并没有。交易场所期望我们指定一些其他交易参数：我们应该说明我们希望如何执行订单，*在什么价格*，以及*何时*。这三个额外参数中的第一个被称为订单类型，我们通常区分*市价订单*、*限价订单*和*止损订单*。还有一些所谓的**复合**或**条件订单**，它们本质上是由这三种基本订单类型的组合，但并非所有场所都支持。因此，我们只将详细考虑这三种主要订单类型。
- en: Market orders – the way to get maximum control over transactional risk
  id: totrans-30
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 市价订单 – 获取最大交易风险控制的途径
- en: 'Let’s start with the most simplistic (at least at first glance) type of order:
    the market order. A **market order** is an order to buy or sell a certain amount
    of an asset at a **market price**. By market price, we normally assume the best
    bid or the best ask (see [*Chapter 3*](B19145_03.xhtml#_idTextAnchor044), *FX
    Market Overview from a Developer’s Standpoint,* for the explanation of the best
    bid and ask), and most trading strategy developers test their ideas using only
    the best bid/ask historical data. So, we can add another record to our order ticket
    prototype, and this record represents the order type:'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们从最简单（至少从第一眼看来）的订单类型开始：市价订单。**市价订单**是购买或出售一定数量的资产以**市价**的订单。通过市价，我们通常假设最佳买入价或最佳卖出价（参见[*第3章*](B19145_03.xhtml#_idTextAnchor044)，*从开发者角度的FX市场概述*，关于最佳买入价和卖出价的解释），并且大多数交易策略开发者仅使用最佳买入/卖出历史数据来测试他们的想法。因此，我们可以在我们的订单票证原型中添加另一条记录，这条记录代表订单类型：
- en: "![Figure \uFEFF10.5 – Specifying the order type](img/B19145_10_05.jpg)"
  id: totrans-32
  prefs: []
  type: TYPE_IMG
  zh: '![图10.5 – 指定订单类型](img/B19145_10_05.jpg)'
- en: Figure 10.5 – Specifying the order type
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.5 – 指定订单类型
- en: We already saw (see again [*Chapter 3*](B19145_03.xhtml#_idTextAnchor044), *FX
    Market Overview from a Developer’s Standpoint*) that liquidity may have a substantial
    impact on how orders are executed in reality and it is considered quite a frequent
    situation when a single large order may move the best bid or ask during its execution.
    So, it’s important to make sure that the order will be executed at a price closest
    to the last best bid or best ask seen in the order book immediately before sending
    the order to the market.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 我们已经看到（再次参见[*第3章*](B19145_03.xhtml#_idTextAnchor044)，*从开发者角度的FX市场概述*），流动性可能对实际订单执行方式有重大影响，并且当单个大订单在执行过程中可能移动最佳买入价或卖出价时，这种情况被认为是相当常见的。因此，在将订单发送到市场之前，确保订单将以最接近订单簿中立即看到的最优买入价或最优卖出价的价格执行是很重要的。
- en: Using this order type makes sure that if the order is executed, then you get
    the exact amount of the traded asset specified in the order. At the same time,
    it doesn’t guarantee that the average execution price will be the same as the
    top of the book because this kind of execution method allows buying or selling
    up to the entire amount currently present in the order book.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 使用这种订单类型可以确保如果订单被执行，那么你将获得订单中指定的交易资产的准确数量。同时，它并不保证平均执行价格将与订单簿的顶部相同，因为这种执行方法允许购买或出售订单簿中目前存在的全部金额。
- en: For example, let’s have a look back at the example of an order book shown in
    [*Chapter 3*](B19145_03.xhtml#_idTextAnchor044) (*Figure 3**.1* in the *Exchange
    and order book* section). Imagine that we send a market order to buy 1,000 contracts.
    Will it be executed? Yes, because there are more than 1,000 contracts in the order
    book. But at which price will it be filled?
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，让我们回顾一下[*第3章*](B19145_03.xhtml#_idTextAnchor044)（*交易所和订单簿*部分中的*图3.1*）中显示的订单簿示例。想象一下，我们发送一个市价订单购买1,000份合约。它会被执行吗？是的，因为订单簿中有超过1,000份合约。但将以什么价格成交呢？
- en: 'The order book at the moment of sending the order had 155 contracts at the
    best ask price (2,149.25), then 306 contracts at 2,149.50, then 291 contracts
    at 2,149.75, and 532 contracts at 2,150.0\. So our order will consume all liquidity
    from the first 3 price levels and 248 contracts from the 4th. The resulting average
    execution price can be calculated using the standard weighted average formula:'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 发送订单时的订单簿中，最优卖出价（2,149.25）有155份合约，然后是2,149.50的306份合约，接着是2,149.75的291份合约，最后是2,150.0的532份合约。因此，我们的订单将消耗前三个价格水平上的所有流动性，以及第四个价格水平上的248份合约。结果平均执行价格可以使用标准加权平均公式计算：
- en: '![](img/Formula_B19145_10_001.jpg)'
  id: totrans-38
  prefs: []
  type: TYPE_IMG
  zh: '![公式B19145_10_001.jpg]'
- en: Here, *P* means the weighted average price, *p* denotes the price in the order
    book, and *q* means the quantity, the number of contracts traded at the price,
    *p*. In our example, it will be about 2,149.658, which is quite far from 2,145.25,
    which used to be the best ask at the moment we fired our order.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 在这里，*P*代表加权平均价格，*p*表示订单簿中的价格，而*q*表示数量，即在价格*p*下成交的合约数量。在我们的例子中，它将是大约2,149.658，这比2,145.25要远得多，后者是我们发出订单时的最佳卖出价。
- en: The phenomenon of an order being executed at a worse market price or the process
    of filling the order in parts according to the present liquidity is called **slippage**.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 订单以更差的市场价格执行或根据现有流动性分部分填充订单的现象称为**滑点**。
- en: So, market orders can be useful when we need to fill the exact trading size,
    but this also may lead to filling at a price worse than expected. Why then did
    we say that market orders are *the way to get maximum control over transactional
    risk* in the very title of this section?
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，当我们需要填补确切的交易规模时，市价单可能是有用的，但这也可能导致以低于预期的价格填补。那么，为什么我们说市价单是*控制交易风险的最大途径*呢？
- en: The reason is that by using market orders, you can be as granular and as precise
    with the ordering as possible. Indeed, nothing prevents us from developing an
    algorithm that would first check the liquidity in the order book and then send
    orders only of the amount that would not destroy it. In case you need to fill
    an order with a large size (for example, you work for a financial institution),
    you can split this order into parts and send multiple market orders in sequence
    until the entire amount is filled – again, without disturbing the order book too
    much.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 原因在于，使用市价单，我们可以尽可能地对订单进行细粒度和精确的排序。确实，没有什么阻止我们开发一个算法，该算法首先检查订单簿中的流动性，然后只发送不会破坏流动性的订单。如果你需要用大额订单（例如，如果你为金融机构工作）来填补订单，你可以将这个订单分成几部分，并依次发送多个市价单，直到整个金额被填补——再次强调，不要过多地干扰订单簿。
- en: Another *benefit*, if I may say so, of using market orders is that this is the
    only type of order that is accepted by all trading venues without a single exception.
    Although we are going to consider orders of other types, such as limit and stop,
    remember that they are not always supported by the venue with which you plan to
    work.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我可以这么说的话，使用市价单的另一个*好处*是，这是唯一一种所有交易场所都接受而没有例外的情况。虽然我们将会考虑其他类型的订单，例如限价和止损，但请记住，它们并不总是由你计划与之合作的场所支持。
- en: Possible execution issues
  id: totrans-44
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 可能的执行问题
- en: 'Besides the liquidity and average price fills just discussed, the main issue
    with market orders is that such an order (if sent without a time-in-force specifier
    – see later in this chapter) will be executed at whatever price is currently present
    in the market. Yes, 99% of the time, it doesn’t cause real issues as the liquidity
    is quite sufficient, especially if you trade major currency pairs (those that
    constitute the US dollar index, see [*Chapter 9*](B19145_09.xhtml#_idTextAnchor152),
    *Trading Strategies and Their Core Elements*, the *Common FX benchmarks – US dollar
    index* section), but do you remember what happens around the time important economic
    news is released? Just have a quick look back at *Figure 6**.2* and *Figure 6**.4*
    in [*Chapter 6*](B19145_06.xhtml#_idTextAnchor101), *Basics of Fundamental Analysis
    and its Possible Use in FX Trading*, and refresh the US **non-farm payroll** (**NFP**)
    and UK GDP cases: the gaps or the distance in price between just adjacent ticks
    during such an event may reach dozens of pips.'
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 除了刚才讨论的流动性和平均价格填补问题外，市价单的主要问题是，这样的订单（如果没有指定有效期——见本章后面的内容）将以当前市场中的任何价格执行。是的，99%
    的时间，它不会引起真正的问题，因为流动性相当充足，尤其是如果你交易主要货币对（构成美元指数的那些货币对，见[*第9章*](B19145_09.xhtml#_idTextAnchor152)，*交易策略及其核心要素*，*常见外汇基准——美元指数*部分），但你记得在重要经济新闻发布时会发生什么吗？快速回顾一下[*第6章*](B19145_06.xhtml#_idTextAnchor101)，*基本面分析的基础及其在FX交易中的可能用途*中的*图6.2*和*图6.4*，并刷新一下美国**非农就业人数**（**NFP**）和英国GDP案例：在这些事件发生期间，相邻价格跳动之间的差距或距离可能达到几十个点。
- en: So, if we consider the US NFP case, and assume that you wanted to sell at 1.0230
    with a market order a second before the NFP was released, so the order most likely
    would have been executed at the first tick after the news release, which was at
    1.0210 – 20 pips away from the desired price!
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，如果我们考虑美国NFP案例，并假设你希望在NFP发布前的一秒以市价单卖出1.0230，那么订单很可能会在新闻发布后的第一个跳动时执行，即1.0210——距离期望价格有20个点的差距！
- en: 'Alright, seems like it’s more or less clear with market orders: we say *buy*
    or *sell* and get filled immediately (with or without liquidity-related issues).
    But what to do if we want to buy or sell *at a certain price*, or, to be even
    more precise, to get our order executed at no worse than a certain price? Well,
    here comes the limit order.'
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 好吧，看来市价单的情况大致是清晰的：我们说*买入*或*卖出*，然后立即成交（无论是否有流动性相关的问题）。但如果我们想以*某个特定价格*买入或卖出，或者更精确地说，以不差于某个价格的价格执行我们的订单，我们该怎么办？嗯，这就是限价单的作用。
- en: Limit orders – guaranteed price, but not execution
  id: totrans-48
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 限价单 - 保证价格，但不保证执行
- en: In general and brief, a **limit order** is an order to buy or sell the specified
    amount of the asset at the specified price or better.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 简要来说，**限价订单**是在指定价格或更好的价格买入或卖出指定数量的资产的一种订单。
- en: What does *better* mean here?
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 这里“更好”是什么意思？
- en: This means that if I send a limit order to *buy* EURUSD at 1.0100, then any
    price *below* 1.0100 will match my order. On the contrary, if I send a limit order
    to *sell* EURUSD at 1.0100, then any price *above* this level will match. In other
    words, by using a limit order, I say that *I am ready to buy or sell at any price
    no worse than the one specified in* *the order*.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 这意味着如果我发送一个以 1.0100 买入 EURUSD 的限价订单，那么任何低于 1.0100 的价格都将匹配我的订单。相反，如果我发送一个以 1.0100
    卖出 EURUSD 的限价订单，那么任何高于这个水平的价格都将匹配。换句话说，通过使用限价订单，我表示*我愿意以订单中指定的任何不低于该价格的价格买入或卖出*。
- en: What happens if you send a limit order at a price that is better than the current
    market price? For example, a *buy limit* order at a price that is *below* the
    current ask? Well, it depends on the particular implementation of limit orders
    used by your broker or execution venue. If you trade at an exchange (for example,
    if you trade currency futures), then your order will be routed directly into the
    order book.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你以比当前市场价格更好的价格发送限价订单会发生什么？例如，以低于当前卖出价的*买入限价*订单？嗯，这取决于你的经纪商或执行场所使用的限价订单的具体实现。如果你在交易所交易（例如，如果你交易货币期货），那么你的订单将直接进入订单簿。
- en: If you trade spot or forward contracts, then most likely, such an order will
    reside in the trading venue’s system until the market price touches the order
    level and then the order will be converted into a market order. If the market
    price never reaches the order level, the order may be canceled or may reside in
    the broker’s order book virtually forever (actually not forever, of course, every
    broker has their own rules on what to do with *forgotten* limit orders).
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你交易现货或远期合约，那么这样的订单很可能会留在交易场所的系统里，直到市场价格触及订单水平，然后订单将被转换为市价订单。如果市场价格从未达到订单水平，订单可能会被取消，或者可能在实际意义上永远留在经纪商的订单簿中（当然，不是真的永远，每个经纪商都有自己的规则来处理*被遗忘*的限价订单）。
- en: What happens if we send a limit buy order at a price that is worse than the
    current market price – for example, a *buy limit* order at a price that is *above*
    the current ask? In this case, the order will be executed immediately, and it
    will start absorbing the liquidity from the order book level by level, pushing
    the price higher and higher, but *this process will stop as soon as the limit
    price is hit*. Thus, a limit order sent at a price worse than the market can be
    considered a *market order* *with protection*.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我们以比当前市场价格更差的价格发送限价买入订单会发生什么？例如，以高于当前卖出价的*买入限价*订单？在这种情况下，订单将立即执行，并且它将从订单簿的级别开始吸收流动性，推动价格不断上升，但*这个过程将在触及限价时停止*。因此，以低于市场价格的价格发送的限价订单可以被视为*带有保护的市价订单*。
- en: 'Now we know that besides market orders, we can use limit orders, and in case
    we use them, we should specify a new field in our order ticket prototype: *order
    price*.'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们知道，除了市价订单外，我们还可以使用限价订单，如果我们使用它们，我们应该在我们的订单票证原型中指定一个新字段：*订单价格*。
- en: "![Figure \uFEFF10.6 – Price attribute added for stop and limit orders](img/B19145_10_06.jpg)"
  id: totrans-56
  prefs: []
  type: TYPE_IMG
  zh: '![图 10.6 – 为停止和限价订单添加的价格属性](img/B19145_10_06.jpg)'
- en: Figure 10.6 – Price attribute added for stop and limit orders
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 图 10.6 – 为停止和限价订单添加的价格属性
- en: So far, it looks like limit orders are the best to use in all situations, but
    is it really true? Of course, as there’s neither a free lunch nor a Holy Grail
    in trading, limit orders are no panacea to execution issues. Let’s take a deep
    dive into this domain, as execution issues with limit orders are far less obvious
    than those of market orders.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，看起来限价订单在所有情况下都是最好的选择，但这真的是真的吗？当然，正如在交易中没有免费的午餐也没有圣杯一样，限价订单并不是执行问题的万能药。让我们深入探讨这个领域，因为限价订单的执行问题远不如市价订单的明显。
- en: Possible execution issues
  id: totrans-59
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 可能的执行问题
- en: 'While the main execution issue with market orders is that they guarantee the
    execution itself but do not guarantee the execution price, the main issue with
    limit orders is exactly the opposite: a limit order guarantees the execution price
    (just by its definition) but does not guarantee the execution as such.'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管市价订单的主要执行问题是它们保证了执行本身但并不保证执行价格，限价订单的主要问题正好相反：限价订单保证了执行价格（仅凭其定义）但并不保证执行本身。
- en: 'Indeed, let’s carefully consider both cases: if we send a limit order to be
    executed at a *better price* (that is, a *lower than the current price* for a
    *buy limit* and a *higher than the current price* for a *sell limit*) to an exchange,
    and if we send such an order to a broker or an ECN.'
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 事实上，让我们仔细考虑这两种情况：如果我们向交易所发送一个以*更好的价格*（即，对于*买单限价*低于当前价格，对于*卖单限价*高于当前价格）执行的限价单，以及如果我们向经纪人或ECN发送这样的订单。
- en: 'If we work with an exchange, limit orders go straight into the order book (well,
    actually not really straight: first they pass the broker’s risk management systems
    that check whether you have sufficient margin to send such an order, but it doesn’t
    matter in the current context). However, we should remember that the order book
    is, in reality, two-dimensional (see *Figure 3**.2* in [*Chapter 3*](B19145_03.xhtml#_idTextAnchor044),
    *FX Market Overview from Developer’s Standpoint*, in the *Exchange and order book*
    section) and that our order will always be put at the end of the current order
    queue at the same price level. So, when the market price touches the order level,
    that is, someone actually traded at the order price, there is no guarantee that
    the size of that trade was sufficient to match all orders from the same price
    level – including ours.'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我们与交易所合作，限价单会直接进入订单簿（实际上并不是真的直接：首先它们会通过经纪人的风险管理系统，检查你是否拥有足够的保证金来发送这样的订单，但在当前情况下这并不重要）。然而，我们应该记住，订单簿在现实中是二维的（参见[*第三章*](B19145_03.xhtml#_idTextAnchor044)中的*图3.2*，*从开发者角度的FX市场概述*，在*交易所和订单簿*部分），并且我们的订单将始终以相同的价格水平放在当前订单队列的末尾。因此，当市场价格触及订单水平时，即有人实际上以订单价格进行了交易，并不能保证该交易的规模足以匹配同一价格水平上的所有订单——包括我们的订单。
- en: Note
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 备注
- en: One of the most common mistakes during the research and development phase of
    an algo trading project is assuming that all limit orders are executed, even if
    their prices were touched by a single tick. This erroneous assumption often leads
    to the creation of various *Holy Grails* of trading that work only on paper.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 在算法交易项目的研究和开发阶段，最常见的错误之一是假设所有限价单都会被执行，即使它们的价位只被一个价位点触及。这种错误的假设通常会导致各种*圣杯*交易策略的产生，这些策略只在纸上有效。
- en: If we trade with an FX broker or an ECN, then most likely, our limit order won’t
    go into any order book and no one will see it except for that same broker – until
    the market price reaches the order level. At this moment, the limit order is transformed
    into a market order and actually sent to the market. With this approach, we may
    suffer from the same disease as when trading with market orders – potentially,
    it could be executed at a price that is worse than the limit order price, which
    sounds exactly the opposite of the very definition of a limit order.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我们与外汇经纪人或ECN交易，那么我们的限价单很可能不会进入任何订单簿，除了那个经纪人之外没有人会看到它——直到市场价格达到订单水平。此时，限价单将转换为市价单并实际上发送到市场。采用这种方法，我们可能会遭受与使用市价单交易时相同的疾病——可能以比限价单价格更差的价格执行，这与限价单的定义正好相反。
- en: 'There are several workarounds for this issue, and most of these workarounds
    are implemented by execution venues. Most of them check the liquidity in the order
    book before actually sending the market order: if the order size exceeds the liquidity
    at the best bid/ask, then the order is executed only partially, up to the actual
    available amount. This way, the traditional behavior of a classical exchange order
    book is imitated.'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 对于这个问题有几种解决方案，其中大多数解决方案都是由执行场所实施的。大多数方案在发送市场订单之前都会检查订单簿中的流动性：如果订单规模超过了最佳买价/卖价的流动性，那么订单只执行部分，直到实际可用的金额。这样，就模仿了传统交易所订单簿的传统行为。
- en: Sounds disappointing?
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 听起来令人失望？
- en: Well, in fact, some (not all, unfortunately) execution venues allow for somewhat
    greater control over the order execution. Checking the liquidity in the order
    book prior to sending an order is a good practice, but with some trading technology
    providers, we can also use special conditions, or specifiers, to control the order’s
    time in force.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 好吧，实际上，一些（不幸的是，并非所有）执行场所允许对订单执行有更大的控制。在发送订单之前检查订单簿中的流动性是一种好习惯，但与一些交易技术提供商合作，我们还可以使用特殊条件或指定条件来控制订单的有效时间。
- en: Time in force – better control over execution
  id: totrans-69
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 有效时间 – 更好的执行控制
- en: The specifiers mentioned previously are normally called **time in force** conditions,
    although, as you will see a bit later in this chapter, for some of them, it is
    not really obvious or intuitive.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 之前提到的指定通常被称为**有效期**条件，尽管，正如你将在本章稍后看到的那样，对于其中的一些，这并不真正明显或直观。
- en: Important disambiguation
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 重要区分
- en: 'More often than not, these execution method specifiers are referred to as the
    **type of order**. This can be found not only in some brokers’ documentation but
    also in books on trading, and even academic research. So, be very careful when
    you encounter *type of order* or *time in force* in any documentation, and make
    sure you understand what exactly the author had in mind: the type of order as
    such (market, limit, stop, etc.), the time during which it is valid, or how the
    order should be executed liquidity-wise!'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 通常，这些执行方法指定被称为**订单类型**。这不仅在一些经纪商的文档中可以找到，而且在交易书籍和学术研究中也可以找到。所以，当你遇到任何文档中的*订单类型*或*有效期*时，一定要非常小心，并确保你确切地理解作者的想法：订单类型本身（市价、限价、止损等）、其有效的期间，或者订单应该如何在流动性方面执行！
- en: In the following subsections, we will consider different order specifiers in
    detail.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 在以下小节中，我们将详细考虑不同的订单指定。
- en: Immediate or cancel
  id: totrans-74
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 立即成交或取消
- en: 'An **Immediate-or-Cancel** (**IOC**) instruction attached to a market order
    means: I want to buy or sell *at most* X euros, dollars, lots, contracts, whatever,
    at the market price (that is, current best bid/ask), but no worse than this price,
    and *I don’t care if I do not get the entire X euros, dollars, and so on, but
    only a smaller amount*. If there’s not sufficient liquidity to fill my order,
    then fill in what is available and cancel the rest.'
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 附带在市价订单上的**立即成交或取消**（**IOC**）指令意味着：我想以市价（即当前最佳买入/卖出价）最多买入或卖出X欧元、美元、手数、合约等，但价格不能低于这个价格，而且*我不在乎是否不能得到全部的X欧元、美元等，只希望得到更少的数量*。如果市场流动性不足以满足我的订单，那么就填入可用的部分，并取消剩余的部分。
- en: In other words, *with IOC, I prioritize price* *over size*.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 换句话说，*使用IOC，我优先考虑价格* *而非数量*。
- en: For example, I send an IOC market order to buy 1,000,000 EUR USD. The current
    ask price is 1.01234 and the currently available amount at ask is 500,000\. Then,
    I will get 500,000 EURUSD bought at 1.01234 and the rest of my order (another
    500,000) will be canceled.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，我发送一个IOC市场订单以购买1,000,000 EUR USD。当前卖出价是1.01234，当前卖出价处的可用数量是500,000。那么，我将购买500,000
    EURUSD，以1.01234的价格，而我剩余的订单（另外500,000）将被取消。
- en: Using IOC orders is probably the best way to prevent execution at an unwanted
    price, but you should remember that using it may lead to partial fills – so, your
    trading algorithm should somehow account for situations of this sort.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 使用IOC订单可能是防止以不希望的价格成交的最好方法，但你应该记住，使用它可能会导致部分成交 – 因此，你的交易算法应该以某种方式考虑到这种情况。
- en: Fill or kill
  id: totrans-79
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 全部成交或取消
- en: 'A **fill-or-kill** (**FOK**) instruction means: I want to buy or sell *exactly
    X* euros, dollars, lots, contracts, and so on *at the market price*, but if there
    is insufficient liquidity at the best bid/ask to fill the entire order, then do
    not execute this order at all (or *kill* the order).'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: '**全部成交或取消**（**FOK**）指令意味着：我想以市价买入或卖出*正好X*欧元、美元、手数、合约等，但如果最佳买入/卖出价处的流动性不足以完成整个订单，则根本不执行此订单（或*取消*此订单）。'
- en: In other words, *with FOK, I prioritize the integrity of the order over* *its
    execution*.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 换句话说，*使用FOK，我优先考虑订单的完整性而非其执行*。
- en: In the same example, if I send a market buy FOK order for 1,000,000 EURUSD but
    there’s only 500,000 at the best ask, then the entire order will be killed (canceled)
    and no partial fill will be executed.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 在相同的例子中，如果我发送一个1,000,000 EURUSD的市场买入FOK订单，但最佳卖出价处只有500,000，那么整个订单将被取消（取消），并且不会执行部分成交。
- en: 'You may wonder why both IOC and FOK are considered time-in-force specifiers:
    both assume immediate, instant execution of the order. Well, the answer is probably
    in the question: with IOC or FOK, we specify that the order should be executed
    *as quickly as possible*; this way, we specify its time in force.'
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能会想知道为什么IOC和FOK都被认为是有效期指定：两者都假设订单立即、即时执行。答案可能就在问题中：使用IOC或FOK，我们指定订单应该尽快执行；这样，我们就指定了它的有效期。
- en: Most execution venues support IOC or FOK only for market orders, but there are
    some that allow adding IOC or FOK to limit orders as well. This makes sense because
    some execution venues just convert a limit order into a market one when the limit
    order’s price is touched by the market, so the market order’s time-in-force specifiers
    become absolutely valid in such a scenario.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 大多数执行场所只支持市价订单的IOC或FOK，但也有一些允许将IOC或FOK添加到限价订单中。这很有意义，因为一些执行场所会在限价订单的价格被市场触及时将其转换为市价订单，因此在这种情况下，市价订单的时间有效指定符变得绝对有效。
- en: Of course, there are other time-in-force specifiers that give an order a much
    longer life than IOC or FOK. The most common are **good for a day** and **good**
    **till canceled**.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，还有其他时间有效指定符，可以为订单提供比IOC或FOK更长的生命周期。最常见的是**当日有效**和**取消前有效**。
- en: Good for a day (GTD) and good till canceled (GTC)
  id: totrans-86
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 当日有效（GTD）和取消前有效（GTC）
- en: Both specifiers assume that the order can be filled in parts and set the time
    frame during which it can be filled.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 这两个指定符都假设订单可以部分成交，并设定了它可以成交的时间框架。
- en: A GTD order tries to fill what is available at the best bid/ask and the remaining
    will reside in the venue’s order book till the end of the day (that is, 5 P.M.
    New York time in most cases). Any moment the price returns to the order level,
    another portion of the order is executed.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: GTD（当日有效）订单试图以最佳买卖价填充可用的部分，剩余的部分将保留在交易场所的订单簿中直到当天结束（在大多数情况下，即纽约时间下午5点）。任何时刻，当价格回到订单水平时，订单的另一部分将被执行。
- en: A GTC order behaves in a similar way, but there’s no explicitly specified time
    until which the order remains actual. The trader should take care of all GTC orders,
    manually or automatically.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: GTC订单的行为方式类似，但没有明确指定订单保持有效的具体时间。交易者应该手动或自动地关注所有GTC订单。
- en: In reality, both specifiers are used with limit orders and simply mean the time
    during which such an order will remain in force, because if we take all appropriate
    measures by checking the liquidity, then in most cases, a limit order will be
    executed instantly.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 在现实中，这两个指定符都与限价订单一起使用，仅仅意味着这样一个订单将保持有效的时间，因为如果我们通过检查流动性采取所有适当的措施，那么在大多数情况下，限价订单将立即被执行。
- en: 'Now that we are familiar with time-in-force specifiers, it’s time to update
    our proposed order ticket structure:'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经熟悉了时间有效指定符，是时候更新我们提出的订单票结构了：
- en: "![Figure \uFEFF10.7 – Time in force attribute added](img/B19145_10_07.jpg)"
  id: totrans-92
  prefs: []
  type: TYPE_IMG
  zh: '![图10.7 – 添加了时间有效属性](img/B19145_10_07.jpg)'
- en: Figure 10.7 – Time in force attribute added
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.7 – 添加了时间有效属性
- en: So far, we have discussed market (*I buy now*) and limit (*I buy at this price
    or better*) orders. But it would be quite logical to suppose that if we have an
    *at this price or better* order, then there should exist an *at this price or
    worse* order, wouldn’t it? Yes, such an order type does exist, and it’s called
    the stop order.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 到目前为止，我们已经讨论了市价订单（*我现在买入*）和限价订单（*我以这个价格或更好的价格买入*）。但如果我们有一个*以这个价格或更好的价格*的订单，那么应该存在一个*以这个价格或更差的价格*的订单，不是吗？是的，这种订单类型确实存在，它被称为止损订单。
- en: Stop orders – maximum uncontrolled risk
  id: totrans-95
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 止损订单 – 最大不可控风险
- en: Essentially, a **stop order** is an order to buy or sell the specified amount
    of the asset *at the specified price* *or worse*.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 从本质上讲，**止损订单**是一种以指定价格*或更差的价格*买入或卖出指定数量资产的订单。
- en: 'You may ask at this point: why on Earth would I want to buy or sell at a price
    worse than I’d like to?'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能会在这个时候问：我为什么要以低于我愿意的价格买入或卖出呢？
- en: 'The answer is very simple: both *better* and *worse* are just references to
    where the order price is relative to the current market price.'
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 答案非常简单：*更好*和*更差*只是指订单价格相对于当前市场价格的关系。
- en: 'For example, if the current price of EURUSD is 0.99673 and I send a buy-stop
    order at 0.9989, then my order will be executed at any price equal to or greater
    than 0.9989\. Similar to limit orders, a stop order will reside in the broker’s
    order book until the market price touches the order price and then converted into
    a market order. Note that, unlike limit orders, stop orders are never sent to
    the order book immediately, even if you trade with an exchange. This is quite
    natural, in fact: if I send a limit order to the order book, then I improve the
    liquidity in the market as others may become my counterparties and then I become
    a liquidity provider to them in a certain sense. But if a stop order had been
    sent to an order book, it would just immediately match one of the limit orders
    there and move the price immediately by an unpredictable distance.'
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，如果当前EURUSD的价格是0.99673，而我发送了一个在0.9989的买入止损订单，那么我的订单将在任何等于或高于0.9989的价格被执行。与限价订单类似，止损订单将存在于经纪商的订单簿中，直到市场价格触及订单价格，然后转换为市价订单。请注意，与限价订单不同，即使你与交易所交易，止损订单也永远不会立即发送到订单簿。这是非常自然的：如果我向订单簿发送限价订单，那么我就提高了市场的流动性，因为其他人可能成为我的交易对手，然后我在某种意义上成为他们的流动性提供者。但是，如果止损订单被发送到订单簿，它将立即与那里的某个限价订单匹配，并立即以不可预测的距离移动价格。
- en: Indeed, let’s consider an example. Say we have an order book for EURUSD and
    the current market price (best bid/ask) is 1.00000/1.00005\. There are some limit
    orders to buy at 0.99999, 0.99998, and so on, and some limit orders to sell at
    1.00006, 1.00007, and so on. Now, imagine someone sends a stop order to buy at
    1.0020 and this order is sent to the order book. Of course, sellers (those on
    the *ask* side) will be more than happy to sell at 1.0020 and not at 1.0010 or
    1.00008\. So, a stop order sent to the order book would trigger the order book
    level that is the most distant from the current best bid/ask, which is strictly
    opposite to the very idea of an order book.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 实际上，让我们考虑一个例子。假设我们有一个EURUSD的订单簿，当前市场价格（最佳买价/卖价）是1.00000/1.00005。有一些限价订单以0.99999、0.99998等价格买入，还有一些限价订单以1.00006、1.00007等价格卖出。现在，想象一下有人发送了一个以1.0020买入的止损订单，并且这个订单被发送到订单簿。当然，卖方（那些在*卖价*一侧的人）会非常乐意以1.0020的价格卖出，而不是1.0010或1.00008。因此，发送到订单簿的止损订单将触发最远离当前最佳买价/卖价的订单簿水平，这与订单簿的基本理念正好相反。
- en: Note
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: Not all execution venues support stop orders. Many institutional liquidity pools
    support only market and limit orders (and some of them only market orders). So
    it’s always a good idea to emulate stop orders locally.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 并非所有执行场所都支持止损订单。许多机构流动性池只支持市价和限价订单（其中一些只支持市价订单）。因此，始终模拟本地止损订单是一个好主意。
- en: 'So, going back to the question about the reason why we may want to use a stop
    order, now we understand that we can use it when we want to do one of these two
    actions:'
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，回到我们可能想要使用止损订单的原因的问题，现在我们理解了，当我们想要执行以下两个动作之一时，我们可以使用它：
- en: Enter the market at a price that is greater than current if we want to buy,
    and at a price that is less than current if we want to sell.
  id: totrans-104
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果我们想要买入，则在高于当前价格的价格进入市场；如果我们想要卖出，则在低于当前价格的价格进入市场。
- en: Exit a position when the price goes against it – that is, with a loss. It happens
    if the current price is less than the entry price for a long position (buy) or
    the current price is greater than the entry price for a short position (sell).
  id: totrans-105
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 当价格与你的头寸相反时退出头寸——也就是说，亏损。这种情况发生在当前价格低于多头头寸（买入）的入场价格，或者当前价格高于空头头寸（卖出）的入场价格。
- en: If we use a stop order to exit from a losing position, then it is called a **stop-loss
    order**.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我们使用止损订单从亏损的头寸中退出，那么它被称为**止损订单**。
- en: Note
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: Quite frequently, stop orders are confused with stop-loss orders. However, stop
    orders can be used to both enter and exit the market, while stop-loss orders are
    always used only to exit from a losing position. In other words, *stop order*
    is a term with a more broad sense that pertains to general trading, and *stop-loss*
    is a narrow term pertaining to just trade logic. From the trading venue’s standpoint,
    there is no difference between a stop order used to open a position or to close
    it, so *stop-loss* orders may be mentioned only in a particular broker’s documentation,
    not that of a trading venue.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 很频繁地，停止订单与止损订单混淆。然而，停止订单可以用来进入和退出市场，而止损订单始终只用于退出亏损仓位。换句话说，*停止订单*是一个更广泛的概念，与一般交易相关，而*止损*是一个狭窄的概念，仅与交易逻辑相关。从交易场所的角度来看，用于开仓或平仓的停止订单之间没有区别，因此*止损订单*可能只会在特定经纪商的文档中提及，而不是交易场所的文档。
- en: Now that we know that stop orders are somewhat *artificial* and actually executed
    as conditional market orders, we can understand the typical issues with their
    execution.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 既然我们知道停止订单在一定程度上是*人为的*，并且实际上作为条件市价订单执行，我们就可以理解它们执行的典型问题。
- en: Possible execution issues
  id: totrans-110
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 可能的执行问题
- en: 'Of course, the main execution issue with stop orders is similar to that of
    market orders: the slippage with stop orders is potentially unlimited. If we send
    a buy-stop order, then it will be executed at any price equal to or greater than
    the order price. It is similar to a sell-stop order: it will be executed at any
    price equal to or less than the order price.'
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，停止订单的主要执行问题与市价订单类似：停止订单的滑点可能是无限的。如果我们发送一个买入停止订单，那么它将在等于或高于订单价格的价格执行。这类似于卖出停止订单：它将在等于或低于订单价格的价格执行。
- en: Stop orders guarantee execution but do not guarantee the price – and in this
    sense, they are somewhat similar to market orders. Let’s go back again to *Figure
    6**.2* in [*Chapter 6*](B19145_06.xhtml#_idTextAnchor101), *Basics of Fundamental
    Analysis and its Possible Use in FX Trading*, which illustrates the sequence of
    ticks (trades) around the publication of US NFP data. Imagine we have a long position
    before the news and we set a protective stop (stop-loss) order at 1.02250\. With
    the very first tick after the news release, this stop order will be executed –
    but not at 1.02250\. It will be executed at the first available price, which would
    be 1.02100 or worse (lower).
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 停止订单保证了执行，但不能保证价格——从这个意义上说，它们与市价订单有些相似。让我们再次回到[*第6章*](B19145_06.xhtml#_idTextAnchor101)中的*图6**.2*，*基本面分析的基础及其在FX交易中的可能用途*，它说明了美国NFP数据发布前后交易（tick）的顺序。想象一下，我们在新闻发布前持有多头仓位，并在1.02250处设置了一个保护性停止（止损）订单。在新闻发布后的第一个tick，这个停止订单将被执行——但不是在1.02250处。它将在第一个可用的价格执行，这可能是1.02100或更低（更低）。
- en: Always remember that even if you placed a stop-loss order, it doesn’t mean that
    you limited your losses by the order’s price level. It can be executed way beyond
    the requested price, thus increasing the losses.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 总要记住，即使你放置了止损订单，这也并不意味着你通过订单的价格水平限制了你的损失。它可能会在请求价格之外执行，从而增加损失。
- en: It’s worth mentioning that some market makers offer *guaranteed stop-loss execution*.
    This means that during an event such as US NFP or a similar situation when the
    price may jump beyond the stop order price in one tick, they would still execute
    the order at the requested price, not the market price. Only market makers can
    do that as it is they who quote the market for you as the price taker. Of course,
    there’s no free lunch here either, so market makers ask for a premium for this
    service. Such a premium typically means a wider spread or a greater commission.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 值得注意的是，一些做市商提供*保证止损执行*。这意味着在像美国NFP或类似情况这样的事件期间，当价格可能在一次tick内跳过停止订单价格时，他们仍然会在请求的价格执行订单，而不是市场价格。只有做市商才能做到这一点，因为他们为你这个价格接受者报价。当然，这里也没有免费的午餐，所以做市商会为此服务收取溢价。这种溢价通常意味着更宽的价差或更高的佣金。
- en: Does it make sense to use *guaranteed* stop-loss orders? Well, it depends on
    the trade logic of your model and its statistics. If you use stop orders as a
    regular means of exiting the position even in a *calm* market, then the answer
    is probably no because you will lose more in spreads and commissions. If you use
    them only as a protective measure against an unexpected disastrous market price
    movement, then the answer is probably yes, as such a disastrous movement can ruin
    your account in one tick – just recall the case of the Swiss National Bank unpegging
    the rate of CHF from the euro described in [*Chapter 9*](B19145_09.xhtml#_idTextAnchor152),
    *Trading Strategies and Their Core Elements*, in *Figure 9**.6*.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 使用*保证*止损订单是否有意义？嗯，这取决于你模型中的交易逻辑及其统计数据。如果你将止损订单作为退出头寸的常规手段，即使在*平静*的市场中也是如此，那么答案可能是否定的，因为你会在价差和佣金上损失更多。如果你只将其作为应对意外灾难性市场价格变动的保护措施，那么答案可能是肯定的，因为这种灾难性变动可以在一个tick内摧毁你的账户——只需回忆一下瑞士国家银行将瑞士法郎（CHF）汇率与欧元脱钩的案例，该案例在[*第9章*](B19145_09.xhtml#_idTextAnchor152)“交易策略及其核心要素”中的*图9**.6*中描述。
- en: With all that in mind, stop orders kept at the broker are mostly used as protective
    stop-loss orders, which exit from a losing position and cut running losses. If
    your strategy logic assumes entering the market along with the price movement,
    which is typical for a breakout strategy, for example, then it’s always a better
    idea to emulate such a stop order locally and send it to the market as a market
    or even a limit order to prevent bad execution.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 考虑到所有这些，经纪商处的止损订单大多被用作保护性止损订单，用于退出亏损头寸并削减持续亏损。如果你的策略逻辑假设随着价格变动进入市场，例如典型的突破策略，那么本地模拟此类止损订单并将其作为市价订单甚至限价订单发送到市场，以防止不良执行，总是一个更好的主意。
- en: 'Now, we can suggest the final draft of our general order ticket, which would
    support all three main types of orders (market, limit, and stop) and all the essential
    attributes required to send the order to a broker:'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，我们可以提出我们的一般订单单据的最终草案，该草案将支持所有三种主要类型的订单（市价、限价和止损）以及发送订单到经纪商所需的所有基本属性：
- en: "![Figure \uFEFF10.8 – All types of orders are now supported in the order ticket](img/B19145_10_08.jpg)"
  id: totrans-118
  prefs: []
  type: TYPE_IMG
  zh: '![图10.8 – 订单单据现在支持所有类型的订单](img/B19145_10_08.jpg)'
- en: Figure 10.8 – All types of orders are now supported in the order ticket
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 图10.8 – 订单单据现在支持所有类型的订单
- en: 'Similar to limit orders, IOC and FOK are not used with stop orders, but GTD
    and GTC are. Besides that, some execution venues offer an additional condition
    to trigger a stop order, which is to convert a stop order into a market order:
    whether it’s triggered when the bid or the ask price hits the order level. However,
    this specifier is not common.'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 与限价订单类似，IOC和FOK不与止损订单一起使用，但GTD和GTC可以。除此之外，一些执行场所还提供触发止损订单的额外条件，即将止损订单转换为市价订单：无论是当买入价或卖出价触及订单水平时触发。然而，这个指定器并不常见。
- en: Market, limit, and stop orders are de facto standard orders accepted by almost
    any trading venue. However, some venues offer other types of orders that are frequently
    referred to as compound orders, which we will explore in the next section. They
    are not common and not essential, but it’s worth at least knowing that they exist
    and how they work in very general terms.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 市价、限价和止损订单是实际上被几乎所有交易场所接受的标准化订单。然而，一些场所提供其他类型的订单，这些订单通常被称为复合订单，我们将在下一节中探讨。它们并不常见，也不是必需的，但至少值得知道它们存在以及它们在非常一般意义上的工作方式。
- en: Compound orders
  id: totrans-122
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 复合订单
- en: '**Compound orders** are those that assume a certain logical chain in their
    execution. That’s why they are also referred to as **conditional orders**. Strictly
    speaking, such an order is not a single order: it’s a sequence of orders that
    are triggered one by another.'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: '**复合订单**是指那些在执行过程中假设一定逻辑链的订单。这就是为什么它们也被称为**条件订单**。严格来说，此类订单不是一个单独的订单：它是一系列依次触发的订单。'
- en: 'As the most common example, let’s consider a **stop-limit order**. Unlike stop
    or limit orders, it requires two prices to be specified: stop and limit. If such
    an order is sent to the execution venue, first, the venue’s matching engine waits
    till the stop price of the order is touched by the market (best bid/ask) price.
    After that, the order is executed using its limit price exactly like when executing
    a limit order. So, a stop limit order is a combination of both.'
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 作为最常见的例子，让我们考虑一个**止损限价单**。与止损或限价单不同，它需要指定两个价格：止损价和限价。如果将此类订单发送到执行场所，首先，该场所的匹配引擎会等待市场（最佳买价/卖价）价格触及订单的止损价。之后，订单将使用其限价价格执行，就像执行限价单一样。因此，止损限价单是两者的结合。
- en: 'For example, if the current price of EUR USD is 1.01015 and I want to buy it
    at 1.0102, I can use a stop order to enter the market – but I remember that during
    the execution of a stop order, I can get a potentially unlimited slippage. Therefore,
    I send a stop limit order with two prices: a stop price of 1.0102 and a limit
    price of 1.01025\. Then, as soon as 1.0102 is touched by the market (this means
    that either ask or bid becomes equal or greater than 1.0102; see the explanation
    on special execution conditions for stop orders in the previous section), a limit-buy
    order at 1.01025 is actually executed. So, I will buy EURUSD at any price between
    1.0102 (the stop price) and 1.01025 (the limit price).'
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，如果当前EUR USD的价格为1.01015，而我想要以1.0102的价格买入，我可以使用止损单进入市场——但我记得在止损单执行过程中，我可能会得到一个可能无限大的滑点。因此，我发送了一个包含两个价格的止损限价单：止损价为1.0102，限价为1.01025。然后，一旦市场（这意味着要价或出价变为等于或大于1.0102；参见前一部分中关于止损订单的特殊执行条件说明）触及1.0102，实际上就会执行一个1.01025的限价买单。因此，我将以1.0102（止损价）和1.01025（限价）之间的任何价格买入EURUSD。
- en: It’s worth mentioning that stop-limit orders are used only to enter the market
    and never used as stop-loss orders. A stop-loss order must ensure the entire order
    size is filled, but a stop-limit order, like any limit order, cannot guarantee
    the execution of the entire order size.
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 值得注意的是，止损限价单仅用于进入市场，永远不会用作止损单。止损单必须确保整个订单量被完全成交，但止损限价单，就像任何限价单一样，不能保证整个订单量的执行。
- en: Summary
  id: totrans-127
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 摘要
- en: 'Now, we are familiar with orders of the three main types, and we know in which
    cases we prefer to use market, stop and limit orders, and in which cases we’d
    rather avoid using them. Besides that, from previous chapters, we remember how
    to receive and handle market data, and how to use technical analysis, and we remember
    the key risks and have at least some ideas on how to mitigate them. So, we are
    ready for the final, ultimate job of any algo trader in the research and development
    phase: we are about to start drafting a trading application, something that will
    receive data, process it, generate trading signals, convert them into orders,
    send the order to the broker, process the broker’s response, and collect the trading
    statistics, which can ultimately prove or disprove the trading idea. This is what
    we are going to do in the next chapter.'
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，我们已经熟悉了三种主要类型的订单，并且知道在哪些情况下我们更喜欢使用市价、止损和限价单，在哪些情况下我们宁愿避免使用它们。除此之外，从之前的章节中，我们记得如何接收和处理市场数据，如何使用技术分析，并且我们记得关键风险，并至少有一些关于如何缓解这些风险的想法。因此，我们为任何算法交易员在研究和开发阶段的最终、终极任务做好了准备：我们即将开始起草一个交易应用，这将接收数据，处理数据，生成交易信号，将它们转换为订单，将订单发送给经纪人，处理经纪人的响应，并收集交易统计数据，这些数据最终可以证明或反驳交易想法。这就是我们在下一章将要做的。
