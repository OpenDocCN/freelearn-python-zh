<html><head></head><body><div class="chapter" title="Chapter&#xA0;7.&#xA0;Sense and Display Real-World Data"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Sense and Display Real-World Data</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using devices with the I<sup>2</sup>C bus</li><li class="listitem" style="list-style-type: disc">Reading analog data using an analog-to-digital converter</li><li class="listitem" style="list-style-type: disc">Logging and plotting data</li><li class="listitem" style="list-style-type: disc">Extending the Raspberry Pi GPIO with an I/O expander</li><li class="listitem" style="list-style-type: disc">Capturing data in an SQLite database</li><li class="listitem" style="list-style-type: disc">Viewing data from your own webserver</li><li class="listitem" style="list-style-type: disc">Sensing and sending data to online services</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec50"/>Introduction</h1></div></div></div><p>In the previous chapter, we made use of the Raspberry Pi GPIO to directly control and respond to the attached hardware by controlling or reading the GPIO pins. In this chapter, we will learn how to collect analog data from the real world and process it so we can display, log, graph, and share the data and make use of it in our programs.</p><p>We will extend the capabilities of the Raspberry Pi by interfacing with <a class="indexterm" id="id414"/>
<span class="strong"><strong>Analog-to-Digital Converters</strong></span> (<span class="strong"><strong>ADCs</strong></span>), LCD alphanumeric displays, and digital port expanders using Raspberry Pi's GPIO connections.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip14"/>Tip</h3><p>Be sure to check out <a class="link" href="apa.html" title="Appendix A. Hardware and Software List">Appendix</a>, <span class="emphasis"><em>Hardware and Software List</em></span>, which lists all the items used in this chapter and the places you can obtain them from.</p></div></div></div></div>
<div class="section" title="Using devices with the I2C bus"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec51"/>Using devices with the I<sup>2</sup>C bus</h1></div></div></div><p>The <a class="indexterm" id="id415"/>Raspberry Pi can support several higher-level protocols<a class="indexterm" id="id416"/> that a wider range of devices can easily be connected to. In this chapter, we shall focus on the most common bus, called <a class="indexterm" id="id417"/>
<span class="strong"><strong>I<sup>2</sup>C</strong></span> (<span class="strong"><strong>I-squared-C</strong></span>). It provides a medium-speed bus for communicating with devices over two wires. In this section, we shall use I<sup>2</sup>C to interface with an 8-bit ADC. This device will measure an analog signal, convert it to a relative value between 0 and 255, and send the value as a digital signal (represented by 8 bits) over the I<sup>2</sup>C bus to the Raspberry Pi.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec127"/>Getting ready</h2></div></div></div><p>The I<sup>2</sup>C bus is not enabled in all Raspberry Pi images; therefore, we need to enable the module and install some supporting tools. Newer versions of Raspbian use <a class="indexterm" id="id418"/>
<span class="strong"><strong>Device Trees</strong></span> to handle hardware peripherals and drivers.</p><p>In order to make use of the I<sup>2</sup>C bus, we need to enable the ARM I<sup>2</sup>C in the <code class="literal">\boot\config.txt</code> file.</p><p>You can do this automatically using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo raspi-config</strong></span>
</pre></div><p>As shown in the following screenshot, select <span class="strong"><strong>Advanced Options</strong></span> from the menu and then <span class="strong"><strong>I2C</strong></span>. When asked, select <span class="strong"><strong>Yes</strong></span> to enable the interface and <span class="strong"><strong>Yes</strong></span> to load the module by default.</p><div class="mediaobject"><img alt="Getting ready" src="graphics/6623OT_07_001.jpg"/></div><p>From the menu select <span class="strong"><strong>I<sup>2</sup>C</strong></span> and select <span class="strong"><strong>Yes</strong></span> to enable the interface and to load the module by default.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip15"/>Tip</h3><p>The <code class="literal">raspi-config</code> program<a class="indexterm" id="id419"/> enables the <code class="literal">I2C_ARM</code> interface by altering <code class="literal">/boot/config.txt</code> to include <code class="literal">dtparam=i2c_arm=on</code>. The other bus (I2C_VC) is typically reserved for interfacing with Raspberry Pi HAT add-on boards (to read the configuration information from the on-board memory devices); however, you can enable this using <code class="literal">dtparam=i2c_vc=on</code>.</p></div></div><p>You can <a class="indexterm" id="id420"/>also <a class="indexterm" id="id421"/>enable the SPI using <code class="literal">raspi-config</code> list if you wish, which is another type of bus that can be seen in <a class="link" href="ch10.html" title="Chapter 10. Interfacing with Technology">Chapter 10</a>, <span class="emphasis"><em>Interfacing with Technology</em></span>.</p><p>Next, we should include the I<sup>2</sup>C module to be loaded on power up, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo nano /etc/modules</strong></span>
</pre></div><p>Add the following on separate lines and save (<span class="emphasis"><em>Ctrl + X, Y, Enter</em></span>):</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>i2c-dev</strong></span>
<span class="strong"><strong>i2c-bcm2708</strong></span>
</pre></div><p>Similarly, we can also enable the SPI module by adding <code class="literal">spi-bcm2708</code>.</p><p>Next, we will install some tools to use I<sup>2</sup>C devices directly from the command line, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get update</strong></span>
<span class="strong"><strong>sudo apt-get install i2c-tools</strong></span>
</pre></div><p>Finally, shut down the Raspberry Pi before attaching the hardware in order to allow the changes to be applied, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo halt</strong></span>
</pre></div><p>You will need a PCF8591 module (retailers of these are listed in <a class="link" href="apa.html" title="Appendix A. Hardware and Software List">Appendix,</a> <span class="emphasis"><em>Hardware and Software List</em></span>) or you can obtain the PCF8591 chip separately and build your own circuit (see the <span class="emphasis"><em>There's more…</em></span> section for details of the circuit).</p><div class="mediaobject"><img alt="Getting ready" src="graphics/6623OT_07_002.jpg"/><div class="caption"><p>The PCF8591 ADC and sensor module from dx.com</p></div></div><p>Connect the <span class="strong"><strong>GND</strong></span>, <span class="strong"><strong>VCC</strong></span>, <span class="strong"><strong>SDA</strong></span>, and <span class="strong"><strong>SCL</strong></span> pins to the Raspberry Pi GPIO header as follows:</p><div class="mediaobject"><img alt="Getting ready" src="graphics/6623OT_07_003.jpg"/><div class="caption"><p>I<sup>2</sup>C connections on the Raspberry Pi GPIO header</p></div></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note59"/>Note</h3><p>You can use the same I<sup>2</sup>C tools/code with other I<sup>2</sup>C devices by studying the datasheet of the device to find out what messages to send/read and which registers are used to control your device.</p></div></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec128"/>How to do it...</h2></div></div></div><p>Detect the I<sup>2</sup>C <a class="indexterm" id="id422"/>device<a class="indexterm" id="id423"/> by using <code class="literal">i2cdetect</code> (the <code class="literal">--y</code> option skips any warnings about possible interference with other hardware that could be connected to the I<sup>2</sup>C bus) using the following commands to scan both buses:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo i2cdetect -y 0</strong></span>
<span class="strong"><strong>sudo i2cdetect -y 1</strong></span>
</pre></div><p>Depending on your Raspberry Pi board revision, the address of the device should be listed on bus 0 (for Model B Rev1 boards) or bus 1 (for Raspberry Pi 2 &amp; 3, Raspberry Pi 1 Model A and Model B Rev 2). By default, the PCF8591 address is <code class="literal">0x48</code>.</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>I<sup>2</sup>C bus number to use</p>
</th><th style="text-align: left" valign="bottom">
<p>Bus 00</p>
</th><th style="text-align: left" valign="bottom">
<p>Bus 11</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Raspberry Pi 2 &amp; 3</p>
</td><td style="text-align: left" valign="top">
<p>HAT ID (I2C_VC)</p>
</td><td style="text-align: left" valign="top">
<p>GPIO (I2C_ARM)</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Model A and Model B Revision 2</p>
</td><td style="text-align: left" valign="top">
<p>P5</p>
</td><td style="text-align: left" valign="top">
<p>GPIO</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Model B Revision 1</p>
</td><td style="text-align: left" valign="top">
<p>GPIOGPIO</p>
</td><td style="text-align: left" valign="top">
<p>n/a</p>
</td></tr></tbody></table></div><p>The following screenshot shows the output of <code class="literal">i2cdetect</code>:</p><div class="mediaobject"><img alt="How to do it..." src="graphics/6623OT_07_004.jpg"/><div class="caption"><p>The PCF8591 address (48) is displayed here on bus 1</p></div></div><p>If nothing is listed, shut <a class="indexterm" id="id424"/>down and double-check your <a class="indexterm" id="id425"/>connections (the ADC module from  <a class="ulink" href="http://www.dx.com">www.dx.com</a> will have a red LED showing when powered).</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note60"/>Note</h3><p>If you receive an error that the <code class="literal">/dev/i2c1</code> bus doesn't exist, you can perform the following checks.</p><p>Ensure that the <code class="literal">/etc/modprobe.d/raspi-blacklist.conf</code> file is empty (that is, the modules haven't been blacklisted), using the following command to view the file:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo nano /etc/modprobe.d/raspi-blacklist.conf</strong></span>
</pre></div><p>If there is anything in the file (such as <code class="literal">blacklist i2c-bcm2708</code>), remove it and save.</p><p>Check <code class="literal">/boot/config</code> and ensure there isn't a line that has <code class="literal">device_tree_param=</code> (this will disable support for the new device tree configurations and disable support for some Raspberry Pi HAT add-on boards).</p><p>Check whether the modules have been loaded by using <code class="literal">lsmod</code> and look for <code class="literal">i2c-bcm2708</code> and <code class="literal">i2c_dev</code>.</p></div></div><p>Using the detected bus number (<code class="literal">0</code> or <code class="literal">1</code>) and the device address (<code class="literal">0x48</code>) use <code class="literal">i2cget</code> to read from the device (after a power up or channel change you will need to read the device twice to see the latest value), as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo i2cget -y 1 0x48</strong></span>
<span class="strong"><strong>sudo i2cget -y 1 0x48</strong></span>
</pre></div><p>To read from channel <code class="literal">1</code> (this is the temperature sensor on the module), we can use <code class="literal">i2cset</code> to write <code class="literal">0x01</code> to the PCF8591 control register. Again, use two reads to get a new sample from channel <code class="literal">1</code>, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo i2cset -y 1 0x48 0x01</strong></span>
<span class="strong"><strong>sudo i2cget -y 1 0x48</strong></span>
<span class="strong"><strong>sudo i2cget -y 1 0x48</strong></span>
</pre></div><p>To cycle through <a class="indexterm" id="id426"/>each of the input channels, use <code class="literal">i2cset</code> to set the control<a class="indexterm" id="id427"/> register to <code class="literal">0x04</code>, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo i2cset -y 1 0x48 0x04</strong></span>
</pre></div><p>We can also control the AOUT pin using the following command to set it fully on (lighting up the LED D1):</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo i2cset -y 1 0x48 0x40 0xff</strong></span>
</pre></div><p>Finally, we can use the following command to set it fully off (switching off the LED D1):</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo i2cset -y 1 0x48 0x40 0x00</strong></span>
</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec129"/>How it works...</h2></div></div></div><p>The first read from the device after power on will return <code class="literal">0x80</code> and will also trigger the new sample from channel 0. If you read a second time, it will return the sample previously read and generate a fresh sample. Each reading will be an 8-bit value (ranging from <code class="literal">0</code> to <code class="literal">255</code>), representing the voltage 0 to VCC (in this case, 0V to 3.3V). On the <a class="ulink" href="http://www.dx.com">www.dx.com</a> module, channel 0 is connected to a light sensor, so if you cover up the module with your hand and resend the command, you will observe a change in the values (darker means a higher value and lighter means a lower one). You will find the readings are always one behind; this is because as it returns the previous sample, it captures the next sample.</p><p>We use the following command to specify a particular channel to read:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo i2cset -y 1 0x48 0x01</strong></span>
</pre></div><p>This changes the channel that is read to channel 1 (this is marked as <span class="strong"><strong>AIN1</strong></span> on the module). Remember, you will need to perform two reads before you will see data from the newly selected channel. The following table shows the channels and pin names as well as which jumper connectors enable/disable each of the sensors:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Channel</p>
</th><th style="text-align: left" valign="bottom">
<p>0</p>
</th><th style="text-align: left" valign="bottom">
<p>1</p>
</th><th style="text-align: left" valign="bottom">
<p>2</p>
</th><th style="text-align: left" valign="bottom">
<p>3</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Pin Name</p>
</td><td style="text-align: left" valign="top">
<p>AIN0</p>
</td><td style="text-align: left" valign="top">
<p>AIN1</p>
</td><td style="text-align: left" valign="top">
<p>AIN2</p>
</td><td style="text-align: left" valign="top">
<p>AIN3</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Sensor</p>
</td><td style="text-align: left" valign="top">
<p>Light Dependent Resistor</p>
</td><td style="text-align: left" valign="top">
<p>Thermistor</p>
</td><td style="text-align: left" valign="top">
<p>External Pin</p>
</td><td style="text-align: left" valign="top">
<p>Potentiometer</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Jumper</p>
</td><td style="text-align: left" valign="top">
<p>P5</p>
</td><td style="text-align: left" valign="top">
<p>P4</p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>P6</p>
</td></tr></tbody></table></div><p>Next, we control<a class="indexterm" id="id428"/> the AOUT pin by setting the analog output enable<a class="indexterm" id="id429"/> flag (bit 6) of the control register and use the next value to set the analog voltage (0V-3.3V 0x00-0xFF), as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo i2cset -y 1 0x48 0x40 0xff </strong></span>
</pre></div><p>Finally, you can set bit 2 (<code class="literal">0x04</code>) to auto-increment and cycle through the input channels as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo i2cset -y 1 0x48 0x04</strong></span>
</pre></div><p>Each time you run <code class="literal">i2cget -y 1 0x48</code>, the next channel will be selected, starting with channel AIN0, then AIN1 through to AIN3, and back to AIN0 again.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note62"/>Note</h3><p>To understand how to set a particular bit in a value, it helps to look at the binary representation of a number. The 8-bit value <code class="literal">0x04</code> can be written as <code class="literal">b0000 0100</code> in binary (<code class="literal">0x</code> indicates the value is written in hexadecimal or hex, and b indicates a binary number).</p><p>Bits within binary numbers are counted from right to left, starting with 0, that is, MSB 7 6 5 4 3 2 1 0 LSB.</p><p>Bit 7 <a class="indexterm" id="id430"/>is known as the<a class="indexterm" id="id431"/> <span class="strong"><strong>Most Significant Bit</strong></span> (<span class="strong"><strong>MSB</strong></span>) and bit 0 as the <a class="indexterm" id="id432"/>
<span class="strong"><strong>Least Significant Bit</strong></span> (<span class="strong"><strong>LSB</strong></span>). Therefore, by setting bit 2, we end up with <code class="literal">b0000 0100</code> (which is <code class="literal">0x04</code>).</p></div></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec130"/>There's more...</h2></div></div></div><p>The I<sup>2</sup>C bus allows us to easily connect multiple devices using only a few wires. The PCF8591 chip can be used to connect your own sensors to the module or just the chip.</p><div class="section" title="Using multiple I2C devices"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec44"/>Using multiple I<sup>2</sup>C devices</h3></div></div></div><p>All<a class="indexterm" id="id433"/> commands on the I<sup>2</sup>C bus are addressed to a specific I<sup>2</sup>C device (many have the option to set some pins high or low to select additional addresses and allow multiple devices to exist on the same bus). Each device must have a unique address so that only one device will respond at any one time. The PCF8591 starting address is <code class="literal">0x48</code>, with additional addresses selectable by the three address pins to <code class="literal">0x4F</code>. This allows up to eight PCF8591 devices to be used on the same bus.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note63"/>Note</h3><p>If you decide to use the I2C_VC bus that is located on GPIO pins 27 and 2828 (or on the P5 header on Model A and Rev2 Model B devices), you may need to add a 1k8 ohm pull-up resistor between the I<sup>2</sup>C lines and 3.3V. These resistors are already present on the I<sup>2</sup>C bus on the GPIO connector. However, some I<sup>2</sup>C modules, including the PCF8591 module, have their own resistors fitted, so it will work without the extra resistors.</p></div></div></div><div class="section" title="I2C bus and level shifting"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec45"/>I<sup>2</sup>C bus and level shifting</h3></div></div></div><p>The I<sup>2</sup>C bus <a class="indexterm" id="id434"/>consists of two wires, one data (SDA) and one clock (SCL). Both are passively pulled to VCC (on the Raspberry Pi, this is 3.3V) with pull-up resistors. The Raspberry Pi will control the clock by pulling it low every cycle and the data line can be pulled low by Raspberry Pi to send commands or by the connected device to respond with data.</p><div class="mediaobject"><img alt="I2C bus and level shifting" src="graphics/6623OT_07_005.jpg"/><div class="caption"><p>The Raspberry Pi I<sup>2</sup>C pins include pull-up resistors on SDA and SCL</p></div></div><p>Since the slave devices can only pull the data line to <span class="strong"><strong>GND</strong></span>, the device may be powered by <span class="strong"><strong>3.3V</strong></span> or even <span class="strong"><strong>5V</strong></span> without the risk of driving the GPIO pins too high (remember that the Raspberry Pi GPIO is not able to handle voltages over 3.3V). This should work as long as the I<sup>2</sup>C bus of the device will recognize logic high at 3.3V instead of 5V. The I<sup>2</sup>C device must not have its own pull-up resistors fitted, as this will cause the GPIO pins to be pulled to the supply voltage of the I<sup>2</sup>C device.</p><p>Note the PCF8591 module used in this chapter has resistors fitted; therefore, we must only use VCC=3V3. A <a class="indexterm" id="id435"/>bidirectional logic level converter can be used to overcome any issues with logic levels. One such device is the <span class="strong"><strong>Adafruit</strong></span>
<a class="indexterm" id="id436"/> I<sup>2</sup>C bidirectional logic level translator, shown in the following image:</p><div class="mediaobject"><img alt="I2C bus and level shifting" src="graphics/6623OT_07_006.jpg"/><div class="caption"><p>Adafruit I<sup>2</sup>C Bi-directional logic level translator module</p></div></div><p>In addition to ensuring that any logic voltages are at suitable levels for the device you are using, it will allow the bus to be extended over longer wires (the level shifter will also act as a bus repeater).</p></div><div class="section" title="Using just the PCF8591 chip or adding alternative sensors"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec46"/>Using just the PCF8591 chip or adding alternative sensors</h3></div></div></div><p>A circuit diagram of the <a class="indexterm" id="id437"/>PCF8591 module without the sensors attached is <a class="indexterm" id="id438"/>shown in the following diagram:</p><div class="mediaobject"><img alt="Using just the PCF8591 chip or adding alternative sensors" src="graphics/6623OT_07_007.jpg"/><div class="caption"><p>The PCF8591 ADC circuit – VCC, GND, SCL, and SDA are connected to the Raspberry Pi as before</p></div></div><p>As you can see, excluding the sensors, there are only five additional components. We have a power-filtering capacitor (C1) and the power-indicating LED (D2) with a current-limiting resistor (R5), all of which are optional.</p><p>It should be noted that the <a class="indexterm" id="id439"/>module includes two 10k pull-up resistors (R8 and R9) for SCL<a class="indexterm" id="id440"/> and SDA signals. However, since the GPIO I<sup>2</sup>C connections on the Raspberry Pi also include pull-up resistors, these are not needed on the module (and could be removed). It also means we should only connect this module to VCC=3.3V (if we use 5V, then voltages on SCL and SDA will be around 3.56V, which is too high for the Raspberry Pi GPIO pins).</p><p>The sensors on the PCF891 module are all resistive, so the voltage level that is present on analog input will change between GND and VCC as the resistance of the sensor changes.</p><div class="mediaobject"><img alt="Using just the PCF8591 chip or adding alternative sensors" src="graphics/6623OT_07_008.jpg"/><div class="caption"><p>A potential divider circuit is used to provide a voltage proportional to the sensor's resistance</p></div></div><p>The module uses a circuit known as a potential divider. The resistor at the top balances the resistance provided by the sensor at the bottom to provide a voltage that is somewhere between VCC and GND.</p><p>The output voltage (<span class="emphasis"><em>Vout</em></span>) of the potential divider can be calculated as follows:</p><div class="mediaobject"><img alt="Using just the PCF8591 chip or adding alternative sensors" src="graphics/6623OT_07_009.jpg"/></div><p>The Rt and Rb are the resistance values at the top and bottom respectively, and VCC is the supply voltage.</p><p>The potentiometer in the module<a class="indexterm" id="id441"/> has the 10k ohm resistance split between top and bottom depending on the position of the adjuster. So, halfway, we have 5k ohm on each side and an output voltage of 1.65V; a quarter of the way (clockwise), we have 2.5k ohm and 7.5k ohm, producing 0.825V.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note64"/>Note</h3><p>I've not shown the AOUT circuit, which is a resistor and LED. However, as you will find, an LED isn't suited to indicate an analog output (except to show the on/off states).</p></div></div><p>For more sensitive circuits, you <a class="indexterm" id="id442"/>can use more complex circuits such as a <a class="indexterm" id="id443"/>
<span class="strong"><strong>Wheatstone bridge</strong></span> (which allows the detection of very small changes in resistance), or you can use dedicated sensors that output an analog voltage based on their readings (such as a <a class="indexterm" id="id444"/>
<span class="strong"><strong>TMP36</strong></span> temperature sensor). The PCF891 also supports the differential input mode, where one channel can be compared to the input of another (the resultant reading will be the difference between the two).</p><p>For more information on the<a class="indexterm" id="id445"/> PCF8591 chip, refer to the datasheet at <a class="ulink" href="http://www.nxp.com/documents/data_sheet/PCF8591.pdf">http://www.nxp.com/documents/data_sheet/PCF8591.pdf</a>.</p></div></div></div>
<div class="section" title="Reading analog data using an analog-to-digital converter"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec52"/>Reading analog data using an analog-to-digital converter</h1></div></div></div><p>The I2CTools (used in the previous section) are very useful for debugging I<sup>2</sup>C devices on the command line, but they are not practical for use within Python, as they would be slow and require significant overhead to use. Fortunately, there are several Python libraries that provide I<sup>2</sup>C support, allowing efficient use of I<sup>2</sup>C to communicate with connected devices and provide easy operation.</p><p>We will use such a library to create<a class="indexterm" id="id446"/> our own Python module that <a class="indexterm" id="id447"/>will allow us to quickly and easily obtain data from the ADC device and use it in our programs. The module is designed in such a way that other hardware or data sources may be put in its place without impacting the remaining examples.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec131"/>Getting ready</h2></div></div></div><p>To use the I<sup>2</sup>C bus using Python 3, we will use Gordon Henderson's <code class="literal">wiringPi2</code>
<a class="indexterm" id="id448"/> (see <a class="ulink" href="http://wiringpi.com/">http://wiringpi.com/</a> for more details).</p><p>The easiest way to install <code class="literal">wiringPi2</code> is by using PIP for Python 3. PIP is a package manager for Python that works in a similar way to <code class="literal">apt-get</code>. Any packages you wish to install will be automatically downloaded and installed from an online repository.</p><p>To install PIP, use the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get install python3-dev python3-pip</strong></span>
</pre></div><p>Then install <code class="literal">wiringPi2</code> with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo pip-3.2 install wiringpi2</strong></span>
</pre></div><p>Once the install has completed, you should see the following, indicating success:</p><div class="mediaobject"><img alt="Getting ready" src="graphics/6623OT_07_010.jpg"/><div class="caption"><p>Successfully installed wiringPi2</p></div></div><p>You will need the PCF8591 module wired as before to the I<sup>2</sup>C connections of the Raspberry Pi.</p><div class="mediaobject"><img alt="Getting ready" src="graphics/6623OT_07_011.jpg"/><div class="caption"><p>The PCF8591 module and pin connections to the Raspberry Pi GPIO connector (as used in the previous section)</p></div></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec132"/>How to do it...</h2></div></div></div><p>In the next section, we shall<a class="indexterm" id="id449"/> write a script to allow us to<a class="indexterm" id="id450"/> gather data that we will then use later on in this chapter.</p><p>Create the following script, <code class="literal">data_adc.py</code>, as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, import the modules and create the variables we will use, as follows:<div class="informalexample"><pre class="programlisting">#!/usr/bin/env python3
#data_adc.py
import wiringpi2
import time

DEBUG=False
LIGHT=0;TEMP=1;EXT=2;POT=3
ADC_CH=[LIGHT,TEMP,EXT,POT]
ADC_ADR=0x48
ADC_CYCLE=0x04
BUS_GAP=0.25
DATANAME=["0:Light","1:Temperature",
          "2:External","3:Potentiometer"]</pre></div></li><li class="listitem">Create the class called <code class="literal">device</code> with a constructor to initialize it, as follows:<div class="informalexample"><pre class="programlisting">class device:
  # Constructor:
  def __init__(self,addr=ADC_ADR):
    self.NAME = DATANAME
    self.i2c = wiringpi2.I2C()
    self.devADC=self.i2c.setup(addr)
    pwrup = self.i2c.read(self.devADC) #flush powerup value
    if DEBUG==True and pwrup!=-1:
      print("ADC Ready")
    self.i2c.read(self.devADC) #flush first value
    time.sleep(BUS_GAP)
    self.i2c.write(self.devADC,ADC_CYCLE)
    time.sleep(BUS_GAP)
    self.i2c.read(self.devADC) #flush first value</pre></div></li><li class="listitem">Within the class, define<a class="indexterm" id="id451"/> a function <a class="indexterm" id="id452"/>to provide a list of channel names as follows:<div class="informalexample"><pre class="programlisting">  def getName(self):
    return self.NAME</pre></div></li><li class="listitem">Define another function (still as part of the class) to return a new set of samples from the ADC channels as follows:<div class="informalexample"><pre class="programlisting">  def getNew(self):
    data=[]
    for ch in ADC_CH:
      time.sleep(BUS_GAP)
      data.append(self.i2c.read(self.devADC))
    return data</pre></div></li><li class="listitem">Finally, after the device class, create a test function to exercise our new <code class="literal">device</code> class as follows. This is only to be run when the script is executed directly:<div class="informalexample"><pre class="programlisting">def main():
  ADC = device(ADC_ADR)
  print (str(ADC.getName()))
  for i in range(10):
    dataValues = ADC.getNew()
    print (str(dataValues))
    time.sleep(1)

if __name__=='__main__':
  main()
#End</pre></div></li></ol></div><p>You can run the test function of this module using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo python3 data_adc.py</strong></span>
</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec133"/>How it works...</h2></div></div></div><p>We start by importing <code class="literal">wiringpi2</code> so we can communicate with our I<sup>2</sup>C device later on.  We will create a class to contain the required functionality to control the ADC. When we  create the class, we can initialize <code class="literal">wiringPi2</code> in such a way that it is ready to use the I<sup>2</sup>C bus (using <code class="literal">wiringpi2.I2C()</code>), and we set up a generic I<sup>2</sup>C device with the chip's bus address (using <code class="literal">self.i2c.setup(0x48)</code>).</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note65"/>Note</h3><p>
<code class="literal">wiringPi2</code> also <a class="indexterm" id="id453"/>has a dedicated class to use with the PCF8591 chip; however, in this case, it is more useful to use the standard I<sup>2</sup>C functionality to illustrate how any I<sup>2</sup>C device can be controlled using <code class="literal">wiringPi2</code>. By referring to the device datasheet, you can use similar commands to communicate to any connected I<sup>2</sup>C device (whether it is directly supported or not).</p></div></div><p>As before, we perform a<a class="indexterm" id="id454"/> device read and configure<a class="indexterm" id="id455"/> the ADC to cycle through the channels, but instead of <code class="literal">i2cget</code> and <code class="literal">i2cset</code>, we use the <code class="literal">wiringPi2</code> read and write functions of the I<sup>2</sup>C object. Once initialized, the device will be ready to read the analog signals on each of the channels.</p><p>The class will also have two member functions. The first function, <code class="literal">getName()</code>, returns a list of channel names (which we can use to correlate our data to its source) and the second function, <code class="literal">getNew()</code>, returns a new set of data from all the channels. The data is read from ADC using the <code class="literal">i2c.read()</code> function and, since we have already put it into cycle mode, each read will be from the next channel.</p><p>As we plan to reuse this class later on, we will use the <code class="literal">if __name__</code> test to allow us to define some code to run when we execute the file directly. Within our <code class="literal">main()</code> function, we create ADC, which is an instance of our new device class. We can choose to select a non-default address if we need to; otherwise, the default address for the chip will be used. We use the <code class="literal">getName()</code> function to print out the names of the channels and then we can collect data from the <code class="literal">ADC</code> (using <code class="literal">getNew()</code>) and display them.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec134"/>There's more...</h2></div></div></div><p>The following allows us to define an alternative version of the device class in <code class="literal">data_adc.py</code> so it can be used in place of the ADC module. This will allow the remaining sections of the chapter to be tried without needing any specific hardware.</p><div class="section" title="Gathering analog data without hardware"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec47"/>Gathering analog data without hardware</h3></div></div></div><p>If you don't <a class="indexterm" id="id456"/>have an ADC module available, there is a wealth of data available from within Raspberry Pi that you can use instead.</p><p>Create the following script, <code class="literal">data_local.py</code>:</p><div class="informalexample"><pre class="programlisting">#!/usr/bin/env python3
#data_local.py
import subprocess
from random import randint
import time

MEM_TOTAL=0
MEM_USED=1
MEM_FREE=2
MEM_OFFSET=7
DRIVE_USED=0
DRIVE_FREE=1
DRIVE_OFFSET=9
DEBUG=False
DATANAME=["CPU_Load","System_Temp","CPU_Frequency",
          "Random","RAM_Total","RAM_Used","RAM_Free",
          "Drive_Used","Drive_Free"]

def read_loadavg():
  # function to read 1 minute load average from system uptime
  value = subprocess.check_output(
            ["awk '{print $1}' /proc/loadavg"], shell=True)
  return float(value)

def read_systemp():
  # function to read current system temperature
  value = subprocess.check_output(
            ["cat /sys/class/thermal/thermal_zone0/temp"],
            shell=True)
  return int(value)

def read_cpu():
  # function to read current clock frequency
  value = subprocess.check_output(
            ["cat /sys/devices/system/cpu/cpu0/cpufreq/"+
             "scaling_cur_freq"], shell=True)
  return int(value)
  
def read_rnd():
  return randint(0,255)

def read_mem():
  # function to read RAM info
  value = subprocess.check_output(["free"], shell=True)
  memory=[]
  for val in value.split()[MEM_TOTAL+
                           MEM_OFFSET:MEM_FREE+
                           MEM_OFFSET+1]:
    memory.append(int(val))
  return(memory)
  
def read_drive():
  # function to read drive info
  value = subprocess.check_output(["df"], shell=True)
  memory=[]
  for val in value.split()[DRIVE_USED+
                           DRIVE_OFFSET:DRIVE_FREE+
                           DRIVE_OFFSET+1]:
    memory.append(int(val))
  return(memory)

class device:
  # Constructor:
  def __init__(self,addr=0):
    self.NAME=DATANAME
    
  def getName(self):
    return self.NAME

  def getNew(self):
    data=[]
    data.append(read_loadavg())
    data.append(read_systemp())
    data.append(read_cpu())
    data.append(read_rnd())
    memory_ram = read_mem()
    data.append(memory_ram[MEM_TOTAL])
    data.append(memory_ram[MEM_USED])
    data.append(memory_ram[MEM_FREE])
    memory_drive = read_drive()
    data.append(memory_drive[DRIVE_USED])
    data.append(memory_drive[DRIVE_FREE])
    return data

def main():
  LOCAL = device()
  print (str(LOCAL.getName()))
  for i in range(10):
    dataValues = LOCAL.getNew()
    print (str(dataValues))
    time.sleep(1)

if __name__=='__main__':
  main()
#End</pre></div><p>The preceding <a class="indexterm" id="id457"/>script allows us to gather system information from the Raspberry Pi using the following commands (the <code class="literal">subprocess</code> module allows us to capture the results and process them):</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">CPU speed:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq</strong></span>
</pre></div></li><li class="listitem" style="list-style-type: disc">CPU load:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>awk '{print $1}' /proc/loadavg</strong></span>
</pre></div></li><li class="listitem" style="list-style-type: disc">Core temperature (scaled by 1,000):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>cat /sys/class/thermal/thermal_zone0/temp</strong></span>
</pre></div></li><li class="listitem" style="list-style-type: disc">Drive info:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>df</strong></span>
</pre></div></li><li class="listitem" style="list-style-type: disc">RAM info:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>free</strong></span>
</pre></div></li></ul></div><p>Each data item is sampled using one of the functions. In the case of the drive and RAM information, we split the response into a list (separated by spaces) and select the items that we want to monitor (such as available memory and used drive space).</p><p>This is all packaged up to function in the same way as the <code class="literal">data_adc.py</code> file and the <code class="literal">device</code> class (so you can choose to use either in the following examples just by swapping the <code class="literal">data_adc</code> include with <code class="literal">data_local</code>).</p></div></div></div>
<div class="section" title="Logging and plotting data"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec53"/>Logging and plotting data</h1></div></div></div><p>Now that we are able to<a class="indexterm" id="id458"/> sample and collect a lot of data, it is important that we can<a class="indexterm" id="id459"/> capture and analyze it. We will make use of a Python library called <code class="literal">matplotlib</code>, which includes lots of useful tools for manipulating, graphing, and analyzing data. We will use <code class="literal">pyplot</code> (which is a part of <code class="literal">matplotlib</code>) to produce graphs of our captured data. For more information on <code class="literal">pyplot</code>, go <a class="indexterm" id="id460"/>to <a class="ulink" href="http://matplotlib.org/users/pyplot_tutorial.html">http://matplotlib.org/users/pyplot_tutorial.html</a>.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec135"/>Getting ready</h2></div></div></div><p>To use <code class="literal">pyplot</code>, we will need to install <code class="literal">matplotlib</code>.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note66"/>Note</h3><p>Due to a problem with the <code class="literal">matplotlib</code> installer, performing the installation using pip-3.2 doesn't always work correctly. The method that follows will overcome this problem by performing all the steps PIP does manually; however, this can take over 30 minutes to complete.</p><p>To save time, you can try the PIP installation, which is much quicker. If it doesn't work, you can install it using this manual method.</p><p>Try installing <code class="literal">matplotlib</code> using PIP with the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get install tk-dev python3-tk libpng-dev</strong></span>
<span class="strong"><strong>sudo pip-3.2 install numpy</strong></span>
<span class="strong"><strong>sudo pip-3.2 install matplotlib</strong></span>
</pre></div></div></div><p>You can confirm<a class="indexterm" id="id461"/> <code class="literal">matplotlib</code> has installed by running <code class="literal">python3</code> and trying to import<a class="indexterm" id="id462"/> it from the Python terminal, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>import matplotlib</strong></span>
</pre></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note67"/>Note</h3><p>If the installation failed, it will respond with the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>ImportError: No module named matplotlib</strong></span>
</pre></div><p>Otherwise, there will be no errors.</p></div></div><p>Use the following steps to install <code class="literal">matplotlib</code> manually:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install the support packages as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get install tk-dev python3-tk python3-dev libpng-dev</strong></span>
<span class="strong"><strong>sudo pip-3.2 install numpy</strong></span>
<span class="strong"><strong>sudo pip-3.2 install matplotlib</strong></span>
</pre></div></li><li class="listitem">Download the source files from the Git repository (the command should be a single line) as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>wget https://github.com/matplotlib/matplotlib/archive/master.zip</strong></span>
</pre></div></li><li class="listitem">Unzip and open the <code class="literal">matplotlib-master</code> folder created, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>unzip master.zip</strong></span>
<span class="strong"><strong>rm master.zip</strong></span>
<span class="strong"><strong>cd matplotlib-master</strong></span>
</pre></div></li><li class="listitem">Run the setup file to build (this will take a while) and install it as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo python3 setup.py build</strong></span>
<span class="strong"><strong>sudo python3 setup.py install</strong></span>
</pre></div></li><li class="listitem">Test the installation in the same way as the automated install.</li></ol></div><p>We will either need the PCF8591 ADC module (and <code class="literal">wiringPi2</code> installed as before), or we can use the <code class="literal">data_local.py</code> module from the previous section (just replace <code class="literal">data_adc</code> with <code class="literal">data_local</code> in the import section of the script). We also need to have <code class="literal">data_adc.py</code> and <code class="literal">data_local.py</code> in the same directory as the new script, depending on which you use.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec136"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the<a class="indexterm" id="id463"/> following <a class="indexterm" id="id464"/>script, <code class="literal">log_adc.py</code>:<div class="informalexample"><pre class="programlisting">#!/usr/bin/python3
#log_adc.c
import time
import datetime
import data_adc as dataDevice

DEBUG=True
FILE=True
VAL0=0;VAL1=1;VAL2=2;VAL3=3 #Set data order
FORMATHEADER = "\t%s\t%s\t%s\t%s\t%s"
FORMATBODY = "%d\t%s\t%f\t%f\t%f\t%f"

if(FILE):f = open("data.log",'w')

def timestamp():
  ts = time.time() 
  return datetime.datetime.fromtimestamp(ts).strftime(
                                    '%Y-%m-%d %H:%M:%S')

def main():
    counter=0
    myData = dataDevice.device()
    myDataNames = myData.getName()
    header = (FORMATHEADER%("Time",
                        myDataNames[VAL0],myDataNames[VAL1],
                        myDataNames[VAL2],myDataNames[VAL3]))
    if(DEBUG):print (header)
    if(FILE):f.write(header+"\n")
    while(1):
      data = myData.getNew()
      counter+=1
      body = (FORMATBODY%(counter,timestamp(),
                        data[0],data[1],data[2],data[3]))
      if(DEBUG):print (body)
      if(FILE):f.write(body+"\n")
      time.sleep(0.1)

try:
  main()
finally:
  f.close()
#End</pre></div></li><li class="listitem">Create a <a class="indexterm" id="id465"/>second<a class="indexterm" id="id466"/> script, <code class="literal">log_graph.py</code>, as follows:<div class="informalexample"><pre class="programlisting">#!/usr/bin/python3
#log_graph.py
import numpy as np
import matplotlib.pyplot as plt

filename = "data.log"
OFFSET=2
with open(filename) as f:
    header = f.readline().split('\t')
    
data = np.genfromtxt(filename, delimiter='\t', skip_header=1,
                    names=['sample', 'date', 'DATA0',
                           'DATA1', 'DATA2', 'DATA3'])
fig = plt.figure(1)
ax1 = fig.add_subplot(211)#numrows, numcols, fignum
ax2 = fig.add_subplot(212)
ax1.plot(data['sample'],data['DATA0'],'r',
         label=header[OFFSET+0])
ax2.plot(data['sample'],data['DATA1'],'b',
         label=header[OFFSET+1])
ax1.set_title("ADC Samples")    
ax1.set_xlabel('Samples')
ax1.set_ylabel('Reading')
ax2.set_xlabel('Samples')
ax2.set_ylabel('Reading')

leg1 = ax1.legend()
leg2 = ax2.legend()

plt.show()
#End</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec137"/>How it works...</h2></div></div></div><p>The first script, <code class="literal">log_adc.py</code>, allows us to collect data and write it to a logfile.</p><p>We can use the ADC <a class="indexterm" id="id467"/>device by importing <code class="literal">data_adc</code> as <code class="literal">dataDevice</code> or we can<a class="indexterm" id="id468"/> import  <code class="literal">data_local</code> to use the system data. The numbers given to <code class="literal">VAL0</code> through <code class="literal">VAL3</code> allow us to change the order of the channels (and if using the <code class="literal">data_local</code> device, select the other channels). We also define the format string for the header and each line in the logfile (to create a file with data separated by tabs) using <code class="literal">%s</code>, <code class="literal">%d</code>, and <code class="literal">%f</code> to allow us to substitute strings, integers, and float values, as shown in the following table:</p><div class="mediaobject"><img alt="How it works..." src="graphics/6623OT_07_012.jpg"/><div class="caption"><p>The table of data captured from the ADC sensor module</p></div></div><p>If logging in to the file (when <code class="literal">FILE=True</code>), we open <code class="literal">data.log</code> in write mode using the <code class="literal">'w'</code> option (this will overwrite any existing files; to append to a file, use <code class="literal">'a'</code>).</p><p>As part of our data log, we generate <code class="literal">timestamp</code> using <code class="literal">time</code> and <code class="literal">datetime</code> to get the current <a class="indexterm" id="id469"/>
<span class="strong"><strong>Epoch time</strong></span> (this is the number of milliseconds since Jan 1, 1970) using the <code class="literal">time.time()</code> command. We convert the value into a more friendly <code class="literal">year-month-day hour:min:sec</code> format using <code class="literal">strftime()</code>.</p><p>The <code class="literal">main()</code> function starts by creating an instance of our <code class="literal">device</code> class (we made this in the previous example), which will supply the data. We fetch the channel names from the <code class="literal">data</code> device and construct the <code class="literal">header</code> string. If <code class="literal">DEBUG</code> is set to <code class="literal">True</code>, the data is printed to screen; if <code class="literal">FILE</code> is set to <code class="literal">True</code>, it will be written to file.</p><p>In the main loop, we use the <code class="literal">getNew()</code> function of the device to collect data and format it to display on screen or log to the file. The <code class="literal">main()</code> function is called using the <code class="literal">try: finally:</code> command, which will ensure that when the script is aborted the file will be correctly closed.</p><p>The second script, <code class="literal">log_graph.py</code>, allows us to read the logfile and produce a graph of the recorded data, as shown in the following figure:</p><div class="mediaobject"><img alt="How it works..." src="graphics/6623OT_07_013.jpg"/><div class="caption"><p>Graphs produced by log_graph.py from the light and temperature sensors</p></div></div><p>We start by opening <a class="indexterm" id="id470"/>up the logfile and reading the first line; this contains the header<a class="indexterm" id="id471"/> information (which we can then use to identify the data later on). Next, we use <code class="literal">numpy</code>, a specialist Python library that extends how we can manipulate data and numbers. In this case, we use it to read in the data from the file, split it up based on the tab delimiter, and provide identifiers for each of the data channels.</p><p>We define a figure to hold our graphs, adding two subplots (located in a 2 x 1 grid and positions 1 and 2 in the grid – set by the values <code class="literal">211</code> and <code class="literal">212</code>). Next, we define the values we want to plot, providing the <code class="literal">x</code> values (<code class="literal">data['sample']</code>), the <code class="literal">y</code> values (<code class="literal">data['DATA0']</code>), the <code class="literal">color</code> value (<code class="literal">'r'</code> which is <code class="literal">Red</code> or <code class="literal">'b'</code> for <code class="literal">Blue</code>), and <code class="literal">label</code> (set to the heading text we read previously from the top of the file).</p><p>Finally, we set a title, <code class="literal">x</code> and <code class="literal">y</code> labels for each subplot, enable legends (to show the labels), and display the plot (using <code class="literal">plt.show()</code>).</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec138"/>There's more...</h2></div></div></div><p>Now that we have the ability to see the data we have been capturing, we can take things even further by displaying it as we sample it. This will allow us to instantly see how the data reacts to changes in the environment or stimuli. We can also calibrate our data so that we can assign the appropriate scaling to produce measurements in real units.</p><div class="section" title="Plotting live data"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec48"/>Plotting live data</h3></div></div></div><p>Besides plotting data <a class="indexterm" id="id472"/>from files, we can use <code class="literal">matplotlib</code> to plot sensor data as it is sampled. To achieve this, we can use the <code class="literal">plot-animation</code> feature, which automatically calls a function to collect new data and update our plot.</p><p>Create the following script, <code class="literal">live_graph.py</code>:</p><div class="informalexample"><pre class="programlisting">#!/usr/bin/python3
#live_graph.py
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.animation as animation
import data_local as dataDevice

PADDING=5
myData = dataDevice.device()
dispdata = []
timeplot=0
fig, ax = plt.subplots()
line, = ax.plot(dispdata)

def update(data):
  global dispdata,timeplot
  timeplot+=1
  dispdata.append(data)
  ax.set_xlim(0, timeplot)
  ymin = min(dispdata)-PADDING
  ymax = max(dispdata)+PADDING
  ax.set_ylim(ymin, ymax)
  line.set_data(range(timeplot),dispdata)
  return line

def data_gen():
  while True:
    yield myData.getNew()[1]/1000

ani = animation.FuncAnimation(fig, update, 
                              data_gen, interval=1000)
plt.show()
#End</pre></div><p>We start by defining our <code class="literal">dataDevice</code> object and creating an empty array, <code class="literal">dispdata[]</code>, which will hold all the data collected. Next, we define our subplot and the line we are going to plot.</p><p>The <code class="literal">FuncAnimation()</code> function allows us to update a figure (<code class="literal">fig</code>) by defining an update function and a generator function. The generator function (<code class="literal">data_gen()</code>) will be called every interval (1,000 ms) and will produce a data value.</p><p>This example <a class="indexterm" id="id473"/>uses the core temperature reading that, when divided by 1,000, gives the actual temperature in <code class="literal">degC</code>.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip16"/>Tip</h3><p>To use the ADC data instead, change the import for <code class="literal">dataDevice</code> to <code class="literal">data_adc</code> and adjust the following line to use a channel other than <code class="literal">[1]</code> and apply a scaling that is different from 1,000:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>yield myData.getNew()[1]/1000</strong></span>
</pre></div></div></div><div class="mediaobject"><img alt="Plotting live data" src="graphics/6623OT_07_014.jpg"/><div class="caption"><p>The Raspberry Pi plotting in real time (core temperature in degC versus time in seconds)</p></div></div><p>The data value is passed to the <code class="literal">update()</code> function, which allows us to add it to our <code class="literal">dispdata[]</code> array that will contain all the data values to be displayed in the plot. We adjust the <span class="emphasis"><em>x</em></span> axis range to be near the <code class="literal">min</code> and <code class="literal">max</code> values of the data, as well as adjust the <span class="emphasis"><em>y</em></span> axis to grow as we continue to sample more data.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note69"/>Note</h3><p>The <code class="literal">FuncAnimation()</code> function requires the <code class="literal">data_gen()</code> object to be a special type of function called <code class="literal">generator</code>. A <code class="literal">generator</code> function produces a continuous series of values each time it is called, and can even use its previous state to calculate the next value if required. This is used to perform continuous calculations for plotting; this is why it is used here. In our case, we just want to run the same sampling function (<code class="literal">new_data()</code>) continuously, so each time it is called, it will yield a new sample.</p></div></div><p>Finally, we <a class="indexterm" id="id474"/>update the <span class="emphasis"><em>x</em></span> and <span class="emphasis"><em>y</em></span> axes data with our <code class="literal">dispdata[]</code> array (using the <code class="literal">set_data()</code> function), which will plot our samples against the number of seconds we are sampling. To use other data, or to plot data from the ADC, adjust the import for <code class="literal">dataDevice</code> and select the required channel (and scaling) in the <code class="literal">data_gen()</code> function.</p></div><div class="section" title="Scaling and calibrating data"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec49"/>Scaling and calibrating data</h3></div></div></div><p>You may have<a class="indexterm" id="id475"/> noticed that it can sometimes be difficult to interpret data read from an ADC, since <a class="indexterm" id="id476"/>the value is just a number. A number isn't much help except to tell you it is slightly hotter or slightly darker than the previous sample. However, if you can use another device to provide comparable values (such as the current room temperature), you can then calibrate your sensor data to provide more useful real-world information.</p><p>To obtain a rough calibration, we shall use two samples to create a linear fit model that can then be used to estimate real-world values for other ADC readings (this assumes the sensor itself is mostly linear in its response). The following figure shows a linear fit using two readings at 25 and 30 degrees Celsius, providing estimated ADC values for other temperatures:</p><div class="mediaobject"><img alt="Scaling and calibrating data" src="graphics/6623OT_07_015.jpg"/><div class="caption"><p>Samples are used to linearly calibrate temperature sensor readings</p></div></div><p>We can calculate our model using the following function:</p><div class="informalexample"><pre class="programlisting">  def linearCal(realVal1,readVal1,realVal2,readVal2):
    #y=Ax+C
    A = (realVal1-realVal2)/(readVal1-readVal2)
    C = realVal1-(readVal1*A)
    cal = (A,C)
    return cal</pre></div><p>This will return <code class="literal">cal</code>, which will contain the model slope (<code class="literal">A</code>) and offset (<code class="literal">C</code>).</p><p>We can then use the following function to calculate the value of any reading by using the calculated <code class="literal">cal</code> values for that channel:</p><div class="informalexample"><pre class="programlisting">  def calValue(readVal,cal = [1,0]):
    realVal = (readVal*cal[0])+cal[1]
    return realVal</pre></div><p>For more accuracy, you <a class="indexterm" id="id477"/>can take several samples and use linear interpolation between the <a class="indexterm" id="id478"/>values (or fit the data to other more complex mathematical models), if required.</p></div></div></div>
<div class="section" title="Extending the Raspberry Pi GPIO with an I/O expander"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec54"/>Extending the Raspberry Pi GPIO with an I/O expander</h1></div></div></div><p>As we have seen, making use<a class="indexterm" id="id479"/> of the higher-level bus protocols <a class="indexterm" id="id480"/>allows us to connect to more complex hardware quickly and easily. The I<sup>2</sup>C can be put to great use by using it to expand the available I/O on the Raspberry Pi as well as providing additional circuit protection (and, in some cases, additional power to drive more hardware).</p><p>There are lots of devices available that provide I/O expansion over the I<sup>2</sup>C bus (and also SPI), but the most commonly used is a 28-pin device, MCP23017, which provides 16 additional digital input/output pins. Being an I<sup>2</sup>C device, it only requires the two signals (SCL and SDA connections plus ground and power) and will happily function with other I<sup>2</sup>C devices on the same bus.</p><p>We shall see how the Adafruit I<sup>2</sup>C 16x2 RGB LCD Pi Plate makes use of one of these chips to control an LCD alphanumeric display and keypad over the I<sup>2</sup>C bus (without the I/O expander, this would normally require up to 15 GPIO pins).</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec139"/>Getting ready</h2></div></div></div><p>You will need the Adafruit I<sup>2</sup>C 16x2 RGB LCD Pi Plate (which also includes five keypad buttons), and is shown in the following image:</p><div class="mediaobject"><img alt="Getting ready" src="graphics/6623OT_07_016.jpg"/><div class="caption"><p>Adafruit I<sup>2</sup>C 16x2 RGB LCD Pi Plate with keypad buttons</p></div></div><p>The Adafruit I<sup>2</sup>C 16x2 <a class="indexterm" id="id481"/>RGB LCD Pi Plate directly <a class="indexterm" id="id482"/>connects to the GPIO connector of Raspberry Pi.</p><p>As before, we can use the PCF8591 ADC module or use the <code class="literal">data_local.py</code> module from the previous section (use <code class="literal">data_adc</code> or <code class="literal">data_local</code> in the import section of the script). The files <code class="literal">data_adc.py</code> and <code class="literal">data_local.py</code> should be in the same directory as the new script.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip17"/>Tip</h3><p>The LCD Pi Plate only requires five pins (SDA, SCL, GND, and 5V); it connects over the whole GPIO header. If we want to use it with other devices, such as the PCF8591 ADC module, then something similar to a TriBorg from PiBorg (which splits the GPIO port into three) can be used.</p></div></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec140"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the following script, <code class="literal">lcd_i2c.py</code>:<div class="informalexample"><pre class="programlisting">#!/usr/bin/python3
#lcd_i2c.py
import wiringpi2
import time
import datetime
import data_local as dataDevice

AF_BASE=100
AF_E=AF_BASE+13;     AF_RW=AF_BASE+14;   AF_RS=AF_BASE+15
AF_DB4=AF_BASE+12;   AF_DB5=AF_BASE+11;  AF_DB6=AF_BASE+10
AF_DB7=AF_BASE+9

AF_SELECT=AF_BASE+0; AF_RIGHT=AF_BASE+1; AF_DOWN=AF_BASE+2
AF_UP=AF_BASE+3;     AF_LEFT=AF_BASE+4;  AF_BACK=AF_BASE+5

AF_GREEN=AF_BASE+6;  AF_BLUE=AF_BASE+7;  AF_RED=AF_BASE+8
BNK=" "*16 #16 spaces

def gpiosetup():
  global lcd
  wiringpi2.wiringPiSetup()
  wiringpi2.mcp23017Setup(AF_BASE,0x20)
  wiringpi2.pinMode(AF_RIGHT,0)
  wiringpi2.pinMode(AF_LEFT,0)
  wiringpi2.pinMode(AF_SELECT,0)
  wiringpi2.pinMode(AF_RW,1)
  wiringpi2.digitalWrite(AF_RW,0)
  lcd=wiringpi2.lcdInit(2,16,4,AF_RS,AF_E,
                        AF_DB4,AF_DB5,AF_DB6,AF_DB7,0,0,0,0)

def printLCD(line0="",line1=""):
  wiringpi2.lcdPosition(lcd,0,0)
  wiringpi2.lcdPrintf(lcd,line0+BNK)
  wiringpi2.lcdPosition(lcd,0,1)
  wiringpi2.lcdPrintf(lcd,line1+BNK)

def checkBtn(idx,size):
  global run
  if wiringpi2.digitalRead(AF_LEFT):
    idx-=1
    printLCD()
  elif wiringpi2.digitalRead(AF_RIGHT):
    idx+=1
    printLCD()
  if wiringpi2.digitalRead(AF_SELECT):
    printLCD("Exit Display")
    run=False
  return idx%size

def main():
  global run
  gpiosetup()
  myData = dataDevice.device()
  myDataNames = myData.getName()
  run=True
  index=0
  while(run):
    data = myData.getNew()
    printLCD(myDataNames[index],str(data[index]))
    time.sleep(0.2)
    index = checkBtn(index,len(myDataNames))

main()
#End</pre></div></li><li class="listitem">With the LCD module connected, run the script as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo python3 lcd_i2c.py</strong></span>
</pre></div></li></ol></div><p>Select the data channel you<a class="indexterm" id="id483"/> want to display using the<a class="indexterm" id="id484"/> left and right buttons and press the <span class="strong"><strong>SELECT</strong></span> button to exit.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec141"/>How it works...</h2></div></div></div><p>The <code class="literal">wiringPi2</code> library has excellent support for I/O expander chips, like the one used for the AdaFruit LCD Character module. To use the Adafruit module, we need to set up the pin mapping for all the pins of MCP23017 PortA, as shown in the following table (then we set up the I/O expander pins with an offset of <code class="literal">100</code>):</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Name</p>
</th><th style="text-align: left" valign="bottom">
<p>SELECT</p>
</th><th style="text-align: left" valign="bottom">
<p>RIGHT</p>
</th><th style="text-align: left" valign="bottom">
<p>DOWN</p>
</th><th style="text-align: left" valign="bottom">
<p>UP</p>
</th><th style="text-align: left" valign="bottom">
<p>LEFT</p>
</th><th style="text-align: left" valign="bottom">
<p>GREEN </p>
</th><th style="text-align: left" valign="bottom">
<p>BLUE</p>
</th><th style="text-align: left" valign="bottom">
<p>RED</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>MCP23017 PortA</p>
</td><td style="text-align: left" valign="top">
<p>A0</p>
</td><td style="text-align: left" valign="top">
<p>A1</p>
</td><td style="text-align: left" valign="top">
<p>A2</p>
</td><td style="text-align: left" valign="top">
<p>A3</p>
</td><td style="text-align: left" valign="top">
<p>A4</p>
</td><td style="text-align: left" valign="top">
<p>A6</p>
</td><td style="text-align: left" valign="top">
<p>A7</p>
</td><td style="text-align: left" valign="top">
<p>A8</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>WiringPiPin</p>
</td><td style="text-align: left" valign="top">
<p>100</p>
</td><td style="text-align: left" valign="top">
<p>101</p>
</td><td style="text-align: left" valign="top">
<p>102</p>
</td><td style="text-align: left" valign="top">
<p>103</p>
</td><td style="text-align: left" valign="top">
<p>104</p>
</td><td style="text-align: left" valign="top">
<p>106</p>
</td><td style="text-align: left" valign="top">
<p>107</p>
</td><td style="text-align: left" valign="top">
<p>108</p>
</td></tr></tbody></table></div><p>The pin mapping for all the pins of MCP23017 PortB are as follows:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Name</p>
</th><th style="text-align: left" valign="bottom">
<p>DB7</p>
</th><th style="text-align: left" valign="bottom">
<p>DB6</p>
</th><th style="text-align: left" valign="bottom">
<p>DB5</p>
</th><th style="text-align: left" valign="bottom">
<p>DB4</p>
</th><th style="text-align: left" valign="bottom">
<p>E</p>
</th><th style="text-align: left" valign="bottom">
<p>RW</p>
</th><th style="text-align: left" valign="bottom">
<p>RS</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>MCP23017 PortB</p>
</td><td style="text-align: left" valign="top">
<p>B1</p>
</td><td style="text-align: left" valign="top">
<p>B2</p>
</td><td style="text-align: left" valign="top">
<p>B3</p>
</td><td style="text-align: left" valign="top">
<p>B4</p>
</td><td style="text-align: left" valign="top">
<p>B5</p>
</td><td style="text-align: left" valign="top">
<p>B6</p>
</td><td style="text-align: left" valign="top">
<p>B7</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>WiringPiPin</p>
</td><td style="text-align: left" valign="top">
<p>109</p>
</td><td style="text-align: left" valign="top">
<p>110</p>
</td><td style="text-align: left" valign="top">
<p>111</p>
</td><td style="text-align: left" valign="top">
<p>112</p>
</td><td style="text-align: left" valign="top">
<p>113</p>
</td><td style="text-align: left" valign="top">
<p>114</p>
</td><td style="text-align: left" valign="top">
<p>115</p>
</td></tr></tbody></table></div><p>To set up the LCD screen, we initialize <code class="literal">wiringPiSetup()</code> and the I/O expander, <code class="literal">mcp23017Setup()</code>. We then specify the pin offset and bus address of the I/O expander. Next, we set all the hardware buttons as inputs (using <code class="literal">pinMode(pin number,0)</code>), and the RW pin of the LCD to an output. The <code class="literal">wiringPi2</code> LCD library expects the RW pin to be set to <code class="literal">LOW</code> (forcing it into read-only mode), so we set the pin to <code class="literal">LOW</code> (using <code class="literal">digitalWrite(AF_RW,0)</code>).</p><p>We create an <code class="literal">lcd</code> object by defining the number of rows and columns of the screen, and whether we are using 4- or 8-bit data mode (we are using 4 of the 8 data lines, so it is the 4-bit mode). We also provide the pin mapping of the pins we are using (the last four are set to <code class="literal">0</code> since we are only using four data lines).</p><p>Now we create a function called <code class="literal">PrintLCD()</code>, which will allow us to send strings to show on each line of the display. We use <code class="literal">lcdPosition()</code> to set the cursor position on the <code class="literal">lcd</code> object for each line and then print the text for each line. We also add some blank spaces at the end of each line to ensure the full line is overwritten.</p><p>The next<a class="indexterm" id="id485"/> function, <code class="literal">checkBtn()</code> briefly <a class="indexterm" id="id486"/>checks the left/right and select buttons to see if they have been pressed (using the <code class="literal">digitalRead()</code> function). If the left/right button has been pressed, then the index is set to the previous or next item in the array. If the <span class="strong"><strong>SELECT</strong></span> button is pressed, then the <code class="literal">run</code> flag is set to <code class="literal">False</code> (this will exit the main loop, allowing the script to finish).</p><p>The <code class="literal">main()</code> function calls <code class="literal">gpiosetup()</code> to create our <code class="literal">lcd</code> object; then we create our <code class="literal">dataDevice</code> object and fetch the data names. Within the main loop, we get new data; then we use our <code class="literal">printLCD()</code> function to display the data name on the top line and the data value on the second line. Finally, we check to see whether the buttons have been pressed and set the index to our data as required.</p></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec142"/>There's more…</h2></div></div></div><p>Using an expander chip such as the MCP23017 provides an excellent way to increase the amount of hardware connectivity to the Raspberry Pi while also providing an additional layer of protection (it is cheaper to replace the expander chip Raspberry Pi).</p><div class="section" title="I/O expander voltages and limits"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec50"/>I/O expander voltages and limits</h3></div></div></div><p>The port expander only <a class="indexterm" id="id487"/>uses a <a class="indexterm" id="id488"/>small amount of power when in use, but if you are powering it using the 3.3V supply, then you will still only be able to draw a maximum of 50 mA in total from all the pins. If you draw too much power, then you may experience system freezes or corrupted read/writes on the SD card.</p><p>If you power the expander using the 5V supply, then you can draw up to the maximum the expander can support (around 25 mA maximum per pin and 125 mA total) as long as your USB power supply is powerful enough.</p><p>We must remember that if the expander is powered with 5V, the inputs/outputs and interrupt lines will also be 5V and should never be connected back to the Raspberry Pi (without using level shifters to translate the voltage down to 3.3V).</p><p>By changing the wiring of the <a class="indexterm" id="id489"/>address pins (A0, A1, and A2) on the expander chip, up to eight modules can be used on the same I<sup>2</sup>C bus simultaneously. To ensure there is enough current available for each, we would need to use a separate 3.3V supply. A linear regulator such as LM1117-3.3 would be suitable (this would provide up to 800 mA at 3.3V, 100 mA for each), and <a class="indexterm" id="id490"/>only needs the following simple circuit:</p><div class="mediaobject"><img alt="I/O expander voltages and limits" src="graphics/6623OT_07_017.jpg"/><div class="caption"><p>The LM1117 linear voltage regulator circuit</p></div></div><p>The following diagram shows how a voltage regulator can be connected to the I/O expander (or other device) to provide more current for driving extra hardware:</p><div class="mediaobject"><img alt="I/O expander voltages and limits" src="graphics/6623OT_07_018.jpg"/><div class="caption"><p>Using a voltage regulator with the Raspberry Pi</p></div></div><p>The input voltage (Vin) is provided by the Raspberry Pi (for example, from the GPIO pin header, such as 5V pin 2). However, Vin could be provided by any other power supply (or battery pack) as long as it is between 4.5V and 15V and able to provide enough current. The important part is ensuring that<a class="indexterm" id="id491"/> the ground connections (GND) of the Raspberry Pi, the power supply (if a separate one is used), the regulator, and the I/O expander are all connected <a class="indexterm" id="id492"/>together (as a common ground).</p></div><div class="section" title="Using your own I/O expander module"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec51"/>Using your own I/O expander module</h3></div></div></div><p>You can use<a class="indexterm" id="id493"/> one of the I/O expander modules that are available (or just the MCP23017 chip in the following circuit) to control most HD44780-compatible LCD displays:</p><div class="mediaobject"><img alt="Using your own I/O expander module" src="graphics/6623OT_07_019.jpg"/><div class="caption"><p>The I/O expander and a HD44780-compatible display</p></div></div><p>The D-Pad circuit, which is explained in the recipe <span class="emphasis"><em>The GPIO keypad input</em></span> in <a class="link" href="ch06.html" title="Chapter 6. Using Python to Drive Hardware">Chapter 6</a>, <span class="emphasis"><em>Using Python to Drive Hardware</em></span>, can also be connected to the remaining Port A pins of the expander (<code class="literal">PA0</code> to Button 1, <code class="literal">PA1</code> to Right, <code class="literal">PA2</code> to Down, <code class="literal">PA3</code> to Up, <code class="literal">PA4</code> to Left, and <code class="literal">PA5</code> to Button 2). As in the previous example, the buttons will be <code class="literal">PA0</code> to <code class="literal">PA4</code> (WiringPiPin number 100 to 104); apart from these, we have the second button added to <code class="literal">PA5</code> (WiringPiPin number 105).</p></div><div class="section" title="Directly controlling an LCD alphanumeric display"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec52"/>Directly controlling an LCD alphanumeric display</h3></div></div></div><p>Alternatively, you<a class="indexterm" id="id494"/> can also drive the screen directly from the Raspberry Pi with the following connections:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>
<span class="strong"><strong>LCD</strong></span>
</p>
</th><th style="text-align: left" valign="bottom">
<p>VSS</p>
</th><th style="text-align: left" valign="bottom">
<p>VDD</p>
</th><th style="text-align: left" valign="bottom">
<p>V0</p>
</th><th style="text-align: left" valign="bottom">
<p>RS</p>
</th><th style="text-align: left" valign="bottom">
<p>RW</p>
</th><th style="text-align: left" valign="bottom">
<p>E</p>
</th><th style="text-align: left" valign="bottom">
<p>DB4</p>
</th><th style="text-align: left" valign="bottom">
<p>DB5</p>
</th><th style="text-align: left" valign="bottom">
<p>DB6</p>
</th><th style="text-align: left" valign="bottom">
<p>DB7</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>LCD Pin</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>1</p>
</td><td style="text-align: left" valign="top">
<p>2</p>
</td><td style="text-align: left" valign="top">
<p>3</p>
</td><td style="text-align: left" valign="top">
<p>4</p>
</td><td style="text-align: left" valign="top">
<p>5</p>
</td><td style="text-align: left" valign="top">
<p>6</p>
</td><td style="text-align: left" valign="top">
<p>11</p>
</td><td style="text-align: left" valign="top">
<p>12</p>
</td><td style="text-align: left" valign="top">
<p>13</p>
</td><td style="text-align: left" valign="top">
<p>14</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Raspberry Pi GPIO</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>6 (GND)</p>
</td><td style="text-align: left" valign="top">
<p>2 (5V)</p>
</td><td style="text-align: left" valign="top">
<p>Contrast </p>
</td><td style="text-align: left" valign="top">
<p>11</p>
</td><td style="text-align: left" valign="top">
<p>13 (GND)</p>
</td><td style="text-align: left" valign="top">
<p>15</p>
</td><td style="text-align: left" valign="top">
<p>12</p>
</td><td style="text-align: left" valign="top">
<p>16</p>
</td><td style="text-align: left" valign="top">
<p>18</p>
</td><td style="text-align: left" valign="top">
<p>22</p>
</td></tr></tbody></table></div><p>The preceding table lists the connections required between the Raspberry Pi and the HD44780-compatible alphanumeric display module.</p><p>The contrast pin (V0) can be connected to a variable resistor as before (with one side on 5V and the other on GND); although, depending on the screen, you may find you can connect directly to GND/5V to obtain the maximum contrast.</p><p>The wiringPi2 LCD library assumes that the RW pin is connected to GND (read only); this avoids the risk that the LCD will send data back if connected directly to the Raspberry Pi (this would be a problem since the screen is powered by 5V and would send data using 5V logic).</p><p>Ensure you update the code with the new <code class="literal">AF_XX</code> references and refer to the physical pin number by changing the setup within the <code class="literal">gpiosetup()</code> function. We can also skip the  setup of the MCP23017 device.</p><p>Have a look at the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>wiringpi2.wiringPiSetup()</strong></span>
<span class="strong"><strong>wiringpi2.mcp23017Setup(AF_BASE,0x20)</strong></span>
</pre></div><p>Replace the preceding commands with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>wiringpi.wiringPiSetupPhys()</strong></span>
</pre></div><p>You can see that we only need to change the pin references to switch between using the I/O expander and not using it, which shows how convenient the wiringPi2 implementation is.</p></div></div></div>
<div class="section" title="Capturing data in an SQLite database"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec55"/>Capturing data in an SQLite database</h1></div></div></div><p>Databases<a class="indexterm" id="id495"/> are a<a class="indexterm" id="id496"/> perfect way to store lots of structured data while maintaining the ability to access and search for specific data. <span class="strong"><strong>Structured Query Language</strong></span> (<span class="strong"><strong>SQL</strong></span>)<a class="indexterm" id="id497"/> is a standardized set of commands to update and query databases. For this example, we will use SQLite (a lightweight self-contained implementation of an SQL database system).</p><p>In this chapter, we will gather raw data from our ADC (or local data source) and build our own database. We can then use a Python library called <code class="literal">sqlite3</code> to add data to a database and then query it.</p><div class="informalexample"><pre class="programlisting">   ##            Timestamp  0:Light  1:Temperature   2:External  3:Potentiometer
    0 2015-06-16 21:30:51      225            212          122              216
    1  2015-06-16 21:30:52      225            212          148              216
    2  2015-06-16 21:30:53      225            212          113              216
    3  2015-06-16 21:30:54      225            212          137              216
    4  2015-06-16 21:30:55      225            212          142              216
    5  2015-06-16 21:30:56      225            212          115              216
    6  2015-06-16 21:30:57      225            212          149              216
    7  2015-06-16 21:30:58      225            212          128              216
    8  2015-06-16 21:30:59      225            212          123              216
    9  2015-06-16 21:31:02      225            212          147              216 </pre></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec143"/>Getting ready</h2></div></div></div><p>To capture data<a class="indexterm" id="id498"/> in our database, we will install SQLite ready to use<a class="indexterm" id="id499"/> with Python's <code class="literal">sqlite3</code> built-in module. Use the following command to install SQLite:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get install sqlite3</strong></span>
</pre></div><p>Next, we will perform some basic operations with SQLite to see how to use SQL queries.</p><p>Run SQLite directly, creating a new <code class="literal">test.db</code> database file with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sqlite3 test.db</strong></span>
<span class="strong"><strong>SQLite version 3.7.13 2012-06-11 02:05:22</strong></span>
<span class="strong"><strong>Enter ".help" for instructions</strong></span>
<span class="strong"><strong>Enter SQL statements terminated with a ";"</strong></span>
<span class="strong"><strong>sqlite&gt;</strong></span>
</pre></div><p>This will open a SQLite console within which we enter SQL commands directly. For example, the following commands will create a new table, add some data, display the content, and then remove the table:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>CREATE TABLE mytable (info TEXT, info2 TEXT,);</strong></span>
<span class="strong"><strong>INSERT INTO mytable VALUES ("John","Smith");</strong></span>
<span class="strong"><strong>INSERT INTO mytable VALUES ("Mary","Jane");</strong></span>
<span class="strong"><strong>John|Smith</strong></span>
<span class="strong"><strong>Mary|Jane</strong></span>
<span class="strong"><strong>DROP TABLE mytable;</strong></span>
<span class="strong"><strong>.exit</strong></span>
</pre></div><p>You will need the same <a class="indexterm" id="id500"/>hardware setup as the previous recipe, as<a class="indexterm" id="id501"/> detailed in the <span class="emphasis"><em>Getting ready</em></span> section of the <span class="emphasis"><em>Using devices with the I<sup>2</sup>C bus</em></span> recipe.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec144"/>How to do it...</h2></div></div></div><p>Create the following script, <code class="literal">mysqlite_adc.py</code>:</p><div class="informalexample"><pre class="programlisting">#!/usr/bin/python3
#mysql_adc.py
import sqlite3
import datetime
import data_adc as dataDevice
import time
import os


DEBUG=True
SHOWSQL=True
CLEARDATA=False
VAL0=0;VAL1=1;VAL2=2;VAL3=3 #Set data order
FORMATBODY="%5s %8s %14s %12s %16s"
FORMATLIST="%5s %12s %10s %16s %7s"
DATEBASE_DIR="/var/databases/datasite/"
DATEBASE=DATEBASE_DIR+"mydatabase.db"
TABLE="recordeddata"
DELAY=1 #approximate seconds between samples

def captureSamples(cursor):
    if(CLEARDATA):cursor.execute("DELETE FROM %s" %(TABLE))
    myData = dataDevice.device()
    myDataNames=myData.getName()

    if(DEBUG):print(FORMATBODY%("##",myDataNames[VAL0],
                                myDataNames[VAL1],myDataNames[VAL2],
                                myDataNames[VAL3]))
    for x in range(10):
        data=myData.getNew()
        for i,dataName in enumerate(myDataNames):
            sqlquery = "INSERT INTO %s (itm_name, itm_value) " %(TABLE) + \
                       "VALUES('%s', %s)" \
                        %(str(dataName),str(data[i]))
            if (SHOWSQL):print(sqlquery)
            cursor.execute(sqlquery)

        if(DEBUG):print(FORMATBODY%(x,
                                    data[VAL0],data[VAL1],
                                    data[VAL2],data[VAL3]))
        time.sleep(DELAY)
    cursor.commit()

def displayAll(connect):
    sqlquery="SELECT * FROM %s" %(TABLE)
    if (SHOWSQL):print(sqlquery)
    cursor = connect.execute (sqlquery)
    print(FORMATLIST%("","Date","Time","Name","Value"))

    for x,column in enumerate(cursor.fetchall()):
       print(FORMATLIST%(x,str(column[0]),str(column[1]),
                         str(column[2]),str(column[3])))

def createTable(cursor):
    print("Create a new table: %s" %(TABLE))
    sqlquery="CREATE TABLE %s (" %(TABLE) + \
             "itm_date DEFAULT (date('now','localtime')), " + \
             "itm_time DEFAULT (time('now','localtime')), " + \
             "itm_name, itm_value)" 
    if (SHOWSQL):print(sqlquery)
    cursor.execute(sqlquery)
    cursor.commit()

def openTable(cursor):
    try:
        displayAll(cursor)
    except sqlite3.OperationalError:
        print("Table does not exist in database")
        createTable(cursor)
    finally:
        captureSamples(cursor)
        displayAll(cursor)

try:
    if not os.path.exists(DATEBASE_DIR):
        os.makedirs(DATEBASE_DIR)
    connection = sqlite3.connect(DATEBASE)
    try:
        openTable(connection)
    finally:
        connection.close()
except sqlite3.OperationalError:
    print("Unable to open Database")
finally:
    print("Done")

#End</pre></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note70"/>Note</h3><p>If you do not have the ADC module hardware, you can capture local data by setting the <code class="literal">dataDevice</code> module as <code class="literal">data_local</code>. Ensure you have <code class="literal">data_local.py</code> (from the <span class="emphasis"><em>There's more…</em></span> section in the <span class="emphasis"><em>Reading analog data using an analog-to-digital converter</em></span> recipe) in the same directory as this script:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>import data_local as dataDevice</strong></span>
</pre></div><p>This will capture the local data (RAM, CPU activity, temperature, and so on) to the SQLite database instead of ADC samples.</p></div></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec145"/>How it works...</h2></div></div></div><p>When the script is first run, it will<a class="indexterm" id="id502"/> create a new SQLite database file<a class="indexterm" id="id503"/> called <code class="literal">mydatabase.db</code>, which will add a table named <code class="literal">recordeddata</code>. The table is generated by <code class="literal">createTable()</code>, which runs the following SQLite command:</p><div class="informalexample"><pre class="programlisting">CREATE TABLE recordeddata
(
    itm_date DEFAULT (date('now','localtime')),
    itm_time DEFAULT (time('now','localtime')),
    itm_name,
    itm_value
)</pre></div><p>The new table will contain the following data items:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Name</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">itm_date</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Used to store the date of the data sample. When the data record is created the current date (using <code class="literal">date('now','localtime')</code>) is applied as the DEFAULT value.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">itm_time</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Used to store the time of the data sample. When the data record is created the current time (using <code class="literal">time('now','localtime')</code>) is applied as the DEFAULT value.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">itm_name</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Used to record the name of the sample.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">itm_value</code>
</p>
</td><td style="text-align: left" valign="top">
<p>Used to keep the sampled value.</p>
</td></tr></tbody></table></div><p>We then use the same the method to capture ten data samples from the ADC as we did in the <span class="emphasis"><em>Logging and plotting</em></span> <span class="emphasis"><em>data </em></span>recipe previously (as shown in the function <code class="literal">captureSamples()</code>). However, this time we will then add the captured data into our new SQLite database table, using the following SQL command (applied using <code class="literal">cursor.execute(sqlquery)</code>):</p><div class="informalexample"><pre class="programlisting">INSERT INTO recordeddata
    (itm_name, itm_value) VALUES ('0:Light', 210)</pre></div><p>The current date and <a class="indexterm" id="id504"/>time will be added by default to each record as it is<a class="indexterm" id="id505"/> created. We end up with a set of 40 records (four records for every cycle of ADC samples captured), which are now stored in the SQLite database.</p><div class="mediaobject"><img alt="How it works..." src="graphics/6623OT_07_020.jpg"/><div class="caption"><p>Eight ADC samples have been captured and stored in the SQLite database</p></div></div><p>After the records have been created we must remember to call <code class="literal">cursor.commit()</code>, which will save all the new records to the database.</p><p>The last part of the script calls <code class="literal">displayAll()</code>, which will use the following SQL command:</p><div class="informalexample"><pre class="programlisting"> SELECT * FROM recordeddata</pre></div><p>This will select all of the data records in the <code class="literal">recordeddata</code> table, and we use <code class="literal">cursor.fetch()</code> to provide the selected data as a list we can iterate through:</p><div class="informalexample"><pre class="programlisting">    for x,column in enumerate(cursor.fetchall()):
       print(FORMATLIST%(x,str(column[0]),str(column[1]),
                         str(column[2]),str(column[3])))</pre></div><p>This allows us to print out the full contents of the database, displaying the captured data.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note72"/>Note</h3><p>Notice that here we use the <code class="literal">try</code>, <code class="literal">except</code>, and <code class="literal">finally</code> constructs in this script to attempt to handle the mostly likely scenario users will face when running the script.</p><p>First we ensure that if the database directory doesn't exist, we create it. Next we try opening the database file; this process will automatically create a new database file if one doesn't already exist. If either of these initial steps fail (due to not having read/write permissions, for example) we cannot continue so we report that we cannot open the database and simply exit the script.</p><p>Next, we try to open the required table within the database and display it; if the database file is brand new this operation will always fail as it will be empty. However, if this occurs we just catch the exception and create the table before continuing with the script to add our sampled data to the table and display it.</p><p>This allows the script to gracefully handle potential problems, take corrective action and then continue smoothly. The next time the script is run, the database and table will already exist, so we won't need to create them a second time and we can append the sample data to the table within the same database file.</p></div></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec146"/>There's more…</h2></div></div></div><p>There are many variants of SQL servers available (such as MySQL, Microsoft SQL Server, or PostgreSQL); however, they should at least have the following primary commands (or equivalent):</p><div class="informalexample"><pre class="programlisting">CREATE, INSERT, SELECT, WHERE, UPDATE, SET, DELETE, and DROP</pre></div><p>You should find that even if you choose to use a different SQL server to the SQLite one used here, the SQL commands will be relatively similar.</p><div class="section" title="CREATE"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec53"/>CREATE</h3></div></div></div><p>The <code class="literal">CREATE TABLE</code> command<a class="indexterm" id="id506"/> is used to define a new table by specifying the <a class="indexterm" id="id507"/>column names (and also to set DEFAULT values if desired):</p><div class="informalexample"><pre class="programlisting">CREATE TABLE table_name (
    column_name1 TEXT, 
    column_name2 INTEGER DEFAULT 0,
    column_name3 REAL )</pre></div><p>The previous SQL command will create a new table called <code class="literal">table_name</code>, containing three data items. One column would contain<a class="indexterm" id="id508"/> text, another integers (for example, 1, 3, -9) and finally one column for real<a class="indexterm" id="id509"/> numbers (for example, 5.6, 3.1749, 1.0).</p></div><div class="section" title="INSERT"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec54"/>INSERT</h3></div></div></div><p>The <code class="literal">INSERT</code> command<a class="indexterm" id="id510"/> will add a <a class="indexterm" id="id511"/>particular entry to a table in the database:</p><div class="informalexample"><pre class="programlisting">INSERT INTO table_name (column_name1name1, column_name2name2, column_name3)name3)
    VALUES ('Terry'Terry Pratchett', 6666, 27.082015)082015)</pre></div><p>This will enter the values provided into the corresponding columns in the table.</p></div><div class="section" title="SELECT"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec55"/>SELECT</h3></div></div></div><p>The <code class="literal">SELECT</code> command<a class="indexterm" id="id512"/> allows us to specify a particular column or columns from the <a class="indexterm" id="id513"/>database table, returning a list of records with the data:</p><div class="informalexample"><pre class="programlisting">SELECT column_name1, column_name2 FROM table_name</pre></div><p>Or to select all items, use this command:</p><div class="informalexample"><pre class="programlisting">SELECT * FROM table_name</pre></div></div><div class="section" title="WHERE"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec56"/>WHERE</h3></div></div></div><p>The <code class="literal">WHERE</code> command<a class="indexterm" id="id514"/> is used to <a class="indexterm" id="id515"/>specify specific entries to be selected, updated, or deleted:</p><div class="informalexample"><pre class="programlisting">SELECT * FROM table_name
    WHERE column_name1= 'Terry Pratchett'</pre></div><p>This will <code class="literal">SELECT</code> any records where the <code class="literal">column_name1</code> matches <code class="literal">'Terry Pratchett'</code>.</p></div><div class="section" title="UPDATE"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec57"/>UPDATE</h3></div></div></div><p>The UPDATE command<a class="indexterm" id="id516"/> will allow us to change (<code class="literal">SET</code>) the values of data in each of the specified<a class="indexterm" id="id517"/> columns. We can also combine this with the <code class="literal">WHERE</code> command to limit the records the change is applied to:</p><div class="informalexample"><pre class="programlisting">UPDATE table_name
    SET column_name2=49name2=49,column_name3=30name3=30.111997
    WHERE column_name1name1= 'Douglas Adams'Adams';</pre></div></div><div class="section" title="DELETE"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec58"/>DELETE</h3></div></div></div><p>The <code class="literal">DELETE</code> command<a class="indexterm" id="id518"/> allows any records selected using <code class="literal">WHERE</code> to be removed from the <a class="indexterm" id="id519"/>specified table. However, if the whole table is selected, using <code class="literal">DELETE * FROM table_name</code> will delete the entire contents of the table:</p><div class="informalexample"><pre class="programlisting">DELETE FROM table_name
    WHERE columncolumn_name2=9999</pre></div></div><div class="section" title="DROP"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec59"/>DROP</h3></div></div></div><p>The <code class="literal">DROP</code> command<a class="indexterm" id="id520"/> allows a<a class="indexterm" id="id521"/> table to be removed completely from the database:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>DROP table_name</strong></span>
</pre></div><p>Be warned that this will permanently remove all the data that was stored in the specified table and the structure.</p></div></div></div>
<div class="section" title="Viewing data from your own webserver"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec56"/>Viewing data from your own webserver</h1></div></div></div><p>Gathering and collecting<a class="indexterm" id="id522"/> information into databases is very helpful, but<a class="indexterm" id="id523"/> if it is locked inside a database or a file it isn't much use. However, if we allow the stored data to be viewed via a web page it will be far more accessible; not only can we view the data from other devices, we can also share it with others on the same network.</p><p>We shall create a local web server to query and display the captured SQLite data and allow it to be viewed through a PHP web interface. This will allow the data to be viewed, not only via the web browser on the Raspberry, Pi but also on other devices, such as cell phones or tablets, on the local network:</p><div class="mediaobject"><img alt="Viewing data from your own webserver" src="graphics/6623OT_07_021.jpg"/><div class="caption"><p>Data captured in the SQLite database displayed via a web-page</p></div></div><p>Using a web server to <a class="indexterm" id="id524"/>enter and display information is a powerful <a class="indexterm" id="id525"/>way to allow a wide range of users to interact with your projects. The following example demonstrates a web server setup that can be customized for a variety of uses.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec147"/>Getting ready</h2></div></div></div><p>Ensure you have completed the previous recipe so that the sensor data has been collected and stored in the SQLite database. We need to install a web server (<span class="strong"><strong>Apache2</strong></span>) and enable PHP support to allow SQLite access.</p><p>Use these commands to install a web server and PHP:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo apt-get update</strong></span>
<span class="strong"><strong>sudo aptitude install apache2 php5 php5-sqlite</strong></span>
</pre></div><p>The <code class="literal">/var/www/</code> directory is used by the web server; by default it will load <code class="literal">index.html</code> (or <code class="literal">index.php</code>), otherwise it will just display a list of the links to the files within the directory.</p><p>To test the web server is running, create a default <code class="literal">index.html</code> page. To do this you will need to create the file using <code class="literal">sudo</code> permissions (the <code class="literal">/var/www/</code> directory is protected from changes made by normal users). Use the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo nano /var/www/index.html</strong></span>
</pre></div><p>Create <code class="literal">index.html</code> with the following content:</p><div class="informalexample"><pre class="programlisting">&lt;h1&gt;It works!&lt;/h1&gt;</pre></div><p>Close and save the file (using <span class="emphasis"><em>Ctrl + X</em></span>, <span class="emphasis"><em>Y</em></span> and <span class="emphasis"><em>Enter</em></span>).</p><p>If you are using the Raspberry Pi with a screen, you can check it is working by loading the desktop:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>startx</strong></span>
</pre></div><p>Then, open the web <a class="indexterm" id="id526"/>browser (<span class="strong"><strong>epiphany-browser</strong></span>) and enter <code class="literal">http://localhost</code> as the <a class="indexterm" id="id527"/>address. You should see the following test page, indicating<a class="indexterm" id="id528"/> the web server is active:</p><div class="mediaobject"><img alt="Getting ready" src="graphics/6623OT_07_022.jpg"/><div class="caption"><p>Raspberry Pi browser displaying the test page, located at http://localhost</p></div></div><p>If you are using the Raspberry Pi remotely or it is connected to your network, you should also be able to view the page on another computer on your network. First, identify the IP address of the Raspberry Pi (using <code class="literal">sudo hostname -I</code>) and then use this as the address in your web browser. You may even find you can use the actual hostname of the Raspberry Pi (by default this is <a class="ulink" href="http://raspberrypi/">http://raspberrypi/</a>).</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note73"/>Note</h3><p>If you are unable to see the web page from another computer, ensure that you do not have a firewall enabled (on the computer itself or on your router) that could be blocking it.</p></div></div><p>Next, we can test that PHP is operating correctly. We can create the following web page, <code class="literal">test.php</code>, and ensure it is located in the <code class="literal">/var/www/ directory</code>:</p><div class="informalexample"><pre class="programlisting">&lt;?php
phpinfo();
?&gt;;</pre></div><div class="mediaobject"><img alt="Getting ready" src="graphics/6623OT_07_023.jpg"/><div class="caption"><p>View the test.php page at the following location: http://localhost/test.php</p></div></div><p>We are ready to write our own PHP web page to view the data in the SQLite database.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec148"/>How to do it...</h2></div></div></div><p>Create the following <a class="indexterm" id="id529"/>PHP files and save them in the webserver <a class="indexterm" id="id530"/>directory, <code class="literal">/var/www/./</code>.</p><p>Use the following command to create the PHP file:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo nano /var/www/show_data_lite.php</strong></span>
</pre></div><p>The <code class="literal">show_data_lite.php</code> file should contain:</p><div class="informalexample"><pre class="programlisting">&lt;head&gt;
&lt;title&gt;DatabaseDatabase Data&lt;/title&gt;
&lt;meta http-equiv="refresh" content="10" &gt;
&lt;/head&gt;
&lt;body&gt;

Press button to remove the table data
&lt;br&gt;
&lt;input type="button" onclick="location.href = 'del_data_lite.php';" value="Delete"&gt;
&lt;br&gt;&lt;br&gt;
&lt;b&gt;Recorded Data&lt;/b&gt;&lt;br&gt;
&lt;?php
$db = new PDO("sqlite:/var/databases/datasitedatasite/mydatabase.db");
//SQL query
$strSQL = "SELECT * FROM recordeddatarecordeddata WHERE itmitm_name LIKE '%'%temp%'";
//Excute the query
$response = $db-&gt;query($strSQL);
//Loop through the response
while($column = $response-&gt;fetch())
{
   //Display the content of the response
   echo $column[0] . " ";
   echo $column[1] . " ";
   echo $column[2] . " ";
   echo $column[3] . "&lt;br /&gt;";
}
?&gt;
Done
&lt;/body&gt;
&lt;/html&gt;</pre></div><p>Use the following<a class="indexterm" id="id531"/> command to<a class="indexterm" id="id532"/> create the PHP file:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo nano /var/www/del_data_lite.php</strong></span>
<span class="strong"><strong>&lt;html&gt;</strong></span>
<span class="strong"><strong>&lt;body&gt;</strong></span>

<span class="strong"><strong>Remove all the data in the table.</strong></span>
<span class="strong"><strong>&lt;br&gt;</strong></span>
<span class="strong"><strong>&lt;?php</strong></span>
<span class="strong"><strong>$db = new PDO("sqlite:/var/databases/datasitedatasite/mydatabase.db");</strong></span>
<span class="strong"><strong>//SQL query</strong></span>
<span class="strong"><strong>$strSQL = "DROPDROP TABLErecordeddata recordeddata";</strong></span>
<span class="strong"><strong>//ExecuteExecute the query</strong></span>
<span class="strong"><strong>$response = $db-&gt;query($strSQL);</strong></span>

<span class="strong"><strong>if ($response == 1)</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>  echo "Result: DELETED DATA";</strong></span>
<span class="strong"><strong>}</strong></span>
<span class="strong"><strong>else</strong></span>
<span class="strong"><strong>{</strong></span>
<span class="strong"><strong>  echo "Error: Ensure table exists and database directory is owned by www-data";</strong></span>
<span class="strong"><strong>}</strong></span>
<span class="strong"><strong>?&gt;</strong></span>
<span class="strong"><strong>&lt;br&gt;&lt;br&gt;</strong></span>
<span class="strong"><strong>Press button to return to data display.</strong></span>
<span class="strong"><strong>&lt;br&gt;</strong></span>
<span class="strong"><strong>&lt;input type="button" onclick="location.href = 'show'show_data_lite.php';" value="Return"&gt;</strong></span>

<span class="strong"><strong>&lt;/body&gt;</strong></span>
<span class="strong"><strong>&lt;/html&gt;</strong></span>
</pre></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note74"/>Note</h3><p>Note: In order for the PHP code to delete the table within the database, it needs to be writable by the web server. Use the following command to allow it to be writable:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo chown www-data /var/databases/datasite -R</strong></span>
</pre></div></div></div><p>
<code class="literal">show_data_lite.php</code> will appear as a web page if you open it in a web browser by using the following address:</p><div class="informalexample"><pre class="programlisting">http://localhost/showshow_data_lite.php</pre></div><p>Alternatively, you <a class="indexterm" id="id533"/>can open the web page (including on another <a class="indexterm" id="id534"/>computer within your network) by referencing the IP address of the Raspberry Pi (use <code class="literal">hostname -I</code> to confirm the IP address):</p><div class="informalexample"><pre class="programlisting">http://192.168.1.101/showshow_data_lite.php</pre></div><p>You may be able to use the hostname instead (by default, this would make the address <a class="ulink" href="http://raspberrypi/show_data_lite.php">http://raspberrypi/show_data_lite.php</a>). However, this may depend upon your network setup.</p><p>If there is no data present, ensure you run the <code class="literal">mysqlite_adc.py</code> script to capture additional data.</p><p>To make the <code class="literal">show_data_lite.php</code> page display automatically when you visit the web address of your Raspberry Pi (instead of the "<code class="literal">It works!</code>" page), we can change the <code class="literal">index.html</code> to the following:</p><div class="informalexample"><pre class="programlisting">&lt;meta http-equiv="refresh" content="0; URL='show_data_lite.php' " /&gt;</pre></div><p>This will automatically redirect the browser to load our <code class="literal">show_data_lite.php</code> page.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec149"/>How it works...</h2></div></div></div><p>The <code class="literal">show_data_lite.php</code> file shall display the temperature data that has been stored within the SQLite database (either from the ADC samples or local data sources).</p><p>The <code class="literal">show_data_lite.php</code> file consists of standard HTML code as well as a special PHP code section. The HTML code sets <code class="literal">ACD Data</code> as the title on the head section of the page and uses the following command to make the page automatically reload every 10 seconds:</p><div class="informalexample"><pre class="programlisting">&lt;meta http-equiv="refresh" content="10" &gt;</pre></div><p>Next, we define a <code class="literal">Delete</code> button, which will load the <code class="literal">del_data_lite.php</code> page when clicked:</p><div class="informalexample"><pre class="programlisting">&lt;input type="button" onclick="location.href = 'del_data_lite.php';" value="Delete"&gt;</pre></div><p>Finally, we use the PHP code section to load the SQLite database and display the Channel 0 data.</p><p>We use the following PHP command to open the SQLite database we have previously stored data in (located at <code class="literal">/var/databases/testsites/mydatabase.db</code>):</p><div class="informalexample"><pre class="programlisting">$db = new PDO("sqlite:/var/databases/testsite/mydatabase.db");</pre></div><p>Next, we use the<a class="indexterm" id="id535"/> following SQLite query to select all the entries where the<a class="indexterm" id="id536"/> zone includes <code class="literal">0:</code> in the text (for example, <code class="literal">0:Light</code>):</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>SELECT * FROM recordeddatarecordeddata WHERE itm_namename LIKE '%temp%''</strong></span>
</pre></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note75"/>Note</h3><p>Notice that even though we are now using PHP, the queries we use with the SQLite database are the same as we would use when using the SQLite3 Python module.</p></div></div><p>We now collect the query result in the <code class="literal">$response</code> variable:</p><div class="informalexample"><pre class="programlisting">$response = $db-&gt;query($strSQL);
Allowing us to use fetch() (like we used cursor.fetchall() previously) to list all the data columns in each of the data entries within the response.
while($column = $response-&gt;fetch())
{
   //Display the content of the response
   echo $column[0] . " ";
   echo $column[1] . " ";
   echo $column[2] . " ";
   echo $column[3] . "&lt;br /&gt;";
}
?&gt;</pre></div><p>The <code class="literal">del_data_lite.php</code> file is fairly similar; it starts by reopening the <code class="literal">mydatabase.db</code> file as before. It then executes the following SQLite query:</p><div class="informalexample"><pre class="programlisting">DROP TABLE recordeddata</pre></div><p>As described in the <span class="emphasis"><em>There's more… DROP</em></span> section, this will remove the table <code class="literal">recordeddata</code> from the <a class="indexterm" id="id537"/>database. If the <code class="literal">response</code> isn't equal to 1, the<a class="indexterm" id="id538"/> action was not completed. The most likely reason for this is that the directory that contains the <code class="literal">mydatabase.db</code> file isn't writable by the web server (see the note in the <span class="emphasis"><em>How to do it</em></span> section about changing the file owner to <code class="literal">www-data</code>).</p><p>Finally, we provide another button that will take the user back to the <code class="literal">show_data_lite.php</code> page (which will show that the recorded data has now been cleared).</p><div class="mediaobject"><img alt="How it works..." src="graphics/6623OT_07_024.jpg"/><div class="caption"><p>The del_data_lite.php page includes a button to return to the data display page (show_data_lite.php)</p></div></div></div><div class="section" title="There's more…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec150"/>There's more…</h2></div></div></div><p>You may have noticed that this recipe has focused more on HTML and PHP than Python (yes, check the cover, this is still a book for Python programmers!). However, it is important to remember that a key part of engineering is integrating and combining different technologies to produce desired results.</p><p>By design, Python lends itself well to this kind of task since it allows easy customization and integration with a huge range of other languages and modules. We could just do it all in Python… but why not make use of the existing solutions instead? After all, they are usually well documented, have undergone extensive testing, and are often industry standards.</p><div class="section" title="Security"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec60"/>Security</h3></div></div></div><p>SQL databases<a class="indexterm" id="id539"/> are used in many places to store a wide range of information from product information to customer details. In such circumstances, users may be required to enter information which is then formed into SQL queries. In a poorly implemented system, a malicious user may be able to include additional SQL syntax in their response, allowing them to compromise the SQL database (such as access sensitive information, alter it, or simply delete it).</p><p>For example, when asking for a username within a web page, the user could enter the following text:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>John; DELETE FROM Orders</strong></span>
</pre></div><p>If this was used directly to construct the SQL query, we would end up with the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>SELECT * FROM Users WHERE UserName = John; DELETE FROM CurrentOrders</strong></span>
</pre></div><p>The result is we have just allowed the attacker to delete everything in the <code class="literal">CurrentOrders</code> table!</p><p>Using user input to form part of SQL queries means we have to be careful what commands we allow to be executed. In this example, the user may be able to wipe out potentially important information, which could be very costly for a company and its reputation.</p><p>This technique is called SQL injection and is easily protected against by using the parameters option of the SQLite <code class="literal">execute()</code> function. We can replace our Python SQLite query with a safer version, as follows:</p><div class="informalexample"><pre class="programlisting">sqlquery = "INSERT INTO %s (itm_name, itm_value) VALUES(?, ?)" %(TABLE)
cursor.execute(sqlquery, (str(dataName), str(data[i]))</pre></div><p>Instead of blindly building the SQL query, the SQLite module will first check that the provided parameters are valid values to enter into the database, then it will ensure that no additional SQL actions will result from inserting them into the command. Finally, the value of the <code class="literal">dataName</code> and <code class="literal">data[i]</code> parameters will be used to replace the <code class="literal">?</code> characters to generate the final safe SQLite query.</p></div><div class="section" title="Using MySQL instead"><div class="titlepage"><div><div><h3 class="title"><a id="ch07lvl3sec61"/>Using MySQL instead</h3></div></div></div><p>SQLite, used in this <a class="indexterm" id="id540"/>recipe, is just one of many SQL databases available. It is helpful for small projects that only require relatively small databases and minimal resources. However, for larger projects that require additional features (such user accounts to control access and additional security), you can use alternatives such as MySQL.</p><p>To use a different SQL database, you will need to adjust the Python code we used to capture the entries using a suitable Python module.</p><p>For MySQL (<code class="literal">mysql-server</code>) we can use a Python 3 compatible library called <span class="strong"><strong>PyMySQL</strong></span>
<a class="indexterm" id="id541"/> to interface with it. See the PyMySQL website (<a class="ulink" href="https://github.com/PyMySQL/PyMySQL">https://github.com/PyMySQL/PyMySQL</a>) for additional information about how to use this library.</p><p>To use PHP with <a class="indexterm" id="id542"/>MySQL, you will also need PHP MySQL (<code class="literal">php5-mysql</code>); for more information, see the excellent<a class="indexterm" id="id543"/> resource on W3 Schools (<a class="ulink" href="http://www.w3schools.com/php/php_mysql_connect.asp">http://www.w3schools.com/php/php_mysql_connect.asp</a>).</p><p>You will notice that although there are small differences between SQL implementations, the general concepts and commands should now be familiar to you whichever one you select.</p></div></div></div>
<div class="section" title="Sensing and sending data to online services"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec57"/>Sensing and sending data to online services</h1></div></div></div><p>In this section, we shall make <a class="indexterm" id="id544"/>use of an online service called Xively; the service<a class="indexterm" id="id545"/> allows us to <a class="indexterm" id="id546"/>connect, transmit, and view data online. Xively <a class="indexterm" id="id547"/>makes use of a common protocol that is used for transferring information over HTTP called REpresentational State Transfer (REST). REST is used by many services, such as Facebook and Twitter, using various keys and access tokens to ensure data is transferred securely between authorized applications and verified sites.</p><p>You can perform most REST operations (methods such as <code class="literal">POST</code>, <code class="literal">GET</code>, <code class="literal">SET</code>, and so on) manually using a Python library<a class="indexterm" id="id548"/> called <code class="literal">requests</code> (<a class="ulink" href="http://docs.python-requests.org">http://docs.python-requests.org</a>).</p><p>However, it is often easier to make use of specific libraries available for the service you intend to use. They will handle the authorization process; provide access functions; and, if the service changes, the library can be updated rather than your code.</p><p>We will use the <code class="literal">xively-python</code> library, which provides Python functions to allow us to easily interact with the site.</p><p>For details about<a class="indexterm" id="id549"/> the <code class="literal">xively-python</code> library, refer to <a class="ulink" href="http://xively.github.io/xively-python/">http://xively.github.io/xively-python/</a>.</p><p>The data collected by Xively is shown in the following screenshot:</p><div class="mediaobject"><img alt="Sensing and sending data to online services" src="graphics/6623OT_07_025.jpg"/><div class="caption"><p>Xively collects and graphs data transferred using REST</p></div></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec151"/>Getting ready</h2></div></div></div><p>You will need to create an <a class="indexterm" id="id550"/>account on <a class="ulink" href="http://www.xively.com">www.xively.com</a>, which<a class="indexterm" id="id551"/> we will use to receive our data. Go <a class="indexterm" id="id552"/>to the site and sign up for a free developer <a class="indexterm" id="id553"/>account (via the <span class="emphasis"><em>Developer</em></span> section, <a class="ulink" href="https://personal.xively.com/signup">https://personal.xively.com/signup</a>).</p><div class="mediaobject"><img alt="Getting ready" src="graphics/6623OT_07_026.jpg"/><div class="caption"><p>Sign up and create a Xively account</p></div></div><p>Once you have registered and verified your account, you can follow the instructions that will take you through a test drive example. This will demonstrate linking to data from your smartphone (gyroscopic data, location, and so on), which will give you a taste of what we can do with the Raspberry Pi.</p><p>When you log in, you<a class="indexterm" id="id554"/> will be<a class="indexterm" id="id555"/> taken to the <span class="strong"><strong>Development Devices</strong></span>
<a class="indexterm" id="id556"/> dashboard (located in the <span class="strong"><strong>WebTools</strong></span> drop-down menu):</p><div class="mediaobject"><img alt="Getting ready" src="graphics/6623OT_07_027.jpg"/><div class="caption"><p>Adding a new device</p></div></div><p>Select <span class="strong"><strong>+Add Device</strong></span> and fill in the details, giving your device a name and setting <span class="strong"><strong>Device</strong></span> as <span class="strong"><strong>Private</strong></span>.</p><p>You will now see the control page for your remote device, which contains all the information you need to connect and also where your data will be displayed.</p><div class="mediaobject"><img alt="Getting ready" src="graphics/6623OT_07_028.jpg"/><div class="caption"><p>Example API Key and feed number (this will be unique for your device)</p></div></div><p>Although there is a lot <a class="indexterm" id="id557"/>of information on this page, you only need two parts of it:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The API<a class="indexterm" id="id558"/> Key (which is the long code in the<a class="indexterm" id="id559"/> <code class="literal">API Keys</code> section), as follows:<div class="informalexample"><pre class="programlisting">API_KEY = CcRxJbP5TuHp1PiOGVrN2kTGeXVsb6QZRJU236v6PjOdtzze</pre></div></li><li class="listitem" style="list-style-type: disc">The feed number (referred to in the <code class="literal">API Keys</code> section and also listed at the top of the page), as follows:<div class="informalexample"><pre class="programlisting">FEED_ID = 399948883</pre></div></li></ul></div><p>Now that we have the details we need to connect with Xively, we can focus on the Raspberry Pi side of things.</p><p>We will use pip-3.2 to install Xively, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>sudo pip-3.2 install xively-python</strong></span>
</pre></div><p>Ensure that the install reports the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Successfully installed xively-python requests</strong></span>
</pre></div><p>You are now ready to send some data from your Raspberry Pi.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec152"/>How to do it...</h2></div></div></div><p>Create the following script, <code class="literal">xivelyLog.py</code>. Ensure you set <code class="literal">FEED_ID</code> and <code class="literal">API_KEY</code> within the code to match the device you created:</p><div class="informalexample"><pre class="programlisting">#!/usr/bin/env python3
#xivelylog.py
import xively
import time
import datetime
import requests
from random import randint
import data_local as dataDevice

# Set the FEED_ID and API_KEY from your account
FEED_ID = 399948883
API_KEY = "CcRxJbP5TuHp1PiOGVrN2kTGeXVsb6QZRJU236v6PjOdtzze"
api = xively.XivelyAPIClient(API_KEY) # initialize api client
DEBUG=True

myData = dataDevice.device()
myDataNames=myData.getName()

def get_datastream(feed,name,tags):
  try:
    datastream = feed.datastreams.get(name)
    if DEBUG:print ("Found existing datastream")
    return datastream
  except:
    if DEBUG:print ("Creating new datastream")
    datastream = feed.datastreams.create(name, tags=tags)
    return datastream

def run():
  print ("Connecting to Xively")
  feed = api.feeds.get(FEED_ID)
  if DEBUG:print ("Got feed" + str(feed))
  datastreams=[]
  for dataName in myDataNames:
    dstream = get_datastream(feed,dataName,dataName)
    if DEBUG:print ("Got %s datastream:%s"%(dataName,dstream))
    datastreams.append(dstream)

  while True:
    data=myData.getNew()
    for idx,dataValue in enumerate(data):
      if DEBUG:
        print ("Updating %s: %s" % (dataName,dataValue))
      datastreams[idx].current_value = dataValue
      datastreams[idx].at = datetime.datetime.utcnow()
    try:
      for ds in datastreams:
        ds.update()
    except requests.HTTPError as e:
      print ("HTTPError({0}): {1}".format(e.errno, e.strerror))
    time.sleep(60)

run()
#End</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec153"/>How it works...</h2></div></div></div><p>First, we initialize the <a class="indexterm" id="id560"/>Xively API client, to which we supply <code class="literal">API_KEY</code> (this authorizes<a class="indexterm" id="id561"/> us to send data to the <code class="literal">Xively</code> device we created previously). Next, we use <code class="literal">FEED_ID</code> to link us to the specific feed we want to send<a class="indexterm" id="id562"/> the data to. Finally, we request the datastream to connect to (if it doesn't already exist in the feed, the <code class="literal">get_datastream()</code> function will create one for us).</p><p>For each datastream in the feed, we supply a <code class="literal">name</code> function and <code class="literal">tags</code> (these are keywords that help us identify the data; we can use our data names for this).</p><p>Once we have defined our datastreams, we enter the <code class="literal">main</code> loop; here, we gather our data values from <code class="literal">dataDevice</code>. We then set the <code class="literal">current_value</code> function and also the timestamp of the data for each data item and apply it to our datastream objects.</p><p>Finally, when all the data is ready, we update each of the datastreams and the data is sent to Xively, appearing within a few moments on the dashboard for the device.</p><p>We can log in to our Xively account and view data as it comes in, using a standard web browser. This provides the means to send data and remotely monitor it anywhere in the world (perhaps from several Raspberry Pis at once if required). The service even supports the creation of triggers that can send additional messages back if certain items go out of expected ranges, reach specific values, or match set criteria. The triggers can in turn be used to control other devices or raise alerts, and so on.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec154"/>See also</h2></div></div></div><p>The AirPi Air Quality<a class="indexterm" id="id563"/> and Weather project (<a class="ulink" href="http://airpi.es">http://airpi.es</a>) shows you how to add your own sensors or use their AirPi kit to create your own air quality and weather station (with data logging to your own Xively account). The site also allows you to share your Xively data feeds with others from around the world.</p></div></div></body></html>