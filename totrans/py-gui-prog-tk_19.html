<html><head></head><body>
  <div><h1 id="_idParaDest-477" class="chapterTitle">B</h1>
    <h1 id="_idParaDest-478" class="appendix-title">A Quick SQL Tutorial</h1>
    <p class="normal">For over three decades, relational database systems have remained a de facto standard for storing business data. They are<a id="_idIndexMarker1661"/> more commonly known as SQL databases, after the <strong class="keyword">Structured Query Language </strong>(<strong class="keyword">SQL</strong>) used to interact with them. Although a full treatment of SQL warrants a book of its own, this appendix will provide a brief coverage of its basic concepts and syntax that will be adequate for following its usage in this book.</p>
    <h1 id="_idParaDest-479" class="title">SQL concepts</h1>
    <p class="normal">SQL databases<a id="_idIndexMarker1662"/> are made up of <strong class="keyword">tables</strong>. A table<a id="_idIndexMarker1663"/> is something like a CSV or spreadsheet file, in that it has rows representing individual items and columns representing data values associated with each item. A SQL table has some important differences from a spreadsheet, though:</p>
    <ul>
      <li class="bullet">First, each column in the table is assigned a <strong class="keyword">data type</strong>, which is strictly enforced. Just as Python<a id="_idIndexMarker1664"/> will produce an error when you try to convert <code class="Code-In-Text--PACKT-">"abcd"</code> to an <code class="Code-In-Text--PACKT-">int</code> or <code class="Code-In-Text--PACKT-">0.03</code> into a <code class="Code-In-Text--PACKT-">date</code>, a SQL database will return an error if you try to insert letters into a numeric column or decimal values into a date column. SQL databases typically support basic data types like text, numbers, dates and times, Boolean values, and binary data; in addition, some implementations have specialized data types for things like IP addresses, JSON data, currency, or images.</li>
      <li class="bullet">SQL tables can also have <strong class="keyword">constraints</strong>, which further enforce the validity of data inserted<a id="_idIndexMarker1665"/> into the table. For example, a column can be given a <strong class="keyword">unique constraint</strong>, which prevents two<a id="_idIndexMarker1666"/> rows from having the same value in that column, or a <strong class="keyword">not null</strong> constraint, which means that every row<a id="_idIndexMarker1667"/> must have a value.</li>
    </ul>
    <p class="normal">SQL databases commonly contain many tables, and these can be joined together to represent much<a id="_idIndexMarker1668"/> more complicated data structures. By breaking data into multiple linked tables, we can store it in a way that is much more efficient and resilient than a two-dimensional plaintext CSV file.</p>
    <h2 id="_idParaDest-480" class="title">Syntax differences from Python</h2>
    <p class="normal">If you've only<a id="_idIndexMarker1669"/> ever programmed in Python, SQL may feel odd at first, as the rules and syntax are very different. We'll be going over the individual commands and keywords, but here are some general differences from Python:</p>
    <ul>
      <li class="bullet">SQL is (mostly) <strong class="keyword">case-insensitive</strong>: Although it's conventional for readability purposes to type the SQL keywords in all caps, most SQL implementations are not case-sensitive. There are a few small exceptions here and there, but, for the most part, you can type SQL in whatever case is easiest for you.</li>
      <li class="bullet"><strong class="keyword">Whitespace</strong> is not significant: In Python, new lines and indentation can change the meaning of a piece of code. In SQL, whitespace is not significant and statements are terminated with a semicolon. Indents and new lines in a query are only there for readability.</li>
      <li class="bullet">SQL is <strong class="keyword">declarative</strong>: Python could be described as an <strong class="keyword">imperative programming language</strong>: we tell Python what we want it to do by telling it how to do it. SQL is more of a declarative<a id="_idIndexMarker1670"/> language: we <em class="italic">describe</em> what we want done, and the SQL engine figures out how to do it.</li>
    </ul>
    <p class="normal">We'll encounter additional syntax differences as we look at specific SQL code examples.</p>
    <h1 id="_idParaDest-481" class="title">SQL operations and syntax</h1>
    <p class="normal">SQL is a powerful and expressive language for doing mass manipulations of tabular data, but the basics can be grasped quickly. SQL code is executed as individual queries that either define, manipulate, or select data in the database. SQL dialects vary somewhat between different<a id="_idIndexMarker1671"/> relational database products, but most of them support <strong class="keyword">ANSI/ISO-standard SQL</strong> for core operations. </p>
    <p class="normal">While most of the basic concepts and keywords<a id="_idIndexMarker1672"/> covered here will work across SQL implementations, we'll be using PostgreSQL's dialect for the examples in this section. If you wish to try these examples on a different SQL implementation, be prepared to make some adjustments to the syntax.</p>
    <p class="normal">To follow along with this section, connect to an empty database on your PostgreSQL database server, either using the <code class="Code-In-Text--PACKT-">psql</code> command-line tool, the <code class="Code-In-Text--PACKT-">pgAdmin</code> graphical tool, or another database client software of your choosing.</p>
    <h2 id="_idParaDest-482" class="title">Defining tables and inserting data</h2>
    <p class="normal">SQL tables are created<a id="_idIndexMarker1673"/> using the <code class="Code-In-Text--PACKT-">CREATE TABLE</code> command, as shown in the following<a id="_idIndexMarker1674"/> SQL query:</p>
    <pre class="programlisting code"><code class="hljs-code">CREATE TABLE musicians (
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  born DATE,
  died DATE CHECK(died &gt; born)
 );
</code></pre>
    <p class="normal">In this example, we're creating<a id="_idIndexMarker1675"/> a table called <code class="Code-In-Text--PACKT-">musicians</code>. After the name, we specify<a id="_idIndexMarker1676"/> a list of column definitions. Each column definition follows the format <code class="Code-In-Text--PACKT-">column_name data_type constraints</code>.</p>
    <p class="normal">Let's break down the details of these columns we've defined:</p>
    <ul>
      <li class="bullet">The <code class="Code-In-Text--PACKT-">id</code> column will be an arbitrary ID value for the row. Its type is <code class="Code-In-Text--PACKT-">SERIAL</code>, which means it will be an auto-incrementing integer field, and its constraint is <code class="Code-In-Text--PACKT-">PRIMARY KEY</code>, which means it will be used as the unique identifier for the row.</li>
      <li class="bullet">The <code class="Code-In-Text--PACKT-">name</code> field is of type <code class="Code-In-Text--PACKT-">TEXT</code>, so it can hold a string of any length. Its constraint of <code class="Code-In-Text--PACKT-">NOT NULL</code> means that a <code class="Code-In-Text--PACKT-">NULL</code> value is not allowed in this field.</li>
      <li class="bullet">The <code class="Code-In-Text--PACKT-">born</code> and <code class="Code-In-Text--PACKT-">died</code> fields are of type <code class="Code-In-Text--PACKT-">DATE</code>, so they can only hold a date value.</li>
      <li class="bullet">The <code class="Code-In-Text--PACKT-">born</code> field has no constraints but <code class="Code-In-Text--PACKT-">died</code> has a <code class="Code-In-Text--PACKT-">CHECK</code> constraint enforcing that its value must be greater than the value of <code class="Code-In-Text--PACKT-">born</code> for any given row.</li>
    </ul>
    <p class="normal">Although it's not required, it's a good practice to specify a <strong class="keyword">primary key</strong> for each table. Primary keys can be one field, or a combination<a id="_idIndexMarker1677"/> of fields, but the value must be unique for any given row. For example, if we made <code class="Code-In-Text--PACKT-">name</code> the primary key field, we couldn't have two musicians with the same name in our table.</p>
    <p class="normal">To add rows of data to this table, we use the <code class="Code-In-Text--PACKT-">INSERT INTO</code> command as follows:</p>
    <pre class="programlisting code"><code class="hljs-code">INSERT INTO musicians (name, born, died)
VALUES
  ('Robert Fripp','1946-05-16', NULL),
  ('Keith Emerson', '1944-11-02', '2016-03-11'),
  ('Greg Lake', '1947-11-10', '2016-12-7'),
  ('Bill Bruford', '1949-05-17', NULL),
  ('David Gilmour', '1946-03-06', NULL);
</code></pre>
    <p class="normal">The <code class="Code-In-Text--PACKT-">INSERT INTO</code> command takes a table name and an optional list specifying the fields to receive data; other fields will receive their default value (<code class="Code-In-Text--PACKT-">NULL</code> if not otherwise specified in the <code class="Code-In-Text--PACKT-">CREATE</code> statement). The <code class="Code-In-Text--PACKT-">VALUES</code> keyword indicates that a list of data values will follow, formatted<a id="_idIndexMarker1678"/> as a comma-separated list of tuples. Each tuple<a id="_idIndexMarker1679"/> corresponds to one table row and must match<a id="_idIndexMarker1680"/> the order of the field list specified after the table name.</p>
    <p class="normal">Note that strings are delimited<a id="_idIndexMarker1681"/> by the single quote character. Unlike Python, single quotes and double quotes have different meanings in SQL: a single quote indicates a string literal, while double quotes are used for object names that include spaces or need to preserve case. For example, if we had called our table <code class="Code-In-Text--PACKT-">Musicians of the '70s</code>, we would need to enclose that name in double-quotes due to the spaces, apostrophe, and capitalization.</p>
    <p class="normal">Using double-quotes to enclose a string literal results in an error, for example:</p>
    <pre class="programlisting code"><code class="hljs-code">INSERT INTO musicians (name, born, died)
VALUES
  ("Brian May", "1947-07-19", NULL);
-- Produces error:
ERROR:  column "Brian May" does not exist
</code></pre>
    <p class="normal">To make our database more interesting, let's create and populate another table; this time, an <code class="Code-In-Text--PACKT-">instruments</code> table:</p>
    <pre class="programlisting code"><code class="hljs-code">CREATE TABLE instruments (id SERIAL PRIMARY KEY, name TEXT NOT NULL);
INSERT INTO instruments (name)
VALUES ('bass'), ('drums'), ('guitar'), ('keyboards'), ('sax');
</code></pre>
    <p class="normal">Note that the <code class="Code-In-Text--PACKT-">VALUES</code> lists must always use parentheses around each row, even if there's only one value per row.</p>
    <p class="normal">To relate the <code class="Code-In-Text--PACKT-">musicians</code> table to the <code class="Code-In-Text--PACKT-">instruments</code> table, we'll need to add a column to it. Tables can be changed after they are created using the <code class="Code-In-Text--PACKT-">ALTER TABLE</code> command. For example, we can add our new column like this:</p>
    <pre class="programlisting code"><code class="hljs-code">ALTER TABLE musicians
  ADD COLUMN main_instrument INT REFERENCES instruments(id);
</code></pre>
    <p class="normal">The <code class="Code-In-Text--PACKT-">ALTER TABLE</code> command<a id="_idIndexMarker1682"/> takes a table name, then a command altering some<a id="_idIndexMarker1683"/> aspect of the table. In this<a id="_idIndexMarker1684"/> case, we're adding<a id="_idIndexMarker1685"/> a new column called <code class="Code-In-Text--PACKT-">main_instrument</code>, which<a id="_idIndexMarker1686"/> will be an integer. </p>
    <p class="normal">The <code class="Code-In-Text--PACKT-">REFERENCES</code> constraint we've specified is known as a <strong class="keyword">foreign key constraint</strong>; it limits the possible values of <code class="Code-In-Text--PACKT-">main_instrument</code> to existing ID numbers in the <code class="Code-In-Text--PACKT-">instruments</code> table.</p>
    <h2 id="_idParaDest-483" class="title">Retrieving data from tables</h2>
    <p class="normal">To retrieve data from tables, we can use a <code class="Code-In-Text--PACKT-">SELECT</code> statement, as follows:</p>
    <pre class="programlisting code"><code class="hljs-code">SELECT name FROM musicians;
</code></pre>
    <p class="normal">The <code class="Code-In-Text--PACKT-">SELECT</code> command<a id="_idIndexMarker1687"/> takes a column or comma-separated list of columns<a id="_idIndexMarker1688"/> followed by a <code class="Code-In-Text--PACKT-">FROM</code> clause, which specifies the table<a id="_idIndexMarker1689"/> or tables containing the specified columns. This query asks for the <code class="Code-In-Text--PACKT-">name</code> column from the <code class="Code-In-Text--PACKT-">musicians</code> table.</p>
    <p class="normal">Its output is as follows:</p>
    <table id="table001-14" class="No-Table-Style _idGenTablePara-1">
      <colgroup>
        <col/>
      </colgroup>
      <tbody>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">name</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Bill Bruford</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Keith Emerson</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Greg Lake</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Robert Fripp</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">David Gilmour</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="normal">Instead of a list of columns, we can also specify an asterisk, which means "all columns." For example:</p>
    <pre class="programlisting code"><code class="hljs-code">SELECT * FROM musicians;
</code></pre>
    <p class="normal">The preceding SQL query returns the following table of data:</p>
    <table id="table002-12" class="No-Table-Style">
      <colgroup>
        <col/>
        <col/>
        <col/>
        <col/>
        <col/>
      </colgroup>
      <thead>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">ID</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">name</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">born</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">died</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">main_instrument</p>
          </td>
        </tr>
      </thead>
      <tbody>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">4</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Bill Bruford</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">1949-05-17</p>
          </td>
          <td class="No-Table-Style"/>
          <td class="No-Table-Style"/>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">2</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Keith Emerson</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">1944-11-02</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">2016-03-11</p>
          </td>
          <td class="No-Table-Style"/>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">3</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Greg Lake</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">1947-11-10</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">2016-12-07</p>
          </td>
          <td class="No-Table-Style"/>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">1</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Robert Fripp</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">1946-05-16</p>
          </td>
          <td class="No-Table-Style"/>
          <td class="No-Table-Style"/>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">5</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">David Gilmour</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">1946-03-06</p>
          </td>
          <td class="No-Table-Style"/>
          <td class="No-Table-Style"/>
        </tr>
      </tbody>
    </table>
    <p class="normal">To filter out rows we don't want, we can specify a <code class="Code-In-Text--PACKT-">WHERE</code> clause, like so:</p>
    <pre class="programlisting code"><code class="hljs-code">SELECT name FROM musicians WHERE died IS NULL;
</code></pre>
    <p class="normal">The <code class="Code-In-Text--PACKT-">WHERE</code> command must be followed by a conditional expression that evaluates to <code class="Code-In-Text--PACKT-">True</code> or <code class="Code-In-Text--PACKT-">False</code>; rows for which<a id="_idIndexMarker1690"/> the expression evaluates <code class="Code-In-Text--PACKT-">True</code> are shown, while rows for which it evaluates <code class="Code-In-Text--PACKT-">False</code> are left<a id="_idIndexMarker1691"/> out. </p>
    <p class="normal">In this case, we have asked for the names of musicians for which<a id="_idIndexMarker1692"/> the <code class="Code-In-Text--PACKT-">died</code> date is <code class="Code-In-Text--PACKT-">NULL</code>. We can specify more complex conditions by combining expressions with the <code class="Code-In-Text--PACKT-">AND</code> and <code class="Code-In-Text--PACKT-">OR</code> operators, like so:</p>
    <pre class="programlisting code"><code class="hljs-code">SELECT name FROM musicians WHERE born &lt; '1945-01-01' AND died IS NULL;
</code></pre>
    <p class="normal">In this case, we would only get musicians born before 1945 who don't have a died date in the database.</p>
    <p class="normal">The <code class="Code-In-Text--PACKT-">SELECT</code> command can also do operations on fields, or re-order the results by certain columns:</p>
    <pre class="programlisting code"><code class="hljs-code">SELECT name, age(born), (died - born)/365 AS "age at death"
FROM musicians
ORDER BY born DESC;
</code></pre>
    <p class="normal">In this example, we're using the <code class="Code-In-Text--PACKT-">age()</code> function to determine the age of the musicians from their birth dates. We're also doing math on the <code class="Code-In-Text--PACKT-">died</code> and <code class="Code-In-Text--PACKT-">born</code> dates to determine the age at death for those who have passed. Notice that we're using the <code class="Code-In-Text--PACKT-">AS</code> keyword to <strong class="keyword">alias</strong>, or rename, the generated column.</p>
    <p class="normal">When you run this query, you should get output like this:</p>
    <table id="table003-10" class="No-Table-Style">
      <colgroup>
        <col/>
        <col/>
        <col/>
      </colgroup>
      <tbody>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">name</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">age</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">age at death</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Bill Bruford</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">72 years 4 mons 18 days</p>
          </td>
          <td class="No-Table-Style"/>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Greg Lake</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">73 years 10 mons 24 days</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">69</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Robert Fripp</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">75 years 4 mons 19 days</p>
          </td>
          <td class="No-Table-Style"/>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">David Gilmour</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">75 years 6 mons 29 days</p>
          </td>
          <td class="No-Table-Style"/>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Keith Emerson</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">76 years 11 mons 2 days</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">71</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="normal">Notice that <code class="Code-In-Text--PACKT-">age at death</code> is <code class="Code-In-Text--PACKT-">NULL</code> for those without a date of death. Mathematical or logical operations on a <code class="Code-In-Text--PACKT-">NULL</code> value always return an answer of <code class="Code-In-Text--PACKT-">NULL</code>.</p>
    <p class="normal">The <code class="Code-In-Text--PACKT-">ORDER BY</code> clause specifies a column or list of columns by which the results should be ordered. It also takes an argument of <code class="Code-In-Text--PACKT-">DESC</code> or <code class="Code-In-Text--PACKT-">ASC</code> to specify descending or ascending order, respectively.</p>
    <p class="normal">We have ordered the<a id="_idIndexMarker1693"/> output here by date of birth in descending<a id="_idIndexMarker1694"/> order. Note that each data type has its own rules for<a id="_idIndexMarker1695"/> sorting data, just like in Python. Dates are ordered by their calendar position, strings by alphabetical order, and numbers by their numeric value.</p>
    <h2 id="_idParaDest-484" class="title">Updating rows, deleting rows, and more WHERE clauses</h2>
    <p class="normal">To update<a id="_idIndexMarker1696"/> or delete existing rows, we use the <code class="Code-In-Text--PACKT-">UPDATE</code> and <code class="Code-In-Text--PACKT-">DELETE FROM</code> keywords<a id="_idIndexMarker1697"/> in conjunction with a <code class="Code-In-Text--PACKT-">WHERE</code> clause to<a id="_idIndexMarker1698"/> select the affected rows.</p>
    <p class="normal">Deleting is fairly simple; for example, if we wanted<a id="_idIndexMarker1699"/> to delete the <code class="Code-In-Text--PACKT-">instrument</code> record with an <code class="Code-In-Text--PACKT-">id</code> value of <code class="Code-In-Text--PACKT-">5</code>, it would look like this:</p>
    <pre class="programlisting code"><code class="hljs-code">DELETE FROM instruments WHERE id=5;
</code></pre>
    <p class="normal">The <code class="Code-In-Text--PACKT-">DELETE FROM</code> command will delete any rows that match the <code class="Code-In-Text--PACKT-">WHERE</code> conditions. In this case, we match the primary key to ensure only one row is deleted. If no rows match the <code class="Code-In-Text--PACKT-">WHERE</code> conditions, no rows will be deleted. Note, however, that the <code class="Code-In-Text--PACKT-">WHERE</code> clause is technically optional: <code class="Code-In-Text--PACKT-">DELETE FROM instruments</code> will simply delete all rows in the table.</p>
    <p class="normal">Updating is similar, except it includes a <code class="Code-In-Text--PACKT-">SET</code> clause to specify new column values, as follows:</p>
    <pre class="programlisting code"><code class="hljs-code">UPDATE musicians SET main_instrument=3 WHERE id=1;
UPDATE musicians SET main_instrument=2 WHERE name='Bill Bruford';
</code></pre>
    <p class="normal">Here, we are setting <code class="Code-In-Text--PACKT-">main_instrument</code> in the <code class="Code-In-Text--PACKT-">musicians</code> table to the primary key value from the <code class="Code-In-Text--PACKT-">instruments</code> table that identifies the instrument we want to associate with each musician. </p>
    <p class="normal">We can select the <code class="Code-In-Text--PACKT-">musician</code> records we want to update using the primary key, name, or any combination of conditions. Like <code class="Code-In-Text--PACKT-">DELETE</code>, omitting the <code class="Code-In-Text--PACKT-">WHERE</code> clause would cause the query to affect all rows.</p>
    <p class="normal">Any number of columns can be updated in the <code class="Code-In-Text--PACKT-">SET</code> clause; for example:</p>
    <pre class="programlisting code"><code class="hljs-code">UPDATE musicians
  SET main_instrument=4, name='Keith Noel Emerson'
  WHERE name LIKE 'Keith%';
</code></pre>
    <p class="normal">Additional columns to be updated are just separated by commas. Note that we've also matched the record using the <code class="Code-In-Text--PACKT-">LIKE</code> operator in tandem with the <code class="Code-In-Text--PACKT-">%</code> wildcard character. <code class="Code-In-Text--PACKT-">LIKE</code> can be used with text and string data types to match partial values. Standard SQL supports two wildcard characters: <code class="Code-In-Text--PACKT-">%</code>, which matches zero or more characters, and <code class="Code-In-Text--PACKT-">_</code>, which matches a single character.</p>
    <p class="normal">We can also match against transformed column values:</p>
    <pre class="programlisting code"><code class="hljs-code">UPDATE musicians SET main_instrument=1 WHERE LOWER (name) LIKE '%lake';
</code></pre>
    <p class="normal">Here, we've<a id="_idIndexMarker1700"/> used the <code class="Code-In-Text--PACKT-">LOWER</code> function to match our string against<a id="_idIndexMarker1701"/> the lowercase version of the column value. This doesn't permanently<a id="_idIndexMarker1702"/> change the data in the table; it just temporarily<a id="_idIndexMarker1703"/> changes the value for the purpose of the comparison.</p>
    <div><p class="Information-Box--PACKT-">Standard SQL specifies that <code class="Code-In-Text--PACKT-">LIKE</code> is a case-sensitive match. PostgreSQL offers an <code class="Code-In-Text--PACKT-">ILIKE</code> operator that does case-insensitive matching, as well as a <code class="Code-In-Text--PACKT-">SIMILAR TO</code> operator that matches using more advanced regular expression syntax.</p>
    </div>
    <h2 id="_idParaDest-485" class="title">Subqueries</h2>
    <p class="normal">Inserting data using meaningless primary key values is not very user-friendly. To make inserting these<a id="_idIndexMarker1704"/> values a little more intuitive, we can use a <strong class="keyword">subquery</strong>, as shown<a id="_idIndexMarker1705"/> in the following SQL query:</p>
    <pre class="programlisting code"><code class="hljs-code">UPDATE musicians
SET main_instrument=(
  SELECT id FROM instruments WHERE name='guitar'
)
WHERE name IN ('Robert Fripp', 'David Gilmour');
</code></pre>
    <p class="normal">A subquery<a id="_idIndexMarker1706"/> is a SQL query within a SQL query. If your subquery can be guaranteed to return a single value, it can be used anywhere you would use a literal value. </p>
    <p class="normal">In this case, we're letting our database do the work of figuring out what the primary key of <code class="Code-In-Text--PACKT-">'guitar'</code> is, and inserting the returned integer for our <code class="Code-In-Text--PACKT-">main_instrument</code> value.</p>
    <p class="normal">In the <code class="Code-In-Text--PACKT-">WHERE</code> clause, we've also used the <code class="Code-In-Text--PACKT-">IN</code> operator to match the musician's name. Just like the Python <code class="Code-In-Text--PACKT-">in</code> keyword, this SQL keyword allows us to match against a list of values. <code class="Code-In-Text--PACKT-">IN</code> can be used with a subquery as well; for example:</p>
    <pre class="programlisting code"><code class="hljs-code">SELECT name FROM musicians
WHERE main_instrument IN (
  SELECT id FROM instruments WHERE name LIKE '%r%'
)
</code></pre>
    <p class="normal">In this example, we've asked the database to give us every musician whose main instrument contains the letter "r". Since <code class="Code-In-Text--PACKT-">IN</code> is meant to be used with a list of values, any query that returns a single column with any number of rows is valid. In this case, our subquery returns several<a id="_idIndexMarker1707"/> rows with only the <code class="Code-In-Text--PACKT-">id</code> column, so it works with <code class="Code-In-Text--PACKT-">IN</code> just fine.</p>
    <p class="normal">Subqueries that return multiple rows and multiple columns can be used anywhere that a table can be used; for example, we can use a subquery in a <code class="Code-In-Text--PACKT-">FROM</code> clause, like so:</p>
    <pre class="programlisting code"><code class="hljs-code">SELECT name
FROM (
  SELECT * FROM musicians WHERE died IS NULL
) AS living_musicians;
</code></pre>
    <p class="normal">In this case, SQL treats our subquery as though it were a table in the database. Note that subqueries used in a <code class="Code-In-Text--PACKT-">FROM</code> clause require an alias; we've aliased this subquery as <code class="Code-In-Text--PACKT-">living_musicians</code>.</p>
    <h2 id="_idParaDest-486" class="title">Joining tables</h2>
    <p class="normal">Subqueries are one way<a id="_idIndexMarker1708"/> of using multiple tables together, but a more flexible and powerful way is to use <code class="Code-In-Text--PACKT-">JOIN</code>. <code class="Code-In-Text--PACKT-">JOIN</code> is used in the <code class="Code-In-Text--PACKT-">FROM</code> clause of a SQL statement, for example:</p>
    <pre class="programlisting code"><code class="hljs-code">SELECT musicians.name, instruments.name as main_instrument
FROM musicians
  JOIN instruments ON musicians.main_instrument = instrument.id;
</code></pre>
    <p class="normal">A <code class="Code-In-Text--PACKT-">JOIN</code> statement requires an <code class="Code-In-Text--PACKT-">ON</code> clause that specifies the conditions used to match rows in each table. The <code class="Code-In-Text--PACKT-">ON</code> clause acts like a filter, much like the <code class="Code-In-Text--PACKT-">WHERE</code> clause does; you can imagine that the <code class="Code-In-Text--PACKT-">JOIN</code> creates<a id="_idIndexMarker1709"/> a new table containing every possible combination of rows from both tables, then filters out the ones that don't match the <code class="Code-In-Text--PACKT-">ON</code> conditions. </p>
    <p class="normal">Tables are typically joined by matching the values in common fields, such as those specified in a foreign key constraint. In this case, our <code class="Code-In-Text--PACKT-">musicians.main_instrument</code> column contains the <code class="Code-In-Text--PACKT-">id</code> values from the <code class="Code-In-Text--PACKT-">instrument</code> table, so we can join the two tables based on this.</p>
    <p class="normal">Joins are used to implement four types of table relationships:</p>
    <ul>
      <li class="bullet"><strong class="keyword">One-to-one joins</strong> match exactly one row<a id="_idIndexMarker1710"/> in the first table to exactly one row in the second.</li>
      <li class="bullet"><strong class="keyword">Many-to-one joins</strong> match multiple rows in the first<a id="_idIndexMarker1711"/> table to exactly one row in the second.</li>
      <li class="bullet"><strong class="keyword">One-to-many joins</strong> match one row in the first<a id="_idIndexMarker1712"/> table to multiple rows in the second.</li>
      <li class="bullet"><strong class="keyword">Many-to-many joins</strong> match multiple rows in both<a id="_idIndexMarker1713"/> tables. This kind of join requires the use of an intermediary table.</li>
    </ul>
    <p class="normal">The previous query shows a many-to-one join, since many <code class="Code-In-Text--PACKT-">musicians</code> can have the same main instrument. Many-to-one joins are often used when a column's value should be limited to a set of options, such<a id="_idIndexMarker1714"/> as fields that our GUI might represent with a <code class="Code-In-Text--PACKT-">Combobox</code> widget. The table joined is often called a <strong class="keyword">lookup table</strong>.</p>
    <p class="normal">If we were to reverse our last query, it would be one-to-many:</p>
    <pre class="programlisting code"><code class="hljs-code">SELECT instruments.name AS instrument, musicians.name AS musician
FROM instruments
  JOIN musicians ON musicians.main_instrument = instruments.id;
</code></pre>
    <p class="normal">One-to-many joins are commonly used when a record has a list of sub-records associated with it; in this case, each instrument<a id="_idIndexMarker1715"/> has a list of musicians who consider it their main instrument. The joined table is often called a <strong class="keyword">detail table</strong>. The preceding SQL query will give you the following output:</p>
    <table id="table004-8" class="No-Table-Style _idGenTablePara-1">
      <colgroup>
        <col/>
        <col/>
      </colgroup>
      <thead>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">instrument</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">musician</p>
          </td>
        </tr>
      </thead>
      <tbody>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">drums</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Bill Bruford</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">keyboards</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Keith Emerson</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">bass</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Greg Lake</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">guitar</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Robert Fripp</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">guitar</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">David Gilmour</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="normal">Notice that <code class="Code-In-Text--PACKT-">guitar</code> is duplicated in the <code class="Code-In-Text--PACKT-">instrument</code> list. When two tables are joined, the rows of the result no longer refer to the same entity. One row in the <code class="Code-In-Text--PACKT-">instrument</code> table represents an instrument. </p>
    <p class="normal">One row in the <code class="Code-In-Text--PACKT-">musician</code> table represents one musician. One row in <em class="italic">this</em> table represents an instrument-musician relationship.</p>
    <p class="normal">Suppose we wanted to keep<a id="_idIndexMarker1716"/> the output such that one row represented<a id="_idIndexMarker1717"/> one instrument, but still include information about associated musicians in each row. To do this, we'll need to combine the matched musician rows using an <strong class="keyword">aggregate function</strong> and a <code class="Code-In-Text--PACKT-">GROUP BY</code> clause, as shown in the following SQL query:</p>
    <pre class="programlisting code"><code class="hljs-code">SELECT instruments.name AS instrument,
  count(musicians.id) as musicians
FROM instruments
  JOIN musicians ON musicians.main_instrument = instruments.id
GROUP BY instruments.name;
</code></pre>
    <p class="normal">The <code class="Code-In-Text--PACKT-">GROUP BY</code> clause specifies which column or columns describe what each row in the output table represents. Output columns not in the <code class="Code-In-Text--PACKT-">GROUP BY</code> clause must then be reduced to single values using an aggregate function. </p>
    <p class="normal">In this case, we're using the <code class="Code-In-Text--PACKT-">count()</code> aggregate function to count the total number of musician records associated with each instrument. Its output looks like this:</p>
    <table id="table005-6" class="No-Table-Style _idGenTablePara-1">
      <colgroup>
        <col/>
        <col/>
      </colgroup>
      <thead>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">instrument</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">musicians</p>
          </td>
        </tr>
      </thead>
      <tbody>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">drums</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">1</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">keyboards</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">1</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">bass</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">1</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">guitar</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">2</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="normal">Standard SQL contains several more aggregate functions, such as <code class="Code-In-Text--PACKT-">min()</code>, <code class="Code-In-Text--PACKT-">max()</code>, and <code class="Code-In-Text--PACKT-">sum()</code>, and most SQL implementations extend this with their own functions as well.</p>
    <p class="normal">Many-to-one and one-to-many joins don't quite cover every possible situation that databases need to model; quite often, a many-to-many relationship is required.</p>
    <p class="normal">To demonstrate a many-to-many join, let's create a new table called <code class="Code-In-Text--PACKT-">bands</code>, like so:</p>
    <pre class="programlisting code"><code class="hljs-code">CREATE TABLE bands (id SERIAL PRIMARY KEY, name TEXT NOT NULL);
INSERT INTO bands(name)
VALUES ('ABWH'), ('ELP'), ('King Crimson'), ('Pink Floyd'), ('Yes');
</code></pre>
    <p class="normal">A band has multiple musicians, and musicians can be part of multiple bands. How can we create a relationship between musicians and bands? If we added a <code class="Code-In-Text--PACKT-">band</code> field to the <code class="Code-In-Text--PACKT-">musicians</code> table, this would<a id="_idIndexMarker1718"/> limit each musician to one band. If we added a <code class="Code-In-Text--PACKT-">musician</code> field to the <code class="Code-In-Text--PACKT-">band</code> table, this<a id="_idIndexMarker1719"/> would limit each band to one musician. To make the connection, we need to create a <strong class="keyword">junction table</strong>, in which each row represents a musician's membership in a band.</p>
    <p class="normal">Create the <code class="Code-In-Text--PACKT-">musicians_bands</code> table like so:</p>
    <pre class="programlisting code"><code class="hljs-code">CREATE TABLE musicians_bands (
  musician_id INT REFERENCES musicians(id),
  band_id INT REFERENCES bands(id),
  PRIMARY KEY (musician_id, band_id)
);
INSERT INTO musicians_bands(musician_id, band_id)
VALUES (1, 3), (2, 2), (3, 2), (3, 3),
  (4, 1), (4, 2), (4, 5), (5,4);
</code></pre>
    <p class="normal">The <code class="Code-In-Text--PACKT-">musicians_bands</code> table simply contains two foreign key fields, one to point to a musician's ID and one to point to the band's ID. </p>
    <p class="normal">Notice that instead of creating or specifying one field as the primary key, we use the combination of both fields as the primary key. It wouldn't make sense to have multiple rows with the same two values in them, so the combination makes an acceptable primary key.</p>
    <p class="normal">To write a query that uses this relationship, our <code class="Code-In-Text--PACKT-">FROM</code> clause needs to specify two <code class="Code-In-Text--PACKT-">JOIN</code> statements: one from <code class="Code-In-Text--PACKT-">musicians</code> to <code class="Code-In-Text--PACKT-">musicians_bands</code> and one from <code class="Code-In-Text--PACKT-">bands</code> to <code class="Code-In-Text--PACKT-">musicians_bands</code>.</p>
    <p class="normal">For example, let's get the names of the bands each musician has been in:</p>
    <pre class="programlisting code"><code class="hljs-code">SELECT musicians.name, array_agg(bands.name) AS bands
FROM musicians
  JOIN musicians_bands ON musicians.id = musicians_bands.musician_id
  JOIN bands ON bands.id = musicians_bands.band_id
GROUP BY musicians.name
ORDER BY musicians.name ASC;
</code></pre>
    <p class="normal">This query ties musicians to bands using the junction table, then displays musician names next to an aggregated list of the bands they've been in, and orders it by the musician's name. It gives you the following output:</p>
    <table id="table006-5" class="No-Table-Style _idGenTablePara-1">
      <colgroup>
        <col/>
        <col/>
      </colgroup>
      <thead>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">name</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">bands</p>
          </td>
        </tr>
      </thead>
      <tbody>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Bill Bruford</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">{ABWH,"King Crimson",Yes}</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">David Gilmour</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">{"Pink Floyd"}</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Greg Lake</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">{ELP,"King Crimson"}</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Keith Emerson</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">{ELP}</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Robert Fripp</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">{"King Crimson"}</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="normal">The <code class="Code-In-Text--PACKT-">array_agg()</code> function used<a id="_idIndexMarker1720"/> here aggregates string values into an array structure. This method, and the <code class="Code-In-Text--PACKT-">ARRAY</code> data type, are specific to PostgreSQL. </p>
    <p class="normal">There is no SQL standard function for aggregating string values, though most SQL implementations have a solution for it.</p>
    <h2 id="_idParaDest-487" class="title">Managing transactions</h2>
    <p class="normal">While we can accomplish a lot of data manipulation in a single SQL query, there are times when a change requires<a id="_idIndexMarker1721"/> multiple queries. Often in these cases, if one query<a id="_idIndexMarker1722"/> fails, the whole set of queries must be reversed or else the data would be corrupted. </p>
    <p class="normal">For example, suppose we want to insert <code class="Code-In-Text--PACKT-">'Vocals'</code> as a value in the <code class="Code-In-Text--PACKT-">instruments</code> table, but we want it to be ID #1. To do that, we'd need to first move the other ID values in the <code class="Code-In-Text--PACKT-">instruments</code> table up by one, adjust the foreign key values in the <code class="Code-In-Text--PACKT-">musicians</code> table, then add the new row. The queries would look like this:</p>
    <pre class="programlisting code"><code class="hljs-code">UPDATE instruments SET id=id+1;
UPDATE musicians SET main_instrument=main_instrument+1;
INSERT INTO instruments(id, name) VALUES (1, 'Vocals');
</code></pre>
    <p class="normal">In this example, all three queries must run successfully in order to effect the change we want, and at the very least the first two must run to avoid data corruption. If only the first query ran, our data would be corrupt.</p>
    <p class="normal">To do this safely, we need to use a <strong class="keyword">transaction</strong>.</p>
    <p class="normal">Using transactions in PostgreSQL involves three keywords, as shown here:</p>
    <table id="table007-3" class="No-Table-Style">
      <colgroup>
        <col/>
        <col/>
      </colgroup>
      <tbody>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">Keyword</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">Function</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">BEGIN</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Start a transaction</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">ROLLBACK</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Undo the transaction and start fresh</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">COMMIT</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Permanently save the transaction</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="normal">To put our queries in a transaction, we simply add <code class="Code-In-Text--PACKT-">BEGIN</code> before the queries and <code class="Code-In-Text--PACKT-">COMMIT</code> afterward, like so:</p>
    <pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">BEGIN</strong><strong class="hljs-slc">;</strong>
UPDATE instruments SET id=id+1;
UPDATE musicians SET main_instrument=main_instrument+1;
INSERT INTO instruments(id, name) VALUES (1, 'Vocals');
<strong class="hljs-keyword-slc">COMMIT</strong><strong class="hljs-slc">;</strong>
</code></pre>
    <p class="normal">Now, if anything goes<a id="_idIndexMarker1723"/> wrong with one of our queries, we can execute a <code class="Code-In-Text--PACKT-">ROLLBACK</code> statement to revert the database<a id="_idIndexMarker1724"/> to the state it was in when we called <code class="Code-In-Text--PACKT-">BEGIN</code>.</p>
    <div><p class="Information-Box--PACKT-">In DBAPI2-compatible modules like the <code class="Code-In-Text--PACKT-">psycopg2</code> module that we use in <em class="chapterRef">Chapter 12</em>, <em class="italic">Improving Data Storage with SQL</em>, transaction management is often handled implicitly through connection settings, or explicitly through connection object methods, rather than using SQL statements.</p>
    </div>
    <h1 id="_idParaDest-488" class="title">Learning more</h1>
    <p class="normal">This has been a quick overview of SQL concepts and syntax; we've covered most of what you need to know to write a simple database application, but there's much more to learn. The PostgreSQL manual, available at <a href="https://www.postgresql.org/docs/manuals">https://www.postgresql.org/docs/manuals</a>, is a great resource and reference for SQL syntax and the specific features of PostgreSQL.</p>
  </div>
</body></html>