<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Templates and JavaScript</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Arranging the base.html template</li><li class="listitem" style="list-style-type: disc">Including JavaScript settings</li><li class="listitem" style="list-style-type: disc">Using HTML5 data attributes</li><li class="listitem" style="list-style-type: disc">Opening object details in a modal dialog</li><li class="listitem" style="list-style-type: disc">Implementing a continuous scroll</li><li class="listitem" style="list-style-type: disc">Implementing the Like widget</li><li class="listitem" style="list-style-type: disc">Uploading images by Ajax</li></ul></div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec47"/>Introduction</h1></div></div></div><p>We are living in the Web2.0 world, where social web applications and smart websites communicate between servers and clients using Ajax, refreshing whole pages only when the context changes. In this chapter, you will learn best practices to deal with JavaScript in your templates in order to create a rich user experience. For responsive layouts, we will use the Bootstrap 3 frontend framework. For productive scripting, we will use the jQuery JavaScript framework.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec48"/>Arranging the base.html template</h1></div></div></div><p>When you start working on templates, one of the first actions is to create the <code class="literal">base.html</code> boilerplate, which <a class="indexterm" id="id207"/>will be extended by most of the page templates in your project. In this recipe, we will demonstrate how to create such template for multilingual HTML5 websites with responsiveness in mind.</p><div><div><h3 class="title"><a id="tip11"/>Tip</h3><p>Responsive websites are the ones that adapt to the viewport of the device whether the visitor uses desktop browsers, tablets, or phones.</p></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec154"/>Getting ready</h2></div></div></div><p>Create the <code class="literal">templates</code> directory in your project and set <code class="literal">TEMPLATE_DIRS</code> in the settings.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec155"/>How to do it…</h2></div></div></div><p>Perform the<a class="indexterm" id="id208"/> following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">In the root directory of your <code class="literal">templates</code>, create a <code class="literal">base.html</code> file with the following content:<div><pre class="programlisting">
<strong>{# templates/base.html #}</strong>
&lt;!DOCTYPE html&gt;
{% load i18n %}
&lt;html lang="{{ LANGUAGE_CODE }}"&gt;
&lt;head&gt;
    &lt;meta charset="utf-8" /&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1" /&gt;
    &lt;title&gt;{% block title %}{% endblock %}{% trans "My Website" %}&lt;/title&gt;
    &lt;link rel="icon" href="{{ STATIC_URL }}site/img/favicon.ico" type="image/png" /&gt;
   
    {% block meta_tags %}{% endblock %}
   
    {% block base_stylesheet %}
        &lt;link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" /&gt;
        &lt;link href="{{ STATIC_URL }}site/css/style.css" rel="stylesheet" media="screen" type="text/css" /&gt;
    {% endblock %}
    {% block stylesheet %}{% endblock %}
   
    {% block base_js %}
        &lt;script src="img/"&gt;&lt;/script&gt;
        &lt;script src="img/"&gt;&lt;/script&gt;
        &lt;script src="img/bootstrap.min.js"&gt;&lt;/script&gt;
        &lt;script src="img/{% url "js_settings" %}"&gt;&lt;/script&gt;
    {% endblock %}
   
    {% block js %}{% endblock %}
    {% block extrahead %}{% endblock %}
&lt;/head&gt;
&lt;body class="{% block bodyclass %}{% endblock %}"&gt;
    {% block page %}
        &lt;section class="wrapper"&gt;
            &lt;header class="clearfix container"&gt;
                &lt;h1&gt;{% trans "My Website" %}&lt;/h1&gt;
                {% block header_navigation %}
                    {% include "utils/header_navigation.html" %}
                {% endblock %}
                {% block language_chooser %}
                    {% include "utils/language_chooser.html" %}
                {% endblock %}
            &lt;/header&gt;
            &lt;div id="content" class="clearfix container"&gt;
                {% block content %}
                {% endblock %}
            &lt;/div&gt; 
            &lt;footer class="clearfix container"&gt;
                {% block footer_navigation %}
                    {% include "utils/footer_navigation.html" %}
                {% endblock %}
            &lt;/footer&gt;
        &lt;/section&gt;
    {% endblock %}
    {% block extrabody %}{% endblock %}
&lt;/body&gt;
&lt;/html&gt;</pre></div></li><li class="listitem">In the<a class="indexterm" id="id209"/> same directory, create another file named <code class="literal">base_simple.html</code> for specific cases, as follows:<div><pre class="programlisting">
<strong>{# templates/base_simple.html #}</strong>
{% extends "base.html" %}

{% block page %}
    &lt;section class="wrapper"&gt;
        &lt;div id="content" class="clearfix"&gt;
            {% block content %}
            {% endblock %}
        &lt;/div&gt;
    &lt;/section&gt;
{% endblock %}</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec156"/>How it works…</h2></div></div></div><p>The base template contains the <code class="literal">&lt;head&gt;</code> and <code class="literal">&lt;body&gt;</code> sections of the HTML document with all the details that are reused on each page of the website. Depending on the web design requirements, you can have additional base templates for different layouts. For example, we added the <code class="literal">base_simple.html</code> file, which has the same HTML <code class="literal">&lt;head&gt;</code> section and<a class="indexterm" id="id210"/> a very minimalistic <code class="literal">&lt;body&gt;</code> section; and it can be used for the login screen, password reset, or other simple pages. You can have separate base templates for single-column, two-column, and three-column layouts, where each of them extends <code class="literal">base.html</code> and overwrites the content of the <code class="literal">&lt;body&gt;</code> section.</p><p>Let's look into the details of the <code class="literal">base.html</code> template that we defined earlier.</p><p>In the <code class="literal">&lt;head&gt;</code> section, we define UTF-8 as the default encoding to support multilingual content. Then, we have the viewport definition that will scale the website in the browser in order to use the full width. This is necessary for small-screen devices that will get specific screen layouts created with the Bootstrap frontend framework. Of course, there is a customizable website title and the favicon will be shown in the browser's tab. We have extendable blocks for meta tags, style sheets, JavaScript, and whatever else that might be necessary for the <code class="literal">&lt;head&gt;</code> section. Note that we load the Bootstrap CSS and JavaScript in the template as we want to have responsive layouts and basic solid predefined styles for all elements. Then, we load the JavaScript jQuery library that efficiently and flexibly allows us to create rich user experiences. We also load JavaScript settings that are rendered from a Django view. You will learn about this in the next recipe.</p><p>In the <code class="literal">&lt;body&gt;</code> section, we have the header with an overwritable navigation and a language chooser. We also have the content block and footer. At the very bottom, there is an extendable block for additional markup or JavaScript.</p><p>The base template that we created is, by no means, a static unchangeable template. You can add to it the elements that you need, for example, Google Analytics code, common JavaScript files, the Apple touch icon for iPhone bookmarks, Open Graph meta tags, Twitter Card tags, schema.org attributes, and so on.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec157"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Including JavaScript settings</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec49"/>Including JavaScript settings</h1></div></div></div><p>Each Django <a class="indexterm" id="id211"/>project has its configuration set in the <code class="literal">conf/base.py</code> or <code class="literal">settings.py</code> settings file. Some of these configuration values also need to be set in JavaScript. As we want a single location to define our project settings, and we don't want to repeat the process when setting the configuration for the JavaScript values, it is a good practice to include a dynamically generated configuration file in the base template. In this recipe, we will see how to do that.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec158"/>Getting ready</h2></div></div></div><p>Make sure <a class="indexterm" id="id212"/>that you have the media, static, and request context processors set in the <code class="literal">TEMPLATE_CONTEXT_PROCESSORS</code> setting, as follows:</p><div><pre class="programlisting">
<strong># conf/base.py or settings.py</strong>
TEMPLATE_CONTEXT_PROCESSORS = (
    "django.contrib.auth.context_processors.auth",
    "django.core.context_processors.debug",
    "django.core.context_processors.i18n",
<strong>    "django.core.context_processors.media",</strong>
<strong>    "django.core.context_processors.static",</strong>
    "django.core.context_processors.tz",
    "django.contrib.messages.context_processors.messages",
<strong>    "django.core.context_processors.request",</strong>
)</pre></div><p>Also, create the <code class="literal">utils</code> app if you haven't done so already and place it under <code class="literal">INSTALLED_APPS</code> in the settings.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec159"/>How to do it…</h2></div></div></div><p>Follow these steps to create and include the JavaScript settings:</p><div><ol class="orderedlist arabic"><li class="listitem">Create a URL rule to call a view that renders JavaScript settings, as follows:<div><pre class="programlisting">
<strong># urls.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.conf.urls import patterns, include, url
from django.conf.urls.i18n import i18n_patterns

urlpatterns = i18n_patterns("",
    # …
    url(r"^js-settings/$", "utils.views.render_js",
        {"template_name": "settings.js"},
        name="js_settings",
    ),
)</pre></div></li><li class="listitem">In the views of your <code class="literal">utils</code> app, create the <code class="literal">render_js()</code> view that returns a response of the JavaScript content type, as shown in the following:<div><pre class="programlisting">
<strong># utils/views.py</strong>
# -*- coding: utf-8 -*-
from __future__ import unicode_literals
from datetime import datetime, timedelta
from django.shortcuts import render
from django.views.decorators.cache import cache_control

@cache_control(public=True)
def render_js(request, cache=True, *args, **kwargs):
    response = render(request, *args, **kwargs)
    response["Content-Type"] = \
        "application/javascript; charset=UTF-8"
    if cache:
        now = datetime.utcnow()
        response["Last-Modified"] = \
            now.strftime("%a, %d %b %Y %H:%M:%S GMT")
        # cache in the browser for 1 month
        expires = now + timedelta(days=31)

        response["Expires"] = \
            expires.strftime("%a, %d %b %Y %H:%M:%S GMT")
    else:
        response["Pragma"] = "No-Cache"
    return response</pre></div></li><li class="listitem">Create a <code class="literal">settings.js</code> template that returns JavaScript with the global settings<a class="indexterm" id="id213"/> variable, as follows:<div><pre class="programlisting">
<strong># templates/settings.js</strong>
window.settings = {
    MEDIA_URL: '{{ MEDIA_URL|escapejs }}',
    STATIC_URL: '{{ STATIC_URL|escapejs }}',
    lang: '{{ LANGUAGE_CODE|escapejs }}',
    languages: { {% for lang_code, lang_name in LANGUAGES %}'{{ lang_code|escapejs }}': '{{ lang_name|escapejs }}'{% if not forloop.last %},{% endif %} {% endfor %} }
};</pre></div></li><li class="listitem">Finally, if you haven't done it yet, include the rendered JavaScript settings file in the base template, as shown in the following:<div><pre class="programlisting">
<strong># templates/base.html</strong>
&lt;script src="img/{% url "js_settings" %}"&gt;&lt;/script&gt;</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec160"/>How it works…</h2></div></div></div><p>The Django template system is very flexible; you are not limited to using templates just for HTML. In this example, we will dynamically create the JavaScript file. You can access it in your development web server at <code class="literal">http://127.0.0.1:8000/en/js-settings/</code> and its content will be something similar to the following:</p><div><pre class="programlisting">window.settings = {
    MEDIA_URL: '/media/',
    STATIC_URL: '/static/20140424140000/',
    lang: 'en',
    languages: { 'en': 'English', 'de': 'Deutsch', 'fr': 'Français', 'lt': 'Lietuvi kalba' }
};</pre></div><p>The view <a class="indexterm" id="id214"/>will be cacheable in both server and browser.</p><p>If you want to pass more variables to the JavaScript settings, either create a custom view and pass all the values to the context or create a custom context processor and pass all the values there. In the latter case, the variables will also be accessed in all the templates of your project. For example, you might have indicators such as <code class="literal">{{ is_mobile }}</code>, <code class="literal">{{ is_tablet }}</code>, and <code class="literal">{{ is_desktop }}</code> in your templates, with the user agent string telling whether the visitor uses a mobile, tablet, or desktop browser.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec161"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Arranging the base.html template</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Using HTML5 data attributes</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec50"/>Using HTML5 data attributes</h1></div></div></div><p>When you have dynamic data related to the DOM elements, you need a more efficient way to pass the <a class="indexterm" id="id215"/>values from Django to JavaScript. In this recipe, we will see a way to attach data from Django to custom HTML5 data attributes and then describe how to read the data from JavaScript with two practical examples. The first example will be an image that changes its source, depending on the viewport, so that the smallest version is shown on mobile devices, the medium-sized version is shown on tablets, and the biggest high-quality image is shown for the desktop version of the website. The second example will be a Google Map with a marker at a specified geographical position.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec162"/>Getting ready</h2></div></div></div><p>To get started, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Create a <code class="literal">locations</code> app with a <code class="literal">Location</code> model, which will at least have the title character field, the slug field for URLs, the <code class="literal">small_image</code>, <code class="literal">medium_image</code>, and <code class="literal">large_image</code> image fields, and the latitude and longitude floating-point fields.<div><div><h3 class="title"><a id="tip12"/>Tip</h3><p>The term <em>slug</em> comes from newspaper editing and it means a short string without any special characters; just letters, numbers, underscores, and hyphens. Slugs are generally used to create unique URLs.</p></div></div></li><li class="listitem">Create an administration for this model and enter a sample location.</li><li class="listitem">Lastly, create a detailed view for the location and set the URL rule for it.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec163"/>How to do it…</h2></div></div></div><p>Perform the<a class="indexterm" id="id216"/> following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">As we already have the app created, we will now need the template for the location detail:<div><pre class="programlisting">
<strong>{# templates/locations/location_detail.html #}</strong>
{% extends "base.html" %}

{% block content %}
  &lt;h2&gt;{{ location.title }}&lt;/h2&gt;

  &lt;img class="img-full-width"
    src="img/{{ location.small_image.url }}"
    data-small-src="img/{{ location.small_image.url }}"
    data-medium-src="img/{{ location.medium_image.url }}"
    data-large-src="img/{{ location.large_image.url }}"
    alt="{{ location.title|escape }}"
  /&gt;

  &lt;div id="map"
    data-latitude="{{ location.latitude|stringformat:"f" }}"
    data-longitude="{{ location.longitude|stringformat:"f" }}"
  &gt;&lt;/div&gt;
{% endblock %}

{% block extrabody %}
  &lt;script src="img/js?v=3"&gt;&lt;/script&gt;
  &lt;script src="img/location_detail.js"&gt;&lt;/script&gt;
{% endblock %}</pre></div></li><li class="listitem">Besides the template, we need the JavaScript file that will read out the HTML5 data <a class="indexterm" id="id217"/>attributes and use them accordingly, as follows:<div><pre class="programlisting">//site_static/site/js/location_detail.js
jQuery(function($) {

function show_best_images() {
  $('img.img-full-width').each(function() {
    var $img = $(this);
    if ($img.width() &gt; 1024) {
      $img.attr('src', $img.data('large-src'));
    } else if ($img.width() &gt; 468) {
      $img.attr('src', $img.data('medium-src'));
    } else {
      $img.attr('src', $img.data('small-src'));
    }
  });
}

function show_map() {
  var $map = $('#map');
  var latitude = parseFloat($map.data('latitude'));
  var longitude = parseFloat($map.data('longitude'));
  var latlng = new google.maps.LatLng(latitude, longitude);

  var map = new google.maps.Map($map.get(0), {
    zoom: 15,
    center: latlng
  });
  var marker = new google.maps.Marker({
    position: latlng,
    map: map
  });
}show_best_images();show_map();

$(window).on('resize', show_best_images);

});</pre></div></li><li class="listitem">Finally, we need to set some CSS, as shown in the following:<div><pre class="programlisting">/* site_static/site/css/style.css */
img.img-full-width {
    width: 100%;
}
#map {
    height: 300px;
}</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec164"/>How it works…</h2></div></div></div><p>If you open <a class="indexterm" id="id218"/>your location detail view in a browser, you will see something similar to the following in the large window:</p><div><img alt="How it works…" src="img/B04912_04_01.jpg"/></div><p>If you resize the browser window to 468 pixels or less, the image will change to its smallest <a class="indexterm" id="id219"/>version, as shown in the following:</p><div><img alt="How it works…" src="img/B04912_04_02.jpg"/></div><p>Let's take a look at the code. In the template, we have an image tag with an <code class="literal">img-full-width</code> CSS class and its source is set to the smallest image by default. This <code class="literal">image</code> tag also has <code class="literal">data-small-src</code>, <code class="literal">data-medium-src</code>, and <code class="literal">data-large-src</code> custom attributes. In the JavaScript, the <code class="literal">show_best_images()</code> function is called when the page is loaded or the window is resized. The function goes through all images with the <code class="literal">img-full-width</code> CSS class and sets appropriate image sources from the custom data attributes, depending on the current image width.</p><p>Then, there is a <code class="literal">&lt;div&gt;</code> element with the map ID and the <code class="literal">data-latitude</code> and <code class="literal">data-longitude</code> custom attributes in the template. In the JavaScript, a <code class="literal">show_map()</code> function is called when the page is loaded. This function will create a Google Map in the <code class="literal">&lt;div&gt;</code> element. At first, the custom attributes are read and converted from strings to floating-point values. Then, the <code class="literal">LatLng</code> object is created that, in the next steps, becomes the center of the <a class="indexterm" id="id220"/>map and the geographical position of the marker shown on this map.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec165"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Including JavaScript settings</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Opening object details in a modal dialog</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Inserting a map into a change form</em> recipe in <a class="link" href="ch06.html" title="Chapter 6. Model Administration">Chapter 6</a>, <em>Model Administration</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec51"/>Opening object details in a modal dialog</h1></div></div></div><p>In this recipe, we will create a list of links to the locations, which when clicked, opens a Bootstrap 3 modal dialog (we will call it pop up in this recipe) with some information about the <a class="indexterm" id="id221"/>location and the <em>more…</em> link leading to the location detail page. The content for the dialog will be loaded by Ajax. For visitors without JavaScript, the detail page will open immediately, without this intermediate step.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec166"/>Getting ready</h2></div></div></div><p>Let's start with the <code class="literal">locations</code> app that we created in the previous recipe.</p><p>In the <code class="literal">urls.py</code> file, we will have three URL rules; one for the location list, other for the location detail, and the third one for the dialog, as follows:</p><div><pre class="programlisting">
<strong># locations/urls.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.conf.urls import patterns, url

urlpatterns = patterns("locations.views",
    url(r"^$", "location_list", name="location_list"),
    url(r"^(?P&lt;slug&gt;[^/]+)/$", "location_detail",
        name="location_detail"),
    url(r"^(?P&lt;slug&gt;[^/]+)/popup/$", "location_detail_popup",
        name="location_detail_popup"),
)</pre></div><p>Consequently, there will be three simple views, as shown in the following:</p><div><pre class="programlisting"># locations/views.py
from __future__ import unicode_literals
# -*- coding: UTF-8 -*-
from django.shortcuts import render, get_object_or_404
from .models import Location

def location_list(request):
  location_list = Location.objects.all()
  return render(request, "locations/location_list.html",
    {"location_list": location_list})

def location_detail(request, slug):
  location = get_object_or_404(Location, slug=slug)
  return render(request, "locations/location_detail.html",
    {"location": location})

def location_detail_popup(request, slug):
  location = get_object_or_404(Location, slug=slug)
  return render(request, "locations/location_detail_popup.html",
    {"location": location})</pre></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec167"/>How to do it…</h2></div></div></div><p>Execute <a class="indexterm" id="id222"/>these steps one by one:</p><div><ol class="orderedlist arabic"><li class="listitem">Create a template for the location's list view with a hidden empty modal dialog at the end. Each listed location will have custom HTML5 data attributes dealing with the pop-up information, as follows:<div><pre class="programlisting">
<strong>{# templates/locations/location_list.html #}</strong>
{% extends "base.html" %}
{% load i18n %}

{% block content %}
    &lt;h2&gt;{% trans "Locations" %}&lt;/h2&gt;
    &lt;ul&gt;
        {% for location in location_list %}
            &lt;li class="item"&gt;
                &lt;a href="{% url "location_detail" slug=location.slug %}"
                data-popup-url="{% url "location_detail_popup" slug=location.slug %}"
                data-popup-title="{{ location.title|escape }}"&gt;
                    {{ location.title }}
                &lt;/a&gt;
            &lt;/li&gt;
        {% endfor %}
    &lt;/ul&gt;
{% endblock %}

{% block extrabody %}
    &lt;div id="popup" class="modal fade"&gt;
        &lt;div class="modal-dialog"&gt;
            &lt;div class="modal-content"&gt;
                &lt;div class="modal-header"&gt;
                    &lt;button type="button" class="close" data-dismiss="modal" aria-hidden="true"&gt;&amp;times;&lt;/button&gt;
                    &lt;h4 class="modal-title"&gt;Modal title&lt;/h4&gt;
                &lt;/div&gt;
                &lt;div class="modal-body"&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;script src="img/location_list.js"&gt;&lt;/script&gt;
{% endblock %}</pre></div></li><li class="listitem">We need <a class="indexterm" id="id223"/>JavaScript to handle the opening of the dialog and loading the content dynamically:<div><pre class="programlisting">
<strong>// site_static/site/js/location_list.js</strong>
jQuery(function($) {
    var $popup = $('#popup');

   
    $('body').on('click', '.item a', function(e) {
        e.preventDefault();
        var $link = $(this);
        var popup_url = $link.data('popup-url');
        var popup_title = $link.data('popup-title');

        if (!popup_url) {
            return true;
        }
        $('.modal-title', $popup).html(popup_title);
        $('.modal-body', $popup).load(popup_url, function() {
            $popup.on('shown.bs.modal', function () {
                // do something when dialog is shown
            }).modal("show");
        });

        $('.close', $popup).click(function() {
            // do something when dialog is closing
        });


    });
});</pre></div></li><li class="listitem">Finally, we<a class="indexterm" id="id224"/> will create a template for the content that will be loaded in the modal dialog, as shown in the following:<div><pre class="programlisting">
<strong>{# templates/locations/location_detail_popup.html #}</strong>
{% load i18n %}
&lt;p&gt;&lt;img src="img/{{ location.small_image.url }}" alt="{{ location.title|escape }}" /&gt;&lt;/p&gt;

&lt;p class="clearfix"&gt;
    &lt;a href="{% url "location_detail" slug=location.slug %}"
    class="btn btn-default pull-right"&gt;
        {% trans "More" %}
        &lt;span class="glyphicon glyphicon-chevron-right"&gt;&lt;/span&gt;
    &lt;/a&gt;
&lt;/p&gt;</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec168"/>How it works…</h2></div></div></div><p>If we go to the location's list view in a browser and click on one of the locations, we will see a modal dialog similar to the following:</p><div><img alt="How it works…" src="img/B04912_04_03.jpg"/></div><p>How does<a class="indexterm" id="id225"/> this work? In the template, there is a <code class="literal">&lt;div&gt;</code> element with the <code class="literal">item</code> CSS class and a link for each location. The links have the <code class="literal">data-popup-url</code> and <code class="literal">data-popup-title</code> custom attributes. In the JavaScript, when the page is loaded, we assign an <code class="literal">onclick</code> handler for the <code class="literal">&lt;body&gt;</code> tag. The handler checks if any link inside the tag with the <code class="literal">item</code> CSS class was clicked. For each such clicked link the custom attributes are read as <code class="literal">popup_url</code>  and <code class="literal">popup_title</code>, the new title is set for the hidden dialog box, the content is loaded in the modal dialog using Ajax, and then it is shown to the visitor.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec169"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Using HTML5 data attributes</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Implementing a continuous scroll</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Implementing the Like widget</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec52"/>Implementing a continuous scroll</h1></div></div></div><p>Social websites often have the feature of continuous scrolling, which is also known as infinite scrolling. There are long lists of items and as you scroll the page down, new items are loaded <a class="indexterm" id="id226"/>and attached to the bottom automatically. In this recipe, we will see how to achieve such an effect with Django and the jScroll jQuery plugin. We'll illustrate this using a sample view showing the top 250 movies of all time from Internet Movie Database (<a class="ulink" href="http://www.imdb.com/">http://www.imdb.com/</a>).</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec170"/>Getting ready</h2></div></div></div><p>First, download<a class="indexterm" id="id227"/> the jScroll plugin from the following link: <a class="ulink" href="https://github.com/pklauzinski/jscroll">https://github.com/pklauzinski/jscroll</a>.</p><p>Put the <code class="literal">jquery.jscroll.js</code> and <code class="literal">jquery.jscroll.min.js</code> files from the package in the <code class="literal">myproject/site_static/site/js/</code> directory.</p><p>Next, for this example, you will create a <code class="literal">movies</code> app with a paginated list view for the movies. You can either create a <code class="literal">Movie</code> model or a list of dictionaries with the movie data. Every movie will have rank, title, release year, and rating fields.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec171"/>How to do it…</h2></div></div></div><p>Perform the following steps to create an continuously scrolling page:</p><div><ol class="orderedlist arabic"><li class="listitem">The first step is to create a template for the list view that will also show a link to the next page, as follows:<div><pre class="programlisting">
<strong>{# templates/movies/movie_list.html #}</strong>
{% extends "base.html" %}
{% load i18n utility_tags %}

{% block content %}
    &lt;h2&gt;{% trans "Top Movies" %}&lt;/h2&gt;
    &lt;div class="object_list"&gt;
        {% for movie in object_list %}
            &lt;div class="item"&gt;
                &lt;p&gt;{{ movie.rank }}.
                    &lt;strong&gt;{{ movie.title }}&lt;/strong&gt;
                    ({{ movie.year }})
                    &lt;span class="badge"&gt;{% trans "IMDB rating" %}: {{ movie.rating }}&lt;/span&gt;
                &lt;/p&gt;
            &lt;/div&gt;
        {% endfor %}
        {% if object_list.has_next %}
            &lt;p class="pagination"&gt;<strong>&lt;a class="next_page" href="{% modify_query page=object_list.next_page_number %}"&gt;{% trans "More…" %}&lt;/a&gt;</strong>&lt;/p&gt;
        {% endif %}
    &lt;/div&gt;
{% endblock %}

{% block extrabody %}
    &lt;script src="img/jquery.jscroll.min.js"&gt;&lt;/script&gt;
    &lt;script src="img/list.js"&gt;&lt;/script&gt;
{% endblock %}</pre></div></li><li class="listitem">The second step is to add JavaScript, as shown in the following:<div><pre class="programlisting">
<strong>// site_static/site/js/list.js</strong>
jQuery(function($) {
    $('.object_list').jscroll({
        loadingHtml: '&lt;img src="img/loading.gif" alt="Loading" /&gt;',
        padding: 100,
        pagingSelector: '.pagination',
        nextSelector: 'a.next_page:last',
        contentSelector: '.item,.pagination'
    });
});</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec172"/>How it works…</h2></div></div></div><p>When you <a class="indexterm" id="id228"/>open the movie list view in a browser; a predefined number of items, for example, 25, is shown on the page. As you scroll down, an additional 25 items and the next pagination link are loaded and appended to the item container. Then, the third page of the items is loaded and attached at the bottom, and this continues until there are no more pages left to display.</p><p>Upon the page load, the <code class="literal">&lt;div&gt;</code> tag in JavaScript that has the <code class="literal">object_list</code> CSS class and contains the items and pagination links will become a jScroll object. The following parameters define its features:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">loadingHtml</code>: This sets an animated loading indicator shown at the end of the list when a new page is loading</li><li class="listitem" style="list-style-type: disc"><code class="literal">padding</code>: This will define that the new page has to be loaded, when there are 100 pixels between the scrolling position and the end of the scrolling area</li><li class="listitem" style="list-style-type: disc"><code class="literal">pagingSelector</code>: This CSS selector finds the HTML elements that will be hidden in the browsers with JavaScript switched on</li><li class="listitem" style="list-style-type: disc"><code class="literal">nextSelector</code>: This CSS selector finds the HTML elements that will be used to read the URL of the next page</li><li class="listitem" style="list-style-type: disc"><code class="literal">contentSelector</code>: This CSS selector defines the HTML elements to be taken out <a class="indexterm" id="id229"/>of the loaded content and put in the container</li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec173"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Managing paginated lists</em> recipe in <a class="link" href="ch03.html" title="Chapter 3. Forms and Views">Chapter 3</a>, <em>Forms and Views</em></li><li class="listitem" style="list-style-type: disc">The <em>Composing class-based views</em> recipe in <a class="link" href="ch03.html" title="Chapter 3. Forms and Views">Chapter 3</a>, <em>Forms and Views</em></li><li class="listitem" style="list-style-type: disc">The <em>Including JavaScript settings</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec53"/>Implementing the Like widget</h1></div></div></div><p>Nowadays, social websites usually have integrated Facebook, Twitter, and Google+ widgets to like <a class="indexterm" id="id230"/>and share pages. In this recipe, I will guide you through a similar internal liking Django app that saves all the likes in your database so that you can create specific views based on the things that are liked on your website. We will create a Like widget with a two-state button and badge showing the number of total likes. The following are the states:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Inactive state, where you can click on a button to activate it:<div><img alt="Implementing the Like widget" src="img/B04912_04_04.jpg"/></div></li><li class="listitem" style="list-style-type: disc">Active state, where you can click on a button to deactivate it:<div><img alt="Implementing the Like widget" src="img/B04912_04_05.jpg"/></div></li></ul></div><p>The state of the widget will be handled by Ajax calls.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec174"/>Getting ready</h2></div></div></div><p>First, create a <code class="literal">likes</code> app with a <code class="literal">Like</code> model, which has a foreign-key relation to the user that is liking <a class="indexterm" id="id231"/>something and a generic relationship to any object in the database. We will use <code class="literal">ObjectRelationMixin</code>, which we defined in the <em>Creating a model mixin to handle generic relations</em> recipe in <a class="link" href="ch02.html" title="Chapter 2. Database Structure">Chapter 2</a>, <em>Database Structure</em>. If you don't want to use the mixin, you can also define a generic relation in the following model yourself:</p><div><pre class="programlisting"># likes/models.py
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.db import models
from django.utils.translation import ugettext_lazy as _
from django.conf import settings
from django.utils.encoding import python_2_unicode_compatible
from utils.models import CreationModificationDateMixin
from utils.models import object_relation_mixin_factory

@python_2_unicode_compatible
class Like(CreationModificationDateMixin,
object_relation_mixin_factory(is_required=True)):
    user = models.ForeignKey(settings.AUTH_USER_MODEL)

    class Meta:
        verbose_name = _("like")
        verbose_name_plural = _("likes")
        ordering = ("-created",)

    def __str__(self):
        return _(u"%(user)s likes %(obj)s") % {
            "user": self.user,
            "obj": self.content_object,
        }</pre></div><p>Also, make sure that the request context processor is set in the settings. We also need an authentication middleware in the settings for the currently logged-in user attached to the request:</p><div><pre class="programlisting">
<strong># conf/base.py or settings.py</strong>
TEMPLATE_CONTEXT_PROCESSORS = (
    # …
    "django.core.context_processors.request",
)
MIDDLEWARE_CLASSES = (
    # …
    "django.contrib.auth.middleware.AuthenticationMiddleware",
)</pre></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec175"/>How to do it…</h2></div></div></div><p>Execute<a class="indexterm" id="id232"/> these steps one by one:</p><div><ol class="orderedlist arabic"><li class="listitem">In the <code class="literal">likes</code> app, create a <code class="literal">templatetags</code> directory with an empty <code class="literal">__init__.py</code> file in order to make it a Python module. Then, add the <code class="literal">likes_tags.py</code> file, where we'll define the <code class="literal">{% like_widget %}</code> template tag as follows:<div><pre class="programlisting"># likes/templatetags/likes_tags.py
# -*- coding: UTF-8 -*-
from django import template
from django.contrib.contenttypes.models import ContentType
from django.template import loader

from likes.models import Like

register = template.Library()

### TAGS ###

@register.tag
def like_widget(parser, token):
    try:
        tag_name, for_str, obj = token.split_contents()
    except ValueError:
        raise template.TemplateSyntaxError, \
            "%r tag requires a following syntax: " \
            "{%% %r for &lt;object&gt; %%}" % (
                token.contents[0], token.contents[0])
    return ObjectLikeWidget(obj)

class ObjectLikeWidget(template.Node):
    def __init__(self, obj):
        self.obj = obj
       
    def render(self, context):
        obj = template.resolve_variable(self.obj, context)
        ct = ContentType.objects.get_for_model(obj)
       
        is_liked_by_user = bool(Like.objects.filter(
            user=context["request"].user,
            content_type=ct,
            object_id=obj.pk,
        ))
       
        context.push()
        context["object"] = obj
        context["content_type_id"] = ct.pk
        context["is_liked_by_user"] = is_liked_by_user
        context["count"] = get_likes_count(obj)
       
        output = loader.render_to_string(
            "likes/includes/like.html", context)
        context.pop()
        return output</pre></div></li><li class="listitem">Also, we'll <a class="indexterm" id="id233"/>add a filter in the same file to get the number of likes for a specified object:<div><pre class="programlisting">### FILTERS ###

@register.filter
def get_likes_count(obj):
    ct = ContentType.objects.get_for_model(obj)
    return Like.objects.filter(
        content_type=ct,
        object_id=obj.pk,
    ).count()</pre></div></li><li class="listitem">In the URL rules, we need a rule for a view, which will handle the liking and unliking using Ajax:<div><pre class="programlisting">
<strong># likes/urls.py</strong>
# -*- coding: UTF-8 -*-
from django.conf.urls import patterns, url

urlpatterns = patterns("likes.views",
       
   url(r"^(?P&lt;content_type_id&gt;[^/]+)/(?P&lt;object_id&gt;[^/]+)/$",
        "json_set_like", name="json_set_like"),
)</pre></div></li><li class="listitem">Then, we need to define the view, as shown in the following:<div><pre class="programlisting">
<strong># likes/views.py</strong>
# -*- coding: UTF-8 -*-
import json
from django.http import HttpResponse
from django.views.decorators.cache import never_cache
from django.contrib.contenttypes.models import ContentType
from django.shortcuts import render
from django.views.decorators.csrf import csrf_exempt

from .models import Like
from .templatetags.likes_tags import get_likes_count

@never_cache
@csrf_exempt
def json_set_like(request, content_type_id, object_id):
    """
    Sets the object as a favorite for the current user
    """
    result = {
        "success": False,
    }
    if request.user.is_authenticated() and \
    request.method == "POST":
        content_type = ContentType.objects.get(id=content_type_id)
        obj = content_type.get_object_for_this_type(pk=object_id)
        like, is_created = Like.objects.get_or_create(
            content_type=ContentType.objects.get_for_model(obj),
            object_id=obj.pk,
            user=request.user,
        )
        if not is_created:
            like.delete()
        result = {
            "success": True,
            "obj": unicode(obj),
            "action": is_created and "added" or "removed",
            "count": get_likes_count(obj),
        }
    json_str = json.dumps(result, ensure_ascii=False,
            encoding="utf8")
    return HttpResponse(json_str,
    mimetype="application/json; charset=utf-8")</pre></div></li><li class="listitem">In the<a class="indexterm" id="id234"/> template for the list or detail view of any object, we can add the template tag for the widget. Let's add the widget to the location detail that we created in the previous recipes, as follows:<div><pre class="programlisting">
<strong>{# templates/locations/location_detail.html #}</strong>
{% extends "base.html" %}
{% load likes_tags %}

{% block content %}
    {% if request.user.is_authenticated %}
        {% like_widget for location %}
    {% endif %}
    {# the details of the object go here… #}
{% endblock %}

{% block extrabody %}
    &lt;script src="img/likes.js"&gt;&lt;/script&gt;
{% endblock %}</pre></div></li><li class="listitem">Then, we<a class="indexterm" id="id235"/> need a template for the widget, as shown in the following:<div><pre class="programlisting">
<strong>{# templates/likes/includes/like.html #}</strong>
{% load i18n %}
&lt;div class="like-widget"&gt;
    &lt;button type="button" class="like-button btn btn-default {% if is_liked_by_user %} active{% endif %}"
        data-href="{% url "json_set_like" content_type_id=content_type_id object_id=object.pk %}"
        data-like-text="{% trans "Like" %}"
        data-unlike-text="{% trans "Unlike" %}"
    &gt;
        {% if is_liked_by_user %}
            &lt;span class="glyphicon glyphicon-star"&gt;&lt;/span&gt;
            {% trans "Unlike" %}
        {% else %}
            &lt;span class="glyphicon glyphicon-star-empty"&gt;&lt;/span&gt;
            {% trans "Like" %}
        {% endif %}
    &lt;/button&gt;
    &lt;span class="like-badge badge"&gt;{{ count }}&lt;/span&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Finally, we create JavaScript to handle the liking and unliking action in the browser, as follows:<div><pre class="programlisting">
<strong>// site_static/site/js/likes.js</strong>
(function($) {
    $(document).on('click', '.like-button', function() {
        var $button = $(this);
        var $badge = $button.closest('.like-widget')
            .find('.like-badge');
        $.post($button.data('href'), function(data) {
            if (data['action'] == 'added') {
                $button.addClass('active').html(
'&lt;span class="glyphicon glyphicon-star"&gt;&lt;/span&gt; ' +
$button.data('unlike-text')
                );
            } else {
                $button.removeClass('active').html(
'&lt;span class="glyphicon glyphicon-star-empty"&gt;&lt;/span&gt; ' +
$button.data('like-text')
                );
            }
            $badge.html(data['count']);
        }, 'json');
    });
})(jQuery);</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec176"/>How it works…</h2></div></div></div><p>For any<a class="indexterm" id="id236"/> object in your website, you can put the <code class="literal">{% like_widget for object %}</code> template tag that will check whether the object is already liked and will show an appropriate state. The <code class="literal">data-href</code>, <code class="literal">data-like-text</code>, and <code class="literal">data-unlike-text</code> custom HTML5 attributes are in the widget template. The first attribute holds a unique object-specific URL to change the current state of the widget. The other two attributes hold the translated texts for the widget. In the JavaScript, liking buttons are recognized by the like button CSS class. A click-event listener attached to the document watches for the <code class="literal">onClick</code> events from each such button and then posts an Ajax call to the URL that is specified by the <code class="literal">data-href</code> attribute. The specified view accepts two of the parameters, content type and object ID, of the liked object. The view checks whether <code class="literal">Like</code> for the specified object exists, and if it does, the view removes it; otherwise the <code class="literal">Like</code> object is added. As a result, the view returns a JSON response with the success status, liked object's text representation, the action whether the <code class="literal">Like</code> object was added or removed, and the total number of likes. Depending on the action that is returned, JavaScript will show an appropriate state for the button.</p><p>You can debug the Ajax responses in the Chrome Developer Tools or Firefox Firebug plugin. If any server errors occur while developing, you will see the error trace back in the preview of the response, otherwise you will see the returned JSON as shown in the following screenshot:</p><div><img alt="How it works…" src="img/B04912_04_06.jpg"/></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec177"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <a class="indexterm" id="id237"/><em>Opening object details in a modal dialog</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Implementing a continuous scroll</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Uploading images by Ajax</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Creating a model mixin to handle generic relations</em> recipe in <a class="link" href="ch02.html" title="Chapter 2. Database Structure">Chapter 2</a>, <em>Database Structure</em></li><li class="listitem" style="list-style-type: disc"><a class="link" href="ch05.html" title="Chapter 5. Custom Template Filters and Tags">Chapter 5</a>, <em>Custom Template Filters and Tags</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec54"/>Uploading images by Ajax</h1></div></div></div><p>File uploads <a class="indexterm" id="id238"/>using Ajax has become the de facto standard on the <a class="indexterm" id="id239"/>web. People want to see what they have chosen right after selecting a file instead of seeing it after submitting a form. Also, if the form has validation errors, nobody wants to select the files again; the file should still be selected in the form with validation errors.</p><p>There is a third-party app, <code class="literal">django-ajax-uploader</code>, that can be used to upload images with Ajax. In this recipe, we will see how to do this.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec178"/>Getting ready</h2></div></div></div><p>Let's start with the <code class="literal">quotes</code> app that we created for the <em>Uploading images</em> recipe in <a class="link" href="ch03.html" title="Chapter 3. Forms and Views">Chapter 3</a>, <em>Forms and Views</em>. We will reuse the model and view; however, we'll create a different form and template and add JavaScript too.</p><p>Install <code class="literal">django-crispy-forms</code> and <code class="literal">django-ajax-uploader</code> in your local environment using the following commands:</p><div><pre class="programlisting">
<strong>(myproject)$ pip install django-crispy-forms</strong>
<strong>(myproject)$ pip install ajaxuploader</strong>
</pre></div><p>Don't forget<a class="indexterm" id="id240"/> to put these apps in <code class="literal">INSTALLED_APPS</code>, as follows:</p><div><pre class="programlisting">
<strong># conf/base.py or settings.py</strong>
INSTALLED_APPS = (
    # …
    "quotes",
    "crispy_forms",
    "ajaxuploader",
)</pre></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec179"/>How to do it…</h2></div></div></div><p>Let's redefine<a class="indexterm" id="id241"/> the form for inspirational quotes using the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">First, we create a layout for the Bootstrap 3 markup. Note that, instead of the <code class="literal">picture</code> image field, we have the hidden <code class="literal">picture_path</code> and <code class="literal">delete_picture</code> fields and some markup for the file upload widget:<div><pre class="programlisting">
<strong># quotes/forms.py</strong>
# -*- coding: UTF-8 -*-
import os
from django import forms
from django.utils.translation import ugettext_lazy as _
from django.core.files import File
from django.conf import settings
from crispy_forms.helper import FormHelper
from crispy_forms import layout, bootstrap
from .models import InspirationQuote

class InspirationQuoteForm(forms.ModelForm):
<strong>    picture_path = forms.CharField(</strong>
<strong>        max_length=255,</strong>
<strong>        widget=forms.HiddenInput(),</strong>
<strong>        required=False,</strong>
<strong>    )</strong>
<strong>    delete_picture = forms.BooleanField(</strong>
<strong>        widget=forms.HiddenInput(),</strong>
<strong>        required=False,</strong>
<strong>    )</strong>

    class Meta:
        model = InspirationQuote
        fields = ["author", "quote"]

    def __init__(self, *args, **kwargs):
                super(InspirationQuoteForm, self).\
            __init__(*args, **kwargs)

        self.helper = FormHelper()
        self.helper.form_action = ""
        self.helper.form_method = "POST"

        self.helper.layout = layout.Layout(
            layout.Fieldset(
                _("Quote"),
                layout.Field("author"),
                layout.Field("quote", rows=3),               
<strong>                layout.HTML("""</strong>
<strong>    {% include "quotes/includes/image_upload_widget.html" %}</strong>
                """),
                layout.Field("picture_path"), # hidden
                layout.Field("delete_picture"), # hidden
            ),
            bootstrap.FormActions(
                layout.Submit("submit", _("Save"),
                    css_class="btn btn-primary"),
            )
        )</pre></div></li><li class="listitem">Then, we<a class="indexterm" id="id242"/> will overwrite the save method in order to <a class="indexterm" id="id243"/>handle the saving of the inspirational quote, as follows:<div><pre class="programlisting">    def save(self, commit=True):
        instance = super(InspirationQuoteForm, self).\
            save(commit=True)

        if self.cleaned_data['delete_picture'] and \
            instance.picture:
            instance.picture.delete()

        if self.cleaned_data['picture_path']:
            tmp_path = self.cleaned_data['picture_path']
            abs_tmp_path = os.path.join(
                settings.MEDIA_ROOT, tmp_path)

            filename = InspirationQuote._meta.\
                get_field('picture').upload_to(
                instance, tmp_path)
            instance.picture.save(
                filename,
                File(open(abs_tmp_path, "rb")),
                False
            )

            os.remove(abs_tmp_path)
        instance.save()
        return instance</pre></div></li><li class="listitem">In addition<a class="indexterm" id="id244"/> to the previously defined views in the <a class="indexterm" id="id245"/>quotes app, we add the <code class="literal">ajax_uploader</code> view that will handle uploads with Ajax, as shown in the following:<div><pre class="programlisting">
<strong># quotes/views.py</strong>
# …
from ajaxuploader.views import AjaxFileUploader
ajax_uploader = AjaxFileUploader()</pre></div></li><li class="listitem">Then, we set the URL rule for the view, as follows:<div><pre class="programlisting">
<strong># quotes/urls.py</strong>
# -*- coding: UTF-8 -*-
from django.conf.urls import patterns, url

urlpatterns = patterns("",
    # …
    url(r"^ajax-upload/$", "quotes.views.ajax_uploader",
        name="ajax_uploader"),
)</pre></div></li><li class="listitem">Next, create the <code class="literal">image_upload_widget.html</code> template that will be included in the crispy form:<div><pre class="programlisting">
<strong>{# templates/quotes/includes/image_upload_widget.html #}</strong>
{% load i18n %}
&lt;div id="image_upload_widget"&gt;
    &lt;div class="preview"&gt;
        {% if instance.picture %}
            &lt;img src="img/{{ instance.picture.url }}" alt="" /&gt;
        {% endif %}
    &lt;/div&gt;
    &lt;div class="uploader"&gt;
        &lt;noscript&gt;
            &lt;p&gt;{% trans "Please enable JavaScript to use file uploader." %}&lt;/p&gt;
        &lt;/noscript&gt;
    &lt;/div&gt;
    &lt;p class="help_text" class="help-block"&gt;{% trans "Available formats are JPG, GIF, and PNG." %}&lt;/p&gt;
    &lt;div class="messages"&gt;&lt;/div&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Then, it is time to create the template for the form page itself. In the extrabody<a class="indexterm" id="id246"/> block, we will set a <code class="literal">translatable_file_uploader_options</code> variable that will deal with all translatable <a class="indexterm" id="id247"/>options for the file uploader, such as the widget template markup, error messages, and notifications:<div><pre class="programlisting">
<strong>{# templates/quotes/change_quote.html #}</strong>
{% extends "base.html" %}
{% load i18n crispy_forms_tags %}

{% block stylesheet %}
    {{ block.super }}
    &lt;link rel="stylesheet" href="{{ STATIC_URL }}ajaxuploader/css/fileuploader.css" /&gt;
{% endblock %}

{% block content %}
    {% crispy form %}
{% endblock %}

{% block extrabody %}
    &lt;script src="img/fileuploader.js"&gt;&lt;/script&gt;
    &lt;script&gt;
        var translatable_file_uploader_options = {
            template: '&lt;div class="qq-upload-drop-area"&gt;&lt;span&gt;{% trans "Drop image here" %}&lt;/span&gt;&lt;/div&gt;' +
                '&lt;div class="qq-uploader"&gt;' +
                '&lt;div class="qq-upload-button btn"&gt;&lt;span class="glyphicon glyphicon-upload"&gt;&lt;/span&gt;  {% trans "Upload Image" %}&lt;/div&gt;' +
                '&amp;nbsp;&lt;button class="btn btn-danger qq-delete-button"&gt;&lt;span class="glyphicon glyphicon-trash"&gt;&lt;/span&gt; {% trans "Delete" %}&lt;/button&gt;' +
                '&lt;ul class="qq-upload-list"&gt;&lt;/ul&gt;' +
            '&lt;/div&gt;',
            // template for one item in file list
            fileTemplate: '&lt;li&gt;' +
                '&lt;span class="qq-upload-file"&gt;&lt;/span&gt;' +
                '&lt;span class="qq-upload-spinner"&gt;&lt;/span&gt;' +
                '&lt;span class="qq-upload-size"&gt;&lt;/span&gt;' +
                '&lt;a class="qq-upload-cancel" href="#"&gt;{% trans "Cancel" %}&lt;/a&gt;' +
                '&lt;span class="qq-upload-failed-text"&gt;{% trans "Failed" %}&lt;/span&gt;' +
            '&lt;/li&gt;',
            messages: {
                typeError: '{% trans "{file} has invalid extension. Only {extensions} are allowed." %}',
                sizeError: '{% trans "{file} is too large, maximum file size is {sizeLimit}." %}',
                minSizeError: '{% trans "{file} is too small, minimum file size is {minSizeLimit}." %}',
                emptyError: '{% trans "{file} is empty, please select files again without it." %}',
                filesLimitError: '{% trans "No more than {filesLimit} files are allowed to be uploaded." %}',
                onLeave: '{% trans "The files are being uploaded, if you leave now the upload will be cancelled." %}'
            }
        };
        var ajax_uploader_path = '{% url "ajax_uploader" %}';
    &lt;/script&gt;
    &lt;script src="img/change_quote.js"&gt;&lt;/script&gt;
{% endblock %}</pre></div></li><li class="listitem">Finally, we <a class="indexterm" id="id248"/>create the JavaScript file that will initialize<a class="indexterm" id="id249"/> the file upload widget and handle the image preview and deletion, as follows:<div><pre class="programlisting">
<strong>// site_static/site/js/change_quote.js</strong>
$(function() {
    var csrfmiddlewaretoken = $('input[name="csrfmiddlewaretoken"]').val();
    var $image_upload_widget = $('#image_upload_widget');
    var current_image_path = $('#id_picture_path').val();
    if (current_image_path) {
        $('.preview', $image_upload_widget).html(
            '&lt;img src="img/' + window.settings.MEDIA_URL + current_image_path  + '" alt="" /&gt;'
        );
    }
    var options = $.extend(window.translatable_file_uploader_options, {
        allowedExtensions: ['jpg', 'jpeg', 'gif', 'png'],
        action: window.ajax_uploader_path,
        element: $('.uploader', $image_upload_widget)[0],
        multiple: false,
        onComplete: function(id, fileName, responseJSON) {
            if(responseJSON.success) {
                $('.messages', $image_upload_widget).html("");
                // set the original to media_file_path
                $('#id_picture_path').val('uploads/' + fileName);
                // show preview link
                $('.preview', $image_upload_widget).html(
                    '&lt;img src="img/' + fileName + '" alt="" /&gt;'
                );
            }
        },
        onAllComplete: function(uploads) {
            // uploads is an array of maps
            // the maps look like this: {file: FileObject, response: JSONServerResponse}
            $('.qq-upload-success').fadeOut("slow", function() {
                $(this).remove();
            });
        },
        params: {
            'csrf_token': csrfmiddlewaretoken,
            'csrf_name': 'csrfmiddlewaretoken',
            'csrf_xname': 'X-CSRFToken'
        },
        showMessage: function(message) {
            $('.messages', $image_upload_widget).html(
                '&lt;div class="alert alert-danger"&gt;' + message + '&lt;/div&gt;'
            );
        }
    });
    var uploader = new qq.FileUploader(options);
    $('.qq-delete-button', $image_upload_widget).click(function() {
        $('.messages', $image_upload_widget).html("");
        $('.preview', $image_upload_widget).html("");
        $('#id_delete_picture').val(1);
        return false;
    });
});</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec180"/>How it works…</h2></div></div></div><p>When an<a class="indexterm" id="id250"/> image is selected in the upload widget, the result in the<a class="indexterm" id="id251"/> browser will look similar to the following screenshot:</p><div><img alt="How it works…" src="img/B04912_04_07.jpg"/></div><p>The same<a class="indexterm" id="id252"/> form can be used to create an inspirational quote and <a class="indexterm" id="id253"/>change an existing inspirational quote. Let's dig deeper into the process to see how it works. In the form, we have an uploading mechanism that consists of the following essential parts:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The area for the preview of the image that is defined as a <code class="literal">&lt;div&gt;</code> tag with the preview CSS class. Initially, it might show an image if we are in an object change view and the <code class="literal">InspirationQuote</code> object is passed to the template as <code class="literal">{{ instance }}</code>.</li><li class="listitem" style="list-style-type: disc">The area for the Ajax uploader widget that is defined as a <code class="literal">&lt;div&gt;</code> tag with the <code class="literal">uploader</code> CSS class. It will be filled with the dynamically-created uploading and deleting buttons as well as the uploading progress indicators.</li><li class="listitem" style="list-style-type: disc">The help text for the upload.</li><li class="listitem" style="list-style-type: disc">The area for error messages that is defined as a <code class="literal">&lt;div&gt;</code> tag with the <code class="literal">messages</code> CSS class.</li><li class="listitem" style="list-style-type: disc">The hidden <code class="literal">picture_path</code> character field to set the path of the uploaded file.</li><li class="listitem" style="list-style-type: disc">The hidden <code class="literal">delete_picture</code> Boolean field to mark the deletion of the file.</li></ul></div><p>On page<a class="indexterm" id="id254"/> load, JavaScript will check whether <code class="literal">picture_path</code> is set; and if it is, it will show a picture preview. This will be the case only when the<a class="indexterm" id="id255"/> form is submitted with an image selected; however, there are validation errors.</p><p>Furthermore, we are defining the options for the upload widget in JavaScript. These options are combined of the global <code class="literal">translatable_file_uploader_options</code> variable with translatable strings set in the template and other configuration options set in the JavaScript file. The Ajax upload widget is initialized with these options. Some important settings to note are the <code class="literal">onComplete</code> callback that shows an image preview and fills in the <code class="literal">picture_path</code> field when an image is uploaded and the <code class="literal">showMessage</code> callback that defines how to show the error messages in the wanted area.</p><p>Lastly, there is a handler for the delete button in JavaScript, which when clicked, sets the hidden <code class="literal">delete_picture</code> field to <code class="literal">1</code> and removes the preview image.</p><p>The Ajax uploader widget dynamically creates a form with the file upload field and a hidden <code class="literal">&lt;iframe&gt;</code> tag to post the form data. When a file is selected, it is immediately uploaded to the <code class="literal">uploads</code> directory under <code class="literal">MEDIA_URL</code> and the path to the file is set to the <code class="literal">hidden picture_path</code> field. This directory is a temporary location for the uploaded files. When a user submits the inspirational quote form and the input is valid, the <code class="literal">save()</code> method is called. If <code class="literal">delete_picture</code> is set to <code class="literal">1</code>, the picture of the model instance will be deleted. If the <code class="literal">picture_path</code> field is defined, the image from the temporary location will be copied to its final destination and the original will be removed.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec181"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Uploading images</em> recipe in <a class="link" href="ch03.html" title="Chapter 3. Forms and Views">Chapter 3</a>, <em>Forms and Views</em></li><li class="listitem" style="list-style-type: disc">The <em>Opening object details in a modal dialog</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Implementing a continuous scroll</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Implementing the Like widget</em> recipe</li></ul></div></div></div></body></html>