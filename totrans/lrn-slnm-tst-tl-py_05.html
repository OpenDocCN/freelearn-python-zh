<html><head></head><body>
  <div><div><div><div><div><h1 class="title"><a id="ch05"/>Chapter 5. Synchronizing Tests</h1></div></div></div><p>Building robust and reliable tests is one of the critical success factors of automated UI testing. However, you will come across situations where testing conditions differ from one test to another. When your script searches for elements or a certain state of application and it cannot find these elements anymore because the application starts responding slowly due to sudden resource constraints or network latency, the tests report false negative results. We need to match the speed of the test script with the application's speed by introducing delays in the test script. In other words, we need to sync the script with the application's response. WebDriver offers implicit and explicit waits to synchronize tests.</p><p>In this chapter, you will learn about the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using implicit and explicit wait</li><li class="listitem" style="list-style-type: disc">When to use implicit and explicit wait</li><li class="listitem" style="list-style-type: disc">Using expected conditions</li><li class="listitem" style="list-style-type: disc">Creating a custom wait condition</li></ul></div><div><div><div><div><h1 class="title"><a id="ch05lvl1sec26"/>Using implicit wait</h1></div></div></div><p>The implicit <a id="id367" class="indexterm"/>wait offers a generic way to synchronize the entire test or group of steps in WebDriver. Implicit wait is useful in dealing with situations where the application's response time is inconsistent due to network speed or applications that use dynamically rendered elements with Ajax calls.</p><p>When we set an implicit wait on WebDriver, it polls or searches the DOM for a certain amount of time to find an element or elements if they are not immediately available. By default, the implicit wait timeout is set to <code class="literal">0</code>.</p><p>Once set, the implicit wait is set for the life of the WebDriver instance or for the entire duration of the test, and the WebDriver applies this implicit wait for all the steps that find the elements on the page unless we set it back to 0.</p><p>The <code class="literal">webdriver</code> class provides the <code class="literal">implicitly_wait()</code> method to configure timeout. We created a <code class="literal">SearchProductTest</code> test in <a class="link" href="ch02.html" title="Chapter 2. Writing Tests Using unittest">Chapter 2</a>, <em>Writing Tests Using unittest</em>. We will modify this test and add an implicit wait with timeout of 10 seconds in the <code class="literal">setUp()</code> method as shown in following code example. When the test is executed, WebDriver will wait for up to 10 seconds if it doesn't <a id="id368" class="indexterm"/>find an element. When it reaches the timeout, that is, 10 seconds in this example, it will throw a <code class="literal">NoSuchElementException</code>.</p><div><pre class="programlisting">import unittest
from selenium import webdriver


class SearchProductTest(unittest.TestCase):
    def setUp(self):
        # create a new Firefox session
        self.driver = webdriver.Firefox()
        self.driver.implicitly_wait(30)
        self.driver.maximize_window()

        # navigate to the application home page
        self.driver.get("http://demo.magentocommerce.com/")

    def test_search_by_category(self):

        # get the search textbox
        self.search_field = self.driver.find_element_by_name("q")
        self.search_field.clear()

        # enter search keyword and submit
        self.search_field.send_keys("phones")
        self.search_field.submit()

        # get all the anchor elements which have product names # displayed currently on result page using # find_elements_by_xpath method
        products = self.driver\
            .find_elements_by_xpath("//h2[@class='product-name']/a")

        # check count of products shown in results
        self.assertEqual(2, len(products))

    def tearDown(self):
        # close the browser window
        self.driver.quit()

if __name__ == '__main__':
    unittest.main(verbosity=2)</pre></div><div><div><h3 class="title"><a id="tip08"/>Tip</h3><p>It is better to avoid using an implicit wait in tests and try to handle synchronization issues with an explicit <a id="id369" class="indexterm"/>wait, which provides more control when compared to an implicit wait.</p></div></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch05lvl1sec27"/>Using explicit wait</h1></div></div></div><p>The explicit wait is another <a id="id370" class="indexterm"/>wait mechanism available in WebDriver to synchronize tests. Explicit wait provides a better control when compared to implicit wait. Unlike an implicit wait, we can use a set of predefined or custom conditions for the script to wait for before proceeding with further steps.</p><p>An explicit wait can only be implemented in specific cases where script synchronization is needed. WebDriver provides the <code class="literal">WebDriverWait</code> and <code class="literal">expected_conditions</code> classes to implement an explicit wait.</p><p>The <a id="id371" class="indexterm"/>
<code class="literal">expected_conditions</code> class provides a set of predefined conditions to wait for before proceeding further in the code.</p><p>Let's create a simple test that uses explicit wait with an expected condition for visibility of an element, as shown in the following code:</p><div><pre class="programlisting">from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions
import unittest


class ExplicitWaitTests(unittest.TestCase):
    def setUp(self):
        self.driver = webdriver.Firefox()
        self.driver.get("http://demo.magentocommerce.com/")

    def test_account_link(self):
        WebDriverWait(self.driver, 10)\
            .until(lambda s: s.find_element_by_id("select-language").get_attribute("length") == "3")

        account = WebDriverWait(self.driver, 10)\
            .until(expected_conditions.visibility_of_element_located((By.LINK_TEXT, "ACCOUNT")))
        account.click()
    
    def tearDown(self):
        self.driver.quit()

if __name__ == "__main__":
    unittest.main(verbosity=2)</pre></div><p>In this test, explicit wait is used to wait until the <strong>Log In</strong> link is visible in the DOM, using the expected <code class="literal">visibility_of_element_located</code> condition. This condition requires the locator strategy and locator details for the element we want to wait for. The script will wait for a maximum of 10 <a id="id372" class="indexterm"/>seconds looking for the element to be visible. Once the element is visible with the specified locator, the expected condition will return the located element back to the script.</p><p>If an element is not visible with the specified locator in the given timeout, a <code class="literal">TimeoutException</code> will be raised.</p></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch05lvl1sec28"/>The expected condition class</h1></div></div></div><p>The following <a id="id373" class="indexterm"/>table shows some common conditions along with examples that we frequently come across when automating web browsers supported by the <code class="literal">expected_conditions</code> class:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Expected condition</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th><th style="text-align: left" valign="bottom">
<p>Argument</p>
</th><th style="text-align: left" valign="bottom">
<p>Example</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">element_to_be_clickable(locator)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id374" class="indexterm"/>will wait for an element to be located <a id="id375" class="indexterm"/>and be visible and enabled so that it can be clicked.</p>
<p>This method returns the element that is located back to the test.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">locator</code>: This is a tuple of <code class="literal">(by, locator)</code>.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">WebDriverWait(self.driver, 10).until(expected_conditions.element_to_be_clickable((By.NAME,"is_subscribed")))</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">element_to_be_selected(element)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id376" class="indexterm"/>will wait until a specified element is <a id="id377" class="indexterm"/>selected.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">element</code>: This is the WebElement.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">subscription = self.driver.find_element_by_name("is_subscribed")</code>
</p>
<p>
<code class="literal">WebDriverWait(self.driver, 10).until(expected_conditions.element_to_be_selected(subscription))</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">invisibility_of_element_located(locator)</code> </p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id378" class="indexterm"/>will wait for an element that is either invisible or is <a id="id379" class="indexterm"/>not present on the DOM.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">locator</code>: This is a tuple of <code class="literal">(by, locator)</code>.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">WebDriverWait(self.driver, 10).until(expected_conditions.invisibility_of_element_located((By.ID,"loading_banner")))</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">presence_of_all_elements_located(locator)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id380" class="indexterm"/>will wait until at least one element for the matching locator is present <a id="id381" class="indexterm"/>on the web page.</p>
<p>This method returns the list of WebElements once they are located.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">locator</code>: This is a tuple of <code class="literal">(by, locator)</code>.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">WebDriverWait(self.driver, 10).until(expected_conditions.presence_of_all_elements_located((By.CLASS_NAME,"input-text")))</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">presence_of_element_located(locator)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id382" class="indexterm"/>will wait until an element for the matching locator is present on a web page or available <a id="id383" class="indexterm"/>on the DOM.</p>
<p>This method returns an element once it is located.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">locator</code>: This is a tuple of <code class="literal">(by, locator)</code>.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">WebDriverWait(self.driver, 10).until(expected_conditions.presence_of_element_located((By.ID,"search")))</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">text_to_be_present_in_element(locator, text_)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id384" class="indexterm"/>will wait until an element is located and has <a id="id385" class="indexterm"/>the given text.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">locator</code>: This is a tuple of <code class="literal">(by, locator)</code>.</p>
<p>
<code class="literal">text</code>: This is the text to be checked.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">WebDriverWait(self.driver,10).until(expected_conditions.text_to_be_present_in_element((By.ID,"select-language"),"English"))</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">title_contains(title)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id386" class="indexterm"/>will wait for the page tile to contain a case-sensitive <a id="id387" class="indexterm"/>substring.</p>
<p>This method returns <code class="literal">true</code> if the tile matches, <code class="literal">false</code> otherwise.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">title</code>: This is the substring of the title to check.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">WebDriverWait(self.driver, 10).until(expected_conditions.title_contains("Create New Customer Account"))</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">title_is(title)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This will <a id="id388" class="indexterm"/>wait for the page tile to be equal to the expected title.</p>
<p>This <a id="id389" class="indexterm"/>method returns <code class="literal">true</code> if the tile matches, <code class="literal">false</code> otherwise.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">title</code>: This is the title of the page.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">WebDriverWait(self.driver, 10).until(expected_conditions.title_is("Create New Customer Account - Magento Commerce Demo Store"))</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">visibility_of(element)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id390" class="indexterm"/>will wait until an element <a id="id391" class="indexterm"/>is present in DOM, is visible, and its width and height are greater than zero.</p>
<p>This method returns the (same) WebElement once it becomes visible.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">element</code>: This is the WebElement.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">first_name = self.driver.find_element_by_id("firstname")</code>
</p>
<p>
<code class="literal">        WebDriverWait(self.driver, 10).until(expected_conditions.visibility_of(first_name))</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">visibility_of_element_located(locator)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id392" class="indexterm"/>will wait until an element to be located is present <a id="id393" class="indexterm"/>in DOM, is visible, and its width and height are greater than zero.</p>
<p>This method returns the WebElement once it becomes visible.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">locator</code>: This is a tuple of <code class="literal">(by, locator)</code>.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">WebDriverWait(self.driver, 10).until(expected_conditions.visibility_of_element_located((By.ID,"firstname")))</code>
</p>
</td></tr></tbody></table></div><p>You can find a <a id="id394" class="indexterm"/>complete list of expected conditions at <a class="ulink" href="http://selenium.googlecode.com/git/docs/api/py/webdriver_support/selenium.webdriver.support.expected_conditions.html#module-selenium.webdriver.support.expected_conditions">http://selenium.googlecode.com/git/docs/api/py/webdriver_support/selenium.webdriver.support.expected_conditions.html#module-selenium.webdriver.support.expected_conditions</a>.</p><p>Let's explore few more examples of expected conditions in the upcoming sections.</p><div><div><div><div><h2 class="title"><a id="ch05lvl2sec37"/>Waiting for an element to be enabled</h2></div></div></div><p>As we <a id="id395" class="indexterm"/>have seen earlier, the <code class="literal">expected_conditons</code> class provides a variety of wait conditions that we can implement in our scripts. In the following example, we will wait for an element to be enabled or made <a id="id396" class="indexterm"/>clickable. We can use this condition in Ajax-heavy applications where form fields are enabled or disabled based on other form field values or filters. In this example, we click on the <strong>Log In</strong> link and then wait for the <strong>Create an Account</strong> button to become clickable, which is displayed on the login page. We will then click on the <strong>Create an Account</strong> button and wait for the next page to be displayed.</p><div><pre class="programlisting">def test_create_new_customer(self):
    # click on Log In link to open Login page
    self.driver.find_element_by_link_text("ACCOUNT").click()

    # wait for My Account link in Menu
    my_account = WebDriverWait(self.driver, 10)\
        .until(expected_conditions.visibility_of_element_located((By.LINK_TEXT, "My Account")))
    my_account.click()

    # get the Create Account button
    create_account_button = WebDriverWait(self.driver, 10)\
        .until(expected_conditions.element_to_be_clickable((By.LINK_TEXT, "CREATE AN ACCOUNT")))

    # click on Create Account button. This will displayed new account
    create_account_button.click()
    WebDriverWait(self.driver, 10)\
        .until(expected_conditions.title_contains("Create New Customer Account"))</pre></div><p>We can wait <a id="id397" class="indexterm"/>and check for an element to be enabled by using the <code class="literal">element_to_be_clickable</code> condition. This requires the locator strategy and locator value. It returns the located element back to the script when that element becomes clickable or, in other words, enabled.</p><p>The <a id="id398" class="indexterm"/>preceding tests also wait for the creating new customer account page to be loaded by checking the title with the specified text. We used the <code class="literal">title_contains</code> condition that checks to make sure that the substring matches with the title of the page.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec38"/>Waiting for alerts</h2></div></div></div><p>We can also use <a id="id399" class="indexterm"/>explicit wait on alerts and frames. A complex JavaScript <a id="id400" class="indexterm"/>processing or backend request might take time to display the alert to the user. This can be handled by the expected <code class="literal">alert_is_present</code> condition in the following way:</p><div><pre class="programlisting">from selenium import webdriver
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.common.by import By
from selenium.webdriver.support import expected_conditions
import unittest


class CompareProducts(unittest.TestCase):
    def setUp(self):
        self.driver = webdriver.Firefox()
        self.driver.get("http://demo.magentocommerce.com/")

    def test_compare_products_removal_alert(self):
        # get the search textbox
        search_field = self.driver.find_element_by_name("q")
        search_field.clear()

        # enter search keyword and submit
        search_field.send_keys("phones")
        search_field.submit()

        # click the Add to compare link
        self.driver.\
            find_element_by_link_text("Add to Compare").click()

        # wait for Clear All link to be visible
        clear_all_link = WebDriverWait(self.driver, 10)\
            .until(expected_conditions.visibility_of_element_located((By.LINK_TEXT, "Clear All")))

        # click on Clear All link,
        # this will display an alert to the user
        clear_all_link.click()

        # wait for the alert to present
        alert = WebDriverWait(self.driver, 10)\
            .until(expected_conditions.alert_is_present())

        # get the text from alert
        alert_text = alert.text

        # check alert text
        self.assertEqual("Are you sure you would like
  to remove all products from your comparison?", alert_text)
        # click on Ok button
        alert.accept()

    def tearDown(self):
        self.driver.quit()

if __name__ == "__main__":
    unittest.main(verbosity=2)</pre></div><p>The preceding test validates the removal of products from the product comparison feature of the application. Users <a id="id401" class="indexterm"/>are sent a confirmation alert when they remove a product from the comparison. The <code class="literal">alert_is_present</code> condition is used to check if the alert is displayed to the user and returned back to the script for the upcoming actions. The script will wait for 10 seconds checking <a id="id402" class="indexterm"/>for the presence of the alert, otherwise it will raise an exception.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch05lvl1sec29"/>Implementing custom wait conditions</h1></div></div></div><p>As we have <a id="id403" class="indexterm"/>seen earlier, the <code class="literal">expected_conditions</code> class provides various predefined conditions to wait. We can also build custom conditions with <code class="literal">WebDriverWait</code>. This becomes useful when there is no suitable expected condition available for which to wait.</p><p>Let's modify one of the tests we created earlier in this chapter and implement a custom wait condition to <a id="id404" class="indexterm"/>check the number of the drop-down items:</p><div><pre class="programlisting">def testLoginLink(self):
    <strong>WebDriverWait(self.driver, 10).until(lambda s: s.find_element_by_id "select-language").get_attribute("length") == "3")</strong>

    login_link = WebDriverWait(self.driver, 10).until(expected_conditions.visibility_of_element_located((By.LINK_TEXT,"Log In")))
       login_link.click();</pre></div><p>We can implement custom wait conditions with <code class="literal">WebDriverWait</code> using the Python lambda expressions. In this example, the script will wait for 10 seconds until the <strong>Select Language</strong> dropdown has eight options for selection. This condition is useful when the dropdowns are populated by Ajax calls and the script needs to wait until all the options are available to the user for selection.</p></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch05lvl1sec30"/>Summary</h1></div></div></div><p>In this chapter, we recognized the need for synchronization and its importance in building highly reliable tests. We looked at the implicit wait and how to use implicit wait as a generic wait mechanism with an example. We then looked at the explicit wait that offers a more flexible way to synchronize tests. The <code class="literal">expected_conditions</code> class offers various built-in conditions for the wait. We have implemented some of these conditions.</p><p>The <code class="literal">WebDriverWait</code> class also provides a very powerful way to implement custom wait conditions over and above <code class="literal">expected_conditions</code>. We implemented a custom wait condition on a dropdown.</p><p>In the next chapter, you will learn how to implement cross-browser testing using <code class="literal">RemoteWebDriver</code> and Selenium Server for running tests on a remote machine and parallel execution with Selenium Grid.</p></div></div>
</body></html>