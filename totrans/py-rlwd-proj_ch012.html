<html xml:lang="en-US" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<meta charset="utf-8"/>
<meta content="pandoc" name="generator"/>
<title>ch012.xhtml</title>
<link href="../styles/stylesheet1.css" rel="stylesheet" type="text/css"/>
<!-- kobo-style -->

<style id="koboSpanStyle" type="text/css" xmlns="http://www.w3.org/1999/xhtml">.koboSpan { -webkit-text-combine: inherit; }</style>
</head>
<body epub:type="bodymatter">
<section class="level1" data-number="12" id="chapter-8-project-2.5-schema-and-metadata">
<h1 data-number="12"><span class="titlemark"><span class="koboSpan" id="kobo.1.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 8</span></span><br/>
<span id="x1-1950008"/><span class="koboSpan" id="kobo.2.1" xmlns="http://www.w3.org/1999/xhtml">Project 2.5: Schema and Metadata</span></h1>
<p><span class="koboSpan" id="kobo.3.1" xmlns="http://www.w3.org/1999/xhtml">It helps to keep the data schema separate from the various applications that share the schema. </span><span class="koboSpan" id="kobo.3.2" xmlns="http://www.w3.org/1999/xhtml">One way to do this is to have a separate module with class definitions that all of the applications in a suite can share. </span><span class="koboSpan" id="kobo.3.3" xmlns="http://www.w3.org/1999/xhtml">While this is helpful for a simple project, it can be awkward when sharing data schema more widely. </span><span class="koboSpan" id="kobo.3.4" xmlns="http://www.w3.org/1999/xhtml">A Python language module is particularly difficult for sharing data outside the Python environment.</span></p>
<p><span class="koboSpan" id="kobo.4.1" xmlns="http://www.w3.org/1999/xhtml">This project will define a </span><span id="dx1-195001"/><span class="koboSpan" id="kobo.5.1" xmlns="http://www.w3.org/1999/xhtml">schema in JSON Schema Notation, first by building </span><code><span class="koboSpan" id="kobo.6.1" xmlns="http://www.w3.org/1999/xhtml">pydantic</span></code><span class="koboSpan" id="kobo.7.1" xmlns="http://www.w3.org/1999/xhtml"> class definitions, then by extracting the JSON from the class definition. </span><span class="koboSpan" id="kobo.7.2" xmlns="http://www.w3.org/1999/xhtml">This will allow you to publish a formal definition of the data being created. </span><span class="koboSpan" id="kobo.7.3" xmlns="http://www.w3.org/1999/xhtml">The schema can be used by a variety of tools to validate data files and assure that the data is suitable for further analytical use.</span></p>
<p><span class="koboSpan" id="kobo.8.1" xmlns="http://www.w3.org/1999/xhtml">The schema is also useful for diagnosing problems with data sources. </span><span class="koboSpan" id="kobo.8.2" xmlns="http://www.w3.org/1999/xhtml">Validator tools like </span><code><span class="koboSpan" id="kobo.9.1" xmlns="http://www.w3.org/1999/xhtml">jsonschema</span></code><span class="koboSpan" id="kobo.10.1" xmlns="http://www.w3.org/1999/xhtml"> can provide detailed error reports that can help identify changes in source data from bug fixes or software updates.</span></p>
<p><span class="koboSpan" id="kobo.11.1" xmlns="http://www.w3.org/1999/xhtml">This chapter will cover a number of skills related to data inspection techniques:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.12.1" xmlns="http://www.w3.org/1999/xhtml">Using the </span><strong><span class="koboSpan" id="kobo.13.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.14.1" xmlns="http://www.w3.org/1999/xhtml">module for crisp, complete definitions</span></p></li>
<li><p><span class="koboSpan" id="kobo.15.1" xmlns="http://www.w3.org/1999/xhtml">Using JSON Schema to create an exportable language-independent definition that anyone can use</span></p></li>
<li><p><span class="koboSpan" id="kobo.16.1" xmlns="http://www.w3.org/1999/xhtml">Creating test scenarios to use the formal schema definition</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.17.1" xmlns="http://www.w3.org/1999/xhtml">We’ll start by looking at the reasons why a formal schema is helpful. </span><span id="x1-195002r208"/></p>
<section class="level2" data-number="12.1" id="description-10">
<h2 data-number="12.1"><span class="titlemark"><span class="koboSpan" id="kobo.18.1" xmlns="http://www.w3.org/1999/xhtml">8.1 </span></span> <span id="x1-1960001"/><span class="koboSpan" id="kobo.19.1" xmlns="http://www.w3.org/1999/xhtml">Description</span></h2>
<p><span class="koboSpan" id="kobo.20.1" xmlns="http://www.w3.org/1999/xhtml">Data validation is a </span><span id="dx1-196001"/><span class="koboSpan" id="kobo.21.1" xmlns="http://www.w3.org/1999/xhtml">common requirement when moving data between applications. </span><span class="koboSpan" id="kobo.21.2" xmlns="http://www.w3.org/1999/xhtml">It is extremely helpful to have a clear definition of what constitutes valid data. </span><span class="koboSpan" id="kobo.21.3" xmlns="http://www.w3.org/1999/xhtml">It helps even more when the definition exists outside a particular programming language or platform.</span></p>
<p><span class="koboSpan" id="kobo.22.1" xmlns="http://www.w3.org/1999/xhtml">We can use the </span><span id="dx1-196002"/><span class="koboSpan" id="kobo.23.1" xmlns="http://www.w3.org/1999/xhtml">JSON Schema (</span><a class="url" href="https://json-schema.org"><span class="koboSpan" id="kobo.24.1" xmlns="http://www.w3.org/1999/xhtml">https://json-schema.org</span></a><span class="koboSpan" id="kobo.25.1" xmlns="http://www.w3.org/1999/xhtml">) to define a </span><span id="dx1-196003"/><span class="koboSpan" id="kobo.26.1" xmlns="http://www.w3.org/1999/xhtml">schema that applies to the </span><span id="dx1-196004"/><span class="koboSpan" id="kobo.27.1" xmlns="http://www.w3.org/1999/xhtml">intermediate documents created by the acquisition process. </span><span class="koboSpan" id="kobo.27.2" xmlns="http://www.w3.org/1999/xhtml">Using JSON Schema enables the confident and reliable use of the JSON data format.</span></p>
<p><span class="koboSpan" id="kobo.28.1" xmlns="http://www.w3.org/1999/xhtml">The JSON Schema definition can be shared and reused within separate Python projects and with non-Python environments, as well. </span><span class="koboSpan" id="kobo.28.2" xmlns="http://www.w3.org/1999/xhtml">It allows us to build data quality checks into the acquisition pipeline to positively affirm the data really fit the requirements for analysis and processing.</span></p>
<p><span class="koboSpan" id="kobo.29.1" xmlns="http://www.w3.org/1999/xhtml">Additional metadata provided with a schema often includes the provenance of the data and details on how attribute values are derived. </span><span class="koboSpan" id="kobo.29.2" xmlns="http://www.w3.org/1999/xhtml">This isn’t a formal part of a JSON Schema, but we can add some details to the JSON Schema document that includes provenance and processing descriptions.</span></p>
<p><span class="koboSpan" id="kobo.30.1" xmlns="http://www.w3.org/1999/xhtml">The subsequent data cleaning projects should validate the input documents using a source schema. </span><span class="koboSpan" id="kobo.30.2" xmlns="http://www.w3.org/1999/xhtml">Starting with </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.31.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.32.1" xmlns="http://www.w3.org/1999/xhtml"> 9</span></em></a><span class="koboSpan" id="kobo.33.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.34.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.1: Data Cleaning Base</span></em> <em><span class="koboSpan" id="kobo.35.1" xmlns="http://www.w3.org/1999/xhtml">Application</span></em></a><span class="koboSpan" id="kobo.36.1" xmlns="http://www.w3.org/1999/xhtml">, the applications should validate their output using the target analytic schema. </span><span class="koboSpan" id="kobo.36.2" xmlns="http://www.w3.org/1999/xhtml">It can seem silly to have an application both create sample records and also validate those records against a schema. </span><span class="koboSpan" id="kobo.36.3" xmlns="http://www.w3.org/1999/xhtml">What’s important is the schema will be shared, and evolve with the needs of consumers of the data. </span><span class="koboSpan" id="kobo.36.4" xmlns="http://www.w3.org/1999/xhtml">The data acquisition and cleaning operations, on the other hand, evolve with the data sources. </span><span class="koboSpan" id="kobo.36.5" xmlns="http://www.w3.org/1999/xhtml">It is all too common for an ad hoc solution to a data problem to seem good but create invalid data.</span></p>
<p><span class="koboSpan" id="kobo.37.1" xmlns="http://www.w3.org/1999/xhtml">It rarely creates new </span><span id="dx1-196005"/><span class="koboSpan" id="kobo.38.1" xmlns="http://www.w3.org/1999/xhtml">problems to validate inputs as well as outputs against a visible, agreed-upon schema. </span><span class="koboSpan" id="kobo.38.2" xmlns="http://www.w3.org/1999/xhtml">There will be some overhead to the validation operation, but much of the processing cost is dominated by the time to perform input and output, not data validation.</span></p>
<p><span class="koboSpan" id="kobo.39.1" xmlns="http://www.w3.org/1999/xhtml">Looking forward to </span><a href="ch016.xhtml#x1-27600012"><em><span class="koboSpan" id="kobo.40.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.41.1" xmlns="http://www.w3.org/1999/xhtml"> 12</span></em></a><span class="koboSpan" id="kobo.42.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch016.xhtml#x1-27600012"><em><span class="koboSpan" id="kobo.43.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.8: Integrated Data Acquisition Web</span></em> <em><span class="koboSpan" id="kobo.44.1" xmlns="http://www.w3.org/1999/xhtml">Service</span></em></a><span class="koboSpan" id="kobo.45.1" xmlns="http://www.w3.org/1999/xhtml">, we’ll see additional uses for a formally-defined schema. </span><span class="koboSpan" id="kobo.45.2" xmlns="http://www.w3.org/1999/xhtml">We’ll also uncover a small problem with using JSON Schema to describe ND JSON documents. </span><span class="koboSpan" id="kobo.45.3" xmlns="http://www.w3.org/1999/xhtml">For now, we’ll focus on the need to use JSON Schema to describe data.</span></p>
<p><span class="koboSpan" id="kobo.46.1" xmlns="http://www.w3.org/1999/xhtml">We’ll start by adding some modules to make it easier to create JSON Schema documents. </span><span id="x1-196006r213"/></p>
</section>
<section class="level2" data-number="12.2" id="approach-9">
<h2 data-number="12.2"><span class="titlemark"><span class="koboSpan" id="kobo.47.1" xmlns="http://www.w3.org/1999/xhtml">8.2 </span></span> <span id="x1-1970002"/><span class="koboSpan" id="kobo.48.1" xmlns="http://www.w3.org/1999/xhtml">Approach</span></h2>
<p><span class="koboSpan" id="kobo.49.1" xmlns="http://www.w3.org/1999/xhtml">First, we’ll need some additional modules. </span><span class="koboSpan" id="kobo.49.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.50.1" xmlns="http://www.w3.org/1999/xhtml">jsonschema</span></code><span class="koboSpan" id="kobo.51.1" xmlns="http://www.w3.org/1999/xhtml"> module defines a </span><span id="dx1-197001"/><span class="koboSpan" id="kobo.52.1" xmlns="http://www.w3.org/1999/xhtml">validator that can be used to confirm a document matches the defined schema.</span></p>
<p><span class="koboSpan" id="kobo.53.1" xmlns="http://www.w3.org/1999/xhtml">Additionally, the </span><strong><span class="koboSpan" id="kobo.54.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.55.1" xmlns="http://www.w3.org/1999/xhtml">module </span><span id="dx1-197002"/><span class="koboSpan" id="kobo.56.1" xmlns="http://www.w3.org/1999/xhtml">provides a way to create class definitions that can emit JSON Schema definitions, saving us from having to create the schema manually. </span><span class="koboSpan" id="kobo.56.2" xmlns="http://www.w3.org/1999/xhtml">In most cases, manual schema creation is not terribly difficult. </span><span class="koboSpan" id="kobo.56.3" xmlns="http://www.w3.org/1999/xhtml">For some cases, though, the schema and the validation rules might be challenging to write directly, and having Python class definitions available can simplify the process.</span></p>
<p><span class="koboSpan" id="kobo.57.1" xmlns="http://www.w3.org/1999/xhtml">This needs to be added to the </span><code><span class="koboSpan" id="kobo.58.1" xmlns="http://www.w3.org/1999/xhtml">requirements-dev.txt</span></code><span class="koboSpan" id="kobo.59.1" xmlns="http://www.w3.org/1999/xhtml"> file so other developers know to install it.</span></p>
<p><span class="koboSpan" id="kobo.60.1" xmlns="http://www.w3.org/1999/xhtml">When using </span><strong><span class="koboSpan" id="kobo.61.1" xmlns="http://www.w3.org/1999/xhtml">conda </span></strong><span class="koboSpan" id="kobo.62.1" xmlns="http://www.w3.org/1999/xhtml">to </span><span id="dx1-197003"/><span class="koboSpan" id="kobo.63.1" xmlns="http://www.w3.org/1999/xhtml">manage virtual environments, the command might look like the following:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-141">
<div class="tcolorbox-content">
<pre class="console"><span class="koboSpan" id="kobo.64.1" xmlns="http://www.w3.org/1999/xhtml">% conda install jsonschema pydantic</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.65.1" xmlns="http://www.w3.org/1999/xhtml">When using other tools to manage virtual environments, the command might look like the following:</span></p>
<pre class="console"><span class="koboSpan" id="kobo.66.1" xmlns="http://www.w3.org/1999/xhtml">% python -m pip install jupyterlab</span></pre>
<p><span class="koboSpan" id="kobo.67.1" xmlns="http://www.w3.org/1999/xhtml">The JSON Schema package requires some supplemental type stubs. </span><span class="koboSpan" id="kobo.67.2" xmlns="http://www.w3.org/1999/xhtml">These are used by the </span><strong><span class="koboSpan" id="kobo.68.1" xmlns="http://www.w3.org/1999/xhtml">mypy </span></strong><span class="koboSpan" id="kobo.69.1" xmlns="http://www.w3.org/1999/xhtml">tool to confirm the application is using types consistently. </span><span class="koboSpan" id="kobo.69.2" xmlns="http://www.w3.org/1999/xhtml">Use the following command to add stubs:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-142">
<div class="tcolorbox-content">
<pre class="console"><span class="koboSpan" id="kobo.70.1" xmlns="http://www.w3.org/1999/xhtml">% mypy --install-types</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.71.1" xmlns="http://www.w3.org/1999/xhtml">Additionally, the </span><code><span class="koboSpan" id="kobo.72.1" xmlns="http://www.w3.org/1999/xhtml">pydantic</span></code><span class="koboSpan" id="kobo.73.1" xmlns="http://www.w3.org/1999/xhtml"> package </span><span id="dx1-197007"/><span class="koboSpan" id="kobo.74.1" xmlns="http://www.w3.org/1999/xhtml">includes a </span><strong><span class="koboSpan" id="kobo.75.1" xmlns="http://www.w3.org/1999/xhtml">mypy </span></strong><span class="koboSpan" id="kobo.76.1" xmlns="http://www.w3.org/1999/xhtml">plug-in that will extend the type-checking capabilities of </span><strong><span class="koboSpan" id="kobo.77.1" xmlns="http://www.w3.org/1999/xhtml">mypy</span></strong><span class="koboSpan" id="kobo.78.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.78.2" xmlns="http://www.w3.org/1999/xhtml">This will spot more nuanced potential problems with classes defined using </span><code><span class="koboSpan" id="kobo.79.1" xmlns="http://www.w3.org/1999/xhtml">pydantic</span></code><span class="koboSpan" id="kobo.80.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.81.1" xmlns="http://www.w3.org/1999/xhtml">To enable the plugin, add </span><code><span class="koboSpan" id="kobo.82.1" xmlns="http://www.w3.org/1999/xhtml">pydantic.mypy</span></code><span class="koboSpan" id="kobo.83.1" xmlns="http://www.w3.org/1999/xhtml"> to the list of plugins in the </span><strong><span class="koboSpan" id="kobo.84.1" xmlns="http://www.w3.org/1999/xhtml">mypy </span></strong><span class="koboSpan" id="kobo.85.1" xmlns="http://www.w3.org/1999/xhtml">configuration file, </span><code><span class="koboSpan" id="kobo.86.1" xmlns="http://www.w3.org/1999/xhtml">mypy.ini</span></code><span class="koboSpan" id="kobo.87.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.87.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.88.1" xmlns="http://www.w3.org/1999/xhtml">mypy.ini</span></code><span class="koboSpan" id="kobo.89.1" xmlns="http://www.w3.org/1999/xhtml"> file should look like this:</span></p>
<pre class="console"><span class="koboSpan" id="kobo.90.1" xmlns="http://www.w3.org/1999/xhtml">[mypy]
plugins = pydantic.mypy</span></pre>
<p><span class="koboSpan" id="kobo.91.1" xmlns="http://www.w3.org/1999/xhtml">(This file goes in the root of the project directory.)</span></p>
<p><span class="koboSpan" id="kobo.92.1" xmlns="http://www.w3.org/1999/xhtml">This </span><span id="dx1-197010"/><span class="koboSpan" id="kobo.93.1" xmlns="http://www.w3.org/1999/xhtml">plugin is part of the </span><strong><span class="koboSpan" id="kobo.94.1" xmlns="http://www.w3.org/1999/xhtml">pydantic </span></strong><span class="koboSpan" id="kobo.95.1" xmlns="http://www.w3.org/1999/xhtml">download, and is compatible with </span><strong><span class="koboSpan" id="kobo.96.1" xmlns="http://www.w3.org/1999/xhtml">mypy</span></strong><span class="koboSpan" id="kobo.97.1" xmlns="http://www.w3.org/1999/xhtml"> versions starting with 0.910.</span></p>
<p><span class="koboSpan" id="kobo.98.1" xmlns="http://www.w3.org/1999/xhtml">With these two packages, we can define classes with details that can be used to create JSON Schema files. </span><span class="koboSpan" id="kobo.98.2" xmlns="http://www.w3.org/1999/xhtml">Once we have a JSON Schema file, we can use the schema definition to confirm that sample data is valid.</span></p>
<p><span class="koboSpan" id="kobo.99.1" xmlns="http://www.w3.org/1999/xhtml">For more </span><span id="dx1-197011"/><span class="koboSpan" id="kobo.100.1" xmlns="http://www.w3.org/1999/xhtml">information on </span><strong><span class="koboSpan" id="kobo.101.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic</span></strong><span class="koboSpan" id="kobo.102.1" xmlns="http://www.w3.org/1999/xhtml">, see </span><a class="url" href="https://docs.pydantic.dev"><span class="koboSpan" id="kobo.103.1" xmlns="http://www.w3.org/1999/xhtml">https://docs.pydantic.dev</span></a><span class="koboSpan" id="kobo.104.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.105.1" xmlns="http://www.w3.org/1999/xhtml">The core concept is to use </span><strong><span class="koboSpan" id="kobo.106.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.107.1" xmlns="http://www.w3.org/1999/xhtml">to define dataclasses with detailed field definitions. </span><span class="koboSpan" id="kobo.107.2" xmlns="http://www.w3.org/1999/xhtml">These definitions can be used for data validation in Python. </span><span class="koboSpan" id="kobo.107.3" xmlns="http://www.w3.org/1999/xhtml">The definition can also be used to emit a JSON Schema document to share with other projects.</span></p>
<p><span class="koboSpan" id="kobo.108.1" xmlns="http://www.w3.org/1999/xhtml">The schema definitions are also useful for defining an OpenAPI specification. </span><span class="koboSpan" id="kobo.108.2" xmlns="http://www.w3.org/1999/xhtml">In </span><a href="ch016.xhtml#x1-27600012"><em><span class="koboSpan" id="kobo.109.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.110.1" xmlns="http://www.w3.org/1999/xhtml"> 12</span></em></a><span class="koboSpan" id="kobo.111.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch016.xhtml#x1-27600012"><em><span class="koboSpan" id="kobo.112.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.8: Integrated Data Acquisition Web Service</span></em></a><span class="koboSpan" id="kobo.113.1" xmlns="http://www.w3.org/1999/xhtml">, we’ll turn to creating a web service that provides data. </span><span class="koboSpan" id="kobo.113.2" xmlns="http://www.w3.org/1999/xhtml">The OpenAPI specification for this service will include the schema definitions from this project.</span></p>
<p><span class="koboSpan" id="kobo.114.1" xmlns="http://www.w3.org/1999/xhtml">The use of </span><strong><span class="koboSpan" id="kobo.115.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.116.1" xmlns="http://www.w3.org/1999/xhtml">isn’t required. </span><span class="koboSpan" id="kobo.116.2" xmlns="http://www.w3.org/1999/xhtml">It is, however, very </span><span id="dx1-197012"/><span class="koboSpan" id="kobo.117.1" xmlns="http://www.w3.org/1999/xhtml">convenient for creating a schema that can be described via JSON Schema. </span><span class="koboSpan" id="kobo.117.2" xmlns="http://www.w3.org/1999/xhtml">It saves a great deal of fussing with details in JSON syntax.</span></p>
<p><span class="koboSpan" id="kobo.118.1" xmlns="http://www.w3.org/1999/xhtml">We’ll start with using </span><strong><span class="koboSpan" id="kobo.119.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.120.1" xmlns="http://www.w3.org/1999/xhtml">to create a useful data model module. </span><span class="koboSpan" id="kobo.120.2" xmlns="http://www.w3.org/1999/xhtml">This will extend the data models built for projects in earlier chapters. </span><span id="x1-197013r211"/></p>
<section class="level3" data-number="12.2.1" id="define-pydantic-classes-and-emit-the-json-schema">
<h3 data-number="12.2.1"><span class="titlemark"><span class="koboSpan" id="kobo.121.1" xmlns="http://www.w3.org/1999/xhtml">8.2.1 </span></span> <span id="x1-1980001"/><span class="koboSpan" id="kobo.122.1" xmlns="http://www.w3.org/1999/xhtml">Define Pydantic classes and emit the JSON Schema</span></h3>
<p><span class="koboSpan" id="kobo.123.1" xmlns="http://www.w3.org/1999/xhtml">We’ll start with two </span><span id="dx1-198001"/><span class="koboSpan" id="kobo.124.1" xmlns="http://www.w3.org/1999/xhtml">profound modifications to the data model definitions used in earlier chapters. </span><span class="koboSpan" id="kobo.124.2" xmlns="http://www.w3.org/1999/xhtml">One change is to switch from the </span><code><span class="koboSpan" id="kobo.125.1" xmlns="http://www.w3.org/1999/xhtml">dataclasses</span></code><span class="koboSpan" id="kobo.126.1" xmlns="http://www.w3.org/1999/xhtml"> module to the </span><code><span class="koboSpan" id="kobo.127.1" xmlns="http://www.w3.org/1999/xhtml">pydantic.dataclasses</span></code><span class="koboSpan" id="kobo.128.1" xmlns="http://www.w3.org/1999/xhtml"> module. </span><span class="koboSpan" id="kobo.128.2" xmlns="http://www.w3.org/1999/xhtml">Doing this creates the need to explicitly use </span><code><span class="koboSpan" id="kobo.129.1" xmlns="http://www.w3.org/1999/xhtml">dataclasses.field</span></code><span class="koboSpan" id="kobo.130.1" xmlns="http://www.w3.org/1999/xhtml"> for individual field definitions. </span><span class="koboSpan" id="kobo.130.2" xmlns="http://www.w3.org/1999/xhtml">This is generally a small change to an </span><code><span class="koboSpan" id="kobo.131.1" xmlns="http://www.w3.org/1999/xhtml">import</span></code><span class="koboSpan" id="kobo.132.1" xmlns="http://www.w3.org/1999/xhtml"> statement to use </span><code><span class="koboSpan" id="kobo.133.1" xmlns="http://www.w3.org/1999/xhtml">from</span></code><code><span class="koboSpan" id="kobo.134.1" xmlns="http://www.w3.org/1999/xhtml"> pydantic.dataclasses</span></code><code><span class="koboSpan" id="kobo.135.1" xmlns="http://www.w3.org/1999/xhtml"> import</span></code><code><span class="koboSpan" id="kobo.136.1" xmlns="http://www.w3.org/1999/xhtml"> dataclass</span></code><span class="koboSpan" id="kobo.137.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.137.2" xmlns="http://www.w3.org/1999/xhtml">The dataclasses </span><code><span class="koboSpan" id="kobo.138.1" xmlns="http://www.w3.org/1999/xhtml">field()</span></code><span class="koboSpan" id="kobo.139.1" xmlns="http://www.w3.org/1999/xhtml"> function will need some changes, also, to add additional details used by </span><strong><span class="koboSpan" id="kobo.140.1" xmlns="http://www.w3.org/1999/xhtml">pydantic</span></strong><span class="koboSpan" id="kobo.141.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.141.2" xmlns="http://www.w3.org/1999/xhtml">The changes should be completely transparent to the existing application; all tests will pass after these changes.</span></p>
<p><span class="koboSpan" id="kobo.142.1" xmlns="http://www.w3.org/1999/xhtml">The second change is to add some </span><span id="dx1-198002"/><span class="koboSpan" id="kobo.143.1" xmlns="http://www.w3.org/1999/xhtml">important metadata to the classes. </span><span class="koboSpan" id="kobo.143.2" xmlns="http://www.w3.org/1999/xhtml">Where the </span><code><span class="koboSpan" id="kobo.144.1" xmlns="http://www.w3.org/1999/xhtml">dataclasses.field(...)</span></code><span class="koboSpan" id="kobo.145.1" xmlns="http://www.w3.org/1999/xhtml"> definition is used, the </span><code><span class="koboSpan" id="kobo.146.1" xmlns="http://www.w3.org/1999/xhtml">metadata={}</span></code><span class="koboSpan" id="kobo.147.1" xmlns="http://www.w3.org/1999/xhtml"> attribute can be added to include a dictionary with JSON Schema attributes like the description, title, examples, valid ranges of values, etc. </span><span class="koboSpan" id="kobo.147.2" xmlns="http://www.w3.org/1999/xhtml">For other fields, the </span><code><span class="koboSpan" id="kobo.148.1" xmlns="http://www.w3.org/1999/xhtml">pydantic.Field()</span></code><span class="koboSpan" id="kobo.149.1" xmlns="http://www.w3.org/1999/xhtml"> function must be used to provide a title, description, and other constraints on the field. </span><span class="koboSpan" id="kobo.149.2" xmlns="http://www.w3.org/1999/xhtml">This will generate a great deal of metadata for us.</span></p>
<p><span class="koboSpan" id="kobo.150.1" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://docs.pydantic.dev/usage/schema/#field-customization"><span class="koboSpan" id="kobo.151.1" xmlns="http://www.w3.org/1999/xhtml">https://docs.pydantic.dev/usage/schema/#field-customization</span></a><span class="koboSpan" id="kobo.152.1" xmlns="http://www.w3.org/1999/xhtml"> for the wide variety of field definition details available.</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-143">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.153.1" xmlns="http://www.w3.org/1999/xhtml">from pydantic import Field
from pydantic.dataclasses import dataclass

@dataclass
class SeriesSample:
    """
    An individual sample value.
    </span><span class="koboSpan" id="kobo.153.2" xmlns="http://www.w3.org/1999/xhtml">"""
    x: float = Field(title="The x attribute", ge=0.0)
    y: float = Field(title="The y attribute", ge=0.0)

@dataclass
class Series:
    """
    A named series with a collection of values.
    </span><span class="koboSpan" id="kobo.153.3" xmlns="http://www.w3.org/1999/xhtml">"""
    name: str = Field(title="Series name")
    samples: list[SeriesSample] = Field(title="Sequence of samples
      in this series")</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.154.1" xmlns="http://www.w3.org/1999/xhtml">We’ve provided several </span><span id="dx1-198022"/><span class="koboSpan" id="kobo.155.1" xmlns="http://www.w3.org/1999/xhtml">additional details in this model definition module. </span><span class="koboSpan" id="kobo.155.2" xmlns="http://www.w3.org/1999/xhtml">The details include:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.156.1" xmlns="http://www.w3.org/1999/xhtml">Docstrings on each class. </span><span class="koboSpan" id="kobo.156.2" xmlns="http://www.w3.org/1999/xhtml">These will become descriptions in the JSON Schema.</span></p></li>
<li><p><span class="koboSpan" id="kobo.157.1" xmlns="http://www.w3.org/1999/xhtml">Fields for each attribute. </span><span class="koboSpan" id="kobo.157.2" xmlns="http://www.w3.org/1999/xhtml">These, too, become descriptions in the JSON Schema.</span></p></li>
<li><p><span class="koboSpan" id="kobo.158.1" xmlns="http://www.w3.org/1999/xhtml">For the </span><code><span class="koboSpan" id="kobo.159.1" xmlns="http://www.w3.org/1999/xhtml">x</span></code><span class="koboSpan" id="kobo.160.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.161.1" xmlns="http://www.w3.org/1999/xhtml">y</span></code><span class="koboSpan" id="kobo.162.1" xmlns="http://www.w3.org/1999/xhtml"> attributes of the </span><code><span class="koboSpan" id="kobo.163.1" xmlns="http://www.w3.org/1999/xhtml">SeriesSample</span></code><span class="koboSpan" id="kobo.164.1" xmlns="http://www.w3.org/1999/xhtml"> class definition, we added a </span><code><span class="koboSpan" id="kobo.165.1" xmlns="http://www.w3.org/1999/xhtml">ge</span></code><span class="koboSpan" id="kobo.166.1" xmlns="http://www.w3.org/1999/xhtml"> value. </span><span class="koboSpan" id="kobo.166.2" xmlns="http://www.w3.org/1999/xhtml">This is a range specification, requiring the values to be greater than or equal to zero.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.167.1" xmlns="http://www.w3.org/1999/xhtml">We’ve also made extremely profound changes to the model: we’ve moved from the source data description — which was a number of </span><code><span class="koboSpan" id="kobo.168.1" xmlns="http://www.w3.org/1999/xhtml">str</span></code><span class="koboSpan" id="kobo.169.1" xmlns="http://www.w3.org/1999/xhtml"> values — to the target data description, using </span><code><span class="koboSpan" id="kobo.170.1" xmlns="http://www.w3.org/1999/xhtml">float</span></code><span class="koboSpan" id="kobo.171.1" xmlns="http://www.w3.org/1999/xhtml"> values.</span></p>
<p><span class="koboSpan" id="kobo.172.1" xmlns="http://www.w3.org/1999/xhtml">What’s central here is that we have two variations on each model:</span></p>
<ul>
<li><p><strong><span class="koboSpan" id="kobo.173.1" xmlns="http://www.w3.org/1999/xhtml">Acquisition</span></strong><span class="koboSpan" id="kobo.174.1" xmlns="http://www.w3.org/1999/xhtml">: This is the data as we find it ”in the wild.” </span><span class="koboSpan" id="kobo.174.2" xmlns="http://www.w3.org/1999/xhtml">In the examples in this book, some variations of source data are text-only, forcing us to use </span><code><span class="koboSpan" id="kobo.175.1" xmlns="http://www.w3.org/1999/xhtml">str</span></code><span class="koboSpan" id="kobo.176.1" xmlns="http://www.w3.org/1999/xhtml"> as a common type. </span><span class="koboSpan" id="kobo.176.2" xmlns="http://www.w3.org/1999/xhtml">Some data sources will have data in more useful Python objects, permitting types other than </span><code><span class="koboSpan" id="kobo.177.1" xmlns="http://www.w3.org/1999/xhtml">str</span></code><span class="koboSpan" id="kobo.178.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p></li>
<li><p><strong><span class="koboSpan" id="kobo.179.1" xmlns="http://www.w3.org/1999/xhtml">Analysis</span></strong><span class="koboSpan" id="kobo.180.1" xmlns="http://www.w3.org/1999/xhtml">: This is the data used for further analysis. </span><span class="koboSpan" id="kobo.180.2" xmlns="http://www.w3.org/1999/xhtml">These data sets can use native Python objects. </span><span class="koboSpan" id="kobo.180.3" xmlns="http://www.w3.org/1999/xhtml">For the most part, we’ll focus on objects that are easily serialized to JSON. </span><span class="koboSpan" id="kobo.180.4" xmlns="http://www.w3.org/1999/xhtml">The exception will be date-time values, which don’t readily serialize to JSON, but require some additional conversion from a standard ISO text format.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.181.1" xmlns="http://www.w3.org/1999/xhtml">The class examples </span><span id="dx1-198023"/><span class="koboSpan" id="kobo.182.1" xmlns="http://www.w3.org/1999/xhtml">shown above do not </span><em><span class="koboSpan" id="kobo.183.1" xmlns="http://www.w3.org/1999/xhtml">replace </span></em><span class="koboSpan" id="kobo.184.1" xmlns="http://www.w3.org/1999/xhtml">the </span><code><span class="koboSpan" id="kobo.185.1" xmlns="http://www.w3.org/1999/xhtml">model</span></code><span class="koboSpan" id="kobo.186.1" xmlns="http://www.w3.org/1999/xhtml"> module in our applications. </span><span class="koboSpan" id="kobo.186.2" xmlns="http://www.w3.org/1999/xhtml">They form a second model of more useful data. </span><span class="koboSpan" id="kobo.186.3" xmlns="http://www.w3.org/1999/xhtml">The recommended approach is to change the initial acquisition model’s module name from </span><code><span class="koboSpan" id="kobo.187.1" xmlns="http://www.w3.org/1999/xhtml">model</span></code><span class="koboSpan" id="kobo.188.1" xmlns="http://www.w3.org/1999/xhtml"> to </span><code><span class="koboSpan" id="kobo.189.1" xmlns="http://www.w3.org/1999/xhtml">acquisition_model</span></code><span class="koboSpan" id="kobo.190.1" xmlns="http://www.w3.org/1999/xhtml"> (or perhaps the shorter </span><code><span class="koboSpan" id="kobo.191.1" xmlns="http://www.w3.org/1999/xhtml">source_model</span></code><span class="koboSpan" id="kobo.192.1" xmlns="http://www.w3.org/1999/xhtml">). </span><span class="koboSpan" id="kobo.192.2" xmlns="http://www.w3.org/1999/xhtml">This property describes the model with mostly string values as the source. </span><span class="koboSpan" id="kobo.192.3" xmlns="http://www.w3.org/1999/xhtml">This second model is the </span><code><span class="koboSpan" id="kobo.193.1" xmlns="http://www.w3.org/1999/xhtml">analysis_model</span></code><span class="koboSpan" id="kobo.194.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.195.1" xmlns="http://www.w3.org/1999/xhtml">The results of the initial investigation into the data can provide narrower and more strict constraints for the analysis model class definitions. </span><span class="koboSpan" id="kobo.195.2" xmlns="http://www.w3.org/1999/xhtml">See </span><a href="ch011.xhtml#x1-1610007"><em><span class="koboSpan" id="kobo.196.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.197.1" xmlns="http://www.w3.org/1999/xhtml"> 7</span></em></a><span class="koboSpan" id="kobo.198.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch011.xhtml#x1-1610007"><em><span class="koboSpan" id="kobo.199.1" xmlns="http://www.w3.org/1999/xhtml">Data Inspection Features</span></em></a><span class="koboSpan" id="kobo.200.1" xmlns="http://www.w3.org/1999/xhtml"> for a number of inspections that can help to reveal expected minima and maxima for attribute values.</span></p>
<p><span class="koboSpan" id="kobo.201.1" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.202.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.203.1" xmlns="http://www.w3.org/1999/xhtml">library </span><span id="dx1-198024"/><span class="koboSpan" id="kobo.204.1" xmlns="http://www.w3.org/1999/xhtml">comes with a large number of customized data types that can be used to describe data values. </span><span class="koboSpan" id="kobo.204.2" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://docs.pydantic.dev/usage/types/"><span class="koboSpan" id="kobo.205.1" xmlns="http://www.w3.org/1999/xhtml">https://docs.pydantic.dev/usage/types/</span></a><span class="koboSpan" id="kobo.206.1" xmlns="http://www.w3.org/1999/xhtml"> for documentation. </span><span class="koboSpan" id="kobo.206.2" xmlns="http://www.w3.org/1999/xhtml">Using the </span><code><span class="koboSpan" id="kobo.207.1" xmlns="http://www.w3.org/1999/xhtml">pydantic</span></code><span class="koboSpan" id="kobo.208.1" xmlns="http://www.w3.org/1999/xhtml"> types can be simpler than defining an attribute as a string, and trying to create a regular expression for valid values.</span></p>
<p><span class="koboSpan" id="kobo.209.1" xmlns="http://www.w3.org/1999/xhtml">Note that validation of source values isn’t central to </span><strong><span class="koboSpan" id="kobo.210.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic</span></strong><span class="koboSpan" id="kobo.211.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.211.2" xmlns="http://www.w3.org/1999/xhtml">When Python objects are provided, it’s entirely possible for the </span><strong><span class="koboSpan" id="kobo.212.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.213.1" xmlns="http://www.w3.org/1999/xhtml">module to </span><span id="dx1-198025"/><span class="koboSpan" id="kobo.214.1" xmlns="http://www.w3.org/1999/xhtml">perform a successful data conversion where we might have hoped for an exception to be raised. </span><span class="koboSpan" id="kobo.214.2" xmlns="http://www.w3.org/1999/xhtml">A concrete example is providing a Python </span><code><span class="koboSpan" id="kobo.215.1" xmlns="http://www.w3.org/1999/xhtml">float</span></code><span class="koboSpan" id="kobo.216.1" xmlns="http://www.w3.org/1999/xhtml"> object to a field that requires an </span><code><span class="koboSpan" id="kobo.217.1" xmlns="http://www.w3.org/1999/xhtml">int</span></code><span class="koboSpan" id="kobo.218.1" xmlns="http://www.w3.org/1999/xhtml"> value. </span><span class="koboSpan" id="kobo.218.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.219.1" xmlns="http://www.w3.org/1999/xhtml">float</span></code><span class="koboSpan" id="kobo.220.1" xmlns="http://www.w3.org/1999/xhtml"> object will be converted; an exception will </span><em><span class="koboSpan" id="kobo.221.1" xmlns="http://www.w3.org/1999/xhtml">not </span></em><span class="koboSpan" id="kobo.222.1" xmlns="http://www.w3.org/1999/xhtml">be raised. </span><span class="koboSpan" id="kobo.222.2" xmlns="http://www.w3.org/1999/xhtml">If this kind of very strict validation of Python objects is required, some additional programming is needed.</span></p>
<p><span class="koboSpan" id="kobo.223.1" xmlns="http://www.w3.org/1999/xhtml">In the next section, we’ll create a JSON Schema definition of our model. </span><span class="koboSpan" id="kobo.223.2" xmlns="http://www.w3.org/1999/xhtml">We can either export the definition from the class definition, or we can craft the JSON manually. </span><span id="x1-198026r215"/></p>
</section>
<section class="level3" data-number="12.2.2" id="define-expected-data-domains-in-json-schema-notation">
<h3 data-number="12.2.2"><span class="titlemark"><span class="koboSpan" id="kobo.224.1" xmlns="http://www.w3.org/1999/xhtml">8.2.2 </span></span> <span id="x1-1990002"/><span class="koboSpan" id="kobo.225.1" xmlns="http://www.w3.org/1999/xhtml">Define expected data domains in JSON Schema notation</span></h3>
<p><span class="koboSpan" id="kobo.226.1" xmlns="http://www.w3.org/1999/xhtml">Once we have the </span><span id="dx1-199001"/><span class="koboSpan" id="kobo.227.1" xmlns="http://www.w3.org/1999/xhtml">class definition, we can then export a schema that describes the class. </span><span class="koboSpan" id="kobo.227.2" xmlns="http://www.w3.org/1999/xhtml">Note that the </span><strong><span class="koboSpan" id="kobo.228.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.229.1" xmlns="http://www.w3.org/1999/xhtml">dataclass is a </span><span id="dx1-199002"/><span class="koboSpan" id="kobo.230.1" xmlns="http://www.w3.org/1999/xhtml">wrapper around an underlying </span><code><span class="koboSpan" id="kobo.231.1" xmlns="http://www.w3.org/1999/xhtml">pydantic.BaseModel</span></code><span class="koboSpan" id="kobo.232.1" xmlns="http://www.w3.org/1999/xhtml"> subclass definition.</span></p>
<p><span class="koboSpan" id="kobo.233.1" xmlns="http://www.w3.org/1999/xhtml">We can </span><span id="dx1-199003"/><span class="koboSpan" id="kobo.234.1" xmlns="http://www.w3.org/1999/xhtml">create a JSON Schema document by adding the following lines to the bottom of the module:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-144">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.235.1" xmlns="http://www.w3.org/1999/xhtml">from pydantic import schema_of
import json

if __name__ == "__main__":
    schema = schema_of(Series)
    print(json.dumps(schema, indent=2))</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.236.1" xmlns="http://www.w3.org/1999/xhtml">These lines turn the data definition module into a script that writes the JSON Schema definition to the standard output file.</span></p>
<p><span class="koboSpan" id="kobo.237.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.238.1" xmlns="http://www.w3.org/1999/xhtml">schema_of()</span></code><span class="koboSpan" id="kobo.239.1" xmlns="http://www.w3.org/1999/xhtml"> function will extract a schema from the dataclass created in the previous section. </span><span class="koboSpan" id="kobo.239.2" xmlns="http://www.w3.org/1999/xhtml">(See </span><a href="#x1-1980001"><em><span class="koboSpan" id="kobo.240.1" xmlns="http://www.w3.org/1999/xhtml">Define Pydantic classes and emit the JSON Schema</span></em></a><span class="koboSpan" id="kobo.241.1" xmlns="http://www.w3.org/1999/xhtml">.) The underlying </span><code><span class="koboSpan" id="kobo.242.1" xmlns="http://www.w3.org/1999/xhtml">pydantic.BaseModel</span></code><span class="koboSpan" id="kobo.243.1" xmlns="http://www.w3.org/1999/xhtml"> subclass also has a </span><code><span class="koboSpan" id="kobo.244.1" xmlns="http://www.w3.org/1999/xhtml">schema()</span></code><span class="koboSpan" id="kobo.245.1" xmlns="http://www.w3.org/1999/xhtml"> method that will transform the class definition into a richly-detailed JSON Schema definition. </span><span class="koboSpan" id="kobo.245.2" xmlns="http://www.w3.org/1999/xhtml">When working with </span><strong><span class="koboSpan" id="kobo.246.1" xmlns="http://www.w3.org/1999/xhtml">pydantic </span></strong><span class="koboSpan" id="kobo.247.1" xmlns="http://www.w3.org/1999/xhtml">dataclasses, the </span><code><span class="koboSpan" id="kobo.248.1" xmlns="http://www.w3.org/1999/xhtml">pydantic.BaseModel</span></code><span class="koboSpan" id="kobo.249.1" xmlns="http://www.w3.org/1999/xhtml"> isn’t directly available, and the </span><code><span class="koboSpan" id="kobo.250.1" xmlns="http://www.w3.org/1999/xhtml">schema_of()</span></code><span class="koboSpan" id="kobo.251.1" xmlns="http://www.w3.org/1999/xhtml"> function must be used.</span></p>
<p><span class="koboSpan" id="kobo.252.1" xmlns="http://www.w3.org/1999/xhtml">When executing the terminal command </span><code><span class="koboSpan" id="kobo.253.1" xmlns="http://www.w3.org/1999/xhtml">python</span></code><code><span class="koboSpan" id="kobo.254.1" xmlns="http://www.w3.org/1999/xhtml"> src/analysis_model.py</span></code><span class="koboSpan" id="kobo.255.1" xmlns="http://www.w3.org/1999/xhtml">, the schema is displayed.</span></p>
<p><span class="koboSpan" id="kobo.256.1" xmlns="http://www.w3.org/1999/xhtml">The output begins as follows:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-145">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.257.1" xmlns="http://www.w3.org/1999/xhtml">{
  "title": "Series",
  "description": "A named series with a collection of values.",
  "type": "object",
  "properties": {
    "name": {
      "title": "Series name",
      "type": "string"
    },
    "samples": {
      "title": "Sequence of samples in this series",
      "type": "array",
      "items": {
        "\$ref": "#/definitions/SeriesSample"
      }
    }
  },
  "required": [
    "name",
    "samples"
  ],
  ...
</span><span class="koboSpan" id="kobo.257.2" xmlns="http://www.w3.org/1999/xhtml">}</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.258.1" xmlns="http://www.w3.org/1999/xhtml">We can see that the title </span><span id="dx1-199033"/><span class="koboSpan" id="kobo.259.1" xmlns="http://www.w3.org/1999/xhtml">matches the class name. </span><span class="koboSpan" id="kobo.259.2" xmlns="http://www.w3.org/1999/xhtml">The description matches the docstring. </span><span class="koboSpan" id="kobo.259.3" xmlns="http://www.w3.org/1999/xhtml">The collection of </span><span id="dx1-199034"/><span class="koboSpan" id="kobo.260.1" xmlns="http://www.w3.org/1999/xhtml">properties matches the attributes’ names in the class. </span><span class="koboSpan" id="kobo.260.2" xmlns="http://www.w3.org/1999/xhtml">Each of the property definitions provides the type information from the dataclass.</span></p>
<p><span class="koboSpan" id="kobo.261.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.262.1" xmlns="http://www.w3.org/1999/xhtml">$ref</span></code><span class="koboSpan" id="kobo.263.1" xmlns="http://www.w3.org/1999/xhtml"> item is a reference to another definition provided later in the JSON Schema. </span><span class="koboSpan" id="kobo.263.2" xmlns="http://www.w3.org/1999/xhtml">This use of references makes sure the other class definition is separately visible, and is available to support this schema definition.</span></p>
<p><span class="koboSpan" id="kobo.264.1" xmlns="http://www.w3.org/1999/xhtml">A very complex model may have a number of definitions that are shared in multiple places. </span><span class="koboSpan" id="kobo.264.2" xmlns="http://www.w3.org/1999/xhtml">This </span><code><span class="koboSpan" id="kobo.265.1" xmlns="http://www.w3.org/1999/xhtml">$ref</span></code><span class="koboSpan" id="kobo.266.1" xmlns="http://www.w3.org/1999/xhtml"> technique normalizes the structure so only a single definition is provided. </span><span class="koboSpan" id="kobo.266.2" xmlns="http://www.w3.org/1999/xhtml">Multiple references to the single definition assure proper reuse of the class definition.</span></p>
<p><span class="koboSpan" id="kobo.267.1" xmlns="http://www.w3.org/1999/xhtml">The JSON structure may look unusual at first glance, but it’s not frighteningly complex. </span><span class="koboSpan" id="kobo.267.2" xmlns="http://www.w3.org/1999/xhtml">Reviewing </span><a class="url" href="https://json-schema.org"><span class="koboSpan" id="kobo.268.1" xmlns="http://www.w3.org/1999/xhtml">https://json-schema.org</span></a><span class="koboSpan" id="kobo.269.1" xmlns="http://www.w3.org/1999/xhtml"> will provide </span><span id="dx1-199035"/><span class="koboSpan" id="kobo.270.1" xmlns="http://www.w3.org/1999/xhtml">information on how best to create JSON Schema definitions </span><span id="dx1-199036"/><span class="koboSpan" id="kobo.271.1" xmlns="http://www.w3.org/1999/xhtml">without using the </span><strong><span class="koboSpan" id="kobo.272.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic</span></strong><span class="koboSpan" id="kobo.273.1" xmlns="http://www.w3.org/1999/xhtml"> module. </span><span id="x1-199037r216"/></p>
</section>
<section class="level3" data-number="12.2.3" id="use-json-schema-to-validate-intermediate-files">
<h3 data-number="12.2.3"><span class="titlemark"><span class="koboSpan" id="kobo.274.1" xmlns="http://www.w3.org/1999/xhtml">8.2.3 </span></span> <span id="x1-2000003"/><span class="koboSpan" id="kobo.275.1" xmlns="http://www.w3.org/1999/xhtml">Use JSON Schema to validate intermediate files</span></h3>
<p><span class="koboSpan" id="kobo.276.1" xmlns="http://www.w3.org/1999/xhtml">Once we have a </span><span id="dx1-200001"/><span class="koboSpan" id="kobo.277.1" xmlns="http://www.w3.org/1999/xhtml">JSON Schema definition, we can provide it to other stakeholders to be sure they understand the data </span><span id="dx1-200002"/><span class="koboSpan" id="kobo.278.1" xmlns="http://www.w3.org/1999/xhtml">required or the data provided. </span><span class="koboSpan" id="kobo.278.2" xmlns="http://www.w3.org/1999/xhtml">We can also use the JSON Schema to create a validator that can examine a JSON document and determine if the document really does match the schema.</span></p>
<p><span class="koboSpan" id="kobo.279.1" xmlns="http://www.w3.org/1999/xhtml">We can do this with a </span><code><span class="koboSpan" id="kobo.280.1" xmlns="http://www.w3.org/1999/xhtml">pydantic</span></code><span class="koboSpan" id="kobo.281.1" xmlns="http://www.w3.org/1999/xhtml"> class definition. </span><span class="koboSpan" id="kobo.281.2" xmlns="http://www.w3.org/1999/xhtml">There’s a </span><code><span class="koboSpan" id="kobo.282.1" xmlns="http://www.w3.org/1999/xhtml">parse_obj()</span></code><span class="koboSpan" id="kobo.283.1" xmlns="http://www.w3.org/1999/xhtml"> method that will examine a dictionary to create an instance of the given </span><code><span class="koboSpan" id="kobo.284.1" xmlns="http://www.w3.org/1999/xhtml">pydantic</span></code><span class="koboSpan" id="kobo.285.1" xmlns="http://www.w3.org/1999/xhtml"> class could be built. </span><span class="koboSpan" id="kobo.285.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.286.1" xmlns="http://www.w3.org/1999/xhtml">parse_raw()</span></code><span class="koboSpan" id="kobo.287.1" xmlns="http://www.w3.org/1999/xhtml"> method can parse a string or bytes object to create an instance of the given class.</span></p>
<p><span class="koboSpan" id="kobo.288.1" xmlns="http://www.w3.org/1999/xhtml">We can also do this with the </span><code><span class="koboSpan" id="kobo.289.1" xmlns="http://www.w3.org/1999/xhtml">jsonschema</span></code><span class="koboSpan" id="kobo.290.1" xmlns="http://www.w3.org/1999/xhtml"> module. </span><span class="koboSpan" id="kobo.290.2" xmlns="http://www.w3.org/1999/xhtml">We’ll look at this as an alternative to </span><code><span class="koboSpan" id="kobo.291.1" xmlns="http://www.w3.org/1999/xhtml">pydantic</span></code><span class="koboSpan" id="kobo.292.1" xmlns="http://www.w3.org/1999/xhtml"> to show how sharing the JSON Schema allows other applications to work with a formal definition of the analysis model.</span></p>
<p><span class="koboSpan" id="kobo.293.1" xmlns="http://www.w3.org/1999/xhtml">First, we need to create a validator from the schema. </span><span class="koboSpan" id="kobo.293.2" xmlns="http://www.w3.org/1999/xhtml">We can dump the JSON into a file and then load the JSON back from the file. </span><span class="koboSpan" id="kobo.293.3" xmlns="http://www.w3.org/1999/xhtml">We can also save a step by creating a validator directly from the </span><strong><span class="koboSpan" id="kobo.294.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic</span></strong><span class="koboSpan" id="kobo.295.1" xmlns="http://www.w3.org/1999/xhtml">-created JSON Schema. </span><span class="koboSpan" id="kobo.295.2" xmlns="http://www.w3.org/1999/xhtml">Here’s the short version:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-146">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.296.1" xmlns="http://www.w3.org/1999/xhtml">from pydantic import schema_of
from jsonschema.validators import Draft202012Validator
from analysis_model import *

schema = schema_of(SeriesSample)
validator = Draft202012Validator(schema)</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.297.1" xmlns="http://www.w3.org/1999/xhtml">This creates a validator using the latest version of JSON Schema, the 2020 draft. </span><span class="koboSpan" id="kobo.297.2" xmlns="http://www.w3.org/1999/xhtml">(The project is on track to become a standard, and has gone through a number of drafts as it matures.)</span></p>
<p><span class="koboSpan" id="kobo.298.1" xmlns="http://www.w3.org/1999/xhtml">Here’s how we might write a function to scan a file to be sure the NDJSON documents all properly fit the defined schema:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-147">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.299.1" xmlns="http://www.w3.org/1999/xhtml">def validate_ndjson_file(
        validator: Draft202012Validator,
        source_file: TextIO
) -&gt; Counter[str]:
    counts: Counter[str] = Counter()
    for row in source_file:
        document = json.loads(row)
        if not validator.is_valid(document):
            errors = list(validator.iter_errors(document))
            print(document, errors)
            counts[’faulty’] += 1
        else:
            counts[’good’] += 1
    return counts</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.300.1" xmlns="http://www.w3.org/1999/xhtml">This </span><span id="dx1-200023"/><span class="koboSpan" id="kobo.301.1" xmlns="http://www.w3.org/1999/xhtml">function will read each NDJSON </span><span id="dx1-200024"/><span class="koboSpan" id="kobo.302.1" xmlns="http://www.w3.org/1999/xhtml">document from the given source file. </span><span class="koboSpan" id="kobo.302.2" xmlns="http://www.w3.org/1999/xhtml">It will use the given validator to see if the document has problems or is otherwise valid. </span><span class="koboSpan" id="kobo.302.3" xmlns="http://www.w3.org/1999/xhtml">For faulty documents, it will print the document and the entire list of validation errors.</span></p>
<p><span class="koboSpan" id="kobo.303.1" xmlns="http://www.w3.org/1999/xhtml">This kind of function can be embedded into a separate script to check files.</span></p>
<p><span class="koboSpan" id="kobo.304.1" xmlns="http://www.w3.org/1999/xhtml">We can, similarly, create the schema for the source model, and use JSON Schema (or </span><strong><span class="koboSpan" id="kobo.305.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic</span></strong><span class="koboSpan" id="kobo.306.1" xmlns="http://www.w3.org/1999/xhtml">) to validate source files before attempting to process them.</span></p>
<p><span class="koboSpan" id="kobo.307.1" xmlns="http://www.w3.org/1999/xhtml">We’ll turn to the more complete validation and cleaning solution in </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.308.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.309.1" xmlns="http://www.w3.org/1999/xhtml"> 9</span></em></a><span class="koboSpan" id="kobo.310.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.311.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.1: Data Cleaning Base Application</span></em></a><span class="koboSpan" id="kobo.312.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.312.2" xmlns="http://www.w3.org/1999/xhtml">This project is one of the foundational components of the more complete solution.</span></p>
<p><span class="koboSpan" id="kobo.313.1" xmlns="http://www.w3.org/1999/xhtml">We’ll look at the deliverables for this project in the next section. </span><span id="x1-200025r214"/></p>
</section>
</section>
<section class="level2" data-number="12.3" id="deliverables-10">
<h2 data-number="12.3"><span class="titlemark"><span class="koboSpan" id="kobo.314.1" xmlns="http://www.w3.org/1999/xhtml">8.3 </span></span> <span id="x1-2010003"/><span class="koboSpan" id="kobo.315.1" xmlns="http://www.w3.org/1999/xhtml">Deliverables</span></h2>
<p><span class="koboSpan" id="kobo.316.1" xmlns="http://www.w3.org/1999/xhtml">This project has the following deliverables:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.317.1" xmlns="http://www.w3.org/1999/xhtml">A </span><code><span class="koboSpan" id="kobo.318.1" xmlns="http://www.w3.org/1999/xhtml">requirements.txt</span></code><span class="koboSpan" id="kobo.319.1" xmlns="http://www.w3.org/1999/xhtml"> file that identifies the tools used, usually </span><code><span class="koboSpan" id="kobo.320.1" xmlns="http://www.w3.org/1999/xhtml">pydantic==1.10.2</span></code><span class="koboSpan" id="kobo.321.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.322.1" xmlns="http://www.w3.org/1999/xhtml">jsonschema==4.16.0</span></code><span class="koboSpan" id="kobo.323.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p></li>
<li><p><span class="koboSpan" id="kobo.324.1" xmlns="http://www.w3.org/1999/xhtml">Documentation in the </span><code><span class="koboSpan" id="kobo.325.1" xmlns="http://www.w3.org/1999/xhtml">docs</span></code><span class="koboSpan" id="kobo.326.1" xmlns="http://www.w3.org/1999/xhtml"> folder.</span></p></li>
<li><p><span class="koboSpan" id="kobo.327.1" xmlns="http://www.w3.org/1999/xhtml">The JSON-format files with the source and analysis schemas. </span><span class="koboSpan" id="kobo.327.2" xmlns="http://www.w3.org/1999/xhtml">A separate </span><code><span class="koboSpan" id="kobo.328.1" xmlns="http://www.w3.org/1999/xhtml">schema</span></code><span class="koboSpan" id="kobo.329.1" xmlns="http://www.w3.org/1999/xhtml"> directory is the suggested location for these files.</span></p></li>
<li><p><span class="koboSpan" id="kobo.330.1" xmlns="http://www.w3.org/1999/xhtml">An acceptance test for the schemas.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.331.1" xmlns="http://www.w3.org/1999/xhtml">We’ll look at the schema acceptance test in some detail. </span><span class="koboSpan" id="kobo.331.2" xmlns="http://www.w3.org/1999/xhtml">Then we’ll look at using schema to extend other acceptance tests. </span><span id="x1-201001r217"/></p>
<section class="level3" data-number="12.3.1" id="schema-acceptance-tests">
<h3 data-number="12.3.1"><span class="titlemark"><span class="koboSpan" id="kobo.332.1" xmlns="http://www.w3.org/1999/xhtml">8.3.1 </span></span> <span id="x1-2020001"/><span class="koboSpan" id="kobo.333.1" xmlns="http://www.w3.org/1999/xhtml">Schema acceptance tests</span></h3>
<p><span class="koboSpan" id="kobo.334.1" xmlns="http://www.w3.org/1999/xhtml">To know if the schema is useful, it is </span><span id="dx1-202001"/><span class="koboSpan" id="kobo.335.1" xmlns="http://www.w3.org/1999/xhtml">essential to have acceptance test cases. </span><span class="koboSpan" id="kobo.335.2" xmlns="http://www.w3.org/1999/xhtml">As new sources of data are integrated into an application, and old sources of data mutate through ordinary bug fixes and upgrades, files will change. </span><span class="koboSpan" id="kobo.335.3" xmlns="http://www.w3.org/1999/xhtml">The new files will often cause problems, and the root cause of the problem will be the unexpected file format change.</span></p>
<p><span class="koboSpan" id="kobo.336.1" xmlns="http://www.w3.org/1999/xhtml">Once a file format change is identified, the smallest relevant example needs to be transformed into an acceptance test. </span><span class="koboSpan" id="kobo.336.2" xmlns="http://www.w3.org/1999/xhtml">The test will — of course — fail. </span><span class="koboSpan" id="kobo.336.3" xmlns="http://www.w3.org/1999/xhtml">Now, the data acquisition pipeline can be fixed knowing there is a precise definition of done.</span></p>
<p><span class="koboSpan" id="kobo.337.1" xmlns="http://www.w3.org/1999/xhtml">To start with, the acceptance test suite should have an example file that’s valid and an example file that’s invalid.</span></p>
<p><span class="koboSpan" id="kobo.338.1" xmlns="http://www.w3.org/1999/xhtml">As we noted in </span><a href="ch008.xhtml#x1-780004"><em><span class="koboSpan" id="kobo.339.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.340.1" xmlns="http://www.w3.org/1999/xhtml"> 4</span></em></a><span class="koboSpan" id="kobo.341.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch008.xhtml#x1-780004"><em><span class="koboSpan" id="kobo.342.1" xmlns="http://www.w3.org/1999/xhtml">Data Acquisition Features: Web APIs and Scraping</span></em></a><span class="koboSpan" id="kobo.343.1" xmlns="http://www.w3.org/1999/xhtml">, we can provide a large block of text as part of a Gherkin scenario. </span><span class="koboSpan" id="kobo.343.2" xmlns="http://www.w3.org/1999/xhtml">We can consider something like the following scenario:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-148">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.344.1" xmlns="http://www.w3.org/1999/xhtml">Scenario: Valid file is recognized.
    </span><span class="koboSpan" id="kobo.344.2" xmlns="http://www.w3.org/1999/xhtml">Given a file "example_1.ndjson" with the following content
        """
        {"x": 1.2, "y": 3.4}
        {"x": 5.6, "y": 7.8}
        """
    When the schema validation tool is run with the analysis schema
    Then the output shows 2 good records
    And the output shows 0 faulty records</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.345.1" xmlns="http://www.w3.org/1999/xhtml">This allows us to provide the contents for an NDJSON file. </span><span class="koboSpan" id="kobo.345.2" xmlns="http://www.w3.org/1999/xhtml">The HTML extract command is quite long. </span><span class="koboSpan" id="kobo.345.3" xmlns="http://www.w3.org/1999/xhtml">The content is available as the </span><code><span class="koboSpan" id="kobo.346.1" xmlns="http://www.w3.org/1999/xhtml">context.text</span></code><span class="koboSpan" id="kobo.347.1" xmlns="http://www.w3.org/1999/xhtml"> parameter of the step definition function. </span><span class="koboSpan" id="kobo.347.2" xmlns="http://www.w3.org/1999/xhtml">See </span><a href="ch008.xhtml#x1-1050004"><em><span class="koboSpan" id="kobo.348.1" xmlns="http://www.w3.org/1999/xhtml">Acceptance tests</span></em></a><span class="koboSpan" id="kobo.349.1" xmlns="http://www.w3.org/1999/xhtml"> for more examples of how to write the step </span><span id="dx1-202011"/><span class="koboSpan" id="kobo.350.1" xmlns="http://www.w3.org/1999/xhtml">definitions to create a temporary file to be used for this test case.</span></p>
<p><span class="koboSpan" id="kobo.351.1" xmlns="http://www.w3.org/1999/xhtml">Scenarios for faulty records are also essential, of course. </span><span class="koboSpan" id="kobo.351.2" xmlns="http://www.w3.org/1999/xhtml">It’s important to be sure the schema definition will reject invalid data. </span><span id="x1-202012r219"/></p>
</section>
<section class="level3" data-number="12.3.2" id="extended-acceptance-testing">
<h3 data-number="12.3.2"><span class="titlemark"><span class="koboSpan" id="kobo.352.1" xmlns="http://www.w3.org/1999/xhtml">8.3.2 </span></span> <span id="x1-2030002"/><span class="koboSpan" id="kobo.353.1" xmlns="http://www.w3.org/1999/xhtml">Extended acceptance testing</span></h3>
<p><span class="koboSpan" id="kobo.354.1" xmlns="http://www.w3.org/1999/xhtml">In </span><em><span class="koboSpan" id="kobo.355.1" xmlns="http://www.w3.org/1999/xhtml">Chapters 3</span></em><span class="koboSpan" id="kobo.356.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.357.1" xmlns="http://www.w3.org/1999/xhtml">4</span></em><span class="koboSpan" id="kobo.358.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><em><span class="koboSpan" id="kobo.359.1" xmlns="http://www.w3.org/1999/xhtml">5</span></em><span class="koboSpan" id="kobo.360.1" xmlns="http://www.w3.org/1999/xhtml">, we wrote acceptance tests that — generally — looked at log summaries of the application’s activity to be sure it </span><span id="dx1-203001"/><span class="koboSpan" id="kobo.361.1" xmlns="http://www.w3.org/1999/xhtml">properly acquired source data. </span><span class="koboSpan" id="kobo.361.2" xmlns="http://www.w3.org/1999/xhtml">We did not write acceptance tests that specifically looked at the data.</span></p>
<p><span class="koboSpan" id="kobo.362.1" xmlns="http://www.w3.org/1999/xhtml">Testing with a schema definition permits a complete analysis of each and every field and record in a file. </span><span class="koboSpan" id="kobo.362.2" xmlns="http://www.w3.org/1999/xhtml">The completeness of this check is of tremendous value.</span></p>
<p><span class="koboSpan" id="kobo.363.1" xmlns="http://www.w3.org/1999/xhtml">This means that we can add some additional Then steps to existing scenarios. </span><span class="koboSpan" id="kobo.363.2" xmlns="http://www.w3.org/1999/xhtml">They might look like the following:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-149">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.364.1" xmlns="http://www.w3.org/1999/xhtml">    # Given (shown earlier)...
    </span><span class="koboSpan" id="kobo.364.2" xmlns="http://www.w3.org/1999/xhtml"># When (shown earlier)...
    </span><span class="koboSpan" id="kobo.364.3" xmlns="http://www.w3.org/1999/xhtml">Then the log has an INFO line with "header: [’x’, ’y’]"
    And log has INFO line with "Series_1 count: 11"
    And log has INFO line with "Series_2 count: 11"
    And log has INFO line with "Series_3 count: 11"
    And log has INFO line with "Series_4 count: 11"
    And the output directory files are valid
        using the "schema/Anscombe_Source.json" schema</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.365.1" xmlns="http://www.w3.org/1999/xhtml">The additional ”Then the output directory files are valid...” </span><span class="koboSpan" id="kobo.365.2" xmlns="http://www.w3.org/1999/xhtml">line requires a step definition that must do the following things:</span></p>
<ol>
<li><div id="x1-203012x1">
<p><span class="koboSpan" id="kobo.366.1" xmlns="http://www.w3.org/1999/xhtml">Load the named JSON Schema file and build a </span><code><span class="koboSpan" id="kobo.367.1" xmlns="http://www.w3.org/1999/xhtml">Validator</span></code><span class="koboSpan" id="kobo.368.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
</div></li>
<li><div id="x1-203014x2">
<p><span class="koboSpan" id="kobo.369.1" xmlns="http://www.w3.org/1999/xhtml">Use the </span><code><span class="koboSpan" id="kobo.370.1" xmlns="http://www.w3.org/1999/xhtml">Validator</span></code><span class="koboSpan" id="kobo.371.1" xmlns="http://www.w3.org/1999/xhtml"> object to examine each line of the ND JSON file to be sure they’re valid.</span></p>
</div></li>
</ol>
<p><span class="koboSpan" id="kobo.372.1" xmlns="http://www.w3.org/1999/xhtml">This use of the schema as part of the acceptance test suite will parallel the way data suppliers and data consumers can use the schema to assure the data files are valid.</span></p>
<p><span class="koboSpan" id="kobo.373.1" xmlns="http://www.w3.org/1999/xhtml">It’s important to note the </span><span id="dx1-203015"/><span class="koboSpan" id="kobo.374.1" xmlns="http://www.w3.org/1999/xhtml">schema definition given earlier in this chapter (in </span><a href="#x1-1980001"><em><span class="koboSpan" id="kobo.375.1" xmlns="http://www.w3.org/1999/xhtml">Define Pydantic classes and emit the JSON Schema</span></em></a><span class="koboSpan" id="kobo.376.1" xmlns="http://www.w3.org/1999/xhtml">) was the output from a future project’s data cleaning step. </span><span class="koboSpan" id="kobo.376.2" xmlns="http://www.w3.org/1999/xhtml">The schema shown in that example is not the output from the previous data acquisition applications.</span></p>
<p><span class="koboSpan" id="kobo.377.1" xmlns="http://www.w3.org/1999/xhtml">To validate the output from data acquisition, you will need to use the model for the various data acquisition projects in </span><em><span class="koboSpan" id="kobo.378.1" xmlns="http://www.w3.org/1999/xhtml">Chapters 3</span></em><span class="koboSpan" id="kobo.379.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.380.1" xmlns="http://www.w3.org/1999/xhtml">4</span></em><span class="koboSpan" id="kobo.381.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><em><span class="koboSpan" id="kobo.382.1" xmlns="http://www.w3.org/1999/xhtml">5</span></em><span class="koboSpan" id="kobo.383.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.383.2" xmlns="http://www.w3.org/1999/xhtml">This will be </span><strong><span class="koboSpan" id="kobo.384.1" xmlns="http://www.w3.org/1999/xhtml">very</span></strong><span class="koboSpan" id="kobo.385.1" xmlns="http://www.w3.org/1999/xhtml"> similar to the example shown earlier in this chapter. </span><span class="koboSpan" id="kobo.385.2" xmlns="http://www.w3.org/1999/xhtml">While similar, it will differ in a profound way: it will use </span><code><span class="koboSpan" id="kobo.386.1" xmlns="http://www.w3.org/1999/xhtml">str</span></code><span class="koboSpan" id="kobo.387.1" xmlns="http://www.w3.org/1999/xhtml"> instead of </span><code><span class="koboSpan" id="kobo.388.1" xmlns="http://www.w3.org/1999/xhtml">float</span></code><span class="koboSpan" id="kobo.389.1" xmlns="http://www.w3.org/1999/xhtml"> for the series sample attribute values. </span><span id="x1-203016r218"/></p>
</section>
</section>
<section class="level2" data-number="12.4" id="summary-7">
<h2 data-number="12.4"><span class="titlemark"><span class="koboSpan" id="kobo.390.1" xmlns="http://www.w3.org/1999/xhtml">8.4 </span></span> <span id="x1-2040004"/><span class="koboSpan" id="kobo.391.1" xmlns="http://www.w3.org/1999/xhtml">Summary</span></h2>
<p><span class="koboSpan" id="kobo.392.1" xmlns="http://www.w3.org/1999/xhtml">This chapter’s projects have shown examples of the following features of a data acquisition application:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.393.1" xmlns="http://www.w3.org/1999/xhtml">Using the Pydantic module for crisp, complete definitions</span></p></li>
<li><p><span class="koboSpan" id="kobo.394.1" xmlns="http://www.w3.org/1999/xhtml">Using JSON Schema to create an exportable language-independent definition that anyone can use</span></p></li>
<li><p><span class="koboSpan" id="kobo.395.1" xmlns="http://www.w3.org/1999/xhtml">Creating test scenarios to use the formal schema definition</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.396.1" xmlns="http://www.w3.org/1999/xhtml">Having formalized schema definitions permits recording additional details about the data processing applications and the transformations applied to the data.</span></p>
<p><span class="koboSpan" id="kobo.397.1" xmlns="http://www.w3.org/1999/xhtml">The docstrings for the class definitions become the descriptions in the schema. </span><span class="koboSpan" id="kobo.397.2" xmlns="http://www.w3.org/1999/xhtml">This permits writing details on data provenance and transformation that are exposed to all users of the data.</span></p>
<p><span class="koboSpan" id="kobo.398.1" xmlns="http://www.w3.org/1999/xhtml">The JSON Schema standard permits recording examples of values. </span><span class="koboSpan" id="kobo.398.2" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.399.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.400.1" xmlns="http://www.w3.org/1999/xhtml">package has ways to include this metadata in field definitions, and class configuration objects. </span><span class="koboSpan" id="kobo.400.2" xmlns="http://www.w3.org/1999/xhtml">This can be helpful when explaining odd or unusual data encodings.</span></p>
<p><span class="koboSpan" id="kobo.401.1" xmlns="http://www.w3.org/1999/xhtml">Further, for text fields, JSONSchema permits including a format attribute that can provide a regular expression used to validate the text. </span><span class="koboSpan" id="kobo.401.2" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.402.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic</span></strong><span class="koboSpan" id="kobo.403.1" xmlns="http://www.w3.org/1999/xhtml"> package has first-class </span><span id="dx1-204001"/><span class="koboSpan" id="kobo.404.1" xmlns="http://www.w3.org/1999/xhtml">support for this additional validation of text fields.</span></p>
<p><span class="koboSpan" id="kobo.405.1" xmlns="http://www.w3.org/1999/xhtml">We’ll return to the details of data validation in </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.406.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.407.1" xmlns="http://www.w3.org/1999/xhtml"> 9</span></em></a><span class="koboSpan" id="kobo.408.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.409.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.1: Data</span></em> <em><span class="koboSpan" id="kobo.410.1" xmlns="http://www.w3.org/1999/xhtml">Cleaning Base Application</span></em></a><span class="koboSpan" id="kobo.411.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><a href="ch014.xhtml#x1-22900010"><em><span class="koboSpan" id="kobo.412.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.413.1" xmlns="http://www.w3.org/1999/xhtml"> 10</span></em></a><span class="koboSpan" id="kobo.414.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch014.xhtml#x1-22900010"><em><span class="koboSpan" id="kobo.415.1" xmlns="http://www.w3.org/1999/xhtml">Data Cleaning Features</span></em></a><span class="koboSpan" id="kobo.416.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.416.2" xmlns="http://www.w3.org/1999/xhtml">In those chapters, we’ll delve more deeply into the various </span><strong><span class="koboSpan" id="kobo.417.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.418.1" xmlns="http://www.w3.org/1999/xhtml">validation features. </span><span id="x1-204002r221"/></p>
</section>
<section class="level2" data-number="12.5" id="extras-6">
<h2 data-number="12.5"><span class="titlemark"><span class="koboSpan" id="kobo.419.1" xmlns="http://www.w3.org/1999/xhtml">8.5 </span></span> <span id="x1-2050005"/><span class="koboSpan" id="kobo.420.1" xmlns="http://www.w3.org/1999/xhtml">Extras</span></h2>
<p><span class="koboSpan" id="kobo.421.1" xmlns="http://www.w3.org/1999/xhtml">Here are some ideas for you to add to this project. </span><span id="x1-205001r220"/></p>
<section class="level3" data-number="12.5.1" id="revise-all-previous-chapter-models-to-use-pydantic">
<h3 data-number="12.5.1"><span class="titlemark"><span class="koboSpan" id="kobo.422.1" xmlns="http://www.w3.org/1999/xhtml">8.5.1 </span></span> <span id="x1-2060001"/><span class="koboSpan" id="kobo.423.1" xmlns="http://www.w3.org/1999/xhtml">Revise all previous chapter models to use Pydantic</span></h3>
<p><span class="koboSpan" id="kobo.424.1" xmlns="http://www.w3.org/1999/xhtml">The previous chapters used </span><code><span class="koboSpan" id="kobo.425.1" xmlns="http://www.w3.org/1999/xhtml">dataclass</span></code><span class="koboSpan" id="kobo.426.1" xmlns="http://www.w3.org/1999/xhtml"> definitions from the </span><code><span class="koboSpan" id="kobo.427.1" xmlns="http://www.w3.org/1999/xhtml">dataclasses</span></code><span class="koboSpan" id="kobo.428.1" xmlns="http://www.w3.org/1999/xhtml"> module. </span><span class="koboSpan" id="kobo.428.2" xmlns="http://www.w3.org/1999/xhtml">These can be shifted to use the </span><code><span class="koboSpan" id="kobo.429.1" xmlns="http://www.w3.org/1999/xhtml">pydantic.dataclasses</span></code><span class="koboSpan" id="kobo.430.1" xmlns="http://www.w3.org/1999/xhtml"> module. </span><span class="koboSpan" id="kobo.430.2" xmlns="http://www.w3.org/1999/xhtml">This should have minimal impact on the previous projects.</span></p>
<p><span class="koboSpan" id="kobo.431.1" xmlns="http://www.w3.org/1999/xhtml">We can also shift all of the previous acceptance test suites to use a formal schema definition for the source data.</span></p>
<p><span id="x1-206001r223"/></p>
</section>
<section class="level3" data-number="12.5.2" id="use-the-orm-layer">
<h3 data-number="12.5.2"><span class="titlemark"><span class="koboSpan" id="kobo.432.1" xmlns="http://www.w3.org/1999/xhtml">8.5.2 </span></span> <span id="x1-2070002"/><span class="koboSpan" id="kobo.433.1" xmlns="http://www.w3.org/1999/xhtml">Use the ORM layer</span></h3>
<p><span class="koboSpan" id="kobo.434.1" xmlns="http://www.w3.org/1999/xhtml">For SQL extracts, an </span><span id="dx1-207001"/><span class="koboSpan" id="kobo.435.1" xmlns="http://www.w3.org/1999/xhtml">ORM can be helpful. </span><span class="koboSpan" id="kobo.435.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.436.1" xmlns="http://www.w3.org/1999/xhtml">pydantic</span></code><span class="koboSpan" id="kobo.437.1" xmlns="http://www.w3.org/1999/xhtml"> module lets an application create Python objects from intermediate ORM objects. </span><span class="koboSpan" id="kobo.437.2" xmlns="http://www.w3.org/1999/xhtml">This two-layer processing seems complex but permits detailed validation in the </span><strong><span class="koboSpan" id="kobo.438.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.439.1" xmlns="http://www.w3.org/1999/xhtml">objects that aren’t handled by the database.</span></p>
<p><span class="koboSpan" id="kobo.440.1" xmlns="http://www.w3.org/1999/xhtml">For example, a database may have a numeric column without any range provided. </span><span class="koboSpan" id="kobo.440.2" xmlns="http://www.w3.org/1999/xhtml">A </span><strong><span class="koboSpan" id="kobo.441.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.442.1" xmlns="http://www.w3.org/1999/xhtml">class definition can provide a field definition with </span><code><span class="koboSpan" id="kobo.443.1" xmlns="http://www.w3.org/1999/xhtml">ge</span></code><span class="koboSpan" id="kobo.444.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.445.1" xmlns="http://www.w3.org/1999/xhtml">le</span></code><span class="koboSpan" id="kobo.446.1" xmlns="http://www.w3.org/1999/xhtml"> attributes to define a range. </span><span class="koboSpan" id="kobo.446.2" xmlns="http://www.w3.org/1999/xhtml">Further, </span><strong><span class="koboSpan" id="kobo.447.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.448.1" xmlns="http://www.w3.org/1999/xhtml">permits the definition of a unique data type with unique validation rules that can be applied to database extract values.</span></p>
<p><span class="koboSpan" id="kobo.449.1" xmlns="http://www.w3.org/1999/xhtml">First, see </span><a class="url" href="https://docs.sqlalchemy.org/en/20/orm/"><span class="koboSpan" id="kobo.450.1" xmlns="http://www.w3.org/1999/xhtml">https://docs.sqlalchemy.org/en/20/orm/</span></a><span class="koboSpan" id="kobo.451.1" xmlns="http://www.w3.org/1999/xhtml"> for information on the SQLAlchemy ORM layer. </span><span class="koboSpan" id="kobo.451.2" xmlns="http://www.w3.org/1999/xhtml">This provides a class definition from which SQL statements like </span><code><span class="koboSpan" id="kobo.452.1" xmlns="http://www.w3.org/1999/xhtml">CREATE</span></code><code><span class="koboSpan" id="kobo.453.1" xmlns="http://www.w3.org/1999/xhtml"> TABLE</span></code><span class="koboSpan" id="kobo.454.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.455.1" xmlns="http://www.w3.org/1999/xhtml">SELECT</span></code><span class="koboSpan" id="kobo.456.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><code><span class="koboSpan" id="kobo.457.1" xmlns="http://www.w3.org/1999/xhtml">INSERT</span></code><span class="koboSpan" id="kobo.458.1" xmlns="http://www.w3.org/1999/xhtml"> can be derived.</span></p>
<p><span class="koboSpan" id="kobo.459.1" xmlns="http://www.w3.org/1999/xhtml">Then, see the </span><a class="url" href="https://docs.pydantic.dev/usage/models/#orm-mode-aka-arbitrary-class-instances"><span class="koboSpan" id="kobo.460.1" xmlns="http://www.w3.org/1999/xhtml">https://docs.pydantic.dev/usage/models/#orm-mode-aka-arbitrary-class-instances</span></a><span class="koboSpan" id="kobo.461.1" xmlns="http://www.w3.org/1999/xhtml"> ”ORM Mode (aka Arbitrary Class Instances)” section of the </span><strong><span class="koboSpan" id="kobo.462.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic</span></strong><span class="koboSpan" id="kobo.463.1" xmlns="http://www.w3.org/1999/xhtml"> documentation for </span><span id="dx1-207002"/><span class="koboSpan" id="kobo.464.1" xmlns="http://www.w3.org/1999/xhtml">ways to map a more useful class to the intermediate ORM class.</span></p>
<p><span class="koboSpan" id="kobo.465.1" xmlns="http://www.w3.org/1999/xhtml">For legacy data in a quirky, poorly-designed database, this can become a problem. </span><span class="koboSpan" id="kobo.465.2" xmlns="http://www.w3.org/1999/xhtml">For databases designed from the beginning with an ORM layer, on the other hand, this can be a simplification to the SQL. </span><span id="x1-207003r212"/></p>
</section>
</section>
</section>
</body>
</html>
