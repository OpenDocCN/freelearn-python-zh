<html><head></head><body>
		<div id="_idContainer158">
			<h1 id="_idParaDest-263"><em class="italic"><a id="_idTextAnchor293"/>Chapter 10</em>: Database Management</h1>
			<p>In programming, the subject of database management encompasses a broad spectrum of subcategories. Many of those categories were already introduced in earlier chapters, such as in <a href="B17243_02_ePub.xhtml#_idTextAnchor037"><em class="italic">Chapter 2</em></a>, <em class="italic">Project Configuration</em>, when we discussed the concept of using a database management tool, or in <a href="B17243_03_ePub.xhtml#_idTextAnchor077"><em class="italic">Chapter 3</em></a>, <em class="italic">Models, Relations, and Inheritance</em>, when we explored the concept of model managers. While these subjects can be considered topics of this chapter, they were introduced in earlier chapters to better fit what that chapter's subject matter was discussing or to serve as a tool that was suited to the exercises in those earlier chapters. The Django fixtures that were introduced and used in <a href="B17243_03_ePub.xhtml#_idTextAnchor077"><em class="italic">Chapter 3</em></a>, <em class="italic">Models, Relations, and Inheritance</em>, can also be considered a database management tool and will finally be covered in more depth in this chapter. </p>
			<p>Django fixtures are used to import and export data found in a database that is connected to a Django project. The <strong class="source-inline">chapter_3</strong> data fixture that was provided and used throughout every chapter prior to this chapter helped to demonstrate those exercises by providing the necessary test/dummy data for you. We will cover how to export data, creating our own data fixtures for projects and developers to use. We will also explain in a little more depth the import process that we have been using and the options that are available.</p>
			<p>In this chapter, we will explore other methods of executing queries that enhance the overall performance of your system. The two methods commonly used are <strong class="source-inline">select_related()</strong> and <strong class="source-inline">prefetch_related()</strong>, which are known in Django as <strong class="bold">performance boosters</strong>. We will practice using these performance boosters on queries made to the <strong class="source-inline">Vehicle</strong> and <strong class="source-inline">Seller</strong> model class data that exists in our database. We will use the <strong class="bold">Django Debug Toolbar</strong> (<strong class="bold">DjDT</strong>) introduced in <a href="B17243_09_ePub.xhtml#_idTextAnchor272"><em class="italic">Chapter 9</em></a>, <em class="italic">Django Testing</em>, to monitor how the performance changes.</p>
			<p>In this chapter, we will cover the following:</p>
			<ul>
				<li>Exporting data into a data fixture</li>
				<li>Importing data from a data fixture</li>
				<li>Boosting query performance using the <strong class="source-inline">select_related()</strong> method</li>
				<li>Boosting query performance using the <strong class="source-inline">prefetch_related()</strong> method</li>
				<li>Boosting query performance using the <strong class="source-inline">Prefetch()</strong> class</li>
			</ul>
			<h1 id="_idParaDest-264"><a id="_idTextAnchor294"/>Technical requirements</h1>
			<p>To work with the code in this chapter, the following tools will need to be installed on your local machine:</p>
			<ul>
				<li>Python version 3.9 – used as the underlying programming language for the project</li>
				<li>Django version 4.0 – used as the backend framework of the project </li>
				<li>pip package manager – used to manage third-party Python/Django packages</li>
			</ul>
			<p>We will continue to work with the solution created in <a href="B17243_02_ePub.xhtml#_idTextAnchor037"><em class="italic">Chapter 2</em></a>, <em class="italic">Project Configuration</em>. However, it is not necessary to use the Visual Studio IDE. The main project itself can be run using another IDE or run independently using a terminal or command-line window from within the project root folder, which is where the <strong class="source-inline">manage.py</strong> file resides. Whatever editor or IDE you are using, a virtual environment will also be needed to work with the Django project. Instructions for how to create a project and virtual environment can be found in <a href="B17243_02_ePub.xhtml#_idTextAnchor037"><em class="italic">Chapter 2</em></a>, <em class="italic">Project Configuration</em>. You will need a database to store the data contained in your project. PostgreSQL was chosen for the examples in the previous chapter; however, any database type that you choose for your project can be used to work with the examples in this chapter.</p>
			<p>We will also be using data that is in the form of a Django fixture, provided in <a href="B17243_03_ePub.xhtml#_idTextAnchor077"><em class="italic">Chapter 3</em></a>, <em class="italic">Models, Relations, and Inheritance</em>, in the subsection titled <em class="italic">Loading the chapter_3 data fixture</em>. Make sure the <strong class="source-inline">chapter_3</strong> fixture is loaded into your database. If this has already been done, then you may skip the next command. If you have already created the tables found in <a href="B17243_03_ePub.xhtml#_idTextAnchor077"><em class="italic">Chapter 3</em></a>, <em class="italic">Models, Relations, and Inheritance</em>, and have not loaded that fixture yet, then run the following command, after activating your virtual environment:</p>
			<p class="source-code">(virtual_env) PS &gt; python manage.py loaddata chapter_3</p>
			<p>All of the code created in this chapter can be found in the GitHub repository for this book: <a href="https://github.com/PacktPublishing/Becoming-an-Enterprise-Django-Developer">https://github.com/PacktPublishing/Becoming-an-Enterprise-Django-Developer</a>. The bulk of the code depicted in this chapter can be found in the <strong class="source-inline">/becoming_a_django_entdev/becoming_a_django_entdev/chapter_10/</strong> directory.</p>
			<p>Check out the following video to see the <em class="italic">Code in Action</em>: <a href="https://bit.ly/3zYgbqd">https://bit.ly/3zYgbqd</a>.</p>
			<h1 id="_idParaDest-265"><a id="_idTextAnchor295"/>Preparing for this chapter</h1>
			<p>Start by creating a new app in your project called <strong class="source-inline">chapter_10</strong> by following the steps discussed in <a href="B17243_02_ePub.xhtml#_idTextAnchor037"><em class="italic">Chapter 2</em></a>, <em class="italic">Project Configuration</em>, in the subsection titled <em class="italic">Creating a Django app</em>. As discussed in that section, don't forget to change the value of the <strong class="source-inline">name =</strong> variable for your app class found in the <strong class="source-inline">/becoming_a_django_entdev/becoming_a_django_entdev/chapter_10/apps.py</strong> file to now point to the path where you installed your app. Be sure to also include this app in the <strong class="source-inline">INSTALLED_APPS</strong> variable found in the <strong class="source-inline">settings.py</strong> file as well.</p>
			<p>In the main <strong class="source-inline">urls.py</strong> file of the site, add the following path, which points to the URL patterns of this chapter that we will be creating:</p>
			<pre class="source-code"><strong class="bold"># /becoming_a_django_entdev/urls.py</strong></pre>
			<pre class="source-code">...</pre>
			<pre class="source-code">urlpatterns = [</pre>
			<pre class="source-code">    <strong class="bold">path(</strong></pre>
			<pre class="source-code">        <strong class="bold">'',   </strong></pre>
			<pre class="source-code">        <strong class="bold">include(</strong></pre>
			<pre class="source-code">            <strong class="bold">'becoming_a_django_entdev.chapter_10.urls'</strong></pre>
			<pre class="source-code">        <strong class="bold">)</strong></pre>
			<pre class="source-code">    <strong class="bold">)</strong>,</pre>
			<pre class="source-code">]</pre>
			<p>Next, copy the <strong class="source-inline">/chapter_10/urls.py</strong> file from the code provided with this book into your project in the same directory.</p>
			<p>In the following exercises, we will use the DjDT that was introduced in <a href="B17243_09_ePub.xhtml#_idTextAnchor272"><em class="italic">Chapter 9</em></a>, <em class="italic">Django Testing</em>, to monitor performance. Please make sure that you have installed the DjDT in your project before proceeding. Instructions can be found in the subsection titled <em class="italic">Installing the DjDT</em> of that chapter. </p>
			<p>Now that we have created the app for this chapter, let's start by creating our own data fixtures.</p>
			<h1 id="_idParaDest-266"><a id="_idTextAnchor296"/>Exporting data into a data fixture</h1>
			<p>A <strong class="bold">data fixture</strong> is<a id="_idIndexMarker1212"/> considered a collection of files that contain data objects related to the models in your application. This really refers to a directory of files that Django searches in for data; by default, that is the <strong class="source-inline">fixtures</strong> folder found in every Django app. This directory can also be changed by modifying the <strong class="source-inline">settings.py</strong> variable called <strong class="source-inline">FIXTURE_DIRS</strong>, but this is not necessary if you intend to use the default directory and behavior. Django fixture files can be written in JSON, JSONL, XML, or YAML file formats. This <a id="_idIndexMarker1213"/>means you can easily export data from other systems if that data is exported into one of these formats, even if that other system is not a Django project. Keep in mind that the table structure of the objects must match exactly if you wish to do a clean export from an old system and import into a new system. </p>
			<p>Usually, there is a great deal of data parsing involved when exporting from an older legacy system and importing into the newly updated system. The other option is to use one or a combination of many command options when exporting or importing data to prevent errors when data structures do not align. Sometimes, using the options provided is not enough to accomplish what needs to be done to your data. <strong class="bold">Parsing data</strong> is the<a id="_idIndexMarker1214"/> process of transforming data from one format or data type to another. We sometimes have to parse data because a newer system changes the data structure and/or constraints that were set on the old data structures. When that happens, we sometimes get errors during the import. Sometimes, data imports fine but at runtime, your users experience odd behavior as a result of improperly formatted data found within your database. We will only cover using the options provided in this chapter; if data in your system is so complex that it needs to be parsed, you will have to look into writing your own Python script to transform your data as needed.</p>
			<p>Let's practice using the Django <strong class="source-inline">dumpdata</strong> management command next.</p>
			<h2 id="_idParaDest-267"><a id="_idTextAnchor297"/>Using the dumpdata command</h2>
			<p>The <strong class="source-inline">dumpdata</strong> management command is the opposite of the <strong class="source-inline">loaddata</strong> command that we<a id="_idIndexMarker1215"/> have been using to import the <strong class="source-inline">chapter_3</strong> fixture data. It is used to export data from a database connected to your Django project into a data fixture. By default, Django will export data fixtures into JSON format, but you can specify a different format by using the <strong class="source-inline">--format</strong> option when running the <strong class="source-inline">dumpdata</strong> command. </p>
			<p>We will start by just dumping the tables of all applications in our project using the <strong class="source-inline">-o</strong> or <strong class="source-inline">--output</strong> option to place a fixture in the <strong class="source-inline">chapter_10</strong> app directory, in order to keep the chapter exercises nicely organized. Every <strong class="source-inline">dumpdata</strong> exercise in this chapter will use the <strong class="source-inline">--output</strong> option for this reason; it is not a required option.</p>
			<p>More information about these options and other options that are not covered can be found here: <a href="https://docs.djangoproject.com/en/4.0/ref/django-admin/#dumpdata">https://docs.djangoproject.com/en/4.0/ref/django-admin/#dumpdata</a>.</p>
			<p>Before proceeding with this exercise, make sure you have data in your database, whether you added it manually or imported it from the <strong class="source-inline">chapter_3</strong> app. We will export all existing data into a <strong class="source-inline">chapter_10</strong> data fixture folder for practice, by following these steps:</p>
			<ol>
				<li>Make sure you are inside your project's root directory, the same folder where your <strong class="source-inline">manage.py</strong> file is located. Then, open your command-line window or terminal and activate your virtual environment, but do not run your project at this time.</li>
				<li>Create a new folder called <strong class="source-inline">fixtures</strong> in your <strong class="source-inline">/becoming_a_django_entdev/chapter_10/</strong> directory using the following command:<p class="source-code"><strong class="bold">(virtual_env) PS &gt; mkdir becoming_a_django_entdev/chapter_10/fixtures</strong></p></li>
				<li>Execute the <strong class="source-inline">dumpdata</strong> command using the <strong class="source-inline">-o</strong> output option to place the dumped data into a file called <strong class="source-inline">chapter_10.json</strong> inside the folder we just created:<p class="source-code"><strong class="bold">(virtual_env) PS &gt; python manage.py dumpdata -o becoming_a_django_entdev/chapter_10/fixtures/chapter_10.json</strong></p></li>
			</ol>
			<p>If you were <a id="_idIndexMarker1216"/>successful, you should now see a new file called <strong class="source-inline">chapter_10.json</strong> in your <strong class="source-inline">/becoming_a_django_entdev/chapter_10/fixtures/</strong> folder, as shown in the following screenshot, using the <strong class="bold">Solution Explorer</strong> in the Visual Studio IDE:</p>
			<div>
				<div id="_idContainer143" class="IMG---Figure">
					<img src="image/Figure_10.01_B17243.jpg" alt="Figure 10.1 – Dumping all data with the dumpdata command&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.1 – Dumping all data with the dumpdata command</p>
			<p>The reason we had to create the <strong class="source-inline">fixtures</strong> folder first is that the <strong class="source-inline">dumpdata</strong> command will fail if we specify a folder that does not exist. The actual <strong class="source-inline">.json</strong> file doesn't have to exist, Django will create that file for you. Keep in mind that if your <strong class="source-inline">.json</strong> file does already exist and you run the <strong class="source-inline">dumpdata</strong> command specifying that file as the output option, then all the data in your existing fixture file will be overwritten and lost.</p>
			<p>Inside the <strong class="source-inline">chapter_10.json</strong> file that was created, you will notice that it is in minified file format. You are welcome to format that document into something readable. In Visual Studio, you can right-click inside your document and select <strong class="bold">Format Document</strong> to do that. You can also copy and paste that data into an online formatting tool, such as my<a id="_idIndexMarker1217"/> favorite, <a href="https://jsonlint.com/">https://jsonlint.com/</a>. Formatting the document is not necessary but it is helpful if you want to read the data objects and/or edit them directly in that file.</p>
			<p>You'll also<a id="_idIndexMarker1218"/> notice that inside the <strong class="source-inline">chapter_10.json</strong> file that was created, you will have data for every app of your project, including the <strong class="source-inline">auth</strong>, <strong class="source-inline">authtoken</strong>, and <strong class="source-inline">chapter_3</strong> data tables and any Django-related data tables, such as the <strong class="source-inline">admin</strong> and <strong class="source-inline">contenttypes</strong> tables. This is far more information than what was provided to you in the <strong class="source-inline">chapter_3.json</strong> data fixture. Odds are, you won't need to include information such as the <strong class="source-inline">admin.logentry</strong> and <strong class="source-inline">contenttypes.contenttype</strong> objects, as they usually cause conflicts when importing that data into a different system. </p>
			<p>In the next subsection, we will practice exporting only the tables found in a specific application of a project by specifying the <strong class="source-inline">app_name</strong> and/or <strong class="source-inline">model_name</strong> of what data we want to include.</p>
			<h3>Exporting a specific application</h3>
			<p>When <a id="_idIndexMarker1219"/>using the <strong class="source-inline">dumpdata</strong> command without specifying any application, just like we did in the previous exercise, Django will export data from all tables in all applications of a project. There is no option syntax for doing this; if there was, it would be in <strong class="source-inline">dumpdata {{ app_name }}</strong> or <strong class="source-inline">dumpdata {{ app_name.model_name }}</strong> format, without the curly brackets of course.</p>
			<p>To specify an app or table, follow these steps:</p>
			<ol>
				<li value="1">Make sure you are inside your project's root directory, the same folder where your <strong class="source-inline">manage.py</strong> file is located. Then, open a command-line window or terminal and activate your virtual environment, but do not run your project at this time.</li>
				<li>Execute the following <strong class="source-inline">dumpdata</strong> command, which will specify all of the tables found only in the <strong class="source-inline">chapter_3</strong> application:<p class="source-code"><strong class="bold">(virtual_env) PS &gt; python manage.py dumpdata chapter_3 -o becoming_a_django_entdev/chapter_10/fixtures/chapter_3_models.json</strong></p></li>
			</ol>
			<p>Now, what should have been created for us is a single file called <strong class="source-inline">chapter_3_models.json</strong> in the <strong class="source-inline">/chapter_10/fixtures/</strong> folder. It should contain data for only the <strong class="source-inline">vehiclemodel</strong>, <strong class="source-inline">engine</strong>, <strong class="source-inline">vehicle</strong>, and <strong class="source-inline">seller</strong> tables. All of the other data that we saw in the previous fixture file will no longer be found in this new file.</p>
			<ol>
				<li value="3">Inside that file, format<a id="_idIndexMarker1220"/> the data so that you can read what is found in it. If you are using Visual Studio, right-click inside your document and select <strong class="bold">Format Document</strong> or copy and paste the data into the online tool found at <a href="https://jsonlint.com/">https://jsonlint.com/</a>. Your data should look similar to that in the following screenshot:</li>
			</ol>
			<div>
				<div id="_idContainer144" class="IMG---Figure">
					<img src="image/Figure_10.02_B17243.jpg" alt="Figure 10.2 – Dump chapter_3 app dumpdata command&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.2 – Dump chapter_3 app dumpdata command</p>
			<p>By default, all related<a id="_idIndexMarker1221"/> objects are displayed using the foreign key of that related object. We can see this with all seven of the related <strong class="source-inline">Vehicle</strong> objects, represented as a list of the numbers <strong class="source-inline">1</strong> through <strong class="source-inline">7</strong> in the preceding screenshot. The order depends on the default ordering of that model.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">JSON exports don't always follow the same or logical order. Your results may vary. In the preceding screenshot, each object that was exported includes its original primary key, represented as the <strong class="source-inline">"pk"</strong> field. We can remove this using the <strong class="source-inline">--natural-primary</strong> option, which we will soon discuss.</p>
			<ol>
				<li value="4">To practice exporting only a specific table, use the following command to export the <strong class="source-inline">Seller</strong> model data, by specifying <strong class="source-inline">chapter_3.seller</strong> as the source:<p class="source-code"><strong class="bold">(virtual_env) PS &gt; python manage.py dumpdata chapter_3.seller -o becoming_a_django_entdev/chapter_10/fixtures/chapter_3_sellers.json</strong></p></li>
			</ol>
			<p>Use the same<a id="_idIndexMarker1222"/> dot notation to specify other models and/or other applications if you want extra practice.</p>
			<p>Next, let's practice exporting everything again, as we did in the first exercise. This time, we will use the <strong class="source-inline">--exclude</strong> option to exclude apps that we do not want to be included.</p>
			<h3>Using the --exclude option</h3>
			<p>The <strong class="source-inline">--exclude</strong> or <strong class="source-inline">-e</strong> option is used<a id="_idIndexMarker1223"/> to tell Django to exclude a particular app or model from the given inclusion of a <strong class="source-inline">dumpdata</strong> command. In this exercise, we will perform the same dump-everything operation that we performed earlier in the subsection titled <em class="italic">Using the dumpdata command</em> of this chapter and exclude all of the Django-related tables. We want to produce the same results as in the <em class="italic">Exporting a specific application</em> subsection, by using the <strong class="source-inline">--exclude</strong> option rather than telling Django what to include.</p>
			<p>Follow these steps to perform your <strong class="source-inline">--exclude</strong> operation:</p>
			<ol>
				<li value="1">Make sure you are inside your project's root directory, the same folder where your <strong class="source-inline">manage.py</strong> file is located. Then, open a command-line window or terminal and activate your virtual environment, but do not run your project at this time.</li>
				<li>Execute the following <strong class="source-inline">dumpdata</strong> command, which excludes the following applications:<p class="source-code"><strong class="bold">(virtual_env) PS &gt; python manage.py dumpdata -e contenttypes -e sessions -e authtoken -e auth -e admin -o becoming_a_django_entdev/chapter_10/fixtures/chapter_10_exclude.json</strong></p><p class="callout-heading">Note</p><p class="callout">Keep in mind that all the <strong class="source-inline">dumpdata</strong> commands in this chapter are very long single-line commands. Anything broken down onto a new line is likely separated by a single space, as is the case with the preceding command.</p></li>
			</ol>
			<p>Options can also be written using an equals character, such as <strong class="source-inline">-e=app_name</strong> or <strong class="source-inline">--exclude=app_name</strong>.</p>
			<p>The contents of the newly created <strong class="source-inline">chapter_10_exclude.json</strong> file should match the contents of the <strong class="source-inline">chapter_3_models.json</strong> file that we created in the previous subsection, titled <em class="italic">Exporting a specific application</em>. This is because we technically performed the same action, except the first time we told Django what to include, and the second time, we told <a id="_idIndexMarker1224"/>Django what to exclude. Compare your files' output to see the results. </p>
			<p>Next, let's practice exporting data as something other than the default JSON format.</p>
			<h3>Using the --format option</h3>
			<p>The <strong class="source-inline">--format</strong> option is<a id="_idIndexMarker1225"/> used to tell Django to output the data into the format specified. The four types that we can specify when exporting data are JSON, JSONL, XML, and YAML. The default is JSON if this option is not specified.</p>
			<p>Follow these steps to export your data in every format type possible, one format for each step:</p>
			<ol>
				<li value="1">Make sure you are inside your project's root directory, the same folder where your <strong class="source-inline">manage.py</strong> file is located. Then, open a command-line window or terminal and activate your virtual environment, but do not run your project at this time.</li>
				<li>Execute the following <strong class="source-inline">dumpdata</strong> command, which dumps the <strong class="source-inline">Sellers</strong> objects as XML:<p class="source-code"><strong class="bold">(virtual_env) PS &gt; python manage.py dumpdata chapter_3.seller --format xml -o becoming_a_django_entdev/chapter_10/fixtures/chapter_3_sellers.xml</strong></p></li>
				<li>Execute the following <strong class="source-inline">dumpdata</strong> command, which dumps the <strong class="source-inline">Sellers</strong> objects as JSONL:<p class="source-code"><strong class="bold">(virtual_env) PS &gt; python manage.py dumpdata chapter_3.seller --format jsonl -o becoming_a_django_entdev/chapter_10/fixtures/chapter_3_sellers.jsonl</strong></p></li>
				<li>To work with <a id="_idIndexMarker1226"/>YAML formats, you need to install the <strong class="source-inline">pip</strong> package called <strong class="source-inline">pyyaml</strong>. Add this package to your <strong class="source-inline">requirements.txt</strong> file and install it from that file or run the following command to install this package manually into your virtual environment:<p class="source-code"><strong class="bold">(virtual_env) PS &gt; pip install pyyaml</strong></p></li>
				<li>Execute the following <strong class="source-inline">dumpdata</strong> command, which dumps the <strong class="source-inline">Sellers</strong> objects as YAML:<p class="source-code"><strong class="bold">(virtual_env) PS &gt; python manage.py dumpdata chapter_3.seller --format yaml -o becoming_a_django_entdev/chapter_10/fixtures/chapter_3_sellers.yaml</strong></p></li>
			</ol>
			<p>You should now<a id="_idIndexMarker1227"/> have three more <strong class="source-inline">chapter_3_sellers</strong> files, one in each format: <strong class="source-inline">.xml</strong>, <strong class="source-inline">.jsonl</strong>, and <strong class="source-inline">.yaml</strong>. Open each of these documents to view how the data is represented in each format and how they differ from the default <strong class="source-inline">.json</strong> format.</p>
			<p>Next, let's practice removing the primary key, the <strong class="source-inline">"pk"</strong> field, when exporting data into a fixture using the <strong class="source-inline">--natural-primary</strong> option.</p>
			<h3>Using the --natural-primary option</h3>
			<p>The <strong class="source-inline">--natural-primary</strong> option is used to<a id="_idIndexMarker1228"/> generate a fixture that does not include the <strong class="source-inline">"pk"</strong> field for each object that is exported. This is helpful if you have a system that already has data and you need to append data to the existing data. Say the primary key was included; it could conflict with an existing object that has that same primary key but is not the same object. This could potentially result in lost or changed data that produces undesirable results.</p>
			<p>Follow these steps to use the <strong class="source-inline">--natural-primary</strong> option:</p>
			<ol>
				<li value="1">Make sure you are inside your project's root directory, the same folder where your <strong class="source-inline">manage.py</strong> file is located. Then, open a command-line window or terminal and activate your virtual environment, but do not run your project at this time.</li>
				<li>Execute the following <strong class="source-inline">dumpdata</strong> command, specifying the <strong class="source-inline">seller</strong> table found in the <strong class="source-inline">chapter_3</strong> application:<p class="source-code"><strong class="bold">(virtual_env) PS &gt; python manage.py dumpdata chapter_3.seller --natural-primary -o becoming_a_django_entdev/chapter_10/fixtures/chapter_3_sellers_natural_primary.json</strong></p></li>
			</ol>
			<p>A new file called <strong class="source-inline">chapter_3_sellers_natural_primary.json</strong> should have been created in your <strong class="source-inline">/chapter_10/fixtures/</strong> folder.</p>
			<ol>
				<li value="3">Inside that file, format the data so that you can read what is found in it. If you are using Visual Studio, right-click inside your document and select <strong class="bold">Format Document</strong> or copy and paste the data into the online tool found here: <a href="https://jsonlint.com/">https://jsonlint.com/</a>.</li>
			</ol>
			<p>Now, what you should see is the same exact data as in the previous subsection except all of the <strong class="source-inline">"pk"</strong> fields have been removed from your data, as shown:</p>
			<div>
				<div id="_idContainer145" class="IMG---Figure">
					<img src="image/Figure_10.03_B17243.jpg" alt="Figure 10.3 – dumpdata --natural-primary option&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.3 – dumpdata --natural-primary option</p>
			<p>You should also still be seeing the numeric foreign key values for all <strong class="source-inline">Vehicles</strong> of your <strong class="source-inline">Sellers</strong>, as shown earlier in <em class="italic">Figure 10.2</em>. This could prove problematic if we are dumping all data using the <strong class="source-inline">--natural-primary</strong> option. What could happen is a vehicle gets created in your new database with its own primary key that doesn't equal the foreign key specified. To <a id="_idIndexMarker1229"/>overcome that problem, we should also use the <strong class="source-inline">--natural-foreign</strong> option, which we will discuss next.</p>
			<h3>Using the --natural-foreign option</h3>
			<p>The <strong class="source-inline">--natural-foreign</strong> option will <a id="_idIndexMarker1230"/>print out a string representation of all related objects rather than the numeric foreign key value of that object. We also need to write a new model class method on all of our related objects in order to format and structure the string representation of that object when used in this way. The output can differ from the <strong class="source-inline">__str__()</strong> method that we covered in <a href="B17243_03_ePub.xhtml#_idTextAnchor077"><em class="italic">Chapter 3</em></a>, <em class="italic">Models, Relations, and Inheritance</em>.</p>
			<p>Follow these steps to add a new model method to your <strong class="source-inline">Vehicle</strong> model and then export your <strong class="source-inline">Seller</strong> data again using the <strong class="source-inline">--natural-foreign</strong> option:</p>
			<ol>
				<li value="1">Inside your existing <strong class="source-inline">/chapter_3/models.py</strong> file, in the existing <strong class="source-inline">Vehicle</strong> model class, add the following <strong class="source-inline">natural_key()</strong> method:<p class="source-code"><strong class="bold"># /becoming_a_django_entdev/chapter_3/models.py</strong></p><p class="source-code">from django.db import models</p><p class="source-code">...</p><p class="source-code"><strong class="bold">class Vehicle(models.Model):</strong></p><p class="source-code">    <strong class="bold">...</strong></p><p class="source-code"><strong class="bold">    </strong>def <strong class="bold">natural_key</strong>(self):</p><p class="source-code"><strong class="bold">        return self.full_vehicle_name()</strong></p></li>
			</ol>
			<p>This <a id="_idIndexMarker1231"/>method is reliant on the existing <strong class="source-inline">full_vehicle_name()</strong> method created in <a href="B17243_03_ePub.xhtml#_idTextAnchor077"><em class="italic">Chapter 3</em></a>, <em class="italic">Models, Relations, and Inheritance</em>, in the subsection titled <em class="italic">Custom model method</em>. Please make sure that method exists in your <strong class="source-inline">Vehicle</strong> model class before proceeding with the next steps.</p>
			<ol>
				<li value="2">Make sure you are in your project root directory, the same folder where your <strong class="source-inline">manage.py</strong> file is located. Then, open a command-line window or terminal and activate your virtual environment, but do not run your project at this time.</li>
				<li>Execute the following <strong class="source-inline">dumpdata</strong> command, specifying all of the tables found in the <strong class="source-inline">chapter_3</strong> application:<p class="source-code"><strong class="bold">(virtual_env) PS &gt; python manage.py dumpdata chapter_3.seller --natural-foreign -o becoming_a_django_entdev/chapter_10/fixtures/chapter_3_sellers_natural_foreign.json</strong></p></li>
			</ol>
			<p>A new file called <strong class="source-inline">chapter_3_sellers_natural_foreign.json</strong> should have been created in your <strong class="source-inline">/chapter_10/fixtures/</strong> folder.</p>
			<ol>
				<li value="4">Inside that file, format the data so that you can read what is found in it. If you are using Visual Studio, right-click inside your document and select <strong class="bold">Format Document</strong> or copy and paste the data into the online tool found here: <a href="https://jsonlint.com/">https://jsonlint.com/</a>.</li>
			</ol>
			<p>What you should see now is something similar to the following screenshot, where the vehicles list is no longer represented by numbers; it now shows the string returned by the <strong class="source-inline">natural_key()</strong> method that we created:</p>
			<div>
				<div id="_idContainer146" class="IMG---Figure">
					<img src="image/Figure_10.04_B17243.jpg" alt="Figure 10.4 – dumpdata --natural-foreign option&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.4 – dumpdata --natural-foreign option</p>
			<p>If you see <a id="_idIndexMarker1232"/>duplicate string entries, as you do in the proceeding screenshot, this is because the natural key string representation uses data from models that happen to have the exact same value in this case, even though they're different objects. You may want to go back and configure the <strong class="source-inline">natural_key()</strong> method to return something more unique.</p>
			<p>You are welcome to create a <strong class="source-inline">natural_key()</strong> method for every model that exists in the <strong class="source-inline">chapter_3</strong> app and then rerun any combination of these commands over again for practice. Inside the <strong class="source-inline">/chapter_10/fixtures/</strong> folder of the code provided with this book are many different fixture documents that have been pre-generated for you, all using the initial data provided in the <strong class="source-inline">chapter_3.json</strong> fixture file. Inside the <strong class="source-inline">/chapter_10/readme.md</strong> file, you can find a list of commands that extend the examples provided in this chapter. Each of the <a id="_idIndexMarker1233"/>commands provided generates a different <strong class="source-inline">chapter_10</strong> fixture file.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">You can combine options, such as combining <strong class="source-inline">--natural-foreign --natural-primary</strong> within a single command. Doing so would produce the results found in <em class="italic">Figure 10.4</em> without the <strong class="source-inline">"pk"</strong> field present.</p>
			<p>Next, let's practice importing data with the <strong class="source-inline">loaddata</strong> Django management command.</p>
			<h1 id="_idParaDest-268"><a id="_idTextAnchor298"/>Importing data from a data fixture</h1>
			<p>Importing <a id="_idIndexMarker1234"/>data from a fixture is done using the <strong class="source-inline">loaddata</strong> Django management command. As long as data exists in one of the four file formats, JSON, JSONL, XML, or YAML, it can be imported using this command. Data can be imported even if it was not exported from a Django project. The <strong class="source-inline">loaddata</strong> management command does not have as many options as the <strong class="source-inline">dumpdata</strong> command uses but they do share most of the same options. </p>
			<p>We have been using this command throughout most of this book to ensure that we have test data available when working with the exercises of previous chapters. Instead of going through examples of how to use this command in depth, we will briefly remind ourselves how it is used and then describe each of the options that are available and what they are used for.</p>
			<h2 id="_idParaDest-269"><a id="_idTextAnchor299"/>Using the importdata command</h2>
			<p>Follow these<a id="_idIndexMarker1235"/> steps to practice loading the <strong class="source-inline">/chapter_10/fixtures/chapter_3_sellers.json</strong> fixture file that we created earlier in this chapter. If we are successful, we should see no change in our data because we are importing the same data, overwriting itself. You can practice changing field values and/or adding new objects to your file before importing if you wish to see data change in your database management tool:</p>
			<ol>
				<li value="1">Make sure you are inside your project's root directory, the same folder where your <strong class="source-inline">manage.py</strong> file is located. Then, open a command-line window or terminal and activate your virtual environment, but do not run your project at this time.</li>
				<li>Execute the <a id="_idIndexMarker1236"/>following <strong class="source-inline">loaddata</strong> command, telling Django to load only the <strong class="source-inline">chapter_3_sellers.json</strong> fixture:<p class="source-code"><strong class="bold">(virtual_env) PS &gt; python manage.py loaddata chapter_3_sellers.json</strong></p><p class="callout-heading">Note</p><p class="callout">In the previous section, we created many different fixture formats, all with the same name, <strong class="source-inline">chapter_3_sellers</strong>, and different file extensions. Because of this, you will have to include the file extension when executing your command. If you are using anything other than JSON file formats, don't forget to always include the <strong class="source-inline">--format</strong> option. If you do not have multiple file formats that share the same name, it is not necessary to include the file extension when using the <strong class="source-inline">loaddata</strong> command.</p></li>
			</ol>
			<p>Each of the options available and <a id="_idIndexMarker1237"/>what they are used for are listed here:</p>
			<ul>
				<li><strong class="source-inline">--app</strong> – used to tell Django to search for the fixture file in only the app directory specified using this option, versus having Django search in every app directory. This is sometimes important if you have two fixture files with the same name that exist in two different Django app directories.</li>
				<li><strong class="source-inline">--database</strong> – tells Django to use a database that is configured in your <strong class="source-inline">settings.py</strong> file that is not the default database specified. Django uses the name you provide to identify that database in your <strong class="source-inline">settings.py</strong> file. This can also be used with the <strong class="source-inline">dumpdata</strong> command.</li>
				<li><strong class="source-inline">--format</strong> – used to tell Django to use a format other than the default JSON format when importing the data file provided.</li>
				<li><strong class="source-inline">--exclude</strong>, <strong class="source-inline">-e</strong> – used to tell Django to omit the <strong class="source-inline">app_name</strong> or <strong class="source-inline">model_name</strong> provided from the data that you are importing.</li>
				<li><strong class="source-inline">--ignorenonexistent</strong>, <strong class="source-inline">-i</strong> – used to omit specific fields or models that may have been removed<a id="_idIndexMarker1238"/> since the time the fixture file was created.</li>
			</ul>
			<p>Let's begin working with performance boosters next.</p>
			<h1 id="_idParaDest-270"><a id="_idTextAnchor300"/>Using the select_related() method</h1>
			<p>The <strong class="source-inline">select_related()</strong> method is<a id="_idIndexMarker1239"/> used as a performance booster on queries pertaining to all related <strong class="source-inline">ForeignKey</strong> and <strong class="source-inline">OneToOneField</strong> relationships. This method is primarily used for obtaining the data of single objects that relate to a parent object. This method will not work on <strong class="source-inline">ManyToManyField</strong> relationships. On the SQL level, this method generally uses a left outer join to look up related data. To learn more about the <strong class="source-inline">select_related()</strong> method in its <a id="_idIndexMarker1240"/>entirety, visit <a href="https://docs.djangoproject.com/en/4.0/ref/models/querysets/#select-related">https://docs.djangoproject.com/en/4.0/ref/models/querysets/#select-related</a>.</p>
			<p>Here, we will monitor the performance of a page that displays a list of vehicles and the details about each vehicle, including related field data. Use the following subsections to create the required view class, template, and URL pattern to demonstrate this concept in action.</p>
			<h2 id="_idParaDest-271"><a id="_idTextAnchor301"/>Creating the view</h2>
			<p>Follow<a id="_idIndexMarker1241"/> these steps to create your <strong class="source-inline">VehicleView</strong> class:</p>
			<ol>
				<li value="1">In your <strong class="source-inline">/chapter_10/views.py</strong> file, add the following <strong class="source-inline">VehiclesView</strong> class and <strong class="source-inline">import</strong> statements:<p class="source-code"><strong class="bold"># /becoming_a_django_entdev/chapter_10/views.py</strong></p><p class="source-code">from django.http import <strong class="bold">Http404</strong></p><p class="source-code">from django.template.response import (</p><p class="source-code">    <strong class="bold">TemplateResponse</strong></p><p class="source-code">)</p><p class="source-code">from django.views.generic import <strong class="bold">View</strong></p><p class="source-code">from ..chapter_3.models import <strong class="bold">Vehicle</strong></p><p class="source-code">class <strong class="bold">VehiclesView</strong>(<strong class="bold">View</strong>):</p><p class="source-code">    template_name = 'chapter_10/vehicles.html'</p></li>
			</ol>
			<p>In this view class, we are telling Django to use the <strong class="source-inline">/chapter_10/vehicles.html</strong> file as the template, which we will create soon.</p>
			<ol>
				<li value="2">Add the<a id="_idIndexMarker1242"/> following <strong class="source-inline">get()</strong> method to your <strong class="source-inline">VehiclesView</strong> class:<p class="source-code"><strong class="bold"># /becoming_a_django_entdev/chapter_10/views.py</strong></p><p class="source-code">...</p><p class="source-code">class <strong class="bold">VehiclesView</strong>(<strong class="bold">View</strong>):</p><p class="source-code">    ...</p><p class="source-code">    def <strong class="bold">get(</strong>self, request, *args, **kwargs<strong class="bold">)</strong>:</p><p class="source-code">        try:</p><p class="source-code">            vehicles = <strong class="bold">Vehicle</strong>.objects.all()</p><p class="source-code">        except <strong class="bold">Vehicle</strong>.DoesNotExist:</p><p class="source-code">            raise <strong class="bold">Http404(</strong>'No Vehicles Found'<strong class="bold">)</strong></p><p class="source-code">        return <strong class="bold">TemplateResponse(</strong></p><p class="source-code">            request,</p><p class="source-code">            self.template_name,</p><p class="source-code">            {'vehicles': vehicles}</p><p class="source-code">        <strong class="bold">)</strong></p></li>
			</ol>
			<p>To explain what this <strong class="source-inline">get()</strong> method is doing, we are performing an <strong class="source-inline">all()</strong> query on the <strong class="source-inline">Vehicle</strong> model object. If no vehicles are found, we then raise an <strong class="source-inline">Http404</strong> not-found response. If vehicles are found, we then return a <strong class="source-inline">TemplateResponse</strong> with the vehicles QuerySet<a id="_idIndexMarker1243"/> provided as context into the template that is rendered.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">The query performed in the <strong class="source-inline">get()</strong> method is not currently performance boosted. Jump ahead to the subsection titled <em class="italic">First demo</em> of this chapter to see the performance-boosted query.</p>
			<p>Let's build the template next.</p>
			<h2 id="_idParaDest-272"><a id="_idTextAnchor302"/>Building the template</h2>
			<p>Follow these steps to create<a id="_idIndexMarker1244"/> your vehicles list template file:</p>
			<ol>
				<li value="1">Create a file called <strong class="source-inline">vehicles.html</strong> in the <strong class="source-inline">/chapter_10/templates/chapter_10/</strong> directory. Inside this file, add the following code:<p class="source-code"><strong class="bold"># /becoming_a_django_entdev/chapter_10/templates/chapter_10/vehicles.html</strong></p><p class="source-code">{% load static <strong class="bold">chapter_4</strong> %}</p><p class="source-code">&lt;html lang="en" xmlns="http://www.w3.org/1999/xhtml"&gt;</p><p class="source-code">    &lt;head&gt;</p><p class="source-code">        &lt;title&gt;All Vehicles Page&lt;/title&gt;</p><p class="source-code">    &lt;/head&gt;</p><p class="source-code">    &lt;body style="text-align:center" </p><p class="source-code">        class="chapter_10"&gt;</p><p class="source-code">        &lt;h1&gt;All Vehicles&lt;/h1&gt;</p><p class="source-code">    &lt;/body&gt;</p><p class="source-code">&lt;/html&gt;</p></li>
			</ol>
			<p>The <strong class="source-inline">{% load %}</strong> tag imports the <strong class="source-inline">templatetags</strong> file that we created in <a href="B17243_04_ePub.xhtml#_idTextAnchor116"><em class="italic">Chapter 4</em></a>, <em class="italic">URLs, Views, and Templates</em>, in the subsection titled <em class="italic">Custom tags and filters</em>. If you do not have the <strong class="source-inline">chapter_4.py</strong> file created at this time, just remove <strong class="source-inline">chapter_4</strong> from the <strong class="source-inline">{% load %}</strong> tag in the preceding code block and remove <strong class="source-inline">|vehicle_make</strong> shown in the code block in <em class="italic">step 2</em>.</p>
			<ol>
				<li value="2">In that same file, just<a id="_idIndexMarker1245"/> before the closing <strong class="source-inline">&lt;/body&gt;</strong> tag, add the following conditional and <strong class="source-inline">for</strong> loop, which will populate your page with the information shown for each <strong class="source-inline">vehicle</strong> in the <strong class="source-inline">vehicles</strong> QuerySet:<p class="source-code"><strong class="bold"># /becoming_a_django_entdev/chapter_10/templates/chapter_10/vehicles.html</strong></p><p class="source-code">...</p><p class="source-code">    &lt;body ...&gt;</p><p class="source-code">        ...</p><p class="source-code">        <strong class="bold">{% if vehicles %}</strong></p><p class="source-code">            <strong class="bold">{% for vehicle in vehicles %}</strong></p><p class="source-code">                &lt;br /&gt;</p><p class="source-code">                &lt;p&gt;VIN #: <strong class="bold">{{ vehicle.vin }}</strong>&lt;/p&gt;</p><p class="source-code">                &lt;p&gt;Price: <strong class="bold">{{ vehicle.price }}</strong>&lt;/p&gt;</p><p class="source-code">                &lt;p&gt;Make: <strong class="bold">{{ vehicle.make|vehicle_make }}</strong>&lt;/p&gt;</p><p class="source-code">                &lt;p&gt;Model: <strong class="bold">{{ vehicle.vehicle_model }}</strong>&lt;/p&gt;</p><p class="source-code">                &lt;p&gt;Engine: <strong class="bold">{{ vehicle.engine }}</strong>&lt;/p&gt;</p><p class="source-code">                &lt;p&gt;Is Sold? <strong class="bold">{{ vehicle.sold }}</strong>&lt;/p&gt;</p><p class="source-code">                &lt;br /&gt;&lt;hr /&gt;</p><p class="source-code">            <strong class="bold">{% endfor %}</strong></p><p class="source-code">        <strong class="bold">{% endif %}</strong></p><p class="source-code">    &lt;/body&gt;</p><p class="source-code">...</p></li>
			</ol>
			<p>The preceding conditional statement will check to see whether there are any vehicles in the <strong class="source-inline">vehicles</strong> QuerySet object. Even though we are doing this with the try/except statement in the view class, it is still good practice to do this in the template just in case there are no exception handlers set in the view class/method to check for when an object is not found. We are <a id="_idIndexMarker1246"/>displaying all of the field data that exists for each object. The <strong class="source-inline">Engine</strong> and <strong class="source-inline">VehicleModel</strong> data shown in the preceding code block are the related objects that we will monitor our performance on.</p>
			<p>Let's map the URL pattern that we need next.</p>
			<h2 id="_idParaDest-273"><a id="_idTextAnchor303"/>Mapping the URL pattern</h2>
			<p>Follow these step to map the <a id="_idIndexMarker1247"/>URL pattern that we will be using to access this test page:</p>
			<ol>
				<li value="1">In your <strong class="source-inline">/chapter_10/urls.py</strong> file, add the following path to the <strong class="source-inline">urlpatterns</strong> list:<p class="source-code">from django.urls import path</p><p class="source-code">from .views import <strong class="bold">VehiclesView</strong></p><p class="source-code">urlpatterns = [</p><p class="source-code">    ...</p><p class="source-code">    path(</p><p class="source-code">        'all-vehicles/',</p><p class="source-code">        <strong class="bold">VehiclesView</strong>.as_view(),</p><p class="source-code">        name = 'all-vehicles'</p><p class="source-code">    ),</p><p class="source-code">]</p></li>
			</ol>
			<p>The path that we just mapped to the <strong class="source-inline">VehiclesView</strong> class will <a id="_idIndexMarker1248"/>point to the URL http://localhost:8000/all-vehicles/.</p>
			<p>Next, let's inspect the performance of the vehicles listing page with the DjDT.</p>
			<h2 id="_idParaDest-274"><a id="_idTextAnchor304"/>First demo</h2>
			<p>Follow these steps<a id="_idIndexMarker1249"/> to view the vehicles listing page and <a id="_idIndexMarker1250"/>inspect its database query performance with the DjDT:</p>
			<ol>
				<li value="1">Make sure your project is running in your virtual environment and navigate to the URL <strong class="source-inline">http://localhost:8000/all-vehicles/</strong>. If you are using the data provided with the <strong class="source-inline">chapter_3</strong> app fixture, you should see at least seven sets of vehicles, each separated by a solid horizontal line.</li>
				<li>Open the DjDT and look at the <strong class="bold">SQL</strong> section. You should see at least <strong class="bold">15 queries</strong>, as shown in the following screenshot:</li>
			</ol>
			<div>
				<div id="_idContainer147" class="IMG---Figure">
					<img src="image/Figure_10.05_B17243.jpg" alt="Figure 10.5 – Query without the select_related() method&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.5 – Query without the select_related() method</p>
			<ol>
				<li value="3">Now, in <a id="_idIndexMarker1251"/>your <strong class="source-inline">/chapter_10/views.py</strong> file, under the <strong class="source-inline">get()</strong> method of the <strong class="source-inline">VehiclesView</strong> class, change<a id="_idIndexMarker1252"/> your query to the one highlighted in the following snippet,where we are adding the <strong class="source-inline">select_related()</strong> method to the query that we last used:<p class="source-code"><strong class="bold"># /becoming_a_django_entdev/chapter_10/views.py</strong></p><p class="source-code">...</p><p class="source-code">class <strong class="bold">VehiclesView</strong>(View):</p><p class="source-code">    ...</p><p class="source-code">    def <strong class="bold">get(</strong>self, request, *args, **kwargs<strong class="bold">)</strong>:</p><p class="source-code">        try:</p><p class="source-code">            vehicles=Vehicle.objects<strong class="bold">.select_related(</strong></p><p class="source-code">                <strong class="bold">'vehicle_model',</strong></p><p class="source-code">                <strong class="bold">'engine'</strong></p><p class="source-code">            <strong class="bold">)</strong>.all()</p><p class="source-code">        ...</p></li>
			</ol>
			<p>Inside the <strong class="source-inline">select_related()</strong> method, we are telling Django to grab the related <strong class="source-inline">vehicle_model</strong> and <strong class="source-inline">engine</strong> field data.</p>
			<ol>
				<li value="4">Refresh the page at http://localhost:8000/all-vehicles/ and inspect the <strong class="bold">SQL</strong> section of the DjDT one more time. This time, you should only see at least <strong class="bold">1 query</strong>, as shown in the following screenshot:</li>
			</ol>
			<div>
				<div id="_idContainer148" class="IMG---Figure">
					<img src="image/Figure_10.06_B17243.jpg" alt="Figure 10.6 – Query with the select_related() method&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.6 – Query with the select_related() method</p>
			<p>As we can see, with<a id="_idIndexMarker1253"/> this particular set of data, we were able<a id="_idIndexMarker1254"/> to shave about 14 SQL query operations off of this search task. This also shaved off 10.16 ms from the original time that it took. While 10.16 ms may seem very small, remember, we only have about a dozen records that pertain to this particular dataset; imagine the difference in a dataset with a few hundred thousand records. The time adds up.</p>
			<p>When we open the <strong class="bold">SQL</strong> tab to see what is going on, we can see that this one SQL query that was performed used a series of <strong class="source-inline">LEFT OUTER JOIN</strong> operations to obtain all related objects.</p>
			<div>
				<div id="_idContainer149" class="IMG---Figure">
					<img src="image/Figure_10.07_B17243.jpg" alt="Figure 10.7 – Inspecting the select_related() query&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.7 – Inspecting the select_related() query</p>
			<p>Let's see what the <strong class="source-inline">prefetch_related()</strong> method does next.</p>
			<h1 id="_idParaDest-275"><a id="_idTextAnchor305"/>Using the prefetch_related() method</h1>
			<p>The <strong class="source-inline">prefetch_related()</strong> method <a id="_idIndexMarker1255"/>is used as a performance booster on queries pertaining to <strong class="source-inline">ManyToManyField</strong> relationships. This method can also be used for <strong class="source-inline">ForeignKey</strong> and <strong class="source-inline">OneToOneField</strong> relationships and allows for forward and backward lookups, as we will soon practice doing. On the SQL level, this method will generally use a WHERE or INNER JOIN statement to perform lookup operations. Unlike the <strong class="source-inline">select_related()</strong> method, the <strong class="source-inline">prefetch_related()</strong> method will perform a separate SQL query for each of the related sets of objects. For example, if we looked up a <strong class="source-inline">Seller</strong> and wanted the related <strong class="source-inline">Vehicles</strong> and their related <strong class="source-inline">VehicleModel</strong> and <strong class="source-inline">Engine</strong> objects, then Django would perform four separate queries to look up all the related data. To learn more about the <strong class="source-inline">prefetch_related()</strong> method in its entirety, visit <a href="https://docs.djangoproject.com/en/4.0/ref/models/querysets/#prefetch-related">https://docs.djangoproject.com/en/4.0/ref/models/querysets/#prefetch-related</a>.</p>
			<p>The following are two exercises, related to the <em class="italic">vehicles view</em> and the <em class="italic">sellers view</em>, to practice using the <strong class="source-inline">prefetch_related()</strong> method in different ways.</p>
			<h2 id="_idParaDest-276"><a id="_idTextAnchor306"/>Vehicles view</h2>
			<p>In this exercise, we will modify<a id="_idIndexMarker1256"/> the existing <strong class="source-inline">VehiclesView</strong> class that we created in the <em class="italic">Using the select_related() method</em> section of this chapter. What we did in that exercise was created a page that displayed all of the vehicles that are in our system and then performance boosted how we looked up the related <strong class="source-inline">VehicleModel</strong> and <strong class="source-inline">Engine</strong> objects. Using the <strong class="source-inline">prefetch_related()</strong> method, we will look up the related <strong class="source-inline">Seller</strong> object to display who is selling that particular vehicle.</p>
			<p>Use the following subsections to prepare your template for this demonstration. The view and URL pattern will remain the same as before.</p>
			<h3>Checking the view</h3>
			<p>Leave your existing <strong class="source-inline">VehiclesView</strong> class <a id="_idIndexMarker1257"/>the same as before, where it is using the performance-boosted query from the last demonstration, as follows:</p>
			<pre class="source-code"><strong class="bold"># /becoming_a_django_entdev/chapter_10/views.py</strong></pre>
			<pre class="source-code">...</pre>
			<pre class="source-code">            Vehicles = Vehicle.objects<strong class="bold">.select_related(</strong></pre>
			<pre class="source-code">                <strong class="bold">'vehicle_model',</strong></pre>
			<pre class="source-code">                <strong class="bold">'engine'</strong></pre>
			<pre class="source-code">            <strong class="bold">)</strong>.all()</pre>
			<pre class="source-code">...</pre>
			<p>We will modify this <a id="_idIndexMarker1258"/>soon, but we first want to monitor how displaying the <strong class="source-inline">seller</strong> object in the template will change the performance-boosted query that we have now.</p>
			<h3>Modifying the template</h3>
			<p>Follow these steps<a id="_idIndexMarker1259"/> to modify your vehicles list template:</p>
			<ol>
				<li value="1">In your <strong class="source-inline">/chapter_10/vehicles.html</strong> file, add the following highlighted code, just above the <strong class="source-inline">&lt;br /&gt;&lt;hr /&gt;</strong> line <a id="_idTextAnchor307"/>and below your last <strong class="source-inline">vehicle</strong> detail item:<p class="source-code"><strong class="bold"># /becoming_a_django_entdev/chapter_10/templates/chapter_10/vehicles.html</strong></p><p class="source-code">...</p><p class="source-code">        {% if vehicles %}</p><p class="source-code">            {% for vehicle in vehicles %}</p><p class="source-code">                ...</p><p class="source-code">                &lt;p&gt;Is Sold? {{ vehicle.sold<a id="_idTextAnchor308"/> }}&lt;/p&gt;</p><p class="source-code">                <strong class="bold">{% for seller in vehicle.</strong></p><p class="source-code"><strong class="bold">                    vehicle_sellers.all %}</strong></p><p class="source-code">                    <strong class="bold">{{ seller.username }}</strong></p><p class="source-code">                <strong class="bold">{% endfor %}</strong></p><p class="source-code">                &lt;br /&gt;&lt;hr /&gt;</p><p class="source-code">            {% endfor %}</p><p class="source-code">        {% endif %}</p><p class="source-code">...</p></li>
				<li>It is important to note that the name used to access a <strong class="source-inline">seller</strong>, as in <strong class="source-inline">vehicle_sellers</strong> in <strong class="source-inline">vehicle.vehicle_sellers.all</strong>, is set on the <strong class="source-inline">vehicles</strong> field of the <strong class="source-inline">Seller</strong> model class, using the <strong class="source-inline">related_name</strong> argument. Make sure, in your <strong class="source-inline">/chapter_3/models.py</strong> file, under the <strong class="source-inline">Seller</strong> model class, that the <strong class="source-inline">vehicles</strong> field is using the arguments and values highlighted<a id="_idIndexMarker1260"/> in the following snippet:<p class="source-code"><strong class="bold"># /becoming_a_django_entdev/chapter_3/models.py</strong></p><p class="source-code">...</p><p class="source-code">class <strong class="bold">Seller</strong>(AbstractUser):</p><p class="source-code">    ...</p><p class="source-code">    <strong class="bold">vehicles</strong> = models.ManyToManyField(</p><p class="source-code">        Vehicle,</p><p class="source-code">        verbose_name = 'Vehicles',</p><p class="source-code">        <strong class="bold">related_name = 'vehicle_sellers',</strong></p><p class="source-code">        <strong class="bold">related_query_name = 'vehicle_seller',</strong></p><p class="source-code">        blank = True,</p><p class="source-code">    )</p><p class="callout-heading">Note</p><p class="callout">If the value of a <strong class="source-inline">related_name</strong> or <strong class="source-inline">related_query_name</strong> argument of a field on a model class ever changes, you will need to rerun your Django migration commands once again to reflect those changes in your database.</p></li>
			</ol>
			<p>Let's see how this changes our performance now.</p>
			<h3>Second demo</h3>
			<p>Follow these steps to see how <a id="_idIndexMarker1261"/>these changes affect the output of the <strong class="bold">SQL</strong> tab<a id="_idIndexMarker1262"/> in the DjDT:</p>
			<ol>
				<li value="1">Make sure your project is running in your virtual environment and navigate to or refresh the URL <strong class="source-inline">http://localhost:8000/all-vehicles/</strong> one more time. </li>
				<li>Inspect the <strong class="bold">SQL</strong> section of the DjDT one more time and you should no longer see <strong class="bold">1 query</strong> as we saw before with the <strong class="source-inline">select_related()</strong> method. Instead, we are now seeing at least <strong class="bold">8 queries</strong>, as shown in the following screenshot:</li>
			</ol>
			<div>
				<div id="_idContainer150" class="IMG---Figure">
					<img src="image/Figure_10.08_B17243.jpg" alt="Figure 10.8 – Query with the select_related() method showing related seller&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.8 – Query with the select_related() method showing related seller</p>
			<p>We are seeing seven extra queries in our search now, one extra for each seller that relates to all seven of the vehicles found. </p>
			<ol>
				<li value="3">In your <strong class="source-inline">/chapter_10/views.py</strong> file, in the same <strong class="source-inline">VehiclesView</strong> class, change the query to the one shown in the following code snippet:<p class="source-code"><strong class="bold"># /becoming_a_django_entdev/chapter_10/views.py</strong></p><p class="source-code">...</p><p class="source-code">            Vehicles = Vehicle.objects<strong class="bold">.prefetch_related(</strong></p><p class="source-code">    <strong class="bold">'vehicle_sellers'</strong></p><p class="source-code"><strong class="bold">)</strong>.select_related(</p><p class="source-code">    'vehicle_model',</p><p class="source-code">    'engine'</p><p class="source-code">).all()</p><p class="source-code">...</p></li>
			</ol>
			<p>We just added the <strong class="source-inline">prefetch_related('vehicle_sellers')</strong> method to the query that we had before, keeping the previous <strong class="source-inline">select_related()</strong> operation. Make sure you are following proper Python indentation where this is used. There is limited room to display this properly in the preceding example.</p>
			<ol>
				<li value="4">Refresh the <a id="_idIndexMarker1263"/>URL <strong class="source-inline">http://localhost:8000/all-vehicles/</strong> one more time<a id="_idIndexMarker1264"/> and inspect the <strong class="bold">SQL</strong> section of the DjDT one more time. You should now see at least <strong class="bold">2 queries</strong>, as shown in the following screenshot:</li>
			</ol>
			<div>
				<div id="_idContainer151" class="IMG---Figure">
					<img src="image/Figure_10.09_B17243.jpg" alt="Figure 10.9 – Query using both the select_related() and prefetch_related() methods&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.9 – Query using both the select_related() and prefetch_related() methods</p>
			<p>If we inspect the <strong class="bold">SQL</strong> tab even further by clicking on it, we can see that Django performed the same <strong class="bold">LEFT OUTER JOIN</strong> lookup from before, and then the <strong class="source-inline">prefetch_related()</strong> method added the <strong class="bold">INNER JOIN</strong> and <strong class="bold">WHERE</strong> lookup, as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer152" class="IMG---Figure">
					<img src="image/Figure_10.10_B17243.jpg" alt="Figure 10.10 – Inspecting both the select_related() and prefetch_related() queries&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.10 – Inspecting both the select_related() and prefetch_related() queries</p>
			<p>We can see from before <a id="_idIndexMarker1265"/>that Django was performing an additional lookup for each of the <strong class="source-inline">vehicle_sellers</strong> objects that it was seeking to display the username of, on your page. That was how we wound up with eight queries after adding the <strong class="source-inline">{% for seller in vehicle.vehicle_sellers.all %}</strong> loop to the <strong class="source-inline">/chapter_10/vehicles.html</strong> template file. When we added the <strong class="source-inline">prefetch_related()</strong> method to the query operation in the <strong class="source-inline">VehiclesView</strong> class, it just added one extra lookup operation that retrieved all seven of the <strong class="source-inline">vehicle_sellers</strong> objects that pertain to this dataset, resulting in the two queries that we have now and <a id="_idIndexMarker1266"/>reducing the excess. Adding more field lookups and using context in multiple places within your template file can sometimes increase your query count.</p>
			<p>Next, let's apply the <strong class="source-inline">prefetch_related()</strong> method to a sellers listing page and see how it behaves following a lookup in the opposite direction of how we used it here.</p>
			<h2 id="_idParaDest-277"><a id="_idTextAnchor309"/>Sellers view</h2>
			<p>In this exercise, we will create a new<a id="_idIndexMarker1267"/> URL pattern, view class, and template that will display a list of sellers and the related vehicles that they are selling.</p>
			<p>Use the following subsections to create the required view class, template, and URL pattern needed to build the sellers listing page.</p>
			<h3>Creating the view</h3>
			<p>Follow these <a id="_idIndexMarker1268"/>steps to create your <strong class="source-inline">SellersView</strong> class:</p>
			<ol>
				<li value="1">In your <strong class="source-inline">/chapter_10/views.py</strong> file, add the following <strong class="source-inline">SellersView</strong> class and <strong class="source-inline">import</strong> statements:<p class="source-code"><strong class="bold"># /becoming_a_django_entdev/chapter_10/views.py</strong></p><p class="source-code">from django.http import Http404</p><p class="source-code">from django.template.response import (</p><p class="source-code">    <strong class="bold">TemplateResponse</strong></p><p class="source-code">)</p><p class="source-code">from django.views.generic import View</p><p class="source-code">from ..chapter_3.models import <strong class="bold">Seller</strong>, Vehicle</p><p class="source-code">class <strong class="bold">SellersView</strong>(<strong class="bold">View</strong>):</p><p class="source-code">    template_name = 'chapter_10/sellers.html'</p></li>
			</ol>
			<p>In this view class, we are telling Django to use the <strong class="source-inline">/chapter_10/sellers.html</strong> file as the template, which we will create soon. We are also using the same imports as before and then adding the <strong class="source-inline">Seller</strong> model class as a new import.</p>
			<ol>
				<li value="2">Add the following <strong class="source-inline">get()</strong> method to your <strong class="source-inline">SellersView</strong> class:<p class="source-code"><strong class="bold"># /becoming_a_django_entdev/chapter_10/views.py</strong></p><p class="source-code">...</p><p class="source-code">class <strong class="bold">SellersView</strong>(<strong class="bold">View</strong>):</p><p class="source-code">    ...</p><p class="source-code">    def <strong class="bold">get(</strong>self, request, *args, **kwargs<strong class="bold">)</strong>:</p><p class="source-code">        try:</p><p class="source-code">            sellers = Seller.objects.all()</p><p class="source-code">        except <strong class="bold">Seller</strong>.DoesNotExist:</p><p class="source-code">            raise <strong class="bold">Http404</strong>('No Sellers Found')</p><p class="source-code">        return <strong class="bold">TemplateResponse(</strong></p><p class="source-code">            request,</p><p class="source-code">            self.template_name,</p><p class="source-code">            {'sellers': sellers}</p><p class="source-code">        <strong class="bold">)</strong></p></li>
			</ol>
			<p>The <strong class="source-inline">get()</strong> method<a id="_idIndexMarker1269"/> is structured the same as the <strong class="source-inline">VehiclesView</strong> class. The only difference is that we are using the <strong class="source-inline">Seller</strong> model class to perform a query on. Again, this query is not currently performance boosted; we will do that after we take a measurement of this query operation.</p>
			<p>Let's build the template next.</p>
			<h3>Building the template</h3>
			<p>Follow these steps to<a id="_idIndexMarker1270"/> build the sellers listing page template:</p>
			<ol>
				<li value="1">Create a file called <strong class="source-inline">sellers.html</strong> in the <strong class="source-inline">/chapter_10/templates/chapter_10/</strong> directory. Inside this file, add the following code:<p class="source-code"><strong class="bold"># /becoming_a_django_entdev/chapter_10/templates/chapter_10/sellers.html</strong></p><p class="source-code">{% load static <strong class="bold">chapter_4</strong> %}</p><p class="source-code">&lt;html lang="en" xmlns="http://www.w3.org/1999/xhtml"&gt;</p><p class="source-code">    &lt;head&gt;</p><p class="source-code">        &lt;title&gt;All Sellers Page&lt;/title&gt;</p><p class="source-code">        &lt;style type="text/css"&gt;</p><p class="source-code">            ...Found With the Code of this Book...</p><p class="source-code">        &lt;/style&gt;</p><p class="source-code">    &lt;/head&gt;</p><p class="source-code">    &lt;body style="text-align:center" </p><p class="source-code">        class="chapter_10"&gt;</p><p class="source-code">        &lt;h1&gt;All Sellers&lt;/h1&gt;</p><p class="source-code">    &lt;/body&gt;</p><p class="source-code">&lt;/html&gt;</p></li>
			</ol>
			<p>The <strong class="source-inline">{% load %}</strong> tag <a id="_idIndexMarker1271"/>imports the <strong class="source-inline">templatetags</strong> file that we created in <a href="B17243_04_ePub.xhtml#_idTextAnchor116"><em class="italic">Chapter </em><em class="italic">4</em></a>, <em class="italic">URLs, Views, and Templates</em> in the subsection titled <em class="italic">Custom tags and filters</em>. If you do not have the <strong class="source-inline">chapter_4.py</strong> file created at this time, just remove <strong class="source-inline">chapter_4</strong> from the<strong class="source-inline"> {% load %}</strong> tag in the preceding code block and remove <strong class="source-inline">|vehicle_make</strong> where it is shown in <em class="italic">step 3</em>. </p>
			<p>The code of this book also provides additional CSS class styles. You can find those styles in the same file found with the code of this book and copy and paste them into your document to view these objects in a more organized way. This is not a necessary step to proceed.</p>
			<ol>
				<li value="2">Just before the closing <strong class="source-inline">&lt;/body&gt;</strong> tag, add the following conditional and <strong class="source-inline">for</strong> loop, which will populate your page with the information for each <strong class="source-inline">seller</strong> in the <strong class="source-inline">sellers</strong> QuerySet:<p class="source-code"><strong class="bold"># /becoming_a_django_entdev/chapter_10/templates/chapter_10/sellers.html</strong></p><p class="source-code">...</p><p class="source-code">    &lt;body ...&gt;</p><p class="source-code">        ...</p><p class="source-code">        <strong class="bold">{% if sellers %}</strong></p><p class="source-code">            <strong class="bold">{% for seller in sellers %}</strong></p><p class="source-code">                &lt;p&gt;First Name: <strong class="bold">{{ seller.first_name }}</strong>&lt;/p&gt;</p><p class="source-code">                &lt;p&gt;Last Name: <strong class="bold">{{ seller.last_name }}</strong>&lt;/p&gt;</p><p class="source-code">                &lt;p&gt;Username: <strong class="bold">{{ seller.username }}</strong>&lt;/p&gt;</p><p class="source-code">                &lt;p&gt;Business Name: <strong class="bold">{{ seller.name }}</strong>&lt;/p&gt;</p><p class="source-code">                &lt;p&gt;Email: <strong class="bold">{{ seller.email }}</strong>&lt;/p&gt;</p><p class="source-code">                &lt;p&gt;Last Login: <strong class="bold">{{ seller.last_login }}</strong>&lt;/p&gt;</p><p class="source-code">                &lt;p&gt;Date Joined: <strong class="bold">{{ seller.date_joined </strong></p><p class="source-code"><strong class="bold">                    }}</strong>&lt;/p&gt;</p><p class="source-code">                &lt;p&gt;Is Staff? <strong class="bold">{{ seller.is_staff }}</strong>&lt;/p&gt;</p><p class="source-code">                &lt;p&gt;Is Active? <strong class="bold">{{ seller.is_active </strong></p><p class="source-code"><strong class="bold">                    }}</strong>&lt;/p&gt;</p><p class="source-code">                &lt;p&gt;Is Superuser? <strong class="bold">{{ </strong></p><p class="source-code"><strong class="bold">                    seller.is_superuser }}</strong>&lt;/p&gt;</p><p class="source-code">                &lt;br /&gt;&lt;hr /&gt;&lt;br /&gt;</p><p class="source-code">            <strong class="bold">{% endfor %}</strong></p><p class="source-code">        <strong class="bold">{% endif %}</strong></p><p class="source-code">    &lt;/body&gt;</p><p class="source-code">...</p></li>
				<li>Just after the <strong class="bold">Is Superuser</strong> paragraph and before the <strong class="source-inline">&lt;br /&gt;&lt;hr /&gt;&lt;br /&gt;</strong> code snippet line, insert the <a id="_idIndexMarker1272"/>following conditional and <strong class="source-inline">for</strong> loop:<p class="source-code"><strong class="bold"># /becoming_a_django_entdev/chapter_10/templates/chapter_10/sellers.html</strong></p><p class="source-code">...</p><p class="source-code">            {% for seller in sellers %}</p><p class="source-code">                ...</p><p class="source-code">                &lt;p&gt;Is Superuser? {{ </p><p class="source-code">                     seller.is_superuser }}&lt;/p&gt;</p><p class="source-code">                <strong class="bold">{% if seller.vehicles.all %}</strong></p><p class="source-code">                    &lt;h2&gt;Seller Vehicles&lt;/h2&gt;</p><p class="source-code">                    <strong class="bold">{% for vehicle in seller.</strong></p><p class="source-code"><strong class="bold">                        vehicles.all %}</strong></p><p class="source-code">                        &lt;div class="vehicle-box"&gt;</p><p class="source-code">                            &lt;p&gt;VIN #: <strong class="bold">{{ vehicle.vin </strong></p><p class="source-code"><strong class="bold">                                }}</strong>&lt;/p&gt;</p><p class="source-code">                            &lt;p&gt;Price: <strong class="bold">{{ vehicle.price </strong></p><p class="source-code"><strong class="bold">                                }}</strong>&lt;/p&gt;</p><p class="source-code">                            &lt;p&gt;Make: <strong class="bold">{{ vehicle.make</strong></p><p class="source-code"><strong class="bold">                                |vehicle_make }}</strong>&lt;/p&gt;</p><p class="source-code">                            &lt;p&gt;Model: <strong class="bold">{{ vehicle.</strong></p><p class="source-code"><strong class="bold">                                vehicle_model }}</strong>&lt;/p&gt;</p><p class="source-code">                            &lt;p&gt;Engine: <strong class="bold">{{ </strong></p><p class="source-code"><strong class="bold">                                vehicle.engine }}</strong>&lt;/p&gt;</p><p class="source-code">                            &lt;p&gt;Is Sold? <strong class="bold">{{ vehicle</strong></p><p class="source-code"><strong class="bold">                                .sold }}</strong>&lt;/p&gt;</p><p class="source-code">                        &lt;/div&gt;</p><p class="source-code">                    <strong class="bold">{% endfor %}</strong></p><p class="source-code">                <strong class="bold">{% endif %}</strong></p><p class="source-code">                &lt;br /&gt;&lt;hr /&gt;&lt;br /&gt;</p><p class="source-code">            {% endfor %}</p><p class="source-code">...</p></li>
			</ol>
			<p>The logic here is pretty much the same as the vehicles listing page that we previously built. We added an additional<a id="_idIndexMarker1273"/> layer of looping inside the <strong class="source-inline">sellers</strong> loop that loops through the <strong class="source-inline">vehicles</strong> related to each <strong class="source-inline">seller</strong>.</p>
			<p>Let's map the URL pattern that we will need next.</p>
			<h3>Mapping the URL pattern</h3>
			<p>Take the following step<a id="_idIndexMarker1274"/> to map the URL pattern that we will be using to access this listing page.</p>
			<p>In your <strong class="source-inline">/chapter_10/urls.py</strong> file, add the following path to your <strong class="source-inline">urlpatterns</strong> list:</p>
			<pre class="source-code">from django.urls import path</pre>
			<pre class="source-code">from .views import <strong class="bold">SellersView</strong>, VehiclesView</pre>
			<pre class="source-code">urlpatterns = [</pre>
			<pre class="source-code">    ...</pre>
			<pre class="source-code">    path(</pre>
			<pre class="source-code">        'all-sellers/',</pre>
			<pre class="source-code">        <strong class="bold">SellersView</strong>.as_view(),</pre>
			<pre class="source-code">        name = 'all-sellers'</pre>
			<pre class="source-code">    )</pre>
			<pre class="source-code">]</pre>
			<p>The path <a id="_idIndexMarker1275"/>that we just mapped to the <strong class="source-inline">SellersView</strong> class will point to the URL http://localhost:8000/all-sellers/.</p>
			<p>Let's inspect the performance of the sellers listing page with the DjDT next.</p>
			<h3>Third demo</h3>
			<p>Follow these steps to <a id="_idIndexMarker1276"/>view the sellers listing page and inspect its database<a id="_idIndexMarker1277"/> query performance with the DjDT:</p>
			<ol>
				<li value="1">Make sure your project is running in your virtual environment and navigate to the URL http://localhost:8000/all-sellers/. If you are using the data provided with the <strong class="source-inline">chapter_3</strong> app fixture, you should see at least one set of <strong class="source-inline">seller</strong> data and seven <strong class="source-inline">vehicles</strong> for the first <strong class="source-inline">seller</strong>. </li>
			</ol>
			<p>If you have been following along with this book, you should have about three <strong class="source-inline">sellers</strong> in your database as a result of the exercises performed in previous chapters. Only one seller was provided in the <strong class="source-inline">chapter_3</strong> fixture. For the performance results shown in the following steps, assume that you have three <strong class="source-inline">sellers</strong> and seven <strong class="source-inline">vehicles</strong>, as your actual data may vary.</p>
			<ol>
				<li value="2">Open the DjDT and look at the <strong class="bold">SQL</strong> tab. You should see at least <strong class="bold">19 queries</strong>, as shown in the following screenshot:</li>
			</ol>
			<p class="figure-caption"><img src="image/Figure_10.11_B17243.png" alt="Figure 10.11 – Sellers list page not performance boosted&#13;&#10;"/></p>
			<p class="figure-caption">Figure 10.11 – Sellers list page not performance boosted</p>
			<p>There are so many queries being executed because Django is looking up each vehicle and each related <strong class="source-inline">vehicle_model</strong> and <strong class="source-inline">engine</strong> over and over again. The conditional that we wrote <strong class="source-inline">{% if seller.vehicles.all %}</strong>, checking if <strong class="source-inline">vehicles</strong> exist, and also added a single query to the page performance. </p>
			<ol>
				<li value="3">Now, in your <strong class="source-inline">/chapter_10/views.py</strong> file, under the <strong class="source-inline">get()</strong> method of the <strong class="source-inline">SellersView</strong> class, change<a id="_idIndexMarker1278"/> the query to the one highlighted in the following code snippet, where<a id="_idIndexMarker1279"/> we are adding the <strong class="source-inline">prefetch_related()</strong> method to what we had before:<p class="source-code"><strong class="bold"># /becoming_a_django_entdev/chapter_10/views.py</strong></p><p class="source-code">...</p><p class="source-code">class <strong class="bold">SellersView</strong>(View):</p><p class="source-code">    ...</p><p class="source-code">    def <strong class="bold">get(</strong>self, request, *args, **kwargs<strong class="bold">)</strong>:</p><p class="source-code">        try:</p><p class="source-code">            sellers = Seller.objects<strong class="bold">.prefetch_related(</strong></p><p class="source-code">    <strong class="bold">'vehicles',</strong></p><p class="source-code">    <strong class="bold">'vehicles__vehicle_model',</strong></p><p class="source-code">    <strong class="bold">'vehicles__engine'</strong></p><p class="source-code"><strong class="bold">)</strong>.all()</p><p class="source-code">        ...</p></li>
			</ol>
			<p>Inside the <strong class="source-inline">prefetch_related()</strong> method, we are telling Django to grab the related <strong class="source-inline">vehicles</strong> and then, in a separate action, the related <strong class="source-inline">vehicle_model</strong> and <strong class="source-inline">engine</strong> of each <strong class="source-inline">vehicle</strong> object. Whenever we need to specify other related fields, as we are doing in the preceding code block, we use a double underscore, <strong class="source-inline">__</strong>, to navigate up or down in a set of relationships. Please make sure you are following proper Python indentation where this is used. There is limited room to display this properly in the example shown previously.</p>
			<ol>
				<li value="4">Refresh the URL http://localhost:8000/all-sellers/ one more time and inspect the <strong class="bold">SQL</strong> tab of the<a id="_idIndexMarker1280"/> DjDT one more time. You should now see at least <strong class="bold">4 queries</strong>, as <a id="_idIndexMarker1281"/>shown in the following screenshot:</li>
			</ol>
			<div>
				<div id="_idContainer154" class="IMG---Figure">
					<img src="image/Figure_10.12_B17243.jpg" alt="Figure 10.12 – Sellers list page performance boosted&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.12 – Sellers list page performance boosted</p>
			<p>We also saved 6.95 ms of time using the performance-boosted method with this query lookup task. If we inspect the <strong class="bold">SQL</strong> tab even further by clicking on it, we can see that Django performed one query for the <strong class="source-inline">Seller</strong> objects, one for the <strong class="source-inline">Vehicle</strong> objects, one for the <strong class="source-inline">VehicleModel</strong> objects, and the last for the <strong class="source-inline">Engine</strong> objects. Django used a combination of <strong class="source-inline">WHERE</strong> clauses and <strong class="source-inline">INNER JOIN</strong> operations to retrieve the related data.</p>
			<div>
				<div id="_idContainer155" class="IMG---Figure">
					<img src="image/Figure_10.13_B17243.jpg" alt="Figure 10.13 – Inspecting the Sellers list page queries&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.13 – Inspecting the Sellers list page queries</p>
			<p>Django also <a id="_idIndexMarker1282"/>provides a <strong class="source-inline">Prefetch()</strong> class that can be used to perform even more<a id="_idIndexMarker1283"/> complex queries with performance-boosted capabilities. Next, let's use this class to perform advanced filtering of the <strong class="source-inline">vehicles</strong> that relate to a <strong class="source-inline">seller</strong>.</p>
			<h1 id="_idParaDest-278"><a id="_idTextAnchor310"/>Using the Prefetch() class</h1>
			<p>The <strong class="source-inline">Prefetch()</strong> class that is <a id="_idIndexMarker1284"/>provided in the <strong class="source-inline">django.db.models</strong> library is used to control how a <strong class="source-inline">prefetch_related()</strong> operation is performed. For instance, we will use it to filter and show only <strong class="source-inline">vehicles</strong> that are of the <strong class="source-inline">VehicleModel</strong> that equals <strong class="source-inline">"Blazer LT"</strong>. We can also prefetch all related objects when performing filters in this way. To learn about how to use this class in depth, visit <a href="https://docs.djangoproject.com/en/4.0/ref/models/querysets/#prefetch-objects">https://docs.djangoproject.com/en/4.0/ref/models/querysets/#prefetch-objects</a>.</p>
			<p>Use the following subsections to prepare your view class and template for this demonstration. The URL pattern will remain the same as the demonstration found in the <em class="italic">Sellers view</em> subsection of this chapter.</p>
			<h2 id="_idParaDest-279"><a id="_idTextAnchor311"/>Modifying the view</h2>
			<p>Follow these<a id="_idIndexMarker1285"/> steps to modify your existing <strong class="source-inline">SellersView</strong> class for this next exercise:</p>
			<ol>
				<li value="1">In your <strong class="source-inline">/chapter_10/views.py</strong> file, add the following <strong class="source-inline">import</strong> statement, preferably before the existing <strong class="source-inline">import</strong> statements:<p class="source-code"><strong class="bold"># /becoming_a_django_entdev/chapter_10/views.py</strong></p><p class="source-code">from django.db.models import <strong class="bold">Prefetch</strong></p><p class="source-code">...</p></li>
				<li>In the <strong class="source-inline">SellersView</strong> class found inside this file, change your query statement to the one shown in the following code snippet:<p class="source-code"><strong class="bold"># /becoming_a_django_entdev/chapter_10/views.py</strong></p><p class="source-code">...</p><p class="source-code">class <strong class="bold">SellersView</strong>(<strong class="bold">View</strong>):</p><p class="source-code">    ...</p><p class="source-code">            sellers = Seller.objects<strong class="bold">.prefetch_related(</strong></p><p class="source-code">                <strong class="bold">Prefetch(</strong></p><p class="source-code">                    <strong class="bold">'vehicles',</strong></p><p class="source-code">                    <strong class="bold">to_attr  = 'filtered_vehicles',</strong></p><p class="source-code">                    <strong class="bold">queryset =</strong> <strong class="bold">Vehicle.objects.filter(</strong></p><p class="source-code">                        <strong class="bold">vehicle_model__name = </strong></p><p class="source-code"><strong class="bold">                            'Blazer LT'</strong></p><p class="source-code"><strong class="bold">)</strong></p><p class="source-code">                <strong class="bold">),</strong></p><p class="source-code">                <strong class="bold">'filtered_vehicles__vehicle_model',</strong></p><p class="source-code">                <strong class="bold">'filtered_vehicles__engine'</strong></p><p class="source-code">            <strong class="bold">)</strong>.all()</p><p class="source-code">...</p></li>
			</ol>
			<p>Please make sure you are following proper Python indentation where this is used. There is limited room to display this properly in the preceding example. </p>
			<p>We are writing our query statement similar to what we wrote before. What we did differently this time is placed the <strong class="source-inline">Prefetch()</strong> class inside the <strong class="source-inline">prefetch_related()</strong> method, as the first argument of that method. The <strong class="source-inline">Prefetch()</strong> class accepts three arguments itself. The first is the lookup argument, which is usually a field but it can also be used to traverse relationships upstream and downstream using the double underscore, <strong class="source-inline">__</strong>, in the string. The second and third arguments are optional and do not have to be in the exact order. The <strong class="source-inline">to_attr</strong> argument is used to store the resulting QuerySet as a list of objects with the name specified as its value. The QuerySet argument is used to perform a specific query on the subset of those items. In the preceding example, we performed the <strong class="source-inline">filter()</strong> operation, searching only for vehicles with a <strong class="source-inline">vehicle_model__name</strong> of <strong class="source-inline">"Blazer LT"</strong>.</p>
			<p>After the <strong class="source-inline">Prefetch()</strong> class, in the same <strong class="source-inline">prefetch_related()</strong> method that we are using previously, we added two more field lookups, those being the <strong class="source-inline">filtered_vehicles__vehicle_model</strong> and <strong class="source-inline">filtered_vehicles__engine</strong> objects. This will prefetch the related objects pertaining to the custom <a id="_idIndexMarker1286"/>filtered list that we just created.</p>
			<p>Next, we need to modify our existing template file in order to work with the <strong class="source-inline">filtered_vehicles</strong> list of objects.</p>
			<h2 id="_idParaDest-280"><a id="_idTextAnchor312"/>Modifying the template</h2>
			<p>Follow these step to modify your existing sellers listing template file<a id="_idIndexMarker1287"/> to work with the <strong class="source-inline">filtered_vehicles</strong> list that was created:</p>
			<ol>
				<li value="1">In your existing <strong class="source-inline">/chapter_10/sellers.html</strong> file, change the two lines where <strong class="source-inline">seller.vehicles.all</strong> is used to now say <strong class="source-inline">seller.filtered_vehicles</strong>, as shown:<p class="source-code"><strong class="bold"># /becoming_a_django_entdev/chapter_10/templates/chapter_10/sellers.html</strong></p><p class="source-code">...</p><p class="source-code">            {% for seller in sellers %}</p><p class="source-code">                ...</p><p class="source-code">                {% if <strong class="bold">seller.filtered_vehicles</strong> %}</p><p class="source-code">                    &lt;h2&gt;Seller Vehicles&lt;/h2&gt;</p><p class="source-code">                    {% for vehicle in </p><p class="source-code">                        <strong class="bold">seller.filtered_vehicles </strong>%}</p><p class="source-code">                        ...</p><p class="source-code">                    {% endfor %}</p><p class="source-code">                {% endif %}</p><p class="source-code">                &lt;br /&gt;&lt;hr /&gt;&lt;br /&gt;</p><p class="source-code">            {% endfor %}</p><p class="source-code">...</p></li>
			</ol>
			<p>That's all that <a id="_idIndexMarker1288"/>we need to modify. Let's see how this affected our performance next.</p>
			<h2 id="_idParaDest-281"><a id="_idTextAnchor313"/>Fourth demo</h2>
			<p>Follow these steps to view the <a id="_idIndexMarker1289"/>sellers listing page and inspect its database query performance using the <strong class="source-inline">Prefetch()</strong> class approach to how a query operation is performed:</p>
			<ol>
				<li value="1">Refresh the URL http://localhost:8000/all-sellers/ in your browser.</li>
				<li>Open the DjDT and look at the <strong class="bold">SQL</strong> tab. You should see at least <strong class="bold">4 queries</strong>, as shown in the following screenshot:</li>
			</ol>
			<div>
				<div id="_idContainer156" class="IMG---Figure">
					<img src="image/Figure_10.14_B17243.jpg" alt="Figure 10.14 – Sellers list page using the Prefetch class&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.14 – Sellers list page using the Prefetch class</p>
			<p>This should also be the same <a id="_idIndexMarker1290"/>number of queries that we saw in our previous example, shown in <em class="italic">Figure 10.12</em>. The only difference in this dataset is that we see five <strong class="source-inline">vehicles</strong> under the first <strong class="source-inline">seller</strong> on the page, whereas before, we had seven <strong class="source-inline">vehicles</strong> shown. The results only display the <strong class="bold">Blazer LT</strong> vehicles now, as shown in the following screenshot:</p>
			<div>
				<div id="_idContainer157" class="IMG---Figure">
					<img src="image/Figure_10.15_B17243.jpg" alt="Figure 10.15 – Sellers list page using the Prefetch class results&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 10.15 – Sellers list page using the Prefetch class results</p>
			<p>While the<a id="_idIndexMarker1291"/> number of results may differ, the number of queries that are executed remains the same. With this approach, we can define a very granular search query that is performance boosted.</p>
			<h1 id="_idParaDest-282"><a id="_idTextAnchor314"/>Summary</h1>
			<p>We were able to conclude our journey in how to use Django to build enterprise-level systems by learning how to import and export data and apply performance-boosting tricks to all query operations. Knowing how to work with data is just as important as building the data siloes that they reside in. When you are working with existing systems, there is always the need to export the existing data from an old system and import that data into your new system. We now know how that is done. We can also combine this knowledge with the skills learned in <a href="B17243_02_ePub.xhtml#_idTextAnchor037"><em class="italic">Chapter 2</em></a>, <em class="italic">Project Configuration</em>, in the subsection titled <em class="italic">Heroku database push/pull operations</em> to work with data in your remote testing and production environments as well. Use each tool as needed to perform different tasks throughout your project's life cycle.</p>
			<p>The performance-boosting methods that were introduced in this chapter are intended to be applied to any query operation. Refer to the topics discussed throughout <a href="B17243_03_ePub.xhtml#_idTextAnchor077"><em class="italic">Chapter 3</em></a>, <em class="italic">Models, Relations, and Inheritance</em>, to learn more about how to structure your data and perform other query operations. In that same chapter, you can also apply performance boosters where queries are made inside of model managers.</p>
			<p>There is a wealth of knowledge, tips, and tricks that relate to the world of Django that were not covered in this book. I hope you enjoyed learning what you have read and practiced so far and I hope that you continue on your journey to learn even more. Use the links, resources, and references to packages and tools scattered throughout this book to expand your learning beyond what has been given to you. Feel free to reach out to me via any of the contact methods provided if you have questions, would like to point out an error in this book, or share a compliment. While I dedicated a lot of time and energy to writing this book and checking and then re-checking my work, we are all human and mistakes are bound to slip through the cracks. I would also love to hear about what marvels you created as a result of reading this book. Thank you all for taking the time to read this!</p>
		</div>
	</body></html>