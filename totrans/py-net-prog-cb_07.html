<html><head></head><body>
  <div id="sbo-rt-content"><div class="chapter" title="Chapter 7. Programming Across Machine Boundaries"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Programming Across Machine Boundaries</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Executing a remote shell command using telnet</li><li class="listitem" style="list-style-type: disc">Copying a file to a remote machine by SFTP</li><li class="listitem" style="list-style-type: disc">Printing a remote machine's CPU information</li><li class="listitem" style="list-style-type: disc">Installing a Python package remotely</li><li class="listitem" style="list-style-type: disc">Running a MySQL command remotely</li><li class="listitem" style="list-style-type: disc">Transferring files to a remote machine over SSH</li><li class="listitem" style="list-style-type: disc">Configuring Apache remotely to host a website</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec68"/>Introduction</h1></div></div></div><p>This chapter promotes some interesting Python libraries. The recipes are presented aiming at the system administrators and advanced Python programmers who like to write code that connects to remote systems and executes commands. The chapter begins with lightweight recipes with a built-in Python library, <code class="literal">telnetlib</code>. It then brings <code class="literal">Paramiko</code>, a well-known remote access library. Finally, the powerful remote system administration library, <code class="literal">fabric</code>, is presented. The <code class="literal">fabric</code> library is loved by developers who regularly script for automatic deployments, for example, deploying web applications or building custom application binaries.</p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Executing a remote shell command using telnet"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec69"/>Executing a remote shell command using telnet</h1></div></div></div><p>If you need to connect an old<a id="id435" class="indexterm"/> network switch or router via telnet, <a id="id436" class="indexterm"/>you can do so from a Python script instead of using a bash script or an interactive shell. This recipe will create a simple telnet session. It will show you how to execute shell commands to the remote host.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec143"/>Getting ready</h2></div></div></div><p>You need to install the telnet server on your machine and ensure that it's up and running. You can use a package manager that is specific to your operating system to install the telnet server package. For example, on Debian/Ubuntu, you can use <code class="literal">apt-get</code> or <code class="literal">aptitude</code> to install the <code class="literal">telnetd</code> package, as shown in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo apt-get install telnetd</strong></span>
<span class="strong"><strong>$ telnet localhost</strong></span>
</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec144"/>How to do it...</h2></div></div></div><p>Let us define a function that will<a id="id437" class="indexterm"/> take a user's login credentials from the command prompt and connect to a telnet server.</p><p>Upon successful connection, it will send the Unix <code class="literal">'ls'</code> command. Then, it will display the output of the command, for example, listing the contents of a directory.</p><p>Listing 7.1 shows the code for a<a id="id438" class="indexterm"/> telnet session that executes a Unix command remotely as follows:</p><div class="informalexample"><pre class="programlisting">#!/usr/bin/env python
# Python Network Programming Cookbook -- Chapter - 7
# This program is optimized for Python 2.7.
# It may run on any other version with/without modifications.

import getpass
import sys
import telnetlib
 
 
def run_telnet_session():
  host = raw_input("Enter remote hostname e.g. localhost:")
  user = raw_input("Enter your remote account: ")
  password = getpass.getpass()
  
  session = telnetlib.Telnet(host)
  
  session.read_until("login: ")
  session.write(user + "\n")
  if password:
    session.read_until("Password: ")
    session.write(password + "\n")
    
  session.write("ls\n")
  session.write("exit\n")
  
  print session.read_all()
 
if __name__ == '__main__':
  run_telnet_session()</pre></div><p>If you run a telnet server on your local machine and run this code, it will ask you for your remote user account and password. <a id="id439" class="indexterm"/>The following output shows a<a id="id440" class="indexterm"/> telnet session executed on a Debian machine:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ python 7_1_execute_remote_telnet_cmd.py </strong></span>
<span class="strong"><strong>Enter remote hostname e.g. localhost: localhost</strong></span>
<span class="strong"><strong>Enter your remote account: faruq</strong></span>
<span class="strong"><strong>Password: </strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong>ls</strong></span>
<span class="strong"><strong>exit</strong></span>
<span class="strong"><strong>Last login: Mon Aug 12 10:37:10 BST 2013 from localhost on pts/9</strong></span>
<span class="strong"><strong>Linux debian6 2.6.32-5-686 #1 SMP Mon Feb 25 01:04:36 UTC 2013 i686</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong>The programs included with the Debian GNU/Linux system are free software;</strong></span>
<span class="strong"><strong>the exact distribution terms for each program are described in the</strong></span>
<span class="strong"><strong>individual files in /usr/share/doc/*/copyright.</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent</strong></span>
<span class="strong"><strong>permitted by applicable law.</strong></span>
<span class="strong"><strong>You have new mail.</strong></span>
<span class="strong"><strong>faruq@debian6:~$ ls       </strong></span>
<span class="strong"><strong>down              Pictures               Videos</strong></span>
<span class="strong"><strong>Downloads         projects               yEd</strong></span>
<span class="strong"><strong>Dropbox           Public</strong></span>
<span class="strong"><strong>env               readme.txt</strong></span>
<span class="strong"><strong>faruq@debian6:~$ exit</strong></span>
<span class="strong"><strong>logout</strong></span>
</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec145"/>How it works...</h2></div></div></div><p>This recipe relies on Python's built-in <code class="literal">telnetlib</code> networking library to create a telnet session. The <code class="literal">run_telnet_session()</code> function<a id="id441" class="indexterm"/> takes the username and password from the command prompt. The <code class="literal">getpass</code> module's <code class="literal">getpass()</code> function<a id="id442" class="indexterm"/> is used to get the password as this function won't let you see what is typed on the screen.</p><p>In order to create a telnet session, you need to instantiate a <code class="literal">Telnet()</code> class<a id="id443" class="indexterm"/>, which takes a hostname parameter to initialize. In this case, <code class="literal">localhost</code> is used as the hostname. You can use the <code class="literal">argparse</code> module to pass a hostname to this script.</p><p>The telnet session's remote output can be captured with the <code class="literal">read_until()</code> method<a id="id444" class="indexterm"/>. In the first case, the login prompt<a id="id445" class="indexterm"/> is detected using this method. Then, <a id="id446" class="indexterm"/>the username with a new line feed is sent to the remote machine by the <code class="literal">write()</code> method (in this case, the same machine accessed as if it's remote). Similarly, the password was supplied to the remote host.</p><p>Then, the <code class="literal">ls</code> command is sent to be executed. Finally, to disconnect from the remote host, the <code class="literal">exit</code> command is sent, and all session data received from the remote host is printed on screen using the <code class="literal">read_all()</code> method.</p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Copying a file to a remote machine by SFTP"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec70"/>Copying a file to a remote machine by SFTP</h1></div></div></div><p>If you want to upload or copy a file from your local machine to a remote machine securely, you can do so via <span class="strong"><strong>Secure File Transfer Protocol</strong></span> (<span class="strong"><strong>SFTP</strong></span>).</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec146"/>Getting ready</h2></div></div></div><p>This recipe uses a<a id="id447" class="indexterm"/> powerful third-party networking library, <code class="literal">Paramiko</code>, to show you<a id="id448" class="indexterm"/> an example of file copying by SFTP, as shown in the following<a id="id449" class="indexterm"/> command. You can grab the latest code of <code class="literal">Paramiko</code> from GitHub (<a class="ulink" href="https://github.com/paramiko/paramiko">https://github.com/paramiko/paramiko</a>) or PyPI:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ pip install paramiko</strong></span>
</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec147"/>How to do it...</h2></div></div></div><p>This recipe takes a few command-line inputs: the remote hostname, server port, source filename, and destination filename. For the sake of simplicity, we can use default or hard-coded values for these input parameters.</p><p>In order to connect to the remote host, we need the username and password, which can be obtained from the user from the command line.</p><p>Listing 7.2 explains how to copy a file remotely by SFTP, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">#!/usr/bin/env python
# Python Network Programming Cookbook -- Chapter - 7
# This program is optimized for Python 2.7.
# It may run on any other version with/without modifications. 
 
import argparse
import paramiko
import getpass
 
 
SOURCE = '7_2_copy_remote_file_over_sftp.py'
DESTINATION ='/tmp/7_2_copy_remote_file_over_sftp.py '
 
 
def copy_file(hostname, port, username, password, src, dst):
  client = paramiko.SSHClient()
  client.load_system_host_keys()
  print " Connecting to %s \n with username=%s... \n" 
%(hostname,username)
  t = paramiko.Transport((hostname, port)) 
  t.connect(username=username,password=password)
  sftp = paramiko.SFTPClient.from_transport(t)
  print "Copying file: %s to path: %s" %(SOURCE, DESTINATION)
  sftp.put(src, dst)
  sftp.close()
  t.close()
 
 
if __name__ == '__main__':
  parser = argparse.ArgumentParser(description='Remote file copy')
  parser.add_argument('--host', action="store", dest="host", 
default='localhost')
  parser.add_argument('--port', action="store", dest="port", 
default=22, type=int)
  parser.add_argument('--src', action="store", dest="src", 
default=SOURCE)
  parser.add_argument('--dst', action="store", dest="dst", 
default=DESTINATION)
  
  given_args = parser.parse_args()
  hostname, port =  given_args.host, given_args.port
  src, dst = given_args.src, given_args.dst
  
  username = raw_input("Enter the username:")
  password = getpass.getpass("Enter password for %s: " %username)
  
  copy_file(hostname, port, username, password, src, dst)</pre></div><p>If you run this script, you will see an output similar to the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ python 7_2_copy_remote_file_over_sftp.py </strong></span>
<span class="strong"><strong>Enter the username:faruq</strong></span>
<span class="strong"><strong>Enter password for faruq: </strong></span>
<span class="strong"><strong> Connecting to localhost </strong></span>
<span class="strong"><strong> with username=faruq... </strong></span>
<span class="strong"><strong>Copying file: 7_2_copy_remote_file_over_sftp.py to path: </strong></span>
<span class="strong"><strong>/tmp/7_2_copy_remote_file_over_sftp.py </strong></span>
</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec148"/>How it works...</h2></div></div></div><p>This recipe can take the various inputs for connecting to a remote machine and copying a file over SFTP.</p><p>This recipe passes the<a id="id450" class="indexterm"/> command-line input to the <code class="literal">copy_file()</code> function<a id="id451" class="indexterm"/>. It then creates a SSH client calling the <code class="literal">SSHClient</code> class<a id="id452" class="indexterm"/> of <code class="literal">paramiko</code>. The client needs to load the system host keys. It then connects to the remote system, <a id="id453" class="indexterm"/>thus creating an instance of the <code class="literal">transport</code> class. The actual SFTP connection object, <code class="literal">sftp,</code> is created by calling the <code class="literal">SFTPClient.from_transport()</code> function<a id="id454" class="indexterm"/> of <code class="literal">paramiko</code>. This takes the <code class="literal">transport</code> instance as an input.</p><p>After the SFTP connection is ready,<a id="id455" class="indexterm"/> the local file is copied over this connection to the remote host using the <code class="literal">put()</code> method.</p><p>Finally, it's a good idea to clean up the SFTP connection and underlying objects by calling the <code class="literal">close()</code> method separately on each object.</p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Printing a remote machine's CPU information"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec71"/>Printing a remote machine's CPU information</h1></div></div></div><p>Sometimes, we need to run a<a id="id456" class="indexterm"/> simple command on a remote machine over SSH. For example, we need to query the remote machine's CPU or RAM information. This can be done from a Python script as shown in this recipe.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec149"/>Getting ready</h2></div></div></div><p>You need to install the third-party package, <code class="literal">Paramiko</code>, as shown in the following command, from the source available from GitHub's repository at <a class="ulink" href="https://github.com/paramiko/paramiko">https://github.com/paramiko/paramiko</a>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ pip install paramiko</strong></span>
</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec150"/>How to do it...</h2></div></div></div><p>We can use the <code class="literal">paramiko</code> module to create a remote session to a Unix machine.</p><p>Then, from this session, we can read the remote machine's <code class="literal">/proc/cpuinfo</code> file to extract the CPU information.</p><p>Listing 7.3 gives the code for<a id="id457" class="indexterm"/> printing a remote machine's CPU information, as follows:</p><div class="informalexample"><pre class="programlisting">#!/usr/bin/env python
# Python Network Programming Cookbook -- Chapter - 7
# This program is optimized for Python 2.7.
# It may run on any other version with/without modifications.
 
import argparse
import getpass
import paramiko
 
RECV_BYTES = 4096
COMMAND = 'cat /proc/cpuinfo'
 
def print_remote_cpu_info(hostname, port, username, password):
  client = paramiko.Transport((hostname, port))
  client.connect(username=username, password=password)
  
  stdout_data = []
  stderr_data = []
  session = client.open_channel(kind='session')
  session.exec_command(COMMAND)
  while True:
    if session.recv_ready():
      stdout_data.append(session.recv(RECV_BYTES))
      if session.recv_stderr_ready():
        stderr_data.append(session.recv_stderr(RECV_BYTES))
      if session.exit_status_ready():
        break
     
  print 'exit status: ', session.recv_exit_status()
  print ''.join(stdout_data)
  print ''.join(stderr_data)
  
  session.close()
  client.close()
 
if __name__ == '__main__':
  parser = argparse.ArgumentParser(description='Remote file copy')
  parser.add_argument('--host', action="store", dest="host", 
default='localhost')
  parser.add_argument('--port', action="store", dest="port", 
default=22, type=int)    
  given_args = parser.parse_args()
  hostname, port =  given_args.host, given_args.port
  
  username = raw_input("Enter the username:")
  password = getpass.getpass("Enter password for %s: " %username)
  print_remote_cpu_info(hostname, port, username, password)</pre></div><p>Running this script will show<a id="id458" class="indexterm"/> the CPU information of a given host, in this case, the local machine, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ python 7_3_print_remote_cpu_info.py </strong></span>
<span class="strong"><strong>Enter the username:faruq</strong></span>
<span class="strong"><strong>Enter password for faruq: </strong></span>
<span class="strong"><strong>exit status:  0</strong></span>
<span class="strong"><strong>processor    : 0</strong></span>
<span class="strong"><strong>vendor_id    : GenuineIntel</strong></span>
<span class="strong"><strong>cpu family    : 6</strong></span>
<span class="strong"><strong>model        : 42</strong></span>
<span class="strong"><strong>model name    : Intel(R) Core(TM) i5-2400S CPU @ 2.50GHz</strong></span>
<span class="strong"><strong>stepping    : 7</strong></span>
<span class="strong"><strong>cpu MHz        : 2469.677</strong></span>
<span class="strong"><strong>cache size    : 6144 KB</strong></span>
<span class="strong"><strong>fdiv_bug    : no</strong></span>
<span class="strong"><strong>hlt_bug        : no</strong></span>
<span class="strong"><strong>f00f_bug    : no</strong></span>
<span class="strong"><strong>coma_bug    : no</strong></span>
<span class="strong"><strong>fpu        : yes</strong></span>
<span class="strong"><strong>fpu_exception    : yes</strong></span>
<span class="strong"><strong>cpuid level    : 5</strong></span>
<span class="strong"><strong>wp        : yes</strong></span>
<span class="strong"><strong>flags        : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 syscall nx rdtscp lm constant_tsc up pni monitor ssse3 lahf_lm</strong></span>
<span class="strong"><strong>bogomips    : 4939.35</strong></span>
<span class="strong"><strong>clflush size    : 64</strong></span>
<span class="strong"><strong>cache_alignment    : 64</strong></span>
<span class="strong"><strong>address sizes    : 36 bits physical, 48 bits virtual</strong></span>
<span class="strong"><strong>power management:</strong></span>
</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec151"/>How it works...</h2></div></div></div><p>First, we collect the connection parameters such as hostname, port, username, and password. These parameters are then passed to the <a id="id459" class="indexterm"/>
<code class="literal">print_remote_cpu_info()</code> function.</p><p>This function creates an SSH client session by calling the <code class="literal">transport</code> class of <code class="literal">paramiko</code>. The connection is made thereafter using the supplied username and password. We can create a raw communication session using <code class="literal">open_channel()</code> on the SSH client. In order to execute a command on the remote host, <code class="literal">exec_command()</code> can be used.</p><p>After sending the command to the remote host, the response from the remote host can be caught by blocking the <code class="literal">recv_ready()</code> event<a id="id460" class="indexterm"/> of the session object. We can create two lists, <code class="literal">stdout_data</code> and <code class="literal">stderr_data</code>, and use them to store the remote output and error messages.</p><p>When the command exits in the<a id="id461" class="indexterm"/> remote machine, it can be detected using the <code class="literal">exit_status_ready()</code> method<a id="id462" class="indexterm"/>, and the remote session data can be concatenated using the <code class="literal">join()</code> string method.</p><p>Finally, the session and client connection can be closed using the <code class="literal">close()</code> method on each object.</p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Installing a Python package remotely"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec72"/>Installing a Python package remotely</h1></div></div></div><p>While dealing with the remote host in the previous recipes, you may have noticed that we need to do a lot of stuff related to the connection setup. For efficient execution, it is desirable that they become abstract and only the relevant high-level part is exposed to the programmers. It is cumbersome and slow to always explicitly set up connections to execute commands remotely.</p><p>Fabric (<a class="ulink" href="http://fabfile.org/">http://fabfile.org/</a>), a third-party Python module, solves this problem. It only exposes as many APIs as can be used to efficiently interact with remote machines.</p><p>In this recipe, a simple<a id="id463" class="indexterm"/> example of using Fabric will be shown.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec152"/>Getting ready</h2></div></div></div><p>We need Fabric to be installed first. You can install Fabric using the Python packing tools, <code class="literal">pip</code> or <code class="literal">easy_install</code>, as shown in the following command. Fabric relies on the <code class="literal">paramiko</code> module, which will be installed automatically.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ pip install fabric</strong></span>
</pre></div><p>Here, we will connect the remote host using the SSH protocol. So, it's necessary to run the SSH server on the remote end. If you like to test with your local machine (pretending to access as a remote machine), you may install the <code class="literal">openssh</code> server package locally. On a Debian/Ubuntu machine, this can be done with the package manager, <code class="literal">apt-get</code>, as shown in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo apt-get install openssh-server</strong></span>
</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec153"/>How to do it...</h2></div></div></div><p>Here's the code for installing a Python package using<a id="id464" class="indexterm"/> Fabric.</p><p>Listing 7.4 gives the code for installing a Python package remotely as follows:</p><div class="informalexample"><pre class="programlisting">#!/usr/bin/env python
# Python Network Programming Cookbook -- Chapter - 7
# This program is optimized for Python 2.7.
# It may run on any other version with/without modifications.
 
from getpass import getpass
from fabric.api import settings, run, env, prompt
 
def remote_server():
  env.hosts = ['127.0.0.1']
  env.user = prompt('Enter user name: ')
  env.password = getpass('Enter password: ')
  
def install_package():
  run("pip install yolk")</pre></div><p>Fabric scripts are run in a different <a id="id465" class="indexterm"/>way as compared to the normal Python scripts. All functions using the <code class="literal">fabric</code> library must be referred to a Python script called <code class="literal">fabfile.py</code>. There's no traditional <code class="literal">__main__</code> directive in this script. Instead, you can define your method using the Fabric APIs and execute these methods using the command-line tool, <code class="literal">fab</code>. So, instead of calling <code class="literal">python &lt;script&gt;.py</code>, you can run a Fabric script, which is defined in a <code class="literal">fabfile.py</code> script and located under the current directory, by calling <code class="literal">fab one_function_name another_function_name</code>.</p><p>So, let's create a <code class="literal">fabfile.py</code> script as shown in the following command. For the sake of simplicity, you can create a file shortcut or link from any file to a <code class="literal">fabfile.py</code> script. First, delete any previously created <code class="literal">fabfile.py</code> file and create a shortcut to <code class="literal">fabfile</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ rm -rf fabfile.py</strong></span>
<span class="strong"><strong>$ ln -s 7_4_install_python_package_remotely.py fabfile.py</strong></span>
</pre></div><p>If you call the fabfile now, it will produce the following output after installing the Python package, <code class="literal">yolk</code>, remotely as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ln -sfn 7_4_install_python_package_remotely.py fabfile.py</strong></span>
<span class="strong"><strong>$ fab remote_server install_package</strong></span>
<span class="strong"><strong>Enter user name: faruq</strong></span>
<span class="strong"><strong>Enter password:</strong></span>
<span class="strong"><strong>[127.0.0.1] Executing task 'install_package'</strong></span>
<span class="strong"><strong>[127.0.0.1] run: pip install yolk</strong></span>
<span class="strong"><strong>[127.0.0.1] out: Downloading/unpacking yolk</strong></span>
<span class="strong"><strong>[127.0.0.1] out:   Downloading yolk-0.4.3.tar.gz (86kB): </strong></span>
<span class="strong"><strong>[127.0.0.1] out:   Downloading yolk-0.4.3.tar.gz (86kB): 100%  86kB</strong></span>
<span class="strong"><strong>[127.0.0.1] out:   Downloading yolk-0.4.3.tar.gz (86kB):           </strong></span>
<span class="strong"><strong>[127.0.0.1] out:   Downloading yolk-0.4.3.tar.gz (86kB): 86kB </strong></span>
<span class="strong"><strong>downloaded</strong></span>
<span class="strong"><strong>[127.0.0.1] out:   Running setup.py egg_info for package yolk</strong></span>
<span class="strong"><strong>[127.0.0.1] out:     Installing yolk script to /home/faruq/env/bin</strong></span>
<span class="strong"><strong>[127.0.0.1] out: Successfully installed yolk</strong></span>
<span class="strong"><strong>[127.0.0.1] out: Cleaning up...</strong></span>
<span class="strong"><strong>[127.0.0.1] out: </strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong>Done.</strong></span>
<span class="strong"><strong>Disconnecting from 127.0.0.1... done.</strong></span>
</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec154"/>How it works...</h2></div></div></div><p>This recipe demonstrates how<a id="id466" class="indexterm"/> a system administration task can be done remotely using a Python script. There are two functions present in this script.<a id="id467" class="indexterm"/> The <code class="literal">remote_server()</code> function<a id="id468" class="indexterm"/> sets up the Fabric <code class="literal">env</code> environment variables, for example, the hostname, user, password, and so on.</p><p>The other function, <code class="literal">install_package()</code>, calls the <code class="literal">run()</code> function. This takes the commands that you usually type in the command line. In this case, the command is <code class="literal">pip install yolk</code>. This installs the Python package, <code class="literal">yolk</code>, with <code class="literal">pip</code>. As compared to the previously described recipes, this method of running a remote command using Fabric is easier and more efficient.</p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Running a MySQL command remotely"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec73"/>Running a MySQL command remotely</h1></div></div></div><p>If you ever need to <a id="id469" class="indexterm"/>administer a MySQL server remotely, this recipe is for<a id="id470" class="indexterm"/> you. It will show you how to send database commands to a remote MySQL server from a Python script. If you need to set up a web application that relies on a backend database, this recipe can be used as a part of your web application setup process.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec155"/>Getting ready</h2></div></div></div><p>This recipe also needs Fabric to be installed first. You can install Fabric using the Python packing tools, <code class="literal">pip</code> or <code class="literal">easy_install</code>, as shown in the following command. Fabric relies on the <code class="literal">paramiko</code> module, which will be installed automatically.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ pip install fabric</strong></span>
</pre></div><p>Here, we will connect the remote host using the SSH protocol. So, it's necessary to run the SSH server on the remote end. You also need to run a MySQL server on the remote host. On a Debian/Ubuntu machine, this can be done with the package manager, <code class="literal">apt-get</code>, as shown in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo apt-get install openssh-server mysql-server</strong></span>
</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec156"/>How to do it...</h2></div></div></div><p>We defined the<a id="id471" class="indexterm"/> Fabric environment settings and a few functions for administering MySQL remotely. In these functions, instead of calling the<a id="id472" class="indexterm"/> <code class="literal">mysql</code> executable directly, we send the SQL commands to <code class="literal">mysql</code> via <code class="literal">echo</code>. This ensures that arguments are passed properly to the <code class="literal">mysql</code> executable.</p><p>Listing 7.5 gives the code for running MySQL commands remotely, as follows:</p><div class="informalexample"><pre class="programlisting">#!/usr/bin/env python
# Python Network Programming Cookbook -- Chapter - 7
# This program is optimized for Python 2.7.
# It may run on any other version with/without modifications.

from getpass import getpass 
from fabric.api import run, env, prompt, cd
 
def remote_server():
  env.hosts = ['127.0.0.1']
# Edit this list to include remote hosts
  env.user =prompt('Enter your system username: ')
  env.password = getpass('Enter your system user password: ')
  env.mysqlhost = 'localhost'
  env.mysqluser = 'root'prompt('Enter your db username: ')
  env.password = getpass('Enter your db user password: ')
  env.db_name = ''
 
def show_dbs():
  """ Wraps mysql show databases cmd"""
  q = "show databases"
  run("echo '%s' | mysql -u%s -p%s" %(q, env.mysqluser, 
env.mysqlpassword))
 
 
def run_sql(db_name, query):
  """ Generic function to run sql"""
  with cd('/tmp'):
    run("echo '%s' | mysql -u%s -p%s -D %s" %(query, 
env.mysqluser, env.mysqlpassword, db_name))
 
def create_db():
  """Create a MySQL DB for App version"""
  if not env.db_name:
    db_name = prompt("Enter the DB name:")
  else:
    db_name = env.db_name
  run('echo "CREATE DATABASE %s default character set utf8 collate 
utf8_unicode_ci;"|mysql --batch --user=%s --password=%s --
host=%s'\
    % (db_name, env.mysqluser, env.mysqlpassword, env.mysqlhost), 
pty=True)
 
def ls_db():
  """ List a dbs with size in MB """
  if not env.db_name:
    db_name = prompt("Which DB to ls?")
  else:
    db_name = env.db_name
  query = """SELECT table_schema                                        
"DB Name", 
  Round(Sum(data_length + index_length) / 1024 / 1024, 1) "DB Size 
in MB" 
    FROM   information_schema.tables         
    WHERE table_schema = \"%s\" 
    GROUP  BY table_schema """ %db_name
  run_sql(db_name, query)
 
 
def empty_db():
  """ Empty all tables of a given DB """
  db_name = prompt("Enter DB name to empty:")
  cmd = """
  (echo 'SET foreign_key_checks = 0;'; 
  (mysqldump -u%s -p%s --add-drop-table --no-data %s | 
  grep ^DROP); 
  echo 'SET foreign_key_checks = 1;') | \
  mysql -u%s -p%s -b %s
  """ %(env.mysqluser, env.mysqlpassword, db_name, env.mysqluser, 
env.mysqlpassword, db_name)
  run(cmd)</pre></div><p>In order to run this script, you should create a shortcut, <code class="literal">fabfile.py</code>. From the command line, you can do this by typing the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ln -sfn 7_5_run_mysql_command_remotely.py fabfile.py</strong></span>
</pre></div><p>Then, you can call the <code class="literal">fab</code> executable in various forms.</p><p>The following command will show a list of databases (using the SQL query, <code class="literal">show databases</code>):</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ fab remote_server show_dbs</strong></span>
</pre></div><p>The following command <a id="id473" class="indexterm"/>will create a new MySQL database. If you haven't defined the Fabric environment variable, <code class="literal">db_name</code>, a prompt will<a id="id474" class="indexterm"/> be shown to enter the target database name. This database will be created using the SQL command, <code class="literal">CREATE DATABASE &lt;database_name&gt; default character set utf8 collate utf8_unicode_ci;</code>.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ fab remote_server create_db</strong></span>
</pre></div><p>This Fabric command will show the size of a database:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ fab remote_server ls_db()</strong></span>
</pre></div><p>The following Fabric command will use the <code class="literal">mysqldump</code> and <code class="literal">mysql</code> executables to empty a database. This behavior of this function is similar to the truncating of a database, except it removes all the tables. The result is as if you created a fresh database without any tables:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ fab remote_server empty_db()</strong></span>
</pre></div><p>The following will be the output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ $ fab remote_server show_dbs</strong></span>
<span class="strong"><strong>[127.0.0.1] Executing task 'show_dbs'</strong></span>
<span class="strong"><strong>[127.0.0.1] run: echo 'show databases' | mysql -uroot -p&lt;DELETED&gt;</strong></span>
<span class="strong"><strong>[127.0.0.1] out: Database</strong></span>
<span class="strong"><strong>[127.0.0.1] out: information_schema</strong></span>
<span class="strong"><strong>[127.0.0.1] out: mysql</strong></span>
<span class="strong"><strong>[127.0.0.1] out: phpmyadmin</strong></span>
<span class="strong"><strong>[127.0.0.1] out: </strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong>Done.</strong></span>
<span class="strong"><strong>Disconnecting from 127.0.0.1... done.</strong></span>

<span class="strong"><strong> </strong></span>
<span class="strong"><strong>$ fab remote_server create_db</strong></span>
<span class="strong"><strong>[127.0.0.1] Executing task 'create_db'</strong></span>
<span class="strong"><strong>Enter the DB name: test123</strong></span>
<span class="strong"><strong>[127.0.0.1] run: echo "CREATE DATABASE test123 default character set utf8 collate utf8_unicode_ci;"|mysql --batch --user=root --password=&lt;DELETED&gt; --host=localhost</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong>Done.</strong></span>
<span class="strong"><strong>Disconnecting from 127.0.0.1... done.</strong></span>
<span class="strong"><strong>$ fab remote_server show_dbs</strong></span>
<span class="strong"><strong>[127.0.0.1] Executing task 'show_dbs'</strong></span>
<span class="strong"><strong>[127.0.0.1] run: echo 'show databases' | mysql -uroot -p&lt;DELETED&gt;</strong></span>
<span class="strong"><strong>[127.0.0.1] out: Database</strong></span>
<span class="strong"><strong>[127.0.0.1] out: information_schema</strong></span>
<span class="strong"><strong>[127.0.0.1] out: collabtive</strong></span>
<span class="strong"><strong>[127.0.0.1] out: test123</strong></span>
<span class="strong"><strong>[127.0.0.1] out: testdb</strong></span>
<span class="strong"><strong>[127.0.0.1] out: </strong></span>

<span class="strong"><strong>Done.</strong></span>
<span class="strong"><strong>Disconnecting from 127.0.0.1... done.</strong></span>
</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec157"/>How it works...</h2></div></div></div><p>This script defines a few functions that are used with Fabric. The first function, <code class="literal">remote_server()</code>,<a id="id475" class="indexterm"/> sets the environment variables. The local loopback IP (<code class="literal">127.0.0.1</code>) is put to the list of hosts. The <a id="id476" class="indexterm"/>local system user and MySQL login credentials are set and collected via <code class="literal">getpass()</code>.</p><p>The other function utilizes the Fabric <code class="literal">run()</code> function to send MySQL commands to the remote MySQL server<a id="id477" class="indexterm"/> by echoing the command to the <code class="literal">mysql</code> executable.</p><p>The <code class="literal">run_sql()</code> function<a id="id478" class="indexterm"/> is a generic function that can be used as a wrapper in other functions. For example, the <code class="literal">empty_db()</code> function<a id="id479" class="indexterm"/> calls it to execute the SQL commands. This can keep your code a bit more organized and cleaner.</p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Transferring files to a remote machine over SSH"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec74"/>Transferring files to a remote machine over SSH</h1></div></div></div><p>While automating a remote system administration task using Fabric, if you want to transfer files between your local <a id="id480" class="indexterm"/>machine and the remote machine with SSH, you can use the Fabric's built-in <code class="literal">get()</code> and <code class="literal">put()</code> functions. This recipe shows you how we can create custom functions to transfer files<a id="id481" class="indexterm"/> smartly by checking the<a id="id482" class="indexterm"/> disk space before and after the transfer.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec158"/>Getting ready</h2></div></div></div><p>This recipe also needs Fabric to be installed first. You can install Fabric using Python packing tools, <code class="literal">pip</code> or <code class="literal">easy_install</code>, as shown in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ pip install fabric</strong></span>
</pre></div><p>Here, we will connect the remote host using the SSH protocol. So, it's necessary to install and run the SSH server on the remote host.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec159"/>How to do it...</h2></div></div></div><p>Let us first set up the Fabric environment variables and then create two functions, one for downloading files and the other for uploading files.</p><p>Listing 7.6 gives the code for transferring files to a remote machine over SSH as follows:</p><div class="informalexample"><pre class="programlisting">#!/usr/bin/env python
# Python Network Programming Cookbook -- Chapter - 7
# This program is optimized for Python 2.7.
# It may run on any other version with/without modifications.
 
from getpass import getpass
from fabric.api import local, run, env, get, put, prompt, open_shell
 
def remote_server():
  env.hosts = ['127.0.0.1']
  env.password = getpass('Enter your system password: ')
  env.home_folder = '/tmp'
 
def login():
  open_shell(command="cd %s" %env.home_folder)
 
 
def download_file():
  print "Checking local disk space..."
  local("df -h")
  remote_path = prompt("Enter the remote file path:")
  local_path = prompt("Enter the local file path:")
  get(remote_path=remote_path, local_path=local_path)
  local("ls %s" %local_path)
 

def upload_file():
  print "Checking remote disk space..."
  run("df -h")
  local_path = prompt("Enter the local file path:")
  remote_path = prompt("Enter the remote file path:")
  put(remote_path=remote_path, local_path=local_path)
  run("ls %s" %remote_path)</pre></div><p>In order to run this script, you should create a shortcut, <code class="literal">fabfile.py</code>. From the command line, you can do this by typing the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ln -sfn 7_6_transfer_file_over_ssh.py fabfile.py</strong></span>
</pre></div><p>Then, you can call the <code class="literal">fab</code> executable in various forms.</p><p>First, to log on to a remote server<a id="id483" class="indexterm"/> using your script, you can run the following Fabric function:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ fab remote_server login</strong></span>
</pre></div><p>This will give you a<a id="id484" class="indexterm"/> minimum shell-like environment. Then, you can download a file from a remote server to your local machine using the following <a id="id485" class="indexterm"/>command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ fab remote_server download_file</strong></span>
</pre></div><p>Similarly, to upload a file, you can use the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ fab remote_server upload_file</strong></span>
</pre></div><p>In this example, the local machine is used via SSH. So, you have to install the SSH server locally to run these scripts. Otherwise, you can modify the <code class="literal">remote_server()</code> function<a id="id486" class="indexterm"/> and point it to a remote server, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ fab remote_server login</strong></span>
<span class="strong"><strong>[127.0.0.1] Executing task 'login'</strong></span>
<span class="strong"><strong>Linux debian6 2.6.32-5-686 #1 SMP Mon Feb 25 01:04:36 UTC 2013 i686</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong>The programs included with the Debian GNU/Linux system are free software;</strong></span>
<span class="strong"><strong>the exact distribution terms for each program are described in the</strong></span>
<span class="strong"><strong>individual files in /usr/share/doc/*/copyright.</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong>Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent</strong></span>
<span class="strong"><strong>permitted by applicable law.</strong></span>
<span class="strong"><strong>You have new mail.</strong></span>
<span class="strong"><strong>Last login: Wed Aug 21 15:08:45 2013 from localhost</strong></span>
<span class="strong"><strong>cd /tmp</strong></span>
<span class="strong"><strong>faruq@debian6:~$ cd /tmp</strong></span>
<span class="strong"><strong>faruq@debian6:/tmp$ </strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong>&lt;CTRL+D&gt;</strong></span>
<span class="strong"><strong>faruq@debian6:/tmp$ logout</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong>Done.</strong></span>
<span class="strong"><strong>Disconnecting from 127.0.0.1... done.</strong></span>

<span class="strong"><strong>$ fab remote_server download_file</strong></span>
<span class="strong"><strong>[127.0.0.1] Executing task 'download_file'</strong></span>
<span class="strong"><strong>Checking local disk space...</strong></span>
<span class="strong"><strong>[localhost] local: df -h</strong></span>
<span class="strong"><strong>Filesystem            Size  Used Avail Use% Mounted on</strong></span>
<span class="strong"><strong>/dev/sda1              62G   47G   12G  81% /</strong></span>
<span class="strong"><strong>tmpfs                 506M     0  506M   0% /lib/init/rw</strong></span>
<span class="strong"><strong>udev                  501M  160K  501M   1% /dev</strong></span>
<span class="strong"><strong>tmpfs                 506M  408K  505M   1% /dev/shm</strong></span>
<span class="strong"><strong>Z_DRIVE              1012G  944G   69G  94% /media/z</strong></span>
<span class="strong"><strong>C_DRIVE               466G  248G  218G  54% /media/c</strong></span>
<span class="strong"><strong>Enter the remote file path: /tmp/op.txt</strong></span>
<span class="strong"><strong>Enter the local file path: .</strong></span>
<span class="strong"><strong>[127.0.0.1] download: chapter7/op.txt &lt;- /tmp/op.txt</strong></span>
<span class="strong"><strong>[localhost] local: ls .</strong></span>
<span class="strong"><strong>7_1_execute_remote_telnet_cmd.py   7_3_print_remote_cpu_info.py           7_5_run_mysql_command_remotely.py  7_7_configure_Apache_for_hosting_website_remotely.py  fabfile.pyc  __init__.py  test.txt</strong></span>
<span class="strong"><strong>7_2_copy_remote_file_over_sftp.py  7_4_install_python_package_remotely.py  7_6_transfer_file_over_ssh.py      fabfile.py                        index.html     op.txt       vhost.conf</strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong>Done.</strong></span>
<span class="strong"><strong>Disconnecting from 127.0.0.1... done.</strong></span>
</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec160"/>How it works...</h2></div></div></div><p>In this recipe, we used a few of Fabric's built-in functions to transfer files between local and remote machines. The <code class="literal">local()</code> function does an action on the local machine, whereas the remote actions are carried out by the <code class="literal">run()</code> function.</p><p>This is useful to check the<a id="id487" class="indexterm"/> available disk space on the target machine before uploading a file and vice versa.</p><p>This is achieved by using the Unix command, <code class="literal">df</code>. The source and destination file paths can be specified via the<a id="id488" class="indexterm"/> command prompt or can be hard coded<a id="id489" class="indexterm"/> in the source file in case of an unattended automatic execution.</p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Configuring Apache remotely to host a website"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec75"/>Configuring Apache remotely to host a website</h1></div></div></div><p>Fabric functions can be run as both regular and super users. If you need to host a website in a remote Apache web server,<a id="id490" class="indexterm"/> you need the administrative user privileges to create configuration files and restart the web server. This recipe introduces the Fabric <code class="literal">sudo()</code> function that runs commands in the remote machine as a superuser. Here, we would like to configure the Apache virtual host for running a website.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec161"/>Getting ready</h2></div></div></div><p>This recipe needs Fabric to be installed first on your local machine. You can install Fabric using the Python packing tools, <code class="literal">pip</code> or <code class="literal">easy_install</code>, as shown in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ pip install fabric</strong></span>
</pre></div><p>Here, we will connect the remote host using the SSH protocol. So, it's necessary to install and run the SSH server on the remote host. It is also assumed that the Apache web server is installed and running on the remote server. On a Debian/Ubuntu machine, this can be done with the package manager, <code class="literal">apt-get</code>, as shown in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo apt-get install openssh-server apache2</strong></span>
</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec162"/>How to do it...</h2></div></div></div><p>First, we collect our Apache installation paths and some configuration parameters, such as web server user, group, virtual host configuration path, and initialization scripts. These parameters can be defined as constants.</p><p>Then, we set up two functions, <code class="literal">remote_server()</code> and <code class="literal">setup_vhost()</code>, to execute the Apache configuration task using Fabric.</p><p>Listing 7.7 gives the code for <a id="id491" class="indexterm"/>configuring Apache remotely to host a website as follows:</p><div class="informalexample"><pre class="programlisting">#!/usr/bin/env python
# Python Network Programming Cookbook -- Chapter - 7
# This program is optimized for Python 2.7.
# It may run on any other version with/without modifications.
 
from fabric.api import env, put, sudo, prompt
from fabric.contrib.files import exists
 
WWW_DOC_ROOT = "/data/apache/test/"
WWW_USER = "www-data"
WWW_GROUP = "www-data"
APACHE_SITES_PATH = "/etc/apache2/sites-enabled/"
APACHE_INIT_SCRIPT = "/etc/init.d/apache2 "
 
def remote_server():
  env.hosts = ['127.0.0.1']
  env.user = prompt('Enter user name: ')
  env.password = getpass('Enter your system password: ')
 
 
def setup_vhost():
  """ Setup a test website """
  print "Preparing the Apache vhost setup..."
  
  print "Setting up the document root..."
  if exists(WWW_DOC_ROOT):
    sudo("rm -rf %s" %WWW_DOC_ROOT)
  sudo("mkdir -p %s" %WWW_DOC_ROOT)
  
  # setup file permissions
  sudo("chown -R %s.%s %s" %(env.user, env.user, WWW_DOC_ROOT))

  # upload a sample index.html file
  put(local_path="index.html", remote_path=WWW_DOC_ROOT)
  sudo("chown -R %s.%s %s" %(WWW_USER, WWW_GROUP, WWW_DOC_ROOT))
  
  print "Setting up the vhost..."
  sudo("chown -R %s.%s %s" %(env.user, env.user, 
APACHE_SITES_PATH))
  
  # upload a pre-configured vhost.conf
  put(local_path="vhost.conf", remote_path=APACHE_SITES_PATH)
  sudo("chown -R %s.%s %s" %('root', 'root', APACHE_SITES_PATH))
  
  # restart Apache to take effect
  sudo("%s restart" %APACHE_INIT_SCRIPT)
  print "Setup complete. Now open the server path 
http://abc.remote-server.org/ in your web browser."</pre></div><p>In order to run this script, the following line should be appended on your host file, for example,. <code class="literal">/etc/hosts</code>:</p><div class="informalexample"><pre class="programlisting">
<code class="literal">127.0.0.1 abc.remote-server.org abc </code>
</pre></div><p>You should also create a shortcut, <code class="literal">fabfile.py</code>. From the command line, you can do this by typing the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ln -sfn 7_7_configure_Apache_for_hosting_website_remotely.py </strong></span>
<span class="strong"><strong>fabfile.py</strong></span>
</pre></div><p>Then, you can call the <code class="literal">fab</code> executable in various forms.</p><p>First, to log on to a remote<a id="id492" class="indexterm"/> server using your script, you can run the following Fabric function. This will result in the following output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ fab remote_server setup_vhost</strong></span>
<span class="strong"><strong>[127.0.0.1] Executing task 'setup_vhost'</strong></span>
<span class="strong"><strong>Preparing the Apache vhost setup...</strong></span>
<span class="strong"><strong>Setting up the document root...</strong></span>
<span class="strong"><strong>[127.0.0.1] sudo: rm -rf /data/apache/test/</strong></span>
<span class="strong"><strong>[127.0.0.1] sudo: mkdir -p /data/apache/test/</strong></span>
<span class="strong"><strong>[127.0.0.1] sudo: chown -R faruq.faruq /data/apache/test/</strong></span>
<span class="strong"><strong>[127.0.0.1] put: index.html -&gt; /data/apache/test/index.html</strong></span>
<span class="strong"><strong>[127.0.0.1] sudo: chown -R www-data.www-data /data/apache/test/</strong></span>
<span class="strong"><strong>Setting up the vhost...</strong></span>
<span class="strong"><strong>[127.0.0.1] sudo: chown -R faruq.faruq /etc/apache2/sites-enabled/</strong></span>
<span class="strong"><strong>[127.0.0.1] put: vhost.conf -&gt; /etc/apache2/sites-enabled/vhost.conf</strong></span>
<span class="strong"><strong>[127.0.0.1] sudo: chown -R root.root /etc/apache2/sites-enabled/</strong></span>
<span class="strong"><strong>[127.0.0.1] sudo: /etc/init.d/apache2 restart</strong></span>
<span class="strong"><strong>[127.0.0.1] out: Restarting web server: apache2apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.0.1 for ServerName</strong></span>
<span class="strong"><strong>[127.0.0.1] out:  ... waiting apache2: Could not reliably determine the server's fully qualified domain name, using 127.0.0.1 for ServerName</strong></span>
<span class="strong"><strong>[127.0.0.1] out: .</strong></span>
<span class="strong"><strong>[127.0.0.1] out: </strong></span>
<span class="strong"><strong> </strong></span>
<span class="strong"><strong>Setup complete. Now open the server path http://abc.remote-server.org/ in your web browser.</strong></span>

<span class="strong"><strong>Done.</strong></span>
<span class="strong"><strong>Disconnecting from 127.0.0.1... done.</strong></span>
</pre></div><p>After you run this recipe, you can open your browser and try to access the path you set up on the host file (for example, <code class="literal">/etc/hosts</code>). It should show the following output on your browser:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>It works! </strong></span>
<span class="strong"><strong>This is the default web page for this server.</strong></span>
<span class="strong"><strong>The web server software is running but no content has been added, </strong></span>
<span class="strong"><strong>yet.</strong></span>
</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec163"/>How it works...</h2></div></div></div><p>This recipe sets up the initial <a id="id493" class="indexterm"/>Apache configuration parameters as constants and then defines two functions. In the <code class="literal">remote_server()</code> function, the usual Fabric environment parameters, for example, hosts, user, password, and so on, are placed.</p><p>The <code class="literal">setup_vhost()</code> function<a id="id494" class="indexterm"/> executes a series of privileged commands. First, it checks whether the website's document root path is already created using the <code class="literal">exists()</code> function. If it exists, it removes that path and creates it in the next step. Using <code class="literal">chown</code>, it ensures that the path is owned by the current user.</p><p>In the next step, it uploads a bare bone HTML file, <code class="literal">index.html</code>, to the document root path. After uploading the file, it reverts the permission of the files to the web server user.</p><p>After setting up the document root, the <code class="literal">setup_vhost()</code> function uploads the supplied <code class="literal">vhost.conf</code> file to the Apache site configuration path. Then, it sets its owner as the root user.</p><p>Finally, the script restarts the Apache service so that the configuration is activated. If the configuration is successful, you should see the sample output shown earlier when you open the URL, <a class="ulink" href="http://abc.remote-server.org/">http://abc.remote-server.org/</a>, in your browser.</p></div></div></div>
</body></html>