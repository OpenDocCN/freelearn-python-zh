<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Security in AWS Lambda</h1>
                
            
            <article>
                
<p class="calibre2">We have learned how to build and configure serverless functions in AWS Lambda. We have learned how to scale them up using third-party tools. We have also had a close look at how microservices work and how to ensure security in them, while ensuring resilience and speed.</p>
<p class="calibre2">In this chapter, we will understand security in the AWS environment, keeping in mind our Lambda functions. We will understand how services, such as AWS VPCs, security groups, and subnets work, with respect to Lambda functions.</p>
<p class="calibre2">This chapter covers the following topics:</p>
<ul class="calibre9">
<li class="calibre10">Understanding <span>AWS VPCs</span></li>
<li class="calibre10">Understanding subnets in VPCs</li>
<li class="calibre10">Securing Lambda inside private subnets</li>
<li class="calibre10">Controlling access to Lambda functions</li>
<li class="calibre10">Using STS inside Lambda for secure session-based execution</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Understanding AWS Virtual Private Clouds (VPCs)</h1>
                
            
            <article>
                
<p class="calibre2">In this section, we will understand AWS VPCs. <strong class="calibre4">VPCs</strong> are a very common component in the security layers of the AWS environment; they are isolated parts of the cloud where users can host their services and build their infrastructures. VPCs are the first layer of security. We will try to understand VPCs in the context of Lambda functions, in the form of bullet points, given here:</p>
<ol class="calibre13">
<li value="1" class="calibre10">VPCs can be created and modified in the AWS's VPC service dashboard, which looks like this:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00232.jpeg" class="calibre48"/></div>
<ol start="2" class="calibre13">
<li value="2" class="calibre10">Now, let's quickly learn how to create a VPC of our own. For that, click on <span>Create VPC</span>. You will see a pop-up box which asks you to enter more meta information for your new VPC:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00233.jpeg" class="calibre166"/></div>
<ol start="3" class="calibre13">
<li value="3" class="calibre10">The <span>Name tag</span> box needs to have the name of the VPC. The <span>IPv4 CIDR block</span> is where you enter your IP range for c<span>lassless inter-domain routing. Then, you can choose whether you want an IPv6 CIDR block or not. You can also select the <span>Tenancy</span> settings; this defines how your EC2 instances run within your VPC, and the resource sharing accordingly:</span></li>
</ol>
<div class="cdpaligncenter"><span><img src="../images/00234.jpeg" class="calibre167"/></span></div>
<ol start="4" class="calibre13">
<li value="4" class="calibre10">We have successfully created our VPC with the necessary settings and with the <kbd class="calibre12"><span>Test-VPC</span></kbd> name. We can see this in our dashboard with all the corresponding meta settings:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00235.jpeg" class="calibre48"/></div>
<ol start="5" class="calibre13">
<li value="5" class="calibre10">You can also see a summary of the VPC which includes the IPv4 settings, the <strong class="calibre1">Network Access Control List</strong> (<strong class="calibre1">ACL</strong>) settings, the <span><strong class="calibre1">Dynamic Host Configuration Protocol</strong> </span>(<strong class="calibre1">DHCP</strong>) options, and also the DNS settings, all of which can also be configured later according to our needs. You can also see IPv4 CIDR blocks under the next <span>CIDR Blocks</span> tab:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00236.jpeg" class="calibre48"/></div>
<ol start="6" class="calibre13">
<li value="6" class="calibre10">We can also create VPC flow logs, which log traffic and data movements in and out of the VPC. This will promote better log management, ensuring security, and better monitoring. Currently, flow logs have not been set up:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00237.jpeg" class="calibre48"/></div>
<ol start="7" class="calibre13">
<li value="7" class="calibre10">To create VPC flow logs, you can just click on the <span>Create Flow Log</span> button at the bottom. This will open up a flow log creation wizard where you can enter the details for the various settings, accordingly. The creation wizard looks like this:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00238.jpeg" class="calibre48"/></div>
<ol start="8" class="calibre13">
<li value="8" class="calibre10">Once all the details have been entered, you can go ahead and click on the <span>Create Flow Log</span> option at the bottom, which will create the VPC flow <span>log </span>with the desired settings:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00239.jpeg" class="calibre48"/></div>
<ol start="9" class="calibre13">
<li value="9" class="calibre10">Once created, you can see the newly created VPC flow log under the <span>Flow Logs</span> tab, as shown here:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00240.jpeg" class="calibre48"/></div>
<ol start="10" class="calibre13">
<li value="10" class="calibre10">Now, let's understand VPCs from AWS Lambda's point of view. Just like any other AWS resource, Lambda functions can also be hosted inside VPCs. You can see that setting under the <span>Network</span> section of your AWS Lambda function. It looks like this:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00241.jpeg" class="calibre168"/></div>
<ol start="11" class="calibre13">
<li value="11" class="calibre10">From the drop-down list, you can select a VPC in which you want to host your Lambda function:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00242.jpeg" class="calibre169"/></div>
<ol start="12" class="calibre13">
<li value="12" class="calibre10">Once you select a VPC, it will further ask you for details regarding subnets, security groups, and so on, as shown in the following screenshot. We will learn about them in the sections following this, so, we will configure the VPC for our Lambda function later:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00243.jpeg" class="calibre170"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Understanding subnets in VPCs</h1>
                
            
            <article>
                
<p class="calibre2">In this section, we will learn about and understand AWS subnets, which are subparts of AWS VPCs. VPCs can be further divided into multiple subnets. These subnets can either be public or private, depending on the security needs of your architecture. We will look at the concept of subnets from the point of view of AWS Lambda functions.</p>
<p class="calibre2">We will perform the following steps:</p>
<ol class="calibre13">
<li value="1" class="calibre10">You can go to the <span>Subnets</span> menu via the VPC page itself. You need to click on the <span>Subne</span><span><span>t</span>s</span> option under the <span>Your VPCs</span> option on the left:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00244.jpeg" class="calibre48"/></div>
<ol start="2" class="calibre13">
<li value="2" class="calibre10">This will take you to the subnets console, where you will see some <span>already existing </span>subnets. These are the default subnets for each availability zone in your region:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00245.jpeg" class="calibre48"/></div>
<ol start="3" class="calibre13">
<li value="3" class="calibre10">Now, to create a new subnet, you need to click on the blue <span>Create Subnet</span> button on the top-left side of the console. In the creation wizard, you will be asked to enter the following details—the name of the subnet, the VPC you want to place it in, availability zones, and also preferred IPv4 CIDR blocks. I have placed this subnet inside the VPC we created in the previous section: </li>
</ol>
<div class="cdpaligncenter"><img src="../images/00246.jpeg" class="calibre48"/></div>
<ol start="4" class="calibre13">
<li value="4" class="calibre10">When you click on the <span>Yes, Create </span>button on the bottom-right side of the creation wizard, the new subnet is created. You can see it listed in the list of your subnets on your console:</li>
</ol>
<p class="cdpaligncenter1"><img src="../images/00247.jpeg" class="calibre99"/></p>
<ol start="5" class="calibre13">
<li value="5" class="calibre10">Now, we will fill in the security settings for our Lambda function with our VPC and subnets, which we have just created. Currently, this is what the <span>Network</span> setting for AWS Lambda looks like:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00248.jpeg" class="calibre171"/></div>
<ol start="6" class="calibre13">
<li value="6" class="calibre10">After adding in the required settings, which are the details of the VPC, subnet and security groups, the <span>Network</span> settings of our Lambda function will look like this:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00249.jpeg" class="calibre172"/><br class="title-page-name"/>
...</div>
<div class="cdpaligncenter"><img src="../images/00250.jpeg" class="calibre173"/></div>
<ol start="7" class="calibre13">
<li value="7" class="calibre10">After setting up your network settings for your Lambda function, click on the orange <span>Save</span> button on the top-right of your Lambda console to save those settings to your Lambda function.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Securing Lambda inside private subnets</h1>
                
            
            <article>
                
<p class="calibre2"><strong class="calibre4">Private subnets</strong> are subnets <span class="calibre11">that</span> are not open to the internet. All of their traffic is routed via the public subnet in the same VPC using the concept of route tables. Let's understand how to position our Lambda functions inside private subnets to add an extra layer of security:</p>
<ol class="calibre13">
<li value="1" class="calibre10">Subnets created in the AWS console are not private by default. Let's evaluate and confirm this by going through the details of the subnet that we just created:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00251.jpeg" class="calibre48"/></div>
<ol start="2" class="calibre13">
<li value="2" class="calibre10">Clicking on the <span>Route Table</span> tab will show us the routing settings of our subnet, which basically tells us what kind of traffic is allowed into it:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00252.jpeg" class="calibre174"/></div>
<ol start="3" class="calibre13">
<li value="3" class="calibre10">In the <span>Network ACL</span> tab, you can see the network rules assigned for our subnet. Here, we can see that the subnet is open to all traffic (<span>0.0.0.0/0</span>). So, in order to make our subnet private, we need to fix this:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00253.jpeg" class="calibre48"/></div>
<ol start="4" class="calibre13">
<li value="4" class="calibre10">Go to the <span>Network ACLs</span> console by clicking on the link to the left side of your console. You will arrive at the following page:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00254.jpeg" class="calibre48"/></div>
<ol start="5" class="calibre13">
<li value="5" class="calibre10">Now, click on the blue <span>Create Network ACL</span> button to create a new ACL. Select our VPC and then enter a name for the ACL in the creation wizard:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00255.jpeg" class="calibre175"/></div>
<ol start="6" class="calibre13">
<li value="6" class="calibre10">Now, in the inbound rules of the new ACL, add in the following rule. In the <span>Source</span> section, add the IPv4 setting of any of your public subnets and click <span>Save</span>:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00256.jpeg" class="calibre48"/></div>
<ol start="7" class="calibre13">
<li value="7" class="calibre10">Now, replace the ACL of our current subnet with the new one that will make our subnet a private subnet:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00257.jpeg" class="calibre48"/></div>
<p class="calibre2">Now, we have our Lambda function in a private subnet, making it more secure.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Controlling access to Lambda functions</h1>
                
            
            <article>
                
<p class="calibre2">We have gone through all the security settings needed to ensure that our Lambda functions and our serverless architectures are secure. So, an engineer working on serverless systems should keep the following points in mind while designing their infrastructure from a security point of view:</p>
<ul class="calibre9">
<li class="calibre10">The VPC and the subnet settings can be added under the <span>Network</span> section of the Lambda function. </li>
<li class="calibre10">It is recommended that the Lambda function is placed across at least two subnets for fault tolerance purposes. However, this is not compulsory.</li>
<li class="calibre10">If you are placing your Lambda function inside a private subnet, you need to ensure that the private subnet is receiving the appropriate traffic from your public subnet(s) in that VPC. If not, then the Lambda function is essentially locked out.</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Using STS inside Lambda for secure session-based execution</h1>
                
            
            <article>
                
<p class="calibre2">While accessing other AWS services and components from inside your Lambda functions, you can make use of <strong class="calibre4">AWS's Simple Token Service</strong> (<strong class="calibre4">STS</strong>) to ensure session-based access, which will essentially add an extra layer of security. As we have already discussed, and learned how to use, STS credentials in our code, we will skip over to the documentation links. </p>
<p class="calibre2">The official documentation of AWS STS will help you understand how session-based access works: <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp.html" class="calibre8">https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp.html</a>.</p>
<p class="calibre2">And this is the <em class="calibre16">Boto3 Python Documentation</em> for using STS credentials inside Python code: <a href="http://boto3.readthedocs.io/en/latest/reference/services/sts.html" class="calibre8">http://boto3.readthedocs.io/en/latest/reference/services/sts.html</a>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we have learned how security works in Lambda functions in a deep-dive mode. We have understood how VPCs and subnets work in the AWS environment. We have learned to create a VPC and also created public and private subnets. This will give you a better understanding of how security works from the whole of the AWS perspective.</p>
<p class="calibre2">We have also learned how to place your Lambda functions inside the VPCs and the subnets we have created throughout this chapter. We understood how to handle and route traffic inside our VPCs and subnets.</p>
<p class="calibre2">Finally, we also learned how to implement better security in our Python code using session-based access to other AWS components, thereby placing security in the control of the developer. </p>
<p class="calibre2">In the next chapter, you will learn about the <strong class="calibre4">Serverless Application Model</strong> (<strong class="calibre4">SAM</strong>) and how to write SAM models and deploy your Lambda applications through them.</p>


            </article>

            
        </section>
    </body></html>