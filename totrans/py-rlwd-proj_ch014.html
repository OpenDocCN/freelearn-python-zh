<html xml:lang="en-US" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<meta charset="utf-8"/>
<meta content="pandoc" name="generator"/>
<title>ch014.xhtml</title>
<link href="../styles/stylesheet1.css" rel="stylesheet" type="text/css"/>
<!-- kobo-style -->
<style id="koboSpanStyle" type="text/css" xmlns="http://www.w3.org/1999/xhtml">.koboSpan { -webkit-text-combine: inherit; }</style>
</head>
<body epub:type="bodymatter">
<section class="level1" data-number="14" id="chapter-10-data-cleaning-features">
<h1 data-number="14"><span class="titlemark"><span class="koboSpan" id="kobo.1.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 10</span></span><br/>
<span id="x1-22900010"/><span class="koboSpan" id="kobo.2.1" xmlns="http://www.w3.org/1999/xhtml">Data Cleaning Features</span></h1>
<p><span class="koboSpan" id="kobo.3.1" xmlns="http://www.w3.org/1999/xhtml">There are a number of techniques for validating and converting data to native Python objects for subsequent analysis. </span><span class="koboSpan" id="kobo.3.2" xmlns="http://www.w3.org/1999/xhtml">This chapter guides you through three of these techniques, each appropriate for different kinds of data. </span><span class="koboSpan" id="kobo.3.3" xmlns="http://www.w3.org/1999/xhtml">The chapter moves on to the idea of standardization to transform unusual or atypical values into a more useful form. </span><span class="koboSpan" id="kobo.3.4" xmlns="http://www.w3.org/1999/xhtml">The chapter concludes with the integration of acquisition and cleansing into a composite pipeline.</span></p>
<p><span class="koboSpan" id="kobo.4.1" xmlns="http://www.w3.org/1999/xhtml">This chapter will expand on the project in </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.5.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.6.1" xmlns="http://www.w3.org/1999/xhtml"> 9</span></em></a><span class="koboSpan" id="kobo.7.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.8.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.1: Data Cleaning</span></em> <em><span class="koboSpan" id="kobo.9.1" xmlns="http://www.w3.org/1999/xhtml">Base Application</span></em></a><span class="koboSpan" id="kobo.10.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.10.2" xmlns="http://www.w3.org/1999/xhtml">The following additional skills will be emphasized:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.11.1" xmlns="http://www.w3.org/1999/xhtml">CLI application extension and refactoring to add features.</span></p></li>
<li><p><span class="koboSpan" id="kobo.12.1" xmlns="http://www.w3.org/1999/xhtml">Pythonic approaches to validation and conversion.</span></p></li>
<li><p><span class="koboSpan" id="kobo.13.1" xmlns="http://www.w3.org/1999/xhtml">Techniques for uncovering key relationships.</span></p></li>
<li><p><span class="koboSpan" id="kobo.14.1" xmlns="http://www.w3.org/1999/xhtml">Pipeline architectures. </span><span class="koboSpan" id="kobo.14.2" xmlns="http://www.w3.org/1999/xhtml">This can be seen as a first step </span><span id="dx1-229001"/><span class="koboSpan" id="kobo.15.1" xmlns="http://www.w3.org/1999/xhtml">toward a processing </span><strong><span class="koboSpan" id="kobo.16.1" xmlns="http://www.w3.org/1999/xhtml">DAG </span></strong><span class="koboSpan" id="kobo.17.1" xmlns="http://www.w3.org/1999/xhtml">(</span><strong><span class="koboSpan" id="kobo.18.1" xmlns="http://www.w3.org/1999/xhtml">Directed Acyclic Graph</span></strong><span class="koboSpan" id="kobo.19.1" xmlns="http://www.w3.org/1999/xhtml">) in which various stages are connected.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.20.1" xmlns="http://www.w3.org/1999/xhtml">We’ll start with a description of the first project to expand on the previous chapters on processing. </span><span class="koboSpan" id="kobo.20.2" xmlns="http://www.w3.org/1999/xhtml">This will include some new </span><strong><span class="koboSpan" id="kobo.21.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.22.1" xmlns="http://www.w3.org/1999/xhtml">features to work with more complex data source fields. </span><span id="x1-229002r246"/></p>
<section class="level2" data-number="14.1" id="project-3.2-validate-and-convert-source-fields">
<h2 data-number="14.1"><span class="titlemark"><span class="koboSpan" id="kobo.23.1" xmlns="http://www.w3.org/1999/xhtml">10.1 </span></span> <span id="x1-2300001"/><span class="koboSpan" id="kobo.24.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.2: Validate and convert source fields</span></h2>
<p><span class="koboSpan" id="kobo.25.1" xmlns="http://www.w3.org/1999/xhtml">In </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.26.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.27.1" xmlns="http://www.w3.org/1999/xhtml"> 9</span></em></a><span class="koboSpan" id="kobo.28.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.29.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.1: Data Cleaning Base Application</span></em></a><span class="koboSpan" id="kobo.30.1" xmlns="http://www.w3.org/1999/xhtml"> we relied on the foundational behavior of the </span><strong><span class="koboSpan" id="kobo.31.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.32.1" xmlns="http://www.w3.org/1999/xhtml">package to convert numeric fields from the </span><span id="dx1-230001"/><span class="koboSpan" id="kobo.33.1" xmlns="http://www.w3.org/1999/xhtml">source text to Python types like </span><code><span class="koboSpan" id="kobo.34.1" xmlns="http://www.w3.org/1999/xhtml">int</span></code><span class="koboSpan" id="kobo.35.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.36.1" xmlns="http://www.w3.org/1999/xhtml">float</span></code><span class="koboSpan" id="kobo.37.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><code><span class="koboSpan" id="kobo.38.1" xmlns="http://www.w3.org/1999/xhtml">Decimal</span></code><span class="koboSpan" id="kobo.39.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.39.2" xmlns="http://www.w3.org/1999/xhtml">In this chapter, we’ll use a dataset that includes </span><span id="dx1-230002"/><span class="koboSpan" id="kobo.40.1" xmlns="http://www.w3.org/1999/xhtml">date strings so we can explore some more complex conversion rules.</span></p>
<p><span class="koboSpan" id="kobo.41.1" xmlns="http://www.w3.org/1999/xhtml">This will follow the design pattern from the earlier project. </span><span class="koboSpan" id="kobo.41.2" xmlns="http://www.w3.org/1999/xhtml">It will use a distinct data set, however, and some unique data model definitions. </span><span id="x1-230003r247"/></p>
<section class="level3" data-number="14.1.1" id="description-12">
<h3 data-number="14.1.1"><span class="titlemark"><span class="koboSpan" id="kobo.42.1" xmlns="http://www.w3.org/1999/xhtml">10.1.1 </span></span> <span id="x1-2310001"/><span class="koboSpan" id="kobo.43.1" xmlns="http://www.w3.org/1999/xhtml">Description</span></h3>
<p><span class="koboSpan" id="kobo.44.1" xmlns="http://www.w3.org/1999/xhtml">This project’s intent is to </span><span id="dx1-231001"/><span class="koboSpan" id="kobo.45.1" xmlns="http://www.w3.org/1999/xhtml">perform data validation, cleaning, and standardization. </span><span class="koboSpan" id="kobo.45.2" xmlns="http://www.w3.org/1999/xhtml">This project will expand on the features of the </span><code><span class="koboSpan" id="kobo.46.1" xmlns="http://www.w3.org/1999/xhtml">pydantic</span></code><span class="koboSpan" id="kobo.47.1" xmlns="http://www.w3.org/1999/xhtml"> package to do somewhat more sophisticated data validations and conversions.</span></p>
<p><span class="koboSpan" id="kobo.48.1" xmlns="http://www.w3.org/1999/xhtml">This new data cleaning application can be designed around a data set like </span><a class="url" href="https://tidesandcurrents.noaa.gov/tide_predictions.html"><span class="koboSpan" id="kobo.49.1" xmlns="http://www.w3.org/1999/xhtml">https://tidesandcurrents.noaa.gov/tide_predictions.html</span></a><span class="koboSpan" id="kobo.50.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.50.2" xmlns="http://www.w3.org/1999/xhtml">The tide predictions around the US include dates, but the fields are decomposed, and our data cleaning application needs to combine them.</span></p>
<p><span class="koboSpan" id="kobo.51.1" xmlns="http://www.w3.org/1999/xhtml">For a specific example, see </span><a class="url" href="https://tidesandcurrents.noaa.gov/noaatideannual.html?id=8725769"><span class="koboSpan" id="kobo.52.1" xmlns="http://www.w3.org/1999/xhtml">https://tidesandcurrents.noaa.gov/noaatideannual.html?id=8725769</span></a><span class="koboSpan" id="kobo.53.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.53.2" xmlns="http://www.w3.org/1999/xhtml">Note that the downloaded </span><code><span class="koboSpan" id="kobo.54.1" xmlns="http://www.w3.org/1999/xhtml">.txt</span></code><span class="koboSpan" id="kobo.55.1" xmlns="http://www.w3.org/1999/xhtml"> file is a tab-delimited CSV file with a very complicated multi-line header. </span><span class="koboSpan" id="kobo.55.2" xmlns="http://www.w3.org/1999/xhtml">This will require some sophisticated acquisition processing similar to the examples shown in </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.56.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.57.1" xmlns="http://www.w3.org/1999/xhtml"> 3</span></em></a><span class="koboSpan" id="kobo.58.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.59.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.1: Data</span></em> <em><span class="koboSpan" id="kobo.60.1" xmlns="http://www.w3.org/1999/xhtml">Acquisition Base Application</span></em></a><span class="koboSpan" id="kobo.61.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.62.1" xmlns="http://www.w3.org/1999/xhtml">An alternative example is the CO2 PPM — Trends in Atmospheric Carbon Dioxide data set, available at </span><a class="url" href="https://datahub.io/core/co2-ppm"><span class="koboSpan" id="kobo.63.1" xmlns="http://www.w3.org/1999/xhtml">https://datahub.io/core/co2-ppm</span></a><span class="koboSpan" id="kobo.64.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.64.2" xmlns="http://www.w3.org/1999/xhtml">This has dates that are provided in two forms: as a </span><code><span class="koboSpan" id="kobo.65.1" xmlns="http://www.w3.org/1999/xhtml">year-month-day</span></code><span class="koboSpan" id="kobo.66.1" xmlns="http://www.w3.org/1999/xhtml"> string and as a decimal number. </span><span class="koboSpan" id="kobo.66.2" xmlns="http://www.w3.org/1999/xhtml">We can better understand this data if we can reproduce the decimal number value.</span></p>
<p><span class="koboSpan" id="kobo.67.1" xmlns="http://www.w3.org/1999/xhtml">The second example data set is </span><a class="url" href="https://datahub.io/core/co2-ppm/r/0.html"><span class="koboSpan" id="kobo.68.1" xmlns="http://www.w3.org/1999/xhtml">https://datahub.io/core/co2-ppm/r/0.html</span></a><span class="koboSpan" id="kobo.69.1" xmlns="http://www.w3.org/1999/xhtml"> This is an HTML file, requiring some acquisition processing similar to the examples from </span><a href="ch008.xhtml#x1-780004"><em><span class="koboSpan" id="kobo.70.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.71.1" xmlns="http://www.w3.org/1999/xhtml"> 4</span></em></a><span class="koboSpan" id="kobo.72.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch008.xhtml#x1-780004"><em><span class="koboSpan" id="kobo.73.1" xmlns="http://www.w3.org/1999/xhtml">Data Acquisition Features: Web APIs and</span></em> <em><span class="koboSpan" id="kobo.74.1" xmlns="http://www.w3.org/1999/xhtml">Scraping</span></em></a><span class="koboSpan" id="kobo.75.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.76.1" xmlns="http://www.w3.org/1999/xhtml">The use case for this cleaning application is identical to the description shown in </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.77.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.78.1" xmlns="http://www.w3.org/1999/xhtml"> 9</span></em></a><span class="koboSpan" id="kobo.79.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.80.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.1: Data Cleaning Base Application</span></em></a><span class="koboSpan" id="kobo.81.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.81.2" xmlns="http://www.w3.org/1999/xhtml">The acquired data — pure text, extracted </span><span id="dx1-231002"/><span class="koboSpan" id="kobo.82.1" xmlns="http://www.w3.org/1999/xhtml">from the source files — will be cleaned to create </span><strong><span class="koboSpan" id="kobo.83.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.84.1" xmlns="http://www.w3.org/1999/xhtml">models with fields of useful Python internal types.</span></p>
<p><span class="koboSpan" id="kobo.85.1" xmlns="http://www.w3.org/1999/xhtml">We’ll take a quick look at the tide table data on the </span><a class="url" href="https://tidesandcurrents.noaa.gov"><span class="koboSpan" id="kobo.86.1" xmlns="http://www.w3.org/1999/xhtml">https://tidesandcurrents.noaa.gov</span></a><span class="koboSpan" id="kobo.87.1" xmlns="http://www.w3.org/1999/xhtml"> website.</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.88.1" xmlns="http://www.w3.org/1999/xhtml">NOAA/NOS/CO-OPS
Disclaimer: These data are based upon the latest information available ...
</span><span class="koboSpan" id="kobo.88.2" xmlns="http://www.w3.org/1999/xhtml">Annual Tide Predictions
StationName: EL JOBEAN, MYAKKA RIVER
State: FL
Stationid: 8725769
ReferencedToStationName: St. Petersburg, Tampa Bay
ReferencedToStationId: 8726520
HeightOffsetLow: * 0.83
HeightOffsetHigh: * 0.83
TimeOffsetLow: 116
TimeOffsetHigh: 98
Prediction Type: Subordinate
From: 20230101 06:35 - 20231231 19:47
Units: Feet and Centimeters
Time Zone: LST_LDT
Datum: MLLW
Interval Type: High/Low

Date  Day Time Pred(Ft) Pred(cm) High/Low
2023/01/01 Sun 06:35 AM -0.13 -4 L
2023/01/01 Sun 01:17 PM 0.87 27 H
etc.</span></pre>
<p><span class="koboSpan" id="kobo.89.1" xmlns="http://www.w3.org/1999/xhtml">The data to be acquired has two interesting structural problems:</span></p>
<ol>
<li><div id="x1-231004x1">
<p><span class="koboSpan" id="kobo.90.1" xmlns="http://www.w3.org/1999/xhtml">There’s a 19-line preamble containing some useful metadata. </span><span class="koboSpan" id="kobo.90.2" xmlns="http://www.w3.org/1999/xhtml">Lines 2 to 18 have a format of a label and a value, for example, </span><code><span class="koboSpan" id="kobo.91.1" xmlns="http://www.w3.org/1999/xhtml">State:</span></code><code><span class="koboSpan" id="kobo.92.1" xmlns="http://www.w3.org/1999/xhtml"> FL</span></code><span class="koboSpan" id="kobo.93.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
</div></li>
<li><div id="x1-231006x2">
<p><span class="koboSpan" id="kobo.94.1" xmlns="http://www.w3.org/1999/xhtml">The data is tab-delimited CSV data. </span><span class="koboSpan" id="kobo.94.2" xmlns="http://www.w3.org/1999/xhtml">There appear to be six column titles. </span><span class="koboSpan" id="kobo.94.3" xmlns="http://www.w3.org/1999/xhtml">However, looking at the tab characters, there are eight columns of header data followed by nine columns of data.</span></p>
</div></li>
</ol>
<p><span class="koboSpan" id="kobo.95.1" xmlns="http://www.w3.org/1999/xhtml">The acquired data should fit </span><span id="dx1-231007"/><span class="koboSpan" id="kobo.96.1" xmlns="http://www.w3.org/1999/xhtml">the dataclass definition shown in the following fragment of a class definition:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-161">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.97.1" xmlns="http://www.w3.org/1999/xhtml">from dataclasses import dataclass

@dataclass
class TidePrediction:
    date: str
    day: str
    time: str
    pred_ft: str
    pred_cm: str
    high_low: str

    @classmethod
    def from_row(
        cls: type["TidePrediction"],
        row: list[str]
    ) -&gt; "TidePrediction":
        ...</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.98.1" xmlns="http://www.w3.org/1999/xhtml">The example omits the details of the </span><code><span class="koboSpan" id="kobo.99.1" xmlns="http://www.w3.org/1999/xhtml">from_row()</span></code><span class="koboSpan" id="kobo.100.1" xmlns="http://www.w3.org/1999/xhtml"> method. </span><span class="koboSpan" id="kobo.100.2" xmlns="http://www.w3.org/1999/xhtml">If a CSV reader is used, this method needs to pick out columns from the CSV-format file, skipping over the generally empty columns. </span><span class="koboSpan" id="kobo.100.3" xmlns="http://www.w3.org/1999/xhtml">If regular expressions are used to parse the source lines, this method will use the groups from the match object.</span></p>
<p><span class="koboSpan" id="kobo.101.1" xmlns="http://www.w3.org/1999/xhtml">Since this looks like many previous projects, we’ll look at the distinct technical approach next. </span><span id="x1-231025r250"/></p>
</section>
<section class="level3" data-number="14.1.2" id="approach-11">
<h3 data-number="14.1.2"><span class="titlemark"><span class="koboSpan" id="kobo.102.1" xmlns="http://www.w3.org/1999/xhtml">10.1.2 </span></span> <span id="x1-2320002"/><span class="koboSpan" id="kobo.103.1" xmlns="http://www.w3.org/1999/xhtml">Approach</span></h3>
<p><span class="koboSpan" id="kobo.104.1" xmlns="http://www.w3.org/1999/xhtml">The core processing of the data </span><span id="dx1-232001"/><span class="koboSpan" id="kobo.105.1" xmlns="http://www.w3.org/1999/xhtml">cleaning application should be — except for a few module changes — very similar to the earlier examples. </span><span class="koboSpan" id="kobo.105.2" xmlns="http://www.w3.org/1999/xhtml">For reference, see </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.106.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.107.1" xmlns="http://www.w3.org/1999/xhtml"> 9</span></em></a><span class="koboSpan" id="kobo.108.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.109.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.1: Data Cleaning Base Application</span></em></a><span class="koboSpan" id="kobo.110.1" xmlns="http://www.w3.org/1999/xhtml">, specifically </span><a href="ch013.xhtml#x1-2150002"><em><span class="koboSpan" id="kobo.111.1" xmlns="http://www.w3.org/1999/xhtml">Approach</span></em></a><span class="koboSpan" id="kobo.112.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.112.2" xmlns="http://www.w3.org/1999/xhtml">This suggests that the </span><code><span class="koboSpan" id="kobo.113.1" xmlns="http://www.w3.org/1999/xhtml">clean</span></code><span class="koboSpan" id="kobo.114.1" xmlns="http://www.w3.org/1999/xhtml"> module should have minimal changes from the earlier version.</span></p>
<p><span class="koboSpan" id="kobo.115.1" xmlns="http://www.w3.org/1999/xhtml">The principle differences should be two different implementations of the </span><code><span class="koboSpan" id="kobo.116.1" xmlns="http://www.w3.org/1999/xhtml">acquire_model</span></code><span class="koboSpan" id="kobo.117.1" xmlns="http://www.w3.org/1999/xhtml"> and the </span><code><span class="koboSpan" id="kobo.118.1" xmlns="http://www.w3.org/1999/xhtml">analysis_model</span></code><span class="koboSpan" id="kobo.119.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.119.2" xmlns="http://www.w3.org/1999/xhtml">For the tide data example, a class is shown in the </span><a href="#x1-2310001"><em><span class="koboSpan" id="kobo.120.1" xmlns="http://www.w3.org/1999/xhtml">Description</span></em></a><span class="koboSpan" id="kobo.121.1" xmlns="http://www.w3.org/1999/xhtml"> section that can be used for the acquire model.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-162">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.122.1" xmlns="http://www.w3.org/1999/xhtml">It’s important to maintain a clear distinction between the acquired data, which is often text, and the data that will be used for later analysis, which can be a mixture of more useful Python object types.</span></p>
<p><span class="koboSpan" id="kobo.123.1" xmlns="http://www.w3.org/1999/xhtml">The two-step conversion from source data to the interim acquired data format, and from the acquired data format to the clean data format can — sometimes — be optimized to a single conversion.</span></p>
<p><span class="koboSpan" id="kobo.124.1" xmlns="http://www.w3.org/1999/xhtml">An optimization to combine processing into a single step can also make debugging more difficult.</span></p>
</div>
</div>
<p><span class="koboSpan" id="kobo.125.1" xmlns="http://www.w3.org/1999/xhtml">We’ll show one approach to defining the enumerated set of values for the state of the tide. </span><span class="koboSpan" id="kobo.125.2" xmlns="http://www.w3.org/1999/xhtml">In the source data, codes of </span><code><span class="koboSpan" id="kobo.126.1" xmlns="http://www.w3.org/1999/xhtml">’H’</span></code><span class="koboSpan" id="kobo.127.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.128.1" xmlns="http://www.w3.org/1999/xhtml">’L’</span></code><span class="koboSpan" id="kobo.129.1" xmlns="http://www.w3.org/1999/xhtml"> are used. </span><span class="koboSpan" id="kobo.129.2" xmlns="http://www.w3.org/1999/xhtml">The following class will define this enumeration of values:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-163">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.130.1" xmlns="http://www.w3.org/1999/xhtml">from enum import StrEnum

class HighLow(StrEnum):
    high = ’H’
    low = ’L’</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.131.1" xmlns="http://www.w3.org/1999/xhtml">We’ll rely on the enumerated type and two other annotated types to define a complete record. </span><span class="koboSpan" id="kobo.131.2" xmlns="http://www.w3.org/1999/xhtml">We’ll return to the annotated </span><span id="dx1-232007"/><span class="koboSpan" id="kobo.132.1" xmlns="http://www.w3.org/1999/xhtml">types after showing the record as a whole first. </span><span class="koboSpan" id="kobo.132.2" xmlns="http://www.w3.org/1999/xhtml">A complete tide prediction record looks as follows:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-164">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.133.1" xmlns="http://www.w3.org/1999/xhtml">import datetime
from typing import Annotated, TypeAlias

from pydantic import BaseModel
from pydantic.functional_validators import AfterValidator, BeforeValidator

# See below for the type aliases.

</span><span class="koboSpan" id="kobo.133.2" xmlns="http://www.w3.org/1999/xhtml">class TidePrediction(BaseModel):
    date: TideCleanDateTime
    pred_ft: float
    pred_cm: float
    high_low: TideCleanHighLow

    @classmethod
    def from_acquire_dataclass(
            cls,
            acquired: acquire_model.TidePrediction
    ) -&gt; "TidePrediction":
        source_timestamp = f"{acquired.date} {acquired.time}"
        return TidePrediction(
            date=source_timestamp,
            pred_ft=acquired.pred_ft,
            pred_cm=acquired.pred_cm,
            high_low=acquired.high_low
        )</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.134.1" xmlns="http://www.w3.org/1999/xhtml">This shows how the source columns’ </span><code><span class="koboSpan" id="kobo.135.1" xmlns="http://www.w3.org/1999/xhtml">date</span></code><span class="koboSpan" id="kobo.136.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.137.1" xmlns="http://www.w3.org/1999/xhtml">time</span></code><span class="koboSpan" id="kobo.138.1" xmlns="http://www.w3.org/1999/xhtml"> are combined into a single text value prior to validation. </span><span class="koboSpan" id="kobo.138.2" xmlns="http://www.w3.org/1999/xhtml">This is done by the </span><code><span class="koboSpan" id="kobo.139.1" xmlns="http://www.w3.org/1999/xhtml">from_acquire_dataclass()</span></code><span class="koboSpan" id="kobo.140.1" xmlns="http://www.w3.org/1999/xhtml"> method, so it happens before invoking the </span><code><span class="koboSpan" id="kobo.141.1" xmlns="http://www.w3.org/1999/xhtml">TidePrediction</span></code><span class="koboSpan" id="kobo.142.1" xmlns="http://www.w3.org/1999/xhtml"> constructor.</span></p>
<p><span class="koboSpan" id="kobo.143.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.144.1" xmlns="http://www.w3.org/1999/xhtml">TideCleanDateTime</span></code><span class="koboSpan" id="kobo.145.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.146.1" xmlns="http://www.w3.org/1999/xhtml">TideCleanHighLow</span></code><span class="koboSpan" id="kobo.147.1" xmlns="http://www.w3.org/1999/xhtml"> type hints will leverage annotated types to define validation rules for each of these attributes. </span><span class="koboSpan" id="kobo.147.2" xmlns="http://www.w3.org/1999/xhtml">Here are the two definitions:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-165">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.148.1" xmlns="http://www.w3.org/1999/xhtml">TideCleanDateTime: TypeAlias = Annotated[
    datetime.datetime, BeforeValidator(clean_date)]
TideCleanHighLow: TypeAlias = Annotated[
    HighLow, BeforeValidator(lambda text: text.upper())]</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.149.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.150.1" xmlns="http://www.w3.org/1999/xhtml">TideCleanDateTime</span></code><span class="koboSpan" id="kobo.151.1" xmlns="http://www.w3.org/1999/xhtml"> type uses the </span><code><span class="koboSpan" id="kobo.152.1" xmlns="http://www.w3.org/1999/xhtml">clean_date()</span></code><span class="koboSpan" id="kobo.153.1" xmlns="http://www.w3.org/1999/xhtml"> function to clean up the </span><code><span class="koboSpan" id="kobo.154.1" xmlns="http://www.w3.org/1999/xhtml">date</span></code><span class="koboSpan" id="kobo.155.1" xmlns="http://www.w3.org/1999/xhtml"> string prior to any attempt at conversion. </span><span class="koboSpan" id="kobo.155.2" xmlns="http://www.w3.org/1999/xhtml">Similarly, the </span><code><span class="koboSpan" id="kobo.156.1" xmlns="http://www.w3.org/1999/xhtml">TideCleanHighLow</span></code><span class="koboSpan" id="kobo.157.1" xmlns="http://www.w3.org/1999/xhtml"> type uses a lambda to transform the value to upper </span><span id="dx1-232038"/><span class="koboSpan" id="kobo.158.1" xmlns="http://www.w3.org/1999/xhtml">case before validation against the </span><code><span class="koboSpan" id="kobo.159.1" xmlns="http://www.w3.org/1999/xhtml">HighLow</span></code><span class="koboSpan" id="kobo.160.1" xmlns="http://www.w3.org/1999/xhtml"> enumerated type.</span></p>
<p><span class="koboSpan" id="kobo.161.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.162.1" xmlns="http://www.w3.org/1999/xhtml">clean_date()</span></code><span class="koboSpan" id="kobo.163.1" xmlns="http://www.w3.org/1999/xhtml"> function works by applying the one (and only) expected date format to the string value. </span><span class="koboSpan" id="kobo.163.2" xmlns="http://www.w3.org/1999/xhtml">This is not designed to be flexible or permissive. </span><span class="koboSpan" id="kobo.163.3" xmlns="http://www.w3.org/1999/xhtml">It’s designed to confirm the data is an exact match against expectations.</span></p>
<p><span class="koboSpan" id="kobo.164.1" xmlns="http://www.w3.org/1999/xhtml">The function looks like this:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-166">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.165.1" xmlns="http://www.w3.org/1999/xhtml">def clean_date(v: str | datetime.datetime) -&gt; datetime.datetime:
    match v:
        case str():
            return datetime.datetime.strptime(v, "%Y/%m/%d %I:%M %p")
        case _:
            return v</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.166.1" xmlns="http://www.w3.org/1999/xhtml">If the data doesn’t match the expected format, the </span><code><span class="koboSpan" id="kobo.167.1" xmlns="http://www.w3.org/1999/xhtml">strptime()</span></code><span class="koboSpan" id="kobo.168.1" xmlns="http://www.w3.org/1999/xhtml"> function will raise a </span><code><span class="koboSpan" id="kobo.169.1" xmlns="http://www.w3.org/1999/xhtml">ValueError</span></code><span class="koboSpan" id="kobo.170.1" xmlns="http://www.w3.org/1999/xhtml"> exception. </span><span class="koboSpan" id="kobo.170.2" xmlns="http://www.w3.org/1999/xhtml">This will be incorporated into a </span><code><span class="koboSpan" id="kobo.171.1" xmlns="http://www.w3.org/1999/xhtml">pydantic.ValidationError</span></code><span class="koboSpan" id="kobo.172.1" xmlns="http://www.w3.org/1999/xhtml"> exception that enumerates all of the errors encountered. </span><span class="koboSpan" id="kobo.172.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.173.1" xmlns="http://www.w3.org/1999/xhtml">match</span></code><span class="koboSpan" id="kobo.174.1" xmlns="http://www.w3.org/1999/xhtml"> statement will pass non-string values through to the </span><strong><span class="koboSpan" id="kobo.175.1" xmlns="http://www.w3.org/1999/xhtml">pydantic </span></strong><span class="koboSpan" id="kobo.176.1" xmlns="http://www.w3.org/1999/xhtml">handler for validation; we don’t need to handle any other types.</span></p>
<p><span class="koboSpan" id="kobo.177.1" xmlns="http://www.w3.org/1999/xhtml">This model can also be used for analysis of clean data. </span><span class="koboSpan" id="kobo.177.2" xmlns="http://www.w3.org/1999/xhtml">(See </span><a href="ch017.xhtml#x1-29700013"><em><span class="koboSpan" id="kobo.178.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.179.1" xmlns="http://www.w3.org/1999/xhtml"> 13</span></em></a><span class="koboSpan" id="kobo.180.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch017.xhtml#x1-29700013"><em><span class="koboSpan" id="kobo.181.1" xmlns="http://www.w3.org/1999/xhtml">Project 4.1: Visual Analysis Techniques</span></em></a><span class="koboSpan" id="kobo.182.1" xmlns="http://www.w3.org/1999/xhtml">.) In this case, the data will already be a valid </span><code><span class="koboSpan" id="kobo.183.1" xmlns="http://www.w3.org/1999/xhtml">datetime.datetime</span></code><span class="koboSpan" id="kobo.184.1" xmlns="http://www.w3.org/1999/xhtml"> object, and no conversion will need to be performed. </span><span class="koboSpan" id="kobo.184.2" xmlns="http://www.w3.org/1999/xhtml">The use of a type hint of </span><code><span class="koboSpan" id="kobo.185.1" xmlns="http://www.w3.org/1999/xhtml">str</span></code><code><span class="koboSpan" id="kobo.186.1" xmlns="http://www.w3.org/1999/xhtml"> |</span></code><code><span class="koboSpan" id="kobo.187.1" xmlns="http://www.w3.org/1999/xhtml"> datetime.datetime</span></code><span class="koboSpan" id="kobo.188.1" xmlns="http://www.w3.org/1999/xhtml"> emphasizes the two types of values this method will be applied to.</span></p>
<p><span class="koboSpan" id="kobo.189.1" xmlns="http://www.w3.org/1999/xhtml">This two-part ”combine and convert” operation is broken into two steps to fit into the </span><strong><span class="koboSpan" id="kobo.190.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.191.1" xmlns="http://www.w3.org/1999/xhtml">design pattern. </span><span class="koboSpan" id="kobo.191.2" xmlns="http://www.w3.org/1999/xhtml">The separation follows the principle of minimizing complex initialization processing and creating </span><span id="dx1-232045"/><span class="koboSpan" id="kobo.192.1" xmlns="http://www.w3.org/1999/xhtml">class definitions that are more declarative and less active.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-167">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.193.1" xmlns="http://www.w3.org/1999/xhtml">It’s often helpful to keep the conversion steps small and separate.</span></p>
<p><span class="koboSpan" id="kobo.194.1" xmlns="http://www.w3.org/1999/xhtml">Premature optimization to create a single, composite function is often a nightmare when changes are required.</span></p>
</div>
</div>
<p><span class="koboSpan" id="kobo.195.1" xmlns="http://www.w3.org/1999/xhtml">For display purposes, the date, day-of-week, and time-of-day can be extracted from a single </span><code><span class="koboSpan" id="kobo.196.1" xmlns="http://www.w3.org/1999/xhtml">datetime</span></code><span class="koboSpan" id="kobo.197.1" xmlns="http://www.w3.org/1999/xhtml"> instance. </span><span class="koboSpan" id="kobo.197.2" xmlns="http://www.w3.org/1999/xhtml">There’s no need to keep many date-related fields around as part of the </span><code><span class="koboSpan" id="kobo.198.1" xmlns="http://www.w3.org/1999/xhtml">TidePrediction</span></code><span class="koboSpan" id="kobo.199.1" xmlns="http://www.w3.org/1999/xhtml"> object.</span></p>
<p><span class="koboSpan" id="kobo.200.1" xmlns="http://www.w3.org/1999/xhtml">The tide prediction is provided in two separate units of measure. </span><span class="koboSpan" id="kobo.200.2" xmlns="http://www.w3.org/1999/xhtml">For the purposes of this example, we retained the two separate values. </span><span class="koboSpan" id="kobo.200.3" xmlns="http://www.w3.org/1999/xhtml">Pragmatically, the height in feet is the height in cm multiplied by </span><span class="koboSpan" id="kobo.201.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="-1-- 30.48" class="frac" data-align="middle" src="../media/file42.jpg"/></span><span class="koboSpan" id="kobo.202.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.203.1" xmlns="http://www.w3.org/1999/xhtml">For some applications, where the value for height in feet is rarely used, a property might make more sense than a computed value. </span><span class="koboSpan" id="kobo.203.2" xmlns="http://www.w3.org/1999/xhtml">For other applications, where the two heights are both used widely, having both values computed may improve performance. </span><span id="x1-232046r251"/></p>
</section>
<section class="level3" data-number="14.1.3" id="deliverables-12">
<h3 data-number="14.1.3"><span class="titlemark"><span class="koboSpan" id="kobo.204.1" xmlns="http://www.w3.org/1999/xhtml">10.1.3 </span></span> <span id="x1-2330003"/><span class="koboSpan" id="kobo.205.1" xmlns="http://www.w3.org/1999/xhtml">Deliverables</span></h3>
<p><span class="koboSpan" id="kobo.206.1" xmlns="http://www.w3.org/1999/xhtml">This project has </span><span id="dx1-233001"/><span class="koboSpan" id="kobo.207.1" xmlns="http://www.w3.org/1999/xhtml">the following deliverables:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.208.1" xmlns="http://www.w3.org/1999/xhtml">Documentation in the </span><code><span class="koboSpan" id="kobo.209.1" xmlns="http://www.w3.org/1999/xhtml">docs</span></code><span class="koboSpan" id="kobo.210.1" xmlns="http://www.w3.org/1999/xhtml"> folder.</span></p></li>
<li><p><span class="koboSpan" id="kobo.211.1" xmlns="http://www.w3.org/1999/xhtml">Acceptance tests in the </span><code><span class="koboSpan" id="kobo.212.1" xmlns="http://www.w3.org/1999/xhtml">tests/features</span></code><span class="koboSpan" id="kobo.213.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.214.1" xmlns="http://www.w3.org/1999/xhtml">tests/steps</span></code><span class="koboSpan" id="kobo.215.1" xmlns="http://www.w3.org/1999/xhtml"> folders.</span></p></li>
<li><p><span class="koboSpan" id="kobo.216.1" xmlns="http://www.w3.org/1999/xhtml">Unit tests for the application modules in the </span><code><span class="koboSpan" id="kobo.217.1" xmlns="http://www.w3.org/1999/xhtml">tests</span></code><span class="koboSpan" id="kobo.218.1" xmlns="http://www.w3.org/1999/xhtml"> folder.</span></p></li>
<li><p><span class="koboSpan" id="kobo.219.1" xmlns="http://www.w3.org/1999/xhtml">Application to clean some acquired data and apply simple conversions to a few fields. </span><span class="koboSpan" id="kobo.219.2" xmlns="http://www.w3.org/1999/xhtml">Later projects will add more complex validation rules.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.220.1" xmlns="http://www.w3.org/1999/xhtml">Many of these deliverables are described in previous chapters. </span><span class="koboSpan" id="kobo.220.2" xmlns="http://www.w3.org/1999/xhtml">Specifically, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.221.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.222.1" xmlns="http://www.w3.org/1999/xhtml"> 9</span></em></a><span class="koboSpan" id="kobo.223.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.224.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.1: Data Cleaning Base Application</span></em></a><span class="koboSpan" id="kobo.225.1" xmlns="http://www.w3.org/1999/xhtml"> covers the basics of the deliverables for this project.</span></p>
<section class="level4 likesubsubsectionHead" data-number="14.1.3.1" id="unit-tests-for-validation-functions">
<h4 class="likesubsubsectionHead" data-number="14.1.3.1"><span id="x1-2340003"/><span class="koboSpan" id="kobo.226.1" xmlns="http://www.w3.org/1999/xhtml">Unit tests for validation functions</span></h4>
<p><span class="koboSpan" id="kobo.227.1" xmlns="http://www.w3.org/1999/xhtml">The unique validators used by a Pydantic class </span><span id="dx1-234001"/><span class="koboSpan" id="kobo.228.1" xmlns="http://www.w3.org/1999/xhtml">need test cases. </span><span class="koboSpan" id="kobo.228.2" xmlns="http://www.w3.org/1999/xhtml">For the example shown, the validator function is used to convert two strings into a date.</span></p>
<p><span class="koboSpan" id="kobo.229.1" xmlns="http://www.w3.org/1999/xhtml">Boundary Value Analysis suggests there are three equivalence classes for date conversions:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.230.1" xmlns="http://www.w3.org/1999/xhtml">Syntactically invalid dates. </span><span class="koboSpan" id="kobo.230.2" xmlns="http://www.w3.org/1999/xhtml">The punctuation or the number of digits is wrong.</span></p></li>
<li><p><span class="koboSpan" id="kobo.231.1" xmlns="http://www.w3.org/1999/xhtml">Syntactically valid, but calendrical invalid dates. </span><span class="koboSpan" id="kobo.231.2" xmlns="http://www.w3.org/1999/xhtml">The 30th of February, for example, is invalid, even when formatted properly.</span></p></li>
<li><p><span class="koboSpan" id="kobo.232.1" xmlns="http://www.w3.org/1999/xhtml">Valid dates.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.233.1" xmlns="http://www.w3.org/1999/xhtml">The above list of classes leads to a minimum of three test cases.</span></p>
<p><span class="koboSpan" id="kobo.234.1" xmlns="http://www.w3.org/1999/xhtml">Some developers like to explore each of the fields within a date, providing 5 distinct values: the lower limit (usually 1), the upper limit (e.g., 12 or 31), just below the limit (e.g., 0), just above the upper limit (e.g., 13 or 32), and a value that’s in the range and otherwise valid. </span><span class="koboSpan" id="kobo.234.2" xmlns="http://www.w3.org/1999/xhtml">These additional test cases, however, are really testing the </span><code><span class="koboSpan" id="kobo.235.1" xmlns="http://www.w3.org/1999/xhtml">strptime()</span></code><span class="koboSpan" id="kobo.236.1" xmlns="http://www.w3.org/1999/xhtml"> method of the </span><code><span class="koboSpan" id="kobo.237.1" xmlns="http://www.w3.org/1999/xhtml">datetime</span></code><span class="koboSpan" id="kobo.238.1" xmlns="http://www.w3.org/1999/xhtml"> class. </span><span class="koboSpan" id="kobo.238.2" xmlns="http://www.w3.org/1999/xhtml">These cases are duplicate tests of the </span><code><span class="koboSpan" id="kobo.239.1" xmlns="http://www.w3.org/1999/xhtml">datetime</span></code><span class="koboSpan" id="kobo.240.1" xmlns="http://www.w3.org/1999/xhtml"> module. </span><span class="koboSpan" id="kobo.240.2" xmlns="http://www.w3.org/1999/xhtml">These cases are </span><em><span class="koboSpan" id="kobo.241.1" xmlns="http://www.w3.org/1999/xhtml">not </span></em><span class="koboSpan" id="kobo.242.1" xmlns="http://www.w3.org/1999/xhtml">needed, since the </span><code><span class="koboSpan" id="kobo.243.1" xmlns="http://www.w3.org/1999/xhtml">datetime</span></code><span class="koboSpan" id="kobo.244.1" xmlns="http://www.w3.org/1999/xhtml"> module already has plenty of test cases for calendrically invalid date strings.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-168">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.245.1" xmlns="http://www.w3.org/1999/xhtml">Don’t test the behavior of modules outside the application. </span><span class="koboSpan" id="kobo.245.2" xmlns="http://www.w3.org/1999/xhtml">Those modules have their own test cases.</span></p>
</div>
</div>
<p><span class="koboSpan" id="kobo.246.1" xmlns="http://www.w3.org/1999/xhtml">In the next section, we’ll look at a project to validate nominal data. </span><span class="koboSpan" id="kobo.246.2" xmlns="http://www.w3.org/1999/xhtml">This can be more complicated than validating ordinal or cardinal data. </span><span id="x1-234002r249"/></p>
</section>
</section>
</section>
<section class="level2" data-number="14.2" id="project-3.3-validate-text-fields-and-numeric-coded-fields">
<h2 data-number="14.2"><span class="titlemark"><span class="koboSpan" id="kobo.247.1" xmlns="http://www.w3.org/1999/xhtml">10.2 </span></span> <span id="x1-2350002"/><span class="koboSpan" id="kobo.248.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.3: Validate text fields (and numeric coded fields)</span></h2>
<p><span class="koboSpan" id="kobo.249.1" xmlns="http://www.w3.org/1999/xhtml">For nominal data, we’ll use </span><strong><span class="koboSpan" id="kobo.250.1" xmlns="http://www.w3.org/1999/xhtml">pydantic</span></strong><span class="koboSpan" id="kobo.251.1" xmlns="http://www.w3.org/1999/xhtml">’s technique of applying a validator function to the value of a field. </span><span class="koboSpan" id="kobo.251.2" xmlns="http://www.w3.org/1999/xhtml">In cases </span><span id="dx1-235001"/><span class="koboSpan" id="kobo.252.1" xmlns="http://www.w3.org/1999/xhtml">where the field contains a code consisting only of digits, there can be some ambiguity as to whether or not the value is a cardinal number. </span><span class="koboSpan" id="kobo.252.2" xmlns="http://www.w3.org/1999/xhtml">Some software may treat any sequence of digits as a number, dropping leading zeroes. </span><span class="koboSpan" id="kobo.252.3" xmlns="http://www.w3.org/1999/xhtml">This can lead to a need to use a validator to recover a sensible value for fields that are strings of digits, but not cardinal values. </span><span id="x1-235002r252"/></p>
<section class="level3" data-number="14.2.1" id="description-13">
<h3 data-number="14.2.1"><span class="titlemark"><span class="koboSpan" id="kobo.253.1" xmlns="http://www.w3.org/1999/xhtml">10.2.1 </span></span> <span id="x1-2360001"/><span class="koboSpan" id="kobo.254.1" xmlns="http://www.w3.org/1999/xhtml">Description</span></h3>
<p><span class="koboSpan" id="kobo.255.1" xmlns="http://www.w3.org/1999/xhtml">This project’s intent is to </span><span id="dx1-236001"/><span class="koboSpan" id="kobo.256.1" xmlns="http://www.w3.org/1999/xhtml">perform data validation, cleaning, and standardization. </span><span class="koboSpan" id="kobo.256.2" xmlns="http://www.w3.org/1999/xhtml">This project will expand on the features of the </span><strong><span class="koboSpan" id="kobo.257.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.258.1" xmlns="http://www.w3.org/1999/xhtml">package to do somewhat more sophisticated data validation and conversion.</span></p>
<p><span class="koboSpan" id="kobo.259.1" xmlns="http://www.w3.org/1999/xhtml">We’ll continue working with a data set like </span><a class="url" href="https://tidesandcurrents.noaa.gov/tide_predictions.html"><span class="koboSpan" id="kobo.260.1" xmlns="http://www.w3.org/1999/xhtml">https://tidesandcurrents.noaa.gov/tide_predictions.html</span></a><span class="koboSpan" id="kobo.261.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.261.2" xmlns="http://www.w3.org/1999/xhtml">The tide predictions around the US include dates, but the date is decomposed into three fields, and our data cleaning application needs to combine them.</span></p>
<p><span class="koboSpan" id="kobo.262.1" xmlns="http://www.w3.org/1999/xhtml">For a specific example, see </span><a class="url" href="https://tidesandcurrents.noaa.gov/noaatideannual.html?id=8725769"><span class="koboSpan" id="kobo.263.1" xmlns="http://www.w3.org/1999/xhtml">https://tidesandcurrents.noaa.gov/noaatideannual.html?id=8725769</span></a><span class="koboSpan" id="kobo.264.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.264.2" xmlns="http://www.w3.org/1999/xhtml">Note that the downloaded </span><code><span class="koboSpan" id="kobo.265.1" xmlns="http://www.w3.org/1999/xhtml">.txt</span></code><span class="koboSpan" id="kobo.266.1" xmlns="http://www.w3.org/1999/xhtml"> file is really a tab-delimited CSV file with a complex header. </span><span class="koboSpan" id="kobo.266.2" xmlns="http://www.w3.org/1999/xhtml">This will require some sophisticated acquisition processing similar to the examples shown in </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.267.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.268.1" xmlns="http://www.w3.org/1999/xhtml"> 3</span></em></a><span class="koboSpan" id="kobo.269.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.270.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.1: Data Acquisition Base</span></em> <em><span class="koboSpan" id="kobo.271.1" xmlns="http://www.w3.org/1999/xhtml">Application</span></em></a><span class="koboSpan" id="kobo.272.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.273.1" xmlns="http://www.w3.org/1999/xhtml">For data with a relatively small domain of unique values, a Python </span><code><span class="koboSpan" id="kobo.274.1" xmlns="http://www.w3.org/1999/xhtml">enum</span></code><span class="koboSpan" id="kobo.275.1" xmlns="http://www.w3.org/1999/xhtml"> class is a very handy way to define the allowed collection of values. </span><span class="koboSpan" id="kobo.275.2" xmlns="http://www.w3.org/1999/xhtml">Using an enumeration permits simple, strict validation by </span><code><span class="koboSpan" id="kobo.276.1" xmlns="http://www.w3.org/1999/xhtml">pydantic</span></code><span class="koboSpan" id="kobo.277.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.278.1" xmlns="http://www.w3.org/1999/xhtml">Some data — like account numbers, as one example — have a large domain of values that may be in a state of flux. </span><span class="koboSpan" id="kobo.278.2" xmlns="http://www.w3.org/1999/xhtml">Using an </span><code><span class="koboSpan" id="kobo.279.1" xmlns="http://www.w3.org/1999/xhtml">enum</span></code><span class="koboSpan" id="kobo.280.1" xmlns="http://www.w3.org/1999/xhtml"> class would mean transforming the valid set of account numbers into an enumerated type before attempting to work with any data. </span><span class="koboSpan" id="kobo.280.2" xmlns="http://www.w3.org/1999/xhtml">This may not be particularly helpful, since there’s rarely a compelling need to confirm that an account number is valid; this is often a stipulation that is made about the data.</span></p>
<p><span class="koboSpan" id="kobo.281.1" xmlns="http://www.w3.org/1999/xhtml">For fields like account numbers, there can be a need to validate potential values without an enumeration of all allowed values. </span><span class="koboSpan" id="kobo.281.2" xmlns="http://www.w3.org/1999/xhtml">This means the application must rely on patterns of the text to determine if the value is valid, or if the value needs to be cleaned to make it valid. </span><span class="koboSpan" id="kobo.281.3" xmlns="http://www.w3.org/1999/xhtml">For example, there may be a required number of digits, or check digits embedded within the code. </span><span class="koboSpan" id="kobo.281.4" xmlns="http://www.w3.org/1999/xhtml">In the case of </span><span id="dx1-236002"/><span class="koboSpan" id="kobo.282.1" xmlns="http://www.w3.org/1999/xhtml">credit card numbers, the last digit of a credit card number is used as part of confirmation that the overall number is valid. </span><span class="koboSpan" id="kobo.282.2" xmlns="http://www.w3.org/1999/xhtml">For more information, see </span><a class="url" href="https://www.creditcardvalidator.org/articles/luhn-algorithm"><span class="koboSpan" id="kobo.283.1" xmlns="http://www.w3.org/1999/xhtml">https://www.creditcardvalidator.org/articles/luhn-algorithm</span></a><span class="koboSpan" id="kobo.284.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.285.1" xmlns="http://www.w3.org/1999/xhtml">After considering some of the additional validations that need to be performed, we’ll take a look at a design approach for adding more complicated validations to the cleaning application. </span><span id="x1-236003r255"/></p>
</section>
<section class="level3" data-number="14.2.2" id="approach-12">
<h3 data-number="14.2.2"><span class="titlemark"><span class="koboSpan" id="kobo.286.1" xmlns="http://www.w3.org/1999/xhtml">10.2.2 </span></span> <span id="x1-2370002"/><span class="koboSpan" id="kobo.287.1" xmlns="http://www.w3.org/1999/xhtml">Approach</span></h3>
<p><span class="koboSpan" id="kobo.288.1" xmlns="http://www.w3.org/1999/xhtml">For reference to the general </span><span id="dx1-237001"/><span class="koboSpan" id="kobo.289.1" xmlns="http://www.w3.org/1999/xhtml">approach to this application, see </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.290.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.291.1" xmlns="http://www.w3.org/1999/xhtml"> 9</span></em></a><span class="koboSpan" id="kobo.292.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.293.1" xmlns="http://www.w3.org/1999/xhtml">Project</span></em> <em><span class="koboSpan" id="kobo.294.1" xmlns="http://www.w3.org/1999/xhtml">3.1: Data Cleaning Base Application</span></em></a><span class="koboSpan" id="kobo.295.1" xmlns="http://www.w3.org/1999/xhtml">, specifically </span><a href="ch013.xhtml#x1-2150002"><em><span class="koboSpan" id="kobo.296.1" xmlns="http://www.w3.org/1999/xhtml">Approach</span></em></a><span class="koboSpan" id="kobo.297.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.298.1" xmlns="http://www.w3.org/1999/xhtml">The model can be defined using the </span><strong><span class="koboSpan" id="kobo.299.1" xmlns="http://www.w3.org/1999/xhtml">pydantic </span></strong><span class="koboSpan" id="kobo.300.1" xmlns="http://www.w3.org/1999/xhtml">package. </span><span class="koboSpan" id="kobo.300.2" xmlns="http://www.w3.org/1999/xhtml">This package offers two paths to validating string values against a domain of valid values. </span><span class="koboSpan" id="kobo.300.3" xmlns="http://www.w3.org/1999/xhtml">These alternatives are:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.301.1" xmlns="http://www.w3.org/1999/xhtml">Define an enumeration with all valid values.</span></p></li>
<li><p><span class="koboSpan" id="kobo.302.1" xmlns="http://www.w3.org/1999/xhtml">Define a regular expression for the string field. </span><span class="koboSpan" id="kobo.302.2" xmlns="http://www.w3.org/1999/xhtml">This has the advantage of defining very large domains of valid values, including </span><em><span class="koboSpan" id="kobo.303.1" xmlns="http://www.w3.org/1999/xhtml">potentially</span></em><span class="koboSpan" id="kobo.304.1" xmlns="http://www.w3.org/1999/xhtml"> infinite domains of values.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.305.1" xmlns="http://www.w3.org/1999/xhtml">Enumeration is an elegant solution that defines the list of values as a class. </span><span class="koboSpan" id="kobo.305.2" xmlns="http://www.w3.org/1999/xhtml">As shown earlier, it might look like this:</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.306.1" xmlns="http://www.w3.org/1999/xhtml">import enum

class HighLow(StrEnum):
    high = 'H'
    low = 'L'</span></pre>
<p><span class="koboSpan" id="kobo.307.1" xmlns="http://www.w3.org/1999/xhtml">This will define a domain of two string values, ”L” and ”H”. </span><span class="koboSpan" id="kobo.307.2" xmlns="http://www.w3.org/1999/xhtml">This map provides easier-to-understand names, </span><code><span class="koboSpan" id="kobo.308.1" xmlns="http://www.w3.org/1999/xhtml">Low</span></code><span class="koboSpan" id="kobo.309.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.310.1" xmlns="http://www.w3.org/1999/xhtml">High</span></code><span class="koboSpan" id="kobo.311.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.311.2" xmlns="http://www.w3.org/1999/xhtml">This class can be used by </span><strong><span class="koboSpan" id="kobo.312.1" xmlns="http://www.w3.org/1999/xhtml">pydantic</span></strong><span class="koboSpan" id="kobo.313.1" xmlns="http://www.w3.org/1999/xhtml"> to validate a string value.</span></p>
<p><span class="koboSpan" id="kobo.314.1" xmlns="http://www.w3.org/1999/xhtml">An example of a case when we need to apply a </span><code><span class="koboSpan" id="kobo.315.1" xmlns="http://www.w3.org/1999/xhtml">BeforeValidator</span></code><span class="koboSpan" id="kobo.316.1" xmlns="http://www.w3.org/1999/xhtml"> annotated type might be some tide data with lower-case ”h” and ”l” instead of proper upper-case ”H” or ”L”. </span><span class="koboSpan" id="kobo.316.2" xmlns="http://www.w3.org/1999/xhtml">This allows the validator to clean the data </span><strong><span class="koboSpan" id="kobo.317.1" xmlns="http://www.w3.org/1999/xhtml">prior </span></strong><span class="koboSpan" id="kobo.318.1" xmlns="http://www.w3.org/1999/xhtml">to the built-in data conversion.</span></p>
<p><span class="koboSpan" id="kobo.319.1" xmlns="http://www.w3.org/1999/xhtml">We might use an annotated type. </span><span class="koboSpan" id="kobo.319.2" xmlns="http://www.w3.org/1999/xhtml">It looked like this in the preceding example:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-169">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.320.1" xmlns="http://www.w3.org/1999/xhtml">TideCleanHighLow: TypeAlias = Annotated[
    HighLow, BeforeValidator(lambda text: text.upper())]</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.321.1" xmlns="http://www.w3.org/1999/xhtml">The annotated type hint describes the base type, </span><code><span class="koboSpan" id="kobo.322.1" xmlns="http://www.w3.org/1999/xhtml">HighLow</span></code><span class="koboSpan" id="kobo.323.1" xmlns="http://www.w3.org/1999/xhtml">, and a validation rule to be applied before the </span><strong><span class="koboSpan" id="kobo.324.1" xmlns="http://www.w3.org/1999/xhtml">pydantic </span></strong><span class="koboSpan" id="kobo.325.1" xmlns="http://www.w3.org/1999/xhtml">conversion. </span><span class="koboSpan" id="kobo.325.2" xmlns="http://www.w3.org/1999/xhtml">In this case, it’s a lambda to convert the text to upper case. </span><span class="koboSpan" id="kobo.325.3" xmlns="http://www.w3.org/1999/xhtml">We’ve emphasized the </span><span id="dx1-237009"/><span class="koboSpan" id="kobo.326.1" xmlns="http://www.w3.org/1999/xhtml">validation of enumerated values using an explicit enumeration because it is an important technique for establishing the complete set of allowed codes for a given attribute. </span><span class="koboSpan" id="kobo.326.2" xmlns="http://www.w3.org/1999/xhtml">The enumerated type’s class definition is often a handy place to record notes and other information about the coded values.</span></p>
<p><span class="koboSpan" id="kobo.327.1" xmlns="http://www.w3.org/1999/xhtml">Now that we’ve looked at the various aspects of the approach, we can turn our attention to the deliverables for this project. </span><span id="x1-237010r256"/></p>
</section>
<section class="level3" data-number="14.2.3" id="deliverables-13">
<h3 data-number="14.2.3"><span class="titlemark"><span class="koboSpan" id="kobo.328.1" xmlns="http://www.w3.org/1999/xhtml">10.2.3 </span></span> <span id="x1-2380003"/><span class="koboSpan" id="kobo.329.1" xmlns="http://www.w3.org/1999/xhtml">Deliverables</span></h3>
<p><span class="koboSpan" id="kobo.330.1" xmlns="http://www.w3.org/1999/xhtml">This project has </span><span id="dx1-238001"/><span class="koboSpan" id="kobo.331.1" xmlns="http://www.w3.org/1999/xhtml">the following deliverables:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.332.1" xmlns="http://www.w3.org/1999/xhtml">Documentation in the </span><code><span class="koboSpan" id="kobo.333.1" xmlns="http://www.w3.org/1999/xhtml">docs</span></code><span class="koboSpan" id="kobo.334.1" xmlns="http://www.w3.org/1999/xhtml"> folder.</span></p></li>
<li><p><span class="koboSpan" id="kobo.335.1" xmlns="http://www.w3.org/1999/xhtml">Acceptance tests in the </span><code><span class="koboSpan" id="kobo.336.1" xmlns="http://www.w3.org/1999/xhtml">tests/features</span></code><span class="koboSpan" id="kobo.337.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.338.1" xmlns="http://www.w3.org/1999/xhtml">tests/steps</span></code><span class="koboSpan" id="kobo.339.1" xmlns="http://www.w3.org/1999/xhtml"> folders.</span></p></li>
<li><p><span class="koboSpan" id="kobo.340.1" xmlns="http://www.w3.org/1999/xhtml">Unit tests for the application modules in the </span><code><span class="koboSpan" id="kobo.341.1" xmlns="http://www.w3.org/1999/xhtml">tests</span></code><span class="koboSpan" id="kobo.342.1" xmlns="http://www.w3.org/1999/xhtml"> folder.</span></p></li>
<li><p><span class="koboSpan" id="kobo.343.1" xmlns="http://www.w3.org/1999/xhtml">Application to clean source data in a number of fields.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.344.1" xmlns="http://www.w3.org/1999/xhtml">Many of these deliverables are described in previous chapters. </span><span class="koboSpan" id="kobo.344.2" xmlns="http://www.w3.org/1999/xhtml">Specifically, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.345.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.346.1" xmlns="http://www.w3.org/1999/xhtml"> 9</span></em></a><span class="koboSpan" id="kobo.347.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.348.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.1: Data Cleaning Base Application</span></em></a><span class="koboSpan" id="kobo.349.1" xmlns="http://www.w3.org/1999/xhtml"> covers the basics of the deliverables for this project.</span></p>
<section class="level4 likesubsubsectionHead" data-number="14.2.3.1" id="unit-tests-for-validation-functions-1">
<h4 class="likesubsubsectionHead" data-number="14.2.3.1"><span id="x1-2390003"/><span class="koboSpan" id="kobo.350.1" xmlns="http://www.w3.org/1999/xhtml">Unit tests for validation functions</span></h4>
<p><span class="koboSpan" id="kobo.351.1" xmlns="http://www.w3.org/1999/xhtml">The unique validators </span><span id="dx1-239001"/><span class="koboSpan" id="kobo.352.1" xmlns="http://www.w3.org/1999/xhtml">used by a pydantic class need test cases. </span><span class="koboSpan" id="kobo.352.2" xmlns="http://www.w3.org/1999/xhtml">For the example shown, the validator function is used to validate the state of the tide. </span><span class="koboSpan" id="kobo.352.3" xmlns="http://www.w3.org/1999/xhtml">This is a small domain of enumerated values. </span><span class="koboSpan" id="kobo.352.4" xmlns="http://www.w3.org/1999/xhtml">There are three core kinds of test cases:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.353.1" xmlns="http://www.w3.org/1999/xhtml">Valid codes like </span><code><span class="koboSpan" id="kobo.354.1" xmlns="http://www.w3.org/1999/xhtml">’H’</span></code><span class="koboSpan" id="kobo.355.1" xmlns="http://www.w3.org/1999/xhtml"> or </span><code><span class="koboSpan" id="kobo.356.1" xmlns="http://www.w3.org/1999/xhtml">’L’</span></code><span class="koboSpan" id="kobo.357.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p></li>
<li><p><span class="koboSpan" id="kobo.358.1" xmlns="http://www.w3.org/1999/xhtml">Codes that can be reliably cleaned. </span><span class="koboSpan" id="kobo.358.2" xmlns="http://www.w3.org/1999/xhtml">For example, lower-case codes </span><code><span class="koboSpan" id="kobo.359.1" xmlns="http://www.w3.org/1999/xhtml">’h’</span></code><span class="koboSpan" id="kobo.360.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.361.1" xmlns="http://www.w3.org/1999/xhtml">’l’</span></code><span class="koboSpan" id="kobo.362.1" xmlns="http://www.w3.org/1999/xhtml"> are unambiguous. </span><span class="koboSpan" id="kobo.362.2" xmlns="http://www.w3.org/1999/xhtml">A data inspection notebook may reveal non-code values like </span><code><span class="koboSpan" id="kobo.363.1" xmlns="http://www.w3.org/1999/xhtml">’High’</span></code><span class="koboSpan" id="kobo.364.1" xmlns="http://www.w3.org/1999/xhtml"> or </span><code><span class="koboSpan" id="kobo.365.1" xmlns="http://www.w3.org/1999/xhtml">’Low’</span></code><span class="koboSpan" id="kobo.366.1" xmlns="http://www.w3.org/1999/xhtml">, also. </span><span class="koboSpan" id="kobo.366.2" xmlns="http://www.w3.org/1999/xhtml">These can be reliably cleaned.</span></p></li>
<li><p><span class="koboSpan" id="kobo.367.1" xmlns="http://www.w3.org/1999/xhtml">Invalid codes like </span><code><span class="koboSpan" id="kobo.368.1" xmlns="http://www.w3.org/1999/xhtml">’’</span></code><span class="koboSpan" id="kobo.369.1" xmlns="http://www.w3.org/1999/xhtml">, or </span><code><span class="koboSpan" id="kobo.370.1" xmlns="http://www.w3.org/1999/xhtml">’9’</span></code><span class="koboSpan" id="kobo.371.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.372.1" xmlns="http://www.w3.org/1999/xhtml">The domain of values that can be cleaned properly is something that is subject to a great deal of change. </span><span class="koboSpan" id="kobo.372.2" xmlns="http://www.w3.org/1999/xhtml">It’s common to </span><span id="dx1-239002"/><span class="koboSpan" id="kobo.373.1" xmlns="http://www.w3.org/1999/xhtml">find problems and use an inspection notebook to uncover a new encoding when upstream applications change. </span><span class="koboSpan" id="kobo.373.2" xmlns="http://www.w3.org/1999/xhtml">This will lead to additional test cases, and then additional validation processing to make the test cases pass.</span></p>
<p><span class="koboSpan" id="kobo.374.1" xmlns="http://www.w3.org/1999/xhtml">In the next project, we’ll look at the situation where data must be validated against an externally defined set of values. </span><span id="x1-239003r254"/></p>
</section>
</section>
</section>
<section class="level2" data-number="14.3" id="project-3.4-validate-references-among-separate-data-sources">
<h2 data-number="14.3"><span class="titlemark"><span class="koboSpan" id="kobo.375.1" xmlns="http://www.w3.org/1999/xhtml">10.3 </span></span> <span id="x1-2400003"/><span class="koboSpan" id="kobo.376.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.4: Validate references among separate data sources</span></h2>
<p><span class="koboSpan" id="kobo.377.1" xmlns="http://www.w3.org/1999/xhtml">In </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.378.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.379.1" xmlns="http://www.w3.org/1999/xhtml"> 9</span></em></a><span class="koboSpan" id="kobo.380.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.381.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.1: Data Cleaning Base Application</span></em></a><span class="koboSpan" id="kobo.382.1" xmlns="http://www.w3.org/1999/xhtml"> we relied on the foundational behavior of Pydantic to convert fields from source text to Python types. </span><span class="koboSpan" id="kobo.382.2" xmlns="http://www.w3.org/1999/xhtml">This next project will look at a more complicated validation rule. </span><span id="x1-240001r257"/></p>
<section class="level3" data-number="14.3.1" id="description-14">
<h3 data-number="14.3.1"><span class="titlemark"><span class="koboSpan" id="kobo.383.1" xmlns="http://www.w3.org/1999/xhtml">10.3.1 </span></span> <span id="x1-2410001"/><span class="koboSpan" id="kobo.384.1" xmlns="http://www.w3.org/1999/xhtml">Description</span></h3>
<p><span class="koboSpan" id="kobo.385.1" xmlns="http://www.w3.org/1999/xhtml">This project’s intent is to perform data validation, cleaning, and standardization. </span><span class="koboSpan" id="kobo.385.2" xmlns="http://www.w3.org/1999/xhtml">This project will expand on the </span><span id="dx1-241001"/><span class="koboSpan" id="kobo.386.1" xmlns="http://www.w3.org/1999/xhtml">features of the </span><code><span class="koboSpan" id="kobo.387.1" xmlns="http://www.w3.org/1999/xhtml">pydantic</span></code><span class="koboSpan" id="kobo.388.1" xmlns="http://www.w3.org/1999/xhtml"> package to do somewhat more sophisticated data validations and conversions.</span></p>
<p><span class="koboSpan" id="kobo.389.1" xmlns="http://www.w3.org/1999/xhtml">Data sets in </span><a class="url" href="https://data.census.gov"><span class="koboSpan" id="kobo.390.1" xmlns="http://www.w3.org/1999/xhtml">https://data.census.gov</span></a><span class="koboSpan" id="kobo.391.1" xmlns="http://www.w3.org/1999/xhtml"> have Z</span><strong><span class="koboSpan" id="kobo.392.1" xmlns="http://www.w3.org/1999/xhtml">IP Code Tabulation Areas</span></strong><span class="koboSpan" id="kobo.393.1" xmlns="http://www.w3.org/1999/xhtml"> (</span><strong><span class="koboSpan" id="kobo.394.1" xmlns="http://www.w3.org/1999/xhtml">ZCTAs</span></strong><span class="koboSpan" id="kobo.395.1" xmlns="http://www.w3.org/1999/xhtml">). </span><span class="koboSpan" id="kobo.395.2" xmlns="http://www.w3.org/1999/xhtml">For certain regions, these US postal </span><span id="dx1-241002"/><span class="koboSpan" id="kobo.396.1" xmlns="http://www.w3.org/1999/xhtml">codes can (and should) have leading zeroes. </span><span class="koboSpan" id="kobo.396.2" xmlns="http://www.w3.org/1999/xhtml">In some variations on this data, however, the ZIP codes get treated as numbers and the leading zeroes get lost.</span></p>
<p><span class="koboSpan" id="kobo.397.1" xmlns="http://www.w3.org/1999/xhtml">Data sets at </span><a class="url" href="https://data.census.gov"><span class="koboSpan" id="kobo.398.1" xmlns="http://www.w3.org/1999/xhtml">https://data.census.gov</span></a><span class="koboSpan" id="kobo.399.1" xmlns="http://www.w3.org/1999/xhtml"> have information about the city of Boston, Massachusets, which has numerous US postal codes with leading zeroes. </span><span class="koboSpan" id="kobo.399.2" xmlns="http://www.w3.org/1999/xhtml">The Food Establishment Inspections available at </span><a class="url" href="https://data.boston.gov/group/permitting"><span class="koboSpan" id="kobo.400.1" xmlns="http://www.w3.org/1999/xhtml">https://data.boston.gov/group/permitting</span></a><span class="koboSpan" id="kobo.401.1" xmlns="http://www.w3.org/1999/xhtml"> provides insight into Boston-area restaurants. </span><span class="koboSpan" id="kobo.401.2" xmlns="http://www.w3.org/1999/xhtml">In addition to postal codes (which are nominal data), this data involves numerous fields that contain nominal data as well as ordinal data.</span></p>
<p><span class="koboSpan" id="kobo.402.1" xmlns="http://www.w3.org/1999/xhtml">For data with a relatively small domain of unique values, a Python </span><code><span class="koboSpan" id="kobo.403.1" xmlns="http://www.w3.org/1999/xhtml">enum</span></code><span class="koboSpan" id="kobo.404.1" xmlns="http://www.w3.org/1999/xhtml"> class is a very handy way to define the allowed collection of values. </span><span class="koboSpan" id="kobo.404.2" xmlns="http://www.w3.org/1999/xhtml">Using an enumeration permits simple, strict validation by </span><strong><span class="koboSpan" id="kobo.405.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic</span></strong><span class="koboSpan" id="kobo.406.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.407.1" xmlns="http://www.w3.org/1999/xhtml">Some data — like account numbers, as one example — have a large domain of values that may be in a state of flux. </span><span class="koboSpan" id="kobo.407.2" xmlns="http://www.w3.org/1999/xhtml">Using an </span><code><span class="koboSpan" id="kobo.408.1" xmlns="http://www.w3.org/1999/xhtml">enum</span></code><span class="koboSpan" id="kobo.409.1" xmlns="http://www.w3.org/1999/xhtml"> class would mean transforming the valid set of account numbers into an enum before attempting to work with any data. </span><span class="koboSpan" id="kobo.409.2" xmlns="http://www.w3.org/1999/xhtml">This may not be particularly helpful, since there’s rarely a compelling need to confirm that an account number is valid; this is often a </span><span id="dx1-241003"/><span class="koboSpan" id="kobo.410.1" xmlns="http://www.w3.org/1999/xhtml">simple stipulation that is made about the data.</span></p>
<p><span class="koboSpan" id="kobo.411.1" xmlns="http://www.w3.org/1999/xhtml">This leads to a need to validate potential values without an enumeration of the allowed values. </span><span class="koboSpan" id="kobo.411.2" xmlns="http://www.w3.org/1999/xhtml">This means the application must rely on patterns of the text to determine if the value is valid, or if the value needs to be cleaned to make it valid.</span></p>
<p><span class="koboSpan" id="kobo.412.1" xmlns="http://www.w3.org/1999/xhtml">When an application cleans postal code data, there are two distinct parts to the cleaning:</span></p>
<ol>
<li><div id="x1-241005x1">
<p><span class="koboSpan" id="kobo.413.1" xmlns="http://www.w3.org/1999/xhtml">Clean the postal code to have the proper format. </span><span class="koboSpan" id="kobo.413.2" xmlns="http://www.w3.org/1999/xhtml">For US ZIP codes, it’s generally 5 digits. </span><span class="koboSpan" id="kobo.413.3" xmlns="http://www.w3.org/1999/xhtml">Some codes are 5 digits, a hyphen, and 4 more digits.</span></p>
</div></li>
<li><div id="x1-241007x2">
<p><span class="koboSpan" id="kobo.414.1" xmlns="http://www.w3.org/1999/xhtml">Compare the code with some master list to be sure it’s a meaningful code that references an actual post office or location.</span></p>
</div></li>
</ol>
<p><span class="koboSpan" id="kobo.415.1" xmlns="http://www.w3.org/1999/xhtml">It’s important to keep these separate since the first step is covered by the previous project, and doesn’t involve anything terribly complicated. </span><span class="koboSpan" id="kobo.415.2" xmlns="http://www.w3.org/1999/xhtml">The second step involves some additional processing to compare a given record against a master list of allowed values. </span><span id="x1-241008r260"/></p>
</section>
<section class="level3" data-number="14.3.2" id="approach-13">
<h3 data-number="14.3.2"><span class="titlemark"><span class="koboSpan" id="kobo.416.1" xmlns="http://www.w3.org/1999/xhtml">10.3.2 </span></span> <span id="x1-2420002"/><span class="koboSpan" id="kobo.417.1" xmlns="http://www.w3.org/1999/xhtml">Approach</span></h3>
<p><span class="koboSpan" id="kobo.418.1" xmlns="http://www.w3.org/1999/xhtml">For reference to the general </span><span id="dx1-242001"/><span class="koboSpan" id="kobo.419.1" xmlns="http://www.w3.org/1999/xhtml">approach to this application, see </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.420.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.421.1" xmlns="http://www.w3.org/1999/xhtml"> 9</span></em></a><span class="koboSpan" id="kobo.422.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.423.1" xmlns="http://www.w3.org/1999/xhtml">Project</span></em> <em><span class="koboSpan" id="kobo.424.1" xmlns="http://www.w3.org/1999/xhtml">3.1: Data Cleaning Base Application</span></em></a><span class="koboSpan" id="kobo.425.1" xmlns="http://www.w3.org/1999/xhtml">, specifically </span><a href="ch013.xhtml#x1-2150002"><em><span class="koboSpan" id="kobo.426.1" xmlns="http://www.w3.org/1999/xhtml">Approach</span></em></a><span class="koboSpan" id="kobo.427.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.428.1" xmlns="http://www.w3.org/1999/xhtml">When we have nominal values that must refer to external data, we can call these “foreign keys.” </span><span class="koboSpan" id="kobo.428.2" xmlns="http://www.w3.org/1999/xhtml">They’re references to an external collection of entities for which the values are primary keys. </span><span class="koboSpan" id="kobo.428.3" xmlns="http://www.w3.org/1999/xhtml">An example of this is a postal code. </span><span class="koboSpan" id="kobo.428.4" xmlns="http://www.w3.org/1999/xhtml">There is a defined list of valid postal codes; the code is a primary key in this collection. </span><span class="koboSpan" id="kobo.428.5" xmlns="http://www.w3.org/1999/xhtml">In our sample data, the postal code is a foreign key reference to the defining collection of postal codes.</span></p>
<p><span class="koboSpan" id="kobo.429.1" xmlns="http://www.w3.org/1999/xhtml">Other examples include country codes, US state codes, and US phone system area codes. </span><span class="koboSpan" id="kobo.429.2" xmlns="http://www.w3.org/1999/xhtml">We can write a regular expression to describe the potential domain of key values. </span><span class="koboSpan" id="kobo.429.3" xmlns="http://www.w3.org/1999/xhtml">For US state codes, for example, we can use the regular expression </span><code><span class="koboSpan" id="kobo.430.1" xmlns="http://www.w3.org/1999/xhtml">r’\w\w’</span></code><span class="koboSpan" id="kobo.431.1" xmlns="http://www.w3.org/1999/xhtml"> to describe state codes as having two letters. </span><span class="koboSpan" id="kobo.431.2" xmlns="http://www.w3.org/1999/xhtml">We could </span><span id="dx1-242002"/><span class="koboSpan" id="kobo.432.1" xmlns="http://www.w3.org/1999/xhtml">narrow this domain slightly using </span><code><span class="koboSpan" id="kobo.433.1" xmlns="http://www.w3.org/1999/xhtml">r’[A-Z]{2}’</span></code><span class="koboSpan" id="kobo.434.1" xmlns="http://www.w3.org/1999/xhtml"> to require the state code use upper-case letters only. </span><span class="koboSpan" id="kobo.434.2" xmlns="http://www.w3.org/1999/xhtml">There are only 50 state codes, plus a few territories and districts; limiting this further would make for a very long regular expression.</span></p>
<p><span class="koboSpan" id="kobo.435.1" xmlns="http://www.w3.org/1999/xhtml">The confounding factor here is when the primary keys need to be loaded from an external source — for example, a database. </span><span class="koboSpan" id="kobo.435.2" xmlns="http://www.w3.org/1999/xhtml">In this case, the simple </span><code><span class="koboSpan" id="kobo.436.1" xmlns="http://www.w3.org/1999/xhtml">@validator</span></code><span class="koboSpan" id="kobo.437.1" xmlns="http://www.w3.org/1999/xhtml"> method has a dependency on external data. </span><span class="koboSpan" id="kobo.437.2" xmlns="http://www.w3.org/1999/xhtml">Further, this data must be loaded prior to any data cleaning activities.</span></p>
<p><span class="koboSpan" id="kobo.438.1" xmlns="http://www.w3.org/1999/xhtml">We have two choices for gathering the set of valid key values:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.439.1" xmlns="http://www.w3.org/1999/xhtml">Create an </span><code><span class="koboSpan" id="kobo.440.1" xmlns="http://www.w3.org/1999/xhtml">Enum</span></code><span class="koboSpan" id="kobo.441.1" xmlns="http://www.w3.org/1999/xhtml"> class with a list of valid values.</span></p></li>
<li><p><span class="koboSpan" id="kobo.442.1" xmlns="http://www.w3.org/1999/xhtml">Define a </span><code><span class="koboSpan" id="kobo.443.1" xmlns="http://www.w3.org/1999/xhtml">@classmethod</span></code><span class="koboSpan" id="kobo.444.1" xmlns="http://www.w3.org/1999/xhtml"> to initialize the pydantic class with valid values.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.445.1" xmlns="http://www.w3.org/1999/xhtml">For </span><span id="dx1-242003"/><span class="koboSpan" id="kobo.446.1" xmlns="http://www.w3.org/1999/xhtml">example, </span><a class="url" href="https://data.opendatasoft.com"><span class="koboSpan" id="kobo.447.1" xmlns="http://www.w3.org/1999/xhtml">https://data.opendatasoft.com</span></a><span class="koboSpan" id="kobo.448.1" xmlns="http://www.w3.org/1999/xhtml"> has a useful list of US zip codes. </span><span class="koboSpan" id="kobo.448.2" xmlns="http://www.w3.org/1999/xhtml">See the URL </span><a class="url" href="https://data.opendatasoft.com/api/explore/v2.1/catalog/datasets/georef-united-states-of-america-zc-point@public/exports/csv"><span class="koboSpan" id="kobo.449.1" xmlns="http://www.w3.org/1999/xhtml">https://data.opendatasoft.com/api/explore/v2.1/catalog/datasets/georef-united-states-of-america-zc-point@public/exports/csv</span></a><span class="koboSpan" id="kobo.450.1" xmlns="http://www.w3.org/1999/xhtml"> for US Zip Codes Points, United States of America. </span><span class="koboSpan" id="kobo.450.2" xmlns="http://www.w3.org/1999/xhtml">This is a file that can be downloaded and transformed into an enum or used to initialize a class. </span><span class="koboSpan" id="kobo.450.3" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.451.1" xmlns="http://www.w3.org/1999/xhtml">Enum</span></code><span class="koboSpan" id="kobo.452.1" xmlns="http://www.w3.org/1999/xhtml"> class creation is a matter of creating a list of two tuples with the label and the value for the enumeration. </span><span class="koboSpan" id="kobo.452.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.453.1" xmlns="http://www.w3.org/1999/xhtml">Enum</span></code><span class="koboSpan" id="kobo.454.1" xmlns="http://www.w3.org/1999/xhtml"> definition can be built with code like the following example:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-170">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.455.1" xmlns="http://www.w3.org/1999/xhtml">import csv
import enum
from pathlib import Path

def zip_code_values() -&gt; list[tuple[str, str]]:
    source_path = Path.home() / "Downloads" / "georef-united-states-of-
      america-zc-point@public.csv"
    with source_path.open(encoding=’utf_8_sig’) as source:
        reader = csv.DictReader(source, delimiter=’;’)
        values = [
            (f"ZIP_{zip[’Zip Code’]:0&gt;5s}", f"{zip[’Zip Code’]:0&gt;5s}")
            for zip in reader
        ]
    return values

ZipCode = enum.Enum("ZipCode", zip_code_values())</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.456.1" xmlns="http://www.w3.org/1999/xhtml">This will create an enumerated class, </span><code><span class="koboSpan" id="kobo.457.1" xmlns="http://www.w3.org/1999/xhtml">ZipCode</span></code><span class="koboSpan" id="kobo.458.1" xmlns="http://www.w3.org/1999/xhtml">, from the approximately 33,000 ZIP codes in the downloaded source file. </span><span class="koboSpan" id="kobo.458.2" xmlns="http://www.w3.org/1999/xhtml">The enumerated labels will be Python attribute names similar to </span><code><span class="koboSpan" id="kobo.459.1" xmlns="http://www.w3.org/1999/xhtml">ZIP_75846</span></code><span class="koboSpan" id="kobo.460.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.460.2" xmlns="http://www.w3.org/1999/xhtml">The values for these labels will be the US postal codes, for example, </span><code><span class="koboSpan" id="kobo.461.1" xmlns="http://www.w3.org/1999/xhtml">’75846’</span></code><span class="koboSpan" id="kobo.462.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.462.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.463.1" xmlns="http://www.w3.org/1999/xhtml">":0&gt;5s"</span></code><span class="koboSpan" id="kobo.464.1" xmlns="http://www.w3.org/1999/xhtml"> string format will force in leading zeroes where needed.</span></p>
<p><span class="koboSpan" id="kobo.465.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.466.1" xmlns="http://www.w3.org/1999/xhtml">zip_code_values()</span></code><span class="koboSpan" id="kobo.467.1" xmlns="http://www.w3.org/1999/xhtml"> function saves us from writing 30,000 lines of code to define the enumeration class, </span><code><span class="koboSpan" id="kobo.468.1" xmlns="http://www.w3.org/1999/xhtml">ZipCode</span></code><span class="koboSpan" id="kobo.469.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.469.2" xmlns="http://www.w3.org/1999/xhtml">Instead, this function reads 30,000 values, creating a list of pairs used to create an </span><code><span class="koboSpan" id="kobo.470.1" xmlns="http://www.w3.org/1999/xhtml">Enum</span></code><span class="koboSpan" id="kobo.471.1" xmlns="http://www.w3.org/1999/xhtml"> subclass.</span></p>
<p><span class="koboSpan" id="kobo.472.1" xmlns="http://www.w3.org/1999/xhtml">The odd encoding of </span><code><span class="koboSpan" id="kobo.473.1" xmlns="http://www.w3.org/1999/xhtml">utf_8_sig</span></code><span class="koboSpan" id="kobo.474.1" xmlns="http://www.w3.org/1999/xhtml"> is necessary because the </span><span id="dx1-242020"/><span class="koboSpan" id="kobo.475.1" xmlns="http://www.w3.org/1999/xhtml">source file has a leading </span><strong><span class="koboSpan" id="kobo.476.1" xmlns="http://www.w3.org/1999/xhtml">byte-order mark </span></strong><span class="koboSpan" id="kobo.477.1" xmlns="http://www.w3.org/1999/xhtml">(</span><strong><span class="koboSpan" id="kobo.478.1" xmlns="http://www.w3.org/1999/xhtml">BOM</span></strong><span class="koboSpan" id="kobo.479.1" xmlns="http://www.w3.org/1999/xhtml">). </span><span class="koboSpan" id="kobo.479.2" xmlns="http://www.w3.org/1999/xhtml">This is unusual but</span><span id="dx1-242021"/><span class="koboSpan" id="kobo.480.1" xmlns="http://www.w3.org/1999/xhtml">permitted by Unicode standards. </span><span class="koboSpan" id="kobo.480.2" xmlns="http://www.w3.org/1999/xhtml">Other data sources for ZIP codes may not include this odd artifact. </span><span class="koboSpan" id="kobo.480.3" xmlns="http://www.w3.org/1999/xhtml">The encoding gracefully ignores the BOM bytes.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-171">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.481.1" xmlns="http://www.w3.org/1999/xhtml">The unusual encoding of </span><code><span class="koboSpan" id="kobo.482.1" xmlns="http://www.w3.org/1999/xhtml">utf_8_sig</span></code><span class="koboSpan" id="kobo.483.1" xmlns="http://www.w3.org/1999/xhtml"> is a special case because this file happens to be in an odd format.</span></p>
<p><span class="koboSpan" id="kobo.484.1" xmlns="http://www.w3.org/1999/xhtml">There are a large number of encodings for text. </span><span class="koboSpan" id="kobo.484.2" xmlns="http://www.w3.org/1999/xhtml">While UTF-8 is popular, it is not universal.</span></p>
<p><span class="koboSpan" id="kobo.485.1" xmlns="http://www.w3.org/1999/xhtml">When unusual characters appear, it’s important to find the source of the data and ask what encoding they used.</span></p>
<p><span class="koboSpan" id="kobo.486.1" xmlns="http://www.w3.org/1999/xhtml">In general, it’s impossible to uncover the encoding given a sample file. </span><span class="koboSpan" id="kobo.486.2" xmlns="http://www.w3.org/1999/xhtml">There are a large number of valid byte code mappings that overlap between ASCII, CP1252, and UTF-8.</span></p>
</div>
</div>
<p><span class="koboSpan" id="kobo.487.1" xmlns="http://www.w3.org/1999/xhtml">This design requires the associated data file. </span><span class="koboSpan" id="kobo.487.2" xmlns="http://www.w3.org/1999/xhtml">One potential improvement is to create a Python module from the source data.</span></p>
<p><span class="koboSpan" id="kobo.488.1" xmlns="http://www.w3.org/1999/xhtml">Using the </span><strong><span class="koboSpan" id="kobo.489.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.490.1" xmlns="http://www.w3.org/1999/xhtml">functional validators uses a similar algorithm to the one shown above. </span><span class="koboSpan" id="kobo.490.2" xmlns="http://www.w3.org/1999/xhtml">The validation initialization is used to </span><span id="dx1-242022"/><span class="koboSpan" id="kobo.491.1" xmlns="http://www.w3.org/1999/xhtml">build an object that retains a set of valid values. </span><span class="koboSpan" id="kobo.491.2" xmlns="http://www.w3.org/1999/xhtml">We’ll start with the goal of a small model using annotated types. </span><span class="koboSpan" id="kobo.491.3" xmlns="http://www.w3.org/1999/xhtml">The model looks like this:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-172">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.492.1" xmlns="http://www.w3.org/1999/xhtml">import csv
from pathlib import Path
import re
from typing import TextIO, TypeAlias, Annotated

from pydantic import BaseModel, Field
from pydantic.functional_validators import BeforeValidator, AfterValidator

# See below for the type aliases.

</span><span class="koboSpan" id="kobo.492.2" xmlns="http://www.w3.org/1999/xhtml">ValidZip: TypeAlias = Annotated[
    str,
    BeforeValidator(zip_format_valid),
    AfterValidator(zip_lookup_valid)]

class SomethingWithZip(BaseModel):
    # Some other fields
    zip: ValidZip</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.493.1" xmlns="http://www.w3.org/1999/xhtml">The model relies on the </span><code><span class="koboSpan" id="kobo.494.1" xmlns="http://www.w3.org/1999/xhtml">ValidZip</span></code><span class="koboSpan" id="kobo.495.1" xmlns="http://www.w3.org/1999/xhtml"> type. </span><span class="koboSpan" id="kobo.495.2" xmlns="http://www.w3.org/1999/xhtml">This type has two validation rules: before any conversion, a </span><code><span class="koboSpan" id="kobo.496.1" xmlns="http://www.w3.org/1999/xhtml">zip_format_valid()</span></code><span class="koboSpan" id="kobo.497.1" xmlns="http://www.w3.org/1999/xhtml"> function is applied, and after conversion, a </span><code><span class="koboSpan" id="kobo.498.1" xmlns="http://www.w3.org/1999/xhtml">zip_lookup_valid()</span></code><span class="koboSpan" id="kobo.499.1" xmlns="http://www.w3.org/1999/xhtml"> function is used.</span></p>
<p><span class="koboSpan" id="kobo.500.1" xmlns="http://www.w3.org/1999/xhtml">We’ve only defined a single field, </span><code><span class="koboSpan" id="kobo.501.1" xmlns="http://www.w3.org/1999/xhtml">zip</span></code><span class="koboSpan" id="kobo.502.1" xmlns="http://www.w3.org/1999/xhtml">, in this </span><strong><span class="koboSpan" id="kobo.503.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.504.1" xmlns="http://www.w3.org/1999/xhtml">class. </span><span class="koboSpan" id="kobo.504.2" xmlns="http://www.w3.org/1999/xhtml">This will let us focus on the validation-by-lookup design. </span><span class="koboSpan" id="kobo.504.3" xmlns="http://www.w3.org/1999/xhtml">A more robust example, perhaps based on the Boston health inspections shown above, would have a </span><span id="dx1-242041"/><span class="koboSpan" id="kobo.505.1" xmlns="http://www.w3.org/1999/xhtml">number of additional fields reflecting the source data to be analyzed.</span></p>
<p><span class="koboSpan" id="kobo.506.1" xmlns="http://www.w3.org/1999/xhtml">The before validator function, </span><code><span class="koboSpan" id="kobo.507.1" xmlns="http://www.w3.org/1999/xhtml">zip_format_valid()</span></code><span class="koboSpan" id="kobo.508.1" xmlns="http://www.w3.org/1999/xhtml">, compares the ZIP code to a regular expression to ensure that it is valid:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-173">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.509.1" xmlns="http://www.w3.org/1999/xhtml">def zip_format_valid(zip: str) -&gt; str:
    assert re.match(r’\d{5}|\d{5}-d{4}’, zip) is not None,
    f"ZIP invalid format {zip!r}"
    return zip</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.510.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.511.1" xmlns="http://www.w3.org/1999/xhtml">zip_format_valid()</span></code><span class="koboSpan" id="kobo.512.1" xmlns="http://www.w3.org/1999/xhtml"> can be expanded to use an f-string like </span><code><span class="koboSpan" id="kobo.513.1" xmlns="http://www.w3.org/1999/xhtml">f"{zip:0&gt;5s}</span></code><span class="koboSpan" id="kobo.514.1" xmlns="http://www.w3.org/1999/xhtml"> to reformat a ZIP code that’s missing the leading zeroes. </span><span class="koboSpan" id="kobo.514.2" xmlns="http://www.w3.org/1999/xhtml">We’ll leave this for you to integrate into this function.</span></p>
<p><span class="koboSpan" id="kobo.515.1" xmlns="http://www.w3.org/1999/xhtml">The after validator function is a callable object. </span><span class="koboSpan" id="kobo.515.2" xmlns="http://www.w3.org/1999/xhtml">It’s an instance of a class that defines the </span><code><span class="koboSpan" id="kobo.516.1" xmlns="http://www.w3.org/1999/xhtml">__call__()</span></code><span class="koboSpan" id="kobo.517.1" xmlns="http://www.w3.org/1999/xhtml"> method.</span></p>
<p><span class="koboSpan" id="kobo.518.1" xmlns="http://www.w3.org/1999/xhtml">Here’s the core class definition, and the creation of the instance:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-174">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.519.1" xmlns="http://www.w3.org/1999/xhtml">class ZipLookupValidator:
    """Compare a code against a list."""
    </span><span class="koboSpan" id="kobo.519.2" xmlns="http://www.w3.org/1999/xhtml">def __init__(self) -&gt; None:
        self.zip_set: set[str] = set()

    def load(self, source: TextIO) -&gt; None:
        reader = csv.DictReader(source, delimiter=’;’)
        self.zip_set = {
            f"{zip[’Zip Code’]:0&gt;5s}"
            for zip in reader
        }

    def __call__(self, zip: str) -&gt; str:
        if zip in self.zip_set:
            return zip
        raise ValueError(f"invalid ZIP code {zip}")

zip_lookup_valid = ZipLookupValidator()</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.520.1" xmlns="http://www.w3.org/1999/xhtml">This will define the </span><code><span class="koboSpan" id="kobo.521.1" xmlns="http://www.w3.org/1999/xhtml">zip_lookup_valid</span></code><span class="koboSpan" id="kobo.522.1" xmlns="http://www.w3.org/1999/xhtml"> callable object. </span><span class="koboSpan" id="kobo.522.2" xmlns="http://www.w3.org/1999/xhtml">Initially, there’s new value for the internal </span><code><span class="koboSpan" id="kobo.523.1" xmlns="http://www.w3.org/1999/xhtml">self.zip_set</span></code><span class="koboSpan" id="kobo.524.1" xmlns="http://www.w3.org/1999/xhtml"> attribute. </span><span class="koboSpan" id="kobo.524.2" xmlns="http://www.w3.org/1999/xhtml">This must be </span><span id="dx1-242064"/><span class="koboSpan" id="kobo.525.1" xmlns="http://www.w3.org/1999/xhtml">built using a function that evaluates </span><code><span class="koboSpan" id="kobo.526.1" xmlns="http://www.w3.org/1999/xhtml">zip_lookup_valid.load(source)</span></code><span class="koboSpan" id="kobo.527.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.527.2" xmlns="http://www.w3.org/1999/xhtml">This will populate the set of valid values.</span></p>
<p><span class="koboSpan" id="kobo.528.1" xmlns="http://www.w3.org/1999/xhtml">We’ve called this function </span><code><span class="koboSpan" id="kobo.529.1" xmlns="http://www.w3.org/1999/xhtml">prepare_validator()</span></code><span class="koboSpan" id="kobo.530.1" xmlns="http://www.w3.org/1999/xhtml"> and it looks like this:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-175">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.531.1" xmlns="http://www.w3.org/1999/xhtml">def prepare_validator() -&gt; None:
    source_path = (
        Path.home() / "Downloads" /
        "georef-united-states-of-america-zc-point@public.csv"
    )
    with source_path.open(encoding=’utf_8_sig’) as source:
        zip_lookup_valid.load(source)</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.532.1" xmlns="http://www.w3.org/1999/xhtml">This idea of a complex validation follows the SOLID design principle. </span><span class="koboSpan" id="kobo.532.2" xmlns="http://www.w3.org/1999/xhtml">It separates the essential work of the </span><code><span class="koboSpan" id="kobo.533.1" xmlns="http://www.w3.org/1999/xhtml">SomethingWithZip</span></code><span class="koboSpan" id="kobo.534.1" xmlns="http://www.w3.org/1999/xhtml"> class from the </span><code><span class="koboSpan" id="kobo.535.1" xmlns="http://www.w3.org/1999/xhtml">ValidZip</span></code><span class="koboSpan" id="kobo.536.1" xmlns="http://www.w3.org/1999/xhtml"> type definition.</span></p>
<p><span class="koboSpan" id="kobo.537.1" xmlns="http://www.w3.org/1999/xhtml">Further, the </span><code><span class="koboSpan" id="kobo.538.1" xmlns="http://www.w3.org/1999/xhtml">ValidZip</span></code><span class="koboSpan" id="kobo.539.1" xmlns="http://www.w3.org/1999/xhtml"> type depends on a separate class, </span><code><span class="koboSpan" id="kobo.540.1" xmlns="http://www.w3.org/1999/xhtml">ZipLookupValidator</span></code><span class="koboSpan" id="kobo.541.1" xmlns="http://www.w3.org/1999/xhtml">, which handles the complications of loading data. </span><span class="koboSpan" id="kobo.541.2" xmlns="http://www.w3.org/1999/xhtml">This separation makes it somewhat easier to change validation files, or change the format of the data used for validation without breaking the </span><code><span class="koboSpan" id="kobo.542.1" xmlns="http://www.w3.org/1999/xhtml">SomethingWithZip</span></code><span class="koboSpan" id="kobo.543.1" xmlns="http://www.w3.org/1999/xhtml"> class and the applications that use it. </span><span class="koboSpan" id="kobo.543.2" xmlns="http://www.w3.org/1999/xhtml">Further, it provides a reusable type, </span><code><span class="koboSpan" id="kobo.544.1" xmlns="http://www.w3.org/1999/xhtml">ValidZip</span></code><span class="koboSpan" id="kobo.545.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.545.2" xmlns="http://www.w3.org/1999/xhtml">This can be used for multiple fields of a model, or multiple models.</span></p>
<p><span class="koboSpan" id="kobo.546.1" xmlns="http://www.w3.org/1999/xhtml">Having looked at the technical approach, we’ll shift to looking at the deliverables for this project. </span><span id="x1-242072r261"/></p>
</section>
<section class="level3" data-number="14.3.3" id="deliverables-14">
<h3 data-number="14.3.3"><span class="titlemark"><span class="koboSpan" id="kobo.547.1" xmlns="http://www.w3.org/1999/xhtml">10.3.3 </span></span> <span id="x1-2430003"/><span class="koboSpan" id="kobo.548.1" xmlns="http://www.w3.org/1999/xhtml">Deliverables</span></h3>
<p><span class="koboSpan" id="kobo.549.1" xmlns="http://www.w3.org/1999/xhtml">This project has the </span><span id="dx1-243001"/><span class="koboSpan" id="kobo.550.1" xmlns="http://www.w3.org/1999/xhtml">following deliverables:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.551.1" xmlns="http://www.w3.org/1999/xhtml">Documentation in the </span><code><span class="koboSpan" id="kobo.552.1" xmlns="http://www.w3.org/1999/xhtml">docs</span></code><span class="koboSpan" id="kobo.553.1" xmlns="http://www.w3.org/1999/xhtml"> folder.</span></p></li>
<li><p><span class="koboSpan" id="kobo.554.1" xmlns="http://www.w3.org/1999/xhtml">Acceptance tests in the </span><code><span class="koboSpan" id="kobo.555.1" xmlns="http://www.w3.org/1999/xhtml">tests/features</span></code><span class="koboSpan" id="kobo.556.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.557.1" xmlns="http://www.w3.org/1999/xhtml">tests/steps</span></code><span class="koboSpan" id="kobo.558.1" xmlns="http://www.w3.org/1999/xhtml"> folders.</span></p></li>
<li><p><span class="koboSpan" id="kobo.559.1" xmlns="http://www.w3.org/1999/xhtml">Unit tests for the application modules in the </span><code><span class="koboSpan" id="kobo.560.1" xmlns="http://www.w3.org/1999/xhtml">tests</span></code><span class="koboSpan" id="kobo.561.1" xmlns="http://www.w3.org/1999/xhtml"> folder.</span></p></li>
<li><p><span class="koboSpan" id="kobo.562.1" xmlns="http://www.w3.org/1999/xhtml">Application to clean and validate data against external sources.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.563.1" xmlns="http://www.w3.org/1999/xhtml">Many of these deliverables are described in previous chapters. </span><span class="koboSpan" id="kobo.563.2" xmlns="http://www.w3.org/1999/xhtml">Specifically, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.564.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.565.1" xmlns="http://www.w3.org/1999/xhtml"> 9</span></em></a><span class="koboSpan" id="kobo.566.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.567.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.1: Data Cleaning Base Application</span></em></a><span class="koboSpan" id="kobo.568.1" xmlns="http://www.w3.org/1999/xhtml"> covers the basics of the deliverables for this project.</span></p>
<section class="level4 likesubsubsectionHead" data-number="14.3.3.1" id="unit-tests-for-data-gathering-and-validation">
<h4 class="likesubsubsectionHead" data-number="14.3.3.1"><span id="x1-2440003"/><span class="koboSpan" id="kobo.569.1" xmlns="http://www.w3.org/1999/xhtml">Unit tests for data gathering and validation</span></h4>
<p><span class="koboSpan" id="kobo.570.1" xmlns="http://www.w3.org/1999/xhtml">The unique validators used by a </span><strong><span class="koboSpan" id="kobo.571.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.572.1" xmlns="http://www.w3.org/1999/xhtml">class need </span><span id="dx1-244001"/><span class="koboSpan" id="kobo.573.1" xmlns="http://www.w3.org/1999/xhtml">test cases. </span><span class="koboSpan" id="kobo.573.2" xmlns="http://www.w3.org/1999/xhtml">For the example shown, the validator function is </span><span id="dx1-244002"/><span class="koboSpan" id="kobo.574.1" xmlns="http://www.w3.org/1999/xhtml">used to validate US ZIP codes. </span><span class="koboSpan" id="kobo.574.2" xmlns="http://www.w3.org/1999/xhtml">There are three core kinds of test cases:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.575.1" xmlns="http://www.w3.org/1999/xhtml">Valid ZIP codes with five digits that are found in the ZIP code database.</span></p></li>
<li><p><span class="koboSpan" id="kobo.576.1" xmlns="http://www.w3.org/1999/xhtml">Syntactically valid ZIP codes with five digits that are </span><strong><span class="koboSpan" id="kobo.577.1" xmlns="http://www.w3.org/1999/xhtml">not </span></strong><span class="koboSpan" id="kobo.578.1" xmlns="http://www.w3.org/1999/xhtml">found in the ZIP code database.</span></p></li>
<li><p><span class="koboSpan" id="kobo.579.1" xmlns="http://www.w3.org/1999/xhtml">Syntactically invalid ZIP that don’t have five digits, or can’t — with the addition of leading zeroes — be made into valid codes.</span></p></li>
</ul>
<p><span id="x1-244003r259"/></p>
</section>
</section>
</section>
<section class="level2" data-number="14.4" id="project-3.5-standardize-data-to-common-codes-and-ranges">
<h2 data-number="14.4"><span class="titlemark"><span class="koboSpan" id="kobo.580.1" xmlns="http://www.w3.org/1999/xhtml">10.4 </span></span> <span id="x1-2450004"/><span class="koboSpan" id="kobo.581.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.5: Standardize data to common codes and ranges</span></h2>
<p><span class="koboSpan" id="kobo.582.1" xmlns="http://www.w3.org/1999/xhtml">Another aspect of cleaning </span><span id="dx1-245001"/><span class="koboSpan" id="kobo.583.1" xmlns="http://www.w3.org/1999/xhtml">data is the transformation of raw data values into standardized values. </span><span class="koboSpan" id="kobo.583.2" xmlns="http://www.w3.org/1999/xhtml">For example, codes in use have evolved over time, and older data codes should be standardized to match new data codes. </span><span class="koboSpan" id="kobo.583.3" xmlns="http://www.w3.org/1999/xhtml">The notion of standardizing values can be a sensitive topic if critical information is treated as an outlier and rejected or improperly standardized.</span></p>
<p><span class="koboSpan" id="kobo.584.1" xmlns="http://www.w3.org/1999/xhtml">We can also consider imputing new values to fill in for missing values as a kind of standardization technique. </span><span class="koboSpan" id="kobo.584.2" xmlns="http://www.w3.org/1999/xhtml">This can be a necessary step when dealing with missing data or data that’s likely to represent some measurement error, not the underlying phenomenon being analyzed.</span></p>
<p><span class="koboSpan" id="kobo.585.1" xmlns="http://www.w3.org/1999/xhtml">This kind of transformation </span><span id="dx1-245002"/><span class="koboSpan" id="kobo.586.1" xmlns="http://www.w3.org/1999/xhtml">often requires careful, thoughtful justification. </span><span class="koboSpan" id="kobo.586.2" xmlns="http://www.w3.org/1999/xhtml">We’ll show some programming examples. </span><span class="koboSpan" id="kobo.586.3" xmlns="http://www.w3.org/1999/xhtml">The deeper questions of handling missing data, imputing values, handling outliers, and other standardization operations are outside the scope of this book.</span></p>
<p><span class="koboSpan" id="kobo.587.1" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://towardsdatascience.com/6-different-ways-to-compensate-for-missing-values-data-imputation-with-examples-6022d9ca0779"><span class="koboSpan" id="kobo.588.1" xmlns="http://www.w3.org/1999/xhtml">https://towardsdatascience.com/6-different-ways-to-compensate-for-missing-values-data-imputation-with-examples-6022d9ca0779</span></a><span class="koboSpan" id="kobo.589.1" xmlns="http://www.w3.org/1999/xhtml"> for an overview of some ways to deal with missing or invalid data. </span><span id="x1-245003r262"/></p>
<section class="level3" data-number="14.4.1" id="description-15">
<h3 data-number="14.4.1"><span class="titlemark"><span class="koboSpan" id="kobo.590.1" xmlns="http://www.w3.org/1999/xhtml">10.4.1 </span></span> <span id="x1-2460001"/><span class="koboSpan" id="kobo.591.1" xmlns="http://www.w3.org/1999/xhtml">Description</span></h3>
<p><span class="koboSpan" id="kobo.592.1" xmlns="http://www.w3.org/1999/xhtml">Creating standardized values is at </span><span id="dx1-246001"/><span class="koboSpan" id="kobo.593.1" xmlns="http://www.w3.org/1999/xhtml">the edge of data cleaning and validation. </span><span class="koboSpan" id="kobo.593.2" xmlns="http://www.w3.org/1999/xhtml">These values can be described as ”derived” values, computed from existing values.</span></p>
<p><span class="koboSpan" id="kobo.594.1" xmlns="http://www.w3.org/1999/xhtml">There are numerous kinds of standardizations; we’ll look at two:</span></p>
<ol>
<li><div id="x1-246003x1">
<p><span class="koboSpan" id="kobo.595.1" xmlns="http://www.w3.org/1999/xhtml">Compute a standardized value, or Z-score, for cardinal data. </span><span class="koboSpan" id="kobo.595.2" xmlns="http://www.w3.org/1999/xhtml">For a normal distribution, the Z-scores have a mean of 0, and a standard deviation of 1. </span><span class="koboSpan" id="kobo.595.3" xmlns="http://www.w3.org/1999/xhtml">It permits comparing values measured on different scales.</span></p>
</div></li>
<li><div id="x1-246005x2">
<p><span class="koboSpan" id="kobo.596.1" xmlns="http://www.w3.org/1999/xhtml">Collapse nominal values into a single standardized value. </span><span class="koboSpan" id="kobo.596.2" xmlns="http://www.w3.org/1999/xhtml">For example, replacing a number of historical product codes with a single, current product code.</span></p>
</div></li>
</ol>
<p><span class="koboSpan" id="kobo.597.1" xmlns="http://www.w3.org/1999/xhtml">The first of these, computing a Z-score, rarely raises questions about the statistical validity of the standardized value. </span><span class="koboSpan" id="kobo.597.2" xmlns="http://www.w3.org/1999/xhtml">The computation, </span><em><span class="koboSpan" id="kobo.598.1" xmlns="http://www.w3.org/1999/xhtml">Z </span></em><span class="koboSpan" id="kobo.599.1" xmlns="http://www.w3.org/1999/xhtml">= </span><span class="koboSpan" id="kobo.600.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="x−σμ-" class="frac" data-align="middle" src="../media/file45.jpg"/></span><span class="koboSpan" id="kobo.601.1" xmlns="http://www.w3.org/1999/xhtml">, is well understood and has known statistical properties.</span></p>
<p><span class="koboSpan" id="kobo.602.1" xmlns="http://www.w3.org/1999/xhtml">The second standardization, replacing nominal values with a standardized code, can be troubling. </span><span class="koboSpan" id="kobo.602.2" xmlns="http://www.w3.org/1999/xhtml">This kind of substitution may simply correct errors in the historical record. </span><span class="koboSpan" id="kobo.602.3" xmlns="http://www.w3.org/1999/xhtml">It may also obscure an important relationship. </span><span class="koboSpan" id="kobo.602.4" xmlns="http://www.w3.org/1999/xhtml">It’s not unusual for a data inspection notebook to reveal outliers or erroneous values in a data set that needs to be standardized.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-176">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.603.1" xmlns="http://www.w3.org/1999/xhtml">Enterprise software may have unrepaired bugs. </span><span class="koboSpan" id="kobo.603.2" xmlns="http://www.w3.org/1999/xhtml">Some business records can have unusual code values that map to other code values.</span></p>
<p><span class="koboSpan" id="kobo.604.1" xmlns="http://www.w3.org/1999/xhtml">Of course, the codes in use may shift over time.</span></p>
<p><span class="koboSpan" id="kobo.605.1" xmlns="http://www.w3.org/1999/xhtml">Some records may have values that reflect two eras: pre-repair and post-repair. </span><span class="koboSpan" id="kobo.605.2" xmlns="http://www.w3.org/1999/xhtml">Worse, of course, there may have been several attempts at a repair, leading to more nuanced timelines.</span></p>
</div>
</div>
<p><span class="koboSpan" id="kobo.606.1" xmlns="http://www.w3.org/1999/xhtml">For this project, we need some relatively simple data. </span><span class="koboSpan" id="kobo.606.2" xmlns="http://www.w3.org/1999/xhtml">The Ancombe’s Quartet data will do nicely as examples from which derived Z-scores can be computed. </span><span class="koboSpan" id="kobo.606.3" xmlns="http://www.w3.org/1999/xhtml">For more information, see </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.607.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.608.1" xmlns="http://www.w3.org/1999/xhtml"> 3</span></em></a><span class="koboSpan" id="kobo.609.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.610.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.1: Data Acquisition Base</span></em> <em><span class="koboSpan" id="kobo.611.1" xmlns="http://www.w3.org/1999/xhtml">Application</span></em></a><span class="koboSpan" id="kobo.612.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.613.1" xmlns="http://www.w3.org/1999/xhtml">The objective is to compute standardized </span><span id="dx1-246006"/><span class="koboSpan" id="kobo.614.1" xmlns="http://www.w3.org/1999/xhtml">values for the two values that comprise the samples in the Anscombe’s Quartet series. </span><span class="koboSpan" id="kobo.614.2" xmlns="http://www.w3.org/1999/xhtml">When the data has a normal distribution, these derived, standardized Z-scores will have a mean of zero and a standard deviation of one. </span><span class="koboSpan" id="kobo.614.3" xmlns="http://www.w3.org/1999/xhtml">When the data does not have a normal distribution, these values will diverge from the expected values. </span><span id="x1-246007r265"/></p>
</section>
<section class="level3" data-number="14.4.2" id="approach-14">
<h3 data-number="14.4.2"><span class="titlemark"><span class="koboSpan" id="kobo.615.1" xmlns="http://www.w3.org/1999/xhtml">10.4.2 </span></span> <span id="x1-2470002"/><span class="koboSpan" id="kobo.616.1" xmlns="http://www.w3.org/1999/xhtml">Approach</span></h3>
<p><span class="koboSpan" id="kobo.617.1" xmlns="http://www.w3.org/1999/xhtml">For reference to the general </span><span id="dx1-247001"/><span class="koboSpan" id="kobo.618.1" xmlns="http://www.w3.org/1999/xhtml">approach to this application, see </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.619.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.620.1" xmlns="http://www.w3.org/1999/xhtml"> 9</span></em></a><span class="koboSpan" id="kobo.621.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.622.1" xmlns="http://www.w3.org/1999/xhtml">Project</span></em> <em><span class="koboSpan" id="kobo.623.1" xmlns="http://www.w3.org/1999/xhtml">3.1: Data Cleaning Base Application</span></em></a><span class="koboSpan" id="kobo.624.1" xmlns="http://www.w3.org/1999/xhtml">, specifically </span><a href="ch013.xhtml#x1-2150002"><em><span class="koboSpan" id="kobo.625.1" xmlns="http://www.w3.org/1999/xhtml">Approach</span></em></a><span class="koboSpan" id="kobo.626.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.627.1" xmlns="http://www.w3.org/1999/xhtml">To replace values with preferred standardized values, we’ve seen how to clean bad data in previous projects. </span><span class="koboSpan" id="kobo.627.2" xmlns="http://www.w3.org/1999/xhtml">See, for example, </span><a href="#x1-2350002"><em><span class="koboSpan" id="kobo.628.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.3: Validate text fields (and</span></em> <em><span class="koboSpan" id="kobo.629.1" xmlns="http://www.w3.org/1999/xhtml">numeric coded fields)</span></em></a><span class="koboSpan" id="kobo.630.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.631.1" xmlns="http://www.w3.org/1999/xhtml">For Z-score standardization, we’ll be computing a derived value. </span><span class="koboSpan" id="kobo.631.2" xmlns="http://www.w3.org/1999/xhtml">This requires knowing the mean, </span><em><span class="koboSpan" id="kobo.632.1" xmlns="http://www.w3.org/1999/xhtml">μ</span></em><span class="koboSpan" id="kobo.633.1" xmlns="http://www.w3.org/1999/xhtml">, and standard deviation, </span><em><span class="koboSpan" id="kobo.634.1" xmlns="http://www.w3.org/1999/xhtml">σ</span></em><span class="koboSpan" id="kobo.635.1" xmlns="http://www.w3.org/1999/xhtml">, for a variable from which the Z-score can be computed.</span></p>
<p><span class="koboSpan" id="kobo.636.1" xmlns="http://www.w3.org/1999/xhtml">This computation of a derived value suggests there are the following two variations on the analytical data model class definitions:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.637.1" xmlns="http://www.w3.org/1999/xhtml">An “initial” version, which lacks the Z-score values. </span><span class="koboSpan" id="kobo.637.2" xmlns="http://www.w3.org/1999/xhtml">These objects are incomplete and require further computation.</span></p></li>
<li><p><span class="koboSpan" id="kobo.638.1" xmlns="http://www.w3.org/1999/xhtml">A “final” version, where the Z-score values have been computed. </span><span class="koboSpan" id="kobo.638.2" xmlns="http://www.w3.org/1999/xhtml">These objects are complete.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.639.1" xmlns="http://www.w3.org/1999/xhtml">There are two common </span><span id="dx1-247002"/><span class="koboSpan" id="kobo.640.1" xmlns="http://www.w3.org/1999/xhtml">approaches to handling this distinction between incomplete and complete objects:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.641.1" xmlns="http://www.w3.org/1999/xhtml">The two classes are distinct. </span><span class="koboSpan" id="kobo.641.2" xmlns="http://www.w3.org/1999/xhtml">The complete version is a subclass of the incomplete version, with additional fields defined.</span></p></li>
<li><p><span class="koboSpan" id="kobo.642.1" xmlns="http://www.w3.org/1999/xhtml">The derived values are marked as optional. </span><span class="koboSpan" id="kobo.642.2" xmlns="http://www.w3.org/1999/xhtml">The incomplete version starts with </span><code><span class="koboSpan" id="kobo.643.1" xmlns="http://www.w3.org/1999/xhtml">None</span></code><span class="koboSpan" id="kobo.644.1" xmlns="http://www.w3.org/1999/xhtml"> values.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.645.1" xmlns="http://www.w3.org/1999/xhtml">The first design is a more conventional object-oriented approach. </span><span class="koboSpan" id="kobo.645.2" xmlns="http://www.w3.org/1999/xhtml">The formality of a distinct type to clearly mark the state of the data is a significant advantage. </span><span class="koboSpan" id="kobo.645.3" xmlns="http://www.w3.org/1999/xhtml">The extra class definition, however, can be seen as clutter, since the incomplete version is transient data that doesn’t create enduring value. </span><span class="koboSpan" id="kobo.645.4" xmlns="http://www.w3.org/1999/xhtml">The incomplete records live long enough to compute the complete version, and the file can then be deleted.</span></p>
<p><span class="koboSpan" id="kobo.646.1" xmlns="http://www.w3.org/1999/xhtml">The second design is sometimes used for functional programming. </span><span class="koboSpan" id="kobo.646.2" xmlns="http://www.w3.org/1999/xhtml">It saves the subclass definition, which can be seen as a slight simplification.</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-177">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.647.1" xmlns="http://www.w3.org/1999/xhtml">from pydantic import BaseModel

class InitialSample(BaseModel):
    x: float
    y: float

class SeriesSample(InitialSample):
    z_x: float
    z_y: float

    @classmethod
    def build_sample(cls, m_x: float, s_x: float,
    m_y: float, s_y: float, init:
      InitialSample)-&gt; "SeriesSample":
        return SeriesSample(
            x=init.x, y=init.y,
            z_x=(init.x - m_x) / s_x,
            z_y=(init.y - m_y) / s_y
        )</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.648.1" xmlns="http://www.w3.org/1999/xhtml">These two class definitions show one </span><span id="dx1-247022"/><span class="koboSpan" id="kobo.649.1" xmlns="http://www.w3.org/1999/xhtml">way to formalize the distinction between the initially cleaned, validated, and converted data, and the complete sample with the standardized Z-scores present for both of the variables.</span></p>
<p><span class="koboSpan" id="kobo.650.1" xmlns="http://www.w3.org/1999/xhtml">This can be handled as three separate operations:</span></p>
<ol>
<li><div id="x1-247024x1">
<p><span class="koboSpan" id="kobo.651.1" xmlns="http://www.w3.org/1999/xhtml">Clean and convert the initial data, writing a temporary file of the </span><code><span class="koboSpan" id="kobo.652.1" xmlns="http://www.w3.org/1999/xhtml">InitialSample</span></code><span class="koboSpan" id="kobo.653.1" xmlns="http://www.w3.org/1999/xhtml"> instances.</span></p>
</div></li>
<li><div id="x1-247026x2">
<p><span class="koboSpan" id="kobo.654.1" xmlns="http://www.w3.org/1999/xhtml">Read the temporary file, computing the means and standard deviations of the variables.</span></p>
</div></li>
<li><div id="x1-247028x3">
<p><span class="koboSpan" id="kobo.655.1" xmlns="http://www.w3.org/1999/xhtml">Read the temporary file again, building the final samples from the </span><code><span class="koboSpan" id="kobo.656.1" xmlns="http://www.w3.org/1999/xhtml">InitialSample</span></code><span class="koboSpan" id="kobo.657.1" xmlns="http://www.w3.org/1999/xhtml"> instances and the computed intermediate values.</span></p>
</div></li>
</ol>
<p><span class="koboSpan" id="kobo.658.1" xmlns="http://www.w3.org/1999/xhtml">A sensible optimization is to combine the first two steps: clean and convert the data, accumulating values that can be used to compute the mean and standard deviation. </span><span class="koboSpan" id="kobo.658.2" xmlns="http://www.w3.org/1999/xhtml">This is helpful because the </span><code><span class="koboSpan" id="kobo.659.1" xmlns="http://www.w3.org/1999/xhtml">statistics</span></code><span class="koboSpan" id="kobo.660.1" xmlns="http://www.w3.org/1999/xhtml"> module expects a sequence of objects that might not fit in memory. </span><span class="koboSpan" id="kobo.660.2" xmlns="http://www.w3.org/1999/xhtml">The mean, which involves a sum and a count, is relatively simple. </span><span class="koboSpan" id="kobo.660.3" xmlns="http://www.w3.org/1999/xhtml">The standard deviation requires accumulating a sum and a sum of squares.</span></p>
<div class="math-display">
<span class="koboSpan" id="kobo.661.1" xmlns="http://www.w3.org/1999/xhtml"><img alt=" ∑ mx = ---x n " class="math-display" src="../media/file46.jpg"/></span>
</div>
<p><span class="koboSpan" id="kobo.662.1" xmlns="http://www.w3.org/1999/xhtml">The mean of </span><em><span class="koboSpan" id="kobo.663.1" xmlns="http://www.w3.org/1999/xhtml">x</span></em><span class="koboSpan" id="kobo.664.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.665.1" xmlns="http://www.w3.org/1999/xhtml">m</span></em><sub><span class="cmmi-8"><span class="koboSpan" id="kobo.666.1" xmlns="http://www.w3.org/1999/xhtml">x</span></span></sub><span class="koboSpan" id="kobo.667.1" xmlns="http://www.w3.org/1999/xhtml">, is the sum of the </span><em><span class="koboSpan" id="kobo.668.1" xmlns="http://www.w3.org/1999/xhtml">x </span></em><span class="koboSpan" id="kobo.669.1" xmlns="http://www.w3.org/1999/xhtml">values divided by the count of </span><em><span class="koboSpan" id="kobo.670.1" xmlns="http://www.w3.org/1999/xhtml">x </span></em><span class="koboSpan" id="kobo.671.1" xmlns="http://www.w3.org/1999/xhtml">values, shown as </span><em><span class="koboSpan" id="kobo.672.1" xmlns="http://www.w3.org/1999/xhtml">n</span></em><span class="koboSpan" id="kobo.673.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<div class="math-display">
<span class="koboSpan" id="kobo.674.1" xmlns="http://www.w3.org/1999/xhtml"><img alt=" ∘ ∑-------(∑-x)2- ---x2 −---n-- sx = n − 1 " class="math-display" src="../media/file47.jpg"/></span>
</div>
<p><span class="koboSpan" id="kobo.675.1" xmlns="http://www.w3.org/1999/xhtml">The standard deviation of </span><em><span class="koboSpan" id="kobo.676.1" xmlns="http://www.w3.org/1999/xhtml">x</span></em><span class="koboSpan" id="kobo.677.1" xmlns="http://www.w3.org/1999/xhtml">, </span><em><span class="koboSpan" id="kobo.678.1" xmlns="http://www.w3.org/1999/xhtml">s</span></em><sub><span class="cmmi-8"><span class="koboSpan" id="kobo.679.1" xmlns="http://www.w3.org/1999/xhtml">x</span></span></sub><span class="koboSpan" id="kobo.680.1" xmlns="http://www.w3.org/1999/xhtml">, uses the sum of </span><em><span class="koboSpan" id="kobo.681.1" xmlns="http://www.w3.org/1999/xhtml">x</span></em><sup><span class="cmr-8"><span class="koboSpan" id="kobo.682.1" xmlns="http://www.w3.org/1999/xhtml">2</span></span></sup><span class="koboSpan" id="kobo.683.1" xmlns="http://www.w3.org/1999/xhtml">, the sum of </span><em><span class="koboSpan" id="kobo.684.1" xmlns="http://www.w3.org/1999/xhtml">x</span></em><span class="koboSpan" id="kobo.685.1" xmlns="http://www.w3.org/1999/xhtml">, and the number of values, </span><em><span class="koboSpan" id="kobo.686.1" xmlns="http://www.w3.org/1999/xhtml">n</span></em><span class="koboSpan" id="kobo.687.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.688.1" xmlns="http://www.w3.org/1999/xhtml">This formula for the standard deviation has some numeric stability issues, and there are variations that are better designs. </span><span class="koboSpan" id="kobo.688.2" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://en.wikipedia.org/wiki/Algorithms_for_calculating_variance"><span class="koboSpan" id="kobo.689.1" xmlns="http://www.w3.org/1999/xhtml">https://en.wikipedia.org/wiki/Algorithms_for_calculating_variance</span></a><span class="koboSpan" id="kobo.690.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.691.1" xmlns="http://www.w3.org/1999/xhtml">We’ll define a class that accumulates the </span><span id="dx1-247029"/><span class="koboSpan" id="kobo.692.1" xmlns="http://www.w3.org/1999/xhtml">values for mean and variance. </span><span class="koboSpan" id="kobo.692.2" xmlns="http://www.w3.org/1999/xhtml">From this, we can compute the standard deviation.</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-178">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.693.1" xmlns="http://www.w3.org/1999/xhtml">import math

class Variance:
    def __init__(self):
        self.k: float | None = None
        self.e_x = 0.0
        self.e_x2 = 0.0
        self.n = 0

    def add(self, x: float) -&gt; None:
        if self.k is None:
            self.k = x
        self.n += 1
        self.e_x += x - self.k
        self.e_x2 += (x - self.k) ** 2

    @property
    def mean(self) -&gt; float:
        return self.k + self.e_x / self.n

    @property
    def variance(self) -&gt; float:
        return (self.e_x2 - self.e_x ** 2 / self.n) / (self.n - 1)

    @property
    def stdev(self) -&gt; float:
        return math.sqrt(self.variance)</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.694.1" xmlns="http://www.w3.org/1999/xhtml">This </span><code><span class="koboSpan" id="kobo.695.1" xmlns="http://www.w3.org/1999/xhtml">variance</span></code><span class="koboSpan" id="kobo.696.1" xmlns="http://www.w3.org/1999/xhtml"> class performs an incremental computation of mean, standard deviation, and variance. </span><span class="koboSpan" id="kobo.696.2" xmlns="http://www.w3.org/1999/xhtml">Each individual </span><span id="dx1-247057"/><span class="koboSpan" id="kobo.697.1" xmlns="http://www.w3.org/1999/xhtml">value is presented by the </span><code><span class="koboSpan" id="kobo.698.1" xmlns="http://www.w3.org/1999/xhtml">add()</span></code><span class="koboSpan" id="kobo.699.1" xmlns="http://www.w3.org/1999/xhtml"> method. </span><span class="koboSpan" id="kobo.699.2" xmlns="http://www.w3.org/1999/xhtml">After all of the data has been presented, the properties can be used to return the summary statistics.</span></p>
<p><span class="koboSpan" id="kobo.700.1" xmlns="http://www.w3.org/1999/xhtml">It’s used as shown in the following snippet:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-179">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.701.1" xmlns="http://www.w3.org/1999/xhtml">var_compute = Variance()
for d in data:
    var_compute.add(d)

print(f"Mean = {var_compute.mean}")
print(f"Standard Deviation = {var_compute.stdev}")</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.702.1" xmlns="http://www.w3.org/1999/xhtml">This provides a way to compute the summary statistics without using a lot of memory. </span><span class="koboSpan" id="kobo.702.2" xmlns="http://www.w3.org/1999/xhtml">It permits the optimization of computing the statistics the first time the data is seen. </span><span class="koboSpan" id="kobo.702.3" xmlns="http://www.w3.org/1999/xhtml">And, it reflects a well-designed algorithm that is numerically stable.</span></p>
<p><span class="koboSpan" id="kobo.703.1" xmlns="http://www.w3.org/1999/xhtml">Now that we’ve explored the technical approach, it’s time to look at the deliverables that must be created for this project. </span><span id="x1-247064r266"/></p>
</section>
<section class="level3" data-number="14.4.3" id="deliverables-15">
<h3 data-number="14.4.3"><span class="titlemark"><span class="koboSpan" id="kobo.704.1" xmlns="http://www.w3.org/1999/xhtml">10.4.3 </span></span> <span id="x1-2480003"/><span class="koboSpan" id="kobo.705.1" xmlns="http://www.w3.org/1999/xhtml">Deliverables</span></h3>
<p><span class="koboSpan" id="kobo.706.1" xmlns="http://www.w3.org/1999/xhtml">This project has </span><span id="dx1-248001"/><span class="koboSpan" id="kobo.707.1" xmlns="http://www.w3.org/1999/xhtml">the following deliverables:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.708.1" xmlns="http://www.w3.org/1999/xhtml">Documentation in the </span><code><span class="koboSpan" id="kobo.709.1" xmlns="http://www.w3.org/1999/xhtml">docs</span></code><span class="koboSpan" id="kobo.710.1" xmlns="http://www.w3.org/1999/xhtml"> folder.</span></p></li>
<li><p><span class="koboSpan" id="kobo.711.1" xmlns="http://www.w3.org/1999/xhtml">Acceptance tests in the </span><code><span class="koboSpan" id="kobo.712.1" xmlns="http://www.w3.org/1999/xhtml">tests/features</span></code><span class="koboSpan" id="kobo.713.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.714.1" xmlns="http://www.w3.org/1999/xhtml">tests/steps</span></code><span class="koboSpan" id="kobo.715.1" xmlns="http://www.w3.org/1999/xhtml"> folders.</span></p></li>
<li><p><span class="koboSpan" id="kobo.716.1" xmlns="http://www.w3.org/1999/xhtml">Unit tests for the application modules in the </span><code><span class="koboSpan" id="kobo.717.1" xmlns="http://www.w3.org/1999/xhtml">tests</span></code><span class="koboSpan" id="kobo.718.1" xmlns="http://www.w3.org/1999/xhtml"> folder.</span></p></li>
<li><p><span class="koboSpan" id="kobo.719.1" xmlns="http://www.w3.org/1999/xhtml">Application to clean the acquired data and compute derived standardized Z-scores.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.720.1" xmlns="http://www.w3.org/1999/xhtml">Many of these deliverables are </span><span id="dx1-248002"/><span class="koboSpan" id="kobo.721.1" xmlns="http://www.w3.org/1999/xhtml">described in previous chapters. </span><span class="koboSpan" id="kobo.721.2" xmlns="http://www.w3.org/1999/xhtml">Specifically, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.722.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.723.1" xmlns="http://www.w3.org/1999/xhtml"> 9</span></em></a><span class="koboSpan" id="kobo.724.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.725.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.1: Data Cleaning Base Application</span></em></a><span class="koboSpan" id="kobo.726.1" xmlns="http://www.w3.org/1999/xhtml"> covers the basics of the deliverables for this project.</span></p>
<section class="level4 likesubsubsectionHead" data-number="14.4.3.1" id="unit-tests-for-standardizing-functions">
<h4 class="likesubsubsectionHead" data-number="14.4.3.1"><span id="x1-2490003"/><span class="koboSpan" id="kobo.727.1" xmlns="http://www.w3.org/1999/xhtml">Unit tests for standardizing functions</span></h4>
<p><span class="koboSpan" id="kobo.728.1" xmlns="http://www.w3.org/1999/xhtml">There are two parts of the standardizing process that require unit tests. </span><span class="koboSpan" id="kobo.728.2" xmlns="http://www.w3.org/1999/xhtml">The first is the incremental computation of mean, variance, and standard deviation. </span><span class="koboSpan" id="kobo.728.3" xmlns="http://www.w3.org/1999/xhtml">This must be compared against results computed by the </span><code><span class="koboSpan" id="kobo.729.1" xmlns="http://www.w3.org/1999/xhtml">statistics</span></code><span class="koboSpan" id="kobo.730.1" xmlns="http://www.w3.org/1999/xhtml"> module to assure that the results are correct. </span><span class="koboSpan" id="kobo.730.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.731.1" xmlns="http://www.w3.org/1999/xhtml">pytest.approx</span></code><span class="koboSpan" id="kobo.732.1" xmlns="http://www.w3.org/1999/xhtml"> object (or the </span><code><span class="koboSpan" id="kobo.733.1" xmlns="http://www.w3.org/1999/xhtml">math.isclose()</span></code><span class="koboSpan" id="kobo.734.1" xmlns="http://www.w3.org/1999/xhtml"> function) are useful for asserting the incremental computation matches the expected values from the standard library module.</span></p>
<p><span class="koboSpan" id="kobo.735.1" xmlns="http://www.w3.org/1999/xhtml">Additionally, of course, the construction of the final sample, including the standardized Z-scores, needs to be tested. </span><span class="koboSpan" id="kobo.735.2" xmlns="http://www.w3.org/1999/xhtml">The test case is generally quite simple: a single value with a given x, y, mean of x, mean of y, the standard deviation of x, and the standard deviation of y need to be converted from the incomplete form to the complete form. </span><span class="koboSpan" id="kobo.735.3" xmlns="http://www.w3.org/1999/xhtml">The computation of the derived values is simple enough that the </span><span id="dx1-249001"/><span class="koboSpan" id="kobo.736.1" xmlns="http://www.w3.org/1999/xhtml">expected results can be computed by hand to check the results.</span></p>
<p><span class="koboSpan" id="kobo.737.1" xmlns="http://www.w3.org/1999/xhtml">It’s important to test this class, even though it seems very simple. </span><span class="koboSpan" id="kobo.737.2" xmlns="http://www.w3.org/1999/xhtml">Experience suggests that these seemingly simple classes are places where a </span><code><span class="koboSpan" id="kobo.738.1" xmlns="http://www.w3.org/1999/xhtml">+</span></code><span class="koboSpan" id="kobo.739.1" xmlns="http://www.w3.org/1999/xhtml"> replaces a </span><code><span class="koboSpan" id="kobo.740.1" xmlns="http://www.w3.org/1999/xhtml">-</span></code><span class="koboSpan" id="kobo.741.1" xmlns="http://www.w3.org/1999/xhtml"> and the distinction isn’t noticed by people inspecting the code. </span><span class="koboSpan" id="kobo.741.2" xmlns="http://www.w3.org/1999/xhtml">This kind of small mistake is best found with a unit test.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="14.4.3.2" id="acceptance-test">
<h4 class="likesubsubsectionHead" data-number="14.4.3.2"><span id="x1-2500003"/><span class="koboSpan" id="kobo.742.1" xmlns="http://www.w3.org/1999/xhtml">Acceptance test</span></h4>
<p><span class="koboSpan" id="kobo.743.1" xmlns="http://www.w3.org/1999/xhtml">The acceptance test suite for this standardization processing will involve a main program that creates two output files. </span><span class="koboSpan" id="kobo.743.2" xmlns="http://www.w3.org/1999/xhtml">This suggests </span><span id="dx1-250001"/><span class="koboSpan" id="kobo.744.1" xmlns="http://www.w3.org/1999/xhtml">the after-scenario cleanup needs to ensure the intermediate file is properly removed by the application.</span></p>
<p><span class="koboSpan" id="kobo.745.1" xmlns="http://www.w3.org/1999/xhtml">The cleaning application could use the </span><code><span class="koboSpan" id="kobo.746.1" xmlns="http://www.w3.org/1999/xhtml">tempfile</span></code><span class="koboSpan" id="kobo.747.1" xmlns="http://www.w3.org/1999/xhtml"> module to create a file that will be deleted when closed. </span><span class="koboSpan" id="kobo.747.2" xmlns="http://www.w3.org/1999/xhtml">This is quite reliable, but it can be difficult to debug very obscure problems if the file that reveals the problems is automatically deleted. </span><span class="koboSpan" id="kobo.747.3" xmlns="http://www.w3.org/1999/xhtml">This doesn’t require any additional acceptance test Then step to be sure the file is removed, since we don’t need to test the </span><code><span class="koboSpan" id="kobo.748.1" xmlns="http://www.w3.org/1999/xhtml">tempfile</span></code><span class="koboSpan" id="kobo.749.1" xmlns="http://www.w3.org/1999/xhtml"> module.</span></p>
<p><span class="koboSpan" id="kobo.750.1" xmlns="http://www.w3.org/1999/xhtml">The cleaning application can also create a temporary file in the current working directory. </span><span class="koboSpan" id="kobo.750.2" xmlns="http://www.w3.org/1999/xhtml">This can be unlinked for normal operation, but left in place for debugging purposes. </span><span class="koboSpan" id="kobo.750.3" xmlns="http://www.w3.org/1999/xhtml">This will require at least two scenarios to be </span><span id="dx1-250002"/><span class="koboSpan" id="kobo.751.1" xmlns="http://www.w3.org/1999/xhtml">sure the file is removed normally, and be sure the file is retained to support debugging.</span></p>
<p><span class="koboSpan" id="kobo.752.1" xmlns="http://www.w3.org/1999/xhtml">The final choice of implementation — and the related test scenarios — is left to you. </span><span id="x1-250003r264"/></p>
</section>
</section>
</section>
<section class="level2" data-number="14.5" id="project-3.6-integration-to-create-an-acquisition-pipeline">
<h2 data-number="14.5"><span class="titlemark"><span class="koboSpan" id="kobo.753.1" xmlns="http://www.w3.org/1999/xhtml">10.5 </span></span> <span id="x1-2510005"/><span class="koboSpan" id="kobo.754.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.6: Integration to create an acquisition pipeline</span></h2>
<p><span class="koboSpan" id="kobo.755.1" xmlns="http://www.w3.org/1999/xhtml">In </span><a href="ch013.xhtml#x1-2100001"><em><span class="koboSpan" id="kobo.756.1" xmlns="http://www.w3.org/1999/xhtml">User experience</span></em></a><span class="koboSpan" id="kobo.757.1" xmlns="http://www.w3.org/1999/xhtml">, we looked at the two-step user experience. </span><span class="koboSpan" id="kobo.757.2" xmlns="http://www.w3.org/1999/xhtml">One command is used to acquire data. </span><span class="koboSpan" id="kobo.757.3" xmlns="http://www.w3.org/1999/xhtml">After this, a second command is </span><span id="dx1-251001"/><span class="koboSpan" id="kobo.758.1" xmlns="http://www.w3.org/1999/xhtml">used to clean the data. </span><span class="koboSpan" id="kobo.758.2" xmlns="http://www.w3.org/1999/xhtml">An alternative user experience is a single shell pipeline. </span><span id="x1-251002r267"/></p>
<section class="level3" data-number="14.5.1" id="description-16">
<h3 data-number="14.5.1"><span class="titlemark"><span class="koboSpan" id="kobo.759.1" xmlns="http://www.w3.org/1999/xhtml">10.5.1 </span></span> <span id="x1-2520001"/><span class="koboSpan" id="kobo.760.1" xmlns="http://www.w3.org/1999/xhtml">Description</span></h3>
<p><span class="koboSpan" id="kobo.761.1" xmlns="http://www.w3.org/1999/xhtml">The previous projects in this chapter have decomposed the cleaning </span><span id="dx1-252001"/><span class="koboSpan" id="kobo.762.1" xmlns="http://www.w3.org/1999/xhtml">operation into two distinct steps. </span><span class="koboSpan" id="kobo.762.2" xmlns="http://www.w3.org/1999/xhtml">There’s another, very desirable user experience alternative.</span></p>
<p><span class="koboSpan" id="kobo.763.1" xmlns="http://www.w3.org/1999/xhtml">Specifically, we’d like the following to work, also:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-180">
<div class="tcolorbox-content">
<pre class="console"><span class="koboSpan" id="kobo.764.1" xmlns="http://www.w3.org/1999/xhtml">% python src/acquire.py -s Series_1Pair --csv source.csv | python src/clean.py -o analysis/Series_1.ndjson</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.765.1" xmlns="http://www.w3.org/1999/xhtml">The idea is to have the </span><strong><span class="koboSpan" id="kobo.766.1" xmlns="http://www.w3.org/1999/xhtml">acquire </span></strong><span class="koboSpan" id="kobo.767.1" xmlns="http://www.w3.org/1999/xhtml">application write a sequence of NDJSON objects to standard output. </span><span class="koboSpan" id="kobo.767.2" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.768.1" xmlns="http://www.w3.org/1999/xhtml">clean </span></strong><span class="koboSpan" id="kobo.769.1" xmlns="http://www.w3.org/1999/xhtml">application will read the sequence of NDJSON objects from standard input. </span><span class="koboSpan" id="kobo.769.2" xmlns="http://www.w3.org/1999/xhtml">The two applications will run concurrently, passing data from process to process.</span></p>
<p><span class="koboSpan" id="kobo.770.1" xmlns="http://www.w3.org/1999/xhtml">For very large data sets, this can reduce the processing time. </span><span class="koboSpan" id="kobo.770.2" xmlns="http://www.w3.org/1999/xhtml">Because of the overhead in serializing Python objects to JSON text and deserializing Python objects from the text, the pipeline will not run in half the time of the two steps executed serially.</span></p>
<section class="level4 likesubsubsectionHead" data-number="14.5.1.1" id="multiple-extractions">
<h4 class="likesubsubsectionHead" data-number="14.5.1.1"><span id="x1-2530001"/><span class="koboSpan" id="kobo.771.1" xmlns="http://www.w3.org/1999/xhtml">Multiple extractions</span></h4>
<p><span class="koboSpan" id="kobo.772.1" xmlns="http://www.w3.org/1999/xhtml">In the case of CSV extraction of Anscombe Quartet data, we have an </span><strong><span class="koboSpan" id="kobo.773.1" xmlns="http://www.w3.org/1999/xhtml">acquire</span></strong><span class="koboSpan" id="kobo.774.1" xmlns="http://www.w3.org/1999/xhtml"> application that’s capable of creating </span><span id="dx1-253001"/><span class="koboSpan" id="kobo.775.1" xmlns="http://www.w3.org/1999/xhtml">four files concurrently. </span><span class="koboSpan" id="kobo.775.2" xmlns="http://www.w3.org/1999/xhtml">This doesn’t fit well with the shell pipeline. </span><span class="koboSpan" id="kobo.775.3" xmlns="http://www.w3.org/1999/xhtml">We have two architectural choices for handling this.</span></p>
<p><span class="koboSpan" id="kobo.776.1" xmlns="http://www.w3.org/1999/xhtml">One choice is to implement a ”fan-out” operation: the </span><strong><span class="koboSpan" id="kobo.777.1" xmlns="http://www.w3.org/1999/xhtml">acquire </span></strong><span class="koboSpan" id="kobo.778.1" xmlns="http://www.w3.org/1999/xhtml">program fans out data to four separate clean applications. </span><span class="koboSpan" id="kobo.778.2" xmlns="http://www.w3.org/1999/xhtml">This is difficult to express as a collection of shell pipelines. </span><span class="koboSpan" id="kobo.778.3" xmlns="http://www.w3.org/1999/xhtml">To implement this, a parent application uses </span><code><span class="koboSpan" id="kobo.779.1" xmlns="http://www.w3.org/1999/xhtml">concurrent.futures</span></code><span class="koboSpan" id="kobo.780.1" xmlns="http://www.w3.org/1999/xhtml">, queues, and processing pools. </span><span class="koboSpan" id="kobo.780.2" xmlns="http://www.w3.org/1999/xhtml">Additionally, the </span><strong><span class="koboSpan" id="kobo.781.1" xmlns="http://www.w3.org/1999/xhtml">acquire</span></strong><span class="koboSpan" id="kobo.782.1" xmlns="http://www.w3.org/1999/xhtml"> program would need to write to shared queue objects, and the </span><strong><span class="koboSpan" id="kobo.783.1" xmlns="http://www.w3.org/1999/xhtml">clean </span></strong><span class="koboSpan" id="kobo.784.1" xmlns="http://www.w3.org/1999/xhtml">program would read from a shared queue.</span></p>
<p><span class="koboSpan" id="kobo.785.1" xmlns="http://www.w3.org/1999/xhtml">The alternative is to process only one of the Anscombe series at a time. </span><span class="koboSpan" id="kobo.785.2" xmlns="http://www.w3.org/1999/xhtml">Introducing a </span><code><span class="koboSpan" id="kobo.786.1" xmlns="http://www.w3.org/1999/xhtml">-s</span></code><code><span class="koboSpan" id="kobo.787.1" xmlns="http://www.w3.org/1999/xhtml"> Series_1Pair</span></code><span class="koboSpan" id="kobo.788.1" xmlns="http://www.w3.org/1999/xhtml"> argument lets the user name a class that can extract a single series from the source data. </span><span class="koboSpan" id="kobo.788.2" xmlns="http://www.w3.org/1999/xhtml">Processing a single series at a time permits a pipeline that can be readily described as a shell command.</span></p>
<p><span class="koboSpan" id="kobo.789.1" xmlns="http://www.w3.org/1999/xhtml">This concept is often necessary to disentangle enterprise data. </span><span class="koboSpan" id="kobo.789.2" xmlns="http://www.w3.org/1999/xhtml">It’s common for enterprise applications — which often evolve organically — to have values from distinct problem domains as parts of a common record.</span></p>
<p><span class="koboSpan" id="kobo.790.1" xmlns="http://www.w3.org/1999/xhtml">We’ll turn to the technical approach in the next section. </span><span id="x1-253002r271"/></p>
</section>
</section>
<section class="level3" data-number="14.5.2" id="approach-15">
<h3 data-number="14.5.2"><span class="titlemark"><span class="koboSpan" id="kobo.791.1" xmlns="http://www.w3.org/1999/xhtml">10.5.2 </span></span> <span id="x1-2540002"/><span class="koboSpan" id="kobo.792.1" xmlns="http://www.w3.org/1999/xhtml">Approach</span></h3>
<p><span class="koboSpan" id="kobo.793.1" xmlns="http://www.w3.org/1999/xhtml">For reference to the general </span><span id="dx1-254001"/><span class="koboSpan" id="kobo.794.1" xmlns="http://www.w3.org/1999/xhtml">approach to this application, see </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.795.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.796.1" xmlns="http://www.w3.org/1999/xhtml"> 9</span></em></a><span class="koboSpan" id="kobo.797.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.798.1" xmlns="http://www.w3.org/1999/xhtml">Project</span></em> <em><span class="koboSpan" id="kobo.799.1" xmlns="http://www.w3.org/1999/xhtml">3.1: Data Cleaning Base Application</span></em></a><span class="koboSpan" id="kobo.800.1" xmlns="http://www.w3.org/1999/xhtml">, specifically </span><a href="ch013.xhtml#x1-2150002"><em><span class="koboSpan" id="kobo.801.1" xmlns="http://www.w3.org/1999/xhtml">Approach</span></em></a><span class="koboSpan" id="kobo.802.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.803.1" xmlns="http://www.w3.org/1999/xhtml">Writing the standard output (and reading from standard input) suggests that these applications will have two distinct operating modes:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.804.1" xmlns="http://www.w3.org/1999/xhtml">Opening a named file for output or input.</span></p></li>
<li><p><span class="koboSpan" id="kobo.805.1" xmlns="http://www.w3.org/1999/xhtml">Using an existing, open, unnamed file — often a pipe created by the shell — for output or input.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.806.1" xmlns="http://www.w3.org/1999/xhtml">This suggests that the bulk of the design for an application needs to focus on open file-like objects. </span><span class="koboSpan" id="kobo.806.2" xmlns="http://www.w3.org/1999/xhtml">These are often described by the type hint of </span><code><span class="koboSpan" id="kobo.807.1" xmlns="http://www.w3.org/1999/xhtml">TextIO</span></code><span class="koboSpan" id="kobo.808.1" xmlns="http://www.w3.org/1999/xhtml">: they are files that can read (or write) text.</span></p>
<p><span class="koboSpan" id="kobo.809.1" xmlns="http://www.w3.org/1999/xhtml">The top-level </span><code><span class="koboSpan" id="kobo.810.1" xmlns="http://www.w3.org/1999/xhtml">main()</span></code><span class="koboSpan" id="kobo.811.1" xmlns="http://www.w3.org/1999/xhtml"> function must be designed either to open a named file, or to provide </span><code><span class="koboSpan" id="kobo.812.1" xmlns="http://www.w3.org/1999/xhtml">sys.stdout</span></code><span class="koboSpan" id="kobo.813.1" xmlns="http://www.w3.org/1999/xhtml"> or </span><code><span class="koboSpan" id="kobo.814.1" xmlns="http://www.w3.org/1999/xhtml">sys.stdin</span></code><span class="koboSpan" id="kobo.815.1" xmlns="http://www.w3.org/1999/xhtml"> as argument values. </span><span class="koboSpan" id="kobo.815.2" xmlns="http://www.w3.org/1999/xhtml">The various combinations of files are provided to a function that will do the more useful work.</span></p>
<p><span class="koboSpan" id="kobo.816.1" xmlns="http://www.w3.org/1999/xhtml">This pattern looks like the following snippet:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-181">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.817.1" xmlns="http://www.w3.org/1999/xhtml">if options.output:
    with options.output.open(’w’) as output:
        process(options.source, output)
else:
    process(options.source, sys.stdout)</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.818.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.819.1" xmlns="http://www.w3.org/1999/xhtml">process()</span></code><span class="koboSpan" id="kobo.820.1" xmlns="http://www.w3.org/1999/xhtml"> function is either </span><span id="dx1-254007"/><span class="koboSpan" id="kobo.821.1" xmlns="http://www.w3.org/1999/xhtml">given a file opened by a context manager, or the function is given the already open </span><code><span class="koboSpan" id="kobo.822.1" xmlns="http://www.w3.org/1999/xhtml">sys.stdout</span></code><span class="koboSpan" id="kobo.823.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-182">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.824.1" xmlns="http://www.w3.org/1999/xhtml">The ability for a Python application to be part of a shell pipeline is a significant help in creating larger, more sophisticated composite processes. </span><span class="koboSpan" id="kobo.824.2" xmlns="http://www.w3.org/1999/xhtml">This higher-level design effort is sometimes called “Programming In The Large.”</span></p>
<p><span class="koboSpan" id="kobo.825.1" xmlns="http://www.w3.org/1999/xhtml">Being able to read and write from pipelines was a core design feature of the Unix operating system and continues to be central to all of the various GNU/Linux variants.</span></p>
</div>
</div>
<p><span class="koboSpan" id="kobo.826.1" xmlns="http://www.w3.org/1999/xhtml">This pipeline-aware design has the advantage of being slightly easier to unit test. </span><span class="koboSpan" id="kobo.826.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.827.1" xmlns="http://www.w3.org/1999/xhtml">process()</span></code><span class="koboSpan" id="kobo.828.1" xmlns="http://www.w3.org/1999/xhtml"> function’s output argument value can be an </span><code><span class="koboSpan" id="kobo.829.1" xmlns="http://www.w3.org/1999/xhtml">io.StringIO</span></code><span class="koboSpan" id="kobo.830.1" xmlns="http://www.w3.org/1999/xhtml"> object. </span><span class="koboSpan" id="kobo.830.2" xmlns="http://www.w3.org/1999/xhtml">When using a </span><code><span class="koboSpan" id="kobo.831.1" xmlns="http://www.w3.org/1999/xhtml">StringIO</span></code><span class="koboSpan" id="kobo.832.1" xmlns="http://www.w3.org/1999/xhtml"> object, the file processing is simulated entirely in memory, leading to faster, and possibly simpler, tests.</span></p>
<p><span class="koboSpan" id="kobo.833.1" xmlns="http://www.w3.org/1999/xhtml">This project sets the stage for a future project. </span><span class="koboSpan" id="kobo.833.2" xmlns="http://www.w3.org/1999/xhtml">See </span><a href="ch016.xhtml#x1-27600012"><em><span class="koboSpan" id="kobo.834.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.835.1" xmlns="http://www.w3.org/1999/xhtml"> 12</span></em></a><span class="koboSpan" id="kobo.836.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch016.xhtml#x1-27600012"><em><span class="koboSpan" id="kobo.837.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.8:</span></em> <em><span class="koboSpan" id="kobo.838.1" xmlns="http://www.w3.org/1999/xhtml">Integrated Data Acquisition Web Service</span></em></a><span class="koboSpan" id="kobo.839.1" xmlns="http://www.w3.org/1999/xhtml"> for a web service that can leverage this pipeline.</span></p>
<section class="level4 likesubsubsectionHead" data-number="14.5.2.1" id="consider-packages-to-help-create-a-pipeline">
<h4 class="likesubsubsectionHead" data-number="14.5.2.1"><span id="x1-2550002"/><span class="koboSpan" id="kobo.840.1" xmlns="http://www.w3.org/1999/xhtml">Consider packages to help create a pipeline</span></h4>
<p><span class="koboSpan" id="kobo.841.1" xmlns="http://www.w3.org/1999/xhtml">A Python application to create a shell pipeline can involve a fair amount of programming to create two subprocesses that </span><span id="dx1-255001"/><span class="koboSpan" id="kobo.842.1" xmlns="http://www.w3.org/1999/xhtml">share a common buffer. </span><span class="koboSpan" id="kobo.842.2" xmlns="http://www.w3.org/1999/xhtml">This is handled elegantly by the shell.</span></p>
<p><span class="koboSpan" id="kobo.843.1" xmlns="http://www.w3.org/1999/xhtml">An alternative is </span><a class="url" href="https://cgarciae.github.io/pypeln/"><span class="koboSpan" id="kobo.844.1" xmlns="http://www.w3.org/1999/xhtml">https://cgarciae.github.io/pypeln/</span></a><span class="koboSpan" id="kobo.845.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.845.2" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.846.1" xmlns="http://www.w3.org/1999/xhtml">PypeLn</span></strong><span class="koboSpan" id="kobo.847.1" xmlns="http://www.w3.org/1999/xhtml"> package is an example of a package that wraps the </span><code><span class="koboSpan" id="kobo.848.1" xmlns="http://www.w3.org/1999/xhtml">subprocess</span></code><span class="koboSpan" id="kobo.849.1" xmlns="http://www.w3.org/1999/xhtml"> module to make it easier for a parent application to create a pipeline that executes the two child applications: </span><strong><span class="koboSpan" id="kobo.850.1" xmlns="http://www.w3.org/1999/xhtml">acquire </span></strong><span class="koboSpan" id="kobo.851.1" xmlns="http://www.w3.org/1999/xhtml">and </span><strong><span class="koboSpan" id="kobo.852.1" xmlns="http://www.w3.org/1999/xhtml">clean</span></strong><span class="koboSpan" id="kobo.853.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.854.1" xmlns="http://www.w3.org/1999/xhtml">Using a higher-level Python application to start the acquire-to-clean pipeline avoids the potential pitfalls of shell programming. </span><span class="koboSpan" id="kobo.854.2" xmlns="http://www.w3.org/1999/xhtml">It permits Python programs with excellent logging and debugging capabilities.</span></p>
<p><span class="koboSpan" id="kobo.855.1" xmlns="http://www.w3.org/1999/xhtml">Now that we’ve seen the technical approach, it’s appropriate to review the deliverables. </span><span id="x1-255002r273"/></p>
</section>
</section>
<section class="level3" data-number="14.5.3" id="deliverables-16">
<h3 data-number="14.5.3"><span class="titlemark"><span class="koboSpan" id="kobo.856.1" xmlns="http://www.w3.org/1999/xhtml">10.5.3 </span></span> <span id="x1-2560003"/><span class="koboSpan" id="kobo.857.1" xmlns="http://www.w3.org/1999/xhtml">Deliverables</span></h3>
<p><span class="koboSpan" id="kobo.858.1" xmlns="http://www.w3.org/1999/xhtml">This project </span><span id="dx1-256001"/><span class="koboSpan" id="kobo.859.1" xmlns="http://www.w3.org/1999/xhtml">has the following deliverables:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.860.1" xmlns="http://www.w3.org/1999/xhtml">Documentation in the </span><code><span class="koboSpan" id="kobo.861.1" xmlns="http://www.w3.org/1999/xhtml">docs</span></code><span class="koboSpan" id="kobo.862.1" xmlns="http://www.w3.org/1999/xhtml"> folder.</span></p></li>
<li><p><span class="koboSpan" id="kobo.863.1" xmlns="http://www.w3.org/1999/xhtml">Acceptance tests in the </span><code><span class="koboSpan" id="kobo.864.1" xmlns="http://www.w3.org/1999/xhtml">tests/features</span></code><span class="koboSpan" id="kobo.865.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.866.1" xmlns="http://www.w3.org/1999/xhtml">tests/steps</span></code><span class="koboSpan" id="kobo.867.1" xmlns="http://www.w3.org/1999/xhtml"> folders.</span></p></li>
<li><p><span class="koboSpan" id="kobo.868.1" xmlns="http://www.w3.org/1999/xhtml">Unit tests for the application modules in the </span><code><span class="koboSpan" id="kobo.869.1" xmlns="http://www.w3.org/1999/xhtml">tests</span></code><span class="koboSpan" id="kobo.870.1" xmlns="http://www.w3.org/1999/xhtml"> folder.</span></p></li>
<li><p><span class="koboSpan" id="kobo.871.1" xmlns="http://www.w3.org/1999/xhtml">Revised applications that can be processed as a pipeline of two concurrent processes.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.872.1" xmlns="http://www.w3.org/1999/xhtml">Many of these deliverables are described in previous chapters. </span><span class="koboSpan" id="kobo.872.2" xmlns="http://www.w3.org/1999/xhtml">Specifically, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.873.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.874.1" xmlns="http://www.w3.org/1999/xhtml"> 9</span></em></a><span class="koboSpan" id="kobo.875.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.876.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.1: Data Cleaning Base Application</span></em></a><span class="koboSpan" id="kobo.877.1" xmlns="http://www.w3.org/1999/xhtml"> covers the basics of the deliverables for this project.</span></p>
<section class="level4 likesubsubsectionHead" data-number="14.5.3.1" id="acceptance-test-1">
<h4 class="likesubsubsectionHead" data-number="14.5.3.1"><span id="x1-2570003"/><span class="koboSpan" id="kobo.878.1" xmlns="http://www.w3.org/1999/xhtml">Acceptance test</span></h4>
<p><span class="koboSpan" id="kobo.879.1" xmlns="http://www.w3.org/1999/xhtml">The acceptance test suite </span><span id="dx1-257001"/><span class="koboSpan" id="kobo.880.1" xmlns="http://www.w3.org/1999/xhtml">needs to confirm the two applications can be used as stand-alone commands, as well as used in a pipeline. </span><span class="koboSpan" id="kobo.880.2" xmlns="http://www.w3.org/1999/xhtml">One technique for confirming the pipeline behavior is to use shell programs like </span><code><span class="koboSpan" id="kobo.881.1" xmlns="http://www.w3.org/1999/xhtml">cat</span></code><span class="koboSpan" id="kobo.882.1" xmlns="http://www.w3.org/1999/xhtml"> to provide input that mocks the input from another application.</span></p>
<p><span class="koboSpan" id="kobo.883.1" xmlns="http://www.w3.org/1999/xhtml">For example, the </span><code><span class="koboSpan" id="kobo.884.1" xmlns="http://www.w3.org/1999/xhtml">When</span></code><span class="koboSpan" id="kobo.885.1" xmlns="http://www.w3.org/1999/xhtml"> step may execute the following kind of command:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-183">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.886.1" xmlns="http://www.w3.org/1999/xhtml">cat some_mock_file.ndj | python src/clean.py -o analysis/some_file.ndj</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.887.1" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.888.1" xmlns="http://www.w3.org/1999/xhtml">clean </span></strong><span class="koboSpan" id="kobo.889.1" xmlns="http://www.w3.org/1999/xhtml">application is executed in a context where it is part of an overall pipeline. </span><span class="koboSpan" id="kobo.889.2" xmlns="http://www.w3.org/1999/xhtml">The head of the pipeline is not the </span><strong><span class="koboSpan" id="kobo.890.1" xmlns="http://www.w3.org/1999/xhtml">acquire </span></strong><span class="koboSpan" id="kobo.891.1" xmlns="http://www.w3.org/1999/xhtml">application; we’ve used the </span><code><span class="koboSpan" id="kobo.892.1" xmlns="http://www.w3.org/1999/xhtml">cat</span></code><code><span class="koboSpan" id="kobo.893.1" xmlns="http://www.w3.org/1999/xhtml"> some_mock_file.ndj</span></code><span class="koboSpan" id="kobo.894.1" xmlns="http://www.w3.org/1999/xhtml"> command as a useful </span><span id="dx1-257003"/><span class="koboSpan" id="kobo.895.1" xmlns="http://www.w3.org/1999/xhtml">mock for the other application’s output. </span><span class="koboSpan" id="kobo.895.2" xmlns="http://www.w3.org/1999/xhtml">This technique permits a lot of flexibility to test applications in a variety of shell contexts.</span></p>
<p><span class="koboSpan" id="kobo.896.1" xmlns="http://www.w3.org/1999/xhtml">Using a pipeline can permit some helpful debugging because it disentangles two complicated programs into two smaller programs. </span><span class="koboSpan" id="kobo.896.2" xmlns="http://www.w3.org/1999/xhtml">The programs can be built, tested, and debugged in isolation. </span><span id="x1-257004r270"/></p>
</section>
</section>
</section>
<section class="level2" data-number="14.6" id="summary-9">
<h2 data-number="14.6"><span class="titlemark"><span class="koboSpan" id="kobo.897.1" xmlns="http://www.w3.org/1999/xhtml">10.6 </span></span> <span id="x1-2580006"/><span class="koboSpan" id="kobo.898.1" xmlns="http://www.w3.org/1999/xhtml">Summary</span></h2>
<p><span class="koboSpan" id="kobo.899.1" xmlns="http://www.w3.org/1999/xhtml">This chapter expanded in several ways on the project in </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.900.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.901.1" xmlns="http://www.w3.org/1999/xhtml"> 9</span></em></a><span class="koboSpan" id="kobo.902.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.903.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.1:</span></em> <em><span class="koboSpan" id="kobo.904.1" xmlns="http://www.w3.org/1999/xhtml">Data Cleaning Base Application</span></em></a><span class="koboSpan" id="kobo.905.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.905.2" xmlns="http://www.w3.org/1999/xhtml">The following additional processing features were added:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.906.1" xmlns="http://www.w3.org/1999/xhtml">Pythonic approaches to validation and conversion of cardinal values.</span></p></li>
<li><p><span class="koboSpan" id="kobo.907.1" xmlns="http://www.w3.org/1999/xhtml">Approaches to validation and conversion of nominal and ordinal values.</span></p></li>
<li><p><span class="koboSpan" id="kobo.908.1" xmlns="http://www.w3.org/1999/xhtml">Techniques for uncovering key relationships and validating data that must properly reference a foreign key.</span></p></li>
<li><p><span class="koboSpan" id="kobo.909.1" xmlns="http://www.w3.org/1999/xhtml">Pipeline architectures using the shell pipeline.</span></p></li>
</ul>
<p><span id="x1-258001r277"/></p>
</section>
<section class="level2" data-number="14.7" id="extras-8">
<h2 data-number="14.7"><span class="titlemark"><span class="koboSpan" id="kobo.910.1" xmlns="http://www.w3.org/1999/xhtml">10.7 </span></span> <span id="x1-2590007"/><span class="koboSpan" id="kobo.911.1" xmlns="http://www.w3.org/1999/xhtml">Extras</span></h2>
<p><span class="koboSpan" id="kobo.912.1" xmlns="http://www.w3.org/1999/xhtml">Here are some ideas for you to add to these projects. </span><span id="x1-259001r275"/></p>
<section class="level3" data-number="14.7.1" id="hypothesis-testing">
<h3 data-number="14.7.1"><span class="titlemark"><span class="koboSpan" id="kobo.913.1" xmlns="http://www.w3.org/1999/xhtml">10.7.1 </span></span> <span id="x1-2600001"/><span class="koboSpan" id="kobo.914.1" xmlns="http://www.w3.org/1999/xhtml">Hypothesis testing</span></h3>
<p><span class="koboSpan" id="kobo.915.1" xmlns="http://www.w3.org/1999/xhtml">The computations for mean, variance, standard deviation, and standardized Z-scores involve floating-point values. </span><span class="koboSpan" id="kobo.915.2" xmlns="http://www.w3.org/1999/xhtml">In some cases, the ordinary truncation errors of float values can introduce significant numeric instability. </span><span class="koboSpan" id="kobo.915.3" xmlns="http://www.w3.org/1999/xhtml">For the most part, the choice of a proper algorithm can ensure results are useful.</span></p>
<p><span class="koboSpan" id="kobo.916.1" xmlns="http://www.w3.org/1999/xhtml">In addition to basic algorithm design, additional testing is sometimes helpful. </span><span class="koboSpan" id="kobo.916.2" xmlns="http://www.w3.org/1999/xhtml">For numeric algorithms, the </span><strong><span class="koboSpan" id="kobo.917.1" xmlns="http://www.w3.org/1999/xhtml">Hypothesis </span></strong><span class="koboSpan" id="kobo.918.1" xmlns="http://www.w3.org/1999/xhtml">package is particularly helpful. </span><span class="koboSpan" id="kobo.918.2" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://hypothesis.readthedocs.io/en/latest/"><span class="koboSpan" id="kobo.919.1" xmlns="http://www.w3.org/1999/xhtml">https://hypothesis.readthedocs.io/en/latest/</span></a><span class="koboSpan" id="kobo.920.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.921.1" xmlns="http://www.w3.org/1999/xhtml">Looking specifically at </span><a href="#x1-2450004"><em><span class="koboSpan" id="kobo.922.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.5: Standardize data to common codes and</span></em> <em><span class="koboSpan" id="kobo.923.1" xmlns="http://www.w3.org/1999/xhtml">ranges</span></em></a><span class="koboSpan" id="kobo.924.1" xmlns="http://www.w3.org/1999/xhtml">, the </span><a href="#x1-2470002"><em><span class="koboSpan" id="kobo.925.1" xmlns="http://www.w3.org/1999/xhtml">Approach</span></em></a><span class="koboSpan" id="kobo.926.1" xmlns="http://www.w3.org/1999/xhtml"> section suggests a way to compute the variance. </span><span class="koboSpan" id="kobo.926.2" xmlns="http://www.w3.org/1999/xhtml">This class definition is an excellent example of a design that can be tested effectively by the Hypothesis module to confirm that the results of providing a sequence of three known values produces the expected results for the count, sum, mean, variance, and standard deviation. </span><span id="x1-260001r279"/></p>
</section>
<section class="level3" data-number="14.7.2" id="rejecting-bad-data-via-filtering-instead-of-logging">
<h3 data-number="14.7.2"><span class="titlemark"><span class="koboSpan" id="kobo.927.1" xmlns="http://www.w3.org/1999/xhtml">10.7.2 </span></span> <span id="x1-2610002"/><span class="koboSpan" id="kobo.928.1" xmlns="http://www.w3.org/1999/xhtml">Rejecting bad data via filtering (instead of logging)</span></h3>
<p><span class="koboSpan" id="kobo.929.1" xmlns="http://www.w3.org/1999/xhtml">In the examples throughout this chapter, there’s been no in-depth mention of what to do with data that raises an exception because it cannot be processed. </span><span class="koboSpan" id="kobo.929.2" xmlns="http://www.w3.org/1999/xhtml">There are three common choices:</span></p>
<ol>
<li><div id="x1-261002x1">
<p><span class="koboSpan" id="kobo.930.1" xmlns="http://www.w3.org/1999/xhtml">Allow the exception to stop processing.</span></p>
</div></li>
<li><div id="x1-261004x2">
<p><span class="koboSpan" id="kobo.931.1" xmlns="http://www.w3.org/1999/xhtml">Log each problem row as it is encountered, discarding it from the output.</span></p>
</div></li>
<li><div id="x1-261006x3">
<p><span class="koboSpan" id="kobo.932.1" xmlns="http://www.w3.org/1999/xhtml">Write the faulty data to a separate output file so it can be examined with a data inspection notebook.</span></p>
</div></li>
</ol>
<p><span class="koboSpan" id="kobo.933.1" xmlns="http://www.w3.org/1999/xhtml">The first option is rather drastic. </span><span class="koboSpan" id="kobo.933.2" xmlns="http://www.w3.org/1999/xhtml">This is useful in some data cleaning applications where there’s a reasonable expectation of very clean, properly curated data. </span><span class="koboSpan" id="kobo.933.3" xmlns="http://www.w3.org/1999/xhtml">In some enterprise applications, this is a sensible assumption, and invalid data is the cause for crashing the application and sorting out the problems.</span></p>
<p><span class="koboSpan" id="kobo.934.1" xmlns="http://www.w3.org/1999/xhtml">The second option has the advantage of simplicity. </span><span class="koboSpan" id="kobo.934.2" xmlns="http://www.w3.org/1999/xhtml">A </span><code><span class="koboSpan" id="kobo.935.1" xmlns="http://www.w3.org/1999/xhtml">try:</span></code><span class="koboSpan" id="kobo.936.1" xmlns="http://www.w3.org/1999/xhtml">/</span><code><span class="koboSpan" id="kobo.937.1" xmlns="http://www.w3.org/1999/xhtml">except:</span></code><span class="koboSpan" id="kobo.938.1" xmlns="http://www.w3.org/1999/xhtml"> block can be used to write log entries for faulty data. </span><span class="koboSpan" id="kobo.938.2" xmlns="http://www.w3.org/1999/xhtml">If the volume of problems is small, then locating the problems in the log and resolving them may be appropriate.</span></p>
<p><span class="koboSpan" id="kobo.939.1" xmlns="http://www.w3.org/1999/xhtml">The third option is often used when there is a large volume of questionable or bad data. </span><span class="koboSpan" id="kobo.939.2" xmlns="http://www.w3.org/1999/xhtml">The rows are written to a file for further study.</span></p>
<p><span class="koboSpan" id="kobo.940.1" xmlns="http://www.w3.org/1999/xhtml">You are encouraged to implement this third strategy: create a separate output file for rejected samples. </span><span class="koboSpan" id="kobo.940.2" xmlns="http://www.w3.org/1999/xhtml">This means creating acceptance tests for files that will lead to the rejection of at least one faulty row. </span><span id="x1-261007r280"/></p>
</section>
<section class="level3" data-number="14.7.3" id="disjoint-subentities">
<h3 data-number="14.7.3"><span class="titlemark"><span class="koboSpan" id="kobo.941.1" xmlns="http://www.w3.org/1999/xhtml">10.7.3 </span></span> <span id="x1-2620003"/><span class="koboSpan" id="kobo.942.1" xmlns="http://www.w3.org/1999/xhtml">Disjoint subentities</span></h3>
<p><span class="koboSpan" id="kobo.943.1" xmlns="http://www.w3.org/1999/xhtml">An even more complicated data validation problem occurs when the source documents don’t reflect a single resulting dataclass. </span><span class="koboSpan" id="kobo.943.2" xmlns="http://www.w3.org/1999/xhtml">This often happens when disjoint subtypes are merged into a single data set. </span><span class="koboSpan" id="kobo.943.3" xmlns="http://www.w3.org/1999/xhtml">This kind of data is a union of the disjoint types. </span><span class="koboSpan" id="kobo.943.4" xmlns="http://www.w3.org/1999/xhtml">The data must involve a ”discriminator” field that shows which type of object is being described.</span></p>
<p><span class="koboSpan" id="kobo.944.1" xmlns="http://www.w3.org/1999/xhtml">For example, we may have a few fields with date, time, and document ID that are common to all samples. </span><span class="koboSpan" id="kobo.944.2" xmlns="http://www.w3.org/1999/xhtml">In addition to those fields, a </span><code><span class="koboSpan" id="kobo.945.1" xmlns="http://www.w3.org/1999/xhtml">document_type</span></code><span class="koboSpan" id="kobo.946.1" xmlns="http://www.w3.org/1999/xhtml"> field provides a set of codes to discriminate between the different kinds of invoices and different kinds of payments.</span></p>
<p><span class="koboSpan" id="kobo.947.1" xmlns="http://www.w3.org/1999/xhtml">In this case, a conversion function involves two stages of conversions:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.948.1" xmlns="http://www.w3.org/1999/xhtml">Identify the subtype. </span><span class="koboSpan" id="kobo.948.2" xmlns="http://www.w3.org/1999/xhtml">This may involve converting the common fields and the discriminator field. </span><span class="koboSpan" id="kobo.948.3" xmlns="http://www.w3.org/1999/xhtml">The work will be delegated to a subtype-specific conversion for the rest of the work.</span></p></li>
<li><p><span class="koboSpan" id="kobo.949.1" xmlns="http://www.w3.org/1999/xhtml">Convert each subtype. </span><span class="koboSpan" id="kobo.949.2" xmlns="http://www.w3.org/1999/xhtml">This may involve a family of functions associated with each of the discriminator values.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.950.1" xmlns="http://www.w3.org/1999/xhtml">This leads to a function design as shown in the activity diagram in </span><a href="#10.1"><em><span class="koboSpan" id="kobo.951.1" xmlns="http://www.w3.org/1999/xhtml">Figure 10.1</span></em></a><span class="koboSpan" id="kobo.952.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<figure class="IMG---Figure">
<span class="koboSpan" id="kobo.953.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 10.1: Subentity validation " src="../media/file48.jpg"/></span>
<figcaption class="IMG---Caption"><span class="id" id="10.1"><span class="koboSpan" id="kobo.954.1" xmlns="http://www.w3.org/1999/xhtml">Figure 10.1: </span></span><span class="content"><span class="koboSpan" id="kobo.955.1" xmlns="http://www.w3.org/1999/xhtml">Subentity validation </span></span></figcaption>
</figure>
<p><span id="x1-262003r281"/></p>
</section>
<section class="level3" data-number="14.7.4" id="create-a-fan-out-cleaning-pipeline">
<h3 data-number="14.7.4"><span class="titlemark"><span class="koboSpan" id="kobo.956.1" xmlns="http://www.w3.org/1999/xhtml">10.7.4 </span></span> <span id="x1-2630004"/><span class="koboSpan" id="kobo.957.1" xmlns="http://www.w3.org/1999/xhtml">Create a fan-out cleaning pipeline</span></h3>
<p><span class="koboSpan" id="kobo.958.1" xmlns="http://www.w3.org/1999/xhtml">There are two common alternatives for concurrent processing of a </span><strong><span class="koboSpan" id="kobo.959.1" xmlns="http://www.w3.org/1999/xhtml">acquire </span></strong><span class="koboSpan" id="kobo.960.1" xmlns="http://www.w3.org/1999/xhtml">and </span><strong><span class="koboSpan" id="kobo.961.1" xmlns="http://www.w3.org/1999/xhtml">clean </span></strong><span class="koboSpan" id="kobo.962.1" xmlns="http://www.w3.org/1999/xhtml">application:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.963.1" xmlns="http://www.w3.org/1999/xhtml">A shell pipeline that connects the </span><strong><span class="koboSpan" id="kobo.964.1" xmlns="http://www.w3.org/1999/xhtml">acquire </span></strong><span class="koboSpan" id="kobo.965.1" xmlns="http://www.w3.org/1999/xhtml">application to the </span><strong><span class="koboSpan" id="kobo.966.1" xmlns="http://www.w3.org/1999/xhtml">clean</span></strong><span class="koboSpan" id="kobo.967.1" xmlns="http://www.w3.org/1999/xhtml"> application. </span><span class="koboSpan" id="kobo.967.2" xmlns="http://www.w3.org/1999/xhtml">These two subprocesses run concurrently. </span><span class="koboSpan" id="kobo.967.3" xmlns="http://www.w3.org/1999/xhtml">Each ND JSON line written by the </span><strong><span class="koboSpan" id="kobo.968.1" xmlns="http://www.w3.org/1999/xhtml">acquire </span></strong><span class="koboSpan" id="kobo.969.1" xmlns="http://www.w3.org/1999/xhtml">application is immediately available for processing by the </span><strong><span class="koboSpan" id="kobo.970.1" xmlns="http://www.w3.org/1999/xhtml">clean </span></strong><span class="koboSpan" id="kobo.971.1" xmlns="http://www.w3.org/1999/xhtml">application.</span></p></li>
<li><p><span class="koboSpan" id="kobo.972.1" xmlns="http://www.w3.org/1999/xhtml">A pool of workers, managed by </span><code><span class="koboSpan" id="kobo.973.1" xmlns="http://www.w3.org/1999/xhtml">concurrent.futures</span></code><span class="koboSpan" id="kobo.974.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.974.2" xmlns="http://www.w3.org/1999/xhtml">Each ND JSON line created by the </span><strong><span class="koboSpan" id="kobo.975.1" xmlns="http://www.w3.org/1999/xhtml">acquire </span></strong><span class="koboSpan" id="kobo.976.1" xmlns="http://www.w3.org/1999/xhtml">application is placed in a queue for one of the workers to consume.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.977.1" xmlns="http://www.w3.org/1999/xhtml">The shell pipeline is shown in </span><a href="#10.2"><em><span class="koboSpan" id="kobo.978.1" xmlns="http://www.w3.org/1999/xhtml">Figure 10.2</span></em></a><span class="koboSpan" id="kobo.979.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<figure class="IMG---Figure">
<span class="koboSpan" id="kobo.980.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 10.2: Components of a shell pipeline " src="../media/file49.jpg"/></span>
<figcaption class="IMG---Caption"><span class="id" id="10.2"><span class="koboSpan" id="kobo.981.1" xmlns="http://www.w3.org/1999/xhtml">Figure 10.2: </span></span><span class="content"><span class="koboSpan" id="kobo.982.1" xmlns="http://www.w3.org/1999/xhtml">Components of a shell pipeline </span></span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.983.1" xmlns="http://www.w3.org/1999/xhtml">The shell creates two child process with a shared buffer between them. </span><span class="koboSpan" id="kobo.983.2" xmlns="http://www.w3.org/1999/xhtml">For the acquire child process, the shared buffer is </span><code><span class="koboSpan" id="kobo.984.1" xmlns="http://www.w3.org/1999/xhtml">sys.stdout</span></code><span class="koboSpan" id="kobo.985.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.985.2" xmlns="http://www.w3.org/1999/xhtml">For the clean child process, the shared buffer is </span><code><span class="koboSpan" id="kobo.986.1" xmlns="http://www.w3.org/1999/xhtml">sys.stdin</span></code><span class="koboSpan" id="kobo.987.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.987.2" xmlns="http://www.w3.org/1999/xhtml">As the two applications run, each byte written is available to be read.</span></p>
<p><span class="koboSpan" id="kobo.988.1" xmlns="http://www.w3.org/1999/xhtml">We’ve included explicit references to the Python runtime in these diagrams. </span><span class="koboSpan" id="kobo.988.2" xmlns="http://www.w3.org/1999/xhtml">This can help clarify how our application is part of the overall Python environment.</span></p>
<p><span class="koboSpan" id="kobo.989.1" xmlns="http://www.w3.org/1999/xhtml">The pipeline creation is an elegant feature of the shell, and can be used to create complex sequences of concurrent processing. </span><span class="koboSpan" id="kobo.989.2" xmlns="http://www.w3.org/1999/xhtml">This is a handy way to think of decomposing a large collection of transformations into a number of concurrent transformations.</span></p>
<p><span class="koboSpan" id="kobo.990.1" xmlns="http://www.w3.org/1999/xhtml">In some cases, the pipeline model isn’t ideal. </span><span class="koboSpan" id="kobo.990.2" xmlns="http://www.w3.org/1999/xhtml">This is often the case when we need asymmetric collections of workers. </span><span class="koboSpan" id="kobo.990.3" xmlns="http://www.w3.org/1999/xhtml">For example, when one process is dramatically faster than another, it helps to have multiple copies of the slow processes to keep up with the faster process. </span><span class="koboSpan" id="kobo.990.4" xmlns="http://www.w3.org/1999/xhtml">This is handled politely by the </span><code><span class="koboSpan" id="kobo.991.1" xmlns="http://www.w3.org/1999/xhtml">concurrent.futures</span></code><span class="koboSpan" id="kobo.992.1" xmlns="http://www.w3.org/1999/xhtml"> package, which lets an application create a ”pool” of workers.</span></p>
<p><span class="koboSpan" id="kobo.993.1" xmlns="http://www.w3.org/1999/xhtml">The pool can be threads or processes, depending on the nature of the work. </span><span class="koboSpan" id="kobo.993.2" xmlns="http://www.w3.org/1999/xhtml">For the most part, CPU cores tend to be used better by process pools, because OS scheduling is often process-focused. </span><span class="koboSpan" id="kobo.993.3" xmlns="http://www.w3.org/1999/xhtml">The Python </span><strong><span class="koboSpan" id="kobo.994.1" xmlns="http://www.w3.org/1999/xhtml">Global Interpreter Lock</span></strong><span class="koboSpan" id="kobo.995.1" xmlns="http://www.w3.org/1999/xhtml"> (</span><strong><span class="koboSpan" id="kobo.996.1" xmlns="http://www.w3.org/1999/xhtml">GIL</span></strong><span class="koboSpan" id="kobo.997.1" xmlns="http://www.w3.org/1999/xhtml">) often prohibits compute-intensive thread pools from making effective use of CPU resources.</span></p>
<p><span class="koboSpan" id="kobo.998.1" xmlns="http://www.w3.org/1999/xhtml">For huge data sets, worker-pool architecture can provide some performance improvements. </span><span class="koboSpan" id="kobo.998.2" xmlns="http://www.w3.org/1999/xhtml">There is overhead in serializing and deserializing the Python objects to pass the values from process to process. </span><span class="koboSpan" id="kobo.998.3" xmlns="http://www.w3.org/1999/xhtml">This overhead imposes some limitations on the benefits of multiprocessing.</span></p>
<p><span class="koboSpan" id="kobo.999.1" xmlns="http://www.w3.org/1999/xhtml">The components that implement a worker process pool are shown in </span><a href="#10.3"><em><span class="koboSpan" id="kobo.1000.1" xmlns="http://www.w3.org/1999/xhtml">Figure 10.3</span></em></a><span class="koboSpan" id="kobo.1001.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<figure class="IMG---Figure">
<span class="koboSpan" id="kobo.1002.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 10.3: Components of a worker pool " src="../media/file50.jpg"/></span>
<figcaption class="IMG---Caption"><span class="id" id="10.3"><span class="koboSpan" id="kobo.1003.1" xmlns="http://www.w3.org/1999/xhtml">Figure 10.3: </span></span><span class="content"><span class="koboSpan" id="kobo.1004.1" xmlns="http://www.w3.org/1999/xhtml">Components of a worker pool </span></span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.1005.1" xmlns="http://www.w3.org/1999/xhtml">This design is a significant alteration to the relationship between the </span><code><span class="koboSpan" id="kobo.1006.1" xmlns="http://www.w3.org/1999/xhtml">acquire.py</span></code><span class="koboSpan" id="kobo.1007.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.1008.1" xmlns="http://www.w3.org/1999/xhtml">clean.py</span></code><span class="koboSpan" id="kobo.1009.1" xmlns="http://www.w3.org/1999/xhtml"> applications. </span><span class="koboSpan" id="kobo.1009.2" xmlns="http://www.w3.org/1999/xhtml">When the </span><code><span class="koboSpan" id="kobo.1010.1" xmlns="http://www.w3.org/1999/xhtml">acquire.py</span></code><span class="koboSpan" id="kobo.1011.1" xmlns="http://www.w3.org/1999/xhtml"> application creates the process pool, it uses class and function definitions available within the same parent process.</span></p>
<p><span class="koboSpan" id="kobo.1012.1" xmlns="http://www.w3.org/1999/xhtml">This suggests the </span><code><span class="koboSpan" id="kobo.1013.1" xmlns="http://www.w3.org/1999/xhtml">clean.py</span></code><span class="koboSpan" id="kobo.1014.1" xmlns="http://www.w3.org/1999/xhtml"> module needs to have a function that processes exactly one source document. </span><span class="koboSpan" id="kobo.1014.2" xmlns="http://www.w3.org/1999/xhtml">This function may be as simple as the following:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-184">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.1015.1" xmlns="http://www.w3.org/1999/xhtml">from multiprocessing import get_logger

import acquire_model
import analysis_model

def clean_sample(
        acquired: acquire_model.SeriesSample
) -&gt; analysis_model.SeriesSample:
    try:
        return analysis_model.SeriesSample.from_acquire_dataclass(acquired)
    except ValueError as ex:
        logger = get_logger()
        logger.error("Bad sample: %r\n%r\n", acquired, ex)
        return None</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.1016.1" xmlns="http://www.w3.org/1999/xhtml">This function uses the analysis model definition, </span><code><span class="koboSpan" id="kobo.1017.1" xmlns="http://www.w3.org/1999/xhtml">SeriesSample</span></code><span class="koboSpan" id="kobo.1018.1" xmlns="http://www.w3.org/1999/xhtml">, to perform the validation, cleaning, and conversion of the acquired data. </span><span class="koboSpan" id="kobo.1018.2" xmlns="http://www.w3.org/1999/xhtml">This can raise exceptions, which need to be logged.</span></p>
<p><span class="koboSpan" id="kobo.1019.1" xmlns="http://www.w3.org/1999/xhtml">The child processes are created with copies of the parent application’s logging configuration. </span><span class="koboSpan" id="kobo.1019.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.1020.1" xmlns="http://www.w3.org/1999/xhtml">multiprocessing.get_logger()</span></code><span class="koboSpan" id="kobo.1021.1" xmlns="http://www.w3.org/1999/xhtml"> function will retrieve the logger that was initialized into the process when the pool of worker processes was created.</span></p>
<p><span class="koboSpan" id="kobo.1022.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.1023.1" xmlns="http://www.w3.org/1999/xhtml">acquire.py</span></code><span class="koboSpan" id="kobo.1024.1" xmlns="http://www.w3.org/1999/xhtml"> application can use a higher-order </span><code><span class="koboSpan" id="kobo.1025.1" xmlns="http://www.w3.org/1999/xhtml">map()</span></code><span class="koboSpan" id="kobo.1026.1" xmlns="http://www.w3.org/1999/xhtml"> function to allocate requests to the workers in an executor pool. </span><span class="koboSpan" id="kobo.1026.2" xmlns="http://www.w3.org/1999/xhtml">The general approach is shown in the following incomplete code snippet:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-185">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.1027.1" xmlns="http://www.w3.org/1999/xhtml">with target_path.open(’w’) as target_file:
    with concurrent.futures.ProcessPoolExecutor() as executor:
        with source_path.open() as source:
            acquire_document_iter = get_series(
                source, builder
            )
            clean_samples = executor.map(
                clean.clean_sample,
                acquire_document_iter
            )
            count = clean.persist_samples(target_file, clean_samples)</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.1028.1" xmlns="http://www.w3.org/1999/xhtml">This works by allocating a number of resources, starting with the target file to be written, then the pool of processes to write clean data records to the file, and finally, the source for the original, raw data samples. </span><span class="koboSpan" id="kobo.1028.2" xmlns="http://www.w3.org/1999/xhtml">Each of these has a context manager to be sure the resources are properly released when all of the processing has finished.</span></p>
<p><span class="koboSpan" id="kobo.1029.1" xmlns="http://www.w3.org/1999/xhtml">We use the </span><code><span class="koboSpan" id="kobo.1030.1" xmlns="http://www.w3.org/1999/xhtml">ProcessPoolExecutor</span></code><span class="koboSpan" id="kobo.1031.1" xmlns="http://www.w3.org/1999/xhtml"> object as a context manager to make sure the subprocesses are properly cleaned up when the source data has been fully consumed by the </span><code><span class="koboSpan" id="kobo.1032.1" xmlns="http://www.w3.org/1999/xhtml">map()</span></code><span class="koboSpan" id="kobo.1033.1" xmlns="http://www.w3.org/1999/xhtml"> function, and all of the results retrieved from the </span><code><span class="koboSpan" id="kobo.1034.1" xmlns="http://www.w3.org/1999/xhtml">Future</span></code><span class="koboSpan" id="kobo.1035.1" xmlns="http://www.w3.org/1999/xhtml"> objects that were created.</span></p>
<p><span class="koboSpan" id="kobo.1036.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.1037.1" xmlns="http://www.w3.org/1999/xhtml">get_series()</span></code><span class="koboSpan" id="kobo.1038.1" xmlns="http://www.w3.org/1999/xhtml"> function is an iterator that provides the builds the acquire version of each </span><code><span class="koboSpan" id="kobo.1039.1" xmlns="http://www.w3.org/1999/xhtml">SeriesSample</span></code><span class="koboSpan" id="kobo.1040.1" xmlns="http://www.w3.org/1999/xhtml"> object. </span><span class="koboSpan" id="kobo.1040.2" xmlns="http://www.w3.org/1999/xhtml">This will use an appropriately configured </span><code><span class="koboSpan" id="kobo.1041.1" xmlns="http://www.w3.org/1999/xhtml">Extractor</span></code><span class="koboSpan" id="kobo.1042.1" xmlns="http://www.w3.org/1999/xhtml"> object to read a source and extract a series from it.</span></p>
<p><span class="koboSpan" id="kobo.1043.1" xmlns="http://www.w3.org/1999/xhtml">Since generators are lazy, nothing really happens until the values of the </span><code><span class="koboSpan" id="kobo.1044.1" xmlns="http://www.w3.org/1999/xhtml">acquire_document_iter</span></code><span class="koboSpan" id="kobo.1045.1" xmlns="http://www.w3.org/1999/xhtml"> variable are consumed. </span><span class="koboSpan" id="kobo.1045.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.1046.1" xmlns="http://www.w3.org/1999/xhtml">executor.map()</span></code><span class="koboSpan" id="kobo.1047.1" xmlns="http://www.w3.org/1999/xhtml"> will consume the source, providing each document to the pool of workers to create a </span><code><span class="koboSpan" id="kobo.1048.1" xmlns="http://www.w3.org/1999/xhtml">Future</span></code><span class="koboSpan" id="kobo.1049.1" xmlns="http://www.w3.org/1999/xhtml"> object that reflects the work being done by a separate subprocess. </span><span class="koboSpan" id="kobo.1049.2" xmlns="http://www.w3.org/1999/xhtml">When the work by the subprocess finishes, the </span><code><span class="koboSpan" id="kobo.1050.1" xmlns="http://www.w3.org/1999/xhtml">Future</span></code><span class="koboSpan" id="kobo.1051.1" xmlns="http://www.w3.org/1999/xhtml"> object will have the result and be ready for another request.</span></p>
<p><span class="koboSpan" id="kobo.1052.1" xmlns="http://www.w3.org/1999/xhtml">When the </span><code><span class="koboSpan" id="kobo.1053.1" xmlns="http://www.w3.org/1999/xhtml">persist_samples()</span></code><span class="koboSpan" id="kobo.1054.1" xmlns="http://www.w3.org/1999/xhtml"> functions consume the values from the </span><code><span class="koboSpan" id="kobo.1055.1" xmlns="http://www.w3.org/1999/xhtml">clean_samples</span></code><span class="koboSpan" id="kobo.1056.1" xmlns="http://www.w3.org/1999/xhtml"> iterator, each of the </span><code><span class="koboSpan" id="kobo.1057.1" xmlns="http://www.w3.org/1999/xhtml">Future</span></code><span class="koboSpan" id="kobo.1058.1" xmlns="http://www.w3.org/1999/xhtml"> objects will yield their result. </span><span class="koboSpan" id="kobo.1058.2" xmlns="http://www.w3.org/1999/xhtml">These result objects are the values computed by the </span><code><span class="koboSpan" id="kobo.1059.1" xmlns="http://www.w3.org/1999/xhtml">clean.clean_sample()</span></code><span class="koboSpan" id="kobo.1060.1" xmlns="http://www.w3.org/1999/xhtml"> function. </span><span class="koboSpan" id="kobo.1060.2" xmlns="http://www.w3.org/1999/xhtml">The sequence of results is written to the target file.</span></p>
<p><span class="koboSpan" id="kobo.1061.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.1062.1" xmlns="http://www.w3.org/1999/xhtml">concurrent.futures</span></code><span class="koboSpan" id="kobo.1063.1" xmlns="http://www.w3.org/1999/xhtml"> process pool </span><code><span class="koboSpan" id="kobo.1064.1" xmlns="http://www.w3.org/1999/xhtml">map()</span></code><span class="koboSpan" id="kobo.1065.1" xmlns="http://www.w3.org/1999/xhtml"> algorithm will preserve the original order. </span><span class="koboSpan" id="kobo.1065.2" xmlns="http://www.w3.org/1999/xhtml">The process pool offers alternative methods that can make results ready as soon as they’re computed. </span><span class="koboSpan" id="kobo.1065.3" xmlns="http://www.w3.org/1999/xhtml">This can reorder the results; something that may or may not be relevant for subsequent processing.</span></p>
<p><span id="x1-263030r248"/></p>
</section>
</section>
</section>
</body>
</html>
