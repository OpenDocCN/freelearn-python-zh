<html><head></head><body>
  <div><h1 class="chapterNumber">10</h1>
    <h1 id="_idParaDest-247" class="chapterTitle">Maintaining Cross-Platform Compatibility</h1>
    <p class="normal">Word has spread throughout ABQ AgriLabs about your application, and it is being requested as a way to visualize and work on experimental data files. As a result, it now needs to run on Windows, macOS, and Linux systems equally well. Fortunately for you, Python and Tkinter are supported on these three operating systems, and you'll be pleasantly surprised to find that your application already runs unaltered on all three. However, there are some small issues that you need to address and remain aware of in order for your application to be a good citizen on each platform.</p>
    <p class="normal">In this chapter, we'll learn more about cross-platform compatibility as we cover the following topics:</p>
    <ul>
      <li class="bullet">In <em class="italic">Writing cross-platform Python</em>, you'll learn how to keep basic Python code functional across multiple platforms.</li>
      <li class="bullet">In <em class="italic">Writing cross-platform Tkinter</em>, you'll learn about cross-platform issues that affect Tkinter code specifically.</li>
      <li class="bullet">In <em class="italic">Improving our application's cross-platform compatibility</em>, we'll update our ABQ Data Entry application for better cross-platform support.</li>
    </ul>
    <h1 id="_idParaDest-248" class="title">Writing cross-platform Python</h1>
    <p class="normal">At the time of writing, Python<a id="_idIndexMarker897"/> is supported on nearly a dozen operating system platforms, covering everything from common desktop systems like Windows to high-end commercial Unixes like AIX and obscure OS projects such as Haiku OS. </p>
    <p class="normal">Across all these platforms, most Python code works without any significant alteration, as Python has been designed to translate high-level functionality into appropriate low-level operations on each system. Even so, there are situations where OS differences cannot be (or simply have not been) abstracted away, and careful handling is required to avoid platform-specific failures.</p>
    <p class="normal">In this section, we'll look at some of the larger issues that impact cross-platform Python.</p>
    <h2 id="_idParaDest-249" class="title">Filenames and file paths across platforms</h2>
    <p class="normal">Filesystems<a id="_idIndexMarker898"/> are probably the biggest source of pitfalls<a id="_idIndexMarker899"/> for cross-platform development. Although most platforms share the concept of files and directories arranged in a hierarchy, there are some crucial differences that can trip up developers who are unfamiliar with a variety of operating systems.</p>
    <h3 id="_idParaDest-250" class="title">Path separators and drives</h3>
    <p class="normal">When it comes to identifying<a id="_idIndexMarker900"/> locations on a filesystem, operating systems<a id="_idIndexMarker901"/> generally use one of the following two models:</p>
    <ul>
      <li class="bullet">Windows/DOS: In this model, each<a id="_idIndexMarker902"/> partition or storage device is assigned a volume label (usually a single letter), and each volume has its own filesystem tree. Paths are separated by a backslash (<code class="Code-In-Text--PACKT-">\</code>) character. This system is used by Windows, DOS, and VMS.</li>
      <li class="bullet">Unix: In this model, there<a id="_idIndexMarker903"/> is one filesystem tree, into which devices and partitions are mounted at arbitrary points. Paths are separated by a forward slash (<code class="Code-In-Text--PACKT-">/</code>). This model is used by macOS, Linux, BSD, iOS, Android, and other Unix-like operating systems.</li>
    </ul>
    <p class="normal">Thus, a path like <code class="Code-In-Text--PACKT-">E:\Server\Files\python</code> is meaningless on Linux or macOS, while a path like <code class="Code-In-Text--PACKT-">/mnt/disk1/files/python</code> is equally meaningless on Windows. This could make it quite difficult to write code that accesses files in a cross-platform way, but Python gives us a few tools to deal with the differences.</p>
    <h4 class="title">Path separator translation</h4>
    <p class="normal">If you use the Unix-style forward slash path separators on a Windows system, Python will automatically translate<a id="_idIndexMarker904"/> them into backslashes. This is quite useful for cross-platform purposes because using backslashes in strings can be problematic. For example, if you try to create the string <code class="Code-In-Text--PACKT-">C:\Users</code> in Python, you'll get an exception, because <code class="Code-In-Text--PACKT-">\u</code> is an escape sequence for specifying Unicode sequences, and <code class="Code-In-Text--PACKT-">sers</code> (the rest of the string after <code class="Code-In-Text--PACKT-">\U</code>) is not a valid Unicode sequence.</p>
    <div><p class="Tip--PACKT-">To use backslashes in a string, you must either escape them by entering a double-backslash (<code class="Code-In-Text--PACKT-">\\</code>) or you must use a raw string (by prefixing the string literal with an <code class="Code-In-Text--PACKT-">r</code>).</p>
    </div>
    <p class="normal">Note that there is no Windows-to-Unix path<a id="_idIndexMarker905"/> separator translation: Python will not translate backslashes into Unix-style forward slashes. Thus, a path like <code class="Code-In-Text--PACKT-">r'\usr\bin\python'</code> will simply not work on macOS or Linux.</p>
    <h4 class="title">The os.path module</h4>
    <p class="normal">Even with automatic path-separator<a id="_idIndexMarker906"/> interpolation, building or hardcoding paths as strings is a messy business. Python's powerful string manipulation methods make it tempting to try to work with paths as strings, and many programmers attempt to do so.</p>
    <p class="normal">The result is often ugly, non-portable code like this:</p>
    <pre class="programlisting code"><code class="hljs-code">script_dir = '/'.join(some_path.split('/')[:-1])
</code></pre>
    <p class="normal">While this approach might work most of the time (even on Windows), it's prone to breaking on some edge cases (for example, if <code class="Code-In-Text--PACKT-">some_path</code> is <code class="Code-In-Text--PACKT-">/script.sh</code>). For this reason, the Python standard library includes the <code class="Code-In-Text--PACKT-">os.path</code> module for working with filesystem paths.</p>
    <p class="normal">The <code class="Code-In-Text--PACKT-">path</code> module appears to be a collection of functions and constants that help abstract common filenames and directory operations, though it's actually a wrapper around the low-level modules <code class="Code-In-Text--PACKT-">posixpath</code> for Unix-like systems and <code class="Code-In-Text--PACKT-">ntpath</code> for Windows. When you import <code class="Code-In-Text--PACKT-">path</code>, Python simply detects your operating system and loads the appropriate low-level library.</p>
    <p class="normal">The following table shows some common <code class="Code-In-Text--PACKT-">os.path</code> functions that are useful for cross-platform developers:</p>
    <table id="table001-6" class="No-Table-Style _idGenTablePara-1">
      <colgroup>
        <col/>
        <col/>
      </colgroup>
      <tbody>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">Function</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">Purpose</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">join()</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Joins two or more path segments in a platform-appropriate way</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">expanduser()</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Expands the <code class="Code-In-Text--PACKT-">~</code> or <code class="Code-In-Text--PACKT-">username</code> shortcuts to the user's home directory or user name, respectively</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">expandvars()</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Expands any shell variables present in a path string</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">dirname()</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Extracts the parent directory of the path</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">isfile()</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Determines whether the path points to a file</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">isdir()</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Determines whether the path points to a directory</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">exists()</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Determines whether the given path exists</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="normal">Using these functions rather than directly manipulating path strings guarantees that your code will work across<a id="_idIndexMarker907"/> platforms consistently.</p>
    <h4 class="title">The pathlib module</h4>
    <p class="normal">A more recent addition<a id="_idIndexMarker908"/> to the Python standard library is the <code class="Code-In-Text--PACKT-">pathlib</code> module. The <code class="Code-In-Text--PACKT-">pathlib</code> module is a more object-oriented and somewhat higher-level take on filesystem paths, which we have been using throughout this book. Unlike <code class="Code-In-Text--PACKT-">os.path</code>, which is just a collection of functions and constants, <code class="Code-In-Text--PACKT-">pathlib</code> offers the <code class="Code-In-Text--PACKT-">Path</code> object, which represents a filesystem location and provides a variety of methods for modifying the path and obtaining information about it.</p>
    <p class="normal">We typically use <code class="Code-In-Text--PACKT-">pathlib</code> by importing the <code class="Code-In-Text--PACKT-">Path</code> class from it. For example:</p>
    <pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; from pathlib import Path
&gt;&gt;&gt; p = Path()
&gt;&gt;&gt; print(p)
.
&gt;&gt;&gt; print(p.absolute())
'/home/alanm'
</code></pre>
    <p class="normal"><code class="Code-In-Text--PACKT-">Path</code> defaults to the current working directory, but you can also provide it with an absolute or relative path string. Relative paths will be calculated against the current working directory.</p>
    <p class="normal"><code class="Code-In-Text--PACKT-">Path</code> objects have a variety of useful properties and methods:</p>
    <pre class="programlisting code"><code class="hljs-code"># Create a Path object for the current working directory
p = Path()
# Find the parent directory
parent = p.parent
# Check if the path /var/log exists
has_var_log = Path('/var/log').exists()
# Join Paths together, using the division operator
image_path = Path(__file__) / 'images' / 'png'
</code></pre>
    <p class="normal">Refer to the <code class="Code-In-Text--PACKT-">pathlib</code> module's documentation at <a href="https://docs.python.org/3/library/pathlib.html">https://docs.python.org/3/library/pathlib.html</a> for more information on this powerful<a id="_idIndexMarker909"/> library.</p>
    <div><p class="Tip--PACKT-">Should you use <code class="Code-In-Text--PACKT-">os.path</code> or <code class="Code-In-Text--PACKT-">pathlib.Path</code>? Generally speaking, <code class="Code-In-Text--PACKT-">pathlib</code> is the better choice and results in much cleaner code overall. However, there are a few edge cases where you might need <code class="Code-In-Text--PACKT-">os.path</code>. For example, <code class="Code-In-Text--PACKT-">pathlib</code> has no equivalent to <code class="Code-In-Text--PACKT-">expandvars()</code>; also, the <code class="Code-In-Text--PACKT-">os.path</code> module's function-oriented approach may be more useful in functional programming situations.</p>
    </div>
    <h3 id="_idParaDest-251" class="title">Case sensitivity</h3>
    <p class="normal">Platforms also<a id="_idIndexMarker910"/> differ in terms of filesystem case sensitivity. On Linux, BSD, and Unix, for example, the files <code class="Code-In-Text--PACKT-">log.txt</code>, <code class="Code-In-Text--PACKT-">LOG.txt</code>, and <code class="Code-In-Text--PACKT-">LoG.TxT</code> are all different files that can coexist in the same directory. On Windows or macOS (depending on your settings), all three names would refer to the same file, and three files with these names could not exist in the same directory.</p>
    <p class="normal">The following table breaks<a id="_idIndexMarker911"/> down the case sensitivity of major operating systems:</p>
    <table id="table002-6" class="No-Table-Style _idGenTablePara-1">
      <colgroup>
        <col/>
        <col/>
      </colgroup>
      <tbody>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">System</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">Case-sensitive</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Windows</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">No</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">macOS</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Not by default (configurable)</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Linux</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Yes</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">BSD, most other Unix systems</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Yes</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="normal">Problems with case (in)sensitivity<a id="_idIndexMarker912"/> usually depend on which system you're accustomed to:</p>
    <ul>
      <li class="bullet">Programmers used to a case-insensitive system tend to run into problems with inconsistent use of cases when referencing files and paths. For instance, you might save a file as <code class="Code-In-Text--PACKT-">UserSettings.json</code> but try to retrieve it as <code class="Code-In-Text--PACKT-">usersettings.JSON</code>.</li>
      <li class="bullet">Programmers used to a case-sensitive system can have problems when depending on a case to differentiate between file or directory names. For example, you might have the files <code class="Code-In-Text--PACKT-">ImportIngest.txt</code> and <code class="Code-In-Text--PACKT-">ImportingEst.txt</code> in the same directory.</li>
    </ul>
    <p class="normal">Avoiding these issues<a id="_idIndexMarker913"/> is fairly simple with the following few basic rules:</p>
    <ul>
      <li class="bullet">Use all-lowercase names for file and path names unless there is a good reason not to.</li>
      <li class="bullet">If you do mix cases, follow consistent rules, so that you don't need to remember arbitrary case usage.</li>
      <li class="bullet">Avoid CamelCase<a id="_idIndexMarker914"/> or similar naming schemes that rely on case<a id="_idIndexMarker915"/> to denote word breaks. Use underscores, hyphens, or spaces (they're valid in all modern filesystems!).</li>
    </ul>
    <p class="normal">To put it another way: treat all paths and filenames as if you had a case-sensitive system, but don't rely on the system being case-sensitive.</p>
    <h3 id="_idParaDest-252" class="title">Symbolic links</h3>
    <p class="normal">A symbolic link is a special filesystem-level construct that appears to be a file or directory<a id="_idIndexMarker916"/> but is actually just a pointer to another file or directory<a id="_idIndexMarker917"/> on the system. They're often used to provide aliases to files or directories, or to make it appear as though the same file exists in multiple places without using additional disk space. Although they exist on Windows, they're far more commonly used on Linux, macOS, and other Unix-like systems; thus, they can be a point of confusion for programmers coming from a Windows environment.</p>
    <div><p class="Information-Box--PACKT-">Symbolic links are not to be confused with desktop shortcuts, which also exist on all three major platforms. Shortcuts are just metadata files implemented at the desktop environment level, whereas symbolic links are implemented at the filesystem level.</p>
    </div>
    <p class="normal">File and path operations sometimes need to clarify if they're working with the symbolic link itself or the file that the link points to.</p>
    <p class="normal">For example, suppose we had a symbolic link in our current directory, <code class="Code-In-Text--PACKT-">secret_stuff.txt</code>, that points to the nonexistent file <code class="Code-In-Text--PACKT-">/tmp/secret_stuff.txt</code>. Look at how <code class="Code-In-Text--PACKT-">os.path()</code> responds to such a file:</p>
    <pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; from os import path
&gt;&gt;&gt; path.exists('secret_stuff.txt')
False
&gt;&gt;&gt; path.lexists('secret_stuff.txt')
True
</code></pre>
    <p class="normal">The regular <code class="Code-In-Text--PACKT-">path.exists()</code> function will follow the link and discover that the actual file in question does not exist. <code class="Code-In-Text--PACKT-">os.path</code> also includes a <code class="Code-In-Text--PACKT-">lexists()</code> function that will tell us if the <em class="italic">link</em> exists, even if the <em class="italic">file</em> does not. This situation could be a problem; for example, your program might be attempting to create a directory with the same name as a broken symbolic link. In this case, <code class="Code-In-Text--PACKT-">os.path.exists()</code> or <code class="Code-In-Text--PACKT-">Path.exists()</code> would both return <code class="Code-In-Text--PACKT-">False</code>, but the name conflict would still exist, and directory creation would fail. Checking <code class="Code-In-Text--PACKT-">os.path.lexists()</code> or <code class="Code-In-Text--PACKT-">Path.is_symlink()</code> as well would be a good idea in this case.</p>
    <p class="normal">The following<a id="_idIndexMarker918"/> table shows some of the <code class="Code-In-Text--PACKT-">os.path</code> functions that help deal with symbolic links:</p>
    <table id="table003-5" class="No-Table-Style _idGenTablePara-1">
      <colgroup>
        <col/>
        <col/>
      </colgroup>
      <tbody>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">Method</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">Description</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">islink()</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Returns <code class="Code-In-Text--PACKT-">True</code> if a path is a symbolic link</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">lexists()</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Returns <code class="Code-In-Text--PACKT-">True</code> if a path exists, even if it's a broken symbolic link</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">realpath()</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Returns the actual path, resolving any symbolic links to real files and directories</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="normal"><code class="Code-In-Text--PACKT-">pathlib.Path</code> objects also feature these link-related methods:</p>
    <table id="table004-3" class="No-Table-Style">
      <colgroup>
        <col/>
        <col/>
      </colgroup>
      <tbody>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">Method</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">Description</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">is_symlink()</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Returns <code class="Code-In-Text--PACKT-">True</code> if the path is a symbolic link</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">resolve()</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Returns a path with all symbolic links resolved to real files and directories</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">lchmod()</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Changes permissions on a symbolic link, rather than the file it is pointed to</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">lstat()</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Returns filesystem information on a symbolic link, rather than the file it is pointed to</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="normal">In summary, our code<a id="_idIndexMarker919"/> should be mindful of symbolic links in situations where they might cause it to behave unexpectedly.</p>
    <h3 id="_idParaDest-253" class="title">Path variables</h3>
    <p class="normal">Most platforms, including Windows, macOS, and Linux, support some kind of shell variables, which<a id="_idIndexMarker920"/> are often automatically set up by the system to point to common<a id="_idIndexMarker921"/> filesystem locations. The <code class="Code-In-Text--PACKT-">os.path</code> module provides the <code class="Code-In-Text--PACKT-">expandvars()</code> function to expand these variables into their actual values (<code class="Code-In-Text--PACKT-">pathlib</code> has no equivalent method). While these variables can be useful in locating common path locations, the cross-platform developer should understand that they are not consistent across platforms.</p>
    <p class="normal">Some commonly used variables across different systems include the following:</p>
    <table id="table005-1" class="No-Table-Style">
      <colgroup>
        <col/>
        <col/>
        <col/>
        <col/>
      </colgroup>
      <tbody>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">Description</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">Windows</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">macOS</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">Linux</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Current user home directory</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">%HOME%</code>, <code class="Code-In-Text--PACKT-">%USERPROFILE%</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">$HOME</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">$HOME</code></p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Temporary directory</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">%TMP%</code>, <code class="Code-In-Text--PACKT-">%TEMP%</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">$TMPDIR</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">None</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Path to default shell</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">N/A</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">$SHELL</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">$SHELL</code></p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Current working directory</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">None</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">$PWD</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">$PWD</code></p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Configuration directory</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">%APPDATA%</code>, <code class="Code-In-Text--PACKT-">%LOCALAPPDATA%</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">None</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">$XDG_CONFIG_HOME</code> (often not set)</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">OS directory</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">%WINDIR%</code>, <code class="Code-In-Text--PACKT-">%SYSTEMROOT%</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">N/A</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">N/A</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Program files directory</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">%PROGRAMFILES%</code>, <code class="Code-In-Text--PACKT-">%PROGRAMW6432%</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">N/A</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">N/A</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="normal">Note that Windows variables can be spelled using the native <code class="Code-In-Text--PACKT-">%VARIABLENAME%</code> format or the Unix-style <code class="Code-In-Text--PACKT-">$VARIABLENAME</code> format; macOS and Linux only accept the Unix-style format.</p>
    <p class="normal">Using these variables<a id="_idIndexMarker922"/> is not necessarily a bad idea (they can help abstract differences<a id="_idIndexMarker923"/> between versions or configurations of an OS), but be aware that they are not consistently available, or even meaningful, across platforms.</p>
    <h2 id="_idParaDest-254" class="title">Inconsistent library and feature support</h2>
    <p class="normal">While it's understandable<a id="_idIndexMarker924"/> that many third-party Python libraries<a id="_idIndexMarker925"/> only support a limited number of platforms, you might be surprised to learn that the standard library contains a slightly different set of modules depending on the platform. Even those that do exist across platforms might behave slightly differently, or have inconsistent contents, depending on the platform.</p>
    <p class="normal">Naturally, these have to be handled carefully in cross-platform applications. Let's look at a few examples of these libraries and features.</p>
    <h3 id="_idParaDest-255" class="title">Python's platform-limited libraries</h3>
    <p class="normal">In sections<a id="_idIndexMarker926"/> 34 and 35 of Python's standard<a id="_idIndexMarker927"/> library documentation (<a href="https://docs.python.org/3/library/index.html">https://docs.python.org/3/library/index.html</a>), you'll find a list of libraries available only<a id="_idIndexMarker928"/> on Windows or Unix-like systems, respectively. Careful reading of the documentation shows that there are a couple more platform-limited libraries listed in other sections as well.</p>
    <p class="normal">This is a list of the more common platform-limited libraries you may encounter:</p>
    <table id="table006-1" class="No-Table-Style">
      <colgroup>
        <col/>
        <col/>
        <col/>
      </colgroup>
      <tbody>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">Library</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">Description</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">Availability</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">ossaudiodev</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Open Sound System (OSS) audio server interface</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Linux, FreeBSD</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">winsound</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Windows audio interface</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Windows</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">msilib</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Windows software packaging tools</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Windows</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">winreg</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Windows registry tools</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Windows</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">syslog</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Unix system log interface</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Linux, macOS, BSD</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">pwd</code>, <code class="Code-In-Text--PACKT-">spwd</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Unix password database interface</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Linux, macOS, BSD</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">resource</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">System resource limits</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Linux, macOS, BSD</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">curses</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Terminal-based UI library</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Linux, macOS, BSD</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="normal">In some cases, there are higher-level, cross-platform libraries that you can use to replace these (for example, use <code class="Code-In-Text--PACKT-">logging</code> instead of <code class="Code-In-Text--PACKT-">syslog</code>), but in other cases the functionality is so platform-specific<a id="_idIndexMarker929"/> that you may have<a id="_idIndexMarker930"/> no choice (<code class="Code-In-Text--PACKT-">winreg</code>, for example). In this case, you'll need to do a platform check before importing these libraries, as you'll get an <code class="Code-In-Text--PACKT-">ImportError</code> exception on unsupported platforms.</p>
    <h3 id="_idParaDest-256" class="title">Checking low-level function compatibility</h3>
    <p class="normal">Even in universally available libraries, there are sometimes functions or methods that are unavailable<a id="_idIndexMarker931"/> or exhibit different behaviors depending on the platform. The <code class="Code-In-Text--PACKT-">os</code> module is perhaps the most notable case.</p>
    <p class="normal">The <code class="Code-In-Text--PACKT-">os</code> module is a relatively thin wrapper around system calls or commands, and while it attempts to abstract some roughly analogous calls across platforms, many of its functions are too platform-specific to make available universally.</p>
    <p class="normal">The <code class="Code-In-Text--PACKT-">os</code> module<a id="_idIndexMarker932"/> documentation at <a href="https://docs.python.org/3/library/os.html">https://docs.python.org/3/library/os.html</a> contains complete details on platform support, but some examples are listed here:</p>
    <table id="table007-1" class="No-Table-Style">
      <colgroup>
        <col/>
        <col/>
        <col/>
      </colgroup>
      <tbody>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">Library</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">Description</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">Availability</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">getuid</code>, <code class="Code-In-Text--PACKT-">getgid</code>, <code class="Code-In-Text--PACKT-">getgroups</code>, <code class="Code-In-Text--PACKT-">geteuid</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Get user or group information for the current process</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Unix-like</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">setuid</code>, <code class="Code-In-Text--PACKT-">setgid</code>, <code class="Code-In-Text--PACKT-">setgroups</code>, <code class="Code-In-Text--PACKT-">seteuid</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Set user or group information for the current process</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Unix-like</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">getpriority</code>, <code class="Code-In-Text--PACKT-">setpriority</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Get or set the priority of the current process</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Unix-like</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">chown</code>, <code class="Code-In-Text--PACKT-">lchown</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Change the owner of a file or its symbolic link</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Unix-like</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-"><code class="Code-In-Text--PACKT-">startfile</code></p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Open a file as if it were double-clicked</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Windows</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="normal">Attempting to use an unavailable function will cause an exception, so none of these functions should be in a cross-platform application without appropriate checks or exception handling. By far, most of the platform-limited functions in <code class="Code-In-Text--PACKT-">os</code> are limited to Unix-like systems (Linux, macOS, BSD, and so on), and most of the analogous functions for Windows will be found in the third-party <code class="Code-In-Text--PACKT-">pywin32</code> package (which is only available for Windows, of course).</p>
    <p class="normal">In general, you need to check the documentation of the libraries you use to make sure they're available<a id="_idIndexMarker933"/> on all the platforms you intend to support. Caution is especially warranted when using libraries that interact with operating system functions (such as window management, filesystems, user authentication, and so on) or with services that are only available on certain platforms (Microsoft SQL Server, for example).</p>
    <h3 id="_idParaDest-257" class="title">The dangers of the subprocess module</h3>
    <p class="normal">The <code class="Code-In-Text--PACKT-">subprocess</code> module provides tools to launch and manage other programs and commands<a id="_idIndexMarker934"/> from within your Python application. For programmers already familiar with their operating system's command-line interface, it often provides a fast and convenient way to accomplish filesystem operations or other administrative tasks. It's also highly effective at sabotaging cross-platform compatibility!</p>
    <p class="normal">For example, a programmer on Linux or macOS might be tempted to copy files as follows:</p>
    <pre class="programlisting code"><code class="hljs-code">import subprocess
subprocess.call(['cp', 'file1.txt', 'file2.txt'])
</code></pre>
    <p class="normal">This would work on Unix-like operating systems but fail on Windows, as <code class="Code-In-Text--PACKT-">cp</code> is not a valid Windows shell<a id="_idIndexMarker935"/> command. The better option in this case is to use the <code class="Code-In-Text--PACKT-">shutil</code> library, which contains high-level functions for copying files.</p>
    <p class="normal">To avoid problems<a id="_idIndexMarker936"/> here, follow these guidelines:</p>
    <ol>
      <li class="numbered">Look for high-level libraries before resorting to <code class="Code-In-Text--PACKT-">subprocess</code> to solve a problem.</li>
      <li class="numbered">If you must use <code class="Code-In-Text--PACKT-">subprocess</code>, carefully study the called command on each supported platform, making sure the syntax, output, and behavior are identical.</li>
      <li class="numbered">If they're not, make sure to create different cases for each platform (see the section <em class="italic">Writing code that changes according to the platform</em>, below).</li>
    </ol>
    <p class="normal">Naturally, all this advice applies equally to any third-party modules that allow you to execute operating system commands from within Python.</p>
    <h2 id="_idParaDest-258" class="title">Text file encodings and formats</h2>
    <p class="normal">Plaintext files on different<a id="_idIndexMarker937"/> platforms use different character encodings and end-of-line characters by default. Although most operating<a id="_idIndexMarker938"/> systems can handle a wide variety of encodings, each system has a default (often determined by language or localization settings) that will be used if none is specified. Text files on different platforms also use different character codes for end-of-line characters.</p>
    <p class="normal">Modern<a id="_idIndexMarker939"/> versions of Linux and macOS use UTF-8 as a default encoding and the line feed character (<code class="Code-In-Text--PACKT-">\n</code>) as a line terminator. Windows 10, however, uses <code class="Code-In-Text--PACKT-">cp1252</code> as its default encoding<a id="_idIndexMarker940"/> and the combination of the carriage return and line feed (<code class="Code-In-Text--PACKT-">\r\n</code>) characters as a line terminator. Most of the time, these differences<a id="_idIndexMarker941"/> do not represent a problem, especially if you are only reading and writing files in Python and working with standard English characters.</p>
    <p class="normal">Consider, however, a scenario where you attempt to append a Unicode character to a text file, like so:</p>
    <pre class="programlisting code"><code class="hljs-code">with open('testfile.test', 'a') as fh:
  fh.write('\U0001F34C')
</code></pre>
    <p class="normal">On Windows, or other systems with a non-Unicode default encoding, the preceding code will raise an exception, like so:</p>
    <pre class="programlisting con"><code class="hljs-con">UnicodeEncodeError: 'charmap' codec can't encode character '\U0001f34c' in position 0: character maps to &lt;undefined&gt;
</code></pre>
    <p class="normal">To avoid this problem, you can manually specify a character encoding when opening a file, as follows:</p>
    <pre class="programlisting code"><code class="hljs-code">with open('testfile.test', 'a', encoding='utf-8') as fh:
  fh.write('\U0001F34C')
</code></pre>
    <p class="normal">The line-terminator character can also be specified when opening a file using the <code class="Code-In-Text--PACKT-">newline</code> argument, like so:</p>
    <pre class="programlisting code"><code class="hljs-code">with open('testfile.test', 'w', newline='\n') as fh:
  fh.write('banana')
</code></pre>
    <p class="normal">We've already<a id="_idIndexMarker942"/> been doing this in ABQ Data Entry to work around a bug in Windows with the <code class="Code-In-Text--PACKT-">csv</code> module. In a cross-platform situation, it's a good idea to specify both the <code class="Code-In-Text--PACKT-">encoding</code> and <code class="Code-In-Text--PACKT-">newline</code> arguments whenever saving data you don't control (such as user-entered data).</p>
    <h2 id="_idParaDest-259" class="title">Graphical and console modes</h2>
    <p class="normal">On Windows, programs are launched in either GUI mode or console mode, as determined by metadata<a id="_idIndexMarker943"/> in the executable. The Python distribution<a id="_idIndexMarker944"/> for Windows includes a utility called Python launcher, which<a id="_idIndexMarker945"/> is associated with Python<a id="_idIndexMarker946"/> files during installation. Python<a id="_idIndexMarker947"/> launcher will launch<a id="_idIndexMarker948"/> your application in either GUI or console mode depending on its file extension, as follows:</p>
    <ul>
      <li class="bullet">Files ending in the <code class="Code-In-Text--PACKT-">.py</code> extension will be launched in console mode using <code class="Code-In-Text--PACKT-">python.exe</code>. This will cause a command-line window to open in the background, which must stay open while the program runs.</li>
      <li class="bullet">Files ending in <code class="Code-In-Text--PACKT-">.pyw</code> will be launched in GUI mode using <code class="Code-In-Text--PACKT-">pythonw.exe</code>. No command-line window will be launched, and if run from a command line the program will not block the console (that is, the prompt will return immediately, while the program is still running); however, <code class="Code-In-Text--PACKT-">print()</code> will have no effect and <code class="Code-In-Text--PACKT-">sys.stderr</code> and <code class="Code-In-Text--PACKT-">sys.stdout</code> will not exist. Trying to access them will raise an exception.</li>
    </ul>
    <p class="normal">This distinction often causes confusion for developers coming from Linux or macOS, where it is common to have graphical applications that output errors and debugging information to the terminal. Even for Windows programmers who are new to GUI applications, the lack of command-line output for GUI applications can be problematic.</p>
    <p class="normal">To avoid issues, simply remember the following:</p>
    <ol>
      <li class="numbered" value="1">Remove any <code class="Code-In-Text--PACKT-">sys.stdout()</code> or <code class="Code-In-Text--PACKT-">sys.stderr()</code> calls from the code if deploying to Windows.</li>
      <li class="numbered">Rely on logging rather than <code class="Code-In-Text--PACKT-">print()</code> or <code class="Code-In-Text--PACKT-">sys.stderr()</code> calls to record debugging information.</li>
      <li class="numbered">Create a copy of the main executable script with a <code class="Code-In-Text--PACKT-">.pyw</code> extension so that Windows users can launch it without a command-line window.</li>
    </ol>
    <p class="normal">While macOS does not distinguish between GUI and console applications (apart from the obvious<a id="_idIndexMarker949"/> presence of a GUI), its desktop launches regular <code class="Code-In-Text--PACKT-">.py</code> files by launching a Terminal window, just like Windows. While macOS Python includes a <code class="Code-In-Text--PACKT-">pythonw.exe</code> file that<a id="_idIndexMarker950"/> launches without the Terminal, there are two problems with it. First, it is not associated with the <code class="Code-In-Text--PACKT-">.pyw</code> extension by default; you'd need to do that manually if you wanted that behavior. Second, depending on how you installed Python 3 (for instance, if you installed it using <code class="Code-In-Text--PACKT-">homebrew</code>), your installation may not have <code class="Code-In-Text--PACKT-">pythonw</code>.</p>
    <div><p class="Information-Box--PACKT-">There is a way to set up Python programs on macOS so that they behave like proper GUI applications, which we'll cover in <em class="chapterRef">Chapter 16</em>, <em class="italic">Packaging with setuptools and cxFreeze</em>.</p>
    </div>
    <h2 id="_idParaDest-260" class="title">Writing code that changes according to the platform</h2>
    <p class="normal">As you've seen so far, there are certain situations where you simply can't avoid writing platform-specific code, either because a high-level library is unavailable or because the actions that<a id="_idIndexMarker951"/> need to be performed are fundamentally different on a particular platform.</p>
    <p class="normal">In this case, it becomes necessary to detect the platform. There are a few ways of doing this in Python, including the <code class="Code-In-Text--PACKT-">os.system()</code> function and the <code class="Code-In-Text--PACKT-">sys.platform</code> attribute, but the standard library <code class="Code-In-Text--PACKT-">platform</code> module contains the best set of functionality for determining the OS details most useful in making decisions. When called, the <code class="Code-In-Text--PACKT-">platform.system()</code> function returns a string identifying the operating system: <code class="Code-In-Text--PACKT-">Windows</code>, <code class="Code-In-Text--PACKT-">Linux</code>, <code class="Code-In-Text--PACKT-">freebsd7</code>, or <code class="Code-In-Text--PACKT-">Darwin</code> (for macOS).</p>
    <p class="normal">Some other useful functions in the <code class="Code-In-Text--PACKT-">platform</code> module include <code class="Code-In-Text--PACKT-">release()</code>, which returns the version string of the OS (for example, "10" on Windows 10, "17.3.0" on macOS High Sierra, or the running kernel version on Linux); and <code class="Code-In-Text--PACKT-">architecture()</code>, which tells us if the system is 64 bit or 32 bit.</p>
    <p class="normal">For simple differences in code, using this information in a nested <code class="Code-In-Text--PACKT-">if</code> / <code class="Code-In-Text--PACKT-">else</code> chain usually suffices:</p>
    <pre class="programlisting code"><code class="hljs-code"># simple_cross_platform_demo.py
import platform
import subprocess
os_name = platform.system()
if os_name in ('Darwin', 'freebsd7'):
    cmd = ['ps', '-e', '-o', "comm=''", '-c']
elif os_name == 'Linux':
    cmd = ['ps', '-e', '--format', 'comm', '--no-heading']
elif os_name == 'Windows':
    cmd = ['tasklist', '/nh', '/fo', 'CSV']
else:
    raise NotImplemented("Command unknown for OS")
processes = subprocess.check_output(cmd, text=True)
print(processes)
</code></pre>
    <p class="normal">This example defines<a id="_idIndexMarker952"/> a platform-appropriate list of command tokens based on the value returned by <code class="Code-In-Text--PACKT-">platform.system()</code>. The correct list is saved as <code class="Code-In-Text--PACKT-">cmd</code>, which is then passed to <code class="Code-In-Text--PACKT-">subprocess.check_output()</code> to run the command and obtain its output.</p>
    <p class="normal">This works acceptably for the occasional call, but for more complex situations, it makes sense to bundle platform-specific code into backend classes that we can then select on the basis of our platform string. For example, we could re-implement the above code as follows:</p>
    <pre class="programlisting code"><code class="hljs-code"># complex_cross_platform_demo/backend.py
import subprocess
import platform
class GenericProcessGetter():
  cmd = []
  def get_process_list(self):
    if self.cmd:
      return subprocess.check_output(self.cmd)
    else:
      raise NotImplementedError
class LinuxProcessGetter(GenericProcessGetter):
  cmd = ['ps', '-e', '--format', 'comm', '--no-heading']
class MacBsdProcessGetter(GenericProcessGetter):
  cmd = ['ps', '-e', '-o', "comm=''", '-c']
class WindowsProcessGetter(GenericProcessGetter):
  cmd = ['tasklist', '/nh', '/fo', 'CSV']
</code></pre>
    <p class="normal">In this approach, we have<a id="_idIndexMarker953"/> created a generic class to handle the common logic for getting processes, then subclassed it to override the <code class="Code-In-Text--PACKT-">cmd</code> attribute specifically for each platform.</p>
    <p class="normal">Now, we can create a selector function to return an appropriate backend class when given an OS name:</p>
    <pre class="programlisting code"><code class="hljs-code"># complex_cross_platform_demo/backend.py
def get_process_getter_class(os_name):
  process_getters = {
    'Linux': LinuxProcessGetter,
    'Darwin': MacBsdProcessGetter,
    'Windows': WindowsProcessGetter,
    'freebsd7': MacBsdProcessGetter
  }
  try:
    return process_getters[os_name]
  except KeyError:
    raise NotImplementedError("No backend for OS")
</code></pre>
    <p class="normal">Now, code that needs to use this class can utilize this function to retrieve a platform-appropriate version. For example:</p>
    <pre class="programlisting code"><code class="hljs-code"># complex_cross_platform_demo/main.py
os_name = platform.system()
process_getter = get_process_getter_class(os_name)()
print(process_getter.get_process_list())
</code></pre>
    <p class="normal">This script can now be run on Linux, Windows, macOS, or BSD to print a process list. Other platforms can be easily added by creating more <code class="Code-In-Text--PACKT-">GenericProcessGetter</code> subclasses and updating <code class="Code-In-Text--PACKT-">get_process_getter_class()</code>.</p>
    <p class="normal">For even more complex situations, where multiple classes or functions need to be implemented differently between platforms, we can take an approach similar to the standard library's <code class="Code-In-Text--PACKT-">os.path</code> module: implement completely separate modules for each platform, then import them<a id="_idIndexMarker954"/> with a common alias depending on the platform. For example:</p>
    <pre class="programlisting code"><code class="hljs-code">import platform
os_name = platform.system()
if os_name == 'Linux':
    import linux_backend as backend
elif os_name == 'Windows':
    import windows_backend as backend
elif os_name in ('Darwin', 'freebsd7'):
    import macos_bsd_backend as backend
else:
    raise NotImplementedError(f'No backend for {os_name}')
</code></pre>
    <p class="normal">Bear in mind that each backend module should ideally contain identical class and function names and produce similar output. That way <code class="Code-In-Text--PACKT-">backend</code> can be used by the code without concern for the platform in question.</p>
    <h1 id="_idParaDest-261" class="title">Writing cross-platform Tkinter</h1>
    <p class="normal">As you've seen so far, Tkinter mostly works identically across platforms, and even has the capability<a id="_idIndexMarker955"/> to do the right thing on each platform with minimal effort. However, there are some minor issues to be aware of as you support a Tkinter application across multiple operating systems. In this section, we'll explore the more significant differences.</p>
    <h2 id="_idParaDest-262" class="title">Tkinter version differences across platforms</h2>
    <p class="normal">As of 2021, the official Python 3 distributions for major platforms ship at least Tcl/Tk 8.6; this is the latest<a id="_idIndexMarker956"/> major release of Tcl/Tk and includes all the functionality discussed in this book. However, not every platform includes the latest minor version, which may impact bug fixes and minor features. At the time of writing, the latest version of Tcl/Tk is 8.6.11.</p>
    <div><p class="Tip--PACKT-">Historically, some platforms (notably macOS) have lagged behind in shipping the latest version of Tcl/Tk. While platform support at the time of writing is fairly consistent, it's possible that differences may arise again in the future.</p>
    </div>
    <p class="normal">To discover the exact version of Tcl/Tk installed on your system, you can execute the following commands at a Python prompt:</p>
    <pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; import tkinter as tk
&gt;&gt;&gt; tk.Tcl().call('info', 'patchlevel')
</code></pre>
    <p class="normal">This code uses the <code class="Code-In-Text--PACKT-">Tcl()</code> function to create a new Tcl interpreter, then calls the <code class="Code-In-Text--PACKT-">info patchlevel</code> command. Here's what<a id="_idIndexMarker957"/> this command returns on several platforms using the most commonly used Python 3 distribution for each platform:</p>
    <table id="table008-1" class="No-Table-Style">
      <colgroup>
        <col/>
        <col/>
        <col/>
      </colgroup>
      <tbody>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">Platform</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">Python version</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Heading--PACKT-">Tcl/Tk version</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Windows 10</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">3.9 (from python.org)</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">8.6.9</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">macOS High Sierra</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">3.9 (from python.org)</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">8.6.8</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Ubuntu 20.04</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">3.8 (from the repositories)</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">8.6.10</p>
          </td>
        </tr>
        <tr class="No-Table-Style">
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">Debian 10</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">3.7 (from the repositories)</p>
          </td>
          <td class="No-Table-Style">
            <p class="Table-Column-Content--PACKT-">8.6.9</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="normal">As you can see, none of these platforms offer the latest version of Tcl/Tk, and even those with newer versions of Python may have older versions of Tcl/Tk. Ultimately, if you intend to write cross-platform Tkinter code, make sure you are not relying on features from the very latest version of Tcl/Tk.</p>
    <h2 id="_idParaDest-263" class="title">Application menus across platforms</h2>
    <p class="normal">The application menu<a id="_idIndexMarker958"/> is probably one of the most visible areas where both capabilities and conventions vary between platforms. As mentioned in <em class="chapterRef">Chapter 7</em>, <em class="italic">Creating Menus with Menu and Tkinter Dialogs</em>, we should<a id="_idIndexMarker959"/> be aware of both the limitations and the expectations on major operating systems when designing our menus.</p>
    <h3 id="_idParaDest-264" class="title">Menu widget capabilities</h3>
    <p class="normal">The <code class="Code-In-Text--PACKT-">Menu</code> widget, which<a id="_idIndexMarker960"/> we learned about in <em class="chapterRef">Chapter 7</em>, is different<a id="_idIndexMarker961"/> from most other Tkinter widgets in that it relies on the menu facilities of the underlying platform. This allows your application to have a menu that behaves natively; for example, on macOS, the menu appears in the global menu area at the top of the screen, while on Windows it appears in the application window under the taskbar.</p>
    <p class="normal">Because of this design, there are some limitations when working with cross-platform <code class="Code-In-Text--PACKT-">Menu</code> widgets. To demonstrate this, let's build an extremely non-cross-platform menu.</p>
    <p class="normal">We'll begin by creating<a id="_idIndexMarker962"/> a simple <code class="Code-In-Text--PACKT-">Tk</code> window with<a id="_idIndexMarker963"/> a menu, like so:</p>
    <pre class="programlisting code"><code class="hljs-code"># non_cross_platform_menu.py
import tkinter as tk
from tkinter.messagebox import showinfo
root = tk.Tk()
root.geometry("300x200")
menu = tk.Menu(root)
</code></pre>
    <p class="normal">Now, we'll create a cascade menu:</p>
    <pre class="programlisting code"><code class="hljs-code">smile = tk.PhotoImage(file='smile.gif')
smile_menu = tk.Menu(menu, tearoff=False)
smile_menu.add_command(
  image=smile,
  command=lambda: showinfo(message="Smile!")
)
smile_menu.add_command(label='test')
menu.add_cascade(image=smile, menu=smile_menu)
</code></pre>
    <p class="normal">The <code class="Code-In-Text--PACKT-">smile_menu</code> contains two commands, one with a text label and the other with only an image. We've also used the image when adding the cascade to the menu, so that it shouldn't have a text label, just an image.</p>
    <p class="normal">While we're at it, let's add some colors; in <em class="chapterRef">Chapter 9</em>, <em class="italic">Improving the Look with Styles and Themes</em>, we customized the color of the application menu, mentioning that it only worked in Linux. Let's see what it does on other platforms; add in the following code:</p>
    <pre class="programlisting code"><code class="hljs-code">menu.configure(foreground='white', background='navy')
smile_menu.configure(foreground='yellow', background='red')
</code></pre>
    <p class="normal">That should make our main menu white text on a black background, and the cascade yellow on red.</p>
    <p class="normal">Next, let's add a separator and a command directly to the main menu, after the <code class="Code-In-Text--PACKT-">smile_menu</code>:</p>
    <pre class="programlisting code"><code class="hljs-code">menu.add_separator()
menu.add_command(
  label='Top level command',
  command=lambda: showinfo(message='By your command!')
)
</code></pre>
    <p class="normal">Last of all, we'll create a <code class="Code-In-Text--PACKT-">Checkbutton</code> widget<a id="_idIndexMarker964"/> directly on the main menu, and finish with the usual boilerplate<a id="_idIndexMarker965"/> to configure <code class="Code-In-Text--PACKT-">root</code> and run the <code class="Code-In-Text--PACKT-">mainloop()</code> method:</p>
    <pre class="programlisting code"><code class="hljs-code">boolvar = tk.BooleanVar()
menu.add_checkbutton(label="It is true", variable=boolvar)
root.config(menu=menu)
root.mainloop()
</code></pre>
    <p class="normal">Save this file and execute the code. Depending on your operating system, you'll see some different things.</p>
    <p class="normal">If you are on Linux (in this case, Ubuntu 20.04), it seems to work mostly as expected:</p>
    <figure class="mediaobject"><img src="img/B17578_10_01.png" alt="Figure 10.1: The menu experiment on Ubuntu 20.04"/></figure>
    <p class="packt_figref">Figure 10.1: The menu experiment on Ubuntu 20.04</p>
    <p class="normal">We have our first cascade labeled with the smiley face GIF, our top-level menu command, and our top-level <code class="Code-In-Text--PACKT-">Checkbutton</code> (which we've checked, because it is true that our menu works!). The colors also seem to be correct, although the background of the GIF is the default<a id="_idIndexMarker966"/> grey rather than the red we would<a id="_idIndexMarker967"/> expect (the GIF itself has a transparent background).</p>
    <p class="normal">If you're using Windows 10, you should see something more like this:</p>
    <figure class="mediaobject"><img src="img/B17578_10_02.png" alt="Figure 10.2: The menu experiment on Windows 10"/></figure>
    <p class="packt_figref">Figure 10.2: The menu experiment on Windows 10</p>
    <p class="normal">Instead of our smiling icon in the top menu, we only have the text <strong class="screenText">(Image)</strong>. Even if we specify a label, this text shows up where the image should be. Fortunately, the image does appear when we use it in the cascade menu. As for the colors, they work as expected in the cascade menu, but the top-level menu ignores them completely. The command in the main menu appears and works just fine, but the <code class="Code-In-Text--PACKT-">Checkbutton</code> widget does not. Its label appears and can be clicked on, but the check mark itself does not appear.</p>
    <p class="normal">Finally, let's try this menu on macOS. It should look something like this:</p>
    <figure class="mediaobject"><img src="img/B17578_10_03.png" alt="Figure 10.3: The menu experiment on macOS"/></figure>
    <p class="packt_figref">Figure 10.3: The menu experiment on macOS</p>
    <p class="normal">On macOS, our menu shows up not in the program window, but in the global menu at the top of the screen, as macOS users would expect it to. However, there are some obvious problems.</p>
    <p class="normal">First, while our smiling icon appears, it's cut off. Since the top bar is a fixed height and Tkinter will not resize our icon for us, images larger than the top bar height get truncated. There are bigger problems too: neither the top-level command nor the <code class="Code-In-Text--PACKT-">Checkbutton</code> widget are anywhere to be seen. Only our cascade menu shows up. Color-wise, the top-level menu<a id="_idIndexMarker968"/> ignored our colors, while the cascades only honored the foreground<a id="_idIndexMarker969"/> color (resulting in a fairly unreadable yellow-on-gray combination). Also note that we have a "Python" cascade menu that we did not create.</p>
    <p class="normal">On each platform, we're limited by the capabilities of the menu system, and while it appears that anything goes for menus on Linux, the other two operating systems require more care when constructing menus.</p>
    <p class="normal">To avoid any issues with menus, follow these guidelines:</p>
    <ul>
      <li class="bullet">Avoid command, <code class="Code-In-Text--PACKT-">Checkbutton</code>, and <code class="Code-In-Text--PACKT-">Radiobutton</code> items in the main menu; stick to cascade menus only.</li>
      <li class="bullet">Don't use images in the top-level main menu.</li>
      <li class="bullet">Don't use colors to style the menu, at least not on Windows or macOS.</li>
      <li class="bullet">If you must do any of the preceding points, create separate menus for each platform.</li>
    </ul>
    <p class="normal">If you take the approach of building separate menus for each platform, of course, you can implement whatever features are supported on the platform in question. However, just because you <em class="italic">can</em> use a feature on a platform doesn't necessarily mean you <em class="italic">should</em>. In the next section, we'll look at the guidelines and standards that can help you decide how to implement a menu on each platform.</p>
    <h3 id="_idParaDest-265" class="title">Menu guidelines and standards</h3>
    <p class="normal">Each of our major platforms offers standards to direct developers in making user interfaces that meet<a id="_idIndexMarker970"/> the expectations of that system's users. While these standards should be taken into consideration for the<a id="_idIndexMarker971"/> whole application, one of the most visible areas affected by them is the layout of the application menu (or menu bar, to use the standard terminology).</p>
    <p class="normal">Let's look at the standards available for each platform, which we'll refer to later in the chapter when we create a cross-platform main menu.</p>
    <h4 class="title">Windows user experience interaction guidelines</h4>
    <p class="normal">Microsoft's <em class="italic">Windows user experience interaction guidelines</em>, available at <a href="https://docs.microsoft.com/en-us/windows/win32/uxguide/guidelines">https://docs.microsoft.com/en-us/windows/win32/uxguide/guidelines</a>, offer developers a wealth<a id="_idIndexMarker972"/> of information for designing applications that fit right in to the Windows desktop. Among many guidelines<a id="_idIndexMarker973"/> offered for menu bar design is a description of the standard menu items and how they should be arranged.</p>
    <div><p class="Information-Box--PACKT-">At the time of writing, Microsoft has just released newer guidelines aimed at Windows 11 and the<a id="_idIndexMarker974"/> Universal Windows Platform, available at <a href="https://docs.microsoft.com/en-us/windows/apps/design/basics/">https://docs.microsoft.com/en-us/windows/apps/design/basics/</a>. However, these newer guidelines do not offer specific guidance on menu structure, so we have used the older guidelines instead.</p>
    </div>
    <h4 class="title">Apple's human interface guidelines</h4>
    <p class="normal">Apple's human interface guidelines are available at <a href="https://developer.apple.com/macos/human-interface-guidelines/">https://developer.apple.com/macos/human-interface-guidelines/</a> and offer a detailed set of rules for creating macOS-friendly interfaces.</p>
    <p class="normal">While much<a id="_idIndexMarker975"/> of the basic advice<a id="_idIndexMarker976"/> for menu bar design is similar to that offered by Microsoft, the layout recommendations are quite different and much more specific. For example, the first cascade on a macOS application should be the App menu, a menu named after the application, which contains items like <strong class="keyword">About</strong> and <strong class="keyword">Preferences</strong>.</p>
    <h4 class="title">Linux and BSD human interface guidelines</h4>
    <p class="normal">In sharp contrast to Windows and macOS, Linux, BSD, and other X11 systems have no blessed default desktop environments or controlling entities to dictate UI standards. There are well<a id="_idIndexMarker977"/> over a dozen full desktop<a id="_idIndexMarker978"/> environments available for these platforms, each with its own goals and ideas about user interaction. While<a id="_idIndexMarker979"/> there are multiple projects working to create <strong class="keyword">human interface guidelines</strong> (<strong class="keyword">HIG</strong>) for these platforms, we'll be following the Gnome HIG from the Gnome<a id="_idIndexMarker980"/> project. This set of guidelines is used by the Gnome, MATE, and XFCE desktops and is available at <a href="https://developer.gnome.org/hig/">https://developer.gnome.org/hig/</a>. The Gnome desktop is the default desktop environment on many Linux distributions, including Red Hat, Ubuntu, and notably Debian, which is our target Linux environment at ABQ.</p>
    <h3 id="_idParaDest-266" class="title">Menus and accelerator keys</h3>
    <p class="normal">Accelerator keys are keyboard shortcuts assigned to common application actions, particularly menu items. Thus far, we've added no accelerator keys, which is bad for keyboard-only users.</p>
    <p class="normal">In Tkinter, accelerator keys<a id="_idIndexMarker981"/> can be assigned to a widget using the <code class="Code-In-Text--PACKT-">bind()</code> method. We can also use the <code class="Code-In-Text--PACKT-">bind_all()</code> method, which can be<a id="_idIndexMarker982"/> called on any widget and effectively binds an event globally (that is, even if the widget that called <code class="Code-In-Text--PACKT-">bind_all()</code> is not focused). Our menu items also take an <code class="Code-In-Text--PACKT-">accelerator</code> argument, which can be used to specify a string that will be shown in the menu as an accelerator key hint.</p>
    <p class="normal">The UI guidelines on each platform define standard accelerator keys for common actions, most of which<a id="_idIndexMarker983"/> are the same across platforms since they descend from the IBM <strong class="keyword">Common User Access</strong> (<strong class="keyword">CUA</strong>) standard established in the 1980s. The most notable difference is the use of the command (<img src="img/B17578_10_001.jpg" alt=""/>) key on macOS in place of the control (Ctrl) key used by Windows and Linux.</p>
    <p class="normal">As we rewrite our application menus for cross-platform compatibility, we'll also add platform-appropriate accelerator keys.</p>
    <h2 id="_idParaDest-267" class="title">Cross-platform fonts</h2>
    <p class="normal">In <em class="chapterRef">Chapter 9</em>, <em class="italic">Improving the Look with Styles and Themes</em>, we learned how easy it is to customize Tkinter's fonts to change the look and feel of your application. Doing so, however, can cause inconsistencies across platforms.</p>
    <p class="normal">There are around 18 fonts<a id="_idIndexMarker984"/> that are shared between macOS and Windows, but not all of them look identical on both platforms. As for Linux, most distributions ship with none of those 18 fonts due to license issues. </p>
    <p class="normal">Unless you can guarantee that a particular font is available on all supported platforms, it's best to avoid naming specific font families in your styles. Fortunately, if you do happen to specify a nonexistent font, Tkinter will just use the default, but even that could cause layout or readability issues in certain cases.</p>
    <p class="normal">To be safe, stick with Tkinter's named fonts, which are automatically set to the same defaults on each platform.</p>
    <h2 id="_idParaDest-268" class="title">Cross-platform theme support</h2>
    <p class="normal">As we saw in <em class="chapterRef">Chapter 9</em>, <em class="italic">Improving the Look with Styles and Themes</em>, Ttk provides a number of themes that differ from platform to platform. Each platform contains an alias called "default", which points<a id="_idIndexMarker985"/> to the most sensible theme for that platform. Attempting to set a theme that doesn't exist results in an exception, so avoid hardcoding a theme setting in your application, and make sure theme choices are checked against the output of <code class="Code-In-Text--PACKT-">Style.theme_names()</code>.</p>
    <h2 id="_idParaDest-269" class="title">Window zoomed state</h2>
    <p class="normal">In addition to maximized and minimized<a id="_idIndexMarker986"/> windows, many windowing environments have the concept of a "zoomed" window, which takes over<a id="_idIndexMarker987"/> the screen completely. On Windows or macOS, it can be activated for a Tkinter application using the root window's <code class="Code-In-Text--PACKT-">state()</code> method, as follows:</p>
    <pre class="programlisting code"><code class="hljs-code">from tkinter import *
root = Tk()
root.state('zoomed')
root.mainloop()
</code></pre>
    <p class="normal">On Windows or macOS, this creates a window that takes over the screen; on Linux or BSD, however, it raises an exception because X11 does not provide anything for setting a zoomed state.</p>
    <p class="normal">On X11, this is accomplished by turning on the root window's <code class="Code-In-Text--PACKT-">-zoomed</code> attribute as follows:</p>
    <pre class="programlisting code"><code class="hljs-code">root.attributes('-zoomed', True)
</code></pre>
    <p class="normal">Unfortunately, the preceding code raises an exception on Windows and macOS. If you need to be able to set this state in a program, you'll need to use some platform-specific code.</p>
    <p class="normal">Now that we've walked through a variety of cross-platform issues, let's take a look at ABQ Data Entry and see what we can do to improve its behavior across different operating systems.</p>
    <h1 id="_idParaDest-270" class="title">Improving our application's cross-platform compatibility</h1>
    <p class="normal">Our application<a id="_idIndexMarker988"/> does pretty well across platforms, but there are some things we can do to improve it:</p>
    <ul>
      <li class="bullet">First, our application stores its preferences in the user's home folder, which is not ideal on any platform. Most desktop platforms define specific locations where configuration files should be placed, so we will fix our application to use those for the <code class="Code-In-Text--PACKT-">abq_settings.json</code> file.</li>
      <li class="bullet">Second, we're creating our CSV files without specifying any encoding; if a user inserted a Unicode character (say, in the <code class="Code-In-Text--PACKT-">Notes</code> field), file saving would raise an exception and fail on non-Unicode platforms.</li>
      <li class="bullet">Finally, the current menu structure does not really come close to following any of the human interface guidelines we've discussed. We'll implement separate menus for each platform to ensure users have a UI that is consistent with their platform.</li>
    </ul>
    <p class="normal">Let's get started!</p>
    <h2 id="_idParaDest-271" class="title">Storing preferences correctly</h2>
    <p class="normal">Each platform<a id="_idIndexMarker989"/> defines a proper location for storing<a id="_idIndexMarker990"/> user configuration files:</p>
    <ul>
      <li class="bullet">Linux and other X11 systems store configuration files in a location defined in the <code class="Code-In-Text--PACKT-">$XDG_CONFIG_HOME</code> environment variable, which defaults to <code class="Code-In-Text--PACKT-">$HOME/.config</code> if it's not defined.</li>
      <li class="bullet">macOS user configuration files are stored in <code class="Code-In-Text--PACKT-">$HOME/Library/Application Support/</code>.</li>
      <li class="bullet">Windows user configuration files are stored in <code class="Code-In-Text--PACKT-">%USERPROFILE%\AppData\Local</code>. Though if your environment uses <strong class="keyword">Active Directory</strong> (<strong class="keyword">AD</strong>) with roaming profiles, you might prefer to use <code class="Code-In-Text--PACKT-">%HOME%\AppData\Roaming</code> instead.</li>
    </ul>
    <p class="normal">To realize this in our application, we'll need to update the <code class="Code-In-Text--PACKT-">SettingsModel</code> class. Remember that our <code class="Code-In-Text--PACKT-">SettingsModel</code> class's initializer method currently places the configuration file in <code class="Code-In-Text--PACKT-">Path.home()</code>, which returns the user's home directory on each platform. Let's update this with some platform-specific code.</p>
    <p class="normal">To begin, open <code class="Code-In-Text--PACKT-">models.py</code> and import the <code class="Code-In-Text--PACKT-">platform</code> module, like so:</p>
    <pre class="programlisting code"><code class="hljs-code"># models.py, at the top
import platform
</code></pre>
    <p class="normal">To figure out the directories required, we're going to need to get the name of the platform, as well as some environment variables. The <code class="Code-In-Text--PACKT-">os.environ</code> variable is a dictionary containing the<a id="_idIndexMarker991"/> environment variables set on the system. Since we've already imported <code class="Code-In-Text--PACKT-">os</code> into the <code class="Code-In-Text--PACKT-">models.py</code> file, we can use <code class="Code-In-Text--PACKT-">os.environ</code> to retrieve the variables we need.</p>
    <p class="normal">In the <code class="Code-In-Text--PACKT-">SettingsModel</code> class, we'll create a dictionary for looking up the correct configuration directories, like so:</p>
    <pre class="programlisting code"><code class="hljs-code">  config_dirs = {
    "Linux": Path(
      os.environ.get('$XDG_CONFIG_HOME', Path.home() / '.config')
    ),
    "freebsd7": Path(
      os.environ.get('$XDG_CONFIG_HOME', Path.home() / '.config')
    ),
    'Darwin': Path.home() / 'Library' / 'Application Support',
    'Windows': Path.home() / 'AppData' / 'Local'
  }
</code></pre>
    <p class="normal">In each case, we've matched<a id="_idIndexMarker992"/> a platform name with a <code class="Code-In-Text--PACKT-">pathlib.Path</code> object pointing to the default configuration directory for each platform. Now, inside the <code class="Code-In-Text--PACKT-">SettingsModel</code> initializer, we just need to look up the correct directory using the value of <code class="Code-In-Text--PACKT-">platform.system()</code>.</p>
    <p class="normal">Update the <code class="Code-In-Text--PACKT-">__init__()</code> method as follows:</p>
    <pre class="programlisting code"><code class="hljs-code">  def __init__(self):
    filename = 'abq_settings.json'
    <strong class="hljs-slc">filedir = self.config_dirs.get(platform.system(), Path.home())</strong>
    self.filepath = filedir / filename
    self.load()
</code></pre>
    <p class="normal">If the platform is not in our list, we simply default to <code class="Code-In-Text--PACKT-">Path.home()</code> to place the configuration file<a id="_idIndexMarker993"/> in the user's home directory. Otherwise, the file should be placed correctly for the platform.</p>
    <p class="normal">Now when<a id="_idIndexMarker994"/> you run the application, you should find that any previous preferences are reset to the default (since we're now looking for the configuration file in a different location), and that if you save new preferences, the file <code class="Code-In-Text--PACKT-">abq_settings.json</code> shows up in your platform's configuration directory.</p>
    <h2 id="_idParaDest-272" class="title">Specifying an encoding for our CSV file</h2>
    <p class="normal">Our application is currently saving CSV files using the system's default encoding. This could be a problem<a id="_idIndexMarker995"/> for Windows users if they try<a id="_idIndexMarker996"/> to use Unicode characters.</p>
    <p class="normal">In <code class="Code-In-Text--PACKT-">models.py</code>, we need to locate the three instances of <code class="Code-In-Text--PACKT-">open()</code> in our <code class="Code-In-Text--PACKT-">CSVModel</code> class and specify an encoding, as in this example:</p>
    <pre class="programlisting code"><code class="hljs-code"># models.py, in CSVModel.save_record()
    with open(
      self.filename, 'a', encoding='utf-8', newline=''
    ) as fh:
</code></pre>
    <p class="normal">Make sure to update all the <code class="Code-In-Text--PACKT-">open()</code> calls in <code class="Code-In-Text--PACKT-">models.py</code>, including those in <code class="Code-In-Text--PACKT-">SettingsModel</code>. With this change, the Unicode characters should no longer be a problem.</p>
    <h2 id="_idParaDest-273" class="title">Making platform-appropriate menus</h2>
    <p class="normal">Creating platform-specific menus is going to be a bit more involved than the previous fixes. Our basic<a id="_idIndexMarker997"/> approach will be to create multiple menu classes and use a selector function to return an appropriate<a id="_idIndexMarker998"/> class as explained in the previous section.</p>
    <p class="normal">Before we can do this, we'll need to prepare our <code class="Code-In-Text--PACKT-">MainMenu</code> class so that it's easier to subclass.</p>
    <h3 id="_idParaDest-274" class="title">Preparing our MainMenu class</h3>
    <p class="normal">Currently, the bulk of the configuration of our <code class="Code-In-Text--PACKT-">MainMenu</code> class takes place in <code class="Code-In-Text--PACKT-">__init__()</code>. For each platform, though, we're going to need to build the menu with a different structure, and<a id="_idIndexMarker999"/> with some different details for<a id="_idIndexMarker1000"/> certain commands. To make this simpler, we're going to take a compositional approach, in which we'll break the menu creation into many discrete methods<a id="_idIndexMarker1001"/> that we can then compose in each subclass as needed.</p>
    <p class="normal">The first thing we'll do is change its name to explain its role more clearly:</p>
    <pre class="programlisting code"><code class="hljs-code">class GenericMainMenu(tk.Menu):
  styles = dict()
</code></pre>
    <p class="normal">We've also created an empty <code class="Code-In-Text--PACKT-">styles</code> dictionary as a class attribute. Since menu styles are not supported across all platforms well, this empty dictionary can act as a placeholder so that we can apply styles when desired by simply overriding this attribute.</p>
    <p class="normal">Next, we're going to create individual methods for creating each menu item. Because these items may be added to different menus depending on the platform, each method will take a <code class="Code-In-Text--PACKT-">menu</code> argument that will be used to specify which <code class="Code-In-Text--PACKT-">Menu</code> object it will be added to.</p>
    <p class="normal">Let's begin with methods for creating our <strong class="screenText">Select file</strong> and <strong class="screenText">Quit</strong> command entries:</p>
    <pre class="programlisting code"><code class="hljs-code">  def _add_file_open(self, menu):
    menu.add_command(
      label='Select file', command=self._event('&lt;&lt;FileSelect&gt;&gt;'),
      image=self.icons.get('file'), compound=tk.LEFT
  )
  def _add_quit(self, menu):
    menu.add_command(
      label='Quit', command=self._event('&lt;&lt;FileQuit&gt;&gt;'),
      image=self.icons.get('quit'), compound=tk.LEFT
    )
</code></pre>
    <p class="normal">Next, create the methods to add the auto-fill settings options:</p>
    <pre class="programlisting code"><code class="hljs-code">  def _add_autofill_date(self, menu):
    menu.add_checkbutton(
      label='Autofill Date', variable=self.settings['autofill date']
    )
  def _add_autofill_sheet(self, menu):
    menu.add_checkbutton(
      label='Autofill Sheet data',
      variable=self.settings['autofill sheet data']
    )
</code></pre>
    <p class="normal">For our font options<a id="_idIndexMarker1002"/> that have their own<a id="_idIndexMarker1003"/> sub-menus, we'll create methods that create the whole sub-menu, like so:</p>
    <pre class="programlisting code"><code class="hljs-code">  def _add_font_size_menu(self, menu):
    font_size_menu = tk.Menu(self, tearoff=False, **self.styles)
    for size in range(6, 17, 1):
      font_size_menu.add_radiobutton(
        label=size, value=size,
        variable=self.settings['font size']
      )
    menu.add_cascade(label='Font size', menu=font_size_menu)
  def _add_font_family_menu(self, menu):
    font_family_menu = tk.Menu(self, tearoff=False, **self.styles)
    for family in font.families():
      font_family_menu.add_radiobutton(
        label=family, value=family,
        variable=self.settings['font family']
    )
    menu.add_cascade(label='Font family', menu=font_family_menu)
</code></pre>
    <p class="normal">Note that we've used the <code class="Code-In-Text--PACKT-">self.styles</code> dict in defining our cascade menus; although it's empty in this class, we want the styles to apply to all menus if we define them.</p>
    <p class="normal">For the themes menu, we'll do the same, and also set up the trace that displays the warning message, as follows:</p>
    <pre class="programlisting code"><code class="hljs-code">  def _add_themes_menu(self, menu):
    style = ttk.Style()
    themes_menu = tk.Menu(self, tearoff=False, **self.styles)
    for theme in style.theme_names():
      themes_menu.add_radiobutton(
        label=theme, value=theme,
        variable=self.settings['theme']
      )
    menu.add_cascade(label='Theme', menu=themes_menu)
    self.settings['theme'].trace_add('write', self._on_theme_change)
</code></pre>
    <p class="normal">Finally, let's add<a id="_idIndexMarker1004"/> the last three methods for our navigation<a id="_idIndexMarker1005"/> and About commands:</p>
    <pre class="programlisting code"><code class="hljs-code">  def _add_go_record_list(self, menu):
    menu.add_command(
      label="Record List", command=self._event('&lt;&lt;ShowRecordlist&gt;&gt;'),
      image=self.icons.get('record_list'), compound=tk.LEFT
    )
  def _add_go_new_record(self, menu):
    menu.add_command(
      label="New Record", command=self._event('&lt;&lt;NewRecord&gt;&gt;'),
      image=self.icons.get('new_record'), compound=tk.LEFT
    )
  def _add_about(self, menu):
    menu.add_command(
      label='About', command=self.show_about,
      image=self.icons.get('about'), compound=tk.LEFT
    )
</code></pre>
    <p class="normal">Now, to compose these methods into a menu, we'll create a new method called <code class="Code-In-Text--PACKT-">_build_menu()</code>. This method can be overridden by our subclasses, leaving <code class="Code-In-Text--PACKT-">__init__()</code> to take care of the common setup tasks.</p>
    <p class="normal">To see how this will work, let's create a version of this method that will recreate our generic menu:</p>
    <pre class="programlisting code"><code class="hljs-code">  def _build_menu(self):
    # The file menu
    self._menus['File'] = tk.Menu(self, tearoff=False, **self.styles)
    self._add_file_open(self._menus['File'])
    self._menus['File'].add_separator()
    self._add_quit(self._menus['File'])
    # The options menu
    self._menus['Options'] = 
      tk.Menu(
        self, tearoff=False, **self.styles
      )
    self._add_autofill_date(self._menus['Options'])
    self._add_autofill_sheet(self._menus['Options'])
    self._add_font_size_menu(self._menus['Options'])
    self._add_font_family_menu(self._menus['Options'])
    self._add_themes_menu(self._menus['Options'])
    # switch from recordlist to recordform
    self._menus['Go'] = tk.Menu(self, tearoff=False, **self.styles)
    self._add_go_record_list(self._menus['Go'])
    self._add_go_new_record(self._menus['Go'])
    # The help menu
    self._menus['Help'] = tk.Menu(self, tearoff=False, **self.styles)
    self.add_cascade(label='Help', menu=self._menus['Help'])
    self._add_about(self._menus['Help'])
    for label, menu in self._menus.items():
      self.add_cascade(label=label, menu=menu)
</code></pre>
    <p class="normal">Here, we're creating our File, Options, Go, and Help cascade menus, and passing each one to the<a id="_idIndexMarker1006"/> appropriate item-adding methods<a id="_idIndexMarker1007"/> to set up its items. We're storing these in a dictionary, <code class="Code-In-Text--PACKT-">self._menus</code>, rather than as local variables. At the end of the method, we iterate through the dictionary to add each cascade to the main menu.</p>
    <p class="normal">Now, we can reduce the initializer of this class to a bare skeleton of method calls, like so:</p>
    <pre class="programlisting code"><code class="hljs-code">  def __init__(self, parent, settings, **kwargs):
    super().__init__(parent, **kwargs)
    self.settings = settings
    self._create_icons()
    self._menus = dict()
    self._build_menu()
    self.configure(**self.styles)
</code></pre>
    <p class="normal">After calling the superclass initializer, this method just saves the settings, creates the icons and the <code class="Code-In-Text--PACKT-">_menus</code> dictionary, then calls <code class="Code-In-Text--PACKT-">_build_menu()</code>. If any styles are set, those are applied to the main menu by <code class="Code-In-Text--PACKT-">self.configure()</code>.</p>
    <h3 id="_idParaDest-275" class="title">Adding accelerators</h3>
    <p class="normal">Before we start building subclasses of <code class="Code-In-Text--PACKT-">GenericMainMenu</code>, let's make it possible to add platform-specific accelerator keys to each menu. These are simply keyboard shortcuts that can activate our<a id="_idIndexMarker1008"/> menu items. We don't need these for every menu item, just a few commands that will be commonly used.</p>
    <p class="normal">To create a key binding<a id="_idIndexMarker1009"/> to menu items, there are two steps:</p>
    <ol>
      <li class="numbered" value="1">Bind the keyboard event to the callback using the <code class="Code-In-Text--PACKT-">bind_all()</code> method.</li>
      <li class="numbered">Label the menu item with the keyboard sequence using the menu entry's accelerator argument.</li>
    </ol>
    <p class="normal">It's important<a id="_idIndexMarker1010"/> to understand that we need to do both; the <code class="Code-In-Text--PACKT-">accelerator</code> argument does not automatically set up the key binding, it just determines how the menu item will be labeled. Likewise, the <code class="Code-In-Text--PACKT-">bind_all()</code> method will not cause menu items to be labeled, it will just create the event binding.</p>
    <p class="normal">To accomplish both, we'll create two class attribute dictionaries, one for the accelerators and one for the key bindings, like so:</p>
    <pre class="programlisting code"><code class="hljs-code">class GenericMainMenu(tk.Menu):
  accelerators = {
    'file_open': 'Ctrl+O',
    'quit': 'Ctrl+Q',
    'record_list': 'Ctrl+L',
    'new_record': 'Ctrl+R',
  }
  keybinds = {
    '&lt;Control-o&gt;': '&lt;&lt;FileSelect&gt;&gt;',
    '&lt;Control-q&gt;': '&lt;&lt;FileQuit&gt;&gt;',
    '&lt;Control-n&gt;': '&lt;&lt;NewRecord&gt;&gt;',
    '&lt;Control-l&gt;': '&lt;&lt;ShowRecordlist&gt;&gt;'
  }
</code></pre>
    <p class="normal">The first dictionary simply matches accelerator strings with keys that we can use in our menu definition methods. To use this dictionary, we just need to update those methods to include the accelerator; for example, update the <code class="Code-In-Text--PACKT-">_add_file_open()</code> method like so:</p>
    <pre class="programlisting code"><code class="hljs-code"># mainmenu.py, inside the GenericMainMenu class
  def _add_file_open(self, menu):
    menu.add_command(
      label='Select file',
      command=self._event('&lt;&lt;FileSelect&gt;&gt;'),
      <strong class="hljs-slc">accelerator=self.accelerators.get('file_open')</strong>,
      image=self.icons.get('file'),
      compound=tk.LEFT
  )
</code></pre>
    <p class="normal">Go ahead<a id="_idIndexMarker1011"/> and add the <code class="Code-In-Text--PACKT-">accelerator</code> argument<a id="_idIndexMarker1012"/> to the <code class="Code-In-Text--PACKT-">add_command()</code> calls in <code class="Code-In-Text--PACKT-">_add_quit()</code>, <code class="Code-In-Text--PACKT-">_add_go_record_list()</code>, and <code class="Code-In-Text--PACKT-">_add_go_new_record()</code> as well.</p>
    <p class="normal">To handle the key bindings, we just need to create a method that will make the key bindings. Add this <code class="Code-In-Text--PACKT-">_bind_accelerators()</code> method to the class:</p>
    <pre class="programlisting code"><code class="hljs-code"># mainmenu.py, inside the GenericMainMenu class
  def _bind_accelerators(self):
    for key, sequence in self.keybinds.items():
      self.bind_all(key, self._event(sequence))
</code></pre>
    <p class="normal">The <code class="Code-In-Text--PACKT-">_bind_accelerators()</code> method iterates the <code class="Code-In-Text--PACKT-">keybinds</code> dictionary and binds each key sequence to a function created by the <code class="Code-In-Text--PACKT-">_event()</code> method that will generate the given event. Note that we've used <code class="Code-In-Text--PACKT-">bind_all()</code> here; unlike the <code class="Code-In-Text--PACKT-">bind()</code> method, which only responds to events on the widget, the <code class="Code-In-Text--PACKT-">bind_all()</code> method will cause the callback to be executed when the event is generated on <em class="italic">any</em> widget. Thus, regardless of what widget is selected or in focus, a Control + Q keystroke will quit the program, for example.</p>
    <p class="normal">The final piece is to call this new method from our initializer. Add this to the end of <code class="Code-In-Text--PACKT-">GenericMainMenu.__init__()</code>:</p>
    <pre class="programlisting code"><code class="hljs-code">    self._bind_accelerators()
</code></pre>
    <p class="normal">Now the <code class="Code-In-Text--PACKT-">GenericMainMenu</code> class is ready for subclassing. Let's go through one platform at a time and figure out what needs to be updated.</p>
    <h3 id="_idParaDest-276" class="title">Building the Windows menu</h3>
    <p class="normal">After studying the <em class="italic">Windows user experience interaction guidelines</em>, you deem the following changes<a id="_idIndexMarker1013"/> are necessary to make<a id="_idIndexMarker1014"/> our menu Windows-friendly:</p>
    <ul>
      <li class="bullet"><strong class="screenText">File</strong> | <strong class="screenText">Quit</strong> should be changed to <strong class="screenText">File</strong> | <strong class="screenText">Exit</strong>, and there should be no accelerator for it. Windows uses Alt + F4 to close programs, and this is handled by Windows automatically.</li>
      <li class="bullet">Windows can handle commands in the menu bar just fine, and the guidelines encourage this for frequently used functionality. We'll move our Record List and New Record commands directly to the main menu. We'll have to remove the icons, though, since it can't handle icons in the main menu.</li>
      <li class="bullet">Configuration option items are supposed to go under a Tools menu, separated from the rest of the items in tools (if there are any). We'll need to create a Tools menu and move our options there.</li>
    </ul>
    <p class="normal">Let's implement these changes and create our Windows menu class. Start by subclassing the <code class="Code-In-Text--PACKT-">GenericMainMenu</code> class like so:</p>
    <pre class="programlisting code"><code class="hljs-code">class WindowsMainMenu(GenericMainMenu):
</code></pre>
    <p class="normal">The first thing we'll do is override the initializer so we can remove the keybinding for <strong class="screenText">File</strong> | <strong class="screenText">Exit</strong>:</p>
    <pre class="programlisting code"><code class="hljs-code"># mainmenu.py, inside WindowsMainMenu
  def __init__(self, *args, **kwargs):
    del(self.keybinds['&lt;Control-q&gt;'])
    super().__init__(*args, **kwargs)
</code></pre>
    <p class="normal">Next, we'll need to override the <code class="Code-In-Text--PACKT-">_add_quit()</code> method to relabel it and remove the accelerator:</p>
    <pre class="programlisting code"><code class="hljs-code">  def _add_quit(self, menu):
    menu.add_command(
      label='Exit', command=self._event('&lt;&lt;FileQuit&gt;&gt;'),
      image=self.icons.get('quit'), compound=tk.LEFT
    )
</code></pre>
    <p class="normal">We need to remove the icons for the two navigation commands, so that we don't have the <strong class="screenText">(Image)</strong> string showing up in our menu. To do that, we'll next override the <code class="Code-In-Text--PACKT-">_create_icons()</code> method, as follows:</p>
    <pre class="programlisting code"><code class="hljs-code"># mainmenu.py, inside WindowsMainMenu
  def _create_icons(self):
    super()._create_icons()
    del(self.icons['new_record'])
    del(self.icons['record_list'])
</code></pre>
    <p class="normal">The superclass version of the method creates <code class="Code-In-Text--PACKT-">self.icons</code>, so we just need to run it and delete the icons we don't want.</p>
    <p class="normal">Now that those<a id="_idIndexMarker1015"/> are fixed, we can create the <code class="Code-In-Text--PACKT-">_build_menu()</code> method to compose our menu, starting<a id="_idIndexMarker1016"/> with the three cascades like so:</p>
    <pre class="programlisting code"><code class="hljs-code">  def _build_menu(self):
    # The File menu
    self._menus['File'] = tk.Menu(self, tearoff=False)
    self._add_file_open(self._menus['File'])
    self._menus['File'].add_separator()
    self._add_quit(self._menus['File'])
    # The Tools menu
    self._menus['Tools'] = tk.Menu(self, tearoff=False)
    self._add_autofill_date(self._menus['Tools'])
    self._add_autofill_sheet(self._menus['Tools'])
    self._add_font_size_menu(self._menus['Tools'])
    self._add_font_family_menu(self._menus['Tools'])
    self._add_themes_menu(self._menus['Tools'])
    # The Help menu
    self._menus['Help'] = tk.Menu(self, tearoff=False)
    self._add_about(self._menus['Help'])
</code></pre>
    <p class="normal">Since we'd like to add our navigation command entries for Record List and New<code class="Code-In-Text--PACKT-"> </code>Record directly to the main menu rather than to a cascade menu, we can't just iterate over the <code class="Code-In-Text--PACKT-">_menus</code> dictionary to add the cascades. Instead, we'll have to manually add the entries to the top-level menu, like so:</p>
    <pre class="programlisting code"><code class="hljs-code">    self.add_cascade(label='File', menu=self._menus['File'])
    self.add_cascade(label='Tools', menu=self._menus['Tools'])
    self._add_go_record_list(self)
    self._add_go_new_record(self)
    self.add_cascade(label='Help', menu=self._menus['Help'])
</code></pre>
    <p class="normal">The Windows menu<a id="_idIndexMarker1017"/> is now complete and ready<a id="_idIndexMarker1018"/> to use. Let's move on to the next platform!</p>
    <h3 id="_idParaDest-277" class="title">Building the Linux menu</h3>
    <p class="normal">Our <code class="Code-In-Text--PACKT-">GenericMainMenu</code> class is pretty<a id="_idIndexMarker1019"/> close to the Gnome HIG, but there is one change to be made: our Options menu doesn't really belong; rather, we need to split its items into two categories:</p>
    <ul>
      <li class="bullet">The autofill options, since<a id="_idIndexMarker1020"/> they change the way data is entered in the form, belong in an Edit menu.</li>
      <li class="bullet">The font and theme options, since<a id="_idIndexMarker1021"/> they only change the appearance of the application and not the actual data, belong in a View menu.</li>
    </ul>
    <p class="normal">Since Linux<a id="_idIndexMarker1022"/> also fully supports menu colors, we'll add our color styles back to this version of the menu.</p>
    <p class="normal">Let's start by subclassing <code class="Code-In-Text--PACKT-">GenericMainMenu</code> and defining some styles:</p>
    <pre class="programlisting code"><code class="hljs-code"># mainmenu.py
class LinuxMainMenu(GenericMainMenu):
  styles = {
    'background': '#333',
    'foreground': 'white',
    'activebackground': '#777',
    'activeforeground': 'white',
    'relief': tk.GROOVE
  }
</code></pre>
    <p class="normal">These menu styles aren't strictly necessary, but if we're going to make a separate menu for Linux, we may as well take advantage of some of its features!</p>
    <p class="normal">Now let's begin the <code class="Code-In-Text--PACKT-">_build_menu()</code> method with the File and Edit menus:</p>
    <pre class="programlisting code"><code class="hljs-code">  def _build_menu(self):
    self._menus['File'] = tk.Menu(self, tearoff=False, **self.styles)
    self._add_file_open(self._menus['File'])
    self._menus['File'].add_separator()
    self._add_quit(self._menus['File'])
    self._menus['Edit'] = tk.Menu(self, tearoff=False, **self.styles)
    self._add_autofill_date(self._menus['Edit'])
    self._add_autofill_sheet(self._menus['Edit'])
</code></pre>
    <p class="normal">Note that we've added back <code class="Code-In-Text--PACKT-">**self.styles</code> to each <code class="Code-In-Text--PACKT-">Menu()</code> call to apply the styles. We'll do the same building the next three cascades, as follows:</p>
    <pre class="programlisting code"><code class="hljs-code">    self._menus['View'] = tk.Menu(self, tearoff=False, **self.styles)
    self._add_font_size_menu(self._menus['View'])
    self._add_font_family_menu(self._menus['View'])
    self._add_themes_menu(self._menus['View'])
    self._menus['Go'] = tk.Menu(self, tearoff=False, **self.styles)
    self._add_go_record_list(self._menus['Go'])
    self._add_go_new_record(self._menus['Go'])
    self._menus['Help'] = tk.Menu(self, tearoff=False, **self.styles)
    self._add_about(self._menus['Help'])
</code></pre>
    <p class="normal">Finally, we'll iterate over the <code class="Code-In-Text--PACKT-">_menus</code> dictionary and add all the cascades:</p>
    <pre class="programlisting code"><code class="hljs-code">    for label, menu in self._menus.items():
      self.add_cascade(label=label, menu=menu)
</code></pre>
    <p class="normal">We don't need<a id="_idIndexMarker1023"/> to change anything else; our<a id="_idIndexMarker1024"/> accelerators and the rest of the menu line up pretty well with the Gnome HIG.</p>
    <h3 id="_idParaDest-278" class="title">Building the macOS menu</h3>
    <p class="normal">Of the three platform-specific menus, the macOS menu will need the most extensive changes. Unlike the Windows<a id="_idIndexMarker1025"/> and Gnome guidelines, which mostly suggest categories, the Apple guidelines are very specific about<a id="_idIndexMarker1026"/> which menus should be created and which items belong in them. Furthermore, macOS also creates and pre-populates some of these menus with default commands, so we'll need to use special arguments to hook into those menus and add our own items.</p>
    <p class="normal">The changes we need to make to comply with Apple's HIG are as follows:</p>
    <ul>
      <li class="bullet">We need to create an <strong class="keyword">App menu</strong>. This is the first menu macOS creates, just to the right of the Apple icon on the menu bar. It's created by default, but we'll need to hook into it to add some custom items.</li>
      <li class="bullet">The About command belongs in the App menu; we'll move it there and remove the unused Help menu.</li>
      <li class="bullet">Since macOS will provide a Quit command for us, we'll remove ours.</li>
      <li class="bullet">As we did with the Linux menu, our options will be split between the Edit and View menus.</li>
      <li class="bullet">We need to add a Window menu; this is another autogenerated menu that macOS fills with window management and navigation functions. Our navigation items will be moved from the Go menu to this menu.</li>
      <li class="bullet">Finally, macOS<a id="_idIndexMarker1027"/> uses the command key rather than the Control key to activate accelerators. We need to update both our key bindings and accelerator dictionaries accordingly.</li>
    </ul>
    <p class="normal">As before, we'll start by creating a subclass of <code class="Code-In-Text--PACKT-">GenericMainMenu</code>:</p>
    <pre class="programlisting code"><code class="hljs-code">class MacOsMainMenu(GenericMainMenu):
  keybinds = {
    '&lt;Command-o&gt;': '&lt;&lt;FileSelect&gt;&gt;',
    '&lt;Command-n&gt;': '&lt;&lt;NewRecord&gt;&gt;',
    '&lt;Command-l&gt;': '&lt;&lt;ShowRecordlist&gt;&gt;'
  }
  accelerators = {
    'file_open': 'Cmd-O',
    'record_list': 'Cmd-L',
    'new_record': 'Cmd-R',
  }
</code></pre>
    <p class="normal">The first thing we've done is redefine the <code class="Code-In-Text--PACKT-">keybinds</code> and <code class="Code-In-Text--PACKT-">accelerators</code> dictionaries to remove the <code class="Code-In-Text--PACKT-">Quit</code> entries and change "<code class="Code-In-Text--PACKT-">Control</code>" <code class="Code-In-Text--PACKT-">to</code> "<code class="Code-In-Text--PACKT-">Command</code>". Note that, when the menu displays, Tkinter<a id="_idIndexMarker1028"/> will automatically replace the strings <code class="Code-In-Text--PACKT-">Command</code> or <code class="Code-In-Text--PACKT-">Cmd</code> with the symbol for the command key (<img src="img/B17578_10_0011.jpg" alt=""/>), so make sure to use one or the other when specifying accelerators.</p>
    <p class="normal">Now, let's start working on the <code class="Code-In-Text--PACKT-">_build_menu()</code> method, as follows:</p>
    <pre class="programlisting code"><code class="hljs-code">  def _build_menu(self):
    self._menus['ABQ Data Entry'] = tk.Menu(
      self, tearoff=False,
      name='apple'
    )
    self._add_about(self._menus['ABQ Data Entry'])
    self._menus['ABQ Data Entry'].add_separator()
</code></pre>
    <p class="normal">The first order of business is the App menu. To access this built-in menu, all we need to do is pass in a <code class="Code-In-Text--PACKT-">name</code> argument set to <code class="Code-In-Text--PACKT-">apple</code> when we create the <code class="Code-In-Text--PACKT-">Menu</code> object. The App menu should contain both our About option and our Quit option, but we only need to add the former since macOS automatically adds a Quit action. Note that we've also added a separator, which should always be added after the About command.</p>
    <div><p class="Tip--PACKT-">The App menu should <em class="italic">always</em> be the first menu you add to the main menu on macOS. If you add anything else first, your customized app menu items will be added in their own menu rather than in the generated App menu.</p>
    </div>
    <p class="normal">Before moving on, we need<a id="_idIndexMarker1029"/> to make one correction to our About command. Apple's HIG specifies that<a id="_idIndexMarker1030"/> this command should read <em class="italic">About &lt;program name&gt;</em> rather than just <em class="italic">About</em>. So, we'll need to override <code class="Code-In-Text--PACKT-">_add_about()</code> to correct this, like so:</p>
    <pre class="programlisting code"><code class="hljs-code"># mainmenu.py, inside MacOSMainMenu
  def _add_about(self, menu):
    menu.add_command(
      label='About ABQ Data Entry', command=self.show_about,
      image=self.icons.get('about'), compound=tk.LEFT
    )
</code></pre>
    <div><p class="Information-Box--PACKT-">Your App menu will currently read "Python" rather than "ABQ Data Entry". We'll address this when we package our application in <em class="chapterRef">Chapter 16</em>, <em class="italic">Packaging with setuptools and cxFreeze</em>.</p>
    </div>
    <p class="normal">After the App menu is created, let's create our File, Edit, and View menus, like so:</p>
    <pre class="programlisting code"><code class="hljs-code"># mainmenu.py, inside MacOSMainMenu._build_menu()    
    self._menus['File'] = tk.Menu(self, tearoff=False)
    self.add_cascade(label='File', menu=self._menus['File'])
    self._add_file_open(self._menus['File'])
    self._menus['Edit'] = tk.Menu(self, tearoff=False)
    self._add_autofill_date(self._menus['Edit'])
    self._add_autofill_sheet(self._menus['Edit'])
    self._menus['View'] = tk.Menu(self, tearoff=False)
    self._add_font_size_menu(self._menus['View'])
    self._add_font_family_menu(self._menus['View'])
    self._add_themes_menu(self._menus['View'])
</code></pre>
    <p class="normal">We don't really need to do anything different there; however, the <code class="Code-In-Text--PACKT-">Window</code> menu is another automatically generated menu created by macOS, so we will once again need to use the <code class="Code-In-Text--PACKT-">name</code> argument<a id="_idIndexMarker1031"/> when creating it:</p>
    <pre class="programlisting code"><code class="hljs-code">    self._menus['Window'] = tk.Menu(
      self, name='window', tearoff=False
    )
    self._add_go_record_list(self._menus['Window'])
    self._add_go_new_record(self._menus['Window'])
</code></pre>
    <p class="normal">Finally, let's iterate<a id="_idIndexMarker1032"/> over the <code class="Code-In-Text--PACKT-">_menus</code> dictionary and add all the cascades:</p>
    <pre class="programlisting code"><code class="hljs-code">    for label, menu in self._menus.items():
      self.add_cascade(label=label, menu=menu)
</code></pre>
    <div><p class="Information-Box--PACKT-">Even though macOS automatically creates the App and Window menus, you still need to explicitly add the <code class="Code-In-Text--PACKT-">Menu</code> objects to the main menu using <code class="Code-In-Text--PACKT-">add_cascade()</code>, or your added items will not appear on the automatically created menu. </p>
    </div>
    <p class="normal">That completes our macOS menu class.</p>
    <h3 id="_idParaDest-279" class="title">Creating and using our selector function</h3>
    <p class="normal">With our classes<a id="_idIndexMarker1033"/> created, let's add a simple selector function<a id="_idIndexMarker1034"/> to return the appropriate<a id="_idIndexMarker1035"/> class for each platform; add this<a id="_idIndexMarker1036"/> code to <code class="Code-In-Text--PACKT-">mainmenu.py</code>:</p>
    <pre class="programlisting code"><code class="hljs-code"># mainmenu.py, at the end
def get_main_menu_for_os(os_name):
  menus = {
    'Linux': LinuxMainMenu,
    'Darwin': MacOsMainMenu,
    'freebsd7': LinuxMainMenu,
    'Windows': WindowsMainMenu
  }
  return menus.get(os_name, GenericMainMenu)
</code></pre>
    <p class="normal">The keys in this dictionary are the output strings from <code class="Code-In-Text--PACKT-">platform.system()</code>, which we have pointed to a platform-appropriate menu class. In the event we're running on some new, unknown system, we default to the <code class="Code-In-Text--PACKT-">GenericMainMenu</code> class.</p>
    <p class="normal">Now, back in <code class="Code-In-Text--PACKT-">application.py</code>, we'll change our import statement from <code class="Code-In-Text--PACKT-">mainmenu</code> to only import this function, like so:</p>
    <pre class="programlisting code"><code class="hljs-code"># application.py, at the top
from .mainmenu import get_main_menu_for_os
import platform
</code></pre>
    <p class="normal">Note that we've also<a id="_idIndexMarker1037"/> imported <code class="Code-In-Text--PACKT-">platform</code>, which we'll use<a id="_idIndexMarker1038"/> to determine the running<a id="_idIndexMarker1039"/> operating system.</p>
    <p class="normal">Now, instead<a id="_idIndexMarker1040"/> of calling <code class="Code-In-Text--PACKT-">v.MainMenu()</code> (which no longer exists), we use the following function:</p>
    <pre class="programlisting code"><code class="hljs-code"># application.py, inside Application.__init__()
    # menu = MainMenu(self, self.settings)
    <strong class="hljs-slc">menu_class = get_main_menu_for_os(platform.system())</strong>
    <strong class="hljs-slc">menu = menu_class(self, self.settings)</strong>
    self.config(menu=menu)
</code></pre>
    <p class="normal">Now when you run the application, your menu appearance will change according to the platform. On Windows, you should see something like this:</p>
    <figure class="mediaobject"><img src="img/B17578_10_04.png" alt="Figure 10.4: The menu system on a Windows computer"/></figure>
    <p class="packt_figref">Figure 10.4: The menu system on a Windows computer</p>
    <p class="normal">On macOS, you'll see<a id="_idIndexMarker1041"/> something like<a id="_idIndexMarker1042"/> this:</p>
    <figure class="mediaobject"><img src="img/B17578_10_05.png" alt="Figure 10.5: The menu system on macOS"/></figure>
    <p class="packt_figref">Figure 10.5: The menu system on macOS</p>
    <p class="normal">On Linux<a id="_idIndexMarker1043"/> or BSD, you'll see a menu<a id="_idIndexMarker1044"/> as shown in the following screenshot:</p>
    <figure class="mediaobject"><img src="img/B17578_10_06.png" alt="Figure 10.5: The menu system on Ubuntu Linux"/></figure>
    <p class="packt_figref">Figure 10.6: The menu system on Ubuntu Linux</p>
    <h1 id="_idParaDest-280" class="title">Summary</h1>
    <p class="normal">In this chapter, you learned how to write Python software that works well across multiple platforms. You learned how to avoid common platform pitfalls in Python code such as filesystem differences and library support, and how to write software that intelligently adapts to the needs of different operating systems. You also learned about published guidelines that help developers write software that meets platform users' expectations, and you used these guidelines to create platform-specific menus for ABQ Data Entry.</p>
    <p class="normal">In the next chapter, we're going to learn about automated testing. You'll learn to write tests that ensure your code works correctly, both for regular Python code and specifically for Tkinter code, and to take advantage of the testing framework included in the Python standard library.</p>
  </div>
</body></html>