<html><head></head><body>
  <div class="Basic-Text-Frame" id="_idContainer226">
   <h1 class="chapterNumber">
    <span class="koboSpan" id="kobo.1.1">
     14
    </span>
   </h1>
   <h1 class="chapterTitle" id="_idParaDest-349">
    <span class="koboSpan" id="kobo.2.1">
     Introduction to API Development
    </span>
   </h1>
   <blockquote class="packt_quote">
    <p class="quote">
     <span class="koboSpan" id="kobo.3.1">
      ”The one goal of compassionate communication is to help others suffer less.”
     </span>
    </p>
    <p class="cite">
     <span class="koboSpan" id="kobo.4.1">
      – Thich Nhat Hanh
     </span>
    </p>
   </blockquote>
   <p class="normal">
    <span class="koboSpan" id="kobo.5.1">
     In this chapter, we are going to learn about the concept of
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.6.1">
      Application Programming Interface
     </span>
    </strong>
    <span class="koboSpan" id="kobo.7.1">
     , or
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.8.1">
      API
     </span>
    </strong>
    <span class="koboSpan" id="kobo.9.1">
     .
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.10.1">
     We are going to discuss the following:
    </span>
   </p>
   <ul>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.11.1">
      The HTTP protocol
     </span>
    </li>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.12.1">
      Introduction to API design
     </span>
    </li>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.13.1">
      A complete API example
     </span>
    </li>
   </ul>
   <p class="normal">
    <span class="koboSpan" id="kobo.14.1">
     We are going to briefly touch on the HTTP protocol, as it is the infrastructure upon which we will build the API.
    </span>
    <span class="koboSpan" id="kobo.14.2">
     Moreover, since the framework we are going to use,
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.15.1">
      FastAPI
     </span>
    </strong>
    <span class="koboSpan" id="kobo.16.1">
     , leverages
    </span>
    <a id="_idIndexMarker1201">
    </a>
    <span class="koboSpan" id="kobo.17.1">
     Type Hinting extensively, you may want to make sure you have read
    </span>
    <em class="chapterRef">
     <span class="koboSpan" id="kobo.18.1">
      Chapter 12, Introduction to Type Hinting
     </span>
    </em>
    <span class="koboSpan" id="kobo.19.1">
     , as a prerequisite.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.20.1">
     After a short general introduction to APIs, we are going to show you a railway project, which you can find in its complete state in the source code for this chapter, along with its requirements and a README file that explains all you need to know to run the API and query it.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.21.1">
     FastAPI has
    </span>
    <a id="_idIndexMarker1202">
    </a>
    <span class="koboSpan" id="kobo.22.1">
     proven to be the optimal choice for this project.
    </span>
    <span class="koboSpan" id="kobo.22.2">
     Thanks to its capabilities, we have been able to create an API with clean, concise, and expressive code.
    </span>
    <span class="koboSpan" id="kobo.22.3">
     We believe it to be a good starting point for you to explore and expand on.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.23.1">
     As a developer, it is quite likely that you will have to work on APIs, at some point in your career.
    </span>
    <span class="koboSpan" id="kobo.23.2">
     Technology and frameworks evolve all the time, so we recommend that you also focus on the theoretical concepts we are going to expose, as that knowledge will help you be less dependent on any particular framework or library.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.24.1">
     Let us start with HTTP.
    </span>
   </p>
   <h1 class="heading-1" id="_idParaDest-350">
    <span class="koboSpan" id="kobo.25.1">
     The Hypertext Transfer Protocol
    </span>
   </h1>
   <p class="normal">
    <span class="koboSpan" id="kobo.26.1">
     The
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.27.1">
      World Wide Web
     </span>
    </strong>
    <span class="koboSpan" id="kobo.28.1">
     (
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.29.1">
      WWW
     </span>
    </strong>
    <span class="koboSpan" id="kobo.30.1">
     ), or
    </span>
    <a id="_idIndexMarker1203">
    </a>
    <span class="koboSpan" id="kobo.31.1">
     simply the
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.32.1">
      Web
     </span>
    </strong>
    <span class="koboSpan" id="kobo.33.1">
     , is a way of accessing information using the
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.34.1">
      Internet
     </span>
    </strong>
    <span class="koboSpan" id="kobo.35.1">
     .
    </span>
    <span class="koboSpan" id="kobo.35.2">
     The Internet is a vast network
    </span>
    <a id="_idIndexMarker1204">
    </a>
    <span class="koboSpan" id="kobo.36.1">
     of networks, a networking infrastructure.
    </span>
    <span class="koboSpan" id="kobo.36.2">
     Its purpose is to connect billions of devices together, all around the globe, so that they can communicate with one another.
    </span>
    <span class="koboSpan" id="kobo.36.3">
     Information travels through the Internet in a rich variety of
    </span>
    <a id="_idIndexMarker1205">
    </a>
    <span class="koboSpan" id="kobo.37.1">
     languages, called
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.38.1">
      protocols
     </span>
    </strong>
    <span class="koboSpan" id="kobo.39.1">
     , that allow different devices to share content.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.40.1">
     The Web is an information-sharing model, built on top of the Internet, which employs the
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.41.1">
      Hypertext Transfer Protocol
     </span>
    </strong>
    <span class="koboSpan" id="kobo.42.1">
     (
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.43.1">
      HTTP
     </span>
    </strong>
    <span class="koboSpan" id="kobo.44.1">
     ) as
    </span>
    <a id="_idIndexMarker1206">
    </a>
    <span class="koboSpan" id="kobo.45.1">
     a basis for data communication.
    </span>
    <span class="koboSpan" id="kobo.45.2">
     The Web, therefore, is just one of several ways information can be exchanged over the Internet; email, instant messaging, news groups, and so on, all rely on different protocols.
    </span>
   </p>
   <h2 class="heading-2" id="_idParaDest-351">
    <span class="koboSpan" id="kobo.46.1">
     How does HTTP work?
    </span>
   </h2>
   <p class="normal">
    <span class="koboSpan" id="kobo.47.1">
     HTTP is an
    </span>
    <a id="_idIndexMarker1207">
    </a>
    <span class="koboSpan" id="kobo.48.1">
     asymmetric
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.49.1">
      request-response
     </span>
    </strong>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.50.1">
      client-server
     </span>
    </strong>
    <span class="koboSpan" id="kobo.51.1">
     protocol.
    </span>
    <span class="koboSpan" id="kobo.51.2">
     An
    </span>
    <a id="_idIndexMarker1208">
    </a>
    <span class="koboSpan" id="kobo.52.1">
     HTTP client – for example, your web browser – sends a
    </span>
    <a id="_idIndexMarker1209">
    </a>
    <span class="koboSpan" id="kobo.53.1">
     request message
    </span>
    <a id="_idIndexMarker1210">
    </a>
    <span class="koboSpan" id="kobo.54.1">
     to an HTTP server.
    </span>
    <span class="koboSpan" id="kobo.54.2">
     The server, in turn, returns a response message.
    </span>
    <span class="koboSpan" id="kobo.54.3">
     HTTP is
    </span>
    <a id="_idIndexMarker1211">
    </a>
    <span class="koboSpan" id="kobo.55.1">
     primarily a
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.56.1">
      pull-based protocol
     </span>
    </strong>
    <span class="koboSpan" id="kobo.57.1">
     , which means the
    </span>
    <a id="_idIndexMarker1212">
    </a>
    <span class="koboSpan" id="kobo.58.1">
     client pulls information from the server, rather than the server pushing it to the client.
    </span>
    <span class="koboSpan" id="kobo.58.2">
     There are techniques, implemented over HTTP, that simulate push-based behavior, for example, long polling, WebSockets, and HTTP/2 Server Push.
    </span>
    <span class="koboSpan" id="kobo.58.3">
     Despite these, the foundation of HTTP remains a pull-based protocol, where it is the client that initiates the requests.
    </span>
    <span class="koboSpan" id="kobo.58.4">
     Look at the diagram in
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.59.1">
      Figure 14.1
     </span>
    </em>
    <span class="koboSpan" id="kobo.60.1">
     :
    </span>
   </p>
   <figure class="mediaobject">
    <span class="koboSpan" id="kobo.61.1">
     <img alt="img" src="../Images/B30992_14_01.png"/>
    </span>
   </figure>
   <p class="packt_figref">
    <span class="koboSpan" id="kobo.62.1">
     Figure 14.1: A simplified depiction of the HTTP protocol
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.63.1">
     HTTP is transmitted
    </span>
    <a id="_idIndexMarker1213">
    </a>
    <span class="koboSpan" id="kobo.64.1">
     via the
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.65.1">
      Transmission Control Protocol/Internet Protocol
     </span>
    </strong>
    <span class="koboSpan" id="kobo.66.1">
     (
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.67.1">
      TCP/IP)
     </span>
    </strong>
    <span class="koboSpan" id="kobo.68.1">
     , which provides the tools for a reliable communication exchange over the Internet.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.69.1">
     An important feature of the HTTP protocol is that it is
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.70.1">
      stateless
     </span>
    </strong>
    <span class="koboSpan" id="kobo.71.1">
     .
    </span>
    <span class="koboSpan" id="kobo.71.2">
     This means that the current request
    </span>
    <a id="_idIndexMarker1214">
    </a>
    <span class="koboSpan" id="kobo.72.1">
     has no knowledge about what happened in previous requests.
    </span>
    <span class="koboSpan" id="kobo.72.2">
     This technical limitation exists for good reasons, but it is easy to overcome.
    </span>
    <span class="koboSpan" id="kobo.72.3">
     In practice, most websites offer the ability to “log in” and the illusion of carrying a state from page to page.
    </span>
    <span class="koboSpan" id="kobo.72.4">
     When a user logs in to a website, a token of user information is saved (most often on the client side, in special files called
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.73.1">
      cookies
     </span>
    </strong>
    <span class="koboSpan" id="kobo.74.1">
     ) so that
    </span>
    <a id="_idIndexMarker1215">
    </a>
    <span class="koboSpan" id="kobo.75.1">
     each request the user makes carries the means for the server to recognize the user and provide a custom interface by showing their name, keeping their basket populated, and so on.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.76.1">
     HTTP defines
    </span>
    <a id="_idIndexMarker1216">
    </a>
    <span class="koboSpan" id="kobo.77.1">
     a set of methods—also known as
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.78.1">
      verbs
     </span>
    </em>
    <span class="koboSpan" id="kobo.79.1">
     —to indicate the desired action to be performed on a given resource.
    </span>
    <span class="koboSpan" id="kobo.79.2">
     Each of them is different, but some of them share some common features.
    </span>
    <span class="koboSpan" id="kobo.79.3">
     In particular, the ones we will use in our API are as follows:
    </span>
   </p>
   <ul>
    <li class="bulletList">
     <strong class="keyWord">
      <span class="koboSpan" id="kobo.80.1">
       GET
      </span>
     </strong>
     <span class="koboSpan" id="kobo.81.1">
      : The
     </span>
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.82.1">
       GET
      </span>
     </code>
     <span class="koboSpan" id="kobo.83.1">
      method requests a representation of the specified resource.
     </span>
     <span class="koboSpan" id="kobo.83.2">
      Requests using
     </span>
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.84.1">
       GET
      </span>
     </code>
     <span class="koboSpan" id="kobo.85.1">
      should only retrieve data.
     </span>
    </li>
    <li class="bulletList">
     <strong class="keyWord">
      <span class="koboSpan" id="kobo.86.1">
       POST
      </span>
     </strong>
     <span class="koboSpan" id="kobo.87.1">
      : The
     </span>
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.88.1">
       POST
      </span>
     </code>
     <span class="koboSpan" id="kobo.89.1">
      method is used to submit an entity to the specified resource, often causing a change in state or side effects on the server.
     </span>
    </li>
    <li class="bulletList">
     <strong class="keyWord">
      <span class="koboSpan" id="kobo.90.1">
       PUT
      </span>
     </strong>
     <span class="koboSpan" id="kobo.91.1">
      : The
     </span>
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.92.1">
       PUT
      </span>
     </code>
     <span class="koboSpan" id="kobo.93.1">
      method requests that the target resource creates or updates its state with the state defined by the representation enclosed in the request.
     </span>
    </li>
    <li class="bulletList">
     <strong class="keyWord">
      <span class="koboSpan" id="kobo.94.1">
       DELETE
      </span>
     </strong>
     <span class="koboSpan" id="kobo.95.1">
      : The
     </span>
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.96.1">
       DELETE
      </span>
     </code>
     <span class="koboSpan" id="kobo.97.1">
      method requests that the target resource delete its state.
     </span>
    </li>
   </ul>
   <p class="normal">
    <span class="koboSpan" id="kobo.98.1">
     Other methods are
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.99.1">
      HEAD
     </span>
    </code>
    <span class="koboSpan" id="kobo.100.1">
     ,
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.101.1">
      CONNECT
     </span>
    </code>
    <span class="koboSpan" id="kobo.102.1">
     ,
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.103.1">
      OPTIONS
     </span>
    </code>
    <span class="koboSpan" id="kobo.104.1">
     ,
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.105.1">
      TRACE
     </span>
    </code>
    <span class="koboSpan" id="kobo.106.1">
     , and
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.107.1">
      PATCH
     </span>
    </code>
    <span class="koboSpan" id="kobo.108.1">
     .
    </span>
    <span class="koboSpan" id="kobo.108.2">
     For a comprehensive explanation of all of these methods, please refer to
    </span>
    <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP">
     <span class="url">
      <span class="koboSpan" id="kobo.109.1">
       https://developer.mozilla.org/en-US/docs/Web/HTTP
      </span>
     </span>
    </a>
    <span class="koboSpan" id="kobo.110.1">
     .
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.111.1">
     The API we are going to write works over HTTP, which means we will write code to perform and handle HTTP requests and responses.
    </span>
    <span class="koboSpan" id="kobo.111.2">
     We will not keep prepending “HTTP” to the terms “request” and “response” from now on, as we trust there will not be any confusion.
    </span>
   </p>
   <h2 class="heading-2" id="_idParaDest-352">
    <span class="koboSpan" id="kobo.112.1">
     Response status codes
    </span>
   </h2>
   <p class="normal">
    <span class="koboSpan" id="kobo.113.1">
     One thing to
    </span>
    <a id="_idIndexMarker1217">
    </a>
    <span class="koboSpan" id="kobo.114.1">
     know about HTTP responses is that they include a status code, which expresses the outcome of the request in a concise way.
    </span>
    <span class="koboSpan" id="kobo.114.2">
     Status codes consist of a number and a brief description, for example,
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.115.1">
      404 Not Found
     </span>
    </em>
    <span class="koboSpan" id="kobo.116.1">
     .
    </span>
    <span class="koboSpan" id="kobo.116.2">
     You can check the complete list of
    </span>
    <a id="_idIndexMarker1218">
    </a>
    <span class="koboSpan" id="kobo.117.1">
     HTTP status codes at
    </span>
    <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status">
     <span class="url">
      <span class="koboSpan" id="kobo.118.1">
       https://developer.mozilla.org/en-US/docs/Web/HTTP/Status
      </span>
     </span>
    </a>
    <span class="koboSpan" id="kobo.119.1">
     .
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.120.1">
     Status codes are classified in this way:
    </span>
   </p>
   <ul>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.121.1">
      1xx informational response: The request was received, continuing process.
     </span>
    </li>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.122.1">
      2xx successful: The request was successfully received, understood, and accepted.
     </span>
    </li>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.123.1">
      3xx redirection: Further action needs to be taken to complete the request.
     </span>
    </li>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.124.1">
      4xx client error: The request contains bad syntax or cannot be fulfilled.
     </span>
    </li>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.125.1">
      5xx server error: The server failed to fulfill a valid request.
     </span>
    </li>
   </ul>
   <p class="normal">
    <span class="koboSpan" id="kobo.126.1">
     When
    </span>
    <a id="_idIndexMarker1219">
    </a>
    <span class="koboSpan" id="kobo.127.1">
     consuming the API, we will receive status codes in the responses, so it is important that you at least have an idea about what they mean.
    </span>
   </p>
   <h1 class="heading-1" id="_idParaDest-353">
    <span class="koboSpan" id="kobo.128.1">
     APIs – An introduction
    </span>
   </h1>
   <p class="normal">
    <span class="koboSpan" id="kobo.129.1">
     Before
    </span>
    <a id="_idIndexMarker1220">
    </a>
    <span class="koboSpan" id="kobo.130.1">
     we delve into the details of this chapter’s specific project, let us spend a moment talking about APIs in general.
    </span>
   </p>
   <h2 class="heading-2" id="_idParaDest-354">
    <span class="koboSpan" id="kobo.131.1">
     What is an API?
    </span>
   </h2>
   <p class="normal">
    <span class="koboSpan" id="kobo.132.1">
     As we mentioned at the beginning of the chapter, API stands for
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.133.1">
      Application Programming Interface
     </span>
    </strong>
    <span class="koboSpan" id="kobo.134.1">
     .
    </span>
    <span class="koboSpan" id="kobo.134.2">
     An API is a set of rules, protocols, and tools for building software and applications.
    </span>
    <span class="koboSpan" id="kobo.134.3">
     It acts as a connection layer between computers, or computer programs.
    </span>
    <span class="koboSpan" id="kobo.134.4">
     In contrast, user interfaces provide a bridge between computers and people.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.135.1">
     An API is
    </span>
    <a id="_idIndexMarker1221">
    </a>
    <span class="koboSpan" id="kobo.136.1">
     normally accompanied by a
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.137.1">
      specification document
     </span>
    </em>
    <span class="koboSpan" id="kobo.138.1">
     , or
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.139.1">
      standard
     </span>
    </em>
    <span class="koboSpan" id="kobo.140.1">
     , which serves as a blueprint that outlines how software components are meant to interact.
    </span>
    <span class="koboSpan" id="kobo.140.2">
     A system that meets the specification is said to implement, or expose, the API.
    </span>
    <span class="koboSpan" id="kobo.140.3">
     The term API can describe both the implementation and the specification.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.141.1">
     In essence, an API defines the methods and data formats that developers can use to interact with a program, a web service, or any other software.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.142.1">
     Broadly speaking, there are two types of APIs:
    </span>
   </p>
   <ul>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.143.1">
      Web APIs: Accessible
     </span>
     <a id="_idIndexMarker1222">
     </a>
     <span class="koboSpan" id="kobo.144.1">
      over the Internet, they are often used to enable web applications to interact with each other or with backend servers.
     </span>
     <span class="koboSpan" id="kobo.144.2">
      They are the backbone of web development, enabling functionalities such as fetching data from a server, posting data, or integrating with third-party services like media platforms, payment gateways, and so on.
     </span>
    </li>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.145.1">
      Frameworks and software libraries: These
     </span>
     <a id="_idIndexMarker1223">
     </a>
     <span class="koboSpan" id="kobo.146.1">
      provide a set of functions and procedures that perform specific tasks, and help speed up application development by providing building blocks to the developers.
     </span>
    </li>
   </ul>
   <p class="normal">
    <span class="koboSpan" id="kobo.147.1">
     In this chapter, we will be focusing on Web APIs.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.148.1">
     An API is normally made of different parts.
    </span>
    <span class="koboSpan" id="kobo.148.2">
     These are known by different names, the most common of which are
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.149.1">
      methods
     </span>
    </em>
    <span class="koboSpan" id="kobo.150.1">
     ,
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.151.1">
      subroutines
     </span>
    </em>
    <span class="koboSpan" id="kobo.152.1">
     , or
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.153.1">
      endpoints
     </span>
    </em>
    <span class="koboSpan" id="kobo.154.1">
     (we will call them endpoints in this chapter).
    </span>
    <span class="koboSpan" id="kobo.154.2">
     When we use these parts, the technical term for this is
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.155.1">
      calling
     </span>
    </em>
    <span class="koboSpan" id="kobo.156.1">
     them.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.157.1">
     The API specification instructs you on how to call each endpoint, what type of requests to make, which parameters and headers to pass, which addresses to reach, and so on.
    </span>
   </p>
   <h2 class="heading-2" id="_idParaDest-355">
    <span class="koboSpan" id="kobo.158.1">
     What is the purpose of an API?
    </span>
   </h2>
   <p class="normal">
    <span class="koboSpan" id="kobo.159.1">
     There
    </span>
    <a id="_idIndexMarker1224">
    </a>
    <span class="koboSpan" id="kobo.160.1">
     are several reasons to introduce an API into a system.
    </span>
    <span class="koboSpan" id="kobo.160.2">
     One we have already mentioned is to create the means for different applications to communicate.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.161.1">
     Another important reason is to give access to a system by providing a layer through which the external world can communicate with the system itself.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.162.1">
     The API layer takes care of security by performing the
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.163.1">
      authentication
     </span>
    </strong>
    <span class="koboSpan" id="kobo.164.1">
     and
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.165.1">
      authorization
     </span>
    </strong>
    <span class="koboSpan" id="kobo.166.1">
     of users, as well as
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.167.1">
      validation
     </span>
    </strong>
    <span class="koboSpan" id="kobo.168.1">
     of all the data that is exchanged in the communications.
    </span>
   </p>
   <div class="note">
    <p class="normal">
     <em class="italic">
      <span class="koboSpan" id="kobo.169.1">
       Authentication
      </span>
     </em>
     <span class="koboSpan" id="kobo.170.1">
      means the system can validate user credentials to unequivocally identify them.
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.171.1">
       Authorization
      </span>
     </em>
     <span class="koboSpan" id="kobo.172.1">
      means the system can verify what a user has access to.
     </span>
    </p>
   </div>
   <p class="normal">
    <span class="koboSpan" id="kobo.173.1">
     Users, systems, and data are checked and validated at the border, and if they pass the check, they can interact with the rest of the system (through the API).
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.174.1">
     This mechanism is conceptually like landing at an airport and having to show the border control our passports to be able to interact with the system, which is the country we landed in.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.175.1">
     The fact that the API layer hides the internals of the systems from the outside world provides another benefit: if the internal system changes, in terms of technology, languages, or even workflows, the API can adapt the way it interfaces to it, but still provide a consistent interface to the public side.
    </span>
    <span class="koboSpan" id="kobo.175.2">
     If we put a letter into a letterbox, we do not need to know or control how the postal service will deal with it, as long as the letter arrives at the destination.
    </span>
    <span class="koboSpan" id="kobo.175.3">
     So, the interface (the letterbox) is kept consistent, while the other side (the mail carrier, their vehicles, technology, workflows, and so on) is free to change and evolve.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.176.1">
     It should not be surprising that virtually any electronic device we own today, that is connected to the Web, is talking to a (potentially wide) range of APIs to perform its tasks.
    </span>
   </p>
   <h2 class="heading-2" id="_idParaDest-356">
    <span class="koboSpan" id="kobo.177.1">
     API protocols
    </span>
   </h2>
   <p class="normal">
    <span class="koboSpan" id="kobo.178.1">
     There
    </span>
    <a id="_idIndexMarker1225">
    </a>
    <span class="koboSpan" id="kobo.179.1">
     are several types of API.
    </span>
    <span class="koboSpan" id="kobo.179.2">
     They can be open to the public, or private.
    </span>
    <span class="koboSpan" id="kobo.179.3">
     They can provide access to data, services, or both.
    </span>
    <span class="koboSpan" id="kobo.179.4">
     APIs can be written and designed using different methods and standards, and they can employ different protocols.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.180.1">
     These are the most common protocols:
    </span>
   </p>
   <ul>
    <li class="bulletList">
     <strong class="keyWord">
      <span class="koboSpan" id="kobo.181.1">
       Hypertext Transfer Protocol/Secure (HTTP/HTTPS)
      </span>
     </strong>
     <span class="koboSpan" id="kobo.182.1">
      : The foundation of data
     </span>
     <a id="_idIndexMarker1226">
     </a>
     <span class="koboSpan" id="kobo.183.1">
      communication for the Web.
     </span>
    </li>
    <li class="bulletList">
     <strong class="keyWord">
      <span class="koboSpan" id="kobo.184.1">
       Representational State Transfer (REST)
      </span>
     </strong>
     <span class="koboSpan" id="kobo.185.1">
      : Technically not a protocol, but rather a
     </span>
     <a id="_idIndexMarker1227">
     </a>
     <span class="koboSpan" id="kobo.186.1">
      type of architecture built over HTTP, APIs designed in this style are called RESTful APIs.
     </span>
     <span class="koboSpan" id="kobo.186.2">
      They are stateless and capable of leveraging data caching.
     </span>
    </li>
    <li class="bulletList">
     <strong class="keyWord">
      <span class="koboSpan" id="kobo.187.1">
       Simple Object Access Protocol (SOAP)
      </span>
     </strong>
     <span class="koboSpan" id="kobo.188.1">
      : A well-established protocol for
     </span>
     <a id="_idIndexMarker1228">
     </a>
     <span class="koboSpan" id="kobo.189.1">
      building web services, its messages are normally XML-formatted, and its specification is quite strict, which is why this protocol is suitable for situations that require high security standards and transactional reliability.
     </span>
    </li>
    <li class="bulletList">
     <strong class="keyWord">
      <span class="koboSpan" id="kobo.190.1">
       GraphQL
      </span>
     </strong>
     <span class="koboSpan" id="kobo.191.1">
      : A
     </span>
     <a id="_idIndexMarker1229">
     </a>
     <span class="koboSpan" id="kobo.192.1">
      query language for APIs that employs a type system to define the data.
     </span>
     <span class="koboSpan" id="kobo.192.2">
      Unlike REST, GraphQL uses a single endpoint to allow clients to fetch only the data they need.
     </span>
    </li>
    <li class="bulletList">
     <strong class="keyWord">
      <span class="koboSpan" id="kobo.193.1">
       WebSocket
      </span>
     </strong>
     <span class="koboSpan" id="kobo.194.1">
      : Ideal
     </span>
     <a id="_idIndexMarker1230">
     </a>
     <span class="koboSpan" id="kobo.195.1">
      for applications that require bidirectional communication between client and server, as well as real-time data updates.
     </span>
     <span class="koboSpan" id="kobo.195.2">
      They provide full-duplex communication over a single TCP connection.
     </span>
    </li>
    <li class="bulletList">
     <strong class="keyWord">
      <span class="koboSpan" id="kobo.196.1">
       Remote Procedural Call (RPC)
      </span>
     </strong>
     <span class="koboSpan" id="kobo.197.1">
      : It
     </span>
     <a id="_idIndexMarker1231">
     </a>
     <span class="koboSpan" id="kobo.198.1">
      allows programmers to execute code on the server side by remotely calling a procedure (hence the name).
     </span>
     <span class="koboSpan" id="kobo.198.2">
      These of APIs are tightly coupled with the server implementation, so they are usually not made for public consumption.
     </span>
    </li>
   </ul>
   <h2 class="heading-2" id="_idParaDest-357">
    <span class="koboSpan" id="kobo.199.1">
     API data-exchange formats
    </span>
   </h2>
   <p class="normal">
    <span class="koboSpan" id="kobo.200.1">
     We said that
    </span>
    <a id="_idIndexMarker1232">
    </a>
    <span class="koboSpan" id="kobo.201.1">
     an API is an interface between at least two computer systems.
    </span>
    <span class="koboSpan" id="kobo.201.2">
     It would be quite impractical, when interfacing with other systems, to have to shape the data into whatever format they implement.
    </span>
    <span class="koboSpan" id="kobo.201.3">
     Therefore, the API, which provides the communication layer between systems, specifies not only the communication protocols but also which formats can be adopted for the data exchanges.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.202.1">
     The most common data-exchange
    </span>
    <a id="_idIndexMarker1233">
    </a>
    <span class="koboSpan" id="kobo.203.1">
     formats
    </span>
    <a id="_idIndexMarker1234">
    </a>
    <span class="koboSpan" id="kobo.204.1">
     today
    </span>
    <a id="_idIndexMarker1235">
    </a>
    <span class="koboSpan" id="kobo.205.1">
     are
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.206.1">
      JSON
     </span>
    </strong>
    <span class="koboSpan" id="kobo.207.1">
     ,
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.208.1">
      XML
     </span>
    </strong>
    <span class="koboSpan" id="kobo.209.1">
     , and
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.210.1">
      YAML
     </span>
    </strong>
    <span class="koboSpan" id="kobo.211.1">
     .
    </span>
    <span class="koboSpan" id="kobo.211.2">
     We saw JSON in
    </span>
    <em class="chapterRef">
     <span class="koboSpan" id="kobo.212.1">
      Chapter 8, Files and Data Persistence
     </span>
    </em>
    <span class="koboSpan" id="kobo.213.1">
     , and we will use it as the format for the API of this chapter too.
    </span>
    <span class="koboSpan" id="kobo.213.2">
     JSON is widely adopted today by many APIs, and many frameworks provide the ability to translate data from and to JSON, out of the box.
    </span>
   </p>
   <h1 class="heading-1" id="_idParaDest-358">
    <span class="koboSpan" id="kobo.214.1">
     The railway API
    </span>
   </h1>
   <p class="normal">
    <span class="koboSpan" id="kobo.215.1">
     Now that we
    </span>
    <a id="_idIndexMarker1236">
    </a>
    <span class="koboSpan" id="kobo.216.1">
     have a working knowledge of what an API is, let us turn to something more concrete.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.217.1">
     Before we show you the code, allow us to stress that this code is not production-ready, as that would have been too long and needlessly complex for a book’s chapter.
    </span>
    <span class="koboSpan" id="kobo.217.2">
     However, this code is fully functional, and it should provide you with a good starting point to learn more, especially if you experiment with it.
    </span>
    <span class="koboSpan" id="kobo.217.3">
     We will leave suggestions on how to do so at the end of this chapter.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.218.1">
     We have a
    </span>
    <a id="_idIndexMarker1237">
    </a>
    <span class="koboSpan" id="kobo.219.1">
     database with some entities that model a railway application.
    </span>
    <span class="koboSpan" id="kobo.219.2">
     We want to
    </span>
    <a id="_idIndexMarker1238">
    </a>
    <span class="koboSpan" id="kobo.220.1">
     allow an external system to perform
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.221.1">
      CRUD
     </span>
    </strong>
    <span class="koboSpan" id="kobo.222.1">
     operations on the database, so we are going to write an API to serve as the interface to it.
    </span>
   </p>
   <div class="note">
    <p class="normal">
     <strong class="keyWord">
      <span class="koboSpan" id="kobo.223.1">
       CRUD
      </span>
     </strong>
     <span class="koboSpan" id="kobo.224.1">
      stands for
     </span>
     <strong class="keyWord">
      <span class="koboSpan" id="kobo.225.1">
       Create
      </span>
     </strong>
     <span class="koboSpan" id="kobo.226.1">
      ,
     </span>
     <strong class="keyWord">
      <span class="koboSpan" id="kobo.227.1">
       Read
      </span>
     </strong>
     <span class="koboSpan" id="kobo.228.1">
      ,
     </span>
     <strong class="keyWord">
      <span class="koboSpan" id="kobo.229.1">
       Update
      </span>
     </strong>
     <span class="koboSpan" id="kobo.230.1">
      , and
     </span>
     <strong class="keyWord">
      <span class="koboSpan" id="kobo.231.1">
       Delete
      </span>
     </strong>
     <span class="koboSpan" id="kobo.232.1">
      .
     </span>
     <span class="koboSpan" id="kobo.232.2">
      These are the four basic database operations.
     </span>
     <span class="koboSpan" id="kobo.232.3">
      Many HTTP services also model CRUD operations through REST or REST-like APIs.
     </span>
    </p>
   </div>
   <p class="normal">
    <span class="koboSpan" id="kobo.233.1">
     Let us start by looking at the project files, so you will have an idea of where things are.
    </span>
    <span class="koboSpan" id="kobo.233.2">
     You can find them in the folder for this chapter, in the source code:
    </span>
   </p>
   <pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.234.1">$ tree -a api_code
api_code
├── .env.example
├── api
│   ├── __init__.py
│   ├── admin.py
│   ├── config.py
│   ├── crud.py
│   ├── database.py
│   ├── deps.py
│   ├── models.py
│   ├── schemas.py
│   ├── stations.py
│   ├── tickets.py
│   ├── trains.py
│   ├── users.py
│   └── util.py
├── dummy_data.py
├── main.py
├── queries.md
└── train.db
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.235.1">
     Within the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.236.1">
      api_code
     </span>
    </code>
    <span class="koboSpan" id="kobo.237.1">
     folder, you can find all the files belonging to the FastAPI project.
    </span>
    <span class="koboSpan" id="kobo.237.2">
     The main application module is
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.238.1">
      main.py
     </span>
    </code>
    <span class="koboSpan" id="kobo.239.1">
     .
    </span>
    <span class="koboSpan" id="kobo.239.2">
     We have left the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.240.1">
      dummy_data.py
     </span>
    </code>
    <span class="koboSpan" id="kobo.241.1">
     script in the code, which you can use to generate a new
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.242.1">
      train.db
     </span>
    </code>
    <span class="koboSpan" id="kobo.243.1">
     , the database file.
    </span>
    <span class="koboSpan" id="kobo.243.2">
     Make sure you read the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.244.1">
      README.md
     </span>
    </code>
    <span class="koboSpan" id="kobo.245.1">
     in this chapter’s folder for instructions on how to use it.
    </span>
    <span class="koboSpan" id="kobo.245.2">
     We have also collected a list of queries to the API for you to copy and try out, in
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.246.1">
      queries.md
     </span>
    </code>
    <span class="koboSpan" id="kobo.247.1">
     .
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.248.1">
     Within the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.249.1">
      api
     </span>
    </code>
    <span class="koboSpan" id="kobo.250.1">
     package, we
    </span>
    <a id="_idIndexMarker1239">
    </a>
    <span class="koboSpan" id="kobo.251.1">
     have the application modules.
    </span>
    <span class="koboSpan" id="kobo.251.2">
     The database models are in
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.252.1">
      models.py
     </span>
    </code>
    <span class="koboSpan" id="kobo.253.1">
     , and the schemas used to describe them to the API are in
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.254.1">
      schemas.py
     </span>
    </code>
    <span class="koboSpan" id="kobo.255.1">
     .
    </span>
    <span class="koboSpan" id="kobo.255.2">
     The other modules’ purposes should be evident from their names:
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.256.1">
      users.py
     </span>
    </code>
    <span class="koboSpan" id="kobo.257.1">
     ,
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.258.1">
      stations.py
     </span>
    </code>
    <span class="koboSpan" id="kobo.259.1">
     ,
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.260.1">
      tickets.py
     </span>
    </code>
    <span class="koboSpan" id="kobo.261.1">
     ,
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.262.1">
      trains.py
     </span>
    </code>
    <span class="koboSpan" id="kobo.263.1">
     , and
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.264.1">
      admin.py
     </span>
    </code>
    <span class="koboSpan" id="kobo.265.1">
     all contain the definitions of the corresponding endpoints of the API.
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.266.1">
      util.py
     </span>
    </code>
    <span class="koboSpan" id="kobo.267.1">
     contains some utility functions;
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.268.1">
      deps.py
     </span>
    </code>
    <span class="koboSpan" id="kobo.269.1">
     defines the dependency providers;
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.270.1">
      config.py
     </span>
    </code>
    <span class="koboSpan" id="kobo.271.1">
     holds the configuration settings;
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.272.1">
      crud.py
     </span>
    </code>
    <span class="koboSpan" id="kobo.273.1">
     contains the functions that perform CRUD operations on the database and, finally,
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.274.1">
      .env.example
     </span>
    </code>
    <span class="koboSpan" id="kobo.275.1">
     is a template for you to create a
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.276.1">
      .env
     </span>
    </code>
    <span class="koboSpan" id="kobo.277.1">
     file to provide settings to your application.
    </span>
   </p>
   <div class="note">
    <p class="normal">
     <span class="koboSpan" id="kobo.278.1">
      In software engineering,
     </span>
     <strong class="keyWord">
      <span class="koboSpan" id="kobo.279.1">
       dependency injection
      </span>
     </strong>
     <span class="koboSpan" id="kobo.280.1">
      is a
     </span>
     <a id="_idIndexMarker1240">
     </a>
     <span class="koboSpan" id="kobo.281.1">
      design pattern in which an object receives other objects that it depends on, called dependencies.
     </span>
     <span class="koboSpan" id="kobo.281.2">
      The software responsible for constructing and injecting those dependencies is known as the
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.282.1">
       injector
      </span>
     </em>
     <span class="koboSpan" id="kobo.283.1">
      , or
     </span>
     <em class="italic">
      <span class="koboSpan" id="kobo.284.1">
       provider
      </span>
     </em>
     <span class="koboSpan" id="kobo.285.1">
      .
     </span>
     <span class="koboSpan" id="kobo.285.2">
      Hence, a dependency provider is a piece of software that creates and provides a dependency, so that other parts of the software can use it without having to take care of creating it, setting it up, and disposing of it.
     </span>
     <span class="koboSpan" id="kobo.285.3">
      To
     </span>
     <a id="_idIndexMarker1241">
     </a>
     <span class="koboSpan" id="kobo.286.1">
      learn more about this pattern, please refer to this Wikipedia page:
     </span>
    </p>
    <p class="normal">
     <a href="https://en.wikipedia.org/wiki/Dependency_injection">
      <span class="url">
       <span class="koboSpan" id="kobo.287.1">
        https://en.wikipedia.org/wiki/Dependency_injection
       </span>
      </span>
     </a>
    </p>
   </div>
   <h2 class="heading-2" id="_idParaDest-359">
    <span class="koboSpan" id="kobo.288.1">
     Modeling the database
    </span>
   </h2>
   <p class="normal">
    <span class="koboSpan" id="kobo.289.1">
     When
    </span>
    <a id="_idIndexMarker1242">
    </a>
    <span class="koboSpan" id="kobo.290.1">
     preparing the entity-relationship schema for this project, we sought to design something interesting and, at the same time, simple and contained.
    </span>
    <span class="koboSpan" id="kobo.290.2">
     This application considers four entities:
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.291.1">
      Stations
     </span>
    </em>
    <span class="koboSpan" id="kobo.292.1">
     ,
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.293.1">
      Trains
     </span>
    </em>
    <span class="koboSpan" id="kobo.294.1">
     ,
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.295.1">
      Tickets
     </span>
    </em>
    <span class="koboSpan" id="kobo.296.1">
     , and
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.297.1">
      Users
     </span>
    </em>
    <span class="koboSpan" id="kobo.298.1">
     .
    </span>
    <span class="koboSpan" id="kobo.298.2">
     A Train is a journey from one station to another one.
    </span>
    <span class="koboSpan" id="kobo.298.3">
     A Ticket is a connection between a Train and a User.
    </span>
    <span class="koboSpan" id="kobo.298.4">
     Users can be passengers or administrators, according to what they are supposed to be able to do with the API.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.299.1">
     In
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.300.1">
      Figure 14.2
     </span>
    </em>
    <span class="koboSpan" id="kobo.301.1">
     , you can see
    </span>
    <a id="_idIndexMarker1243">
    </a>
    <span class="koboSpan" id="kobo.302.1">
     the
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.303.1">
      entity relationship
     </span>
    </strong>
    <span class="koboSpan" id="kobo.304.1">
     (
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.305.1">
      ER
     </span>
    </strong>
    <span class="koboSpan" id="kobo.306.1">
     ) model of the database.
    </span>
    <span class="koboSpan" id="kobo.306.2">
     It describes the four
    </span>
    <a id="_idIndexMarker1244">
    </a>
    <span class="koboSpan" id="kobo.307.1">
     entities and how they relate to one another:
    </span>
   </p>
   <figure class="mediaobject">
    <span class="koboSpan" id="kobo.308.1">
     <img alt="img" src="../Images/B30992_14_02.png"/>
    </span>
   </figure>
   <p class="packt_figref">
    <span class="koboSpan" id="kobo.309.1">
     Figure 14.2: ER model of the database
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.310.1">
     We have defined the database models using SQLAlchemy, and we have chosen SQLite as the DBMS, for simplicity.
    </span>
   </p>
   <div class="note">
    <p class="normal">
     <span class="koboSpan" id="kobo.311.1">
      If you skipped
     </span>
     <em class="chapterRef">
      <span class="koboSpan" id="kobo.312.1">
       Chapter 8, Files and Data Persistence
      </span>
     </em>
     <span class="koboSpan" id="kobo.313.1">
      , this would be a good moment to read it, as it will provide you with a foundation to understand the models in this chapter’s project.
     </span>
    </p>
   </div>
   <p class="normal">
    <span class="koboSpan" id="kobo.314.1">
     Let us see the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.315.1">
      models
     </span>
    </code>
    <span class="koboSpan" id="kobo.316.1">
     module:
    </span>
   </p>
   <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.317.1"># api_code/api/models.py</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.318.1">import</span></span><span class="koboSpan" id="kobo.319.1"> hashlib
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.320.1">import</span></span><span class="koboSpan" id="kobo.321.1"> os
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.322.1">import</span></span><span class="koboSpan" id="kobo.323.1"> secrets
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.324.1">from</span></span><span class="koboSpan" id="kobo.325.1"> enum </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.326.1">import</span></span><span class="koboSpan" id="kobo.327.1"> StrEnum, auto
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.328.1">from</span></span><span class="koboSpan" id="kobo.329.1"> sqlalchemy </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.330.1">import</span></span><span class="koboSpan" id="kobo.331.1"> (
    DateTime,
    Enum,
    ForeignKey,
    Unicode,
)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.332.1">from</span></span><span class="koboSpan" id="kobo.333.1"> sqlalchemy.orm </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.334.1">import</span></span><span class="koboSpan" id="kobo.335.1"> mapped_column, relationship, Mapped
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.336.1">from</span></span><span class="koboSpan" id="kobo.337.1"> .database </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.338.1">import</span></span><span class="koboSpan" id="kobo.339.1"> Base
UNICODE_LEN = </span><span class="hljs-number"><span class="koboSpan" id="kobo.340.1">128</span></span><span class="koboSpan" id="kobo.341.1">
SALT_LEN = </span><span class="hljs-number"><span class="koboSpan" id="kobo.342.1">64</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.343.1"># Enums</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.344.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.345.1">Classes</span></span><span class="koboSpan" id="kobo.346.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.347.1">StrEnum</span></span><span class="koboSpan" id="kobo.348.1">):
    first = auto()
    second = auto()
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.349.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.350.1">Roles</span></span><span class="koboSpan" id="kobo.351.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.352.1">StrEnum</span></span><span class="koboSpan" id="kobo.353.1">):
    admin = auto()
    passenger = auto()
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.354.1">
     As usual, at
    </span>
    <a id="_idIndexMarker1245">
    </a>
    <span class="koboSpan" id="kobo.355.1">
     the top of the module, we import all that is necessary.
    </span>
    <span class="koboSpan" id="kobo.355.2">
     We then define a couple of variables to indicate the default length of Unicode fields (
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.356.1">
      UNICODE_LEN
     </span>
    </code>
    <span class="koboSpan" id="kobo.357.1">
     ) and the length of the salt used to hash passwords (
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.358.1">
      SALT_LEN
     </span>
    </code>
    <span class="koboSpan" id="kobo.359.1">
     ).
    </span>
   </p>
   <div class="packt_tip">
    <p class="normal">
     <span class="koboSpan" id="kobo.360.1">
      For a refresher on what a salt is, please refer to
     </span>
     <em class="chapterRef">
      <span class="koboSpan" id="kobo.361.1">
       Chapter 9, Cryptography and Tokens
      </span>
     </em>
     <span class="koboSpan" id="kobo.362.1">
      .
     </span>
    </p>
   </div>
   <p class="normal">
    <span class="koboSpan" id="kobo.363.1">
     We also define two enumerations:
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.364.1">
      Classes
     </span>
    </code>
    <span class="koboSpan" id="kobo.365.1">
     and
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.366.1">
      Roles
     </span>
    </code>
    <span class="koboSpan" id="kobo.367.1">
     , which will be used in the models’ definitions.
    </span>
    <span class="koboSpan" id="kobo.367.2">
     We used the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.368.1">
      StrEnum
     </span>
    </code>
    <span class="koboSpan" id="kobo.369.1">
     class as a base, which was introduced in Python 3.11, and makes it possible to compare its members directly to strings.
    </span>
    <span class="koboSpan" id="kobo.369.2">
     The
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.370.1">
      auto()
     </span>
    </code>
    <span class="koboSpan" id="kobo.371.1">
     function automatically generates values for
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.372.1">
      Enum
     </span>
    </code>
    <span class="koboSpan" id="kobo.373.1">
     attributes.
    </span>
    <span class="koboSpan" id="kobo.373.2">
     For
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.374.1">
      StrEnum
     </span>
    </code>
    <span class="koboSpan" id="kobo.375.1">
     , it will set the value to the lowercase version of the attribute name.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.376.1">
     Let us see
    </span>
    <a id="_idIndexMarker1246">
    </a>
    <span class="koboSpan" id="kobo.377.1">
     the definition of the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.378.1">
      Station
     </span>
    </code>
    <span class="koboSpan" id="kobo.379.1">
     model:
    </span>
   </p>
   <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.380.1"># api_code/api/models.py</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.381.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.382.1">Station</span></span><span class="koboSpan" id="kobo.383.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.384.1">Base</span></span><span class="koboSpan" id="kobo.385.1">):
    __tablename__ = </span><span class="hljs-string"><span class="koboSpan" id="kobo.386.1">"station"</span></span>
    <span class="hljs-built_in"><span class="koboSpan" id="kobo.387.1">id</span></span><span class="koboSpan" id="kobo.388.1">: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.389.1">int</span></span><span class="koboSpan" id="kobo.390.1">] = mapped_column(primary_key=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.391.1">True</span></span><span class="koboSpan" id="kobo.392.1">)
    code: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.393.1">str</span></span><span class="koboSpan" id="kobo.394.1">] = mapped_column(
        Unicode(UNICODE_LEN), unique=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.395.1">True</span></span><span class="koboSpan" id="kobo.396.1">
    )
    country: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.397.1">str</span></span><span class="koboSpan" id="kobo.398.1">] = mapped_column(Unicode(UNICODE_LEN))
    city: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.399.1">str</span></span><span class="koboSpan" id="kobo.400.1">] = mapped_column(Unicode(UNICODE_LEN))
    departures: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.401.1">list</span></span><span class="koboSpan" id="kobo.402.1">[</span><span class="hljs-string"><span class="koboSpan" id="kobo.403.1">"Train"</span></span><span class="koboSpan" id="kobo.404.1">]] = relationship(
        foreign_keys=</span><span class="hljs-string"><span class="koboSpan" id="kobo.405.1">"[Train.station_from_id]"</span></span><span class="koboSpan" id="kobo.406.1">,
        back_populates=</span><span class="hljs-string"><span class="koboSpan" id="kobo.407.1">"station_from"</span></span><span class="koboSpan" id="kobo.408.1">,
    )
    arrivals: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.409.1">list</span></span><span class="koboSpan" id="kobo.410.1">[</span><span class="hljs-string"><span class="koboSpan" id="kobo.411.1">"Train"</span></span><span class="koboSpan" id="kobo.412.1">]] = relationship(
        foreign_keys=</span><span class="hljs-string"><span class="koboSpan" id="kobo.413.1">"[Train.station_to_id]"</span></span><span class="koboSpan" id="kobo.414.1">,
        back_populates=</span><span class="hljs-string"><span class="koboSpan" id="kobo.415.1">"station_to"</span></span><span class="koboSpan" id="kobo.416.1">,
    )
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.417.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.418.1">__repr__</span></span><span class="koboSpan" id="kobo.419.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.420.1">self</span></span><span class="koboSpan" id="kobo.421.1">):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.422.1">return</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.423.1">f"&lt;</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.424.1">{self.code}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.425.1">: id=</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.426.1">{self.</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.427.1">id</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.428.1">}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.429.1"> city=</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.430.1">{self.city}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.431.1">&gt;"</span></span><span class="koboSpan" id="kobo.432.1">
    __str__ = __repr__
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.433.1">
     The
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.434.1">
      Station
     </span>
    </code>
    <span class="koboSpan" id="kobo.435.1">
     model is quite straightforward.
    </span>
    <span class="koboSpan" id="kobo.435.2">
     There are a few attributes:
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.436.1">
      id
     </span>
    </code>
    <span class="koboSpan" id="kobo.437.1">
     acts as the primary key, and then we have
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.438.1">
      code
     </span>
    </code>
    <span class="koboSpan" id="kobo.439.1">
     ,
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.440.1">
      country
     </span>
    </code>
    <span class="koboSpan" id="kobo.441.1">
     , and
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.442.1">
      city
     </span>
    </code>
    <span class="koboSpan" id="kobo.443.1">
     , which (when combined) tell us all we need to know about a station.
    </span>
    <span class="koboSpan" id="kobo.443.2">
     There are two relationships that link station instances to all the trains departing from, and arriving to, them.
    </span>
    <span class="koboSpan" id="kobo.443.3">
     The rest of the code defines the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.444.1">
      __repr__()
     </span>
    </code>
    <span class="koboSpan" id="kobo.445.1">
     method, which provides a string representation for instances, and whose implementation is also assigned to
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.446.1">
      __str__()
     </span>
    </code>
    <span class="koboSpan" id="kobo.447.1">
     , so the output will be the same whether we call
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.448.1">
      str(station_instance)
     </span>
    </code>
    <span class="koboSpan" id="kobo.449.1">
     or
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.450.1">
      repr(station_instance)
     </span>
    </code>
    <span class="koboSpan" id="kobo.451.1">
     .
    </span>
    <span class="koboSpan" id="kobo.451.2">
     This technique is quite commonly adopted to prevent code repetition.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.452.1">
     Notice that
    </span>
    <a id="_idIndexMarker1247">
    </a>
    <span class="koboSpan" id="kobo.453.1">
     we defined a unique constraint on the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.454.1">
      code
     </span>
    </code>
    <span class="koboSpan" id="kobo.455.1">
     field to ensure that no two stations with the same code can exist in the database.
    </span>
    <span class="koboSpan" id="kobo.455.2">
     Big cities like Rome, London, and Paris have more than one train station, so the fields
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.456.1">
      city
     </span>
    </code>
    <span class="koboSpan" id="kobo.457.1">
     and
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.458.1">
      country
     </span>
    </code>
    <span class="koboSpan" id="kobo.459.1">
     can be the same for stations located in the same city, but each of them must have its own unique
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.460.1">
      code
     </span>
    </code>
    <span class="koboSpan" id="kobo.461.1">
     .
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.462.1">
     Following that, we find the definition of the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.463.1">
      Train
     </span>
    </code>
    <span class="koboSpan" id="kobo.464.1">
     model:
    </span>
   </p>
   <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.465.1"># api_code/api/models.py</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.466.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.467.1">Train</span></span><span class="koboSpan" id="kobo.468.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.469.1">Base</span></span><span class="koboSpan" id="kobo.470.1">):
    __tablename__ = </span><span class="hljs-string"><span class="koboSpan" id="kobo.471.1">"train"</span></span>
    <span class="hljs-built_in"><span class="koboSpan" id="kobo.472.1">id</span></span><span class="koboSpan" id="kobo.473.1">: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.474.1">int</span></span><span class="koboSpan" id="kobo.475.1">] = mapped_column(primary_key=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.476.1">True</span></span><span class="koboSpan" id="kobo.477.1">)
    name: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.478.1">str</span></span><span class="koboSpan" id="kobo.479.1">] = mapped_column(Unicode(UNICODE_LEN))
    station_from_id: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.480.1">int</span></span><span class="koboSpan" id="kobo.481.1">] = mapped_column(
        ForeignKey(</span><span class="hljs-string"><span class="koboSpan" id="kobo.482.1">"station.id"</span></span><span class="koboSpan" id="kobo.483.1">)
    )
    station_from: Mapped[</span><span class="hljs-string"><span class="koboSpan" id="kobo.484.1">"Station"</span></span><span class="koboSpan" id="kobo.485.1">] = relationship(
        foreign_keys=[station_from_id],
        back_populates=</span><span class="hljs-string"><span class="koboSpan" id="kobo.486.1">"departures"</span></span><span class="koboSpan" id="kobo.487.1">,
    )
    station_to_id: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.488.1">int</span></span><span class="koboSpan" id="kobo.489.1">] = mapped_column(
        ForeignKey(</span><span class="hljs-string"><span class="koboSpan" id="kobo.490.1">"station.id"</span></span><span class="koboSpan" id="kobo.491.1">)
    )
    station_to: Mapped[</span><span class="hljs-string"><span class="koboSpan" id="kobo.492.1">"Station"</span></span><span class="koboSpan" id="kobo.493.1">] = relationship(
        foreign_keys=[station_to_id],
        back_populates=</span><span class="hljs-string"><span class="koboSpan" id="kobo.494.1">"arrivals"</span></span><span class="koboSpan" id="kobo.495.1">,
    )
    departs_at: Mapped[DateTime] = mapped_column(
        DateTime(timezone=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.496.1">True</span></span><span class="koboSpan" id="kobo.497.1">)
    )
    arrives_at: Mapped[DateTime] = mapped_column(
        DateTime(timezone=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.498.1">True</span></span><span class="koboSpan" id="kobo.499.1">)
    )
    first_class: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.500.1">int</span></span><span class="koboSpan" id="kobo.501.1">] = mapped_column(default=</span><span class="hljs-number"><span class="koboSpan" id="kobo.502.1">0</span></span><span class="koboSpan" id="kobo.503.1">)
    second_class: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.504.1">int</span></span><span class="koboSpan" id="kobo.505.1">] = mapped_column(default=</span><span class="hljs-number"><span class="koboSpan" id="kobo.506.1">0</span></span><span class="koboSpan" id="kobo.507.1">)
    seats_per_car: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.508.1">int</span></span><span class="koboSpan" id="kobo.509.1">] = mapped_column(default=</span><span class="hljs-number"><span class="koboSpan" id="kobo.510.1">0</span></span><span class="koboSpan" id="kobo.511.1">)
    tickets: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.512.1">list</span></span><span class="koboSpan" id="kobo.513.1">[</span><span class="hljs-string"><span class="koboSpan" id="kobo.514.1">"Ticket"</span></span><span class="koboSpan" id="kobo.515.1">]] = relationship(
        back_populates=</span><span class="hljs-string"><span class="koboSpan" id="kobo.516.1">"train"</span></span><span class="koboSpan" id="kobo.517.1">
    )
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.518.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.519.1">__repr__</span></span><span class="koboSpan" id="kobo.520.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.521.1">self</span></span><span class="koboSpan" id="kobo.522.1">):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.523.1">return</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.524.1">f"&lt;</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.525.1">{self.name}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.526.1">: id=</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.527.1">{self.</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.528.1">id</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.529.1">}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.530.1">&gt;"</span></span><span class="koboSpan" id="kobo.531.1">
    __str__ = __repr__
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.532.1">
     In the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.533.1">
      Train
     </span>
    </code>
    <span class="koboSpan" id="kobo.534.1">
     model, we find all the attributes we need to describe a train instance, plus a handy relationship,
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.535.1">
      tickets
     </span>
    </code>
    <span class="koboSpan" id="kobo.536.1">
     , that gives us access to all the tickets that have
    </span>
    <a id="_idIndexMarker1248">
    </a>
    <span class="koboSpan" id="kobo.537.1">
     been created against a train.
    </span>
    <span class="koboSpan" id="kobo.537.2">
     The
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.538.1">
      first_class
     </span>
    </code>
    <span class="koboSpan" id="kobo.539.1">
     and
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.540.1">
      second_class
     </span>
    </code>
    <span class="koboSpan" id="kobo.541.1">
     fields hold how many first- and second-class cars a train has.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.542.1">
     We also added relationships to station instances:
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.543.1">
      station_from
     </span>
    </code>
    <span class="koboSpan" id="kobo.544.1">
     and
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.545.1">
      station_to
     </span>
    </code>
    <span class="koboSpan" id="kobo.546.1">
     .
    </span>
    <span class="koboSpan" id="kobo.546.2">
     These allow us to fetch the station instances as objects, instead of only having access to their IDs.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.547.1">
     Next, the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.548.1">
      Ticket
     </span>
    </code>
    <span class="koboSpan" id="kobo.549.1">
     model:
    </span>
   </p>
   <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.550.1"># api_code/api/models.py</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.551.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.552.1">Ticket</span></span><span class="koboSpan" id="kobo.553.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.554.1">Base</span></span><span class="koboSpan" id="kobo.555.1">):
    __tablename__ = </span><span class="hljs-string"><span class="koboSpan" id="kobo.556.1">"ticket"</span></span>
    <span class="hljs-built_in"><span class="koboSpan" id="kobo.557.1">id</span></span><span class="koboSpan" id="kobo.558.1">: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.559.1">int</span></span><span class="koboSpan" id="kobo.560.1">] = mapped_column(primary_key=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.561.1">True</span></span><span class="koboSpan" id="kobo.562.1">)
    created_at: Mapped[DateTime] = mapped_column(
        DateTime(timezone=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.563.1">True</span></span><span class="koboSpan" id="kobo.564.1">)
    )
    user_id: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.565.1">int</span></span><span class="koboSpan" id="kobo.566.1">] = mapped_column(ForeignKey(</span><span class="hljs-string"><span class="koboSpan" id="kobo.567.1">"user.id"</span></span><span class="koboSpan" id="kobo.568.1">))
    user: Mapped[</span><span class="hljs-string"><span class="koboSpan" id="kobo.569.1">"User"</span></span><span class="koboSpan" id="kobo.570.1">] = relationship(
        foreign_keys=[user_id], back_populates=</span><span class="hljs-string"><span class="koboSpan" id="kobo.571.1">"tickets"</span></span><span class="koboSpan" id="kobo.572.1">
    )
    train_id: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.573.1">int</span></span><span class="koboSpan" id="kobo.574.1">] = mapped_column(ForeignKey(</span><span class="hljs-string"><span class="koboSpan" id="kobo.575.1">"train.id"</span></span><span class="koboSpan" id="kobo.576.1">))
    train: Mapped[</span><span class="hljs-string"><span class="koboSpan" id="kobo.577.1">"Train"</span></span><span class="koboSpan" id="kobo.578.1">] = relationship(
        foreign_keys=[train_id], back_populates=</span><span class="hljs-string"><span class="koboSpan" id="kobo.579.1">"tickets"</span></span><span class="koboSpan" id="kobo.580.1">
    )
    price: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.581.1">float</span></span><span class="koboSpan" id="kobo.582.1">] = mapped_column(default=</span><span class="hljs-number"><span class="koboSpan" id="kobo.583.1">0</span></span><span class="koboSpan" id="kobo.584.1">)
    car_class: Mapped[Enum] = mapped_column(Enum(Classes))
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.585.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.586.1">__repr__</span></span><span class="koboSpan" id="kobo.587.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.588.1">self</span></span><span class="koboSpan" id="kobo.589.1">):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.590.1">return</span></span><span class="koboSpan" id="kobo.591.1"> (
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.592.1">f"&lt;id=</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.593.1">{self.</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.594.1">id</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.595.1">}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.596.1"> user=</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.597.1">{self.user}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.598.1"> train=</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.599.1">{self.train}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.600.1">&gt;"</span></span><span class="koboSpan" id="kobo.601.1">
        )
    __str__ = __repr__
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.602.1">
     A
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.603.1">
      Ticket
     </span>
    </code>
    <span class="koboSpan" id="kobo.604.1">
     has
    </span>
    <a id="_idIndexMarker1249">
    </a>
    <span class="koboSpan" id="kobo.605.1">
     some properties too and includes two relationships:
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.606.1">
      user
     </span>
    </code>
    <span class="koboSpan" id="kobo.607.1">
     and
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.608.1">
      train
     </span>
    </code>
    <span class="koboSpan" id="kobo.609.1">
     , which point to the user who bought the ticket, and to the train the ticket is for, respectively.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.610.1">
     Notice how we have used the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.611.1">
      Classes
     </span>
    </code>
    <span class="koboSpan" id="kobo.612.1">
     enumeration in the definition of the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.613.1">
      car_class
     </span>
    </code>
    <span class="koboSpan" id="kobo.614.1">
     attribute.
    </span>
    <span class="koboSpan" id="kobo.614.2">
     This translates to an enumeration field in the database schema definition.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.615.1">
     Finally, the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.616.1">
      User
     </span>
    </code>
    <span class="koboSpan" id="kobo.617.1">
     model:
    </span>
   </p>
   <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.618.1"># api_code/api/models.py</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.619.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.620.1">User</span></span><span class="koboSpan" id="kobo.621.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.622.1">Base</span></span><span class="koboSpan" id="kobo.623.1">):
    __tablename__ = </span><span class="hljs-string"><span class="koboSpan" id="kobo.624.1">"user"</span></span><span class="koboSpan" id="kobo.625.1">
    pwd_separator = </span><span class="hljs-string"><span class="koboSpan" id="kobo.626.1">"#"</span></span>
    <span class="hljs-built_in"><span class="koboSpan" id="kobo.627.1">id</span></span><span class="koboSpan" id="kobo.628.1">: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.629.1">int</span></span><span class="koboSpan" id="kobo.630.1">] = mapped_column(primary_key=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.631.1">True</span></span><span class="koboSpan" id="kobo.632.1">)
    full_name: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.633.1">str</span></span><span class="koboSpan" id="kobo.634.1">] = mapped_column(
        Unicode(UNICODE_LEN), nullable=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.635.1">False</span></span><span class="koboSpan" id="kobo.636.1">
    )
    email: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.637.1">str</span></span><span class="koboSpan" id="kobo.638.1">] = mapped_column(
        Unicode(</span><span class="hljs-number"><span class="koboSpan" id="kobo.639.1">2</span></span><span class="koboSpan" id="kobo.640.1"> * UNICODE_LEN), unique=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.641.1">True</span></span><span class="koboSpan" id="kobo.642.1">
    )
    password: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.643.1">str</span></span><span class="koboSpan" id="kobo.644.1">] = mapped_column(
        Unicode(</span><span class="hljs-number"><span class="koboSpan" id="kobo.645.1">2</span></span><span class="koboSpan" id="kobo.646.1"> * UNICODE_LEN)
    )
    role: Mapped[Enum] = mapped_column(Enum(Roles))
    tickets: Mapped[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.647.1">list</span></span><span class="koboSpan" id="kobo.648.1">[</span><span class="hljs-string"><span class="koboSpan" id="kobo.649.1">"Ticket"</span></span><span class="koboSpan" id="kobo.650.1">]] = relationship(
        back_populates=</span><span class="hljs-string"><span class="koboSpan" id="kobo.651.1">"user"</span></span><span class="koboSpan" id="kobo.652.1">
    )
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.653.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.654.1">is_valid_password</span></span><span class="koboSpan" id="kobo.655.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.656.1">self, password: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.657.1">str</span></span><span class="koboSpan" id="kobo.658.1">):
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.659.1">"""Tell if password matches the one stored in DB."""</span></span><span class="koboSpan" id="kobo.660.1">
        salt, stored_hash = self.password.split(
            self.pwd_separator
        )
        _, computed_hash = _</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.661.1">hash</span></span><span class="koboSpan" id="kobo.662.1">(
            password=password, salt=</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.663.1">bytes</span></span><span class="koboSpan" id="kobo.664.1">.fromhex(salt)
        )
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.665.1">return</span></span><span class="koboSpan" id="kobo.666.1"> secrets.compare_digest(stored_hash, computed_hash)
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.667.1">    @classmethod</span></span>
    <span class="hljs-keyword"><span class="koboSpan" id="kobo.668.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.669.1">hash_password</span></span><span class="koboSpan" id="kobo.670.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.671.1">cls, password: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.672.1">str</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.673.1">, salt: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.674.1">bytes</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.675.1"> = </span></span><span class="hljs-literal"><span class="koboSpan" id="kobo.676.1">None</span></span><span class="koboSpan" id="kobo.677.1">):
        salt, hashed = _</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.678.1">hash</span></span><span class="koboSpan" id="kobo.679.1">(password=password, salt=salt)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.680.1">return</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.681.1">f"</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.682.1">{salt}{cls.pwd_separator}{hashed}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.683.1">"</span></span>
    <span class="hljs-keyword"><span class="koboSpan" id="kobo.684.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.685.1">__repr__</span></span><span class="koboSpan" id="kobo.686.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.687.1">self</span></span><span class="koboSpan" id="kobo.688.1">):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.689.1">return</span></span><span class="koboSpan" id="kobo.690.1"> (
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.691.1">f"&lt;</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.692.1">{self.full_name}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.693.1">: id=</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.694.1">{self.</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.695.1">id</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.696.1">}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.697.1"> "</span></span>
            <span class="hljs-string"><span class="koboSpan" id="kobo.698.1">f"role=</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.699.1">{self.role.name}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.700.1">&gt;"</span></span><span class="koboSpan" id="kobo.701.1">
        )
    __str__ = __repr__
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.702.1">
     The
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.703.1">
      User
     </span>
    </code>
    <span class="koboSpan" id="kobo.704.1">
     model
    </span>
    <a id="_idIndexMarker1250">
    </a>
    <span class="koboSpan" id="kobo.705.1">
     defines some properties for each user.
    </span>
    <span class="koboSpan" id="kobo.705.2">
     Note how here we have another enumeration used for the user’s role.
    </span>
    <span class="koboSpan" id="kobo.705.3">
     A user can either be a passenger or an admin.
    </span>
    <span class="koboSpan" id="kobo.705.4">
     This will allow us to present you with a simple example of how to write an endpoint that allows access only to authorized users.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.706.1">
     There are a couple of methods on the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.707.1">
      User
     </span>
    </code>
    <span class="koboSpan" id="kobo.708.1">
     model that are used to hash and validate passwords.
    </span>
    <span class="koboSpan" id="kobo.708.2">
     You might recall from
    </span>
    <em class="chapterRef">
     <span class="koboSpan" id="kobo.709.1">
      Chapter 9, Cryptography and Tokens
     </span>
    </em>
    <span class="koboSpan" id="kobo.710.1">
     , that passwords should never be stored in a database in plain text (which means, as they are).
    </span>
    <span class="koboSpan" id="kobo.710.2">
     So, in our API, when saving a password for a user, we create a hash and store it alongside the salt that was used for the encryption.
    </span>
    <span class="koboSpan" id="kobo.710.3">
     In the source code for the book, you will find, at the end of this module, the implementation of the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.711.1">
      _hash()
     </span>
    </code>
    <span class="koboSpan" id="kobo.712.1">
     function, which we have omitted here for brevity.
    </span>
   </p>
   <h2 class="heading-2" id="_idParaDest-360">
    <span class="koboSpan" id="kobo.713.1">
     Main setup and configuration
    </span>
   </h2>
   <p class="normal">
    <span class="koboSpan" id="kobo.714.1">
     Now that
    </span>
    <a id="_idIndexMarker1251">
    </a>
    <span class="koboSpan" id="kobo.715.1">
     we understand the database models, let us inspect the main entry point of the application:
    </span>
   </p>
   <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.716.1"># api_code/main.py</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.717.1">from</span></span><span class="koboSpan" id="kobo.718.1"> api </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.719.1">import</span></span><span class="koboSpan" id="kobo.720.1"> admin, config, stations, tickets, trains, users
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.721.1">from</span></span><span class="koboSpan" id="kobo.722.1"> fastapi </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.723.1">import</span></span><span class="koboSpan" id="kobo.724.1"> FastAPI
settings = config.Settings()
app = FastAPI()
app.include_router(admin.router)
app.include_router(stations.router)
app.include_router(trains.router)
app.include_router(users.router)
app.include_router(tickets.router)
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.725.1">@app.get(</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.726.1">"/"</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.727.1">)</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.728.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.729.1">root</span></span><span class="koboSpan" id="kobo.730.1">():
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.731.1">return</span></span><span class="koboSpan" id="kobo.732.1"> {
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.733.1">"message"</span></span><span class="koboSpan" id="kobo.734.1">: (
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.735.1">f"Welcome to version </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.736.1">{settings.api_version}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.737.1"> "</span></span>
            <span class="hljs-string"><span class="koboSpan" id="kobo.738.1">f"of our API"</span></span><span class="koboSpan" id="kobo.739.1">
        )
    }
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.740.1">
     This is all the code in the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.741.1">
      main.py
     </span>
    </code>
    <span class="koboSpan" id="kobo.742.1">
     module.
    </span>
    <span class="koboSpan" id="kobo.742.2">
     It imports the various endpoint modules and includes their routers in the main app.
    </span>
    <span class="koboSpan" id="kobo.742.3">
     By including a router in the main app, we enable the application to serve all the endpoints declared using that specific router.
    </span>
    <span class="koboSpan" id="kobo.742.4">
     We will explain what routers are later in the chapter.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.743.1">
     There is only one endpoint in the main module, which serves as a greeting message.
    </span>
    <span class="koboSpan" id="kobo.743.2">
     An endpoint is a simple function – in this case,
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.744.1">
      root()
     </span>
    </code>
    <span class="koboSpan" id="kobo.745.1">
     – that contains the code to be executed when a request is made against it.
    </span>
    <span class="koboSpan" id="kobo.745.2">
     When and how this function will be invoked depends on the decorator(s) applied to the function.
    </span>
    <span class="koboSpan" id="kobo.745.3">
     In this case, the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.746.1">
      app.get()
     </span>
    </code>
    <span class="koboSpan" id="kobo.747.1">
     decorator instructs the API to serve this endpoint when called with a GET request.
    </span>
    <span class="koboSpan" id="kobo.747.2">
     The decorator accepts an argument to specify the URL path on which
    </span>
    <a id="_idIndexMarker1252">
    </a>
    <span class="koboSpan" id="kobo.748.1">
     the endpoint will be served.
    </span>
    <span class="koboSpan" id="kobo.748.2">
     Here, we use
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.749.1">
      "/"
     </span>
    </code>
    <span class="koboSpan" id="kobo.750.1">
     to specify that this endpoint will be found at the root, which is the base URL on which the app is running.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.751.1">
     If this API were served at the base URL
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.752.1">
      http://localhost:8000
     </span>
    </code>
    <span class="koboSpan" id="kobo.753.1">
     , this endpoint would be called when we requested either
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.754.1">
      http://localhost:8000
     </span>
    </code>
    <span class="koboSpan" id="kobo.755.1">
     or
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.756.1">
      http://localhost:8000/
     </span>
    </code>
    <span class="koboSpan" id="kobo.757.1">
     (notice the difference is in the trailing slash).
    </span>
   </p>
   <h3 class="heading-3" id="_idParaDest-361">
    <span class="koboSpan" id="kobo.758.1">
     Application settings
    </span>
   </h3>
   <p class="normal">
    <span class="koboSpan" id="kobo.759.1">
     Within
    </span>
    <a id="_idIndexMarker1253">
    </a>
    <span class="koboSpan" id="kobo.760.1">
     the greeting message from the last snippet of code, there is a variable,
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.761.1">
      api_version
     </span>
    </code>
    <span class="koboSpan" id="kobo.762.1">
     , taken from the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.763.1">
      settings
     </span>
    </code>
    <span class="koboSpan" id="kobo.764.1">
     object.
    </span>
    <span class="koboSpan" id="kobo.764.2">
     All frameworks allow for a collection of settings to be injected into the application to configure its behavior.
    </span>
    <span class="koboSpan" id="kobo.764.3">
     We did not really need to use settings in this example project—we could have just hardcoded those values in the main module—but we thought it was worth showing you how they work:
    </span>
   </p>
   <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.765.1"># api_code/api/config.py</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.766.1">from</span></span><span class="koboSpan" id="kobo.767.1"> pydantic_settings </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.768.1">import</span></span><span class="koboSpan" id="kobo.769.1"> BaseSettings, SettingsConfigDict
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.770.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.771.1">Settings</span></span><span class="koboSpan" id="kobo.772.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.773.1">BaseSettings</span></span><span class="koboSpan" id="kobo.774.1">):
    model_config = SettingsConfigDict(env_file=</span><span class="hljs-string"><span class="koboSpan" id="kobo.775.1">".env"</span></span><span class="koboSpan" id="kobo.776.1">)
    secret_key: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.777.1">str</span></span><span class="koboSpan" id="kobo.778.1">
    debug: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.779.1">bool</span></span><span class="koboSpan" id="kobo.780.1">
    api_version: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.781.1">str</span></span>
</code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.782.1">
     Settings are defined within a Pydantic model (
    </span>
    <a href="https://github.com/pydantic/pydantic">
     <span class="url">
      <span class="koboSpan" id="kobo.783.1">
       https://github.com/pydantic/pydantic
      </span>
     </span>
    </a>
    <span class="koboSpan" id="kobo.784.1">
     ).
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.785.1">
      Pydantic
     </span>
    </strong>
    <span class="koboSpan" id="kobo.786.1">
     is a
    </span>
    <a id="_idIndexMarker1254">
    </a>
    <span class="koboSpan" id="kobo.787.1">
     library that provides data validation using Python-type annotations.
    </span>
    <span class="koboSpan" id="kobo.787.2">
     Older versions of Pydantic also provided settings management, but that feature has been extracted into a separate library called
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.788.1">
      pydantic-settings
     </span>
    </code>
    <span class="koboSpan" id="kobo.789.1">
     (
    </span>
    <a href="https://github.com/pydantic/pydantic-settings">
     <span class="url">
      <span class="koboSpan" id="kobo.790.1">
       https://github.com/pydantic/pydantic-settings
      </span>
     </span>
    </a>
    <span class="koboSpan" id="kobo.791.1">
     ), which also adds additional settings management capabilities.
    </span>
    <span class="koboSpan" id="kobo.791.2">
     In this case, we have three pieces of information within the settings:
    </span>
   </p>
   <ul>
    <li class="bulletList">
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.792.1">
       secret_key
      </span>
     </code>
     <span class="koboSpan" id="kobo.793.1">
      : Used to sign and verify JSON Web Tokens (JWTs).
     </span>
    </li>
    <li class="bulletList">
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.794.1">
       debug
      </span>
     </code>
     <span class="koboSpan" id="kobo.795.1">
      : When set to
     </span>
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.796.1">
       True
      </span>
     </code>
     <span class="koboSpan" id="kobo.797.1">
      , it instructs the SQLAlchemy engine to log verbosely, which is helpful to debug queries.
     </span>
    </li>
    <li class="bulletList">
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.798.1">
       api_version
      </span>
     </code>
     <span class="koboSpan" id="kobo.799.1">
      : The version of the API.
     </span>
     <span class="koboSpan" id="kobo.799.2">
      We do not really make use of this information, apart from displaying it in the greeting message, but normally the version plays an important role because it is tied to a specific API specification.
     </span>
    </li>
   </ul>
   <p class="normal">
    <span class="koboSpan" id="kobo.800.1">
     FastAPI plucks
    </span>
    <a id="_idIndexMarker1255">
    </a>
    <span class="koboSpan" id="kobo.801.1">
     these settings from a
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.802.1">
      .env
     </span>
    </code>
    <span class="koboSpan" id="kobo.803.1">
     file, as specified when we create the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.804.1">
      SettingsConfigDict
     </span>
    </code>
    <span class="koboSpan" id="kobo.805.1">
     instance.
    </span>
    <span class="koboSpan" id="kobo.805.2">
     Here is how that file looks:
    </span>
   </p>
   <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.806.1"># api_code/.env</span></span><span class="koboSpan" id="kobo.807.1">
SECRET_KEY=</span><span class="hljs-string"><span class="koboSpan" id="kobo.808.1">"018ea65f62337ed59567a794b19dcaf8"</span></span><span class="koboSpan" id="kobo.809.1">
DEBUG=false
API_VERSION=</span><span class="hljs-number"><span class="koboSpan" id="kobo.810.1">2.0.0</span></span>
</code></pre>
   <div class="note">
    <p class="normal">
     <span class="koboSpan" id="kobo.811.1">
      For this to work, FastAPI needs help from a library called
     </span>
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.812.1">
       python-dotenv
      </span>
     </code>
     <span class="koboSpan" id="kobo.813.1">
      .
     </span>
     <span class="koboSpan" id="kobo.813.2">
      It is part of this chapter’s requirements, so if you have installed them in your virtual environment, you are all set.
     </span>
    </p>
   </div>
   <h2 class="heading-2" id="_idParaDest-362">
    <span class="koboSpan" id="kobo.814.1">
     Station endpoints
    </span>
   </h2>
   <p class="normal">
    <span class="koboSpan" id="kobo.815.1">
     We are going to
    </span>
    <a id="_idIndexMarker1256">
    </a>
    <span class="koboSpan" id="kobo.816.1">
     explore some FastAPI endpoints.
    </span>
    <span class="koboSpan" id="kobo.816.2">
     Because this API is CRUD-oriented, there is some repetition in the code.
    </span>
    <span class="koboSpan" id="kobo.816.3">
     We will therefore show you one example for each of
    </span>
    <a id="_idIndexMarker1257">
    </a>
    <span class="koboSpan" id="kobo.817.1">
     the CRUD operations, and we will do so by using the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.818.1">
      Station
     </span>
    </code>
    <span class="koboSpan" id="kobo.819.1">
     endpoints examples.
    </span>
    <span class="koboSpan" id="kobo.819.2">
     Please refer to the source code to explore the endpoints related to the other models.
    </span>
    <span class="koboSpan" id="kobo.819.3">
     You will find that they all follow the same patterns and conventions.
    </span>
    <span class="koboSpan" id="kobo.819.4">
     The main difference is that they relate to different database models.
    </span>
   </p>
   <h3 class="heading-3" id="_idParaDest-363">
    <span class="koboSpan" id="kobo.820.1">
     Reading data
    </span>
   </h3>
   <p class="normal">
    <span class="koboSpan" id="kobo.821.1">
     Let us start our
    </span>
    <a id="_idIndexMarker1258">
    </a>
    <span class="koboSpan" id="kobo.822.1">
     exploration with a GET request.
    </span>
    <span class="koboSpan" id="kobo.822.2">
     In this case, we are going to get all the stations in the database.
    </span>
   </p>
   <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.823.1"># api_code/api/stations.py</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.824.1">from</span></span><span class="koboSpan" id="kobo.825.1"> typing </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.826.1">import</span></span> <span class="hljs-type"><span class="koboSpan" id="kobo.827.1">Optional</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.828.1">from</span></span><span class="koboSpan" id="kobo.829.1"> fastapi </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.830.1">import</span></span><span class="koboSpan" id="kobo.831.1"> (
    APIRouter,
    Depends,
    HTTPException,
    Response,
    status,
)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.832.1">from</span></span><span class="koboSpan" id="kobo.833.1"> sqlalchemy.orm </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.834.1">import</span></span><span class="koboSpan" id="kobo.835.1"> Session
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.836.1">from</span></span><span class="koboSpan" id="kobo.837.1"> . </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.838.1">import</span></span><span class="koboSpan" id="kobo.839.1"> crud
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.840.1">from</span></span><span class="koboSpan" id="kobo.841.1"> .deps </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.842.1">import</span></span><span class="koboSpan" id="kobo.843.1"> get_db
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.844.1">from</span></span><span class="koboSpan" id="kobo.845.1"> .schemas </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.846.1">import</span></span><span class="koboSpan" id="kobo.847.1"> Station, StationCreate, StationUpdate, Train
router = APIRouter(prefix=</span><span class="hljs-string"><span class="koboSpan" id="kobo.848.1">"/stations"</span></span><span class="koboSpan" id="kobo.849.1">)
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.850.1">@router.get(</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.851.1">""</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.852.1">, tags=[</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.853.1">"Stations"</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.854.1">]</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.855.1">)</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.856.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.857.1">get_stations</span></span><span class="koboSpan" id="kobo.858.1">(
</span><span class="hljs-params"><span class="koboSpan" id="kobo.859.1">    db: Session = Depends(get_db), code: </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.860.1">Optional</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.861.1">[</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.862.1">str</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.863.1">] = </span></span><span class="hljs-literal"><span class="koboSpan" id="kobo.864.1">None</span></span><span class="koboSpan" id="kobo.865.1">
) -&gt; </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.866.1">list</span></span><span class="koboSpan" id="kobo.867.1">[Station]:
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.868.1">return</span></span><span class="koboSpan" id="kobo.869.1"> crud.get_stations(db=db, code=code)
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.870.1">
     Within the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.871.1">
      stations.py
     </span>
    </code>
    <span class="koboSpan" id="kobo.872.1">
     module, we start by importing the necessary objects from the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.873.1">
      typing
     </span>
    </code>
    <span class="koboSpan" id="kobo.874.1">
     module, and from
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.875.1">
      fastapi
     </span>
    </code>
    <span class="koboSpan" id="kobo.876.1">
     .
    </span>
    <span class="koboSpan" id="kobo.876.2">
     We also import
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.877.1">
      Session
     </span>
    </code>
    <span class="koboSpan" id="kobo.878.1">
     from
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.879.1">
      sqlalchemy
     </span>
    </code>
    <span class="koboSpan" id="kobo.880.1">
     , and a few other tools from the local codebase.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.881.1">
     The endpoint
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.882.1">
      get_stations()
     </span>
    </code>
    <span class="koboSpan" id="kobo.883.1">
     is decorated with a
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.884.1">
      router
     </span>
    </code>
    <span class="koboSpan" id="kobo.885.1">
     object, instead of
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.886.1">
      app
     </span>
    </code>
    <span class="koboSpan" id="kobo.887.1">
     like in the main file.
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.888.1">
      APIRouter
     </span>
    </code>
    <span class="koboSpan" id="kobo.889.1">
     can be thought of as a mini
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.890.1">
      FastAPI
     </span>
    </code>
    <span class="koboSpan" id="kobo.891.1">
     class, in that it takes all the same arguments.
    </span>
    <span class="koboSpan" id="kobo.891.2">
     We declare
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.892.1">
      router
     </span>
    </code>
    <span class="koboSpan" id="kobo.893.1">
     and assign a prefix to it (
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.894.1">
      "
     </span>
    </code>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.895.1">
      /stations"
     </span>
    </code>
    <span class="koboSpan" id="kobo.896.1">
     , in this case), which means all functions decorated with this router become endpoints that can be called at addresses that start with
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.897.1">
      http://localhost:8000/stations
     </span>
    </code>
    <span class="koboSpan" id="kobo.898.1">
     .
    </span>
    <span class="koboSpan" id="kobo.898.2">
     In this case, the empty string fed to the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.899.1">
      router.get()
     </span>
    </code>
    <span class="koboSpan" id="kobo.900.1">
     method instructs the app to serve this endpoint on the root URL for this router, which will be the concatenation of the base URL and the router prefix, as explained above.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.901.1">
     FastAPI provides
    </span>
    <a id="_idIndexMarker1259">
    </a>
    <span class="koboSpan" id="kobo.902.1">
     a couple of alternative ways to specify the type of data returned from an endpoint.
    </span>
    <span class="koboSpan" id="kobo.902.2">
     One is to pass a
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.903.1">
      response_model
     </span>
    </code>
    <span class="koboSpan" id="kobo.904.1">
     argument to the decorator.
    </span>
    <span class="koboSpan" id="kobo.904.2">
     In our case, though, it is enough to specify the return value of the function using type annotations.
    </span>
    <span class="koboSpan" id="kobo.904.3">
     For this endpoint, we return a list of
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.905.1">
      Station
     </span>
    </code>
    <span class="koboSpan" id="kobo.906.1">
     instances.
    </span>
    <span class="koboSpan" id="kobo.906.2">
     We will see their implementation shortly.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.907.1">
     The
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.908.1">
      tags
     </span>
    </code>
    <span class="koboSpan" id="kobo.909.1">
     argument is used for documentation purposes.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.910.1">
     The function itself takes some arguments, which are a database session,
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.911.1">
      db
     </span>
    </code>
    <span class="koboSpan" id="kobo.912.1">
     , and an optional string,
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.913.1">
      code
     </span>
    </code>
    <span class="koboSpan" id="kobo.914.1">
     , which, when specified, will instruct the endpoint to serve only the stations whose
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.915.1">
      code
     </span>
    </code>
    <span class="koboSpan" id="kobo.916.1">
     field matches the one provided.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.917.1">
     A few things to notice:
    </span>
   </p>
   <ul>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.918.1">
      Data coming with the request, such as query parameters, is specified in the endpoint declaration.
     </span>
     <span class="koboSpan" id="kobo.918.2">
      If the endpoint function requires data to be sent in the body of the request, this is specified using Pydantic models (in this project, they are defined in the
     </span>
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.919.1">
       schemas.py
      </span>
     </code>
     <span class="koboSpan" id="kobo.920.1">
      module).
     </span>
    </li>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.921.1">
      Whatever an endpoint returns becomes the body of the response.
     </span>
     <span class="koboSpan" id="kobo.921.2">
      FastAPI will try to serialize the returned data to JSON.
     </span>
     <span class="koboSpan" id="kobo.921.3">
      However, when the response model is set, serialization goes first through the Pydantic model specified in
     </span>
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.922.1">
       response_model
      </span>
     </code>
     <span class="koboSpan" id="kobo.923.1">
      , and then from the Pydantic model to JSON.
     </span>
    </li>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.924.1">
      To use a database session in the body of an endpoint, we use a dependency provider, which, in this case, is specified using the
     </span>
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.925.1">
       Depends
      </span>
     </code>
     <span class="koboSpan" id="kobo.926.1">
      class, to which we pass the
     </span>
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.927.1">
       get_db()
      </span>
     </code>
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.928.1">
       function
      </span>
     </code>
     <span class="koboSpan" id="kobo.929.1">
      .
     </span>
     <span class="koboSpan" id="kobo.929.2">
      This function yields a local database session and closes it when the endpoint call terminates.
     </span>
    </li>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.930.1">
      We use the
     </span>
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.931.1">
       Optional
      </span>
     </code>
     <span class="koboSpan" id="kobo.932.1">
      class, from the
     </span>
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.933.1">
       typing
      </span>
     </code>
     <span class="koboSpan" id="kobo.934.1">
      module, to specify that parameters are optional in a request.
     </span>
    </li>
   </ul>
   <p class="normal">
    <span class="koboSpan" id="kobo.935.1">
     The body of the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.936.1">
      get_stations()
     </span>
    </code>
    <span class="koboSpan" id="kobo.937.1">
     function simply calls the function of the same name from the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.938.1">
      crud
     </span>
    </code>
    <span class="koboSpan" id="kobo.939.1">
     module and returns the resulting value.
    </span>
    <span class="koboSpan" id="kobo.939.2">
     All the functions that regulate the interaction with the database live in the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.940.1">
      crud.py
     </span>
    </code>
    <span class="koboSpan" id="kobo.941.1">
     module.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.942.1">
     This was a
    </span>
    <a id="_idIndexMarker1260">
    </a>
    <span class="koboSpan" id="kobo.943.1">
     design choice that should make this code easier to reuse and test.
    </span>
    <span class="koboSpan" id="kobo.943.2">
     Moreover, it simplifies reading the entry point code.
    </span>
    <span class="koboSpan" id="kobo.943.3">
     Let us see the body of
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.944.1">
      get_stations()
     </span>
    </code>
    <span class="koboSpan" id="kobo.945.1">
     in the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.946.1">
      crud.py
     </span>
    </code>
    <span class="koboSpan" id="kobo.947.1">
     module:
    </span>
   </p>
   <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.948.1"># api_code/api/crud.py</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.949.1">from</span></span><span class="koboSpan" id="kobo.950.1"> datetime </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.951.1">import</span></span><span class="koboSpan" id="kobo.952.1"> UTC, datetime
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.953.1">from</span></span><span class="koboSpan" id="kobo.954.1"> sqlalchemy </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.955.1">import</span></span><span class="koboSpan" id="kobo.956.1"> delete, select, update
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.957.1">from</span></span><span class="koboSpan" id="kobo.958.1"> sqlalchemy.orm </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.959.1">import</span></span><span class="koboSpan" id="kobo.960.1"> Session, aliased
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.961.1">from</span></span><span class="koboSpan" id="kobo.962.1"> . </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.963.1">import</span></span><span class="koboSpan" id="kobo.964.1"> models, schemas
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.965.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.966.1">get_stations</span></span><span class="koboSpan" id="kobo.967.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.968.1">db: Session, code: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.969.1">str</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.970.1"> | </span></span><span class="hljs-literal"><span class="koboSpan" id="kobo.971.1">None</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.972.1"> = </span></span><span class="hljs-literal"><span class="koboSpan" id="kobo.973.1">None</span></span><span class="koboSpan" id="kobo.974.1">):
    stm = select(models.Station)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.975.1">if</span></span><span class="koboSpan" id="kobo.976.1"> code </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.977.1">is</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.978.1">not</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.979.1">None</span></span><span class="koboSpan" id="kobo.980.1">:
        stm = stm.where(models.Station.code.ilike(code))
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.981.1">return</span></span><span class="koboSpan" id="kobo.982.1"> db.scalars(stm).</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.983.1">all</span></span><span class="koboSpan" id="kobo.984.1">()
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.985.1">
     Notice how similar this function’s signature is to the one for the endpoint that calls it.
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.986.1">
      get_stations()
     </span>
    </code>
    <span class="koboSpan" id="kobo.987.1">
     selects and returns all instances of
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.988.1">
      Station
     </span>
    </code>
    <span class="koboSpan" id="kobo.989.1">
     , optionally filtered by
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.990.1">
      code
     </span>
    </code>
    <span class="koboSpan" id="kobo.991.1">
     (in case it is not
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.992.1">
      None
     </span>
    </code>
    <span class="koboSpan" id="kobo.993.1">
     ).
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.994.1">
     To start the API, activate your virtual environment and run the following command from within the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.995.1">
      api_code
     </span>
    </code>
    <span class="koboSpan" id="kobo.996.1">
     folder:
    </span>
   </p>
   <pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.997.1">$ uvicorn main:app --reload
</span></code></pre>
   <p class="normal">
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.998.1">
      Uvicorn
     </span>
    </strong>
    <span class="koboSpan" id="kobo.999.1">
     is a
    </span>
    <a id="_idIndexMarker1261">
    </a>
    <span class="koboSpan" id="kobo.1000.1">
     lightning-fast
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.1001.1">
      ASGI server
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1002.1">
     , built
    </span>
    <a id="_idIndexMarker1262">
    </a>
    <span class="koboSpan" id="kobo.1003.1">
     on
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1004.1">
      uvloop
     </span>
    </code>
    <span class="koboSpan" id="kobo.1005.1">
     and
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1006.1">
      httptools
     </span>
    </code>
    <span class="koboSpan" id="kobo.1007.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1007.2">
     It works seamlessly with both normal and asynchronous functions.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1008.1">
     From the
    </span>
    <a id="_idIndexMarker1263">
    </a>
    <span class="koboSpan" id="kobo.1009.1">
     ASGI documentation page (
    </span>
    <a href="https://asgi.readthedocs.io/">
     <span class="url">
      <span class="koboSpan" id="kobo.1010.1">
       https://asgi.readthedocs.io/
      </span>
     </span>
    </a>
    <span class="koboSpan" id="kobo.1011.1">
     ):
    </span>
   </p>
   <blockquote class="packt_quote">
    <p class="quote">
     <strong class="keyWord">
      <span class="koboSpan" id="kobo.1012.1">
       ASGI
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1013.1">
      (
     </span>
     <strong class="keyWord">
      <span class="koboSpan" id="kobo.1014.1">
       Asynchronous Server Gateway Interface
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1015.1">
      ) is a spiritual successor to
     </span>
     <strong class="keyWord">
      <span class="koboSpan" id="kobo.1016.1">
       WSGI
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1017.1">
      (
     </span>
     <strong class="keyWord">
      <span class="koboSpan" id="kobo.1018.1">
       Web Server Gateway Interface
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1019.1">
      ), intended to provide a standard interface between async-capable Python web servers, frameworks, and applications.
     </span>
    </p>
    <p class="quote">
     <span class="koboSpan" id="kobo.1020.1">
      Where WSGI
     </span>
     <a id="_idIndexMarker1264">
     </a>
     <span class="koboSpan" id="kobo.1021.1">
      provided a standard for synchronous Python apps, ASGI provides one for both asynchronous and synchronous apps, with a WSGI backwards-compatibility implementation and multiple servers and application frameworks.
     </span>
    </p>
   </blockquote>
   <p class="normal">
    <span class="koboSpan" id="kobo.1022.1">
     For this
    </span>
    <a id="_idIndexMarker1265">
    </a>
    <span class="koboSpan" id="kobo.1023.1">
     chapter’s project, we have chosen to write synchronous code as the asynchronous equivalent would have only made the code more difficult to understand.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1024.1">
     If you are comfortable
    </span>
    <a id="_idIndexMarker1266">
    </a>
    <span class="koboSpan" id="kobo.1025.1">
     writing asynchronous code, please refer to the FastAPI documentation (
    </span>
    <a href="https://fastapi.tiangolo.com">
     <span class="url">
      <span class="koboSpan" id="kobo.1026.1">
       https://fastapi.tiangolo.com
      </span>
     </span>
    </a>
    <span class="koboSpan" id="kobo.1027.1">
     ) to learn how to write asynchronous endpoints.
    </span>
   </p>
   <div class="packt_tip">
    <p class="normal">
     <span class="koboSpan" id="kobo.1028.1">
      The
     </span>
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.1029.1">
       --reload
      </span>
     </code>
     <span class="koboSpan" id="kobo.1030.1">
      flag in the
     </span>
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.1031.1">
       uvicorn
      </span>
     </code>
     <span class="koboSpan" id="kobo.1032.1">
      command above configures the server to automatically reload whenever a file is saved.
     </span>
     <span class="koboSpan" id="kobo.1032.2">
      It is optional, but quite useful for saving time when you are working on the API source code.
     </span>
    </p>
   </div>
   <p class="normal">
    <span class="koboSpan" id="kobo.1033.1">
     If we called the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1034.1">
      get_stations()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1035.1">
     endpoint, this is what we would see:
    </span>
   </p>
   <pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1036.1">$ http http://localhost:8000/stations
HTTP/1.1 200 OK
content-length: 702
content-type: application/json
date: Thu, 04 Apr 2024 09:46:29 GMT
server: uvicorn
[
    {
        "city": "Rome",
        "code": "ROM",
        "country": "Italy",
        "id": 0
    },
    {
        "city": "Paris",
        "code": "PAR",
        "country": "France",
        "id": 1
    },
    ... </span><span class="koboSpan" id="kobo.1036.2">some stations omitted ...
    </span><span class="koboSpan" id="kobo.1036.3">{
        "city": "Sofia",
        "code": "SFA",
        "country": "Bulgaria",
        "id": 11
    }
]
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1037.1">
     Notice the
    </span>
    <a id="_idIndexMarker1267">
    </a>
    <span class="koboSpan" id="kobo.1038.1">
     command we are using to call the API:
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1039.1">
      http
     </span>
    </code>
    <span class="koboSpan" id="kobo.1040.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1040.2">
     This is a command that comes with
    </span>
    <a id="_idIndexMarker1268">
    </a>
    <span class="koboSpan" id="kobo.1041.1">
     the
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.1042.1">
      Httpie
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1043.1">
     utility.
    </span>
   </p>
   <div class="note">
    <p class="normal">
     <span class="koboSpan" id="kobo.1044.1">
      You can find
     </span>
     <a id="_idIndexMarker1269">
     </a>
     <span class="koboSpan" id="kobo.1045.1">
      Httpie at
     </span>
     <a href="https://httpie.io">
      <span class="url">
       <span class="koboSpan" id="kobo.1046.1">
        https://httpie.io
       </span>
      </span>
     </a>
     <span class="koboSpan" id="kobo.1047.1">
      .
     </span>
     <span class="koboSpan" id="kobo.1047.2">
      Httpie is a user-friendly command-line HTTP client for the API era.
     </span>
     <span class="koboSpan" id="kobo.1047.3">
      It comes with JSON support, syntax highlighting, persistent sessions, wget-like downloads, plugins, and more.
     </span>
     <span class="koboSpan" id="kobo.1047.4">
      There are other tools to perform requests, such as
     </span>
     <strong class="keyWord">
      <span class="koboSpan" id="kobo.1048.1">
       curl
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1049.1">
      .
     </span>
     <span class="koboSpan" id="kobo.1049.2">
      The choice is up to you, as it makes no difference which tool you use to make requests from the command line.
     </span>
    </p>
   </div>
   <p class="normal">
    <span class="koboSpan" id="kobo.1050.1">
     The API is served by default at
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1051.1">
      http://localhost:8000
     </span>
    </code>
    <span class="koboSpan" id="kobo.1052.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1052.2">
     You can add arguments to the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1053.1">
      uvicorn
     </span>
    </code>
    <span class="koboSpan" id="kobo.1054.1">
     command to customize this, if you so desire.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1055.1">
     The first few lines of the response are information from the API engine.
    </span>
    <span class="koboSpan" id="kobo.1055.2">
     We learn the protocol used was HTTP1.1, and that the request succeeded (status code
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1056.1">
      200 OK
     </span>
    </em>
    <span class="koboSpan" id="kobo.1057.1">
     ).
    </span>
    <span class="koboSpan" id="kobo.1057.2">
     We have info on the content length, and its type, which is JSON.
    </span>
    <span class="koboSpan" id="kobo.1057.3">
     Finally, we get a timestamp and the type of server.
    </span>
    <span class="koboSpan" id="kobo.1057.4">
     We are going to omit the part of this information that just repeats, from now on.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1058.1">
     The body of the response is a list of
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1059.1">
      Station
     </span>
    </code>
    <span class="koboSpan" id="kobo.1060.1">
     instances, in their JSON representation, thanks to
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1061.1">
      list[Station
     </span>
    </code>
    <span class="koboSpan" id="kobo.1062.1">
     ] type annotation, which we indicated in the function signature.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1063.1">
     If we were to search by
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1064.1">
      code
     </span>
    </code>
    <span class="koboSpan" id="kobo.1065.1">
     , for example, the London station, we could use the following command:
    </span>
   </p>
   <pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1066.1">$ http http://localhost:8000/stations?code=LDN
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1067.1">
     The above command uses the same URL as before but adds the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1068.1">
      code
     </span>
    </code>
    <span class="koboSpan" id="kobo.1069.1">
     query parameter (separated from the URL path with a
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1070.1">
      ?
     </span>
    </code>
    <span class="koboSpan" id="kobo.1071.1">
     ).
    </span>
    <span class="koboSpan" id="kobo.1071.2">
     The result is as follows:
    </span>
   </p>
   <pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1072.1">$ http http://localhost:8000/stations?code=LDN
HTTP/1.1 200 OK
...
</span><span class="koboSpan" id="kobo.1072.2">[
    {
        "city": "London",
        "code": "LDN",
        "country": "UK",
        "id": 2
    }
]
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1073.1">
     Notice
    </span>
    <a id="_idIndexMarker1270">
    </a>
    <span class="koboSpan" id="kobo.1074.1">
     how we got one match, which corresponds to the London station, but still, it is returned as a list, as indicated by the type annotation for this endpoint.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1075.1">
     Let us now explore an endpoint dedicated to fetching a single station by ID:
    </span>
   </p>
   <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1076.1"># api_code/api/stations.py</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.1077.1">@router.get(</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1078.1">"/{station_id}"</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1079.1">, tags=[</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1080.1">"Stations"</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1081.1">]</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.1082.1">)</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1083.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1084.1">get_station</span></span><span class="koboSpan" id="kobo.1085.1">(
</span><span class="hljs-params"><span class="koboSpan" id="kobo.1086.1">    station_id: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1087.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1088.1">, db: Session = Depends(get_db)</span></span><span class="koboSpan" id="kobo.1089.1">
) -&gt; Station:
    db_station = crud.get_station(db=db, station_id=station_id)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1090.1">if</span></span><span class="koboSpan" id="kobo.1091.1"> db_station </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1092.1">is</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.1093.1">None</span></span><span class="koboSpan" id="kobo.1094.1">:
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1095.1">raise</span></span><span class="koboSpan" id="kobo.1096.1"> HTTPException(
            status_code=</span><span class="hljs-number"><span class="koboSpan" id="kobo.1097.1">404</span></span><span class="koboSpan" id="kobo.1098.1">,
            detail=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1099.1">f"Station </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1100.1">{station_id}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1101.1"> not found."</span></span><span class="koboSpan" id="kobo.1102.1">,
        )
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1103.1">return</span></span><span class="koboSpan" id="kobo.1104.1"> db_station
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1105.1">
     For this endpoint, we configure the router to accept GET requests, at the URL
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1106.1">
      http://localhost:8000/stations/{station_id}
     </span>
    </code>
    <span class="koboSpan" id="kobo.1107.1">
     , where
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1108.1">
      station_id
     </span>
    </code>
    <span class="koboSpan" id="kobo.1109.1">
     will be an integer.
    </span>
    <span class="koboSpan" id="kobo.1109.2">
     Hopefully, the way URLs are constructed is starting to make sense for you.
    </span>
    <span class="koboSpan" id="kobo.1109.3">
     There is the base part,
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1110.1">
      http://localhost:8000
     </span>
    </code>
    <span class="koboSpan" id="kobo.1111.1">
     , then the prefix for the router,
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1112.1">
      /stations
     </span>
    </code>
    <span class="koboSpan" id="kobo.1113.1">
     , and finally, the specific URL information that we feed to each endpoint, which in this case is
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1114.1">
      /{station_id}
     </span>
    </code>
    <span class="koboSpan" id="kobo.1115.1">
     .
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1116.1">
     Let us fetch the Kyiv station, with ID
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1117.1">
      3
     </span>
    </code>
    <span class="koboSpan" id="kobo.1118.1">
     :
    </span>
   </p>
   <pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1119.1">$ http http://localhost:8000/stations/3
HTTP/1.1 200 OK
...
</span><span class="koboSpan" id="kobo.1119.2">{
    "city": "Kyiv",
    "code": "KYV",
    "country": "Ukraine",
    "id": 3
}
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1120.1">
     Notice
    </span>
    <a id="_idIndexMarker1271">
    </a>
    <span class="koboSpan" id="kobo.1121.1">
     how this time we got back an object by itself, instead of it being wrapped in a list like it was in the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1122.1">
      get_stations()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1123.1">
     endpoint.
    </span>
    <span class="koboSpan" id="kobo.1123.2">
     This is in accordance with the type annotation for this endpoint, which is set to
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1124.1">
      Station
     </span>
    </code>
    <span class="koboSpan" id="kobo.1125.1">
     , and it makes sense, as we are fetching a single object by ID.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1126.1">
     The
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1127.1">
      get_station()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1128.1">
     function takes the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1129.1">
      station_id
     </span>
    </code>
    <span class="koboSpan" id="kobo.1130.1">
     , type-annotated as an integer, and the usual
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1131.1">
      db
     </span>
    </code>
    <span class="koboSpan" id="kobo.1132.1">
     session object.
    </span>
    <span class="koboSpan" id="kobo.1132.2">
     Using type annotations to specify parameters allows FastAPI to do data validation on the type of the arguments we use when calling an endpoint.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1133.1">
     If we were to pass a non-integer value for
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1134.1">
      station_id
     </span>
    </code>
    <span class="koboSpan" id="kobo.1135.1">
     , this would happen:
    </span>
   </p>
   <pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1136.1">$ http http://localhost:8000/stations/kyiv
HTTP/1.1 422 Unprocessable Entity
...
</span><span class="koboSpan" id="kobo.1136.2">{
    "detail": [
        {
            "input": "kyiv",
            "loc": [
                "path",
                "station_id"
            ],
            "msg": "Input should be a valid integer, …",
            "type": "int_parsing",
            "url": "https://errors.pydantic.dev/2.6/v/int_parsing"
        }
    ]
}
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1137.1">
     Notice we
    </span>
    <a id="_idIndexMarker1272">
    </a>
    <span class="koboSpan" id="kobo.1138.1">
     had to abridge the error message due to its length.
    </span>
    <span class="koboSpan" id="kobo.1138.2">
     FastAPI responds with useful information:
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1139.1">
      station_id
     </span>
    </code>
    <span class="koboSpan" id="kobo.1140.1">
     , from the path, is not a valid integer.
    </span>
    <span class="koboSpan" id="kobo.1140.2">
     Notice also that the status code is
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1141.1">
      422 Unprocessable Entity
     </span>
    </em>
    <span class="koboSpan" id="kobo.1142.1">
     , as opposed to
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1143.1">
      200 OK
     </span>
    </em>
    <span class="koboSpan" id="kobo.1144.1">
     , this time.
    </span>
    <span class="koboSpan" id="kobo.1144.2">
     In general, errors in the four hundreds (
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1145.1">
      4xx
     </span>
    </em>
    <span class="koboSpan" id="kobo.1146.1">
     ) express client errors, while errors in the five hundreds (
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1147.1">
      5xx
     </span>
    </em>
    <span class="koboSpan" id="kobo.1148.1">
     ) express server errors.
    </span>
    <span class="koboSpan" id="kobo.1148.2">
     In this case, we are making a call using an incorrect URL (we are not using an integer).
    </span>
    <span class="koboSpan" id="kobo.1148.3">
     Therefore, it is an error on the client side.
    </span>
    <span class="koboSpan" id="kobo.1148.4">
     Other API frameworks would return a simple
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1149.1">
      400 Bad Request
     </span>
    </em>
    <span class="koboSpan" id="kobo.1150.1">
     status code in the same scenario, but FastAPI returns
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1151.1">
      422 Unprocessable Entity
     </span>
    </em>
    <span class="koboSpan" id="kobo.1152.1">
     , which is oddly specific.
    </span>
    <span class="koboSpan" id="kobo.1152.2">
     It is easy though, in FastAPI, to customize which status would be returned upon a bad request; there are examples in the official documentation.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1153.1">
     Let us see what happens when we try to fetch a station with an ID that does not exist:
    </span>
   </p>
   <pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1154.1">$ http http://localhost:8000/stations/100
HTTP/1.1 404 Not Found
...
</span><span class="koboSpan" id="kobo.1154.2">{
    "detail": "Station 100 not found."
</span><span class="koboSpan" id="kobo.1154.3">}
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1155.1">
     This time the URL is correct, in that
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1156.1">
      station_id
     </span>
    </code>
    <span class="koboSpan" id="kobo.1157.1">
     is an integer; however, there is no station with ID 100.
    </span>
    <span class="koboSpan" id="kobo.1157.2">
     The API returns the
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1158.1">
      404 Not Found
     </span>
    </em>
    <span class="koboSpan" id="kobo.1159.1">
     status, as the response body tells us.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1160.1">
     If you go back to the code of this endpoint, you will notice how straightforward its logic is: provided that the arguments passed are correct—in other words, they respect the type—it tries to fetch the corresponding station from the database by using another simple function from the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1161.1">
      crud
     </span>
    </code>
    <span class="koboSpan" id="kobo.1162.1">
     module.
    </span>
    <span class="koboSpan" id="kobo.1162.2">
     If the station is not found, it raises an
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1163.1">
      HTTPException
     </span>
    </code>
    <span class="koboSpan" id="kobo.1164.1">
     with the desired status code (404) and a detail that will hopefully help the consumer understand what went wrong.
    </span>
    <span class="koboSpan" id="kobo.1164.2">
     If the station is found, then it is returned.
    </span>
    <span class="koboSpan" id="kobo.1164.3">
     The process of returning a JSON serialized version of objects is done automatically by FastAPI.
    </span>
    <span class="koboSpan" id="kobo.1164.4">
     The object retrieved from the
    </span>
    <a id="_idIndexMarker1273">
    </a>
    <span class="koboSpan" id="kobo.1165.1">
     database is a SQLAlchemy instance of the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1166.1">
      Station
     </span>
    </code>
    <span class="koboSpan" id="kobo.1167.1">
     class (
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1168.1">
      models.Station
     </span>
    </code>
    <span class="koboSpan" id="kobo.1169.1">
     ).
    </span>
    <span class="koboSpan" id="kobo.1169.2">
     That instance is fed to the Pydantic
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1170.1">
      Station
     </span>
    </code>
    <span class="koboSpan" id="kobo.1171.1">
     class (
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1172.1">
      schemas.Station
     </span>
    </code>
    <span class="koboSpan" id="kobo.1173.1">
     ), which is used to produce a JSON representation that is then returned by the endpoint.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1174.1">
     This might seem complicated, but it is an excellent example of decoupling.
    </span>
    <span class="koboSpan" id="kobo.1174.2">
     FastAPI takes care of the workflow, and all we need to do is take care of the wiring: request parameters, response models, dependencies, and so on.
    </span>
   </p>
   <h3 class="heading-3" id="_idParaDest-364">
    <span class="koboSpan" id="kobo.1175.1">
     Creating data
    </span>
   </h3>
   <p class="normal">
    <span class="koboSpan" id="kobo.1176.1">
     Let us
    </span>
    <a id="_idIndexMarker1274">
    </a>
    <span class="koboSpan" id="kobo.1177.1">
     now see something a bit more interesting: how to create a station.
    </span>
    <span class="koboSpan" id="kobo.1177.2">
     First, the endpoint:
    </span>
   </p>
   <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1178.1"># api_code/api/stations.py</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.1179.1">@router.post(</span></span>
<span class="hljs-params">    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1180.1">""</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1181.1">,</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.1182.1">    status_code=status.HTTP_201_CREATED,</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.1183.1">    tags=[</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1184.1">"Stations"</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1185.1">],</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.1186.1">)</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1187.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1188.1">create_station</span></span><span class="koboSpan" id="kobo.1189.1">(
</span><span class="hljs-params"><span class="koboSpan" id="kobo.1190.1">    station: StationCreate, db: Session = Depends(get_db)</span></span><span class="koboSpan" id="kobo.1191.1">
) -&gt; Station:
    db_station = crud.get_station_by_code(
        db=db, code=station.code
    )
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1192.1">if</span></span><span class="koboSpan" id="kobo.1193.1"> db_station:
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1194.1">raise</span></span><span class="koboSpan" id="kobo.1195.1"> HTTPException(
            status_code=</span><span class="hljs-number"><span class="koboSpan" id="kobo.1196.1">400</span></span><span class="koboSpan" id="kobo.1197.1">,
            detail=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1198.1">f"Station </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1199.1">{station.code}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1200.1"> already exists."</span></span><span class="koboSpan" id="kobo.1201.1">,
        )
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1202.1">return</span></span><span class="koboSpan" id="kobo.1203.1"> crud.create_station(db=db, station=station)
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1204.1">
     This time, we instruct the router that we want to accept a POST request to the root URL (remember: base part, plus router prefix).
    </span>
    <span class="koboSpan" id="kobo.1204.2">
     We type-annotate the return to be
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1205.1">
      Station
     </span>
    </code>
    <span class="koboSpan" id="kobo.1206.1">
     , as the endpoint will be returning the newly created object, and we also specify the default status code for the response, which is
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1207.1">
      201 Created
     </span>
    </code>
    <span class="koboSpan" id="kobo.1208.1">
     .
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1209.1">
     The
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1210.1">
      create_station()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1211.1">
     function
    </span>
    <a id="_idIndexMarker1275">
    </a>
    <span class="koboSpan" id="kobo.1212.1">
     takes the usual
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1213.1">
      db
     </span>
    </code>
    <span class="koboSpan" id="kobo.1214.1">
     session and a
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1215.1">
      station
     </span>
    </code>
    <span class="koboSpan" id="kobo.1216.1">
     object.
    </span>
    <span class="koboSpan" id="kobo.1216.2">
     The
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1217.1">
      station
     </span>
    </code>
    <span class="koboSpan" id="kobo.1218.1">
     object is created for us, behind the scenes.
    </span>
    <span class="koboSpan" id="kobo.1218.2">
     FastAPI takes the data from the body of the request and feeds it to the Pydantic schema
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1219.1">
      StationCreate
     </span>
    </code>
    <span class="koboSpan" id="kobo.1220.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1220.2">
     That schema defines all the data we need to receive, and the result is the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1221.1">
      station
     </span>
    </code>
    <span class="koboSpan" id="kobo.1222.1">
     object.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1223.1">
     The logic in the body follows this flow: it tries to get a station using the code provided; if a station is found, we cannot create one with that data.
    </span>
    <span class="koboSpan" id="kobo.1223.2">
     The code field is defined to be unique.
    </span>
    <span class="koboSpan" id="kobo.1223.3">
     Therefore, creating a station with the same code would result in a database error.
    </span>
    <span class="koboSpan" id="kobo.1223.4">
     Hence, we return status code
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1224.1">
      400 Bad Request
     </span>
    </em>
    <span class="koboSpan" id="kobo.1225.1">
     , informing the caller that the station already exists.
    </span>
    <span class="koboSpan" id="kobo.1225.2">
     If the station is not found, we can instead proceed to create it and return it.
    </span>
    <span class="koboSpan" id="kobo.1225.3">
     Let us see the declaration of the Pydantic schemas involved:
    </span>
   </p>
   <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1226.1"># api_code/api/schemas.py</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1227.1">from</span></span><span class="koboSpan" id="kobo.1228.1"> pydantic </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1229.1">import</span></span><span class="koboSpan" id="kobo.1230.1"> BaseModel, ConfigDict
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1231.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1232.1">StationBase</span></span><span class="koboSpan" id="kobo.1233.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1234.1">BaseModel</span></span><span class="koboSpan" id="kobo.1235.1">):
    code: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1236.1">str</span></span><span class="koboSpan" id="kobo.1237.1">
    country: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1238.1">str</span></span><span class="koboSpan" id="kobo.1239.1">
    city: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1240.1">str</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1241.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1242.1">Station</span></span><span class="koboSpan" id="kobo.1243.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1244.1">StationBase</span></span><span class="koboSpan" id="kobo.1245.1">):
    model_config = ConfigDict(from_attributes=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.1246.1">True</span></span><span class="koboSpan" id="kobo.1247.1">)
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1248.1">id</span></span><span class="koboSpan" id="kobo.1249.1">: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1250.1">int</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1251.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1252.1">StationCreate</span></span><span class="koboSpan" id="kobo.1253.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1254.1">StationBase</span></span><span class="koboSpan" id="kobo.1255.1">):
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1256.1">pass</span></span>
</code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1257.1">
     Note how we used inheritance to define the schemas.
    </span>
    <span class="koboSpan" id="kobo.1257.2">
     It is normal practice to have a base schema that provides functionalities common to all children.
    </span>
    <span class="koboSpan" id="kobo.1257.3">
     Then, each child specifies its needs separately.
    </span>
    <span class="koboSpan" id="kobo.1257.4">
     In this case, in the base schema, we have
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1258.1">
      code
     </span>
    </code>
    <span class="koboSpan" id="kobo.1259.1">
     ,
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1260.1">
      country
     </span>
    </code>
    <span class="koboSpan" id="kobo.1261.1">
     , and
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1262.1">
      city
     </span>
    </code>
    <span class="koboSpan" id="kobo.1263.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1263.2">
     When fetching stations, we also want to return the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1264.1">
      id
     </span>
    </code>
    <span class="koboSpan" id="kobo.1265.1">
     , so we specify that in the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1266.1">
      Station
     </span>
    </code>
    <span class="koboSpan" id="kobo.1267.1">
     class.
    </span>
    <span class="koboSpan" id="kobo.1267.2">
     Moreover, since this class is used to translate SQLAlchemy objects, we need to tell the model about it, and we do so by specifying the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1268.1">
      model_config
     </span>
    </code>
    <span class="koboSpan" id="kobo.1269.1">
     attribute.
    </span>
    <span class="koboSpan" id="kobo.1269.2">
     Remember that SQLAlchemy is an
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.1270.1">
      object-relational mapping
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1271.1">
     (
    </span>
    <strong class="keyWord">
     <span class="koboSpan" id="kobo.1272.1">
      ORM
     </span>
    </strong>
    <span class="koboSpan" id="kobo.1273.1">
     ), so we
    </span>
    <a id="_idIndexMarker1276">
    </a>
    <span class="koboSpan" id="kobo.1274.1">
     need to tell the model to read the attributes of an object by setting
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1275.1">
      from_attributes=True
     </span>
    </code>
    <span class="koboSpan" id="kobo.1276.1">
     .
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1277.1">
     The
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1278.1">
      StationCreate
     </span>
    </code>
    <span class="koboSpan" id="kobo.1279.1">
     model
    </span>
    <a id="_idIndexMarker1277">
    </a>
    <span class="koboSpan" id="kobo.1280.1">
     does not need anything extra, so we simply use the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1281.1">
      pass
     </span>
    </code>
    <span class="koboSpan" id="kobo.1282.1">
     instruction as a body.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1283.1">
     Let us now see the CRUD functions for this endpoint:
    </span>
   </p>
   <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1284.1"># api_code/api/crud.py</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1285.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1286.1">get_station_by_code</span></span><span class="koboSpan" id="kobo.1287.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1288.1">db: Session, code: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1289.1">str</span></span><span class="koboSpan" id="kobo.1290.1">):
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1291.1">return</span></span><span class="koboSpan" id="kobo.1292.1"> db.scalar(
        select(models.Station).where(
            models.Station.code.ilike(code)
        )
    )
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1293.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1294.1">create_station</span></span><span class="koboSpan" id="kobo.1295.1">(
</span><span class="hljs-params"><span class="koboSpan" id="kobo.1296.1">    db: Session,</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.1297.1">    station: schemas.StationCreate,</span></span><span class="koboSpan" id="kobo.1298.1">
):
    db_station = models.Station(**station.model_dump())
    db.add(db_station)
    db.commit()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1299.1">return</span></span><span class="koboSpan" id="kobo.1300.1"> db_station
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1301.1">
     The
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1302.1">
      get_station_by_code()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1303.1">
     function is fairly simple.
    </span>
    <span class="koboSpan" id="kobo.1303.2">
     It selects a
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1304.1">
      Station
     </span>
    </code>
    <span class="koboSpan" id="kobo.1305.1">
     object with a case-insensitive match on
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1306.1">
      code
     </span>
    </code>
    <span class="koboSpan" id="kobo.1307.1">
     (the “i” prefix in
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1308.1">
      ilike()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1309.1">
     means case-insensitive).
    </span>
   </p>
   <div class="packt_tip">
    <p class="normal">
     <span class="koboSpan" id="kobo.1310.1">
      There are other ways to perform a case-insensitive comparison, which do not involve using
     </span>
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.1311.1">
       ilike
      </span>
     </code>
     <span class="koboSpan" id="kobo.1312.1">
      .
     </span>
     <span class="koboSpan" id="kobo.1312.2">
      Those might be the right way to go when performance is important, but for this chapter’s purpose, we found the simplicity of
     </span>
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.1313.1">
       ilike
      </span>
     </code>
     <span class="koboSpan" id="kobo.1314.1">
      to be exactly what we needed.
     </span>
    </p>
   </div>
   <p class="normal">
    <span class="koboSpan" id="kobo.1315.1">
     The
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1316.1">
      create_station()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1317.1">
     function takes a
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1318.1">
      db
     </span>
    </code>
    <span class="koboSpan" id="kobo.1319.1">
     session and a
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1320.1">
      StationCreate
     </span>
    </code>
    <span class="koboSpan" id="kobo.1321.1">
     instance.
    </span>
    <span class="koboSpan" id="kobo.1321.2">
     First, we get the station data in the form of a Python dictionary (by calling
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1322.1">
      model_dump()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1323.1">
     ).
    </span>
    <span class="koboSpan" id="kobo.1323.2">
     We know all data must be there; otherwise, the endpoint would have already failed during the initial Pydantic validation stage.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1324.1">
     Using the
    </span>
    <a id="_idIndexMarker1278">
    </a>
    <span class="koboSpan" id="kobo.1325.1">
     data from
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1326.1">
      station.model_dump()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1327.1">
     , we create an instance of the SQLAlchemy
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1328.1">
      Station
     </span>
    </code>
    <span class="koboSpan" id="kobo.1329.1">
     model.
    </span>
    <span class="koboSpan" id="kobo.1329.2">
     We add it to the database, commit the transaction, and return it.
    </span>
    <span class="koboSpan" id="kobo.1329.3">
     Note that when we initially create the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1330.1">
      db_station
     </span>
    </code>
    <span class="koboSpan" id="kobo.1331.1">
     object, it does not have an
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1332.1">
      id
     </span>
    </code>
    <span class="koboSpan" id="kobo.1333.1">
     attribute.
    </span>
    <span class="koboSpan" id="kobo.1333.2">
     The
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1334.1">
      id
     </span>
    </code>
    <span class="koboSpan" id="kobo.1335.1">
     is automatically assigned by the database engine when the row is inserted into the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1336.1">
      stations
     </span>
    </code>
    <span class="koboSpan" id="kobo.1337.1">
     table (which happens when we call
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1338.1">
      db.commit()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1339.1">
     ).
    </span>
    <span class="koboSpan" id="kobo.1339.2">
     SQLAlchemy will automatically set the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1340.1">
      id
     </span>
    </code>
    <span class="koboSpan" id="kobo.1341.1">
     attribute when we call
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1342.1">
      commit()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1343.1">
     .
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1344.1">
     Let us see this endpoint in action.
    </span>
    <span class="koboSpan" id="kobo.1344.2">
     Notice how we need to specify
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1345.1">
      POST
     </span>
    </code>
    <span class="koboSpan" id="kobo.1346.1">
     to the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1347.1">
      http
     </span>
    </code>
    <span class="koboSpan" id="kobo.1348.1">
     command, which allows us to send data, in JSON format, within the body of the request.
    </span>
    <span class="koboSpan" id="kobo.1348.2">
     Previous requests were of the GET type, which is the default type for the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1349.1">
      http
     </span>
    </code>
    <span class="koboSpan" id="kobo.1350.1">
     command.
    </span>
    <span class="koboSpan" id="kobo.1350.2">
     Notice also that we have split the command over two lines due to the book’s line length constraints:
    </span>
   </p>
   <pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1351.1">$ http POST http://localhost:8000/stations \
code=TMP country=Temporary-Country city=tmp-city
HTTP/1.1 201 Created
...
</span><span class="koboSpan" id="kobo.1351.2">{
    "city": "tmp-city",
    "code": "TMP",
    "country": "Temporary-Country",
    "id": 12
}
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1352.1">
     We successfully created a station.
    </span>
    <span class="koboSpan" id="kobo.1352.2">
     Let us now try again, but this time omitting the code, which is mandatory:
    </span>
   </p>
   <pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1353.1">$ http POST http://localhost:8000/stations \
country=Another-Country city=another-city
HTTP/1.1 422 Unprocessable Entity
...
</span><span class="koboSpan" id="kobo.1353.2">{
    "detail": [
        {
            "input": {
                "city": "another-city",
                "country": "Another-Country"
            },
            "loc": [
                "body",
                "code"
            ],
            "msg": "Field required",
            "type": "missing",
            "url": "https://errors.pydantic.dev/2.6/v/missing"
        }
    ]
}
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1354.1">
     As expected, we
    </span>
    <a id="_idIndexMarker1279">
    </a>
    <span class="koboSpan" id="kobo.1355.1">
     get a
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1356.1">
      422 Unprocessable Entity
     </span>
    </em>
    <span class="koboSpan" id="kobo.1357.1">
     status code again, because the Pydantic
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1358.1">
      StationCreate
     </span>
    </code>
    <span class="koboSpan" id="kobo.1359.1">
     model validation failed, and the response body tells us why:
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1360.1">
      code
     </span>
    </code>
    <span class="koboSpan" id="kobo.1361.1">
     is missing in the body of the request.
    </span>
    <span class="koboSpan" id="kobo.1361.2">
     It also provides a useful link to look up the error.
    </span>
   </p>
   <h3 class="heading-3" id="_idParaDest-365">
    <span class="koboSpan" id="kobo.1362.1">
     Updating data
    </span>
   </h3>
   <p class="normal">
    <span class="koboSpan" id="kobo.1363.1">
     The logic
    </span>
    <a id="_idIndexMarker1280">
    </a>
    <span class="koboSpan" id="kobo.1364.1">
     to update a station is a bit more complex.
    </span>
    <span class="koboSpan" id="kobo.1364.2">
     Let us go through it together.
    </span>
    <span class="koboSpan" id="kobo.1364.3">
     First, the endpoint:
    </span>
   </p>
   <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1365.1"># api_code/api/stations.py</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.1366.1">@router.put(</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1367.1">"/{station_id}"</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1368.1">, tags=[</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1369.1">"Stations"</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1370.1">]</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.1371.1">)</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1372.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1373.1">update_station</span></span><span class="koboSpan" id="kobo.1374.1">(
</span><span class="hljs-params"><span class="koboSpan" id="kobo.1375.1">    station_id: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1376.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1377.1">,</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.1378.1">    station: StationUpdate,</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.1379.1">    db: Session = Depends(get_db),</span></span><span class="koboSpan" id="kobo.1380.1">
):
    db_station = crud.get_station(db=db, station_id=station_id)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1381.1">if</span></span><span class="koboSpan" id="kobo.1382.1"> db_station </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1383.1">is</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.1384.1">None</span></span><span class="koboSpan" id="kobo.1385.1">:
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1386.1">raise</span></span><span class="koboSpan" id="kobo.1387.1"> HTTPException(
            status_code=</span><span class="hljs-number"><span class="koboSpan" id="kobo.1388.1">404</span></span><span class="koboSpan" id="kobo.1389.1">,
            detail=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1390.1">f"Station </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1391.1">{station_id}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1392.1"> not found."</span></span><span class="koboSpan" id="kobo.1393.1">,
        )
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1394.1">else</span></span><span class="koboSpan" id="kobo.1395.1">:
        crud.update_station(
            db=db, station=station, station_id=station_id
        )
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1396.1">return</span></span><span class="koboSpan" id="kobo.1397.1"> Response(status_code=status.HTTP_204_NO_CONTENT)
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1398.1">
     The
    </span>
    <a id="_idIndexMarker1281">
    </a>
    <span class="koboSpan" id="kobo.1399.1">
     router is instructed to listen for a PUT request, which is the type you should use to modify a web resource.
    </span>
    <span class="koboSpan" id="kobo.1399.2">
     The URL terminates with the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1400.1">
      station_id
     </span>
    </code>
    <span class="koboSpan" id="kobo.1401.1">
     , which identifies the station we want to update.
    </span>
    <span class="koboSpan" id="kobo.1401.2">
     The function takes the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1402.1">
      station_id
     </span>
    </code>
    <span class="koboSpan" id="kobo.1403.1">
     , a Pydantic
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1404.1">
      StationUpdate
     </span>
    </code>
    <span class="koboSpan" id="kobo.1405.1">
     instance, and the usual
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1406.1">
      db
     </span>
    </code>
    <span class="koboSpan" id="kobo.1407.1">
     session.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1408.1">
     We start by fetching the desired station from the database.
    </span>
    <span class="koboSpan" id="kobo.1408.2">
     If the station is not found in the database, we simply return a
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1409.1">
      404 Not Found
     </span>
    </em>
    <span class="koboSpan" id="kobo.1410.1">
     status code, as there is nothing to update.
    </span>
    <span class="koboSpan" id="kobo.1410.2">
     Otherwise, we update the station and return a
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1411.1">
      204 No Content
     </span>
    </em>
    <span class="koboSpan" id="kobo.1412.1">
     status code, which is the common way to respond to a PUT request.
    </span>
    <span class="koboSpan" id="kobo.1412.2">
     We could also have returned
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1413.1">
      200 OK
     </span>
    </em>
    <span class="koboSpan" id="kobo.1414.1">
     , but in that case, we should have returned the updated resource within the body of the response.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1415.1">
     The Pydantic model for a station update is this:
    </span>
   </p>
   <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1416.1"># api_code/api/schemas.py</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1417.1">from</span></span><span class="koboSpan" id="kobo.1418.1"> typing </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1419.1">import</span></span> <span class="hljs-type"><span class="koboSpan" id="kobo.1420.1">Optional</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1421.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1422.1">StationUpdate</span></span><span class="koboSpan" id="kobo.1423.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1424.1">StationBase</span></span><span class="koboSpan" id="kobo.1425.1">):
    code: </span><span class="hljs-type"><span class="koboSpan" id="kobo.1426.1">Optional</span></span><span class="koboSpan" id="kobo.1427.1">[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1428.1">str</span></span><span class="koboSpan" id="kobo.1429.1">] = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1430.1">None</span></span><span class="koboSpan" id="kobo.1431.1">
    country: </span><span class="hljs-type"><span class="koboSpan" id="kobo.1432.1">Optional</span></span><span class="koboSpan" id="kobo.1433.1">[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1434.1">str</span></span><span class="koboSpan" id="kobo.1435.1">] = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1436.1">None</span></span><span class="koboSpan" id="kobo.1437.1">
    city: </span><span class="hljs-type"><span class="koboSpan" id="kobo.1438.1">Optional</span></span><span class="koboSpan" id="kobo.1439.1">[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1440.1">str</span></span><span class="koboSpan" id="kobo.1441.1">] = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1442.1">None</span></span>
</code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1443.1">
     All properties are declared as
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1444.1">
      Optional
     </span>
    </code>
    <span class="koboSpan" id="kobo.1445.1">
     because we want to allow the caller to pass only what they wish to update.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1446.1">
     Let us see the code for the CRUD function responsible for updating a station:
    </span>
   </p>
   <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1447.1"># api_code/api/crud.py</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1448.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1449.1">update_station</span></span><span class="koboSpan" id="kobo.1450.1">(
</span><span class="hljs-params"><span class="koboSpan" id="kobo.1451.1">    db: Session, station: schemas.StationUpdate, station_id: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1452.1">int</span></span><span class="koboSpan" id="kobo.1453.1">
):
    stm = (
        update(models.Station)
        .where(models.Station.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1454.1">id</span></span><span class="koboSpan" id="kobo.1455.1"> == station_id)
        .values(station.model_dump(exclude_unset=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.1456.1">True</span></span><span class="koboSpan" id="kobo.1457.1">))
    )
    result = db.execute(stm)
    db.commit()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1458.1">return</span></span><span class="koboSpan" id="kobo.1459.1"> result.rowcount
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1460.1">
     The
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1461.1">
      update_station()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1462.1">
     function
    </span>
    <a id="_idIndexMarker1282">
    </a>
    <span class="koboSpan" id="kobo.1463.1">
     takes the necessary arguments to identify the station to update, and the station data that will be used to update the record in the database, plus the usual
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1464.1">
      db
     </span>
    </code>
    <span class="koboSpan" id="kobo.1465.1">
     session.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1466.1">
     We build a statement using the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1467.1">
      update()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1468.1">
     helper from
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1469.1">
      sqlalchemy
     </span>
    </code>
    <span class="koboSpan" id="kobo.1470.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1470.2">
     We use
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1471.1">
      where()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1472.1">
     to filter the station by
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1473.1">
      id
     </span>
    </code>
    <span class="koboSpan" id="kobo.1474.1">
     , and we specify the new values by asking the Pydantic station object to give us a Python dictionary excluding anything that has not been passed to the call.
    </span>
    <span class="koboSpan" id="kobo.1474.2">
     This serves the purpose of allowing partial updates to be executed.
    </span>
    <span class="koboSpan" id="kobo.1474.3">
     If we omitted
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1475.1">
      exclude_unset=True
     </span>
    </code>
    <span class="koboSpan" id="kobo.1476.1">
     from the code, any argument that was not passed would end up in the dictionary, set to its default value (
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1477.1">
      None
     </span>
    </code>
    <span class="koboSpan" id="kobo.1478.1">
     ).
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1479.1">
     Strictly speaking, we should use a PATCH request to do a partial update, but it is fairly common to use PUT for both complete and partial updates.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1480.1">
     We execute the statement and return the number of rows affected by this operation.
    </span>
    <span class="koboSpan" id="kobo.1480.2">
     We do not use this information in the endpoint body, but it would be a nice exercise for you to do it.
    </span>
    <span class="koboSpan" id="kobo.1480.3">
     We will see how to make use of that information in the endpoint that deletes a station.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1481.1">
     Let us use this endpoint on the station we created in the previous section, with ID
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1482.1">
      12
     </span>
    </code>
    <span class="koboSpan" id="kobo.1483.1">
     :
    </span>
   </p>
   <pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1484.1">$ http PUT http://localhost:8000/stations/12 \
code=SMC country=Some-Country city=Some-city
HTTP/1.1 204 No Content
...
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1485.1">
     We got what we expected.
    </span>
    <span class="koboSpan" id="kobo.1485.2">
     Let us verify that the update was successful:
    </span>
   </p>
   <pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1486.1">$ http http://localhost:8000/stations/12
HTTP/1.1 200 OK
...
</span><span class="koboSpan" id="kobo.1486.2">{
    "city": "Some-city",
    "code": "SMC",
    "country": "Some-Country",
    "id": 12
}
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1487.1">
     All three properties of the object with ID
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1488.1">
      12
     </span>
    </code>
    <span class="koboSpan" id="kobo.1489.1">
     have been changed.
    </span>
    <span class="koboSpan" id="kobo.1489.2">
     Let us now try a partial update:
    </span>
   </p>
   <pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1490.1">$ http PUT http://localhost:8000/stations/12 code=xxx
HTTP/1.1 204 No Content
...
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1491.1">
     This time we
    </span>
    <a id="_idIndexMarker1283">
    </a>
    <span class="koboSpan" id="kobo.1492.1">
     only updated the station code.
    </span>
    <span class="koboSpan" id="kobo.1492.2">
     Let us verify again:
    </span>
   </p>
   <pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1493.1">$ http http://localhost:8000/stations/12
HTTP/1.1 200 OK
...
</span><span class="koboSpan" id="kobo.1493.2">{
    "city": "Some-city",
    "code": "xxx",
    "country": "Some-Country",
    "id": 12
}
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1494.1">
     As expected, only
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1495.1">
      code
     </span>
    </code>
    <span class="koboSpan" id="kobo.1496.1">
     was changed.
    </span>
   </p>
   <h3 class="heading-3" id="_idParaDest-366">
    <span class="koboSpan" id="kobo.1497.1">
     Deleting data
    </span>
   </h3>
   <p class="normal">
    <span class="koboSpan" id="kobo.1498.1">
     Finally, let us
    </span>
    <a id="_idIndexMarker1284">
    </a>
    <span class="koboSpan" id="kobo.1499.1">
     explore how to delete a station.
    </span>
    <span class="koboSpan" id="kobo.1499.2">
     As usual, let us start with the endpoint:
    </span>
   </p>
   <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1500.1"># api_code/api/stations.py</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.1501.1">@router.delete(</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1502.1">"/{station_id}"</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1503.1">, tags=[</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1504.1">"Stations"</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1505.1">]</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.1506.1">)</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1507.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1508.1">delete_station</span></span><span class="koboSpan" id="kobo.1509.1">(
</span><span class="hljs-params"><span class="koboSpan" id="kobo.1510.1">    station_id: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1511.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1512.1">, db: Session = Depends(get_db)</span></span><span class="koboSpan" id="kobo.1513.1">
):
    row_count = crud.delete_station(db=db, station_id=station_id)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1514.1">if</span></span><span class="koboSpan" id="kobo.1515.1"> row_count:
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1516.1">return</span></span><span class="koboSpan" id="kobo.1517.1"> Response(status_code=status.HTTP_204_NO_CONTENT)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1518.1">return</span></span><span class="koboSpan" id="kobo.1519.1"> Response(status_code=status.HTTP_404_NOT_FOUND)
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1520.1">
     To delete stations, we instruct the router to listen for a DELETE request.
    </span>
    <span class="koboSpan" id="kobo.1520.2">
     The URL is the same one we used to get a single station, as well as to update one.
    </span>
    <span class="koboSpan" id="kobo.1520.3">
     It is the HTTP verb we choose that triggers the right endpoint.
    </span>
    <span class="koboSpan" id="kobo.1520.4">
     The
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1521.1">
      delete_station()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1522.1">
     function takes
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1523.1">
      station_id
     </span>
    </code>
    <span class="koboSpan" id="kobo.1524.1">
     and the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1525.1">
      db
     </span>
    </code>
    <span class="koboSpan" id="kobo.1526.1">
     session.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1527.1">
     Inside the body of
    </span>
    <a id="_idIndexMarker1285">
    </a>
    <span class="koboSpan" id="kobo.1528.1">
     the endpoint, we get the number of rows affected by the operation.
    </span>
    <span class="koboSpan" id="kobo.1528.2">
     In this case, if there is one, we return a
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1529.1">
      204 No Content
     </span>
    </em>
    <span class="koboSpan" id="kobo.1530.1">
     status code, which tells the caller that the deletion was successful.
    </span>
    <span class="koboSpan" id="kobo.1530.2">
     If no rows were affected, we return a
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1531.1">
      404 Not Found
     </span>
    </em>
    <span class="koboSpan" id="kobo.1532.1">
     status code.
    </span>
    <span class="koboSpan" id="kobo.1532.2">
     Notice that we could have written the update method exactly like this, making use of the number of affected rows, but we chose another approach there so that you had a different example to learn from.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1533.1">
     Let us see the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1534.1">
      CRUD
     </span>
    </code>
    <span class="koboSpan" id="kobo.1535.1">
     function:
    </span>
   </p>
   <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1536.1"># api_code/api/crud.py</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1537.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1538.1">delete_station</span></span><span class="koboSpan" id="kobo.1539.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1540.1">db: Session, station_id: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1541.1">int</span></span><span class="koboSpan" id="kobo.1542.1">):
    stm = delete(models.Station).where(
        models.Station.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1543.1">id</span></span><span class="koboSpan" id="kobo.1544.1"> == station_id
    )
    result = db.execute(stm)
    db.commit()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1545.1">return</span></span><span class="koboSpan" id="kobo.1546.1"> result.rowcount
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1547.1">
     This function makes use of the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1548.1">
      delete()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1549.1">
     helper from
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1550.1">
      sqlalchemy
     </span>
    </code>
    <span class="koboSpan" id="kobo.1551.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1551.2">
     Similar to what we did for the update scenario, we create a statement that identifies a station by ID and instructs for its deletion.
    </span>
    <span class="koboSpan" id="kobo.1551.3">
     We execute the statement and return the number of affected rows.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1552.1">
     Let us see this endpoint in action, on a successful scenario first:
    </span>
   </p>
   <pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1553.1">$ http DELETE http://localhost:8000/stations/12
HTTP/1.1 204 No Content
...
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1554.1">
     We got a
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1555.1">
      204 No Content
     </span>
    </em>
    <span class="koboSpan" id="kobo.1556.1">
     status code, which tells us the deletion was successful.
    </span>
    <span class="koboSpan" id="kobo.1556.2">
     Let us verify it indirectly by trying to delete the station with ID
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1557.1">
      12
     </span>
    </code>
    <span class="koboSpan" id="kobo.1558.1">
     again.
    </span>
    <span class="koboSpan" id="kobo.1558.2">
     This time we expect the station to be gone, and a
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1559.1">
      404 Not Found
     </span>
    </em>
    <span class="koboSpan" id="kobo.1560.1">
     status code in return:
    </span>
   </p>
   <pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1561.1">$ http DELETE http://localhost:8000/stations/12
HTTP/1.1 404 Not Found
...
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1562.1">
     As expected, we
    </span>
    <a id="_idIndexMarker1286">
    </a>
    <span class="koboSpan" id="kobo.1563.1">
     received a
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1564.1">
      404 Not Found
     </span>
    </em>
    <span class="koboSpan" id="kobo.1565.1">
     status code, which means a station with ID 12 was not found, proving that the first attempt to delete it was successful.
    </span>
    <span class="koboSpan" id="kobo.1565.2">
     There are a few more endpoints in the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1566.1">
      stations.py
     </span>
    </code>
    <span class="koboSpan" id="kobo.1567.1">
     module, which you should check out.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1568.1">
     The other endpoints we have written are there to create, read, update, and delete users, trains, and tickets.
    </span>
    <span class="koboSpan" id="kobo.1568.2">
     Apart from the fact that they act on different database and Pydantic models, they would not really bring any more insight to this exposition.
    </span>
    <span class="koboSpan" id="kobo.1568.3">
     Therefore, let us instead look at an example of how to authenticate a user.
    </span>
   </p>
   <h2 class="heading-2" id="_idParaDest-367">
    <span class="koboSpan" id="kobo.1569.1">
     User authentication
    </span>
   </h2>
   <p class="normal">
    <span class="koboSpan" id="kobo.1570.1">
     Authentication, in
    </span>
    <a id="_idIndexMarker1287">
    </a>
    <span class="koboSpan" id="kobo.1571.1">
     this project, is done via a JWT.
    </span>
    <span class="koboSpan" id="kobo.1571.2">
     Once again, please refer to
    </span>
    <em class="chapterRef">
     <span class="koboSpan" id="kobo.1572.1">
      Chapter 9, Cryptography and Tokens
     </span>
    </em>
    <span class="koboSpan" id="kobo.1573.1">
     , for a refresher on JWTs.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1574.1">
     Let us start from the authentication endpoint, in the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1575.1">
      users.py
     </span>
    </code>
    <span class="koboSpan" id="kobo.1576.1">
     module:
    </span>
   </p>
   <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1577.1"># api_code/api/users.py</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1578.1">from</span></span><span class="koboSpan" id="kobo.1579.1"> .util </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1580.1">import</span></span><span class="koboSpan" id="kobo.1581.1"> InvalidToken, create_token, extract_payload
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.1582.1">@router.post(</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1583.1">"/authenticate"</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1584.1">, tags=[</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1585.1">"Auth"</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1586.1">]</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.1587.1">)</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1588.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1589.1">authenticate</span></span><span class="koboSpan" id="kobo.1590.1">(
</span><span class="hljs-params"><span class="koboSpan" id="kobo.1591.1">    auth: Auth,</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.1592.1">    db: Session = Depends(get_db),</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.1593.1">    settings: Settings = Depends(get_settings),</span></span><span class="koboSpan" id="kobo.1594.1">
):
    db_user = crud.get_user_by_email(db=db, email=auth.email)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1595.1">if</span></span><span class="koboSpan" id="kobo.1596.1"> db_user </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1597.1">is</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.1598.1">None</span></span><span class="koboSpan" id="kobo.1599.1">:
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1600.1">raise</span></span><span class="koboSpan" id="kobo.1601.1"> HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1602.1">f"User </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1603.1">{auth.email}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1604.1"> not found."</span></span><span class="koboSpan" id="kobo.1605.1">,
        )
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1606.1">if</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1607.1">not</span></span><span class="koboSpan" id="kobo.1608.1"> db_user.is_valid_password(auth.password):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1609.1">raise</span></span><span class="koboSpan" id="kobo.1610.1"> HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1611.1">"Wrong username/password."</span></span><span class="koboSpan" id="kobo.1612.1">,
        )
    payload = {
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1613.1">"email"</span></span><span class="koboSpan" id="kobo.1614.1">: auth.email,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1615.1">"role"</span></span><span class="koboSpan" id="kobo.1616.1">: db_user.role.value,
    }
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1617.1">return</span></span><span class="koboSpan" id="kobo.1618.1"> create_token(payload, settings.secret_key)
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1619.1">
     This router has the prefix
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1620.1">
      "
     </span>
    </code>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1621.1">
      /users"
     </span>
    </code>
    <span class="koboSpan" id="kobo.1622.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1622.2">
     To authenticate a user, we need to make a POST request to this endpoint.
    </span>
    <span class="koboSpan" id="kobo.1622.3">
     It takes a Pydantic
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1623.1">
      Auth
     </span>
    </code>
    <span class="koboSpan" id="kobo.1624.1">
     schema, the usual
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1625.1">
      db
     </span>
    </code>
    <span class="koboSpan" id="kobo.1626.1">
     session, and the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1627.1">
      settings
     </span>
    </code>
    <span class="koboSpan" id="kobo.1628.1">
     object, which is needed to provide the secret key that is used to create the token.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1629.1">
     If the user is not found, we return a
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1630.1">
      404 Not Found
     </span>
    </em>
    <span class="koboSpan" id="kobo.1631.1">
     status code.
    </span>
    <span class="koboSpan" id="kobo.1631.2">
     If the user is found, but the password provided does not correspond to the one in the database record, we return status code
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1632.1">
      401 Unauthorized
     </span>
    </em>
    <span class="koboSpan" id="kobo.1633.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1633.2">
     Finally, if the user is found and the password is correct, we create a token with two claims:
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1634.1">
      email
     </span>
    </code>
    <span class="koboSpan" id="kobo.1635.1">
     and
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1636.1">
      role
     </span>
    </code>
    <span class="koboSpan" id="kobo.1637.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1637.2">
     We will use the role to perform authorization functions.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1638.1">
     The
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1639.1">
      create_token()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1640.1">
     function is a
    </span>
    <a id="_idIndexMarker1288">
    </a>
    <span class="koboSpan" id="kobo.1641.1">
     wrapper around
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1642.1">
      jwt.encode()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1643.1">
     that also adds a couple of timestamps to the payload of the token.
    </span>
    <span class="koboSpan" id="kobo.1643.2">
     It is not worth showing that code here.
    </span>
    <span class="koboSpan" id="kobo.1643.3">
     Let us instead see the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1644.1">
      Auth
     </span>
    </code>
    <span class="koboSpan" id="kobo.1645.1">
     model:
    </span>
   </p>
   <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1646.1"># api_code/api/schemas.py</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1647.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1648.1">Auth</span></span><span class="koboSpan" id="kobo.1649.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1650.1">BaseModel</span></span><span class="koboSpan" id="kobo.1651.1">):
    email: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1652.1">str</span></span><span class="koboSpan" id="kobo.1653.1">
    password: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1654.1">str</span></span>
</code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1655.1">
     We authenticate users with their email (which serves as the username) and password.
    </span>
    <span class="koboSpan" id="kobo.1655.2">
     That is why, in the SQLAlchemy
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1656.1">
      User
     </span>
    </code>
    <span class="koboSpan" id="kobo.1657.1">
     model, we have set up a uniqueness constraint on the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1658.1">
      email
     </span>
    </code>
    <span class="koboSpan" id="kobo.1659.1">
     field.
    </span>
    <span class="koboSpan" id="kobo.1659.2">
     We need each user to have a unique username, and email is a commonly used field for this need.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1660.1">
     Let us exercise this endpoint:
    </span>
   </p>
   <pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1661.1">$ http POST http://localhost:8000/users/authenticate \
email="fabrizio.romano@example.com" password="f4bPassword"
HTTP/1.1 200 OK
...
</span><span class="koboSpan" id="kobo.1661.2">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9....01GK4QyzZje8NKMzBBVckc"
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1662.1">
     We got a
    </span>
    <a id="_idIndexMarker1289">
    </a>
    <span class="koboSpan" id="kobo.1663.1">
     token back (abridged, in the snippet), so we can use it.
    </span>
    <span class="koboSpan" id="kobo.1663.2">
     The user we have authenticated is an admin, so we are going to show you how we could have written the endpoint to delete a station if we wanted to allow only admins to do so.
    </span>
    <span class="koboSpan" id="kobo.1663.3">
     Let us see the code:
    </span>
   </p>
   <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1664.1"># api_code/api/admin.py</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1665.1">from</span></span><span class="koboSpan" id="kobo.1666.1"> .util </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1667.1">import</span></span><span class="koboSpan" id="kobo.1668.1"> is_admin
router = APIRouter(prefix=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1669.1">"/admin"</span></span><span class="koboSpan" id="kobo.1670.1">)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1671.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1672.1">ensure_admin</span></span><span class="koboSpan" id="kobo.1673.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1674.1">settings: Settings, authorization: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1675.1">str</span></span><span class="koboSpan" id="kobo.1676.1">):
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1677.1">if</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1678.1">not</span></span><span class="koboSpan" id="kobo.1679.1"> is_admin(
        settings=settings, authorization=authorization
    ):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1680.1">raise</span></span><span class="koboSpan" id="kobo.1681.1"> HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1682.1">"You must be admin to access this endpoint."</span></span><span class="koboSpan" id="kobo.1683.1">,
        )
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.1684.1">@router.delete(</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1685.1">"/stations/{station_id}"</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1686.1">, tags=[</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1687.1">"Admin"</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1688.1">]</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.1689.1">)</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1690.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1691.1">admin_delete_station</span></span><span class="koboSpan" id="kobo.1692.1">(
</span><span class="hljs-params"><span class="koboSpan" id="kobo.1693.1">    station_id: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1694.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1695.1">,</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.1696.1">    authorization: </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.1697.1">Optional</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1698.1">[</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1699.1">str</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1700.1">] = Header(</span></span><span class="hljs-literal"><span class="koboSpan" id="kobo.1701.1">None</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1702.1">),</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.1703.1">    settings: Settings = Depends(get_settings),</span></span>
<span class="hljs-params"><span class="koboSpan" id="kobo.1704.1">    db: Session = Depends(get_db),</span></span><span class="koboSpan" id="kobo.1705.1">
):
    ensure_admin(settings, authorization)
    row_count = crud.delete_station(db=db, station_id=station_id)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1706.1">if</span></span><span class="koboSpan" id="kobo.1707.1"> row_count:
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1708.1">return</span></span><span class="koboSpan" id="kobo.1709.1"> Response(status_code=status.HTTP_204_NO_CONTENT)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1710.1">return</span></span><span class="koboSpan" id="kobo.1711.1"> Response(status_code=status.HTTP_404_NOT_FOUND)
</span></code></pre>
   <p class="normal">
    <span class="koboSpan" id="kobo.1712.1">
     In this example, you can see that the endpoint declaration and body are nearly the same as their naïve counterpart, with one important difference: before attempting to delete anything, we call
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1713.1">
      ensure_admin()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1714.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1714.2">
     In the endpoint, we need to grab the authorization header from the request, which is responsible for bearing the token information, so that we can pass it to the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1715.1">
      ensure_admin()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1716.1">
     function.
    </span>
    <span class="koboSpan" id="kobo.1716.2">
     We
    </span>
    <a id="_idIndexMarker1290">
    </a>
    <span class="koboSpan" id="kobo.1717.1">
     do this by declaring it in the function signature, as an optional string that comes from the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1718.1">
      Header
     </span>
    </code>
    <span class="koboSpan" id="kobo.1719.1">
     object.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1720.1">
     The
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1721.1">
      ensure_admin()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1722.1">
     function delegates to the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1723.1">
      util.is_admin()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1724.1">
     function, which unpacks the token, verifies its validity, and inspects the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1725.1">
      role
     </span>
    </code>
    <span class="koboSpan" id="kobo.1726.1">
     field within the payload to see if it is that of an admin.
    </span>
    <span class="koboSpan" id="kobo.1726.2">
     If all the checks are successful, it returns
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1727.1">
      True
     </span>
    </code>
    <span class="koboSpan" id="kobo.1728.1">
     , or
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1729.1">
      False
     </span>
    </code>
    <span class="koboSpan" id="kobo.1730.1">
     otherwise.
    </span>
    <span class="koboSpan" id="kobo.1730.2">
     The
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1731.1">
      ensure_admin()
     </span>
    </code>
    <span class="koboSpan" id="kobo.1732.1">
     function does nothing when the check is successful but raises an
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1733.1">
      HTTPException
     </span>
    </code>
    <span class="koboSpan" id="kobo.1734.1">
     with a
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1735.1">
      403 Forbidden
     </span>
    </em>
    <span class="koboSpan" id="kobo.1736.1">
     status code when the check is unsuccessful.
    </span>
    <span class="koboSpan" id="kobo.1736.2">
     This means that if, for any reason, the user is not authorized to make this call, the execution of the endpoint’s body will immediately stop and return after its first line.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1737.1">
     There are more sophisticated ways to do authentication and authorization, but it would have been impractical to fit them within the chapter.
    </span>
    <span class="koboSpan" id="kobo.1737.2">
     This simple example is good enough as a start to understand how to implement this feature in an API.
    </span>
   </p>
   <h2 class="heading-2" id="_idParaDest-368">
    <span class="koboSpan" id="kobo.1738.1">
     Documenting the API
    </span>
   </h2>
   <p class="normal">
    <span class="koboSpan" id="kobo.1739.1">
     Documenting APIs is a
    </span>
    <a id="_idIndexMarker1291">
    </a>
    <span class="koboSpan" id="kobo.1740.1">
     tedious activity.
    </span>
    <span class="koboSpan" id="kobo.1740.2">
     One advantage of using FastAPI is that you do not need to document your project: the documentation is automatically generated by the framework.
    </span>
    <span class="koboSpan" id="kobo.1740.3">
     This is possible thanks to the use of type annotations and Pydantic.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1741.1">
     Make sure your API is running, then open a browser and navigate to
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1742.1">
      http://localhost:8000/docs
     </span>
    </code>
    <span class="koboSpan" id="kobo.1743.1">
     .
    </span>
    <span class="koboSpan" id="kobo.1743.2">
     A page will open that should look something like this:
    </span>
   </p>
   <figure class="mediaobject">
    <span class="koboSpan" id="kobo.1744.1">
     <img alt="img" src="../Images/B30992_14_05.png"/>
    </span>
   </figure>
   <p class="packt_figref">
    <span class="koboSpan" id="kobo.1745.1">
     Figure 14.3: A partial screenshot of FastAPI self-generated documentation
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1746.1">
     In
    </span>
    <em class="italic">
     <span class="koboSpan" id="kobo.1747.1">
      Figure 14.3
     </span>
    </em>
    <span class="koboSpan" id="kobo.1748.1">
     , you
    </span>
    <a id="_idIndexMarker1292">
    </a>
    <span class="koboSpan" id="kobo.1749.1">
     can see a list of endpoints.
    </span>
    <span class="koboSpan" id="kobo.1749.2">
     They are categorized using the
    </span>
    <code class="inlineCode">
     <span class="koboSpan" id="kobo.1750.1">
      tags
     </span>
    </code>
    <span class="koboSpan" id="kobo.1751.1">
     argument, which we have specified in each endpoint declaration.
    </span>
    <span class="koboSpan" id="kobo.1751.2">
     This documentation not only allows you to inspect each endpoint in detail but is also interactive, which means you can test the endpoints by making requests directly from the page.
    </span>
   </p>
   <h1 class="heading-1" id="_idParaDest-369">
    <span class="koboSpan" id="kobo.1752.1">
     Where do we go from here?
    </span>
   </h1>
   <p class="normal">
    <span class="koboSpan" id="kobo.1753.1">
     You should now have a basic understanding of API design and main concepts.
    </span>
    <span class="koboSpan" id="kobo.1753.2">
     Of course, studying this chapter’s code will deepen your understanding and likely provoke questions.
    </span>
    <span class="koboSpan" id="kobo.1753.3">
     Here are some suggestions if you wish to learn more on the subject:
    </span>
   </p>
   <ul>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.1754.1">
      Learn FastAPI well.
     </span>
     <span class="koboSpan" id="kobo.1754.2">
      The website offers tutorials both for beginners and advanced programmers.
     </span>
     <span class="koboSpan" id="kobo.1754.3">
      They are quite thorough and cover much more than we could ever include in a single chapter.
     </span>
    </li>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.1755.1">
      Using the source code from this chapter, enhance the API by adding advanced searching and filtering capabilities.
     </span>
     <span class="koboSpan" id="kobo.1755.2">
      Try implementing a more sophisticated authentication system and exploring the use of background tasks, sorting, and pagination.
     </span>
     <span class="koboSpan" id="kobo.1755.3">
      You could also expand the admin section by adding other endpoints only for admin users.
     </span>
    </li>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.1756.1">
      Amend the endpoint that books a ticket so that it checks that there are free seats on the train.
     </span>
     <span class="koboSpan" id="kobo.1756.2">
      Each train specifies how many first- and second-class cars there are, as well as the number of seats per car.
     </span>
     <span class="koboSpan" id="kobo.1756.3">
      We designed the train model this way specifically to allow you to practice with this exercise.
     </span>
    </li>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.1757.1">
      Add tests for the existing endpoints, and for anything else you add to the source code.
     </span>
    </li>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.1758.1">
      Learn about WSGI (
     </span>
     <a href="https://wsgi.readthedocs.io/">
      <span class="url">
       <span class="koboSpan" id="kobo.1759.1">
        https://wsgi.readthedocs.io/
       </span>
      </span>
     </a>
     <span class="koboSpan" id="kobo.1760.1">
      ) and, if you are familiar with asynchronous programming, ASGI, its asynchronous equivalent (
     </span>
     <a href="https://asgi.readthedocs.io/">
      <span class="url">
       <span class="koboSpan" id="kobo.1761.1">
        https://asgi.readthedocs.io/
       </span>
      </span>
     </a>
     <span class="koboSpan" id="kobo.1762.1">
      ).
     </span>
    </li>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.1763.1">
      Learn about middleware in FastAPI, and concepts like
     </span>
     <strong class="keyWord">
      <span class="koboSpan" id="kobo.1764.1">
       Cross-Origin Resource Sharing (CORS
      </span>
     </strong>
     <span class="koboSpan" id="kobo.1765.1">
      ), which are important when we run an API in the real world.
     </span>
    </li>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.1766.1">
      Learn other API frameworks, like Falcon (
     </span>
     <a href="https://falcon.readthedocs.io/">
      <span class="url">
       <span class="koboSpan" id="kobo.1767.1">
        https://falcon.readthedocs.io/
       </span>
      </span>
     </a>
     <span class="koboSpan" id="kobo.1768.1">
      ), or Django Rest Framework (
     </span>
     <a href="https://www.django-rest-framework.org">
      <span class="url">
       <span class="koboSpan" id="kobo.1769.1">
        https://www.django-rest-framework.org
       </span>
      </span>
     </a>
     <span class="koboSpan" id="kobo.1770.1">
      ).
     </span>
    </li>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.1771.1">
      Learn more about Representational State Transfer (REST).
     </span>
     <span class="koboSpan" id="kobo.1771.2">
      It is used everywhere, but there are different ways to write APIs with it.
     </span>
    </li>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.1772.1">
      Learn about more advanced API concepts, such as versioning, data formats, protocols, and so on.
     </span>
     <span class="koboSpan" id="kobo.1772.2">
      Learn what headers can do more in-depth.
     </span>
    </li>
    <li class="bulletList">
     <span class="koboSpan" id="kobo.1773.1">
      Finally, if you are familiar with asynchronous programming, we recommend rewriting the code for this chapter so that it is asynchronous.
     </span>
    </li>
   </ul>
   <div class="packt_tip">
    <p class="normal">
     <span class="koboSpan" id="kobo.1774.1">
      Remember to set
     </span>
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.1775.1">
       DEBUG=true
      </span>
     </code>
     <span class="koboSpan" id="kobo.1776.1">
      in the
     </span>
     <code class="inlineCode">
      <span class="koboSpan" id="kobo.1777.1">
       .env
      </span>
     </code>
     <span class="koboSpan" id="kobo.1778.1">
      file, when working with the API, so that you get all the database queries logged automatically in your terminal, and you can check if the SQL code they produce reflects your intentions.
     </span>
     <span class="koboSpan" id="kobo.1778.2">
      This is quite a handy tool to have when SQLAlchemy operations become a bit more complex.
     </span>
    </p>
   </div>
   <p class="normal">
    <span class="koboSpan" id="kobo.1779.1">
     API design is such an important skill.
    </span>
    <span class="koboSpan" id="kobo.1779.2">
     We cannot emphasize enough how essential it is for you to master this subject.
    </span>
   </p>
   <h1 class="heading-1" id="_idParaDest-370">
    <span class="koboSpan" id="kobo.1780.1">
     Summary
    </span>
   </h1>
   <p class="normal">
    <span class="koboSpan" id="kobo.1781.1">
     In this chapter, we explored the world of APIs.
    </span>
    <span class="koboSpan" id="kobo.1781.2">
     We started with a brief overview of the Web and moved on to FastAPI, which leverages type annotations.
    </span>
    <span class="koboSpan" id="kobo.1781.3">
     Those were introduced in
    </span>
    <em class="chapterRef">
     <span class="koboSpan" id="kobo.1782.1">
      Chapter 12, Introduction to Type Hinting
     </span>
    </em>
    <span class="koboSpan" id="kobo.1783.1">
     .
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1784.1">
     We then discussed APIs in generic terms.
    </span>
    <span class="koboSpan" id="kobo.1784.2">
     We saw different ways to classify them, and the purposes and benefits of their use.
    </span>
    <span class="koboSpan" id="kobo.1784.3">
     We also explored protocols and data-exchange formats.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1785.1">
     Finally, we delved into the source code, analyzing a small part of the FastAPI project that we wrote for this chapter.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1786.1">
     We concluded the chapter with a series of suggestions for the next steps.
    </span>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1787.1">
     The next chapter discusses developing CLI applications with Python.
    </span>
   </p>
   <h1 class="heading-1" id="_idParaDest-371">
    <span class="koboSpan" id="kobo.1788.1">
     Join our community on Discord
    </span>
   </h1>
   <p class="normal">
    <span class="koboSpan" id="kobo.1789.1">
     Join our community’s Discord space for discussions with the authors and other readers:
    </span>
   </p>
   <p class="normal">
    <a href="Chapter_14.xhtml">
     <span class="url">
      <span class="koboSpan" id="kobo.1790.1">
       https://discord.com/invite/uaKmaz7FEC
      </span>
     </span>
    </a>
   </p>
   <p class="normal">
    <span class="koboSpan" id="kobo.1791.1">
     <img alt="img" src="../Images/QR_Code119001106417026468.png"/>
    </span>
   </p>
  </div>
 </body></html>