<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer074">
<h1 class="chapter-number" id="_idParaDest-48"><a id="_idTextAnchor049"/>3</h1>
<h1 id="_idParaDest-49"><a id="_idTextAnchor050"/>Creating Your Add-Ons</h1>
<p>Add-ons are extensions that expand the capabilities of Blender and can be enabled in the preferences. Some <a id="_idIndexMarker149"/>of them, such as Math Vis, encountered in <a href="B18375_02.xhtml#_idTextAnchor033"><span class="No-Break"><em class="italic">Chapter 2</em></span></a>, are official features distributed as optional functionalities. Others are third-party expansions that can be installed by <span class="No-Break">a user.</span></p>
<p>At their core, add-ons are Python modules that contain information used by Blender to install, enable, and remove them like in a <span class="No-Break">plugin system.</span></p>
<p>In this chapter, you will learn how to write and install an add-on in Blender, and how to enable add-ons while they are still in the making. We will also implement a new command that groups objects into collections and make it part of the object <span class="No-Break">context menu.</span></p>
<p>This chapter will cover the <span class="No-Break">following topics:</span></p>
<ul>
<li>Scripting <span class="No-Break">Blender extensions</span></li>
<li>Running and updating <span class="No-Break">our add-on</span></li>
<li>Fixing errors and improving <span class="No-Break">our code</span></li>
</ul>
<h1 id="_idParaDest-50"><a id="_idTextAnchor051"/>Technical requirements</h1>
<p>We will use Blender and <strong class="bold">Visual Studio Code</strong> (<strong class="bold">VS Code</strong>). The examples created in this chapter can be found <span class="No-Break">at </span><a href="https://github.com/PacktPublishing/Python-Scripting-in-Blender/tree/main/ch3"><span class="No-Break">https://github.com/PacktPublishing/Python-Scripting-in-Blender/tree/main/ch3</span></a><span class="No-Break">.</span></p>
<h1 id="_idParaDest-51"><a id="_idTextAnchor052"/>Installing our add-ons in Blender</h1>
<p>We can write a very <a id="_idIndexMarker150"/>simple add-on using VS Code. This add-on doesn’t really do anything; it just shows up in the <span class="No-Break">extensions list.</span></p>
<p>First, we must create a folder for the code of this chapter. We can use the file manager or the navigation sidebar that comes with most IDEs. In this example, we will use VS Code, which we met in the <em class="italic">External editors</em> section of <a href="B18375_01.xhtml#_idTextAnchor014"><span class="No-Break"><em class="italic">Chapter 1</em></span></a><span class="No-Break">:</span></p>
<ol>
<li>Open your <strong class="bold">PythonScriptingBlender</strong> project in <span class="No-Break">VS Code.</span></li>
<li>Create a new folder by clicking the <strong class="bold">New </strong><span class="No-Break"><strong class="bold">Folder</strong></span><span class="No-Break"> icon.</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer058">
<img alt="Figure 3.1: Creating a folder in Visual Studio Code" height="203" src="image/Figure_3.01_B18375.jpg" width="639"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.1: Creating a folder in Visual Studio Code</p>
<ol>
<li value="3">Name the new <span class="No-Break">folder </span><span class="No-Break"><strong class="source-inline">ch3</strong></span><span class="No-Break">.</span></li>
</ol>
<p>Now, we can <a id="_idIndexMarker151"/>create a Python file for <span class="No-Break">our add-on:</span></p>
<ol>
<li>Make sure the <strong class="source-inline">ch3</strong> folder is selected in the <strong class="bold">VS Code</strong> explorer, and then create a new file by clicking the <strong class="bold">New </strong><span class="No-Break"><strong class="bold">File</strong></span><span class="No-Break"> icon.</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer059">
<img alt="Figure 3.2: Creating a file in VS Code" height="216" src="image/Figure_3.02_B18375.jpg" width="638"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.2: Creating a file in VS Code</p>
<ol>
<li value="2">Name the new <span class="No-Break">file </span><span class="No-Break"><strong class="source-inline">the_simplest_add_on.py</strong></span><span class="No-Break">.</span></li>
<li>Open the file via a <span class="No-Break">double click.</span></li>
</ol>
<p>We are ready to <a id="_idIndexMarker152"/>write our add-on; let’s look at what <span class="No-Break">is required.</span></p>
<h2 id="_idParaDest-52"><a id="_idTextAnchor053"/>Add-on requirements</h2>
<p>To be considered an <a id="_idIndexMarker153"/>add-on, our code must contain <span class="No-Break">three things:</span></p>
<ul>
<li><strong class="bold">Script meta info</strong> – that is, information about <span class="No-Break">the add-on</span></li>
<li>A <strong class="source-inline">register()</strong> function to enable <span class="No-Break">the add-on</span></li>
<li>An <strong class="source-inline">unregister()</strong> function to disable <span class="No-Break">the add-on</span></li>
</ul>
<h3>Script meta info</h3>
<p>The information displayed in the preferences tab comes from the <strong class="source-inline">bl_info</strong> variable, a dictionary <a id="_idIndexMarker154"/>located at the top of the <strong class="source-inline">.py</strong> file. The dictionary must contain the name of the author, a short description of the add-on, and the version of Blender for which it is written. Here is the info for our <span class="No-Break">simple add-on:</span></p>
<pre class="source-code">
bl_info = {
    "name": "The Simplest Add-on",
    "author": "John Doe",
    "version": (1, 0),
    "blender": (3, 00, 0),
    "description": "A very simple add-on",
    "warning": "This is just for Learning",
    "category": "Learning",
}</pre>
<p class="callout-heading">Start with a blank!</p>
<p class="callout">It is better to leave a blank line at the start and the end of our code – <strong class="source-inline">.py</strong> files that do not start with a blank line might fail to register as add-ons and cause a <strong class="source-inline">missing </strong><span class="No-Break"><strong class="source-inline">bl_info</strong></span><span class="No-Break"> error.</span></p>
<h3>Registration</h3>
<p>The <strong class="source-inline">register()</strong> function is <a id="_idIndexMarker155"/>executed when an add-on is enabled. There is not much going on for now – only a <strong class="source-inline">pass</strong> statement, as our function doesn’t <span class="No-Break">do anything:</span></p>
<pre class="source-code">
def register():
    # this function is called when the add-on is enabled
    pass</pre>
<p>The <strong class="source-inline">unregister()</strong> function is <a id="_idIndexMarker156"/>invoked when the add-on is disabled. Much like <strong class="source-inline">register()</strong>, it doesn’t do anything yet, but it is required as <span class="No-Break">an add-on:</span></p>
<pre class="source-code">
def unregister():
    # this function is called when the add-on is disabled
    pass</pre>
<h2 id="_idParaDest-53"><a id="_idTextAnchor054"/>Installation</h2>
<p>Now, it’s time <a id="_idIndexMarker157"/>to install our add-on <span class="No-Break">in Blender:</span></p>
<ol>
<li>Open the preferences window via <strong class="bold">Edit</strong> | <strong class="bold">Preferences</strong> from the <span class="No-Break">top menu.</span></li>
<li>Select the <strong class="bold">Add-ons</strong> tab in the <span class="No-Break">left column.</span></li>
<li>Click the <strong class="bold">Install</strong> button at the top right of the <span class="No-Break">add-ons preferences.</span></li>
<li>In the file browser, navigate to <strong class="source-inline">PythonScriptingBlender\ch3</strong> and <span class="No-Break">select </span><span class="No-Break"><strong class="source-inline">the_simplest_add_on.py</strong></span><span class="No-Break">.</span></li>
<li>Click the <strong class="bold">Install Add-on</strong> button at <span class="No-Break">the bottom</span></li>
</ol>
<p>Our add-on has been copied and installed in Blender; the filter entry on the top left is filled so that only the new add-on is displayed. We can click the add-on checkbox to enable it. Expanding the disclosure triangle displays more information <span class="No-Break">from </span><span class="No-Break"><strong class="source-inline">bl_info</strong></span><span class="No-Break">.</span></p>
<div>
<div class="IMG---Figure" id="_idContainer060">
<img alt="Figure 3.3: A very simple add-on as listed in Blender" height="498" src="image/Figure_3.3_B18375.jpg" width="1353"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.3: A very simple add-on as listed in Blender</p>
<p>The <strong class="source-inline">warning</strong> entry <a id="_idIndexMarker158"/>from our dictionary is displayed with a triangle icon. That line is to warn the users of potentially <span class="No-Break">unstable code.</span></p>
<p>Now that our add-on has served its purpose, it’s time to <span class="No-Break">remove it.</span></p>
<h2 id="_idParaDest-54"><a id="_idTextAnchor055"/>Uninstall</h2>
<p>Clicking the big <strong class="bold">Remove</strong> button <a id="_idIndexMarker159"/>in the add-on preferences will display a confirmation dialog that asks whether it is fine to delete the add-on. This operation cannot be undone, but in this case, it is fine to go along and remove <strong class="bold">The </strong><span class="No-Break"><strong class="bold">Simplest Add-on</strong></span><span class="No-Break">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer061">
<img alt="Figure 3.4: Add-on removal in Blender" height="677" src="image/Figure_3.4_B18375.jpg" width="1353"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.4: Add-on removal in Blender</p>
<p>The path displayed in the <strong class="bold">Remove</strong> dialog informs that the add-on was installed inside Blender user <a id="_idIndexMarker160"/>preferences. That’s not always the case, as we will see how to point the scripts path to our working directory in the <span class="No-Break">next paragraph.</span></p>
<h2 id="_idParaDest-55"><a id="_idTextAnchor056"/>The scripts path</h2>
<p>Reinstalling an add-on <a id="_idIndexMarker161"/>at every change during development would end up <a id="_idIndexMarker162"/>being impractical. Programmers usually set up a <strong class="bold">system path</strong> for Python scripts and <a id="_idIndexMarker163"/>work on their add-ons <span class="No-Break">from there.</span></p>
<p>System paths can be found in <strong class="bold">Blender Preferences</strong>, by choosing the <strong class="bold">File Paths</strong> tab in the <span class="No-Break">left column.</span></p>
<div>
<div class="IMG---Figure" id="_idContainer062">
<img alt="Figure 3.5: The File Paths preferences window" height="917" src="image/Figure_3.5_B18375.jpg" width="1402"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.5: The File Paths preferences window</p>
<p>We can set this path <a id="_idIndexMarker164"/>to the directory that we will use for scripting, such <a id="_idIndexMarker165"/>as the <strong class="source-inline">PythonScriptingBlender/ch3</strong> folder that hosts the code of <span class="No-Break">this chapter.</span></p>
<h3>The addons folder</h3>
<p>Now that blender <a id="_idIndexMarker166"/>will look in our scripting folder, we can create a directory for our add-ons. We can do that from <span class="No-Break">VS Code:</span></p>
<ol>
<li>Select <strong class="source-inline">PythonScriptingBlender/ch3</strong> in <span class="No-Break">VS Code.</span></li>
<li>Create a new folder by clicking the <strong class="bold">New </strong><span class="No-Break"><strong class="bold">Folder</strong></span><span class="No-Break"> icon.</span></li>
<li>Name the new <span class="No-Break">folder </span><span class="No-Break"><strong class="source-inline">addons</strong></span><span class="No-Break">.</span></li>
</ol>
<p>It is important that <strong class="source-inline">addons</strong> is the exact name of this folder; otherwise, Blender will not look for extensions. We need to restart Blender for the <strong class="bold">File Paths</strong> settings to take effect, but once we <a id="_idIndexMarker167"/>do, Blender will be able to load the add-ons on which we are working, with no <span class="No-Break">installation needed.</span></p>
<p>Now, we can work on a new add-on that adds functionality to Blender. In the next section, we will write an add-on that groups the objects of a scene <span class="No-Break">into collections.</span></p>
<h1 id="_idParaDest-56"><a id="_idTextAnchor057"/>Creating our first add-on – object collector</h1>
<p>We are going to <a id="_idIndexMarker168"/>write an add-on that groups the objects of a scene in <a id="_idIndexMarker169"/>collections that reflect their type – one collection for all the meshes, one for all the lights, one for the curves, and <span class="No-Break">so on.</span></p>
<p>Since we have set up <strong class="source-inline">PythonScriptingBlender/ch3</strong> as the directory for our add-ons, we will proceed in <span class="No-Break">VS Code:</span></p>
<ol>
<li>Select <strong class="source-inline">PythonScriptingBlender/ch3/addons</strong> in <span class="No-Break">VS Code.</span></li>
<li>Create a new file by clicking the <strong class="bold">New </strong><span class="No-Break"><strong class="bold">File</strong></span><span class="No-Break"> icon.</span></li>
<li>Name the new <span class="No-Break">file </span><span class="No-Break"><strong class="source-inline">object_collector.py</strong></span><span class="No-Break">.</span></li>
<li>Open the file via a <span class="No-Break">double click.</span></li>
</ol>
<p>This Python script’s name starts with <strong class="source-inline">object</strong>, since it affects object data. It is a <em class="italic">soft convention</em>, as this filename scheme is suggested but <span class="No-Break">not enforced.</span></p>
<p>At this stage, the add-on is very similar to the previous one – we haven’t added any code yet. Note how, besides the obvious difference in names and descriptions, we haven’t put a <strong class="source-inline">warning</strong> entry – we intend to make a <span class="No-Break">non-experimental add-on:</span></p>
<p class="SC---Heading" lang="en-US" xml:lang="en-US">object_collector.py</p>
<pre class="source-code">
bl_info = {
    "name": "Collector",
    "author": "John Doe",
    "version": (1, 0),
    "blender": (3, 00, 0),
    "description": "Create collections for object types",
    "category": "Object",
}
def register():
    # this function is called when the add-on is enabled
    pass
def unregister():
    # this function is called when the add-on is disabled
    pass</pre>
<p class="callout-heading">Remove carefully!</p>
<p class="callout">It is better to not remove add-ons loaded from the script path using the <strong class="bold">Remove</strong> button – we risk erasing our working (and perhaps <span class="No-Break">only) copy!</span></p>
<p>Blender will show <a id="_idIndexMarker170"/>up this add-on in the preferences panel. In <a id="_idIndexMarker171"/>order to add functionalities, our add-on <a id="_idIndexMarker172"/>must contain an <strong class="bold">operator</strong>. Operators are the entities that carry on the execution of code; we will now learn how to <span class="No-Break">write them.</span></p>
<h2 id="_idParaDest-57"><a id="_idTextAnchor058"/>Operators</h2>
<p>The <strong class="source-inline">Operator</strong> class allows <a id="_idIndexMarker173"/>calling functions from the graphic <a id="_idIndexMarker174"/>interface. They are, essentially, commands that can be run <span class="No-Break">in Blender.</span></p>
<p>Therefore, we <a id="_idIndexMarker175"/>subclass the <strong class="source-inline">bpy.types.Operator</strong> class <a id="_idIndexMarker176"/>to make our code available <span class="No-Break">to users.</span></p>
<h3>Operator requirements</h3>
<p>A class deriving <strong class="source-inline">bpy.types.Operators</strong> must <a id="_idIndexMarker177"/>implement <span class="No-Break">these members:</span></p>
<ul>
<li>A static string named <strong class="source-inline">bl_idname</strong> that contains a unique name by which the operator <span class="No-Break">goes internally</span></li>
<li>A static string named <strong class="source-inline">bl_label</strong> that contains the displayed name of <span class="No-Break">the operator</span></li>
<li>A <strong class="source-inline">poll()</strong> class method that verifies that the conditions for executing the operator are met and return either <strong class="source-inline">True</strong> <span class="No-Break">or </span><span class="No-Break"><strong class="source-inline">False</strong></span></li>
<li>An <strong class="source-inline">execute()</strong> method that runs when the operator is executed, returning a set of possible <span class="No-Break">running states</span></li>
<li>Optionally, a docstring that Blender will display as <span class="No-Break">additional information</span></li>
</ul>
<p>We are going to fill in this information so that our add-on will contain an operator that can <span class="No-Break">be executed.</span></p>
<h2 id="_idParaDest-58"><a id="_idTextAnchor059"/>Writing a basic operator</h2>
<p>Let’s start to create <a id="_idIndexMarker178"/>our operator class. Following the Blender guidelines, the name <a id="_idIndexMarker179"/>starts with <strong class="source-inline">OBJECT_OT</strong>. Soon after the (optional) docstring comes <strong class="source-inline">bl_idname</strong> and <strong class="source-inline">bl_label</strong>, the two attributes that Blender uses respectively as an identifier and description of <span class="No-Break">the operator:</span></p>
<pre class="source-code">
class OBJECT_OT_collector_types(bpy.types.Operator):
    """Create collections based on objects types"""
    bl_idname = "object.pckt_type_collector"
    bl_label = "Create Type Collections"
    @classmethod
    def poll(cls, context):
        return False
    def execute(self, context):
        # our code goes here
        return {'FINISHED'}</pre>
<p>The <strong class="source-inline">poll()</strong> and <strong class="source-inline">execute()</strong> methods, at this stage, neither allow nor perform any action. We are going <a id="_idIndexMarker180"/>to implement them in the following pages, using what <a id="_idIndexMarker181"/>we have learned in <a href="B18375_02.xhtml#_idTextAnchor033"><span class="No-Break"><em class="italic">Chapter 2</em></span></a>, when dealing with <span class="No-Break">Blender data.</span></p>
<h3>Implementing the poll() method</h3>
<p><strong class="source-inline">poll()</strong> verifies <a id="_idIndexMarker182"/>that the conditions for running the operator are <a id="_idIndexMarker183"/>met. That restricts the possibility of error and makes the intended use of the operator more evident. This method is marked with a <strong class="source-inline">@classmethod</strong> decorator that allows us to validate the conditions before the operator <span class="No-Break">is run.</span></p>
<p>Since our operator collects objects in the scene, we should not be able to use it if the scene <span class="No-Break">is empty:</span></p>
<pre class="source-code">
    @classmethod
    def poll(cls, context):
        return len(context.scene.objects) &gt; 0</pre>
<h3>Implementing the execute() method</h3>
<p>After an operator is <a id="_idIndexMarker184"/>invoked, Blender runs <a id="_idIndexMarker185"/>its <strong class="source-inline">execute()</strong> method. This <strong class="source-inline">execute()</strong> function contains our operations. Breaking them down into single steps will help to code them <span class="No-Break">in Python.</span></p>
<h4>Planning our execution</h4>
<p>We must know what <a id="_idIndexMarker186"/>to expect when we execute our operator. For instance, running it on the default scene, we would end up with three new collections – <strong class="bold">Mesh</strong> for the <strong class="bold">Cube</strong> object, <strong class="bold">Camera</strong> for the <strong class="bold">Camera</strong> object, and <strong class="bold">Light</strong> for the <span class="No-Break"><strong class="bold">Light</strong></span><span class="No-Break"> object.</span></p>
<div>
<div class="IMG---Figure" id="_idContainer063">
<img alt="Figure 3.6: The expected result after running Collector" height="240" src="image/Figure_3.6_B18375.jpg" width="481"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.6: The expected result after running Collector</p>
<p>There is more <a id="_idIndexMarker187"/>than one way to reach this result, but to accomplish it by hand, we will need to create the <strong class="bold">Mesh</strong>, <strong class="bold">Light</strong>, and <strong class="bold">Camera</strong> collections and bring each object under each one <span class="No-Break">of them.</span></p>
<p>Now, we will translate these actions <span class="No-Break">into Python.</span></p>
<h4>Writing the execution code</h4>
<p>We have seen in <a href="B18375_02.xhtml#_idTextAnchor033"><span class="No-Break"><em class="italic">Chapter 2</em></span></a> how new <a id="_idIndexMarker188"/>collections can be created and linked <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">scene.collection.children</strong></span><span class="No-Break">:</span></p>
<pre class="source-code">
    def execute(self, context):
        mesh_cl = bpy.data.collections.new("Mesh")
        light_cl = bpy.data.collections.new("Light")
        cam_cl = bpy.data.collections.new("Camera")
        context.scene.collection.children.link(mesh_cl)
        context.scene.collection.children.link(light_cl)
        context.scene.collection.children.link(cam_cl)</pre>
<p>Then, we can process the objects using a <span class="No-Break"><strong class="source-inline">for</strong></span><span class="No-Break"> loop:</span></p>
<pre class="source-code">
        for ob in context.scene.objects:
            if ob.type == 'MESH':
                mesh_cl.objects.link(ob)
            elif ob.type == 'LIGHT':
                light_cl.objects.link(ob)
            elif ob.type == 'CAMERA':
                cam_cl.objects.link(ob)</pre>
<p>Finally, we always return an operation state when we exit <span class="No-Break">the function:</span></p>
<pre class="source-code">
        return {'FINISHED'}</pre>
<p>This operator is still <a id="_idIndexMarker189"/>in progress and needs refining, but we can already use it. To do that, we must inform Blender of its existence using the <strong class="source-inline">register_class()</strong> function <span class="No-Break">from </span><span class="No-Break"><strong class="source-inline">bpy.utils</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-59"><a id="_idTextAnchor060"/>Loading operators in our add-on</h2>
<p>Our add-on adds an <a id="_idIndexMarker190"/>operator to Blender when <a id="_idIndexMarker191"/>enabled and removes it when it is disabled. This is done via the <strong class="source-inline">bpy.utils.register_class()</strong> and <strong class="source-inline">bpy.utils.unregister_class()</strong> functions that we call, respectively, inside the add-on’s <strong class="source-inline">register()</strong> and <span class="No-Break"><strong class="source-inline">unregister()</strong></span><span class="No-Break"> functions:</span></p>
<pre class="source-code">
def register():
    bpy.utils.register_class(OBJECT_OT_collector_types)
def unregister():
    bpy.utils.unregister_class(OBJECT_OT_collector_types)</pre>
<p>Enabling the <strong class="bold">Collector</strong> add-on will add <strong class="bold">Create Type Collections</strong> to Blender and allow you to call it from the <span class="No-Break">user interface.</span></p>
<h1 id="_idParaDest-60"><a id="_idTextAnchor061"/>Running our add-on</h1>
<p>Even if we have <a id="_idIndexMarker192"/>yet to add any graphic element, our add-on is ready for its first launch. We can use two tricks in order to run add-ons that are not yet listed, which is quite common <span class="No-Break">in development.</span></p>
<h2 id="_idParaDest-61"><a id="_idTextAnchor062"/>Refreshing the add-on list</h2>
<p>Since we have <a id="_idIndexMarker193"/>added a new script folder and just changed its content, we need to either restart Blender or refresh the add-on information. To do that, we can click the <strong class="bold">Refresh</strong> button at the top right in the <strong class="bold">Add-ons</strong> <span class="No-Break">preferences window.</span></p>
<div>
<div class="IMG---Figure" id="_idContainer064">
<img alt="Figure 3.7: The Collector add-on, loaded from the project folder" height="441" src="image/Figure_3.7_B18375.jpg" width="1322"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.7: The Collector add-on, loaded from the project folder</p>
<p>If we start typing the name of our add-on in the filter bar, the entries in the list will narrow down until <strong class="bold">Collector</strong> becomes <a id="_idIndexMarker194"/>easy to find and enable. Now, it’s time to execute our operator via the <strong class="bold">Blender </strong><span class="No-Break"><strong class="bold">Source Bar</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-62"><a id="_idTextAnchor063"/>Running from the Search Toolbar</h2>
<p>Operators that <a id="_idIndexMarker195"/>are not part of any graphic element are for internal usage – that is, callable by other operators but not by <span class="No-Break">the user.</span></p>
<p>To make every operator searchable, make sure that <strong class="bold">Developers Extra</strong> is enabled in the <strong class="bold">Preferences</strong> | <strong class="bold">Interface</strong> tab, as we did in <a href="B18375_02.xhtml#_idTextAnchor033"><span class="No-Break"><em class="italic">Chapter 2</em></span></a>. If this option is active, here is how we can call <span class="No-Break">our operator:</span></p>
<ol>
<li>Press the <span class="No-Break"><em class="italic">F3</em></span><span class="No-Break"> button.</span></li>
<li>Start typing <strong class="source-inline">create type</strong>, and the operator will show up in the <span class="No-Break">search box.</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer065">
<img alt="Figure 3.8: The Create Type Collections operator, showing up in the search bar" height="288" src="image/Figure_3.8_B18375.jpg" width="993"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.8: The Create Type Collections operator, showing up in the search bar</p>
<ol>
<li value="3">Click on the <a id="_idIndexMarker196"/>operator to <span class="No-Break">execute it.</span></li>
</ol>
<p>We can see in the outliner that our operator succeeded.</p>
<div>
<div class="IMG---Figure" id="_idContainer066">
<img alt="" height="508" src="image/Figure_3.9_B18375.jpg" width="524"/>
</div>
</div>
<p class="IMG---Figure">figure 3.9: Each object is grouped under its type collection</p>
<p>Our add-on is at an early stage; it has a few bugs and limitations that we are going to fix. For instance, the <strong class="bold">Mesh</strong>, <strong class="bold">Light</strong>, and <strong class="bold">Camera</strong> collections are created without checking whether they already exist, which will create duplicates. Also, we are only handling these three <a id="_idIndexMarker197"/>categories, skipping <strong class="bold">Curves</strong>, <strong class="bold">Armatures</strong>, and all the other object <span class="No-Break">types entirely.</span></p>
<p>Nevertheless, if we are using version control for our folder, as seen in <a href="B18375_01.xhtml#_idTextAnchor014"><span class="No-Break"><em class="italic">Chapter 1</em></span></a>, we can commit our new files. We are going to improve our add-on in the <span class="No-Break">next section.</span></p>
<h1 id="_idParaDest-63"><a id="_idTextAnchor064"/>Improving our code</h1>
<p>Fixing bugs or starting with a row prototype that will be completed at a later stage is common practice in <a id="_idIndexMarker198"/>development. In this section, we will complete our add-on to its finished form, reload it in Blender, and deal with the versioning of the <span class="No-Break">scripts path.</span></p>
<h2 id="_idParaDest-64"><a id="_idTextAnchor065"/>Saving our edits automatically</h2>
<p>The <strong class="bold">Auto Save</strong> option <a id="_idIndexMarker199"/>will make VS Code save every file change to disk automatically. To activate this option, follow <span class="No-Break">these steps:</span></p>
<ol>
<li>Open the <strong class="bold">File</strong> menu in the <strong class="bold">Visual Studio Code</strong> <span class="No-Break">menu bar.</span></li>
<li>Click on <strong class="bold">Auto Save</strong> to enable <span class="No-Break">this entry.</span></li>
</ol>
<p>There are developers that prefer to save manually to have more control of their files. Which solution is better depends on personal tastes and workflows. Generally, if version control is used, the advantage of <strong class="bold">Auto Save</strong> outweighs the danger of <span class="No-Break">unwanted changes.</span></p>
<p>In some cases, we want to turn off version control on specific files. For instance, there are files that Python generates when it executes code; we have no interest in tracking them. In the following paragraph, we are going to see how to ignore <span class="No-Break">specific files.</span></p>
<h2 id="_idParaDest-65"><a id="_idTextAnchor066"/>Ignoring bytecode files (.pyc)</h2>
<p>If we execute code from <a id="_idIndexMarker200"/>our development <a id="_idIndexMarker201"/>folder, the <strong class="bold">SOURCE CONTROL</strong> tab in VS Code will display a <strong class="source-inline">.pyc</strong> file, along with our <strong class="source-inline">.</strong><span class="No-Break"><strong class="source-inline">py</strong></span><span class="No-Break"> files.</span></p>
<div>
<div class="IMG---Figure" id="_idContainer067">
<img alt="Figure 3.10: A temporary .pyc file can be seen alongside our scripts" height="461" src="image/Figure_3.10_B18375.jpg" width="920"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.10: A temporary .pyc file can be seen alongside our scripts</p>
<p>When a <strong class="source-inline">.py</strong> file is <a id="_idIndexMarker202"/>executed, Python translates it to <a id="_idIndexMarker203"/>an internal format and saves it as <strong class="source-inline">.pyc</strong>. We don’t need to concern ourselves with <strong class="source-inline">.pyc</strong> files, and usually, we don’t need to keep track <span class="No-Break">of them.</span></p>
<h3>Creating a .gitignore file</h3>
<p>A text file named <strong class="source-inline">.gitignore</strong>, containing the names of files and directories that we don’t want to track, will <a id="_idIndexMarker204"/>have an immediate effect when placed in a version control-managed folder. We can create it manually or follow these steps inside <span class="No-Break">VS Code:</span></p>
<ol>
<li>In the <strong class="bold">SOURCE CONTROL</strong> tab, right-click on the <strong class="source-inline">.pyc</strong> file listed <span class="No-Break">under </span><span class="No-Break"><strong class="bold">Changes</strong></span><span class="No-Break">.</span></li>
<li>From the context menu, select <strong class="bold">Add </strong><span class="No-Break"><strong class="bold">to .gitignore</strong></span><span class="No-Break">.</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer068">
<img alt="Figure 3.11: Adding to the git ignore list in VS Code" height="926" src="image/Figure_3.11_B18375.jpg" width="920"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.11: Adding to the git ignore list in VS Code</p>
<ol>
<li value="3">Once the<strong class="source-inline">.gitignore</strong> file is created, the <strong class="source-inline">.pyc</strong> file stops showing up in <span class="No-Break">the changes.</span></li>
<li>If we open <a id="_idIndexMarker205"/>the <strong class="source-inline">.gitignore</strong> file, we will see that it contains the full path of the <strong class="source-inline">.</strong><span class="No-Break"><strong class="source-inline">pyc</strong></span><span class="No-Break"> file:</span></li>
</ol>
<pre class="source-code">
ch3/addons/__pycache__/object_collector.cpython-39.pyc</pre>
<ol>
<li value="5">We don’t need to ignore that specific file; we can blacklist all the directories called <strong class="source-inline">__pycache__</strong>. To do that, we take the <span class="No-Break">following code:</span><pre class="source-code">
ch3/addons/__pycache__/object_collector.cpython-39.pyc</pre></li>
</ol>
<p>And change it to this, then save:</p>
<pre class="source-code">
__pycache__</pre>
<p>Source control applies to the <strong class="source-inline">.gitignore</strong> file itself; we have to stage and commit this file, along with the other changes made in <span class="No-Break">this chapter.</span></p>
<div>
<div class="IMG---Figure" id="_idContainer069">
<img alt="Figure 3.12: Staging the current changes for this chapter" height="834" src="image/Figure_3.12_B18375.jpg" width="920"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.12: Staging the current changes for this chapter</p>
<p>Once we have <a id="_idIndexMarker206"/>committed our changes, we can go back to working on our script, fixing its flows, and expanding its capabilities. We will see how simplifying the logic of a script improves readability, behavior, and functionality at the <span class="No-Break">same time.</span></p>
<h2 id="_idParaDest-66"><a id="_idTextAnchor067"/>Fixing the operator logic</h2>
<p>The most <a id="_idIndexMarker207"/>evident flow in our operator is that it tries to recreate <a id="_idIndexMarker208"/>existing collections. Running it twice in a row creates the <strong class="bold">Mesh.001</strong> and <strong class="bold">Light.001</strong> collections, and <span class="No-Break">so on.</span></p>
<div>
<div class="IMG---Figure" id="_idContainer070">
<img alt="Figure 3.13: Unwanted collections are created" height="159" src="image/Figure_3.13_B18375.jpg" width="511"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.13: Unwanted collections are created</p>
<h3>Avoiding duplicate collections</h3>
<p>We should <a id="_idIndexMarker209"/>create the mesh collection only if it doesn<a id="_idTextAnchor068"/>’t exist already. Note <span class="No-Break">the following:</span></p>
<pre class="source-code">
mesh_cl = bpy.data.collections.new("Mesh")</pre>
<p>Instead of that, we should create a new one, only if looking it up causes a <span class="No-Break"><strong class="source-inline">KeyError</strong></span><span class="No-Break"> error:</span></p>
<pre class="source-code">
try:
    mesh_cl = bpy.data.collections.new['Mesh']
except KeyError:
    mesh_cl = bpy.data.collections.new("Mesh")</pre>
<p>To be more generic, we can write a function that takes the collection name as <span class="No-Break">an argument.</span></p>
<p>The function presented in the following code block starts with a very descriptive docstring that can help to give a better idea of what a function should do and how to <span class="No-Break">implement it:</span></p>
<pre class="source-code">
def get_collection(name):
    '''Returns the collection named after the given
    argument. If it doesn't exist, a new collection
    is created and linked to the scene'''
    try:
        return bpy.data.collections[name]
    except KeyError:
        cl = bpy.data.collections.new(name)
        bpy.context.scene.collection.children.link(cl)
        return cl</pre>
<h3>Querying object types</h3>
<p>We could create <a id="_idIndexMarker210"/>unique collections using the preceding function – for instance, <strong class="source-inline">get_collection("Mesh")</strong> – but we don’t need to mention the object type explicitly; the <strong class="source-inline">Object.type</strong> parameter returns the type as <span class="No-Break">a string:</span></p>
<pre class="source-code">
&gt;&gt;&gt; bpy.data.objects['Cube'].type
'MESH'</pre>
<p>Strings can also be formatted nicely via their <strong class="source-inline">.</strong><span class="No-Break"><strong class="source-inline">title()</strong></span><span class="No-Break"> method:</span></p>
<pre class="source-code">
&gt;&gt;&gt; bpy.data.objects['Cube'].type.title()
'Mesh'</pre>
<p>Here is our operator execution block after <span class="No-Break">the rewrite:</span></p>
<pre class="source-code">
    @staticmethod
    def get_collection(name):
        '''Returns the collection named after the given
        argument. If it doesn't exist, a new collection
        is created and linked to the scene'''
        try:
            return bpy.data.collections[name]
        except KeyError:
            cl = bpy.data.collections.new(name)
            bpy.context.scene.collection.children.link(cl)
            return cl
    def execute(self, context):
        for ob in context.scene.objects:
            cl = self.get_collection(ob.type.title())
            cl.objects.link(ob)
    return {'FINISHED'}</pre>
<p>This version is more <a id="_idIndexMarker211"/>elegant and supports objects of any type. There is still a bug that we will fix shortly. Before we come to that, we need to reload the script to use this <span class="No-Break">new version.</span></p>
<h2 id="_idParaDest-67"><a id="_idTextAnchor069"/>Reloading scripts</h2>
<p>Blender and Python <a id="_idIndexMarker212"/>store used scripts in memory; therefore, changes made to the code will not have an immediate effect. There is a Blender command that reloads the scripts, which we can look up in the <span class="No-Break">search bar:</span></p>
<ol>
<li>Press the <em class="italic">F3</em> key to go to the <span class="No-Break">search bar.</span></li>
<li>Start typing <strong class="source-inline">reload scr</strong> in the <span class="No-Break">search field.</span></li>
<li>Click the operator, <strong class="bold">script.reload · </strong><span class="No-Break"><strong class="bold">Reload Scripts</strong></span><span class="No-Break">.</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer071">
<img alt="Figure 3.14: Invoking the Reload Scripts operator" height="158" src="image/Figure_3.14_B18375.jpg" width="984"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.14: Invoking the Reload Scripts operator</p>
<p>This command reloads all the scripts and spares us from having to restart Blender every time. Our add-ons now use the latest <strong class="source-inline">.py</strong> files on disk, and we can verify that our collections are created <span class="No-Break">only once.</span></p>
<h2 id="_idParaDest-68"><a id="_idTextAnchor070"/>Avoiding re-assignment errors</h2>
<p>While <a id="_idIndexMarker213"/>executing <strong class="bold">Create Type Collections</strong> twice doesn’t create duplicates anymore, when it tries to assign objects to collections they already belong to, it causes a <strong class="source-inline">RuntimeError</strong> error. We’ll see this error pop up if we run our operator a <span class="No-Break">second time:</span></p>
<pre class="source-code">
    cl.objects.link(ob)
RuntimeError: Object 'Cube' already in collection 'Mesh'</pre>
<p>We need to enclose object linking in a <strong class="source-inline">try</strong>/<strong class="source-inline">catch</strong> statement to <span class="No-Break">avoid that:</span></p>
<pre class="source-code">
            cl.objects.link(ob)</pre>
<p>This should be replaced with <span class="No-Break">the following:</span></p>
<pre class="source-code">
            try:
                cl.objects.link(ob)
            except RuntimeError:
                continue</pre>
<p>This way, no <a id="_idIndexMarker214"/>action is taken for objects that were already collected and the operator moves on to the rest of <span class="No-Break">the scene.</span></p>
<p class="callout-heading">Don’t try too hard!</p>
<p class="callout">We should always make sure that the actions contained inside a <strong class="source-inline">try</strong> block are minimal – these statements should not be used lightly. There is no obvious rule, but if we are trying more than two lines in a block, we should probably rethink our code so that it is <span class="No-Break">less error-prone.</span></p>
<h2 id="_idParaDest-69"><a id="_idTextAnchor071"/>Our final operator</h2>
<p>We can add more objects to <a id="_idIndexMarker215"/>the scene by invoking the <strong class="bold">Add</strong> menu from the viewport or using the <em class="italic">Shift</em> + <em class="italic">A</em> shortcut. We can add objects of different types, such as <strong class="bold">Text</strong>, <strong class="bold">Speaker</strong>, <strong class="bold">Empty</strong> | <strong class="bold">Plain Axes</strong>, and even a few new meshes such as <strong class="bold">Cylinder</strong> and <strong class="bold">Sphere</strong>, and run <strong class="bold">Create Type Collections</strong> again. We can see that each object is assigned to a collection named after <span class="No-Break">its type.</span></p>
<div>
<div class="IMG---Figure" id="_idContainer072">
<img alt="Figure 3.15: Every object type gets its own collection" height="480" src="image/Figure_3.15_B18375.jpg" width="472"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.15: Every object type gets its own collection</p>
<p>The nice thing is we didn’t have to account manually for all the object types – once a procedural <a id="_idIndexMarker216"/>workflow is in place, it will work with objects of all types, even those that will be added in future releases <span class="No-Break">of Blender.</span></p>
<p>Our operator is complete; what is missing is an easy way to invoke it. We will finish the chapter by learning how to display an operator inside a menu of <span class="No-Break">the interface.</span></p>
<h2 id="_idParaDest-70"><a id="_idTextAnchor072"/>Extending menus</h2>
<p>Menus present many advantages – they are everywhere in the application, they cover a specific aspect of <a id="_idIndexMarker217"/>the 3D workflow, and new items can be added easily. We are going to handle the addition and removal of new menu entries in our add-on – our operator will be displayed only when our add-on <span class="No-Break">is enabled.</span></p>
<h3>Draw functions</h3>
<p>Blender menus accept new <a id="_idIndexMarker218"/>items in the form of functions. These functions describe how a menu should draw a new entry; they must accept the <strong class="source-inline">self</strong> and <strong class="source-inline">context</strong> arguments passed by their menu and have the <span class="No-Break">following form:</span></p>
<pre class="source-code">
def draw_menu_item(self, context):
    row = self.layout.row()</pre>
<p>We will gain a better grasp of UI elements in <a href="B18375_05.xhtml#_idTextAnchor100"><span class="No-Break"><em class="italic">Chapter 5</em></span></a>. For now, we <a id="_idIndexMarker219"/>will only add our operator to a menu row. This is how our function <span class="No-Break">will look:</span></p>
<pre class="source-code">
def draw_collector_item(self, context):
    row = self.layout.row()
    row.operator(OBJECT_OT_collector_types.bl_idname)</pre>
<p>We can now append this function to a Blender menu and let it display <span class="No-Break">our operator.</span></p>
<h3>Adding menu entries</h3>
<p>Blender menus <a id="_idIndexMarker220"/>are stored in the <strong class="source-inline">bpy.types</strong> namespace. By convention, the name of a menu type follows the <span class="No-Break">following scheme:</span></p>
<pre class="source-code">
bpy.types.[AREA]_MT_[NAME]</pre>
<p>For instance, menus in the 3D view start with <strong class="source-inline">bpy.types.VIEW3D_MT_</strong>. Typing that in the Python console and pressing <em class="italic">Tab</em> will show the menus available in the viewport as <span class="No-Break">a suggestion:</span></p>
<pre class="source-code">
&gt;&gt;&gt; bpy.types.VIEW3D_MT_
                        add(
                        angle_control(
                        armature_add(
                        …</pre>
<p>Since <strong class="bold">Create Type Collections</strong> operates on objects, we might want to look into the <span class="No-Break"><strong class="source-inline">bpy.types.VIEW3D_MT_object</strong></span><span class="No-Break"> menus:</span></p>
<pre class="source-code">
&gt;&gt;&gt; bpy.types.VIEW3D_MT_object
                              (
                              _animation(
                              _apply(
                              _asset(
                              …
                              _context_menu(</pre>
<p>The <strong class="source-inline">bpy.types.VIEW3D_MT_object</strong> is the <strong class="bold">Object</strong> menu menu in the 3D View top bar; most of the other suggestions are its submenus. The right-click menu is available as <strong class="source-inline">VIEW3D_MT_pose_context_menu</strong>. We use this one in our example, but we could very well use any <span class="No-Break">other menu.</span></p>
<p>The <strong class="source-inline">append()</strong> and <strong class="source-inline">remove()</strong> methods add and remove a draw function from a menu. That can <a id="_idIndexMarker221"/>be done in the <strong class="source-inline">register()</strong>/<strong class="source-inline">unregister()</strong> functions of our add-on, so it becomes <span class="No-Break">the following:</span></p>
<pre class="source-code">
def register():
    bpy.utils.register_class(OBJECT_OT_collector_types)
    menu = bpy.types.VIEW3D_MT_object_context_menu
    menu.append(draw_collector_item)
def unregister():
    bpy.utils.unregister_class(OBJECT_OT_collector_types)
    menu = bpy.types.VIEW3D_MT_object_context_menu
    menu.remove(draw_collector_item)</pre>
<p>Reloading the scripts, and invoking the right-click menu while in <strong class="bold">Object Mode</strong> displays our option at the bottom. Now that there is a way to invoke our operator in the UI, we can consider our add-on complete and commit <span class="No-Break">our changes.</span></p>
<div>
<div class="IMG---Figure" id="_idContainer073">
<img alt="Figure 3.16: Our operator added to the context menu" height="257" src="image/Figure_3.16_B18375.jpg" width="390"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.16: Our operator added to the context menu</p>
<h1 id="_idParaDest-71"><a id="_idTextAnchor073"/>Summary</h1>
<p>In this chapter, we have coded a complete add-on that expands Blender functionalities and integrates seamlessly into an application. We have also learned how to work on our code while it is being used and improve our tools through consecutive steps <span class="No-Break">of refinement.</span></p>
<p>In <a href="B18375_04.xhtml#_idTextAnchor075"><span class="No-Break"><em class="italic">Chapter 4</em></span></a><em class="italic">,</em> we will learn how to affect the position and rotation of Blender objects via Python, and we will add interactive properties to <span class="No-Break">our operator.</span></p>
<h1 id="_idParaDest-72"><a id="_idTextAnchor074"/>Questions</h1>
<ol>
<li>What is the difference between a Python script and a <span class="No-Break">Blender add-on?</span></li>
<li>Which advantages does an add-on provide over <span class="No-Break">sparse code?</span></li>
<li>What do <span class="No-Break">operators do?</span></li>
<li>How do we define the conditions under which an operator can <span class="No-Break">be executed?</span></li>
<li>Can we work on an add-on while it is being used? How do we <span class="No-Break">update it?</span></li>
<li>How do we ignore bytecode (<strong class="source-inline">.pyc</strong>) files in Git <span class="No-Break">version control?</span></li>
<li>How do we avoid <span class="No-Break">creating duplicates?</span></li>
</ol>
</div>
</div></body></html>