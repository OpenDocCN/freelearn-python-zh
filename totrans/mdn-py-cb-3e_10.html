<html><head></head><body>
<section data-number="0.13" id="chapter-10-working-with-type-matching-and-annotations">
<h2 class="likechapterhead" data-number="0.13"><span><span class="kobospan" id="kobo.1.1">10</span></span><br class="tipbox1"/> <span id="x1-57300010"/><span class="kobospan" id="kobo.2.1">Working with Type Matching and Annotations</span></h2>
<p class="normal"><span class="kobospan" id="kobo.3.1">This chapter will look at how we can work with data structures that have a variety of data types. </span><span class="kobospan" id="kobo.3.2">This often means inspecting the type of an attribute, an element of a tuple, or a value in a dictionary.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.4.1">In previous chapters, we’ve avoided spending too much time on data validation considerations. </span><span class="kobospan" id="kobo.4.2">In this chapter, we’ll look closely at validating input values to be sure they conform to expected data types and value ranges.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.5.1">This data validation is a kind of type-checking. </span><span class="kobospan" id="kobo.5.2">It validates a narrower domain of values than the very broad classes of integer or string. </span><span class="kobospan" id="kobo.5.3">The application must check the values of objects to be sure they’re valid for the intended purpose.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.6.1">Some data structures like JSON or XML documents can contain objects of a variety of data types. </span><span class="kobospan" id="kobo.6.2">A common situation is summarized as </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.7.1">First Normal</span></span> <span class="cmbx-10x-x"><span class="kobospan" id="kobo.8.1">Form </span></span><span class="kobospan" id="kobo.9.1">(</span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.10.1">1NF</span></span><span class="kobospan" id="kobo.11.1">), where each item in a collection is of the same type. </span><span class="kobospan" id="kobo.11.2">This isn’t universal, however. </span><span class="kobospan" id="kobo.11.3">When parsing complex files like programming language statements, we’ll see a sequence of distinct data types. </span><span class="kobospan" id="kobo.11.4">The presence of diverse types means that the application software can’t simply assume a single, consistent type, but must process the available data.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.12.1">In this chapter, we’ll look at a number of recipes related to types and type matching:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><a href="ch014.xhtml#x1-5740001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.13.1">Designing with type hints</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch014.xhtml#x1-5820002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.14.1">Using the built-in type matching functions</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch014.xhtml#x1-5880003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.15.1">Using the match statement</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch014.xhtml#x1-5940004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.16.1">Handling type conversions</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch014.xhtml#x1-6000005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.17.1">Implementing more strict type checks with Pydantic</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch014.xhtml#x1-6060006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.18.1">Including run-time valid value checks</span></span></a></p></li>
</ul>
<p class="normal1"><span id="x1-573001r1205"/></p>
<section data-number="0.13.1" id="designing-with-type-hints">
<h1 class="unnumbered" data-number="0.13.1"><span><span class="kobospan" id="kobo.19.1">10.1 </span></span> <span id="x1-5740001"/><span class="kobospan" id="kobo.20.1">Designing with type hints</span></h1>
<p class="normal"><span class="kobospan" id="kobo.21.1">Annotations in function definitions</span><span id="dx1-574001"/><span class="kobospan" id="kobo.22.1"> were introduced to the language syntax back in 2006, without any formal semantics. </span><span class="kobospan" id="kobo.22.2">The annotations idea came with a list of potential use cases, one of which was type checking. </span><span class="kobospan" id="kobo.22.3">In 2014, the idea of type hints were solidified and formalized into a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.23.1">typing</span></span></span></span><span class="kobospan" id="kobo.24.1"> module and some associated tools including the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.25.1">mypy </span></span><span class="kobospan" id="kobo.26.1">tool.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.27.1">For a few years, </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.28.1">annotations </span></span><span class="kobospan" id="kobo.29.1">were a general kind of syntax and </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.30.1">type hints </span></span><span class="kobospan" id="kobo.31.1">were a specific use case for annotations. </span><span class="kobospan" id="kobo.31.2">By 2017, other uses for annotations</span><span id="dx1-574002"/><span class="kobospan" id="kobo.32.1"> were deprecated and the annotation syntax was expressly focused on type hints. </span><span class="kobospan" id="kobo.32.2">While there was once a subtle difference between annotations and type hints, the distinction has since evaporated, leaving us with two synonyms.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.33.1">There are three important aspects of using type</span><span id="dx1-574003"/><span class="kobospan" id="kobo.34.1"> hints:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.35.1">Type hints are optional. </span><span class="kobospan" id="kobo.35.2">We can write Python without type hints.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.36.1">Type hints can be applied </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.37.1">gradually</span></span><span class="kobospan" id="kobo.38.1">. </span><span class="kobospan" id="kobo.38.2">Part of an application can have hints, where another part lacks them. </span><span class="kobospan" id="kobo.38.3">Tools like </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.39.1">mypy </span></span><span class="kobospan" id="kobo.40.1">can tolerate mixtures</span><span id="dx1-574004"/><span class="kobospan" id="kobo.41.1"> of code with and without hints.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.42.1">Type hints are not used at run time</span><span id="dx1-574005"/><span class="kobospan" id="kobo.43.1"> and have no performance overhead.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.44.1">Throughout this book, we’ve treated hints as essential to good software design. </span><span class="kobospan" id="kobo.44.2">They’re as essential as unit tests and coherent documentation, both of which are also technically optional, but essential for trustworthy software. </span><span class="kobospan" id="kobo.44.3">We’ve found them to help prevent problems by enforcing a level of rigor and formality.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.45.1">Python’s processing relies on </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.46.1">duck typing </span></span><span class="kobospan" id="kobo.47.1">rules. </span><span class="kobospan" id="kobo.47.2">For more background, see </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.48.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.49.1"> </span></span><a href="ch012.xhtml#x1-4520008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.50.1">8</span></span></a><span class="kobospan" id="kobo.51.1">, specifically, the </span><a href="ch012.xhtml#x1-4670003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.52.1">Leveraging Python’s duck typing</span></span></a><span class="kobospan" id="kobo.53.1"> recipe. </span><span class="kobospan" id="kobo.53.2">There are two broad design patterns available to us:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.54.1">A strict hierarchy with a common superclass.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.55.1">Leveraging duck typing, a collection of classes can have common features, often defined as a protocol that specifies the relevant features.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.56.1">In this recipe, we’ll look at two approaches to designing code that includes type hints and can be checked by tools like </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.57.1">mypy</span></span><span class="kobospan" id="kobo.58.1">. </span><span id="x1-574006r1203"/></p>
<section data-number="0.13.1.1" id="getting-ready-79">
<h2 class="likechapterhead" data-number="0.13.1.1"><span><span class="kobospan" id="kobo.59.1">10.1.1 </span></span> <span id="x1-5750001"/><span class="kobospan" id="kobo.60.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.61.1">We’ll look at a problem that involves</span><span id="dx1-575001"/><span class="kobospan" id="kobo.62.1"> working with two distinct types of data that are mingled together in a source file. </span><span class="kobospan" id="kobo.62.2">In this case, we’re going to classify the contents of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.63.1">data</span></span></span></span><span class="kobospan" id="kobo.64.1"> directory with a large number of data files. </span><span class="kobospan" id="kobo.64.2">Additionally, we have an </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.65.1">src</span></span></span></span><span class="kobospan" id="kobo.66.1"> directory with a large number of sub-directories that contain application programs and scripts. </span><span class="kobospan" id="kobo.66.2">We want to create a collection of data structures to represent two distinct classes of data files:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.67.1">Data files not named by any application program or script</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.68.1">Data files that are referenced by one or more application programs</span></p></li>
</ul>
<p class="normal1"><span id="x1-575002r1209"/></p>
</section>
<section data-number="0.13.1.2" id="how-to-do-it...-80">
<h2 class="likechapterhead" data-number="0.13.1.2"><span><span class="kobospan" id="kobo.69.1">10.1.2 </span></span> <span id="x1-5760002"/><span class="kobospan" id="kobo.70.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.71.1">There are two broad strategies for designing this kind of program:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.72.1">Sketch out the data types and transformations first, then write code to fit the types.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.73.1">Write code first and then add type hints to the working code.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.74.1">Neither can be described as best. </span><span class="kobospan" id="kobo.74.2">In many cases, the two evolve side by side.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.75.1">We’ll look at each of these in separate</span><span id="dx1-576001"/><span class="kobospan" id="kobo.76.1"> variations in this recipe.</span></p>
<section data-number="0.13.1.2.1" id="type-hints-first-design">
<h3 class="likesubsubsectionhead" data-number="0.13.1.2.1"><span id="x1-5770002"/><span class="kobospan" id="kobo.77.1">Type hints first design</span></h3>
<p class="normal"><span class="kobospan" id="kobo.78.1">We’re going to work with diverse</span><span id="dx1-577001"/><span class="kobospan" id="kobo.79.1"> classes of objects. </span><span class="kobospan" id="kobo.79.2">In this variation, we’ll define the type hints first, and then fill in the needed processing. </span><span class="kobospan" id="kobo.79.3">Here’s how we can define a classifier and the related classes starting from the class definitions:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-577003x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.80.1">Define the two subclasses. </span><span class="kobospan" id="kobo.80.2">In this example, we’ll call them </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.81.1">Unreferenced</span></span></span></span><span class="kobospan" id="kobo.82.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.83.1">Referenced</span></span></span></span><span class="kobospan" id="kobo.84.1"> files. </span><span class="kobospan" id="kobo.84.2">For each class, write a sentence describing the unique purpose for the instances of each class. </span><span class="kobospan" id="kobo.84.3">These serve as the starting point for the class definitions.</span></p>
</div></li>
<li class="calibre7"><div id="x1-577005x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.85.1">Chose an appropriate variety of available classes. </span><span class="kobospan" id="kobo.85.2">This might be an ordinary class with mutable attributes, a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.86.1">NamedTuple</span></span></span></span><span class="kobospan" id="kobo.87.1">, or a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.88.1">@dataclass</span></span></span></span><span class="kobospan" id="kobo.89.1">. </span><span class="kobospan" id="kobo.89.2">Starting with a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.90.1">@dataclass</span></span></span></span><span class="kobospan" id="kobo.91.1"> often gives the most flexibility. </span><span class="kobospan" id="kobo.91.2">Switching between named tuples, dataclasses, and frozen dataclasses involves minimal syntax changes:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.92.1">from pathlib import Path 
 
from dataclasses import dataclass 
 
 
 
@dataclass 
 
class Referenced: 
 
    """Defines a data file and applications that reference it."""</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.93.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.94.1">Unreferenced</span></span></span></span><span class="kobospan" id="kobo.95.1"> class definition would be similar, with an appropriate docstring.</span></p>
</div></li>
<li class="calibre7"><div id="x1-577014x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.96.1">Add the attributes with values that will define the state of each instance. </span><span class="kobospan" id="kobo.96.2">For the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.97.1">Referenced</span></span></span></span><span class="kobospan" id="kobo.98.1"> class, this is the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.99.1">Path</span></span></span></span><span class="kobospan" id="kobo.100.1"> and a collection of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.101.1">Path</span></span></span></span><span class="kobospan" id="kobo.102.1"> objects for each source file that has a reference. </span><span class="kobospan" id="kobo.102.2">These two attribute definitions look like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.103.1">    datafile: Path 
 
    recipes: list[Path]                                                                </span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.104.1">For the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.105.1">Unreferenced</span></span></span></span><span class="kobospan" id="kobo.106.1"> class, however, there really aren’t very many other attributes beyond the path. </span><span class="kobospan" id="kobo.106.2">This raises an interesting question: does this deserve a separate class declaration, or can it simply be a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.107.1">Path</span></span></span></span><span class="kobospan" id="kobo.108.1"> object?</span></p>
<p class="normal1"><span class="kobospan" id="kobo.109.1">Because Python permits type aliases and type unions, there’s no real need for an </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.110.1">Unreferenced</span></span></span></span><span class="kobospan" id="kobo.111.1"> class; the existing </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.112.1">Path</span></span></span></span><span class="kobospan" id="kobo.113.1"> will do. </span><span class="kobospan" id="kobo.113.2">It is helpful to provide a type alias for this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.114.1">from typing import TypeAlias 
 
 
 
Unreferenced: TypeAlias = Path</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-577023x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.115.1">Formalize the union of these distinct classes.</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.116.1">ContentType: TypeAlias = Unreferenced | Referenced</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.117.1">Now that we have the type</span><span id="dx1-577026"/><span class="kobospan" id="kobo.118.1"> definitions, we can write a function that is an iterator over the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.119.1">ContentType</span></span></span></span><span class="kobospan" id="kobo.120.1"> union of classes. </span><span class="kobospan" id="kobo.120.2">This function will yield a sequence of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.121.1">Unreferenced</span></span></span></span><span class="kobospan" id="kobo.122.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.123.1">Referenced</span></span></span></span><span class="kobospan" id="kobo.124.1"> objects, one for each data file.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.125.1">The function might look like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.126.1">def datafile_iter(base: Path) -&gt; Iterator[ContentType]: 
 
    data = (base / "data") 
 
    code = (base / "src") 
 
    for path in sorted(data.glob("*.*")): 
 
        if not path.is_file(): 
 
            continue 
 
 
 
        used_by = [ 
 
            chap_recipe.relative_to(code) 
 
            for chap_recipe in code.glob("**/*.py") 
 
            if ( 
 
                chap_recipe.is_file() 
 
                and "__pycache__" not in chap_recipe.parts 
 
                and ".venv" not in chap_recipe.parts 
 
                and "ch10" not in chap_recipe.parts 
 
                and path.name in chap_recipe.read_text() 
 
            ) 
 
        ] 
 
 
 
        if used_by: 
 
            yield Referenced(path.relative_to(data), used_by) 
 
        else: 
 
            yield path.relative_to(data)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.127.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.128.1">datafile_iter()</span></span></span></span><span class="kobospan" id="kobo.129.1"> function skips past any non-file names in the data directory. </span><span class="kobospan" id="kobo.129.2">It also skips some source code directories, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.130.1">__pycache__</span></span></span></span><span class="kobospan" id="kobo.131.1">, and</span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.132.1">.venv</span></span></span></span><span class="kobospan" id="kobo.133.1">. </span><span class="kobospan" id="kobo.133.2">Additionally, we have to ignore some of the files in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.134.1">Chapter 10 </span></span><span class="kobospan" id="kobo.135.1">because these files will have test cases that contain names of data files, creating confusing results.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.136.1">If a data file name appears in a source file, the reference is saved in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.137.1">used_by</span></span></span></span><span class="kobospan" id="kobo.138.1"> collection. </span><span class="kobospan" id="kobo.138.2">Files with a non-empty </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.139.1">used_by</span></span></span></span><span class="kobospan" id="kobo.140.1"> collection will create a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.141.1">Referenced</span></span></span></span><span class="kobospan" id="kobo.142.1"> instance. </span><span class="kobospan" id="kobo.142.2">The remaining files are </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.143.1">Path</span></span></span></span><span class="kobospan" id="kobo.144.1"> objects; because of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.145.1">TypeAlias</span></span></span></span><span class="kobospan" id="kobo.146.1"> these are recognized as </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.147.1">Unreferenced</span></span></span></span><span class="kobospan" id="kobo.148.1"> instances, also. </span><span class="kobospan" id="kobo.148.2">We don’t need to formally cast or convert a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.149.1">Path</span></span></span></span><span class="kobospan" id="kobo.150.1"> object to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.151.1">Unreferenced</span></span></span></span><span class="kobospan" id="kobo.152.1"> type. </span><span class="kobospan" id="kobo.152.2">Tools like </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.153.1">mypy</span></span><span class="kobospan" id="kobo.154.1"> will use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.155.1">TypeAlias</span></span></span></span><span class="kobospan" id="kobo.156.1"> to see the equivalence</span><span id="dx1-577051"/><span class="kobospan" id="kobo.157.1"> without any additional code.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.158.1">The resulting iterator</span><span id="dx1-577052"/><span class="kobospan" id="kobo.159.1"> provides a mix of objects of distinct types. </span><span class="kobospan" id="kobo.159.2">In the </span><a href="ch014.xhtml#x1-5880003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.160.1">Using the</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.161.1">match statement</span></span></a><span class="kobospan" id="kobo.162.1"> recipe, we’ll look at convenient ways to process objects of diverse types.</span></p>
</section>
<section data-number="0.13.1.2.2" id="code-first-design">
<h3 class="likesubsubsectionhead" data-number="0.13.1.2.2"><span id="x1-5780002"/><span class="kobospan" id="kobo.163.1">Code first design</span></h3>
<p class="normal"><span class="kobospan" id="kobo.164.1">We’re going to work</span><span id="dx1-578001"/><span class="kobospan" id="kobo.165.1"> with diverse classes of objects. </span><span class="kobospan" id="kobo.165.2">In this variation, we’ll define the processing first, and then fold in type hints to clarify our intent. </span><span class="kobospan" id="kobo.165.3">Here’s how we can define a classifer and the related classes starting from a function definition:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-578003x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.166.1">Start with a function definition that provides the needed parameters:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.167.1">def datafile_iter(base): 
 
    data = (base / "data") 
 
    code = (base / "src")</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-578009x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.168.1">Write the processing to accumulate the required data values. </span><span class="kobospan" id="kobo.168.2">In this case, we need to iterate through the names of the data files. </span><span class="kobospan" id="kobo.168.3">For each data file, we need to look for references in all of the source files.</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.169.1">    for path in sorted(data.glob("*.*")): 
 
        if not path.is_file(): 
 
            continue 
 
 
 
        used_by = [ 
 
            chap_recipe.relative_to(code) 
 
            for chap_recipe in code.glob("**/*.py") 
 
            if ( 
 
                    chap_recipe.is_file() 
 
                    and "__pycache__" not in chap_recipe.parts 
 
                    and ".venv" not in chap_recipe.parts 
 
                    and "ch10" not in chap_recipe.parts 
 
                    and path.name in chap_recipe.read_text() 
 
            ) 
 
        ]</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-578027x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.170.1">Decide what the various outputs from the function need to be. </span><span class="kobospan" id="kobo.170.2">In some cases, we can yield tuple objects with the various kinds of values that are available.</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.171.1">        if used_by: 
 
            yield (path.relative_to(data), used_by) 
 
        else: 
 
            yield path.relative_to(data)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.172.1">For paths without any references in the source, we yield the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.173.1">Path</span></span></span></span><span class="kobospan" id="kobo.174.1"> object. </span><span class="kobospan" id="kobo.174.2">For paths that have references in the source, we can yield the data </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.175.1">Path</span></span></span></span><span class="kobospan" id="kobo.176.1"> and a list of source </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.177.1">Path</span></span></span></span><span class="kobospan" id="kobo.178.1"> instances.</span></p>
</div></li>
<li class="calibre7"><div id="x1-578034x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.179.1">For objects with more complicated internal</span><span id="dx1-578035"/><span class="kobospan" id="kobo.180.1"> state, consider introducing</span><span id="dx1-578036"/><span class="kobospan" id="kobo.181.1"> a class definition to properly encapsulate the state. </span><span class="kobospan" id="kobo.181.2">For this example, it makes sense to introduce a type for data files that have references. </span><span class="kobospan" id="kobo.181.3">This would lead to replacing a simple, anonymous tuple with a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.182.1">NamedTuple</span></span></span></span><span class="kobospan" id="kobo.183.1"> like the following:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.184.1">from typing import NamedTuple 
 
class Referenced(NamedTuple): 
 
    datafile: Path 
 
    recipes: list[Path]</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.185.1">This, in turn, leads to revising the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.186.1">yield</span></span></span></span><span class="kobospan" id="kobo.187.1"> statement for the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.188.1">Referenced</span></span></span></span><span class="kobospan" id="kobo.189.1"> instances.</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.190.1">            yield Referenced(path.relative_to(data), used_by)
                                                                     

                                                                     </span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-578045x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.191.1">Revisit the function definition to add type hints.</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.192.1">def datafile_iter_2(base: Path) -&gt; Iterator[Path | Referenced]:</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.193.1">The processing in both variants</span><span id="dx1-578048"/><span class="kobospan" id="kobo.194.1"> of the recipe is nearly identical. </span><span class="kobospan" id="kobo.194.2">The differences are minor choices on how best to present the results. </span><span class="kobospan" id="kobo.194.3">In the previous example, an explicit union named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.195.1">Content_Type</span></span></span></span><span class="kobospan" id="kobo.196.1"> was created. </span><span class="kobospan" id="kobo.196.2">For this version, the union is implicit. </span><span id="x1-578049r1210"/></p>
</section>
</section>
<section data-number="0.13.1.3" id="how-it-works...-80">
<h2 class="likechapterhead" data-number="0.13.1.3"><span><span class="kobospan" id="kobo.197.1">10.1.3 </span></span> <span id="x1-5790003"/><span class="kobospan" id="kobo.198.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.199.1">Python duck typing permits</span><span id="dx1-579001"/><span class="kobospan" id="kobo.200.1"> a great deal of latitude in design. </span><span class="kobospan" id="kobo.200.2">We can start with type definitions or we can start from code and add type hints. </span><span class="kobospan" id="kobo.200.3">The final code will tend to be similar because it performs the same processing on the same data.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.201.1">The choice between a </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.202.1">code first </span></span><span class="kobospan" id="kobo.203.1">or </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.204.1">type first </span></span><span class="kobospan" id="kobo.205.1">approach may lead to an insight about performance or optimization. </span><span class="kobospan" id="kobo.205.2">Each choice emphasizes distinct attributes of the final code. </span><span class="kobospan" id="kobo.205.3">The code-first approach can emphasize simple processing, where type first might emphasize uniformity of the objects being processed. </span><span class="kobospan" id="kobo.205.4">The choice of approach can also stem from the author’s degree of comfort with Python’s types.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.206.1">In some cases, the process of writing the type hints may suggest algorithms or optimizations. </span><span class="kobospan" id="kobo.206.2">This can lead to beneficial refactoring of code already written.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.207.1">It’s important to note that the presence or absence of type hints has no performance impact. </span><span class="kobospan" id="kobo.207.2">Any performance gains (or losses) are ordinary design issues that might be made more visible through the use of type hints. </span><span id="x1-579002r1224"/></p>
</section>
<section data-number="0.13.1.4" id="theres-more...-71">
<h2 class="likechapterhead" data-number="0.13.1.4"><span><span class="kobospan" id="kobo.208.1">10.1.4 </span></span> <span id="x1-5800004"/><span class="kobospan" id="kobo.209.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.210.1">When decomposing a large problem into smaller pieces, the interfaces among the smaller pieces are essential design decisions that must be made early in the design process. </span><span class="kobospan" id="kobo.210.2">An early decision on data structures often leads to a </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.211.1">type first </span></span><span class="kobospan" id="kobo.212.1">design process overall. </span><span class="kobospan" id="kobo.212.2">The externally facing components must have well-defined interfaces. </span><span class="kobospan" id="kobo.212.3">The functions or methods that support these external components may be designed more freely with fewer constraints.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.213.1">This leads to </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.214.1">type first </span></span><span class="kobospan" id="kobo.215.1">for the overall</span><span id="dx1-580001"/><span class="kobospan" id="kobo.216.1"> architecture of complicated software, reserving a choice of </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.217.1">type first </span></span><span class="kobospan" id="kobo.218.1">or </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.219.1">code first </span></span><span class="kobospan" id="kobo.220.1">design</span><span id="dx1-580002"/><span class="kobospan" id="kobo.221.1"> when working on the more detailed layers. </span><span class="kobospan" id="kobo.221.2">When we consider distributed applications – like web services – where servers and clients are on separate machines, we find that </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.222.1">type first </span></span><span class="kobospan" id="kobo.223.1">is essential.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.224.1">As the volume of code grows, the importance of type hints also grows. </span><span class="kobospan" id="kobo.224.2">It’s challenging to keep a lot of details in the space between one’s ears. </span><span class="kobospan" id="kobo.224.3">Having a type hint to summarize a more complicated data structure can reduce the clutter of details around the code.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.225.1">In distributed computing environments, we’ll often need to consider that some components may not be Python programs. </span><span class="kobospan" id="kobo.225.2">In these cases, we can’t share Python type hints. </span><span class="kobospan" id="kobo.225.3">This means we’re forced to use a schema definition that exists outside Python, but provides needed mappings to Python types.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.226.1">Examples of these kinds of formal definitions that transcend languages include JSON Schema, Protocol Buffers, AVRO, and many others. </span><span class="kobospan" id="kobo.226.2">The JSON Schema approach is typical, and is supported by a number of Python tools. </span><span class="kobospan" id="kobo.226.3">Later in this chapter, we’ll look at using </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.227.1">Pydantic</span></span><span class="kobospan" id="kobo.228.1">, which has support for defining data using JSON Schema. </span><span id="x1-580003r1225"/></p>
</section>
<section data-number="0.13.1.5" id="see-also-78">
<h2 class="likechapterhead" data-number="0.13.1.5"><span><span class="kobospan" id="kobo.229.1">10.1.5 </span></span> <span id="x1-5810005"/><span class="kobospan" id="kobo.230.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.231.1">In the </span><a href="ch015_split_001.xhtml#x1-6520006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.232.1">Reading JSON and YAML documents</span></span></a><span class="kobospan" id="kobo.233.1"> recipe in Chapter </span><a href="ch015_split_000.xhtml#x1-61500011" class="url"><span class="kobospan" id="kobo.234.1">11</span></a><span class="kobospan" id="kobo.235.1">, we’ll return to using JSON documents for complicated data.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.236.1">In the </span><a href="ch014.xhtml#x1-5880003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.237.1">Using the match statement</span></span></a><span class="kobospan" id="kobo.238.1"> recipe, later in this chapter, we’ll look at how to use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.239.1">match</span></span></span></span><span class="kobospan" id="kobo.240.1"> statement to process data of a variety of types. </span><span class="kobospan" id="kobo.240.2">This makes it relatively easy to work with unions of types.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.241.1">In the </span><a href="ch014.xhtml#x1-6000005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.242.1">Implementing more strict type checks with Pydantic</span></span></a><span class="kobospan" id="kobo.243.1"> recipe, later in this chapter, we’ll look at stronger type definitions using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.244.1">pydantic</span></span></span></span><span class="kobospan" id="kobo.245.1"> package.</span></p></li>
</ul>
<p class="normal1"><span id="x1-581001r1208"/></p>
</section>
</section>
<section data-number="0.13.2" id="using-the-built-in-type-matching-functions">
<h1 class="unnumbered" data-number="0.13.2"><span><span class="kobospan" id="kobo.246.1">10.2 </span></span> <span id="x1-5820002"/><span class="kobospan" id="kobo.247.1">Using the built-in type matching functions</span></h1>
<p class="normal"><span class="kobospan" id="kobo.248.1">When we have a collection of objects</span><span id="dx1-582001"/><span class="kobospan" id="kobo.249.1"> with mixed types, we often need to distinguish among the types. </span><span class="kobospan" id="kobo.249.2">When working with classes that we’ve defined, it’s possible to define classes that are properly </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.250.1">polymorphic</span></span><span class="kobospan" id="kobo.251.1">. </span><span class="kobospan" id="kobo.251.2">This is not generally the case when working with Python’s internal objects, or working with collections of data that involve a mixture of classes we’ve defined, and built-in classes that are part of Python.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.252.1">When working entirely with our own classes, we can design them to have common methods and attributes, but offer distinct behavior depending on which of the subclasses is involved. </span><span class="kobospan" id="kobo.252.2">This kind of design fits the ”L” design principle in the S.O.L.I.D design principles: the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.253.1">Liskov Substitution Principle</span></span><span class="kobospan" id="kobo.254.1">. </span><span class="kobospan" id="kobo.254.2">Any of the subclasses can be used in place of the superclass, because they all have a common set of method definitions. </span><span class="kobospan" id="kobo.254.3">For more information on this, see </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.255.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.256.1"> </span></span><a href="ch012.xhtml#x1-4520008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.257.1">8</span></span></a><span class="kobospan" id="kobo.258.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.259.1">This kind of abstraction-driven design is not always needed with Python. </span><span class="kobospan" id="kobo.259.2">Because of Python’s duck-typing, designs don’t require a common superclass. </span><span class="kobospan" id="kobo.259.3">In some cases, it isn’t even practical: we may have diverse types without a unifying abstraction. </span><span class="kobospan" id="kobo.259.4">It’s very common to work with mixtures of objects from built-in classes, as well as objects from our own class definitions. </span><span class="kobospan" id="kobo.259.5">We can’t impose polymorphism on the built-in classes.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.260.1">How can we leverage the built-in functions to write functions and methods that are flexible with respect to type? </span><span class="kobospan" id="kobo.260.2">For this recipe, we’ll reuse the processing from the </span><a href="ch014.xhtml#x1-5740001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.261.1">Designing with type hints</span></span></a><span class="kobospan" id="kobo.262.1"> recipe earlier in this chapter. </span><span id="x1-582002r1226"/></p>
<section data-number="0.13.2.1" id="getting-ready-80">
<h2 class="likechapterhead" data-number="0.13.2.1"><span><span class="kobospan" id="kobo.263.1">10.2.1 </span></span> <span id="x1-5830001"/><span class="kobospan" id="kobo.264.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.265.1">In the </span><a href="ch014.xhtml#x1-5740001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.266.1">Designing with type hints</span></span></a><span class="kobospan" id="kobo.267.1"> recipe, we defined a function </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.268.1">datafile_iter()</span></span></span></span><span class="kobospan" id="kobo.269.1"> that emitted two distinct types of objects: </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.270.1">Path</span></span></span></span><span class="kobospan" id="kobo.271.1"> objects and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.272.1">Referenced</span></span></span></span><span class="kobospan" id="kobo.273.1"> objects. </span><span class="kobospan" id="kobo.273.2">A </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.274.1">Referenced</span></span></span></span><span class="kobospan" id="kobo.275.1"> object was a bundle of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.276.1">Path</span></span></span></span><span class="kobospan" id="kobo.277.1"> instances, showing a data file that was used by one or more application programs. </span><span class="kobospan" id="kobo.277.2">A stand-alone </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.278.1">Path</span></span></span></span><span class="kobospan" id="kobo.279.1"> object was a data file not used by any application program. </span><span class="kobospan" id="kobo.279.2">These unreferenced paths are candidates for removal to reduce clutter.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.280.1">We need to process these two classes of objects in distinct ways. </span><span class="kobospan" id="kobo.280.2">They’re created by a single generator function, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.281.1">datafile_iter()</span></span></span></span><span class="kobospan" id="kobo.282.1">. </span><span class="kobospan" id="kobo.282.2">This function emits a sequence of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.283.1">Unreferenced</span></span></span></span><span class="kobospan" id="kobo.284.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.285.1">Referenced</span></span></span></span><span class="kobospan" id="kobo.286.1"> instances. </span><span class="kobospan" id="kobo.286.2">This mixture means an application must filter objects by their type.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.287.1">The application will work with a sequence</span><span id="dx1-583001"/><span class="kobospan" id="kobo.288.1"> of objects. </span><span class="kobospan" id="kobo.288.2">These will be created by a function with the following definition:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.289.1">from collections.abc import Iterator 
 
DataFileIter: TypeAlias = Iterator[Unreferenced | Referenced] 
 
 
 
def datafile_iter(base: Path) -&gt; DataFileIter:</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.290.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.291.1">datafile_iter()</span></span></span></span><span class="kobospan" id="kobo.292.1"> function will produce a sequence of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.293.1">Unreferenced</span></span></span></span><span class="kobospan" id="kobo.294.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.295.1">Referenced</span></span></span></span><span class="kobospan" id="kobo.296.1"> objects. </span><span class="kobospan" id="kobo.296.2">This will reflect the current state of files in a given directory. </span><span class="kobospan" id="kobo.296.3">Some will have references in source code; others will lack any references. </span><span class="kobospan" id="kobo.296.4">See the </span><a href="ch014.xhtml#x1-5740001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.297.1">Designing with type hints</span></span></a><span class="kobospan" id="kobo.298.1"> recipe for this function. </span><span id="x1-583007r1228"/></p>
</section>
<section data-number="0.13.2.2" id="how-to-do-it...-81">
<h2 class="likechapterhead" data-number="0.13.2.2"><span><span class="kobospan" id="kobo.299.1">10.2.2 </span></span> <span id="x1-5840002"/><span class="kobospan" id="kobo.300.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.301.1">The application function to do analysis will consume objects of a variety of types. </span><span class="kobospan" id="kobo.301.2">The function is designed as follows:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-584002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.302.1">Start with a definition like the following that shows the types consumed:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.303.1">from collections.abc import Iterable 
 
 
 
def analysis(source: Iterable[Unreferenced | Referenced]) -&gt; None:</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-584008x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.304.1">Create an empty list that will hold the data files that have references. </span><span class="kobospan" id="kobo.304.2">Write the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.305.1">for</span></span></span></span><span class="kobospan" id="kobo.306.1"> statement to consume objects from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.307.1">source</span></span></span></span><span class="kobospan" id="kobo.308.1"> iterable, and populate that list:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.309.1">    good_files: list[Referenced] = [] 
 
    for file in source:</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-584013x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.310.1">To distinguish objects by type, we can use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.311.1">isinstance()</span></span></span></span><span class="kobospan" id="kobo.312.1"> function to see if an object is a class of a given type.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.313.1">To distinguish the class, use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.314.1">isinstance()</span></span></span></span><span class="kobospan" id="kobo.315.1"> function:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.316.1">        if isinstance(file, Unreferenced): 
 
            print(f"delete {file}") 
 
        elif isinstance(file, Referenced): 
 
            good_files.append(file)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-584020x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.317.1">While it’s technically unnecessary, it always seems prudent to include an </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.318.1">else</span></span></span></span><span class="kobospan" id="kobo.319.1"> condition to raise an exception in the unlikely event that the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.320.1">datafile_iter</span></span></span></span><span class="kobospan" id="kobo.321.1"> function was changed in some astonishing way:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.322.1">        else: 
 
            raise ValueError(f"unexpected type {type(file)}")</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.323.1">For more about this design pattern, see the </span><a href="ch006_split_000.xhtml#x1-1170005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.324.1">Designing complex if...elif</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.325.1">chains</span></span></a><span class="kobospan" id="kobo.326.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.327.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.328.1"> </span></span><a href="ch006_split_000.xhtml#x1-840002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.329.1">2</span></span></a><span class="kobospan" id="kobo.330.1">.</span></p>
</div></li>
<li class="calibre7"><div id="x1-584025x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.331.1">Write the final summary:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.332.1">    print(f"Keep {len(good_files)} files")</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span id="x1-584028r1230"/></p>
</section>
<section data-number="0.13.2.3" id="how-it-works...-81">
<h2 class="likechapterhead" data-number="0.13.2.3"><span><span class="kobospan" id="kobo.333.1">10.2.3 </span></span> <span id="x1-5850003"/><span class="kobospan" id="kobo.334.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.335.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.336.1">isinstance()</span></span></span></span><span class="kobospan" id="kobo.337.1"> function examines</span><span id="dx1-585001"/><span class="kobospan" id="kobo.338.1"> an object to see what classes it belongs to. </span><span class="kobospan" id="kobo.338.2">The second argument can be single class or a tuple of alternative classes.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.339.1">It’s important to note that an object often has a number of parent classes, forming a lattice, stemming from the class </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.340.1">object</span></span></span></span><span class="kobospan" id="kobo.341.1">. </span><span class="kobospan" id="kobo.341.2">If multiple inheritance is being used, there can be a large number of paths through the super class definitions. </span><span class="kobospan" id="kobo.341.3">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.342.1">isinstance()</span></span></span></span><span class="kobospan" id="kobo.343.1"> function examines all the alternative parent classes.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.344.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.345.1">isinstance()</span></span></span></span><span class="kobospan" id="kobo.346.1"> function is aware of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.347.1">TypeAlias</span></span></span></span><span class="kobospan" id="kobo.348.1"> names in addition to the classes imported and defined within the application. </span><span class="kobospan" id="kobo.348.2">This gives us a great deal of flexibility to use meaning names in type hints.</span></p>
<div class="tipbox" id="tcolobox-22">
<div class="note">
<p class="normal1"><span class="kobospan" id="kobo.349.1">In Python 3.12, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.350.1">TypeAlias</span></span></span></span><span class="kobospan" id="kobo.351.1"> construct can be replaced with the new </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.352.1">type</span></span></span></span><span class="kobospan" id="kobo.353.1"> statement:</span></p>
<pre class="programlisting" id="listing-53"><code class="calibre13"><span class="kobospan" id="kobo.354.1">type Unreferenced = Path</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.355.1">See </span><a href="https://github.com/python/mypy/issues/15238" class="url"><span class="kobospan" id="kobo.356.1">Mypy Issue #15238</span></a><span class="kobospan" id="kobo.357.1"> for more information on support for the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.358.1">type</span></span></span></span><span class="kobospan" id="kobo.359.1"> statement by the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.360.1">mypy </span></span><span class="kobospan" id="kobo.361.1">tool.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.362.1">Until this is resolved, we’ve elected to use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.363.1">TypeAlias</span></span></span></span><span class="kobospan" id="kobo.364.1"> in this book.</span></p>
</div>
</div>
<p class="normal1"><span id="x1-585003r1236"/></p>
</section>
<section data-number="0.13.2.4" id="theres-more...-72">
<h2 class="likechapterhead" data-number="0.13.2.4"><span><span class="kobospan" id="kobo.365.1">10.2.4 </span></span> <span id="x1-5860004"/><span class="kobospan" id="kobo.366.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.367.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.368.1">isinstance()</span></span></span></span><span class="kobospan" id="kobo.369.1"> function is the kind of Boolean</span><span id="dx1-586001"/><span class="kobospan" id="kobo.370.1"> function that works well with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.371.1">filter()</span></span></span></span><span class="kobospan" id="kobo.372.1"> higher-order function. </span><span class="kobospan" id="kobo.372.2">For more information, see the </span><a href="ch013_split_000.xhtml#x1-5270004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.373.1">Picking a</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.374.1">subset – three ways to filter</span></span></a><span class="kobospan" id="kobo.375.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.376.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.377.1"> </span></span><a href="ch013_split_000.xhtml#x1-5020009" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.378.1">9</span></span></a><span class="kobospan" id="kobo.379.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.380.1">In addition to the built-in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.381.1">isinstance()</span></span></span></span><span class="kobospan" id="kobo.382.1"> to interrogate objects, there is also a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.383.1">issubclass()</span></span></span></span><span class="kobospan" id="kobo.384.1"> function that lets an application examine type definitions. </span><span class="kobospan" id="kobo.384.2">It’s important to distinguish between instances of a class and a class object; the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.385.1">issubclass()</span></span></span></span><span class="kobospan" id="kobo.386.1"> function is used to examine type definitions. </span><span class="kobospan" id="kobo.386.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.387.1">issubclass()</span></span></span></span><span class="kobospan" id="kobo.388.1"> function is often used for </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.389.1">metaprogramming</span></span><span class="kobospan" id="kobo.390.1">: software that’s concerned with software rather than the application data. </span><span class="kobospan" id="kobo.390.2">When designing functions that work with types of objects, rather than objects, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.391.1">issubclass()</span></span></span></span><span class="kobospan" id="kobo.392.1"> function is necessary.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.393.1">When examining the type of objects, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.394.1">match</span></span></span></span><span class="kobospan" id="kobo.395.1"> statement is often a better choice than the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.396.1">isinstance()</span></span></span></span><span class="kobospan" id="kobo.397.1"> function. </span><span class="kobospan" id="kobo.397.2">The reason is that a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.398.1">match</span></span></span></span><span class="kobospan" id="kobo.399.1"> statement’s </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.400.1">case</span></span></span></span><span class="kobospan" id="kobo.401.1"> clause has very sophisticated type pattern matching, where the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.402.1">isinstance()</span></span></span></span><span class="kobospan" id="kobo.403.1"> function is limited to ensuring the object has a given class (or a class in a tuple of classes) in its parents. </span><span id="x1-586002r1237"/></p>
</section>
<section data-number="0.13.2.5" id="see-also-79">
<h2 class="likechapterhead" data-number="0.13.2.5"><span><span class="kobospan" id="kobo.404.1">10.2.5 </span></span> <span id="x1-5870005"/><span class="kobospan" id="kobo.405.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.406.1">See the </span><a href="ch014.xhtml#x1-5880003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.407.1">Using the match statement</span></span></a><span class="kobospan" id="kobo.408.1"> recipe for an alternative to this, using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.409.1">match</span></span></span></span><span class="kobospan" id="kobo.410.1"> statement.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.411.1">See </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.412.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.413.1"> </span></span><a href="ch011_split_000.xhtml#x1-3760007" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.414.1">7</span></span></a><span class="kobospan" id="kobo.415.1"> and </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.416.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.417.1"> </span></span><a href="ch012.xhtml#x1-4520008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.418.1">8</span></span></a><span class="kobospan" id="kobo.419.1"> for several recipes related to playing cards and the interesting class hierarchies they involve.</span></p></li>
</ul>
<p class="normal1"><span id="x1-587001r1227"/></p>
</section>
</section>
<section data-number="0.13.3" id="using-the-match-statement">
<h1 class="unnumbered" data-number="0.13.3"><span><span class="kobospan" id="kobo.420.1">10.3 </span></span> <span id="x1-5880003"/><span class="kobospan" id="kobo.421.1">Using the match statement</span></h1>
<p class="normal"><span class="kobospan" id="kobo.422.1">One important reason for defining</span><span id="dx1-588001"/><span class="kobospan" id="kobo.423.1"> a collection of closely-related types is to distinguish the processing that applies to the objects. </span><span class="kobospan" id="kobo.423.2">One technique for providing distinct behavior is by using a </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.424.1">polymorphic </span></span><span class="kobospan" id="kobo.425.1">design: a number of subclasses provide distinct implementations of a common function. </span><span class="kobospan" id="kobo.425.2">When working entirely with our own classes, we can design them to have common methods and attributes, but offer distinct behavior depending on which of the subclasses is involved. </span><span class="kobospan" id="kobo.425.3">This is covered in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.426.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.427.1"> </span></span><a href="ch012.xhtml#x1-4520008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.428.1">8</span></span></a><span class="kobospan" id="kobo.429.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.430.1">This is not generally possible when working with Python’s internal objects, or when working with collections of data that involve a mixture of classes we’ve defined, and built-in classes that are part of Python. </span><span class="kobospan" id="kobo.430.2">In these cases, it’s simpler to rely on type matching to implement distinct behaviors. </span><span class="kobospan" id="kobo.430.3">One approach was shown in the </span><a href="ch014.xhtml#x1-5820002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.431.1">Using the built-in type matching functions</span></span></a><span class="kobospan" id="kobo.432.1"> recipe in this chapter.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.433.1">We can also use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.434.1">match</span></span></span></span><span class="kobospan" id="kobo.435.1"> statement to write functions and methods that are flexible and work with argument values of a variety of types. </span><span class="kobospan" id="kobo.435.2">For the recipe, we’ll reuse the processing from the </span><a href="ch014.xhtml#x1-5740001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.436.1">Designing with type hints</span></span></a><span class="kobospan" id="kobo.437.1"> and </span><a href="ch014.xhtml#x1-5820002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.438.1">Using the built-in type matching functions</span></span></a><span class="kobospan" id="kobo.439.1"> recipes earlier in this chapter. </span><span id="x1-588002r1238"/></p>
<section data-number="0.13.3.1" id="getting-ready-81">
<h2 class="likechapterhead" data-number="0.13.3.1"><span><span class="kobospan" id="kobo.440.1">10.3.1 </span></span> <span id="x1-5890001"/><span class="kobospan" id="kobo.441.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.442.1">In the </span><a href="ch014.xhtml#x1-5740001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.443.1">Designing with type hints</span></span></a><span class="kobospan" id="kobo.444.1"> recipe, we defined a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.445.1">datafile_iter()</span></span></span></span><span class="kobospan" id="kobo.446.1"> function that emitted two distinct types of objects: </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.447.1">Path</span></span></span></span><span class="kobospan" id="kobo.448.1"> objects and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.449.1">Referenced</span></span></span></span><span class="kobospan" id="kobo.450.1"> objects.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.451.1">We need to process these two classes of objects in distinct ways. </span><span class="kobospan" id="kobo.451.2">This mixture means an application must filter them by their type. </span><span id="x1-589001r1240"/></p>
</section>
<section data-number="0.13.3.2" id="how-to-do-it...-82">
<h2 class="likechapterhead" data-number="0.13.3.2"><span><span class="kobospan" id="kobo.452.1">10.3.2 </span></span> <span id="x1-5900002"/><span class="kobospan" id="kobo.453.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.454.1">The application will work with a sequence of objects of distinct types. </span><span class="kobospan" id="kobo.454.2">The function is designed as follows:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-590002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.455.1">Start with a definition like the following that shows the types consumed:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.456.1">from collections.abc import Iterable 
 
 
 
def analysis(source: Iterable[Unreferenced | Referenced]) -&gt; None:</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.457.1">This function will consume an iterable sequence of objects. </span><span class="kobospan" id="kobo.457.2">This function will count the ones that have references. </span><span class="kobospan" id="kobo.457.3">It will suggest deleting the files with no references.</span></p>
</div></li>
<li class="calibre7"><div id="x1-590008x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.458.1">Create an empty list</span><span id="dx1-590009"/><span class="kobospan" id="kobo.459.1"> that will hold the data files that have references. </span><span class="kobospan" id="kobo.459.2">Write the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.460.1">for</span></span></span></span><span class="kobospan" id="kobo.461.1"> statement to consume objects from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.462.1">source</span></span></span></span><span class="kobospan" id="kobo.463.1"> iterable:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.464.1">    good_files: list[Referenced] = [] 
 
    for file in source:</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-590014x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.465.1">Write the start of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.466.1">match</span></span></span></span><span class="kobospan" id="kobo.467.1"> statement with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.468.1">file</span></span></span></span><span class="kobospan" id="kobo.469.1"> variable:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.470.1">        match file:</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-590018x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.471.1">To process a file of the various classes, create </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.472.1">case</span></span></span></span><span class="kobospan" id="kobo.473.1"> statements that show the kinds of objects that must be matched. </span><span class="kobospan" id="kobo.473.2">These cases are indented within the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.474.1">match</span></span></span></span><span class="kobospan" id="kobo.475.1"> statement:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.476.1">            case Unreferenced() as unref: 
 
                print(f"delete {unref}") 
 
            case Referenced() as ref: 
 
                good_files.append(file)                                                                </span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-590025x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.477.1">While it’s technically unnecessary, it always seems prudent to include a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.478.1">case</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.479.1"> _:</span></span></span></span><span class="kobospan" id="kobo.480.1"> condition. </span><span class="kobospan" id="kobo.480.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.481.1">_</span></span></span></span><span class="kobospan" id="kobo.482.1"> will match anything. </span><span class="kobospan" id="kobo.482.2">The body of this clause can raise an exception in the unlikely event that the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.483.1">datafile_iter</span></span></span></span><span class="kobospan" id="kobo.484.1"> function was changed in some astonishing way:</span></p>
<pre class="programlistingcode"><code class="calibre13"><span class="kobospan" id="kobo.485.1">            case _: 
 
                raise ValueError(f"unexpected type {type(file)}")</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.486.1">For more about this design pattern, see the </span><a href="ch006_split_000.xhtml#x1-1170005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.487.1">Designing complex if...elif</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.488.1">chains</span></span></a><span class="kobospan" id="kobo.489.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.490.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.491.1"> </span></span><a href="ch006_split_000.xhtml#x1-840002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.492.1">2</span></span></a><span class="kobospan" id="kobo.493.1">.</span></p>
</div></li>
<li class="calibre7"><div id="x1-590030x6" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.494.1">Write the final summary:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.495.1">    print(f"Keep {len(good_files)} files")</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span id="x1-590033r1241"/></p>
</section>
<section data-number="0.13.3.3" id="how-it-works...-82">
<h2 class="likechapterhead" data-number="0.13.3.3"><span><span class="kobospan" id="kobo.496.1">10.3.3 </span></span> <span id="x1-5910003"/><span class="kobospan" id="kobo.497.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.498.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.499.1">match</span></span></span></span><span class="kobospan" id="kobo.500.1"> statement uses a sequence of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.501.1">case</span></span></span></span><span class="kobospan" id="kobo.502.1"> clauses to establish a class that matches the given object. </span><span class="kobospan" id="kobo.502.2">While there are a wide variety of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.503.1">case</span></span></span></span><span class="kobospan" id="kobo.504.1"> clauses, one common case is the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.505.1">case</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.506.1"> class()</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.507.1"> as</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.508.1"> name:</span></span></span></span><span class="kobospan" id="kobo.509.1"> variant, called</span><span id="dx1-591001"/><span class="kobospan" id="kobo.510.1"> the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.511.1">class pattern</span></span><span class="kobospan" id="kobo.512.1">. </span><span class="kobospan" id="kobo.512.2">Within </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.513.1">()</span></span></span></span><span class="kobospan" id="kobo.514.1">, we can provide sub-patterns to match objects with specific kinds of parameters.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.515.1">For this example, we didn’t need the more sophisticated</span><span id="dx1-591002"/><span class="kobospan" id="kobo.516.1"> matching patterns. </span><span class="kobospan" id="kobo.516.2">We can provide what looks like an instance – made from the class name and</span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.517.1">()</span></span></span></span><span class="kobospan" id="kobo.518.1"> – to show that the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.519.1">case</span></span></span></span><span class="kobospan" id="kobo.520.1"> clause will match an instance of the class. </span><span class="kobospan" id="kobo.520.2">No additional detail regarding the structure of the instance is necessary.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.521.1">The use of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.522.1">case</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.523.1"> Unreferenced()</span></span></span></span><span class="kobospan" id="kobo.524.1"> almost looks as if the expression </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.525.1">Unreferenced()</span></span></span></span><span class="kobospan" id="kobo.526.1"> will create an instance of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.527.1">Unreferenced</span></span></span></span><span class="kobospan" id="kobo.528.1"> class. </span><span class="kobospan" id="kobo.528.2">The intent here is not to create an object, but to write an expression that looks very much like object creation. </span><span class="kobospan" id="kobo.528.3">This syntax helps to clarify the intent of using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.529.1">case</span></span></span></span><span class="kobospan" id="kobo.530.1"> to match any object of the named class.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.531.1">Other patterns are available that allow matching simple literal values, sequences, and mappings, as well as classes. </span><span class="kobospan" id="kobo.531.2">Further, there are ways to provide groups of alternatives, and even apply additional filtering via a guard condition that’s used in conjunction with the pattern matching.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.532.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.533.1">case</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.534.1"> _</span></span></span></span><span class="kobospan" id="kobo.535.1"> clause is a wildcard clause. </span><span class="kobospan" id="kobo.535.2">It will match anything provided in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.536.1">match</span></span></span></span><span class="kobospan" id="kobo.537.1"> statement. </span><span class="kobospan" id="kobo.537.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.538.1">_</span></span></span></span><span class="kobospan" id="kobo.539.1"> variable name has special significance here, and only this variable can be used.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.540.1">Central to this design is the clarity of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.541.1">case</span></span></span></span><span class="kobospan" id="kobo.542.1"> definitions. </span><span class="kobospan" id="kobo.542.2">These are much more readable than </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.543.1">isinstance()</span></span></span></span><span class="kobospan" id="kobo.544.1"> function evaluation in a series of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.545.1">elif</span></span></span></span><span class="kobospan" id="kobo.546.1"> clauses. </span><span id="x1-591003r1248"/></p>
</section>
<section data-number="0.13.3.4" id="theres-more...-73">
<h2 class="likechapterhead" data-number="0.13.3.4"><span><span class="kobospan" id="kobo.547.1">10.3.4 </span></span> <span id="x1-5920004"/><span class="kobospan" id="kobo.548.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.549.1">We’ll extend this recipe to show some of the sophisticated type matching available in these </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.550.1">case</span></span></span></span><span class="kobospan" id="kobo.551.1"> clauses. </span><span class="kobospan" id="kobo.551.2">Consider the case where we want to separate a referenced file that has only a single item in the list of applications that refer to it.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.552.1">We’re looking for objects that look like this specific example:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.553.1">single use: Referenced(datafile=PosixPath(’race_result.json’), recipes=[PosixPath(’ch11/recipe_06.py’)])</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.554.1">This case can be summarized as </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.555.1">Referenced(_,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.556.1"> [Path()])</span></span></span></span><span class="kobospan" id="kobo.557.1">. </span><span class="kobospan" id="kobo.557.2">We want to match an instance of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.558.1">Referenced</span></span></span></span><span class="kobospan" id="kobo.559.1"> class where the second parameter is a list with a single </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.560.1">Path</span></span></span></span><span class="kobospan" id="kobo.561.1"> instance.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.562.1">This turns into a new </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.563.1">case</span></span></span></span><span class="kobospan" id="kobo.564.1"> clause. </span><span class="kobospan" id="kobo.564.2">Here’s the new, more specific case, followed by the more general case:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.565.1">
            case Referenced(_, [Path()]) as single: 
 
                print(f"single use: {single}") 
 
                good_files.append(single) 
 
            case Referenced() as multiple: 
 
                good_files.append(multiple)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.566.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.567.1">match</span></span></span></span><span class="kobospan" id="kobo.568.1"> statement works through the cases in order. </span><span class="kobospan" id="kobo.568.2">The more-specific cases </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.569.1">must </span></span><span class="kobospan" id="kobo.570.1">precede the less-specific cases. </span><span class="kobospan" id="kobo.570.2">If we flip the order of these two cases, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.571.1">case</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.572.1"> Referenced()</span></span></span></span><span class="kobospan" id="kobo.573.1"> would match before </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.574.1">case</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.575.1"> Referenced(_,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.576.1"> [Path()])</span></span></span></span><span class="kobospan" id="kobo.577.1"> would even be examined. </span><span class="kobospan" id="kobo.577.2">The most general case, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.578.1">case</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.579.1"> _:</span></span></span></span><span class="kobospan" id="kobo.580.1"> must be last. </span><span id="x1-592009r1249"/></p>
</section>
<section data-number="0.13.3.5" id="see-also-80">
<h2 class="likechapterhead" data-number="0.13.3.5"><span><span class="kobospan" id="kobo.581.1">10.3.5 </span></span> <span id="x1-5930005"/><span class="kobospan" id="kobo.582.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.583.1">See the </span><a href="ch014.xhtml#x1-5820002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.584.1">Using the built-in type matching functions</span></span></a><span class="kobospan" id="kobo.585.1"> recipe for an alternative approach using the built-in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.586.1">isinstance()</span></span></span></span><span class="kobospan" id="kobo.587.1"> function.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.588.1">See </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.589.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.590.1"> </span></span><a href="ch012.xhtml#x1-4520008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.591.1">8</span></span></a><span class="kobospan" id="kobo.592.1"> for several recipes related to polymorphic class design. </span><span class="kobospan" id="kobo.592.2">Sometimes, this can reduce the need for type matching.</span></p></li>
</ul>
<p class="normal1"><span id="x1-593001r1239"/></p>
</section>
</section>
<section data-number="0.13.4" id="handling-type-conversions">
<h1 class="unnumbered" data-number="0.13.4"><span><span class="kobospan" id="kobo.593.1">10.4 </span></span> <span id="x1-5940004"/><span class="kobospan" id="kobo.594.1">Handling type conversions</span></h1>
<p class="normal"><span class="kobospan" id="kobo.595.1">One of the useful features of Python</span><span id="dx1-594001"/><span class="kobospan" id="kobo.596.1"> is the ”numeric tower” idea. </span><span class="kobospan" id="kobo.596.2">See </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.597.1">The</span></span> <span class="cmbx-10x-x"><span class="kobospan" id="kobo.598.1">Numeric Tower </span></span><span class="kobospan" id="kobo.599.1">in</span><span id="dx1-594002"/><span class="kobospan" id="kobo.600.1"> the Python standard library documentation. </span><span class="kobospan" id="kobo.600.2">The idea is that numeric values can move ”up” the tower from integral to rational to real to complex.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.601.1">The numeric conversions are based on the idea that there are a several overlapping domains of numbers. </span><span class="kobospan" id="kobo.601.2">These include </span><span><span class="kobospan" id="kobo.602.1">ℤ </span></span><span class="kobospan" id="kobo.603.1">integers, </span><span><span class="kobospan" id="kobo.604.1">ℚ </span></span><span class="kobospan" id="kobo.605.1">rational numbers, </span><span><span class="kobospan" id="kobo.606.1">ℙ</span></span><span class="kobospan" id="kobo.607.1"> irrational numbers, </span><span><span class="kobospan" id="kobo.608.1">ℝ </span></span><span class="kobospan" id="kobo.609.1">real numbers, and </span><span><span class="kobospan" id="kobo.610.1">ℂ </span></span><span class="kobospan" id="kobo.611.1">complex numbers. </span><span class="kobospan" id="kobo.611.2">The idea is that these form a nested series of sets: </span><span><span class="kobospan" id="kobo.612.1">ℤ </span></span><span><span class="kobospan" id="kobo.613.1">⊂</span></span><span><span class="kobospan" id="kobo.614.1">ℚ </span></span><span><span class="kobospan" id="kobo.615.1">⊂</span></span><span><span class="kobospan" id="kobo.616.1">ℝ </span></span><span><span class="kobospan" id="kobo.617.1">⊂</span></span><span><span class="kobospan" id="kobo.618.1">ℂ</span></span><span class="kobospan" id="kobo.619.1">. </span><span class="kobospan" id="kobo.619.2">Also, </span><span><span class="kobospan" id="kobo.620.1">ℚ </span></span><span><span class="kobospan" id="kobo.621.1">∪</span></span><span><span class="kobospan" id="kobo.622.1">ℙ </span></span><span class="kobospan" id="kobo.623.1">= </span><span><span class="kobospan" id="kobo.624.1">ℝ</span></span><span class="kobospan" id="kobo.625.1">: the real numbers include rational and irrational numbers.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.626.1">These built-in numeric types follow the abstract concepts:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span><span class="kobospan" id="kobo.627.1">ℂ </span></span><span class="kobospan" id="kobo.628.1">is implemented by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.629.1">complex</span></span></span></span><span class="kobospan" id="kobo.630.1"> type. </span><span class="kobospan" id="kobo.630.2">Any of the types below this type can be converted to a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.631.1">complex</span></span></span></span><span class="kobospan" id="kobo.632.1"> value.</span></p></li>
<li class="calibre7"><p class="normal2"><span><span class="kobospan" id="kobo.633.1">ℝ </span></span><span class="kobospan" id="kobo.634.1">is supported by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.635.1">float</span></span></span></span><span class="kobospan" id="kobo.636.1"> type. </span><span class="kobospan" id="kobo.636.2">It’s important to note that </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.637.1">float</span></span></span></span><span class="kobospan" id="kobo.638.1"> involves approximations, and doesn’t fully match the mathematical ideal of real numbers. </span><span class="kobospan" id="kobo.638.2">When an operator in this class encounters </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.639.1">int</span></span></span></span><span class="kobospan" id="kobo.640.1"> or </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.641.1">fraction</span></span></span></span><span class="kobospan" id="kobo.642.1"> values, it will create the equivalent </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.643.1">float</span></span></span></span><span class="kobospan" id="kobo.644.1"> value.</span></p></li>
<li class="calibre7"><p class="normal2"><span><span class="kobospan" id="kobo.645.1">ℚ </span></span><span class="kobospan" id="kobo.646.1">uses the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.647.1">Fraction</span></span></span></span><span class="kobospan" id="kobo.648.1"> class in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.649.1">fractions</span></span></span></span><span class="kobospan" id="kobo.650.1"> module. </span><span class="kobospan" id="kobo.650.2">When an arithmetic operator in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.651.1">Fraction</span></span></span></span><span class="kobospan" id="kobo.652.1"> class encounters an </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.653.1">int</span></span></span></span><span class="kobospan" id="kobo.654.1"> it will quietly create a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.655.1">Fraction</span></span></span></span><span class="kobospan" id="kobo.656.1"> with the same value as the integer. </span><span class="kobospan" id="kobo.657.1"><img alt="z 1" class="calibre9" data-align="middle" src="../media/file73.png"/></span><span class="kobospan" id="kobo.658.1"> = </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.659.1">z</span></span><span class="kobospan" id="kobo.660.1">.</span></p></li>
<li class="calibre7"><p class="normal2"><span><span class="kobospan" id="kobo.661.1">ℤ </span></span><span class="kobospan" id="kobo.662.1">is the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.663.1">int</span></span></span></span><span class="kobospan" id="kobo.664.1"> class.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.665.1">Generally, the Python language avoids too many conversions to other types. </span><span class="kobospan" id="kobo.665.2">Strings, for example, are not automatically parsed to create numeric values. </span><span class="kobospan" id="kobo.665.3">An explicit built-in function like </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.666.1">int()</span></span></span></span><span class="kobospan" id="kobo.667.1"> or </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.668.1">float()</span></span></span></span><span class="kobospan" id="kobo.669.1"> needs to be used to process strings with numbers.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.670.1">We’ll often want our own types to share this kind of behavior. </span><span class="kobospan" id="kobo.670.2">We’d like our functions to be flexible, and convert objects to other types when needed. </span><span class="kobospan" id="kobo.670.3">We may, for example, want to permit a number of representations for a latitude-longitude point. </span><span class="kobospan" id="kobo.670.4">These alternatives might include:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.671.1">A tuple of two floating-point numeric values</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.672.1">A pair of strings, with each string representing a floating-point value</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.673.1">A single string with two numeric values separated by a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.674.1">","</span></span></span></span><span class="kobospan" id="kobo.675.1"> character</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.676.1">As with the numeric</span><span id="dx1-594003"/><span class="kobospan" id="kobo.677.1"> tower, our own class definitions need to convert other types into the needed target type. </span><span id="x1-594004r1252"/></p>
<section data-number="0.13.4.1" id="getting-ready-82">
<h2 class="likechapterhead" data-number="0.13.4.1"><span><span class="kobospan" id="kobo.678.1">10.4.1 </span></span> <span id="x1-5950001"/><span class="kobospan" id="kobo.679.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.680.1">We’ll consider a function to compute</span><span id="dx1-595001"/><span class="kobospan" id="kobo.681.1"> distances between points on the surface of the Earth. </span><span class="kobospan" id="kobo.681.2">This involves some clever spherical trigonometry. </span><span class="kobospan" id="kobo.681.3">For more information, see </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.682.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.683.1"> </span></span><a href="ch007_split_000.xhtml#x1-1610003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.684.1">3</span></span></a><span class="kobospan" id="kobo.685.1">, specifically, the </span><a href="ch007_split_001.xhtml#x1-1940006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.686.1">Picking an order for parameters</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.687.1">based on partial functions</span></span></a><span class="kobospan" id="kobo.688.1"> recipe. </span><span class="kobospan" id="kobo.688.2">Also see the </span><a href="ch011_split_001.xhtml#x1-43700011" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.689.1">Creating contexts and context</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.690.1">managers</span></span></a><span class="kobospan" id="kobo.691.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.692.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.693.1"> </span></span><a href="ch011_split_000.xhtml#x1-3760007" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.694.1">7</span></span></a><span class="kobospan" id="kobo.695.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.696.1">The function is defined as:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.697.1">def haversine( 
 
    lat_1: float, lon_1: float, 
 
    lat_2: float, lon_2: float, *, R: float) -&gt; float: 
 
 
 
    ... </span><span class="kobospan" id="kobo.697.2"> # etc.</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.698.1">This definition requires converting source data into individual float values. </span><span class="kobospan" id="kobo.698.2">In applications that integrate data from a number of sources, these conversions are so common that it seems better to centralize them into a function that wraps the essential </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.699.1">haversine()</span></span></span></span><span class="kobospan" id="kobo.700.1"> computation.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.701.1">We want a function like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.702.1">def distance( 
 
    *args: str | float | tuple[float, float], 
 
    R: float = NM 
 
) -&gt; float:</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.703.1">This function will compute distances among points defined as a variety of data types. </span><span class="kobospan" id="kobo.703.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.704.1">*args</span></span></span></span><span class="kobospan" id="kobo.705.1"> parameter means all of the positional argument values will be combined into a single tuple. </span><span class="kobospan" id="kobo.705.2">A number of validation rules must be applied to make sense of this tuple. </span><span class="kobospan" id="kobo.705.3">Here are the rules we’ll start with: Four float values: use these directly. </span><span class="kobospan" id="kobo.705.4">Example: </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.706.1">distance(36.12,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.707.1"> -86.67,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.708.1"> 33.94,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.709.1"> -118.40,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.710.1"> R=6372.8)</span></span></span></span><span class="kobospan" id="kobo.711.1">. </span><span class="kobospan" id="kobo.711.2">Four strings: convert these to float. </span><span class="kobospan" id="kobo.711.3">Example: </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.712.1">distance("36.12",</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.713.1"> "-86.67",</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.714.1"> "33.94",</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.715.1"> "-118.40",</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.716.1"> R=6372.8)</span></span></span></span><span class="kobospan" id="kobo.717.1">. </span><span class="kobospan" id="kobo.717.2">two strings: parse each string, breaking on a ”,”. </span><span class="kobospan" id="kobo.717.3">Each string should have two float values. </span><span class="kobospan" id="kobo.717.4">Example: </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.718.1">distance("36.12,-86.67",</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.719.1"> "33.94,-118.40",</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.720.1"> R=6372.8)</span></span></span></span><span class="kobospan" id="kobo.721.1">. </span><span class="kobospan" id="kobo.721.2">Two tuples: unpack each tuple to make sure it has two float values. </span><span class="kobospan" id="kobo.721.3">Example: </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.722.1">distance((36.12,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.723.1"> -86.67),</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.724.1"> (33.94,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.725.1"> -118.40),</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.726.1"> R=6372.8)</span></span></span></span><span class="kobospan" id="kobo.727.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.728.1">Ideally, it might be nice to support combinations of these, also. </span><span class="kobospan" id="kobo.728.2">We’ll design a function that performs the needed type conversions. </span><span id="x1-595013r1254"/></p>
</section>
<section data-number="0.13.4.2" id="how-to-do-it...-83">
<h2 class="likechapterhead" data-number="0.13.4.2"><span><span class="kobospan" id="kobo.729.1">10.4.2 </span></span> <span id="x1-5960002"/><span class="kobospan" id="kobo.730.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.731.1">A function that includes type conversions</span><span id="dx1-596001"/><span class="kobospan" id="kobo.732.1"> is often built separately from the underlying processing. </span><span class="kobospan" id="kobo.732.2">It can help testing and debugging if these two aspects of processing – conversions and computations – are separated:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-596003x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.733.1">Import the needed </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.734.1">literal_eval()</span></span></span></span><span class="kobospan" id="kobo.735.1"> function to do the conversions of strings that are expected to be Python literals:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.736.1">from ast import literal_eval</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.737.1">With this function, we can evaluate </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.738.1">literal_eval("2,3")</span></span></span></span><span class="kobospan" id="kobo.739.1"> to get a result of a proper tuple, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.740.1">(2,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.741.1"> 3)</span></span></span></span><span class="kobospan" id="kobo.742.1">. </span><span class="kobospan" id="kobo.742.2">We don’t need to use a regular expression to decompose the string to see the pattern of the text.</span></p>
</div></li>
<li class="calibre7"><div id="x1-596007x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.743.1">Define the distance function that performs conversions:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.744.1">def distance( 
 
    *args: str | float | tuple[float, float], 
 
    R: float = NM 
 
) -&gt; float:</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-596014x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.745.1">Start the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.746.1">match</span></span></span></span><span class="kobospan" id="kobo.747.1"> statement for the various kinds of argument patterns.</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.748.1">    match args:</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-596018x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.749.1">Write the individual cases, moving from more specific to less specific. </span><span class="kobospan" id="kobo.749.2">Start with four distinct float values, since no conversion needs to be done. </span><span class="kobospan" id="kobo.749.3">The tuple of float values has a more complex type structure, but doesn’t require any conversion.</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.750.1">        case [float(lat_1), float(lon_1), float(lat_2), float(lon_2)]: 
 
            pass 
 
        case ( 
 
            [[float(lat_1), float(lon_1)], 
 
             [float(lat_2), float(lon_2)]] 
 
        ): 
 
            pass</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.751.1">We’ve provided the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.752.1">lat_1</span></span></span></span><span class="kobospan" id="kobo.753.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.754.1">lon_1</span></span></span></span><span class="kobospan" id="kobo.755.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.756.1">lat_2</span></span></span></span><span class="kobospan" id="kobo.757.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.758.1">on_2</span></span></span></span><span class="kobospan" id="kobo.759.1"> variables</span><span id="dx1-596027"/><span class="kobospan" id="kobo.760.1"> to bind the values from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.761.1">args</span></span></span></span><span class="kobospan" id="kobo.762.1"> structure to variable names. </span><span class="kobospan" id="kobo.762.2">This saves us from having to write assignment statements to unpack an argument tuple. </span><span class="kobospan" id="kobo.762.3">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.763.1">pass</span></span></span></span><span class="kobospan" id="kobo.764.1"> statement placeholder is used because no further processing is required beyond unpacking the data structure.</span></p>
</div></li>
<li class="calibre7"><div id="x1-596029x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.765.1">Write the cases that involve conversions of the supplied values:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.766.1">        case [str(s1), str(s2), str(s3), str(s4)]: 
 
            lat_1, lon_1, lat_2, lon_2 = ( 
 
                float(s1), float(s2), float(s3), float(s4) 
 
            ) 
 
        case [str(ll1), str(ll2)]: 
 
            lat_1, lon_1 = literal_eval(ll1) 
 
            lat_2, lon_2 = literal_eval(ll2)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.767.1">When the argument values are four strings, we provided four variables to unpack the four strings.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.768.1">When the argument pattern is two strings, we provided two variables, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.769.1">ll1</span></span></span></span><span class="kobospan" id="kobo.770.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.771.1">ll2</span></span></span></span><span class="kobospan" id="kobo.772.1">, that each needed to be converted into two tuples of numbers and then unpacked.</span></p>
</div></li>
<li class="calibre7"><div id="x1-596039x6" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.773.1">Write the default case that will match anything else and raise an exception:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.774.1">        case _: 
 
            raise ValueError(f"unexpected types in {args!r}")                                                                

                                                                     
     </span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-596044x7" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.775.1">Now that the arguments have been properly unpacked and any conversions applied, use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.776.1">haversine()</span></span></span></span><span class="kobospan" id="kobo.777.1"> function to compute the required result:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.778.1">    return haversine(lat_1, lon_1, lat_2, lon_2, R=R)</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span id="x1-596047r1257"/></p>
</section>
<section data-number="0.13.4.3" id="how-it-works...-83">
<h2 class="likechapterhead" data-number="0.13.4.3"><span><span class="kobospan" id="kobo.779.1">10.4.3 </span></span> <span id="x1-5970003"/><span class="kobospan" id="kobo.780.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.781.1">The essential feature for type conversions</span><span id="dx1-597001"/><span class="kobospan" id="kobo.782.1"> is using a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.783.1">match</span></span></span></span><span class="kobospan" id="kobo.784.1"> statement to provide appropriate conversions for the supported types. </span><span class="kobospan" id="kobo.784.2">In this example, we tolerated a mixture of strings and tuples that could be converted and unpacked to locate the required four argument values. </span><span class="kobospan" id="kobo.784.3">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.785.1">match</span></span></span></span><span class="kobospan" id="kobo.786.1"> statement has many clever type-matching rules. </span><span class="kobospan" id="kobo.786.2">For example, an expression like </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.787.1">((float(f1),</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.788.1"> float(f2)),</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.789.1"> (float(f3),</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.790.1"> float(f4)))</span></span></span></span><span class="kobospan" id="kobo.791.1"> will match two tuples, each with two float values. </span><span class="kobospan" id="kobo.791.2">Further, it unpacks the values from the tuples and assigns them to four variables.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.792.1">The mechanics of converting the values are also based on a built-in feature. </span><span class="kobospan" id="kobo.792.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.793.1">float()</span></span></span></span><span class="kobospan" id="kobo.794.1"> function converts numeric strings to float values or raises a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.795.1">ValueError</span></span></span></span><span class="kobospan" id="kobo.796.1"> exception.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.797.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.798.1">ast.literal_eval()</span></span></span></span><span class="kobospan" id="kobo.799.1"> function is very handy for evaluating strings that are Python literals. </span><span class="kobospan" id="kobo.799.2">The function is safe from evaluating dangerous expressions because it is limited to literal values, and a few simple data structures – tuples, lists, dicts, and sets – built from literal values. </span><span class="kobospan" id="kobo.799.3">It permits us to parse a string like </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.800.1">"36.12,-86.67"</span></span></span></span><span class="kobospan" id="kobo.801.1"> into </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.802.1">(36.12,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.803.1"> -86.67)</span></span></span></span><span class="kobospan" id="kobo.804.1"> directly. </span><span id="x1-597002r1265"/></p>
</section>
<section data-number="0.13.4.4" id="theres-more...-74">
<h2 class="likechapterhead" data-number="0.13.4.4"><span><span class="kobospan" id="kobo.805.1">10.4.4 </span></span> <span id="x1-5980004"/><span class="kobospan" id="kobo.806.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.807.1">The use of independent </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.808.1">case</span></span></span></span><span class="kobospan" id="kobo.809.1"> clauses makes it relatively easy to add additional type conversions. </span><span class="kobospan" id="kobo.809.2">We might, for example, want to handle a tuple of two dictionary structures that look like </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.810.1">{"lat":</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.811.1"> 36.12,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.812.1"> "lon":</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.813.1"> -86.67}</span></span></span></span><span class="kobospan" id="kobo.814.1">. </span><span class="kobospan" id="kobo.814.2">This can be matched with the following </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.815.1">case</span></span></span></span><span class="kobospan" id="kobo.816.1">:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.817.1">        case ( 
 
             {"lat": float(lat_1), "lon": float(lon_1)}, 
 
             {"lat": float(lat_2), "lon": float(lon_2)} 
 
        ): 
 
            pass</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.818.1">The argument tuple pattern has </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.819.1">()</span></span></span></span><span class="kobospan" id="kobo.820.1"> around it, making it easy to break it into multiple lines. </span><span class="kobospan" id="kobo.820.2">The four values extracted from the dictionaries will be bound to four target variables.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.821.1">If we want to permit more flexibility, we can consider the case where we have two argument values of a mixture of type patterns. </span><span class="kobospan" id="kobo.821.2">For example, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.822.1">distance("36.12,-86.67",</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.823.1"> (33.94,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.824.1"> -118.40),</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.825.1"> R=6372.8)</span></span></span></span><span class="kobospan" id="kobo.826.1">. </span><span class="kobospan" id="kobo.826.2">This has two distinct formats: a string and a tuple with a pair of float values.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.827.1">Rather than enumerate all of the possible combinations, we can decompose the parsing of a pair of values into a separate function, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.828.1">parse()</span></span></span></span><span class="kobospan" id="kobo.829.1">, that applies the same conversion to both argument values:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.830.1">        case [p_1, p_2]: 
 
            lat_1, lon_1 = parse(p_1) 
 
            lat_2, lon_2 = parse(p_2)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.831.1">This new </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.832.1">parse()</span></span></span></span><span class="kobospan" id="kobo.833.1"> function must handle</span><span id="dx1-598011"/><span class="kobospan" id="kobo.834.1"> all the cases where a latitude and longitude are provided together. </span><span class="kobospan" id="kobo.834.2">This includes strings, tuples, and mappings. </span><span class="kobospan" id="kobo.834.3">It looks like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.835.1">    def parse(item: Point | float) -&gt; tuple[float, float]: 
 
        match item: 
 
            case [float(lat), float(lon)]: 
 
                pass 
 
            case {"lat": float(lat), "lon": float(lon)}: 
 
                pass 
 
            case str(sll): 
 
                lat, lon = literal_eval(sll) 
 
            case _: 
 
                raise ValueError(f"unexpected types in {item!r}") 
 
        return lat, lon</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.836.1">This will slightly simplify the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.837.1">match</span></span></span></span><span class="kobospan" id="kobo.838.1"> statement in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.839.1">distance</span></span></span></span><span class="kobospan" id="kobo.840.1"> function. </span><span class="kobospan" id="kobo.840.2">The refactored statement only handles four cases:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.841.1">    match args: 
 
        case [float(lat_1), float(lon_1), float(lat_2), float(lon_2)]: 
 
            pass 
 
        case [str(s1), str(s2), str(s3), str(s4)]: 
 
            lat_1, lon_1, lat_2, lon_2 = float(s1), float(s2), float(s3), float(s4) 
 
        case [p_1, p_2]: 
 
            lat_1, lon_1 = parse(p_1) 
 
            lat_2, lon_2 = parse(p_2) 
 
        case _: 
 
            raise ValueError(f"unexpected types in {args!r}")</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.842.1">The first two cases handle the situation where four argument values are provided. </span><span class="kobospan" id="kobo.842.2">The third case looks at a pair of values, which can have any of the pair formats.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.843.1">We expressly avoid the case where three argument values are provided. </span><span class="kobospan" id="kobo.843.2">This requires a bit more care to interpret, since one of the three argument values must be a latitude and longitude pair. </span><span class="kobospan" id="kobo.843.3">The other two values must be separated latitude and longitude values. </span><span class="kobospan" id="kobo.843.4">The logic is not overwhelmingly complicated, but the details stray from the central idea of this recipe.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.844.1">While the recipe focuses on built-in types including </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.845.1">str</span></span></span></span><span class="kobospan" id="kobo.846.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.847.1">float</span></span></span></span><span class="kobospan" id="kobo.848.1">, any type can be used. </span><span class="kobospan" id="kobo.848.2">A customized </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.849.1">Leg</span></span></span></span><span class="kobospan" id="kobo.850.1"> type, for example, with start and stop locations could easily be added in a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.851.1">case</span></span></span></span><span class="kobospan" id="kobo.852.1"> clause. </span><span id="x1-598035r1266"/></p>
</section>
<section data-number="0.13.4.5" id="see-also-81">
<h2 class="likechapterhead" data-number="0.13.4.5"><span><span class="kobospan" id="kobo.853.1">10.4.5 </span></span> <span id="x1-5990005"/><span class="kobospan" id="kobo.854.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.855.1">For more information on numbers and conversions, see the </span><a href="ch005_split_000.xhtml#x1-180001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.856.1">Choosing</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.857.1">between float, decimal, and fraction</span></span></a><span class="kobospan" id="kobo.858.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.859.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.860.1"> </span></span><a href="ch005_split_000.xhtml#x1-170001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.861.1">1</span></span></a><span class="kobospan" id="kobo.862.1">. </span><span class="kobospan" id="kobo.862.2">This provides some more information about the limitations of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.863.1">float</span></span></span></span><span class="kobospan" id="kobo.864.1"> approximation.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.865.1">For more information on the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.866.1">haversine()</span></span></span></span><span class="kobospan" id="kobo.867.1"> function, see the </span><a href="ch007_split_001.xhtml#x1-1940006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.868.1">Picking</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.869.1">an order for parameters based on partial functions</span></span></a><span class="kobospan" id="kobo.870.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.871.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.872.1"> </span></span><a href="ch007_split_000.xhtml#x1-1610003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.873.1">3</span></span></a><span class="kobospan" id="kobo.874.1">. </span><span class="kobospan" id="kobo.874.2">Also see the </span><a href="ch011_split_001.xhtml#x1-43700011" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.875.1">Creating contexts and context managers</span></span></a><span class="kobospan" id="kobo.876.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.877.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.878.1"> </span></span><a href="ch011_split_000.xhtml#x1-3760007" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.879.1">7</span></span></a><span class="kobospan" id="kobo.880.1">.</span></p></li>
</ul>
<p class="normal1"><span id="x1-599001r1253"/></p>
</section>
</section>
<section data-number="0.13.5" id="implementing-more-strict-type-checks-with-pydantic">
<h1 class="unnumbered" data-number="0.13.5"><span><span class="kobospan" id="kobo.881.1">10.5 </span></span> <span id="x1-6000005"/><span class="kobospan" id="kobo.882.1">Implementing more strict type checks with Pydantic</span></h1>
<p class="normal"><span class="kobospan" id="kobo.883.1">For the most part, Python’s internal</span><span id="dx1-600001"/><span class="kobospan" id="kobo.884.1"> processing will handle</span><span id="dx1-600002"/><span class="kobospan" id="kobo.885.1"> a great many simple validity checks properly. </span><span class="kobospan" id="kobo.885.2">If we’ve written a function to convert a string to float, the function will work with float values and string values. </span><span class="kobospan" id="kobo.885.3">It will raise a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.886.1">ValueError</span></span></span></span><span class="kobospan" id="kobo.887.1"> exception if we try to apply the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.888.1">float()</span></span></span></span><span class="kobospan" id="kobo.889.1"> function to a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.890.1">Path</span></span></span></span><span class="kobospan" id="kobo.891.1"> object.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.892.1">In order for type hints to be optional, run-time type-checking is the minimum level of checking required to make sure some processing can proceed. </span><span class="kobospan" id="kobo.892.2">This is emphatically distinct from the strict checks that tools like </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.893.1">mypy</span></span><span class="kobospan" id="kobo.894.1"> make.</span></p>
<div class="tipbox" id="tcolobox-23">
<div class="note">
<p class="normal1"><span class="kobospan" id="kobo.895.1">Type hints do no run-time processing.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.896.1">Python (without any add-on packages) does no data type checks or value range checks at run-time. </span><span class="kobospan" id="kobo.896.2">Exceptions are raised when an operator is confronted with a type it can’t process, without regard to the type hints.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.897.1">This means that Python may be able to process a type that was excluded by a hint. </span><span class="kobospan" id="kobo.897.2">It’s possible to write a narrow hint like </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.898.1">list[str]</span></span></span></span><span class="kobospan" id="kobo.899.1">. </span><span class="kobospan" id="kobo.899.2">An object of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.900.1">set[str]</span></span></span></span><span class="kobospan" id="kobo.901.1"> may also work with the given body of the function.</span></p>
</div>
</div>
<p class="normal1"><span class="kobospan" id="kobo.902.1">There are applications where we’d like stronger checks at run-time. </span><span class="kobospan" id="kobo.902.2">These are often helpful in applications where extensions or plug-ins are used, and we’d like to be sure the additional plug-in code behaves properly.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.903.1">One way to provide for run-time type</span><span id="dx1-600003"/><span class="kobospan" id="kobo.904.1"> checking is to use the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.905.1">Pydantic </span></span><span class="kobospan" id="kobo.906.1">package. </span><span class="kobospan" id="kobo.906.2">This module allows us to define complex</span><span id="dx1-600004"/><span class="kobospan" id="kobo.907.1"> objects that are accompanied by run-time type checking, as well as management of schema definitions that can be shared widely.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.908.1">In </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.909.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.910.1"> </span></span><a href="ch009.xhtml#x1-2890005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.911.1">5</span></span></a><span class="kobospan" id="kobo.912.1">, in the </span><a href="ch009.xhtml#x1-2900001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.913.1">Creating dictionaries – inserting and updating</span></span></a><span class="kobospan" id="kobo.914.1"> recipe, we looked at a log file that we needed to parse into a more useful structure. </span><span class="kobospan" id="kobo.914.2">In </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.915.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.916.1"> </span></span><a href="ch013_split_000.xhtml#x1-5020009" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.917.1">9</span></span></a><span class="kobospan" id="kobo.918.1">, in the </span><a href="ch013_split_000.xhtml#x1-5030001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.919.1">Writing generator functions with the yield statement</span></span></a><span class="kobospan" id="kobo.920.1"> recipe, we looked at writing a generator function that would parse and yield the parsed objects. </span><span class="kobospan" id="kobo.920.2">We called the resulting objects </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.921.1">RawLog</span></span></span></span><span class="kobospan" id="kobo.922.1">, with no type checks or type conversions. </span><span class="kobospan" id="kobo.922.2">We applied a simple transformation to create a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.923.1">DatedLog</span></span></span></span><span class="kobospan" id="kobo.924.1"> instance with the date-time stamp converted from text to a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.925.1">datetime.datetime</span></span></span></span><span class="kobospan" id="kobo.926.1"> object.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.927.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.928.1">pydantic</span></span></span></span><span class="kobospan" id="kobo.929.1"> package can handle some of this conversion to a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.930.1">DatedLog</span></span></span></span><span class="kobospan" id="kobo.931.1"> instance, saving us some programming. </span><span class="kobospan" id="kobo.931.2">Further, because the schema can be generated automatically, we can build a JSON Schema definition and do JSON serialization without a lot of complicated work.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.932.1">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.933.1">Pydantic </span></span><span class="kobospan" id="kobo.934.1">package must be downloaded and installed. </span><span class="kobospan" id="kobo.934.2">Generally, this is done with the following terminal command:</span></p>
<pre class="programlisting" id="listing-54"><code class="calibre13"><span class="kobospan" id="kobo.935.1">(cookbook3) % python -m pip install pydantic</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.936.1">Using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.937.1">python</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.938.1"> -m</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.939.1"> pip</span></span></span></span><span class="kobospan" id="kobo.940.1"> command ensures that we will use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.941.1">pip</span></span></span></span><span class="kobospan" id="kobo.942.1"> command that goes with the currently active virtual environment, shown as </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.943.1">cookbook3</span></span></span></span><span class="kobospan" id="kobo.944.1"> in the example. </span><span id="x1-600006r1271"/></p>
<section data-number="0.13.5.1" id="getting-ready-83">
<h2 class="likechapterhead" data-number="0.13.5.1"><span><span class="kobospan" id="kobo.945.1">10.5.1 </span></span> <span id="x1-6010001"/><span class="kobospan" id="kobo.946.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.947.1">The log data has date-time stamps represented as string values. </span><span class="kobospan" id="kobo.947.2">We need to parse these to create proper </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.948.1">datetime</span></span></span></span><span class="kobospan" id="kobo.949.1"> objects. </span><span class="kobospan" id="kobo.949.2">To keep things focused in this recipe, we’ll use a simplified log produced by a web server written with Flask.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.950.1">The entries start out as lines of text that look like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.951.1">[2016-06-15 17:57:54,715] INFO in ch10_r10: Sample Message One 
 
[2016-06-15 17:57:54,716] DEBUG in ch10_r10: Debugging 
 
[2016-06-15 17:57:54,720] WARNING in ch10_r10: Something might have gone wrong</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.952.1">We’ve seen other examples of working with this kind of log in the </span><a href="ch012.xhtml#x1-4810005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.953.1">Using more</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.954.1">complex structures – maps of lists</span></span></a><span class="kobospan" id="kobo.955.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.956.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.957.1"> </span></span><a href="ch012.xhtml#x1-4520008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.958.1">8</span></span></a><span class="kobospan" id="kobo.959.1">. </span><span class="kobospan" id="kobo.959.2">Using REs from the </span><a href="ch005_split_000.xhtml#x1-350003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.960.1">String</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.961.1">parsing with regular expressions</span></span></a><span class="kobospan" id="kobo.962.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.963.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.964.1"> </span></span><a href="ch005_split_000.xhtml#x1-170001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.965.1">1</span></span></a><span class="kobospan" id="kobo.966.1">, we can decompose each line into a more useful structure.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.967.1">Looking at the other recipes, the regular expression used for parsing had an important feature. </span><span class="kobospan" id="kobo.967.2">The names used in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.968.1">(?P&lt;name&gt;...)</span></span></span></span><span class="kobospan" id="kobo.969.1"> groups were specifically designed to be ordinary Python attribute names. </span><span class="kobospan" id="kobo.969.2">This will fit nicely with the class definition we’ll build later.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.970.1">We’ll need to define a class</span><span id="dx1-601005"/><span class="kobospan" id="kobo.971.1"> that captures the essential</span><span id="dx1-601006"/><span class="kobospan" id="kobo.972.1"> content of each log line in a useful form. </span><span class="kobospan" id="kobo.972.2">We’ll use the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.973.1">Pydantic </span></span><span class="kobospan" id="kobo.974.1">package to define and populate this class. </span><span id="x1-601007r1273"/></p>
</section>
<section data-number="0.13.5.2" id="how-to-do-it...-84">
<h2 class="likechapterhead" data-number="0.13.5.2"><span><span class="kobospan" id="kobo.975.1">10.5.2 </span></span> <span id="x1-6020002"/><span class="kobospan" id="kobo.976.1">How to do it...</span></h2>
<ol class="calibre2">
<li class="calibre7"><div id="x1-602002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.977.1">We’ll need the following imports to create this class definition:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.978.1">import datetime 
 
from enum import StrEnum 
 
from typing import Annotated 
 
from pydantic import BaseModel, Field</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-602009x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.979.1">In order to properly validate a string that has a number of values, an </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.980.1">Enum</span></span></span></span><span class="kobospan" id="kobo.981.1"> class is required. </span><span class="kobospan" id="kobo.981.2">We’ll define a subclass of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.982.1">StrEnum</span></span></span></span><span class="kobospan" id="kobo.983.1"> to list the valid string values. </span><span class="kobospan" id="kobo.983.2">Each class-level variable provides a name and the string literal that is the serialization for the name:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.984.1">class LevelClass(StrEnum): 
 
    DEBUG = "DEBUG" 
 
    INFO = "INFO" 
 
    WARNING = "WARNING" 
 
    ERROR = "ERROR"</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.985.1">In this class, the Python attribute names and the string literals match. </span><span class="kobospan" id="kobo.985.2">This isn’t a requirement. </span><span class="kobospan" id="kobo.985.3">It happens to be convenient for this collection of enumerated string values.</span></p>
</div></li>
<li class="calibre7"><div id="x1-602017x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.986.1">The class will be a subclass of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.987.1">BaseModel</span></span></span></span><span class="kobospan" id="kobo.988.1"> class from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.989.1">pydantic</span></span></span></span><span class="kobospan" id="kobo.990.1"> package:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.991.1">class LogData(BaseModel):</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.992.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.993.1">BaseModel</span></span></span></span><span class="kobospan" id="kobo.994.1"> class must be the superclass for any model that makes use of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.995.1">pydantic</span></span></span></span><span class="kobospan" id="kobo.996.1"> features.</span></p>
</div></li>
<li class="calibre7"><div id="x1-602021x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.997.1">We’ll define each field with a field name that matches the group name in the regular expression used to parse the fields. </span><span class="kobospan" id="kobo.997.2">This is not a requirement, but it makes it very easy to build instances of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.998.1">LogData</span></span></span></span><span class="kobospan" id="kobo.999.1"> class from the group dictionary that’s part of a regular expression </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1000.1">Match</span></span></span></span><span class="kobospan" id="kobo.1001.1"> object:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1002.1">    date: datetime.datetime 
 
    level: LevelClass 
 
    module: Annotated[str, Field(pattern=r’^\w+$’)] 
 
    message: str</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1003.1">The date is defined</span><span id="dx1-602027"/><span class="kobospan" id="kobo.1004.1"> to be a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1005.1">datetime.datetime</span></span></span></span><span class="kobospan" id="kobo.1006.1"> instance. </span><span class="kobospan" id="kobo.1006.2">The inherited</span><span id="dx1-602028"/><span class="kobospan" id="kobo.1007.1"> methods from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1008.1">BaseModel</span></span></span></span><span class="kobospan" id="kobo.1009.1"> class will handle this conversion. </span><span class="kobospan" id="kobo.1009.2">The level is an instance of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1010.1">LevelClass</span></span></span></span><span class="kobospan" id="kobo.1011.1">. </span><span class="kobospan" id="kobo.1011.2">Again, features from </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1012.1">BaseModel</span></span></span></span><span class="kobospan" id="kobo.1013.1"> will handle this conversion for us. </span><span class="kobospan" id="kobo.1013.2">We’ve used the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1014.1">Annotated</span></span></span></span><span class="kobospan" id="kobo.1015.1"> type to provide a type, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1016.1">str</span></span></span></span><span class="kobospan" id="kobo.1017.1">, and an annotation argument, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1018.1">Field(...)</span></span></span></span><span class="kobospan" id="kobo.1019.1">. </span><span class="kobospan" id="kobo.1019.2">This will be used by the methods of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1020.1">BaseModel</span></span></span></span><span class="kobospan" id="kobo.1021.1"> to validate the field’s content.</span></p>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.1022.1">Here’s a generator function to read and parse log records:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1023.1">from typing import Iterable, Iterator 
 
 
 
def logdata_iter(source: Iterable[str]) -&gt; Iterator[LogData]: 
 
    for row in source: 
 
        if match := pattern.match(row): 
 
            l = LogData.model_validate(match.groupdict()) 
 
            yield l</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1024.1">This will use the regular expression pattern, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1025.1">pattern</span></span></span></span><span class="kobospan" id="kobo.1026.1"> to parse each record. </span><span class="kobospan" id="kobo.1026.2">The group dictionary, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1027.1">match.groupdict()</span></span></span></span><span class="kobospan" id="kobo.1028.1"> will have the group names and the parsed text. </span><span class="kobospan" id="kobo.1028.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1029.1">model_validate()</span></span></span></span><span class="kobospan" id="kobo.1030.1"> method of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1031.1">BaseModel</span></span></span></span><span class="kobospan" id="kobo.1032.1"> will build an instance of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1033.1">LogData</span></span></span></span><span class="kobospan" id="kobo.1034.1"> class from the dictionary created by the compiled regular expression.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1035.1">It looks like the following example when we use this </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1036.1">logdata_iter</span></span></span></span><span class="kobospan" id="kobo.1037.1"> function to create instances of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1038.1">LogData</span></span></span></span><span class="kobospan" id="kobo.1039.1"> class:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1040.1">&gt;&gt;&gt; from pprint import pprint 
 
&gt;&gt;&gt; pprint(list(logdata_iter(data.splitlines()))) 
 
[LogData(date=datetime.datetime(2016, 6, 15, 17, 57, 54, 715000), level=&lt;LevelClass.INFO: ’INFO’&gt;, module=’ch10_r10’, message=’Sample Message One’), 
 
 LogData(date=datetime.datetime(2016, 6, 15, 17, 57, 54, 716000), level=&lt;LevelClass.DEBUG: ’DEBUG’&gt;, module=’ch10_r10’, message=’Debugging’), 
 
 LogData(date=datetime.datetime(2016, 6, 15, 17, 57, 54, 720000), level=&lt;LevelClass.WARNING: ’WARNING’&gt;, module=’ch10_r10’, message=’Something might have gone wrong’)]</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1041.1">This function has transformed lines of text into </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1042.1">LogData</span></span></span></span><span class="kobospan" id="kobo.1043.1"> objects populated with proper Python objects: </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1044.1">datetime.datetime</span></span></span></span><span class="kobospan" id="kobo.1045.1"> instances and enumerated values from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1046.1">LevelClass</span></span></span></span><span class="kobospan" id="kobo.1047.1">. </span><span class="kobospan" id="kobo.1047.2">Further, it’s validated the module names to be sure they match a specific regular expression pattern. </span><span id="x1-602043r1275"/></p>
</section>
<section data-number="0.13.5.3" id="how-it-works...-84">
<h2 class="likechapterhead" data-number="0.13.5.3"><span><span class="kobospan" id="kobo.1048.1">10.5.3 </span></span> <span id="x1-6030003"/><span class="kobospan" id="kobo.1049.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1050.1">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1051.1">Pydantic </span></span><span class="kobospan" id="kobo.1052.1">package includes numerous tools</span><span id="dx1-603001"/><span class="kobospan" id="kobo.1053.1"> for data</span><span id="dx1-603002"/><span class="kobospan" id="kobo.1054.1"> validation and class definition. </span><span class="kobospan" id="kobo.1054.2">Python’s use of types, and more detailed </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1055.1">Annotated</span></span></span></span><span class="kobospan" id="kobo.1056.1"> types, provides syntax that helps us define the members of a class, including data conversions and data validations. </span><span class="kobospan" id="kobo.1056.2">In this example, the conversions were implied; the class provided the target type, and the methods inherited from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1057.1">BaseModel</span></span></span></span><span class="kobospan" id="kobo.1058.1"> class made sure that source data was properly converted to the desired target type.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1059.1">This small class definition had three distinct kinds of types hints:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1060.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1061.1">date</span></span></span></span><span class="kobospan" id="kobo.1062.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1063.1">level</span></span></span></span><span class="kobospan" id="kobo.1064.1"> field involved conversions to a target type.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1065.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1066.1">module</span></span></span></span><span class="kobospan" id="kobo.1067.1"> field used an annotated type to provide a </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1068.1">Pydantic </span></span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1069.1">Field</span></span></span></span><span class="kobospan" id="kobo.1070.1"> definition for the attribute. </span><span class="kobospan" id="kobo.1070.2">The regular expression pattern will check each string value to be sure it matches the required pattern.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1071.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1072.1">message</span></span></span></span><span class="kobospan" id="kobo.1073.1"> field provided a simple type that will match the source data type. </span><span class="kobospan" id="kobo.1073.2">No additional validation will be performed for this field.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1074.1">There are some parallels between the way the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1075.1">@dataclass</span></span></span></span><span class="kobospan" id="kobo.1076.1"> and a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1077.1">BaseModel</span></span></span></span><span class="kobospan" id="kobo.1078.1"> subclass work. </span><span class="kobospan" id="kobo.1078.2">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1079.1">Pydantic </span></span><span class="kobospan" id="kobo.1080.1">package provides considerably more sophisticated definitions than a dataclass definition. </span><span class="kobospan" id="kobo.1080.2">A </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1081.1">@dataclass</span></span></span></span><span class="kobospan" id="kobo.1082.1">, for example, does not do type checking or any automatic data conversion. </span><span class="kobospan" id="kobo.1082.2">The type information provided when defining a dataclass is primarily of interest to tools like </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1083.1">mypy</span></span><span class="kobospan" id="kobo.1084.1">. </span><span class="kobospan" id="kobo.1084.2">In contrast, the subclasses of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1085.1">BaseModel</span></span></span></span><span class="kobospan" id="kobo.1086.1"> do considerably more automated conversion and run-time type checking.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1087.1">The subclasses of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1088.1">DataModel</span></span></span></span><span class="kobospan" id="kobo.1089.1"> come with a large number of methods.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1090.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1091.1">model_dump_json()</span></span></span></span><span class="kobospan" id="kobo.1092.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1093.1">model_validate_json()</span></span></span></span><span class="kobospan" id="kobo.1094.1"> methods are particularly helpful for web services where the application often works with RESTful transfers of object state in JSON notation. </span><span class="kobospan" id="kobo.1094.2">These can be serialized into newline-delimited files to collect a number of complicated objects into files in a standardized physical format.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1095.1">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1096.1">Pydantic </span></span><span class="kobospan" id="kobo.1097.1">package tends to be extremely fast. </span><span class="kobospan" id="kobo.1097.2">The current version involves Python extensions that are compiled to provide very high performance. </span><span class="kobospan" id="kobo.1097.3">Clearly, a dataclass – which lacks a number of </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1098.1">Pydantic </span></span><span class="kobospan" id="kobo.1099.1">features – will be faster, but do less. </span><span class="kobospan" id="kobo.1099.2">However, the additional data validation</span><span id="dx1-603003"/><span class="kobospan" id="kobo.1100.1"> is often worth</span><span id="dx1-603004"/><span class="kobospan" id="kobo.1101.1"> the overhead. </span><span id="x1-603005r1282"/></p>
</section>
<section data-number="0.13.5.4" id="theres-more...-75">
<h2 class="likechapterhead" data-number="0.13.5.4"><span><span class="kobospan" id="kobo.1102.1">10.5.4 </span></span> <span id="x1-6040004"/><span class="kobospan" id="kobo.1103.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1104.1">One of the benefits of working with </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1105.1">Pydantic </span></span><span class="kobospan" id="kobo.1106.1">is the automatic support for JSON Schema definitions and JSON serialization.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1107.1">This shows how we can get the JSON Schema for</span><span id="dx1-604001"/><span class="kobospan" id="kobo.1108.1"> a model:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1109.1">&gt;&gt;&gt; import json 
 
&gt;&gt;&gt; print(json.dumps(LogData.model_json_schema(), indent=2))</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1110.1">The details of the JSON Schema</span><span id="dx1-604005"/><span class="kobospan" id="kobo.1111.1"> are long and match the Python definition of the class. </span><span class="kobospan" id="kobo.1111.2">We’ve omitted the output.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1112.1">We can serialize these </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1113.1">LogData</span></span></span></span><span class="kobospan" id="kobo.1114.1"> instances in JSON notation. </span><span class="kobospan" id="kobo.1114.2">Here’s how this looks:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1115.1">&gt;&gt;&gt; for record in logdata_iter(data.splitlines()): 
 
... </span><span class="kobospan" id="kobo.1115.2">    print(record.model_dump_json()) 
 
{"date":"2016-06-15T17:57:54.715000","level":"INFO","module":"ch10_r10","message":"Sample Message One"} 
 
{"date":"2016-06-15T17:57:54.716000","level":"DEBUG","module":"ch10_r10","message":"Debugging"} 
 
{"date":"2016-06-15T17:57:54.720000","level":"WARNING","module":"ch10_r10","message":"Something might have gone wrong"}</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1116.1">We’ve used the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1117.1">model_dump_json()</span></span></span></span><span class="kobospan" id="kobo.1118.1"> method to serialize the object as a JSON document. </span><span class="kobospan" id="kobo.1118.2">This lets us convert documents from a variety of sources to a common format. </span><span class="kobospan" id="kobo.1118.3">This makes it easy to create analytic processing around the common format, separating parsing, merging, and validating from the analysis and the interesting results of the analytic processing. </span><span id="x1-604012r1283"/></p>
</section>
<section data-number="0.13.5.5" id="see-also-82">
<h2 class="likechapterhead" data-number="0.13.5.5"><span><span class="kobospan" id="kobo.1119.1">10.5.5 </span></span> <span id="x1-6050005"/><span class="kobospan" id="kobo.1120.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1121.1">See the </span><a href="ch014.xhtml#x1-6060006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1122.1">Including run-time valid value checks</span></span></a><span class="kobospan" id="kobo.1123.1"> recipe for some additional validation rules that are possible.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1124.1">See the </span><a href="ch011_split_000.xhtml#x1-4010005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1125.1">Using dataclasses for mutable objects</span></span></a><span class="kobospan" id="kobo.1126.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1127.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1128.1"> </span></span><a href="ch011_split_000.xhtml#x1-3760007" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1129.1">7</span></span></a><span class="kobospan" id="kobo.1130.1"> for more on dataclasses. </span><span class="kobospan" id="kobo.1130.2">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1131.1">Pydantic </span></span><span class="kobospan" id="kobo.1132.1">variant on dataclasses is often more useful than the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1133.1">dataclasses</span></span></span></span><span class="kobospan" id="kobo.1134.1"> module.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1135.1">See the </span><a href="ch015_split_001.xhtml#x1-6520006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1136.1">Reading JSON and YAML documents</span></span></a><span class="kobospan" id="kobo.1137.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1138.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1139.1"> </span></span><a href="ch015_split_000.xhtml#x1-61500011" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1140.1">11</span></span></a><span class="kobospan" id="kobo.1141.1"> for information related to reading data in JSON format.</span></p></li>
</ul>
<p class="normal1"><span id="x1-605001r1272"/></p>
</section>
</section>
<section data-number="0.13.6" id="including-run-time-valid-value-checks">
<h1 class="unnumbered" data-number="0.13.6"><span><span class="kobospan" id="kobo.1142.1">10.6 </span></span> <span id="x1-6060006"/><span class="kobospan" id="kobo.1143.1">Including run-time valid value checks</span></h1>
<p class="normal"><span class="kobospan" id="kobo.1144.1">Data analytics often involves</span><span id="dx1-606001"/><span class="kobospan" id="kobo.1145.1"> a great deal of ”data wrangling”: dealing with invalid data, or unusual data. </span><span class="kobospan" id="kobo.1145.2">It’s common for source application software to change, leading to new formats for data files, causing problems in downstream analytic applications when parsing those files. </span><span class="kobospan" id="kobo.1145.3">A change in enterprise processes or policies may lead to new data types or new coded values that can disrupt analytic processing.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1146.1">Similarly, when working with machines</span><span id="dx1-606002"/><span class="kobospan" id="kobo.1147.1"> and robots, sometimes called the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1148.1">Internet</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1149.1">of Things</span></span><span class="kobospan" id="kobo.1150.1">, it’s common for a device to provide invalid data when it’s starting up, or when it’s failing to operate normally. </span><span class="kobospan" id="kobo.1150.2">In some cases, it may be necessary to raise alarms when bad data arrives. </span><span class="kobospan" id="kobo.1150.3">In other cases, the out-of-range data needs to be quietly ignored.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1151.1">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1152.1">Pydantic </span></span><span class="kobospan" id="kobo.1153.1">package offers very sophisticated validation</span><span id="dx1-606003"/><span class="kobospan" id="kobo.1154.1"> functions that allow us two choices:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1155.1">Convert data from unusual formats into Python objects.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1156.1">Raise an exception for data that cannot be converted or fails to pass more specific domain checks.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1157.1">In some cases, we also need to validate the resulting object is internally consistent. </span><span class="kobospan" id="kobo.1157.2">This often means that several fields must be checked for consistency with each other. </span><span class="kobospan" id="kobo.1157.3">This is</span><span id="dx1-606004"/><span class="kobospan" id="kobo.1158.1"> called </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1159.1">model validation</span></span><span class="kobospan" id="kobo.1160.1">, which is distinct from isolated </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1161.1">field validation</span></span><span class="kobospan" id="kobo.1162.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1163.1">The idea of validation can be extended. </span><span class="kobospan" id="kobo.1163.2">It can embrace both rejecting invalid data and filtering out data that’s valid, but uninteresting, for a given application. </span><span id="x1-606005r1286"/></p>
<section data-number="0.13.6.1" id="getting-ready-84">
<h2 class="likechapterhead" data-number="0.13.6.1"><span><span class="kobospan" id="kobo.1164.1">10.6.1 </span></span> <span id="x1-6070001"/><span class="kobospan" id="kobo.1165.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1166.1">We’re looking at the US </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1167.1">National Oceanographic and Atmospheric</span></span> <span class="cmbx-10x-x"><span class="kobospan" id="kobo.1168.1">Administration </span></span><span class="kobospan" id="kobo.1169.1">(</span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1170.1">NOAA</span></span><span class="kobospan" id="kobo.1171.1">) data on coastal</span><span id="dx1-607001"/><span class="kobospan" id="kobo.1172.1"> tides. </span><span class="kobospan" id="kobo.1172.2">Moving a large sailboat means making sure there’s enough water for it to float. </span><span class="kobospan" id="kobo.1172.3">This constraint requires checking predictions for the height of the tides at places that are known to be shallow and difficult to pass.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1173.1">In particular, a place called El Jobean, on the Myakka river, has a shallow spot that requires some care when transiting it. </span><span class="kobospan" id="kobo.1173.2">We can get the tidal prediction from the NOAA </span><a href="https://tidesandcurrents.noaa.gov/noaatidepredictions.html?id=8725769" class="url"><span class="kobospan" id="kobo.1174.1">Tides and Currents</span></a><span class="kobospan" id="kobo.1175.1"> web site. </span><span class="kobospan" id="kobo.1175.2">This web page allows putting in a range of dates and downloading a text file with tide predictions for the given range of dates.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1176.1">The resulting text file looks as follows:</span></p>
<pre class="programlisting" id="listing-55"><code class="calibre13"><span class="kobospan" id="kobo.1177.1">NOAA/NOS/CO-OPS 
 
Disclaimer: These data are based upon the latest information available as of the date of your request, and may differ from the published tide tables. 
 
Daily Tide Predictions 
 
StationName: EL JOBEAN, MYAKKA RIVER 
 
State: FL 
 
Stationid: 8725769 
 
... 
 
 
 
Date           Day    Time    Pred    High/Low 
 
2024/04/01      Mon    04:30  -0.19  L 
 
2024/04/01      Mon    20:07  1.91    H 
 
...</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1178.1">This data is </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1179.1">almost </span></span><span class="kobospan" id="kobo.1180.1">in CSV format, but a few quirks</span><span id="dx1-607014"/><span class="kobospan" id="kobo.1181.1"> make it difficult to process. </span><span class="kobospan" id="kobo.1181.2">Here are some complicating factors:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1182.1">The file has 19 lines of data before the useful column heading line.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1183.1">The columns use the tab character </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1184.1">\t</span></span></span></span><span class="kobospan" id="kobo.1185.1"> as a delimiter instead of a comma.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1186.1">The heading row for the relevant data has some extraneous whitespace hidden in it.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1187.1">The following function will provide clean CSV rows for further processing:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1188.1">import csv 
 
from collections.abc import Iterator 
 
from typing import TextIO 
 
 
 
def tide_table_reader(source: TextIO) -&gt; Iterator[dict[str, str]]: 
 
    line_iter = iter(source) 
 
    for line in line_iter: 
 
        if len(line.rstrip()) == 0: 
 
            break 
 
    header = next(line_iter).rstrip().split(’\t’) 
 
    del header[1]  # Extra tab in the header 
 
    reader = csv.DictReader(line_iter, fieldnames=header, delimiter=’\t’) 
 
    yield from reader</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1189.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1190.1">Extra</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1191.1"> tab</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1192.1"> in</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1193.1"> the</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1194.1"> header</span></span></span></span><span class="kobospan" id="kobo.1195.1"> comment handles the heading, which has an extra whitespace character in it. </span><span class="kobospan" id="kobo.1195.2">This header row has two </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1196.1">\t</span></span></span></span><span class="kobospan" id="kobo.1197.1"> characters between the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1198.1">Date</span></span></span></span><span class="kobospan" id="kobo.1199.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1200.1">Day</span></span></span></span><span class="kobospan" id="kobo.1201.1"> column names:</span></p>
<div class="tipbox" id="tcolobox-24">
<span id="x1-607030x1"/>
<div class="note">
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1202.1"> ’Date \t\tDay\tTime\tPred\tHigh/Low\n’</span></code></pre>
</div>
</div>
<p class="normal1"><span class="kobospan" id="kobo.1203.1">See the </span><a href="ch008_split_000.xhtml#x1-2400003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1204.1">Slicing and dicing a list</span></span></a><span class="kobospan" id="kobo.1205.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1206.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1207.1"> </span></span><a href="ch008_split_000.xhtml#x1-2240004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1208.1">4</span></span></a><span class="kobospan" id="kobo.1209.1"> for more on this technique for removing an item from a list.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1210.1">This list of column names can be used to build a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1211.1">DictReader</span></span></span></span><span class="kobospan" id="kobo.1212.1"> instance to consume the rest of the data. </span><span class="kobospan" id="kobo.1212.2">(See the </span><a href="ch015_split_000.xhtml#x1-6320003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1213.1">Reading delimited files with the CSV</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1214.1">module</span></span></a><span class="kobospan" id="kobo.1215.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1216.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1217.1"> </span></span><a href="ch015_split_000.xhtml#x1-61500011" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1218.1">11</span></span></a><span class="kobospan" id="kobo.1219.1"> for more on CSV files.)</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1220.1">We can convert each from a dictionary</span><span id="dx1-607031"/><span class="kobospan" id="kobo.1221.1"> to a class</span><span id="dx1-607032"/><span class="kobospan" id="kobo.1222.1"> instance using </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1223.1">Pydantic</span></span><span class="kobospan" id="kobo.1224.1"> validation features. </span><span id="x1-607033r1288"/></p>
</section>
<section data-number="0.13.6.2" id="how-to-do-it...-85">
<h2 class="likechapterhead" data-number="0.13.6.2"><span><span class="kobospan" id="kobo.1225.1">10.6.2 </span></span> <span id="x1-6080002"/><span class="kobospan" id="kobo.1226.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1227.1">The core data model will validate rows of data, creating an instance of a class. </span><span class="kobospan" id="kobo.1227.2">We can add features to this class to handle the application-specific processing. </span><span class="kobospan" id="kobo.1227.3">Here’s how we build this class:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-608002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1228.1">Start with the imports for the the data types within each row, plus the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1229.1">BaseModel</span></span></span></span><span class="kobospan" id="kobo.1230.1"> class and some related classes:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1231.1">import datetime 
 
from enum import StrEnum 
 
from typing import Annotated 
 
from pydantic import BaseModel, Field, PlainValidator</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-608009x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1232.1">Define the domain of values for the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1233.1">High/Low</span></span></span></span><span class="kobospan" id="kobo.1234.1"> column. </span><span class="kobospan" id="kobo.1234.2">The two codes are enumerated as an </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1235.1">Enum</span></span></span></span><span class="kobospan" id="kobo.1236.1"> subclass:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1237.1">class HighLow(StrEnum): 
 
    high = "H" 
 
    low = "L"</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-608015x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1238.1">Since the date text is not in the default format used by </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1239.1">Pydantic</span></span><span class="kobospan" id="kobo.1240.1">, we need to define a validation function that will produce a date object from the given string:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1241.1">def validate_date(v: str | datetime.date) -&gt; datetime.date: 
 
    match v: 
 
        case datetime.date(): 
 
            return v 
 
        case str(): 
 
            return datetime.datetime.strptime(v, "%Y/%m/%d").date() 
 
        case _: 
 
            raise TypeError("can’t validate {v!r} of type {type(v)}")</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1242.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1243.1">Pydantic</span></span></span></span><span class="kobospan" id="kobo.1244.1"> validators can be used</span><span id="dx1-608025"/><span class="kobospan" id="kobo.1245.1"> on internal Python objects as well as strings from source CSV files or JSON documents. </span><span class="kobospan" id="kobo.1245.2">When applied to a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1246.1">datetime.date</span></span></span></span><span class="kobospan" id="kobo.1247.1"> object, no additional conversion is needed.</span></p>
</div></li>
<li class="calibre7"><div id="x1-608027x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1248.1">Define the model. </span><span class="kobospan" id="kobo.1248.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1249.1">validation_alias</span></span></span></span><span class="kobospan" id="kobo.1250.1"> parameter of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1251.1">Field</span></span></span></span><span class="kobospan" id="kobo.1252.1"> definition will pluck data from a source field in the dictionary that’s not exactly the same as the target attribute name in the class:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1253.1">class TideTable(BaseModel): 
 
    date: Annotated[ 
 
        datetime.date, 
 
        Field(validation_alias=’Date ’), 
 
        PlainValidator(validate_date)] 
 
    day: Annotated[ 
 
        str, Field(validation_alias=’Day’)] 
 
    time: Annotated[ 
 
        datetime.time, Field(validation_alias=’Time’)] 
 
    prediction: Annotated[ 
 
        float, Field(validation_alias=’Pred’)] 
 
    high_low: Annotated[ 
 
        HighLow, Field(validation_alias=’High/Low’)]</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1254.1">Each field uses an </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1255.1">Annotated</span></span></span></span><span class="kobospan" id="kobo.1256.1"> type to define the base type, and additional details required to validate strings and convert them to that type.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1257.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1258.1">day</span></span></span></span><span class="kobospan" id="kobo.1259.1"> field – with the day of the week – is not actually useful. </span><span class="kobospan" id="kobo.1259.2">It’s derived data from the date. </span><span class="kobospan" id="kobo.1259.3">For debugging purposes, this is preserved.</span></p>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.1260.1">Given this class, we can use it to validate model instances from a sequence of dictionary instances. </span><span class="kobospan" id="kobo.1260.2">It looks like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1261.1">&gt;&gt;&gt; tides = [TideTable.model_validate(row) for row in dict_rows] 
 
&gt;&gt;&gt; tides[0] 
 
TideTable(date=datetime.date(2024, 4, 1), day=’Mon’, time=datetime.time(4, 30), prediction=-0.19, high_low=&lt;HighLow.low: ’L’&gt;) 
 
&gt;&gt;&gt; tides[-1] 
 
TideTable(date=datetime.date(2024, 4, 30), day=’Tue’, time=datetime.time(19, 57), prediction=1.98, high_low=&lt;HighLow.high: ’H’&gt;)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1262.1">This sequence of objects contains too much data. </span><span class="kobospan" id="kobo.1262.2">We can use </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1263.1">Pydantic </span></span><span class="kobospan" id="kobo.1264.1">to also filter the data, and pass only the useful rows. </span><span class="kobospan" id="kobo.1264.2">We’ll do this by revising this class definition and creating an alternative that includes</span><span id="dx1-608048"/><span class="kobospan" id="kobo.1265.1"> the rules for the data to be passed. </span><span id="x1-608049r1290"/></p>
</section>
<section data-number="0.13.6.3" id="how-it-works...-85">
<h2 class="likechapterhead" data-number="0.13.6.3"><span><span class="kobospan" id="kobo.1266.1">10.6.3 </span></span> <span id="x1-6090003"/><span class="kobospan" id="kobo.1267.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1268.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1269.1">BaseModel</span></span></span></span><span class="kobospan" id="kobo.1270.1"> class includes a number of operations that work with the annotated type hints of the class attributes. </span><span class="kobospan" id="kobo.1270.2">Consider this type hint:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1271.1">    date: Annotated[ 
 
        datetime.date, 
 
        Field(validation_alias=’Date ’), 
 
        PlainValidator(validate_date)]</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1272.1">This provides a base type, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1273.1">datetime.date</span></span></span></span><span class="kobospan" id="kobo.1274.1">. </span><span class="kobospan" id="kobo.1274.2">It provides a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1275.1">Field</span></span></span></span><span class="kobospan" id="kobo.1276.1"> object that will extract the field named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1277.1">’Date</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1278.1"> ’</span></span></span></span><span class="kobospan" id="kobo.1279.1"> from a dictionary, and apply validation rules to it. </span><span class="kobospan" id="kobo.1279.2">Finally, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1280.1">PlainValidator</span></span></span></span><span class="kobospan" id="kobo.1281.1"> object provides a one-step validation rule that’s applied to the source data. </span><span class="kobospan" id="kobo.1281.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1282.1">validate_date()</span></span></span></span><span class="kobospan" id="kobo.1283.1"> function was written to accept </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1284.1">date</span></span></span></span><span class="kobospan" id="kobo.1285.1"> objects as already valid, and convert string objects into </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1286.1">date</span></span></span></span><span class="kobospan" id="kobo.1287.1"> objects. </span><span class="kobospan" id="kobo.1287.2">This allows the validation to be used for raw data as well as Python objects.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1288.1">Our application involves some narrowing of the domains of data for this example. </span><span class="kobospan" id="kobo.1288.2">There are three important criteria:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1289.1">We’re only interested in high tide predictions.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1290.1">We’d prefer the tide be at least 1.5 (45 cm) feet above baseline.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1291.1">We need this to occur after 10:00 and before 17:00.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1292.1">We can leverage Pydantic to perform</span><span id="dx1-609006"/><span class="kobospan" id="kobo.1293.1"> additional validations to narrow the data domains. </span><span class="kobospan" id="kobo.1293.2">These additional validations can reject high tides less than the minimum of 1.5 feet. </span><span id="x1-609007r1296"/></p>
</section>
<section data-number="0.13.6.4" id="theres-more...-76">
<h2 class="likechapterhead" data-number="0.13.6.4"><span><span class="kobospan" id="kobo.1294.1">10.6.4 </span></span> <span id="x1-6100004"/><span class="kobospan" id="kobo.1295.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1296.1">We can extend this model to add validation rules that narrow the domain of valid rows to those that match our selection criteria based on time of day and height of tide. </span><span class="kobospan" id="kobo.1296.2">We’ll be applying these more narrow data validation rules</span><span id="dx1-610001"/><span class="kobospan" id="kobo.1297.1"> after any data conversions. </span><span class="kobospan" id="kobo.1297.2">These rules will raise </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1298.1">ValidationError</span></span></span></span><span class="kobospan" id="kobo.1299.1"> exceptions. </span><span class="kobospan" id="kobo.1299.2">This expands the imports from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1300.1">pydantic</span></span></span></span><span class="kobospan" id="kobo.1301.1"> package.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1302.1">We’ll define a number of additional validation functions. </span><span class="kobospan" id="kobo.1302.2">Here’s a validator that raises an exception for low-tide data:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1303.1">    BaseModel, Field, PlainValidator, AfterValidator, ValidationError 
 
) 
 
 
 
def pass_high_tide(hl: HighLow) -&gt; HighLow: 
 
    assert hl == HighLow.high, f"rejected low tide" 
 
    return hl</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1304.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1305.1">assert</span></span></span></span><span class="kobospan" id="kobo.1306.1"> statement is elegantly simple for this task. </span><span class="kobospan" id="kobo.1306.2">This can also be done with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1307.1">if</span></span></span></span><span class="kobospan" id="kobo.1308.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1309.1">raise</span></span></span></span><span class="kobospan" id="kobo.1310.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1311.1">A similar validator can raise an exception for data outside the acceptable time window:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1312.1">def pass_daylight(time: datetime.time) -&gt; datetime.time: 
 
    assert datetime.time(10, 0) &lt;= time &lt;= datetime.time(17, 0) 
 
    return time</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1313.1">Finally, we can combine these additional validators</span><span id="dx1-610013"/><span class="kobospan" id="kobo.1314.1"> into the annotated type definitions:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1315.1">class HighTideTable(BaseModel): 
 
    date: Annotated[ 
 
        datetime.date, 
 
        Field(validation_alias=’Date ’), 
 
        PlainValidator(validate_date)] 
 
    time: Annotated[ 
 
        datetime.time, 
 
        Field(validation_alias=’Time’), 
 
        AfterValidator(pass_daylight)]  # Range check 
 
    prediction: Annotated[ 
 
        float, 
 
        Field(validation_alias=’Pred’, ge=1.5)]  # Minimum check 
 
    high_low: Annotated[ 
 
        HighLow, 
 
        Field(validation_alias=’High/Low’), 
 
        AfterValidator(pass_high_tide)]  # Required value check</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1316.1">The additional validators will reject data where the criteria don’t match our narrow requirements. </span><span class="kobospan" id="kobo.1316.2">The output will only have high tides, greater than 1.5 feet, and during daylight hours.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1317.1">This data forms a sequence of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1318.1">HighTideTable</span></span></span></span><span class="kobospan" id="kobo.1319.1"> instances, like the following:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1320.1">&gt;&gt;&gt; from pathlib import Path 
 
&gt;&gt;&gt; data = Path("data") / "tide-table-2024.txt" 
 
&gt;&gt;&gt; with open(data) as tide_file: 
 
... </span><span class="kobospan" id="kobo.1320.2">    for ht in high_tide_iter(tide_table_reader(tide_file)): 
 
... </span><span class="kobospan" id="kobo.1320.3">        print(repr(ht)) 
 
HighTideTable(date=datetime.date(2024, 4, 7), time=datetime.time(15, 42), prediction=1.55, high_low=&lt;HighLow.high: ’H’&gt;) 
 
... 
 
HighTideTable(date=datetime.date(2024, 4, 10), time=datetime.time(16, 42), prediction=2.1, high_low=&lt;HighLow.high: ’H’&gt;) 
 
... 
 
HighTideTable(date=datetime.date(2024, 4, 26), time=datetime.time(16, 41), prediction=2.19, high_low=&lt;HighLow.high: ’H’&gt;)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1321.1">We’ve omitted some rows to show just the first row, a row from the middle, and the last row. </span><span class="kobospan" id="kobo.1321.2">These are </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1322.1">HighTideTable</span></span></span></span><span class="kobospan" id="kobo.1323.1"> objects with attributes that are Python objects, suitable for further analysis and processing.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1324.1">The general approach to </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1325.1">Pydantic </span></span><span class="kobospan" id="kobo.1326.1">design means individual rules for combining raw data fields, converting data, and filtering data are all separated. </span><span class="kobospan" id="kobo.1326.2">We can confidently change one of these rules without having to worry about breaking other parts of the application.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1327.1">This recipe included three varieties of checks:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1328.1">A range check to be sure a continuous value is within the allowed range. </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1329.1">AfterValidator</span></span></span></span><span class="kobospan" id="kobo.1330.1"> is used to make sure a string is converted to a time.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1331.1">A minimum check to be sure a continuous value is above a limit. </span><span class="kobospan" id="kobo.1331.2">For numbers, this can be done by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1332.1">Field</span></span></span></span><span class="kobospan" id="kobo.1333.1"> definition directly.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1334.1">A required value check to be sure a discrete value has one of the required values. </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1335.1">AfterValidator</span></span></span></span><span class="kobospan" id="kobo.1336.1"> is used to make sure a string is converted the enumerated type.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1337.1">These kinds of checks are performed after the essential type matching and used to apply</span><span id="dx1-610042"/><span class="kobospan" id="kobo.1338.1"> narrower validation rules. </span><span id="x1-610043r1298"/></p>
</section>
<section data-number="0.13.6.5" id="see-also-83">
<h2 class="likechapterhead" data-number="0.13.6.5"><span><span class="kobospan" id="kobo.1339.1">10.6.5 </span></span> <span id="x1-6110005"/><span class="kobospan" id="kobo.1340.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1341.1">In </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1342.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1343.1"> </span></span><a href="ch015_split_000.xhtml#x1-61500011" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1344.1">11</span></span></a><span class="kobospan" id="kobo.1345.1"> we’ll look more deeply at reading files of data.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1346.1">See the </span><a href="ch014.xhtml#x1-6000005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1347.1">Implementing more strict type checks with Pydantic</span></span></a><span class="kobospan" id="kobo.1348.1"> recipe for additional examples of using </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1349.1">Pydantic</span></span><span class="kobospan" id="kobo.1350.1">. </span><span class="kobospan" id="kobo.1350.2">Pydantic uses compiled Python extensions to apply the validation rules with little overhead.</span></p></li>
</ul>
<p class="normal1"><span id="x1-611001r1287"/></p>
</section>
</section>
<section data-number="0.13.9" id="join-our-community-discord-space-10">
<h1 class="unnumbered" data-number="0.13.9"><span id="x1-6140008"/><span class="kobospan" id="kobo.1351.1">Join our community Discord space</span></h1>
<p class="normal"><span class="kobospan" id="kobo.1352.1">Join our Python Discord workspace to discuss and find out more about the book: </span><a class="url" href="https://packt.link/dHrHU"><span class="url1"><span class="kobospan" id="kobo.1353.1">https://packt.link/dHrHU</span></span></a></p>
<p class="normal1"><span class="kobospan" id="kobo.1354.1"><img alt="PIC" src="../media/file1.png" class="calibre9"/></span></p>
<p class="normal1"><span id="x1-614001r1207"/></p>
</section>
</section>
</body></html>