<html><head></head><body>
<div class="Basic-Text-Frame" id="_idContainer444">
<h1 class="chapterNumber"><span class="koboSpan" id="kobo.1.1">17</span></h1>
<h1 class="chapterTitle" id="_idParaDest-446"><span class="koboSpan" id="kobo.2.1">Going Live</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">In the previous chapter, you built a real-time chat server for students using Django Channels. </span><span class="koboSpan" id="kobo.3.2">Now that you have created a fully functional e-learning platform, you need to set up a production environment so that it can be accessed over the internet. </span><span class="koboSpan" id="kobo.3.3">Until now, you have been working in a development environment, using the Django development server to run your site. </span><span class="koboSpan" id="kobo.3.4">In this chapter, you will learn how to set up a production environment that is able to serve your Django project in a secure and efficient manner.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4.1">This chapter will cover the following topics:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.5.1">Configuring Django settings for multiple environments</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.6.1">Using Docker Compose to run multiple services</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.7.1">Setting up a web server with uWSGI and Django</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.8.1">Serving PostgreSQL and Redis with Docker Compose</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.9.1">Using the Django system check framework</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.10.1">Serving NGINX with Docker</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.11.1">Serving static assets through NGINX</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.12.1">Securing </span><a id="_idIndexMarker1529"/><span class="koboSpan" id="kobo.13.1">connections through </span><strong class="keyWord"><span class="koboSpan" id="kobo.14.1">Transport Layer Security</span></strong><span class="koboSpan" id="kobo.15.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.16.1">TLS</span></strong><span class="koboSpan" id="kobo.17.1">) / </span><strong class="keyWord"><span class="koboSpan" id="kobo.18.1">Secure Sockets Layer</span></strong><span class="koboSpan" id="kobo.19.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.20.1">SSL</span></strong><span class="koboSpan" id="kobo.21.1">)</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.22.1">Using </span><a id="_idIndexMarker1530"/><span class="koboSpan" id="kobo.23.1">the Daphne </span><strong class="keyWord"><span class="koboSpan" id="kobo.24.1">Asynchronous Server Gateway Interface</span></strong><span class="koboSpan" id="kobo.25.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.26.1">ASGI</span></strong><span class="koboSpan" id="kobo.27.1">) server for Django Channels</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.28.1">Creating </span><a id="_idIndexMarker1531"/><span class="koboSpan" id="kobo.29.1">a custom Django middleware</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.30.1">Implementing custom Django management commands</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.31.1">In previous chapters, diagrams at the start represented views, templates, and end-to-end functionalities. </span><span class="koboSpan" id="kobo.31.2">This chapter, however, shifts focus to setting up a production environment. </span><span class="koboSpan" id="kobo.31.3">Instead, you will find specific diagrams to illustrate the environment setup throughout the chapter.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.32.1">The source code for this chapter can be found at </span><a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter17"><span class="url"><span class="koboSpan" id="kobo.33.1">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter17</span></span></a><span class="koboSpan" id="kobo.34.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.35.1">All Python modules used in this chapter are included in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.36.1">requirements.txt</span></code><span class="koboSpan" id="kobo.37.1"> file in the source code that comes along with this chapter. </span><span class="koboSpan" id="kobo.37.2">You can follow the instructions to install each Python module below or you can install all requirements at once with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.38.1">python -m pip install -r requirements.txt</span></code><span class="koboSpan" id="kobo.39.1"> command.</span></p>
<h1 class="heading-1" id="_idParaDest-447"><span class="koboSpan" id="kobo.40.1">Creating a production environment</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.41.1">It’s time </span><a id="_idIndexMarker1532"/><span class="koboSpan" id="kobo.42.1">to deploy your Django project in a production environment. </span><span class="koboSpan" id="kobo.42.2">You will start by configuring Django settings for multiple environments, and then you will set up a production environment.</span></p>
<h2 class="heading-2" id="_idParaDest-448"><span class="koboSpan" id="kobo.43.1">Managing settings for multiple environments</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.44.1">In real-world projects, you will have to deal with multiple environments. </span><span class="koboSpan" id="kobo.44.2">You will usually have at </span><a id="_idIndexMarker1533"/><span class="koboSpan" id="kobo.45.1">least a local environment for development and a production environment for serving your application. </span><span class="koboSpan" id="kobo.45.2">You could have other environments as well, such as testing or staging environments.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.46.1">Some project settings will be common to all environments, but others will be specific to each environment. </span><span class="koboSpan" id="kobo.46.2">Usually, you will use a base file that defines common settings, and a settings file per environment that overrides any necessary settings and defines additional ones.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.47.1">We will manage the following environments:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.48.1">local</span></code><span class="koboSpan" id="kobo.49.1">: The local environment to run the project on your machine</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.50.1">prod</span></code><span class="koboSpan" id="kobo.51.1">: The environment for deploying your project on a production server</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.52.1">Create a </span><code class="inlineCode"><span class="koboSpan" id="kobo.53.1">settings/</span></code><span class="koboSpan" id="kobo.54.1"> directory next to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.55.1">settings.py</span></code><span class="koboSpan" id="kobo.56.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.57.1">educa</span></code><span class="koboSpan" id="kobo.58.1"> project. </span><span class="koboSpan" id="kobo.58.2">Rename the </span><code class="inlineCode"><span class="koboSpan" id="kobo.59.1">settings.py</span></code><span class="koboSpan" id="kobo.60.1"> file to </span><code class="inlineCode"><span class="koboSpan" id="kobo.61.1">base.py</span></code><span class="koboSpan" id="kobo.62.1"> and move it into the new </span><code class="inlineCode"><span class="koboSpan" id="kobo.63.1">settings/</span></code><span class="koboSpan" id="kobo.64.1"> directory.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.65.1">Create the following additional files inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.66.1">settings/</span></code><span class="koboSpan" id="kobo.67.1"> folder so that the new directory looks as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.68.1">settings/
    __init__.py
    base.py
    local.py
    prod.py
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.69.1">These files are as follows:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.70.1">base.py</span></code><span class="koboSpan" id="kobo.71.1">: The base settings file, which contains common settings (previously </span><code class="inlineCode"><span class="koboSpan" id="kobo.72.1">settings.py</span></code><span class="koboSpan" id="kobo.73.1">)</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.74.1">local.py</span></code><span class="koboSpan" id="kobo.75.1">: Custom settings for your local environment</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.76.1">prod.py</span></code><span class="koboSpan" id="kobo.77.1">: Custom settings for the production environment</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.78.1">You have moved the settings files to a directory one level below, so you need to update the </span><code class="inlineCode"><span class="koboSpan" id="kobo.79.1">BASE_DIR</span></code><span class="koboSpan" id="kobo.80.1"> setting in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.81.1">settings/base.py</span></code><span class="koboSpan" id="kobo.82.1"> file to point to the main project directory.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.83.1">When </span><a id="_idIndexMarker1534"/><span class="koboSpan" id="kobo.84.1">handling multiple environments, create a base settings file and a settings file for each environment. </span><span class="koboSpan" id="kobo.84.2">Environment settings files should inherit the common settings and override environment-specific settings.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.85.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.86.1">settings/base.py</span></code><span class="koboSpan" id="kobo.87.1"> file and replace the following line:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.88.1">BASE_DIR = Path(__file__).resolve().parent.parent
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.89.1">Replace the preceding line with the following one:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.90.1">BASE_DIR = Path(__file__).resolve().parent.parent</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.91.1">.parent</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.92.1">You point to one directory above by adding </span><code class="inlineCode"><span class="koboSpan" id="kobo.93.1">.parent</span></code><span class="koboSpan" id="kobo.94.1"> to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.95.1">BASE_DIR</span></code><span class="koboSpan" id="kobo.96.1"> path. </span><span class="koboSpan" id="kobo.96.2">Let’s configure the settings for the local environment.</span></p>
<h3 class="heading-3" id="_idParaDest-449"><span class="koboSpan" id="kobo.97.1">Local environment settings</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.98.1">Instead </span><a id="_idIndexMarker1535"/><span class="koboSpan" id="kobo.99.1">of using a default configuration </span><a id="_idIndexMarker1536"/><span class="koboSpan" id="kobo.100.1">for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.101.1">DEBUG</span></code><span class="koboSpan" id="kobo.102.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.103.1">DATABASES</span></code><span class="koboSpan" id="kobo.104.1"> settings, you will define them for each environment explicitly. </span><span class="koboSpan" id="kobo.104.2">These settings will be environment specific. </span><span class="koboSpan" id="kobo.104.3">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.105.1">educa/settings/local.py</span></code><span class="koboSpan" id="kobo.106.1"> file and add the following lines:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.107.1">from</span></span><span class="koboSpan" id="kobo.108.1"> .base </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.109.1">import</span></span><span class="koboSpan" id="kobo.110.1"> *
DEBUG = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.111.1">True</span></span><span class="koboSpan" id="kobo.112.1">
DATABASES = {
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.113.1">'default'</span></span><span class="koboSpan" id="kobo.114.1">: {
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.115.1">'ENGINE'</span></span><span class="koboSpan" id="kobo.116.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.117.1">'django.db.backends.sqlite3'</span></span><span class="koboSpan" id="kobo.118.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.119.1">'NAME'</span></span><span class="koboSpan" id="kobo.120.1">: BASE_DIR / </span><span class="hljs-string"><span class="koboSpan" id="kobo.121.1">'db.sqlite3'</span></span><span class="koboSpan" id="kobo.122.1">,
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.123.1">This is </span><a id="_idIndexMarker1537"/><span class="koboSpan" id="kobo.124.1">the settings file for your local environment. </span><span class="koboSpan" id="kobo.124.2">In this file, you import all settings defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.125.1">base.py</span></code><span class="koboSpan" id="kobo.126.1"> file, and you define the </span><code class="inlineCode"><span class="koboSpan" id="kobo.127.1">DEBUG</span></code><span class="koboSpan" id="kobo.128.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.129.1">DATABASES</span></code><span class="koboSpan" id="kobo.130.1"> settings for this environment. </span><span class="koboSpan" id="kobo.130.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.131.1">DEBUG</span></code><span class="koboSpan" id="kobo.132.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.133.1">DATABASES</span></code><span class="koboSpan" id="kobo.134.1"> settings remain the same as you have been using for development.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.135.1">Now, remove the </span><code class="inlineCode"><span class="koboSpan" id="kobo.136.1">DATABASES</span></code><span class="koboSpan" id="kobo.137.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.138.1">DEBUG</span></code><span class="koboSpan" id="kobo.139.1"> settings from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.140.1">base.py</span></code><span class="koboSpan" id="kobo.141.1"> settings file.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.142.1">Django </span><a id="_idIndexMarker1538"/><span class="koboSpan" id="kobo.143.1">management commands won’t automatically detect the settings file to use because the project settings file is not the default </span><code class="inlineCode"><span class="koboSpan" id="kobo.144.1">settings.py</span></code><span class="koboSpan" id="kobo.145.1"> file. </span><span class="koboSpan" id="kobo.145.2">When running management commands, you need to indicate the settings module that you want to use by adding a </span><code class="inlineCode"><span class="koboSpan" id="kobo.146.1">--settings</span></code><span class="koboSpan" id="kobo.147.1"> option, as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.148.1">python manage.py runserver --settings=educa.settings.local
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.149.1">Next, we are going to validate the project and the local environment configuration.</span></p>
<h3 class="heading-3" id="_idParaDest-450"><span class="koboSpan" id="kobo.150.1">Running the local environment</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.151.1">Let’s run the local environment using the new settings structure. </span><span class="koboSpan" id="kobo.151.2">Make sure Redis is running </span><a id="_idIndexMarker1539"/><span class="koboSpan" id="kobo.152.1">or start the Redis Docker container in a shell with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.153.1">docker run -it --rm --name redis -p 6379:6379 redis:7.2.4
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.154.1">Run the </span><a id="_idIndexMarker1540"/><span class="koboSpan" id="kobo.155.1">following management command in another shell, from the project directory:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.156.1">python manage.py runserver --settings=educa.settings.local
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.157.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.158.1">http://127.0.0.1:8000/</span></code><span class="koboSpan" id="kobo.159.1"> in your browser and check that the site loads correctly. </span><span class="koboSpan" id="kobo.159.2">You are now serving your site using the settings for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.160.1">local</span></code><span class="koboSpan" id="kobo.161.1"> environment.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.162.1">If don’t want to pass the </span><code class="inlineCode"><span class="koboSpan" id="kobo.163.1">--settings</span></code><span class="koboSpan" id="kobo.164.1"> option every time you run a management command, you can define the </span><code class="inlineCode"><span class="koboSpan" id="kobo.165.1">DJANGO_SETTINGS_MODULE</span></code><span class="koboSpan" id="kobo.166.1"> environment variable. </span><span class="koboSpan" id="kobo.166.2">Django will use it to identify the settings module to use. </span><span class="koboSpan" id="kobo.166.3">If you are using Linux or macOS, you can define the environment variable by executing the following command in the shell:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.167.1">export DJANGO_SETTINGS_MODULE=educa.settings.local
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.168.1">If you are using Windows, you can execute the following command in the shell:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.169.1">set DJANGO_SETTINGS_MODULE=educa.settings.local
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.170.1">Any management command you execute after this will use the settings defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.171.1">DJANGO_SETTINGS_MODULE</span></code><span class="koboSpan" id="kobo.172.1"> environment variable.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.173.1">Stop the </span><a id="_idIndexMarker1541"/><span class="koboSpan" id="kobo.174.1">Django development server from the shell by pressing the </span><em class="italic"><span class="koboSpan" id="kobo.175.1">Ctrl </span></em><span class="koboSpan" id="kobo.176.1">+ </span><em class="italic"><span class="koboSpan" id="kobo.177.1">C</span></em><span class="koboSpan" id="kobo.178.1"> keys and stop the Redis Docker container from the shell by also pressing the </span><em class="italic"><span class="koboSpan" id="kobo.179.1">Ctrl</span></em><span class="koboSpan" id="kobo.180.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.181.1">C</span></em><span class="koboSpan" id="kobo.182.1"> keys.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.183.1">The local </span><a id="_idIndexMarker1542"/><span class="koboSpan" id="kobo.184.1">environment works well. </span><span class="koboSpan" id="kobo.184.2">Let’s prepare the settings for the production environment.</span></p>
<h3 class="heading-3" id="_idParaDest-451"><span class="koboSpan" id="kobo.185.1">Production environment settings</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.186.1">Let’s </span><a id="_idIndexMarker1543"/><span class="koboSpan" id="kobo.187.1">start by adding initial </span><a id="_idIndexMarker1544"/><span class="koboSpan" id="kobo.188.1">settings for the production environment. </span><span class="koboSpan" id="kobo.188.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.189.1">educa/settings/prod.py</span></code><span class="koboSpan" id="kobo.190.1"> file and make it look as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.191.1">from</span></span><span class="koboSpan" id="kobo.192.1"> .base </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.193.1">import</span></span><span class="koboSpan" id="kobo.194.1"> *
DEBUG = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.195.1">False</span></span><span class="koboSpan" id="kobo.196.1">
ADMINS = [
    (</span><span class="hljs-string"><span class="koboSpan" id="kobo.197.1">'Antonio M'</span></span><span class="koboSpan" id="kobo.198.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.199.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.200.1">email@mydomain.com'</span></span><span class="koboSpan" id="kobo.201.1">),
]
ALLOWED_HOSTS = [</span><span class="hljs-string"><span class="koboSpan" id="kobo.202.1">'*'</span></span><span class="koboSpan" id="kobo.203.1">]
DATABASES = {
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.204.1">'default'</span></span><span class="koboSpan" id="kobo.205.1">: {
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.206.1">'ENGINE'</span></span><span class="koboSpan" id="kobo.207.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.208.1">'django.db.backends.sqlite3'</span></span><span class="koboSpan" id="kobo.209.1">,
        NAME: BASE_DIR / </span><span class="hljs-string"><span class="koboSpan" id="kobo.210.1">'db.sqlite3'</span></span><span class="koboSpan" id="kobo.211.1">,
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.212.1">These are the settings for the production environment:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.213.1">DEBUG</span></code><span class="koboSpan" id="kobo.214.1">: Setting </span><code class="inlineCode"><span class="koboSpan" id="kobo.215.1">DEBUG</span></code><span class="koboSpan" id="kobo.216.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.217.1">False</span></code><span class="koboSpan" id="kobo.218.1"> is necessary for any production environment. </span><span class="koboSpan" id="kobo.218.2">Failing to do so will result in the traceback information and sensitive configuration data being exposed to everyone.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.219.1">ADMINS</span></code><span class="koboSpan" id="kobo.220.1">: When </span><code class="inlineCode"><span class="koboSpan" id="kobo.221.1">DEBUG</span></code><span class="koboSpan" id="kobo.222.1"> is </span><code class="inlineCode"><span class="koboSpan" id="kobo.223.1">False</span></code><span class="koboSpan" id="kobo.224.1"> and a view raises an exception, all information will be sent by email to the people listed in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.225.1">ADMINS</span></code><span class="koboSpan" id="kobo.226.1"> setting. </span><span class="koboSpan" id="kobo.226.2">Make sure that you replace the name/email tuple with your own information.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.227.1">ALLOWED_HOSTS</span></code><span class="koboSpan" id="kobo.228.1">: For security reasons, Django will only allow the hosts included in this list to serve the project. </span><span class="koboSpan" id="kobo.228.2">For now, you allow all hosts by using the asterisk symbol, </span><code class="inlineCode"><span class="koboSpan" id="kobo.229.1">*</span></code><span class="koboSpan" id="kobo.230.1">. </span><span class="koboSpan" id="kobo.230.2">You will limit the hosts that can be used for serving the project later.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.231.1">DATABASES</span></code><span class="koboSpan" id="kobo.232.1">: You keep the </span><code class="inlineCode"><span class="koboSpan" id="kobo.233.1">default</span></code><span class="koboSpan" id="kobo.234.1"> database settings pointing to the SQLite database of your local environment. </span><span class="koboSpan" id="kobo.234.2">You will configure the production database later.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.235.1">Over the </span><a id="_idIndexMarker1545"/><span class="koboSpan" id="kobo.236.1">next sections of this </span><a id="_idIndexMarker1546"/><span class="koboSpan" id="kobo.237.1">chapter, you will complete the settings file for your production environment.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.238.1">You have successfully organized settings for handling multiple environments. </span><span class="koboSpan" id="kobo.238.2">Now, you will build a complete production environment by setting up different services with Docker.</span></p>
<h1 class="heading-1" id="_idParaDest-452"><span class="koboSpan" id="kobo.239.1">Using Docker Compose</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.240.1">You initially used Docker in </span><em class="italic"><span class="koboSpan" id="kobo.241.1">Chapter 3</span></em><span class="koboSpan" id="kobo.242.1">, </span><em class="italic"><span class="koboSpan" id="kobo.243.1">Extending Your Blog Application</span></em><span class="koboSpan" id="kobo.244.1">, and you have been using Docker throughout this book to run containers for different services, such as PostgreSQL, Redis, and RabbitMQ.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.245.1">Each Docker </span><a id="_idIndexMarker1547"/><span class="koboSpan" id="kobo.246.1">container combines application source code with operating system libraries and dependencies required to run the application. </span><span class="koboSpan" id="kobo.246.2">By using application containers, you can improve your application portability. </span><span class="koboSpan" id="kobo.246.3">For the production environment, we will use Docker Compose to build and run multiple Docker containers.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.247.1">Docker Compose is a tool for defining and running multi-container applications. </span><span class="koboSpan" id="kobo.247.2">You can create a configuration file to define the different services and use a single command to start all services </span><a id="_idIndexMarker1548"/><span class="koboSpan" id="kobo.248.1">from your configuration. </span><span class="koboSpan" id="kobo.248.2">You can find information about Docker Compose at </span><a href="https://docs.docker.com/compose/"><span class="url"><span class="koboSpan" id="kobo.249.1">https://docs.docker.com/compose/</span></span></a><span class="koboSpan" id="kobo.250.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.251.1">For the production environment, you will create a distributed application that runs across multiple Docker containers. </span><span class="koboSpan" id="kobo.251.2">Each Docker container will run a different service. </span><span class="koboSpan" id="kobo.251.3">You will initially </span><a id="_idIndexMarker1549"/><span class="koboSpan" id="kobo.252.1">define the following three services and you will add additional services in the next sections:</span></p>
<ul>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.253.1">Web service</span></strong><span class="koboSpan" id="kobo.254.1">: A web </span><a id="_idIndexMarker1550"/><span class="koboSpan" id="kobo.255.1">server to serve the Django project</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.256.1">Database service</span></strong><span class="koboSpan" id="kobo.257.1">: A database </span><a id="_idIndexMarker1551"/><span class="koboSpan" id="kobo.258.1">service to run PostgreSQL</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.259.1">Cache service</span></strong><span class="koboSpan" id="kobo.260.1">: A </span><a id="_idIndexMarker1552"/><span class="koboSpan" id="kobo.261.1">service to run Redis</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.262.1">Let’s start by installing Docker Compose.</span></p>
<h2 class="heading-2" id="_idParaDest-453"><span class="koboSpan" id="kobo.263.1">Installing Docker Compose via Docker Desktop</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.264.1">You can run Docker Compose on macOS, 64-bit Linux, and Windows. </span><span class="koboSpan" id="kobo.264.2">The fastest way to install </span><a id="_idIndexMarker1553"/><span class="koboSpan" id="kobo.265.1">Docker Compose is by installing </span><a id="_idIndexMarker1554"/><span class="koboSpan" id="kobo.266.1">Docker Desktop. </span><span class="koboSpan" id="kobo.266.2">The installation includes Docker Engine, the command-line interface, and Docker Compose.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.267.1">Install </span><a id="_idIndexMarker1555"/><span class="koboSpan" id="kobo.268.1">Docker Desktop by following the instructions at </span><a href="https://docs.docker.com/compose/install/compose-desktop/"><span class="url"><span class="koboSpan" id="kobo.269.1">https://docs.docker.com/compose/install/compose-desktop/</span></span></a><span class="koboSpan" id="kobo.270.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.271.1">Open the Docker Desktop application and click on </span><strong class="screenText"><span class="koboSpan" id="kobo.272.1">Containers</span></strong><span class="koboSpan" id="kobo.273.1">. </span><span class="koboSpan" id="kobo.273.2">It will look as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.274.1"><img alt="" role="presentation" src="../Images/B21088_17_01.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.275.1">Figure 17.1: The Docker Desktop interface</span></p>
<p class="normal"><span class="koboSpan" id="kobo.276.1">After </span><a id="_idIndexMarker1556"/><span class="koboSpan" id="kobo.277.1">installing Docker Compose, you need to </span><a id="_idIndexMarker1557"/><span class="koboSpan" id="kobo.278.1">create a Docker image for your Django project.</span></p>
<h2 class="heading-2" id="_idParaDest-454"><span class="koboSpan" id="kobo.279.1">Creating a Dockerfile</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.280.1">You need to create a Docker image to run the Django project. </span><span class="koboSpan" id="kobo.280.2">A </span><code class="inlineCode"><span class="koboSpan" id="kobo.281.1">Dockerfile</span></code><span class="koboSpan" id="kobo.282.1"> is a text file that contains </span><a id="_idIndexMarker1558"/><span class="koboSpan" id="kobo.283.1">the commands for Docker to assemble a Docker image. </span><span class="koboSpan" id="kobo.283.2">You will prepare a </span><code class="inlineCode"><span class="koboSpan" id="kobo.284.1">Dockerfile</span></code><span class="koboSpan" id="kobo.285.1"> with the commands for building the </span><a id="_idIndexMarker1559"/><span class="koboSpan" id="kobo.286.1">Docker image for the Django project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.287.1">Next to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.288.1">educa</span></code><span class="koboSpan" id="kobo.289.1"> project directory, create a new file and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.290.1">Dockerfile</span></code><span class="koboSpan" id="kobo.291.1">. </span><span class="koboSpan" id="kobo.291.2">Add the following code to the new file:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.292.1"># Pull official base Python Docker image</span></span><span class="koboSpan" id="kobo.293.1">
FROM python:</span><span class="hljs-number"><span class="koboSpan" id="kobo.294.1">3.12.3</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.295.1"># Set environment variables</span></span><span class="koboSpan" id="kobo.296.1">
ENV PYTHONDONTWRITEBYTECODE=</span><span class="hljs-number"><span class="koboSpan" id="kobo.297.1">1</span></span><span class="koboSpan" id="kobo.298.1">
ENV PYTHONUNBUFFERED=</span><span class="hljs-number"><span class="koboSpan" id="kobo.299.1">1</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.300.1"># Set work directory</span></span><span class="koboSpan" id="kobo.301.1">
WORKDIR /code
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.302.1"># Install dependencies</span></span><span class="koboSpan" id="kobo.303.1">
RUN pip install --upgrade pip
COPY requirements.txt .
</span><span class="koboSpan" id="kobo.303.2">RUN pip install -r requirements.txt
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.304.1"># Copy the Django project</span></span><span class="koboSpan" id="kobo.305.1">
COPY . </span><span class="koboSpan" id="kobo.305.2">.
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.306.1">This code </span><a id="_idIndexMarker1560"/><span class="koboSpan" id="kobo.307.1">performs the following tasks:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.308.1">The </span><a id="_idIndexMarker1561"/><span class="koboSpan" id="kobo.309.1">Python </span><code class="inlineCode"><span class="koboSpan" id="kobo.310.1">3.12.3</span></code><span class="koboSpan" id="kobo.311.1"> parent Docker image is used. </span><span class="koboSpan" id="kobo.311.2">You can </span><a id="_idIndexMarker1562"/><span class="koboSpan" id="kobo.312.1">find the official Python Docker image at </span><a href="https://hub.docker.com/_/python"><span class="url"><span class="koboSpan" id="kobo.313.1">https://hub.docker.com/_/python</span></span></a><span class="koboSpan" id="kobo.314.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.315.1">The following environment variables are set:</span><ol class="alphabeticList" style="list-style-type: lower-alpha;">
<li class="alphabeticList" value="1"><code class="inlineCode"><span class="koboSpan" id="kobo.316.1">PYTHONDONTWRITEBYTECODE</span></code><span class="koboSpan" id="kobo.317.1">: This prevents Python from writing out </span><code class="inlineCode"><span class="koboSpan" id="kobo.318.1">pyc</span></code><span class="koboSpan" id="kobo.319.1"> files.</span></li>
<li class="alphabeticList"><code class="inlineCode"><span class="koboSpan" id="kobo.320.1">PYTHONUNBUFFERED</span></code><span class="koboSpan" id="kobo.321.1">: This ensures that the Python </span><code class="inlineCode"><span class="koboSpan" id="kobo.322.1">stdout</span></code><span class="koboSpan" id="kobo.323.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.324.1">stderr</span></code><span class="koboSpan" id="kobo.325.1"> streams are sent straight to the terminal without first being buffered.</span></li>
</ol>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.326.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.327.1">WORKDIR</span></code><span class="koboSpan" id="kobo.328.1"> command is used to define the working directory of the image.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.329.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.330.1">pip</span></code><span class="koboSpan" id="kobo.331.1"> package of the image is upgraded.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.332.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.333.1">requirements.txt</span></code><span class="koboSpan" id="kobo.334.1"> file is copied to the working directory (</span><code class="inlineCode"><span class="koboSpan" id="kobo.335.1">.</span></code><span class="koboSpan" id="kobo.336.1">) of the parent Python image.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.337.1">The Python packages in </span><code class="inlineCode"><span class="koboSpan" id="kobo.338.1">requirements.txt</span></code><span class="koboSpan" id="kobo.339.1"> are installed in the image using </span><code class="inlineCode"><span class="koboSpan" id="kobo.340.1">pip</span></code><span class="koboSpan" id="kobo.341.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.342.1">The Django project source code is copied from the local directory to the working directory (</span><code class="inlineCode"><span class="koboSpan" id="kobo.343.1">.</span></code><span class="koboSpan" id="kobo.344.1">) directory of the image.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.345.1">With this </span><code class="inlineCode"><span class="koboSpan" id="kobo.346.1">Dockerfile</span></code><span class="koboSpan" id="kobo.347.1">, you have defined how the Docker image that will serve Django will be assembled. </span><span class="koboSpan" id="kobo.347.2">You can find the </span><code class="inlineCode"><span class="koboSpan" id="kobo.348.1">Dockerfile</span></code><span class="koboSpan" id="kobo.349.1"> reference at </span><a href="https://docs.docker.com/reference/dockerfile/"><span class="url"><span class="koboSpan" id="kobo.350.1">https://docs.docker.com/reference/dockerfile/</span></span></a><span class="koboSpan" id="kobo.351.1">.</span></p>
<h2 class="heading-2" id="_idParaDest-455"><span class="koboSpan" id="kobo.352.1">Adding the Python requirements</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.353.1">A </span><code class="inlineCode"><span class="koboSpan" id="kobo.354.1">requirements.txt</span></code><span class="koboSpan" id="kobo.355.1"> file is used in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.356.1">Dockerfile</span></code><span class="koboSpan" id="kobo.357.1"> you created to install all of the necessary </span><a id="_idIndexMarker1563"/><span class="koboSpan" id="kobo.358.1">Python packages for the project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.359.1">Next to </span><a id="_idIndexMarker1564"/><span class="koboSpan" id="kobo.360.1">the </span><code class="inlineCode"><span class="koboSpan" id="kobo.361.1">educa</span></code><span class="koboSpan" id="kobo.362.1"> project directory, create a new file and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.363.1">requirements.txt</span></code><span class="koboSpan" id="kobo.364.1">. </span><span class="koboSpan" id="kobo.364.2">You may have already created this file before and copied the content for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.365.1">requirements.txt</span></code><span class="koboSpan" id="kobo.366.1"> file from </span><a href="https://github.com/PacktPublishing/Django-5-by-example/blob/main/Chapter17/requirements.txt"><span class="url"><span class="koboSpan" id="kobo.367.1">https://github.com/PacktPublishing/Django-5-by-example/blob/main/Chapter17/requirements.txt</span></span></a><span class="koboSpan" id="kobo.368.1">. </span><span class="koboSpan" id="kobo.368.2">If you haven’t done so, add the following lines to the newly created </span><code class="inlineCode"><span class="koboSpan" id="kobo.369.1">requirements.txt</span></code><span class="koboSpan" id="kobo.370.1"> file:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.371.1">asgiref==</span><span class="hljs-number"><span class="koboSpan" id="kobo.372.1">3.8.1</span></span><span class="koboSpan" id="kobo.373.1">
Django~=</span><span class="hljs-number"><span class="koboSpan" id="kobo.374.1">5.0.4</span></span><span class="koboSpan" id="kobo.375.1">
Pillow==</span><span class="hljs-number"><span class="koboSpan" id="kobo.376.1">10.3.0</span></span><span class="koboSpan" id="kobo.377.1">
sqlparse==</span><span class="hljs-number"><span class="koboSpan" id="kobo.378.1">0.5.0</span></span><span class="koboSpan" id="kobo.379.1">
django-braces==</span><span class="hljs-number"><span class="koboSpan" id="kobo.380.1">1.15.0</span></span><span class="koboSpan" id="kobo.381.1">
django-embed-video==</span><span class="hljs-number"><span class="koboSpan" id="kobo.382.1">1.4.9</span></span><span class="koboSpan" id="kobo.383.1">
pymemcache==</span><span class="hljs-number"><span class="koboSpan" id="kobo.384.1">4.0.0</span></span><span class="koboSpan" id="kobo.385.1">
django-debug-toolbar==</span><span class="hljs-number"><span class="koboSpan" id="kobo.386.1">4.3.0</span></span><span class="koboSpan" id="kobo.387.1">
redis==</span><span class="hljs-number"><span class="koboSpan" id="kobo.388.1">5.0.4</span></span><span class="koboSpan" id="kobo.389.1">
django-redisboard==</span><span class="hljs-number"><span class="koboSpan" id="kobo.390.1">8.4.0</span></span><span class="koboSpan" id="kobo.391.1">
djangorestframework==</span><span class="hljs-number"><span class="koboSpan" id="kobo.392.1">3.15.1</span></span><span class="koboSpan" id="kobo.393.1">
requests==</span><span class="hljs-number"><span class="koboSpan" id="kobo.394.1">2.31.0</span></span><span class="koboSpan" id="kobo.395.1">
channels[daphne]==</span><span class="hljs-number"><span class="koboSpan" id="kobo.396.1">4.1.0</span></span><span class="koboSpan" id="kobo.397.1">
channels-redis==</span><span class="hljs-number"><span class="koboSpan" id="kobo.398.1">4.2.0</span></span><span class="koboSpan" id="kobo.399.1">
psycopg==</span><span class="hljs-number"><span class="koboSpan" id="kobo.400.1">3.1.18</span></span><span class="koboSpan" id="kobo.401.1">
uwsgi==</span><span class="hljs-number"><span class="koboSpan" id="kobo.402.1">2.0.25.1</span></span><span class="koboSpan" id="kobo.403.1">
python-decouple==</span><span class="hljs-number"><span class="koboSpan" id="kobo.404.1">3.8</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.405.1">In addition to the Python packages that you installed in the previous chapters, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.406.1">requirements.txt </span></code><span class="koboSpan" id="kobo.407.1">file includes the following packages:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.408.1">psycopg</span></code><span class="koboSpan" id="kobo.409.1">: This is </span><a id="_idIndexMarker1565"/><span class="koboSpan" id="kobo.410.1">the PostgreSQL adapter. </span><span class="koboSpan" id="kobo.410.2">You will use PostgreSQL for the production environment.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.411.1">uwsgi</span></code><span class="koboSpan" id="kobo.412.1">: A WSGI </span><a id="_idIndexMarker1566"/><span class="koboSpan" id="kobo.413.1">web server. </span><span class="koboSpan" id="kobo.413.2">You will configure this web server later to serve Django in the production environment.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.414.1">python-decouple</span></code><span class="koboSpan" id="kobo.415.1">: Package to load environment variables easily.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.416.1">Let’s start by setting up the Docker application in Docker Compose. </span><span class="koboSpan" id="kobo.416.2">We will create a Docker Compose file with the definition for the web server, database, and Redis services.</span></p>
<h2 class="heading-2" id="_idParaDest-456"><span class="koboSpan" id="kobo.417.1">Creating a Docker Compose file</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.418.1">To define the services that will run in different Docker containers, we will use a Docker Compose file. </span><span class="koboSpan" id="kobo.418.2">The Compose file is a text file in YAML format, defining services, networks, and data </span><a id="_idIndexMarker1567"/><span class="koboSpan" id="kobo.419.1">volumes for a Docker application. </span><span class="koboSpan" id="kobo.419.2">YAML is a human-readable data-serialization language. </span><span class="koboSpan" id="kobo.419.3">You can see an example of a YAML file at </span><a href="https://yaml.org/"><span class="url"><span class="koboSpan" id="kobo.420.1">https://yaml.org/</span></span></a><span class="koboSpan" id="kobo.421.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.422.1">Next to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.423.1">educa</span></code><span class="koboSpan" id="kobo.424.1"> project directory, create a new file and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.425.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.426.1">. </span><span class="koboSpan" id="kobo.426.2">Add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.427.1">services:
  web:
    build: .
    </span><span class="koboSpan" id="kobo.427.2">command: python /code/educa/manage.py runserver </span><span class="hljs-number"><span class="koboSpan" id="kobo.428.1">0.0.0.0</span></span><span class="koboSpan" id="kobo.429.1">:</span><span class="hljs-number"><span class="koboSpan" id="kobo.430.1">8000</span></span><span class="koboSpan" id="kobo.431.1">
    restart: always
    volumes:
      - .:/code
    ports:
      - </span><span class="hljs-string"><span class="koboSpan" id="kobo.432.1">"8000:8000"</span></span><span class="koboSpan" id="kobo.433.1">
    environment:
      - DJANGO_SETTINGS_MODULE=educa.settings.prod
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.434.1">In this file, you define a </span><code class="inlineCode"><span class="koboSpan" id="kobo.435.1">web</span></code><span class="koboSpan" id="kobo.436.1"> service. </span><span class="koboSpan" id="kobo.436.2">The sections to define this service are as follows:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.437.1">build</span></code><span class="koboSpan" id="kobo.438.1">: This defines the build requirements for a service container image. </span><span class="koboSpan" id="kobo.438.2">This can </span><a id="_idIndexMarker1568"/><span class="koboSpan" id="kobo.439.1">be a single string defining a context path, or a detailed build definition. </span><span class="koboSpan" id="kobo.439.2">You provide a relative path with a single dot (</span><code class="inlineCode"><span class="koboSpan" id="kobo.440.1">.</span></code><span class="koboSpan" id="kobo.441.1">) to point to the same directory where the Compose file is located. </span><span class="koboSpan" id="kobo.441.2">Docker Compose will look for a </span><code class="inlineCode"><span class="koboSpan" id="kobo.442.1">Dockerfile</span></code><span class="koboSpan" id="kobo.443.1"> at this location. </span><span class="koboSpan" id="kobo.443.2">You can read more about the </span><code class="inlineCode"><span class="koboSpan" id="kobo.444.1">build</span></code><span class="koboSpan" id="kobo.445.1"> section at </span><a href="https://docs.docker.com/compose/compose-file/build/"><span class="url"><span class="koboSpan" id="kobo.446.1">https://docs.docker.com/compose/compose-file/build/</span></span></a><span class="koboSpan" id="kobo.447.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.448.1">command</span></code><span class="koboSpan" id="kobo.449.1">: This overrides </span><a id="_idIndexMarker1569"/><span class="koboSpan" id="kobo.450.1">the default command of the container. </span><span class="koboSpan" id="kobo.450.2">You run the Django development server using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.451.1">runserver</span></code><span class="koboSpan" id="kobo.452.1"> management command. </span><span class="koboSpan" id="kobo.452.2">The project is served on host </span><code class="inlineCode"><span class="koboSpan" id="kobo.453.1">0.0.0.0</span></code><span class="koboSpan" id="kobo.454.1">, which is the default Docker IP, on port </span><code class="inlineCode"><span class="koboSpan" id="kobo.455.1">8000</span></code><span class="koboSpan" id="kobo.456.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.457.1">restart</span></code><span class="koboSpan" id="kobo.458.1">: This </span><a id="_idIndexMarker1570"/><span class="koboSpan" id="kobo.459.1">defines the restart policy for the container. </span><span class="koboSpan" id="kobo.459.2">Using </span><code class="inlineCode"><span class="koboSpan" id="kobo.460.1">always</span></code><span class="koboSpan" id="kobo.461.1">, the container is always restarted if it stops. </span><span class="koboSpan" id="kobo.461.2">This is useful for a production environment where you want to minimize downtime. </span><span class="koboSpan" id="kobo.461.3">You can read more about the restart policy at </span><a href="https://docs.docker.com/config/containers/start-containers-automatically/"><span class="url"><span class="koboSpan" id="kobo.462.1">https://docs.docker.com/config/containers/start-containers-automatically/</span></span></a><span class="koboSpan" id="kobo.463.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.464.1">volumes</span></code><span class="koboSpan" id="kobo.465.1">: Data in </span><a id="_idIndexMarker1571"/><span class="koboSpan" id="kobo.466.1">Docker containers is not permanent. </span><span class="koboSpan" id="kobo.466.2">Each Docker container has a virtual filesystem that is populated with the files of the image and that is destroyed when the container is stopped. </span><span class="koboSpan" id="kobo.466.3">Volumes are the preferred method to persist data generated and used by Docker containers. </span><span class="koboSpan" id="kobo.466.4">In this section, you mount the local . </span><span class="koboSpan" id="kobo.466.5">directory to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.467.1">/code</span></code><span class="koboSpan" id="kobo.468.1"> directory of the image. </span><span class="koboSpan" id="kobo.468.2">You can read more about Docker volumes at </span><a href="https://docs.docker.com/storage/volumes/"><span class="url"><span class="koboSpan" id="kobo.469.1">https://docs.docker.com/storage/volumes/</span></span></a><span class="koboSpan" id="kobo.470.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.471.1">ports</span></code><span class="koboSpan" id="kobo.472.1">: This exposes </span><a id="_idIndexMarker1572"/><span class="koboSpan" id="kobo.473.1">container ports. </span><span class="koboSpan" id="kobo.473.2">Host port </span><code class="inlineCode"><span class="koboSpan" id="kobo.474.1">8000</span></code><span class="koboSpan" id="kobo.475.1"> is mapped to container port </span><code class="inlineCode"><span class="koboSpan" id="kobo.476.1">8000</span></code><span class="koboSpan" id="kobo.477.1">, on which the Django development server is running.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.478.1">environment</span></code><span class="koboSpan" id="kobo.479.1">: This </span><a id="_idIndexMarker1573"/><span class="koboSpan" id="kobo.480.1">defines environment variables. </span><span class="koboSpan" id="kobo.480.2">You set the </span><code class="inlineCode"><span class="koboSpan" id="kobo.481.1">DJANGO_SETTINGS_MODULE</span></code><span class="koboSpan" id="kobo.482.1"> environment variable to use the production Django settings file </span><code class="inlineCode"><span class="koboSpan" id="kobo.483.1">educa.settings.prod</span></code><span class="koboSpan" id="kobo.484.1">.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.485.1">Note that in the Docker Compose file definition, you are using the Django development server to </span><a id="_idIndexMarker1574"/><span class="koboSpan" id="kobo.486.1">serve the application. </span><span class="koboSpan" id="kobo.486.2">The Django development server is not suitable for production use, so you will replace it later with a WSGI Python web server.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.487.1">You can </span><a id="_idIndexMarker1575"/><span class="koboSpan" id="kobo.488.1">find information about the Docker Compose specification at </span><a href="https://docs.docker.com/compose/compose-file/"><span class="url"><span class="koboSpan" id="kobo.489.1">https://docs.docker.com/compose/compose-file/</span></span></a><span class="koboSpan" id="kobo.490.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.491.1">At this point, assuming your parent directory is named </span><code class="inlineCode"><span class="koboSpan" id="kobo.492.1">Chapter17</span></code><span class="koboSpan" id="kobo.493.1">, the file structure should look as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.494.1">Chapter17/
    Dockerfile
    docker-compose.yml
    educa/
        manage.py
        ...
    </span><span class="koboSpan" id="kobo.494.2">requirements.txt
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.495.1">Open a shell in the parent directory, where the </span><code class="inlineCode"><span class="koboSpan" id="kobo.496.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.497.1"> file is located, and run the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.498.1">docker compose up
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.499.1">This will </span><a id="_idIndexMarker1576"/><span class="koboSpan" id="kobo.500.1">start the Docker app defined in the Docker Compose file. </span><span class="koboSpan" id="kobo.500.2">You will see an output that includes the following lines:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.501.1">chapter17-web-1  | Performing system checks...
</span><span class="koboSpan" id="kobo.501.2">chapter17-web-1  |
chapter17-web-1  | System check identified no issues (0 silenced).
</span><span class="koboSpan" id="kobo.501.3">chapter17-web-1  | March 10, 2024 - 12:03:28
chapter17-web-1  | Django version 5.0.4, using settings 'educa.settings.prod'
chapter17-web-1  | Starting ASGI/Daphne version 4.1.0 development server at http://0.0.0.0:8000/
chapter17-web-1  | Quit the server with CONTROL-C.
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.502.1">The Docker container for your Django project is running!</span></p>
<p class="normal"><span class="koboSpan" id="kobo.503.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.504.1">http://0.0.0.0:8000/admin/</span></code><span class="koboSpan" id="kobo.505.1"> with your browser. </span><span class="koboSpan" id="kobo.505.2">You should see the Django administration site login form. </span><span class="koboSpan" id="kobo.505.3">It should look like </span><em class="italic"><span class="koboSpan" id="kobo.506.1">Figure 17.2</span></em><span class="koboSpan" id="kobo.507.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.508.1"><img alt="" role="presentation" src="../Images/B21088_17_02.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.509.1">Figure 17.2: The Django administration site login form with no CSS styles applied</span></p>
<p class="normal"><span class="koboSpan" id="kobo.510.1">CSS styles </span><a id="_idIndexMarker1577"/><span class="koboSpan" id="kobo.511.1">are not loaded. </span><span class="koboSpan" id="kobo.511.2">You are using </span><code class="inlineCode"><span class="koboSpan" id="kobo.512.1">DEBUG=False</span></code><span class="koboSpan" id="kobo.513.1">, so URL patterns for serving static files are not being included in the main </span><code class="inlineCode"><span class="koboSpan" id="kobo.514.1">urls.py</span></code><span class="koboSpan" id="kobo.515.1"> file of the project. </span><span class="koboSpan" id="kobo.515.2">Remember that the Django development server is not suitable for serving static files. </span><span class="koboSpan" id="kobo.515.3">You will configure a server for serving static files later in this chapter.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.516.1">If you access any other URL of your site, you might get an HTTP </span><code class="inlineCode"><span class="koboSpan" id="kobo.517.1">500</span></code><span class="koboSpan" id="kobo.518.1"> error because you haven’t configured a database for the production environment yet.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.519.1">Take a look at the Docker Desktop app. </span><span class="koboSpan" id="kobo.519.2">You will see the following containers:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.520.1"><img alt="" role="presentation" src="../Images/B21088_17_03.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.521.1">Figure 17.3: The chapter17 application and the web-1 container in Docker Desktop</span></p>
<p class="normal"><span class="koboSpan" id="kobo.522.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.523.1">chapter17</span></code><span class="koboSpan" id="kobo.524.1"> Docker application is running and it has a single container named </span><code class="inlineCode"><span class="koboSpan" id="kobo.525.1">web-1</span></code><span class="koboSpan" id="kobo.526.1">, which is running on port </span><code class="inlineCode"><span class="koboSpan" id="kobo.527.1">8000</span></code><span class="koboSpan" id="kobo.528.1">. </span><span class="koboSpan" id="kobo.528.2">The name for the Docker application is generated dynamically </span><a id="_idIndexMarker1578"/><span class="koboSpan" id="kobo.529.1">using the name of the directory where the Docker Compose file is located, in this case, </span><code class="inlineCode"><span class="koboSpan" id="kobo.530.1">chapter17</span></code><span class="koboSpan" id="kobo.531.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.532.1">Under </span><strong class="screenText"><span class="koboSpan" id="kobo.533.1">Images</span></strong><span class="koboSpan" id="kobo.534.1">, you will see the image built for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.535.1">web</span></code><span class="koboSpan" id="kobo.536.1"> service, as in </span><em class="italic"><span class="koboSpan" id="kobo.537.1">Figure 17.4</span></em><span class="koboSpan" id="kobo.538.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.539.1"><img alt="" role="presentation" src="../Images/B21088_17_04.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.540.1">Figure 17.4: The chapter17 application and the web-1 container in Docker Desktop</span></p>
<p class="normal"><span class="koboSpan" id="kobo.541.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.542.1">chapter17-web</span></code><span class="koboSpan" id="kobo.543.1"> image has been built using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.544.1">Dockerfile</span></code><span class="koboSpan" id="kobo.545.1"> you defined earlier and is used by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.546.1">web-1</span></code><span class="koboSpan" id="kobo.547.1"> container.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.548.1">Next, you are going to add a PostgreSQL service and a Redis service to your Docker application.</span></p>
<h2 class="heading-2" id="_idParaDest-457"><span class="koboSpan" id="kobo.549.1">Configuring the PostgreSQL service</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.550.1">Throughout this book, you have mostly used the SQLite database. </span><span class="koboSpan" id="kobo.550.2">SQLite is simple and quick to </span><a id="_idIndexMarker1579"/><span class="koboSpan" id="kobo.551.1">set up, but for a production environment, you will need a more powerful database, such as PostgreSQL, MySQL, or Oracle. </span><span class="koboSpan" id="kobo.551.2">You used Docker to install PostgreSQL in </span><em class="italic"><span class="koboSpan" id="kobo.552.1">Chapter 3</span></em><span class="koboSpan" id="kobo.553.1">, </span><em class="italic"><span class="koboSpan" id="kobo.554.1">Extending Your Blog Application</span></em><span class="koboSpan" id="kobo.555.1">. </span><span class="koboSpan" id="kobo.555.2">You can </span><a id="_idIndexMarker1580"/><span class="koboSpan" id="kobo.556.1">find information about the official PostgreSQL Docker image at </span><a href="https://hub.docker.com/_/postgres"><span class="url"><span class="koboSpan" id="kobo.557.1">https://hub.docker.com/_/postgres</span></span></a><span class="koboSpan" id="kobo.558.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.559.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.560.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.561.1"> file and add the following lines highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.562.1">services:
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.563.1">  db:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.564.1">    image: postgres:</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.565.1">16.2</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.566.1">    restart: always</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.567.1">    volumes:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.568.1">      - ./data/db:/var/lib/postgresql/data</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.569.1">    environment:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.570.1">      - POSTGRES_DB=postgres</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.571.1">      - POSTGRES_USER=postgres</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.572.1">      - POSTGRES_PASSWORD=postgres</span></strong></span><span class="koboSpan" id="kobo.573.1">
  web:
    build: .
    </span><span class="koboSpan" id="kobo.573.2">command: python /code/educa/manage.py runserver </span><span class="hljs-number"><span class="koboSpan" id="kobo.574.1">0.0.0.0</span></span><span class="koboSpan" id="kobo.575.1">:</span><span class="hljs-number"><span class="koboSpan" id="kobo.576.1">8000</span></span><span class="koboSpan" id="kobo.577.1">
    restart: always
    volumes:
      - .:/code
    ports:
      - </span><span class="hljs-string"><span class="koboSpan" id="kobo.578.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.579.1">8000:8000"</span></span><span class="koboSpan" id="kobo.580.1">
    environment:
      - DJANGO_SETTINGS_MODULE=educa.settings.prod
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.581.1">      - POSTGRES_DB=postgres</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.582.1">      - POSTGRES_USER=postgres</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.583.1">      - POSTGRES_PASSWORD=postgres</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.584.1">    depends_on:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.585.1">      - db</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.586.1">With these </span><a id="_idIndexMarker1581"/><span class="koboSpan" id="kobo.587.1">changes, you define a service named </span><code class="inlineCode"><span class="koboSpan" id="kobo.588.1">db</span></code><span class="koboSpan" id="kobo.589.1"> with the following subsections:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.590.1">image</span></code><span class="koboSpan" id="kobo.591.1">: The service uses the base </span><code class="inlineCode"><span class="koboSpan" id="kobo.592.1">postgres</span></code><span class="koboSpan" id="kobo.593.1"> Docker image.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.594.1">restart</span></code><span class="koboSpan" id="kobo.595.1">: The restart policy is set to </span><code class="inlineCode"><span class="koboSpan" id="kobo.596.1">always</span></code><span class="koboSpan" id="kobo.597.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.598.1">volumes</span></code><span class="koboSpan" id="kobo.599.1">: You mount the </span><code class="inlineCode"><span class="koboSpan" id="kobo.600.1">./data/db</span></code><span class="koboSpan" id="kobo.601.1"> directory to the image directory </span><code class="inlineCode"><span class="koboSpan" id="kobo.602.1">/var/lib/postgresql/data</span></code><span class="koboSpan" id="kobo.603.1"> to persist the database so that data stored in the database is maintained after the Docker application is stopped. </span><span class="koboSpan" id="kobo.603.2">This will create the local </span><code class="inlineCode"><span class="koboSpan" id="kobo.604.1">data/db/</span></code><span class="koboSpan" id="kobo.605.1"> path.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.606.1">environment</span></code><span class="koboSpan" id="kobo.607.1">: You use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.608.1">POSTGRES_DB</span></code><span class="koboSpan" id="kobo.609.1"> (database name), </span><code class="inlineCode"><span class="koboSpan" id="kobo.610.1">POSTGRES_USER</span></code><span class="koboSpan" id="kobo.611.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.612.1">POSTGRES_PASSWORD</span></code><span class="koboSpan" id="kobo.613.1"> variables with default values.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.614.1">The definition for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.615.1">web</span></code><span class="koboSpan" id="kobo.616.1"> service now includes the PostgreSQL environment variables for Django. </span><span class="koboSpan" id="kobo.616.2">You create a service dependency using </span><code class="inlineCode"><span class="koboSpan" id="kobo.617.1">depends_on</span></code><span class="koboSpan" id="kobo.618.1"> so that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.619.1">web</span></code><span class="koboSpan" id="kobo.620.1"> service is started after the </span><code class="inlineCode"><span class="koboSpan" id="kobo.621.1">db</span></code><span class="koboSpan" id="kobo.622.1"> service. </span><span class="koboSpan" id="kobo.622.2">This will guarantee the order of the container initialization, but it won’t guarantee that PostgreSQL is fully initiated before the Django web server is started. </span><span class="koboSpan" id="kobo.622.3">To solve this, you need to use a script that will wait on the availability of the database host and its TCP port. </span><span class="koboSpan" id="kobo.622.4">Docker recommends that you use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.623.1">wait-for-it</span></code><span class="koboSpan" id="kobo.624.1"> tool to control container initialization.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.625.1">Download the </span><code class="inlineCode"><span class="koboSpan" id="kobo.626.1">wait-for-it.sh</span></code><span class="koboSpan" id="kobo.627.1"> bash script from </span><a href="https://github.com/vishnubob/wait-for-it/blob/master/wait-for-it.sh"><span class="url"><span class="koboSpan" id="kobo.628.1">https://github.com/vishnubob/wait-for-it/blob/master/wait-for-it.sh</span></span></a><span class="koboSpan" id="kobo.629.1"> and save the file next to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.630.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.631.1"> file. </span><span class="koboSpan" id="kobo.631.2">Then, edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.632.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.633.1"> file and modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.634.1">web</span></code><span class="koboSpan" id="kobo.635.1"> service definition as follows. </span><span class="koboSpan" id="kobo.635.2">The new code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.636.1">web:
  build: .
  </span><span class="koboSpan" id="kobo.636.2">command: </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.637.1">[</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.638.1">"</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.639.1">./wait-for-it.sh"</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.640.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.641.1">"db:5432"</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.642.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.643.1">"--"</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.644.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.645.1">"python"</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.646.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.647.1">"/code/educa/manage.py"</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.648.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.649.1">"runserver"</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.650.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.651.1">"0.0.0.0:8000"</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.652.1">]</span></strong></span><span class="koboSpan" id="kobo.653.1">
  restart: always
  volumes:
      - .:/code
    environment:
      - DJANGO_SETTINGS_MODULE=educa.settings.prod
      - POSTGRES_DB=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    depends_on:
      - db
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.654.1">In this service definition, you use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.655.1">wait-for-it.sh</span></code><span class="koboSpan" id="kobo.656.1"> bash script to wait for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.657.1">db</span></code><span class="koboSpan" id="kobo.658.1"> host to be ready </span><a id="_idIndexMarker1582"/><span class="koboSpan" id="kobo.659.1">and accept connections on port </span><code class="inlineCode"><span class="koboSpan" id="kobo.660.1">5432</span></code><span class="koboSpan" id="kobo.661.1">, the default port for PostgreSQL, before starting the Django development server. </span><span class="koboSpan" id="kobo.661.2">You can read more </span><a id="_idIndexMarker1583"/><span class="koboSpan" id="kobo.662.1">about the service startup order in Compose at </span><a href="https://docs.docker.com/compose/startup-order/"><span class="url"><span class="koboSpan" id="kobo.663.1">https://docs.docker.com/compose/startup-order/</span></span></a><span class="koboSpan" id="kobo.664.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.665.1">Let’s edit the Django settings. </span><span class="koboSpan" id="kobo.665.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.666.1">educa/settings/prod.py</span></code><span class="koboSpan" id="kobo.667.1"> file and add the following code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.668.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.669.1"> decouple </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.670.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.671.1"> config</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.672.1">from</span></span><span class="koboSpan" id="kobo.673.1"> .base </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.674.1">import</span></span><span class="koboSpan" id="kobo.675.1"> *	
DEBUG = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.676.1">False</span></span><span class="koboSpan" id="kobo.677.1">
ADMINS = [
    (</span><span class="hljs-string"><span class="koboSpan" id="kobo.678.1">'Antonio M'</span></span><span class="koboSpan" id="kobo.679.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.680.1">'email@mydomain.com'</span></span><span class="koboSpan" id="kobo.681.1">),
]
ALLOWED_HOSTS = [</span><span class="hljs-string"><span class="koboSpan" id="kobo.682.1">'*'</span></span><span class="koboSpan" id="kobo.683.1">]
DATABASES = {
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.684.1">'default'</span></span><span class="koboSpan" id="kobo.685.1">: {
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.686.1">'ENGINE'</span></span><span class="koboSpan" id="kobo.687.1">: </span><span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.688.1">'django.db.backends.postgresql'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.689.1">,</span></strong></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.690.1">'NAME'</span></span><span class="koboSpan" id="kobo.691.1">: </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.692.1">config(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.693.1">'POSTGRES_DB'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.694.1">),</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.695.1">'USER'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.696.1">: config(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.697.1">'POSTGRES_USER'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.698.1">),</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.699.1">'PASSWORD'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.700.1">: config(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.701.1">'POSTGRES_PASSWORD'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.702.1">),</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.703.1">'HOST'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.704.1">: </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.705.1">'db'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.706.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.707.1">'PORT'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.708.1">: </span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.709.1">5432</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.710.1">,</span></strong></span><span class="koboSpan" id="kobo.711.1">
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.712.1">In the production settings file, you use the following settings:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.713.1">ENGINE</span></code><span class="koboSpan" id="kobo.714.1">: You use the Django database backend for PostgreSQL.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.715.1">NAME</span></code><span class="koboSpan" id="kobo.716.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.717.1">USER</span></code><span class="koboSpan" id="kobo.718.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.719.1">PASSWORD</span></code><span class="koboSpan" id="kobo.720.1">: You use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.721.1">config()</span></code><span class="koboSpan" id="kobo.722.1"> function of </span><code class="inlineCode"><span class="koboSpan" id="kobo.723.1">python-decouple</span></code><span class="koboSpan" id="kobo.724.1"> to retrieve the </span><code class="inlineCode"><span class="koboSpan" id="kobo.725.1">POSTGRES_DB</span></code><span class="koboSpan" id="kobo.726.1"> (database name), </span><code class="inlineCode"><span class="koboSpan" id="kobo.727.1">POSTGRES_USER</span></code><span class="koboSpan" id="kobo.728.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.729.1">POSTGRES_PASSWORD</span></code><span class="koboSpan" id="kobo.730.1"> environment variables. </span><span class="koboSpan" id="kobo.730.2">You have set these environment variables in the Docker Compose file.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.731.1">HOST</span></code><span class="koboSpan" id="kobo.732.1">: You use </span><code class="inlineCode"><span class="koboSpan" id="kobo.733.1">db</span></code><span class="koboSpan" id="kobo.734.1">, which is the container hostname for the database service defined in the Docker Compose file. </span><span class="koboSpan" id="kobo.734.2">A container hostname defaults to the container’s ID in Docker. </span><span class="koboSpan" id="kobo.734.3">That’s why you use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.735.1">db</span></code><span class="koboSpan" id="kobo.736.1"> hostname.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.737.1">PORT</span></code><span class="koboSpan" id="kobo.738.1">: You use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.739.1">5432</span></code><span class="koboSpan" id="kobo.740.1"> value, which is the default port for PostgreSQL.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.741.1">Stop the Docker application from the shell by pressing the </span><em class="italic"><span class="koboSpan" id="kobo.742.1">Ctrl</span></em><span class="koboSpan" id="kobo.743.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.744.1">C</span></em><span class="koboSpan" id="kobo.745.1"> keys or using the stop button in the </span><a id="_idIndexMarker1584"/><span class="koboSpan" id="kobo.746.1">Docker Desktop app. </span><span class="koboSpan" id="kobo.746.2">Then, start Compose again with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.747.1">docker compose up
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.748.1">The first execution after adding the </span><code class="inlineCode"><span class="koboSpan" id="kobo.749.1">db</span></code><span class="koboSpan" id="kobo.750.1"> service to the Docker Compose file will take longer because PostgreSQL needs to initialize the database. </span><span class="koboSpan" id="kobo.750.2">The output will contain the following two lines:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.751.1">db-1   | ... </span><span class="koboSpan" id="kobo.751.2">database system is ready to accept connections
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.752.1">...</span></span><span class="koboSpan" id="kobo.753.1">
web-1  | Starting ASGI/Daphne version 4.1.0 development server at http://0.0.0.0:8000/
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.754.1">Both the PostgreSQL database and the Django application are ready. </span><span class="koboSpan" id="kobo.754.2">The production database is empty, so you need to apply database migrations.</span></p>
<h2 class="heading-2" id="_idParaDest-458"><span class="koboSpan" id="kobo.755.1">Applying database migrations and creating a superuser</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.756.1">Open a </span><a id="_idIndexMarker1585"/><span class="koboSpan" id="kobo.757.1">different shell in the parent </span><a id="_idIndexMarker1586"/><span class="koboSpan" id="kobo.758.1">directory, where the </span><code class="inlineCode"><span class="koboSpan" id="kobo.759.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.760.1"> file is located, and run the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.761.1">docker compose exec web python /code/educa/manage.py migrate
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.762.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.763.1">docker compose exec</span></code><span class="koboSpan" id="kobo.764.1"> command allows you to execute commands in the container. </span><span class="koboSpan" id="kobo.764.2">You use this command to execute the </span><code class="inlineCode"><span class="koboSpan" id="kobo.765.1">migrate</span></code><span class="koboSpan" id="kobo.766.1"> management command in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.767.1">web</span></code><span class="koboSpan" id="kobo.768.1"> Docker container.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.769.1">Finally, create a superuser with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.770.1">docker compose exec web python /code/educa/manage.py createsuperuser
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.771.1">Migrations have been applied to the database and you have created a superuser. </span><span class="koboSpan" id="kobo.771.2">You can access </span><code class="inlineCode"><span class="koboSpan" id="kobo.772.1">http://localhost:8000/admin/</span></code><span class="koboSpan" id="kobo.773.1"> with the superuser credentials. </span><span class="koboSpan" id="kobo.773.2">CSS styles still won’t load because you haven’t configured serving static files yet.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.774.1">You have defined services to serve Django and PostgreSQL using Docker Compose. </span><span class="koboSpan" id="kobo.774.2">Next, you will add a service to serve Redis in the production environment.</span></p>
<h2 class="heading-2" id="_idParaDest-459"><span class="koboSpan" id="kobo.775.1">Configuring the Redis service</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.776.1">Let’s add </span><a id="_idIndexMarker1587"/><span class="koboSpan" id="kobo.777.1">a Redis service to the Docker Compose file. </span><span class="koboSpan" id="kobo.777.2">For </span><a id="_idIndexMarker1588"/><span class="koboSpan" id="kobo.778.1">this purpose, you will use the official </span><a id="_idIndexMarker1589"/><span class="koboSpan" id="kobo.779.1">Redis Docker image. </span><span class="koboSpan" id="kobo.779.2">You can find information about the official Redis Docker image at </span><a href="https://hub.docker.com/_/redis"><span class="url"><span class="koboSpan" id="kobo.780.1">https://hub.docker.com/_/redis</span></span></a><span class="koboSpan" id="kobo.781.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.782.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.783.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.784.1"> file and add the following lines highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.785.1">services:
  db:
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.786.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.787.1">  cache:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.788.1">    image: redis:</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.789.1">7.2.4</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.790.1">    restart: always</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.791.1">    volumes:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.792.1">      - ./data/cache:/data</span></strong></span><span class="koboSpan" id="kobo.793.1">
  web:
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.794.1"># ...</span></span><span class="koboSpan" id="kobo.795.1">
    depends_on:
      - db
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.796.1">      - cache</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.797.1">In the previous code, you define the </span><code class="inlineCode"><span class="koboSpan" id="kobo.798.1">cache</span></code><span class="koboSpan" id="kobo.799.1"> service with the following subsections:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.800.1">image</span></code><span class="koboSpan" id="kobo.801.1">: The service uses the base </span><code class="inlineCode"><span class="koboSpan" id="kobo.802.1">redis</span></code><span class="koboSpan" id="kobo.803.1"> Docker image.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.804.1">restart</span></code><span class="koboSpan" id="kobo.805.1">: The restart policy is set to </span><code class="inlineCode"><span class="koboSpan" id="kobo.806.1">always</span></code><span class="koboSpan" id="kobo.807.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.808.1">volumes</span></code><span class="koboSpan" id="kobo.809.1">: You mount the </span><code class="inlineCode"><span class="koboSpan" id="kobo.810.1">./data/cache</span></code><span class="koboSpan" id="kobo.811.1"> directory to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.812.1">/data</span></code><span class="koboSpan" id="kobo.813.1"> image directory where any Redis writes will be persisted. </span><span class="koboSpan" id="kobo.813.2">This will create the local </span><code class="inlineCode"><span class="koboSpan" id="kobo.814.1">data/cache/</span></code><span class="koboSpan" id="kobo.815.1"> path.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.816.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.817.1">web</span></code><span class="koboSpan" id="kobo.818.1"> service definition, you add the </span><code class="inlineCode"><span class="koboSpan" id="kobo.819.1">cache</span></code><span class="koboSpan" id="kobo.820.1"> service as a dependency, so that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.821.1">web</span></code><span class="koboSpan" id="kobo.822.1"> service </span><a id="_idIndexMarker1590"/><span class="koboSpan" id="kobo.823.1">is started after the </span><code class="inlineCode"><span class="koboSpan" id="kobo.824.1">cache</span></code><span class="koboSpan" id="kobo.825.1"> service. </span><span class="koboSpan" id="kobo.825.2">The </span><a id="_idIndexMarker1591"/><span class="koboSpan" id="kobo.826.1">Redis server initializes fast, so you don’t need to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.827.1">wait-for-it</span></code><span class="koboSpan" id="kobo.828.1"> tool in this case.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.829.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.830.1">educa/settings/prod.py</span></code><span class="koboSpan" id="kobo.831.1"> file and add the following lines:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.832.1">REDIS_URL = </span><span class="hljs-string"><span class="koboSpan" id="kobo.833.1">'redis://cache:6379'</span></span><span class="koboSpan" id="kobo.834.1">
CACHES[</span><span class="hljs-string"><span class="koboSpan" id="kobo.835.1">'default'</span></span><span class="koboSpan" id="kobo.836.1">][</span><span class="hljs-string"><span class="koboSpan" id="kobo.837.1">'LOCATION'</span></span><span class="koboSpan" id="kobo.838.1">] = REDIS_URL
CHANNEL_LAYERS[</span><span class="hljs-string"><span class="koboSpan" id="kobo.839.1">'default'</span></span><span class="koboSpan" id="kobo.840.1">][</span><span class="hljs-string"><span class="koboSpan" id="kobo.841.1">'CONFIG'</span></span><span class="koboSpan" id="kobo.842.1">][</span><span class="hljs-string"><span class="koboSpan" id="kobo.843.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.844.1">hosts'</span></span><span class="koboSpan" id="kobo.845.1">] = [REDIS_URL]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.846.1">In these settings, you use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.847.1">cache</span></code><span class="koboSpan" id="kobo.848.1"> hostname that is automatically generated by Docker Compose using the name of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.849.1">cache</span></code><span class="koboSpan" id="kobo.850.1"> service and port </span><code class="inlineCode"><span class="koboSpan" id="kobo.851.1">6379</span></code><span class="koboSpan" id="kobo.852.1"> used by Redis. </span><span class="koboSpan" id="kobo.852.2">You modify the Django </span><code class="inlineCode"><span class="koboSpan" id="kobo.853.1">CACHE</span></code><span class="koboSpan" id="kobo.854.1"> setting and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.855.1">CHANNEL_LAYERS</span></code><span class="koboSpan" id="kobo.856.1"> setting used by Channels to use the production Redis URL.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.857.1">Stop the Docker application from the shell by pressing the </span><em class="italic"><span class="koboSpan" id="kobo.858.1">Ctrl</span></em><span class="koboSpan" id="kobo.859.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.860.1">C</span></em><span class="koboSpan" id="kobo.861.1"> keys or using the stop button in the Docker Desktop app. </span><span class="koboSpan" id="kobo.861.2">Then, start Compose again with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.862.1">docker compose up
cache-1   | ... </span><span class="koboSpan" id="kobo.862.2">Ready to accept connections tcp
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.863.1">Open the Docker Desktop application. </span><span class="koboSpan" id="kobo.863.2">You should see now the </span><code class="inlineCode"><span class="koboSpan" id="kobo.864.1">chapter17</span></code><span class="koboSpan" id="kobo.865.1"> Docker application running a container for each service defined in the Docker Compose file: </span><code class="inlineCode"><span class="koboSpan" id="kobo.866.1">db</span></code><span class="koboSpan" id="kobo.867.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.868.1">cache</span></code><span class="koboSpan" id="kobo.869.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.870.1">web</span></code><span class="koboSpan" id="kobo.871.1">, as in </span><em class="italic"><span class="koboSpan" id="kobo.872.1">Figure 17.4</span></em><span class="koboSpan" id="kobo.873.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.874.1"><img alt="" role="presentation" src="../Images/B21088_17_05.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.875.1">Figure 17.5: The chapter17 application with the db-1, web-1, and cache-1 containers in Docker Desktop</span></p>
<p class="normal"><span class="koboSpan" id="kobo.876.1">You are </span><a id="_idIndexMarker1592"/><span class="koboSpan" id="kobo.877.1">still serving Django with the Django development </span><a id="_idIndexMarker1593"/><span class="koboSpan" id="kobo.878.1">server, which, as you know, is meant for development only and not optimized for production use. </span><span class="koboSpan" id="kobo.878.2">Let’s replace it with the WSGI Python web server.</span></p>
<h1 class="heading-1" id="_idParaDest-460"><span class="koboSpan" id="kobo.879.1">Serving Django through WSGI and NGINX</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.880.1">Django’s </span><a id="_idIndexMarker1594"/><span class="koboSpan" id="kobo.881.1">primary deployment platform is WSGI. </span><strong class="keyWord"><span class="koboSpan" id="kobo.882.1">WSGI</span></strong><span class="koboSpan" id="kobo.883.1"> stands for </span><strong class="keyWord"><span class="koboSpan" id="kobo.884.1">Web Server Gateway Interface </span></strong><span class="koboSpan" id="kobo.885.1">, and it is the standard for serving Python </span><a id="_idIndexMarker1595"/><span class="koboSpan" id="kobo.886.1">applications on the web.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.887.1">When </span><a id="_idIndexMarker1596"/><span class="koboSpan" id="kobo.888.1">you generate a new project using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.889.1">startproject</span></code><span class="koboSpan" id="kobo.890.1"> command, Django creates a </span><code class="inlineCode"><span class="koboSpan" id="kobo.891.1">wsgi.py</span></code><span class="koboSpan" id="kobo.892.1"> file inside </span><a id="_idIndexMarker1597"/><span class="koboSpan" id="kobo.893.1">your project directory. </span><span class="koboSpan" id="kobo.893.2">This file contains a WSGI </span><a id="_idIndexMarker1598"/><span class="koboSpan" id="kobo.894.1">application callable, which is an access point to your application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.895.1">WSGI is used for both running your project with the Django development server and deploying your application with the server of your choice in a production environment. </span><span class="koboSpan" id="kobo.895.2">You can </span><a id="_idIndexMarker1599"/><span class="koboSpan" id="kobo.896.1">learn more about WSGI at </span><a href="https://wsgi.readthedocs.io/en/latest/"><span class="url"><span class="koboSpan" id="kobo.897.1">https://wsgi.readthedocs.io/en/latest/</span></span></a><span class="koboSpan" id="kobo.898.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.899.1">In the following </span><a id="_idIndexMarker1600"/><span class="koboSpan" id="kobo.900.1">sections we will use </span><strong class="keyWord"><span class="koboSpan" id="kobo.901.1">uWSGI</span></strong><span class="koboSpan" id="kobo.902.1">, an open source web server that implements the WSGI specification.</span></p>
<h2 class="heading-2" id="_idParaDest-461"><span class="koboSpan" id="kobo.903.1">Using uWSGI</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.904.1">Throughout this book, you have been using the Django development server to run projects in your local environment. </span><span class="koboSpan" id="kobo.904.2">However, the development server is not designed for production use, and deploying your application in a production environment will require a standard web server.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.905.1">uWSGI is an </span><a id="_idIndexMarker1601"/><span class="koboSpan" id="kobo.906.1">extremely fast Python application server. </span><span class="koboSpan" id="kobo.906.2">It communicates with your Python application using the WSGI specification. </span><span class="koboSpan" id="kobo.906.3">uWSGI translates web requests into a format that your Django project can process.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.907.1">Let’s configure uWSGI to serve the Django project. </span><span class="koboSpan" id="kobo.907.2">You already added </span><code class="inlineCode"><span class="koboSpan" id="kobo.908.1">uwsgi==2.0.20</span></code><span class="koboSpan" id="kobo.909.1"> to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.910.1">requirements.txt</span></code><span class="koboSpan" id="kobo.911.1"> file of the project, so uWSGI is already being installed in the Docker image of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.912.1">web</span></code><span class="koboSpan" id="kobo.913.1"> service.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.914.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.915.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.916.1"> file and modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.917.1">web</span></code><span class="koboSpan" id="kobo.918.1"> service definition as follows. </span><span class="koboSpan" id="kobo.918.2">The new code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.919.1">web:
    build: .
    </span><span class="koboSpan" id="kobo.919.2">command: </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.920.1">[</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.921.1">"./wait-for-it.sh"</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.922.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.923.1">"db:5432"</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.924.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.925.1">"--"</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.926.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.927.1">"uwsgi"</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.928.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.929.1">"--ini"</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.930.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.931.1">"/code/config/uwsgi/uwsgi.ini"</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.932.1">]</span></strong></span><span class="koboSpan" id="kobo.933.1">
    restart: always
    volumes:
      - .:/code
    environment:
      - DJANGO_SETTINGS_MODULE=educa.settings.prod
      - POSTGRES_DB=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    depends_on:
      - db
      - cache
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.934.1">Make sure to remove the </span><code class="inlineCode"><span class="koboSpan" id="kobo.935.1">ports</span></code><span class="koboSpan" id="kobo.936.1"> section. </span><span class="koboSpan" id="kobo.936.2">uWSGI will be reachable with a socket, so you don’t need to expose a port in the container.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.937.1">The new </span><code class="inlineCode"><span class="koboSpan" id="kobo.938.1">command</span></code><span class="koboSpan" id="kobo.939.1"> for the image runs </span><code class="inlineCode"><span class="koboSpan" id="kobo.940.1">uwsgi</span></code><span class="koboSpan" id="kobo.941.1"> and passes the </span><code class="inlineCode"><span class="koboSpan" id="kobo.942.1">/code/config/uwsgi/uwsgi.ini</span></code><span class="koboSpan" id="kobo.943.1"> configuration file to it. </span><span class="koboSpan" id="kobo.943.2">Let’s create the configuration file for uWSGI.</span></p>
<h2 class="heading-2" id="_idParaDest-462"><span class="koboSpan" id="kobo.944.1">Configuring uWSGI</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.945.1">uWSGI allows </span><a id="_idIndexMarker1602"/><span class="koboSpan" id="kobo.946.1">you to define a custom configuration in an </span><code class="inlineCode"><span class="koboSpan" id="kobo.947.1">.ini</span></code><span class="koboSpan" id="kobo.948.1"> file. </span><span class="koboSpan" id="kobo.948.2">Next to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.949.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.950.1"> file, create the </span><code class="inlineCode"><span class="koboSpan" id="kobo.951.1">config/uwsgi/uwsgi.ini</span></code><span class="koboSpan" id="kobo.952.1"> file path. </span><span class="koboSpan" id="kobo.952.2">Assuming your parent directory is named </span><code class="inlineCode"><span class="koboSpan" id="kobo.953.1">Chapter17</span></code><span class="koboSpan" id="kobo.954.1">, the file structure should look as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.955.1">Chapter17/
    config/
        uwsgi/
            uwsgi.ini
    Dockerfile
    docker-compose.yml
    educa/
        manage.py
        ...
    </span><span class="koboSpan" id="kobo.955.2">requirements.txt
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.956.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.957.1">config/uwsgi/uwsgi.ini</span></code><span class="koboSpan" id="kobo.958.1"> file and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.959.1">[uwsgi]
socket=/code/educa/uwsgi_app.sock
chdir = /code/educa/
module=educa.wsgi:application
master=true
chmod-socket=</span><span class="hljs-number"><span class="koboSpan" id="kobo.960.1">666</span></span><span class="koboSpan" id="kobo.961.1">
uid=www-data
gid=www-data
vacuum=true
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.962.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.963.1">uwsgi.ini</span></code><span class="koboSpan" id="kobo.964.1"> file, you define the following options:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.965.1">socket</span></code><span class="koboSpan" id="kobo.966.1">: This is the Unix/TCP socket to bind the server.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.967.1">chdir</span></code><span class="koboSpan" id="kobo.968.1">: This is the path to your project directory, so that uWSGI changes to that directory before loading the Python application.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.969.1">module</span></code><span class="koboSpan" id="kobo.970.1">: This is the WSGI module to use. </span><span class="koboSpan" id="kobo.970.2">You set this to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.971.1">application</span></code><span class="koboSpan" id="kobo.972.1"> callable contained in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.973.1">wsgi</span></code><span class="koboSpan" id="kobo.974.1"> module of your project.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.975.1">master</span></code><span class="koboSpan" id="kobo.976.1">: This enables the master process.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.977.1">chmod-socket</span></code><span class="koboSpan" id="kobo.978.1">: These are the file permissions to apply to the socket file. </span><span class="koboSpan" id="kobo.978.2">In this case, you use </span><code class="inlineCode"><span class="koboSpan" id="kobo.979.1">666</span></code><span class="koboSpan" id="kobo.980.1"> so that NGINX can read/write the socket.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.981.1">uid</span></code><span class="koboSpan" id="kobo.982.1">: This is the user ID of the process once it’s started.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.983.1">gid</span></code><span class="koboSpan" id="kobo.984.1">: This is the group ID of the process once it’s started.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.985.1">vacuum</span></code><span class="koboSpan" id="kobo.986.1">: Using </span><code class="inlineCode"><span class="koboSpan" id="kobo.987.1">true</span></code><span class="koboSpan" id="kobo.988.1"> instructs uWSGI to clean up any temporary files or UNIX sockets it creates.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.989.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.990.1">socket</span></code><span class="koboSpan" id="kobo.991.1"> option is intended for communication with some kind of third-party router, such as NGINX. </span><span class="koboSpan" id="kobo.991.2">You </span><a id="_idIndexMarker1603"/><span class="koboSpan" id="kobo.992.1">are going to run uWSGI using a socket and you are going to configure NGINX as your web server, which will communicate with uWSGI through the socket.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.993.1">You can find </span><a id="_idIndexMarker1604"/><span class="koboSpan" id="kobo.994.1">the list of available uWSGI options at </span><a href="https://uwsgi-docs.readthedocs.io/en/latest/Options.html"><span class="url"><span class="koboSpan" id="kobo.995.1">https://uwsgi-docs.readthedocs.io/en/latest/Options.html</span></span></a><span class="koboSpan" id="kobo.996.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.997.1">You will not be able to access your uWSGI instance from your browser now, since it’s running through a socket. </span><span class="koboSpan" id="kobo.997.2">To complete the environment, we will use NGINX in front of uWSGI, to manage HTTP requests and pass application requests to uWSGI through the socket. </span><span class="koboSpan" id="kobo.997.3">Let’s complete the production environment.</span></p>
<h2 class="heading-2" id="_idParaDest-463"><span class="koboSpan" id="kobo.998.1">Using NGINX</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.999.1">When you are serving a website, you have to serve dynamic content, but you also need to serve </span><a id="_idIndexMarker1605"/><span class="koboSpan" id="kobo.1000.1">static files, such as CSS style sheets, JavaScript files, and images. </span><span class="koboSpan" id="kobo.1000.2">While uWSGI is capable of serving static files, it adds unnecessary overhead to HTTP requests and, therefore, it is encouraged to set up a web server, such as NGINX, in front of it.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1001.1">NGINX is a web server focused on high concurrency, performance, and low memory usage. </span><span class="koboSpan" id="kobo.1001.2">NGINX also acts as a reverse proxy, receiving HTTP and WebSocket requests and routing them to different backends.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1002.1">Generally, you will use a web server, such as NGINX, in front of uWSGI for serving static files efficiently, and you will forward dynamic requests to uWSGI workers. </span><span class="koboSpan" id="kobo.1002.2">By using NGINX, you can also apply different rules and benefit from its reverse proxy capabilities.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1003.1">We will </span><a id="_idIndexMarker1606"/><span class="koboSpan" id="kobo.1004.1">add the NGINX service to the Docker Compose file using the official NGINX Docker image. </span><span class="koboSpan" id="kobo.1004.2">You can find information about the official NGINX Docker image at </span><a href="https://hub.docker.com/_/nginx"><span class="url"><span class="koboSpan" id="kobo.1005.1">https://hub.docker.com/_/nginx</span></span></a><span class="koboSpan" id="kobo.1006.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1007.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1008.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.1009.1"> file and add the following lines highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1010.1">services:
  db:
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1011.1"># ...</span></span><span class="koboSpan" id="kobo.1012.1">
  cache:
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1013.1"># ...</span></span><span class="koboSpan" id="kobo.1014.1">
  web:
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1015.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1016.1">  nginx:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1017.1">    image: nginx:</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.1018.1">1.25.5</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1019.1">    restart: always</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1020.1">    volumes:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1021.1">      - ./config/nginx:/etc/nginx/templates</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1022.1">      - .:/code</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1023.1">    ports:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1024.1">      - </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1025.1">"80:80"</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1026.1">You have </span><a id="_idIndexMarker1607"/><span class="koboSpan" id="kobo.1027.1">added the definition for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1028.1">nginx</span></code><span class="koboSpan" id="kobo.1029.1"> service with the following subsections:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1030.1">image</span></code><span class="koboSpan" id="kobo.1031.1">: The service uses the base </span><code class="inlineCode"><span class="koboSpan" id="kobo.1032.1">nginx</span></code><span class="koboSpan" id="kobo.1033.1"> Docker image.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1034.1">restart</span></code><span class="koboSpan" id="kobo.1035.1">: The restart policy is set to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1036.1">always</span></code><span class="koboSpan" id="kobo.1037.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1038.1">volumes</span></code><span class="koboSpan" id="kobo.1039.1">: You mount the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1040.1">./config/nginx</span></code><span class="koboSpan" id="kobo.1041.1"> volume to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1042.1">/etc/nginx/templates</span></code><span class="koboSpan" id="kobo.1043.1"> directory of the Docker image. </span><span class="koboSpan" id="kobo.1043.2">This is where NGINX will look for a default configuration template. </span><span class="koboSpan" id="kobo.1043.3">You also mount the local directory </span><code class="inlineCode"><span class="koboSpan" id="kobo.1044.1">.</span></code><span class="koboSpan" id="kobo.1045.1"> to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1046.1">/code</span></code><span class="koboSpan" id="kobo.1047.1"> directory of the image, so that NGINX can have access to static files.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1048.1">ports</span></code><span class="koboSpan" id="kobo.1049.1">: You expose port </span><code class="inlineCode"><span class="koboSpan" id="kobo.1050.1">80</span></code><span class="koboSpan" id="kobo.1051.1">, which is mapped to container port </span><code class="inlineCode"><span class="koboSpan" id="kobo.1052.1">80</span></code><span class="koboSpan" id="kobo.1053.1">. </span><span class="koboSpan" id="kobo.1053.2">This is the default port for HTTP.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1054.1">Let’s configure the NGINX web server.</span></p>
<h2 class="heading-2" id="_idParaDest-464"><span class="koboSpan" id="kobo.1055.1">Configuring NGINX</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1056.1">Create the </span><a id="_idIndexMarker1608"/><span class="koboSpan" id="kobo.1057.1">following file path highlighted in bold under the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1058.1">config/</span></code><span class="koboSpan" id="kobo.1059.1"> directory:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1060.1">config/
    uwsgi/
      uwsgi.ini
    </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1061.1">nginx/</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1062.1">default.conf.template</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1063.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1064.1">nginx/default.conf.template</span></code><span class="koboSpan" id="kobo.1065.1"> file and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1066.1"># upstream for uWSGI</span></span><span class="koboSpan" id="kobo.1067.1">
upstream uwsgi_app {
    server unix:/code/educa/uwsgi_app.sock;
}
server {
    listen       </span><span class="hljs-number"><span class="koboSpan" id="kobo.1068.1">80</span></span><span class="koboSpan" id="kobo.1069.1">;
    server_name  www.educaproject.com educaproject.com;
    error_log    stderr warn;
    access_log   /dev/stdout main;
    location / {
        include      /etc/nginx/uwsgi_params;
        uwsgi_pass   uwsgi_app;
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1070.1">This is the </span><a id="_idIndexMarker1609"/><span class="koboSpan" id="kobo.1071.1">basic configuration for NGINX. </span><span class="koboSpan" id="kobo.1071.2">In this configuration, you set up an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1072.1">upstream</span></code><span class="koboSpan" id="kobo.1073.1"> component named </span><code class="inlineCode"><span class="koboSpan" id="kobo.1074.1">uwsgi_app</span></code><span class="koboSpan" id="kobo.1075.1">, which points to the socket created by uWSGI. </span><span class="koboSpan" id="kobo.1075.2">You use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1076.1">server</span></code><span class="koboSpan" id="kobo.1077.1"> block with the following configuration:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.1078.1">You tell NGINX to listen on port </span><code class="inlineCode"><span class="koboSpan" id="kobo.1079.1">80</span></code><span class="koboSpan" id="kobo.1080.1">.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1081.1">You set the server name to both </span><code class="inlineCode"><span class="koboSpan" id="kobo.1082.1">www.educaproject.com</span></code><span class="koboSpan" id="kobo.1083.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1084.1">educaproject.com</span></code><span class="koboSpan" id="kobo.1085.1">. </span><span class="koboSpan" id="kobo.1085.2">NGINX will serve incoming requests for both domains.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1086.1">You use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1087.1">stderr</span></code><span class="koboSpan" id="kobo.1088.1"> for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1089.1">error_log</span></code><span class="koboSpan" id="kobo.1090.1"> directive to get error logs written to the standard error file. </span><span class="koboSpan" id="kobo.1090.2">The second parameter determines the logging level. </span><span class="koboSpan" id="kobo.1090.3">You use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1091.1">warn</span></code><span class="koboSpan" id="kobo.1092.1"> to get warnings and errors of higher severity.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1093.1">You point </span><code class="inlineCode"><span class="koboSpan" id="kobo.1094.1">access_log</span></code><span class="koboSpan" id="kobo.1095.1"> to the standard output with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1096.1">/dev/stdout</span></code><span class="koboSpan" id="kobo.1097.1">.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1098.1">You specify that any request under the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1099.1">/</span></code><span class="koboSpan" id="kobo.1100.1"> path has to be routed with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1101.1">uwsgi_app</span></code><span class="koboSpan" id="kobo.1102.1"> socket to uWSGI.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1103.1">You include the default uWSGI configuration parameters that come with NGINX. </span><span class="koboSpan" id="kobo.1103.2">These are located at </span><code class="inlineCode"><span class="koboSpan" id="kobo.1104.1">/etc/nginx/uwsgi_params</span></code><span class="koboSpan" id="kobo.1105.1">.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1106.1">NGINX is </span><a id="_idIndexMarker1610"/><span class="koboSpan" id="kobo.1107.1">now configured. </span><span class="koboSpan" id="kobo.1107.2">You can find the NGINX documentation at </span><a href="https://nginx.org/en/docs/"><span class="url"><span class="koboSpan" id="kobo.1108.1">https://nginx.org/en/docs/</span></span></a><span class="koboSpan" id="kobo.1109.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1110.1">Stop the Docker application from the shell by pressing the </span><em class="italic"><span class="koboSpan" id="kobo.1111.1">Ctrl</span></em><span class="koboSpan" id="kobo.1112.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.1113.1">C</span></em><span class="koboSpan" id="kobo.1114.1"> keys or using the stop button in the Docker Desktop app. </span><span class="koboSpan" id="kobo.1114.2">Then, start Compose again with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1115.1">docker compose up
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1116.1">Open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1117.1">http://localhost/</span></code><span class="koboSpan" id="kobo.1118.1"> URL in your browser. </span><span class="koboSpan" id="kobo.1118.2">It’s not necessary to add a port to the URL because you are accessing the host through the standard HTTP port </span><code class="inlineCode"><span class="koboSpan" id="kobo.1119.1">80</span></code><span class="koboSpan" id="kobo.1120.1">. </span><span class="koboSpan" id="kobo.1120.2">You should see the course list page with no CSS styles, like </span><em class="italic"><span class="koboSpan" id="kobo.1121.1">Figure 17.6</span></em><span class="koboSpan" id="kobo.1122.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1123.1"><img alt="" role="presentation" src="../Images/B21088_17_06.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1124.1">Figure 17.6: The course list page served with NGINX and uWSGI</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1125.1">The following </span><a id="_idIndexMarker1611"/><span class="koboSpan" id="kobo.1126.1">diagram shows the request/response cycle of the production environment that you have set up:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1127.1"><img alt="" role="presentation" src="../Images/B21088_17_07.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1128.1">Figure 17.7: The production environment request/response cycle</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1129.1">The following happens when the client browser sends an HTTP request:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1130.1">NGINX receives the HTTP request.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1131.1">NGINX delegates the request to uWSGI through a socket.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1132.1">uWSGI passes the request to Django for processing.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1133.1">Django returns an HTTP response that is passed back to NGINX, which in turn passes it back to the client browser.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1134.1">If you </span><a id="_idIndexMarker1612"/><span class="koboSpan" id="kobo.1135.1">check the Docker Desktop application, you should see that there are four containers running:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.1136.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1137.1">db</span></code><span class="koboSpan" id="kobo.1138.1"> service is running PostgreSQL</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1139.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1140.1">cache</span></code><span class="koboSpan" id="kobo.1141.1"> service is running Redis</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1142.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1143.1">web</span></code><span class="koboSpan" id="kobo.1144.1"> service is running uWSGI and Django</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1145.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1146.1">nginx</span></code><span class="koboSpan" id="kobo.1147.1"> service is running NGINX</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1148.1">Let’s continue with the production environment setup. </span><span class="koboSpan" id="kobo.1148.2">Instead of accessing our project using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1149.1">localhost</span></code><span class="koboSpan" id="kobo.1150.1">, we will configure the project to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1151.1">educaproject.com</span></code><span class="koboSpan" id="kobo.1152.1"> hostname.</span></p>
<h2 class="heading-2" id="_idParaDest-465"><span class="koboSpan" id="kobo.1153.1">Using a hostname</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1154.1">You will use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1155.1">educaproject.com</span></code><span class="koboSpan" id="kobo.1156.1"> hostname for your site. </span><span class="koboSpan" id="kobo.1156.2">Since you are using a sample domain name, you need to redirect it to your local host.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1157.1">If you are </span><a id="_idIndexMarker1613"/><span class="koboSpan" id="kobo.1158.1">using Linux or macOS, edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1159.1">/etc/hosts</span></code><span class="koboSpan" id="kobo.1160.1"> file and add the following line to it:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1161.1">127.0.0.1 educaproject.com www.educaproject.com
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1162.1">If you are using Windows, edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1163.1">C:\Windows\System32\drivers\etc</span></code><span class="koboSpan" id="kobo.1164.1"> file and add the same line.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1165.1">By doing so, you are routing the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1166.1">educaproject.com</span></code><span class="koboSpan" id="kobo.1167.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1168.1">www.educaproject.com</span></code><span class="koboSpan" id="kobo.1169.1"> hostnames to your local server. </span><span class="koboSpan" id="kobo.1169.2">In a production server, you won’t need to do this, since you will have a fixed IP address and you will point your hostname to your server in your domain’s DNS configuration.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1170.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.1171.1">http://educaproject.com/</span></code><span class="koboSpan" id="kobo.1172.1"> in your browser. </span><span class="koboSpan" id="kobo.1172.2">You should be able to see your site, still without any static assets loaded. </span><span class="koboSpan" id="kobo.1172.3">Your production environment is almost ready.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1173.1">Now, you can restrict the hosts that can serve your Django project. </span><span class="koboSpan" id="kobo.1173.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1174.1">educa/settings/prod.py</span></code><span class="koboSpan" id="kobo.1175.1"> production settings file of your project and change the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1176.1">ALLOWED_HOSTS</span></code><span class="koboSpan" id="kobo.1177.1"> setting, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1178.1">ALLOWED_HOSTS = [</span><span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1179.1">'educaproject.com'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1180.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1181.1">'www.educaproject.com'</span></strong></span><span class="koboSpan" id="kobo.1182.1">]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1183.1">Django will only serve your application if it’s running under any of these hostnames. </span><span class="koboSpan" id="kobo.1183.2">You can read </span><a id="_idIndexMarker1614"/><span class="koboSpan" id="kobo.1184.1">more about the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1185.1">ALLOWED_HOSTS</span></code><span class="koboSpan" id="kobo.1186.1"> setting at </span><a href="https://docs.djangoproject.com/en/5.0/ref/settings/#allowed-hosts"><span class="url"><span class="koboSpan" id="kobo.1187.1">https://docs.djangoproject.com/en/5.0/ref/settings/#allowed-hosts</span></span></a><span class="koboSpan" id="kobo.1188.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1189.1">The production </span><a id="_idIndexMarker1615"/><span class="koboSpan" id="kobo.1190.1">environment is almost ready. </span><span class="koboSpan" id="kobo.1190.2">Let’s continue by configuring NGINX to serve static files.</span></p>
<h2 class="heading-2" id="_idParaDest-466"><span class="koboSpan" id="kobo.1191.1">Serving static and media assets</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1192.1">uWSGI is capable of serving static files flawlessly, but it is not as fast and effective as NGINX. </span><span class="koboSpan" id="kobo.1192.2">For the </span><a id="_idIndexMarker1616"/><span class="koboSpan" id="kobo.1193.1">best performance, you will use NGINX to serve static </span><a id="_idIndexMarker1617"/><span class="koboSpan" id="kobo.1194.1">files in your production environment. </span><span class="koboSpan" id="kobo.1194.2">You will set up NGINX to serve both the static files of your application (CSS style sheets, JavaScript files, and images) and media files uploaded by instructors for the course contents.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1195.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1196.1">settings/base.py</span></code><span class="koboSpan" id="kobo.1197.1"> file and add the following line just below the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1198.1">STATIC_URL</span></code><span class="koboSpan" id="kobo.1199.1"> setting:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1200.1">STATIC_ROOT = BASE_DIR / </span><span class="hljs-string"><span class="koboSpan" id="kobo.1201.1">'static'</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1202.1">This is the root directory for all static files of the project. </span><span class="koboSpan" id="kobo.1202.2">Next, you are going to collect the static files from the different Django applications into the common directory.</span></p>
<h3 class="heading-3" id="_idParaDest-467"><span class="koboSpan" id="kobo.1203.1">Collecting static files</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.1204.1">Each application in your Django project may contain static files in a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1205.1">static/</span></code><span class="koboSpan" id="kobo.1206.1"> directory. </span><span class="koboSpan" id="kobo.1206.2">Django provides </span><a id="_idIndexMarker1618"/><span class="koboSpan" id="kobo.1207.1">a command to collect static files from all applications into a single location. </span><span class="koboSpan" id="kobo.1207.2">This simplifies the setup for serving static files in production. </span><span class="koboSpan" id="kobo.1207.3">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1208.1">collectstatic</span></code><span class="koboSpan" id="kobo.1209.1"> command collects the static files from all applications of the project into the path defined with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1210.1">STATIC_ROOT</span></code><span class="koboSpan" id="kobo.1211.1"> setting.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1212.1">Stop the Docker application from the shell by pressing the </span><em class="italic"><span class="koboSpan" id="kobo.1213.1">Ctrl</span></em><span class="koboSpan" id="kobo.1214.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.1215.1">C</span></em><span class="koboSpan" id="kobo.1216.1"> keys or using the stop button in the Docker Desktop app. </span><span class="koboSpan" id="kobo.1216.2">Then, start Compose again with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1217.1">docker compose up
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1218.1">Open another shell in the parent directory, where the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1219.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.1220.1"> file is located, and run the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1221.1">docker compose exec web python /code/educa/manage.py collectstatic
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1222.1">Note that you can alternatively run the following command in the shell, from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1223.1">educa/</span></code><span class="koboSpan" id="kobo.1224.1"> project directory:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1225.1">python manage.py collectstatic --settings=educa.settings.local
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1226.1">Both commands will have the same effect since the base local directory is mounted to the Docker image. </span><span class="koboSpan" id="kobo.1226.2">Django will ask whether you want to override any existing files in the root directory. </span><span class="koboSpan" id="kobo.1226.3">Type </span><code class="inlineCode"><span class="koboSpan" id="kobo.1227.1">yes</span></code><span class="koboSpan" id="kobo.1228.1"> and press </span><em class="italic"><span class="koboSpan" id="kobo.1229.1">Enter</span></em><span class="koboSpan" id="kobo.1230.1">. </span><span class="koboSpan" id="kobo.1230.2">You will see the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1231.1">171 static files copied to '/code/educa/static'.
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1232.1">Files located </span><a id="_idIndexMarker1619"/><span class="koboSpan" id="kobo.1233.1">under the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1234.1">static/</span></code><span class="koboSpan" id="kobo.1235.1"> directory of each application present in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1236.1">INSTALLED_APPS</span></code><span class="koboSpan" id="kobo.1237.1"> setting have been copied to the global </span><code class="inlineCode"><span class="koboSpan" id="kobo.1238.1">/educa/static/</span></code><span class="koboSpan" id="kobo.1239.1"> project directory.</span></p>
<h3 class="heading-3" id="_idParaDest-468"><span class="koboSpan" id="kobo.1240.1">Serving static files with NGINX</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.1241.1">Edit </span><a id="_idIndexMarker1620"/><span class="koboSpan" id="kobo.1242.1">the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1243.1">config/nginx/default.conf.template</span></code><span class="koboSpan" id="kobo.1244.1"> file and </span><a id="_idIndexMarker1621"/><span class="koboSpan" id="kobo.1245.1">add the following lines highlighted in bold to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1246.1">server</span></code><span class="koboSpan" id="kobo.1247.1"> block:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1248.1">server {
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1249.1"># ...</span></span><span class="koboSpan" id="kobo.1250.1">
    location / {
        include      /etc/nginx/uwsgi_params;
        uwsgi_pass   uwsgi_app;
    }
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1251.1">    location /static/ {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1252.1">        alias /code/educa/static/;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1253.1">    }</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1254.1">    location /media/ {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1255.1">        alias /code/educa/media/;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1256.1">    }</span></strong></span><span class="koboSpan" id="kobo.1257.1">
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1258.1">These directives tell NGINX to serve static files located under the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1259.1">/static/</span></code><span class="koboSpan" id="kobo.1260.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1261.1">/media/</span></code><span class="koboSpan" id="kobo.1262.1"> paths directly. </span><span class="koboSpan" id="kobo.1262.2">These paths are as follows:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1263.1">/static/</span></code><span class="koboSpan" id="kobo.1264.1">: This corresponds to the path of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1265.1">STATIC_URL</span></code><span class="koboSpan" id="kobo.1266.1"> setting. </span><span class="koboSpan" id="kobo.1266.2">The target path corresponds to the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1267.1">STATIC_ROOT</span></code><span class="koboSpan" id="kobo.1268.1"> setting. </span><span class="koboSpan" id="kobo.1268.2">You use it to serve the static files of your application from the directory mounted to the NGINX Docker image.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1269.1">/media/</span></code><span class="koboSpan" id="kobo.1270.1">: This corresponds to the path of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1271.1">MEDIA_URL</span></code><span class="koboSpan" id="kobo.1272.1"> setting, and its target path corresponds to the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1273.1">MEDIA_ROOT</span></code><span class="koboSpan" id="kobo.1274.1"> setting. </span><span class="koboSpan" id="kobo.1274.2">You use it to serve the </span><a id="_idIndexMarker1622"/><span class="koboSpan" id="kobo.1275.1">media files uploaded to the </span><a id="_idIndexMarker1623"/><span class="koboSpan" id="kobo.1276.1">course contents from the directory mounted to the NGINX Docker image.</span></li>
</ul>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.1277.1">Figure 17.8 </span></em><span class="koboSpan" id="kobo.1278.1">shows the current setup of the production environment:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1279.1"><img alt="" role="presentation" src="../Images/B21088_17_08.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1280.1">Figure 17.8: The production environment request/response cycle, including static files</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1281.1">Files under the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1282.1">/static/</span></code><span class="koboSpan" id="kobo.1283.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1284.1">/media/</span></code><span class="koboSpan" id="kobo.1285.1"> paths are now served by NGINX directly, instead of being forwarded to uWSGI. </span><span class="koboSpan" id="kobo.1285.2">Requests to any other path are still passed by NGINX to uWSGI through the UNIX socket.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1286.1">Stop the Docker application from the shell by pressing the </span><em class="italic"><span class="koboSpan" id="kobo.1287.1">Ctrl</span></em><span class="koboSpan" id="kobo.1288.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.1289.1">C</span></em><span class="koboSpan" id="kobo.1290.1"> keys or using the stop button in the Docker Desktop app. </span><span class="koboSpan" id="kobo.1290.2">Then, start Compose again with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1291.1">docker compose up
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1292.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.1293.1">http://educaproject.com/</span></code><span class="koboSpan" id="kobo.1294.1"> in your browser. </span><span class="koboSpan" id="kobo.1294.2">You should see the following screen:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1295.1"><img alt="" role="presentation" src="../Images/B21088_17_09.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1296.1">Figure 17.9: The course list page served with NGINX and uWSGI</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1297.1">Static resources, such as CSS style sheets and images, are now loaded correctly. </span><span class="koboSpan" id="kobo.1297.2">HTTP requests </span><a id="_idIndexMarker1624"/><span class="koboSpan" id="kobo.1298.1">for static files are now being served by NGINX directly, instead of being forwarded to uWSGI.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1299.1">You have </span><a id="_idIndexMarker1625"/><span class="koboSpan" id="kobo.1300.1">successfully configured NGINX for serving static files. </span><span class="koboSpan" id="kobo.1300.2">Next, you are going to perform some checks on your Django project to validate it for a production environment and you are going to serve your site under HTTPS.</span></p>
<h1 class="heading-1" id="_idParaDest-469"><span class="koboSpan" id="kobo.1301.1">Securing your site with SSL/TLS</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1302.1">The </span><strong class="keyWord"><span class="koboSpan" id="kobo.1303.1">TLS</span></strong><span class="koboSpan" id="kobo.1304.1"> protocol is </span><a id="_idIndexMarker1626"/><span class="koboSpan" id="kobo.1305.1">the standard for serving websites through a secure connection. </span><span class="koboSpan" id="kobo.1305.2">The TLS predecessor is SSL. </span><span class="koboSpan" id="kobo.1305.3">Although SSL is now deprecated, in multiple </span><a id="_idIndexMarker1627"/><span class="koboSpan" id="kobo.1306.1">libraries and online documentation, you will find </span><a id="_idIndexMarker1628"/><span class="koboSpan" id="kobo.1307.1">references to both the terms TLS and SSL. </span><span class="koboSpan" id="kobo.1307.2">It’s strongly encouraged that you serve your websites over HTTPS.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1308.1">In this section, you are going to check your Django project for any issues and validate it for a production deployment. </span><span class="koboSpan" id="kobo.1308.2">You will also prepare the project to be served over HTTPS. </span><span class="koboSpan" id="kobo.1308.3">Then, you are going to configure an SSL/TLS certificate in NGINX to serve your site securely.</span></p>
<h2 class="heading-2" id="_idParaDest-470"><span class="koboSpan" id="kobo.1309.1">Checking your project for production</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1310.1">Django includes a system check framework for validating your project at any time. </span><span class="koboSpan" id="kobo.1310.2">The check framework </span><a id="_idIndexMarker1629"/><span class="koboSpan" id="kobo.1311.1">inspects the applications installed in your Django project and detects common problems. </span><span class="koboSpan" id="kobo.1311.2">Checks are triggered implicitly when you run management commands like </span><code class="inlineCode"><span class="koboSpan" id="kobo.1312.1">runserver</span></code><span class="koboSpan" id="kobo.1313.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1314.1">migrate</span></code><span class="koboSpan" id="kobo.1315.1">. </span><span class="koboSpan" id="kobo.1315.2">However, you can trigger checks explicitly with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1316.1">check</span></code><span class="koboSpan" id="kobo.1317.1"> management command.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1318.1">You can </span><a id="_idIndexMarker1630"/><span class="koboSpan" id="kobo.1319.1">read more about Django’s system check framework at </span><a href="https://docs.djangoproject.com/en/5.0/topics/checks/"><span class="url"><span class="koboSpan" id="kobo.1320.1">https://docs.djangoproject.com/en/5.0/topics/checks/</span></span></a><span class="koboSpan" id="kobo.1321.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1322.1">Let’s confirm that the check framework does not raise any issues for your project. </span><span class="koboSpan" id="kobo.1322.2">Open the shell in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1323.1">educa</span></code><span class="koboSpan" id="kobo.1324.1"> project directory and run the following command to check your project:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1325.1">python manage.py check --settings=educa.settings.prod
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1326.1">You will see the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1327.1">System check identified no issues (0 silenced).
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1328.1">The system check framework didn’t identify any issues. </span><span class="koboSpan" id="kobo.1328.2">If you use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1329.1">--deploy</span></code><span class="koboSpan" id="kobo.1330.1"> option, the system check framework will perform additional checks that are relevant for a production deployment.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1331.1">Run the following command from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1332.1">educa</span></code><span class="koboSpan" id="kobo.1333.1"> project directory:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1334.1">python manage.py check --deploy --settings=educa.settings.prod
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1335.1">You will see an output like the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1336.1">System check identified some issues:
WARNINGS:
(security.W004) You have not set a value for the SECURE_HSTS_SECONDS setting. </span><span class="koboSpan" id="kobo.1336.2">...
</span><span class="koboSpan" id="kobo.1336.3">(security.W008) Your SECURE_SSL_REDIRECT setting is not set to True...
</span><span class="koboSpan" id="kobo.1336.4">(security.W009) Your SECRET_KEY has less than 50 characters, less than 5 unique characters, or it's prefixed with 'django-insecure-'...
</span><span class="koboSpan" id="kobo.1336.5">(security.W012) SESSION_COOKIE_SECURE is not set to True. </span><span class="koboSpan" id="kobo.1336.6">...
</span><span class="koboSpan" id="kobo.1336.7">(security.W016) You have 'django.middleware.csrf.CsrfViewMiddleware' in your MIDDLEWARE, but you have not set CSRF_COOKIE_SECURE ...
</span><span class="koboSpan" id="kobo.1336.8">System check identified 5 issues (0 silenced).
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1337.1">The check framework has identified five issues (zero errors and five warnings). </span><span class="koboSpan" id="kobo.1337.2">All warnings are related to security-related settings.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1338.1">Let’s address </span><a id="_idIndexMarker1631"/><span class="koboSpan" id="kobo.1339.1">the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1340.1">security.W009</span></code><span class="koboSpan" id="kobo.1341.1"> issue. </span><span class="koboSpan" id="kobo.1341.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1342.1">educa/settings/base.py</span></code><span class="koboSpan" id="kobo.1343.1"> file and modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1344.1">SECRET_KEY</span></code><span class="koboSpan" id="kobo.1345.1"> setting by removing the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1346.1">django-insecure-</span></code><span class="koboSpan" id="kobo.1347.1"> prefix and adding additional random characters to generate a string with at least 50 characters.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1348.1">Run the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1349.1">check</span></code><span class="koboSpan" id="kobo.1350.1"> command again and verify that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1351.1">security.W009</span></code><span class="koboSpan" id="kobo.1352.1"> issue is not raised anymore. </span><span class="koboSpan" id="kobo.1352.2">The rest of the warnings are related to SSL/TLS configuration. </span><span class="koboSpan" id="kobo.1352.3">We will address them next.</span></p>
<h2 class="heading-2" id="_idParaDest-471"><span class="koboSpan" id="kobo.1353.1">Configuring your Django project for SSL/TLS</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1354.1">Django </span><a id="_idIndexMarker1632"/><span class="koboSpan" id="kobo.1355.1">comes with specific settings for SSL/TLS support. </span><span class="koboSpan" id="kobo.1355.2">You are going to edit the production settings to serve your site over HTTPS.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1356.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1357.1">educa/settings/prod.py</span></code><span class="koboSpan" id="kobo.1358.1"> settings file and add the following settings to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1359.1"># Security</span></span><span class="koboSpan" id="kobo.1360.1">
CSRF_COOKIE_SECURE = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1361.1">True</span></span><span class="koboSpan" id="kobo.1362.1">
SESSION_COOKIE_SECURE = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1363.1">True</span></span><span class="koboSpan" id="kobo.1364.1">
SECURE_SSL_REDIRECT = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1365.1">True</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1366.1">These settings are as follows:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1367.1">CSRF_COOKIE_SECURE</span></code><span class="koboSpan" id="kobo.1368.1">: Use a secure cookie for </span><strong class="keyWord"><span class="koboSpan" id="kobo.1369.1">cross-site request forgery</span></strong><span class="koboSpan" id="kobo.1370.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.1371.1">CSRF</span></strong><span class="koboSpan" id="kobo.1372.1">) protection. </span><span class="koboSpan" id="kobo.1372.2">With </span><code class="inlineCode"><span class="koboSpan" id="kobo.1373.1">True</span></code><span class="koboSpan" id="kobo.1374.1">, browsers will only transfer the cookie over HTTPS.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1375.1">SESSION_COOKIE_SECURE</span></code><span class="koboSpan" id="kobo.1376.1">: Use a secure session cookie. </span><span class="koboSpan" id="kobo.1376.2">With </span><code class="inlineCode"><span class="koboSpan" id="kobo.1377.1">True</span></code><span class="koboSpan" id="kobo.1378.1">, browsers will only transfer the cookie over HTTPS.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1379.1">SECURE_SSL_REDIRECT</span></code><span class="koboSpan" id="kobo.1380.1">: This indicates whether HTTP requests have to be redirected to HTTPS.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1381.1">Django will now redirect HTTP requests to HTTPS; session and CSRF cookies will be sent only over HTTPS.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1382.1">Run the following command from the main directory of your project:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1383.1">python manage.py check --deploy --settings=educa.settings.prod
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1384.1">Only one warning remains, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1385.1">security.W004</span></code><span class="koboSpan" id="kobo.1386.1">:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1387.1">(security.W004) You have not set a value for the SECURE_HSTS_SECONDS setting. </span><span class="koboSpan" id="kobo.1387.2">...
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1388.1">This warning </span><a id="_idIndexMarker1633"/><span class="koboSpan" id="kobo.1389.1">is related to the </span><strong class="keyWord"><span class="koboSpan" id="kobo.1390.1">HTTP Strict Transport Security</span></strong><span class="koboSpan" id="kobo.1391.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.1392.1">HSTS</span></strong><span class="koboSpan" id="kobo.1393.1">) policy. </span><span class="koboSpan" id="kobo.1393.2">The HSTS policy prevents users from bypassing warnings and connecting to a site with an expired, self-signed, or otherwise invalid SSL certificate. </span><span class="koboSpan" id="kobo.1393.3">In the next section, we will use a self-signed certificate for our site, so we will ignore this </span><a id="_idIndexMarker1634"/><span class="koboSpan" id="kobo.1394.1">warning. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.1395.1">When you own a real domain, you can apply for a trusted </span><strong class="keyWord"><span class="koboSpan" id="kobo.1396.1">Certificate Authority</span></strong><span class="koboSpan" id="kobo.1397.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.1398.1">CA</span></strong><span class="koboSpan" id="kobo.1399.1">) to issue an SSL/TLS certificate for it, so that </span><a id="_idIndexMarker1635"/><span class="koboSpan" id="kobo.1400.1">browsers can verify its identity. </span><span class="koboSpan" id="kobo.1400.2">In that case, you can give a value to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1401.1">SECURE_HSTS_SECONDS</span></code><span class="koboSpan" id="kobo.1402.1"> higher than </span><code class="inlineCode"><span class="koboSpan" id="kobo.1403.1">0</span></code><span class="koboSpan" id="kobo.1404.1">, which is the default value. </span><span class="koboSpan" id="kobo.1404.2">You </span><a id="_idIndexMarker1636"/><span class="koboSpan" id="kobo.1405.1">can learn more about the HSTS policy at </span><a href="https://docs.djangoproject.com/en/5.0/ref/middleware/#http-strict-transport-security"><span class="url"><span class="koboSpan" id="kobo.1406.1">https://docs.djangoproject.com/en/5.0/ref/middleware/#http-strict-transport-security</span></span></a><span class="koboSpan" id="kobo.1407.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1408.1">You have successfully fixed the rest of the issues raised by the check framework. </span><span class="koboSpan" id="kobo.1408.2">You can read more about the Django deployment checklist at </span><a href="https://docs.djangoproject.com/en/5.0/howto/deployment/checklist/"><span class="url"><span class="koboSpan" id="kobo.1409.1">https://docs.djangoproject.com/en/5.0/howto/deployment/checklist/</span></span></a><span class="koboSpan" id="kobo.1410.1">.</span></p>
<h2 class="heading-2" id="_idParaDest-472"><span class="koboSpan" id="kobo.1411.1">Creating an SSL/TLS certificate</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1412.1">Create a new </span><a id="_idIndexMarker1637"/><span class="koboSpan" id="kobo.1413.1">directory inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1414.1">educa</span></code><span class="koboSpan" id="kobo.1415.1"> project directory and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.1416.1">ssl</span></code><span class="koboSpan" id="kobo.1417.1">. </span><span class="koboSpan" id="kobo.1417.2">Then, generate an SSL/TLS certificate from the command line with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1418.1">openssl req -x509 -newkey rsa:2048 -sha256 -days 3650 -nodes \
  -keyout ssl/educa.key -out ssl/educa.crt \
  -subj '/CN=*.educaproject.com' \
  -addext 'subjectAltName=DNS:*.educaproject.com'
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1419.1">This will generate a private key and a 2048-bit SSL/TLS certificate that is valid for 10 years. </span><span class="koboSpan" id="kobo.1419.2">This certificate is issued for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1420.1">*.educaproject.com</span></code><span class="koboSpan" id="kobo.1421.1"> hostname. </span><span class="koboSpan" id="kobo.1421.2">This is a wildcard certificate; by using the * wildcard character in the domain name, the certificate can be used for any subdomain of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1422.1">educaproject.com</span></code><span class="koboSpan" id="kobo.1423.1">, such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.1424.1">www.educaproject.com</span></code><span class="koboSpan" id="kobo.1425.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.1426.1">django.educaproject.com</span></code><span class="koboSpan" id="kobo.1427.1">. </span><span class="koboSpan" id="kobo.1427.2">After generating the certificate, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1428.1">educa/ssl/</span></code><span class="koboSpan" id="kobo.1429.1"> directory will contain two files: </span><code class="inlineCode"><span class="koboSpan" id="kobo.1430.1">educa.key</span></code><span class="koboSpan" id="kobo.1431.1"> (the private key) and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1432.1">educa.crt</span></code><span class="koboSpan" id="kobo.1433.1"> (the certificate).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1434.1">You will need at least OpenSSL 1.1.1 or LibreSSL 3.1.0 to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1435.1">-addext</span></code><span class="koboSpan" id="kobo.1436.1"> option. </span><span class="koboSpan" id="kobo.1436.2">You can check the OpenSSL location in your machine with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1437.1">which openssl</span></code><span class="koboSpan" id="kobo.1438.1"> command and you can check </span><a id="_idIndexMarker1638"/><span class="koboSpan" id="kobo.1439.1">the version with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1440.1">openssl version</span></code><span class="koboSpan" id="kobo.1441.1"> command.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1442.1">Alternatively, you can use the SSL/TLS certificate provided in the source code for this chapter. </span><span class="koboSpan" id="kobo.1442.2">You will find the certificate at </span><a href="https://github.com/PacktPublishing/Django-5-by-example/blob/main/Chapter17/educa/ssl/"><span class="url"><span class="koboSpan" id="kobo.1443.1">https://github.com/PacktPublishing/Django-5-by-example/blob/main/Chapter17/educa/ssl/</span></span></a><span class="koboSpan" id="kobo.1444.1">. </span><span class="koboSpan" id="kobo.1444.2">Note that you should generate a private key and not use this certificate in production.</span></p>
<h2 class="heading-2" id="_idParaDest-473"><span class="koboSpan" id="kobo.1445.1">Configuring NGINX to use SSL/TLS</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1446.1">Edit </span><a id="_idIndexMarker1639"/><span class="koboSpan" id="kobo.1447.1">the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1448.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.1449.1"> file and add the </span><a id="_idIndexMarker1640"/><span class="koboSpan" id="kobo.1450.1">following line highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1451.1">services:
  </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1452.1"># ...</span></span><span class="koboSpan" id="kobo.1453.1">
  nginx:
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1454.1">#...</span></span><span class="koboSpan" id="kobo.1455.1">
    ports:
      - </span><span class="hljs-string"><span class="koboSpan" id="kobo.1456.1">"80:80"</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1457.1">      - </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1458.1">"443:443"</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1459.1">The NGINX container host will be accessible through port </span><code class="inlineCode"><span class="koboSpan" id="kobo.1460.1">80</span></code><span class="koboSpan" id="kobo.1461.1"> (HTTP) and port </span><code class="inlineCode"><span class="koboSpan" id="kobo.1462.1">443</span></code><span class="koboSpan" id="kobo.1463.1"> (HTTPS). </span><span class="koboSpan" id="kobo.1463.2">The host port </span><code class="inlineCode"><span class="koboSpan" id="kobo.1464.1">443</span></code><span class="koboSpan" id="kobo.1465.1"> is mapped to the container port </span><code class="inlineCode"><span class="koboSpan" id="kobo.1466.1">443</span></code><span class="koboSpan" id="kobo.1467.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1468.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1469.1">config/nginx/default.conf.template</span></code><span class="koboSpan" id="kobo.1470.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1471.1">educa</span></code><span class="koboSpan" id="kobo.1472.1"> project and edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1473.1">server</span></code><span class="koboSpan" id="kobo.1474.1"> block to include SSL/TLS, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1475.1">server {
   listen               </span><span class="hljs-number"><span class="koboSpan" id="kobo.1476.1">80</span></span><span class="koboSpan" id="kobo.1477.1">;
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1478.1">   listen               </span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.1479.1">443</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1480.1"> ssl;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1481.1">   ssl_certificate      /code/educa/ssl/educa.crt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1482.1">   ssl_certificate_key  /code/educa/ssl/educa.key;</span></strong></span><span class="koboSpan" id="kobo.1483.1">
   server_name          www.educaproject.com educaproject.com;
   </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1484.1"># ...</span></span><span class="koboSpan" id="kobo.1485.1">
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1486.1">With the preceding code, NGINX now listens both to HTTP over port </span><code class="inlineCode"><span class="koboSpan" id="kobo.1487.1">80</span></code><span class="koboSpan" id="kobo.1488.1"> and HTTPS over port </span><code class="inlineCode"><span class="koboSpan" id="kobo.1489.1">443</span></code><span class="koboSpan" id="kobo.1490.1">. </span><span class="koboSpan" id="kobo.1490.2">You indicate the path to the SSL/TLS certificate with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1491.1">ssl_certificate</span></code><span class="koboSpan" id="kobo.1492.1"> and the certificate key with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1493.1">ssl_certificate_key</span></code><span class="koboSpan" id="kobo.1494.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1495.1">Stop the Docker application from the shell by pressing the </span><em class="italic"><span class="koboSpan" id="kobo.1496.1">Ctrl</span></em><span class="koboSpan" id="kobo.1497.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.1498.1">C</span></em><span class="koboSpan" id="kobo.1499.1"> keys or using the stop button </span><a id="_idIndexMarker1641"/><span class="koboSpan" id="kobo.1500.1">in the Docker Desktop app. </span><span class="koboSpan" id="kobo.1500.2">Then, start </span><a id="_idIndexMarker1642"/><span class="koboSpan" id="kobo.1501.1">Compose again with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1502.1">docker compose up
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1503.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.1504.1">https://educaproject.com/</span></code><span class="koboSpan" id="kobo.1505.1"> with your browser. </span><span class="koboSpan" id="kobo.1505.2">You should see a warning message similar to the following one:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1506.1"><img alt="" role="presentation" src="../Images/B21088_17_10.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1507.1">Figure 17.10: An invalid certificate warning</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1508.1">This screen might vary depending on your browser. </span><span class="koboSpan" id="kobo.1508.2">It alerts you that your site is not using a trusted or valid certificate; the browser can’t verify the identity of your site. </span><span class="koboSpan" id="kobo.1508.3">This is because you signed your own certificate instead of obtaining one from a trusted CA. </span><span class="koboSpan" id="kobo.1508.4">When you own a real domain, you can apply for a trusted CA to issue an SSL/TLS certificate for it, so that browsers can verify its identity. </span><span class="koboSpan" id="kobo.1508.5">If you want to obtain a trusted certificate </span><a id="_idIndexMarker1643"/><span class="koboSpan" id="kobo.1509.1">for a real domain, you can refer to the Let’s Encrypt project created by the Linux Foundation. </span><span class="koboSpan" id="kobo.1509.2">It is a nonprofit CA that simplifies </span><a id="_idIndexMarker1644"/><span class="koboSpan" id="kobo.1510.1">obtaining and renewing trusted SSL/TLS certificates for free. </span><span class="koboSpan" id="kobo.1510.2">You can find more information at </span><a href="https://letsencrypt.org"><span class="url"><span class="koboSpan" id="kobo.1511.1">https://letsencrypt.org</span></span></a><span class="koboSpan" id="kobo.1512.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1513.1">Click on the link or button that provides additional information and choose to visit the website, ignoring warnings. </span><span class="koboSpan" id="kobo.1513.2">The browser might ask you to add an exception for this certificate or verify that you trust it. </span><span class="koboSpan" id="kobo.1513.3">If you are using Chrome, you might not see any option to proceed to the website. </span><span class="koboSpan" id="kobo.1513.4">If this is the case, type </span><code class="inlineCode"><span class="koboSpan" id="kobo.1514.1">thisisunsafe</span></code><span class="koboSpan" id="kobo.1515.1"> and press </span><em class="italic"><span class="koboSpan" id="kobo.1516.1">Enter</span></em><span class="koboSpan" id="kobo.1517.1"> directly in Chrome on the warning page. </span><span class="koboSpan" id="kobo.1517.2">Chrome will then load the website. </span><span class="koboSpan" id="kobo.1517.3">Note that you do this with your own issued certificate; don’t trust any unknown certificate or bypass the browser SSL/TLS certificate checks for other domains.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1518.1">When you access the site, the browser will display a lock icon next to the URL like </span><em class="italic"><span class="koboSpan" id="kobo.1519.1">Figure 17.11</span></em><span class="koboSpan" id="kobo.1520.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1521.1"><img alt="" role="presentation" src="../Images/B21088_17_11.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1522.1">Figure 17.11: The browser address bar, including a secure connection padlock icon</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1523.1">Other browsers might display a warning indicating that the certificate is not trusted, like </span><em class="italic"><span class="koboSpan" id="kobo.1524.1">Figure 17.12</span></em><span class="koboSpan" id="kobo.1525.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1526.1"><img alt="" role="presentation" src="../Images/B21088_17_12.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1527.1">Figure 17.12: The browser address bar, including a warning message</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1528.1">Your browser might mark the certificate as unsafe, but you are using it for testing purposes only. </span><span class="koboSpan" id="kobo.1528.2">You are now serving your site securely over HTTPS.</span></p>
<h2 class="heading-2" id="_idParaDest-474"><span class="koboSpan" id="kobo.1529.1">Redirecting HTTP traffic over to HTTPS</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1530.1">You </span><a id="_idIndexMarker1645"/><span class="koboSpan" id="kobo.1531.1">are redirecting HTTP requests to HTTPS with Django using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1532.1">SECURE_SSL_REDIRECT</span></code><span class="koboSpan" id="kobo.1533.1"> setting. </span><span class="koboSpan" id="kobo.1533.2">Any request using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1534.1">http://</span></code><span class="koboSpan" id="kobo.1535.1"> is redirected to the same URL using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1536.1">https://</span></code><span class="koboSpan" id="kobo.1537.1">. </span><span class="koboSpan" id="kobo.1537.2">However, this can be handled in a more efficient manner using NGINX.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1538.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1539.1">config/nginx/default.conf.template</span></code><span class="koboSpan" id="kobo.1540.1"> file and add the following lines highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1541.1"># upstream for uWSGI</span></span><span class="koboSpan" id="kobo.1542.1">
upstream uwsgi_app {
    server unix:/code/educa/uwsgi_app.sock;
}
server {
    listen      </span><span class="hljs-number"><span class="koboSpan" id="kobo.1543.1">80</span></span><span class="koboSpan" id="kobo.1544.1">;
    </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1545.1">server_name www.educaproject.com educaproject.com;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1546.1">return</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.1547.1">301</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1548.1"> https://$host$request_uri;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1549.1">}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1550.1">server {</span></strong></span><span class="koboSpan" id="kobo.1551.1">
    listen               </span><span class="hljs-number"><span class="koboSpan" id="kobo.1552.1">443</span></span><span class="koboSpan" id="kobo.1553.1"> ssl;
    ssl_certificate      /code/educa/ssl/educa.crt;
    ssl_certificate_key  /code/educa/ssl/educa.key;
    server_name   www.educaproject.com educaproject.com;
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1554.1"># ...</span></span><span class="koboSpan" id="kobo.1555.1">
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1556.1">In this code, you remove the directive </span><code class="inlineCode"><span class="koboSpan" id="kobo.1557.1">listen 80;</span></code><span class="koboSpan" id="kobo.1558.1"> from the original </span><code class="inlineCode"><span class="koboSpan" id="kobo.1559.1">server</span></code><span class="koboSpan" id="kobo.1560.1"> block, so that the platform is only available over HTTPS (port </span><code class="inlineCode"><span class="koboSpan" id="kobo.1561.1">443</span></code><span class="koboSpan" id="kobo.1562.1">). </span><span class="koboSpan" id="kobo.1562.2">On top of the original </span><code class="inlineCode"><span class="koboSpan" id="kobo.1563.1">server</span></code><span class="koboSpan" id="kobo.1564.1"> block, you add an additional </span><code class="inlineCode"><span class="koboSpan" id="kobo.1565.1">server</span></code><span class="koboSpan" id="kobo.1566.1"> block that only listens on port </span><code class="inlineCode"><span class="koboSpan" id="kobo.1567.1">80</span></code><span class="koboSpan" id="kobo.1568.1"> and redirects all HTTP requests to HTTPS. </span><span class="koboSpan" id="kobo.1568.2">To achieve this, you return an HTTP response code </span><code class="inlineCode"><span class="koboSpan" id="kobo.1569.1">301</span></code><span class="koboSpan" id="kobo.1570.1"> (permanent redirect) that redirects to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1571.1">https://</span></code><span class="koboSpan" id="kobo.1572.1"> version of the requested URL using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1573.1">$host</span></code><span class="koboSpan" id="kobo.1574.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1575.1">$request_uri</span></code><span class="koboSpan" id="kobo.1576.1"> variables.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1577.1">Open a shell in the parent directory, where the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1578.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.1579.1"> file is located, and run the following command to reload NGINX:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1580.1">docker compose exec nginx nginx -s reload
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1581.1">This runs the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1582.1">nginx -s reload</span></code><span class="koboSpan" id="kobo.1583.1"> command in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1584.1">nginx</span></code><span class="koboSpan" id="kobo.1585.1"> container. </span><span class="koboSpan" id="kobo.1585.2">You are now redirecting all HTTP traffic to HTTPS using NGINX.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1586.1">Your </span><a id="_idIndexMarker1646"/><span class="koboSpan" id="kobo.1587.1">environment is now secured with TLS/SSL. </span><span class="koboSpan" id="kobo.1587.2">To complete the production environment setup, the only remaining step is integrating Daphne to handle asynchronous requests, and get our course chat rooms running in production.</span></p>
<h1 class="heading-1" id="_idParaDest-475"><span class="koboSpan" id="kobo.1588.1">Configuring Daphne for Django Channels</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1589.1">In </span><em class="italic"><span class="koboSpan" id="kobo.1590.1">Chapter 16</span></em><span class="koboSpan" id="kobo.1591.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1592.1">Building a Chat Server</span></em><span class="koboSpan" id="kobo.1593.1">, you used Django Channels to build a chat server using </span><a id="_idIndexMarker1647"/><span class="koboSpan" id="kobo.1594.1">WebSockets and you used Daphne to </span><a id="_idIndexMarker1648"/><span class="koboSpan" id="kobo.1595.1">serve asynchronous requests by replacing the standard Django </span><code class="inlineCode"><span class="koboSpan" id="kobo.1596.1">runserver</span></code><span class="koboSpan" id="kobo.1597.1"> command. </span><span class="koboSpan" id="kobo.1597.2">We will add Daphne to our production environment.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1598.1">Let’s create a new service in the Docker Compose file to run the Daphne web server.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1599.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1600.1">docker-compose.yml</span></code><span class="koboSpan" id="kobo.1601.1"> file and add the following lines inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1602.1">services</span></code><span class="koboSpan" id="kobo.1603.1"> block:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1604.1">daphne:
    build: .
    </span><span class="koboSpan" id="kobo.1604.2">working_dir: /code/educa/
    command: [</span><span class="hljs-string"><span class="koboSpan" id="kobo.1605.1">"../wait-for-it.sh"</span></span><span class="koboSpan" id="kobo.1606.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1607.1">"db:5432"</span></span><span class="koboSpan" id="kobo.1608.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1609.1">"--"</span></span><span class="koboSpan" id="kobo.1610.1">,
              </span><span class="hljs-string"><span class="koboSpan" id="kobo.1611.1">"daphne"</span></span><span class="koboSpan" id="kobo.1612.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1613.1">"-b"</span></span><span class="koboSpan" id="kobo.1614.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1615.1">"0.0.0.0"</span></span><span class="koboSpan" id="kobo.1616.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1617.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1618.1">-p"</span></span><span class="koboSpan" id="kobo.1619.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1620.1">"9001"</span></span><span class="koboSpan" id="kobo.1621.1">,
              </span><span class="hljs-string"><span class="koboSpan" id="kobo.1622.1">"educa.asgi:application"</span></span><span class="koboSpan" id="kobo.1623.1">]
    restart: always
    volumes:
      - .:/code
    environment:
      - DJANGO_SETTINGS_MODULE=educa.settings.prod
      - POSTGRES_DB=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    depends_on:
      - db
      - cache
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1624.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1625.1">daphne</span></code><span class="koboSpan" id="kobo.1626.1"> service definition is very similar to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1627.1">web</span></code><span class="koboSpan" id="kobo.1628.1"> service. </span><span class="koboSpan" id="kobo.1628.2">The image for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1629.1">daphne</span></code><span class="koboSpan" id="kobo.1630.1"> service is also built with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1631.1">Dockerfile</span></code><span class="koboSpan" id="kobo.1632.1"> you previously created for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1633.1">web</span></code><span class="koboSpan" id="kobo.1634.1"> service. </span><span class="koboSpan" id="kobo.1634.2">The main differences are as follows:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1635.1">working_dir</span></code><span class="koboSpan" id="kobo.1636.1"> changes the working directory of the image to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1637.1">/code/educa/</span></code><span class="koboSpan" id="kobo.1638.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1639.1">command</span></code><span class="koboSpan" id="kobo.1640.1"> runs the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1641.1">educa.asgi:application</span></code><span class="koboSpan" id="kobo.1642.1"> application defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1643.1">educa/asgi.py</span></code><span class="koboSpan" id="kobo.1644.1"> file with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1645.1">daphne</span></code><span class="koboSpan" id="kobo.1646.1"> in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1647.1">0.0.0.0</span></code><span class="koboSpan" id="kobo.1648.1"> hostname and port </span><code class="inlineCode"><span class="koboSpan" id="kobo.1649.1">9001</span></code><span class="koboSpan" id="kobo.1650.1">. </span><span class="koboSpan" id="kobo.1650.2">It also uses the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1651.1">wait-for-it</span></code><span class="koboSpan" id="kobo.1652.1"> bash script to wait for the PostgreSQL database to be ready before initializing the web server.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1653.1">Since you </span><a id="_idIndexMarker1649"/><span class="koboSpan" id="kobo.1654.1">are running Django on production, Django checks the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1655.1">ALLOWED_HOSTS</span></code><span class="koboSpan" id="kobo.1656.1"> when receiving HTTP requests. </span><span class="koboSpan" id="kobo.1656.2">We will implement </span><a id="_idIndexMarker1650"/><span class="koboSpan" id="kobo.1657.1">the same validation for WebSocket connections.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1658.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1659.1">educa/asgi.py</span></code><span class="koboSpan" id="kobo.1660.1"> file of your project and add the following lines highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1661.1">import</span></span><span class="koboSpan" id="kobo.1662.1"> os
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1663.1">from</span></span><span class="koboSpan" id="kobo.1664.1"> django.core.asgi </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1665.1">import</span></span><span class="koboSpan" id="kobo.1666.1"> get_asgi_application
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1667.1">from</span></span><span class="koboSpan" id="kobo.1668.1"> channels.routing </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1669.1">import</span></span><span class="koboSpan" id="kobo.1670.1"> ProtocolTypeRouter, URLRouter
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1671.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1672.1"> channels.security.websocket </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1673.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1674.1"> AllowedHostsOriginValidator</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1675.1">from</span></span><span class="koboSpan" id="kobo.1676.1"> channels.auth </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1677.1">import</span></span><span class="koboSpan" id="kobo.1678.1"> AuthMiddlewareStack
os.environ.setdefault(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1679.1">'DJANGO_SETTINGS_MODULE'</span></span><span class="koboSpan" id="kobo.1680.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1681.1">'educa.settings'</span></span><span class="koboSpan" id="kobo.1682.1">)
django_asgi_app = get_asgi_application()
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1683.1">from</span></span><span class="koboSpan" id="kobo.1684.1"> chat.routing </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1685.1">import</span></span><span class="koboSpan" id="kobo.1686.1"> websocket_urlpatterns
application = ProtocolTypeRouter({
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1687.1">'http'</span></span><span class="koboSpan" id="kobo.1688.1">: django_asgi_app,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1689.1">'websocket'</span></span><span class="koboSpan" id="kobo.1690.1">: </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1691.1">AllowedHostsOriginValidator(</span></strong></span><span class="koboSpan" id="kobo.1692.1">
        AuthMiddlewareStack(
            URLRouter(websocket_urlpatterns)
        )
    </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1693.1">)</span></strong></span><span class="koboSpan" id="kobo.1694.1">,
})
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1695.1">The Channels configuration is now ready for production.</span></p>
<h2 class="heading-2" id="_idParaDest-476"><span class="koboSpan" id="kobo.1696.1">Using secure connections for WebSockets</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1697.1">You </span><a id="_idIndexMarker1651"/><span class="koboSpan" id="kobo.1698.1">have configured NGINX </span><a id="_idIndexMarker1652"/><span class="koboSpan" id="kobo.1699.1">to use secure connections with SSL/TLS. </span><span class="koboSpan" id="kobo.1699.2">You need to change </span><code class="inlineCode"><span class="koboSpan" id="kobo.1700.1">ws</span></code><span class="koboSpan" id="kobo.1701.1"> (WebSocket) connections to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1702.1">wss</span></code><span class="koboSpan" id="kobo.1703.1"> (WebSocket Secure) protocol now, in the same way that HTTP connections are now being served over HTTPS.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1704.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1705.1">chat/room.html</span></code><span class="koboSpan" id="kobo.1706.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1707.1">chat</span></code><span class="koboSpan" id="kobo.1708.1"> application and find the following line in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1709.1">domready</span></code><span class="koboSpan" id="kobo.1710.1"> block:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1711.1">const url = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1712.1">'ws://'</span></span><span class="koboSpan" id="kobo.1713.1"> + window.location.host +
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1714.1">Replace </span><a id="_idIndexMarker1653"/><span class="koboSpan" id="kobo.1715.1">that line with </span><a id="_idIndexMarker1654"/><span class="koboSpan" id="kobo.1716.1">the following one:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1717.1">const url = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1718.1">'ws</span></span><span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1719.1">s</span></strong></span><span class="hljs-string"><span class="koboSpan" id="kobo.1720.1">://'</span></span><span class="koboSpan" id="kobo.1721.1"> + window.location.host +
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1722.1">By using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1723.1">wss://</span></code><span class="koboSpan" id="kobo.1724.1"> instead of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1725.1">ws://</span></code><span class="koboSpan" id="kobo.1726.1">, you are explicitly connecting to a secure WebSocket.</span></p>
<h2 class="heading-2" id="_idParaDest-477"><span class="koboSpan" id="kobo.1727.1">Including Daphne in the NGINX configuration</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1728.1">In your production setup, you will run Daphne on a UNIX socket and use NGINX in front of it. </span><span class="koboSpan" id="kobo.1728.2">NGINX </span><a id="_idIndexMarker1655"/><span class="koboSpan" id="kobo.1729.1">will pass requests to Daphne based on the requested path. </span><span class="koboSpan" id="kobo.1729.2">You will expose Daphne to NGINX through a UNIX socket interface, just like the uWSGI setup.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1730.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1731.1">config/nginx/default.conf.template</span></code><span class="koboSpan" id="kobo.1732.1"> file and make it look as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1733.1"># upstream for uWSGI</span></span><span class="koboSpan" id="kobo.1734.1">
upstream uwsgi_app {
    server unix:/code/educa/uwsgi_app.sock;
}
</span><span class="code-highlight"><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1735.1"># upstream for Daphne</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1736.1">upstream daphne {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1737.1">    server daphne:</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.1738.1">9001</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1739.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1740.1">}</span></strong></span><span class="koboSpan" id="kobo.1741.1">
server {
    listen       </span><span class="hljs-number"><span class="koboSpan" id="kobo.1742.1">80</span></span><span class="koboSpan" id="kobo.1743.1">;
    server_name www.educaproject.com educaproject.com;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1744.1">return</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.1745.1">301</span></span><span class="koboSpan" id="kobo.1746.1"> https://$host$request_uri;
}
server {
    listen               </span><span class="hljs-number"><span class="koboSpan" id="kobo.1747.1">443</span></span><span class="koboSpan" id="kobo.1748.1"> ssl;
    ssl_certificate      /code/educa/ssl/educa.crt;
    ssl_certificate_key  /code/educa/ssl/educa.key;
    server_name  www.educaproject.com educaproject.com;
    error_log    stderr warn;
    access_log   /dev/stdout main;
    location / {
        include      /etc/nginx/uwsgi_params;
        uwsgi_pass   uwsgi_app;
    }
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1749.1">    location /ws/ {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1750.1">        proxy_pass          http://daphne;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1751.1">        proxy_http_version  </span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.1752.1">1.1</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1753.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1754.1">        proxy_set_header    Upgrade $http_upgrade;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1755.1">        proxy_set_header    Connection </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1756.1">"upgrade"</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1757.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1758.1">        proxy_redirect      off;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1759.1">    }</span></strong></span><span class="koboSpan" id="kobo.1760.1">
    location /static/ {
        alias /code/educa/static/;
    }
    location /media/ {
        alias /code/educa/media/;
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1761.1">In this </span><a id="_idIndexMarker1656"/><span class="koboSpan" id="kobo.1762.1">configuration, you set up a new upstream named </span><code class="inlineCode"><span class="koboSpan" id="kobo.1763.1">daphne</span></code><span class="koboSpan" id="kobo.1764.1">, which points to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1765.1">daphne</span></code><span class="koboSpan" id="kobo.1766.1"> host and port </span><code class="inlineCode"><span class="koboSpan" id="kobo.1767.1">9001</span></code><span class="koboSpan" id="kobo.1768.1">. </span><span class="koboSpan" id="kobo.1768.2">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1769.1">server</span></code><span class="koboSpan" id="kobo.1770.1"> block, you configure the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1771.1">/ws/</span></code><span class="koboSpan" id="kobo.1772.1"> location to forward requests to Daphne. </span><span class="koboSpan" id="kobo.1772.2">You use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1773.1">proxy_pass</span></code><span class="koboSpan" id="kobo.1774.1"> directive to pass requests to Daphne and you include some additional proxy directives.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1775.1">With this configuration, NGINX will pass any URL request that starts with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1776.1">/ws/</span></code><span class="koboSpan" id="kobo.1777.1"> prefix to Daphne and the rest to uWSGI, except for files under the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1778.1">/static/</span></code><span class="koboSpan" id="kobo.1779.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.1780.1">/media/</span></code><span class="koboSpan" id="kobo.1781.1"> paths, which will be served directly by NGINX.</span></p>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.1782.1">Figure 17.13</span></em><span class="koboSpan" id="kobo.1783.1"> shows the final production setup, including the Daphne server:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1784.1"><img alt="" role="presentation" src="../Images/B21088_17_13.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1785.1">Figure 17.13: The production environment request/response cycle, including Daphne</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1786.1">NGINX runs in front of uWSGI and Daphne as a reverse proxy server. </span><span class="koboSpan" id="kobo.1786.2">NGINX faces the web </span><a id="_idIndexMarker1657"/><span class="koboSpan" id="kobo.1787.1">and passes requests to the application server (uWSGI or Daphne) based on their path prefix. </span><span class="koboSpan" id="kobo.1787.2">Besides this, NGINX also serves static files and redirects non-secure requests to secure ones. </span><span class="koboSpan" id="kobo.1787.3">This setup reduces downtime, consumes fewer server resources, and provides greater performance and security.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1788.1">Stop the Docker application from the shell by pressing the </span><em class="italic"><span class="koboSpan" id="kobo.1789.1">Ctrl</span></em><span class="koboSpan" id="kobo.1790.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.1791.1">C</span></em><span class="koboSpan" id="kobo.1792.1"> keys or using the stop button in the Docker Desktop app. </span><span class="koboSpan" id="kobo.1792.2">Then, start Compose again with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1793.1">docker compose up
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1794.1">Use your browser to create a sample course with an instructor user, log in with a user who is enrolled in the course, and open </span><code class="inlineCode"><span class="koboSpan" id="kobo.1795.1">https://educaproject.com/chat/room/1/</span></code><span class="koboSpan" id="kobo.1796.1"> with your browser. </span><span class="koboSpan" id="kobo.1796.2">You should be able to send and receive messages like the following example:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1797.1"><img alt="" role="presentation" src="../Images/B21088_17_14.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1798.1">Figure 17.14: Course chat room messages served with NGINX and Daphne</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1799.1">Daphne </span><a id="_idIndexMarker1658"/><span class="koboSpan" id="kobo.1800.1">is working correctly, and NGINX is passing WebSocket requests to it. </span><span class="koboSpan" id="kobo.1800.2">All connections are secured with SSL/TLS.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1801.1">Congratulations! </span><span class="koboSpan" id="kobo.1801.2">You have built a custom production-ready stack using NGINX, uWSGI, and Daphne. </span><span class="koboSpan" id="kobo.1801.3">You could do further optimization for additional performance and enhanced security through configuration settings in NGINX, uWSGI, and Daphne. </span><span class="koboSpan" id="kobo.1801.4">However, this production setup is a great start!</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1802.1">You have used Docker Compose to define and run services in multiple containers. </span><span class="koboSpan" id="kobo.1802.2">Note that you can use Docker Compose both for local development environments as well as production environments. </span><span class="koboSpan" id="kobo.1802.3">You can find additional information on using Docker Compose in production at </span><a href="https://docs.docker.com/compose/production/"><span class="url"><span class="koboSpan" id="kobo.1803.1">https://docs.docker.com/compose/production/</span></span></a><span class="koboSpan" id="kobo.1804.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1805.1">For more advanced production environments, you will need to dynamically distribute containers across a varying number of machines. </span><span class="koboSpan" id="kobo.1805.2">For that, instead of Docker Compose, you will need an orchestrator like Docker Swarm mode or Kubernetes. </span><span class="koboSpan" id="kobo.1805.3">You can find information about the Docker Swarm mode at </span><a href="https://docs.docker.com/engine/swarm/"><span class="url"><span class="koboSpan" id="kobo.1806.1">https://docs.docker.com/engine/swarm/</span></span></a><span class="koboSpan" id="kobo.1807.1">, and about Kubernetes at </span><a href="https://kubernetes.io/docs/home/"><span class="url"><span class="koboSpan" id="kobo.1808.1">https://kubernetes.io/docs/home/</span></span></a><span class="koboSpan" id="kobo.1809.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1810.1">Note that managing systems and cloud infrastructure demands expertise in configuration, optimization, and security. </span><span class="koboSpan" id="kobo.1810.2">To ensure a secure and efficient production environment, consider bringing a systems/DevOps expert on board or enhancing your own expertise in these areas.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1811.1">Now that </span><a id="_idIndexMarker1659"/><span class="koboSpan" id="kobo.1812.1">we have a complete environment that processes HTTP requests in a performant manner, it’s a good time to dive into middleware for request/response processing across our application.</span></p>
<h1 class="heading-1" id="_idParaDest-478"><span class="koboSpan" id="kobo.1813.1">Creating a custom middleware</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1814.1">You already know the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1815.1">MIDDLEWARE</span></code><span class="koboSpan" id="kobo.1816.1"> setting, which contains the middleware for your project. </span><span class="koboSpan" id="kobo.1816.2">You can think of it as a low-level plugin system, allowing you to implement hooks that </span><a id="_idIndexMarker1660"/><span class="koboSpan" id="kobo.1817.1">get executed in the request/response process. </span><span class="koboSpan" id="kobo.1817.2">Each middleware is responsible for some specific action that will be executed for all HTTP requests or responses.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.1818.1">You should avoid adding expensive processing to middleware since they are executed in every single request.</span></p>
</div>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.1819.1">Figure 17.15</span></em><span class="koboSpan" id="kobo.1820.1"> shows the middleware execution in Django:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1821.1"><img alt="" role="presentation" src="../Images/B21088_17_15.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1822.1">Figure 17.15: Middleware execution in Django</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1823.1">When an </span><a id="_idIndexMarker1661"/><span class="koboSpan" id="kobo.1824.1">HTTP request is received, middleware is executed in order of appearance in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1825.1">MIDDLEWARE</span></code><span class="koboSpan" id="kobo.1826.1"> setting. </span><span class="koboSpan" id="kobo.1826.2">When an HTTP response has been generated by Django, the response passes through all middleware back in reverse order.</span></p>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.1827.1">Figure 17.16</span></em><span class="koboSpan" id="kobo.1828.1"> shows the execution order of the middleware components included in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1829.1">MIDDLEWARE</span></code><span class="koboSpan" id="kobo.1830.1"> setting when creating a project with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1831.1">startproject</span></code><span class="koboSpan" id="kobo.1832.1"> management command:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1833.1"><img alt="" role="presentation" src="../Images/B21088_17_16.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1834.1">Figure 17.16: Execution order for default middleware components</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1835.1">Middleware </span><a id="_idIndexMarker1662"/><span class="koboSpan" id="kobo.1836.1">can be written as a function, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1837.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1838.1">my_middleware</span></span><span class="koboSpan" id="kobo.1839.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1840.1">get_response</span></span><span class="koboSpan" id="kobo.1841.1">):
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1842.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1843.1">middleware</span></span><span class="koboSpan" id="kobo.1844.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1845.1">request</span></span><span class="koboSpan" id="kobo.1846.1">):
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1847.1"># Code executed for each request before</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1848.1"># the view (and later middleware) are called.</span></span><span class="koboSpan" id="kobo.1849.1">
        response = get_response(request)
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1850.1"># Code executed for each request/response after</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1851.1"># the view is called.</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1852.1">return</span></span><span class="koboSpan" id="kobo.1853.1"> response
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1854.1">return</span></span><span class="koboSpan" id="kobo.1855.1"> middleware
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1856.1">A middleware factory is a callable that takes a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1857.1">get_response</span></code><span class="koboSpan" id="kobo.1858.1"> callable and returns middleware. </span><span class="koboSpan" id="kobo.1858.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1859.1">middleware</span></code><span class="koboSpan" id="kobo.1860.1"> callable takes a request and returns a response, just like a view. </span><span class="koboSpan" id="kobo.1860.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1861.1">get_response</span></code><span class="koboSpan" id="kobo.1862.1"> callable might be the next middleware in the chain or the actual view in the case of the last listed middleware.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1863.1">If any </span><a id="_idIndexMarker1663"/><span class="koboSpan" id="kobo.1864.1">middleware returns a response without calling its </span><code class="inlineCode"><span class="koboSpan" id="kobo.1865.1">get_response</span></code><span class="koboSpan" id="kobo.1866.1"> callable, it short-circuits the process; no further middleware gets executed (nor does the view), and the response returns through the same layers that the request passed in through.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1867.1">The order of middleware components in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1868.1">MIDDLEWARE</span></code><span class="koboSpan" id="kobo.1869.1"> setting is very important because each component may depend on the data set in the request by other middleware components executed previously.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1870.1">When adding a new middleware to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1871.1">MIDDLEWARE</span></code><span class="koboSpan" id="kobo.1872.1"> setting, make sure to place it in the right position.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1873.1">You can find more information about middleware at </span><a href="https://docs.djangoproject.com/en/5.0/topics/http/middleware/"><span class="url"><span class="koboSpan" id="kobo.1874.1">https://docs.djangoproject.com/en/5.0/topics/http/middleware/</span></span></a><span class="koboSpan" id="kobo.1875.1">.</span></p>
<h2 class="heading-2" id="_idParaDest-479"><span class="koboSpan" id="kobo.1876.1">Creating subdomain middleware</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1877.1">You are going to create custom middleware to allow courses to be accessible through a custom </span><a id="_idIndexMarker1664"/><span class="koboSpan" id="kobo.1878.1">subdomain. </span><span class="koboSpan" id="kobo.1878.2">Each course detail URL, which looks like </span><code class="inlineCode"><span class="koboSpan" id="kobo.1879.1">https://educaproject.com/course/django/</span></code><span class="koboSpan" id="kobo.1880.1">, will also be accessible through the subdomain that makes use of the course slug, such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.1881.1">https://django.educaproject.com/</span></code><span class="koboSpan" id="kobo.1882.1">. </span><span class="koboSpan" id="kobo.1882.2">Users will be able to use the subdomain as a shortcut to access the course details. </span><span class="koboSpan" id="kobo.1882.3">Any requests to subdomains will be redirected to each corresponding course detail URL.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1883.1">Middleware can reside anywhere within your project. </span><span class="koboSpan" id="kobo.1883.2">However, it’s recommended that you create a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1884.1">middleware.py</span></code><span class="koboSpan" id="kobo.1885.1"> file in your application directory.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1886.1">Create a new file inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1887.1">courses</span></code><span class="koboSpan" id="kobo.1888.1"> application directory and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.1889.1">middleware.py</span></code><span class="koboSpan" id="kobo.1890.1">. </span><span class="koboSpan" id="kobo.1890.2">Add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1891.1">from</span></span><span class="koboSpan" id="kobo.1892.1"> django.urls </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1893.1">import</span></span><span class="koboSpan" id="kobo.1894.1"> reverse
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1895.1">from</span></span><span class="koboSpan" id="kobo.1896.1"> django.shortcuts </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1897.1">import</span></span><span class="koboSpan" id="kobo.1898.1"> get_object_or_404, redirect
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1899.1">from</span></span><span class="koboSpan" id="kobo.1900.1"> .models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1901.1">import</span></span><span class="koboSpan" id="kobo.1902.1"> Course
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1903.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1904.1">subdomain_course_middleware</span></span><span class="koboSpan" id="kobo.1905.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1906.1">get_response</span></span><span class="koboSpan" id="kobo.1907.1">):
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1908.1">"""</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1909.1">    Subdomains for courses</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1910.1">    """</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1911.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1912.1">middleware</span></span><span class="koboSpan" id="kobo.1913.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1914.1">request</span></span><span class="koboSpan" id="kobo.1915.1">):
        host_parts = request.get_host().split(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1916.1">'.'</span></span><span class="koboSpan" id="kobo.1917.1">)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1918.1">if</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1919.1">len</span></span><span class="koboSpan" id="kobo.1920.1">(host_parts) &gt; </span><span class="hljs-number"><span class="koboSpan" id="kobo.1921.1">2</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1922.1">and</span></span><span class="koboSpan" id="kobo.1923.1"> host_parts[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1924.1">0</span></span><span class="koboSpan" id="kobo.1925.1">] != </span><span class="hljs-string"><span class="koboSpan" id="kobo.1926.1">'www'</span></span><span class="koboSpan" id="kobo.1927.1">:
            </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1928.1"># get course for the given subdomain</span></span><span class="koboSpan" id="kobo.1929.1">
            course = get_object_or_404(Course, slug=host_parts[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1930.1">0</span></span><span class="koboSpan" id="kobo.1931.1">])
            course_url = reverse(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1932.1">'course_detail'</span></span><span class="koboSpan" id="kobo.1933.1">, args=[course.slug])
            </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1934.1"># redirect current request to the course_detail view</span></span><span class="koboSpan" id="kobo.1935.1">
            url = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1936.1">'{}://{}{}'</span></span><span class="koboSpan" id="kobo.1937.1">.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1938.1">format</span></span><span class="koboSpan" id="kobo.1939.1">(
                request.scheme, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1940.1">'.'</span></span><span class="koboSpan" id="kobo.1941.1">.join(host_parts[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1942.1">1</span></span><span class="koboSpan" id="kobo.1943.1">:]), course_url
            )
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1944.1">return</span></span><span class="koboSpan" id="kobo.1945.1"> redirect(url)
        response = get_response(request)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1946.1">return</span></span><span class="koboSpan" id="kobo.1947.1"> response
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1948.1">return</span></span><span class="koboSpan" id="kobo.1949.1"> middleware
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1950.1">When an </span><a id="_idIndexMarker1665"/><span class="koboSpan" id="kobo.1951.1">HTTP request is received, you perform the following tasks:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1952.1">You get the hostname that is being used in the request and divide it into parts. </span><span class="koboSpan" id="kobo.1952.2">For example, if the user is accessing </span><code class="inlineCode"><span class="koboSpan" id="kobo.1953.1">mycourse.educaproject.com</span></code><span class="koboSpan" id="kobo.1954.1">, you generate the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1955.1">['mycourse', 'educaproject', 'com']</span></code><span class="koboSpan" id="kobo.1956.1"> list.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1957.1">You check whether the hostname includes a subdomain by checking whether the split generated more than two elements. </span><span class="koboSpan" id="kobo.1957.2">If the hostname includes a subdomain, and this is not </span><code class="inlineCode"><span class="koboSpan" id="kobo.1958.1">www</span></code><span class="koboSpan" id="kobo.1959.1">, you try to get the course with the slug provided in the subdomain.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1960.1">If a course is not found, you raise an HTTP </span><code class="inlineCode"><span class="koboSpan" id="kobo.1961.1">404</span></code><span class="koboSpan" id="kobo.1962.1"> exception. </span><span class="koboSpan" id="kobo.1962.2">Otherwise, you redirect the browser to the course detail URL.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1963.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1964.1">settings/base.py</span></code><span class="koboSpan" id="kobo.1965.1"> file of the project and add </span><code class="inlineCode"><span class="koboSpan" id="kobo.1966.1">'courses.middleware.subdomain_course_middleware'</span></code><span class="koboSpan" id="kobo.1967.1"> at the bottom of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1968.1">MIDDLEWARE</span></code><span class="koboSpan" id="kobo.1969.1"> list, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1970.1">MIDDLEWARE = [
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1971.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1972.1">'courses.middleware.subdomain_course_middleware'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1973.1">,</span></strong></span><span class="koboSpan" id="kobo.1974.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1975.1">The middleware will now be executed in every request.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1976.1">Remember </span><a id="_idIndexMarker1666"/><span class="koboSpan" id="kobo.1977.1">that the hostnames allowed to serve your Django project are specified in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1978.1">ALLOWED_HOSTS</span></code><span class="koboSpan" id="kobo.1979.1"> setting. </span><span class="koboSpan" id="kobo.1979.2">Let’s change this setting so that any possible subdomain of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1980.1">educaproject.com</span></code><span class="koboSpan" id="kobo.1981.1"> is allowed to serve your application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1982.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1983.1">educa/settings/prod.py</span></code><span class="koboSpan" id="kobo.1984.1"> file and modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1985.1">ALLOWED_HOSTS</span></code><span class="koboSpan" id="kobo.1986.1"> setting, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1987.1">ALLOWED_HOSTS = [</span><span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1988.1">'</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1989.1">.educaproject.com'</span></strong></span><span class="koboSpan" id="kobo.1990.1">]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1991.1">A value that begins with a period is used as a subdomain wildcard; </span><code class="inlineCode"><span class="koboSpan" id="kobo.1992.1">'.educaproject.com'</span></code><span class="koboSpan" id="kobo.1993.1"> will match </span><code class="inlineCode"><span class="koboSpan" id="kobo.1994.1">educaproject.com</span></code><span class="koboSpan" id="kobo.1995.1"> and any subdomain for this domain, for example, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1996.1">course.educaproject.com</span></code><span class="koboSpan" id="kobo.1997.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1998.1">django.educaproject.com</span></code><span class="koboSpan" id="kobo.1999.1">.</span></p>
<h3 class="heading-3" id="_idParaDest-480"><span class="koboSpan" id="kobo.2000.1">Serving multiple subdomains with NGINX</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.2001.1">You need </span><a id="_idIndexMarker1667"/><span class="koboSpan" id="kobo.2002.1">NGINX to be able to serve your site </span><a id="_idIndexMarker1668"/><span class="koboSpan" id="kobo.2003.1">with any possible subdomain. </span><span class="koboSpan" id="kobo.2003.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2004.1">config/nginx/default.conf.template</span></code><span class="koboSpan" id="kobo.2005.1"> file at these two occurrences:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2006.1">server_name  www.educaproject.com educaproject.com;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2007.1">Replace the occurences of the preceding line with the following one:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2008.1">server_name  </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2009.1">*</span></strong></span><span class="koboSpan" id="kobo.2010.1">.educaproject.com educaproject.com;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2011.1">By using the asterisk, this rule applies to all subdomains of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2012.1">educaproject.com</span></code><span class="koboSpan" id="kobo.2013.1">. </span><span class="koboSpan" id="kobo.2013.2">In order to test your middleware locally, you need to add any subdomains you want to test to </span><code class="inlineCode"><span class="koboSpan" id="kobo.2014.1">/etc/hosts</span></code><span class="koboSpan" id="kobo.2015.1">. </span><span class="koboSpan" id="kobo.2015.2">For testing the middleware with a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2016.1">Course</span></code><span class="koboSpan" id="kobo.2017.1"> object with the slug </span><code class="inlineCode"><span class="koboSpan" id="kobo.2018.1">django</span></code><span class="koboSpan" id="kobo.2019.1">, add the following line to your </span><code class="inlineCode"><span class="koboSpan" id="kobo.2020.1">/etc/hosts</span></code><span class="koboSpan" id="kobo.2021.1"> file:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2022.1">127.0.0.1  django.educaproject.com
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2023.1">Stop the Docker application from the shell by pressing the </span><em class="italic"><span class="koboSpan" id="kobo.2024.1">Ctrl</span></em><span class="koboSpan" id="kobo.2025.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.2026.1">C</span></em><span class="koboSpan" id="kobo.2027.1"> keys or using the stop button in the Docker Desktop app. </span><span class="koboSpan" id="kobo.2027.2">Then, start Compose again with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2028.1">docker compose up
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2029.1">Then, open </span><code class="inlineCode"><span class="koboSpan" id="kobo.2030.1">https://django.educaproject.com/</span></code><span class="koboSpan" id="kobo.2031.1"> in your browser. </span><span class="koboSpan" id="kobo.2031.2">The middleware will find the course by the subdomain and redirect your browser to </span><code class="inlineCode"><span class="koboSpan" id="kobo.2032.1">https://educaproject.com/course/django/</span></code><span class="koboSpan" id="kobo.2033.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2034.1">Your </span><a id="_idIndexMarker1669"/><span class="koboSpan" id="kobo.2035.1">custom subdomain middleware is working!</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2036.1">Now, we will </span><a id="_idIndexMarker1670"/><span class="koboSpan" id="kobo.2037.1">delve into a final topic that is extremely useful for projects: automating tasks and making them available as commands.</span></p>
<h1 class="heading-1" id="_idParaDest-481"><span class="koboSpan" id="kobo.2038.1">Implementing custom management commands</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2039.1">Django allows your applications to register custom management commands for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2040.1">manage.py</span></code><span class="koboSpan" id="kobo.2041.1"> utility. </span><span class="koboSpan" id="kobo.2041.2">For example, you used the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2042.1">makemessages</span></code><span class="koboSpan" id="kobo.2043.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2044.1">compilemessages</span></code><span class="koboSpan" id="kobo.2045.1"> management commands in </span><em class="italic"><span class="koboSpan" id="kobo.2046.1">Chapter 11</span></em><span class="koboSpan" id="kobo.2047.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2048.1">Adding Internationalization to Your Shop</span></em><span class="koboSpan" id="kobo.2049.1">, to create and compile translation files.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2050.1">A management </span><a id="_idIndexMarker1671"/><span class="koboSpan" id="kobo.2051.1">command consists of a Python module containing a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2052.1">Command</span></code><span class="koboSpan" id="kobo.2053.1"> class that inherits from </span><code class="inlineCode"><span class="koboSpan" id="kobo.2054.1">django.core.management.base.BaseCommand</span></code><span class="koboSpan" id="kobo.2055.1"> or one of its subclasses. </span><span class="koboSpan" id="kobo.2055.2">You can create simple commands or make them take positional and optional arguments as input.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2056.1">Django looks for management commands in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2057.1">management/commands/</span></code><span class="koboSpan" id="kobo.2058.1"> directory for each active application in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2059.1">INSTALLED_APPS</span></code><span class="koboSpan" id="kobo.2060.1"> setting. </span><span class="koboSpan" id="kobo.2060.2">Each module found is registered as a management command named after it.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2061.1">You can </span><a id="_idIndexMarker1672"/><span class="koboSpan" id="kobo.2062.1">learn more about custom management commands at </span><a href="https://docs.djangoproject.com/en/5.0/howto/custom-management-commands/"><span class="url"><span class="koboSpan" id="kobo.2063.1">https://docs.djangoproject.com/en/5.0/howto/custom-management-commands/</span></span></a><span class="koboSpan" id="kobo.2064.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2065.1">You are going to create a custom management command to remind students to enroll in at least one course. </span><span class="koboSpan" id="kobo.2065.2">The command will send an email reminder to users who have been registered for longer than a specified period and who aren’t enrolled in any course yet.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2066.1">Create </span><a id="_idIndexMarker1673"/><span class="koboSpan" id="kobo.2067.1">the following file structure inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2068.1">students</span></code><span class="koboSpan" id="kobo.2069.1"> application directory:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2070.1">management/
    __init__.py
    commands/
        __init__.py
        enroll_reminder.py
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2071.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2072.1">enroll_reminder.py</span></code><span class="koboSpan" id="kobo.2073.1"> file and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2074.1">import</span></span><span class="koboSpan" id="kobo.2075.1"> datetime
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2076.1">from</span></span><span class="koboSpan" id="kobo.2077.1"> django.conf </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2078.1">import</span></span><span class="koboSpan" id="kobo.2079.1"> settings
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2080.1">from</span></span><span class="koboSpan" id="kobo.2081.1"> django.contrib.auth.models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2082.1">import</span></span><span class="koboSpan" id="kobo.2083.1"> User
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2084.1">from</span></span><span class="koboSpan" id="kobo.2085.1"> django.core.mail </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2086.1">import</span></span><span class="koboSpan" id="kobo.2087.1"> send_mass_mail
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2088.1">from</span></span><span class="koboSpan" id="kobo.2089.1"> django.core.management.base </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2090.1">import</span></span><span class="koboSpan" id="kobo.2091.1"> BaseCommand
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2092.1">from</span></span><span class="koboSpan" id="kobo.2093.1"> django.db.models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2094.1">import</span></span><span class="koboSpan" id="kobo.2095.1"> Count
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2096.1">from</span></span><span class="koboSpan" id="kobo.2097.1"> django.utils </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2098.1">import</span></span><span class="koboSpan" id="kobo.2099.1"> timezone
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2100.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2101.1">Command</span></span><span class="koboSpan" id="kobo.2102.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.2103.1">BaseCommand</span></span><span class="koboSpan" id="kobo.2104.1">):
    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2105.1">help</span></span><span class="koboSpan" id="kobo.2106.1"> = </span><span class="hljs-string"><span class="koboSpan" id="kobo.2107.1">'Sends an e-mail reminder to users registered more'</span></span><span class="koboSpan" id="kobo.2108.1"> \
           </span><span class="hljs-string"><span class="koboSpan" id="kobo.2109.1">'than N days that are not enrolled into any courses yet'</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2110.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2111.1">add_arguments</span></span><span class="koboSpan" id="kobo.2112.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2113.1">self, parser</span></span><span class="koboSpan" id="kobo.2114.1">):
        parser.add_argument(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2115.1">'--days'</span></span><span class="koboSpan" id="kobo.2116.1">, dest=</span><span class="hljs-string"><span class="koboSpan" id="kobo.2117.1">'days'</span></span><span class="koboSpan" id="kobo.2118.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2119.1">type</span></span><span class="koboSpan" id="kobo.2120.1">=</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2121.1">int</span></span><span class="koboSpan" id="kobo.2122.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2123.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2124.1">handle</span></span><span class="koboSpan" id="kobo.2125.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2126.1">self, *args, **options</span></span><span class="koboSpan" id="kobo.2127.1">):
        emails = []
        subject = </span><span class="hljs-string"><span class="koboSpan" id="kobo.2128.1">'Enroll in a course'</span></span><span class="koboSpan" id="kobo.2129.1">
        date_joined = timezone.now().today() - datetime.timedelta(
            days=options[</span><span class="hljs-string"><span class="koboSpan" id="kobo.2130.1">'days'</span></span><span class="koboSpan" id="kobo.2131.1">] </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2132.1">or</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.2133.1">0</span></span><span class="koboSpan" id="kobo.2134.1">
        )
        users = User.objects.annotate(
            course_count=Count(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2135.1">'courses_joined'</span></span><span class="koboSpan" id="kobo.2136.1">)
        ).</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2137.1">filter</span></span><span class="koboSpan" id="kobo.2138.1">(course_count=</span><span class="hljs-number"><span class="koboSpan" id="kobo.2139.1">0</span></span><span class="koboSpan" id="kobo.2140.1">, date_joined__date__lte=date_joined)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2141.1">for</span></span><span class="koboSpan" id="kobo.2142.1"> user </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2143.1">in</span></span><span class="koboSpan" id="kobo.2144.1"> users:
            message = </span><span class="hljs-string"><span class="koboSpan" id="kobo.2145.1">f"""Dear </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.2146.1">{user.first_name}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2147.1">,</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.2148.1">            We noticed that you didn't enroll in any courses yet.</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.2149.1">            What are you waiting for?"""</span></span><span class="koboSpan" id="kobo.2150.1">
            emails.append(
                (
                    subject,
                    message,
                    settings.DEFAULT_FROM_EMAIL,
                    [user.email]
                )
            )
        send_mass_mail(emails)
        self.stdout.write(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2151.1">f'Sent </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.2152.1">{</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2153.1">len</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.2154.1">(emails)}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2155.1"> reminders'</span></span><span class="koboSpan" id="kobo.2156.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2157.1">This is </span><a id="_idIndexMarker1674"/><span class="koboSpan" id="kobo.2158.1">your </span><code class="inlineCode"><span class="koboSpan" id="kobo.2159.1">enroll_reminder</span></code><span class="koboSpan" id="kobo.2160.1"> command. </span><span class="koboSpan" id="kobo.2160.2">The preceding code is as follows:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2161.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2162.1">Command</span></code><span class="koboSpan" id="kobo.2163.1"> class inherits from </span><code class="inlineCode"><span class="koboSpan" id="kobo.2164.1">BaseCommand</span></code><span class="koboSpan" id="kobo.2165.1">.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2166.1">You include a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2167.1">help</span></code><span class="koboSpan" id="kobo.2168.1"> attribute. </span><span class="koboSpan" id="kobo.2168.2">This attribute provides a short description of the command that is printed if you run the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2169.1">python manage.py help enroll_reminder</span></code><span class="koboSpan" id="kobo.2170.1"> command.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2171.1">You use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2172.1">add_arguments()</span></code><span class="koboSpan" id="kobo.2173.1"> method to add the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2174.1">--days</span></code><span class="koboSpan" id="kobo.2175.1"> named argument. </span><span class="koboSpan" id="kobo.2175.2">This argument is used to specify the minimum number of days a user has to be registered, without having enrolled in any course, in order to receive the reminder.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2176.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2177.1">handle()</span></code><span class="koboSpan" id="kobo.2178.1"> command contains the actual command. </span><span class="koboSpan" id="kobo.2178.2">You get the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2179.1">days</span></code><span class="koboSpan" id="kobo.2180.1"> attribute parsed from the command line. </span><span class="koboSpan" id="kobo.2180.2">If this is not set, you use </span><code class="inlineCode"><span class="koboSpan" id="kobo.2181.1">0</span></code><span class="koboSpan" id="kobo.2182.1">, so that a reminder is sent to all users that haven’t enrolled on a course, regardless of when they registered. </span><span class="koboSpan" id="kobo.2182.2">You use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2183.1">timezone</span></code><span class="koboSpan" id="kobo.2184.1"> utility provided by Django to retrieve the current timezone-aware date with </span><code class="inlineCode"><span class="koboSpan" id="kobo.2185.1">timezone.now().date()</span></code><span class="koboSpan" id="kobo.2186.1">. </span><span class="koboSpan" id="kobo.2186.2">(You can set the timezone for your project with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2187.1">TIME_ZONE</span></code><span class="koboSpan" id="kobo.2188.1"> setting.) You retrieve the users who have been registered for more than the specified days and are not enrolled in any courses yet. </span><span class="koboSpan" id="kobo.2188.2">You achieve this by annotating the QuerySet with the total number of courses each user is enrolled in. </span><span class="koboSpan" id="kobo.2188.3">You generate the reminder email for each user and append it to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2189.1">emails</span></code><span class="koboSpan" id="kobo.2190.1"> list. </span><span class="koboSpan" id="kobo.2190.2">Finally, you send the emails using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2191.1">send_mass_mail()</span></code><span class="koboSpan" id="kobo.2192.1"> function, which is optimized to open a single SMTP connection for sending all emails, instead of opening one connection per email sent.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.2193.1">You have created your first management command. </span><span class="koboSpan" id="kobo.2193.2">Open the shell and run your command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2194.1">docker compose exec web python /code/educa/manage.py \
  enroll_reminder --days=20 --settings=educa.settings.prod
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2195.1">If you don’t have a local SMTP server running, you can look at </span><em class="italic"><span class="koboSpan" id="kobo.2196.1">Chapter 2</span></em><span class="koboSpan" id="kobo.2197.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2198.1">Enhancing Your Blog with Advanced Features</span></em><span class="koboSpan" id="kobo.2199.1">, where you configured the SMTP settings for your first Django project. </span><span class="koboSpan" id="kobo.2199.2">Alternatively, you can add the following setting to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2200.1">base.py</span></code><span class="koboSpan" id="kobo.2201.1"> file to make </span><a id="_idIndexMarker1675"/><span class="koboSpan" id="kobo.2202.1">Django output emails to the standard output during development:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2203.1">EMAIL_BACKEND = </span><span class="hljs-string"><span class="koboSpan" id="kobo.2204.1">'django.core.mail.backends.console.EmailBackend'</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2205.1">Django also includes a utility to call management commands using Python. </span><span class="koboSpan" id="kobo.2205.2">You can run management commands from your code as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2206.1">from</span></span><span class="koboSpan" id="kobo.2207.1"> django.core </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2208.1">import</span></span><span class="koboSpan" id="kobo.2209.1"> management
management.call_command(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2210.1">'enroll_reminder'</span></span><span class="koboSpan" id="kobo.2211.1">, days=</span><span class="hljs-number"><span class="koboSpan" id="kobo.2212.1">20</span></span><span class="koboSpan" id="kobo.2213.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2214.1">Congratulations! </span><span class="koboSpan" id="kobo.2214.2">You can now create custom management commands for your applications.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2215.1">Django management commands can be scheduled to run automatically using tools like cron or Celery Beat. </span><span class="koboSpan" id="kobo.2215.2">Cron is a time-based job scheduler in Unix-like operating systems that enables users to schedule scripts or commands to run at specified times and intervals. </span><span class="koboSpan" id="kobo.2215.3">You </span><a id="_idIndexMarker1676"/><span class="koboSpan" id="kobo.2216.1">can read more about cron at </span><a href="https://en.wikipedia.org/wiki/Cron"><span class="url"><span class="koboSpan" id="kobo.2217.1">https://en.wikipedia.org/wiki/Cron</span></span></a><span class="koboSpan" id="kobo.2218.1">. </span><span class="koboSpan" id="kobo.2218.2">On the other hand, Celery Beat is a scheduler that works </span><a id="_idIndexMarker1677"/><span class="koboSpan" id="kobo.2219.1">with Celery to run functions at designated intervals. </span><span class="koboSpan" id="kobo.2219.2">You can learn more about Celery Beat at </span><a href="https://docs.celeryq.dev/en/stable/userguide/periodic-tasks.html"><span class="url"><span class="koboSpan" id="kobo.2220.1">https://docs.celeryq.dev/en/stable/userguide/periodic-tasks.html</span></span></a><span class="koboSpan" id="kobo.2221.1">. </span><span class="koboSpan" id="kobo.2221.2">By using either cron or Celery Beat, you can ensure your tasks are executed regularly without manual intervention.</span></p>
<h1 class="heading-1" id="_idParaDest-482"><span class="koboSpan" id="kobo.2222.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2223.1">In this chapter, you created a production environment using Docker Compose. </span><span class="koboSpan" id="kobo.2223.2">You configured NGINX, uWSGI, and Daphne to serve your application in production. </span><span class="koboSpan" id="kobo.2223.3">You secured your environment using SSL/TLS. </span><span class="koboSpan" id="kobo.2223.4">You also implemented custom middleware and you learned how to create custom management commands.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2224.1">You have reached the end of this book. </span><span class="koboSpan" id="kobo.2224.2">Congratulations! </span><span class="koboSpan" id="kobo.2224.3">You have learned the skills required to build successful web applications with Django. </span><span class="koboSpan" id="kobo.2224.4">This book has guided you through the process of developing real-life projects and integrating Django with other technologies. </span><span class="koboSpan" id="kobo.2224.5">Now, you are ready to create your own Django project, whether it is a simple prototype or a large-scale web application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2225.1">Good luck with your next Django adventure!</span></p>
<h1 class="heading-1" id="_idParaDest-483"><span class="koboSpan" id="kobo.2226.1">Expanding your project using AI</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2227.1">In this section, you are presented with a task to extend your project, accompanied by a sample prompt for ChatGPT to assist you. </span><span class="koboSpan" id="kobo.2227.2">To engage with ChatGPT, visit </span><a href="https://chat.openai.com/"><span class="url"><span class="koboSpan" id="kobo.2228.1">https://chat.openai.com/</span></span></a><span class="koboSpan" id="kobo.2229.1">. </span><span class="koboSpan" id="kobo.2229.2">If this is your first interaction with ChatGPT, you can revisit the </span><em class="italic"><span class="koboSpan" id="kobo.2230.1">Expanding your project using AI</span></em><span class="koboSpan" id="kobo.2231.1"> section in </span><em class="italic"><span class="koboSpan" id="kobo.2232.1">Chapter 3, Extending Your Blog Application</span></em><span class="koboSpan" id="kobo.2233.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2234.1">We have developed a comprehensive e-learning platform. </span><span class="koboSpan" id="kobo.2234.2">However, when students are enrolled in multiple courses, each containing several modules, it can be challenging for them to remember where they last left off. </span><span class="koboSpan" id="kobo.2234.3">To address this, let’s use ChatGPT in conjunction with Redis to store and retrieve each student’s progress within a course. </span><span class="koboSpan" id="kobo.2234.4">For guidance, refer to the prompt provided at </span><a href="https://github.com/PacktPublishing/Django-5-by-example/blob/main/Chapter17/prompts/task.md"><span class="url"><span class="koboSpan" id="kobo.2235.1">https://github.com/PacktPublishing/Django-5-by-example/blob/main/Chapter17/prompts/task.md</span></span></a><span class="koboSpan" id="kobo.2236.1">.</span></p>
<div class="packt_tip">
<p class="normal"><span class="koboSpan" id="kobo.2237.1"> When you’re refining your Python code, ChatGPT can help you explore different refactoring strategies. </span><span class="koboSpan" id="kobo.2237.2">Discuss your current approach, and ChatGPT can provide advice on making your code more Pythonic, utilizing principles like </span><strong class="keyWord"><span class="koboSpan" id="kobo.2238.1">don’t repeat yourself</span></strong><span class="koboSpan" id="kobo.2239.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.2240.1">DRY</span></strong><span class="koboSpan" id="kobo.2241.1">) and modular design for cleaner, more maintainable code.</span></p>
</div>
<h1 class="heading-1" id="_idParaDest-484"><span class="koboSpan" id="kobo.2242.1">Additional resources</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2243.1">The following resources provide additional information related to the topics covered in this chapter:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2244.1">Source code for this chapter: </span><a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter17"><span class="url"><span class="koboSpan" id="kobo.2245.1">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter17</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2246.1">Docker Compose overview: </span><a href="https://docs.docker.com/compose/"><span class="url"><span class="koboSpan" id="kobo.2247.1">https://docs.docker.com/compose/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2248.1">Installing Docker Compose: </span><a href="https://docs.docker.com/compose/install/compose-desktop/"><span class="url"><span class="koboSpan" id="kobo.2249.1">https://docs.docker.com/compose/install/compose-desktop/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2250.1">Official Python Docker image: </span><a href="https://hub.docker.com/_/python"><span class="url"><span class="koboSpan" id="kobo.2251.1">https://hub.docker.com/_/python</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2252.1">Dockerfile reference: </span><a href="https://docs.docker.com/reference/dockerfile/"><span class="url"><span class="koboSpan" id="kobo.2253.1">https://docs.docker.com/reference/dockerfile/</span></span></a></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2254.1">requirements.txt</span></code><span class="koboSpan" id="kobo.2255.1"> file for this chapter: </span><a href="https://github.com/PacktPublishing/Django-5-by-example/blob/main/Chapter17/requirements.txt"><span class="url"><span class="koboSpan" id="kobo.2256.1">https://github.com/PacktPublishing/Django-5-by-example/blob/main/Chapter17/requirements.txt</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2257.1">YAML file example: </span><a href="https://yaml.org/"><span class="url"><span class="koboSpan" id="kobo.2258.1">https://yaml.org/</span></span></a></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2259.1">Dockerfile build</span></code><span class="koboSpan" id="kobo.2260.1"> section: </span><a href="https://docs.docker.com/compose/compose-file/build/"><span class="url"><span class="koboSpan" id="kobo.2261.1">https://docs.docker.com/compose/compose-file/build/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2262.1">Docker restart policy: </span><a href="https://docs.docker.com/config/containers/start-containers-automatically/"><span class="url"><span class="koboSpan" id="kobo.2263.1">https://docs.docker.com/config/containers/start-containers-automatically/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2264.1">Docker volumes: </span><a href="https://docs.docker.com/storage/volumes/"><span class="url"><span class="koboSpan" id="kobo.2265.1">https://docs.docker.com/storage/volumes/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2266.1">Docker Compose specification: </span><a href="https://docs.docker.com/compose/compose-file/"><span class="url"><span class="koboSpan" id="kobo.2267.1">https://docs.docker.com/compose/compose-file/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2268.1">Official PostgreSQL Docker image: </span><a href="https://hub.docker.com/_/postgres"><span class="url"><span class="koboSpan" id="kobo.2269.1">https://hub.docker.com/_/postgres</span></span></a></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2270.1">wait-for-it.sh</span></code><span class="koboSpan" id="kobo.2271.1"> bash script for Docker: </span><a href="https://github.com/vishnubob/wait-for-it/blob/master/wait-for-it.sh"><span class="url"><span class="koboSpan" id="kobo.2272.1">https://github.com/vishnubob/wait-for-it/blob/master/wait-for-it.sh</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2273.1">Service startup order in Compose: </span><a href="https://docs.docker.com/compose/startup-order/"><span class="url"><span class="koboSpan" id="kobo.2274.1">https://docs.docker.com/compose/startup-order/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2275.1">Official Redis Docker image: </span><a href="https://hub.docker.com/_/redis"><span class="url"><span class="koboSpan" id="kobo.2276.1">https://hub.docker.com/_/redis</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2277.1">WSGI documentation: </span><a href="https://wsgi.readthedocs.io/en/latest/"><span class="url"><span class="koboSpan" id="kobo.2278.1">https://wsgi.readthedocs.io/en/latest/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2279.1">List of uWSGI options: </span><a href="https://uwsgi-docs.readthedocs.io/en/latest/Options.html"><span class="url"><span class="koboSpan" id="kobo.2280.1">https://uwsgi-docs.readthedocs.io/en/latest/Options.html</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2281.1">Official NGINX Docker image: </span><a href="https://hub.docker.com/_/nginx"><span class="url"><span class="koboSpan" id="kobo.2282.1">https://hub.docker.com/_/nginx</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2283.1">NGINX documentation: </span><a href="https://nginx.org/en/docs/"><span class="url"><span class="koboSpan" id="kobo.2284.1">https://nginx.org/en/docs/</span></span></a></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2285.1">ALLOWED_HOSTS</span></code><span class="koboSpan" id="kobo.2286.1"> setting: </span><a href="https://docs.djangoproject.com/en/5.0/ref/settings/#allowed-hosts"><span class="url"><span class="koboSpan" id="kobo.2287.1">https://docs.djangoproject.com/en/5.0/ref/settings/#allowed-hosts</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2288.1">Django’s system check framework: </span><a href="https://docs.djangoproject.com/en/5.0/topics/checks/"><span class="url"><span class="koboSpan" id="kobo.2289.1">https://docs.djangoproject.com/en/5.0/topics/checks/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2290.1">HTTP Strict Transport Security policy with Django: </span><a href="https://docs.djangoproject.com/en/5.0/ref/middleware/#http-strict-transport-security"><span class="url"><span class="koboSpan" id="kobo.2291.1">https://docs.djangoproject.com/en/5.0/ref/middleware/#http-strict-transport-security</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2292.1">Django deployment checklist: </span><a href="https://docs.djangoproject.com/en/5.0/howto/deployment/checklist/"><span class="url"><span class="koboSpan" id="kobo.2293.1">https://docs.djangoproject.com/en/5.0/howto/deployment/checklist/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2294.1">Self-generated SSL/TLS certificate directory: </span><a href="https://github.com/PacktPublishing/Django-5-by-example/blob/main/Chapter17/educa/ssl/"><span class="url"><span class="koboSpan" id="kobo.2295.1">https://github.com/PacktPublishing/Django-5-by-example/blob/main/Chapter17/educa/ssl/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2296.1">Let’s Encrypt Certificate Authority: </span><a href="https://letsencrypt.org/"><span class="url"><span class="koboSpan" id="kobo.2297.1">https://letsencrypt.org/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2298.1">Using Docker Compose in production: </span><a href="https://docs.docker.com/compose/production/"><span class="url"><span class="koboSpan" id="kobo.2299.1">https://docs.docker.com/compose/production/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2300.1">Docker Swarm mode: </span><a href="https://docs.docker.com/engine/swarm/ "><span class="url"><span class="koboSpan" id="kobo.2301.1">https://docs.docker.com/engine/swarm/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2302.1">Kubernetes: </span><a href="https://kubernetes.io/docs/home/"><span class="url"><span class="koboSpan" id="kobo.2303.1">https://kubernetes.io/docs/home/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2304.1">Django middleware: </span><a href="https://docs.djangoproject.com/en/5.0/topics/http/middleware/"><span class="url"><span class="koboSpan" id="kobo.2305.1">https://docs.djangoproject.com/en/5.0/topics/http/middleware/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2306.1">Creating custom management commands: </span><a href="https://docs.djangoproject.com/en/5.0/howto/custom-management-commands/"><span class="url"><span class="koboSpan" id="kobo.2307.1">https://docs.djangoproject.com/en/5.0/howto/custom-management-commands/</span></span></a></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2308.1">cron</span></code><span class="koboSpan" id="kobo.2309.1">: </span><a href="https://en.wikipedia.org/wiki/Cron"><span class="url"><span class="koboSpan" id="kobo.2310.1">https://en.wikipedia.org/wiki/Cron</span></span></a><span class="koboSpan" id="kobo.2311.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2312.1">celery beat</span></code><span class="koboSpan" id="kobo.2313.1">: </span><a href="https://docs.celeryq.dev/en/stable/userguide/periodic-tasks.html"><span class="url"><span class="koboSpan" id="kobo.2314.1">https://docs.celeryq.dev/en/stable/userguide/periodic-tasks.html</span></span></a></li>
</ul>
<h1 class="heading-1" id="_idParaDest-485"><span class="koboSpan" id="kobo.2315.1">Join us on Discord!</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2316.1">Read this book alongside other users, Django development experts, and the author himself. </span><span class="koboSpan" id="kobo.2316.2">Ask questions, provide solutions to other readers, chat with the author via Ask Me Anything sessions, and much more.Scan the QR code or visit the link to join the community.</span></p>
<p class="normal"><a href="https://packt.link/Django5ByExample"><span class="url"><span class="koboSpan" id="kobo.2317.1">https://packt.link/Django5ByExample</span></span></a></p>
<p class="normal"><span class="koboSpan" id="kobo.2318.1"><img alt="" role="presentation" src="../Images/QR_Code287089408934129031.png"/></span></p>
</div>
</body></html>