<html><head></head><body>
<div><h1 class="chapterNumber">2</h1>
<h1 class="chapterTitle" id="_idParaDest-81">Enhancing Your Blog and Adding Social Features</h1>
<p class="normal">In the preceding chapter, we learned the main components of Django by developing a simple blog application using views, templates, and URLs. In this chapter, we will extend the functionalities of the blog application with features that can be found in many blogging platforms nowadays.</p>
<p class="normal">In this chapter, you will learn the following topics:</p>
<ul>
<li class="bulletList">Using canonical URLs for models</li>
<li class="bulletList">Creating SEO-friendly URLs for posts</li>
<li class="bulletList">Adding pagination to the post list view</li>
<li class="bulletList">Building class-based views</li>
<li class="bulletList">Sending emails with Django</li>
<li class="bulletList">Using Django forms to share posts via email</li>
<li class="bulletList">Adding comments to posts using forms from models</li>
</ul>
<h1 class="heading-1" id="_idParaDest-82">Functional overview</h1>
<p class="normal"><em class="italic">Figure 2.1</em> shows a representation <a id="_idIndexMarker165"/>of the views, templates, and functionalities that will be built in this chapter:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_01.png"/></figure>
<p class="packt_figref">Figure 2.1: Diagram of functionalities built in Chapter 2</p>
<p class="normal">In this chapter, we will add pagination to the post list page to navigate through all posts. We will also learn <a id="_idIndexMarker166"/>how to build class-based views with Django and convert the <code class="inlineCode">post_list</code> view to a class-based view named <code class="inlineCode">PostListView</code>.</p>
<p class="normal">We will create the <code class="inlineCode">post_share</code> view to share posts via email. We will use Django forms to share <a id="_idIndexMarker167"/>posts and send email recommendations via <strong class="keyWord">Simple Mail Transfer Protocol</strong> (<strong class="keyWord">SMTP</strong>). To add comments to posts, we will create a <code class="inlineCode">Comment</code> model to store comments, and we will build the <code class="inlineCode">post_comment</code> view using forms for models.</p>
<p class="normal">The source code for this chapter can be found at <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter02">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter02</a>.</p>
<p class="normal">All Python packages used in this chapter are included in the <code class="inlineCode">requirements.txt</code> file in the source code for the chapter. You can follow the instructions to install each Python package in the following sections, or you can install all the requirements at once with the <code class="inlineCode">python -m pip install -r requirements.txt</code> command.</p>
<h1 class="heading-1" id="_idParaDest-83">Using canonical URLs for models</h1>
<p class="normal">A website might have different pages that display the same content. In our application, the initial <a id="_idIndexMarker168"/>part of the content for each post is displayed both on the post list page and the post detail page. A canonical URL is the preferred URL for a resource. You can think of it as the URL of the most representative page for specific content. There might be different pages on your site that display posts, but there is a single URL that you use as the main URL for a post. </p>
<p class="normal">Canonical URLs allow you to specify the URL for the master copy of a page. Django allows you to implement the <code class="inlineCode">get_absolute_url()</code> method in your models to return the canonical URL for the object.</p>
<p class="normal">We will use the <code class="inlineCode">post_detail</code> URL defined in the URL patterns of the application to build the canonical URL for <code class="inlineCode">Post</code> objects. Django provides different URL resolver functions that allow you to build URLs dynamically using their name and any required parameters. We will use the <code class="inlineCode">reverse()</code> utility function of the <code class="inlineCode">django.urls</code> module.</p>
<p class="normal">Edit the <code class="inlineCode">models.py</code> file of the <code class="inlineCode">blog</code> application to import the <code class="inlineCode">reverse()</code> function and add the <code class="inlineCode">get_absolute_url()</code> method to the <code class="inlineCode">Post</code> model as follows. The new code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django.conf import settings
from django.db import models
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.urls </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> reverse</strong>
from django.utils import timezone
class PublishedManager(models.Manager):
    def get_queryset(self):
        return (
            super().get_queryset().filter(status=Post.Status.PUBLISHED)
        )
class Post(models.Model):
    # ...
class Meta:
        ordering = ['-publish']
        indexes = [
            models.Index(fields=['-publish']),
        ]
    def __str__(self):
        return self.title
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">get_absolute_url</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> reverse(</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'blog:post_detail'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">            args=[self.</strong><strong class="hljs-built_in-slc">id</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">    )</strong>
</code></pre>
<p class="normal">The <code class="inlineCode">reverse()</code> function will build the URL dynamically using the URL name defined in the URL patterns. We have used the <code class="inlineCode">blog</code> namespace followed by a colon and the <code class="inlineCode">post_detail</code> URL name. Remember that the <code class="inlineCode">blog</code> namespace is defined in the main <code class="inlineCode">urls.py</code> file of the project when including the URL patterns from <code class="inlineCode">blog.urls</code>. The <code class="inlineCode">post_detail</code> URL is defined in the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">blog</code> application. </p>
<p class="normal">The resulting string, <code class="inlineCode">blog:post_detail</code>, can be used globally in your project to refer to the post detail URL. This URL <a id="_idIndexMarker169"/>has a required parameter, which is the <code class="inlineCode">id</code> of the blog post to retrieve. We have included the <code class="inlineCode">id</code> of the <code class="inlineCode">Post</code> object as a positional argument by using <code class="inlineCode">args=[self.id]</code>.</p>
<p class="normal">You can learn more about the URL’s utility functions at <a href="https://docs.djangoproject.com/en/5.0/ref/urlresolvers/">https://docs.djangoproject.com/en/5.0/ref/urlresolvers/</a>.</p>
<p class="normal">Let’s replace the post detail URLs in the templates with the new <code class="inlineCode">get_absolute_url()</code> method.</p>
<p class="normal">Edit the <code class="inlineCode">blog/post/list.html</code> file and replace the following line:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;a href="{% url 'blog:post_detail' post.id %}"&gt;
</code></pre>
<p class="normal">Replace the preceding line with the following line:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;a href="{<strong class="hljs-string-slc">{ post.get_absolute_url }</strong>}"&gt;
</code></pre>
<p class="normal">The <code class="inlineCode">blog/post/list.html</code> file should now look as follows:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "blog/base.html" %}
{% block title %}My Blog{% endblock %}
{% block content %}
  &lt;h1&gt;My Blog&lt;/h1&gt;
  {% for post in posts %}
    &lt;h2&gt;
&lt;a href="{{ post.get_absolute_url }}"&gt;
        {{ post.title }}
      &lt;/a&gt;
&lt;/h2&gt;
&lt;p class="date"&gt;
      Published {{ post.publish }} by {{ post.author }}
    &lt;/p&gt;
    {{ post.body|truncatewords:30|linebreaks }}
  {% endfor %}
{% endblock %}
</code></pre>
<p class="normal">Open the <a id="_idIndexMarker170"/>shell prompt and execute the following command to start the development server:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/blog/</code> in your browser. Links to individual blog posts should still work. Django now builds the post URLs using the <code class="inlineCode">get_absolute_url()</code> method of the <code class="inlineCode">Post</code> model.</p>
<h1 class="heading-1" id="_idParaDest-84">Creating SEO-friendly URLs for posts</h1>
<p class="normal">The canonical URL for a blog post detail view currently looks like <code class="inlineCode">/blog/1/</code>. We will change the <a id="_idIndexMarker171"/>URL pattern to create SEO-friendly URLs for posts. We will be using both the <code class="inlineCode">publish</code> date and <code class="inlineCode">slug</code> values to build the URLs for single posts. By combining dates, we will make a post detail URL to look like <code class="inlineCode">/blog/2024/1/1/who-was-django-reinhardt/</code>. We will provide search engines with friendly URLs to index, containing both the title and date of the post.</p>
<p class="normal">To retrieve single posts with the combination of publication date and slug, we need to ensure that no post can be stored in the database with the same <code class="inlineCode">slug</code> and <code class="inlineCode">publish</code> date as an existing post. We will prevent the <code class="inlineCode">Post</code> model from storing duplicated posts by defining slugs to be unique for the publication date of the post.</p>
<p class="normal">Edit the <code class="inlineCode">models.py</code> file and add the following <code class="inlineCode">unique_for_date</code> parameter to the <code class="inlineCode">slug</code> field of the <code class="inlineCode">Post</code> model:</p>
<pre class="programlisting code"><code class="hljs-code">class Post(models.Model):
    # ...
    slug = models.SlugField(
        max_length=250,
<strong class="hljs-slc">        unique_for_date=</strong><strong class="hljs-string-slc">'publish'</strong>
    )
    # ...
</code></pre>
<p class="normal">By using <code class="inlineCode">unique_for_date</code>, the <code class="inlineCode">slug</code> field is now required to be unique for the date stored in the <code class="inlineCode">publish</code> field. Note that the <code class="inlineCode">publish</code> field is an instance of <code class="inlineCode">DateTimeField</code>, but the check for unique values will be done only against the date (not the time). Django will prevent you from saving a new post with the same slug as an existing post for a given publication date. We have now ensured that slugs are unique for the publication date, so we can now retrieve single posts by the <code class="inlineCode">publish</code> and <code class="inlineCode">slug</code> fields.</p>
<p class="normal">We have <a id="_idIndexMarker172"/>changed our models, so, let’s create migrations. Note that <code class="inlineCode">unique_for_date</code> is not enforced at the database level, so no database migration is required. However, Django uses migrations to keep track of all model changes. We will create a migration just to keep migrations aligned with the current state of the model.</p>
<p class="normal">Run the following command in the shell prompt:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py makemigrations blog
</code></pre>
<p class="normal">You should get the following output:</p>
<pre class="programlisting con"><code class="hljs-con">Migrations for 'blog':
    blog/migrations/0002_alter_post_slug.py
    - Alter field slug on post
</code></pre>
<p class="normal">Django just created the <code class="inlineCode">0002_alter_post_slug.py</code> file inside the <code class="inlineCode">migrations</code> directory of the <code class="inlineCode">blog</code> application.</p>
<p class="normal">Execute the following command in the shell prompt to apply existing migrations:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py migrate
</code></pre>
<p class="normal">You will get an output that ends with the following line:</p>
<pre class="programlisting con"><code class="hljs-con">Applying blog.0002_alter_post_slug... OK
</code></pre>
<p class="normal">Django will consider that all migrations have been applied and the models are in sync. No action will be done in the database because <code class="inlineCode">unique_for_date</code> is not enforced at the database level.</p>
<h2 class="heading-2" id="_idParaDest-85">Modifying the URL patterns</h2>
<p class="normal">Let’s modify <a id="_idIndexMarker173"/>the URL patterns to use the publication date and slug for the post detail URL.</p>
<p class="normal">Edit the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">blog</code> application and replace the following line:</p>
<pre class="programlisting code"><code class="hljs-code">path('&lt;int:id&gt;/', views.post_detail, name='post_detail'),
</code></pre>
<p class="normal">Replace the preceding line with the following lines:</p>
<pre class="programlisting code"><code class="hljs-code">path(
    '<strong class="hljs-string-slc">&lt;int:year&gt;/&lt;int:month&gt;/&lt;int:day&gt;/&lt;slug:post&gt;/</strong>',
    views.post_detail,
    name='post_detail'
),
</code></pre>
<p class="normal">The <code class="inlineCode">urls.py</code> file should now look like this:</p>
<pre class="programlisting code"><code class="hljs-code">from django.urls import path
from . import views
app_name = 'blog'
urlpatterns = [
    # Post views
    path('', views.post_list, name='post_list'),
    path(
        '<strong class="hljs-string-slc">&lt;int:year&gt;/&lt;int:month&gt;/&lt;int:day&gt;/&lt;slug:post&gt;/</strong>',
         views.post_detail,
         name='post_detail'
    ),
]
</code></pre>
<p class="normal">The URL pattern for the <code class="inlineCode">post_detail</code> view takes the following arguments:</p>
<ul>
<li class="bulletList"><code class="inlineCode">year</code>: This requires an integer</li>
<li class="bulletList"><code class="inlineCode">month</code>: This requires an integer</li>
<li class="bulletList"><code class="inlineCode">day</code>: This requires an integer</li>
<li class="bulletList"><code class="inlineCode">post</code>: This requires a slug (a string that contains only letters, numbers, underscores, or hyphens)</li>
</ul>
<p class="normal">The <code class="inlineCode">int</code> path converter is used for the <code class="inlineCode">year</code>, <code class="inlineCode">month</code>, and <code class="inlineCode">day</code> parameters, whereas the <code class="inlineCode">slug</code> path converter <a id="_idIndexMarker174"/>is used for the <code class="inlineCode">post</code> parameter. You learned about path converters in the previous chapter. You can see all path converters provided by Django at <a href="https://docs.djangoproject.com/en/5.0/topics/http/urls/#path-converters">https://docs.djangoproject.com/en/5.0/topics/http/urls/#path-converters</a>.</p>
<p class="normal">Our posts have now an SEO-friendly URL that is built with the date and slug of each post. Let’s modify the <code class="inlineCode">post_detail</code> view accordingly.</p>
<h2 class="heading-2" id="_idParaDest-86">Modifying the views</h2>
<p class="normal">We will change the parameters of the <code class="inlineCode">post_detail</code> view to match the new URL parameters <a id="_idIndexMarker175"/>and use them to retrieve the corresponding <code class="inlineCode">Post</code> object.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file and edit the <code class="inlineCode">post_detail</code> view like this:</p>
<pre class="programlisting code"><code class="hljs-code">def post_detail(request, <strong class="hljs-params-slc">year, month, day, post</strong>):
    post = get_object_or_404(
        Post,
        status=Post.Status.PUBLISHED<strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        slug=post,</strong>
<strong class="hljs-slc">        publish__year=year,</strong>
<strong class="hljs-slc">        publish__month=month,</strong>
<strong class="hljs-slc">        publish__day=day)</strong>
return render(
        request,
        'blog/post/detail.html',
        {'post': post}
    )
</code></pre>
<p class="normal">We have modified the <code class="inlineCode">post_detail</code> view to take the <code class="inlineCode">year</code>, <code class="inlineCode">month</code>, <code class="inlineCode">day</code>, and <code class="inlineCode">post</code> arguments and retrieve a published post with the given slug and publication date. By adding <code class="inlineCode">unique_for_date='publish'</code> to the <code class="inlineCode">slug</code> field of the <code class="inlineCode">Post</code> model, we ensured that there would be only one post with a slug for a given date. Thus, you can retrieve single posts using the date and slug.</p>
<h2 class="heading-2" id="_idParaDest-87">Modifying the canonical URL for posts</h2>
<p class="normal">We also <a id="_idIndexMarker176"/>have to modify the parameters of the canonical URL for blog posts to match the new URL parameters.</p>
<p class="normal">Edit the <code class="inlineCode">models.py</code> file of the <code class="inlineCode">blog</code> application and edit the <code class="inlineCode">get_absolute_url()</code> method as follows:</p>
<pre class="programlisting code"><code class="hljs-code">class Post(models.Model):
    # ...
def get_absolute_url(self):
        return reverse(
            'blog:post_detail',
            args=[
                <strong class="hljs-slc">self.publish.year,</strong>
<strong class="hljs-slc">                self.publish.month,</strong>
<strong class="hljs-slc">                self.publish.day,</strong>
<strong class="hljs-slc">                self.slug</strong>
            ]
        )
</code></pre>
<p class="normal">Start the development server by typing the following command in the shell prompt:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Next, you can return to your browser and click on one of the post titles to take a look at the detail view of the post. You should see something like this:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_02.png"/></figure>
<p class="packt_figref">Figure 2.2: The page for the post’s detail view</p>
<p class="normal">You have designed SEO-friendly URLs for the blog posts. The URL for a post now looks like <code class="inlineCode">/blog/2024/1/1/who-was-django-reinhardt/</code>.</p>
<p class="normal">Now that <a id="_idIndexMarker177"/>you have implemented SEO-friendly URLs, let’s focus on implementing navigation through posts using pagination.</p>
<h1 class="heading-1" id="_idParaDest-88">Adding pagination</h1>
<p class="normal">When you start adding content to your blog, you can easily store tens or hundreds of posts in your <a id="_idIndexMarker178"/>database. Instead of displaying all the posts on a single page, you may want to split the list of posts across several pages and include navigation links to the different pages. This functionality is called pagination, and you can find it in almost every web application that displays long lists of items.</p>
<p class="normal">For example, Google uses pagination to divide search results across multiple pages. <em class="italic">Figure 2.3</em> shows Google’s pagination links for search result pages:</p>
<figure class="mediaobject"><img alt="Icon  Description automatically generated" src="img/B21088_02_03.png"/></figure>
<p class="packt_figref">Figure 2.3: Google pagination links for search result pages</p>
<p class="normal">Django has a built-in pagination class that allows you to manage paginated data easily. You can define the number of objects you want to be returned per page and you can retrieve the posts that correspond to the page requested by the user.</p>
<h2 class="heading-2" id="_idParaDest-89">Adding pagination to the post list view</h2>
<p class="normal">We will <a id="_idIndexMarker179"/>add pagination to the list of posts so that users can easily navigate through all posts published on the blog.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">blog</code> application to import the Django <code class="inlineCode">Paginator</code> class and modify the <code class="inlineCode">post_list</code> view as follows:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.core.paginator </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> Paginator</strong>
from django.shortcuts import get_object_or_404, render
from .models import Post
def post_list(request):
    <strong class="hljs-slc">post_list</strong> = Post.published.all()
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># Pagination with 3 posts per page</strong>
<strong class="hljs-slc">    paginator = Paginator(post_list, </strong><strong class="hljs-number-slc">3</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    page_number = request.GET.get(</strong><strong class="hljs-string-slc">'page'</strong><strong class="hljs-slc">, </strong><strong class="hljs-number-slc">1</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    posts = paginator.page(page_number)</strong>
return render(
        request,
        'blog/post/list.html',
        {'posts': posts}
    )
</code></pre>
<p class="normal">Let’s <a id="_idIndexMarker180"/>review the new code we have added to the view:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">We instantiate the <code class="inlineCode">Paginator</code> class with the number of objects to return per page. We will display three posts per page.</li>
<li class="numberedList">We retrieve the <code class="inlineCode">page</code> <code class="inlineCode">GET</code> HTTP parameter and store it in the <code class="inlineCode">page_number</code> variable. This parameter contains the requested page number. If the <code class="inlineCode">page</code> parameter is not in the <code class="inlineCode">GET</code> parameters of the request, we use the default value <code class="inlineCode">1</code> to load the first page of results.</li>
<li class="numberedList">We obtain the objects for the desired page by calling the <code class="inlineCode">page()</code> method of <code class="inlineCode">Paginator</code>. This method returns a <code class="inlineCode">Page</code> object that we store in the <code class="inlineCode">posts</code> variable.</li>
<li class="numberedList">We pass the <code class="inlineCode">posts</code> object to the template.</li>
</ol>
<h2 class="heading-2" id="_idParaDest-90">Creating a pagination template</h2>
<p class="normal">We need <a id="_idIndexMarker181"/>to create a page navigation for users to browse through the different pages. In this section, we will create a template to display the pagination links, and we’ll make it generic so that we can reuse the template for any object pagination on our website.</p>
<p class="normal">In the <code class="inlineCode">templates/</code> directory, create a new file and name it <code class="inlineCode">pagination.html</code>. Add the following HTML code to the file:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;div class="pagination"&gt;
&lt;span class="step-links"&gt;
    {% if page.has_previous %}
      &lt;a href="?page={{ page.previous_page_number }}"&gt;Previous&lt;/a&gt;
    {% endif %}
    &lt;span class="current"&gt;
      Page {{ page.number }} of {{ page.paginator.num_pages }}.
    &lt;/span&gt;
    {% if page.has_next %}
      &lt;a href="?page={{ page.next_page_number }}"&gt;Next&lt;/a&gt;
    {% endif %}
  &lt;/span&gt;
&lt;/div&gt;
</code></pre>
<p class="normal">This is the <a id="_idIndexMarker182"/>generic pagination template. The template expects to have a <code class="inlineCode">Page</code> object in the context to render the previous and next links and to display the current page and total pages of results.</p>
<p class="normal">Let’s return to the <code class="inlineCode">blog/post/list.html</code> template and include the <code class="inlineCode">pagination.html</code> template at the bottom of the <code class="inlineCode">{% content %}</code> block, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "blog/base.html" %}
{% block title %}My Blog{% endblock %}
{% block content %}
  &lt;h1&gt;My Blog&lt;/h1&gt;
  {% for post in posts %}
    &lt;h2&gt;
&lt;a href="{{ post.get_absolute_url }}"&gt;
        {{ post.title }}
      &lt;/a&gt;
&lt;/h2&gt;
&lt;p class="date"&gt;
      Published {{ post.publish }} by {{ post.author }}
    &lt;/p&gt;
    {{ post.body|truncatewords:30|linebreaks }}
  {% endfor %}
  <strong class="hljs-slc">{% include "pagination.html" with page=posts %}</strong>
{% endblock %}
</code></pre>
<p class="normal">The <code class="inlineCode">{% include %}</code> template tag loads the given template and renders it using the current template context. We use <code class="inlineCode">with</code> to pass additional context variables to the template. The pagination template uses the <code class="inlineCode">page</code> variable to render, while the <code class="inlineCode">Page</code> object that we <a id="_idIndexMarker183"/>pass from our view to the template is called <code class="inlineCode">posts</code>. We use <code class="inlineCode">with page=posts</code> to pass the variable expected by the pagination template. You can follow this method to use the pagination template for any type of object.</p>
<p class="normal">Start the development server by typing the following command in the shell prompt:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/admin/blog/post/</code> in your browser and use the administration site to create a total of four different posts. Make sure to set the status to <strong class="screenText">Published</strong><strong class="keyWord"> </strong>for all of them.</p>
<p class="normal">Now, open <code class="inlineCode">http://127.0.0.1:8000/blog/</code> in your browser. You should see the first three posts in reverse chronological order, and then the navigation links at the bottom of the post list like this:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_04.png"/></figure>
<p class="packt_figref">Figure 2.4: The post list page including pagination</p>
<p class="normal">If you <a id="_idIndexMarker184"/>click on <strong class="screenText">Next</strong>, you will see the last post. The URL for the second page contains the <code class="inlineCode">?page=2</code> <code class="inlineCode">GET</code> parameter. This parameter is used by the view to load the requested page of results using the paginator.</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_05.png"/></figure>
<p class="packt_figref">Figure 2.5: The second page of results</p>
<p class="normal">Great! The pagination <a id="_idIndexMarker185"/>links are working as expected.</p>
<h2 class="heading-2" id="_idParaDest-91">Handling pagination errors</h2>
<p class="normal">Now that the pagination is working, we can add exception handling for pagination errors in the view. The <code class="inlineCode">page</code> parameter used by the view to retrieve the given page could potentially <a id="_idIndexMarker186"/>be used with wrong values, such as non-existing page numbers or a string value that cannot be used as a page number. We will implement appropriate error handling for those cases.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/blog/?page=3</code> in your browser. You should see the following error page:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_06.png"/></figure>
<p class="packt_figref">Figure 2.6: The EmptyPage error page</p>
<p class="normal">The <code class="inlineCode">Paginator</code> object throws an <code class="inlineCode">EmptyPage</code> exception when retrieving page <code class="inlineCode">3</code> because it’s out of range. There are no results to display. Let’s handle this error in our view.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">blog</code> application to add the necessary imports and modify the <code class="inlineCode">post_list</code> view as follows:</p>
<pre class="programlisting code"><code class="hljs-code">from django.core.paginator import <strong class="hljs-slc">EmptyPage,</strong> Paginator
from django.shortcuts import get_object_or_404, render
from .models import Post
def post_list(request):
    post_list = Post.published.all()
    # Pagination with 3 posts per page
    paginator = Paginator(post_list, 3)
    page_number = request.GET.get('page', 1)
    <strong class="hljs-keyword-slc">try</strong><strong class="hljs-slc">:</strong>
        posts = paginator.page(page_number)
    <strong class="hljs-keyword-slc">except</strong><strong class="hljs-slc"> EmptyPage:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># If page_number is out of range get last page of results</strong>
<strong class="hljs-slc">        posts = paginator.page(paginator.num_pages)</strong>
return render(
        request,
        'blog/post/list.html',
        {'posts': posts}
    )
</code></pre>
<p class="normal">We have added <a id="_idIndexMarker187"/>a try and except block to manage the <code class="inlineCode">EmptyPage</code> exception when retrieving a page. If the page requested is out of range, we return the last page of results. We get the total number of pages with <code class="inlineCode">paginator.num_pages</code>. The total number of pages is the same as the last page number.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/blog/?page=3</code> in your browser again. Now, the exception is managed by the view, and the last page of results is returned as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_07.png"/></figure>
<p class="packt_figref">Figure 2.7: The last page of results</p>
<p class="normal">Our view <a id="_idIndexMarker188"/>should also handle the case when something different than an integer is passed in the <code class="inlineCode">page</code> parameter.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/blog/?page=asdf</code> in your browser. You should see the following error page:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_08.png"/></figure>
<p class="packt_figref">Figure 2.8: The PageNotAnInteger error page</p>
<p class="normal">In this case, the <code class="inlineCode">Paginator</code> object throws a <code class="inlineCode">PageNotAnInteger</code> exception when retrieving the page <code class="inlineCode">asdf</code> because page numbers can only be integers. Let’s handle this error in our view.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">blog</code> application to add the necessary imports and modify the <code class="inlineCode">post_list</code> view as follows:</p>
<pre class="programlisting code"><code class="hljs-code">from django.shortcuts import get_object_or_404, render
from .models import Post
from django.core.paginator import EmptyPage<strong class="hljs-slc">, PageNotAnInteger</strong>, Paginator
def post_list(request):
    post_list = Post.published.all()
    # Pagination with 3 posts per page
    paginator = Paginator(post_list, 3)
    page_number = request.GET.get('page')
    try:
        posts = paginator.page(page_number)
    <strong class="hljs-keyword-slc">except</strong><strong class="hljs-slc"> PageNotAnInteger:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># If page_number is not an integer get the first page</strong>
<strong class="hljs-slc">        posts = paginator.page(</strong><strong class="hljs-number-slc">1</strong><strong class="hljs-slc">)</strong>
except EmptyPage:
        # If page_number is out of range get last page of results
        posts = paginator.page(paginator.num_pages)
    return render(
        request,
        'blog/post/list.html',
        {'posts': posts}
    )
</code></pre>
<p class="normal">We have <a id="_idIndexMarker189"/>added a new <code class="inlineCode">except</code> block to manage the <code class="inlineCode">PageNotAnInteger</code> exception when retrieving a page. If the page requested is not an integer, we return the first page of results.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/blog/?page=asdf</code> in your browser again. Now, the exception is managed by the view and the first page of results is returned as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_09.png"/></figure>
<p class="packt_figref">Figure 2.9: The first page of results</p>
<p class="normal">The pagination <a id="_idIndexMarker190"/>for blog posts is now fully implemented.</p>
<p class="normal">You can <a id="_idIndexMarker191"/>learn more about the <code class="inlineCode">Paginator</code> class at <a href="https://docs.djangoproject.com/en/5.0/ref/paginator/">https://docs.djangoproject.com/en/5.0/ref/paginator/</a>.</p>
<p class="normal">Having learned how to paginate your blog, we will now turn to transforming the <code class="inlineCode">post_list</code> view into an equivalent view that is built using Django generic views and built-in pagination.</p>
<h1 class="heading-1" id="_idParaDest-92">Building class-based views</h1>
<p class="normal">We have built the blog application using function-based views. Function-based views are simple and powerful, but Django also allows you to build views using classes.</p>
<p class="normal">Class-based <a id="_idIndexMarker192"/>views are an alternative way to implement views as Python objects instead of functions. Since a view is a function that takes a web request and returns a web response, you can also define your views as class methods. Django provides base view classes that you can use to implement your own views. All of them inherit from the <code class="inlineCode">View</code> class, which handles HTTP method dispatching and other common functionalities.</p>
<h2 class="heading-2" id="_idParaDest-93">Why use class-based views</h2>
<p class="normal">Class-based <a id="_idIndexMarker193"/>views offer some advantages over function-based views that are useful for specific use cases. Class-based views allow you to:</p>
<ul>
<li class="bulletList">Organize code related to HTTP methods, such as <code class="inlineCode">GET</code>, <code class="inlineCode">POST</code>, or <code class="inlineCode">PUT</code>, in separate methods, instead of using conditional branching</li>
<li class="bulletList">Use multiple inheritance to create reusable view classes (also known as <em class="italic">mixins</em>)</li>
</ul>
<h2 class="heading-2" id="_idParaDest-94">Using a class-based view to list posts</h2>
<p class="normal">To understand how to write class-based views, we will create a new class-based view that is <a id="_idIndexMarker194"/>equivalent to the <code class="inlineCode">post_list</code> view. We will create a class that will inherit from the generic <code class="inlineCode">ListView</code> view offered by Django. <code class="inlineCode">ListView</code> allows you to list any type of object.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">blog</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.views.generic import ListView
class PostListView(ListView):
    """
    Alternative post list view
    """
    queryset = Post.published.all()
    context_object_name = 'posts'
    paginate_by = 3
    template_name = 'blog/post/list.html'
</code></pre>
<p class="normal">The <code class="inlineCode">PostListView</code> view is analogous to the <code class="inlineCode">post_list</code> view we built previously. We have implemented a class-based view that inherits from the <code class="inlineCode">ListView</code> class. We have defined a view with the following attributes:</p>
<ul>
<li class="bulletList">We use <code class="inlineCode">queryset</code> to use a custom QuerySet instead of retrieving all objects. Instead of defining a <code class="inlineCode">queryset</code> attribute, we could have specified <code class="inlineCode">model = Post</code> and Django would have built the generic <code class="inlineCode">Post.objects.all()</code> QuerySet for us.</li>
<li class="bulletList">We use the context variable <code class="inlineCode">posts</code> for the query results. The default variable is <code class="inlineCode">object_list</code> if you don’t specify any <code class="inlineCode">context_object_name</code>.</li>
<li class="bulletList">We define the pagination of results with <code class="inlineCode">paginate_by</code>, returning three objects per page.</li>
<li class="bulletList">We use a custom template to render the page with <code class="inlineCode">template_name</code>. If you don’t set a default template, <code class="inlineCode">ListView</code> will use <code class="inlineCode">blog/post_list.html</code> by default.</li>
</ul>
<p class="normal">Now, edit <a id="_idIndexMarker195"/>the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">blog</code> application, comment the preceding <code class="inlineCode">post_list</code> URL pattern, and add a new URL pattern using the <code class="inlineCode">PostListView</code> class, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    # Post views
<strong class="hljs-comment-slc">#</strong> path('', views.post_list, name='post_list'),
<strong class="hljs-slc">path(</strong><strong class="hljs-string-slc">''</strong><strong class="hljs-slc">, views.PostListView.as_view(), name=</strong><strong class="hljs-string-slc">'post_list'</strong><strong class="hljs-slc">),</strong>
    path(
        '&lt;int:year&gt;/&lt;int:month&gt;/&lt;int:day&gt;/&lt;slug:post&gt;/',
        views.post_detail,
        name='post_detail'
    ),
]
</code></pre>
<p class="normal">In order to keep pagination working, we have to use the right page object that is passed to the template. Django’s <code class="inlineCode">ListView</code> generic view passes the page requested in a variable called <code class="inlineCode">page_obj</code>. We have to edit the <code class="inlineCode">post/list.html</code> template accordingly to include the paginator using the right variable, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "blog/base.html" %}
{% block title %}My Blog{% endblock %}
{% block content %}
  &lt;h1&gt;My Blog&lt;/h1&gt;
  {% for post in posts %}
    &lt;h2&gt;
&lt;a href="{{ post.get_absolute_url }}"&gt;
        {{ post.title }}
      &lt;/a&gt;
&lt;/h2&gt;
&lt;p class="date"&gt;
      Published {{ post.publish }} by {{ post.author }}
    &lt;/p&gt;
    {{ post.body|truncatewords:30|linebreaks }}
  {% endfor %}
  <strong class="hljs-slc">{% include "pagination.html" with page=page_obj %}</strong>
{% endblock %}
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/blog/</code> in your browser and verify that the pagination links work <a id="_idIndexMarker196"/>as expected. The behavior of the pagination links should be the same as with the previous <code class="inlineCode">post_list</code> view.</p>
<p class="normal">The exception handling in this case is a bit different. If you try to load a page out of range or pass a non-integer value in the <code class="inlineCode">page</code> parameter, the view will return an HTTP response with the status code <code class="inlineCode">404</code> (page not found) like this:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_10.png"/></figure>
<p class="packt_figref">Figure 2.10: HTTP 404 Page not found response</p>
<p class="normal">The exception handling that returns the HTTP <code class="inlineCode">404</code> status code is provided by the <code class="inlineCode">ListView</code> view.</p>
<p class="normal">This is a <a id="_idIndexMarker197"/>simple example of how to write class-based views. You will learn more about class-based views in <em class="italic">Chapter 13</em>, <em class="italic">Creating a Content Management System</em>, and successive chapters.</p>
<p class="normal">You can read an introduction to class-based views at <a href="https://docs.djangoproject.com/en/5.0/topics/class-based-views/intro/">https://docs.djangoproject.com/en/5.0/topics/class-based-views/intro/</a>.</p>
<p class="normal">After learning how to use class-based views and using built-in object pagination, we will implement the functionality for sharing posts by email to engage your blog readers.</p>
<h1 class="heading-1" id="_idParaDest-95">Recommending posts by email</h1>
<p class="normal">We will <a id="_idIndexMarker198"/>allow users to share blog posts with others by sending post recommendations via email. You will learn how to create forms in Django, handle data submission, and send emails with Django, enhancing your blog with a personal touch.</p>
<p class="normal">Take a minute to think about how you could use <em class="italic">views</em>, <em class="italic">URLs</em>, and <em class="italic">templates</em> to create this functionality using what you learned in the preceding chapter.</p>
<p class="normal">To allow users to share posts via email, we will need to:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">Create a form for users to fill in their name, their email address, the recipient’s email address, and optional comments</li>
<li class="numberedList">Create a view in the <code class="inlineCode">views.py</code> file that handles the posted data and sends the email</li>
<li class="numberedList">Add a URL pattern for the new view in the <code class="inlineCode">urls.py</code> file of the blog application</li>
<li class="numberedList">Create a template to display the form</li>
</ol>
<h2 class="heading-2" id="_idParaDest-96">Creating forms with Django</h2>
<p class="normal">Let’s start by building the form to share posts. Django has a built-in forms framework that allows <a id="_idIndexMarker199"/>you to create forms easily. The forms framework makes it simple to define the fields of the form, specify how they have to be displayed, and indicate how they have to validate input data. The Django forms framework offers a flexible way to render forms in HTML and handle data.</p>
<p class="normal">Django comes with two base classes to build forms:</p>
<ul>
<li class="bulletList"><code class="inlineCode">Form</code>: This allows you to build standard forms by defining fields and validations.</li>
<li class="bulletList"><code class="inlineCode">ModelForm</code>: This allows you to build forms tied to model instances. It provides all the functionalities of the base <code class="inlineCode">Form</code> class, but form fields can be explicitly declared, or automatically generated, from model fields. The form can be used to create or edit model instances.</li>
</ul>
<p class="normal">First, create a <code class="inlineCode">forms.py</code> file inside the directory of your <code class="inlineCode">blog</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django import forms
class EmailPostForm(forms.Form):
    name = forms.CharField(max_length=25)
    email = forms.EmailField()
    to = forms.EmailField()
    comments = forms.CharField(
        required=False,
        widget=forms.Textarea
    )
</code></pre>
<p class="normal">We have defined our first Django form. The <code class="inlineCode">EmailPostForm</code> form inherits from the base <code class="inlineCode">Form</code> class. We use different field types to validate data accordingly.</p>
<div><p class="normal">Forms can reside anywhere in your Django project. The convention is to place them inside a <code class="inlineCode">forms.py</code> file for each application.</p>
</div>
<p class="normal">The form contains the following fields:</p>
<ul>
<li class="bulletList"><code class="inlineCode">name</code>: An instance of <code class="inlineCode">CharField</code> with a maximum length of <code class="inlineCode">25</code> characters. We will use it for the name of the person sending the post.</li>
<li class="bulletList"><code class="inlineCode">email</code>: An instance of <code class="inlineCode">EmailField</code>. We will use the email of the person sending the post recommendation.</li>
<li class="bulletList"><code class="inlineCode">to</code>: An instance of <code class="inlineCode">EmailField</code>. We will use the email address of the recipient, who will receive an email recommending the post.</li>
<li class="bulletList"><code class="inlineCode">comments</code>: An instance of <code class="inlineCode">CharField</code>. We will use it for comments to include in the post recommendation email. We have made this field optional by setting <code class="inlineCode">required</code> to <code class="inlineCode">False</code>, and we have specified a custom widget to render the field.</li>
</ul>
<p class="normal">Each field <a id="_idIndexMarker200"/>type has a default widget that determines how the field is rendered in HTML. The <code class="inlineCode">name</code> field is an instance of <code class="inlineCode">CharField</code>. This type of field is rendered as an <code class="inlineCode">&lt;input type="text"&gt;</code> HTML element. The default widget can be overridden with the <code class="inlineCode">widget</code> attribute. In the <code class="inlineCode">comments</code> field, we use the <code class="inlineCode">Textarea</code> widget to display it as a <code class="inlineCode">&lt;textarea&gt;</code> HTML element instead of the default <code class="inlineCode">&lt;input&gt;</code> element.</p>
<p class="normal">Field validation also depends on the field type. For example, the <code class="inlineCode">email</code> and <code class="inlineCode">to</code> fields are <code class="inlineCode">EmailField</code> fields. Both fields require a valid email address; the field validation will otherwise raise a <code class="inlineCode">forms.ValidationError</code> exception and the form will not validate. Other parameters are also taken into account for the form field validation, such as the <code class="inlineCode">name</code> field having a maximum length of <code class="inlineCode">25</code> or the <code class="inlineCode">comments</code> field being optional.</p>
<p class="normal">These are only some of the field types that Django provides for forms. You can find a list of all field types available at <a href="https://docs.djangoproject.com/en/5.0/ref/forms/fields/">https://docs.djangoproject.com/en/5.0/ref/forms/fields/</a>.</p>
<h2 class="heading-2" id="_idParaDest-97">Handling forms in views</h2>
<p class="normal">We have <a id="_idIndexMarker201"/>defined the form to recommend posts via email. Now, we need a view to create an instance of the form and handle the form submission.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">blog</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from .forms import EmailPostForm
def post_share(request, post_id):
    # Retrieve post by id
    post = get_object_or_404(
        Post,
        id=post_id,
        status=Post.Status.PUBLISHED
    )
    if request.method == 'POST':
        # Form was submitted
        form = EmailPostForm(request.POST)
        if form.is_valid():
            # Form fields passed validation
            cd = form.cleaned_data
            # ... send email
else:
        form = EmailPostForm()
    return render(
 request,
        'blog/post/share.html',
        {
            'post': post,
            'form': form
        }
    )
</code></pre>
<p class="normal">We have defined the <code class="inlineCode">post_share</code> view that takes the <code class="inlineCode">request</code> object and the <code class="inlineCode">post_id</code> variable as parameters. We use the <code class="inlineCode">get_object_or_404()</code> shortcut to retrieve a published post by its <code class="inlineCode">id</code>.</p>
<p class="normal">We use <a id="_idIndexMarker202"/>the same view both for displaying the initial form and processing the submitted data. The HTTP <code class="inlineCode">request</code> method allows us to differentiate whether the form is being submitted. A <code class="inlineCode">GET</code> request will indicate that an empty form has to be displayed to the user and a <code class="inlineCode">POST</code> request will indicate the form is being submitted. We use <code class="inlineCode">request.method == 'POST'</code> to differentiate between the two scenarios.</p>
<p class="normal">This is the process to display the form and handle the form submission:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">When the page is loaded for the first time, the view receives a <code class="inlineCode">GET</code> request. In this case, a new <code class="inlineCode">EmailPostForm</code> instance is created and stored in the <code class="inlineCode">form</code> variable. This form instance will be used to display the empty form in the template:
        <pre class="programlisting code"><code class="hljs-code">form = EmailPostForm()
</code></pre>
</li>
<li class="numberedList">When the user fills in the form and submits it via <code class="inlineCode">POST</code>, a form instance is created using the submitted data contained in <code class="inlineCode">request.POST</code>:
        <pre class="programlisting code"><code class="hljs-code">if request.method == 'POST':
    # Form was submitted
    form = EmailPostForm(request.POST)
</code></pre>
</li>
<li class="numberedList">After this, the data submitted is validated using the form’s <code class="inlineCode">is_valid()</code> method. This method validates the data introduced in the form and returns <code class="inlineCode">True</code> if all fields contain valid data. If any field contains invalid data, then <code class="inlineCode">is_valid()</code> returns <code class="inlineCode">False</code>. The list of validation errors can be obtained with <code class="inlineCode">form.errors</code>.</li>
<li class="numberedList">If the form is not valid, the form is rendered in the template again, including the data submitted. Validation errors will be displayed in the template.</li>
<li class="numberedList">If the <a id="_idIndexMarker203"/>form is valid, the validated data is retrieved with <code class="inlineCode">form.cleaned_data</code>. This attribute is a dictionary of form fields and their values. Forms not only validate the data but also <em class="italic">clean</em> the data by normalizing it to a consistent format.</li>
</ol>
<div><p class="normal">If your form data does not validate, <code class="inlineCode">cleaned_data</code> will contain only the valid fields.</p>
</div>
<p class="normal">We have implemented the view to display the form and handle the form submission. We will now learn how to send emails using Django and then we will add that functionality to the <code class="inlineCode">post_share</code> view.</p>
<h2 class="heading-2" id="_idParaDest-98">Sending emails with Django</h2>
<p class="normal">Sending <a id="_idIndexMarker204"/>emails with Django is very straightforward. You need to have a local SMTP server, or you need to access an external SMTP server, like your email service provider.</p>
<p class="normal">The following settings allow you to define the SMTP configuration to send emails with Django:</p>
<ul>
<li class="bulletList"><code class="inlineCode">EMAIL_HOST</code>: The SMTP server host; the default is <code class="inlineCode">localhost</code></li>
<li class="bulletList"><code class="inlineCode">EMAIL_PORT</code>: The SMTP port; the default is <code class="inlineCode">25</code></li>
<li class="bulletList"><code class="inlineCode">EMAIL_HOST_USER</code>: The username for the SMTP server</li>
<li class="bulletList"><code class="inlineCode">EMAIL_HOST_PASSWORD</code>: The password for the SMTP server</li>
<li class="bulletList"><code class="inlineCode">EMAIL_USE_TLS</code>: Whether <a id="_idIndexMarker205"/>to use a <strong class="keyWord">Transport Layer Security</strong> (<strong class="keyWord">TLS</strong>) secure connection</li>
<li class="bulletList"><code class="inlineCode">EMAIL_USE_SSL</code>: Whether to use an implicit TLS secure connection</li>
</ul>
<p class="normal">Additionally, you <a id="_idIndexMarker206"/>can use the <code class="inlineCode">DEFAULT_FROM_EMAIL</code> setting to specify the default sender when sending emails with Django. For this example, we will use Google’s SMTP server with a standard Gmail account.</p>
<h2 class="heading-2" id="_idParaDest-99">Working with environment variables</h2>
<p class="normal">We will add SMTP configuration settings to the project, and we will load the SMTP credentials <a id="_idIndexMarker207"/>from environment variables. By using environment variables, we will avoid embedding credentials in the source code. There are multiple reasons to keep configuration separate from the code:</p>
<ul>
<li class="bulletList"><strong class="keyWord">Security</strong>: Credentials or secret keys in the code can lead to unintentional exposure, especially if you push the code to public repositories.</li>
<li class="bulletList"><strong class="keyWord">Flexibility</strong>: Keeping the configuration separate will allow you to use the same code base across different environments without any changes. You will learn how to build multiple environments in <em class="chapterRef">Chapter 17</em>, <em class="italic">Going Live</em>.</li>
<li class="bulletList"><strong class="keyWord">Maintainability</strong>: Changing a configuration won’t require a code change, ensuring that your project remains consistent across versions.</li>
</ul>
<p class="normal">To facilitate the separation of configuration from code, we are going to use <code class="inlineCode">python-decouple</code>. This library simplifies the use of environment variables in your projects. You can find information about <code class="inlineCode">python-decouple</code> at <a href="https://github.com/HBNetwork/python-decouple">https://github.com/HBNetwork/python-decouple</a>.</p>
<p class="normal">First, install <code class="inlineCode">python-decouple</code> via <code class="inlineCode">pip</code> by running the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install python-decouple==3.8
</code></pre>
<p class="normal">Then, create a new file inside your project’s root directory and name it <code class="inlineCode">.env</code>. The <code class="inlineCode">.env</code> file will contain key-value pairs of environment variables. Add the following lines to the new file:</p>
<pre class="programlisting code"><code class="hljs-code">EMAIL_HOST_USER=your_account@gmail.com
EMAIL_HOST_PASSWORD=
DEFAULT_FROM_EMAIL=My Blog &lt;your_account@gmail.com&gt;
</code></pre>
<p class="normal">If you have a Gmail account, replace <code class="inlineCode">your_account@gmail.com</code> with your Gmail account. The <code class="inlineCode">EMAIL_HOST_PASSWORD</code> variable has no value yet, we will add it later. The <code class="inlineCode">DEFAULT_FROM_EMAIL</code> variable will be used to specify the default sender for our emails. If you don’t have a Gmail account, you can use the SMTP credentials for your email service provider.</p>
<p class="normal">If you <a id="_idIndexMarker208"/>are using a <code class="inlineCode">git</code> repository for your code, make sure to include <code class="inlineCode">.env</code> in the <code class="inlineCode">.gitignore</code> file of your repository. By doing so, you ensure that credentials are excluded from the repository.</p>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of your project and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> decouple </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> config</strong>
# ...
<strong class="hljs-comment-slc"># Email server configuration</strong>
<strong class="hljs-slc">EMAIL_HOST = </strong><strong class="hljs-string-slc">'smtp.gmail.com'</strong>
<strong class="hljs-slc">EMAIL_HOST_USER = config(</strong><strong class="hljs-string-slc">'EMAIL_HOST_USER'</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">EMAIL_HOST_PASSWORD = config(</strong><strong class="hljs-string-slc">'EMAIL_HOST_PASSWORD'</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">EMAIL_PORT = </strong><strong class="hljs-number-slc">587</strong>
<strong class="hljs-slc">EMAIL_USE_TLS = </strong><strong class="hljs-literal-slc">True</strong>
<strong class="hljs-slc">DEFAULT_FROM_EMAIL = config(</strong><strong class="hljs-string-slc">'DEFAULT_FROM_EMAIL'</strong><strong class="hljs-slc">)</strong>
</code></pre>
<p class="normal">The <code class="inlineCode">EMAIL_HOST_USER</code>, <code class="inlineCode">EMAIL_HOST_PASSWORD</code> and <code class="inlineCode">DEFAULT_FROM_EMAIL</code> settings are now loaded from environment variables defined in the <code class="inlineCode">.env</code> file.</p>
<p class="normal">The provided <code class="inlineCode">EMAIL_HOST</code>, <code class="inlineCode">EMAIL_PORT</code> and <code class="inlineCode">EMAIL_USE_TLS</code> settings are for Gmail’s SMTP server. If you don’t have a Gmail account, you can use the SMTP server configuration of your email service provider.</p>
<p class="normal">Instead of Gmail, you can also use a professional, scalable email service that allows you to send emails via SMTP using your own domain, such as SendGrid (<a href="https://sendgrid.com/">https://sendgrid.com/</a>) or Amazon <strong class="keyWord">Simple Email Service</strong> (<strong class="keyWord">SES</strong>) (<a href="https://aws.amazon.com/ses/">https://aws.amazon.com/ses/</a>). Both services will require you to verify your domain and sender email accounts and will provide you with SMTP credentials to send emails. The <code class="inlineCode">django-anymail</code> application simplifies the task of adding email service providers to your project like SendGrid or Amazon SES. You can find installation instructions for <code class="inlineCode">django-anymail</code> at <a href="https://anymail.dev/en/stable/installation/">https://anymail.dev/en/stable/installation/</a>, and the list of supported email service providers at <a href="https://anymail.dev/en/stable/esps/">https://anymail.dev/en/stable/esps/</a>.</p>
<p class="normal">If you can’t use an SMTP server, you can tell Django to write emails to the console by adding the following setting to the <code class="inlineCode">settings.py</code> file:</p>
<pre class="programlisting code"><code class="hljs-code">EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'
</code></pre>
<p class="normal">By using <a id="_idIndexMarker209"/>this setting, Django will output all emails to the shell instead of sending them. This is very useful for testing your application without an SMTP server.</p>
<p class="normal">In order to send emails with Gmail’s SMTP server, make sure that two-step verification is active in your Gmail account. </p>
<p class="normal">Open <a href="https://myaccount.google.com/security">https://myaccount.google.com/security</a> in your browser and enable <strong class="screenText">2-Step Verification</strong> for your account, as shown in <em class="italic">Figure 2.11</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_11.png"/></figure>
<p class="packt_figref">Figure 2.11: The sign in to Google page for Google accounts</p>
<p class="normal">Then, you need to create an app password and use it for your SMTP credentials. An app password is a 16-digit passcode that gives a <em class="italic">less secure</em> app or device permission to access your Google account.</p>
<p class="normal">To create an app password, open <a href="https://myaccount.google.com/apppasswords">https://myaccount.google.com/apppasswords</a> in your browser. You will see the following screen:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_12.png"/></figure>
<p class="packt_figref">Figure 2.12: Form to generate a new Google app password</p>
<p class="normal">If you cannot access <strong class="screenText">App passwords</strong>, it might be that 2-Step Verification is not set for your account, your account is an organization account instead of a standard Gmail account, or you turned on Google’s advanced protection. Make sure to use a standard Gmail <a id="_idIndexMarker210"/>account and activate 2-Step Verification for your Google account. You can find more information at <a href="https://support.google.com/accounts/answer/185833">https://support.google.com/accounts/answer/185833</a>.</p>
<p class="normal">Enter the name <code class="inlineCode">Blog</code> and click the <strong class="screenText">Create</strong> button, as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_13.png"/></figure>
<p class="packt_figref">Figure 2.13: Form to generate a new Google app password</p>
<p class="normal">A new password will be generated and displayed like this:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_14.png"/></figure>
<p class="packt_figref">Figure 2.14: Generated Google app password</p>
<p class="normal">Copy <a id="_idIndexMarker211"/>the generated app password.</p>
<p class="normal">Next, edit the <code class="inlineCode">.env</code> file of your project and add the app password to the <code class="inlineCode">EMAIL_HOST_PASSWORD</code> variable, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">EMAIL_HOST_USER=your_account@gmail.com
EMAIL_HOST_PASSWORD=<strong class="hljs-slc">xxxxxxxxxxxxxxxx</strong>
DEFAULT_FROM_EMAIL=My Blog &lt;your_account@gmail.com&gt;
</code></pre>
<p class="normal">Open the Python shell by running the following command in the system shell prompt:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py shell
</code></pre>
<p class="normal">Execute the following code in the Python shell:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; from django.core.mail import send_mail
&gt;&gt;&gt; send_mail('Django mail',
... 'This e-mail was sent with Django.',
... 'your_account@gmail.com',
...           ['your_account@gmail.com'],
...           fail_silently=False)
</code></pre>
<p class="normal">The <code class="inlineCode">send_mail()</code> function takes the subject, message, sender, and list of recipients as required arguments. By setting the optional argument <code class="inlineCode">fail_silently=False</code>, we are telling it to raise an exception if the email cannot be sent. If the output you see is <code class="inlineCode">1</code>, then your email was successfully sent.</p>
<p class="normal">If you get a <code class="inlineCode">CERTIFICATE_VERIFY_FAILED</code> error, install the <code class="inlineCode">certify</code> module with the command <code class="inlineCode">pip install --upgrade certifi</code>. If you are using macOS, run the following command on the shell to install <code class="inlineCode">certify</code> and let Python access macOS root certificates:</p>
<pre class="programlisting con"><code class="hljs-con">/Applications/Python\ 3.12/Install\ Certificates.command
</code></pre>
<p class="normal">Check <a id="_idIndexMarker212"/>your inbox. You should have received the email as displayed in <em class="italic">Figure 2.15</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_15.png"/></figure>
<p class="packt_figref">Figure 2.15: Test email sent displayed in Gmail</p>
<p class="normal">You just sent your first email with Django! You can find more information about sending emails with Django at <a href="https://docs.djangoproject.com/en/5.0/topics/email/">https://docs.djangoproject.com/en/5.0/topics/email/</a>.</p>
<p class="normal">Let’s add this functionality to the <code class="inlineCode">post_share</code> view.</p>
<h2 class="heading-2" id="_idParaDest-100">Sending emails in views</h2>
<p class="normal">Edit <a id="_idIndexMarker213"/>the <code class="inlineCode">post_share</code> view in the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">blog</code> application, as follows:</p>
<pre class="programlisting code"><code class="hljs-code"># ...
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.core.mail </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> send_mail</strong>
# ...
def post_share(request, post_id):
    # Retrieve post by id
    post = get_object_or_404(
        Post,
        id=post_id,
        status=Post.Status.PUBLISHED
    )
    <strong class="hljs-slc">sent = </strong><strong class="hljs-literal-slc">False</strong>
if request.method == 'POST':
        # Form was submitted
        form = EmailPostForm(request.POST)
        if form.is_valid():
            # Form fields passed validation
            cd = form.cleaned_data
            <strong class="hljs-slc">post_url = request.build_absolute_uri(</strong>
<strong class="hljs-slc">                post.get_absolute_url()</strong>
<strong class="hljs-slc">            )</strong>
<strong class="hljs-slc">            subject = (</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">f"</strong><strong class="hljs-subst-slc">{cd[</strong><strong class="hljs-string-slc">'name'</strong><strong class="hljs-subst-slc">]}</strong><strong class="hljs-string-slc"> (</strong><strong class="hljs-subst-slc">{cd[</strong><strong class="hljs-string-slc">'email'</strong><strong class="hljs-subst-slc">]}</strong><strong class="hljs-string-slc">) "</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">f"recommends you read </strong><strong class="hljs-subst-slc">{post.title}</strong><strong class="hljs-string-slc">"</strong>
<strong class="hljs-slc">            )</strong>
<strong class="hljs-slc">            message = (</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">f"Read </strong><strong class="hljs-subst-slc">{post.title}</strong><strong class="hljs-string-slc"> at </strong><strong class="hljs-subst-slc">{post_url}</strong><strong class="hljs-string-slc">\n\n"</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">f"</strong><strong class="hljs-subst-slc">{cd[</strong><strong class="hljs-string-slc">'name'</strong><strong class="hljs-subst-slc">]}</strong><strong class="hljs-string-slc">\'s comments: </strong><strong class="hljs-subst-slc">{cd[</strong><strong class="hljs-string-slc">'comments'</strong><strong class="hljs-subst-slc">]}</strong><strong class="hljs-string-slc">"</strong>
<strong class="hljs-slc">            )</strong>
<strong class="hljs-slc">            send_mail(</strong>
<strong class="hljs-slc">                subject=subject,</strong>
<strong class="hljs-slc">                message=message,</strong>
<strong class="hljs-slc">                from_email=</strong><strong class="hljs-literal-slc">None</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">                recipient_list=[cd[</strong><strong class="hljs-string-slc">'to'</strong><strong class="hljs-slc">]]</strong>
<strong class="hljs-slc">            )</strong>
<strong class="hljs-slc">            sent = </strong><strong class="hljs-literal-slc">True</strong>
else:
        form = EmailPostForm()
    return render(
        request,
        'blog/post/share.html',
        {
            'post': post,
            'form': form<strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'sent'</strong><strong class="hljs-slc">: sent</strong>
        }
    )
</code></pre>
<p class="normal">In the preceding code, we have declared a <code class="inlineCode">sent</code> variable with the initial <code class="inlineCode">False</code> value. We set this variable to <code class="inlineCode">True</code> after the email is sent. We will use the <code class="inlineCode">sent</code> variable later in the template to display a success message when the form is successfully submitted.</p>
<p class="normal">Since we have to include a link to the post in the email, we retrieve the absolute path of the post using its <code class="inlineCode">get_absolute_url()</code> method. We use this path as an input for <code class="inlineCode">request.build_absolute_uri()</code> to build a complete URL, including the HTTP schema and hostname.</p>
<p class="normal">We create <a id="_idIndexMarker214"/>the subject and the message body of the email using the cleaned data of the validated form. Finally, we send the email to the email address contained in the <code class="inlineCode">to</code> field of the form. In the <code class="inlineCode">from_email</code> parameter, we pass the <code class="inlineCode">None</code> value, so the value of the <code class="inlineCode">DEFAULT_FROM_EMAIL</code> setting will be used for the sender.</p>
<p class="normal">Now that the view is complete, we have to add a new URL pattern for it.</p>
<p class="normal">Open the <code class="inlineCode">urls.py</code> file of your <code class="inlineCode">blog</code> application and add the <code class="inlineCode">post_share</code> URL pattern, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">from django.urls import path
from . import views
app_name = 'blog'
urlpatterns = [
    # Post views
# path('', views.post_list, name='post_list'),
    path('', views.PostListView.as_view(), name='post_list'),
    path(
        '&lt;int:year&gt;/&lt;int:month&gt;/&lt;int:day&gt;/&lt;slug:post&gt;/',
        views.post_detail,
        name='post_detail'),
    <strong class="hljs-slc">path(</strong><strong class="hljs-string-slc">'&lt;int:post_id&gt;/share/'</strong><strong class="hljs-slc">, views.post_share, name=</strong><strong class="hljs-string-slc">'post_share'</strong><strong class="hljs-slc">),</strong>
]
</code></pre>
<h2 class="heading-2" id="_idParaDest-101">Rendering forms in templates</h2>
<p class="normal">After creating the form, programming the view, and adding the URL pattern, the only thing <a id="_idIndexMarker215"/>missing is the template for the view.</p>
<p class="normal">Create a new file in the <code class="inlineCode">blog/templates/blog/post/</code> directory and name it <code class="inlineCode">share.html</code>.</p>
<p class="normal">Add the following code to the new <code class="inlineCode">share.html</code> template:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "blog/base.html" %}
{% block title %}Share a post{% endblock %}
{% block content %}
  {% if sent %}
    &lt;h1&gt;E-mail successfully sent&lt;/h1&gt;
&lt;p&gt;
      "{{ post.title }}" was successfully sent to {{ form.cleaned_data.to }}.
    &lt;/p&gt;
  {% else %}
    &lt;h1&gt;Share "{{ post.title }}" by e-mail&lt;/h1&gt;
&lt;form method="post"&gt;
      {{ form.as_p }}
      {% csrf_token %}
      &lt;input type="submit" value="Send e-mail"&gt;
&lt;/form&gt;
  {% endif %}
{% endblock %}
</code></pre>
<p class="normal">This is the template that is used to both display the form to share a post via email and to display a success message when the email has been sent. We differentiate between both cases with <code class="inlineCode">{% if sent %}</code>.</p>
<p class="normal">To display the form, we have defined an HTML form element, indicating that it has to be submitted by the <code class="inlineCode">POST</code> method:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;form method="post"&gt;
</code></pre>
<p class="normal">We have included the form instance with <code class="inlineCode">{{ form.as_p }}</code>. We tell Django to render the form fields using HTML paragraph <code class="inlineCode">&lt;p&gt;</code> elements by using the <code class="inlineCode">as_p</code> method. We could also render the form as an unordered list with <code class="inlineCode">as_ul</code> or as an HTML table with <code class="inlineCode">as_table</code>.</p>
<p class="normal">We have added a <code class="inlineCode">{% csrf_token %}</code> template tag. This tag introduces a hidden field with an <a id="_idIndexMarker216"/>autogenerated token to avoid <strong class="keyWord">cross-site request forgery</strong> (<strong class="keyWord">CSRF</strong>) attacks. These attacks consist of a malicious website or program performing an unwanted action for a user on the site. You can find more information about CSRF at <a href="https://owasp.org/www-community/attacks/csrf">https://owasp.org/www-community/attacks/csrf</a>.</p>
<p class="normal">The <code class="inlineCode">{% csrf_token %}</code> template tag generates a hidden field that is rendered like this:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;input type='hidden' name='csrfmiddlewaretoken' value='26JjKo2lcEtYkGoV9z4XmJIEHLXN5LDR' /&gt;
</code></pre>
<div><p class="normal">By default, Django checks for the CSRF token in all <code class="inlineCode">POST</code> requests. Remember to include the <code class="inlineCode">csrf_token</code> tag in all forms that are submitted via <code class="inlineCode">POST</code>.</p>
</div>
<p class="normal">Edit <a id="_idIndexMarker217"/>the <code class="inlineCode">blog/post/detail.html</code> template and make it look like this:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "blog/base.html" %}
{% block title %}{{ post.title }}{% endblock %}
{% block content %}
  &lt;h1&gt;{{ post.title }}&lt;/h1&gt;
&lt;p class="date"&gt;
    Published {{ post.publish }} by {{ post.author }}
  &lt;/p&gt;
  {{ post.body|linebreaks }}
  <strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">p</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-slc"> </strong><strong class="hljs-attr-slc">href</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"{% url "blog:post_share" post.id %}"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">Share this post</strong>
<strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">p</strong><strong class="hljs-tag-slc">&gt;</strong>
{% endblock %}
</code></pre>
<p class="normal">We have added a link to the <code class="inlineCode">post_share</code> URL. The URL is built dynamically with the <code class="inlineCode">{% url %}</code> template tag provided by Django. We use the namespace called <code class="inlineCode">blog</code> and the URL named <code class="inlineCode">post_share</code>. We pass the <code class="inlineCode">id</code> post as a parameter to build the URL.</p>
<p class="normal">Open the shell prompt and execute the following command to start the development server:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/blog/</code> in your browser and click on any post title to view the post detail page.</p>
<p class="normal">Under <a id="_idIndexMarker218"/>the post body, you should see the link that you just added, as shown in <em class="italic">Figure 2.16</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_16.png"/></figure>
<p class="packt_figref">Figure 2.16: The post detail page, including a link to share the post</p>
<p class="normal">Click on <strong class="screenText">Share this post</strong>, and you should see the page, including the form to share this post by email, as follows:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" src="img/B21088_02_17.png"/></figure>
<p class="packt_figref">Figure 2.17: The page to share a post via email</p>
<p class="normal">CSS <a id="_idIndexMarker219"/>styles for the form are included in the example code in the <code class="inlineCode">static/css/blog.css</code> file. When you click on the <strong class="screenText">SEND E-MAIL</strong> button, the form is submitted and validated. If all fields contain valid data, you get a success message, as follows:</p>
<figure class="mediaobject"><img alt="Text  Description automatically generated with medium confidence" src="img/B21088_02_18.png"/></figure>
<p class="packt_figref">Figure 2.18: A success message for a post shared via email</p>
<p class="normal">Send a post to your own email address and check your inbox. The email you receive should look like this:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_19.png"/></figure>
<p class="packt_figref">Figure 2.19: Test email sent displayed in Gmail</p>
<p class="normal">If you <a id="_idIndexMarker220"/>submit the form with invalid data, the form will be rendered again, including all validation errors:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, Teams  Description automatically generated" src="img/B21088_02_20.png"/></figure>
<p class="packt_figref">Figure 2.20: The share post form displaying invalid data errors</p>
<p class="normal">Most modern browsers will prevent you from submitting a form with empty or erroneous fields. This is because the browser validates the fields based on their attributes before submitting the form. In this case, the form won’t be submitted, and the browser will display an error message for the fields that are wrong. To test the Django <a id="_idIndexMarker221"/>form validation using a modern browser, you can skip the browser form validation by adding the <code class="inlineCode">novalidate</code> attribute to the HTML <code class="inlineCode">&lt;form&gt;</code> element, like <code class="inlineCode">&lt;form method="post" novalidate&gt;</code>. You can add this attribute to prevent the browser from validating fields and test your own form validation. After you are done testing, remove the <code class="inlineCode">novalidate</code> attribute to keep the browser form validation.</p>
<p class="normal">The functionality for sharing posts by email is now complete. You can find more information about working with forms at <a href="https://docs.djangoproject.com/en/5.0/topics/forms/">https://docs.djangoproject.com/en/5.0/topics/forms/</a>.</p>
<h1 class="heading-1" id="_idParaDest-102">Creating a comment system</h1>
<p class="normal">We will <a id="_idIndexMarker222"/>continue extending our blog application with a comment system that will allow users to comment on posts. To build the comment system, we will need the following:</p>
<ul>
<li class="bulletList">A comment model to store user comments on posts</li>
<li class="bulletList">A Django form that allows users to submit comments and manages the data validation</li>
<li class="bulletList">A view that processes the form and saves a new comment to the database</li>
<li class="bulletList">A list of comments and the HTML form to add a new comment that can be included in the post detail template</li>
</ul>
<h2 class="heading-2" id="_idParaDest-103">Creating a model for comments</h2>
<p class="normal">Let’s start <a id="_idIndexMarker223"/>by building a model to store user comments on posts.</p>
<p class="normal">Open the <code class="inlineCode">models.py</code> file of your <code class="inlineCode">blog</code> application and add the following code:</p>
<pre class="programlisting code"><code class="hljs-code">class Comment(models.Model):
    post = models.ForeignKey(
        Post,
        on_delete=models.CASCADE,
        related_name='comments'
 )
    name = models.CharField(max_length=80)
    email = models.EmailField()
    body = models.TextField()
    created = models.DateTimeField(auto_now_add=True)
    updated = models.DateTimeField(auto_now=True)
    active = models.BooleanField(default=True)
    class Meta:
        ordering = ['created']
        indexes = [
            models.Index(fields=['created']),
        ]
    def __str__(self):
        return f'Comment by {self.name} on {self.post}'
</code></pre>
<p class="normal">This is the <code class="inlineCode">Comment</code> model. We have added a <code class="inlineCode">ForeignKey</code> field to associate each comment <a id="_idIndexMarker224"/>with a single post. This many-to-one relationship is defined in the <code class="inlineCode">Comment</code> model because each comment will be made on one post, and each post may have multiple comments.</p>
<p class="normal">The <code class="inlineCode">related_name</code> attribute allows you to name the attribute that you use for the relationship from the related object back to this one. We can retrieve the post of a comment object using <code class="inlineCode">comment.post</code> and retrieve all comments associated with a post object using <code class="inlineCode">post.comments.all()</code>. If you don’t define the <code class="inlineCode">related_name</code> attribute, Django will use the name of the model in lowercase, followed by <code class="inlineCode">_set</code> (that is, <code class="inlineCode">comment_set</code>) to name the relationship of the related object to the object of the model, where this relationship has been defined.</p>
<p class="normal">You can learn more about many-to-one relationships at <a href="https://docs.djangoproject.com/en/5.0/topics/db/examples/many_to_one/">https://docs.djangoproject.com/en/5.0/topics/db/examples/many_to_one/</a>.</p>
<p class="normal">We have defined the <code class="inlineCode">active</code> Boolean field to control the status of the comments. This field will allow us to manually deactivate inappropriate comments using the administration site. We use <code class="inlineCode">default=True</code> to indicate that all comments are active by default.</p>
<p class="normal">We have defined the <code class="inlineCode">created</code> field to store the date and time when the comment was created. By using <code class="inlineCode">auto_now_add</code>, the date will be saved automatically when creating an object. In the <code class="inlineCode">Meta</code> class of the model, we have added <code class="inlineCode">ordering = ['created']</code> to sort comments in chronological order by default, and we have added an index for the <code class="inlineCode">created</code> field in ascending order. This will improve the performance of database lookups or ordering results using the <code class="inlineCode">created</code> field.</p>
<p class="normal">The <code class="inlineCode">Comment</code> model that we have built is not synchronized with the database. We need to generate a new database migration to create the corresponding database table.</p>
<p class="normal">Run the <a id="_idIndexMarker225"/>following command from the shell prompt:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py makemigrations blog
</code></pre>
<p class="normal">You should see the following output:</p>
<pre class="programlisting con"><code class="hljs-con">Migrations for 'blog':
  blog/migrations/0003_comment.py
    - Create model Comment
</code></pre>
<p class="normal">Django has generated a <code class="inlineCode">0003_comment.py</code> file inside the <code class="inlineCode">migrations/</code> directory of the <code class="inlineCode">blog</code> application. We need to create the related database schema and apply the changes to the database.</p>
<p class="normal">Run the following command to apply existing migrations:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py migrate
</code></pre>
<p class="normal">You will get an output that includes the following line:</p>
<pre class="programlisting con"><code class="hljs-con">Applying blog.0003_comment... OK
</code></pre>
<p class="normal">The migration has been applied and the <code class="inlineCode">blog_comment</code> table has been created in the database.</p>
<h2 class="heading-2" id="_idParaDest-104">Adding comments to the administration site</h2>
<p class="normal">Next, we will <a id="_idIndexMarker226"/>add the new model to the administration site to manage comments through a simple interface.</p>
<p class="normal">Open the <code class="inlineCode">admin.py</code> file of the <code class="inlineCode">blog</code> application, import the <code class="inlineCode">Comment</code> model, and add the following <code class="inlineCode">ModelAdmin</code> class:</p>
<pre class="programlisting code"><code class="hljs-code">from .models import <strong class="hljs-slc">Comment,</strong> Post
<strong class="hljs-meta-slc">@admin.register(</strong><strong class="hljs-params-slc">Comment</strong><strong class="hljs-meta-slc">)</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">CommentAdmin</strong><strong class="hljs-slc">(admin.ModelAdmin):</strong>
<strong class="hljs-slc">    list_display = [</strong><strong class="hljs-string-slc">'name'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'email'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'post'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'created'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'active'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">    list_filter = [</strong><strong class="hljs-string-slc">'active'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'created'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'updated'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">    search_fields = [</strong><strong class="hljs-string-slc">'name'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'email'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'body'</strong><strong class="hljs-slc">]</strong>
</code></pre>
<p class="normal">Open the shell prompt and execute the following command to start the development server:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/admin/</code> in your browser. You should see the new model included <a id="_idIndexMarker227"/>in the <strong class="screenText">BLOG</strong> section, as shown in <em class="italic">Figure 2.21</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_21.png"/></figure>
<p class="packt_figref">Figure 2.21: Blog application models on the Django administration index page</p>
<p class="normal">The model is now registered on the administration site.</p>
<p class="normal">In the <strong class="screenText">Comments</strong> row, click on <strong class="screenText">Add</strong>. You will see the form to add a new comment:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_22.png"/></figure>
<p class="packt_figref">Figure 2.22: Form to add a new comment in the Django administration site</p>
<p class="normal">Now we <a id="_idIndexMarker228"/>can manage <code class="inlineCode">Comment</code> instances using the administration site.</p>
<h2 class="heading-2" id="_idParaDest-105">Creating forms from models</h2>
<p class="normal">We need to build a form to let users comment on blog posts. Remember that Django has two <a id="_idIndexMarker229"/>base classes that can be used to create forms: <code class="inlineCode">Form</code> and <code class="inlineCode">ModelForm</code>. We used the <code class="inlineCode">Form</code> class to allow users to share posts by email. Now, we will use <code class="inlineCode">ModelForm</code> to take advantage of the existing <code class="inlineCode">Comment</code> model and build a form dynamically for it.</p>
<p class="normal">Edit the <code class="inlineCode">forms.py</code> file of your <code class="inlineCode">blog</code> application and add the following lines:</p>
<pre class="programlisting code"><code class="hljs-code">from .models import Comment
class CommentForm(forms.ModelForm):
    class Meta:
        model = Comment
        fields = ['name', 'email', 'body']
</code></pre>
<p class="normal">To create a form from a model, we just indicate which model to build the form for in the <code class="inlineCode">Meta</code> class of the form. Django will introspect the model and build the corresponding form dynamically.</p>
<p class="normal">Each model field type has a corresponding default form field type. The attributes of model fields are taken into account for form validation. By default, Django creates a form field for each field contained in the model. However, we can explicitly tell Django which fields <a id="_idIndexMarker230"/>to include in the form using the <code class="inlineCode">fields</code> attribute or define which fields to exclude using the <code class="inlineCode">exclude</code> attribute. In the <code class="inlineCode">CommentForm</code> form, we have explicitly included the <code class="inlineCode">name</code>, <code class="inlineCode">email</code>, and <code class="inlineCode">body</code> fields. These are the only fields that will be included in the form.</p>
<p class="normal">You can find more information about creating forms from models at <a href="https://docs.djangoproject.com/en/5.0/topics/forms/modelforms/">https://docs.djangoproject.com/en/5.0/topics/forms/modelforms/</a>.</p>
<h2 class="heading-2" id="_idParaDest-106">Handling ModelForms in views</h2>
<p class="normal">For sharing posts by email, we used the same view to display the form and manage its submission. We used the HTTP method to differentiate between both cases: <code class="inlineCode">GET</code> to display the <a id="_idIndexMarker231"/>form and <code class="inlineCode">POST</code> to submit it. In this case, we will add the comment form to the post detail page, and we will build a separate view to handle the form submission. The new view that processes the form will allow the user to return to the post detail view once the comment has been stored in the database.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">blog</code> application and add the following code:</p>
<pre class="programlisting code"><code class="hljs-code">from django.core.mail import send_mail
from django.core.paginator import EmptyPage, PageNotAnInteger, Paginator
from django.shortcuts import get_object_or_404, render
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.views.decorators.http </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> require_POST</strong>
from django.views.generic import ListView
from .forms import <strong class="hljs-slc">CommentForm,</strong> EmailPostForm
from .models import Post
# ...
<strong class="hljs-meta-slc">@require_POST</strong>
<strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">post_comment</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">request, post_id</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc">    post = get_object_or_404(</strong>
<strong class="hljs-slc">        Post,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">id</strong><strong class="hljs-slc">=post_id,</strong>
<strong class="hljs-slc">        status=Post.Status.PUBLISHED</strong>
<strong class="hljs-slc">    )</strong>
<strong class="hljs-slc">    comment = </strong><strong class="hljs-literal-slc">None</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># A comment was posted</strong>
<strong class="hljs-slc">    form = CommentForm(data=request.POST)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> form.is_valid():</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># Create a Comment object without saving it to the database</strong>
<strong class="hljs-slc">        comment = form.save(commit=</strong><strong class="hljs-literal-slc">False</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># Assign the post to the comment</strong>
<strong class="hljs-slc">        comment.post = post</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># Save the comment to the database</strong>
<strong class="hljs-slc">        comment.save()</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> render(</strong>
<strong class="hljs-slc">        request,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'blog/post/comment.html'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        {</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'post'</strong><strong class="hljs-slc">: post,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'form'</strong><strong class="hljs-slc">: form,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'comment'</strong><strong class="hljs-slc">: comment</strong>
<strong class="hljs-slc">        }</strong>
<strong class="hljs-slc">    )</strong>
</code></pre>
<p class="normal">We have <a id="_idIndexMarker232"/>defined the <code class="inlineCode">post_comment</code> view that takes the <code class="inlineCode">request</code> object and the <code class="inlineCode">post_id</code> variable as parameters. We will be using this view to manage the post submission. We expect the form to be submitted using the HTTP <code class="inlineCode">POST</code> method. We use the <code class="inlineCode">require_POST</code> decorator provided by Django to only allow <code class="inlineCode">POST</code> requests for this view. Django allows you to restrict the HTTP methods allowed for views. Django will throw an HTTP <code class="inlineCode">405</code> (method not allowed) error if you try to access the view with any other HTTP method.</p>
<p class="normal">In this view, we have implemented the following actions:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">We retrieve a published post by its <code class="inlineCode">id</code> using the <code class="inlineCode">get_object_or_404()</code> shortcut.</li>
<li class="numberedList">We define a <code class="inlineCode">comment</code> variable with the initial value <code class="inlineCode">None</code>. This variable will be used to store the comment object when it is created.</li>
<li class="numberedList">We instantiate the form using the submitted <code class="inlineCode">POST</code> data and validate it using the <code class="inlineCode">is_valid()</code> method. If the form is invalid, the template is rendered with the validation errors.</li>
<li class="numberedList">If the form is valid, we create a new <code class="inlineCode">Comment</code> object by calling the form’s <code class="inlineCode">save()</code> method and assign it to the <code class="inlineCode">comment</code> variable, as follows:
        <pre class="programlisting code"><code class="hljs-code">comment = form.save(commit=False)
</code></pre>
</li>
<li class="numberedList">The <code class="inlineCode">save()</code> method creates an instance of the model that the form is linked to and saves it to the database. If you call it using <code class="inlineCode">commit=False</code>, the model instance <a id="_idIndexMarker233"/>is created but not saved to the database. This allows us to modify the object before finally saving it.<div><p class="normal">The <code class="inlineCode">save()</code> method is available for <code class="inlineCode">ModelForm</code> but not for <code class="inlineCode">Form</code> instances since they are not linked to any model.</p>
</div>
</li>
</ol>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="6">We assign the post to the comment we created:
        <pre class="programlisting code"><code class="hljs-code">comment.post = post
</code></pre>
</li>
<li class="numberedList">We save the new comment to the database by calling its <code class="inlineCode">save()</code> method:
        <pre class="programlisting code"><code class="hljs-code">comment.save()
</code></pre>
</li>
<li class="numberedList">We render the <code class="inlineCode">blog/post/comment.html</code> template, passing the <code class="inlineCode">post</code>, <code class="inlineCode">form</code>, and <code class="inlineCode">comment</code> objects in the template context. This template doesn’t exist yet; we will create it later.</li>
</ol>
<p class="normal">Let’s create a URL pattern for this view.</p>
<p class="normal">Edit the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">blog</code> application and add the following URL pattern to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.urls import path
from . import views
app_name = 'blog'
urlpatterns = [
    # Post views
# path('', views.post_list, name='post_list'),
    path('', views.PostListView.as_view(), name='post_list'),
    path(
        '&lt;int:year&gt;/&lt;int:month&gt;/&lt;int:day&gt;/&lt;slug:post&gt;/',
        views.post_detail,
        name='post_detail'
 ),
    path('&lt;int:post_id&gt;/share/', views.post_share, name='post_share'),
    <strong class="hljs-slc">path(</strong>
<strong class="hljs-string-slc">'&lt;int:post_id&gt;/comment/'</strong><strong class="hljs-slc">, views.post_comment, name=</strong><strong class="hljs-string-slc">'post_comment'</strong>
 <strong class="hljs-slc">),</strong>
]
</code></pre>
<p class="normal">We have <a id="_idIndexMarker234"/>implemented the view to manage the submission of comments and their corresponding URL. Let’s create the necessary templates.</p>
<h2 class="heading-2" id="_idParaDest-107">Creating templates for the comment form</h2>
<p class="normal">We will <a id="_idIndexMarker235"/>create a template for the comment form that we will use in two places:</p>
<ul>
<li class="bulletList">In the post detail template associated with the <code class="inlineCode">post_detail</code> view to let users publish comments.</li>
<li class="bulletList">In the post comment template associated with the <code class="inlineCode">post_comment</code> view to display the form again if there are any form errors.</li>
</ul>
<p class="normal">We will create the form template and use the <code class="inlineCode">{% include %}</code> template tag to include it in the two other templates.</p>
<p class="normal">In the <code class="inlineCode">templates/blog/post/</code> directory, create a new <code class="inlineCode">includes/</code> directory. Add a new file inside this directory and name it <code class="inlineCode">comment_form.html</code>.</p>
<p class="normal">The file structure should look as follows:</p>
<pre class="programlisting con"><code class="hljs-con">templates/
  blog/
    post/
      includes/
        comment_form.html
      detail.html
      list.html
      share.html
</code></pre>
<p class="normal">Edit the new <code class="inlineCode">blog/post/includes/comment_form.html</code> template and add the following code:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;h2&gt;Add a new comment&lt;/h2&gt;
&lt;form action="{% url "blog:post_comment" post.id %}" method="post"&gt;
  {{ form.as_p }}
  {% csrf_token %}
  &lt;p&gt;&lt;input type="submit" value="Add comment"&gt;&lt;/p&gt;
&lt;/form&gt;
</code></pre>
<p class="normal">In this <a id="_idIndexMarker236"/>template, we build the <code class="inlineCode">action</code> URL of the HTML <code class="inlineCode">&lt;form&gt;</code> element dynamically using the <code class="inlineCode">{% url %}</code> template tag. We build the URL of the <code class="inlineCode">post_comment</code> view that will process the form. We display the form rendered in paragraphs and we include <code class="inlineCode">{% csrf_token %}</code> for CSRF protection because this form will be submitted with the <code class="inlineCode">POST</code> method.</p>
<p class="normal">Create a new file in the <code class="inlineCode">templates/blog/post/</code> directory of the <code class="inlineCode">blog</code> application and name it <code class="inlineCode">comment.html</code>.</p>
<p class="normal">The file structure should now look as follows:</p>
<pre class="programlisting con"><code class="hljs-con">templates/
  blog/
    post/
      includes/
        comment_form.html
      comment.html
      detail.html
      list.html
      share.html
</code></pre>
<p class="normal">Edit the new <code class="inlineCode">blog/post/comment.html</code> template and add the following code:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "blog/base.html" %}
{% block title %}Add a comment{% endblock %}
{% block content %}
  {% if comment %}
    &lt;h2&gt;Your comment has been added.&lt;/h2&gt;
&lt;p&gt;&lt;a href="{{ post.get_absolute_url }}"&gt;Back to the post&lt;/a&gt;&lt;/p&gt;
  {% else %}
    {% include "blog/post/includes/comment_form.html" %}
  {% endif %}
{% endblock %}
</code></pre>
<p class="normal">This <a id="_idIndexMarker237"/>is the template for the post comment view. In this view, we expect the form to be submitted via the <code class="inlineCode">POST</code> method. The template covers two different scenarios:</p>
<ul>
<li class="bulletList">If the form data submitted is valid, the <code class="inlineCode">comment</code> variable will contain the <code class="inlineCode">comment</code> object that was created and a success message will be displayed.</li>
<li class="bulletList">If the form data submitted is not valid, the <code class="inlineCode">comment</code> variable will be <code class="inlineCode">None</code>. In this case, we will display the comment form. We use the <code class="inlineCode">{% include %}</code> template tag to include the <code class="inlineCode">comment_form.html</code> template that we have previously created.</li>
</ul>
<h2 class="heading-2" id="_idParaDest-108">Adding comments to the post detail view</h2>
<p class="normal">To complete the comment functionality, we will add the list of comments and the comment <a id="_idIndexMarker238"/>form to the <code class="inlineCode">post_detail</code> view.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">blog</code> application and edit the <code class="inlineCode">post_detail</code> view as follows:</p>
<pre class="programlisting code"><code class="hljs-code">def post_detail(request, year, month, day, post):
    post = get_object_or_404(
        Post,
        status=Post.Status.PUBLISHED,
        slug=post,
        publish__year=year,
        publish__month=month,
        publish__day=day
    )
    <strong class="hljs-comment-slc"># List of active comments for this post</strong>
<strong class="hljs-slc">    comments = post.comments.</strong><strong class="hljs-built_in-slc">filter</strong><strong class="hljs-slc">(active=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># Form for users to comment</strong>
<strong class="hljs-slc">    form = CommentForm()</strong>
return render(
        request,
        'blog/post/detail.html',
        {
            'post': post<strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'comments'</strong><strong class="hljs-slc">: comments,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'form'</strong><strong class="hljs-slc">: form</strong>
        }
    )
</code></pre>
<p class="normal">Let’s <a id="_idIndexMarker239"/>review the code we have added to the <code class="inlineCode">post_detail</code> view:</p>
<ul>
<li class="bulletList">We have added a QuerySet to retrieve all active comments for the post, as follows:
        <pre class="programlisting code"><code class="hljs-code">comments = post.comments.filter(active=True)
</code></pre>
</li>
<li class="bulletList">This QuerySet is built using the <code class="inlineCode">post</code> object. Instead of building a QuerySet for the <code class="inlineCode">Comment</code> model directly, we leverage the <code class="inlineCode">post</code> object to retrieve the related <code class="inlineCode">Comment</code> objects. We use the <code class="inlineCode">comments</code> manager for the related <code class="inlineCode">Comment</code> objects that we previously defined in the <code class="inlineCode">Comment</code> model, using the <code class="inlineCode">related_name</code> attribute of the <code class="inlineCode">ForeignKey</code> field to the <code class="inlineCode">Post</code> model.</li>
<li class="bulletList">We have also created an instance of the comment form with <code class="inlineCode">form = CommentForm()</code>.</li>
</ul>
<h2 class="heading-2" id="_idParaDest-109">Adding comments to the post detail template</h2>
<p class="normal">We <a id="_idIndexMarker240"/>need to edit the <code class="inlineCode">blog/post/detail.html</code> template to implement the following:</p>
<ul>
<li class="bulletList">Display the total number of comments for a post</li>
<li class="bulletList">Display the list of comments</li>
<li class="bulletList">Display the form for users to add a new comment</li>
</ul>
<p class="normal">We will start by adding the total number of comments for a post.</p>
<p class="normal">Edit the <code class="inlineCode">blog/post/detail.html</code> template and change it as follows:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "blog/base.html" %}
{% block title %}{{ post.title }}{% endblock %}
{% block content %}
  &lt;h1&gt;{{ post.title }}&lt;/h1&gt;
&lt;p class="date"&gt;
    Published {{ post.publish }} by {{ post.author }}
  &lt;/p&gt;
  {{ post.body|linebreaks }}
  &lt;p&gt;
&lt;a href="{% url "blog:post_share" post.id %}"&gt;
      Share this post
    &lt;/a&gt;
&lt;/p&gt;
<strong class="hljs-slc">{% with comments.count as total_comments %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">h2</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">      {{ total_comments }} comment{{ total_comments|pluralize }}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">h2</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">  {% endwith %}</strong>
{% endblock %}
</code></pre>
<p class="normal">We <a id="_idIndexMarker241"/>use the Django <strong class="keyWord">object relational mapper</strong> (<strong class="keyWord">ORM</strong>) in the template, executing the <code class="inlineCode">comments.count()</code> QuerySet. Note <a id="_idIndexMarker242"/>that the Django template language doesn’t use parentheses for calling methods. The <code class="inlineCode">{% with %}</code> tag allows you to assign a value to a new variable that will be available in the template until the <code class="inlineCode">{% endwith %}</code> tag.</p>
<div><p class="normal">The <code class="inlineCode">{% with %}</code> template tag is useful for avoiding hitting the database or accessing expensive methods multiple times.</p>
</div>
<p class="normal">We use the <code class="inlineCode">pluralize</code> template filter to display a plural suffix for the word “comment,” depending on the <code class="inlineCode">total_comments</code> value. Template filters take the value of the variable they are applied to as their input and return a computed value. We will learn more about template filters in <em class="italic">Chapter 3</em>, <em class="italic">Extending Your Blog Application</em>.</p>
<p class="normal">The <code class="inlineCode">pluralize</code> template filter returns a string with the letter “s” if the value is different from <code class="inlineCode">1</code>. The preceding text will be rendered as <em class="italic">0 comments</em>, <em class="italic">1 comment</em>, or <em class="italic">N comments</em>, depending on the number of active comments for the post.</p>
<p class="normal">Now, let’s <a id="_idIndexMarker243"/>add the list of active comments to the post detail template.</p>
<p class="normal">Edit the <code class="inlineCode">blog/post/detail.html</code> template and implement the following changes:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "blog/base.html" %}
{% block title %}{{ post.title }}{% endblock %}
{% block content %}
  &lt;h1&gt;{{ post.title }}&lt;/h1&gt;
&lt;p class="date"&gt;
    Published {{ post.publish }} by {{ post.author }}
  &lt;/p&gt;
  {{ post.body|linebreaks }}
  &lt;p&gt;
&lt;a href="{% url "blog:post_share" post.id %}"&gt;
      Share this post
    &lt;/a&gt;
&lt;/p&gt;
  {% with comments.count as total_comments %}
    &lt;h2&gt;
      {{ total_comments }} comment{{ total_comments|pluralize }}
    &lt;/h2&gt;
  {% endwith %}
  <strong class="hljs-slc">{% for comment in comments %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">div</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"comment"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">p</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"info"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">        Comment {{ forloop.counter }} by {{ comment.name }}</strong>
<strong class="hljs-slc">        {{ comment.created }}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">p</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">      {{ comment.body|linebreaks }}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">div</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">  {% empty %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">p</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">There are no comments.</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">p</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">  {% endfor %}</strong>
{% endblock %}
</code></pre>
<p class="normal">We have added a <code class="inlineCode">{% for %}</code> template tag to loop through the post comments. If the <code class="inlineCode">comments</code> list is empty, we display a message that informs users that there are no comments for this post. We enumerate comments with the <code class="inlineCode">{{ forloop.counter }}</code> variable, which contains the loop counter in each iteration. For each post, we display the name <a id="_idIndexMarker244"/>of the user who posted it, the date, and the body of the comment.</p>
<p class="normal">Finally, let’s add the comment form to the template.</p>
<p class="normal">Edit the <code class="inlineCode">blog/post/detail.html</code> template and include the comment form template as follows:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "blog/base.html" %}
{% block title %}{{ post.title }}{% endblock %}
{% block content %}
  &lt;h1&gt;{{ post.title }}&lt;/h1&gt;
&lt;p class="date"&gt;
    Published {{ post.publish }} by {{ post.author }}
  &lt;/p&gt;
  {{ post.body|linebreaks }}
  &lt;p&gt;
&lt;a href="{% url "blog:post_share" post.id %}"&gt;
      Share this post
    &lt;/a&gt;
&lt;/p&gt;
  {% with comments.count as total_comments %}
    &lt;h2&gt;
      {{ total_comments }} comment{{ total_comments|pluralize }}
    &lt;/h2&gt;
  {% endwith %}
  {% for comment in comments %}
    &lt;div class="comment"&gt;
&lt;p class="info"&gt;
        Comment {{ forloop.counter }} by {{ comment.name }}
        {{ comment.created }}
      &lt;/p&gt;
      {{ comment.body|linebreaks }}
    &lt;/div&gt;
  {% empty %}
    &lt;p&gt;There are no comments.&lt;/p&gt;
  {% endfor %}
  <strong class="hljs-slc">{% include "blog/post/includes/comment_form.html" %}</strong>
{% endblock %}
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/blog/</code> in your browser and click on a post title to take a look <a id="_idIndexMarker245"/>at the post detail page. You will see something like <em class="italic">Figure 2.23</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_23.png"/></figure>
<p class="packt_figref">Figure 2.23: The post detail page, including the form to add a comment</p>
<p class="normal">Fill in the comment form with valid data and click on <strong class="screenText">Add comment</strong>. You should see the following page:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_24.png"/></figure>
<p class="packt_figref">Figure 2.24: The comment added success page</p>
<p class="normal">Click <a id="_idIndexMarker246"/>on the <strong class="screenText">Back to the post</strong> link. You should be redirected back to the post detail page, and you should be able to see the comment that you just added, as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_25.png"/></figure>
<p class="packt_figref">Figure 2.25: The post detail page, including a comment</p>
<p class="normal">Add <a id="_idIndexMarker247"/>one more comment to the post. The comments should appear below the post contents in chronological order, as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_26.png"/></figure>
<p class="packt_figref">Figure 2.26: The comment list on the post detail page</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/admin/blog/comment/</code> in your browser. You will see the administration page with the list of comments you created, like this:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_27.png"/></figure>
<p class="packt_figref">Figure 2.27: List of comments on the administration site</p>
<p class="normal">Click <a id="_idIndexMarker248"/>on the name of one of the posts to edit it. Uncheck the <strong class="screenText">Active</strong> checkbox as follows and click on the <strong class="screenText">Save</strong> button:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_28.png"/></figure>
<p class="packt_figref">Figure 2.28: Editing a comment on the administration site</p>
<p class="normal">You will be redirected to the list of comments. The <strong class="screenText">Active</strong> column will display an inactive icon for the comment, as shown in <em class="italic">Figure 2.29</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_29.png"/></figure>
<p class="packt_figref">Figure 2.29: Active/inactive comments on the administration site</p>
<p class="normal">If you <a id="_idIndexMarker249"/>return to the post detail view, you will note that the inactive comment is no longer displayed, neither is it counted for the total number of active comments for the post:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_30.png"/></figure>
<p class="packt_figref">Figure 2.30: A single active comment displayed on the post detail page</p>
<p class="normal">Thanks to the <code class="inlineCode">active</code> field, you can deactivate inappropriate comments and avoid showing them on your posts.</p>
<h2 class="heading-2" id="_idParaDest-110">Using simplified templates for form rendering</h2>
<p class="normal">You have used <code class="inlineCode">{{ form.as_p }}</code> to render the forms using HTML paragraphs. This is a very <a id="_idIndexMarker250"/>straightforward method for rendering forms, but there may be occasions when you need to employ custom HTML markup for rendering forms.</p>
<p class="normal">To use custom HTML for rendering form fields, you can access each form field directly, or iterate through the form fields, as in the following example:</p>
<pre class="programlisting code"><code class="hljs-code">{% for field in form %}
  &lt;div class="my-div"&gt;
    {{ field.errors }}
    {{ field.label_tag }} {{ field }}
    &lt;div class="help-text"&gt;{{ field.help_text|safe }}&lt;/div&gt;
&lt;/div&gt;
{% endfor %}
</code></pre>
<p class="normal">In this code, we use <code class="inlineCode">{{ field.errors }}</code> to render any field errors of the form, <code class="inlineCode">{{ field.label_tag }}</code> to render the form HTML label, <code class="inlineCode">{{ field }}</code> to render the actual field, and <code class="inlineCode">{{ field.help_text|safe }}</code> to render the field’s help text HTML.</p>
<p class="normal">This method is helpful to customize how forms are rendered, but you might need to add certain HTML elements for specific fields or include some fields in containers. Django 5.0 introduces field groups and field group templates. Field groups simplify the rendering of labels, widgets, help texts, and field errors. Let’s use this new feature to customize the comment form.</p>
<p class="normal">We are going to use custom HTML markup to reposition the <code class="inlineCode">name</code> and <code class="inlineCode">email</code> form fields using additional HTML elements.</p>
<p class="normal">Edit the <code class="inlineCode">blog/post/includes/comment_form.html</code> template and modify it as follows. The new code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;h2&gt;Add a new comment&lt;/h2&gt;
&lt;form action="{% url "blog:post_comment" post.id %}" method="post"&gt;
<strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">div</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"left"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">    {{ form.name.as_field_group }}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">div</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">div</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"left"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">    {{ form.email.as_field_group }}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">div</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">  {{ form.body.as_field_group }}</strong>
  {% csrf_token %}
  &lt;p&gt;&lt;input type="submit" value="Add comment"&gt;&lt;/p&gt;
&lt;/form&gt;
</code></pre>
<p class="normal">We have added <code class="inlineCode">&lt;div&gt;</code> containers for the <code class="inlineCode">name</code> and <code class="inlineCode">email</code> fields with a custom CSS class to float both fields to the left.<code class="inlineCode"> </code>The <code class="inlineCode">as_field_group</code> method renders each field including help <a id="_idIndexMarker251"/>text and errors. This method uses the <code class="inlineCode">django/forms/field.html</code> template by default. You can see the contents of this template at <a href="https://github.com/django/django/blob/stable/5.0.x/django/forms/templates/django/forms/field.html">https://github.com/django/django/blob/stable/5.0.x/django/forms/templates/django/forms/field.html</a>. You can also create custom field templates and reuse them by adding the <code class="inlineCode">template_name</code> attribute to any form field. You can read more about reusable form templates at <a href="https://docs.djangoproject.com/en/5.0/topics/forms/#reusable-field-group-templates">https://docs.djangoproject.com/en/5.0/topics/forms/#reusable-field-group-templates</a>.</p>
<p class="normal">Open a blog post and take a look at the comment form. The form should now look like <em class="italic">Figure 2.31</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_02_31.png"/></figure>
<p class="packt_figref">Figure 2.31: The comment form with the new HTML markup</p>
<p class="normal">The <code class="inlineCode">name</code> and <code class="inlineCode">email</code> fields are now displayed next to each other. Field groups allow you to easily customize form rendering.</p>
<h1 class="heading-1" id="_idParaDest-111">Summary</h1>
<p class="normal">In this chapter, you learned how to define canonical URLs for models. You created SEO-friendly URLs for blog posts, and you implemented object pagination for your post list. You also learned how to work with Django forms and model forms. You created a system to recommend posts by email and created a comment system for your blog.</p>
<p class="normal">In the next chapter, you will create a tagging system for the blog. You will learn how to build complex QuerySets to retrieve objects by similarity. You will learn how to create custom template tags and filters. You will also build a custom sitemap and feed for your blog posts and implement full-text search functionality for your posts.</p>
<h1 class="heading-1" id="_idParaDest-112">Additional resources</h1>
<p class="normal">The following resources provide additional information related to the topics covered in this chapter:</p>
<ul>
<li class="bulletList">Source code for this chapter: <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter02">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter02</a></li>
<li class="bulletList">URL utility functions: <a href="https://docs.djangoproject.com/en/5.0/ref/urlresolvers/">https://docs.djangoproject.com/en/5.0/ref/urlresolvers/</a></li>
<li class="bulletList">URL path converters: <a href="https://docs.djangoproject.com/en/5.0/topics/http/urls/#path-converters">https://docs.djangoproject.com/en/5.0/topics/http/urls/#path-converters</a></li>
<li class="bulletList">Django paginator class: <a href="https://docs.djangoproject.com/en/5.0/ref/paginator/">https://docs.djangoproject.com/en/5.0/ref/paginator/</a></li>
<li class="bulletList">Introduction to class-based views – <a href="https://docs.djangoproject.com/en/5.0/topics/class-based-views/intro/">https://docs.djangoproject.com/en/5.0/topics/class-based-views/intro/</a></li>
<li class="bulletList">Sending emails with Django: <a href="https://docs.djangoproject.com/en/5.0/topics/email/">https://docs.djangoproject.com/en/5.0/topics/email/</a></li>
<li class="bulletList">The <code class="inlineCode">python-decouple</code> library: <a href="https://github.com/HBNetwork/python-decouple">https://github.com/HBNetwork/python-decouple</a></li>
<li class="bulletList">The <code class="inlineCode">django-anymail</code> library: <a href="https://anymail.dev/en/stable/installation/">https://anymail.dev/en/stable/installation/</a></li>
<li class="bulletList">The <code class="inlineCode">django-anymail</code> supported email service providers: <a href="https://anymail.dev/en/stable/esps/">https://anymail.dev/en/stable/esps/</a></li>
<li class="bulletList">Django form field types: <a href="https://docs.djangoproject.com/en/5.0/ref/forms/fields/">https://docs.djangoproject.com/en/5.0/ref/forms/fields/</a></li>
<li class="bulletList">Working with forms: <a href="https://docs.djangoproject.com/en/5.0/topics/forms/">https://docs.djangoproject.com/en/5.0/topics/forms/</a></li>
<li class="bulletList">Creating forms from models: <a href="https://docs.djangoproject.com/en/5.0/topics/forms/modelforms/">https://docs.djangoproject.com/en/5.0/topics/forms/modelforms/</a></li>
<li class="bulletList">Many-to-one model relationships: <a href="https://docs.djangoproject.com/en/5.0/topics/db/examples/many_to_one/">https://docs.djangoproject.com/en/5.0/topics/db/examples/many_to_one/</a></li>
<li class="bulletList">Default form field template: <a href="https://github.com/django/django/blob/stable/5.0.x/django/forms/templates/django/forms/field.html">https://github.com/django/django/blob/stable/5.0.x/django/forms/templates/django/forms/field.html</a></li>
<li class="bulletList">Reusable field group templates: <a href="https://docs.djangoproject.com/en/5.0/topics/forms/#reusable-field-group-templates">https://docs.djangoproject.com/en/5.0/topics/forms/#reusable-field-group-templates</a></li>
</ul>
</div>
</body></html>