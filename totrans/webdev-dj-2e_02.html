<html><head></head><body>
		<div>
			<div id="_idContainer086" class="Content">
			</div>
		</div>
		<div id="_idContainer087" class="Content">
			<h1 id="_idParaDest-63"><a id="_idTextAnchor065"/>2. Models and Migrations</h1>
		</div>
		<div id="_idContainer112" class="Content">
			<p class="callout-heading">Overview</p>
			<p class="callout">This chapter introduces you to the concept of databases and their importance in building web applications. You will start by creating a database using an open-source database visualization tool called <strong class="bold">SQLite DB Browser</strong>. You will then perform some basic <strong class="bold">Create Read Update Delete</strong> (<strong class="bold">CRUD</strong>) database operations using SQL commands. Then, you will learn about Django's <strong class="bold">Object Relational Mapping</strong> (<strong class="bold">ORM</strong>), using which your application can interact and seamlessly work with a relational database using simple Python code, eliminating the need to run complex SQL queries. You will learn about <strong class="bold">models</strong> and <strong class="bold">migrations</strong>, which are a part of Django's ORM, that are used to propagate database schematic changes from the application to the database, and also perform database CRUD operations. Toward the end of the chapter, you will study the various types of database relationships and use that knowledge to perform queries across related records.</p>
			<h1 id="_idParaDest-64"><a id="_idTextAnchor066"/>Introduction</h1>
			<p>Data is at the core of most web applications. Unless we're talking about a very simple application such as a calculator, in most cases we need to store data, process it, and display it to the user on a page. Since most operations in user-facing web applications involve data, there is a need to store data in places that are secure, easily accessible, and readily available. This is where databases come in handy. Imagine a library operational before the advent of computers. The librarian would have to maintain records of book inventories, records of book lending, returns from students, and so on. All of these would have been maintained in physical records. The librarian, while carrying out their day-to-day activities, would modify these records for each operation, for example, when lending a book to someone or when the book was returned.</p>
			<p>Today, we have databases to help us with such administrative tasks. A database looks like a spreadsheet or an Excel sheet containing records, with each table consisting of multiple rows and columns. An application can have many such tables. Here is an example table of a book inventory in a library:</p>
			<div>
				<div id="_idContainer088" class="IMG---Figure">
					<img src="image/B15509_02_01.jpg" alt="Figure 2.1: Table of a book inventory for a library&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.1: Table of a book inventory for a library</p>
			<p>In the preceding table, we can see that there are columns with details about various attributes of the books in the library, while the rows contain entries for each book. To manage a library, there can be many such tables working together as a system. For example, along with an inventory, we may have other tables such as student information, book lending records, and so on. Databases are built with the same logic, where software applications can easily manage data.</p>
			<p>In the previous chapter, we had a brief introduction to Django and its use in developing web applications. Then we learned about the Model-View-Template (MVT) concept. Later, we created a Django project and started the Django development server. We also had a brief discussion about Django's views, URLs, and templates. </p>
			<p>In this chapter, we will start by learning about the types of databases and a few basic database operations using SQL. After that, we will move on to the concept of models and migrations in Django, which assist in faster development by providing a layer of abstraction to facilitate database operations using Python objects.</p>
			<h1 id="_idParaDest-65"><a id="_idTextAnchor067"/>Databases</h1>
			<p>A database is a structured collection of data that helps manage information easily. A software layer called the Database Management System (DBMS) is used to store, maintain, and perform operations on the data. Databases are of two types, relational databases and non-relational databases.</p>
			<h2 id="_idParaDest-66"><a id="_idTextAnchor068"/>Relational Databases</h2>
			<p>Relational databases or Structured Query Language (SQL) databases store data in a pre-determined structure of rows and columns called tables. A database can be made up of more than one such table, and these tables have a fixed structure of attributes, data types, and relations with other tables. For example, as we just saw in <em class="italic">Figure 2.1</em>, the book inventory table has a fixed structure of columns comprising <strong class="bold">Book Number</strong>, <strong class="bold">Author</strong>, <strong class="bold">Title</strong>, and <strong class="bold">Number of Copies</strong>, and the entries form the rows in the table. There could be other tables as well, such as <strong class="bold">Student Information</strong> and <strong class="bold">Lending Records</strong>, which could be related to the inventory table. Also, whenever a book is lent to a student, the records will be stored per the relationships between multiple tables (say, the <strong class="bold">Student Information</strong> and the <strong class="bold">Book Inventory</strong> tables).</p>
			<p>This pre-determined structure of rules defining the data types, tabular structures, and relationships across different tables acts like scaffolding or a blueprint for a database. This blueprint is collectively called a database schema. When applied to a database, it will prepare the database to store application data. To manage and maintain these databases, there is a common language for relational databases called SQL. Some examples of relational databases are SQLite, PostgreSQL, MySQL, and OracleDB.</p>
			<h2 id="_idParaDest-67"><a id="_idTextAnchor069"/>Non-Relational Databases</h2>
			<p>Non-relational databases or NoSQL (Not Only SQL) databases are designed to store unstructured data. They are well suited to large amounts of generated data that does not follow rigid rules, as is the case with relational databases. Some examples of non-relational databases are Cassandra, MongoDB, CouchDB, and Redis.</p>
			<p>For example, imagine that you need to store the stock value of companies in a database using Redis. Here, the company name will be stored as the key and the stock value as the value. Using the key-value type NoSQL database in this use case is appropriate because it stores the desired value for a unique key and is faster to access.</p>
			<p>For the scope of this book, we will be dealing only with relational databases as Django does not officially support non-relational databases. However, if you wish to explore, there are many forked projects, such as Django non-rel, that support NoSQL databases. </p>
			<h2 id="_idParaDest-68"><a id="_idTextAnchor070"/>Database Operations Using SQL</h2>
			<p>SQL uses a set of commands to perform a variety of database operations, such as creating an entry, reading values, updating an entry, and deleting an entry. These operations are collectively called <strong class="bold">CRUD operations</strong>, which stands for Create, Read, Update, and Delete. To understand database operations in detail, let's first get some hands-on experience with SQL commands. Most relational databases share a similar SQL syntax; however, some operations will differ.</p>
			<p>For the scope of this chapter, we will use SQLite as the database. SQLite is a lightweight relational database that is a part of Python standard libraries. That's why Django uses SQLite as its default database configuration. However, we will also learn more about how to perform configuration changes to use other databases in <em class="italic">Chapter 17</em>, <em class="italic">Deployment of a Django Application (Part 1 – Server Setup)</em>. This chapter can be downloaded from the GitHub repository of this book, from <a href="http://packt.live/2Kx6FmR">http://packt.live/2Kx6FmR</a>.</p>
			<h2 id="_idParaDest-69"><a id="_idTextAnchor071"/>Data Types in Relational databases</h2>
			<p>Databases provide us with a way to restrict the type of data that can be stored in a given column. These are called data types. Some examples of data types for a relational database such as SQLite3 are given here:</p>
			<ul>
				<li><strong class="source-inline">INTEGER</strong> is used for storing integers.</li>
				<li><strong class="source-inline">TEXT</strong> can store text.</li>
				<li><strong class="source-inline">REAL</strong> is used for floating-point values.</li>
			</ul>
			<p>For example, you would want the title of a book to have <strong class="source-inline">TEXT</strong> as the data type. So, the database will enforce a rule that no type of data, other than text data, can be stored in that column. Similarly, the book's price can have a <strong class="source-inline">REAL</strong> data type, and so on.</p>
			<h2 id="_idParaDest-70"><a id="_idTextAnchor072"/>Exercise 2.01: Creating a Book Database</h2>
			<p>In this exercise, you will create a book database for a book review application. For better visualization of the data in the SQLite database, you will install an open-source tool called <strong class="bold">DB Browser</strong> for SQLite. This tool helps visualize the data and provides a shell to execute the SQL commands.</p>
			<p>If you haven't done so already, visit the URL <a href="https://sqlitebrowser.org">https://sqlitebrowser.org</a> and from the <em class="italic">downloads</em> section, install the application as per your operating system and launch it. Detailed instructions for DB Browser installation can be found in the <em class="italic">Preface</em>.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">Database operations can be performed using a command-line shell as well.</p>
			<ol>
				<li>After launching the application, create a new database by clicking <strong class="source-inline">New Database</strong> in the top-left corner of the application. Create a database named <strong class="source-inline">bookr</strong>, as you are working on a book review application:<div id="_idContainer089" class="IMG---Figure"><img src="image/B15509_02_02.jpg" alt="Figure 2.2: Creating a database named bookr&#13;&#10;"/></div><p class="figure-caption">Figure 2.2: Creating a database named bookr</p></li>
				<li>Next, click the <strong class="source-inline">Create Table</strong> button in the top-left corner and enter <strong class="source-inline">book</strong> as the table name.<p class="callout-heading">Note</p><p class="callout">After clicking the <strong class="source-inline">Save</strong> button, you may find that the window for creating a table opens up automatically. In that case, you won't have to click the <strong class="source-inline">Create Table</strong> button; simply proceed with the creation of the book table as specified in the preceding step. </p></li>
				<li>Now, click the <strong class="source-inline">Add field</strong> button, enter the field name as <strong class="source-inline">title</strong>, and select the type as <strong class="source-inline">TEXT</strong> from the dropdown. Here <strong class="source-inline">TEXT</strong> is the data type for the <strong class="source-inline">title</strong> field in the database:<div id="_idContainer090" class="IMG---Figure"><img src="image/B15509_02_03.jpg" alt="Figure 2.3: Adding a TEXT field named title&#13;&#10;"/></div><p class="figure-caption">Figure 2.3: Adding a TEXT field named title</p></li>
				<li>Similarly, add two more fields for the table named <strong class="source-inline">publisher</strong> and <strong class="source-inline">author</strong> and select <strong class="source-inline">TEXT</strong> as the type for both the fields. Then, click the <strong class="source-inline">OK</strong> button:<div id="_idContainer091" class="IMG---Figure"><img src="image/B15509_02_04.jpg" alt="Figure 2.4: Creating TEXT fields named publisher and author&#13;&#10;"/></div></li>
			</ol>
			<p class="figure-caption">Figure 2.4: Creating TEXT fields named publisher and author</p>
			<p>This creates a database table called <strong class="source-inline">book</strong> in the <strong class="source-inline">bookr</strong> database with the fields title, publisher, and <strong class="source-inline">author</strong>. This can be seen as follows:</p>
			<div>
				<div id="_idContainer092" class="IMG---Figure">
					<img src="image/B15509_02_05.jpg" alt="Figure 2.5: Database with the fields title, publisher, and author&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.5: Database with the fields title, publisher, and author</p>
			<p>In this exercise, we used an open-source tool called DB Browser (SQLite) to create our first database called <strong class="source-inline">bookr</strong>, and in it, we created our first table named <strong class="source-inline">book</strong>.</p>
			<h1 id="_idParaDest-71"><a id="_idTextAnchor073"/>SQL CRUD Operations</h1>
			<p>Let's assume that the editors or the users of our book review application want to make some modifications to the book inventory, such as adding a few books to the database, updating an entry in the database, and so on. SQL provides various ways to perform such CRUD operations. Before we dive into the world of Django models and migrations, let's explore these basic SQL operations first.</p>
			<p>For the CRUD operations that follow, you will be running a few SQL queries. To run them, navigate to the <strong class="source-inline">Execute SQL</strong> tab in DB Browser. You can type in or paste the SQL queries we've listed in the sections that follow in the <strong class="source-inline">SQL 1</strong> window. You can spend some time modifying your queries, and understanding them, before you execute them. When you're ready, click the icon that looks like a <strong class="source-inline">Play</strong> button or press the F5 key to execute the command. The results will show up in the window below the <strong class="source-inline">SQL 1</strong> window:</p>
			<div>
				<div id="_idContainer093" class="IMG---Figure">
					<img src="image/B15509_02_06.jpg" alt="Figure 2.6: Executing SQL queries in DB Browser&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.6: Executing SQL queries in DB Browser</p>
			<h2 id="_idParaDest-72"><a id="_idTextAnchor074"/>SQL Create Operations</h2>
			<p>The <strong class="bold">Create</strong> operation in SQL is performed using the <strong class="source-inline">insert</strong> command, which, as the name implies, lets us insert data into the database. Let's go back to our <strong class="source-inline">bookr</strong> example. Since we have already created the database and the <strong class="source-inline">book</strong> table, we can now create or insert an entry in the database by executing the following command:</p>
			<p class="source-code">insert into book values ('The Sparrow Warrior', 'Super Hero   Publications', 'Patric Javagal');</p>
			<p>This inserts into the table named <strong class="source-inline">book</strong> the values defined in the command. Here, <strong class="source-inline">The Sparrow Warrior</strong> is the title, <strong class="source-inline">Super Hero Publications</strong> is the publisher, and <strong class="source-inline">Patric Javagal</strong> is the author of the book. Note that the order of insertion corresponds with the way we have created our table; that is, the values are inserted into the columns representing title, publisher, and author respectively. Similarly, let's execute two more inserts to populate the <strong class="source-inline">book</strong> table:</p>
			<p class="source-code">insert into book values ('Ninja Warrior', 'East Hill Publications',   'Edward Smith');</p>
			<p class="source-code">insert into book values ('The European History', 'Northside   Publications', 'Eric Robbins');</p>
			<p>The three inserts executed so far will insert three rows into the <strong class="source-inline">book</strong> table. But how do we verify that? How would we know whether those three entries we inserted were entered into the database correctly? Let's learn how to do that in the next section.</p>
			<h2 id="_idParaDest-73"><a id="_idTextAnchor075"/>SQL Read Operations</h2>
			<p>We can read from the database using the <strong class="source-inline">select</strong> SQL operation. For example, the following SQL <strong class="source-inline">select</strong> command retrieves the selected entries created in the <strong class="source-inline">book</strong> table:</p>
			<p class="source-code">select title, publisher, author from book;</p>
			<p>You should see the following output:</p>
			<div>
				<div id="_idContainer094" class="IMG---Figure">
					<img src="image/B15509_02_07.jpg" alt="Figure 2.7: Output after using the select command&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.7: Output after using the select command</p>
			<p>Here, <strong class="source-inline">select</strong> is the command that reads from the database, and the fields <strong class="source-inline">title</strong>, <strong class="source-inline">publisher</strong>, and <strong class="source-inline">author</strong> are the columns that we intend to select from the book table. Since these are all the columns the database has, the select statement has returned all the values present in the database. The select statement is also called a SQL query. An alternate way to get all the fields in the database is by using the wildcard <strong class="source-inline">*</strong> in the select query instead of specifying all the column names explicitly:</p>
			<p class="source-code">select * from book;</p>
			<p>This will return the same output as shown in the preceding figure. Now, suppose we want to get the author name for the book titled <strong class="source-inline">The Sparrow Warrior</strong>; in this case, the <strong class="source-inline">select</strong> query would be as follows:</p>
			<p class="source-code">select author from book where title="The Sparrow Warrior";</p>
			<p>Here, we have added a special SQL keyword called <strong class="source-inline">where</strong> so that the <strong class="source-inline">select</strong> query returns only the entries that match the condition. The result of the query, of course, will be <strong class="source-inline">Patric Javagal</strong>. Now, what if we wanted to change the name of the book's publisher? </p>
			<h2 id="_idParaDest-74"><a id="_idTextAnchor076"/>SQL Update Operations</h2>
			<p>In SQL, the way to update a record in the database is by using the <strong class="source-inline">update</strong> command:</p>
			<p class="source-code">update book set publisher = 'Northside Publications' where   title='The Sparrow Warrior';</p>
			<p>Here, we are setting the value of publisher to <strong class="source-inline">Northside Publications</strong> if the value of the title is <strong class="source-inline">The Sparrow Warrior</strong>. We can then run the <strong class="source-inline">select</strong> query we ran in the SQL Read Operations section to see how the updated table looks after running the <strong class="source-inline">update</strong> command:</p>
			<div>
				<div id="_idContainer095" class="IMG---Figure">
					<img src="image/B15509_02_08.jpg" alt="Figure 2.8: Updating the value of publisher for the title The Sparrow Warrior&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.8: Updating the value of publisher for the title The Sparrow Warrior</p>
			<p>Next, what if we wanted to delete the title of the record we just updated?</p>
			<h2 id="_idParaDest-75"><a id="_idTextAnchor077"/>SQL Delete Operations</h2>
			<p>Here is an example of how to delete a record from the database using the <strong class="source-inline">delete</strong> command:</p>
			<p class="source-code">delete from book where title='The Sparrow Warrior';</p>
			<p><strong class="source-inline">delete</strong> is the SQL keyword for delete operations. Here, this operation will be performed only if the title is <strong class="source-inline">The Sparrow Warrior</strong>. Here is how the book table will look after the delete operation:</p>
			<div>
				<div id="_idContainer096" class="IMG---Figure">
					<img src="image/B15509_02_09.jpg" alt="Figure 2.9: Output after performing the delete operation&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.9: Output after performing the delete operation</p>
			<p>These are the basic operations of SQL. We will not go very deep into all the SQL commands and syntax, but feel free to explore more about database base operations using SQL.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">For further reading, you can start by exploring some advanced SQL <strong class="source-inline">select</strong> operations with <strong class="source-inline">join</strong> statements, which are used to query data across multiple tables. For a detailed course on SQL, you can refer to <em class="italic">The SQL Workshop</em> (<a href="https://www.packtpub.com/product/the-sql-workshop/9781838642358">https://www.packtpub.com/product/the-sql-workshop/9781838642358</a>). </p>
			<h2 id="_idParaDest-76"><a id="_idTextAnchor078"/>Django ORM</h2>
			<p>Web applications constantly interact with databases, and one of the ways to do so is using SQL. If you decide to write a web application without a web framework like Django and instead use Python alone, Python libraries such as <strong class="source-inline">psycopg2</strong> could be used to interact directly with the databases using SQL commands. But while developing a web application with multiple tables and fields, SQL commands can easily become overly complex and thus difficult to maintain. For this reason, popular web frameworks such as Django provide a level of abstraction using which we can easily work with databases. The part of Django that helps us do this is called <strong class="bold">ORM</strong>, which stands for <strong class="bold">Object Relational Mapping</strong>. </p>
			<p>Django ORM converts object-oriented Python code into actual database constructs such as database tables with data type definitions and facilitates all the database operations via simple Python code. Because of this, we do not have to deal with SQL commands while performing database operations. This helps in faster application development and ease in maintaining the application source code. </p>
			<p>Django supports relational databases such as SQLite, PostgreSQL, Oracle Database, and MySQL. Django's database abstraction layer ensures that the same Python/Django source code can be used across any of the above relational databases with very little modification to the project settings. Since SQLite is part of the Python libraries and Django is configured by default to SQLite, for the scope of this chapter, we shall use SQLite while we learn about Django models and migrations.</p>
			<h2 id="_idParaDest-77"><a id="_idTextAnchor079"/>Database Configuration and Creating Django Applications</h2>
			<p>As we have already seen in <em class="italic">Chapter 1</em>, <em class="italic">Introduction to Django</em>, when we create a Django project and run the Django server, the default database configuration is of SQLite3. The database configuration will be present in the project directory, in the <strong class="source-inline">settings.py</strong> file. </p>
			<p class="callout-heading">Note</p>
			<p class="callout">Make sure you go through the <strong class="source-inline">settings.py</strong> file for the <strong class="source-inline">bookr</strong> app. Going through the entire file once will help you understand the concepts that follow. You can find the file at this link: <a href="http://packt.live/2KEdaUM">http://packt.live/2KEdaUM</a>.</p>
			<p>So, for our example project, the database configuration will be present at the following location: <strong class="source-inline">bookr/settings.py</strong>. The default database configuration present in this file, when a Django project is created, is as follows:</p>
			<p class="source-code">DATABASES = {\</p>
			<p class="source-code">             'default': {\</p>
			<p class="source-code">                         'ENGINE': 'django.db.backends.sqlite3',\</p>
			<p class="source-code">                         'NAME': os.path.join\</p>
			<p class="source-code">                                 (BASE_DIR, 'db.sqlite3'),}}</p>
			<p class="callout-heading">Note</p>
			<p class="callout">The preceding code snippet uses a backslash ( \ ) to split the logic across multiple lines. When the code is executed, Python will ignore the backslash, and treat the code on the next line as a direct continuation of the current line.</p>
			<p>The DATABASES variable is assigned with a dictionary containing the database details for the project. Inside the dictionary, there is a nested dictionary with a key as default. This holds the configuration of a default database for the Django project. The reason we have a nested dictionary with <strong class="source-inline">default</strong> as a key is that a Django project could potentially interact with multiple databases, and the default database is the one used by Django for all operations unless explicitly specified. The ENGINE key represents which database engine is being used; in this case, it is <strong class="source-inline">sqlite3</strong>.</p>
			<p>The <strong class="source-inline">NAME</strong> key defines the name of the database, which can have any value. But for SQLite3, since the database is created as a file, <strong class="source-inline">NAME</strong> can have the full path of the directory where the file needs to be created. The full path of the <strong class="source-inline">db</strong> file is processed by joining (or concatenating) the previously defined path in <strong class="source-inline">BASE_DIR</strong> with <strong class="source-inline">db.sqlite3</strong>. Note that <strong class="source-inline">BASE_DIR</strong> is the project directory as already defined in the <strong class="source-inline">settings.py</strong> file.</p>
			<p>If you are using other databases, such as PostgreSQL, MySQL, and so on, changes will have to be made in the preceding database settings as shown here:</p>
			<p class="source-code">DATABASES = {\</p>
			<p class="source-code">             'default': {\</p>
			<p class="source-code">                         'ENGINE': 'django.db\</p>
			<p class="source-code">                                    .backends.postgresql',\</p>
			<p class="source-code">                         'NAME': 'bookr',\</p>
			<p class="source-code">                         'USER': &lt;username&gt;,\</p>
			<p class="source-code">                         'PASSWORD': &lt;password&gt;,\</p>
			<p class="source-code">                         'HOST': &lt;host-IP-address&gt;,\</p>
			<p class="source-code">                         'PORT': '5432',}}</p>
			<p>Here, changes have been made to <strong class="source-inline">ENGINE</strong> to use PostgreSQL. The host IP address and port number of the server need to be provided for <strong class="source-inline">HOST</strong> and <strong class="source-inline">PORT</strong> respectively. As the names suggest, <strong class="source-inline">USER</strong> is the database username and <strong class="source-inline">PASSWORD</strong> is the database password. In addition to changes in the configuration, we will have to install the database drivers or bindings along with the database host and credentials. This will be covered in detail in later chapters, but for now, since we are using SQLite3, the default configuration will be sufficient. Note that the above is just an example to show the changes you'll need to make to use a different database such as PostgreSQL, but since we are using SQLite, we shall use the database configuration that exists already, and there is no need to make any modifications to the database settings.</p>
			<h2 id="_idParaDest-78"><a id="_idTextAnchor080"/>Django Apps</h2>
			<p>A Django project can have multiple apps that often act as discrete entities. That's why, whenever required, an app can be plugged into a different Django project as well. For example, if we are developing an e-commerce web application, the web application can have multiple apps, such as a chatbot for customer support or a payment gateway to accept payments as users purchase goods from the application. These apps, if needed, can also be plugged into or reused in a different project. </p>
			<p>Django comes with the following apps enabled by default. The following is a snippet from a project's <strong class="source-inline">settings.py</strong> file:</p>
			<p class="source-code">INSTALLED_APPS = ['django.contrib.admin',\</p>
			<p class="source-code">                  'django.contrib.auth',\</p>
			<p class="source-code">                  'django.contrib.contenttypes',\</p>
			<p class="source-code">                  'django.contrib.sessions',\</p>
			<p class="source-code">                  'django.contrib.messages',\</p>
			<p class="source-code">                  'django.contrib.staticfiles',]</p>
			<p>These are a set of installed or default apps used for the admin site, authentication, content types, sessions, messaging, and an application to collect and manage static files. In the upcoming chapters, we shall study this in-depth. For the scope of this chapter, though, we shall understand why Django migration is needed for these installed apps.</p>
			<h2 id="_idParaDest-79"><a id="_idTextAnchor081"/>Django Migration</h2>
			<p>As we have learned before, Django's ORM helps make database operations simpler. A major part of the operation is to transform the Python code into database structures such as database fields with stated data types and tables. In other words, the transformation of Python code into database structures is known as <strong class="bold">migration</strong>. Instead of creating dozens of tables by running SQL queries, you would write models for them in Python, something you'll learn to do in an upcoming section titled <em class="italic">Creating Models and Migrations</em>. These models will have <strong class="bold">fields</strong>, which form the blueprints of database tables. The fields, in turn, will have different field types giving us more information about the type of data stored there (recall how we specified the data type of our field as <strong class="source-inline">TEXT</strong> in <em class="italic">step 4</em> of <em class="italic">Exercise 2.01</em>, <em class="italic">Creating a Book Database</em>).</p>
			<p>Since we have a Django project set up, let's perform our first migration. Although we have not added any code yet to our project, we can migrate the applications listed in <strong class="source-inline">INSTALLED_APPS</strong>. This is necessary because Django's installed apps need to store the relevant data in the database for their operations, and migration will create the required database tables to store the data in the database. The following command should be entered in the terminal or shell to do this:</p>
			<p class="source-code">python manage.py migrate</p>
			<p class="callout-heading">Note</p>
			<p class="callout">For macOS, you can use <strong class="source-inline">python3</strong> instead of <strong class="source-inline">python</strong> in the preceding command.</p>
			<p>Here, <strong class="source-inline">manage.py</strong> is a script that was automatically created when the project was created. It is used for carrying out managerial or administrative tasks. By executing this command, we create all the database structures required by the installed apps.</p>
			<p>As we are using DB Browser for SQLite to browse the database, let's take a look at the database for which changes have been made after executing the <strong class="source-inline">migrate</strong> command.</p>
			<p>The database file will have been created in the project directory under the name <strong class="source-inline">db.sqlite3</strong>. Open DB Browser, click <strong class="source-inline">Open Database</strong>, navigate until you find the <strong class="source-inline">db.sqlite3</strong> file, and open it. You should see a set of newly created tables created by the Django migration. It will look as follows in DB Browser:</p>
			<div>
				<div id="_idContainer097" class="IMG---Figure">
					<img src="image/B15509_02_10.jpg" alt="Figure 2.10: Contents of the db.sqlite3 file&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.10: Contents of the db.sqlite3 file</p>
			<p>Now, if we browse through the newly created database structure by clicking the database tables, we see the following:</p>
			<div>
				<div id="_idContainer098" class="IMG---Figure">
					<img src="image/B15509_02_11.jpg" alt="Figure 2.11: Browsing through the newly created database structure&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.11: Browsing through the newly created database structure</p>
			<p>Notice that the database tables created have different fields, each with their respective data types. Click the <strong class="source-inline">Browse data</strong> tab in DB Browser and select a table from the dropdown. For instance, after clicking the <strong class="source-inline">auth_group_permissions</strong> table, you should see something like this:</p>
			<div>
				<div id="_idContainer099" class="IMG---Figure">
					<img src="image/B15509_02_12.jpg" alt="Figure 2.12: Viewing the auth_group_permissions table&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.12: Viewing the auth_group_permissions table</p>
			<p>You will see that there is no data available for these tables yet because Django migration only creates the database structure or the blueprint, and the actual data in the database is stored during the operation of the application. Now since we have migrated the built-in or default Django apps, let's try to create an app and perform a Django migration.</p>
			<h2 id="_idParaDest-80"><a id="_idTextAnchor082"/>Creating Django Models and Migrations</h2>
			<p>A Django model is essentially a Python class that holds the blueprint for creating a table in a database. The <strong class="source-inline">models.py</strong> file can have many such models, and each model transforms into a database table. The attributes of the class form the fields and relationships of the database table as per the model definitions.</p>
			<p>For our reviews application, we need to create the following models and their database tables consequently: </p>
			<ul>
				<li>Book: This should store information about books.</li>
				<li>Contributor: This should store information about the person(s) who contributed to writing the book, such as author, co-author, or editor.</li>
				<li>Publisher: As the name implies, this refers to the book publisher.</li>
				<li>Review: This should store all the books' reviews written by the users of the application.</li>
			</ul>
			<p>Every book in our application will need to have a publisher, so let's create <strong class="source-inline">Publisher</strong> as our first model. Enter the following code in <strong class="source-inline">reviews/models.py</strong>:</p>
			<p class="source-code">from django.db import models</p>
			<p class="source-code">class Publisher(models.Model):</p>
			<p class="source-code">    """A company that publishes books."""</p>
			<p class="source-code">    name = models.CharField\</p>
			<p class="source-code">           (max_length=50, \</p>
			<p class="source-code">            help_text="The name of the Publisher.")</p>
			<p class="source-code">    website = models.URLField\</p>
			<p class="source-code">              (help_text="The Publisher's website.")</p>
			<p class="source-code">    email = models.EmailField\</p>
			<p class="source-code">            (help_text="The Publisher's email address.")</p>
			<p class="callout-heading">Note</p>
			<p class="callout">You can take a look at the complete models.py file for the bookr app by clicking the following link: <a href="http://packt.live/3hmFQxn">http://packt.live/3hmFQxn</a>.</p>
			<p>The first line of code imports the Django's <strong class="source-inline">models</strong> module. While this line will be autogenerated at the time of the creation of the Django app, do make sure you add it if it is not present. Following the import, the rest of the code is defining a class named <strong class="source-inline">Publisher</strong>, which will be a subclass of Django's <strong class="source-inline">models.Model</strong>. Furthermore, this class will have attributes or fields such as name, website, and email. </p>
			<h2 id="_idParaDest-81"><a id="_idTextAnchor083"/>Field Types</h2>
			<p>As we can see, each of these fields is defined to have the following types:</p>
			<ul>
				<li><strong class="source-inline">CharField</strong>: This field type is used to store shorter string fields, for example, Packt Publishing. For very large strings, we use <strong class="source-inline">TextField</strong>.</li>
				<li><strong class="source-inline">EmailField</strong>: This is similar to <strong class="source-inline">CharField</strong>, but validates whether the string represents a valid email address, for example, customersupport@packtpub.com.</li>
				<li><strong class="source-inline">URLField</strong>: This is again similar to <strong class="source-inline">CharField</strong>, but validates whether the string represents a valid URL, for example, <a href="https://www.packtpub.com">https://www.packtpub.com</a>.</li>
			</ul>
			<h2 id="_idParaDest-82"><a id="_idTextAnchor084"/>Field Options</h2>
			<p>Django provides a way to define field options to a model's field. These field options are used to set a value or a constraint, and so on. For example, we can set a default value for a field using <strong class="source-inline">default=&lt;value&gt;</strong>, to ensure that every time a record is created in the database for the field, it is set to a default value specified by us. Following are the two field options that we have used while defining the <strong class="source-inline">Publisher</strong> model:</p>
			<ul>
				<li><strong class="source-inline">help_text</strong>: This is a field option that helps us add descriptive text for a field that gets automatically included for Django forms.</li>
				<li><strong class="source-inline">max_length</strong>: This option is provided to <strong class="source-inline">CharField</strong> where it defines the maximum length of the field in terms of the number of characters. </li>
			</ul>
			<p>Django has many more field types and field options that can be explored from the extensive official Django documentation. As we go about developing our sample book review application, we shall learn about those types and fields that are used for the project. Now let's migrate the Django models into the database. Execute the following command in the shell or terminal to do that (run it from the folder where your <strong class="source-inline">manage.py</strong> file is stored):</p>
			<p class="source-code">python manage.py makemigrations reviews</p>
			<p>The output of the command looks like this:</p>
			<p class="source-code">Migrations for 'reviews':</p>
			<p class="source-code">  reviews/migrations/0001_initial.py</p>
			<p class="source-code">    - Create model Publisher</p>
			<p>The <strong class="source-inline">makemigrations &lt;appname&gt;</strong> command creates the migration scripts for the given app; in this case, for the reviews app. Notice that after running makemigrations, there is a new file created under the <strong class="source-inline">migrations</strong> folder: </p>
			<div>
				<div id="_idContainer100" class="IMG---Figure">
					<img src="image/B15509_02_13.jpg" alt="Figure 2.13: New file under the migrations folder&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.13: New file under the migrations folder</p>
			<p>This is the migration script created by Django. When we run <strong class="source-inline">makemigrations</strong> without the app name, the migration scripts will be created for all the apps in the project. Next, let's list the project migration status. Remember that earlier, we applied migrations to Django's installed apps and now we have created a new app, reviews. The following command, when run in the shell or terminal, will show the status of model migrations throughout the project (run it from the folder where your <strong class="source-inline">manage.py</strong> file is stored):</p>
			<p class="source-code">python manage.py showmigrations</p>
			<p>The output for the preceding command is as follows:</p>
			<p class="source-code">admin</p>
			<p class="source-code"> [X] 0001_initial</p>
			<p class="source-code"> [X] 0002_logentry_remove_auto_add</p>
			<p class="source-code"> [X] 0003_logentry_add_action_flag_choices</p>
			<p class="source-code">auth</p>
			<p class="source-code"> [X] 0001_initial</p>
			<p class="source-code"> [X] 0002_alter_permission_name_max_length</p>
			<p class="source-code"> [X] 0003_alter_user_email_max_length</p>
			<p class="source-code"> [X] 0004_alter_user_username_opts</p>
			<p class="source-code"> [X] 0005_alter_user_last_login_null</p>
			<p class="source-code"> [X] 0006_require_contenttypes_0002</p>
			<p class="source-code"> [X] 0007_alter_validators_add_error_messages</p>
			<p class="source-code"> [X] 0008_alter_user_username_max_length</p>
			<p class="source-code"> [X] 0009_alter_user_last_name_max_length</p>
			<p class="source-code"> [X] 0010_alter_group_name_max_length</p>
			<p class="source-code"> [X] 0011_update_proxy_permissions</p>
			<p class="source-code">contenttypes</p>
			<p class="source-code"> [X] 0001_initial</p>
			<p class="source-code"> [X] 0002_remove_content_type_name</p>
			<p class="source-code">reviews</p>
			<p class="source-code"> [ ] 0001_initial</p>
			<p class="source-code">sessions</p>
			<p class="source-code"> [X] 0001_initial</p>
			<p>Here, the <strong class="source-inline">[X]</strong> mark indicates that the migrations have been applied. Notice the difference that all the other apps' migrations have applied except that of reviews. The <strong class="source-inline">showmigrations</strong> command can be executed to understand the migration status, but this is not a mandatory step while performing model migrations. </p>
			<p>Next, let's understand how Django transforms a model into an actual database table. This can be understood by running the <strong class="source-inline">sqlmigrate</strong> command:</p>
			<p class="source-code">python manage.py sqlmigrate reviews 0001_initial </p>
			<p>We should see the following output:</p>
			<p class="source-code">BEGIN;</p>
			<p class="source-code">--</p>
			<p class="source-code">-- Create model Publisher</p>
			<p class="source-code">--</p>
			<p class="source-code">CREATE TABLE "reviews_publisher" ("id" integer \</p>
			<p class="source-code">    NOT NULL PRIMARY KEY AUTOINCREMENT, "name" \</p>
			<p class="source-code">    varchar(50) NOT NULL, "website" varchar(200) \</p>
			<p class="source-code">    NOT NULL, "email" varchar(254) NOT NULL);</p>
			<p class="source-code">COMMIT;</p>
			<p>The preceding snippet shows the SQL command equivalent used when Django migrates the database. In this case, we are creating the <strong class="source-inline">reviews_publisher</strong> table with the fields name, website, and email with the defined field types. Furthermore, all these fields are defined to be <strong class="source-inline">NOT NULL</strong>, implying that the entries for these fields cannot be null and should have some value. The <strong class="source-inline">sqlmigrate</strong> command is not a mandatory step while doing the model migrations.</p>
			<h2 id="_idParaDest-83"><a id="_idTextAnchor085"/>Primary Keys</h2>
			<p>Let's assume that a database table called users, as its name suggests, stores information about users. Let's say it has more than 1,000 records and there are at least 3 users with the same name, Joe Burns. How do we uniquely identify these users from the application? The solution is to have a way to uniquely identify each record in the database. This is done using <strong class="bold">Primary Keys</strong>. A primary key is unique for a database table, and as a rule, a table cannot have two rows with the same primary key. In Django, when the primary key is not explicitly mentioned in the database models, Django automatically creates <strong class="source-inline">id</strong> as the primary key (of type integer), which auto increments as new records are created. </p>
			<p>In the previous section, notice the output of the <strong class="source-inline">python manage.py sqlmigrate</strong> command. While creating the <strong class="source-inline">Publisher</strong> table, the <strong class="source-inline">SQL CREATE TABLE</strong> command was adding one more field called <strong class="source-inline">id</strong> to the table. <strong class="source-inline">id</strong> is defined to be <strong class="source-inline">PRIMARY KEY AUTOINCREMENT</strong>. In relational databases, a primary key is used to uniquely identify an entry in the database. For example, the book table has <strong class="source-inline">id</strong> as the primary key, which has numbers starting from 1. This value increments by 1 as new records are created. The integer value of <strong class="source-inline">id</strong> is always unique across the book table. Since the migration script has already been created by executing makemigrations, let's now migrate the newly created model in the reviews app by executing the following command:</p>
			<p class="source-code">python manage.py migrate reviews</p>
			<p>You should get the following output:</p>
			<p class="source-code">Operations to perform:</p>
			<p class="source-code">    Apply all migrations: reviews</p>
			<p class="source-code">Running migrations:</p>
			<p class="source-code">    Applying reviews.0001_initial... OK</p>
			<p>This operation creates the database table for the reviews app. The following is a snippet from DB Browser indicating the new table <strong class="source-inline">reviews_publisher</strong> has been created in the database:</p>
			<div>
				<div id="_idContainer101" class="IMG---Figure">
					<img src="image/B15509_02_14.jpg" alt="Figure 2.14: reviews_publisher table created after executing the migration command&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.14: reviews_publisher table created after executing the migration command</p>
			<p>So far, we have explored how to create a model and migrate it into the database. Let's now work on creating the rest of the models for our book review application. As we've already seen, the application will have the following database tables:</p>
			<ul>
				<li><strong class="source-inline">Book</strong>: This is the database table that holds the information about the book itself. We have already created a <strong class="source-inline">Book</strong> model and have migrated this to the database.</li>
				<li><strong class="source-inline">Publisher</strong>: This table holds information about the book publisher.</li>
				<li><strong class="source-inline">Contributor</strong>: This table holds information about the contributor, that is, the author, co-author, or editor.</li>
				<li><strong class="source-inline">Review</strong>: This table holds information about the review comments posted by the reviewers.</li>
			</ul>
			<p>Let's add the <strong class="source-inline">Book</strong> and <strong class="source-inline">Contributor</strong> models, as shown in the following code snippet, into <strong class="source-inline">reviews/models.py</strong>:</p>
			<p class="source-code">class Book(models.Model):</p>
			<p class="source-code">    """A published book."""</p>
			<p class="source-code">    title = models.CharField\</p>
			<p class="source-code">            (max_length=70, \</p>
			<p class="source-code">             help_text="The title of the book.")</p>
			<p class="source-code">    publication_date = models.DateField\</p>
			<p class="source-code">                       (verbose_name=\</p>
			<p class="source-code">                        "Date the book was published.")</p>
			<p class="source-code">    isbn = models.CharField\</p>
			<p class="source-code">           (max_length=20, \</p>
			<p class="source-code">            verbose_name="ISBN number of the book.")</p>
			<p class="source-code">class Contributor(models.Model):</p>
			<p class="source-code">"""</p>
			<p class="source-code">A contributor to a Book, e.g. author, editor, \</p>
			<p class="source-code">co-author.</p>
			<p class="source-code">"""</p>
			<p class="source-code">  first_names = models.CharField\</p>
			<p class="source-code">                (max_length=50, \</p>
			<p class="source-code">                 help_text=\</p>
			<p class="source-code">                 "The contributor's first name or names.")</p>
			<p class="source-code">    last_names = models.CharField\</p>
			<p class="source-code">                 (max_length=50, \</p>
			<p class="source-code">                  help_text=\</p>
			<p class="source-code">                  "The contributor's last name or names.")</p>
			<p class="source-code">    email = models.EmailField\</p>
			<p class="source-code">            (help_text="The contact email for the contributor.")</p>
			<p>The code is self-explanatory. The <strong class="source-inline">Book</strong> model has the fields title, publication_date, and isbn. The <strong class="source-inline">Contributor</strong> model has the fields <strong class="source-inline">first_names</strong> and <strong class="source-inline">last_names</strong> fields and the email ID of the contributor. There are some newly added models as well, apart from the ones we have seen in the Publisher model. They have <strong class="source-inline">DateField</strong> as a new field type, which, as the name suggests, is used to store a date. A new field option called <strong class="source-inline">verbose_name</strong> is also used. It provides a descriptive name for the field.</p>
			<h1 id="_idParaDest-84"><a id="_idTextAnchor086"/>Relationships</h1>
			<p>One of the powers of relational databases is the ability to establish relationships between data stored across database tables. Relationships help maintain data integrity by establishing the correct references across tables, which in turn helps maintain the database. Relationship rules, on the other hand, ensure data consistency and prevent duplicates. </p>
			<p>In a relational database, there can be the following types of relations:</p>
			<ul>
				<li>Many to one</li>
				<li>Many to many</li>
				<li>One to one</li>
			</ul>
			<p>Let's explore each relationship in detail. </p>
			<h2 id="_idParaDest-85"><a id="_idTextAnchor087"/>Many to One</h2>
			<p>In this relationship, many records (rows/entries) from one table can refer to one record (row/entry) in another table. For example, there can be many books produced by one publisher. This is a case of a many-to-one relationship. To establish this relationship, we need to use the database's foreign keys. A foreign key in a relational database establishes the relationship between a field from one table and a primary key from a different table.</p>
			<p>For example, say you have data about employees belonging to different departments stored in a table called <strong class="source-inline">employee_info</strong> with their employee ID as the primary key alongside a column that stores their department name; this table also contains a column that stores that department's department ID. Now, there's another table called <strong class="source-inline">departments_info</strong>, which has department ID as the primary key. In this case, then, the department ID is a foreign key in the <strong class="source-inline">employee_info</strong> table.</p>
			<p>In our <strong class="source-inline">bookr</strong> app, the <strong class="source-inline">Book</strong> model can have a foreign key referring to the primary key of the <strong class="source-inline">Publisher</strong> table. Since we have already created the models for <strong class="source-inline">Book</strong>, <strong class="source-inline">Contributor</strong>, and <strong class="source-inline">Publisher</strong>, now let's establish a many-to-one relationship across the <strong class="source-inline">Book</strong> and <strong class="source-inline">Publisher</strong> models. For the <strong class="source-inline">Book</strong> model, add the last line:</p>
			<p class="source-code">class Book(models.Model):</p>
			<p class="source-code">    """A published book."""</p>
			<p class="source-code">    title = models.CharField\</p>
			<p class="source-code">            (max_length=70, \</p>
			<p class="source-code">             help_text="The title of the book.")</p>
			<p class="source-code">    publication_date = models.DateField\</p>
			<p class="source-code">                       (verbose_name=\</p>
			<p class="source-code">                        "Date the book was published.")</p>
			<p class="source-code">    isbn = models.CharField\</p>
			<p class="source-code">           (max_length=20, \</p>
			<p class="source-code">            verbose_name="ISBN number of the book.")</p>
			<p class="source-code">    publisher = models.ForeignKey\</p>
			<p class="source-code">                (Publisher, on_delete=models.CASCADE)</p>
			<p>Now the newly added <strong class="source-inline">publisher</strong> field is establishing a many-to-one relationship between <strong class="source-inline">Book</strong> and <strong class="source-inline">Publisher</strong> using a foreign key. This relationship ensures the nature of a many-to-one relationship, which is that many books can have one publisher:</p>
			<ul>
				<li><strong class="source-inline">models.ForeignKey</strong>: This is the field option to establish a many-to-one relationship.</li>
				<li><strong class="source-inline">Publisher</strong>: When we establish relationships with different tables in Django, we refer to the model that creates the table; in this case, the <strong class="source-inline">Publisher</strong> table is created by the <strong class="source-inline">Publisher</strong> model (or the Python class Publisher).</li>
				<li><strong class="source-inline">on_delete</strong>: This is a field option that determines the action to be taken upon the deletion of the referenced object. In this case, the <strong class="source-inline">on_delete</strong> option is set to <strong class="source-inline">CASCADE(models.CASCADE)</strong>, which deletes the referenced objects. </li>
			</ul>
			<p>For example, assume a publisher has published a set of books. For some reason, if the publisher has to be deleted from the application, the next action is CASCADE, which means delete all the referenced books from the application. There are many more <strong class="source-inline">on_delete</strong> actions, such as the following:</p>
			<ul>
				<li><strong class="source-inline">PROTECT</strong>: This prevents the deletion of the record unless all the referenced objects are deleted.</li>
				<li><strong class="source-inline">SET_NULL</strong>: This sets a null value if the database field has been previously configured to store null values.</li>
				<li><strong class="source-inline">SET_DEFAULT</strong>: Sets to a default value on the deletion of the referenced object.</li>
			</ul>
			<p>For our book review application, we will be using only the CASCADE option.</p>
			<h1 id="_idParaDest-86"><a id="_idTextAnchor088"/>Many to Many</h1>
			<p>In this relationship, multiple records in a table can have a relationship with multiple records in a different table. For example, a book can have multiple co-authors and each author (contributor) could have written multiple books. So, this forms a many-to-many relationship between the <strong class="source-inline">Book</strong> and <strong class="source-inline">Contributor</strong> tables:</p>
			<div>
				<div id="_idContainer102" class="IMG---Figure">
					<img src="image/B15509_02_15.jpg" alt="Figure 2.15: Many-to-many relationship between books and co-authors&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.15: Many-to-many relationship between books and co-authors</p>
			<p>In <strong class="source-inline">models.py</strong>, for the Book model, add the last line as shown here:</p>
			<p class="source-code">class Book(models.Model):</p>
			<p class="source-code">    """A published book."""</p>
			<p class="source-code">    title = models.CharField\</p>
			<p class="source-code">            (max_length=70, \</p>
			<p class="source-code">             help_text="The title of the book.")</p>
			<p class="source-code">    publication_date = models.DateField\</p>
			<p class="source-code">                       (verbose_name=\</p>
			<p class="source-code">                        "Date the book was published.")</p>
			<p class="source-code">    isbn = models.CharField\</p>
			<p class="source-code">           (max_length=20, \</p>
			<p class="source-code">            verbose_name="ISBN number of the book.")</p>
			<p class="source-code">    publisher = models.ForeignKey\</p>
			<p class="source-code">                (Publisher, on_delete=models.CASCADE)</p>
			<p class="source-code">    contributors = models.ManyToManyField\</p>
			<p class="source-code">                   ('Contributor', through="BookContributor")</p>
			<p>The newly added contributors field establishes a many-to-many relationship with Book and Contributor using the ManyToManyField field type:</p>
			<ul>
				<li><strong class="source-inline">models.ManyToManyField</strong>: This is the field type to establish a many-to-many relationship.</li>
				<li><strong class="source-inline">through</strong>: This is a special field option for many-to-many relationships. When we have a many-to-many relationship across two tables, if we want to store some extra information about the relationship, then we can use this to establish the relationship via an intermediary table.</li>
			</ul>
			<p>For example, we have two tables, namely <strong class="source-inline">Book</strong> and <strong class="source-inline">Contributor</strong>, where we need to store the information on the type of contributor for the book, such as Author, Co-author, or Editor. Then the type of contributor is stored in an intermediary table called <strong class="source-inline">BookContributor</strong>. Here is how the <strong class="source-inline">BookContributor</strong> table/model looks. Make sure you include this model in <strong class="source-inline">reviews/models.py</strong>:</p>
			<p class="source-code">class BookContributor(models.Model):</p>
			<p class="source-code">    class ContributionRole(models.TextChoices):</p>
			<p class="source-code">        AUTHOR = "AUTHOR", "Author"</p>
			<p class="source-code">        CO_AUTHOR = "CO_AUTHOR", "Co-Author"</p>
			<p class="source-code">        EDITOR = "EDITOR", "Editor"</p>
			<p class="source-code">    book = models.ForeignKey\</p>
			<p class="source-code">           (Book, on_delete=models.CASCADE)</p>
			<p class="source-code">    contributor = models.ForeignKey\</p>
			<p class="source-code">                  (Contributor, \</p>
			<p class="source-code">                   on_delete=models.CASCADE)</p>
			<p class="source-code">    role = models.CharField\</p>
			<p class="source-code">           (verbose_name=\</p>
			<p class="source-code">            "The role this contributor had in the book.", \</p>
			<p class="source-code">            choices=ContributionRole.choices, max_length=20)</p>
			<p class="callout-heading">Note</p>
			<p class="callout">The complete <strong class="source-inline">models.py</strong> file can be viewed at this link: <a href="http://packt.live/3hmFQxn">http://packt.live/3hmFQxn</a>.</p>
			<p>An intermediary table such as <strong class="source-inline">BookContributor</strong> establishes relationships by using foreign keys to both the <strong class="source-inline">Book</strong> and <strong class="source-inline">Contributor</strong> tables. It can also have extra fields that can store information about the relationship the <strong class="source-inline">BookContributor</strong> model has with the following fields:</p>
			<ul>
				<li><strong class="source-inline">book</strong>: This is a foreign key to the <strong class="source-inline">Book</strong> model. As we saw previously, <strong class="source-inline">on_delete=models.CASCADE</strong> will delete an entry from the relationship table when the relevant book is deleted from the application.</li>
				<li><strong class="source-inline">Contributor</strong>: This is again a foreign key to the <strong class="source-inline">Contributor</strong> model/table. This is also defined as <strong class="source-inline">CASCADE</strong> upon deletion.</li>
				<li><strong class="source-inline">role</strong>: This is the field of the intermediary model, which stores the extra information about the relationship between <strong class="source-inline">Book</strong> and <strong class="source-inline">Contributor</strong>.</li>
				<li><strong class="source-inline">class ContributionRole(models.TextChoices)</strong>: This can be used to define a set of choices by creating a subclass of <strong class="source-inline">models.TextChoices</strong>. For example, <strong class="source-inline">ContributionRole</strong> is a subclass created out of <strong class="source-inline">TextChoices</strong>, which is used by the roles field to define Author, Co-Author, and Editor as a set of choices.</li>
				<li><strong class="source-inline">choices</strong>: This refers to a set of choices defined in the models, and they are useful when creating Django <strong class="source-inline">Forms</strong> using the models.<p class="callout-heading">Note</p><p class="callout">When the through field option is not provided while establishing a many-to-many relationship, Django automatically creates an intermediary table to manage the relationship.</p></li>
			</ul>
			<h2 id="_idParaDest-87"><a id="_idTextAnchor089"/>One-to-One Relationships</h2>
			<p>In this relationship, one record in a table will have a reference to only one record in a different table. For example, a person can have only one driver's license, so a person to their driver's license could form a one-to-one relationship:</p>
			<div>
				<div id="_idContainer103" class="IMG---Figure">
					<img src="image/B15509_02_16.jpg" alt="Figure 2.16: Example of a one-to-one relationship&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.16: Example of a one-to-one relationship</p>
			<p>The OneToOneField can be used to establish a one-to-one relationship, as shown here:</p>
			<p class="source-code">class DriverLicence(models.Model):</p>
			<p class="source-code">    person = models.OneToOneField\</p>
			<p class="source-code">             (Person, on_delete=models.CASCADE)</p>
			<p class="source-code">    licence_number = models.CharField(max_length=50)</p>
			<p>Now that we have explored database relationships, let's come back to our bookr application and add one more model there.</p>
			<h2 id="_idParaDest-88"><a id="_idTextAnchor090"/>Adding the Review Model</h2>
			<p>We've already added the <strong class="source-inline">Book</strong> and <strong class="source-inline">Publisher</strong> models to the <strong class="source-inline">reviews/models.py</strong> file. The last model that we are going to add is the <strong class="source-inline">Review</strong> model. The following code snippet should help us do this:</p>
			<p class="source-code">from django.contrib import auth</p>
			<p class="source-code">class Review(models.Model):</p>
			<p class="source-code">    content = models.TextField\</p>
			<p class="source-code">              (help_text="The Review text.")</p>
			<p class="source-code">    rating = models.IntegerField\</p>
			<p class="source-code">             (help_text="The rating the reviewer has given.")</p>
			<p class="source-code">    date_created = models.DateTimeField\</p>
			<p class="source-code">                   (auto_now_add=True, \</p>
			<p class="source-code">                    help_text=\</p>
			<p class="source-code">                    "The date and time the review was created.")</p>
			<p class="source-code">    date_edited = models.DateTimeField\</p>
			<p class="source-code">                  (null=True, \</p>
			<p class="source-code">                   help_text=\</p>
			<p class="source-code">                   "The date and time the review was last edited.")</p>
			<p class="source-code">    creator = models.ForeignKey\</p>
			<p class="source-code">              (auth.get_user_model(), on_delete=models.CASCADE)</p>
			<p class="source-code">    book = models.ForeignKey\</p>
			<p class="source-code">           (Book, on_delete=models.CASCADE, \</p>
			<p class="source-code">            help_text="The Book that this review is for.")</p>
			<p class="callout-heading">Note</p>
			<p class="callout">The complete <strong class="source-inline">models.py</strong> file can be viewed at this link: <a href="http://packt.live/3hmFQxn">http://packt.live/3hmFQxn</a>.</p>
			<p>The <strong class="source-inline">review</strong> model/table will be used to store user-provided review comments and ratings for books. It has the following fields:</p>
			<ul>
				<li><strong class="source-inline">content</strong>: This field stores the text for a book review, hence the field type used is <strong class="source-inline">TextField</strong> as this can store a large amount of text.</li>
				<li><strong class="source-inline">rating</strong>: This field stores the review rating of a book. Since the rating is going to be an integer, the field type used is <strong class="source-inline">IntegerField</strong>.</li>
				<li><strong class="source-inline">date_created</strong>: This field stores the time and date when the review was written, hence the field type is <strong class="source-inline">DateTimeField</strong>.</li>
				<li><strong class="source-inline">date_edited</strong>: This field stores the date and time whenever a review is edited. The field type is again <strong class="source-inline">DateTimeField</strong>.</li>
				<li><strong class="source-inline">Creator</strong>: This field specifies the review creator or the person who writes the book review. Notice that this is a foreign key to <strong class="source-inline">auth.get_user_model()</strong>, which is referring to the <strong class="source-inline">User</strong> model from Django's built-in authentication module. It has a field option <strong class="source-inline">on_delete=models.CASCADE</strong>. This explains that when a user is deleted from the database, all the reviews written by that user will be deleted.</li>
				<li><strong class="source-inline">Book</strong>: Reviews have a field called <strong class="source-inline">book</strong>, which is a foreign key to the <strong class="source-inline">Book</strong> model. This is because for a book review application, reviews have to be written, and a book can have many reviews, so this is a many-to-one relationship. This is also defined with a field option, <strong class="source-inline">on_delete=models.CASCADE</strong>, because once the book is deleted, there is no point in retaining the reviews in the application. So, when a book is deleted, all the reviews referring to the book will also get deleted.</li>
			</ul>
			<h2 id="_idParaDest-89"><a id="_idTextAnchor091"/>Model Methods</h2>
			<p>In Django, we can write methods inside a model class. These are called <strong class="bold">model methods</strong> and they can be custom methods or special methods that override the default methods of Django models. One such method is <strong class="source-inline">__str__()</strong>. This method returns the string representation of the <strong class="source-inline">Model</strong> instances and can be especially useful while using the Django shell. In the following example, where the <strong class="source-inline">__str__()</strong> method is added to the <strong class="source-inline">Publisher</strong> model, the string representation of the <strong class="source-inline">Publisher</strong> object will be the publisher's name:</p>
			<p class="source-code">class Publisher(models.Model):</p>
			<p class="source-code">    """A company that publishes books."""</p>
			<p class="source-code">    name = models.CharField\</p>
			<p class="source-code">           (max_length=50, \</p>
			<p class="source-code">            help_text="The name of the Publisher.")</p>
			<p class="source-code">    website = models.URLField\</p>
			<p class="source-code">              (help_text="The Publisher's website.")</p>
			<p class="source-code">    email = models.EmailField\</p>
			<p class="source-code">            (help_text="The Publisher's email address.")</p>
			<p class="source-code">    def __str__(self):</p>
			<p class="source-code">        return self.name</p>
			<p>Add the <strong class="source-inline">_str_()</strong> methods to <strong class="source-inline">Contributor</strong> and <strong class="source-inline">Book</strong> as well, as follows:</p>
			<p class="source-code">class Book(models.Model):</p>
			<p class="source-code">    """A published book."""</p>
			<p class="source-code">    title = models.CharField\</p>
			<p class="source-code">            (max_length=70, \</p>
			<p class="source-code">             help_text="The title of the book.")</p>
			<p class="source-code">    publication_date = models.DateField\</p>
			<p class="source-code">                       (verbose_name=\</p>
			<p class="source-code">                        "Date the book was published.")</p>
			<p class="source-code">    isbn = models.CharField\</p>
			<p class="source-code">           (max_length=20, \</p>
			<p class="source-code">            verbose_name="ISBN number of the book.")</p>
			<p class="source-code">    publisher = models.ForeignKey\</p>
			<p class="source-code">                (Publisher, \</p>
			<p class="source-code">                 on_delete=models.CASCADE)</p>
			<p class="source-code">    contributors = models.ManyToManyField\</p>
			<p class="source-code">                   ('Contributor', through="BookContributor")</p>
			<p class="source-code">    def __str__(self):</p>
			<p class="source-code">        return self.title</p>
			<p class="source-code">class Contributor(models.Model):</p>
			<p class="source-code">"""</p>
			<p class="source-code">A contributor to a Book, e.g. author, editor, \</p>
			<p class="source-code">co-author.</p>
			<p class="source-code">"""</p>
			<p class="source-code">    first_names = models.CharField\</p>
			<p class="source-code">                  (max_length=50, \</p>
			<p class="source-code">                   help_text=\</p>
			<p class="source-code">                   "The contributor's first name or names.")</p>
			<p class="source-code">    last_names = models.CharField\</p>
			<p class="source-code">                 (max_length=50, \</p>
			<p class="source-code">                  help_text=\</p>
			<p class="source-code">                  "The contributor's last name or names.")</p>
			<p class="source-code">    email = models.EmailField\</p>
			<p class="source-code">            (help_text=\</p>
			<p class="source-code">             "The contact email for the contributor.")</p>
			<p class="source-code">    def __str__(self):</p>
			<p class="source-code">        return self.first_names</p>
			<h2 id="_idParaDest-90"><a id="_idTextAnchor092"/>Migrating the Reviews App</h2>
			<p>Since we have the entire model file ready, let's now migrate the models into the database, similar to what we did before with the installed apps. Since the reviews app has a set of models created by us, before running the migration, it is important to create the migration scripts. Migration scripts help in identifying any changes to the models and will propagate these changes into the database while running the migration. Execute the following command to create the migration scripts:</p>
			<p class="source-code">python manage.py makemigrations reviews</p>
			<p>You should get an output similar to this:</p>
			<p class="source-code">  reviews/migrations/0002_auto_20191007_0112.py</p>
			<p class="source-code">    - Create model Book</p>
			<p class="source-code">    - Create model Contributor</p>
			<p class="source-code">    - Create model Review</p>
			<p class="source-code">    - Create model BookContributor</p>
			<p class="source-code">    - Add field contributors to book</p>
			<p class="source-code">    - Add field publisher to book</p>
			<p>Migration scripts will be created in a folder named <strong class="source-inline">migrations</strong> in the application folder. Next, migrate all the models into the database using the <strong class="source-inline">migrate</strong> command:</p>
			<p class="source-code">python manage.py migrate reviews</p>
			<p>You should see the following output:</p>
			<p class="source-code">Operations to perform:</p>
			<p class="source-code">  Apply all migrations: reviews</p>
			<p class="source-code">Running migrations:</p>
			<p class="source-code">  Applying reviews.0002_auto_20191007_0112... OK</p>
			<p>After executing this command, we have successfully created the database tables defined in the <strong class="source-inline">reviews</strong> app. You may use DB Browser for SQLite to explore the tables you have just created after the migration. To do so, open DB Browser for SQLite, click the <strong class="source-inline">Open</strong> <strong class="source-inline">Database</strong> button (<em class="italic">Figure 2.17</em>), and navigate to your project directory: </p>
			<p> </p>
			<div>
				<div id="_idContainer104" class="IMG---Figure">
					<img src="image/B15509_02_17.jpg" alt="Figure 2.17: Click the Open Database button&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.17: Click the Open Database button</p>
			<p>Select the database file named <strong class="source-inline">db.sqlite3</strong> to open it (<em class="italic">Figure 2.18</em>). </p>
			<div>
				<div id="_idContainer105" class="IMG---Figure">
					<img src="image/B15509_02_18.jpg" alt="Figure 2.18: Locating db.sqlite3 in the bookr directory &#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.18: Locating db.sqlite3 in the bookr directory </p>
			<p>You should now be able to browse the new sets of tables created. The following figure shows the database tables defined in the <strong class="source-inline">reviews</strong> app:</p>
			<div>
				<div id="_idContainer106" class="IMG---Figure">
					<img src="image/B15509_02_19.jpg" alt="Figure 2.19: Database tables as defined in the reviews app&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.19: Database tables as defined in the reviews app</p>
			<h1 id="_idParaDest-91"><a id="_idTextAnchor093"/>Django's Database CRUD Operations</h1>
			<p>As we have created the necessary database tables for the book review application, let's work on understanding the basic database operations with Django.</p>
			<p>We've already briefly touched on database operations using SQL statements in the section titled <em class="italic">SQL CRUD Operations</em>. We tried creating an entry into the database using the <strong class="source-inline">Insert</strong> statement, read from the database using the <strong class="source-inline">select</strong> statement, updated an entry using the <strong class="source-inline">update</strong> statement, and deleted an entry from the database using the <strong class="source-inline">delete</strong> statement. </p>
			<p>Django's ORM provides the same functionality without having to deal with the SQL statements. Django's database operations are simple Python code, hence we overcome the hassle of maintaining SQL statements among the Python code. Let's take a look at how these are performed. </p>
			<p>To execute the CRUD operations, we will enter Django's command-line shell by executing the following command:</p>
			<p class="source-code">python manage.py shell</p>
			<p class="callout-heading">Note</p>
			<p class="callout">For this chapter, we will designate Django shell commands using the <strong class="source-inline">&gt;&gt;&gt;</strong> notation (highlighted) at the start of the code block. While pasting the query into DB Browser, make sure you exclude this notation every time. </p>
			<p>When the interactive console starts, it looks as follows:</p>
			<p class="source-code">Type "help", "copyright", "credits" or "license" for more information.</p>
			<p class="source-code">(InteractiveConsole)</p>
			<p class="source-code"><strong class="bold">&gt;&gt;&gt; </strong></p>
			<h2 id="_idParaDest-92"><a id="_idTextAnchor094"/>Exercise 2.02: Creating an Entry in the Bookr Database</h2>
			<p>In this exercise, you will create a new entry in the database by saving a model instance. In other words, you will create an entry in a database table without explicitly running a SQL query:</p>
			<ol>
				<li value="1">First, import the <strong class="source-inline">Publisher</strong> class/model from <strong class="source-inline">reviews.models</strong>:<p class="source-code">&gt;&gt;&gt;from reviews.models import Publisher</p></li>
				<li>Create an object or an instance of the <strong class="source-inline">Publisher</strong> class by passing all the field values (name, website, and email) required by the <strong class="source-inline">Publisher</strong> model:<p class="source-code">&gt;&gt;&gt;publisher = Publisher(name='Packt Publishing', website='https://www.packtpub.com', email='info@packtpub.com')</p></li>
				<li>Next, to write the object into the database, it is important to call the <strong class="source-inline">save()</strong> method, because until this is called there will not be an entry created in the database:<p class="source-code">&gt;&gt;&gt;publisher.save()</p><p>Now you can see a new entry created in the database using DB Browser: </p><div id="_idContainer107" class="IMG---Figure"><img src="image/B15509_02_20.jpg" alt="Figure 2.20: Entry created in the database&#13;&#10;"/></div><p class="figure-caption">Figure 2.20: Entry created in the database</p></li>
				<li>Use the object attributes to make any further changes to the object and save the changes to the database:<p class="source-code">&gt;&gt;&gt;publisher.email</p><p class="source-code">'info@packtpub.com'</p><p class="source-code">&gt;&gt;&gt; publisher.email = 'customersupport@packtpub.com'</p><p class="source-code">&gt;&gt;&gt; publisher.save()</p><p>You can see the changes using DB Browser as follows:</p><div id="_idContainer108" class="IMG---Figure"><img src="image/B15509_02_21.jpg" alt="Figure 2.21: Entry with the updated email field&#13;&#10;"/></div></li>
			</ol>
			<p class="figure-caption">Figure 2.21: Entry with the updated email field</p>
			<p>In this exercise, you created an entry in the database by creating an instance of the model object and used the <strong class="source-inline">save()</strong> method to write the model object into the database. </p>
			<p>Note that by following the preceding method, the changes to the class instance are not saved until the <strong class="source-inline">save()</strong> method is called. However, if we use the <strong class="source-inline">create()</strong> method, Django saves the changes to the database in a single step. We'll use this method in the exercise that follows.</p>
			<h2 id="_idParaDest-93"><a id="_idTextAnchor095"/>Exercise 2.03: Using the create() Method to Create an Entry</h2>
			<p>Here, you will create a record in the <strong class="source-inline">contributor</strong> table using the <strong class="source-inline">create()</strong> method in a single step:</p>
			<ol>
				<li value="1">First, import the Contributor class as before:<p class="source-code">&gt;&gt;&gt; from reviews.models import Contributor</p></li>
				<li>Invoke the <strong class="source-inline">create()</strong> method to create an object in the database in a single step. Ensure that you pass all the required parameters (f<strong class="source-inline">irst_names, last_names</strong>, and <strong class="source-inline">email</strong>):<p class="source-code">&gt;&gt;&gt; contributor  =   Contributor.objects.create(first_names="Rowel",     last_names="Atienza", email="RowelAtienza@example.com")</p></li>
				<li>Use DB Browser to verify that the contributor record has been created in the database. If your DB Browser is not already open, open the database file <strong class="source-inline">db.sqlite3</strong> as we just did in the previous section. Click <strong class="source-inline">Browse Data</strong> and select the desired table – in this case, the <strong class="source-inline">reviews_contributor</strong> table from the <strong class="source-inline">Table</strong> dropdown, as shown in the screenshot – and verify the newly created database record:<div id="_idContainer109" class="IMG---Figure"><img src="image/B15509_02_22.jpg" alt="Figure 2.22: Verifying the creation of the record in DB Browser&#13;&#10;"/></div></li>
			</ol>
			<p class="figure-caption">Figure 2.22: Verifying the creation of the record in DB Browser</p>
			<p>In this exercise, we learned that using the <strong class="source-inline">create()</strong> method, we can create a record for a model in a database in a single step.</p>
			<h2 id="_idParaDest-94"><a id="_idTextAnchor096"/>Creating an Object with a Foreign Key</h2>
			<p>Similar to how we created a record in the <strong class="source-inline">Publisher</strong> and <strong class="source-inline">Contributor</strong> tables, let's now create one for the <strong class="source-inline">Book</strong> table. If you recall, the <strong class="source-inline">Book</strong> model has a foreign key to <strong class="source-inline">Publisher</strong> that cannot have a null value. So, a way to populate the publisher's foreign key is by providing the created <strong class="source-inline">publisher</strong> object in the book's <strong class="source-inline">publisher</strong> field as shown in the following exercise.</p>
			<h2 id="_idParaDest-95"><a id="_idTextAnchor097"/>Exercise 2.04: Creating Records for a Many-to-One Relationship</h2>
			<p>In this exercise, you will create a record in the <strong class="source-inline">Book</strong> table including a foreign key to the <strong class="source-inline">Publisher</strong> model. As you already know, the relationship between <strong class="source-inline">Book</strong> and <strong class="source-inline">Publisher</strong> is a many-to-one relationship, so you have to first fetch the <strong class="source-inline">Publisher</strong> object and then use it while creating the book record:</p>
			<ol>
				<li value="1">First, import the <strong class="source-inline">Publisher</strong> class:<p class="source-code">&gt;&gt;&gt;from reviews.models import Book, Publisher</p></li>
				<li>Retrieve the <strong class="source-inline">publisher</strong> object from the database using the following command. The <strong class="source-inline">get()</strong> method is used to retrieve an object from the database. We still haven't explored database read operations. For now, use the following command; we will go deeper into database read/retrieve in the next section:<p class="source-code">&gt;&gt;&gt;publisher = Publisher.objects.get(name='Packt Publishing')</p></li>
				<li>When creating a book, we need to supply a <strong class="source-inline">date</strong> object as publication_date is a date field in the <strong class="source-inline">Book</strong> model. So, import <strong class="source-inline">date</strong> from datetime so that a date object can be supplied when creating the <strong class="source-inline">book</strong> object as shown in the following code:<p class="source-code">&gt;&gt;&gt;from datetime import date</p></li>
				<li>Use the <strong class="source-inline">create()</strong> method to create a record of the book in the database. Ensure that you pass all the fields, namely <strong class="source-inline">title</strong>, <strong class="source-inline">publication_ date</strong>, <strong class="source-inline">isbn</strong>, and the <strong class="source-inline">publisher</strong> object:<p class="source-code">&gt;&gt;&gt;book = Book.objects.create(title="Advanced Deep Learning   with Keras", publication_date=date(2018, 10, 31),     isbn="9781788629416", publisher=publisher)</p><p>Note that since <strong class="source-inline">publisher</strong> is a foreign key and it is not nullable (cannot hold a <strong class="source-inline">null</strong> value), it is mandatory to pass a <strong class="source-inline">publisher</strong> object. When the mandatory foreign key object publisher is not provided, the database will throw an integrity error.</p><p><em class="italic">Figure 2.23</em> shows the <strong class="source-inline">Book</strong> table where the first entry is created. Notice that the foreign key field (<strong class="source-inline">publisher_id</strong> ) points to the <strong class="bold">id</strong> (primary key) of the <strong class="source-inline">Publisher</strong> table. The entry <strong class="source-inline">publisher_id</strong> in the book's record is pointing to a <strong class="source-inline">Publisher</strong> record that has <strong class="source-inline">id</strong> (primary key) <strong class="source-inline">1</strong> as shown in the following two screenshots: </p><div id="_idContainer110" class="IMG---Figure"><img src="image/B15509_02_23.jpg" alt="Figure 2.23: Foreign key pointing to the primary key for reviews_book&#13;&#10;"/></div></li>
			</ol>
			<p class="figure-caption">Figure 2.23: Foreign key pointing to the primary key for reviews_book</p>
			<div>
				<div id="_idContainer111" class="IMG---Figure">
					<img src="image/B15509_02_24.jpg" alt="Figure 2.24: Foreign key pointing to the primary key for reviews_publisher&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 2.24: Foreign key pointing to the primary key for reviews_publisher</p>
			<p>In this exercise, we learned that while creating a database record, an object can be assigned to a field if it is a foreign key. We know that the <strong class="source-inline">Book</strong> model also has a many-to-many relationship with the Contributor model. Let's now explore the ways to establish many-to-many relations as we create records in the database.</p>
			<h2 id="_idParaDest-96"><a id="_idTextAnchor098"/>Exercise 2.05: Creating Records with Many-to-Many Relationships</h2>
			<p>In this exercise, you will create a many-to-many relationship between <strong class="source-inline">Book</strong> and <strong class="source-inline">Contributor</strong> using the relationship model <strong class="source-inline">BookContributor</strong>: </p>
			<ol>
				<li value="1">In case you have restarted the shell and lost the <strong class="source-inline">publisher</strong> and the <strong class="source-inline">book</strong> objects, retrieve them from the database by using the following set of Python statements:<p class="source-code">&gt;&gt;&gt;from reviews.models import Book</p><p class="source-code">&gt;&gt;&gt;from reviews.models import Contributor</p><p class="source-code">&gt;&gt;&gt;contributor = Contributor.objects.get(first_names='Rowel')</p><p class="source-code">book = Book.objects.get(title="Advanced Deep Learning with Keras")</p></li>
				<li>The way to establish a many-to-many relationship is by storing the information about the relationship in the intermediary model or the relationship model; in this case, it is <strong class="source-inline">BookContributor</strong>. Since we have already fetched the book and the contributor records from the database, let's use these objects while creating a record for the <strong class="source-inline">BookContributor</strong> relationship model. To do so, first, create an instance of the <strong class="source-inline">BookContributor</strong> relationship class and then save the object to the database. While doing so, ensure you pass the required fields, namely the <strong class="source-inline">book</strong> object, <strong class="source-inline">contributor</strong> object, and <strong class="source-inline">role</strong>:<p class="source-code">&gt;&gt;&gt;from reviews.models import BookContributor</p><p class="source-code">&gt;&gt;&gt;book_contributor = BookContributor(book=book,   contributor=contributor, role='AUTHOR')</p><p class="source-code">&gt;&gt;&gt; book_contributor.save()</p><p>Notice that we specified the role as <strong class="source-inline">AUTHOR</strong> while creating the <strong class="source-inline">book_contributor</strong> object. This is a classic example of storing relationship data while establishing a many-to-many relationship. The role can be <strong class="source-inline">AUTHOR</strong>, <strong class="source-inline">CO_AUTHOR</strong>, or <strong class="source-inline">EDITOR</strong>.</p><p>This established the relationship between the book <em class="italic">Advanced Deep Learning with Keras</em> and the contributor Rowel (Rowel being the author of the book).</p></li>
			</ol>
			<p>In this exercise, we established a many-to-many relationship between <strong class="source-inline">Book</strong> and <strong class="source-inline">Contributor</strong> using the <strong class="source-inline">BookContributor</strong> relationship model. With regards to the verification of the many-to-many relationship that we just created, we will see this in detail in a few exercises later on in this chapter.</p>
			<h2 id="_idParaDest-97"><a id="_idTextAnchor099"/>Exercise 2.06: A Many-to-Many Relationship Using the add() Method</h2>
			<p>In this exercise, you will establish a many-to-many relationship using the <strong class="source-inline">add()</strong> method. When we don't use the relationship to create the objects, we can use <strong class="source-inline">through_default</strong> to pass in a dictionary with the parameters defining the required fields. Continuing from the previous exercise, let's add one more contributor to the book titled <em class="italic">Advanced Deep Learning with Keras</em>. This time, the contributor is an editor of the book:</p>
			<ol>
				<li value="1">If you have restarted the shell, run the following two commands to import and fetch the desired book instance:<p class="source-code">&gt;&gt;&gt;from reviews.models import Book, Contributor</p><p class="source-code">&gt;&gt;&gt;book = Book.objects.get(title="Advanced Deep Learning with   Keras")</p></li>
				<li>Use the <strong class="source-inline">create()</strong> method to create a contributor as shown here: <p class="source-code">&gt;&gt;&gt;contributor = Contributor.objects.create(first_names='Packt',   last_names='Example Editor',     email='PacktEditor@example.com')</p></li>
				<li>Add the newly created contributor to the book using the <strong class="source-inline">add()</strong> method. Ensure you provide the relationship parameter <strong class="source-inline">role</strong> as <strong class="source-inline">dict</strong>. Enter the following code:<p class="source-code">&gt;&gt;&gt;book.contributors.add(contributor,   through_defaults={'role': 'EDITOR'})</p></li>
			</ol>
			<p>Thus, we used the <strong class="source-inline">add()</strong> method to establish a many-to-many relationship between the book and contributor while storing the relationship data role as <strong class="source-inline">Editor</strong>. Let's now take a look at other ways of doing this.</p>
			<h2 id="_idParaDest-98"><a id="_idTextAnchor100"/>Using create() and set() Methods for Many-to-Many Relationships</h2>
			<p>Assume the book <em class="italic">Advanced Deep Learning with Keras</em> has a total of two editors. Let's use the following method to add another editor to the book. If the contributor is not already present in the database, then we can use the <strong class="source-inline">create()</strong> method to simultaneously create an entry as well as to establish the relation with the book:</p>
			<p class="source-code">&gt;&gt;&gt;book.contributors.create(first_names='Packtp', last_names=  'Editor Example', email='PacktEditor2@example.com',     through_defaults={'role': 'EDITOR'})</p>
			<p>Similarly, we can also use the <strong class="source-inline">set()</strong> method to add a list of contributors for a book. Let's create a publisher, a set of two contributors who are the co-authors, and a <strong class="source-inline">book</strong> object. First, import the <strong class="source-inline">Publisher</strong> model, if not already imported, using the following code:</p>
			<p class="source-code">&gt;&gt;&gt;from reviews.models import Publisher</p>
			<p>The following code will help us do so:</p>
			<p class="source-code">&gt;&gt;&gt; publisher = Publisher.objects.create(name='Pocket Books',   website='https://pocketbookssampleurl.com', email='pocketbook@example.com')</p>
			<p class="source-code">&gt;&gt;&gt; contributor1 = Contributor.objects.create(first_names=  'Stephen', last_names='Stephen', email='StephenKing@example.com')</p>
			<p class="source-code">&gt;&gt;&gt; contributor2 = Contributor.objects.create(first_names=  'Peter', last_names='Straub', email='PeterStraub@example.com')</p>
			<p class="source-code">&gt;&gt;&gt; book = Book.objects.create(title='The Talisman',   publication_date=date(2012, 9, 25), isbn='9781451697216',     publisher=publisher)</p>
			<p>Since this is a many-to-many relationship, we can add a list of objects in just one go, using the <strong class="source-inline">set()</strong> method. We can use through_defaults to specify the role of the contributors; in this case, they are co-authors:</p>
			<p class="source-code">&gt;&gt;&gt; book.contributors.set([contributor1, contributor2],   through_defaults={'role': 'CO_AUTHOR'})</p>
			<h2 id="_idParaDest-99"><a id="_idTextAnchor101"/>Read Operations</h2>
			<p>Django provides us with methods that allow us to read/retrieve from the database. We can retrieve a single object from the database using the <strong class="source-inline">get()</strong> method. We have already created a few records in the previous sections, so let's use the <strong class="source-inline">get()</strong> method to retrieve an object.</p>
			<h2 id="_idParaDest-100"><a id="_idTextAnchor102"/>Exercise 2.07: Using the get() Method to Retrieve an Object</h2>
			<p>In this exercise, you will retrieve an object from the database using the <strong class="source-inline">get()</strong> method:</p>
			<ol>
				<li value="1">Fetch a <strong class="source-inline">Publisher</strong> object that has a <strong class="source-inline">name</strong> field with the value <strong class="source-inline">Pocket Books</strong>:<p class="source-code">&gt;&gt;&gt;from reviews.models import Publisher</p><p class="source-code">&gt;&gt;&gt; publisher = Publisher.objects.get(name='Pocket Books')</p></li>
				<li>Re-enter the retrieved <strong class="source-inline">publisher</strong> object and press <em class="italic">Enter</em>:<p class="source-code">&gt;&gt;&gt; publisher</p><p class="source-code">&lt;Publisher: Pocket Books&gt;</p><p>Notice that the output is displayed in the shell. This is called a string representation of an object. It is the result of adding the model method <strong class="source-inline">__str__()</strong> as we did in the <em class="italic">Model Methods</em> section for the <strong class="source-inline">Publisher</strong> class.</p></li>
				<li>Upon retrieving the object, you have access to all the object's attributes. Since this is a Python object, the attributes of the object can be accessed by using <strong class="source-inline">.</strong> followed by the attribute name. So, you can retrieve the publisher's name with the following command:<p class="source-code">&gt;&gt;&gt; publisher.name</p><p class="source-code">'Pocket Books'</p></li>
				<li>Similarly, retrieve the publisher's website:<p class="source-code">&gt;&gt;&gt; publisher.website</p><p class="source-code">'https://pocketbookssampleurl.com'</p><p>The publisher's email address can be retrieved as well:</p><p class="source-code">&gt;&gt;&gt; publisher.email</p><p class="source-code">'pocketbook@example.com'</p></li>
			</ol>
			<p>In this exercise, we learned how to fetch a single object using the <strong class="source-inline">get()</strong> method. There are several disadvantages to using this method, though. Let's find out why.</p>
			<h2 id="_idParaDest-101"><a id="_idTextAnchor103"/>Returning an Object Using the get() Method</h2>
			<p>It is important to note that the <strong class="source-inline">get()</strong> method can only fetch one object. If there is another object carrying the same value as the field mentioned, then we can expect a <em class="italic">"returned more than one"</em> error message. For example, if there are two entries in the <strong class="source-inline">Publisher</strong> table with the same value for the name field, we can expect an error. In such cases, there are alternate ways to retrieve those objects, which we will be exploring in the subsequent sections. </p>
			<p>We can also get a <em class="italic">"matching query does not exist"</em> error message when there are no objects returned from the <strong class="source-inline">get()</strong> query. The <strong class="source-inline">get()</strong> method can be used with any of the object's fields to retrieve a record. In the following case, we are using the <strong class="source-inline">website</strong> field:</p>
			<p class="source-code">&gt;&gt;&gt; publisher = Publisher.objects.get(website='https://pocketbookssampleurl.com')</p>
			<p>After retrieving the object, we can still get the publisher's name, as shown here:</p>
			<p class="source-code">&gt;&gt;&gt; publisher.name</p>
			<p class="source-code">'Pocket Books'</p>
			<p>Another way to retrieve an object is by using its primary key – <strong class="source-inline">pk</strong>, as can be seen here: </p>
			<p class="source-code">&gt;&gt;&gt; Publisher.objects.get(pk=2)</p>
			<p class="source-code">&lt;Publisher: Pocket Books&gt;</p>
			<p>Using pk for the primary key is a more generic way of using the primary key field. But for the <strong class="source-inline">Publisher</strong> table, since we know that <strong class="source-inline">id</strong> is the primary key, we can simply use the field name <strong class="source-inline">id</strong> to create our <strong class="source-inline">get()</strong> query:</p>
			<p class="source-code">&gt;&gt;&gt; Publisher.objects.get(id=2)</p>
			<p class="source-code">&lt;Publisher: Pocket Books&gt;</p>
			<p class="callout-heading">Note</p>
			<p class="callout">For <strong class="source-inline">Publisher</strong> and all the other tables, the primary key is <strong class="source-inline">id</strong>, which was automatically created by Django. This happens when a primary key field is not mentioned at the time of the creation of the table. But there can be instances where a field can be explicitly declared as a primary key.</p>
			<h2 id="_idParaDest-102"><a id="_idTextAnchor104"/>Exercise 2.08: Using the all() Method to Retrieve a Set of Objects</h2>
			<p>We can use the <strong class="source-inline">all()</strong> method to retrieve a set of objects. In this exercise, you will use this method to retrieve the names of all contributors:</p>
			<ol>
				<li value="1">Add the following code to retrieve all the objects from the <strong class="source-inline">Contributor</strong> table:<p class="source-code">&gt;&gt;&gt;from reviews.models import Contributor</p><p class="source-code">&gt;&gt;&gt; Contributor.objects.all()</p><p class="source-code">&lt;QuerySet [&lt;Contributor: Rowel&gt;, &lt;Contributor: Packt&gt;, &lt;Contributor: Packtp&gt;, &lt;Contributor: Stephen&gt;, &lt;Contributor:   Peter&gt;]&gt;</p><p>Upon execution, you will get a <strong class="source-inline">QuerySet</strong> of all the objects.</p></li>
				<li>We can use list indexing to look up a specific object or to iterate over the list using a loop to do any other operation:<p class="source-code">&gt;&gt;&gt; contributors = Contributor.objects.all()</p></li>
				<li>Since <strong class="source-inline">Contributor</strong> is a list of objects, you can use indexing to access any element in the list as shown in the following command:<p class="source-code">&gt;&gt;&gt; contributors[0]</p><p class="source-code">&lt;Contributor: Rowel&gt;</p><p>In this case, the first element in the list is a contributor with a <strong class="source-inline">first_names</strong> value of <strong class="source-inline">'Rowel'</strong> and a <strong class="source-inline">last_names</strong> value of <strong class="source-inline">'Atienza'</strong>, as you can see from the following code:</p><p class="source-code">&gt;&gt;&gt; contributors[0].first_names</p><p class="source-code">'Rowel'</p><p class="source-code">&gt;&gt;&gt; contributors[0].last_names</p><p class="source-code">'Atienza'</p></li>
			</ol>
			<p>In this exercise, we learned how to retrieve all the objects using the <strong class="source-inline">all()</strong> method and we also learned how to use the retrieved set of objects as a list.</p>
			<h2 id="_idParaDest-103"><a id="_idTextAnchor105"/>Retrieving Objects by Filtering</h2>
			<p>If we have more than one object for a field value, then we cannot use the <strong class="source-inline">get()</strong> method since the <strong class="source-inline">get()</strong> method can return only one object. For such cases, we have the <strong class="source-inline">filter()</strong> method, which can retrieve all the objects that match a specified condition.</p>
			<h2 id="_idParaDest-104"><a id="_idTextAnchor106"/>Exercise 2.09: Using the filter() Method to Retrieve Objects</h2>
			<p>In this exercise, you will use the <strong class="source-inline">filter()</strong> method to get a specific set of objects for a certain condition. Specifically, you will retrieve all the contributors' names who have their first name as <strong class="source-inline">Peter</strong>:</p>
			<ol>
				<li value="1">First, create two more contributors:<p class="source-code">&gt;&gt;&gt;from reviews.models import Contributor</p><p class="source-code">&gt;&gt;&gt; Contributor.objects.create(first_names='Peter', last_names='Wharton', email='PeterWharton@example.com')</p><p class="source-code">&gt;&gt;&gt; Contributor.objects.create(first_names='Peter', last_names='Tyrrell', email='PeterTyrrell@example.com')</p></li>
				<li>To retrieve those contributors who have the value of <strong class="source-inline">first_names</strong> as <strong class="source-inline">Peter</strong>, add the following code:<p class="source-code">&gt;&gt;&gt; Contributor.objects.filter(first_names='Peter')</p><p class="source-code">&lt;QuerySet [&lt;Contributor: Peter&gt;, &lt;Contributor: Peter&gt;,   &lt;Contributor: Peter&gt;]&gt;</p></li>
				<li>The <strong class="source-inline">filter()</strong> method returns the object even if there is only one. You can see this here:<p class="source-code">&gt;&gt;&gt;Contributor.objects.filter(first_names='Rowel')</p><p class="source-code">&lt;QuerySet [&lt;Contributor: Rowel&gt;]&gt;</p></li>
				<li>Furthermore, the <strong class="source-inline">filter()</strong> method returns an empty <strong class="source-inline">QuerySet</strong> if there is none matching the query. This can be seen here:<p class="source-code">&gt;&gt;&gt;Contributor.objects.filter(first_names='Nobody')</p><p class="source-code">&lt;QuerySet []&gt;</p></li>
			</ol>
			<p>In this exercise, we saw the use of filters to retrieve a set of a few objects filtered by a certain condition.</p>
			<h2 id="_idParaDest-105"><a id="_idTextAnchor107"/>Filtering by Field Lookups</h2>
			<p>Now, let's suppose we want to filter and query a set of objects using the object's fields by providing certain conditions. In such a case, we can use what is called a double-underscore lookup. For example, the <strong class="source-inline">Book</strong> object has a field named <strong class="source-inline">publication_date</strong>; let's say we want to filter and fetch all the books that were published after 01-01-2014. We can easily look these up by using the double-underscore method. To do this, we will first import the <strong class="source-inline">Book</strong> model:</p>
			<p class="source-code">&gt;&gt;&gt;from reviews.models import Book</p>
			<p class="source-code">&gt;&gt;&gt;book = Book.objects.filter(publication_date__gt=date(2014, 1, 1))</p>
			<p>Here, <strong class="source-inline">publication_date__gt</strong> indicates the publication date, which is greater than (<strong class="source-inline">gt</strong>) a certain specified date – in this case, 01-01-2014. Similar to this, we have the following abbreviations:</p>
			<ul>
				<li><strong class="source-inline">lt</strong>: Less than</li>
				<li><strong class="source-inline">lte</strong>: Less than or equal to</li>
				<li><strong class="source-inline">gte</strong>: Greater than or equal to</li>
			</ul>
			<p>The result after filtering can be seen here:</p>
			<p class="source-code">&gt;&gt;&gt; book</p>
			<p class="source-code">&lt;QuerySet [&lt;Book: Advanced Deep Learning with Keras&gt;]&gt;</p>
			<p>Here is the publication date of the book that is part of the query set, which confirms that the publication date was after 01-01-2014:</p>
			<p class="source-code">&gt;&gt;&gt; book[0].publication_date</p>
			<p class="source-code">datetime.date(2018, 10, 31)</p>
			<h2 id="_idParaDest-106"><a id="_idTextAnchor108"/>Using Pattern Matching for Filtering Operations</h2>
			<p>For filtered results, we can also look up whether the parameter contains a part of the string we are looking for:</p>
			<p class="source-code">&gt;&gt;&gt; book = Book.objects.filter(title__contains=</p>
			<p class="source-code">    'Deep learning')</p>
			<p>Here, <strong class="source-inline">title__contains</strong> looks for all those objects with titles containing <strong class="source-inline">'Deep learning'</strong> as a part of the string: </p>
			<p class="source-code">&gt;&gt;&gt; book</p>
			<p class="source-code">&lt;QuerySet [&lt;Book: Advanced Deep Learning with Keras&gt;]&gt;</p>
			<p class="source-code">&gt;&gt;&gt; book[0].title</p>
			<p class="source-code">'Advanced Deep Learning with Keras'</p>
			<p>Similarly, we can use <strong class="source-inline">icontains</strong> if the string match needs to be case-insensitive. Using <strong class="source-inline">startswith</strong> matches any string starting with the specified string.</p>
			<h2 id="_idParaDest-107"><a id="_idTextAnchor109"/>Retrieving Objects by Excluding</h2>
			<p>In the previous section, we learned about fetching a set of objects by matching a certain condition. Now, suppose we want to do the opposite; that is, we want to fetch all those objects that do not match a certain condition. In such cases, we can use the <strong class="source-inline">exclude()</strong> method to exclude a certain condition and fetch all the required objects. This will be clearer with an example. The following is a list of all contributors:</p>
			<p class="source-code">&gt;&gt;&gt; Contributor.objects.all()</p>
			<p class="source-code">&lt;QuerySet [&lt;Contributor: Rowel&gt;, &lt;Contributor: Packt&gt;,   &lt;Contributor: Packtp&gt;, &lt;Contributor: Stephen&gt;,     &lt;Contributor: Peter&gt;, &lt;Contributor: Peter&gt;,       &lt;Contributor: Peter&gt;]&gt;</p>
			<p>Now, from this list, we will exclude all those contributors who have the value of <strong class="source-inline">first_names</strong> as <strong class="source-inline">Peter</strong>:</p>
			<p class="source-code">&gt;&gt;&gt; Contributor.objects.exclude(first_names='Peter')</p>
			<p class="source-code">&lt;QuerySet [&lt;Contributor: Rowel&gt;, &lt;Contributor: Packt&gt;,   &lt;Contributor: Packtp&gt;, &lt;Contributor: Stephen&gt;]&gt;</p>
			<p>We see here that the query returned all those contributors whose first name is not Peter.</p>
			<h2 id="_idParaDest-108"><a id="_idTextAnchor110"/>Retrieving Objects Using the order_by() Method</h2>
			<p>We can retrieve a list of objects while ordering by a specified field, using the <strong class="source-inline">order_by()</strong> method. For example, in the following code snippet, we order the books by their publication date:</p>
			<p class="source-code">&gt;&gt;&gt; books = Book.objects.order_by("publication_date")</p>
			<p class="source-code">&gt;&gt;&gt; books</p>
			<p class="source-code">&lt;QuerySet [&lt;Book: The Talisman&gt;, &lt;Book: Advanced Deep Learning   with Keras&gt;]&gt;</p>
			<p>Let's examine the order of the query. Since the query set is a list, we can use indexing to check the publication date of each book:</p>
			<p class="source-code">&gt;&gt;&gt; books[0].publication_date</p>
			<p class="source-code">datetime.date(2012, 9, 25)</p>
			<p class="source-code">&gt;&gt;&gt; books[1].publication_date</p>
			<p class="source-code">datetime.date(2018, 10, 31)</p>
			<p>Notice that the publication date of the first book with index <strong class="source-inline">0</strong> is older than the publication date of the second book with index <strong class="source-inline">1</strong>. So, this confirms that the queried list of books has been properly ordered as per their publication dates. We can also use a prefix with the negative sign for the field parameter to order results in descending order. This can be seen from the following code snippet:</p>
			<p class="source-code">&gt;&gt;&gt; books = Book.objects.order_by("<strong class="bold">-</strong>publication_date")</p>
			<p class="source-code">&gt;&gt;&gt; books</p>
			<p class="source-code">&lt;QuerySet [&lt;Book: Advanced Deep Learning with Keras&gt;,   &lt;Book: The Talisman&gt;]&gt;</p>
			<p>Since we have prefixed a negative sign to the publication date, notice that the queried set of books has now been returned in the opposite order, where the first book object with index <strong class="source-inline">0</strong> has a more recent date than the second book:</p>
			<p class="source-code">&gt;&gt;&gt; books[0].publication_date</p>
			<p class="source-code">datetime.date(2018, 10, 31)</p>
			<p class="source-code">&gt;&gt;&gt; books[1].publication_date</p>
			<p class="source-code">datetime.date(2012, 9, 25)</p>
			<p>We can also order by using a string field or a numerical. For example, the following code can be used to order books by their primary key or <strong class="source-inline">id</strong>:</p>
			<p class="source-code">&gt;&gt;&gt;books = Book.objects.order_by('id')</p>
			<p class="source-code">&lt;QuerySet [&lt;Book: Advanced Deep Learning with Keras&gt;,   &lt;Book: The Talisman&gt;]&gt;</p>
			<p>The queried set of books has been ordered as per book <strong class="source-inline">id</strong> in ascending order:</p>
			<p class="source-code">&gt;&gt;&gt; books[0].id</p>
			<p class="source-code">1</p>
			<p class="source-code">&gt;&gt;&gt; books[1].id</p>
			<p class="source-code">2</p>
			<p>Again, to order in descending order, the negative sign can be used as a prefix, as follows:</p>
			<p class="source-code">&gt;&gt;&gt; Book.objects.order_by('-id')</p>
			<p class="source-code">&lt;QuerySet [&lt;Book: The Talisman&gt;, &lt;Book: Advanced Deep Learning   with Keras&gt;]&gt;</p>
			<p>Now, the queried set of books has been ordered per book <strong class="source-inline">id</strong> in descending order:</p>
			<p class="source-code">&gt;&gt;&gt; books[0].id</p>
			<p class="source-code">2</p>
			<p class="source-code">&gt;&gt;&gt; books[1].id</p>
			<p class="source-code">1</p>
			<p>To order by a string field in alphabetical order, we can do something like this:</p>
			<p class="source-code">&gt;&gt;&gt;Book.objects.order_by('title')</p>
			<p class="source-code">&lt;QuerySet [&lt;Book: Advanced Deep Learning with Keras&gt;, &lt;Book:   The Talisman&gt;]&gt;</p>
			<p>Since we have used the title of the book to order by, the query set has been ordered in alphabetical order. We can see this as follows:</p>
			<p class="source-code">&gt;&gt;&gt; books[0]</p>
			<p class="source-code">&lt;Book: Advanced Deep Learning with Keras&gt;</p>
			<p class="source-code">&gt;&gt;&gt; books[1]</p>
			<p class="source-code">&lt;Book: The Talisman&gt;</p>
			<p>Similar to what we've seen for the previous ordering types, the negative sign prefix can help us sort in reverse alphabetical order, as we can see here:</p>
			<p class="source-code">&gt;&gt;&gt; Book.objects.order_by('-title')</p>
			<p class="source-code">&lt;QuerySet [&lt;Book: The Talisman&gt;, &lt;Book: Advanced Deep Learning   with Keras&gt;]&gt;</p>
			<p>This will lead to the following output:</p>
			<p class="source-code">&gt;&gt;&gt; books[0]</p>
			<p class="source-code">&lt;Book: The Talisman&gt;</p>
			<p class="source-code">&gt;&gt;&gt; books[1]</p>
			<p class="source-code">&lt;Book: Advanced Deep Learning with Keras&gt;</p>
			<p>Yet another useful method offered by Django is <strong class="source-inline">values()</strong>. It helps us get a query set of dictionaries instead of objects. In the following code snippet, we're using this for a <strong class="source-inline">Publisher</strong> object:</p>
			<p class="source-code">&gt;&gt;&gt; publishers = Publisher.objects.all().values()</p>
			<p class="source-code">&gt;&gt;&gt; publishers</p>
			<p class="source-code">&lt;QuerySet [{'id': 1, 'name': 'Packt Publishing', 'website':   'https://www.packtpub.com', 'email':     'customersupport@packtpub.com'}, {'id': 2, 'name':       'Pocket Books', 'website': 'https://pocketbookssampleurl.com',        'email': 'pocketbook@example.com'}]&gt;</p>
			<p class="source-code">&gt;&gt;&gt; publishers[0]</p>
			<p class="source-code">{'id': 1, 'name': 'Packt Publishing', 'website':  'https://www.packtpub.com', 'email':     'customersupport@packtpub.com'}</p>
			<p class="source-code">&gt;&gt;&gt; publishers[0]</p>
			<p class="source-code">{'id': 1, 'name': 'Packt Publishing', 'website':   'https://www.packtpub.com', 'email':    'customersupport@packtpub.com'}</p>
			<h2 id="_idParaDest-109"><a id="_idTextAnchor111"/>Querying Across Relationships</h2>
			<p>As we have studied in this chapter, the <strong class="source-inline">reviews</strong> app has two kinds of relationships – many-to-one and many-to-many. So far, we have learned various ways of making queries using <strong class="source-inline">get()</strong>, filters, field lookups, and so on. Now let's study how to perform queries across relationships. There are several ways to go about this – we could use foreign keys, object instances, and more. Let's explore these with the help of some examples.</p>
			<h2 id="_idParaDest-110"><a id="_idTextAnchor112"/>Querying Using Foreign Keys</h2>
			<p>When we have relationships across two models/tables, Django provides a way to perform a query using the relationship. The command shown in this section will retrieve all the books published by <strong class="source-inline">Packt Publishing</strong> by performing a query using model relationships. Similar to what we've seen previously, this is done using the double-underscore lookup. For example, the <strong class="source-inline">Book</strong> model has a foreign key of <strong class="source-inline">publisher</strong> pointing to the <strong class="source-inline">Publisher</strong> model. Using this foreign key, we can perform a query using double underscores and the field <strong class="source-inline">name</strong> in the <strong class="source-inline">Publisher</strong> model. This can be seen from the following code:</p>
			<p class="source-code">&gt;&gt;&gt; Book.objects.filter(publisher__name='Packt Publishing')</p>
			<p class="source-code">&lt;QuerySet [&lt;Book: Advanced Deep Learning with Keras&gt;]&gt;</p>
			<h2 id="_idParaDest-111"><a id="_idTextAnchor113"/>Querying Using Model Name</h2>
			<p>Another way of querying is where we can use a relationship to do the query backward, using the model name in lowercase. For instance, let's say we want to query the publisher who published the book <em class="italic">Advanced Deep Learning with Keras</em> using model relationships in the query. For this, we can execute the following statement to retrieve the <strong class="source-inline">Publisher</strong> information object:</p>
			<p class="source-code">&gt;&gt;&gt; Publisher.objects.get(book__title='Advanced Deep Learning   with Keras')</p>
			<p class="source-code">&lt;Publisher: Packt Publishing&gt;</p>
			<p>Here, <strong class="source-inline">book</strong> is the model name in lowercase. As we already know, the <strong class="source-inline">Book</strong> model has a <strong class="source-inline">publisher</strong> foreign key with the value of <strong class="source-inline">name</strong> as Packt Publishing.</p>
			<h2 id="_idParaDest-112"><a id="_idTextAnchor114"/>Querying Across Foreign Key Relationships Using the Object Instance</h2>
			<p>We can also retrieve the information using the object's foreign key. Suppose we want to query the publisher's name for the title <em class="italic">The Talisman</em>:</p>
			<p class="source-code">&gt;&gt;&gt; book = Book.objects.get(title='The Talisman')</p>
			<p class="source-code">&gt;&gt;&gt; book.publisher</p>
			<p class="source-code">&lt;Publisher: Pocket Books&gt;</p>
			<p>Using the object here is an example where we use the reverse direction to get all the books published by a publisher by using the <strong class="source-inline">set.all()</strong> method:</p>
			<p class="source-code">&gt;&gt;&gt; publisher = Publisher.objects.get(name='Pocket Books')</p>
			<p class="source-code">&gt;&gt;&gt; publisher.book_set.all()</p>
			<p class="source-code">&lt;QuerySet [&lt;Book: The Talisman&gt;]&gt;</p>
			<p>We can also create queries using chains of queries:</p>
			<p class="source-code">&gt;&gt;&gt; Book.objects.filter(publisher__name='Pocket Books').filter(title='The Talisman')</p>
			<p class="source-code">&lt;QuerySet [&lt;Book: The Talisman&gt;]&gt;</p>
			<p>Let's perform some more exercises to shore up our knowledge of the various kinds of queries we have learned about so far.</p>
			<h2 id="_idParaDest-113"><a id="_idTextAnchor115"/>Exercise 2.10: Querying Across a Many-to-Many Relationship Using Field Lookup</h2>
			<p>We know that <strong class="source-inline">Book</strong> and <strong class="source-inline">Contributor</strong> have a many-to-many relationship. In this exercise, without creating an object, you will perform a query to retrieve all the contributors who contributed to writing the book titled <em class="italic">The Talisman</em>: </p>
			<ol>
				<li value="1">First, import the <strong class="source-inline">Contributor</strong> class:<p class="source-code">&gt;&gt;&gt; from reviews.models import Contributor</p></li>
				<li>Now, add the following code to query for the set of contributors on <em class="italic">The Talisman</em>:<p class="source-code">&gt;&gt;&gt;Contributor.objects.filter(book__title='The Talisman')</p><p>You should see the following:</p><p class="source-code">&lt;QuerySet [&lt;Contributor: Stephen&gt;, &lt;Contributor: Peter&gt;]&gt;</p></li>
			</ol>
			<p>From the preceding output, we can see that Stephen and Peter are the contributors who contributed to writing the book <em class="italic">The Talisman</em>. The query uses the <strong class="source-inline">book</strong> model (written in lowercase) and does a field lookup for the <strong class="source-inline">title</strong> field using the double underscore as shown in the command.</p>
			<p>In this exercise, we learned how to perform queries across many-to-many relationships using field lookup. Let's now look at using another method to carry out the same task.</p>
			<h2 id="_idParaDest-114"><a id="_idTextAnchor116"/>Exercise 2.11: A Many-to-Many Query Using Objects</h2>
			<p>In this exercise, using a <strong class="source-inline">Book</strong> object, search for all the contributors who contributed to writing the book with the title <em class="italic">The Talisman</em>. The following steps will help you do that:</p>
			<ol>
				<li value="1">Import the Book model:<p class="source-code">&gt;&gt;&gt; from reviews.models import Book</p></li>
				<li>Retrieve a book object with the title <em class="italic">The Talisman</em>, by adding the following line of code:<p class="source-code">&gt;&gt;&gt; book = Book.objects.get(title='The Talisman')</p></li>
				<li>Then retrieve all the contributors who worked on the book The Talisman using the <strong class="source-inline">book</strong> object. Add the following code to do so:<p class="source-code">&gt;&gt;&gt;book.contributors.all()</p><p class="source-code">&lt;QuerySet [&lt;Contributor: Stephen&gt;, &lt;Contributor: Peter&gt;]&gt;</p></li>
			</ol>
			<p>Again, we can see that Stephen and Peter are the contributors who worked on the book <em class="italic">The Talisman</em>. Since the book has a many-to-many relationship with contributors, we have used the <strong class="source-inline">contributors.all()</strong> method to get a query set of all those contributors who worked on the book. Now, let's try using the <strong class="source-inline">set</strong> method to perform a similar task.</p>
			<h2 id="_idParaDest-115"><a id="_idTextAnchor117"/>Exercise 2.12: A Many-to-Many Query Using the set() Method</h2>
			<p>In this exercise, you will use a <strong class="source-inline">contributor</strong> object to fetch all the books written by the contributor named <strong class="source-inline">Rowel</strong>:</p>
			<ol>
				<li value="1">Import the <strong class="source-inline">Contributor</strong> model:<p class="source-code">&gt;&gt;&gt; from reviews.models import Contributor</p></li>
				<li>Fetch a <strong class="source-inline">contributor</strong> object whose <strong class="source-inline">first_names</strong> is <strong class="source-inline">'Rowel'</strong> using the <strong class="source-inline">get()</strong> method:<p class="source-code">&gt;&gt;&gt; contributor = Contributor.objects.get(first_names='Rowel')</p></li>
				<li>Using the <strong class="source-inline">contributor</strong> object and the <strong class="source-inline">book_set()</strong> method, get all those books written by the contributor:<p class="source-code">&gt;&gt;&gt; contributor.book_set.all()</p><p class="source-code">&lt;QuerySet [&lt;Book: Advanced Deep Learning with Keras&gt;]&gt;</p></li>
			</ol>
			<p>Since <strong class="source-inline">Book</strong> and <strong class="source-inline">Contributor</strong> have a many-to-many relationship, we can use the <strong class="source-inline">set()</strong> method to query a set of objects associated with the model. In this case, <strong class="source-inline">contributor.book_set.all()</strong> returned all the books written by the contributor.</p>
			<h2 id="_idParaDest-116"><a id="_idTextAnchor118"/>Exercise 2.13: Using the update() Method</h2>
			<p>In this exercise, you will use the <strong class="source-inline">update()</strong> method to update an existing record: </p>
			<ol>
				<li value="1">Change <strong class="source-inline">first_names</strong> for a contributor who has the last name <strong class="source-inline">Tyrrell</strong>:<p class="source-code">&gt;&gt;&gt; from reviews.models import Contributor</p><p class="source-code">&gt;&gt;&gt; Contributor.objects.filter(last_names='Tyrrell').  update(first_names='Mike')</p><p class="source-code">1</p><p>The return value shows the number of records that have been updated. In this case, one record has been updated.</p></li>
				<li>Fetch the contributor that was just modified using the <strong class="source-inline">get()</strong> method and verify that the first name has been changed to <strong class="source-inline">Mike</strong>:<p class="source-code">&gt;&gt;&gt; Contributor.objects.get(last_names='Tyrrell').first_names</p><p class="source-code">'Mike'</p><p class="callout-heading">Note</p><p class="callout">If the filter operation has more than one record, then the <strong class="source-inline">update()</strong> method will update the specified field in all the records returned by the filter.</p></li>
			</ol>
			<p>In this exercise, we learned how to use the <strong class="source-inline">update()</strong> method to update a record in the database. Now, finally, let's try deleting a record from the database using the <strong class="source-inline">delete()</strong> method.</p>
			<h2 id="_idParaDest-117"><a id="_idTextAnchor119"/>Exercise 2.14: Using the delete() Method</h2>
			<p>An existing record in the database can be deleted using the <strong class="source-inline">delete()</strong> method. In this exercise, you will delete a record from the <strong class="source-inline">contributors</strong> table that has the value of <strong class="source-inline">last_name</strong> as <strong class="source-inline">Wharton</strong>:</p>
			<ol>
				<li value="1">Fetch the object using the <strong class="source-inline">get</strong> method and use the <strong class="source-inline">delete</strong> method as shown here:<p class="source-code">&gt;&gt;&gt; from reviews.models import Contributor</p><p class="source-code">&gt;&gt;&gt; Contributor.objects.get(last_names='Wharton').delete()</p><p class="source-code">(1, {'reviews.BookContributor': 0, 'reviews.Contributor': 1})</p><p>Notice that you called the <strong class="source-inline">delete()</strong> method without assigning the <strong class="source-inline">contributor</strong> object to a variable. Since the <strong class="source-inline">get()</strong> method returns a single object, you can access the object's method without actually creating a variable for it.</p></li>
				<li>Verify the <strong class="source-inline">contributor</strong> object with <strong class="source-inline">last_name</strong> as <strong class="source-inline">'Wharton'</strong> has been deleted:<p class="source-code">&gt;&gt;&gt; Contributor.objects.get(last_names='Wharton')</p><p class="source-code">Traceback (most recent call last):</p><p class="source-code">    File "&lt;console&gt;", line 1, in &lt;module&gt;</p><p class="source-code">    File "/../site-packages/django/db/models/manager.py",  line 82, in manager_method</p><p class="source-code">    return getattr(self.get_queryset(), name)(*args, **kwargs)</p><p class="source-code">    File "/../site-packages/django/db/models/query.py",  line 417, in get</p><p class="source-code">    self.model._meta.object_name</p><p class="source-code">reviews.models.Contributor.DoesNotExist: Contributor   matching query does not exist.</p></li>
			</ol>
			<p>As you can see upon running the query, we got an <em class="italic">object does not exist</em> error. This is expected since the record has been deleted. In this exercise, we learned how to use the <strong class="source-inline">delete</strong> method to delete a record from the database.</p>
			<h2 id="_idParaDest-118"><a id="_idTextAnchor120"/>Activity 2.01: Create Models for a Project Management Application</h2>
			<p>Imagine you are developing a project management application called <strong class="source-inline">Juggler</strong>. Juggler is an application that can track multiple projects, and each project can have multiple tasks associated with it. The following steps will help you complete this activity:</p>
			<ol>
				<li value="1">Using the techniques we have learned so far, create a Django project called <strong class="source-inline">juggler</strong>.</li>
				<li>Create a Django app called <strong class="source-inline">projectp</strong>.</li>
				<li>Add the app projects in the <strong class="source-inline">juggler/settings.py</strong> file.</li>
				<li>Create two related model classes called <strong class="source-inline">Project</strong> and <strong class="source-inline">Task</strong> in <strong class="source-inline">projectp/models.py</strong>.</li>
				<li>Create migration scripts and migrate the models' definitions to the database.</li>
				<li>Open the Django shell now and import the models.</li>
				<li>Populate the database with an example and write a query displaying the list of tasks associated with a given project.<p class="callout-heading">Note</p><p class="callout">The solution to this activity can be found at <a href="http://packt.live/2Nh1NTJ">http://packt.live/2Nh1NTJ</a>.</p></li>
			</ol>
			<h2 id="_idParaDest-119"><a id="_idTextAnchor121"/>Populating the Bookr Project's Database</h2>
			<p>Although we know how to create database records for the project, in the next few chapters, we will have to create a lot of records to work with the project. For that reason, we have created a script that can make things easy for us. This script populates the database by reading a <strong class="bold">.csv</strong> (<strong class="bold">Comma-Separated Values</strong>) file consisting of many records. Follow the next few steps to populate the project's database:</p>
			<ol>
				<li value="1">Create the following folder structure inside the project directory:<p class="source-code">bookr/reviews/management/commands/</p></li>
				<li>Copy the <strong class="source-inline">loadcsv.py</strong> file from the following location and <strong class="source-inline">WebDevWithDjangoData.csv</strong> into the folder created. This can be found on the GitHub repository for this book at <a href="http://packt.live/3pvbCLM">http://packt.live/3pvbCLM</a>.<p>Because <strong class="source-inline">loadcsv.py</strong> is placed inside the <strong class="source-inline">management/commands</strong> folder, now it works like a Django custom management command. You can go through the <strong class="source-inline">loadcsv.py</strong> file and read more about writing Django custom management commands at this link: <a href="https://docs.djangoproject.com/en/3.0/howto/custom-management-commands/.">https://docs.djangoproject.com/en/3.0/howto/custom-management-commands/.</a></p></li>
				<li>Now let's recreate a fresh database. Delete your SQL database file present in the project folder:<p class="source-code">rm reviews/db.sqlite3</p></li>
				<li>To create a fresh database again, execute the Django <strong class="source-inline">migrate</strong> command:<p class="source-code">python manage.py migrate</p><p>Now you can see the newly created <strong class="source-inline">db.sqlite3</strong> file under the <strong class="source-inline">reviews</strong> folder.</p></li>
				<li>Execute the custom management command <strong class="source-inline">loadcsv</strong> to populate the database:<p class="source-code">python manage.py loadcsv --csv reviews/management/commands/WebDevWithDjangoData.csv</p></li>
				<li>Using DB Browser for SQLite, verify that all the tables created by the <strong class="source-inline">bookr</strong> project are populated.</li>
			</ol>
			<h1 id="_idParaDest-120"><a id="_idTextAnchor122"/>Summary</h1>
			<p>In this chapter, we learned about some basic database concepts and their importance in application development. We used a free database visualization tool, DB Browser for SQLite, to understand what database tables and fields are, how records are stored in a database, and further performed some basic CRUD operations on the database using simple SQL queries.</p>
			<p>We then learned how Django provides a valuable abstraction layer called ORM that helps us interact seamlessly with relational databases using simple Python code, without having to compose SQL commands. As a part of ORM, we learned about Django models, migrations, and how they help propagate the changes to the Django models in the database.  </p>
			<p>We shored up our knowledge of databases by learning about database relationships, and their key types, in relational databases. We also worked with the Django shell, where we used Python code to perform the same CRUD queries we performed earlier using SQL. Later, we learned how to retrieve our data in a more refined manner using pattern matching and field lookups. As we learned these concepts, we made considerable progress on our Bookr application as well. We created models for our <strong class="source-inline">reviews</strong> app and gained all the skills we need to interact with the data stored inside the app's database. In the next chapter, we will learn how to create Django views, URL routing, and templates.</p>
		</div>
		<div>
			<div id="_idContainer113" class="Content">
			</div>
		</div>
	</body></html>