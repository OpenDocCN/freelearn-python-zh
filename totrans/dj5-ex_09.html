<html><head></head><body>
<div><h1 class="chapterNumber">9</h1>
<h1 class="chapterTitle" id="_idParaDest-257">Managing Payments and Orders</h1>
<p class="normal">In the previous chapter, you created a basic online shop with a product catalog and a shopping cart. You learned how to use Django sessions and built a custom context processor. You also learned how to launch asynchronous tasks using Celery and RabbitMQ.</p>
<p class="normal">In this chapter, you will learn how to integrate a payment gateway into your site to let users pay by credit card and manage order payments. You will also extend the administration site with different features.</p>
<p class="normal">In this chapter, you will:</p>
<ul>
<li class="bulletList">Integrate the Stripe payment gateway into your project</li>
<li class="bulletList">Process credit card payments with Stripe</li>
<li class="bulletList">Handle payment notifications and mark orders as paid</li>
<li class="bulletList">Export orders to CSV files</li>
<li class="bulletList">Create custom views for the administration site</li>
<li class="bulletList">Generate PDF invoices dynamically</li>
</ul>
<h1 class="heading-1" id="_idParaDest-258">Functional overview</h1>
<p class="normal"><em class="italic">Figure 9.1</em> shows a representation of the views, templates, and functionalities that will be built in this chapter:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_01.png"/></figure>
<p class="packt_figref">Figure 9.1: Diagram of the functionalities built in Chapter 9</p>
<p class="normal">In this chapter, you will create a new <code class="inlineCode">payment</code> app, where you will implement the <code class="inlineCode">payment_process</code> view to initiate a checkout session to pay orders with Stripe. You will build the <code class="inlineCode">payment_completed</code> view to redirect users after successful payments and the <code class="inlineCode">payment_canceled</code> view to redirect users if the payment is canceled. You will implement the <code class="inlineCode">export_to_csv</code> admin action to export orders in CSV format in the administration site. You will also build the admin view <code class="inlineCode">admin_order_detail</code> to display order details and the <code class="inlineCode">admin_order_pdf</code> view to generate PDF invoices dynamically. You will implement the <code class="inlineCode">stripe_webhook</code> webhook to receive asynchronous payment notifications from Stripe, and you will implement the <code class="inlineCode">payment_completed</code> asynchronous task to send invoices to clients when orders are paid.</p>
<p class="normal">The source code for this chapter can be found at <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter09">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter09</a>.</p>
<p class="normal">All Python packages used in this chapter are included in the <code class="inlineCode">requirements.txt</code> file in the source code for the chapter. You can follow the instructions to install each Python package in the following sections, or you can install all the requirements at once with the command <code class="inlineCode">python</code> <code class="inlineCode">-m</code> <code class="inlineCode">pip</code> <code class="inlineCode">install</code> <code class="inlineCode">-r</code> <code class="inlineCode">requirements.txt</code>.</p>
<h1 class="heading-1" id="_idParaDest-259">Integrating a payment gateway</h1>
<p class="normal">A payment gateway is a technology used by merchants to process payments from customers online. Using a payment gateway, you can manage customers’ orders and delegate payment processing to <a id="_idIndexMarker825"/>a reliable, secure third party. By using a trusted payment gateway, you won’t have to worry about the technical, security, and regulatory complexity of processing credit cards in your own system.</p>
<p class="normal">There are several payment gateway providers to choose from. We are going to integrate Stripe, which is a very popular payment gateway used by online services such as Shopify, Uber, Twitch, and GitHub, among others.</p>
<p class="normal">Stripe provides an <strong class="keyWord">Application Programming Interface </strong>(<strong class="keyWord">API</strong>) that allows you to process online payments with multiple<a id="_idIndexMarker826"/> payment methods, such as credit card, Google Pay, and Apple Pay. You can learn more about Stripe at <a href="https://www.stripe.com/">https://www.stripe.com/</a>.</p>
<p class="normal">Stripe provides<a id="_idIndexMarker827"/> different products related to payment processing. It can manage one-off payments, recurring payments for subscription services, multiparty payments for platforms and marketplaces, and more.</p>
<p class="normal">Stripe offers different integration methods, from Stripe-hosted payment forms to fully customizable checkout flows. We will integrate the <em class="italic">Stripe</em> <em class="italic">Checkout</em> product, which consists of a payment page optimized for conversion. Users will be able to easily pay with a credit card or other payment methods for the items they order. We will receive payment notifications from Stripe. You can see the <em class="italic">Stripe</em> <em class="italic">Checkout</em> documentation at <a href="https://stripe.com/docs/payments/checkout">https://stripe.com/docs/payments/checkout</a>.</p>
<p class="normal">By leveraging <em class="italic">Stripe</em> <em class="italic">Checkout</em> to process payments, you rely on a s<a id="_idIndexMarker828"/>olution that is secure and compliant with <strong class="keyWord">Payment Card Industry</strong> (<strong class="keyWord">PCI</strong>) requirements. You will be able to collect payments from Google Pay, Apple Pay, Afterpay, Alipay, SEPA direct debits, Bacs direct debits, BECS direct debits, iDEAL, Sofort, GrabPay, FPX, and other payment methods.</p>
<h2 class="heading-2" id="_idParaDest-260">Creating a Stripe account</h2>
<p class="normal">You need a Stripe account to<a id="_idIndexMarker829"/> integrate the payment gateway into your site. Let’s create an account to test the Stripe API. Open <a href="https://dashboard.stripe.com/register">https://dashboard.stripe.com/register</a> in your browser. </p>
<p class="normal">You will see a form like the following one:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_02.png"/></figure>
<p class="packt_figref">Figure 9.2: The Stripe signup form</p>
<p class="normal">Fill in the form with your own data and click on <strong class="screenText">Create account</strong>. You will receive an email from Stripe with a link to verify your email address. The email will look like this:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_03.png"/></figure>
<p class="packt_figref">Figure 9.3: The verification email to verify your email address</p>
<p class="normal">Open the email in your<a id="_idIndexMarker830"/> inbox and click on <strong class="screenText">Verify email</strong>.</p>
<p class="normal">You will be redirected to the Stripe dashboard screen, which will look like this:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_04.png"/></figure>
<p class="packt_figref">Figure 9.4: The Stripe dashboard after verifying the email address</p>
<p class="normal">At the top right of the screen, you can see that <strong class="screenText">Test mode</strong> is activated. Stripe provides you with a test environment and a production environment. If you own a business or are a freelancer, you can add your business details to activate the account and get access to process real payments. However, this is not necessary to implement and test payments through Stripe, as <a id="_idIndexMarker831"/>we will be working in the test environment.</p>
<p class="normal">You need to add an account name to process payments. Open <a href="https://dashboard.stripe.com/settings/account">https://dashboard.stripe.com/settings/account</a> in your browser. </p>
<p class="normal">You will see the following screen:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_05.png"/></figure>
<p class="packt_figref">Figure 9.5: The Stripe account settings</p>
<p class="normal">Under <strong class="screenText">Account name</strong>, enter the name of your choice and then click on <strong class="screenText">Save</strong>. Go back to the Stripe dashboard. You will see your account name displayed in the header:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_06.png"/></figure>
<p class="packt_figref">Figure 9.6: The Stripe dashboard header including the account name</p>
<p class="normal">We will continue by installing the Stripe<a id="_idIndexMarker832"/> Python SDK and adding Stripe to our Django project.</p>
<h2 class="heading-2" id="_idParaDest-261">Installing the Stripe Python library</h2>
<p class="normal">Stripe provides a Python library that <a id="_idIndexMarker833"/>simplifies dealing with its API. We are going to integrate the payment gateway into the project using the <code class="inlineCode">stripe</code> library.</p>
<p class="normal">You can find the source code for the Stripe Python library at <a href="https://github.com/stripe/stripe-python">https://github.com/stripe/stripe-python</a>.</p>
<p class="normal">Install the <code class="inlineCode">stripe</code> library from the shell using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install stripe==9.3.0
</code></pre>
<h2 class="heading-2" id="_idParaDest-262">Adding Stripe to your project</h2>
<p class="normal">Open <a href="https://dashboard.stripe.com/test/apikeys">https://dashboard.stripe.com/test/apikeys</a> in your browser. You can also access this page from the Stripe<a id="_idIndexMarker834"/> dashboard by clicking on <strong class="screenText">Developers</strong> and then clicking on <strong class="screenText">API keys</strong>. You will see the following screen:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_07.png"/></figure>
<p class="packt_figref">Figure 9.7: The Stripe test API keys screen</p>
<p class="normal">Stripe provides a key pair for the two different environments, test and production. There is a <strong class="screenText">Publishable key</strong> and a <strong class="screenText">Secret key</strong> for each environment. Test mode publishable keys have the prefix <code class="inlineCode">pk_test_</code> and live mode publishable keys have the prefix <code class="inlineCode">pk_live_</code>. Test mode secret keys have the prefix <code class="inlineCode">sk_test_</code> and live mode secret keys have the prefix <code class="inlineCode">sk_live_</code>.</p>
<p class="normal">You will need this information to authenticate requests to the Stripe API. You should always keep your private key <a id="_idIndexMarker835"/>secret and store it securely. The publishable key can be used in client-side code such as JavaScript scripts. You can read more about Stripe API keys at <a href="https://stripe.com/docs/keys">https://stripe.com/docs/keys</a>.</p>
<p class="normal">To facilitate separating configuration from code, we are going to use <code class="inlineCode">python-decouple</code>. You already used this library in <em class="chapterRef">Chapter 2</em>, <em class="italic">Enhancing Your Blog and Adding Social Features</em>.</p>
<p class="normal">Create a new file inside your project’s root directory and name it <code class="inlineCode">.env</code>. The <code class="inlineCode">.env</code> file will contain key-value pairs of environment variables. Add the Stripe credentials to the new file, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">STRIPE_PUBLISHABLE_KEY=pk_test_XXXX
STRIPE_SECRET_KEY=sk_test_XXXX
</code></pre>
<p class="normal">Replace the <code class="inlineCode">STRIPE_PUBLISHABLE_KEY</code> and <code class="inlineCode">STRIPE_SECRET_KEY</code> values with the test <strong class="screenText">Publishable key</strong> and <strong class="screenText">Secret key</strong> values provided by Stripe.</p>
<p class="normal">If you are using a <code class="inlineCode">git</code> repository for your code, make sure to include <code class="inlineCode">.env</code> in the <code class="inlineCode">.gitignore</code> file of your repository. By doing so, you ensure that credentials are excluded from the repository.</p>
<p class="normal">Install <code class="inlineCode">python-decouple</code> via <code class="inlineCode">pip</code> by running the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install python-decouple==3.8
</code></pre>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of your project and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> decouple </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> config</strong>
# ...
<strong class="hljs-slc">STRIPE_PUBLISHABLE_KEY = config(</strong><strong class="hljs-string-slc">'</strong><strong class="hljs-string-slc">STRIPE_PUBLISHABLE_KEY'</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">STRIPE_SECRET_KEY = config(</strong><strong class="hljs-string-slc">'STRIPE_SECRET_KEY'</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">STRIPE_API_VERSION = </strong><strong class="hljs-string-slc">'2024-04-10'</strong>
</code></pre>
<p class="normal">You will use Stripe API version <code class="inlineCode">2024-04-10</code>. You can see the release notes for this API version at <a href="https://stripe.com/docs/api/events/types">https://stripe.com/docs/upgrades#2024-04-10</a>.</p>
<div><p class="normal">You are using the test environment keys for the project. Once you go live and validate your Stripe account, you will obtain the production environment keys. In <em class="italic">Chapter 17</em>, <em class="italic">Going Live</em>, you will learn how to configure settings for multiple environments.</p>
</div>
<p class="normal">Let’s integrate the payment <a id="_idIndexMarker836"/>gateway into the checkout process. You can find the Python documentation for Stripe at <a href="https://stripe.com/docs/api/events/types">https://stripe.com/docs/api?lang=python</a>.</p>
<h2 class="heading-2" id="_idParaDest-263">Building the payment process</h2>
<p class="normal">The checkout process <a id="_idIndexMarker837"/>will work as follows:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">Add items to the shopping cart.</li>
<li class="numberedList">Check out the shopping cart.</li>
<li class="numberedList">Enter credit card details and pay.</li>
</ol>
<p class="normal">We are going to create a new application to manage payments. Create a new application in your project using the following command:</p>
<pre class="programlisting code"><code class="hljs-code">python manage.py startapp payment
</code></pre>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of the project and add the new application to the <code class="inlineCode">INSTALLED_APPS</code> setting, as follows. The new line is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">INSTALLED_APPS = [
    # ...
    'cart.apps.CartConfig',
    'orders.apps.OrdersConfig',
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'payment.apps.PaymentConfig'</strong><strong class="hljs-slc">,</strong>
'shop.apps.ShopConfig',
]
</code></pre>
<p class="normal">The <code class="inlineCode">payment</code> application is now active in the project.</p>
<p class="normal">Currently, users are able to place orders but they cannot pay for them. After clients place an order, we<a id="_idIndexMarker838"/> need to redirect them to the payment process.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">orders</code> application and include the following import:</p>
<pre class="programlisting code"><code class="hljs-code">from django.shortcuts import <strong class="hljs-slc">redirect, </strong>render
</code></pre>
<p class="normal">In the same file, find the following lines of the <code class="inlineCode">order_create</code> view:</p>
<pre class="programlisting code"><code class="hljs-code"># launch asynchronous task
order_created.delay(order.id)
return render(
  request, 'orders/order/created.html', {'order': order}
)
</code></pre>
<p class="normal">Replace them with the following code:</p>
<pre class="programlisting code"><code class="hljs-code"># launch asynchronous task
order_created.delay(order.id)
<strong class="hljs-comment-slc"># set the order in the session</strong>
<strong class="hljs-slc">request.session[</strong><strong class="hljs-string-slc">'order_id'</strong><strong class="hljs-slc">] = order.</strong><strong class="hljs-built_in-slc">id</strong>
<strong class="hljs-comment-slc"># redirect for payment</strong>
<strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> redirect(</strong><strong class="hljs-string-slc">'payment:process'</strong><strong class="hljs-slc">)</strong>
</code></pre>
<p class="normal">The edited view should look as follows:</p>
<pre class="programlisting code"><code class="hljs-code">from django.shortcuts import <strong class="hljs-slc">redirect, </strong>render
# ...
def order_create(request):
    cart = Cart(request)
    if request.method == 'POST':
        form = OrderCreateForm(request.POST)
        if form.is_valid():
            order = form.save()
            for item in cart:
                OrderItem.objects.create(
                    order=order,
                    product=item['product'],
                    price=item['price'],
                    quantity=item['quantity']
                )
            # clear the cart
            cart.clear()
            # launch asynchronous task
            order_created.delay(order.id)
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># set the order in the session</strong>
<strong class="hljs-slc">            request.session[</strong><strong class="hljs-string-slc">'order_id'</strong><strong class="hljs-slc">] = order.</strong><strong class="hljs-built_in-slc">id</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># redirect for payment</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> redirect(</strong><strong class="hljs-string-slc">'payment:process'</strong><strong class="hljs-slc">)</strong>
else:
        form = OrderCreateForm()
    return render(
        request,
        'orders/order/create.html',
        {'cart': cart, 'form': form}
    )
</code></pre>
<p class="normal">Instead of rendering the template <code class="inlineCode">orders/order/created.html</code> when placing a new order, the order ID is stored in the user session and the user is redirected to the <code class="inlineCode">payment:process</code> URL. We are <a id="_idIndexMarker839"/>going to implement this URL later. Remember that Celery has to be running for the <code class="inlineCode">order_created</code> task to be queued and executed.</p>
<p class="normal">Let’s integrate the payment gateway.</p>
<h3 class="heading-3" id="_idParaDest-264">Integrating Stripe Checkout</h3>
<p class="normal">The Stripe Checkout integration consists of a checkout page hosted by Stripe that allows the user to enter the payment<a id="_idIndexMarker840"/> details, usually a credit card, and then it collects the payment. If the payment is successful, Stripe redirects the client to a success page. If the payment is canceled by the client, it redirects the client to a cancel page.</p>
<p class="normal">We will implement three views:</p>
<ul>
<li class="bulletList"><code class="inlineCode">payment_process</code>: Creates a Stripe <strong class="keyWord">Checkout Session</strong> and redirects the client to the Stripe-hosted payment form. A checkout session is a programmatic representation of what the client sees when they are redirected to the payment form, including the products, quantities, currency, and amount to charge.</li>
<li class="bulletList"><code class="inlineCode">payment_completed</code>: Displays a message for successful payments. The user is redirected to this view if the payment is successful.</li>
<li class="bulletList"><code class="inlineCode">payment_canceled</code>: Displays a message for canceled payments. The user is redirected to this view if the payment is canceled.</li>
</ul>
<p class="normal"><em class="italic">Figure 9.8</em> shows the checkout payment flow:</p>
<figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="img/B21088_09_08.png"/></figure>
<p class="packt_figref">Figure 9.8: The checkout payment flow</p>
<p class="normal">The complete checkout process will work as follows:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">After an order is created, the user is redirected to the <code class="inlineCode">payment_process</code> view. The user is presented with <a id="_idIndexMarker841"/>an order summary and a button to proceed with the payment.</li>
<li class="numberedList">When the user proceeds to pay, a Stripe checkout session is created. The checkout session includes the list of items that the user will purchase, a URL to redirect the user to after a successful payment, and a URL to redirect the user to if the payment is canceled.</li>
<li class="numberedList">The view redirects the user to the Stripe-hosted checkout page. This page includes the payment form. The client enters their credit card details and submits the form.</li>
<li class="numberedList">Stripe processes the payment and redirects the client to the <code class="inlineCode">payment_completed</code> view. If the client doesn’t complete the payment, Stripe redirects the client to the <code class="inlineCode">payment_canceled</code> view instead.</li>
</ol>
<p class="normal">Let’s start building the payment <a id="_idIndexMarker842"/>views. Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">payment</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from decimal import Decimal
import stripe
from django.conf import settings
from django.shortcuts import get_object_or_404, redirect, render
from django.urls import reverse
from orders.models import Order
# create the Stripe instance
stripe.api_key = settings.STRIPE_SECRET_KEY
stripe.api_version = settings.STRIPE_API_VERSION
def payment_process(request):
    order_id = request.session.get('order_id')
    order = get_object_or_404(Order, id=order_id)
    if request.method == 'POST':
        success_url = request.build_absolute_uri(
            reverse('payment:completed')
        )
        cancel_url = request.build_absolute_uri(
            reverse('payment:canceled')
        )
        # Stripe checkout session data
        session_data = {
            'mode': 'payment',
            'client_reference_id': order.id,
            'success_url': success_url,
            'cancel_url': cancel_url,
            'line_items': []
        }
        # create Stripe checkout session
        session = stripe.checkout.Session.create(**session_data)
        # redirect to Stripe payment form
return redirect(session.url, code=303)
    else:
        return render(request, 'payment/process.html', locals())
</code></pre>
<p class="normal">In the previous code, the <code class="inlineCode">stripe</code> module is imported and the Stripe API key is set using the value of the <code class="inlineCode">STRIPE_SECRET_KEY</code> setting. The API version to use is also set using the value of the <code class="inlineCode">STRIPE_API_VERSION</code> setting.</p>
<p class="normal">The <code class="inlineCode">payment_process</code> view performs the following tasks:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">The current <code class="inlineCode">Order</code> object is retrieved from the database using the <code class="inlineCode">order_id</code> session key, which was stored previously in the session by the <code class="inlineCode">order_create</code> view.</li>
<li class="numberedList">The <code class="inlineCode">Order</code> object for the<a id="_idIndexMarker843"/> given ID is retrieved. By using the shortcut function <code class="inlineCode">get_object_or_404()</code>, an <code class="inlineCode">Http404</code> (page not found) exception is raised if no order is found with the given ID.</li>
<li class="numberedList">If the view is loaded with a <code class="inlineCode">GET</code> request, the template <code class="inlineCode">payment/process.html</code> is rendered and returned. This template will include the order summary and a button to proceed with the payment, which will generate a <code class="inlineCode">POST</code> request to the view.</li>
<li class="numberedList">Alternatively, if the view is loaded with a <code class="inlineCode">POST</code> request, a Stripe checkout session is created with <code class="inlineCode">stripe.checkout.Session.create()</code> using the following parameters:<ul>
<li class="bulletList"><code class="inlineCode">mode</code>: The mode of the checkout session. We use <code class="inlineCode">payment</code> for a one-time payment. You can see the different values accepted for this parameter at <a href="https://stripe.com/docs/api/checkout/sessions/object#checkout_session_object-mode">https://stripe.com/docs/api/checkout/sessions/object#checkout_session_object-mode</a>.</li>
<li class="bulletList"><code class="inlineCode">client_reference_id</code>: The unique reference for this payment. We will use this to reconcile the Stripe checkout session with our order. By passing the order ID, we link Stripe payments to orders in our system and we will be able to receive payment notifications from Stripe to mark the orders as paid.</li>
<li class="bulletList"><code class="inlineCode">success_url</code>: The URL for Stripe to redirect the user to if the payment is successful. We use <code class="inlineCode">request.build_absolute_uri()</code> to generate an absolute URI from the URL path. You can see the documentation for this method at <a href="https://docs.djangoproject.com/en/5.0/ref/request-response/#django.http.HttpRequest.build_absolute_uri">https://docs.djangoproject.com/en/5.0/ref/request-response/#django.http.HttpRequest.build_absolute_uri</a>.</li>
<li class="bulletList"><code class="inlineCode">cancel_url</code>: The URL for Stripe to redirect the user to if the payment is canceled.</li>
<li class="bulletList"><code class="inlineCode">line_items</code>: This is an empty list. We will next populate it with the order items to be purchased.</li>
</ul>
</li>
<li class="numberedList">After creating the checkout session, an HTTP redirect with status code <code class="inlineCode">303</code> is returned to redirect the user to Stripe. The status code <code class="inlineCode">303</code> is recommended to redirect web applications to<a id="_idIndexMarker844"/> a new URI after an HTTP <code class="inlineCode">POST</code> has been performed.</li>
</ol>
<p class="normal">You can see all the parameters to create a Stripe <code class="inlineCode">session</code> object at <a href="https://stripe.com/docs/api/checkout/sessions/create">https://stripe.com/docs/api/checkout/sessions/create</a>.</p>
<p class="normal">Let’s populate the <code class="inlineCode">line_items</code> list with the order items to create the checkout session. Each item will contain the name of the item, the amount to charge, the currency to use, and the quantity purchased.</p>
<p class="normal">Add the following code highlighted in bold to the <code class="inlineCode">payment_process</code> view:</p>
<pre class="programlisting code"><code class="hljs-code">def payment_process(request):
    order_id = request.session.get('order_id')
    order = get_object_or_404(Order, id=order_id)
    if request.method == 'POST':
        success_url = request.build_absolute_uri(
            reverse('payment:completed')
        )
        cancel_url = request.build_absolute_uri(
            reverse('payment:canceled')
        )
        # Stripe checkout session data
        session_data = {
            'mode': 'payment',
            'success_url': success_url,
            'cancel_url': cancel_url,
            'line_items': []
        }
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># add order items to the Stripe checkout session</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">for</strong><strong class="hljs-slc"> item </strong><strong class="hljs-keyword-slc">in</strong><strong class="hljs-slc"> order.items.</strong><strong class="hljs-built_in-slc">all</strong><strong class="hljs-slc">():</strong>
<strong class="hljs-slc">            session_data[</strong><strong class="hljs-string-slc">'line_items'</strong><strong class="hljs-slc">].append(</strong>
<strong class="hljs-slc">                {</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'price_data'</strong><strong class="hljs-slc">: {</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'unit_amount'</strong><strong class="hljs-slc">: </strong><strong class="hljs-built_in-slc">int</strong><strong class="hljs-slc">(item.price * Decimal(</strong><strong class="hljs-string-slc">'100'</strong><strong class="hljs-slc">)),</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'currency'</strong><strong class="hljs-slc">: </strong><strong class="hljs-string-slc">'usd'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'product_data'</strong><strong class="hljs-slc">: {</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'name'</strong><strong class="hljs-slc">: item.product.name,</strong>
<strong class="hljs-slc">                        },</strong>
<strong class="hljs-slc">                    },</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'quantity'</strong><strong class="hljs-slc">: item.quantity,</strong>
<strong class="hljs-slc">                }</strong>
<strong class="hljs-slc">            )</strong>
# create Stripe checkout session
        session = stripe.checkout.Session.create(**session_data)
        # redirect to Stripe payment form
return redirect(session.url, code=303)
    else:
        return render(request, 'payment/process.html', locals())
</code></pre>
<p class="normal">We use the following information<a id="_idIndexMarker845"/> for each item:</p>
<ul>
<li class="bulletList"><code class="inlineCode">price_data</code>: Price-related information:<ul>
<li class="bulletList"><code class="inlineCode">unit_amount</code>: The amount in cents to be collected by the payment. This is a positive integer representing how much to charge in the smallest currency unit with no decimal places. For example, to charge $10.00, this would be <code class="inlineCode">1000</code> (that is, 1,000 cents). The item price, <code class="inlineCode">item.price</code>, is multiplied by <code class="inlineCode">Decimal('100')</code> to obtain the value in cents, and then it is converted into an integer.</li>
<li class="bulletList"><code class="inlineCode">currency</code>: The currency to use in the three-letter ISO format. We use <code class="inlineCode">usd</code> for US dollars. You can see a list of supported currencies at <a href="https://stripe.com/docs/currencies">https://stripe.com/docs/currencies</a>.</li>
</ul>
</li>
<li class="bulletList"><code class="inlineCode">product_data</code>: Product-related information:<ul>
<li class="bulletList"><code class="inlineCode">name</code>: The name of the product</li>
</ul>
</li>
<li class="bulletList"><code class="inlineCode">quantity</code>: The number of units to purchase</li>
</ul>
<p class="normal">The <code class="inlineCode">payment_process</code> view is now ready. Let’s create simple views for the payment success and cancel pages.</p>
<p class="normal">Add the following code to the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">payment</code> application:</p>
<pre class="programlisting code"><code class="hljs-code">def payment_completed(request):
    return render(request, 'payment/completed.html')
def payment_canceled(request):
    return render(request, 'payment/canceled.html')
</code></pre>
<p class="normal">Create a new file inside the <code class="inlineCode">payment</code> application <a id="_idIndexMarker846"/>directory and name it <code class="inlineCode">urls.py</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.urls import path
from . import views
app_name = 'payment'
urlpatterns = [
    path('process/', views.payment_process, name='process'),
    path('completed/', views.payment_completed, name='completed'),
    path('canceled/', views.payment_canceled, name='canceled'),
]
</code></pre>
<p class="normal">These are the URLs for the payment workflow. We have included the following URL patterns:</p>
<ul>
<li class="bulletList"><code class="inlineCode">process</code>: The view that displays the order summary to the user, creates the Stripe checkout session, and redirects the user to the Stripe-hosted payment form</li>
<li class="bulletList"><code class="inlineCode">completed</code>: The view for Stripe to redirect the user to if the payment is successful</li>
<li class="bulletList"><code class="inlineCode">canceled</code>: The view for Stripe to redirect the user to if the payment is canceled</li>
</ul>
<p class="normal">Edit the main <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">myshop</code> project and include the URL patterns for the <code class="inlineCode">payment</code> application, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    path('admin/', admin.site.urls),
    path('cart/', include('cart.urls', namespace='cart')),
    path('orders/', include('orders.urls', namespace='orders')),
<strong class="hljs-slc">    path(</strong><strong class="hljs-string-slc">'payment/'</strong><strong class="hljs-slc">, include(</strong><strong class="hljs-string-slc">'payment.urls'</strong><strong class="hljs-slc">, namespace=</strong><strong class="hljs-string-slc">'payment'</strong><strong class="hljs-slc">)),</strong>
    path('', include('shop.urls', namespace='shop')),
]
</code></pre>
<p class="normal">We have placed the new path before the <code class="inlineCode">shop.urls</code> pattern to avoid an unintended pattern match with a pattern defined in <code class="inlineCode">shop.urls</code>. Remember that Django runs through each URL pattern in order and stops at the first one that matches the requested URL.</p>
<p class="normal">Let’s build a template for each <a id="_idIndexMarker847"/>view. Create the following file structure inside the <code class="inlineCode">payment</code> application directory:</p>
<pre class="programlisting con"><code class="hljs-con">templates/
    payment/
        process.html
        completed.html
        canceled.html
</code></pre>
<p class="normal">Edit the <code class="inlineCode">payment/process.html</code> template and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "shop/base.html" %}
{% load static %}
{% block title %}Pay your order{% endblock %}
{% block content %}
  &lt;h1&gt;Order summary&lt;/h1&gt;
&lt;table class="cart"&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Image&lt;/th&gt;
&lt;th&gt;Product&lt;/th&gt;
&lt;th&gt;Price&lt;/th&gt;
&lt;th&gt;Quantity&lt;/th&gt;
&lt;th&gt;Total&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
      {% for item in order.items.all %}
        &lt;tr class="row{% cycle "1" "2" %}"&gt;
&lt;td&gt;
&lt;img src="{% if item.product.image %}{{ item.product.image.url }}
            {% else %}{% static "img/no_image.png" %}{% endif %}"&gt;
&lt;/td&gt;
&lt;td&gt;{{ item.product.name }}&lt;/td&gt;
&lt;td class="num"&gt;${{ item.price }}&lt;/td&gt;
&lt;td class="num"&gt;{{ item.quantity }}&lt;/td&gt;
&lt;td class="num"&gt;${{ item.get_cost }}&lt;/td&gt;
&lt;/tr&gt;
      {% endfor %}
      &lt;tr class="total"&gt;
&lt;td colspan="4"&gt;Total&lt;/td&gt;
&lt;td class="num"&gt;${{ order.get_total_cost }}&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;form action="{% url "payment:process" %}" method="post"&gt;
&lt;input type="submit" value="Pay now"&gt;
    {% csrf_token %}
  &lt;/form&gt;
{% endblock %}
</code></pre>
<p class="normal">This is the template to display the order summary to the user and allow the client to proceed with the payment. It includes <a id="_idIndexMarker848"/>a form and a <strong class="screenText">Pay now</strong> button to submit it via <code class="inlineCode">POST</code>. When the form is submitted, the <code class="inlineCode">payment_process</code> view creates the Stripe checkout session and redirects the user to the Stripe-hosted payment form.</p>
<p class="normal">Edit the <code class="inlineCode">payment/completed.html</code> template and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "shop/base.html" %}
{% block title %}Payment successful{% endblock %}
{% block content %}
  &lt;h1&gt;Your payment was successful&lt;/h1&gt;
&lt;p&gt;Your payment has been processed successfully.&lt;/p&gt;
{% endblock %}
</code></pre>
<p class="normal">This is the template for the page that the user is redirected to after a successful payment.</p>
<p class="normal">Edit the <code class="inlineCode">payment/canceled.html</code> template and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "shop/base.html" %}
{% block title %}Payment canceled{% endblock %}
{% block content %}
  &lt;h1&gt;Your payment has not been processed&lt;/h1&gt;
&lt;p&gt;There was a problem processing your payment.&lt;/p&gt;
{% endblock %}
</code></pre>
<p class="normal">This is the template for the page that the user is redirected to when the payment is canceled.</p>
<p class="normal">We have implemented the <a id="_idIndexMarker849"/>necessary views to process payments, including their URL patterns and templates. It’s time to try out the checkout process.</p>
<h2 class="heading-2" id="_idParaDest-265">Testing the checkout process</h2>
<p class="normal">Execute the following<a id="_idIndexMarker850"/> command in the shell to start the RabbitMQ server<a id="_idIndexMarker851"/> with Docker:</p>
<pre class="programlisting con"><code class="hljs-con">docker run -it --rm --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3.13.1-management
</code></pre>
<p class="normal">This will run RabbitMQ on port <code class="inlineCode">5672</code> and the web-based management interface on port <code class="inlineCode">15672</code>.</p>
<p class="normal">Open another shell and start the Celery worker from your project directory with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">celery -A myshop worker -l info
</code></pre>
<p class="normal">Open one more shell and start the development server from your project directory with this command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/</code> in your browser, add some products to the shopping cart, and fill in the checkout form. Click the <strong class="screenText">Place order</strong> button. The order will be persisted to the database, the order ID will be saved in the current session, and you will be redirected to the payment process page.</p>
<p class="normal">The payment process page will look as follows:</p>
<figure class="mediaobject"><img alt="A picture containing graphical user interface  Description automatically generated" src="img/B21088_09_09.png"/></figure>
<p class="packt_figref">Figure 9.9: The payment process page including an order summary</p>
<div><p class="normal">Images in this chapter:</p>
<ul>
<li class="bulletList"><em class="italic">Green tea</em>: Photo by Jia Ye on Unsplash</li>
<li class="bulletList"><em class="italic">Red tea</em>: Photo by Manki Kim on Unsplash</li>
</ul>
</div>
<p class="normal">On this page, you can see an order <a id="_idIndexMarker852"/>summary and a <strong class="screenText">Pay now</strong> button. Click on <strong class="screenText">Pay now</strong>. The <code class="inlineCode">payment_process</code> view will create a Stripe checkout session, and<a id="_idIndexMarker853"/> you will be redirected to the Stripe-hosted payment form. </p>
<p class="normal">You will see the following page:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_10.png"/></figure>
<p class="packt_figref">Figure 9.10: The Stripe checkout payment from</p>
<h3 class="heading-3" id="_idParaDest-266">Using test credit cards</h3>
<p class="normal">Stripe provides different test credit cards from different card issuers and countries, which allows you to simulate<a id="_idIndexMarker854"/> payments to test all possible scenarios (successful payment, declined payment, etc.). The following table shows some of the cards you can test for different scenarios:</p>
<table class="table-container" id="table001">
<tbody>
<tr>
<td class="table-cell">
<p class="normal"><strong class="keyWord">Result</strong></p>
</td>
<td class="table-cell">
<p class="normal"><strong class="keyWord">Test Credit Card</strong></p>
</td>
<td class="table-cell">
<p class="normal"><strong class="keyWord">CVC</strong></p>
</td>
<td class="table-cell">
<p class="normal"><strong class="keyWord">Expiry date</strong></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal">Successful payment</p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlineCode">4242 4242 4242 4242</code></p>
</td>
<td class="table-cell">
<p class="normal">Any 3 digits</p>
</td>
<td class="table-cell">
<p class="normal">Any future date</p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal">Failed payment</p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlineCode">4000 0000 0000 0002</code></p>
</td>
<td class="table-cell">
<p class="normal">Any 3 digits</p>
</td>
<td class="table-cell">
<p class="normal">Any future date</p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal">Requires 3D secure authentication</p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlineCode">4000 0025 0000 3155</code></p>
</td>
<td class="table-cell">
<p class="normal">Any 3 digits</p>
</td>
<td class="table-cell">
<p class="normal">Any future date</p>
</td>
</tr>
</tbody>
</table>
<p class="normal">You can find the complete list<a id="_idIndexMarker855"/> of credit cards for testing at <a href="https://stripe.com/docs/testing">https://stripe.com/docs/testing</a>.</p>
<p class="normal">We are going to use the test card <code class="inlineCode">4242 4242 4242 4242</code>, which is a Visa card that returns a successful purchase. We will <a id="_idIndexMarker856"/>use the CVC <code class="inlineCode">123</code> and any future expiration date, such as <code class="inlineCode">12/29</code>. Enter the credit card details in the payment form as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_11.png"/></figure>
<p class="packt_figref">Figure 9.11: The payment form with the valid test credit card details</p>
<p class="normal">Click the <strong class="screenText">Pay</strong><strong class="keyWord"> </strong>button. The button text will change to <strong class="screenText">Processing…</strong>, as shown in <em class="italic">Figure 9.12</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_12.png"/></figure>
<p class="packt_figref">Figure 9.12: The payment form being processed</p>
<p class="normal">After a couple of <a id="_idIndexMarker857"/>seconds, you will see the button turn green, as in <em class="italic">Figure 9.13</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_13.png"/></figure>
<p class="packt_figref">Figure 9.13: The payment form after the payment is successful</p>
<p class="normal">Then, Stripe redirects your browser to the payment completed URL you provided when creating the checkout session. You <a id="_idIndexMarker858"/>will see the following page:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" src="img/B21088_09_14.png"/></figure>
<p class="packt_figref">Figure 9.14: The successful payment page</p>
<h3 class="heading-3" id="_idParaDest-267">Checking the payment information in the Stripe dashboard</h3>
<p class="normal">Access the <a id="_idIndexMarker859"/>Stripe dashboard at <a href="https://dashboard.stripe.com/test/payments">https://dashboard.stripe.com/test/payments</a>. Under <strong class="screenText">Payments</strong>, you will be able to see the <a id="_idIndexMarker860"/>payment, as in <em class="italic">Figure 9.15</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_15.png"/></figure>
<p class="packt_figref">Figure 9.15: The payment object with the status Succeeded in the Stripe dashboard</p>
<p class="normal">The payment status is <strong class="screenText">Succeeded</strong>. The payment description includes the <strong class="keyWord">payment intent</strong> ID that starts with <code class="inlineCode">pi_</code>. When a checkout session is confirmed, Stripe creates a payment intent associated with the session. A payment intent is used to collect a payment from the user. Stripe records all attempted payments as payment intents. Each payment intent has a unique ID, and it <a id="_idIndexMarker861"/>encapsulates the details of the transaction, such as the supported payment methods, the amount to collect, and the desired currency. Click on the transaction to access the payment details.</p>
<p class="normal">You will see the following screen:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_16.png"/></figure>
<p class="packt_figref">Figure 9.16: Payment details for a Stripe transaction</p>
<p class="normal">Here, you can see the payment information and the payment timeline, including payment changes. Under <strong class="screenText">Checkout summary</strong>, you can find the line items purchased, including the name, quantity, unit price, and amount. </p>
<p class="normal">Under <strong class="screenText">Payment details</strong>, you can see a breakdown of the amount <a id="_idIndexMarker862"/>paid and the Stripe fee for processing the payment.</p>
<p class="normal">Under this section, you will find a <strong class="screenText">Payment method</strong> section, including details about the payment method and the credit card checks performed by Stripe, as in <em class="italic">Figure 9.17</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_17.png"/></figure>
<p class="packt_figref">Figure 9.17: Payment method used in the Stripe transaction</p>
<p class="normal">Under this section, you will find another section named <strong class="screenText">Events and logs</strong>, as in <em class="italic">Figure 9.18</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_18.png"/></figure>
<p class="packt_figref">Figure 9.18: Events and logs for a Stripe transaction</p>
<p class="normal">This section contains all the activity related to the transaction, including requests to the Stripe API. You can click on any<a id="_idIndexMarker863"/> request to see the HTTP request to the Stripe API and the response in the JSON format.</p>
<p class="normal">Let’s review the activity events in chronological order, from bottom to top:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">First, a new checkout session is created by sending a <code class="inlineCode">POST</code> request to the Stripe API endpoint <code class="inlineCode">/v1/checkout/sessions</code>. The Stripe SDK method <code class="inlineCode">stripe.checkout.Session.create()</code> that is used in the <code class="inlineCode">payment_process</code> view builds and sends the request to the Stripe API, handling the response to return a <code class="inlineCode">session</code> object.</li>
<li class="numberedList">The user is redirected to the checkout page where they submit the payment form. A request to confirm the checkout session is sent by the Stripe checkout page.</li>
<li class="numberedList">A new payment intent is created.</li>
<li class="numberedList">A charge related to the payment intent is created.</li>
<li class="numberedList">The payment intent is now completed with a successful payment.</li>
<li class="numberedList">The checkout session is completed.</li>
</ol>
<p class="normal">Congratulations! You have<a id="_idIndexMarker864"/> successfully integrated Stripe Checkout into your project. Next, you will learn how to receive payment notifications from Stripe and how to reference Stripe payments in your shop orders.</p>
<h2 class="heading-2" id="_idParaDest-268">Using webhooks to receive payment notifications</h2>
<p class="normal">Stripe can push real-time events to our application by<a id="_idIndexMarker865"/> using webhooks. A <strong class="keyWord">webhook</strong>, also called a callback, can<a id="_idIndexMarker866"/> be thought of<a id="_idIndexMarker867"/> as an event-driven API instead of a request-driven API. Instead of polling the Stripe API <a id="_idIndexMarker868"/>frequently to know when a new payment is completed, Stripe can send an HTTP request to a URL of our application to notify us of successful payments in real time. The notification of these events will be asynchronous, when the event occurs, regardless of our synchronous calls to the Stripe API.</p>
<p class="normal">We will build a webhook endpoint to receive Stripe events. The webhook will consist of a view that will receive a JSON payload, with the event information to process it. We will use the event information to mark orders as paid when the checkout session is successfully completed.</p>
<h3 class="heading-3" id="_idParaDest-269">Creating a webhook endpoint</h3>
<p class="normal">You can add webhook<a id="_idIndexMarker869"/> endpoint URLs to your Stripe account to receive events. Since we are using webhooks and we don’t have a hosted website accessible through a public URL, we <a id="_idIndexMarker870"/>will use the Stripe <strong class="keyWord">Command-Line Interface</strong> (<strong class="keyWord">CLI</strong>) to listen to events and forward them to our local environment.</p>
<p class="normal">Open <a href="https://dashboard.stripe.com/test/webhooks">https://dashboard.stripe.com/test/webhooks</a> in your browser. You will see the following screen:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, chat or text message  Description automatically generated" src="img/B21088_09_19.png"/></figure>
<p class="packt_figref">Figure 9.19: The Stripe webhooks default screen</p>
<p class="normal">Here, you can see a schema of <a id="_idIndexMarker871"/>how Stripe notifies your integration asynchronously. You will get Stripe notifications in real time whenever an event happens. Stripe sends different types of events, like checkout session created, payment intent created, payment intent updated, or checkout session completed. You can find a list of all the types of events that Stripe sends at <a href="https://stripe.com/docs/api/events/types">https://stripe.com/docs/api/events/types</a>.</p>
<p class="normal">Click on <strong class="screenText">Test in a local environment</strong>. You will see the following screen:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" src="img/B21088_09_20.png"/></figure>
<p class="packt_figref">Figure 9.20: The Stripe webhook setup screen</p>
<p class="normal">This screen shows the steps to listen to Stripe events from your local environment. It also includes a sample Python<a id="_idIndexMarker872"/> webhook endpoint. Copy just the <code class="inlineCode">endpoint_secret</code> value.</p>
<p class="normal">Edit the <code class="inlineCode">.env</code> file of your project and add the following environment variable highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">STRIPE_PUBLISHABLE_KEY=pk_test_XXXX
STRIPE_SECRET_KEY=sk_test_XXXX
<strong class="hljs-slc">STRIPE_WEBHOOK_SECRET=whsec_XXXX</strong>
</code></pre>
<p class="normal">Replace the <code class="inlineCode">STRIPE_WEBHOOK_SECRET</code> value with the <code class="inlineCode">endpoint_secret</code> value provided by Stripe.</p>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of the <code class="inlineCode">myshop</code> project and add the following setting to it:</p>
<pre class="programlisting code"><code class="hljs-code"># ...
STRIPE_PUBLISHABLE_KEY = config('STRIPE_PUBLISHABLE_KEY')
STRIPE_SECERT_KEY = config('STRIPE_SECRET_KEY')
STRIPE_API_VERSION = '2024-04-10'
<strong class="hljs-slc">STRIPE_WEBHOOK_SECRET = config(</strong><strong class="hljs-string-slc">'STRIPE_WEBHOOK_SECRET'</strong><strong class="hljs-slc">)</strong>
</code></pre>
<p class="normal">To build a webhook endpoint, we will create a view that receives a JSON payload with the event details. We will check the event details to identify when a checkout session is completed and mark the related order as paid.</p>
<p class="normal">Stripe signs the webhook events it sends to your endpoints by including a <code class="inlineCode">Stripe-Signature</code> header, with a signature<a id="_idIndexMarker873"/> in each event. By checking the Stripe signature, you can verify that events were sent by Stripe and not by a third party. If you don’t check the signature, an attacker could send fake events to your webhooks intentionally. The Stripe SDK provides a method to verify signatures. We will use it to create a webhook that verifies the signature.</p>
<p class="normal">Add a new file to the <code class="inlineCode">payment/</code> application directory and name it <code class="inlineCode">webhooks.py</code>. Add the following code to the new <code class="inlineCode">webhooks.py</code> file:</p>
<pre class="programlisting code"><code class="hljs-code">import stripe
from django.conf import settings
from django.http import HttpResponse
from django.views.decorators.csrf import csrf_exempt
from orders.models import Order
@csrf_exempt
def stripe_webhook(request):
    payload = request.body
    sig_header = request.META['HTTP_STRIPE_SIGNATURE']
    event = None
try:
        event = stripe.Webhook.construct_event(
            payload, sig_header, settings.STRIPE_WEBHOOK_SECRET
        )
    except ValueError as e:
        # Invalid payload
return HttpResponse(status=400)
    except stripe.error.SignatureVerificationError as e:
        # Invalid signature
return HttpResponse(status=400)
    return HttpResponse(status=200)
</code></pre>
<p class="normal">The <code class="inlineCode">@csrf_exempt</code> decorator is used to prevent Django from performing the <strong class="keyWord">cross-site request forgery</strong> (<strong class="keyWord">CSRF</strong>) validation<a id="_idIndexMarker874"/> that is done by default for all <code class="inlineCode">POST</code> requests. We use the method <code class="inlineCode">stripe.Webhook.construct_event()</code> of the <code class="inlineCode">stripe</code> library to verify the event’s signature header. If the event’s payload or the signature is invalid, we return an HTTP <code class="inlineCode">400 Bad Request</code> response. Otherwise, we return an HTTP <code class="inlineCode">200 OK</code> response. </p>
<p class="normal">This is the basic functionality required to <a id="_idIndexMarker875"/>verify the signature and construct the event from the JSON payload. Now, we can implement the actions of the webhook endpoint.</p>
<p class="normal">Add the following code highlighted in bold to the <code class="inlineCode">stripe_webhook</code> view:</p>
<pre class="programlisting code"><code class="hljs-code">@csrf_exempt
def stripe_webhook(request):
    payload = request.body
    sig_header = request.META['HTTP_STRIPE_SIGNATURE']
    event = None
try:
        event = stripe.Webhook.construct_event(
            payload, sig_header, settings.STRIPE_WEBHOOK_SECRET
        )
    except ValueError as e:
        # Invalid payload
return HttpResponse(status=400)
    except stripe.error.SignatureVerificationError as e:
        # Invalid signature
return HttpResponse(status=400)
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> event.</strong><strong class="hljs-built_in-slc">type</strong><strong class="hljs-slc"> == </strong><strong class="hljs-string-slc">'checkout.session.completed'</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">        session = event.data.</strong><strong class="hljs-built_in-slc">object</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> (</strong>
<strong class="hljs-slc">            session.mode == </strong><strong class="hljs-string-slc">'payment'</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">and</strong><strong class="hljs-slc"> session.payment_status == </strong><strong class="hljs-string-slc">'paid'</strong>
<strong class="hljs-slc">        ):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">try</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">                order = Order.objects.get(</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">id</strong><strong class="hljs-slc">=session.client_reference_id</strong>
<strong class="hljs-slc">                )</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">except</strong><strong class="hljs-slc"> Order.DoesNotExist:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> HttpResponse(status=</strong><strong class="hljs-number-slc">404</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># mark order as paid</strong>
<strong class="hljs-slc">            order.paid = </strong><strong class="hljs-literal-slc">True</strong>
<strong class="hljs-slc">            order.save()</strong>
return HttpResponse(status=200)
</code></pre>
<p class="normal">In the new code, we check whether the event received is <code class="inlineCode">checkout.session.completed</code>. This event indicates that the checkout session has been successfully completed. If we receive this event, we retrieve the <code class="inlineCode">session</code> object and check whether the session <code class="inlineCode">mode</code> is <code class="inlineCode">payment</code> because this is the expected mode for one-off payments. </p>
<p class="normal">Then, we get the <code class="inlineCode">client_reference_id</code> attribute that<a id="_idIndexMarker876"/> we used when we created the checkout session and use the Django ORM to retrieve the <code class="inlineCode">Order</code> object with the given <code class="inlineCode">id</code>. If the order does not exist, we raise an HTTP <code class="inlineCode">404</code> exception. Otherwise, we mark the order as paid with <code class="inlineCode">order.paid = True</code>, and we save the order in the database.</p>
<p class="normal">Edit the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">payment</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django.urls import path
from . import views<strong class="hljs-slc">, webhooks</strong>
app_name = 'payment'
urlpatterns = [
    path('process/', views.payment_process, name='process'),
    path('completed/', views.payment_completed, name='completed'),
    path('canceled/', views.payment_canceled, name='canceled'),
<strong class="hljs-slc">    path(</strong><strong class="hljs-string-slc">'webhook/'</strong><strong class="hljs-slc">, webhooks.stripe_webhook, name=</strong><strong class="hljs-string-slc">'stripe-webhook'</strong><strong class="hljs-slc">),</strong>
]
</code></pre>
<p class="normal">We have imported the <code class="inlineCode">webhooks</code> module and added the URL pattern for the Stripe webhook.</p>
<h3 class="heading-3" id="_idParaDest-270">Testing webhook notifications</h3>
<p class="normal">To test webhooks, you <a id="_idIndexMarker877"/>need to install the Stripe CLI. The Stripe CLI is a developer tool that allows you to test and manage your integration with Stripe directly from your shell. You will find installation instructions at <a href="https://stripe.com/docs/stripe-cli#install">https://stripe.com/docs/stripe-cli#install</a>.</p>
<p class="normal">If you are using macOS or Linux, you can install the Stripe CLI with Homebrew using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">brew install stripe/stripe-cli/stripe
</code></pre>
<p class="normal">If you are using Windows, or you are using macOS or Linux without Homebrew, download the latest Stripe CLI release for macOS, Linux, or Windows from <a href="https://github.com/stripe/stripe-cli/releases/latest">https://github.com/stripe/stripe-cli/releases/latest</a> and unzip the file. If you are using Windows, run the unzipped <code class="inlineCode">.exe</code> file.</p>
<p class="normal">After installing the Stripe CLI, run<a id="_idIndexMarker878"/> the following command from a shell:</p>
<pre class="programlisting con"><code class="hljs-con">stripe login
</code></pre>
<p class="normal">You will see the following output:</p>
<pre class="programlisting con"><code class="hljs-con">Your pairing code is: xxxx-yyyy-zzzz-oooo This pairing code verifies your authentication with Stripe.Press Enter to open the browser or visit https://dashboard.stripe.com/stripecli/confirm_auth?t=....
</code></pre>
<p class="normal">Press <em class="italic">Enter</em> or open the URL in your browser. You will see the following screen:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" src="img/B21088_09_21.png"/></figure>
<p class="packt_figref">Figure 9.21: The Stripe CLI pairing screen</p>
<p class="normal">Verify that the pairing code<a id="_idIndexMarker879"/> in the Stripe CLI matches the one shown on the website and click on <strong class="screenText">Allow access</strong>. You will see the following message:</p>
<figure class="mediaobject"><img alt="Graphical user interface, application, Teams  Description automatically generated" src="img/B21088_09_22.png"/></figure>
<p class="packt_figref">Figure 9.22: The Stripe CLI pairing confirmation</p>
<p class="normal">Now, run the following command from your shell:</p>
<pre class="programlisting con"><code class="hljs-con">stripe listen --forward-to 127.0.0.1:8000/payment/webhook/
</code></pre>
<p class="normal">We use this command to tell Stripe to listen to events and forward them to our localhost. We use port <code class="inlineCode">8000</code>, where the<a id="_idIndexMarker880"/> Django development server is running, and the path <code class="inlineCode">/payment/webhook/</code>, which matches the URL pattern of our webhook.</p>
<p class="normal">You will see the following output:</p>
<pre class="programlisting con"><code class="hljs-con">Getting ready... &gt; Ready! You are using Stripe API Version [2024-04-10]. Your webhook signing secret is xxxxxxxxxxxxxxxxxxx (^C to quit)
</code></pre>
<p class="normal">Here, you can see the webhook secret. Check that the webhook signing secret matches the <code class="inlineCode">STRIPE_WEBHOOK_SECRET</code> setting in the <code class="inlineCode">settings.py</code> file of your project.</p>
<p class="normal">Open <a href="https://dashboard.stripe.com/test/webhooks">https://dashboard.stripe.com/test/webhooks</a> in your browser. You will see the following screen:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_23.png"/></figure>
<p class="packt_figref">Figure 9.23: The Stripe Webhooks page</p>
<p class="normal">Under <strong class="screenText">Local listeners</strong>, you will see the local listener that we created.</p>
<div><p class="normal">In a production environment, the Stripe CLI is not needed. Instead, you would need to add a hosted webhook endpoint using the URL of your hosted application.</p>
</div>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/</code> in your <a id="_idIndexMarker881"/>browser, add some products to the shopping cart, and complete the checkout process.</p>
<p class="normal">Check the shell where you are running the Stripe CLI:</p>
<pre class="programlisting con"><code class="hljs-con">2024-01-03 18:06:13   --&gt; <strong class="hljs-slc">payment_intent.created</strong> [evt_...]
2024-01-03 18:06:13  &lt;--  [200] POST http://127.0.0.1:8000/payment/webhook/ [evt_...]
2024-01-03 18:06:13   --&gt; <strong class="hljs-slc">payment_intent.succeeded</strong> [evt_...]
2024-01-03 18:06:13  &lt;--  [200] POST http://127.0.0.1:8000/payment/webhook/ [evt_...]
2024-01-03 18:06:13   --&gt; <strong class="hljs-slc">charge.succeeded</strong> [evt_...]
2024-01-03 18:06:13  &lt;--  [200] POST http://127.0.0.1:8000/payment/webhook/ [evt_...]
2024-01-03 18:06:14   --&gt; <strong class="hljs-slc">checkout.session.completed</strong> [evt_...]
2024-01-03 18:06:14  &lt;--  [200] POST http://127.0.0.1:8000/payment/webhook/ [evt_...]
</code></pre>
<p class="normal">You can see the different events that have been sent by Stripe to the local webhook endpoint. The events might be in a different order than above. Stripe doesn’t guarantee the delivery of events in the order in which they are generated. Let’s review the events:</p>
<ul>
<li class="bulletList"><code class="inlineCode">payment_intent.created</code>: The payment intent has been created.</li>
<li class="bulletList"><code class="inlineCode">payment_intent.succeeded</code>: The payment intent succeeded.</li>
<li class="bulletList"><code class="inlineCode">charge.succeeded</code>: The charge associated with the payment intent succeeded.</li>
<li class="bulletList"><code class="inlineCode">checkout.session.completed</code>: The checkout session has been completed. This is the event that we use to mark the order as paid.</li>
</ul>
<p class="normal">The <code class="inlineCode">stripe_webhook</code> webhook returns an HTTP <code class="inlineCode">200 OK</code> response to all of the requests sent by Stripe. However, we<a id="_idIndexMarker882"/> only process the event <code class="inlineCode">checkout.session.completed</code> to mark the order related to the payment as paid.</p>
<p class="normal">Next, open <code class="inlineCode">http://127.0.0.1:8000/admin/orders/order/</code> in your browser. The order should now be marked as paid:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_24.png"/></figure>
<p class="packt_figref">Figure 9.24: An order marked as paid in the order list of the administration site</p>
<p class="normal">Now, orders get automatically marked as paid with Stripe payment notifications. Next, you are going to learn how to reference Stripe payments in your shop orders.</p>
<h2 class="heading-2" id="_idParaDest-271">Referencing Stripe payments in orders</h2>
<p class="normal">Each Stripe payment has a <a id="_idIndexMarker883"/>unique identifier. We can use the payment ID to associate each order with its corresponding Stripe payment. We will add a new field to the <code class="inlineCode">Order</code> model of the <code class="inlineCode">orders</code> application so that we can reference the related payment by its ID. This will allow us to link each order with the related Stripe transaction.</p>
<p class="normal">Edit the <code class="inlineCode">models.py</code> file of the <code class="inlineCode">orders</code> application and add the following field to the <code class="inlineCode">Order</code> model. The new field is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">class Order(models.Model):
    # ...
<strong class="hljs-slc">    stripe_id = models.CharField(max_length=</strong><strong class="hljs-number-slc">250</strong><strong class="hljs-slc">, blank=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">)</strong>
</code></pre>
<p class="normal">Let’s sync this field with the database. Use the following command to generate the database migrations for the project:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py makemigrations
</code></pre>
<p class="normal">You will see the following output:</p>
<pre class="programlisting con"><code class="hljs-con">Migrations for 'orders':
  orders/migrations/0002_order_stripe_id.py
    - Add field stripe_id to order
</code></pre>
<p class="normal">Apply the migration to the database with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py migrate
</code></pre>
<p class="normal">You will see output that ends with the following line:</p>
<pre class="programlisting con"><code class="hljs-con">Applying orders.0002_order_stripe_id... OK
</code></pre>
<p class="normal">The model changes are now<a id="_idIndexMarker884"/> synced with the database. Now, you will be able to store the Stripe payment ID for each order.</p>
<p class="normal">Edit the <code class="inlineCode">stripe_webhook</code> function in the <code class="inlineCode">webhooks.py</code> file of the payment application and add the following lines highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"># ...
@csrf_exempt
def stripe_webhook(request):
    # ...
if event.type == 'checkout.session.completed':
        session = event.data.object
if (
            session.mode == 'payment'
and session.payment_status == 'paid'
        ):
            try:
                order = Order.objects.get(
                    id=session.client_reference_id
                )
            except Order.DoesNotExist:
                return HttpResponse(status=404)
            # mark order as paid
            order.paid = True
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># store Stripe payment ID</strong>
<strong class="hljs-slc">            order.stripe_id = session.payment_intent</strong>
            order.save()
    return HttpResponse(status=200)
</code></pre>
<p class="normal">With this change, when receiving a webhook notification for a completed checkout session, the payment intent ID is stored in the <code class="inlineCode">stripe_id</code> field of the <code class="inlineCode">Order</code> object.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/</code> in your browser, add some products to the shopping cart, and complete the checkout process. Then, access <code class="inlineCode">http://127.0.0.1:8000/admin/orders/order/</code> in your browser and click on the latest order ID to edit it. The <code class="inlineCode">stripe_id</code> field should contain the payment intent ID, as shown in <em class="italic">Figure 9.25</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_25.png"/></figure>
<p class="packt_figref">Figure 9.25: The Stripe id field with the payment intent ID</p>
<p class="normal">Great! We have successfully referenced<a id="_idIndexMarker885"/> Stripe payments in orders. Now, we can add Stripe payment IDs to the order list on the administration site. We can also include a link to each payment ID to see the payment details in the Stripe dashboard.</p>
<p class="normal">Edit the <code class="inlineCode">models.py</code> file of the <code class="inlineCode">orders</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.conf </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> settings</strong>
from django.db import models
class Order(models.Model):
    # ...
class Meta:
        # ...
def __str__(self):
        return f'Order {self.id}'
def get_total_cost(self):
        return sum(item.get_cost() for item in self.items.all())
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">get_stripe_url</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">not</strong><strong class="hljs-slc"> self.stripe_id:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># no payment associated</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">''</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'_test_'</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">in</strong><strong class="hljs-slc"> settings.STRIPE_SECRET_KEY:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># Stripe path for test payments</strong>
<strong class="hljs-slc">            path = </strong><strong class="hljs-string-slc">'/test/'</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">else</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># Stripe path for real payments</strong>
<strong class="hljs-slc">            path = </strong><strong class="hljs-string-slc">'</strong><strong class="hljs-string-slc">/'</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">f'https://dashboard.stripe.com</strong><strong class="hljs-subst-slc">{path}</strong><strong class="hljs-string-slc">payments/</strong><strong class="hljs-subst-slc">{self.stripe_id}</strong><strong class="hljs-string-slc">'</strong>
</code></pre>
<p class="normal">We have added the new <code class="inlineCode">get_stripe_url()</code> method to the <code class="inlineCode">Order</code> model. This method is used to return the Stripe dashboard’s URL for the payment associated with the order. If no payment ID is stored in the <code class="inlineCode">stripe_id</code> field of the <code class="inlineCode">Order</code> object, an empty string is returned. Otherwise, the URL for the payment in the Stripe dashboard is returned. We check if the string <code class="inlineCode">_test_</code> is present in the <code class="inlineCode">STRIPE_SECRET_KEY</code> setting to discriminate the production environment <a id="_idIndexMarker886"/>from the test environment. Payments in the production environment follow the pattern <code class="inlineCode">https://dashboard.stripe.com/payments/{id}</code>, whereas test payments follow the pattern <code class="inlineCode">https://dashboard.stripe.com/payments/test/{id}</code>.</p>
<p class="normal">Let’s add a link to each <code class="inlineCode">Order</code> object on the list display page of the administration site.</p>
<p class="normal">Edit the <code class="inlineCode">admin.py</code> file of the <code class="inlineCode">orders</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"># ...
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.utils.safestring </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> mark_safe</strong>
<strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">order_payment</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">obj</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc">    url = obj.get_stripe_url()</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> obj.stripe_id:</strong>
<strong class="hljs-slc">        html = </strong><strong class="hljs-string-slc">f'&lt;a href="</strong><strong class="hljs-subst-slc">{url}</strong><strong class="hljs-string-slc">" target="_blank"&gt;</strong><strong class="hljs-subst-slc">{obj.stripe_id}</strong><strong class="hljs-string-slc">&lt;/a&gt;'</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> mark_safe(html)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">''</strong>
<strong class="hljs-slc">order_payment.short_description = </strong><strong class="hljs-string-slc">'Stripe payment'</strong>
@admin.register(Order)
class OrderAdmin(admin.ModelAdmin):
    list_display = [
        'id',
        'first_name',
        'last_name',
        'email',
        'address',
        'postal_code',
        'city',
        'paid',
<strong class="hljs-slc">        order_payment,</strong>
'created',
        'updated'
    ]
    # ...
</code></pre>
<p class="normal">The <code class="inlineCode">order_stripe_payment()</code> function takes an <code class="inlineCode">Order</code> object as an argument and returns an HTML link with the payment<a id="_idIndexMarker887"/> URL in Stripe. Django escapes HTML output by default. We use the <code class="inlineCode">mark_safe</code> function to avoid auto-escaping.</p>
<div><p class="normal">Avoid using <code class="inlineCode">mark_safe</code> on input that has come from the user to avoid <strong class="keyWord">Cross-Site Scripting</strong> (<strong class="keyWord">XSS</strong>). XSS enables attackers to inject client-side scripts into web content viewed by other users.</p>
</div>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/admin/orders/order/</code> in your browser. You will see a new column named <strong class="screenText">STRIPE PAYMENT</strong>. You will see the related Stripe payment ID for the latest order. If you click on the payment ID, you will be taken to the payment URL in Stripe, where you can find the additional payment details.</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_26.png"/></figure>
<p class="packt_figref">Figure 9.26: The Stripe payment ID for an Order object in the administration site</p>
<p class="normal">Now, you automatically store<a id="_idIndexMarker888"/> Stripe payment IDs in orders when receiving payment notifications. You have successfully integrated Stripe into your project.</p>
<h2 class="heading-2" id="_idParaDest-272">Going live</h2>
<p class="normal">Once you have tested <a id="_idIndexMarker889"/>your integration, you can apply for a production Stripe account. When you are ready to move into production, remember to replace your test Stripe credentials with the live ones in the <code class="inlineCode">settings.py</code> file. You will also need to add a webhook endpoint for your hosted website at <a href="https://dashboard.stripe.com/webhooks">https://dashboard.stripe.com/webhooks</a> instead of using the Stripe CLI. <em class="chapterRef">Chapter 17</em>, <em class="italic">Going Live</em>, will teach you how to configure project settings for multiple environments.</p>
<h1 class="heading-1" id="_idParaDest-273">Exporting orders to CSV files</h1>
<p class="normal">Sometimes, you might want to export the information contained in a model to a file so that you can import it into another system. One of the most widely used formats to export/import data is the <strong class="keyWord">Comma-Separated Values</strong> (<strong class="keyWord">CSV</strong>) format. A CSV file is a plain text file consisting of a number of <a id="_idIndexMarker890"/>records. There is usually one record per line and some delimiter character, usually a literal comma, separating the record fields. We are going to customize the administration site to be able to export orders to CSV files.</p>
<h2 class="heading-2" id="_idParaDest-274">Adding custom actions to the administration site</h2>
<p class="normal">Django offers a wide range of options <a id="_idIndexMarker891"/>to customize the administration site. You are going to modify the object list view to include a custom<a id="_idIndexMarker892"/> administration action. You can implement custom administration actions to allow staff users to apply actions to multiple elements at once in the change list view.</p>
<p class="normal">An administration action works as follows: a user selects objects from the administration object list page with checkboxes, selects an action to perform on all of the selected items, and then executes the actions. <em class="italic">Figure 9.27</em> shows where the actions are located on the administration site:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, chat or text message  Description automatically generated" src="img/B21088_09_27.png"/></figure>
<p class="packt_figref">Figure 9.27: The drop-down menu for Django administration actions</p>
<p class="normal">You can create a custom action <a id="_idIndexMarker893"/>by writing a regular function that<a id="_idIndexMarker894"/><a id="_idIndexMarker895"/> receives the following parameters:</p>
<ul>
<li class="bulletList">The current <code class="inlineCode">ModelAdmin</code> being displayed</li>
<li class="bulletList">The current request object as an <code class="inlineCode">HttpRequest</code> instance</li>
<li class="bulletList">A QuerySet for the objects selected by the user</li>
</ul>
<p class="normal">This function will be executed when the action is triggered from the administration site.</p>
<p class="normal">You are going to create a custom administration action to download a list of orders as a CSV file.</p>
<p class="normal">Edit the <code class="inlineCode">admin.py</code> file of the <code class="inlineCode">orders</code> application and add the following code before the <code class="inlineCode">OrderAdmin</code> class:</p>
<pre class="programlisting code"><code class="hljs-code">import csv
import datetime
from django.http import HttpResponse
def export_to_csv(modeladmin, request, queryset):
    opts = modeladmin.model._meta
    content_disposition = (
        f'attachment; filename={opts.verbose_name}.csv'
 )
    response = HttpResponse(content_type='text/csv')
    response['Content-Disposition'] = content_disposition
    writer = csv.writer(response)
    fields = [
        field
        for field in opts.get_fields()
        if not field.many_to_many and not field.one_to_many
    ]
    # Write a first row with header information
    writer.writerow([field.verbose_name for field in fields])
    # Write data rows
for obj in queryset:
        data_row = []
        for field in fields:
            value = getattr(obj, field.name)
            if isinstance(value, datetime.datetime):
                value = value.strftime('%d/%m/%Y')
            data_row.append(value)
        writer.writerow(data_row)
    return response
export_to_csv.short_description = 'Export to CSV'
</code></pre>
<p class="normal">In this code, you<a id="_idIndexMarker896"/> perform the following tasks:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">You create an instance of <code class="inlineCode">HttpResponse</code>, specifying the <code class="inlineCode">text/csv</code> content type, to tell the browser that the<a id="_idIndexMarker897"/> response has to be treated as a CSV file. You also add a <code class="inlineCode">Content-Disposition</code> header to indicate that the HTTP response contains an attached file.</li>
<li class="numberedList">You create a CSV <code class="inlineCode">writer</code> object that will write to the <code class="inlineCode">response</code> object.</li>
<li class="numberedList">You get the <code class="inlineCode">model</code> fields dynamically using the <code class="inlineCode">get_fields()</code> method of the model’s <code class="inlineCode">_meta</code> options. You exclude many-to-many and one-to-many relationships.</li>
<li class="numberedList">You write a header row, including the field names.</li>
<li class="numberedList">You iterate over the given QuerySet and write a row for each object returned by the QuerySet. You take care of formatting <code class="inlineCode">datetime</code> objects because the output value for CSV has to be a string.</li>
<li class="numberedList">You customize the display name for the action in the action’s drop-down element of the administration site by setting a <code class="inlineCode">short_description</code> attribute on the function.</li>
</ol>
<p class="normal">You have created a <a id="_idIndexMarker898"/>generic administration action that can<a id="_idIndexMarker899"/> be added to any <code class="inlineCode">ModelAdmin</code> class.</p>
<p class="normal">Finally, add the new <code class="inlineCode">export_to_csv</code> administration action to the <code class="inlineCode">OrderAdmin</code> class, as follows. The new code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">@admin.register(Order)
class OrderAdmin(admin.ModelAdmin):
    # ...
<strong class="hljs-slc">    actions = [export_to_csv]</strong>
</code></pre>
<p class="normal">Start the development server with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/admin/orders/order/</code> in your browser. The resulting administration action should look like this:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_28.png"/></figure>
<p class="packt_figref">Figure 9.28: Using the custom Export to CSV administration action</p>
<p class="normal">Select some orders, choose the <strong class="screenText">Export to CSV</strong> action from the select box, and then click the <strong class="screenText">Go</strong> button. Your browser will download the generated CSV file named <code class="inlineCode">order.csv</code>. Open the downloaded file using a text editor. You should see content with the following format, including a header row and a row for each <code class="inlineCode">Order</code> object you selected:</p>
<pre class="programlisting code"><code class="hljs-code">ID,first name,last name,email,address,postal code,city,created,updated,paid,stripe id
4,Antonio,Melé,email@domain.com,20 W 34th St,10001,New York,03/01/2024,03/01/2024,True,pi_3ORvzkGNwIe5nm8S1wVd7l7i
...
</code></pre>
<p class="normal">As you can see, creating administration actions is pretty straightforward. You can learn more about generating CSV files with Django at <a href="https://docs.djangoproject.com/en/5.0/howto/outputting-csv/">https://docs.djangoproject.com/en/5.0/howto/outputting-csv/</a>.</p>
<p class="normal">If you want to add more <a id="_idIndexMarker900"/>advanced import/export functionalities to your administration site, you can use the third-party application <code class="inlineCode">django-import-export</code>. You can find its documentation at <a href="https://django-import-export.readthedocs.io/en/latest/">https://django-import-export.readthedocs.io/en/latest/</a>.</p>
<p class="normal">The example we<a id="_idIndexMarker901"/> have implemented works well for small to medium datasets. Given that the export occurs within an HTTP request, very large datasets could lead to server timeouts if the server closes the connection before the export process concludes. To circumvent this, you can generate exports asynchronously using Celery, with the <code class="inlineCode">django-import-export-celery</code> application. This project is available at <a href="https://github.com/auto-mat/django-import-export-celery">https://github.com/auto-mat/django-import-export-celery</a>.</p>
<p class="normal">Next, you are going to customize the administration site further by creating a custom administration view.</p>
<h1 class="heading-1" id="_idParaDest-275">Extending the administration site with custom views</h1>
<p class="normal">Sometimes, you may want to customize the administration site beyond what is possible by configuring <code class="inlineCode">ModelAdmin</code>, creating administration actions, and overriding administration templates. You<a id="_idIndexMarker902"/> might want to implement additional functionalities that are not available in existing administration views or templates. If this is the case, you need to create a custom administration view. With a custom view, you can build any functionality you want; you just have to make sure that only staff users can access your view and that you maintain the administration look and feel by making your template extend an administration template.</p>
<p class="normal">Let’s create a custom view to display information about an order. Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">orders</code> application and <a id="_idIndexMarker903"/>add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.contrib.admin.views.decorators </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> staff_member_required</strong>
from django.shortcuts import <strong class="hljs-slc">get_object_or_404, </strong>redirect, render
from cart.cart import Cart
from .forms import OrderCreateForm
from .models import Order, OrderItem
from .tasks import order_created
def order_create(request):
    # ...
<strong class="hljs-meta-slc">@staff_member_required</strong>
<strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">admin_order_detail</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">request, order_id</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc">    order = get_object_or_404(Order, </strong><strong class="hljs-built_in-slc">id</strong><strong class="hljs-slc">=order_id)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> render(</strong>
<strong class="hljs-slc">        request, </strong><strong class="hljs-string-slc">'admin/orders/order/detail.html'</strong><strong class="hljs-slc">, {</strong><strong class="hljs-string-slc">'order'</strong><strong class="hljs-slc">: order}</strong>
<strong class="hljs-slc">    )</strong>
</code></pre>
<p class="normal">The <code class="inlineCode">staff_member_required</code> decorator checks that both the <code class="inlineCode">is_active</code> and <code class="inlineCode">is_staff</code> fields of the user requesting the page are set to <code class="inlineCode">True</code>. In this view, you get the <code class="inlineCode">Order</code> object with the given ID and render a template to display the order.</p>
<p class="normal">Next, edit the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">orders</code> application and add the following URL pattern highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    path('create/', views.order_create, name='order_create'),
<strong class="hljs-slc">    path(</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'admin/order/&lt;int:order_id&gt;/'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        views.admin_order_detail,</strong>
<strong class="hljs-slc">        name=</strong><strong class="hljs-string-slc">'admin_order_detail'</strong>
<strong class="hljs-string-slc"> </strong><strong class="hljs-slc">),</strong>
]
</code></pre>
<p class="normal">Create the following file structure inside the <code class="inlineCode">templates/</code> directory of the <code class="inlineCode">orders</code> application:</p>
<pre class="programlisting con"><code class="hljs-con">admin/
    orders/
        order/
            detail.html
</code></pre>
<p class="normal">Edit the <code class="inlineCode">detail.html</code> template <a id="_idIndexMarker904"/>and add the following content to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "admin/base_site.html" %}
{% block title %}
  Order {{ order.id }} {{ block.super }}
{% endblock %}
{% block breadcrumbs %}
  &lt;div class="breadcrumbs"&gt;
&lt;a href="{% url "admin:index" %}"&gt;Home&lt;/a&gt; &amp;rsaquo;
&lt;a href="{% url "admin:orders_order_changelist" %}"&gt;Orders&lt;/a&gt;
&amp;rsaquo;
&lt;a href="{% url "admin:orders_order_change" order.id %}"&gt;Order {{ order.id }}&lt;/a&gt;
&amp;rsaquo; Detail
  &lt;/div&gt;
{% endblock %}
{% block content %}
&lt;div class="module"&gt;
&lt;h1&gt;Order {{ order.id }}&lt;/h1&gt;
&lt;ul class="object-tools"&gt;
&lt;li&gt;
&lt;a href="#" onclick="window.print();"&gt;
        Print order
      &lt;/a&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;th&gt;Created&lt;/th&gt;
&lt;td&gt;{{ order.created }}&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;Customer&lt;/th&gt;
&lt;td&gt;{{ order.first_name }} {{ order.last_name }}&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;E-mail&lt;/th&gt;
&lt;td&gt;&lt;a href="mailto:{{ order.email }}"&gt;{{ order.email }}&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;Address&lt;/th&gt;
&lt;td&gt;
      {{ order.address }},
      {{ order.postal_code }} {{ order.city }}
    &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;Total amount&lt;/th&gt;
&lt;td&gt;${{ order.get_total_cost }}&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;Status&lt;/th&gt;
&lt;td&gt;{% if order.paid %}Paid{% else %}Pending payment{% endif %}&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th&gt;Stripe payment&lt;/th&gt;
&lt;td&gt;
        {% if order.stripe_id %}
          &lt;a href="{{ order.get_stripe_url }}" target="_blank"&gt;
            {{ order.stripe_id }}
          &lt;/a&gt;
        {% endif %}
      &lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class="module"&gt;
&lt;h2&gt;Items bought&lt;/h2&gt;
&lt;table style="width:100%"&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Product&lt;/th&gt;
&lt;th&gt;Price&lt;/th&gt;
&lt;th&gt;Quantity&lt;/th&gt;
&lt;th&gt;Total&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
      {% for item in order.items.all %}
        &lt;tr class="row{% cycle "1" "2" %}"&gt;
&lt;td&gt;{{ item.product.name }}&lt;/td&gt;
&lt;td class="num"&gt;${{ item.price }}&lt;/td&gt;
&lt;td class="num"&gt;{{ item.quantity }}&lt;/td&gt;
&lt;td class="num"&gt;${{ item.get_cost }}&lt;/td&gt;
&lt;/tr&gt;
      {% endfor %}
      &lt;tr class="total"&gt;
&lt;td colspan="3"&gt;Total&lt;/td&gt;
&lt;td class="num"&gt;${{ order.get_total_cost }}&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
{% endblock %}
</code></pre>
<p class="normal">Make sure that no template tag is split across multiple lines.</p>
<p class="normal">This is the template to display <a id="_idIndexMarker905"/>the details of an order on the administration site. This template extends the <code class="inlineCode">admin/base_site.html</code> template of Django’s administration site, which contains the main HTML structure and CSS styles. You use the blocks defined in the parent template to include your own content. You display information about the order and the items bought.</p>
<p class="normal">When you want to extend an administration template, you need to know its structure and identify existing blocks. You can find all administration templates at <a href="https://github.com/django/django/tree/5.0/django/contrib/admin/templates/admin">https://github.com/django/django/tree/5.0/django/contrib/admin/templates/admin</a>.</p>
<p class="normal">You can also override an administration template if you need to. To do so, copy a template into your <code class="inlineCode">templates/</code> directory, keeping the same relative path and filename. Django’s administration site will use your custom template instead of the default one.</p>
<p class="normal">Finally, let’s add a link to each <code class="inlineCode">Order</code> object on the list display page of the administration site. Edit the <code class="inlineCode">admin.py</code> file of the <code class="inlineCode">orders</code> application and add the following code to it, above the <code class="inlineCode">OrderAdmin</code> class:</p>
<pre class="programlisting code"><code class="hljs-code">from django.urls import reverse
def order_detail(obj):
    url = reverse('orders:admin_order_detail', args=[obj.id])
    return mark_safe(f'&lt;a href="{url}"&gt;View&lt;/a&gt;')
</code></pre>
<p class="normal">This is a function that<a id="_idIndexMarker906"/> takes an <code class="inlineCode">Order</code> object as an argument and returns an HTML link for the <code class="inlineCode">admin_order_detail</code> URL. Django escapes HTML output by default. You have to use the <code class="inlineCode">mark_safe</code> function to avoid auto-escaping.</p>
<p class="normal">Then, edit the <code class="inlineCode">OrderAdmin</code> class to display the link, as follows. The new code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">class OrderAdmin(admin.ModelAdmin):
    list_display = [
        'id',
        'first_name',
        'last_name',
        'email',
        'address',
        'postal_code',
        'city',
        'paid',
        order_payment,
        'created',
        'updated',
<strong class="hljs-slc">        order_detail,</strong>
    ]
    # ...
</code></pre>
<p class="normal">Start the development server with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/admin/orders/order/</code> in your browser. Each row includes a <strong class="screenText">View</strong><strong class="keyWord"> </strong>link, as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_29.png"/></figure>
<p class="packt_figref">Figure 9.29: The View link included in each order row</p>
<p class="normal">Click on the <strong class="screenText">View</strong> link for <a id="_idIndexMarker907"/>any order to load the custom order detail page. You should see a page like the following one:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_30.png"/></figure>
<p class="packt_figref">Figure 9.30: The custom order detail page on the administration site</p>
<p class="normal">Now that you have created the product detail page, you will learn how to generate order invoices in the PDF format dynamically.</p>
<h1 class="heading-1" id="_idParaDest-276">Generating PDF invoices dynamically</h1>
<p class="normal">Now that you have a complete checkout and payment system, you can generate a PDF invoice for each order. There are <a id="_idIndexMarker908"/>several Python libraries to generate PDF files. One popular library to generate PDFs with Python code is ReportLab. You can find information about how to output PDF files with ReportLab at <a href="https://docs.djangoproject.com/en/5.0/howto/outputting-pdf/">https://docs.djangoproject.com/en/5.0/howto/outputting-pdf/</a>.</p>
<p class="normal">In most cases, you will have to add custom styles and formatting to your PDF files. You will find it more convenient to render an HTML template and convert it into a PDF file, keeping Python away from the presentation layer. You are going to follow this approach and use a module to generate PDF files with Django. You will use WeasyPrint, which is a Python library that can generate PDF files from HTML templates.</p>
<h2 class="heading-2" id="_idParaDest-277">Installing WeasyPrint</h2>
<p class="normal">First, install WeasyPrint’s dependencies for <a id="_idIndexMarker909"/>your operating<a id="_idIndexMarker910"/> system from <a href="https://doc.courtbouillon.org/weasyprint/stable/first_steps.html">https://doc.courtbouillon.org/weasyprint/stable/first_steps.html</a>. Then, install WeasyPrint via <code class="inlineCode">pip</code> using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install WeasyPrint==61.2
</code></pre>
<h2 class="heading-2" id="_idParaDest-278">Creating a PDF template</h2>
<p class="normal">You need an HTML document as<a id="_idIndexMarker911"/> input for WeasyPrint. You are going to create an HTML template, render it using Django, and pass it to WeasyPrint to generate the PDF file.</p>
<p class="normal">Create a new template file inside the <code class="inlineCode">templates/orders/order/</code> directory of the <code class="inlineCode">orders</code> application and name it <code class="inlineCode">pdf.html</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;html&gt;
&lt;body&gt;
&lt;h1&gt;My Shop&lt;/h1&gt;
&lt;p&gt;
    Invoice no. {{ order.id }}&lt;br&gt;
&lt;span class="secondary"&gt;
      {{ order.created|date:"M d, Y" }}
    &lt;/span&gt;
&lt;/p&gt;
&lt;h3&gt;Bill to&lt;/h3&gt;
&lt;p&gt;
    {{ order.first_name }} {{ order.last_name }}&lt;br&gt;
    {{ order.email }}&lt;br&gt;
    {{ order.address }}&lt;br&gt;
    {{ order.postal_code }}, {{ order.city }}
  &lt;/p&gt;
&lt;h3&gt;Items bought&lt;/h3&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Product&lt;/th&gt;
&lt;th&gt;Price&lt;/th&gt;
&lt;th&gt;Quantity&lt;/th&gt;
&lt;th&gt;Cost&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
      {% for item in order.items.all %}
        &lt;tr class="row{% cycle "1" "2" %}"&gt;
&lt;td&gt;{{ item.product.name }}&lt;/td&gt;
&lt;td class="num"&gt;${{ item.price }}&lt;/td&gt;
&lt;td class="num"&gt;{{ item.quantity }}&lt;/td&gt;
&lt;td class="num"&gt;${{ item.get_cost }}&lt;/td&gt;
&lt;/tr&gt;
      {% endfor %}
      &lt;tr class="total"&gt;
&lt;td colspan="3"&gt;Total&lt;/td&gt;
&lt;td class="num"&gt;${{ order.get_total_cost }}&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;span class="{% if order.paid %}paid{% else %}pending{% endif %}"&gt;
    {% if order.paid %}Paid{% else %}Pending payment{% endif %}
  &lt;/span&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p class="normal">This is the template<a id="_idIndexMarker912"/> for the PDF invoice. In this template, you display all order details and an HTML <code class="inlineCode">&lt;table&gt;</code> element, including the products. You also include a message to display whether the order has been paid.</p>
<h2 class="heading-2" id="_idParaDest-279">Rendering PDF files</h2>
<p class="normal">You are going to create a view to <a id="_idIndexMarker913"/>generate PDF invoices for existing orders using the administration site. Edit the <code class="inlineCode">views.py</code> file inside the <code class="inlineCode">orders</code> application directory and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">import weasyprint
from django.contrib.staticfiles import finders
from django.http import HttpResponse
from django.template.loader import render_to_string
@staff_member_required
def admin_order_pdf(request, order_id):
    order = get_object_or_404(Order, id=order_id)
    html = render_to_string('orders/order/pdf.html', {'order': order})
    response = HttpResponse(content_type='application/pdf')
    response['Content-Disposition'] = f'filename=order_{order.id}.pdf'
    weasyprint.HTML(string=html).write_pdf(
        response,
        stylesheets=[weasyprint.CSS(finders.find('css/pdf.css'))]
    )
    return response
</code></pre>
<p class="normal">This is the view to generate a PDF invoice for an order. You use the <code class="inlineCode">staff_member_required</code> decorator to make sure only staff users can access this view.</p>
<p class="normal">You get the <code class="inlineCode">Order</code> object with the given ID and use the <code class="inlineCode">render_to_string()</code> function provided by Django to render <code class="inlineCode">orders/order/pdf.html</code>. The rendered HTML is saved in the <code class="inlineCode">html</code> variable.</p>
<p class="normal">Then, you generate a new <code class="inlineCode">HttpResponse</code> object, specifying the <code class="inlineCode">application/pdf</code> content type and including the <code class="inlineCode">Content-Disposition</code> header to specify the filename. You use WeasyPrint to generate a PDF file from the rendered HTML code and write the file to the <code class="inlineCode">HttpResponse</code> object.</p>
<p class="normal">You use the static file <code class="inlineCode">css/pdf.css</code> to add CSS styles to the generated PDF file. To locate the file, you use the <code class="inlineCode">finders()</code> function of the <code class="inlineCode">staticfiles</code> module. Finally, you return the generated response.</p>
<p class="normal">If you are missing the CSS styles, remember to copy the static files located in the <code class="inlineCode">static/</code> directory of the <code class="inlineCode">shop</code> application to the same location of your project.</p>
<p class="normal">You can find the contents of the directory at <a href="https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter09/myshop/shop/static">https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter09/myshop/shop/static</a>.</p>
<p class="normal">Since you need to use the <code class="inlineCode">STATIC_ROOT</code> setting, you have to add it to your project. This is the project’s path where static<a id="_idIndexMarker914"/> files reside. Edit the <code class="inlineCode">settings.py</code> file of the <code class="inlineCode">myshop</code> project and add the following setting:</p>
<pre class="programlisting code"><code class="hljs-code">STATIC_ROOT = BASE_DIR / 'static'
</code></pre>
<p class="normal">Then, run the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py collectstatic
</code></pre>
<p class="normal">You should see output that ends like this:</p>
<pre class="programlisting con"><code class="hljs-con">131 static files copied to 'code/myshop/static'.
</code></pre>
<p class="normal">The <code class="inlineCode">collectstatic</code> command copies all static files from your applications into the directory defined in the <code class="inlineCode">STATIC_ROOT</code> setting. This allows each application to provide its own static files using a <code class="inlineCode">static/</code> directory containing them. You can also provide additional static file sources in the <code class="inlineCode">STATICFILES_DIRS</code> setting. All of the directories specified in the <code class="inlineCode">STATICFILES_DIRS</code> list will also be copied to the <code class="inlineCode">STATIC_ROOT</code> directory when <code class="inlineCode">collectstatic</code> is executed. Whenever you execute <code class="inlineCode">collectstatic</code> again, you will be asked if you want to override the existing static files.</p>
<p class="normal">Edit the <code class="inlineCode">urls.py</code> file inside the <code class="inlineCode">orders</code> application directory and add the following URL pattern highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    # ...
<strong class="hljs-slc">    path(</strong><strong class="hljs-string-slc">'admin/order/&lt;int:order_id&gt;/pdf/'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        views.admin_order_pdf,</strong>
<strong class="hljs-slc">        name=</strong><strong class="hljs-string-slc">'admin_order_pdf'</strong>
<strong class="hljs-string-slc"> </strong><strong class="hljs-slc">),</strong>
]
</code></pre>
<p class="normal">Now, you can edit the administration list display page for the <code class="inlineCode">Order</code> model to add a link to the PDF file for each result. Edit the <code class="inlineCode">admin.py</code> file inside the <code class="inlineCode">orders</code> application and add the following code above the <code class="inlineCode">OrderAdmin</code> class:</p>
<pre class="programlisting code"><code class="hljs-code">def order_pdf(obj):
    url = reverse('orders:admin_order_pdf', args=[obj.id])
    return mark_safe(f'&lt;a href="{url}"&gt;PDF&lt;/a&gt;')
order_pdf.short_description = 'Invoice'
</code></pre>
<p class="normal">If you specify a <code class="inlineCode">short_description</code> attribute<a id="_idIndexMarker915"/> for your callable, Django will use it for the name of the column.</p>
<p class="normal">Add <code class="inlineCode">order_pdf</code> to the <code class="inlineCode">list_display</code> attribute of the <code class="inlineCode">OrderAdmin</code> class, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">class OrderAdmin(admin.ModelAdmin):
    list_display = [
        'id',
        'first_name',
        'last_name',
        'email',
        'address',
        'postal_code',
        'city',
        'paid',
        order_payment,
        'created',
        'updated',
        order_detail,
<strong class="hljs-slc">        order_pdf,</strong>
    ]
</code></pre>
<p class="normal">Make sure the development server is running. Open <code class="inlineCode">http://127.0.0.1:8000/admin/orders/order/</code> in your browser. Each row should now include a <strong class="screenText">PDF</strong> link, like this:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_31.png"/></figure>
<p class="packt_figref">Figure 9.31: The PDF link included in each order row</p>
<p class="normal">Click on the <strong class="screenText">PDF</strong> link for any order. You should see a generated PDF file like the following one for orders that<a id="_idIndexMarker916"/> have not been paid yet:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_32.png"/></figure>
<p class="packt_figref">Figure 9.32: The PDF invoice for an unpaid order</p>
<p class="normal">For paid orders, you will see the following PDF file:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_09_33.png"/></figure>
<p class="packt_figref">Figure 9.33: The PDF invoice for a paid order</p>
<h2 class="heading-2" id="_idParaDest-280">Sending PDF files by email</h2>
<p class="normal">When a payment is<a id="_idIndexMarker917"/> successful, you will send an automatic email to your customer including the generated PDF invoice. You will create an asynchronous task to perform this action.</p>
<p class="normal">Create a new file inside the <code class="inlineCode">payment</code> application directory and name it <code class="inlineCode">tasks.py</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from io import BytesIO
import weasyprint
from celery import shared_task
from django.contrib.staticfiles import finders
from django.core.mail import EmailMessage
from django.template.loader import render_to_string
from orders.models import Order
@shared_task
def payment_completed(order_id):
    """
    Task to send an e-mail notification when an order is
    successfully paid.
    """
    order = Order.objects.get(id=order_id)
    # create invoice e-mail
    subject = f'My Shop - Invoice no. {order.id}'
    message = (
        'Please, find attached the invoice for your recent purchase.'
    )
    email = EmailMessage(
        subject, message, 'admin@myshop.com', [order.email]
    )
    # generate PDF
    html = render_to_string('orders/order/pdf.html', {'order': order})
    out = BytesIO()
    stylesheets=[weasyprint.CSS(finders.find('css/pdf.css'))]
    weasyprint.HTML(string=html).write_pdf(out, stylesheets=stylesheets)
    # attach PDF file
    email.attach(
        f'order_{order.id}.pdf', out.getvalue(), 'application/pdf'
 )
    # send e-mail
    email.send()
</code></pre>
<p class="normal">You define the <code class="inlineCode">payment_completed</code> task by <a id="_idIndexMarker918"/>using the <code class="inlineCode">@shared_task</code> decorator. In this task, you use the <code class="inlineCode">EmailMessage</code> class provided by Django to create an <code class="inlineCode">email</code> object. Then, you render the template in the <code class="inlineCode">html</code> variable. You generate the PDF file from the rendered template and output it to a <code class="inlineCode">BytesIO</code> instance, which is an in-memory bytes buffer. Then, you attach the generated PDF file to the <code class="inlineCode">EmailMessage</code> object using the <code class="inlineCode">attach()</code> method, including the contents of the <code class="inlineCode">out</code> buffer. Finally, you send the email.</p>
<p class="normal">Remember to set up your <strong class="keyWord">Simple Mail Transfer Protocol</strong> (<strong class="keyWord">SMTP</strong>) settings in the <code class="inlineCode">settings.py</code> file of the project to send<a id="_idIndexMarker919"/> emails. You can refer to <em class="italic">Chapter 2</em>, <em class="italic">Enhancing Your Blog with Advanced Features</em>, to see a working example of an SMTP configuration. If you don’t want to set up email settings, you can tell Django to write emails to the console by adding the following <a id="_idIndexMarker920"/>setting to the <code class="inlineCode">settings.py</code> file:</p>
<pre class="programlisting code"><code class="hljs-code">EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'
</code></pre>
<p class="normal">Let’s add the <code class="inlineCode">payment_completed</code> task to the webhook endpoint that handles payment completion events.</p>
<p class="normal">Edit the <code class="inlineCode">webhooks.py</code> file of the <code class="inlineCode">payment</code> application and modify it to make it look like this:</p>
<pre class="programlisting code"><code class="hljs-code">import stripe
from django.conf import settings
from django.http import HttpResponse
from django.views.decorators.csrf import csrf_exempt
from orders.models import Order
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> .tasks </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> payment_completed</strong>
@csrf_exempt
def stripe_webhook(request):
    payload = request.body
    sig_header = request.META['HTTP_STRIPE_SIGNATURE']
    event = None
try:
        event = stripe.Webhook.construct_event(
            payload, sig_header, settings.STRIPE_WEBHOOK_SECRET
        )
    except ValueError as e:
        # Invalid payload
return HttpResponse(status=400)
    except stripe.error.SignatureVerificationError as e:
        # Invalid signature
return HttpResponse(status=400)
    if event.type == 'checkout.session.completed':
        session = event.data.object
if (
            session.mode == 'payment'
and session.payment_status == 'paid'
        ):
            try:
                order = Order.objects.get(
                    id=session.client_reference_id
                )
            except Order.DoesNotExist:
                return HttpResponse(status=404)
            # mark order as paid
            order.paid = True
# store Stripe payment ID
            order.stripe_id = session.payment_intent
            order.save()
            <strong class="hljs-comment-slc"># launch asynchronous task</strong>
<strong class="hljs-slc">            payment_completed.delay(order.</strong><strong class="hljs-built_in-slc">id</strong><strong class="hljs-slc">)</strong>
return HttpResponse(status=200)
</code></pre>
<p class="normal">The <code class="inlineCode">payment_completed</code> task is queued by calling its <code class="inlineCode">delay()</code> method. The task will be added to the queue and executed asynchronously by a Celery worker as soon as possible.</p>
<p class="normal">Now, you can complete a <a id="_idIndexMarker921"/>new checkout process in order to receive the PDF invoice in your email. If you are using the <code class="inlineCode">console.EmailBackend</code> for your email backend, in the shell where you are running Celery, you will be able to see the following output:</p>
<pre class="programlisting con"><code class="hljs-con">MIME-Version: 1.0
Subject: My Shop - Invoice no. 7
From: admin@myshop.com
To: email@domain.com
Date: Wed, 3 Jan 2024 20:15:24 -0000
Message-ID: &lt;164841212458.94972.10344068999595916799@amele-mbp.home&gt;
--===============8908668108717577350==
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Please, find attached the invoice for your recent purchase.
--===============8908668108717577350==
Content-Type: application/pdf
MIME-Version: 1.0
Content-Transfer-Encoding: base64
Content-Disposition: attachment; filename="order_7.pdf"
JVBERi0xLjcKJfCflqQKMSAwIG9iago8PAovVHlwZSA...
</code></pre>
<p class="normal">This output shows that the email contains an attachment. You have learned how to attach files to emails <a id="_idIndexMarker922"/>and send them programmatically.</p>
<p class="normal">Congratulations! You have completed the Stripe integration and have added valuable functionality to your shop.</p>
<h1 class="heading-1" id="_idParaDest-281">Summary</h1>
<p class="normal">In this chapter, you integrated the Stripe payment gateway into your project and created a webhook endpoint to receive payment notifications. You built a custom administration action to export orders to CSV. You also customized the Django administration site using custom views and templates. Finally, you learned how to generate PDF files with WeasyPrint and how to attach them to emails.</p>
<p class="normal">The next chapter will teach you how to create a coupon system using Django sessions, and you will build a product recommendation engine with Redis.</p>
<h1 class="heading-1" id="_idParaDest-282">Additional resources</h1>
<p class="normal">The following resources provide additional information related to the topics covered in this chapter:</p>
<ul>
<li class="bulletList">Source code for this chapter: <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter09">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter09</a></li>
<li class="bulletList">Stripe website: <a href="https://www.stripe.com/">https://www.stripe.com/</a></li>
<li class="bulletList">Stripe Checkout documentation: <a href="https://stripe.com/docs/payments/checkout">https://stripe.com/docs/payments/checkout</a></li>
<li class="bulletList">Creating a Stripe account: <a href="https://dashboard.stripe.com/register">https://dashboard.stripe.com/register</a></li>
<li class="bulletList">Stripe account settings: <a href="https://dashboard.stripe.com/settings/account">https://dashboard.stripe.com/settings/account</a></li>
<li class="bulletList">Stripe Python library: <a href="https://github.com/stripe/stripe-python">https://github.com/stripe/stripe-python</a></li>
<li class="bulletList">Stripe test API keys: <a href="https://dashboard.stripe.com/test/apikeys">https://dashboard.stripe.com/test/apikeys</a></li>
<li class="bulletList">Stripe API keys documentation: <a href="https://stripe.com/docs/keys">https://stripe.com/docs/keys</a></li>
<li class="bulletList">Stripe API version 2024-04-10 release: <a href="https://stripe.com/docs/api/events/types">https://stripe.com/docs/upgrades#2024-04-10</a></li>
<li class="bulletList">Stripe checkout session modes: <a href="https://stripe.com/docs/api/checkout/sessions/object#checkout_session_object-mode">https://stripe.com/docs/api/checkout/sessions/object#checkout_session_object-mode</a></li>
<li class="bulletList">Building absolute URIs with Django: <a href="https://docs.djangoproject.com/en/5.0/ref/request-response/#django.http.HttpRequest.build_absolute_uri">https://docs.djangoproject.com/en/5.0/ref/request-response/#django.http.HttpRequest.build_absolute_uri</a></li>
<li class="bulletList">Creating Stripe sessions: <a href="https://stripe.com/docs/api/checkout/sessions/create">https://stripe.com/docs/api/checkout/sessions/create</a></li>
<li class="bulletList">Stripe-supported currencies: <a href="https://stripe.com/docs/currencies">https://stripe.com/docs/currencies</a></li>
<li class="bulletList">Stripe Payments dashboard: <a href="https://dashboard.stripe.com/test/payments">https://dashboard.stripe.com/test/payments</a></li>
<li class="bulletList">Credit cards for testing payments with Stripe: <a href="https://stripe.com/docs/testing">https://stripe.com/docs/testing</a></li>
<li class="bulletList">Stripe webhooks: <a href="https://dashboard.stripe.com/test/webhooks">https://dashboard.stripe.com/test/webhooks</a></li>
<li class="bulletList">Types of events sent by Stripe: <a href="https://stripe.com/docs/api/events/types">https://stripe.com/docs/api/events/types</a></li>
<li class="bulletList">Installing the Stripe CLI: <a href="https://stripe.com/docs/stripe-cli#install ">https://stripe.com/docs/stripe-cli#install</a></li>
<li class="bulletList">Latest Stripe CLI release: <a href="https://github.com/stripe/stripe-cli/releases/latest">https://github.com/stripe/stripe-cli/releases/latest</a></li>
<li class="bulletList">Generating CSV files with Django: <a href="https://docs.djangoproject.com/en/5.0/howto/outputting-csv/">https://docs.djangoproject.com/en/5.0/howto/outputting-csv/</a></li>
<li class="bulletList"><code class="inlineCode">django-import-export</code> application: <a href="https://django-import-export.readthedocs.io/en/latest/">https://django-import-export.readthedocs.io/en/latest/</a></li>
<li class="bulletList"><code class="inlineCode">django-import-export-celery</code> application: <a href="https://github.com/auto-mat/django-import-export-celery">https://github.com/auto-mat/django-import-export-celery</a></li>
<li class="bulletList">Django administration templates: <a href="https://github.com/django/django/tree/5.0/django/contrib/admin/templates/admin">https://github.com/django/django/tree/5.0/django/contrib/admin/templates/admin</a></li>
<li class="bulletList">Outputting PDF files with ReportLab: <a href="https://docs.djangoproject.com/en/5.0/howto/outputting-pdf/">https://docs.djangoproject.com/en/5.0/howto/outputting-pdf/</a></li>
<li class="bulletList">Installing WeasyPrint: <a href="https://doc.courtbouillon.org/weasyprint/stable/first_steps.html">https://doc.courtbouillon.org/weasyprint/stable/first_steps.html</a></li>
<li class="bulletList">Static files for this chapter: <a href="https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter09/myshop/shop/static">https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter09/myshop/shop/static</a></li>
</ul>
</div>
</body></html>