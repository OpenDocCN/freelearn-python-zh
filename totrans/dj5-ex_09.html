<html><head></head><body>
<div class="Basic-Text-Frame" id="_idContainer303">
<h1 class="chapterNumber"><span class="koboSpan" id="kobo.1.1">9</span></h1>
<h1 class="chapterTitle" id="_idParaDest-257"><span class="koboSpan" id="kobo.2.1">Managing Payments and Orders</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">In the previous chapter, you created a basic online shop with a product catalog and a shopping cart. </span><span class="koboSpan" id="kobo.3.2">You learned how to use Django sessions and built a custom context processor. </span><span class="koboSpan" id="kobo.3.3">You also learned how to launch asynchronous tasks using Celery and RabbitMQ.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4.1">In this chapter, you will learn how to integrate a payment gateway into your site to let users pay by credit card and manage order payments. </span><span class="koboSpan" id="kobo.4.2">You will also extend the administration site with different features.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.5.1">In this chapter, you will:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.6.1">Integrate the Stripe payment gateway into your project</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.7.1">Process credit card payments with Stripe</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.8.1">Handle payment notifications and mark orders as paid</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.9.1">Export orders to CSV files</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.10.1">Create custom views for the administration site</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.11.1">Generate PDF invoices dynamically</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-258"><span class="koboSpan" id="kobo.12.1">Functional overview</span></h1>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.13.1">Figure 9.1</span></em><span class="koboSpan" id="kobo.14.1"> shows a representation of the views, templates, and functionalities that will be built in this chapter:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.15.1"><img alt="" role="presentation" src="../Images/B21088_09_01.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.16.1">Figure 9.1: Diagram of the functionalities built in Chapter 9</span></p>
<p class="normal"><span class="koboSpan" id="kobo.17.1">In this chapter, you will create a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.18.1">payment</span></code><span class="koboSpan" id="kobo.19.1"> app, where you will implement the </span><code class="inlineCode"><span class="koboSpan" id="kobo.20.1">payment_process</span></code><span class="koboSpan" id="kobo.21.1"> view to initiate a checkout session to pay orders with Stripe. </span><span class="koboSpan" id="kobo.21.2">You will build the </span><code class="inlineCode"><span class="koboSpan" id="kobo.22.1">payment_completed</span></code><span class="koboSpan" id="kobo.23.1"> view to redirect users after successful payments and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.24.1">payment_canceled</span></code><span class="koboSpan" id="kobo.25.1"> view to redirect users if the payment is canceled. </span><span class="koboSpan" id="kobo.25.2">You will implement the </span><code class="inlineCode"><span class="koboSpan" id="kobo.26.1">export_to_csv</span></code><span class="koboSpan" id="kobo.27.1"> admin action to export orders in CSV format in the administration site. </span><span class="koboSpan" id="kobo.27.2">You will also build the admin view </span><code class="inlineCode"><span class="koboSpan" id="kobo.28.1">admin_order_detail</span></code><span class="koboSpan" id="kobo.29.1"> to display order details and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.30.1">admin_order_pdf</span></code><span class="koboSpan" id="kobo.31.1"> view to generate PDF invoices dynamically. </span><span class="koboSpan" id="kobo.31.2">You will implement the </span><code class="inlineCode"><span class="koboSpan" id="kobo.32.1">stripe_webhook</span></code><span class="koboSpan" id="kobo.33.1"> webhook to receive asynchronous payment notifications from Stripe, and you will implement the </span><code class="inlineCode"><span class="koboSpan" id="kobo.34.1">payment_completed</span></code><span class="koboSpan" id="kobo.35.1"> asynchronous task to send invoices to clients when orders are paid.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.36.1">The source code for this chapter can be found at </span><a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter09"><span class="url"><span class="koboSpan" id="kobo.37.1">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter09</span></span></a><span class="koboSpan" id="kobo.38.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.39.1">All Python packages used in this chapter are included in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.40.1">requirements.txt</span></code><span class="koboSpan" id="kobo.41.1"> file in the source code for the chapter. </span><span class="koboSpan" id="kobo.41.2">You can follow the instructions to install each Python package in the following sections, or you can install all the requirements at once with the command </span><code class="inlineCode"><span class="koboSpan" id="kobo.42.1">python</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.43.1">-m</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.44.1">pip</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.45.1">install</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.46.1">-r</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.47.1">requirements.txt</span></code><span class="koboSpan" id="kobo.48.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-259"><span class="koboSpan" id="kobo.49.1">Integrating a payment gateway</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.50.1">A payment gateway is a technology used by merchants to process payments from customers online. </span><span class="koboSpan" id="kobo.50.2">Using a payment gateway, you can manage customers’ orders and delegate payment processing to </span><a id="_idIndexMarker825"/><span class="koboSpan" id="kobo.51.1">a reliable, secure third party. </span><span class="koboSpan" id="kobo.51.2">By using a trusted payment gateway, you won’t have to worry about the technical, security, and regulatory complexity of processing credit cards in your own system.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.52.1">There are several payment gateway providers to choose from. </span><span class="koboSpan" id="kobo.52.2">We are going to integrate Stripe, which is a very popular payment gateway used by online services such as Shopify, Uber, Twitch, and GitHub, among others.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.53.1">Stripe provides an </span><strong class="keyWord"><span class="koboSpan" id="kobo.54.1">Application Programming Interface </span></strong><span class="koboSpan" id="kobo.55.1">(</span><strong class="keyWord"><span class="koboSpan" id="kobo.56.1">API</span></strong><span class="koboSpan" id="kobo.57.1">) that allows you to process online payments with multiple</span><a id="_idIndexMarker826"/><span class="koboSpan" id="kobo.58.1"> payment methods, such as credit card, Google Pay, and Apple Pay. </span><span class="koboSpan" id="kobo.58.2">You can learn more about Stripe at </span><a href="https://www.stripe.com/"><span class="url"><span class="koboSpan" id="kobo.59.1">https://www.stripe.com/</span></span></a><span class="koboSpan" id="kobo.60.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.61.1">Stripe provides</span><a id="_idIndexMarker827"/><span class="koboSpan" id="kobo.62.1"> different products related to payment processing. </span><span class="koboSpan" id="kobo.62.2">It can manage one-off payments, recurring payments for subscription services, multiparty payments for platforms and marketplaces, and more.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.63.1">Stripe offers different integration methods, from Stripe-hosted payment forms to fully customizable checkout flows. </span><span class="koboSpan" id="kobo.63.2">We will integrate the </span><em class="italic"><span class="koboSpan" id="kobo.64.1">Stripe</span></em> <em class="italic"><span class="koboSpan" id="kobo.65.1">Checkout</span></em><span class="koboSpan" id="kobo.66.1"> product, which consists of a payment page optimized for conversion. </span><span class="koboSpan" id="kobo.66.2">Users will be able to easily pay with a credit card or other payment methods for the items they order. </span><span class="koboSpan" id="kobo.66.3">We will receive payment notifications from Stripe. </span><span class="koboSpan" id="kobo.66.4">You can see the </span><em class="italic"><span class="koboSpan" id="kobo.67.1">Stripe</span></em> <em class="italic"><span class="koboSpan" id="kobo.68.1">Checkout</span></em><span class="koboSpan" id="kobo.69.1"> documentation at </span><a href="https://stripe.com/docs/payments/checkout"><span class="url"><span class="koboSpan" id="kobo.70.1">https://stripe.com/docs/payments/checkout</span></span></a><span class="koboSpan" id="kobo.71.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.72.1">By leveraging </span><em class="italic"><span class="koboSpan" id="kobo.73.1">Stripe</span></em> <em class="italic"><span class="koboSpan" id="kobo.74.1">Checkout</span></em><span class="koboSpan" id="kobo.75.1"> to process payments, you rely on a s</span><a id="_idIndexMarker828"/><span class="koboSpan" id="kobo.76.1">olution that is secure and compliant with </span><strong class="keyWord"><span class="koboSpan" id="kobo.77.1">Payment Card Industry</span></strong><span class="koboSpan" id="kobo.78.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.79.1">PCI</span></strong><span class="koboSpan" id="kobo.80.1">) requirements. </span><span class="koboSpan" id="kobo.80.2">You will be able to collect payments from Google Pay, Apple Pay, Afterpay, Alipay, SEPA direct debits, Bacs direct debits, BECS direct debits, iDEAL, Sofort, GrabPay, FPX, and other payment methods.</span></p>
<h2 class="heading-2" id="_idParaDest-260"><span class="koboSpan" id="kobo.81.1">Creating a Stripe account</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.82.1">You need a Stripe account to</span><a id="_idIndexMarker829"/><span class="koboSpan" id="kobo.83.1"> integrate the payment gateway into your site. </span><span class="koboSpan" id="kobo.83.2">Let’s create an account to test the Stripe API. </span><span class="koboSpan" id="kobo.83.3">Open </span><a href="https://dashboard.stripe.com/register"><span class="url"><span class="koboSpan" id="kobo.84.1">https://dashboard.stripe.com/register</span></span></a><span class="koboSpan" id="kobo.85.1"> in your browser. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.86.1">You will see a form like the following one:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.87.1"><img alt="" role="presentation" src="../Images/B21088_09_02.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.88.1">Figure 9.2: The Stripe signup form</span></p>
<p class="normal"><span class="koboSpan" id="kobo.89.1">Fill in the form with your own data and click on </span><strong class="screenText"><span class="koboSpan" id="kobo.90.1">Create account</span></strong><span class="koboSpan" id="kobo.91.1">. </span><span class="koboSpan" id="kobo.91.2">You will receive an email from Stripe with a link to verify your email address. </span><span class="koboSpan" id="kobo.91.3">The email will look like this:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.92.1"><img alt="" role="presentation" src="../Images/B21088_09_03.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.93.1">Figure 9.3: The verification email to verify your email address</span></p>
<p class="normal"><span class="koboSpan" id="kobo.94.1">Open the email in your</span><a id="_idIndexMarker830"/><span class="koboSpan" id="kobo.95.1"> inbox and click on </span><strong class="screenText"><span class="koboSpan" id="kobo.96.1">Verify email</span></strong><span class="koboSpan" id="kobo.97.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.98.1">You will be redirected to the Stripe dashboard screen, which will look like this:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.99.1"><img alt="" role="presentation" src="../Images/B21088_09_04.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.100.1">Figure 9.4: The Stripe dashboard after verifying the email address</span></p>
<p class="normal"><span class="koboSpan" id="kobo.101.1">At the top right of the screen, you can see that </span><strong class="screenText"><span class="koboSpan" id="kobo.102.1">Test mode</span></strong><span class="koboSpan" id="kobo.103.1"> is activated. </span><span class="koboSpan" id="kobo.103.2">Stripe provides you with a test environment and a production environment. </span><span class="koboSpan" id="kobo.103.3">If you own a business or are a freelancer, you can add your business details to activate the account and get access to process real payments. </span><span class="koboSpan" id="kobo.103.4">However, this is not necessary to implement and test payments through Stripe, as </span><a id="_idIndexMarker831"/><span class="koboSpan" id="kobo.104.1">we will be working in the test environment.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.105.1">You need to add an account name to process payments. </span><span class="koboSpan" id="kobo.105.2">Open </span><a href="https://dashboard.stripe.com/settings/account"><span class="url"><span class="koboSpan" id="kobo.106.1">https://dashboard.stripe.com/settings/account</span></span></a><span class="koboSpan" id="kobo.107.1"> in your browser. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.108.1">You will see the following screen:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.109.1"><img alt="" role="presentation" src="../Images/B21088_09_05.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.110.1">Figure 9.5: The Stripe account settings</span></p>
<p class="normal"><span class="koboSpan" id="kobo.111.1">Under </span><strong class="screenText"><span class="koboSpan" id="kobo.112.1">Account name</span></strong><span class="koboSpan" id="kobo.113.1">, enter the name of your choice and then click on </span><strong class="screenText"><span class="koboSpan" id="kobo.114.1">Save</span></strong><span class="koboSpan" id="kobo.115.1">. </span><span class="koboSpan" id="kobo.115.2">Go back to the Stripe dashboard. </span><span class="koboSpan" id="kobo.115.3">You will see your account name displayed in the header:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.116.1"><img alt="" role="presentation" src="../Images/B21088_09_06.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.117.1">Figure 9.6: The Stripe dashboard header including the account name</span></p>
<p class="normal"><span class="koboSpan" id="kobo.118.1">We will continue by installing the Stripe</span><a id="_idIndexMarker832"/><span class="koboSpan" id="kobo.119.1"> Python SDK and adding Stripe to our Django project.</span></p>
<h2 class="heading-2" id="_idParaDest-261"><span class="koboSpan" id="kobo.120.1">Installing the Stripe Python library</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.121.1">Stripe provides a Python library that </span><a id="_idIndexMarker833"/><span class="koboSpan" id="kobo.122.1">simplifies dealing with its API. </span><span class="koboSpan" id="kobo.122.2">We are going to integrate the payment gateway into the project using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.123.1">stripe</span></code><span class="koboSpan" id="kobo.124.1"> library.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.125.1">You can find the source code for the Stripe Python library at </span><a href="https://github.com/stripe/stripe-python"><span class="url"><span class="koboSpan" id="kobo.126.1">https://github.com/stripe/stripe-python</span></span></a><span class="koboSpan" id="kobo.127.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.128.1">Install the </span><code class="inlineCode"><span class="koboSpan" id="kobo.129.1">stripe</span></code><span class="koboSpan" id="kobo.130.1"> library from the shell using the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.131.1">python -m pip install stripe==9.3.0
</span></code></pre>
<h2 class="heading-2" id="_idParaDest-262"><span class="koboSpan" id="kobo.132.1">Adding Stripe to your project</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.133.1">Open </span><a href="https://dashboard.stripe.com/test/apikeys"><span class="url"><span class="koboSpan" id="kobo.134.1">https://dashboard.stripe.com/test/apikeys</span></span></a><span class="koboSpan" id="kobo.135.1"> in your browser. </span><span class="koboSpan" id="kobo.135.2">You can also access this page from the Stripe</span><a id="_idIndexMarker834"/><span class="koboSpan" id="kobo.136.1"> dashboard by clicking on </span><strong class="screenText"><span class="koboSpan" id="kobo.137.1">Developers</span></strong><span class="koboSpan" id="kobo.138.1"> and then clicking on </span><strong class="screenText"><span class="koboSpan" id="kobo.139.1">API keys</span></strong><span class="koboSpan" id="kobo.140.1">. </span><span class="koboSpan" id="kobo.140.2">You will see the following screen:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.141.1"><img alt="" role="presentation" src="../Images/B21088_09_07.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.142.1">Figure 9.7: The Stripe test API keys screen</span></p>
<p class="normal"><span class="koboSpan" id="kobo.143.1">Stripe provides a key pair for the two different environments, test and production. </span><span class="koboSpan" id="kobo.143.2">There is a </span><strong class="screenText"><span class="koboSpan" id="kobo.144.1">Publishable key</span></strong><span class="koboSpan" id="kobo.145.1"> and a </span><strong class="screenText"><span class="koboSpan" id="kobo.146.1">Secret key</span></strong><span class="koboSpan" id="kobo.147.1"> for each environment. </span><span class="koboSpan" id="kobo.147.2">Test mode publishable keys have the prefix </span><code class="inlineCode"><span class="koboSpan" id="kobo.148.1">pk_test_</span></code><span class="koboSpan" id="kobo.149.1"> and live mode publishable keys have the prefix </span><code class="inlineCode"><span class="koboSpan" id="kobo.150.1">pk_live_</span></code><span class="koboSpan" id="kobo.151.1">. </span><span class="koboSpan" id="kobo.151.2">Test mode secret keys have the prefix </span><code class="inlineCode"><span class="koboSpan" id="kobo.152.1">sk_test_</span></code><span class="koboSpan" id="kobo.153.1"> and live mode secret keys have the prefix </span><code class="inlineCode"><span class="koboSpan" id="kobo.154.1">sk_live_</span></code><span class="koboSpan" id="kobo.155.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.156.1">You will need this information to authenticate requests to the Stripe API. </span><span class="koboSpan" id="kobo.156.2">You should always keep your private key </span><a id="_idIndexMarker835"/><span class="koboSpan" id="kobo.157.1">secret and store it securely. </span><span class="koboSpan" id="kobo.157.2">The publishable key can be used in client-side code such as JavaScript scripts. </span><span class="koboSpan" id="kobo.157.3">You can read more about Stripe API keys at </span><a href="https://stripe.com/docs/keys"><span class="url"><span class="koboSpan" id="kobo.158.1">https://stripe.com/docs/keys</span></span></a><span class="koboSpan" id="kobo.159.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.160.1">To facilitate separating configuration from code, we are going to use </span><code class="inlineCode"><span class="koboSpan" id="kobo.161.1">python-decouple</span></code><span class="koboSpan" id="kobo.162.1">. </span><span class="koboSpan" id="kobo.162.2">You already used this library in </span><em class="chapterRef"><span class="koboSpan" id="kobo.163.1">Chapter 2</span></em><span class="koboSpan" id="kobo.164.1">, </span><em class="italic"><span class="koboSpan" id="kobo.165.1">Enhancing Your Blog and Adding Social Features</span></em><span class="koboSpan" id="kobo.166.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.167.1">Create a new file inside your project’s root directory and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.168.1">.env</span></code><span class="koboSpan" id="kobo.169.1">. </span><span class="koboSpan" id="kobo.169.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.170.1">.env</span></code><span class="koboSpan" id="kobo.171.1"> file will contain key-value pairs of environment variables. </span><span class="koboSpan" id="kobo.171.2">Add the Stripe credentials to the new file, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.172.1">STRIPE_PUBLISHABLE_KEY=pk_test_XXXX
STRIPE_SECRET_KEY=sk_test_XXXX
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.173.1">Replace the </span><code class="inlineCode"><span class="koboSpan" id="kobo.174.1">STRIPE_PUBLISHABLE_KEY</span></code><span class="koboSpan" id="kobo.175.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.176.1">STRIPE_SECRET_KEY</span></code><span class="koboSpan" id="kobo.177.1"> values with the test </span><strong class="screenText"><span class="koboSpan" id="kobo.178.1">Publishable key</span></strong><span class="koboSpan" id="kobo.179.1"> and </span><strong class="screenText"><span class="koboSpan" id="kobo.180.1">Secret key</span></strong><span class="koboSpan" id="kobo.181.1"> values provided by Stripe.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.182.1">If you are using a </span><code class="inlineCode"><span class="koboSpan" id="kobo.183.1">git</span></code><span class="koboSpan" id="kobo.184.1"> repository for your code, make sure to include </span><code class="inlineCode"><span class="koboSpan" id="kobo.185.1">.env</span></code><span class="koboSpan" id="kobo.186.1"> in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.187.1">.gitignore</span></code><span class="koboSpan" id="kobo.188.1"> file of your repository. </span><span class="koboSpan" id="kobo.188.2">By doing so, you ensure that credentials are excluded from the repository.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.189.1">Install </span><code class="inlineCode"><span class="koboSpan" id="kobo.190.1">python-decouple</span></code><span class="koboSpan" id="kobo.191.1"> via </span><code class="inlineCode"><span class="koboSpan" id="kobo.192.1">pip</span></code><span class="koboSpan" id="kobo.193.1"> by running the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.194.1">python -m pip install python-decouple==3.8
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.195.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.196.1">settings.py</span></code><span class="koboSpan" id="kobo.197.1"> file of your project and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.198.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.199.1"> decouple </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.200.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.201.1"> config</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.202.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.203.1">STRIPE_PUBLISHABLE_KEY = config(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.204.1">'</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.205.1">STRIPE_PUBLISHABLE_KEY'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.206.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.207.1">STRIPE_SECRET_KEY = config(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.208.1">'STRIPE_SECRET_KEY'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.209.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.210.1">STRIPE_API_VERSION = </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.211.1">'2024-04-10'</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.212.1">You will use Stripe API version </span><code class="inlineCode"><span class="koboSpan" id="kobo.213.1">2024-04-10</span></code><span class="koboSpan" id="kobo.214.1">. </span><span class="koboSpan" id="kobo.214.2">You can see the release notes for this API version at </span><a href="https://stripe.com/docs/api/events/types"><span class="url"><span class="koboSpan" id="kobo.215.1">https://stripe.com/docs/upgrades#2024-04-10</span></span></a><span class="koboSpan" id="kobo.216.1">.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.217.1">You are using the test environment keys for the project. </span><span class="koboSpan" id="kobo.217.2">Once you go live and validate your Stripe account, you will obtain the production environment keys. </span><span class="koboSpan" id="kobo.217.3">In </span><em class="italic"><span class="koboSpan" id="kobo.218.1">Chapter 17</span></em><span class="koboSpan" id="kobo.219.1">, </span><em class="italic"><span class="koboSpan" id="kobo.220.1">Going Live</span></em><span class="koboSpan" id="kobo.221.1">, you will learn how to configure settings for multiple environments.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.222.1">Let’s integrate the payment </span><a id="_idIndexMarker836"/><span class="koboSpan" id="kobo.223.1">gateway into the checkout process. </span><span class="koboSpan" id="kobo.223.2">You can find the Python documentation for Stripe at </span><a href="https://stripe.com/docs/api/events/types"><span class="url"><span class="koboSpan" id="kobo.224.1">https://stripe.com/docs/api?lang=python</span></span></a><span class="koboSpan" id="kobo.225.1">.</span></p>
<h2 class="heading-2" id="_idParaDest-263"><span class="koboSpan" id="kobo.226.1">Building the payment process</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.227.1">The checkout process </span><a id="_idIndexMarker837"/><span class="koboSpan" id="kobo.228.1">will work as follows:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.229.1">Add items to the shopping cart.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.230.1">Check out the shopping cart.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.231.1">Enter credit card details and pay.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.232.1">We are going to create a new application to manage payments. </span><span class="koboSpan" id="kobo.232.2">Create a new application in your project using the following command:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.233.1">python manage.py startapp payment
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.234.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.235.1">settings.py</span></code><span class="koboSpan" id="kobo.236.1"> file of the project and add the new application to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.237.1">INSTALLED_APPS</span></code><span class="koboSpan" id="kobo.238.1"> setting, as follows. </span><span class="koboSpan" id="kobo.238.2">The new line is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.239.1">INSTALLED_APPS = [
    # ...
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.240.1">'cart.apps.CartConfig'</span></span><span class="koboSpan" id="kobo.241.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.242.1">'orders.apps.OrdersConfig'</span></span><span class="koboSpan" id="kobo.243.1">,
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.244.1">'payment.apps.PaymentConfig'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.245.1">,</span></strong></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.246.1">'shop.apps.ShopConfig'</span></span><span class="koboSpan" id="kobo.247.1">,
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.248.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.249.1">payment</span></code><span class="koboSpan" id="kobo.250.1"> application is now active in the project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.251.1">Currently, users are able to place orders but they cannot pay for them. </span><span class="koboSpan" id="kobo.251.2">After clients place an order, we</span><a id="_idIndexMarker838"/><span class="koboSpan" id="kobo.252.1"> need to redirect them to the payment process.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.253.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.254.1">views.py</span></code><span class="koboSpan" id="kobo.255.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.256.1">orders</span></code><span class="koboSpan" id="kobo.257.1"> application and include the following import:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.258.1">from django.shortcuts </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.259.1">import</span></span> <span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.260.1">redirect, </span></strong></span><span class="koboSpan" id="kobo.261.1">render
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.262.1">In the same file, find the following lines of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.263.1">order_create</span></code><span class="koboSpan" id="kobo.264.1"> view:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.265.1"># launch asynchronous task</span></span><span class="koboSpan" id="kobo.266.1">
order_created.delay(order.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.267.1">id</span></span><span class="koboSpan" id="kobo.268.1">)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.269.1">return</span></span><span class="koboSpan" id="kobo.270.1"> render(
  request, </span><span class="hljs-string"><span class="koboSpan" id="kobo.271.1">'orders/order/created.html'</span></span><span class="koboSpan" id="kobo.272.1">, {</span><span class="hljs-string"><span class="koboSpan" id="kobo.273.1">'order'</span></span><span class="koboSpan" id="kobo.274.1">: order}
)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.275.1">Replace them with the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.276.1"># launch asynchronous task</span></span><span class="koboSpan" id="kobo.277.1">
order_created.delay(order.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.278.1">id</span></span><span class="koboSpan" id="kobo.279.1">)
</span><span class="code-highlight"><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.280.1"># set the order in the session</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.281.1">request.session[</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.282.1">'order_id'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.283.1">] = order.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.284.1">id</span></strong></span>
<span class="code-highlight"><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.285.1"># redirect for payment</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.286.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.287.1"> redirect(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.288.1">'payment:process'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.289.1">)</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.290.1">The edited view should look as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.291.1">from</span></span><span class="koboSpan" id="kobo.292.1"> django.shortcuts </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.293.1">import</span></span> <span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.294.1">redirect, </span></strong></span><span class="koboSpan" id="kobo.295.1">render
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.296.1"># ...</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.297.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.298.1">order_create</span></span><span class="koboSpan" id="kobo.299.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.300.1">request</span></span><span class="koboSpan" id="kobo.301.1">):
    cart = Cart(request)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.302.1">if</span></span><span class="koboSpan" id="kobo.303.1"> request.method == </span><span class="hljs-string"><span class="koboSpan" id="kobo.304.1">'POST'</span></span><span class="koboSpan" id="kobo.305.1">:
        form = OrderCreateForm(request.POST)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.306.1">if</span></span><span class="koboSpan" id="kobo.307.1"> form.is_valid():
            order = form.save()
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.308.1">for</span></span><span class="koboSpan" id="kobo.309.1"> item </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.310.1">in</span></span><span class="koboSpan" id="kobo.311.1"> cart:
                OrderItem.objects.create(
                    order=order,
                    product=item[</span><span class="hljs-string"><span class="koboSpan" id="kobo.312.1">'product'</span></span><span class="koboSpan" id="kobo.313.1">],
                    price=item[</span><span class="hljs-string"><span class="koboSpan" id="kobo.314.1">'price'</span></span><span class="koboSpan" id="kobo.315.1">],
                    quantity=item[</span><span class="hljs-string"><span class="koboSpan" id="kobo.316.1">'quantity'</span></span><span class="koboSpan" id="kobo.317.1">]
                )
            </span><span class="hljs-comment"><span class="koboSpan" id="kobo.318.1"># clear the cart</span></span><span class="koboSpan" id="kobo.319.1">
            cart.clear()
            </span><span class="hljs-comment"><span class="koboSpan" id="kobo.320.1"># launch asynchronous task</span></span><span class="koboSpan" id="kobo.321.1">
            order_created.delay(order.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.322.1">id</span></span><span class="koboSpan" id="kobo.323.1">)
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.324.1"># set the order in the session</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.325.1">            request.session[</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.326.1">'order_id'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.327.1">] = order.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.328.1">id</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.329.1"># redirect for payment</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.330.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.331.1"> redirect(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.332.1">'payment:process'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.333.1">)</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.334.1">else</span></span><span class="koboSpan" id="kobo.335.1">:
        form = OrderCreateForm()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.336.1">return</span></span><span class="koboSpan" id="kobo.337.1"> render(
        request,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.338.1">'orders/order/create.html'</span></span><span class="koboSpan" id="kobo.339.1">,
        {</span><span class="hljs-string"><span class="koboSpan" id="kobo.340.1">'cart'</span></span><span class="koboSpan" id="kobo.341.1">: cart, </span><span class="hljs-string"><span class="koboSpan" id="kobo.342.1">'form'</span></span><span class="koboSpan" id="kobo.343.1">: form}
    )
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.344.1">Instead of rendering the template </span><code class="inlineCode"><span class="koboSpan" id="kobo.345.1">orders/order/created.html</span></code><span class="koboSpan" id="kobo.346.1"> when placing a new order, the order ID is stored in the user session and the user is redirected to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.347.1">payment:process</span></code><span class="koboSpan" id="kobo.348.1"> URL. </span><span class="koboSpan" id="kobo.348.2">We are </span><a id="_idIndexMarker839"/><span class="koboSpan" id="kobo.349.1">going to implement this URL later. </span><span class="koboSpan" id="kobo.349.2">Remember that Celery has to be running for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.350.1">order_created</span></code><span class="koboSpan" id="kobo.351.1"> task to be queued and executed.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.352.1">Let’s integrate the payment gateway.</span></p>
<h3 class="heading-3" id="_idParaDest-264"><span class="koboSpan" id="kobo.353.1">Integrating Stripe Checkout</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.354.1">The Stripe Checkout integration consists of a checkout page hosted by Stripe that allows the user to enter the payment</span><a id="_idIndexMarker840"/><span class="koboSpan" id="kobo.355.1"> details, usually a credit card, and then it collects the payment. </span><span class="koboSpan" id="kobo.355.2">If the payment is successful, Stripe redirects the client to a success page. </span><span class="koboSpan" id="kobo.355.3">If the payment is canceled by the client, it redirects the client to a cancel page.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.356.1">We will implement three views:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.357.1">payment_process</span></code><span class="koboSpan" id="kobo.358.1">: Creates a Stripe </span><strong class="keyWord"><span class="koboSpan" id="kobo.359.1">Checkout Session</span></strong><span class="koboSpan" id="kobo.360.1"> and redirects the client to the Stripe-hosted payment form. </span><span class="koboSpan" id="kobo.360.2">A checkout session is a programmatic representation of what the client sees when they are redirected to the payment form, including the products, quantities, currency, and amount to charge.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.361.1">payment_completed</span></code><span class="koboSpan" id="kobo.362.1">: Displays a message for successful payments. </span><span class="koboSpan" id="kobo.362.2">The user is redirected to this view if the payment is successful.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.363.1">payment_canceled</span></code><span class="koboSpan" id="kobo.364.1">: Displays a message for canceled payments. </span><span class="koboSpan" id="kobo.364.2">The user is redirected to this view if the payment is canceled.</span></li>
</ul>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.365.1">Figure 9.8</span></em><span class="koboSpan" id="kobo.366.1"> shows the checkout payment flow:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.367.1"><img alt="Graphical user interface, application  Description automatically generated" src="../Images/B21088_09_08.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.368.1">Figure 9.8: The checkout payment flow</span></p>
<p class="normal"><span class="koboSpan" id="kobo.369.1">The complete checkout process will work as follows:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.370.1">After an order is created, the user is redirected to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.371.1">payment_process</span></code><span class="koboSpan" id="kobo.372.1"> view. </span><span class="koboSpan" id="kobo.372.2">The user is presented with </span><a id="_idIndexMarker841"/><span class="koboSpan" id="kobo.373.1">an order summary and a button to proceed with the payment.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.374.1">When the user proceeds to pay, a Stripe checkout session is created. </span><span class="koboSpan" id="kobo.374.2">The checkout session includes the list of items that the user will purchase, a URL to redirect the user to after a successful payment, and a URL to redirect the user to if the payment is canceled.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.375.1">The view redirects the user to the Stripe-hosted checkout page. </span><span class="koboSpan" id="kobo.375.2">This page includes the payment form. </span><span class="koboSpan" id="kobo.375.3">The client enters their credit card details and submits the form.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.376.1">Stripe processes the payment and redirects the client to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.377.1">payment_completed</span></code><span class="koboSpan" id="kobo.378.1"> view. </span><span class="koboSpan" id="kobo.378.2">If the client doesn’t complete the payment, Stripe redirects the client to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.379.1">payment_canceled</span></code><span class="koboSpan" id="kobo.380.1"> view instead.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.381.1">Let’s start building the payment </span><a id="_idIndexMarker842"/><span class="koboSpan" id="kobo.382.1">views. </span><span class="koboSpan" id="kobo.382.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.383.1">views.py</span></code><span class="koboSpan" id="kobo.384.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.385.1">payment</span></code><span class="koboSpan" id="kobo.386.1"> application and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.387.1">from</span></span><span class="koboSpan" id="kobo.388.1"> decimal </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.389.1">import</span></span><span class="koboSpan" id="kobo.390.1"> Decimal
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.391.1">import</span></span><span class="koboSpan" id="kobo.392.1"> stripe
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.393.1">from</span></span><span class="koboSpan" id="kobo.394.1"> django.conf </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.395.1">import</span></span><span class="koboSpan" id="kobo.396.1"> settings
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.397.1">from</span></span><span class="koboSpan" id="kobo.398.1"> django.shortcuts </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.399.1">import</span></span><span class="koboSpan" id="kobo.400.1"> get_object_or_404, redirect, render
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.401.1">from</span></span><span class="koboSpan" id="kobo.402.1"> django.urls </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.403.1">import</span></span><span class="koboSpan" id="kobo.404.1"> reverse
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.405.1">from</span></span><span class="koboSpan" id="kobo.406.1"> orders.models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.407.1">import</span></span><span class="koboSpan" id="kobo.408.1"> Order
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.409.1"># create the Stripe instance</span></span><span class="koboSpan" id="kobo.410.1">
stripe.api_key = settings.STRIPE_SECRET_KEY
stripe.api_version = settings.STRIPE_API_VERSION
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.411.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.412.1">payment_process</span></span><span class="koboSpan" id="kobo.413.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.414.1">request</span></span><span class="koboSpan" id="kobo.415.1">):
    order_id = request.session.get(</span><span class="hljs-string"><span class="koboSpan" id="kobo.416.1">'order_id'</span></span><span class="koboSpan" id="kobo.417.1">)
    order = get_object_or_404(Order, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.418.1">id</span></span><span class="koboSpan" id="kobo.419.1">=order_id)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.420.1">if</span></span><span class="koboSpan" id="kobo.421.1"> request.method == </span><span class="hljs-string"><span class="koboSpan" id="kobo.422.1">'POST'</span></span><span class="koboSpan" id="kobo.423.1">:
        success_url = request.build_absolute_uri(
            reverse(</span><span class="hljs-string"><span class="koboSpan" id="kobo.424.1">'payment:completed'</span></span><span class="koboSpan" id="kobo.425.1">)
        )
        cancel_url = request.build_absolute_uri(
            reverse(</span><span class="hljs-string"><span class="koboSpan" id="kobo.426.1">'payment:canceled'</span></span><span class="koboSpan" id="kobo.427.1">)
        )
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.428.1"># Stripe checkout session data</span></span><span class="koboSpan" id="kobo.429.1">
        session_data = {
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.430.1">'mode'</span></span><span class="koboSpan" id="kobo.431.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.432.1">'payment'</span></span><span class="koboSpan" id="kobo.433.1">,
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.434.1">'client_reference_id'</span></span><span class="koboSpan" id="kobo.435.1">: order.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.436.1">id</span></span><span class="koboSpan" id="kobo.437.1">,
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.438.1">'success_url'</span></span><span class="koboSpan" id="kobo.439.1">: success_url,
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.440.1">'cancel_url'</span></span><span class="koboSpan" id="kobo.441.1">: cancel_url,
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.442.1">'line_items'</span></span><span class="koboSpan" id="kobo.443.1">: []
        }
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.444.1"># create Stripe checkout session</span></span><span class="koboSpan" id="kobo.445.1">
        session = stripe.checkout.Session.create(**session_data)
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.446.1"># redirect to Stripe payment form</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.447.1">return</span></span><span class="koboSpan" id="kobo.448.1"> redirect(session.url, code=</span><span class="hljs-number"><span class="koboSpan" id="kobo.449.1">303</span></span><span class="koboSpan" id="kobo.450.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.451.1">else</span></span><span class="koboSpan" id="kobo.452.1">:
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.453.1">return</span></span><span class="koboSpan" id="kobo.454.1"> render(request, </span><span class="hljs-string"><span class="koboSpan" id="kobo.455.1">'payment/process.html'</span></span><span class="koboSpan" id="kobo.456.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.457.1">locals</span></span><span class="koboSpan" id="kobo.458.1">())
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.459.1">In the previous code, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.460.1">stripe</span></code><span class="koboSpan" id="kobo.461.1"> module is imported and the Stripe API key is set using the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.462.1">STRIPE_SECRET_KEY</span></code><span class="koboSpan" id="kobo.463.1"> setting. </span><span class="koboSpan" id="kobo.463.2">The API version to use is also set using the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.464.1">STRIPE_API_VERSION</span></code><span class="koboSpan" id="kobo.465.1"> setting.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.466.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.467.1">payment_process</span></code><span class="koboSpan" id="kobo.468.1"> view performs the following tasks:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.469.1">The current </span><code class="inlineCode"><span class="koboSpan" id="kobo.470.1">Order</span></code><span class="koboSpan" id="kobo.471.1"> object is retrieved from the database using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.472.1">order_id</span></code><span class="koboSpan" id="kobo.473.1"> session key, which was stored previously in the session by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.474.1">order_create</span></code><span class="koboSpan" id="kobo.475.1"> view.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.476.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.477.1">Order</span></code><span class="koboSpan" id="kobo.478.1"> object for the</span><a id="_idIndexMarker843"/><span class="koboSpan" id="kobo.479.1"> given ID is retrieved. </span><span class="koboSpan" id="kobo.479.2">By using the shortcut function </span><code class="inlineCode"><span class="koboSpan" id="kobo.480.1">get_object_or_404()</span></code><span class="koboSpan" id="kobo.481.1">, an </span><code class="inlineCode"><span class="koboSpan" id="kobo.482.1">Http404</span></code><span class="koboSpan" id="kobo.483.1"> (page not found) exception is raised if no order is found with the given ID.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.484.1">If the view is loaded with a </span><code class="inlineCode"><span class="koboSpan" id="kobo.485.1">GET</span></code><span class="koboSpan" id="kobo.486.1"> request, the template </span><code class="inlineCode"><span class="koboSpan" id="kobo.487.1">payment/process.html</span></code><span class="koboSpan" id="kobo.488.1"> is rendered and returned. </span><span class="koboSpan" id="kobo.488.2">This template will include the order summary and a button to proceed with the payment, which will generate a </span><code class="inlineCode"><span class="koboSpan" id="kobo.489.1">POST</span></code><span class="koboSpan" id="kobo.490.1"> request to the view.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.491.1">Alternatively, if the view is loaded with a </span><code class="inlineCode"><span class="koboSpan" id="kobo.492.1">POST</span></code><span class="koboSpan" id="kobo.493.1"> request, a Stripe checkout session is created with </span><code class="inlineCode"><span class="koboSpan" id="kobo.494.1">stripe.checkout.Session.create()</span></code><span class="koboSpan" id="kobo.495.1"> using the following parameters:</span><ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.496.1">mode</span></code><span class="koboSpan" id="kobo.497.1">: The mode of the checkout session. </span><span class="koboSpan" id="kobo.497.2">We use </span><code class="inlineCode"><span class="koboSpan" id="kobo.498.1">payment</span></code><span class="koboSpan" id="kobo.499.1"> for a one-time payment. </span><span class="koboSpan" id="kobo.499.2">You can see the different values accepted for this parameter at </span><a href="https://stripe.com/docs/api/checkout/sessions/object#checkout_session_object-mode"><span class="url"><span class="koboSpan" id="kobo.500.1">https://stripe.com/docs/api/checkout/sessions/object#checkout_session_object-mode</span></span></a><span class="koboSpan" id="kobo.501.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.502.1">client_reference_id</span></code><span class="koboSpan" id="kobo.503.1">: The unique reference for this payment. </span><span class="koboSpan" id="kobo.503.2">We will use this to reconcile the Stripe checkout session with our order. </span><span class="koboSpan" id="kobo.503.3">By passing the order ID, we link Stripe payments to orders in our system and we will be able to receive payment notifications from Stripe to mark the orders as paid.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.504.1">success_url</span></code><span class="koboSpan" id="kobo.505.1">: The URL for Stripe to redirect the user to if the payment is successful. </span><span class="koboSpan" id="kobo.505.2">We use </span><code class="inlineCode"><span class="koboSpan" id="kobo.506.1">request.build_absolute_uri()</span></code><span class="koboSpan" id="kobo.507.1"> to generate an absolute URI from the URL path. </span><span class="koboSpan" id="kobo.507.2">You can see the documentation for this method at </span><a href="https://docs.djangoproject.com/en/5.0/ref/request-response/#django.http.HttpRequest.build_absolute_uri"><span class="url"><span class="koboSpan" id="kobo.508.1">https://docs.djangoproject.com/en/5.0/ref/request-response/#django.http.HttpRequest.build_absolute_uri</span></span></a><span class="koboSpan" id="kobo.509.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.510.1">cancel_url</span></code><span class="koboSpan" id="kobo.511.1">: The URL for Stripe to redirect the user to if the payment is canceled.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.512.1">line_items</span></code><span class="koboSpan" id="kobo.513.1">: This is an empty list. </span><span class="koboSpan" id="kobo.513.2">We will next populate it with the order items to be purchased.</span></li>
</ul>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.514.1">After creating the checkout session, an HTTP redirect with status code </span><code class="inlineCode"><span class="koboSpan" id="kobo.515.1">303</span></code><span class="koboSpan" id="kobo.516.1"> is returned to redirect the user to Stripe. </span><span class="koboSpan" id="kobo.516.2">The status code </span><code class="inlineCode"><span class="koboSpan" id="kobo.517.1">303</span></code><span class="koboSpan" id="kobo.518.1"> is recommended to redirect web applications to</span><a id="_idIndexMarker844"/><span class="koboSpan" id="kobo.519.1"> a new URI after an HTTP </span><code class="inlineCode"><span class="koboSpan" id="kobo.520.1">POST</span></code><span class="koboSpan" id="kobo.521.1"> has been performed.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.522.1">You can see all the parameters to create a Stripe </span><code class="inlineCode"><span class="koboSpan" id="kobo.523.1">session</span></code><span class="koboSpan" id="kobo.524.1"> object at </span><a href="https://stripe.com/docs/api/checkout/sessions/create"><span class="url"><span class="koboSpan" id="kobo.525.1">https://stripe.com/docs/api/checkout/sessions/create</span></span></a><span class="koboSpan" id="kobo.526.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.527.1">Let’s populate the </span><code class="inlineCode"><span class="koboSpan" id="kobo.528.1">line_items</span></code><span class="koboSpan" id="kobo.529.1"> list with the order items to create the checkout session. </span><span class="koboSpan" id="kobo.529.2">Each item will contain the name of the item, the amount to charge, the currency to use, and the quantity purchased.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.530.1">Add the following code highlighted in bold to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.531.1">payment_process</span></code><span class="koboSpan" id="kobo.532.1"> view:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.533.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.534.1">payment_process</span></span><span class="koboSpan" id="kobo.535.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.536.1">request</span></span><span class="koboSpan" id="kobo.537.1">):
    order_id = request.session.get(</span><span class="hljs-string"><span class="koboSpan" id="kobo.538.1">'order_id'</span></span><span class="koboSpan" id="kobo.539.1">)
    order = get_object_or_404(Order, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.540.1">id</span></span><span class="koboSpan" id="kobo.541.1">=order_id)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.542.1">if</span></span><span class="koboSpan" id="kobo.543.1"> request.method == </span><span class="hljs-string"><span class="koboSpan" id="kobo.544.1">'POST'</span></span><span class="koboSpan" id="kobo.545.1">:
        success_url = request.build_absolute_uri(
            reverse(</span><span class="hljs-string"><span class="koboSpan" id="kobo.546.1">'payment:completed'</span></span><span class="koboSpan" id="kobo.547.1">)
        )
        cancel_url = request.build_absolute_uri(
            reverse(</span><span class="hljs-string"><span class="koboSpan" id="kobo.548.1">'payment:canceled'</span></span><span class="koboSpan" id="kobo.549.1">)
        )
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.550.1"># Stripe checkout session data</span></span><span class="koboSpan" id="kobo.551.1">
        session_data = {
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.552.1">'mode'</span></span><span class="koboSpan" id="kobo.553.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.554.1">'payment'</span></span><span class="koboSpan" id="kobo.555.1">,
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.556.1">'success_url'</span></span><span class="koboSpan" id="kobo.557.1">: success_url,
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.558.1">'cancel_url'</span></span><span class="koboSpan" id="kobo.559.1">: cancel_url,
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.560.1">'line_items'</span></span><span class="koboSpan" id="kobo.561.1">: []
        }
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.562.1"># add order items to the Stripe checkout session</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.563.1">for</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.564.1"> item </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.565.1">in</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.566.1"> order.items.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.567.1">all</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.568.1">():</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.569.1">            session_data[</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.570.1">'line_items'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.571.1">].append(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.572.1">                {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.573.1">'price_data'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.574.1">: {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.575.1">'unit_amount'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.576.1">: </span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.577.1">int</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.578.1">(item.price * Decimal(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.579.1">'100'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.580.1">)),</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.581.1">'currency'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.582.1">: </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.583.1">'usd'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.584.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.585.1">'product_data'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.586.1">: {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.587.1">'name'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.588.1">: item.product.name,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.589.1">                        },</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.590.1">                    },</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.591.1">'quantity'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.592.1">: item.quantity,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.593.1">                }</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.594.1">            )</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.595.1"># create Stripe checkout session</span></span><span class="koboSpan" id="kobo.596.1">
        session = stripe.checkout.Session.create(**session_data)
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.597.1"># redirect to Stripe payment form</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.598.1">return</span></span><span class="koboSpan" id="kobo.599.1"> redirect(session.url, code=</span><span class="hljs-number"><span class="koboSpan" id="kobo.600.1">303</span></span><span class="koboSpan" id="kobo.601.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.602.1">else</span></span><span class="koboSpan" id="kobo.603.1">:
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.604.1">return</span></span><span class="koboSpan" id="kobo.605.1"> render(request, </span><span class="hljs-string"><span class="koboSpan" id="kobo.606.1">'payment/process.html'</span></span><span class="koboSpan" id="kobo.607.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.608.1">locals</span></span><span class="koboSpan" id="kobo.609.1">())
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.610.1">We use the following information</span><a id="_idIndexMarker845"/><span class="koboSpan" id="kobo.611.1"> for each item:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.612.1">price_data</span></code><span class="koboSpan" id="kobo.613.1">: Price-related information:</span><ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.614.1">unit_amount</span></code><span class="koboSpan" id="kobo.615.1">: The amount in cents to be collected by the payment. </span><span class="koboSpan" id="kobo.615.2">This is a positive integer representing how much to charge in the smallest currency unit with no decimal places. </span><span class="koboSpan" id="kobo.615.3">For example, to charge $10.00, this would be </span><code class="inlineCode"><span class="koboSpan" id="kobo.616.1">1000</span></code><span class="koboSpan" id="kobo.617.1"> (that is, 1,000 cents). </span><span class="koboSpan" id="kobo.617.2">The item price, </span><code class="inlineCode"><span class="koboSpan" id="kobo.618.1">item.price</span></code><span class="koboSpan" id="kobo.619.1">, is multiplied by </span><code class="inlineCode"><span class="koboSpan" id="kobo.620.1">Decimal('100')</span></code><span class="koboSpan" id="kobo.621.1"> to obtain the value in cents, and then it is converted into an integer.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.622.1">currency</span></code><span class="koboSpan" id="kobo.623.1">: The currency to use in the three-letter ISO format. </span><span class="koboSpan" id="kobo.623.2">We use </span><code class="inlineCode"><span class="koboSpan" id="kobo.624.1">usd</span></code><span class="koboSpan" id="kobo.625.1"> for US dollars. </span><span class="koboSpan" id="kobo.625.2">You can see a list of supported currencies at </span><a href="https://stripe.com/docs/currencies"><span class="url"><span class="koboSpan" id="kobo.626.1">https://stripe.com/docs/currencies</span></span></a><span class="koboSpan" id="kobo.627.1">.</span></li>
</ul>
</li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.628.1">product_data</span></code><span class="koboSpan" id="kobo.629.1">: Product-related information:</span><ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.630.1">name</span></code><span class="koboSpan" id="kobo.631.1">: The name of the product</span></li>
</ul>
</li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.632.1">quantity</span></code><span class="koboSpan" id="kobo.633.1">: The number of units to purchase</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.634.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.635.1">payment_process</span></code><span class="koboSpan" id="kobo.636.1"> view is now ready. </span><span class="koboSpan" id="kobo.636.2">Let’s create simple views for the payment success and cancel pages.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.637.1">Add the following code to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.638.1">views.py</span></code><span class="koboSpan" id="kobo.639.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.640.1">payment</span></code><span class="koboSpan" id="kobo.641.1"> application:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.642.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.643.1">payment_completed</span></span><span class="koboSpan" id="kobo.644.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.645.1">request</span></span><span class="koboSpan" id="kobo.646.1">):
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.647.1">return</span></span><span class="koboSpan" id="kobo.648.1"> render(request, </span><span class="hljs-string"><span class="koboSpan" id="kobo.649.1">'payment/completed.html'</span></span><span class="koboSpan" id="kobo.650.1">)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.651.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.652.1">payment_canceled</span></span><span class="koboSpan" id="kobo.653.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.654.1">request</span></span><span class="koboSpan" id="kobo.655.1">):
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.656.1">return</span></span><span class="koboSpan" id="kobo.657.1"> render(request, </span><span class="hljs-string"><span class="koboSpan" id="kobo.658.1">'payment/canceled.html'</span></span><span class="koboSpan" id="kobo.659.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.660.1">Create a new file inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.661.1">payment</span></code><span class="koboSpan" id="kobo.662.1"> application </span><a id="_idIndexMarker846"/><span class="koboSpan" id="kobo.663.1">directory and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.664.1">urls.py</span></code><span class="koboSpan" id="kobo.665.1">. </span><span class="koboSpan" id="kobo.665.2">Add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.666.1">from</span></span><span class="koboSpan" id="kobo.667.1"> django.urls </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.668.1">import</span></span><span class="koboSpan" id="kobo.669.1"> path
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.670.1">from</span></span><span class="koboSpan" id="kobo.671.1"> . </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.672.1">import</span></span><span class="koboSpan" id="kobo.673.1"> views
app_name = </span><span class="hljs-string"><span class="koboSpan" id="kobo.674.1">'payment'</span></span><span class="koboSpan" id="kobo.675.1">
urlpatterns = [
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.676.1">'process/'</span></span><span class="koboSpan" id="kobo.677.1">, views.payment_process, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.678.1">'process'</span></span><span class="koboSpan" id="kobo.679.1">),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.680.1">'completed/'</span></span><span class="koboSpan" id="kobo.681.1">, views.payment_completed, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.682.1">'completed'</span></span><span class="koboSpan" id="kobo.683.1">),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.684.1">'canceled/'</span></span><span class="koboSpan" id="kobo.685.1">, views.payment_canceled, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.686.1">'canceled'</span></span><span class="koboSpan" id="kobo.687.1">),
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.688.1">These are the URLs for the payment workflow. </span><span class="koboSpan" id="kobo.688.2">We have included the following URL patterns:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.689.1">process</span></code><span class="koboSpan" id="kobo.690.1">: The view that displays the order summary to the user, creates the Stripe checkout session, and redirects the user to the Stripe-hosted payment form</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.691.1">completed</span></code><span class="koboSpan" id="kobo.692.1">: The view for Stripe to redirect the user to if the payment is successful</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.693.1">canceled</span></code><span class="koboSpan" id="kobo.694.1">: The view for Stripe to redirect the user to if the payment is canceled</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.695.1">Edit the main </span><code class="inlineCode"><span class="koboSpan" id="kobo.696.1">urls.py</span></code><span class="koboSpan" id="kobo.697.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.698.1">myshop</span></code><span class="koboSpan" id="kobo.699.1"> project and include the URL patterns for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.700.1">payment</span></code><span class="koboSpan" id="kobo.701.1"> application, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.702.1">urlpatterns = [
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.703.1">'admin/'</span></span><span class="koboSpan" id="kobo.704.1">, admin.site.urls),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.705.1">'cart/'</span></span><span class="koboSpan" id="kobo.706.1">, include(</span><span class="hljs-string"><span class="koboSpan" id="kobo.707.1">'cart.urls'</span></span><span class="koboSpan" id="kobo.708.1">, namespace=</span><span class="hljs-string"><span class="koboSpan" id="kobo.709.1">'cart'</span></span><span class="koboSpan" id="kobo.710.1">)),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.711.1">'orders/'</span></span><span class="koboSpan" id="kobo.712.1">, include(</span><span class="hljs-string"><span class="koboSpan" id="kobo.713.1">'orders.urls'</span></span><span class="koboSpan" id="kobo.714.1">, namespace=</span><span class="hljs-string"><span class="koboSpan" id="kobo.715.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.716.1">orders'</span></span><span class="koboSpan" id="kobo.717.1">)),
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.718.1">    path(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.719.1">'payment/'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.720.1">, include(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.721.1">'payment.urls'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.722.1">, namespace=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.723.1">'payment'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.724.1">)),</span></strong></span><span class="koboSpan" id="kobo.725.1">
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.726.1">''</span></span><span class="koboSpan" id="kobo.727.1">, include(</span><span class="hljs-string"><span class="koboSpan" id="kobo.728.1">'shop.urls'</span></span><span class="koboSpan" id="kobo.729.1">, namespace=</span><span class="hljs-string"><span class="koboSpan" id="kobo.730.1">'shop'</span></span><span class="koboSpan" id="kobo.731.1">)),
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.732.1">We have placed the new path before the </span><code class="inlineCode"><span class="koboSpan" id="kobo.733.1">shop.urls</span></code><span class="koboSpan" id="kobo.734.1"> pattern to avoid an unintended pattern match with a pattern defined in </span><code class="inlineCode"><span class="koboSpan" id="kobo.735.1">shop.urls</span></code><span class="koboSpan" id="kobo.736.1">. </span><span class="koboSpan" id="kobo.736.2">Remember that Django runs through each URL pattern in order and stops at the first one that matches the requested URL.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.737.1">Let’s build a template for each </span><a id="_idIndexMarker847"/><span class="koboSpan" id="kobo.738.1">view. </span><span class="koboSpan" id="kobo.738.2">Create the following file structure inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.739.1">payment</span></code><span class="koboSpan" id="kobo.740.1"> application directory:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.741.1">templates/
    payment/
        process.html
        completed.html
        canceled.html
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.742.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.743.1">payment/process.html</span></code><span class="koboSpan" id="kobo.744.1"> template and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.745.1">{% extends "shop/base.html" %}
{% load static %}
{% block title %}Pay your order{% endblock %}
{% block content %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.746.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.747.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.748.1">&gt;</span></span><span class="koboSpan" id="kobo.749.1">Order summary</span><span class="hljs-tag"><span class="koboSpan" id="kobo.750.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.751.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.752.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.753.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.754.1">table</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.755.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.756.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.757.1">"cart"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.758.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.759.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.760.1">thead</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.761.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.762.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.763.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.764.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.765.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.766.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.767.1">&gt;</span></span><span class="koboSpan" id="kobo.768.1">Image</span><span class="hljs-tag"><span class="koboSpan" id="kobo.769.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.770.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.771.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.772.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.773.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.774.1">&gt;</span></span><span class="koboSpan" id="kobo.775.1">Product</span><span class="hljs-tag"><span class="koboSpan" id="kobo.776.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.777.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.778.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.779.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.780.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.781.1">&gt;</span></span><span class="koboSpan" id="kobo.782.1">Price</span><span class="hljs-tag"><span class="koboSpan" id="kobo.783.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.784.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.785.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.786.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.787.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.788.1">&gt;</span></span><span class="koboSpan" id="kobo.789.1">Quantity</span><span class="hljs-tag"><span class="koboSpan" id="kobo.790.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.791.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.792.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.793.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.794.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.795.1">&gt;</span></span><span class="koboSpan" id="kobo.796.1">Total</span><span class="hljs-tag"><span class="koboSpan" id="kobo.797.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.798.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.799.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.800.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.801.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.802.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.803.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.804.1">thead</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.805.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.806.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.807.1">tbody</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.808.1">&gt;</span></span><span class="koboSpan" id="kobo.809.1">
      {% for item in order.items.all %}
        </span><span class="hljs-tag"><span class="koboSpan" id="kobo.810.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.811.1">tr</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.812.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.813.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.814.1">"row{% cycle "</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.815.1">1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.816.1">" "</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.817.1">2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.818.1">" %}"&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.819.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.820.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.821.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.822.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.823.1">img</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.824.1">src</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.825.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.826.1">"{% if item.product.image %}{{ item.product.image.url }}</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.827.1">            {% else %}{% static "img/no_image.png" %}{% endif %}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.828.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.829.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.830.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.831.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.832.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.833.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.834.1">&gt;</span></span><span class="koboSpan" id="kobo.835.1">{{ item.product.name }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.836.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.837.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.838.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.839.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.840.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.841.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.842.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.843.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.844.1">&gt;</span></span><span class="koboSpan" id="kobo.845.1">${{ item.price }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.846.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.847.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.848.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.849.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.850.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.851.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.852.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.853.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.854.1">&gt;</span></span><span class="koboSpan" id="kobo.855.1">{{ item.quantity }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.856.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.857.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.858.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.859.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.860.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.861.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.862.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.863.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.864.1">&gt;</span></span><span class="koboSpan" id="kobo.865.1">${{ item.get_cost }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.866.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.867.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.868.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.869.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.870.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.871.1">&gt;</span></span><span class="koboSpan" id="kobo.872.1">
      {% endfor %}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.873.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.874.1">tr</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.875.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.876.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.877.1">"total"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.878.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.879.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.880.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.881.1">colspan</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.882.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.883.1">"4"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.884.1">&gt;</span></span><span class="koboSpan" id="kobo.885.1">Total</span><span class="hljs-tag"><span class="koboSpan" id="kobo.886.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.887.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.888.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.889.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.890.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.891.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.892.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.893.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.894.1">&gt;</span></span><span class="koboSpan" id="kobo.895.1">${{ order.get_total_cost }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.896.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.897.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.898.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.899.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.900.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.901.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.902.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.903.1">tbody</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.904.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.905.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.906.1">table</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.907.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.908.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.909.1">form</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.910.1">action</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.911.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.912.1">"{% url "payment:process" %}"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.913.1">method</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.914.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.915.1">"post"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.916.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.917.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.918.1">input</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.919.1">type</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.920.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.921.1">"submit"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.922.1">value</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.923.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.924.1">"Pay now"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.925.1">&gt;</span></span><span class="koboSpan" id="kobo.926.1">
    {% csrf_token %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.927.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.928.1">form</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.929.1">&gt;</span></span><span class="koboSpan" id="kobo.930.1">
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.931.1">This is the template to display the order summary to the user and allow the client to proceed with the payment. </span><span class="koboSpan" id="kobo.931.2">It includes </span><a id="_idIndexMarker848"/><span class="koboSpan" id="kobo.932.1">a form and a </span><strong class="screenText"><span class="koboSpan" id="kobo.933.1">Pay now</span></strong><span class="koboSpan" id="kobo.934.1"> button to submit it via </span><code class="inlineCode"><span class="koboSpan" id="kobo.935.1">POST</span></code><span class="koboSpan" id="kobo.936.1">. </span><span class="koboSpan" id="kobo.936.2">When the form is submitted, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.937.1">payment_process</span></code><span class="koboSpan" id="kobo.938.1"> view creates the Stripe checkout session and redirects the user to the Stripe-hosted payment form.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.939.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.940.1">payment/completed.html</span></code><span class="koboSpan" id="kobo.941.1"> template and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.942.1">{% extends "shop/base.html" %}
{% block title %}Payment successful{% endblock %}
{% block content %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.943.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.944.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.945.1">&gt;</span></span><span class="koboSpan" id="kobo.946.1">Your payment was successful</span><span class="hljs-tag"><span class="koboSpan" id="kobo.947.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.948.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.949.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.950.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.951.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.952.1">&gt;</span></span><span class="koboSpan" id="kobo.953.1">Your payment has been processed successfully.</span><span class="hljs-tag"><span class="koboSpan" id="kobo.954.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.955.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.956.1">&gt;</span></span><span class="koboSpan" id="kobo.957.1">
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.958.1">This is the template for the page that the user is redirected to after a successful payment.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.959.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.960.1">payment/canceled.html</span></code><span class="koboSpan" id="kobo.961.1"> template and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.962.1">{% extends "shop/base.html" %}
{% block title %}Payment canceled{% endblock %}
{% block content %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.963.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.964.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.965.1">&gt;</span></span><span class="koboSpan" id="kobo.966.1">Your payment has not been processed</span><span class="hljs-tag"><span class="koboSpan" id="kobo.967.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.968.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.969.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.970.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.971.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.972.1">&gt;</span></span><span class="koboSpan" id="kobo.973.1">There was a problem processing your payment.</span><span class="hljs-tag"><span class="koboSpan" id="kobo.974.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.975.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.976.1">&gt;</span></span><span class="koboSpan" id="kobo.977.1">
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.978.1">This is the template for the page that the user is redirected to when the payment is canceled.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.979.1">We have implemented the </span><a id="_idIndexMarker849"/><span class="koboSpan" id="kobo.980.1">necessary views to process payments, including their URL patterns and templates. </span><span class="koboSpan" id="kobo.980.2">It’s time to try out the checkout process.</span></p>
<h2 class="heading-2" id="_idParaDest-265"><span class="koboSpan" id="kobo.981.1">Testing the checkout process</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.982.1">Execute the following</span><a id="_idIndexMarker850"/><span class="koboSpan" id="kobo.983.1"> command in the shell to start the RabbitMQ server</span><a id="_idIndexMarker851"/><span class="koboSpan" id="kobo.984.1"> with Docker:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.985.1">docker run -it --rm --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3.13.1-management
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.986.1">This will run RabbitMQ on port </span><code class="inlineCode"><span class="koboSpan" id="kobo.987.1">5672</span></code><span class="koboSpan" id="kobo.988.1"> and the web-based management interface on port </span><code class="inlineCode"><span class="koboSpan" id="kobo.989.1">15672</span></code><span class="koboSpan" id="kobo.990.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.991.1">Open another shell and start the Celery worker from your project directory with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.992.1">celery -A myshop worker -l info
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.993.1">Open one more shell and start the development server from your project directory with this command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.994.1">python manage.py runserver
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.995.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.996.1">http://127.0.0.1:8000/</span></code><span class="koboSpan" id="kobo.997.1"> in your browser, add some products to the shopping cart, and fill in the checkout form. </span><span class="koboSpan" id="kobo.997.2">Click the </span><strong class="screenText"><span class="koboSpan" id="kobo.998.1">Place order</span></strong><span class="koboSpan" id="kobo.999.1"> button. </span><span class="koboSpan" id="kobo.999.2">The order will be persisted to the database, the order ID will be saved in the current session, and you will be redirected to the payment process page.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1000.1">The payment process page will look as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1001.1"><img alt="A picture containing graphical user interface  Description automatically generated" src="../Images/B21088_09_09.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1002.1">Figure 9.9: The payment process page including an order summary</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.1003.1">Images in this chapter:</span></p>
<ul>
<li class="bulletList"><em class="italic"><span class="koboSpan" id="kobo.1004.1">Green tea</span></em><span class="koboSpan" id="kobo.1005.1">: Photo by Jia Ye on Unsplash</span></li>
<li class="bulletList"><em class="italic"><span class="koboSpan" id="kobo.1006.1">Red tea</span></em><span class="koboSpan" id="kobo.1007.1">: Photo by Manki Kim on Unsplash</span></li>
</ul>
</div>
<p class="normal"><span class="koboSpan" id="kobo.1008.1">On this page, you can see an order </span><a id="_idIndexMarker852"/><span class="koboSpan" id="kobo.1009.1">summary and a </span><strong class="screenText"><span class="koboSpan" id="kobo.1010.1">Pay now</span></strong><span class="koboSpan" id="kobo.1011.1"> button. </span><span class="koboSpan" id="kobo.1011.2">Click on </span><strong class="screenText"><span class="koboSpan" id="kobo.1012.1">Pay now</span></strong><span class="koboSpan" id="kobo.1013.1">. </span><span class="koboSpan" id="kobo.1013.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1014.1">payment_process</span></code><span class="koboSpan" id="kobo.1015.1"> view will create a Stripe checkout session, and</span><a id="_idIndexMarker853"/><span class="koboSpan" id="kobo.1016.1"> you will be redirected to the Stripe-hosted payment form. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.1017.1">You will see the following page:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1018.1"><img alt="" role="presentation" src="../Images/B21088_09_10.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1019.1">Figure 9.10: The Stripe checkout payment from</span></p>
<h3 class="heading-3" id="_idParaDest-266"><span class="koboSpan" id="kobo.1020.1">Using test credit cards</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.1021.1">Stripe provides different test credit cards from different card issuers and countries, which allows you to simulate</span><a id="_idIndexMarker854"/><span class="koboSpan" id="kobo.1022.1"> payments to test all possible scenarios (successful payment, declined payment, etc.). </span><span class="koboSpan" id="kobo.1022.2">The following table shows some of the cards you can test for different scenarios:</span></p>
<table class="table-container" id="table001">
<tbody>
<tr>
<td class="table-cell">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.1023.1">Result</span></strong></p>
</td>
<td class="table-cell">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.1024.1">Test Credit Card</span></strong></p>
</td>
<td class="table-cell">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.1025.1">CVC</span></strong></p>
</td>
<td class="table-cell">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.1026.1">Expiry date</span></strong></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.1027.1">Successful payment</span></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.1028.1">4242 4242 4242 4242</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.1029.1">Any 3 digits</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.1030.1">Any future date</span></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.1031.1">Failed payment</span></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.1032.1">4000 0000 0000 0002</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.1033.1">Any 3 digits</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.1034.1">Any future date</span></p>
</td>
</tr>
<tr>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.1035.1">Requires 3D secure authentication</span></p>
</td>
<td class="table-cell">
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.1036.1">4000 0025 0000 3155</span></code></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.1037.1">Any 3 digits</span></p>
</td>
<td class="table-cell">
<p class="normal"><span class="koboSpan" id="kobo.1038.1">Any future date</span></p>
</td>
</tr>
</tbody>
</table>
<p class="normal"><span class="koboSpan" id="kobo.1039.1">You can find the complete list</span><a id="_idIndexMarker855"/><span class="koboSpan" id="kobo.1040.1"> of credit cards for testing at </span><a href="https://stripe.com/docs/testing"><span class="url"><span class="koboSpan" id="kobo.1041.1">https://stripe.com/docs/testing</span></span></a><span class="koboSpan" id="kobo.1042.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1043.1">We are going to use the test card </span><code class="inlineCode"><span class="koboSpan" id="kobo.1044.1">4242 4242 4242 4242</span></code><span class="koboSpan" id="kobo.1045.1">, which is a Visa card that returns a successful purchase. </span><span class="koboSpan" id="kobo.1045.2">We will </span><a id="_idIndexMarker856"/><span class="koboSpan" id="kobo.1046.1">use the CVC </span><code class="inlineCode"><span class="koboSpan" id="kobo.1047.1">123</span></code><span class="koboSpan" id="kobo.1048.1"> and any future expiration date, such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.1049.1">12/29</span></code><span class="koboSpan" id="kobo.1050.1">. </span><span class="koboSpan" id="kobo.1050.2">Enter the credit card details in the payment form as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1051.1"><img alt="" role="presentation" src="../Images/B21088_09_11.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1052.1">Figure 9.11: The payment form with the valid test credit card details</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1053.1">Click the </span><strong class="screenText"><span class="koboSpan" id="kobo.1054.1">Pay</span></strong><strong class="keyWord"> </strong><span class="koboSpan" id="kobo.1055.1">button. </span><span class="koboSpan" id="kobo.1055.2">The button text will change to </span><strong class="screenText"><span class="koboSpan" id="kobo.1056.1">Processing…</span></strong><span class="koboSpan" id="kobo.1057.1">, as shown in </span><em class="italic"><span class="koboSpan" id="kobo.1058.1">Figure 9.12</span></em><span class="koboSpan" id="kobo.1059.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1060.1"><img alt="" role="presentation" src="../Images/B21088_09_12.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1061.1">Figure 9.12: The payment form being processed</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1062.1">After a couple of </span><a id="_idIndexMarker857"/><span class="koboSpan" id="kobo.1063.1">seconds, you will see the button turn green, as in </span><em class="italic"><span class="koboSpan" id="kobo.1064.1">Figure 9.13</span></em><span class="koboSpan" id="kobo.1065.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1066.1"><img alt="" role="presentation" src="../Images/B21088_09_13.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1067.1">Figure 9.13: The payment form after the payment is successful</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1068.1">Then, Stripe redirects your browser to the payment completed URL you provided when creating the checkout session. </span><span class="koboSpan" id="kobo.1068.2">You </span><a id="_idIndexMarker858"/><span class="koboSpan" id="kobo.1069.1">will see the following page:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1070.1"><img alt="Graphical user interface, text, application  Description automatically generated" src="../Images/B21088_09_14.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1071.1">Figure 9.14: The successful payment page</span></p>
<h3 class="heading-3" id="_idParaDest-267"><span class="koboSpan" id="kobo.1072.1">Checking the payment information in the Stripe dashboard</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.1073.1">Access the </span><a id="_idIndexMarker859"/><span class="koboSpan" id="kobo.1074.1">Stripe dashboard at </span><a href="https://dashboard.stripe.com/test/payments"><span class="url"><span class="koboSpan" id="kobo.1075.1">https://dashboard.stripe.com/test/payments</span></span></a><span class="koboSpan" id="kobo.1076.1">. </span><span class="koboSpan" id="kobo.1076.2">Under </span><strong class="screenText"><span class="koboSpan" id="kobo.1077.1">Payments</span></strong><span class="koboSpan" id="kobo.1078.1">, you will be able to see the </span><a id="_idIndexMarker860"/><span class="koboSpan" id="kobo.1079.1">payment, as in </span><em class="italic"><span class="koboSpan" id="kobo.1080.1">Figure 9.15</span></em><span class="koboSpan" id="kobo.1081.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1082.1"><img alt="" role="presentation" src="../Images/B21088_09_15.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1083.1">Figure 9.15: The payment object with the status Succeeded in the Stripe dashboard</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1084.1">The payment status is </span><strong class="screenText"><span class="koboSpan" id="kobo.1085.1">Succeeded</span></strong><span class="koboSpan" id="kobo.1086.1">. </span><span class="koboSpan" id="kobo.1086.2">The payment description includes the </span><strong class="keyWord"><span class="koboSpan" id="kobo.1087.1">payment intent</span></strong><span class="koboSpan" id="kobo.1088.1"> ID that starts with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1089.1">pi_</span></code><span class="koboSpan" id="kobo.1090.1">. </span><span class="koboSpan" id="kobo.1090.2">When a checkout session is confirmed, Stripe creates a payment intent associated with the session. </span><span class="koboSpan" id="kobo.1090.3">A payment intent is used to collect a payment from the user. </span><span class="koboSpan" id="kobo.1090.4">Stripe records all attempted payments as payment intents. </span><span class="koboSpan" id="kobo.1090.5">Each payment intent has a unique ID, and it </span><a id="_idIndexMarker861"/><span class="koboSpan" id="kobo.1091.1">encapsulates the details of the transaction, such as the supported payment methods, the amount to collect, and the desired currency. </span><span class="koboSpan" id="kobo.1091.2">Click on the transaction to access the payment details.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1092.1">You will see the following screen:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1093.1"><img alt="" role="presentation" src="../Images/B21088_09_16.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1094.1">Figure 9.16: Payment details for a Stripe transaction</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1095.1">Here, you can see the payment information and the payment timeline, including payment changes. </span><span class="koboSpan" id="kobo.1095.2">Under </span><strong class="screenText"><span class="koboSpan" id="kobo.1096.1">Checkout summary</span></strong><span class="koboSpan" id="kobo.1097.1">, you can find the line items purchased, including the name, quantity, unit price, and amount. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.1098.1">Under </span><strong class="screenText"><span class="koboSpan" id="kobo.1099.1">Payment details</span></strong><span class="koboSpan" id="kobo.1100.1">, you can see a breakdown of the amount </span><a id="_idIndexMarker862"/><span class="koboSpan" id="kobo.1101.1">paid and the Stripe fee for processing the payment.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1102.1">Under this section, you will find a </span><strong class="screenText"><span class="koboSpan" id="kobo.1103.1">Payment method</span></strong><span class="koboSpan" id="kobo.1104.1"> section, including details about the payment method and the credit card checks performed by Stripe, as in </span><em class="italic"><span class="koboSpan" id="kobo.1105.1">Figure 9.17</span></em><span class="koboSpan" id="kobo.1106.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1107.1"><img alt="" role="presentation" src="../Images/B21088_09_17.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1108.1">Figure 9.17: Payment method used in the Stripe transaction</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1109.1">Under this section, you will find another section named </span><strong class="screenText"><span class="koboSpan" id="kobo.1110.1">Events and logs</span></strong><span class="koboSpan" id="kobo.1111.1">, as in </span><em class="italic"><span class="koboSpan" id="kobo.1112.1">Figure 9.18</span></em><span class="koboSpan" id="kobo.1113.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1114.1"><img alt="" role="presentation" src="../Images/B21088_09_18.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1115.1">Figure 9.18: Events and logs for a Stripe transaction</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1116.1">This section contains all the activity related to the transaction, including requests to the Stripe API. </span><span class="koboSpan" id="kobo.1116.2">You can click on any</span><a id="_idIndexMarker863"/><span class="koboSpan" id="kobo.1117.1"> request to see the HTTP request to the Stripe API and the response in the JSON format.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1118.1">Let’s review the activity events in chronological order, from bottom to top:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1119.1">First, a new checkout session is created by sending a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1120.1">POST</span></code><span class="koboSpan" id="kobo.1121.1"> request to the Stripe API endpoint </span><code class="inlineCode"><span class="koboSpan" id="kobo.1122.1">/v1/checkout/sessions</span></code><span class="koboSpan" id="kobo.1123.1">. </span><span class="koboSpan" id="kobo.1123.2">The Stripe SDK method </span><code class="inlineCode"><span class="koboSpan" id="kobo.1124.1">stripe.checkout.Session.create()</span></code><span class="koboSpan" id="kobo.1125.1"> that is used in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1126.1">payment_process</span></code><span class="koboSpan" id="kobo.1127.1"> view builds and sends the request to the Stripe API, handling the response to return a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1128.1">session</span></code><span class="koboSpan" id="kobo.1129.1"> object.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1130.1">The user is redirected to the checkout page where they submit the payment form. </span><span class="koboSpan" id="kobo.1130.2">A request to confirm the checkout session is sent by the Stripe checkout page.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1131.1">A new payment intent is created.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1132.1">A charge related to the payment intent is created.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1133.1">The payment intent is now completed with a successful payment.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1134.1">The checkout session is completed.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1135.1">Congratulations! </span><span class="koboSpan" id="kobo.1135.2">You have</span><a id="_idIndexMarker864"/><span class="koboSpan" id="kobo.1136.1"> successfully integrated Stripe Checkout into your project. </span><span class="koboSpan" id="kobo.1136.2">Next, you will learn how to receive payment notifications from Stripe and how to reference Stripe payments in your shop orders.</span></p>
<h2 class="heading-2" id="_idParaDest-268"><span class="koboSpan" id="kobo.1137.1">Using webhooks to receive payment notifications</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1138.1">Stripe can push real-time events to our application by</span><a id="_idIndexMarker865"/><span class="koboSpan" id="kobo.1139.1"> using webhooks. </span><span class="koboSpan" id="kobo.1139.2">A </span><strong class="keyWord"><span class="koboSpan" id="kobo.1140.1">webhook</span></strong><span class="koboSpan" id="kobo.1141.1">, also called a callback, can</span><a id="_idIndexMarker866"/><span class="koboSpan" id="kobo.1142.1"> be thought of</span><a id="_idIndexMarker867"/><span class="koboSpan" id="kobo.1143.1"> as an event-driven API instead of a request-driven API. </span><span class="koboSpan" id="kobo.1143.2">Instead of polling the Stripe API </span><a id="_idIndexMarker868"/><span class="koboSpan" id="kobo.1144.1">frequently to know when a new payment is completed, Stripe can send an HTTP request to a URL of our application to notify us of successful payments in real time. </span><span class="koboSpan" id="kobo.1144.2">The notification of these events will be asynchronous, when the event occurs, regardless of our synchronous calls to the Stripe API.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1145.1">We will build a webhook endpoint to receive Stripe events. </span><span class="koboSpan" id="kobo.1145.2">The webhook will consist of a view that will receive a JSON payload, with the event information to process it. </span><span class="koboSpan" id="kobo.1145.3">We will use the event information to mark orders as paid when the checkout session is successfully completed.</span></p>
<h3 class="heading-3" id="_idParaDest-269"><span class="koboSpan" id="kobo.1146.1">Creating a webhook endpoint</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.1147.1">You can add webhook</span><a id="_idIndexMarker869"/><span class="koboSpan" id="kobo.1148.1"> endpoint URLs to your Stripe account to receive events. </span><span class="koboSpan" id="kobo.1148.2">Since we are using webhooks and we don’t have a hosted website accessible through a public URL, we </span><a id="_idIndexMarker870"/><span class="koboSpan" id="kobo.1149.1">will use the Stripe </span><strong class="keyWord"><span class="koboSpan" id="kobo.1150.1">Command-Line Interface</span></strong><span class="koboSpan" id="kobo.1151.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.1152.1">CLI</span></strong><span class="koboSpan" id="kobo.1153.1">) to listen to events and forward them to our local environment.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1154.1">Open </span><a href="https://dashboard.stripe.com/test/webhooks"><span class="url"><span class="koboSpan" id="kobo.1155.1">https://dashboard.stripe.com/test/webhooks</span></span></a><span class="koboSpan" id="kobo.1156.1"> in your browser. </span><span class="koboSpan" id="kobo.1156.2">You will see the following screen:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1157.1"><img alt="Graphical user interface, text, application, chat or text message  Description automatically generated" src="../Images/B21088_09_19.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1158.1">Figure 9.19: The Stripe webhooks default screen</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1159.1">Here, you can see a schema of </span><a id="_idIndexMarker871"/><span class="koboSpan" id="kobo.1160.1">how Stripe notifies your integration asynchronously. </span><span class="koboSpan" id="kobo.1160.2">You will get Stripe notifications in real time whenever an event happens. </span><span class="koboSpan" id="kobo.1160.3">Stripe sends different types of events, like checkout session created, payment intent created, payment intent updated, or checkout session completed. </span><span class="koboSpan" id="kobo.1160.4">You can find a list of all the types of events that Stripe sends at </span><a href="https://stripe.com/docs/api/events/types"><span class="url"><span class="koboSpan" id="kobo.1161.1">https://stripe.com/docs/api/events/types</span></span></a><span class="koboSpan" id="kobo.1162.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1163.1">Click on </span><strong class="screenText"><span class="koboSpan" id="kobo.1164.1">Test in a local environment</span></strong><span class="koboSpan" id="kobo.1165.1">. </span><span class="koboSpan" id="kobo.1165.2">You will see the following screen:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1166.1"><img alt="Graphical user interface, text, application  Description automatically generated" src="../Images/B21088_09_20.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1167.1">Figure 9.20: The Stripe webhook setup screen</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1168.1">This screen shows the steps to listen to Stripe events from your local environment. </span><span class="koboSpan" id="kobo.1168.2">It also includes a sample Python</span><a id="_idIndexMarker872"/><span class="koboSpan" id="kobo.1169.1"> webhook endpoint. </span><span class="koboSpan" id="kobo.1169.2">Copy just the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1170.1">endpoint_secret</span></code><span class="koboSpan" id="kobo.1171.1"> value.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1172.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1173.1">.env</span></code><span class="koboSpan" id="kobo.1174.1"> file of your project and add the following environment variable highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1175.1">STRIPE_PUBLISHABLE_KEY=pk_test_XXXX
STRIPE_SECRET_KEY=sk_test_XXXX
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1176.1">STRIPE_WEBHOOK_SECRET=whsec_XXXX</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1177.1">Replace the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1178.1">STRIPE_WEBHOOK_SECRET</span></code><span class="koboSpan" id="kobo.1179.1"> value with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1180.1">endpoint_secret</span></code><span class="koboSpan" id="kobo.1181.1"> value provided by Stripe.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1182.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1183.1">settings.py</span></code><span class="koboSpan" id="kobo.1184.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1185.1">myshop</span></code><span class="koboSpan" id="kobo.1186.1"> project and add the following setting to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1187.1"># ...</span></span><span class="koboSpan" id="kobo.1188.1">
STRIPE_PUBLISHABLE_KEY = config(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1189.1">'STRIPE_PUBLISHABLE_KEY'</span></span><span class="koboSpan" id="kobo.1190.1">)
STRIPE_SECERT_KEY = config(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1191.1">'STRIPE_SECRET_KEY'</span></span><span class="koboSpan" id="kobo.1192.1">)
STRIPE_API_VERSION = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1193.1">'2024-04-10'</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1194.1">STRIPE_WEBHOOK_SECRET = config(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1195.1">'STRIPE_WEBHOOK_SECRET'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1196.1">)</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1197.1">To build a webhook endpoint, we will create a view that receives a JSON payload with the event details. </span><span class="koboSpan" id="kobo.1197.2">We will check the event details to identify when a checkout session is completed and mark the related order as paid.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1198.1">Stripe signs the webhook events it sends to your endpoints by including a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1199.1">Stripe-Signature</span></code><span class="koboSpan" id="kobo.1200.1"> header, with a signature</span><a id="_idIndexMarker873"/><span class="koboSpan" id="kobo.1201.1"> in each event. </span><span class="koboSpan" id="kobo.1201.2">By checking the Stripe signature, you can verify that events were sent by Stripe and not by a third party. </span><span class="koboSpan" id="kobo.1201.3">If you don’t check the signature, an attacker could send fake events to your webhooks intentionally. </span><span class="koboSpan" id="kobo.1201.4">The Stripe SDK provides a method to verify signatures. </span><span class="koboSpan" id="kobo.1201.5">We will use it to create a webhook that verifies the signature.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1202.1">Add a new file to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1203.1">payment/</span></code><span class="koboSpan" id="kobo.1204.1"> application directory and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.1205.1">webhooks.py</span></code><span class="koboSpan" id="kobo.1206.1">. </span><span class="koboSpan" id="kobo.1206.2">Add the following code to the new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1207.1">webhooks.py</span></code><span class="koboSpan" id="kobo.1208.1"> file:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1209.1">import</span></span><span class="koboSpan" id="kobo.1210.1"> stripe
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1211.1">from</span></span><span class="koboSpan" id="kobo.1212.1"> django.conf </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1213.1">import</span></span><span class="koboSpan" id="kobo.1214.1"> settings
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1215.1">from</span></span><span class="koboSpan" id="kobo.1216.1"> django.http </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1217.1">import</span></span><span class="koboSpan" id="kobo.1218.1"> HttpResponse
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1219.1">from</span></span><span class="koboSpan" id="kobo.1220.1"> django.views.decorators.csrf </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1221.1">import</span></span><span class="koboSpan" id="kobo.1222.1"> csrf_exempt
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1223.1">from</span></span><span class="koboSpan" id="kobo.1224.1"> orders.models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1225.1">import</span></span><span class="koboSpan" id="kobo.1226.1"> Order
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.1227.1">@csrf_exempt</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1228.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1229.1">stripe_webhook</span></span><span class="koboSpan" id="kobo.1230.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1231.1">request</span></span><span class="koboSpan" id="kobo.1232.1">):
    payload = request.body
    sig_header = request.META[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1233.1">'HTTP_STRIPE_SIGNATURE'</span></span><span class="koboSpan" id="kobo.1234.1">]
    event = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1235.1">None</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1236.1">try</span></span><span class="koboSpan" id="kobo.1237.1">:
        event = stripe.Webhook.construct_event(
            payload, sig_header, settings.STRIPE_WEBHOOK_SECRET
        )
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1238.1">except</span></span><span class="koboSpan" id="kobo.1239.1"> ValueError </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1240.1">as</span></span><span class="koboSpan" id="kobo.1241.1"> e:
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1242.1"># Invalid payload</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1243.1">return</span></span><span class="koboSpan" id="kobo.1244.1"> HttpResponse(status=</span><span class="hljs-number"><span class="koboSpan" id="kobo.1245.1">400</span></span><span class="koboSpan" id="kobo.1246.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1247.1">except</span></span><span class="koboSpan" id="kobo.1248.1"> stripe.error.SignatureVerificationError </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1249.1">as</span></span><span class="koboSpan" id="kobo.1250.1"> e:
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1251.1"># Invalid signature</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1252.1">return</span></span><span class="koboSpan" id="kobo.1253.1"> HttpResponse(status=</span><span class="hljs-number"><span class="koboSpan" id="kobo.1254.1">400</span></span><span class="koboSpan" id="kobo.1255.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1256.1">return</span></span><span class="koboSpan" id="kobo.1257.1"> HttpResponse(status=</span><span class="hljs-number"><span class="koboSpan" id="kobo.1258.1">200</span></span><span class="koboSpan" id="kobo.1259.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1260.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1261.1">@csrf_exempt</span></code><span class="koboSpan" id="kobo.1262.1"> decorator is used to prevent Django from performing the </span><strong class="keyWord"><span class="koboSpan" id="kobo.1263.1">cross-site request forgery</span></strong><span class="koboSpan" id="kobo.1264.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.1265.1">CSRF</span></strong><span class="koboSpan" id="kobo.1266.1">) validation</span><a id="_idIndexMarker874"/><span class="koboSpan" id="kobo.1267.1"> that is done by default for all </span><code class="inlineCode"><span class="koboSpan" id="kobo.1268.1">POST</span></code><span class="koboSpan" id="kobo.1269.1"> requests. </span><span class="koboSpan" id="kobo.1269.2">We use the method </span><code class="inlineCode"><span class="koboSpan" id="kobo.1270.1">stripe.Webhook.construct_event()</span></code><span class="koboSpan" id="kobo.1271.1"> of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1272.1">stripe</span></code><span class="koboSpan" id="kobo.1273.1"> library to verify the event’s signature header. </span><span class="koboSpan" id="kobo.1273.2">If the event’s payload or the signature is invalid, we return an HTTP </span><code class="inlineCode"><span class="koboSpan" id="kobo.1274.1">400 Bad Request</span></code><span class="koboSpan" id="kobo.1275.1"> response. </span><span class="koboSpan" id="kobo.1275.2">Otherwise, we return an HTTP </span><code class="inlineCode"><span class="koboSpan" id="kobo.1276.1">200 OK</span></code><span class="koboSpan" id="kobo.1277.1"> response. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.1278.1">This is the basic functionality required to </span><a id="_idIndexMarker875"/><span class="koboSpan" id="kobo.1279.1">verify the signature and construct the event from the JSON payload. </span><span class="koboSpan" id="kobo.1279.2">Now, we can implement the actions of the webhook endpoint.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1280.1">Add the following code highlighted in bold to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1281.1">stripe_webhook</span></code><span class="koboSpan" id="kobo.1282.1"> view:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.1283.1">@csrf_exempt</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1284.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1285.1">stripe_webhook</span></span><span class="koboSpan" id="kobo.1286.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1287.1">request</span></span><span class="koboSpan" id="kobo.1288.1">):
    payload = request.body
    sig_header = request.META[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1289.1">'HTTP_STRIPE_SIGNATURE'</span></span><span class="koboSpan" id="kobo.1290.1">]
    event = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1291.1">None</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1292.1">try</span></span><span class="koboSpan" id="kobo.1293.1">:
        event = stripe.Webhook.construct_event(
            payload, sig_header, settings.STRIPE_WEBHOOK_SECRET
        )
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1294.1">except</span></span><span class="koboSpan" id="kobo.1295.1"> ValueError </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1296.1">as</span></span><span class="koboSpan" id="kobo.1297.1"> e:
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1298.1"># Invalid payload</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1299.1">return</span></span><span class="koboSpan" id="kobo.1300.1"> HttpResponse(status=</span><span class="hljs-number"><span class="koboSpan" id="kobo.1301.1">400</span></span><span class="koboSpan" id="kobo.1302.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1303.1">except</span></span><span class="koboSpan" id="kobo.1304.1"> stripe.error.SignatureVerificationError </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1305.1">as</span></span><span class="koboSpan" id="kobo.1306.1"> e:
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1307.1"># Invalid signature</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1308.1">return</span></span><span class="koboSpan" id="kobo.1309.1"> HttpResponse(status=</span><span class="hljs-number"><span class="koboSpan" id="kobo.1310.1">400</span></span><span class="koboSpan" id="kobo.1311.1">)
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1312.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1313.1"> event.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1314.1">type</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1315.1"> == </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1316.1">'checkout.session.completed'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1317.1">:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1318.1">        session = event.data.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1319.1">object</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1320.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1321.1"> (</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1322.1">            session.mode == </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1323.1">'payment'</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1324.1">and</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1325.1"> session.payment_status == </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1326.1">'paid'</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1327.1">        ):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1328.1">try</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1329.1">:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1330.1">                order = Order.objects.get(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1331.1">id</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1332.1">=session.client_reference_id</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1333.1">                )</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1334.1">except</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1335.1"> Order.DoesNotExist:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1336.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1337.1"> HttpResponse(status=</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.1338.1">404</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1339.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1340.1"># mark order as paid</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1341.1">            order.paid = </span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.1342.1">True</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1343.1">            order.save()</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1344.1">return</span></span><span class="koboSpan" id="kobo.1345.1"> HttpResponse(status=</span><span class="hljs-number"><span class="koboSpan" id="kobo.1346.1">200</span></span><span class="koboSpan" id="kobo.1347.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1348.1">In the new code, we check whether the event received is </span><code class="inlineCode"><span class="koboSpan" id="kobo.1349.1">checkout.session.completed</span></code><span class="koboSpan" id="kobo.1350.1">. </span><span class="koboSpan" id="kobo.1350.2">This event indicates that the checkout session has been successfully completed. </span><span class="koboSpan" id="kobo.1350.3">If we receive this event, we retrieve the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1351.1">session</span></code><span class="koboSpan" id="kobo.1352.1"> object and check whether the session </span><code class="inlineCode"><span class="koboSpan" id="kobo.1353.1">mode</span></code><span class="koboSpan" id="kobo.1354.1"> is </span><code class="inlineCode"><span class="koboSpan" id="kobo.1355.1">payment</span></code><span class="koboSpan" id="kobo.1356.1"> because this is the expected mode for one-off payments. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.1357.1">Then, we get the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1358.1">client_reference_id</span></code><span class="koboSpan" id="kobo.1359.1"> attribute that</span><a id="_idIndexMarker876"/><span class="koboSpan" id="kobo.1360.1"> we used when we created the checkout session and use the Django ORM to retrieve the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1361.1">Order</span></code><span class="koboSpan" id="kobo.1362.1"> object with the given </span><code class="inlineCode"><span class="koboSpan" id="kobo.1363.1">id</span></code><span class="koboSpan" id="kobo.1364.1">. </span><span class="koboSpan" id="kobo.1364.2">If the order does not exist, we raise an HTTP </span><code class="inlineCode"><span class="koboSpan" id="kobo.1365.1">404</span></code><span class="koboSpan" id="kobo.1366.1"> exception. </span><span class="koboSpan" id="kobo.1366.2">Otherwise, we mark the order as paid with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1367.1">order.paid = True</span></code><span class="koboSpan" id="kobo.1368.1">, and we save the order in the database.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1369.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1370.1">urls.py</span></code><span class="koboSpan" id="kobo.1371.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1372.1">payment</span></code><span class="koboSpan" id="kobo.1373.1"> application and add the following code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1374.1">from</span></span><span class="koboSpan" id="kobo.1375.1"> django.urls </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1376.1">import</span></span><span class="koboSpan" id="kobo.1377.1"> path
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1378.1">from</span></span><span class="koboSpan" id="kobo.1379.1"> . </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1380.1">import</span></span><span class="koboSpan" id="kobo.1381.1"> views</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1382.1">, webhooks</span></strong></span><span class="koboSpan" id="kobo.1383.1">
app_name = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1384.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1385.1">payment'</span></span><span class="koboSpan" id="kobo.1386.1">
urlpatterns = [
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1387.1">'process/'</span></span><span class="koboSpan" id="kobo.1388.1">, views.payment_process, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1389.1">'process'</span></span><span class="koboSpan" id="kobo.1390.1">),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1391.1">'completed/'</span></span><span class="koboSpan" id="kobo.1392.1">, views.payment_completed, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1393.1">'completed'</span></span><span class="koboSpan" id="kobo.1394.1">),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1395.1">'canceled/'</span></span><span class="koboSpan" id="kobo.1396.1">, views.payment_canceled, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1397.1">'canceled'</span></span><span class="koboSpan" id="kobo.1398.1">),
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1399.1">    path(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1400.1">'webhook/'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1401.1">, webhooks.stripe_webhook, name=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1402.1">'stripe-webhook'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1403.1">),</span></strong></span><span class="koboSpan" id="kobo.1404.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1405.1">We have imported the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1406.1">webhooks</span></code><span class="koboSpan" id="kobo.1407.1"> module and added the URL pattern for the Stripe webhook.</span></p>
<h3 class="heading-3" id="_idParaDest-270"><span class="koboSpan" id="kobo.1408.1">Testing webhook notifications</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.1409.1">To test webhooks, you </span><a id="_idIndexMarker877"/><span class="koboSpan" id="kobo.1410.1">need to install the Stripe CLI. </span><span class="koboSpan" id="kobo.1410.2">The Stripe CLI is a developer tool that allows you to test and manage your integration with Stripe directly from your shell. </span><span class="koboSpan" id="kobo.1410.3">You will find installation instructions at </span><a href="https://stripe.com/docs/stripe-cli#install"><span class="url"><span class="koboSpan" id="kobo.1411.1">https://stripe.com/docs/stripe-cli#install</span></span></a><span class="koboSpan" id="kobo.1412.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1413.1">If you are using macOS or Linux, you can install the Stripe CLI with Homebrew using the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1414.1">brew install stripe/stripe-cli/stripe
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1415.1">If you are using Windows, or you are using macOS or Linux without Homebrew, download the latest Stripe CLI release for macOS, Linux, or Windows from </span><a href="https://github.com/stripe/stripe-cli/releases/latest"><span class="url"><span class="koboSpan" id="kobo.1416.1">https://github.com/stripe/stripe-cli/releases/latest</span></span></a><span class="koboSpan" id="kobo.1417.1"> and unzip the file. </span><span class="koboSpan" id="kobo.1417.2">If you are using Windows, run the unzipped </span><code class="inlineCode"><span class="koboSpan" id="kobo.1418.1">.exe</span></code><span class="koboSpan" id="kobo.1419.1"> file.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1420.1">After installing the Stripe CLI, run</span><a id="_idIndexMarker878"/><span class="koboSpan" id="kobo.1421.1"> the following command from a shell:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1422.1">stripe login
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1423.1">You will see the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1424.1">Your pairing code is: xxxx-yyyy-zzzz-oooo This pairing code verifies your authentication with Stripe.Press Enter to open the browser or visit https://dashboard.stripe.com/stripecli/confirm_auth?t=....
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1425.1">Press </span><em class="italic"><span class="koboSpan" id="kobo.1426.1">Enter</span></em><span class="koboSpan" id="kobo.1427.1"> or open the URL in your browser. </span><span class="koboSpan" id="kobo.1427.2">You will see the following screen:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1428.1"><img alt="Graphical user interface, text, application  Description automatically generated" src="../Images/B21088_09_21.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1429.1">Figure 9.21: The Stripe CLI pairing screen</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1430.1">Verify that the pairing code</span><a id="_idIndexMarker879"/><span class="koboSpan" id="kobo.1431.1"> in the Stripe CLI matches the one shown on the website and click on </span><strong class="screenText"><span class="koboSpan" id="kobo.1432.1">Allow access</span></strong><span class="koboSpan" id="kobo.1433.1">. </span><span class="koboSpan" id="kobo.1433.2">You will see the following message:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1434.1"><img alt="Graphical user interface, application, Teams  Description automatically generated" src="../Images/B21088_09_22.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1435.1">Figure 9.22: The Stripe CLI pairing confirmation</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1436.1">Now, run the following command from your shell:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1437.1">stripe listen --forward-to 127.0.0.1:8000/payment/webhook/
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1438.1">We use this command to tell Stripe to listen to events and forward them to our localhost. </span><span class="koboSpan" id="kobo.1438.2">We use port </span><code class="inlineCode"><span class="koboSpan" id="kobo.1439.1">8000</span></code><span class="koboSpan" id="kobo.1440.1">, where the</span><a id="_idIndexMarker880"/><span class="koboSpan" id="kobo.1441.1"> Django development server is running, and the path </span><code class="inlineCode"><span class="koboSpan" id="kobo.1442.1">/payment/webhook/</span></code><span class="koboSpan" id="kobo.1443.1">, which matches the URL pattern of our webhook.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1444.1">You will see the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1445.1">Getting ready... </span><span class="koboSpan" id="kobo.1445.2">&gt; Ready! </span><span class="koboSpan" id="kobo.1445.3">You are using Stripe API Version [2024-04-10]. </span><span class="koboSpan" id="kobo.1445.4">Your webhook signing secret is xxxxxxxxxxxxxxxxxxx (^C to quit)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1446.1">Here, you can see the webhook secret. </span><span class="koboSpan" id="kobo.1446.2">Check that the webhook signing secret matches the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1447.1">STRIPE_WEBHOOK_SECRET</span></code><span class="koboSpan" id="kobo.1448.1"> setting in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1449.1">settings.py</span></code><span class="koboSpan" id="kobo.1450.1"> file of your project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1451.1">Open </span><a href="https://dashboard.stripe.com/test/webhooks"><span class="url"><span class="koboSpan" id="kobo.1452.1">https://dashboard.stripe.com/test/webhooks</span></span></a><span class="koboSpan" id="kobo.1453.1"> in your browser. </span><span class="koboSpan" id="kobo.1453.2">You will see the following screen:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1454.1"><img alt="" role="presentation" src="../Images/B21088_09_23.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1455.1">Figure 9.23: The Stripe Webhooks page</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1456.1">Under </span><strong class="screenText"><span class="koboSpan" id="kobo.1457.1">Local listeners</span></strong><span class="koboSpan" id="kobo.1458.1">, you will see the local listener that we created.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.1459.1">In a production environment, the Stripe CLI is not needed. </span><span class="koboSpan" id="kobo.1459.2">Instead, you would need to add a hosted webhook endpoint using the URL of your hosted application.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.1460.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.1461.1">http://127.0.0.1:8000/</span></code><span class="koboSpan" id="kobo.1462.1"> in your </span><a id="_idIndexMarker881"/><span class="koboSpan" id="kobo.1463.1">browser, add some products to the shopping cart, and complete the checkout process.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1464.1">Check the shell where you are running the Stripe CLI:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1465.1">2024-01-03 18:06:13   --&gt; </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1466.1">payment_intent.created</span></strong></span><span class="koboSpan" id="kobo.1467.1"> [evt_...]
2024-01-03 18:06:13  &lt;--  [200] POST http://127.0.0.1:8000/payment/webhook/ [evt_...]
2024-01-03 18:06:13   --&gt; </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1468.1">payment_intent.succeeded</span></strong></span><span class="koboSpan" id="kobo.1469.1"> [evt_...]
2024-01-03 18:06:13  &lt;--  [200] POST http://127.0.0.1:8000/payment/webhook/ [evt_...]
2024-01-03 18:06:13   --&gt; </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1470.1">charge.succeeded</span></strong></span><span class="koboSpan" id="kobo.1471.1"> [evt_...]
2024-01-03 18:06:13  &lt;--  [200] POST http://127.0.0.1:8000/payment/webhook/ [evt_...]
2024-01-03 18:06:14   --&gt; </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1472.1">checkout.session.completed</span></strong></span><span class="koboSpan" id="kobo.1473.1"> [evt_...]
2024-01-03 18:06:14  &lt;--  [200] POST http://127.0.0.1:8000/payment/webhook/ [evt_...]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1474.1">You can see the different events that have been sent by Stripe to the local webhook endpoint. </span><span class="koboSpan" id="kobo.1474.2">The events might be in a different order than above. </span><span class="koboSpan" id="kobo.1474.3">Stripe doesn’t guarantee the delivery of events in the order in which they are generated. </span><span class="koboSpan" id="kobo.1474.4">Let’s review the events:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1475.1">payment_intent.created</span></code><span class="koboSpan" id="kobo.1476.1">: The payment intent has been created.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1477.1">payment_intent.succeeded</span></code><span class="koboSpan" id="kobo.1478.1">: The payment intent succeeded.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1479.1">charge.succeeded</span></code><span class="koboSpan" id="kobo.1480.1">: The charge associated with the payment intent succeeded.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1481.1">checkout.session.completed</span></code><span class="koboSpan" id="kobo.1482.1">: The checkout session has been completed. </span><span class="koboSpan" id="kobo.1482.2">This is the event that we use to mark the order as paid.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1483.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1484.1">stripe_webhook</span></code><span class="koboSpan" id="kobo.1485.1"> webhook returns an HTTP </span><code class="inlineCode"><span class="koboSpan" id="kobo.1486.1">200 OK</span></code><span class="koboSpan" id="kobo.1487.1"> response to all of the requests sent by Stripe. </span><span class="koboSpan" id="kobo.1487.2">However, we</span><a id="_idIndexMarker882"/><span class="koboSpan" id="kobo.1488.1"> only process the event </span><code class="inlineCode"><span class="koboSpan" id="kobo.1489.1">checkout.session.completed</span></code><span class="koboSpan" id="kobo.1490.1"> to mark the order related to the payment as paid.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1491.1">Next, open </span><code class="inlineCode"><span class="koboSpan" id="kobo.1492.1">http://127.0.0.1:8000/admin/orders/order/</span></code><span class="koboSpan" id="kobo.1493.1"> in your browser. </span><span class="koboSpan" id="kobo.1493.2">The order should now be marked as paid:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1494.1"><img alt="" role="presentation" src="../Images/B21088_09_24.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1495.1">Figure 9.24: An order marked as paid in the order list of the administration site</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1496.1">Now, orders get automatically marked as paid with Stripe payment notifications. </span><span class="koboSpan" id="kobo.1496.2">Next, you are going to learn how to reference Stripe payments in your shop orders.</span></p>
<h2 class="heading-2" id="_idParaDest-271"><span class="koboSpan" id="kobo.1497.1">Referencing Stripe payments in orders</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1498.1">Each Stripe payment has a </span><a id="_idIndexMarker883"/><span class="koboSpan" id="kobo.1499.1">unique identifier. </span><span class="koboSpan" id="kobo.1499.2">We can use the payment ID to associate each order with its corresponding Stripe payment. </span><span class="koboSpan" id="kobo.1499.3">We will add a new field to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1500.1">Order</span></code><span class="koboSpan" id="kobo.1501.1"> model of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1502.1">orders</span></code><span class="koboSpan" id="kobo.1503.1"> application so that we can reference the related payment by its ID. </span><span class="koboSpan" id="kobo.1503.2">This will allow us to link each order with the related Stripe transaction.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1504.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1505.1">models.py</span></code><span class="koboSpan" id="kobo.1506.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1507.1">orders</span></code><span class="koboSpan" id="kobo.1508.1"> application and add the following field to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1509.1">Order</span></code><span class="koboSpan" id="kobo.1510.1"> model. </span><span class="koboSpan" id="kobo.1510.2">The new field is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1511.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1512.1">Order</span></span><span class="koboSpan" id="kobo.1513.1">(models.Model):
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1514.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1515.1">    stripe_id = models.CharField(max_length=</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.1516.1">250</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1517.1">, blank=</span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.1518.1">True</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1519.1">)</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1520.1">Let’s sync this field with the database. </span><span class="koboSpan" id="kobo.1520.2">Use the following command to generate the database migrations for the project:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1521.1">python manage.py makemigrations
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1522.1">You will see the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1523.1">Migrations for 'orders':
  orders/migrations/0002_order_stripe_id.py
    - Add field stripe_id to order
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1524.1">Apply the migration to the database with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1525.1">python manage.py migrate
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1526.1">You will see output that ends with the following line:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1527.1">Applying orders.0002_order_stripe_id... </span><span class="koboSpan" id="kobo.1527.2">OK
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1528.1">The model changes are now</span><a id="_idIndexMarker884"/><span class="koboSpan" id="kobo.1529.1"> synced with the database. </span><span class="koboSpan" id="kobo.1529.2">Now, you will be able to store the Stripe payment ID for each order.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1530.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1531.1">stripe_webhook</span></code><span class="koboSpan" id="kobo.1532.1"> function in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1533.1">webhooks.py</span></code><span class="koboSpan" id="kobo.1534.1"> file of the payment application and add the following lines highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1535.1"># ...</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.1536.1">@csrf_exempt</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1537.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1538.1">stripe_webhook</span></span><span class="koboSpan" id="kobo.1539.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1540.1">request</span></span><span class="koboSpan" id="kobo.1541.1">):
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1542.1"># ...</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1543.1">if</span></span><span class="koboSpan" id="kobo.1544.1"> event.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1545.1">type</span></span><span class="koboSpan" id="kobo.1546.1"> == </span><span class="hljs-string"><span class="koboSpan" id="kobo.1547.1">'checkout.session.completed'</span></span><span class="koboSpan" id="kobo.1548.1">:
        session = event.data.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1549.1">object</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1550.1">if</span></span><span class="koboSpan" id="kobo.1551.1"> (
            session.mode == </span><span class="hljs-string"><span class="koboSpan" id="kobo.1552.1">'payment'</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1553.1">and</span></span><span class="koboSpan" id="kobo.1554.1"> session.payment_status == </span><span class="hljs-string"><span class="koboSpan" id="kobo.1555.1">'paid'</span></span><span class="koboSpan" id="kobo.1556.1">
        ):
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1557.1">try</span></span><span class="koboSpan" id="kobo.1558.1">:
                order = Order.objects.get(
                    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1559.1">id</span></span><span class="koboSpan" id="kobo.1560.1">=session.client_reference_id
                )
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1561.1">except</span></span><span class="koboSpan" id="kobo.1562.1"> Order.DoesNotExist:
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1563.1">return</span></span><span class="koboSpan" id="kobo.1564.1"> HttpResponse(status=</span><span class="hljs-number"><span class="koboSpan" id="kobo.1565.1">404</span></span><span class="koboSpan" id="kobo.1566.1">)
            </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1567.1"># mark order as paid</span></span><span class="koboSpan" id="kobo.1568.1">
            order.paid = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1569.1">True</span></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1570.1"># store Stripe payment ID</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1571.1">            order.stripe_id = session.payment_intent</span></strong></span><span class="koboSpan" id="kobo.1572.1">
            order.save()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1573.1">return</span></span><span class="koboSpan" id="kobo.1574.1"> HttpResponse(status=</span><span class="hljs-number"><span class="koboSpan" id="kobo.1575.1">200</span></span><span class="koboSpan" id="kobo.1576.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1577.1">With this change, when receiving a webhook notification for a completed checkout session, the payment intent ID is stored in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1578.1">stripe_id</span></code><span class="koboSpan" id="kobo.1579.1"> field of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1580.1">Order</span></code><span class="koboSpan" id="kobo.1581.1"> object.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1582.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.1583.1">http://127.0.0.1:8000/</span></code><span class="koboSpan" id="kobo.1584.1"> in your browser, add some products to the shopping cart, and complete the checkout process. </span><span class="koboSpan" id="kobo.1584.2">Then, access </span><code class="inlineCode"><span class="koboSpan" id="kobo.1585.1">http://127.0.0.1:8000/admin/orders/order/</span></code><span class="koboSpan" id="kobo.1586.1"> in your browser and click on the latest order ID to edit it. </span><span class="koboSpan" id="kobo.1586.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1587.1">stripe_id</span></code><span class="koboSpan" id="kobo.1588.1"> field should contain the payment intent ID, as shown in </span><em class="italic"><span class="koboSpan" id="kobo.1589.1">Figure 9.25</span></em><span class="koboSpan" id="kobo.1590.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1591.1"><img alt="" role="presentation" src="../Images/B21088_09_25.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1592.1">Figure 9.25: The Stripe id field with the payment intent ID</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1593.1">Great! </span><span class="koboSpan" id="kobo.1593.2">We have successfully referenced</span><a id="_idIndexMarker885"/><span class="koboSpan" id="kobo.1594.1"> Stripe payments in orders. </span><span class="koboSpan" id="kobo.1594.2">Now, we can add Stripe payment IDs to the order list on the administration site. </span><span class="koboSpan" id="kobo.1594.3">We can also include a link to each payment ID to see the payment details in the Stripe dashboard.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1595.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1596.1">models.py</span></code><span class="koboSpan" id="kobo.1597.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1598.1">orders</span></code><span class="koboSpan" id="kobo.1599.1"> application and add the following code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1600.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1601.1"> django.conf </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1602.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1603.1"> settings</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1604.1">from</span></span><span class="koboSpan" id="kobo.1605.1"> django.db </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1606.1">import</span></span><span class="koboSpan" id="kobo.1607.1"> models
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1608.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1609.1">Order</span></span><span class="koboSpan" id="kobo.1610.1">(models.Model):
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1611.1"># ...</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1612.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1613.1">Meta</span></span><span class="koboSpan" id="kobo.1614.1">:
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1615.1"># ...</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1616.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1617.1">__str__</span></span><span class="koboSpan" id="kobo.1618.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1619.1">self</span></span><span class="koboSpan" id="kobo.1620.1">):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1621.1">return</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1622.1">f'Order </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1623.1">{self.</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1624.1">id</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1625.1">}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1626.1">'</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1627.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1628.1">get_total_cost</span></span><span class="koboSpan" id="kobo.1629.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1630.1">self</span></span><span class="koboSpan" id="kobo.1631.1">):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1632.1">return</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1633.1">sum</span></span><span class="koboSpan" id="kobo.1634.1">(item.get_cost() </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1635.1">for</span></span><span class="koboSpan" id="kobo.1636.1"> item </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1637.1">in</span></span><span class="koboSpan" id="kobo.1638.1"> self.items.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1639.1">all</span></span><span class="koboSpan" id="kobo.1640.1">())
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1641.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1642.1">get_stripe_url</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1643.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1644.1">self</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1645.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1646.1">if</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1647.1">not</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1648.1"> self.stripe_id:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1649.1"># no payment associated</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1650.1">return</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1651.1">''</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1652.1">if</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1653.1">'_test_'</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1654.1">in</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1655.1"> settings.STRIPE_SECRET_KEY:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1656.1"># Stripe path for test payments</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1657.1">            path = </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1658.1">'/test/'</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1659.1">else</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1660.1">:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1661.1"># Stripe path for real payments</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1662.1">            path = </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1663.1">'</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1664.1">/'</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1665.1">return</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1666.1">f'https://dashboard.stripe.com</span></strong><strong class="hljs-subst-slc"><span class="koboSpan" id="kobo.1667.1">{path}</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1668.1">payments/</span></strong><strong class="hljs-subst-slc"><span class="koboSpan" id="kobo.1669.1">{self.stripe_id}</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1670.1">'</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1671.1">We have added the new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1672.1">get_stripe_url()</span></code><span class="koboSpan" id="kobo.1673.1"> method to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1674.1">Order</span></code><span class="koboSpan" id="kobo.1675.1"> model. </span><span class="koboSpan" id="kobo.1675.2">This method is used to return the Stripe dashboard’s URL for the payment associated with the order. </span><span class="koboSpan" id="kobo.1675.3">If no payment ID is stored in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1676.1">stripe_id</span></code><span class="koboSpan" id="kobo.1677.1"> field of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1678.1">Order</span></code><span class="koboSpan" id="kobo.1679.1"> object, an empty string is returned. </span><span class="koboSpan" id="kobo.1679.2">Otherwise, the URL for the payment in the Stripe dashboard is returned. </span><span class="koboSpan" id="kobo.1679.3">We check if the string </span><code class="inlineCode"><span class="koboSpan" id="kobo.1680.1">_test_</span></code><span class="koboSpan" id="kobo.1681.1"> is present in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1682.1">STRIPE_SECRET_KEY</span></code><span class="koboSpan" id="kobo.1683.1"> setting to discriminate the production environment </span><a id="_idIndexMarker886"/><span class="koboSpan" id="kobo.1684.1">from the test environment. </span><span class="koboSpan" id="kobo.1684.2">Payments in the production environment follow the pattern </span><code class="inlineCode"><span class="koboSpan" id="kobo.1685.1">https://dashboard.stripe.com/payments/{id}</span></code><span class="koboSpan" id="kobo.1686.1">, whereas test payments follow the pattern </span><code class="inlineCode"><span class="koboSpan" id="kobo.1687.1">https://dashboard.stripe.com/payments/test/{id}</span></code><span class="koboSpan" id="kobo.1688.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1689.1">Let’s add a link to each </span><code class="inlineCode"><span class="koboSpan" id="kobo.1690.1">Order</span></code><span class="koboSpan" id="kobo.1691.1"> object on the list display page of the administration site.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1692.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1693.1">admin.py</span></code><span class="koboSpan" id="kobo.1694.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1695.1">orders</span></code><span class="koboSpan" id="kobo.1696.1"> application and add the following code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1697.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1698.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1699.1"> django.utils.safestring </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1700.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1701.1"> mark_safe</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1702.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1703.1">order_payment</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1704.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1705.1">obj</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1706.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1707.1">    url = obj.get_stripe_url()</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1708.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1709.1"> obj.stripe_id:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1710.1">        html = </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1711.1">f'&lt;a href="</span></strong><strong class="hljs-subst-slc"><span class="koboSpan" id="kobo.1712.1">{url}</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1713.1">" target="_blank"&gt;</span></strong><strong class="hljs-subst-slc"><span class="koboSpan" id="kobo.1714.1">{obj.stripe_id}</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1715.1">&lt;/a&gt;'</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1716.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1717.1"> mark_safe(html)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1718.1">return</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1719.1">''</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1720.1">order_payment.short_description = </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1721.1">'Stripe payment'</span></strong></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.1722.1">@admin.register(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1723.1">Order</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.1724.1">)</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1725.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1726.1">OrderAdmin</span></span><span class="koboSpan" id="kobo.1727.1">(admin.ModelAdmin):
    list_display = [
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1728.1">'id'</span></span><span class="koboSpan" id="kobo.1729.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1730.1">'first_name'</span></span><span class="koboSpan" id="kobo.1731.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1732.1">'last_name'</span></span><span class="koboSpan" id="kobo.1733.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1734.1">'email'</span></span><span class="koboSpan" id="kobo.1735.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1736.1">'address'</span></span><span class="koboSpan" id="kobo.1737.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1738.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1739.1">postal_code'</span></span><span class="koboSpan" id="kobo.1740.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1741.1">'city'</span></span><span class="koboSpan" id="kobo.1742.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1743.1">'paid'</span></span><span class="koboSpan" id="kobo.1744.1">,
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1745.1">        order_payment,</span></strong></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1746.1">'created'</span></span><span class="koboSpan" id="kobo.1747.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1748.1">'updated'</span></span><span class="koboSpan" id="kobo.1749.1">
    ]
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1750.1"># ...</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1751.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1752.1">order_stripe_payment()</span></code><span class="koboSpan" id="kobo.1753.1"> function takes an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1754.1">Order</span></code><span class="koboSpan" id="kobo.1755.1"> object as an argument and returns an HTML link with the payment</span><a id="_idIndexMarker887"/><span class="koboSpan" id="kobo.1756.1"> URL in Stripe. </span><span class="koboSpan" id="kobo.1756.2">Django escapes HTML output by default. </span><span class="koboSpan" id="kobo.1756.3">We use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1757.1">mark_safe</span></code><span class="koboSpan" id="kobo.1758.1"> function to avoid auto-escaping.</span></p>
<div class="packt_tip">
<p class="normal"><span class="koboSpan" id="kobo.1759.1">Avoid using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1760.1">mark_safe</span></code><span class="koboSpan" id="kobo.1761.1"> on input that has come from the user to avoid </span><strong class="keyWord"><span class="koboSpan" id="kobo.1762.1">Cross-Site Scripting</span></strong><span class="koboSpan" id="kobo.1763.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.1764.1">XSS</span></strong><span class="koboSpan" id="kobo.1765.1">). </span><span class="koboSpan" id="kobo.1765.2">XSS enables attackers to inject client-side scripts into web content viewed by other users.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.1766.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.1767.1">http://127.0.0.1:8000/admin/orders/order/</span></code><span class="koboSpan" id="kobo.1768.1"> in your browser. </span><span class="koboSpan" id="kobo.1768.2">You will see a new column named </span><strong class="screenText"><span class="koboSpan" id="kobo.1769.1">STRIPE PAYMENT</span></strong><span class="koboSpan" id="kobo.1770.1">. </span><span class="koboSpan" id="kobo.1770.2">You will see the related Stripe payment ID for the latest order. </span><span class="koboSpan" id="kobo.1770.3">If you click on the payment ID, you will be taken to the payment URL in Stripe, where you can find the additional payment details.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1771.1"><img alt="" role="presentation" src="../Images/B21088_09_26.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1772.1">Figure 9.26: The Stripe payment ID for an Order object in the administration site</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1773.1">Now, you automatically store</span><a id="_idIndexMarker888"/><span class="koboSpan" id="kobo.1774.1"> Stripe payment IDs in orders when receiving payment notifications. </span><span class="koboSpan" id="kobo.1774.2">You have successfully integrated Stripe into your project.</span></p>
<h2 class="heading-2" id="_idParaDest-272"><span class="koboSpan" id="kobo.1775.1">Going live</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1776.1">Once you have tested </span><a id="_idIndexMarker889"/><span class="koboSpan" id="kobo.1777.1">your integration, you can apply for a production Stripe account. </span><span class="koboSpan" id="kobo.1777.2">When you are ready to move into production, remember to replace your test Stripe credentials with the live ones in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1778.1">settings.py</span></code><span class="koboSpan" id="kobo.1779.1"> file. </span><span class="koboSpan" id="kobo.1779.2">You will also need to add a webhook endpoint for your hosted website at </span><a href="https://dashboard.stripe.com/webhooks"><span class="url"><span class="koboSpan" id="kobo.1780.1">https://dashboard.stripe.com/webhooks</span></span></a><span class="koboSpan" id="kobo.1781.1"> instead of using the Stripe CLI. </span><em class="chapterRef"><span class="koboSpan" id="kobo.1782.1">Chapter 17</span></em><span class="koboSpan" id="kobo.1783.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1784.1">Going Live</span></em><span class="koboSpan" id="kobo.1785.1">, will teach you how to configure project settings for multiple environments.</span></p>
<h1 class="heading-1" id="_idParaDest-273"><span class="koboSpan" id="kobo.1786.1">Exporting orders to CSV files</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1787.1">Sometimes, you might want to export the information contained in a model to a file so that you can import it into another system. </span><span class="koboSpan" id="kobo.1787.2">One of the most widely used formats to export/import data is the </span><strong class="keyWord"><span class="koboSpan" id="kobo.1788.1">Comma-Separated Values</span></strong><span class="koboSpan" id="kobo.1789.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.1790.1">CSV</span></strong><span class="koboSpan" id="kobo.1791.1">) format. </span><span class="koboSpan" id="kobo.1791.2">A CSV file is a plain text file consisting of a number of </span><a id="_idIndexMarker890"/><span class="koboSpan" id="kobo.1792.1">records. </span><span class="koboSpan" id="kobo.1792.2">There is usually one record per line and some delimiter character, usually a literal comma, separating the record fields. </span><span class="koboSpan" id="kobo.1792.3">We are going to customize the administration site to be able to export orders to CSV files.</span></p>
<h2 class="heading-2" id="_idParaDest-274"><span class="koboSpan" id="kobo.1793.1">Adding custom actions to the administration site</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1794.1">Django offers a wide range of options </span><a id="_idIndexMarker891"/><span class="koboSpan" id="kobo.1795.1">to customize the administration site. </span><span class="koboSpan" id="kobo.1795.2">You are going to modify the object list view to include a custom</span><a id="_idIndexMarker892"/><span class="koboSpan" id="kobo.1796.1"> administration action. </span><span class="koboSpan" id="kobo.1796.2">You can implement custom administration actions to allow staff users to apply actions to multiple elements at once in the change list view.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1797.1">An administration action works as follows: a user selects objects from the administration object list page with checkboxes, selects an action to perform on all of the selected items, and then executes the actions. </span><em class="italic"><span class="koboSpan" id="kobo.1798.1">Figure 9.27</span></em><span class="koboSpan" id="kobo.1799.1"> shows where the actions are located on the administration site:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1800.1"><img alt="Graphical user interface, text, application, chat or text message  Description automatically generated" src="../Images/B21088_09_27.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1801.1">Figure 9.27: The drop-down menu for Django administration actions</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1802.1">You can create a custom action </span><a id="_idIndexMarker893"/><span class="koboSpan" id="kobo.1803.1">by writing a regular function that</span><a id="_idIndexMarker894"/><a id="_idIndexMarker895"/><span class="koboSpan" id="kobo.1804.1"> receives the following parameters:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.1805.1">The current </span><code class="inlineCode"><span class="koboSpan" id="kobo.1806.1">ModelAdmin</span></code><span class="koboSpan" id="kobo.1807.1"> being displayed</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1808.1">The current request object as an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1809.1">HttpRequest</span></code><span class="koboSpan" id="kobo.1810.1"> instance</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1811.1">A QuerySet for the objects selected by the user</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1812.1">This function will be executed when the action is triggered from the administration site.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1813.1">You are going to create a custom administration action to download a list of orders as a CSV file.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1814.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1815.1">admin.py</span></code><span class="koboSpan" id="kobo.1816.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1817.1">orders</span></code><span class="koboSpan" id="kobo.1818.1"> application and add the following code before the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1819.1">OrderAdmin</span></code><span class="koboSpan" id="kobo.1820.1"> class:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1821.1">import</span></span><span class="koboSpan" id="kobo.1822.1"> csv
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1823.1">import</span></span><span class="koboSpan" id="kobo.1824.1"> datetime
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1825.1">from</span></span><span class="koboSpan" id="kobo.1826.1"> django.http </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1827.1">import</span></span><span class="koboSpan" id="kobo.1828.1"> HttpResponse
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1829.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1830.1">export_to_csv</span></span><span class="koboSpan" id="kobo.1831.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1832.1">modeladmin, request, queryset</span></span><span class="koboSpan" id="kobo.1833.1">):
    opts = modeladmin.model._meta
    content_disposition = (
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1834.1">f'attachment; filename=</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1835.1">{opts.verbose_name}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1836.1">.csv'</span></span>
<span class="hljs-string"> </span><span class="koboSpan" id="kobo.1837.1">)
    response = HttpResponse(content_type=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1838.1">'text/csv'</span></span><span class="koboSpan" id="kobo.1839.1">)
    response[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1840.1">'Content-Disposition'</span></span><span class="koboSpan" id="kobo.1841.1">] = content_disposition
    writer = csv.writer(response)
    fields = [
        field
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1842.1">for</span></span><span class="koboSpan" id="kobo.1843.1"> field </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1844.1">in</span></span><span class="koboSpan" id="kobo.1845.1"> opts.get_fields()
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1846.1">if</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1847.1">not</span></span><span class="koboSpan" id="kobo.1848.1"> field.many_to_many </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1849.1">and</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1850.1">not</span></span><span class="koboSpan" id="kobo.1851.1"> field.one_to_many
    ]
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1852.1"># Write a first row with header information</span></span><span class="koboSpan" id="kobo.1853.1">
    writer.writerow([field.verbose_name </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1854.1">for</span></span><span class="koboSpan" id="kobo.1855.1"> field </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1856.1">in</span></span><span class="koboSpan" id="kobo.1857.1"> fields])
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1858.1"># Write data rows</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1859.1">for</span></span><span class="koboSpan" id="kobo.1860.1"> obj </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1861.1">in</span></span><span class="koboSpan" id="kobo.1862.1"> queryset:
        data_row = []
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1863.1">for</span></span><span class="koboSpan" id="kobo.1864.1"> field </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1865.1">in</span></span><span class="koboSpan" id="kobo.1866.1"> fields:
            value = </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1867.1">getattr</span></span><span class="koboSpan" id="kobo.1868.1">(obj, field.name)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1869.1">if</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1870.1">isinstance</span></span><span class="koboSpan" id="kobo.1871.1">(value, datetime.datetime):
                value = value.strftime(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1872.1">'%d/%m/%Y'</span></span><span class="koboSpan" id="kobo.1873.1">)
            data_row.append(value)
        writer.writerow(data_row)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1874.1">return</span></span><span class="koboSpan" id="kobo.1875.1"> response
export_to_csv.short_description = 'Export to CSV'
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1876.1">In this code, you</span><a id="_idIndexMarker896"/><span class="koboSpan" id="kobo.1877.1"> perform the following tasks:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1878.1">You create an instance of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1879.1">HttpResponse</span></code><span class="koboSpan" id="kobo.1880.1">, specifying the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1881.1">text/csv</span></code><span class="koboSpan" id="kobo.1882.1"> content type, to tell the browser that the</span><a id="_idIndexMarker897"/><span class="koboSpan" id="kobo.1883.1"> response has to be treated as a CSV file. </span><span class="koboSpan" id="kobo.1883.2">You also add a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1884.1">Content-Disposition</span></code><span class="koboSpan" id="kobo.1885.1"> header to indicate that the HTTP response contains an attached file.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1886.1">You create a CSV </span><code class="inlineCode"><span class="koboSpan" id="kobo.1887.1">writer</span></code><span class="koboSpan" id="kobo.1888.1"> object that will write to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1889.1">response</span></code><span class="koboSpan" id="kobo.1890.1"> object.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1891.1">You get the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1892.1">model</span></code><span class="koboSpan" id="kobo.1893.1"> fields dynamically using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1894.1">get_fields()</span></code><span class="koboSpan" id="kobo.1895.1"> method of the model’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.1896.1">_meta</span></code><span class="koboSpan" id="kobo.1897.1"> options. </span><span class="koboSpan" id="kobo.1897.2">You exclude many-to-many and one-to-many relationships.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1898.1">You write a header row, including the field names.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1899.1">You iterate over the given QuerySet and write a row for each object returned by the QuerySet. </span><span class="koboSpan" id="kobo.1899.2">You take care of formatting </span><code class="inlineCode"><span class="koboSpan" id="kobo.1900.1">datetime</span></code><span class="koboSpan" id="kobo.1901.1"> objects because the output value for CSV has to be a string.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1902.1">You customize the display name for the action in the action’s drop-down element of the administration site by setting a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1903.1">short_description</span></code><span class="koboSpan" id="kobo.1904.1"> attribute on the function.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1905.1">You have created a </span><a id="_idIndexMarker898"/><span class="koboSpan" id="kobo.1906.1">generic administration action that can</span><a id="_idIndexMarker899"/><span class="koboSpan" id="kobo.1907.1"> be added to any </span><code class="inlineCode"><span class="koboSpan" id="kobo.1908.1">ModelAdmin</span></code><span class="koboSpan" id="kobo.1909.1"> class.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1910.1">Finally, add the new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1911.1">export_to_csv</span></code><span class="koboSpan" id="kobo.1912.1"> administration action to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1913.1">OrderAdmin</span></code><span class="koboSpan" id="kobo.1914.1"> class, as follows. </span><span class="koboSpan" id="kobo.1914.2">The new code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.1915.1">@admin.register(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1916.1">Order</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.1917.1">)</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1918.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1919.1">OrderAdmin</span></span><span class="koboSpan" id="kobo.1920.1">(admin.ModelAdmin):
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1921.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1922.1">    actions = [export_to_csv]</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1923.1">Start the development server with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1924.1">python manage.py runserver
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1925.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.1926.1">http://127.0.0.1:8000/admin/orders/order/</span></code><span class="koboSpan" id="kobo.1927.1"> in your browser. </span><span class="koboSpan" id="kobo.1927.2">The resulting administration action should look like this:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1928.1"><img alt="" role="presentation" src="../Images/B21088_09_28.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1929.1">Figure 9.28: Using the custom Export to CSV administration action</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1930.1">Select some orders, choose the </span><strong class="screenText"><span class="koboSpan" id="kobo.1931.1">Export to CSV</span></strong><span class="koboSpan" id="kobo.1932.1"> action from the select box, and then click the </span><strong class="screenText"><span class="koboSpan" id="kobo.1933.1">Go</span></strong><span class="koboSpan" id="kobo.1934.1"> button. </span><span class="koboSpan" id="kobo.1934.2">Your browser will download the generated CSV file named </span><code class="inlineCode"><span class="koboSpan" id="kobo.1935.1">order.csv</span></code><span class="koboSpan" id="kobo.1936.1">. </span><span class="koboSpan" id="kobo.1936.2">Open the downloaded file using a text editor. </span><span class="koboSpan" id="kobo.1936.3">You should see content with the following format, including a header row and a row for each </span><code class="inlineCode"><span class="koboSpan" id="kobo.1937.1">Order</span></code><span class="koboSpan" id="kobo.1938.1"> object you selected:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1939.1">ID,first name,last name,email,address,postal code,city,created,updated,paid,stripe id
4,Antonio,Melé,email@domain.com,20 W 34th St,10001,New York,03/01/2024,03/01/2024,True,pi_3ORvzkGNwIe5nm8S1wVd7l7i
...
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1940.1">As you can see, creating administration actions is pretty straightforward. </span><span class="koboSpan" id="kobo.1940.2">You can learn more about generating CSV files with Django at </span><a href="https://docs.djangoproject.com/en/5.0/howto/outputting-csv/"><span class="url"><span class="koboSpan" id="kobo.1941.1">https://docs.djangoproject.com/en/5.0/howto/outputting-csv/</span></span></a><span class="koboSpan" id="kobo.1942.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1943.1">If you want to add more </span><a id="_idIndexMarker900"/><span class="koboSpan" id="kobo.1944.1">advanced import/export functionalities to your administration site, you can use the third-party application </span><code class="inlineCode"><span class="koboSpan" id="kobo.1945.1">django-import-export</span></code><span class="koboSpan" id="kobo.1946.1">. </span><span class="koboSpan" id="kobo.1946.2">You can find its documentation at </span><a href="https://django-import-export.readthedocs.io/en/latest/"><span class="url"><span class="koboSpan" id="kobo.1947.1">https://django-import-export.readthedocs.io/en/latest/</span></span></a><span class="koboSpan" id="kobo.1948.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1949.1">The example we</span><a id="_idIndexMarker901"/><span class="koboSpan" id="kobo.1950.1"> have implemented works well for small to medium datasets. </span><span class="koboSpan" id="kobo.1950.2">Given that the export occurs within an HTTP request, very large datasets could lead to server timeouts if the server closes the connection before the export process concludes. </span><span class="koboSpan" id="kobo.1950.3">To circumvent this, you can generate exports asynchronously using Celery, with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1951.1">django-import-export-celery</span></code><span class="koboSpan" id="kobo.1952.1"> application. </span><span class="koboSpan" id="kobo.1952.2">This project is available at </span><a href="https://github.com/auto-mat/django-import-export-celery"><span class="url"><span class="koboSpan" id="kobo.1953.1">https://github.com/auto-mat/django-import-export-celery</span></span></a><span class="koboSpan" id="kobo.1954.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1955.1">Next, you are going to customize the administration site further by creating a custom administration view.</span></p>
<h1 class="heading-1" id="_idParaDest-275"><span class="koboSpan" id="kobo.1956.1">Extending the administration site with custom views</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1957.1">Sometimes, you may want to customize the administration site beyond what is possible by configuring </span><code class="inlineCode"><span class="koboSpan" id="kobo.1958.1">ModelAdmin</span></code><span class="koboSpan" id="kobo.1959.1">, creating administration actions, and overriding administration templates. </span><span class="koboSpan" id="kobo.1959.2">You</span><a id="_idIndexMarker902"/><span class="koboSpan" id="kobo.1960.1"> might want to implement additional functionalities that are not available in existing administration views or templates. </span><span class="koboSpan" id="kobo.1960.2">If this is the case, you need to create a custom administration view. </span><span class="koboSpan" id="kobo.1960.3">With a custom view, you can build any functionality you want; you just have to make sure that only staff users can access your view and that you maintain the administration look and feel by making your template extend an administration template.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1961.1">Let’s create a custom view to display information about an order. </span><span class="koboSpan" id="kobo.1961.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1962.1">views.py</span></code><span class="koboSpan" id="kobo.1963.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1964.1">orders</span></code><span class="koboSpan" id="kobo.1965.1"> application and </span><a id="_idIndexMarker903"/><span class="koboSpan" id="kobo.1966.1">add the following code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1967.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1968.1"> django.contrib.admin.views.decorators </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1969.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1970.1"> staff_member_required</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1971.1">from</span></span><span class="koboSpan" id="kobo.1972.1"> django.shortcuts </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1973.1">import</span></span> <span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1974.1">get_object_or_404, </span></strong></span><span class="koboSpan" id="kobo.1975.1">redirect, render
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1976.1">from</span></span><span class="koboSpan" id="kobo.1977.1"> cart.cart </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1978.1">import</span></span><span class="koboSpan" id="kobo.1979.1"> Cart
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1980.1">from</span></span><span class="koboSpan" id="kobo.1981.1"> .forms </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1982.1">import</span></span><span class="koboSpan" id="kobo.1983.1"> OrderCreateForm
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1984.1">from</span></span><span class="koboSpan" id="kobo.1985.1"> .models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1986.1">import</span></span><span class="koboSpan" id="kobo.1987.1"> Order, OrderItem
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1988.1">from</span></span><span class="koboSpan" id="kobo.1989.1"> .tasks </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1990.1">import</span></span><span class="koboSpan" id="kobo.1991.1"> order_created
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1992.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1993.1">order_create</span></span><span class="koboSpan" id="kobo.1994.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1995.1">request</span></span><span class="koboSpan" id="kobo.1996.1">):
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1997.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-meta-slc"><span class="koboSpan" id="kobo.1998.1">@staff_member_required</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1999.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2000.1">admin_order_detail</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2001.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.2002.1">request, order_id</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2003.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2004.1">    order = get_object_or_404(Order, </span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.2005.1">id</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2006.1">=order_id)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2007.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2008.1"> render(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2009.1">        request, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2010.1">'admin/orders/order/detail.html'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2011.1">, {</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2012.1">'order'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2013.1">: order}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2014.1">    )</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2015.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2016.1">staff_member_required</span></code><span class="koboSpan" id="kobo.2017.1"> decorator checks that both the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2018.1">is_active</span></code><span class="koboSpan" id="kobo.2019.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2020.1">is_staff</span></code><span class="koboSpan" id="kobo.2021.1"> fields of the user requesting the page are set to </span><code class="inlineCode"><span class="koboSpan" id="kobo.2022.1">True</span></code><span class="koboSpan" id="kobo.2023.1">. </span><span class="koboSpan" id="kobo.2023.2">In this view, you get the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2024.1">Order</span></code><span class="koboSpan" id="kobo.2025.1"> object with the given ID and render a template to display the order.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2026.1">Next, edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2027.1">urls.py</span></code><span class="koboSpan" id="kobo.2028.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2029.1">orders</span></code><span class="koboSpan" id="kobo.2030.1"> application and add the following URL pattern highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2031.1">urlpatterns = [
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2032.1">'create/'</span></span><span class="koboSpan" id="kobo.2033.1">, views.order_create, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.2034.1">'order_create'</span></span><span class="koboSpan" id="kobo.2035.1">),
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2036.1">    path(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2037.1">'admin/order/&lt;int:order_id&gt;/'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2038.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2039.1">        views.admin_order_detail,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2040.1">        name=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2041.1">'admin_order_detail'</span></strong></span>
<span class="code-highlight"><strong class="hljs-string-slc"> </strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2042.1">),</span></strong></span><span class="koboSpan" id="kobo.2043.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2044.1">Create the following file structure inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2045.1">templates/</span></code><span class="koboSpan" id="kobo.2046.1"> directory of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2047.1">orders</span></code><span class="koboSpan" id="kobo.2048.1"> application:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2049.1">admin/
    orders/
        order/
            detail.html
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2050.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2051.1">detail.html</span></code><span class="koboSpan" id="kobo.2052.1"> template </span><a id="_idIndexMarker904"/><span class="koboSpan" id="kobo.2053.1">and add the following content to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2054.1">{% extends "admin/base_site.html" %}
{% block title %}
  Order {{ order.id }} {{ block.super }}
{% endblock %}
{% block breadcrumbs %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2055.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2056.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2057.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2058.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2059.1">"breadcrumbs"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2060.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2061.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2062.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2063.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2064.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2065.1">"{% url "</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.2066.1">admin:index</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2067.1">" %}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2068.1">&gt;</span></span><span class="koboSpan" id="kobo.2069.1">Home</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2070.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2071.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2072.1">&gt;</span></span> <span class="hljs-symbol"><span class="koboSpan" id="kobo.2073.1">&amp;rsaquo;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2074.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2075.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2076.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2077.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2078.1">"{% url "</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.2079.1">admin:orders_order_changelist</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2080.1">" %}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2081.1">&gt;</span></span><span class="koboSpan" id="kobo.2082.1">Orders</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2083.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2084.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2085.1">&gt;</span></span>
<span class="hljs-symbol"><span class="koboSpan" id="kobo.2086.1">&amp;rsaquo;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2087.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2088.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2089.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2090.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2091.1">"{% url "</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.2092.1">admin:orders_order_change</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2093.1">" order.id %}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2094.1">&gt;</span></span><span class="koboSpan" id="kobo.2095.1">Order {{ order.id }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2096.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2097.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2098.1">&gt;</span></span>
<span class="hljs-symbol"><span class="koboSpan" id="kobo.2099.1">&amp;rsaquo;</span></span><span class="koboSpan" id="kobo.2100.1"> Detail
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2101.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2102.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2103.1">&gt;</span></span><span class="koboSpan" id="kobo.2104.1">
{% endblock %}
{% block content %}
</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2105.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2106.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2107.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2108.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2109.1">"module"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2110.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2111.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2112.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2113.1">&gt;</span></span><span class="koboSpan" id="kobo.2114.1">Order {{ order.id }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2115.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2116.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2117.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2118.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2119.1">ul</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2120.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2121.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2122.1">"object-tools"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2123.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2124.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2125.1">li</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2126.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2127.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2128.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2129.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2130.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2131.1">"#"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2132.1">onclick</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2133.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2134.1">"window.print();"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2135.1">&gt;</span></span><span class="koboSpan" id="kobo.2136.1">
        Print order
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2137.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2138.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2139.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2140.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2141.1">li</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2142.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2143.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2144.1">ul</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2145.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2146.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2147.1">table</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2148.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2149.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2150.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2151.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2152.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2153.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2154.1">&gt;</span></span><span class="koboSpan" id="kobo.2155.1">Created</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2156.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2157.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2158.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2159.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2160.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2161.1">&gt;</span></span><span class="koboSpan" id="kobo.2162.1">{{ order.created }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2163.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2164.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2165.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2166.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2167.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2168.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2169.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2170.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2171.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2172.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2173.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2174.1">&gt;</span></span><span class="koboSpan" id="kobo.2175.1">Customer</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2176.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2177.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2178.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2179.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2180.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2181.1">&gt;</span></span><span class="koboSpan" id="kobo.2182.1">{{ order.first_name }} {{ order.last_name }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2183.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2184.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2185.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2186.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2187.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2188.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2189.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2190.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2191.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2192.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2193.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2194.1">&gt;</span></span><span class="koboSpan" id="kobo.2195.1">E-mail</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2196.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2197.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2198.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2199.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2200.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2201.1">&gt;&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2202.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2203.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2204.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2205.1">"mailto:{{ order.email }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2206.1">&gt;</span></span><span class="koboSpan" id="kobo.2207.1">{{ order.email }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2208.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2209.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2210.1">&gt;&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2211.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2212.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2213.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2214.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2215.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2216.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2217.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2218.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2219.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2220.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2221.1">&gt;</span></span><span class="koboSpan" id="kobo.2222.1">Address</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2223.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2224.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2225.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2226.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2227.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2228.1">&gt;</span></span><span class="koboSpan" id="kobo.2229.1">
      {{ order.address }},
      {{ order.postal_code }} {{ order.city }}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2230.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2231.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2232.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2233.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2234.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2235.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2236.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2237.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2238.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2239.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2240.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2241.1">&gt;</span></span><span class="koboSpan" id="kobo.2242.1">Total amount</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2243.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2244.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2245.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2246.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2247.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2248.1">&gt;</span></span><span class="koboSpan" id="kobo.2249.1">${{ order.get_total_cost }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2250.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2251.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2252.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2253.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2254.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2255.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2256.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2257.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2258.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2259.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2260.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2261.1">&gt;</span></span><span class="koboSpan" id="kobo.2262.1">Status</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2263.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2264.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2265.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2266.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2267.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2268.1">&gt;</span></span><span class="koboSpan" id="kobo.2269.1">{% if order.paid %}Paid{% else %}Pending payment{% endif %}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2270.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2271.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2272.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2273.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2274.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2275.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2276.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2277.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2278.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2279.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2280.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2281.1">&gt;</span></span><span class="koboSpan" id="kobo.2282.1">Stripe payment</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2283.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2284.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2285.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2286.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2287.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2288.1">&gt;</span></span><span class="koboSpan" id="kobo.2289.1">
        {% if order.stripe_id %}
          </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2290.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2291.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2292.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2293.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2294.1">"{{ order.get_stripe_url }}"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2295.1">target</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2296.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2297.1">"_blank"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2298.1">&gt;</span></span><span class="koboSpan" id="kobo.2299.1">
            {{ order.stripe_id }}
          </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2300.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2301.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2302.1">&gt;</span></span><span class="koboSpan" id="kobo.2303.1">
        {% endif %}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2304.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2305.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2306.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2307.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2308.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2309.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2310.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2311.1">table</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2312.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2313.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2314.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2315.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2316.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2317.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2318.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2319.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2320.1">"module"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2321.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2322.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2323.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2324.1">&gt;</span></span><span class="koboSpan" id="kobo.2325.1">Items bought</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2326.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2327.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2328.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2329.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2330.1">table</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2331.1">style</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2332.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2333.1">"width:100%"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2334.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2335.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2336.1">thead</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2337.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2338.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2339.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2340.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2341.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2342.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2343.1">&gt;</span></span><span class="koboSpan" id="kobo.2344.1">Product</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2345.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2346.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2347.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2348.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2349.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2350.1">&gt;</span></span><span class="koboSpan" id="kobo.2351.1">Price</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2352.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2353.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2354.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2355.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2356.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2357.1">&gt;</span></span><span class="koboSpan" id="kobo.2358.1">Quantity</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2359.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2360.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2361.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2362.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2363.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2364.1">&gt;</span></span><span class="koboSpan" id="kobo.2365.1">Total</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2366.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2367.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2368.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2369.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2370.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2371.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2372.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2373.1">thead</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2374.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2375.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2376.1">tbody</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2377.1">&gt;</span></span><span class="koboSpan" id="kobo.2378.1">
      {% for item in order.items.all %}
        </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2379.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2380.1">tr</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2381.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2382.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2383.1">"row{% cycle "</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.2384.1">1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2385.1">" "</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.2386.1">2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2387.1">" %}"&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2388.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2389.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2390.1">&gt;</span></span><span class="koboSpan" id="kobo.2391.1">{{ item.product.name }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2392.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2393.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2394.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2395.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2396.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2397.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2398.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2399.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2400.1">&gt;</span></span><span class="koboSpan" id="kobo.2401.1">${{ item.price }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2402.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2403.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2404.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2405.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2406.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2407.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2408.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2409.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2410.1">&gt;</span></span><span class="koboSpan" id="kobo.2411.1">{{ item.quantity }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2412.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2413.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2414.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2415.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2416.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2417.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2418.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2419.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2420.1">&gt;</span></span><span class="koboSpan" id="kobo.2421.1">${{ item.get_cost }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2422.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2423.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2424.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2425.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2426.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2427.1">&gt;</span></span><span class="koboSpan" id="kobo.2428.1">
      {% endfor %}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2429.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2430.1">tr</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2431.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2432.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2433.1">"total"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2434.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2435.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2436.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2437.1">colspan</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2438.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2439.1">"3"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2440.1">&gt;</span></span><span class="koboSpan" id="kobo.2441.1">Total</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2442.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2443.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2444.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2445.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2446.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2447.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2448.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2449.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2450.1">&gt;</span></span><span class="koboSpan" id="kobo.2451.1">${{ order.get_total_cost }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2452.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2453.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2454.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2455.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2456.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2457.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2458.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2459.1">tbody</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2460.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2461.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2462.1">table</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2463.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2464.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2465.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2466.1">&gt;</span></span><span class="koboSpan" id="kobo.2467.1">
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2468.1">Make sure that no template tag is split across multiple lines.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2469.1">This is the template to display </span><a id="_idIndexMarker905"/><span class="koboSpan" id="kobo.2470.1">the details of an order on the administration site. </span><span class="koboSpan" id="kobo.2470.2">This template extends the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2471.1">admin/base_site.html</span></code><span class="koboSpan" id="kobo.2472.1"> template of Django’s administration site, which contains the main HTML structure and CSS styles. </span><span class="koboSpan" id="kobo.2472.2">You use the blocks defined in the parent template to include your own content. </span><span class="koboSpan" id="kobo.2472.3">You display information about the order and the items bought.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2473.1">When you want to extend an administration template, you need to know its structure and identify existing blocks. </span><span class="koboSpan" id="kobo.2473.2">You can find all administration templates at </span><a href="https://github.com/django/django/tree/5.0/django/contrib/admin/templates/admin"><span class="url"><span class="koboSpan" id="kobo.2474.1">https://github.com/django/django/tree/5.0/django/contrib/admin/templates/admin</span></span></a><span class="koboSpan" id="kobo.2475.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2476.1">You can also override an administration template if you need to. </span><span class="koboSpan" id="kobo.2476.2">To do so, copy a template into your </span><code class="inlineCode"><span class="koboSpan" id="kobo.2477.1">templates/</span></code><span class="koboSpan" id="kobo.2478.1"> directory, keeping the same relative path and filename. </span><span class="koboSpan" id="kobo.2478.2">Django’s administration site will use your custom template instead of the default one.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2479.1">Finally, let’s add a link to each </span><code class="inlineCode"><span class="koboSpan" id="kobo.2480.1">Order</span></code><span class="koboSpan" id="kobo.2481.1"> object on the list display page of the administration site. </span><span class="koboSpan" id="kobo.2481.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2482.1">admin.py</span></code><span class="koboSpan" id="kobo.2483.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2484.1">orders</span></code><span class="koboSpan" id="kobo.2485.1"> application and add the following code to it, above the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2486.1">OrderAdmin</span></code><span class="koboSpan" id="kobo.2487.1"> class:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2488.1">from</span></span><span class="koboSpan" id="kobo.2489.1"> django.urls </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2490.1">import</span></span><span class="koboSpan" id="kobo.2491.1"> reverse
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2492.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2493.1">order_detail</span></span><span class="koboSpan" id="kobo.2494.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2495.1">obj</span></span><span class="koboSpan" id="kobo.2496.1">):
    url = reverse(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2497.1">'orders:admin_order_detail'</span></span><span class="koboSpan" id="kobo.2498.1">, args=[obj.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2499.1">id</span></span><span class="koboSpan" id="kobo.2500.1">])
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2501.1">return</span></span><span class="koboSpan" id="kobo.2502.1"> mark_safe(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2503.1">f'&lt;a href="</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.2504.1">{url}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2505.1">"&gt;View&lt;/a&gt;'</span></span><span class="koboSpan" id="kobo.2506.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2507.1">This is a function that</span><a id="_idIndexMarker906"/><span class="koboSpan" id="kobo.2508.1"> takes an </span><code class="inlineCode"><span class="koboSpan" id="kobo.2509.1">Order</span></code><span class="koboSpan" id="kobo.2510.1"> object as an argument and returns an HTML link for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2511.1">admin_order_detail</span></code><span class="koboSpan" id="kobo.2512.1"> URL. </span><span class="koboSpan" id="kobo.2512.2">Django escapes HTML output by default. </span><span class="koboSpan" id="kobo.2512.3">You have to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2513.1">mark_safe</span></code><span class="koboSpan" id="kobo.2514.1"> function to avoid auto-escaping.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2515.1">Then, edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2516.1">OrderAdmin</span></code><span class="koboSpan" id="kobo.2517.1"> class to display the link, as follows. </span><span class="koboSpan" id="kobo.2517.2">The new code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2518.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2519.1">OrderAdmin</span></span><span class="koboSpan" id="kobo.2520.1">(admin.ModelAdmin):
    list_display = [
</span><span class="hljs-string"><span class="koboSpan" id="kobo.2521.1">        'id'</span></span><span class="koboSpan" id="kobo.2522.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2523.1">'first_name'</span></span><span class="koboSpan" id="kobo.2524.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2525.1">'last_name'</span></span><span class="koboSpan" id="kobo.2526.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2527.1">'email'</span></span><span class="koboSpan" id="kobo.2528.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2529.1">'address'</span></span><span class="koboSpan" id="kobo.2530.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2531.1">'postal_code'</span></span><span class="koboSpan" id="kobo.2532.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2533.1">'city'</span></span><span class="koboSpan" id="kobo.2534.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2535.1">'paid'</span></span><span class="koboSpan" id="kobo.2536.1">,
        order_payment,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2537.1">'created'</span></span><span class="koboSpan" id="kobo.2538.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2539.1">'updated'</span></span><span class="koboSpan" id="kobo.2540.1">,
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2541.1">        order_detail,</span></strong></span><span class="koboSpan" id="kobo.2542.1">
    ]
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.2543.1"># ...</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2544.1">Start the development server with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2545.1">python manage.py runserver
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2546.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.2547.1">http://127.0.0.1:8000/admin/orders/order/</span></code><span class="koboSpan" id="kobo.2548.1"> in your browser. </span><span class="koboSpan" id="kobo.2548.2">Each row includes a </span><strong class="screenText"><span class="koboSpan" id="kobo.2549.1">View</span></strong><strong class="keyWord"> </strong><span class="koboSpan" id="kobo.2550.1">link, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2551.1"><img alt="" role="presentation" src="../Images/B21088_09_29.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2552.1">Figure 9.29: The View link included in each order row</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2553.1">Click on the </span><strong class="screenText"><span class="koboSpan" id="kobo.2554.1">View</span></strong><span class="koboSpan" id="kobo.2555.1"> link for </span><a id="_idIndexMarker907"/><span class="koboSpan" id="kobo.2556.1">any order to load the custom order detail page. </span><span class="koboSpan" id="kobo.2556.2">You should see a page like the following one:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2557.1"><img alt="" role="presentation" src="../Images/B21088_09_30.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2558.1">Figure 9.30: The custom order detail page on the administration site</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2559.1">Now that you have created the product detail page, you will learn how to generate order invoices in the PDF format dynamically.</span></p>
<h1 class="heading-1" id="_idParaDest-276"><span class="koboSpan" id="kobo.2560.1">Generating PDF invoices dynamically</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2561.1">Now that you have a complete checkout and payment system, you can generate a PDF invoice for each order. </span><span class="koboSpan" id="kobo.2561.2">There are </span><a id="_idIndexMarker908"/><span class="koboSpan" id="kobo.2562.1">several Python libraries to generate PDF files. </span><span class="koboSpan" id="kobo.2562.2">One popular library to generate PDFs with Python code is ReportLab. </span><span class="koboSpan" id="kobo.2562.3">You can find information about how to output PDF files with ReportLab at </span><a href="https://docs.djangoproject.com/en/5.0/howto/outputting-pdf/"><span class="url"><span class="koboSpan" id="kobo.2563.1">https://docs.djangoproject.com/en/5.0/howto/outputting-pdf/</span></span></a><span class="koboSpan" id="kobo.2564.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2565.1">In most cases, you will have to add custom styles and formatting to your PDF files. </span><span class="koboSpan" id="kobo.2565.2">You will find it more convenient to render an HTML template and convert it into a PDF file, keeping Python away from the presentation layer. </span><span class="koboSpan" id="kobo.2565.3">You are going to follow this approach and use a module to generate PDF files with Django. </span><span class="koboSpan" id="kobo.2565.4">You will use WeasyPrint, which is a Python library that can generate PDF files from HTML templates.</span></p>
<h2 class="heading-2" id="_idParaDest-277"><span class="koboSpan" id="kobo.2566.1">Installing WeasyPrint</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2567.1">First, install WeasyPrint’s dependencies for </span><a id="_idIndexMarker909"/><span class="koboSpan" id="kobo.2568.1">your operating</span><a id="_idIndexMarker910"/><span class="koboSpan" id="kobo.2569.1"> system from </span><a href="https://doc.courtbouillon.org/weasyprint/stable/first_steps.html"><span class="url"><span class="koboSpan" id="kobo.2570.1">https://doc.courtbouillon.org/weasyprint/stable/first_steps.html</span></span></a><span class="koboSpan" id="kobo.2571.1">. </span><span class="koboSpan" id="kobo.2571.2">Then, install WeasyPrint via </span><code class="inlineCode"><span class="koboSpan" id="kobo.2572.1">pip</span></code><span class="koboSpan" id="kobo.2573.1"> using the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2574.1">python -m pip install WeasyPrint==61.2
</span></code></pre>
<h2 class="heading-2" id="_idParaDest-278"><span class="koboSpan" id="kobo.2575.1">Creating a PDF template</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2576.1">You need an HTML document as</span><a id="_idIndexMarker911"/><span class="koboSpan" id="kobo.2577.1"> input for WeasyPrint. </span><span class="koboSpan" id="kobo.2577.2">You are going to create an HTML template, render it using Django, and pass it to WeasyPrint to generate the PDF file.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2578.1">Create a new template file inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2579.1">templates/orders/order/</span></code><span class="koboSpan" id="kobo.2580.1"> directory of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2581.1">orders</span></code><span class="koboSpan" id="kobo.2582.1"> application and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.2583.1">pdf.html</span></code><span class="koboSpan" id="kobo.2584.1">. </span><span class="koboSpan" id="kobo.2584.2">Add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.2585.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2586.1">html</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2587.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2588.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2589.1">body</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2590.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2591.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2592.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2593.1">&gt;</span></span><span class="koboSpan" id="kobo.2594.1">My Shop</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2595.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2596.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2597.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2598.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2599.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2600.1">&gt;</span></span><span class="koboSpan" id="kobo.2601.1">
    Invoice no. </span><span class="koboSpan" id="kobo.2601.2">{{ order.id }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2602.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2603.1">br</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2604.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2605.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2606.1">span</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2607.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2608.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2609.1">"secondary"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2610.1">&gt;</span></span><span class="koboSpan" id="kobo.2611.1">
      {{ order.created|date:"M d, Y" }}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2612.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2613.1">span</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2614.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2615.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2616.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2617.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2618.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2619.1">h3</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2620.1">&gt;</span></span><span class="koboSpan" id="kobo.2621.1">Bill to</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2622.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2623.1">h3</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2624.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2625.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2626.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2627.1">&gt;</span></span><span class="koboSpan" id="kobo.2628.1">
    {{ order.first_name }} {{ order.last_name }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2629.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2630.1">br</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2631.1">&gt;</span></span><span class="koboSpan" id="kobo.2632.1">
    {{ order.email }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2633.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2634.1">br</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2635.1">&gt;</span></span><span class="koboSpan" id="kobo.2636.1">
    {{ order.address }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2637.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2638.1">br</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2639.1">&gt;</span></span><span class="koboSpan" id="kobo.2640.1">
    {{ order.postal_code }}, {{ order.city }}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2641.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2642.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2643.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2644.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2645.1">h3</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2646.1">&gt;</span></span><span class="koboSpan" id="kobo.2647.1">Items bought</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2648.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2649.1">h3</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2650.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2651.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2652.1">table</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2653.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2654.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2655.1">thead</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2656.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2657.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2658.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2659.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2660.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2661.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2662.1">&gt;</span></span><span class="koboSpan" id="kobo.2663.1">Product</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2664.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2665.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2666.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2667.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2668.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2669.1">&gt;</span></span><span class="koboSpan" id="kobo.2670.1">Price</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2671.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2672.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2673.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2674.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2675.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2676.1">&gt;</span></span><span class="koboSpan" id="kobo.2677.1">Quantity</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2678.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2679.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2680.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2681.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2682.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2683.1">&gt;</span></span><span class="koboSpan" id="kobo.2684.1">Cost</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2685.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2686.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2687.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2688.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2689.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2690.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2691.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2692.1">thead</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2693.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2694.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2695.1">tbody</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2696.1">&gt;</span></span><span class="koboSpan" id="kobo.2697.1">
      {% for item in order.items.all %}
        </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2698.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2699.1">tr</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2700.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2701.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2702.1">"row{% cycle "1" "2" %}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2703.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2704.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2705.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2706.1">&gt;</span></span><span class="koboSpan" id="kobo.2707.1">{{ item.product.name }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2708.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2709.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2710.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2711.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2712.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2713.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2714.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2715.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2716.1">&gt;</span></span><span class="koboSpan" id="kobo.2717.1">${{ item.price }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2718.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2719.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2720.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2721.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2722.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2723.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2724.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2725.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2726.1">&gt;</span></span><span class="koboSpan" id="kobo.2727.1">{{ item.quantity }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2728.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2729.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2730.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2731.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2732.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2733.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2734.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2735.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2736.1">&gt;</span></span><span class="koboSpan" id="kobo.2737.1">${{ item.get_cost }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2738.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2739.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2740.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2741.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2742.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2743.1">&gt;</span></span><span class="koboSpan" id="kobo.2744.1">
      {% endfor %}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2745.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2746.1">tr</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2747.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2748.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2749.1">"total"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2750.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2751.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2752.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2753.1">colspan</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2754.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2755.1">"3"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2756.1">&gt;</span></span><span class="koboSpan" id="kobo.2757.1">Total</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2758.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2759.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2760.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2761.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2762.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2763.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2764.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2765.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2766.1">&gt;</span></span><span class="koboSpan" id="kobo.2767.1">${{ order.get_total_cost }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2768.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2769.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2770.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2771.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2772.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2773.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2774.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2775.1">tbody</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2776.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2777.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2778.1">table</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2779.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2780.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2781.1">span</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2782.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2783.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2784.1">"{% if order.paid %}paid{% else %}pending{% endif %}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2785.1">&gt;</span></span><span class="koboSpan" id="kobo.2786.1">
    {% if order.paid %}Paid{% else %}Pending payment{% endif %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2787.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2788.1">span</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2789.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2790.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2791.1">body</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2792.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2793.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2794.1">html</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2795.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2796.1">This is the template</span><a id="_idIndexMarker912"/><span class="koboSpan" id="kobo.2797.1"> for the PDF invoice. </span><span class="koboSpan" id="kobo.2797.2">In this template, you display all order details and an HTML </span><code class="inlineCode"><span class="koboSpan" id="kobo.2798.1">&lt;table&gt;</span></code><span class="koboSpan" id="kobo.2799.1"> element, including the products. </span><span class="koboSpan" id="kobo.2799.2">You also include a message to display whether the order has been paid.</span></p>
<h2 class="heading-2" id="_idParaDest-279"><span class="koboSpan" id="kobo.2800.1">Rendering PDF files</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2801.1">You are going to create a view to </span><a id="_idIndexMarker913"/><span class="koboSpan" id="kobo.2802.1">generate PDF invoices for existing orders using the administration site. </span><span class="koboSpan" id="kobo.2802.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2803.1">views.py</span></code><span class="koboSpan" id="kobo.2804.1"> file inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2805.1">orders</span></code><span class="koboSpan" id="kobo.2806.1"> application directory and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2807.1">import</span></span><span class="koboSpan" id="kobo.2808.1"> weasyprint
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2809.1">from</span></span><span class="koboSpan" id="kobo.2810.1"> django.contrib.staticfiles </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2811.1">import</span></span><span class="koboSpan" id="kobo.2812.1"> finders
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2813.1">from</span></span><span class="koboSpan" id="kobo.2814.1"> django.http </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2815.1">import</span></span><span class="koboSpan" id="kobo.2816.1"> HttpResponse
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2817.1">from</span></span><span class="koboSpan" id="kobo.2818.1"> django.template.loader </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2819.1">import</span></span><span class="koboSpan" id="kobo.2820.1"> render_to_string
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.2821.1">@staff_member_required</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2822.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2823.1">admin_order_pdf</span></span><span class="koboSpan" id="kobo.2824.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2825.1">request, order_id</span></span><span class="koboSpan" id="kobo.2826.1">):
    order = get_object_or_404(Order, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2827.1">id</span></span><span class="koboSpan" id="kobo.2828.1">=order_id)
    html = render_to_string(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2829.1">'orders/order/pdf.html'</span></span><span class="koboSpan" id="kobo.2830.1">, {</span><span class="hljs-string"><span class="koboSpan" id="kobo.2831.1">'order'</span></span><span class="koboSpan" id="kobo.2832.1">: order})
    response = HttpResponse(content_type=</span><span class="hljs-string"><span class="koboSpan" id="kobo.2833.1">'application/pdf'</span></span><span class="koboSpan" id="kobo.2834.1">)
    response[</span><span class="hljs-string"><span class="koboSpan" id="kobo.2835.1">'Content-Disposition'</span></span><span class="koboSpan" id="kobo.2836.1">] = </span><span class="hljs-string"><span class="koboSpan" id="kobo.2837.1">f'filename=order_</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.2838.1">{order.</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2839.1">id</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.2840.1">}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2841.1">.pdf'</span></span><span class="koboSpan" id="kobo.2842.1">
    weasyprint.HTML(string=html).write_pdf(
        response,
        stylesheets=[weasyprint.CSS(finders.find(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2843.1">'css/pdf.css'</span></span><span class="koboSpan" id="kobo.2844.1">))]
    )
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2845.1">return</span></span><span class="koboSpan" id="kobo.2846.1"> response
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2847.1">This is the view to generate a PDF invoice for an order. </span><span class="koboSpan" id="kobo.2847.2">You use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2848.1">staff_member_required</span></code><span class="koboSpan" id="kobo.2849.1"> decorator to make sure only staff users can access this view.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2850.1">You get the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2851.1">Order</span></code><span class="koboSpan" id="kobo.2852.1"> object with the given ID and use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2853.1">render_to_string()</span></code><span class="koboSpan" id="kobo.2854.1"> function provided by Django to render </span><code class="inlineCode"><span class="koboSpan" id="kobo.2855.1">orders/order/pdf.html</span></code><span class="koboSpan" id="kobo.2856.1">. </span><span class="koboSpan" id="kobo.2856.2">The rendered HTML is saved in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2857.1">html</span></code><span class="koboSpan" id="kobo.2858.1"> variable.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2859.1">Then, you generate a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.2860.1">HttpResponse</span></code><span class="koboSpan" id="kobo.2861.1"> object, specifying the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2862.1">application/pdf</span></code><span class="koboSpan" id="kobo.2863.1"> content type and including the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2864.1">Content-Disposition</span></code><span class="koboSpan" id="kobo.2865.1"> header to specify the filename. </span><span class="koboSpan" id="kobo.2865.2">You use WeasyPrint to generate a PDF file from the rendered HTML code and write the file to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2866.1">HttpResponse</span></code><span class="koboSpan" id="kobo.2867.1"> object.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2868.1">You use the static file </span><code class="inlineCode"><span class="koboSpan" id="kobo.2869.1">css/pdf.css</span></code><span class="koboSpan" id="kobo.2870.1"> to add CSS styles to the generated PDF file. </span><span class="koboSpan" id="kobo.2870.2">To locate the file, you use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2871.1">finders()</span></code><span class="koboSpan" id="kobo.2872.1"> function of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2873.1">staticfiles</span></code><span class="koboSpan" id="kobo.2874.1"> module. </span><span class="koboSpan" id="kobo.2874.2">Finally, you return the generated response.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2875.1">If you are missing the CSS styles, remember to copy the static files located in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2876.1">static/</span></code><span class="koboSpan" id="kobo.2877.1"> directory of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2878.1">shop</span></code><span class="koboSpan" id="kobo.2879.1"> application to the same location of your project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2880.1">You can find the contents of the directory at </span><a href="https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter09/myshop/shop/static"><span class="url"><span class="koboSpan" id="kobo.2881.1">https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter09/myshop/shop/static</span></span></a><span class="koboSpan" id="kobo.2882.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2883.1">Since you need to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2884.1">STATIC_ROOT</span></code><span class="koboSpan" id="kobo.2885.1"> setting, you have to add it to your project. </span><span class="koboSpan" id="kobo.2885.2">This is the project’s path where static</span><a id="_idIndexMarker914"/><span class="koboSpan" id="kobo.2886.1"> files reside. </span><span class="koboSpan" id="kobo.2886.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2887.1">settings.py</span></code><span class="koboSpan" id="kobo.2888.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2889.1">myshop</span></code><span class="koboSpan" id="kobo.2890.1"> project and add the following setting:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2891.1">STATIC_ROOT = BASE_DIR / </span><span class="hljs-string"><span class="koboSpan" id="kobo.2892.1">'static'</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2893.1">Then, run the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2894.1">python manage.py collectstatic
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2895.1">You should see output that ends like this:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2896.1">131 static files copied to 'code/myshop/static'.
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2897.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2898.1">collectstatic</span></code><span class="koboSpan" id="kobo.2899.1"> command copies all static files from your applications into the directory defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2900.1">STATIC_ROOT</span></code><span class="koboSpan" id="kobo.2901.1"> setting. </span><span class="koboSpan" id="kobo.2901.2">This allows each application to provide its own static files using a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2902.1">static/</span></code><span class="koboSpan" id="kobo.2903.1"> directory containing them. </span><span class="koboSpan" id="kobo.2903.2">You can also provide additional static file sources in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2904.1">STATICFILES_DIRS</span></code><span class="koboSpan" id="kobo.2905.1"> setting. </span><span class="koboSpan" id="kobo.2905.2">All of the directories specified in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2906.1">STATICFILES_DIRS</span></code><span class="koboSpan" id="kobo.2907.1"> list will also be copied to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2908.1">STATIC_ROOT</span></code><span class="koboSpan" id="kobo.2909.1"> directory when </span><code class="inlineCode"><span class="koboSpan" id="kobo.2910.1">collectstatic</span></code><span class="koboSpan" id="kobo.2911.1"> is executed. </span><span class="koboSpan" id="kobo.2911.2">Whenever you execute </span><code class="inlineCode"><span class="koboSpan" id="kobo.2912.1">collectstatic</span></code><span class="koboSpan" id="kobo.2913.1"> again, you will be asked if you want to override the existing static files.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2914.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2915.1">urls.py</span></code><span class="koboSpan" id="kobo.2916.1"> file inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2917.1">orders</span></code><span class="koboSpan" id="kobo.2918.1"> application directory and add the following URL pattern highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2919.1">urlpatterns = [
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.2920.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2921.1">    path(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2922.1">'admin/order/&lt;int:order_id&gt;/pdf/'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2923.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2924.1">        views.admin_order_pdf,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2925.1">        name=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2926.1">'admin_order_pdf'</span></strong></span>
<span class="code-highlight"><strong class="hljs-string-slc"> </strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2927.1">),</span></strong></span><span class="koboSpan" id="kobo.2928.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2929.1">Now, you can edit the administration list display page for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2930.1">Order</span></code><span class="koboSpan" id="kobo.2931.1"> model to add a link to the PDF file for each result. </span><span class="koboSpan" id="kobo.2931.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2932.1">admin.py</span></code><span class="koboSpan" id="kobo.2933.1"> file inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2934.1">orders</span></code><span class="koboSpan" id="kobo.2935.1"> application and add the following code above the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2936.1">OrderAdmin</span></code><span class="koboSpan" id="kobo.2937.1"> class:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2938.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2939.1">order_pdf</span></span><span class="koboSpan" id="kobo.2940.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2941.1">obj</span></span><span class="koboSpan" id="kobo.2942.1">):
    url = reverse(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2943.1">'orders:admin_order_pdf'</span></span><span class="koboSpan" id="kobo.2944.1">, args=[obj.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2945.1">id</span></span><span class="koboSpan" id="kobo.2946.1">])
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2947.1">return</span></span><span class="koboSpan" id="kobo.2948.1"> mark_safe(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2949.1">f'&lt;a href="</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.2950.1">{url}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2951.1">"&gt;PDF&lt;/a&gt;'</span></span><span class="koboSpan" id="kobo.2952.1">)
order_pdf.short_description = </span><span class="hljs-string"><span class="koboSpan" id="kobo.2953.1">'Invoice'</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2954.1">If you specify a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2955.1">short_description</span></code><span class="koboSpan" id="kobo.2956.1"> attribute</span><a id="_idIndexMarker915"/><span class="koboSpan" id="kobo.2957.1"> for your callable, Django will use it for the name of the column.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2958.1">Add </span><code class="inlineCode"><span class="koboSpan" id="kobo.2959.1">order_pdf</span></code><span class="koboSpan" id="kobo.2960.1"> to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2961.1">list_display</span></code><span class="koboSpan" id="kobo.2962.1"> attribute of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2963.1">OrderAdmin</span></code><span class="koboSpan" id="kobo.2964.1"> class, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2965.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2966.1">OrderAdmin</span></span><span class="koboSpan" id="kobo.2967.1">(admin.ModelAdmin):
    list_display = [
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2968.1">'id'</span></span><span class="koboSpan" id="kobo.2969.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2970.1">'first_name'</span></span><span class="koboSpan" id="kobo.2971.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2972.1">'last_name'</span></span><span class="koboSpan" id="kobo.2973.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2974.1">'email'</span></span><span class="koboSpan" id="kobo.2975.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2976.1">'address'</span></span><span class="koboSpan" id="kobo.2977.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2978.1">'postal_code'</span></span><span class="koboSpan" id="kobo.2979.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2980.1">'city'</span></span><span class="koboSpan" id="kobo.2981.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2982.1">'paid'</span></span><span class="koboSpan" id="kobo.2983.1">,
        order_payment,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2984.1">'created'</span></span><span class="koboSpan" id="kobo.2985.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2986.1">'updated'</span></span><span class="koboSpan" id="kobo.2987.1">,
        order_detail,
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2988.1">        order_pdf,</span></strong></span><span class="koboSpan" id="kobo.2989.1">
    ]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2990.1">Make sure the development server is running. </span><span class="koboSpan" id="kobo.2990.2">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.2991.1">http://127.0.0.1:8000/admin/orders/order/</span></code><span class="koboSpan" id="kobo.2992.1"> in your browser. </span><span class="koboSpan" id="kobo.2992.2">Each row should now include a </span><strong class="screenText"><span class="koboSpan" id="kobo.2993.1">PDF</span></strong><span class="koboSpan" id="kobo.2994.1"> link, like this:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2995.1"><img alt="" role="presentation" src="../Images/B21088_09_31.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2996.1">Figure 9.31: The PDF link included in each order row</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2997.1">Click on the </span><strong class="screenText"><span class="koboSpan" id="kobo.2998.1">PDF</span></strong><span class="koboSpan" id="kobo.2999.1"> link for any order. </span><span class="koboSpan" id="kobo.2999.2">You should see a generated PDF file like the following one for orders that</span><a id="_idIndexMarker916"/><span class="koboSpan" id="kobo.3000.1"> have not been paid yet:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.3001.1"><img alt="" role="presentation" src="../Images/B21088_09_32.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.3002.1">Figure 9.32: The PDF invoice for an unpaid order</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3003.1">For paid orders, you will see the following PDF file:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.3004.1"><img alt="" role="presentation" src="../Images/B21088_09_33.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.3005.1">Figure 9.33: The PDF invoice for a paid order</span></p>
<h2 class="heading-2" id="_idParaDest-280"><span class="koboSpan" id="kobo.3006.1">Sending PDF files by email</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.3007.1">When a payment is</span><a id="_idIndexMarker917"/><span class="koboSpan" id="kobo.3008.1"> successful, you will send an automatic email to your customer including the generated PDF invoice. </span><span class="koboSpan" id="kobo.3008.2">You will create an asynchronous task to perform this action.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3009.1">Create a new file inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3010.1">payment</span></code><span class="koboSpan" id="kobo.3011.1"> application directory and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.3012.1">tasks.py</span></code><span class="koboSpan" id="kobo.3013.1">. </span><span class="koboSpan" id="kobo.3013.2">Add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3014.1">from</span></span><span class="koboSpan" id="kobo.3015.1"> io </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3016.1">import</span></span><span class="koboSpan" id="kobo.3017.1"> BytesIO
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3018.1">import</span></span><span class="koboSpan" id="kobo.3019.1"> weasyprint
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3020.1">from</span></span><span class="koboSpan" id="kobo.3021.1"> celery </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3022.1">import</span></span><span class="koboSpan" id="kobo.3023.1"> shared_task
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3024.1">from</span></span><span class="koboSpan" id="kobo.3025.1"> django.contrib.staticfiles </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3026.1">import</span></span><span class="koboSpan" id="kobo.3027.1"> finders
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3028.1">from</span></span><span class="koboSpan" id="kobo.3029.1"> django.core.mail </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3030.1">import</span></span><span class="koboSpan" id="kobo.3031.1"> EmailMessage
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3032.1">from</span></span><span class="koboSpan" id="kobo.3033.1"> django.template.loader </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3034.1">import</span></span><span class="koboSpan" id="kobo.3035.1"> render_to_string
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3036.1">from</span></span><span class="koboSpan" id="kobo.3037.1"> orders.models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3038.1">import</span></span><span class="koboSpan" id="kobo.3039.1"> Order
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.3040.1">@shared_task</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.3041.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3042.1">payment_completed</span></span><span class="koboSpan" id="kobo.3043.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3044.1">order_id</span></span><span class="koboSpan" id="kobo.3045.1">):
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.3046.1">"""</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.3047.1">    Task to send an e-mail notification when an order is</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.3048.1">    successfully paid.</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.3049.1">    """</span></span><span class="koboSpan" id="kobo.3050.1">
    order = Order.objects.get(</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3051.1">id</span></span><span class="koboSpan" id="kobo.3052.1">=order_id)
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.3053.1"># create invoice e-mail</span></span><span class="koboSpan" id="kobo.3054.1">
    subject = </span><span class="hljs-string"><span class="koboSpan" id="kobo.3055.1">f'My Shop - Invoice no. </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.3056.1">{order.</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3057.1">id</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.3058.1">}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3059.1">'</span></span><span class="koboSpan" id="kobo.3060.1">
    message = (
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.3061.1">'Please, find attached the invoice for your recent purchase.'</span></span><span class="koboSpan" id="kobo.3062.1">
    )
    email = EmailMessage(
        subject, message, </span><span class="hljs-string"><span class="koboSpan" id="kobo.3063.1">'admin@myshop.com'</span></span><span class="koboSpan" id="kobo.3064.1">, [order.email]
    )
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.3065.1"># generate PDF</span></span><span class="koboSpan" id="kobo.3066.1">
    html = render_to_string(</span><span class="hljs-string"><span class="koboSpan" id="kobo.3067.1">'orders/order/pdf.html'</span></span><span class="koboSpan" id="kobo.3068.1">, {</span><span class="hljs-string"><span class="koboSpan" id="kobo.3069.1">'order'</span></span><span class="koboSpan" id="kobo.3070.1">: order})
    out = BytesIO()
    stylesheets=[weasyprint.CSS(finders.find(</span><span class="hljs-string"><span class="koboSpan" id="kobo.3071.1">'css/pdf.css'</span></span><span class="koboSpan" id="kobo.3072.1">))]
    weasyprint.HTML(string=html).write_pdf(out, stylesheets=stylesheets)
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.3073.1"># attach PDF file</span></span><span class="koboSpan" id="kobo.3074.1">
    email.attach(
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.3075.1">f'order_</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.3076.1">{order.</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3077.1">id</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.3078.1">}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3079.1">.pdf'</span></span><span class="koboSpan" id="kobo.3080.1">, out.getvalue(), </span><span class="hljs-string"><span class="koboSpan" id="kobo.3081.1">'application/pdf'</span></span>
<span class="hljs-string"> </span><span class="koboSpan" id="kobo.3082.1">)
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.3083.1"># send e-mail</span></span><span class="koboSpan" id="kobo.3084.1">
    email.send()
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3085.1">You define the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3086.1">payment_completed</span></code><span class="koboSpan" id="kobo.3087.1"> task by </span><a id="_idIndexMarker918"/><span class="koboSpan" id="kobo.3088.1">using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3089.1">@shared_task</span></code><span class="koboSpan" id="kobo.3090.1"> decorator. </span><span class="koboSpan" id="kobo.3090.2">In this task, you use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3091.1">EmailMessage</span></code><span class="koboSpan" id="kobo.3092.1"> class provided by Django to create an </span><code class="inlineCode"><span class="koboSpan" id="kobo.3093.1">email</span></code><span class="koboSpan" id="kobo.3094.1"> object. </span><span class="koboSpan" id="kobo.3094.2">Then, you render the template in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3095.1">html</span></code><span class="koboSpan" id="kobo.3096.1"> variable. </span><span class="koboSpan" id="kobo.3096.2">You generate the PDF file from the rendered template and output it to a </span><code class="inlineCode"><span class="koboSpan" id="kobo.3097.1">BytesIO</span></code><span class="koboSpan" id="kobo.3098.1"> instance, which is an in-memory bytes buffer. </span><span class="koboSpan" id="kobo.3098.2">Then, you attach the generated PDF file to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3099.1">EmailMessage</span></code><span class="koboSpan" id="kobo.3100.1"> object using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3101.1">attach()</span></code><span class="koboSpan" id="kobo.3102.1"> method, including the contents of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3103.1">out</span></code><span class="koboSpan" id="kobo.3104.1"> buffer. </span><span class="koboSpan" id="kobo.3104.2">Finally, you send the email.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3105.1">Remember to set up your </span><strong class="keyWord"><span class="koboSpan" id="kobo.3106.1">Simple Mail Transfer Protocol</span></strong><span class="koboSpan" id="kobo.3107.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.3108.1">SMTP</span></strong><span class="koboSpan" id="kobo.3109.1">) settings in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3110.1">settings.py</span></code><span class="koboSpan" id="kobo.3111.1"> file of the project to send</span><a id="_idIndexMarker919"/><span class="koboSpan" id="kobo.3112.1"> emails. </span><span class="koboSpan" id="kobo.3112.2">You can refer to </span><em class="italic"><span class="koboSpan" id="kobo.3113.1">Chapter 2</span></em><span class="koboSpan" id="kobo.3114.1">, </span><em class="italic"><span class="koboSpan" id="kobo.3115.1">Enhancing Your Blog with Advanced Features</span></em><span class="koboSpan" id="kobo.3116.1">, to see a working example of an SMTP configuration. </span><span class="koboSpan" id="kobo.3116.2">If you don’t want to set up email settings, you can tell Django to write emails to the console by adding the following </span><a id="_idIndexMarker920"/><span class="koboSpan" id="kobo.3117.1">setting to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3118.1">settings.py</span></code><span class="koboSpan" id="kobo.3119.1"> file:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3120.1">EMAIL_BACKEND = </span><span class="hljs-string"><span class="koboSpan" id="kobo.3121.1">'django.core.mail.backends.console.EmailBackend'</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3122.1">Let’s add the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3123.1">payment_completed</span></code><span class="koboSpan" id="kobo.3124.1"> task to the webhook endpoint that handles payment completion events.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3125.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3126.1">webhooks.py</span></code><span class="koboSpan" id="kobo.3127.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3128.1">payment</span></code><span class="koboSpan" id="kobo.3129.1"> application and modify it to make it look like this:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3130.1">import</span></span><span class="koboSpan" id="kobo.3131.1"> stripe
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3132.1">from</span></span><span class="koboSpan" id="kobo.3133.1"> django.conf </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3134.1">import</span></span><span class="koboSpan" id="kobo.3135.1"> settings
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3136.1">from</span></span><span class="koboSpan" id="kobo.3137.1"> django.http </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3138.1">import</span></span><span class="koboSpan" id="kobo.3139.1"> HttpResponse
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3140.1">from</span></span><span class="koboSpan" id="kobo.3141.1"> django.views.decorators.csrf </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3142.1">import</span></span><span class="koboSpan" id="kobo.3143.1"> csrf_exempt
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3144.1">from</span></span><span class="koboSpan" id="kobo.3145.1"> orders.models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3146.1">import</span></span><span class="koboSpan" id="kobo.3147.1"> Order
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3148.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3149.1"> .tasks </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3150.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3151.1"> payment_completed</span></strong></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.3152.1">@csrf_exempt</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.3153.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3154.1">stripe_webhook</span></span><span class="koboSpan" id="kobo.3155.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3156.1">request</span></span><span class="koboSpan" id="kobo.3157.1">):
    payload = request.body
    sig_header = request.META[</span><span class="hljs-string"><span class="koboSpan" id="kobo.3158.1">'HTTP_STRIPE_SIGNATURE'</span></span><span class="koboSpan" id="kobo.3159.1">]
    event = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.3160.1">None</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.3161.1">try</span></span><span class="koboSpan" id="kobo.3162.1">:
        event = stripe.Webhook.construct_event(
            payload, sig_header, settings.STRIPE_WEBHOOK_SECRET
        )
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3163.1">except</span></span><span class="koboSpan" id="kobo.3164.1"> ValueError </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3165.1">as</span></span><span class="koboSpan" id="kobo.3166.1"> e:
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.3167.1"># Invalid payload</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.3168.1">return</span></span><span class="koboSpan" id="kobo.3169.1"> HttpResponse(status=</span><span class="hljs-number"><span class="koboSpan" id="kobo.3170.1">400</span></span><span class="koboSpan" id="kobo.3171.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3172.1">except</span></span><span class="koboSpan" id="kobo.3173.1"> stripe.error.SignatureVerificationError </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3174.1">as</span></span><span class="koboSpan" id="kobo.3175.1"> e:
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.3176.1"># Invalid signature</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.3177.1">return</span></span><span class="koboSpan" id="kobo.3178.1"> HttpResponse(status=</span><span class="hljs-number"><span class="koboSpan" id="kobo.3179.1">400</span></span><span class="koboSpan" id="kobo.3180.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3181.1">if</span></span><span class="koboSpan" id="kobo.3182.1"> event.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3183.1">type</span></span><span class="koboSpan" id="kobo.3184.1"> == </span><span class="hljs-string"><span class="koboSpan" id="kobo.3185.1">'checkout.session.completed'</span></span><span class="koboSpan" id="kobo.3186.1">:
        session = event.data.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3187.1">object</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.3188.1">if</span></span><span class="koboSpan" id="kobo.3189.1"> (
            session.mode == </span><span class="hljs-string"><span class="koboSpan" id="kobo.3190.1">'payment'</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.3191.1">and</span></span><span class="koboSpan" id="kobo.3192.1"> session.payment_status == </span><span class="hljs-string"><span class="koboSpan" id="kobo.3193.1">'paid'</span></span><span class="koboSpan" id="kobo.3194.1">
        ):
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3195.1">try</span></span><span class="koboSpan" id="kobo.3196.1">:
                order = Order.objects.get(
                    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3197.1">id</span></span><span class="koboSpan" id="kobo.3198.1">=session.client_reference_id
                )
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3199.1">except</span></span><span class="koboSpan" id="kobo.3200.1"> Order.DoesNotExist:
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3201.1">return</span></span><span class="koboSpan" id="kobo.3202.1"> HttpResponse(status=</span><span class="hljs-number"><span class="koboSpan" id="kobo.3203.1">404</span></span><span class="koboSpan" id="kobo.3204.1">)
            </span><span class="hljs-comment"><span class="koboSpan" id="kobo.3205.1"># mark order as paid</span></span><span class="koboSpan" id="kobo.3206.1">
            order.paid = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.3207.1">True</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.3208.1"># store Stripe payment ID</span></span><span class="koboSpan" id="kobo.3209.1">
            order.stripe_id = session.payment_intent
            order.save()
            </span><span class="code-highlight"><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.3210.1"># launch asynchronous task</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3211.1">            payment_completed.delay(order.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.3212.1">id</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3213.1">)</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.3214.1">return</span></span><span class="koboSpan" id="kobo.3215.1"> HttpResponse(status=</span><span class="hljs-number"><span class="koboSpan" id="kobo.3216.1">200</span></span><span class="koboSpan" id="kobo.3217.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3218.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3219.1">payment_completed</span></code><span class="koboSpan" id="kobo.3220.1"> task is queued by calling its </span><code class="inlineCode"><span class="koboSpan" id="kobo.3221.1">delay()</span></code><span class="koboSpan" id="kobo.3222.1"> method. </span><span class="koboSpan" id="kobo.3222.2">The task will be added to the queue and executed asynchronously by a Celery worker as soon as possible.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3223.1">Now, you can complete a </span><a id="_idIndexMarker921"/><span class="koboSpan" id="kobo.3224.1">new checkout process in order to receive the PDF invoice in your email. </span><span class="koboSpan" id="kobo.3224.2">If you are using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3225.1">console.EmailBackend</span></code><span class="koboSpan" id="kobo.3226.1"> for your email backend, in the shell where you are running Celery, you will be able to see the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.3227.1">MIME-Version: 1.0
Subject: My Shop - Invoice no. </span><span class="koboSpan" id="kobo.3227.2">7
From: admin@myshop.com
To: email@domain.com
Date: Wed, 3 Jan 2024 20:15:24 -0000
Message-ID: &lt;164841212458.94972.10344068999595916799@amele-mbp.home&gt;
--===============8908668108717577350==
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Please, find attached the invoice for your recent purchase.
</span><span class="koboSpan" id="kobo.3227.3">--===============8908668108717577350==
Content-Type: application/pdf
MIME-Version: 1.0
Content-Transfer-Encoding: base64
Content-Disposition: attachment; filename="order_7.pdf"
JVBERi0xLjcKJfCflqQKMSAwIG9iago8PAovVHlwZSA...
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3228.1">This output shows that the email contains an attachment. </span><span class="koboSpan" id="kobo.3228.2">You have learned how to attach files to emails </span><a id="_idIndexMarker922"/><span class="koboSpan" id="kobo.3229.1">and send them programmatically.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3230.1">Congratulations! </span><span class="koboSpan" id="kobo.3230.2">You have completed the Stripe integration and have added valuable functionality to your shop.</span></p>
<h1 class="heading-1" id="_idParaDest-281"><span class="koboSpan" id="kobo.3231.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3232.1">In this chapter, you integrated the Stripe payment gateway into your project and created a webhook endpoint to receive payment notifications. </span><span class="koboSpan" id="kobo.3232.2">You built a custom administration action to export orders to CSV. </span><span class="koboSpan" id="kobo.3232.3">You also customized the Django administration site using custom views and templates. </span><span class="koboSpan" id="kobo.3232.4">Finally, you learned how to generate PDF files with WeasyPrint and how to attach them to emails.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3233.1">The next chapter will teach you how to create a coupon system using Django sessions, and you will build a product recommendation engine with Redis.</span></p>
<h1 class="heading-1" id="_idParaDest-282"><span class="koboSpan" id="kobo.3234.1">Additional resources</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3235.1">The following resources provide additional information related to the topics covered in this chapter:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.3236.1">Source code for this chapter: </span><a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter09"><span class="url"><span class="koboSpan" id="kobo.3237.1">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter09</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3238.1">Stripe website: </span><a href="https://www.stripe.com/"><span class="url"><span class="koboSpan" id="kobo.3239.1">https://www.stripe.com/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3240.1">Stripe Checkout documentation: </span><a href="https://stripe.com/docs/payments/checkout"><span class="url"><span class="koboSpan" id="kobo.3241.1">https://stripe.com/docs/payments/checkout</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3242.1">Creating a Stripe account: </span><a href="https://dashboard.stripe.com/register"><span class="url"><span class="koboSpan" id="kobo.3243.1">https://dashboard.stripe.com/register</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3244.1">Stripe account settings: </span><a href="https://dashboard.stripe.com/settings/account"><span class="url"><span class="koboSpan" id="kobo.3245.1">https://dashboard.stripe.com/settings/account</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3246.1">Stripe Python library: </span><a href="https://github.com/stripe/stripe-python"><span class="url"><span class="koboSpan" id="kobo.3247.1">https://github.com/stripe/stripe-python</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3248.1">Stripe test API keys: </span><a href="https://dashboard.stripe.com/test/apikeys"><span class="url"><span class="koboSpan" id="kobo.3249.1">https://dashboard.stripe.com/test/apikeys</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3250.1">Stripe API keys documentation: </span><a href="https://stripe.com/docs/keys"><span class="url"><span class="koboSpan" id="kobo.3251.1">https://stripe.com/docs/keys</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3252.1">Stripe API version 2024-04-10 release: </span><a href="https://stripe.com/docs/api/events/types"><span class="url"><span class="koboSpan" id="kobo.3253.1">https://stripe.com/docs/upgrades#2024-04-10</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3254.1">Stripe checkout session modes: </span><a href="https://stripe.com/docs/api/checkout/sessions/object#checkout_session_object-mode"><span class="url"><span class="koboSpan" id="kobo.3255.1">https://stripe.com/docs/api/checkout/sessions/object#checkout_session_object-mode</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3256.1">Building absolute URIs with Django: </span><a href="https://docs.djangoproject.com/en/5.0/ref/request-response/#django.http.HttpRequest.build_absolute_uri"><span class="url"><span class="koboSpan" id="kobo.3257.1">https://docs.djangoproject.com/en/5.0/ref/request-response/#django.http.HttpRequest.build_absolute_uri</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3258.1">Creating Stripe sessions: </span><a href="https://stripe.com/docs/api/checkout/sessions/create"><span class="url"><span class="koboSpan" id="kobo.3259.1">https://stripe.com/docs/api/checkout/sessions/create</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3260.1">Stripe-supported currencies: </span><a href="https://stripe.com/docs/currencies"><span class="url"><span class="koboSpan" id="kobo.3261.1">https://stripe.com/docs/currencies</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3262.1">Stripe Payments dashboard: </span><a href="https://dashboard.stripe.com/test/payments"><span class="url"><span class="koboSpan" id="kobo.3263.1">https://dashboard.stripe.com/test/payments</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3264.1">Credit cards for testing payments with Stripe: </span><a href="https://stripe.com/docs/testing"><span class="url"><span class="koboSpan" id="kobo.3265.1">https://stripe.com/docs/testing</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3266.1">Stripe webhooks: </span><a href="https://dashboard.stripe.com/test/webhooks"><span class="url"><span class="koboSpan" id="kobo.3267.1">https://dashboard.stripe.com/test/webhooks</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3268.1">Types of events sent by Stripe: </span><a href="https://stripe.com/docs/api/events/types"><span class="url"><span class="koboSpan" id="kobo.3269.1">https://stripe.com/docs/api/events/types</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3270.1">Installing the Stripe CLI: </span><a href="https://stripe.com/docs/stripe-cli#install "><span class="url"><span class="koboSpan" id="kobo.3271.1">https://stripe.com/docs/stripe-cli#install</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3272.1">Latest Stripe CLI release: </span><a href="https://github.com/stripe/stripe-cli/releases/latest"><span class="url"><span class="koboSpan" id="kobo.3273.1">https://github.com/stripe/stripe-cli/releases/latest</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3274.1">Generating CSV files with Django: </span><a href="https://docs.djangoproject.com/en/5.0/howto/outputting-csv/"><span class="url"><span class="koboSpan" id="kobo.3275.1">https://docs.djangoproject.com/en/5.0/howto/outputting-csv/</span></span></a></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.3276.1">django-import-export</span></code><span class="koboSpan" id="kobo.3277.1"> application: </span><a href="https://django-import-export.readthedocs.io/en/latest/"><span class="url"><span class="koboSpan" id="kobo.3278.1">https://django-import-export.readthedocs.io/en/latest/</span></span></a></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.3279.1">django-import-export-celery</span></code><span class="koboSpan" id="kobo.3280.1"> application: </span><a href="https://github.com/auto-mat/django-import-export-celery"><span class="url"><span class="koboSpan" id="kobo.3281.1">https://github.com/auto-mat/django-import-export-celery</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3282.1">Django administration templates: </span><a href="https://github.com/django/django/tree/5.0/django/contrib/admin/templates/admin"><span class="url"><span class="koboSpan" id="kobo.3283.1">https://github.com/django/django/tree/5.0/django/contrib/admin/templates/admin</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3284.1">Outputting PDF files with ReportLab: </span><a href="https://docs.djangoproject.com/en/5.0/howto/outputting-pdf/"><span class="url"><span class="koboSpan" id="kobo.3285.1">https://docs.djangoproject.com/en/5.0/howto/outputting-pdf/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3286.1">Installing WeasyPrint: </span><a href="https://doc.courtbouillon.org/weasyprint/stable/first_steps.html"><span class="url"><span class="koboSpan" id="kobo.3287.1">https://doc.courtbouillon.org/weasyprint/stable/first_steps.html</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3288.1">Static files for this chapter: </span><a href="https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter09/myshop/shop/static"><span class="url"><span class="koboSpan" id="kobo.3289.1">https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter09/myshop/shop/static</span></span></a></li>
</ul>
</div>
</body></html>