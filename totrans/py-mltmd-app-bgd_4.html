<html><head></head><body>
  <div><div><div><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Fun with Animations</h1></div></div></div><div><blockquote class="blockquote"><p>Cartoons have always fascinated the young and old alike. An<em> animation</em> is where the imaginary creatures become alive and take us to a totally different world.</p></blockquote></div><div><blockquote class="blockquote"><p>Animation is a sequence of frames displayed quickly one after the other. This creates an optical illusion where the objects, for instance, appear to be moving around. This chapter will introduce you to the fundamentals of developing animations using Python and Pyglet multimedia application development frameworks. Pyglet is designed to do 3D operations, but we will use it for developing very simple 2D animations in this book.<a id="id136" class="indexterm"/>
</p></blockquote></div><p>In this chapter, we shall:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Learn the basics of Pyglet framework. This will be used to develop code to create or play animations.</li><li class="listitem" style="list-style-type: disc">Learn how to play an existing animation file and create animations using a sequence of images.</li><li class="listitem" style="list-style-type: disc">Work on project 'Bowling animation', where animations can be controlled using inputs from the keyboard.</li><li class="listitem" style="list-style-type: disc">Develop code to create an animation using different regions of a single image.</li></ul></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Work on an exciting project that animates a car moving in a thunderstorm. This project will cover many important things covered throughout this chapter.</li></ul></div><p>So let's get on with it.</p><div><div><div><div><h1 class="title"><a id="ch04lvl1sec01"/>Installation prerequisites</h1></div></div></div><p>We will cover the prerequisites for the installation of Pyglet in this section.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec01"/>Pyglet</h2></div></div></div><p>Pyglet provides an API for multimedia application development using Python. It is an OpenGL-based library, which works on multiple platforms. It is primarily used for developing gaming applications and other graphically-rich applications. Pyglet can be downloaded from<a class="ulink" href="http://www.pyglet.org/download.html"> http://www.pyglet.org/download.html</a>. Install Pyglet version 1.1.4 or later. The Pyglet installation is pretty straightforward.<a id="id137" class="indexterm"/>
</p><div><div><div><div><h3 class="title"><a id="ch04lvl3sec01"/>Windows platform</h3></div></div></div><p>For Windows users, the Pyglet installation is straightforward use the binary distribution<code class="literal"> Pyglet 1.1.4.msi</code> or later.<a id="id138" class="indexterm"/>
</p><div><div><h3 class="title"><a id="note03"/>Note</h3><p>You should have Python 2.6 installed. For Python 2.4, there are some more dependencies. We won't discuss them in this book, because we are using Python 2.6 to build multimedia applications.</p></div></div><p>If you install Pyglet from the source, see the instructions under the next sub-section,<em> Other platforms</em>.</p></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec02"/>Other platforms</h3></div></div></div><p>The Pyglet website provides a binary distribution file for Mac OS X. Download and install<code class="literal"> pyglet-1.1.4.dmg</code> or later.<a id="id139" class="indexterm"/>
</p><p>On Linux, install Pyglet 1.1.4 or later if it is available in the package repository of your operating system. Otherwise, it can be installed from source tarball as follows:<a id="id140" class="indexterm"/>
</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Download and extract the tarball<code class="literal"> pyglet-1.1.4.tar.gz</code> or a later version.</li><li class="listitem" style="list-style-type: disc">Make sure that<code class="literal"> python</code> is a recognizable command in shell. Otherwise, set the<code class="literal"> PYTHONPATH</code> environment variable to the correct Python executable path.</li><li class="listitem" style="list-style-type: disc">In a shell window, change to the mentioned extracted directory and then run the following command:</li></ul></div><div><pre class="programlisting">python setup.py install
</pre></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Review the succeeding installation instructions using the readme/install instruction files in the Pyglet source tarball.</li></ul></div><div><div><h3 class="title"><a id="tip10"/>Tip</h3><p>If you have the package<code class="literal"> setuptools</code> (http://pypi.python.org/pypi/setuptools) installed, the Pyglet installation should be very easy. However, for this, you will need a runtime<code class="literal"> egg</code> of Pyglet. But the<code class="literal"> egg</code> file for Pyglet is not available at<a class="ulink" href="http://pypi.python.org"> http://pypi.python.org</a>. If you get hold of a Pyglet<code class="literal"> egg</code> file, it can be installed by running the following command on Linux or Mac OS X. You will need administrator access to install the package:</p><p>
<code class="literal">$sudo easy_install -U pyglet</code>
</p></div></div></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec02"/>Summary of installation prerequisites</h2></div></div></div><p>The following table illustrates installation prerequisites depending on the version and platform.<a id="id141" class="indexterm"/>
</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Package</p>
</th><th style="text-align: left" valign="bottom">
<p>Download location</p>
</th><th style="text-align: left" valign="bottom">
<p>Version</p>
</th><th style="text-align: left" valign="bottom">
<p>Windows platform</p>
</th><th style="text-align: left" valign="bottom">
<p>Linux/Unix/OS X platforms</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Python</p>
</td><td style="text-align: left" valign="top">
<p>
<a class="ulink" href="http://python.org/download/releases/">http://python.org/download/releases/</a>
</p>
</td><td style="text-align: left" valign="top">
<p>2.6.4 (or any 2.6.x)</p>
</td><td style="text-align: left" valign="top">
<p>Install using binary distribution</p>
</td><td style="text-align: left" valign="top">
<p>Install from binary; also install additional developer packages (For example, with<code class="literal"> python-devel</code> in the package name in a rpm-based Linux distribution).</p>
<p>Build and install from the source tarball.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Pyglet</p>
</td><td style="text-align: left" valign="top">
<p>
<a class="ulink" href="http://www.pyglet.org/download.html">http://www.pyglet.org/download.html</a>
</p>
</td><td style="text-align: left" valign="top">
<p>1.1.4 or later</p>
</td><td style="text-align: left" valign="top">
<p>Install using binary distribution (the<code class="literal"> .msi</code> file)</p>
</td><td style="text-align: left" valign="top">
<p>
<strong>Mac:</strong> Install using disk image file (.dmg file).</p>
<p>
<strong>Linux:</strong> Build and install using the source tarball.</p>
</td></tr></tbody></table></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec03"/>Testing the installation</h2></div></div></div><p>Before proceeding further, ensure that Pyglet is installed properly. To test this, just start Python from the command line and type the following:<a id="id142" class="indexterm"/>
</p><div><pre class="programlisting">&gt;&gt;&gt;import pyglet
</pre></div><p>If this import is successful, we are all set to go!</p></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec02"/>A primer on Pyglet</h1></div></div></div><p>Pyglet provides an API for multimedia application development using Python. It is an OpenGL-based library that works on multiple platforms. It is primarily used for developing gaming and other graphically-rich applications. We will cover some important aspects of Pyglet framework.<a id="id143" class="indexterm"/>
</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec04"/>Important components</h2></div></div></div><p>We will briefly discuss some of the important modules and packages of Pyglet that we will use. Note that this is just a tiny chunk of the Pyglet framework. Please review the Pyglet documentation to know more about its capabilities, as this is beyond the scope of this book.</p><div><div><div><div><h3 class="title"><a id="ch04lvl3sec03"/>Window</h3></div></div></div><p>The<code class="literal"> pyglet.window.Window</code> module provides the user interface. It is used to create a window with an OpenGL context. The<code class="literal"> Window</code> class has API methods to handle various events such as mouse and keyboard events. The window can be viewed in normal or full screen mode. Here is a simple example of creating a<code class="literal"> Window</code> instance. You can define a size by specifying<code class="literal"> width</code> and<code class="literal"> height</code> arguments in the constructor.<a id="id144" class="indexterm"/>
</p><div><pre class="programlisting">win = pyglet.window.Window()
</pre></div><p>The background color for the image can be set using OpenGL call<code class="literal"> glClearColor</code>, as follows:</p><div><pre class="programlisting">pyglet.gl.glClearColor(1, 1, 1, 1)
</pre></div><p>This sets a white background color. The first three arguments are the red, green, and blue color values. Whereas, the last value represents the alpha. The following code will set up a gray background color.</p><div><pre class="programlisting">pyglet.gl.glClearColor(0.5, 0.5, 0.5, 1)
</pre></div><p>The following illustration shows a screenshot of an empty window with a gray background color.</p><div><img src="img/0165_4_1.jpg" alt="Window"/></div></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec04"/>Image</h3></div></div></div><p>The<code class="literal"> pyglet.image</code> module enables the drawing of images on the screen. The following code snippet shows a way to create an image and display it at a specified position within the Pyglet window.<a id="id145" class="indexterm"/>
</p><div><pre class="programlisting">img = pyglet.image.load('my_image.bmp')
x, y, z = 0, 0, 0
img.blit(x, y, z)
</pre></div><p>A later section will cover some important operations supported by the<code class="literal"> pyglet.image</code> module.</p></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec05"/>Sprite</h3></div></div></div><p>This is another important module. It is used to display an image or an animation frame within a Pyglet window discussed earlier. It is an image instance that allows us to position an image anywhere within the Pyglet window. A<code class="literal"> sprite</code> can also be rotated and scaled. It is possible to create multiple sprites of the same image and place them at different locations and with different orientations inside the window.<a id="id146" class="indexterm"/>
</p></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec06"/>Animation</h3></div></div></div><p>
<code class="literal">Animation</code> module is a part of<code class="literal"> pyglet.image</code> package. As the name indicates,<code class="literal"> pyglet.image.Animation</code> is used to create an animation from one or more image frames. There are different ways to create an animation. For example, it can be created from a sequence of images or using<code class="literal"> AnimationFrame</code> objects. We will study these techniques later in the chapter. An animation sprite can be created and displayed within the Pyglet window.<a id="id147" class="indexterm"/>
</p></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec07"/>AnimationFrame</h3></div></div></div><p>This creates a single frame of an animation from a given image. An animation can be created from such<code class="literal"> AnimationFrame</code> objects. The following line of code shows an example.<a id="id148" class="indexterm"/>
</p><div><pre class="programlisting">animation = pyglet.image.Animation(anim_frames)
</pre></div><p>
<code class="literal">anim_frames</code> is a list containing instances of<code class="literal"> AnimationFrame</code>.</p></div><div><div><div><div><h3 class="title"><a id="ch04lvl3sec08"/>Clock</h3></div></div></div><p>Among many other things, this module is used for scheduling functions to be called at a specified time. For example, the following code calls a method<code class="literal"> moveObjects</code> ten times every second.<a id="id149" class="indexterm"/>
</p><div><pre class="programlisting">pyglet.clock.schedule_interval(moveObjects, 1.0/10)
</pre></div></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec05"/>Displaying an image</h2></div></div></div><p>In the<em> Image</em> sub-section, we learned how to load an image using<code class="literal"> image.blit</code>. However, image<em> blitting</em> is a less efficient way of drawing images. There is a better and preferred way to display the image by creating an instance of<code class="literal"> Sprite</code>. Multiple<code class="literal"> Sprite</code> objects can be created for drawing the same image. For example, the same image might need to be displayed at various locations within the window. Each of these images should be represented by separate<code class="literal"> Sprite</code> instances. The following simple program just loads an image and displays the<code class="literal"> Sprite</code> instance representing this image on the screen.<a id="id150" class="indexterm"/>
</p><div><pre class="programlisting">1 import pyglet
2
3 car_img= pyglet.image.load('images/car.png')
4 carSprite = pyglet.sprite.Sprite(car_img)
5 window = pyglet.window.Window()
6 pyglet.gl.glClearColor(1, 1, 1, 1)
7
8 @window.event
9 def on_draw():
10 window.clear()
11 carSprite.draw()
12
13 pyglet.app.run()
</pre></div><p>On line 3, the image is opened using<code class="literal"> pyglet.image.load</code> call. A<code class="literal"> Sprite</code> instance corresponding to this image is created on line 4. The code on line 6 sets white background for the window. The<code class="literal"> on_draw</code> is an API method that is called when the window needs to be redrawn. Here, the image sprite is drawn on the screen. The next illustration shows a loaded image within a Pyglet window.<a id="id151" class="indexterm"/>
</p><div><div><h3 class="title"><a id="tip11"/>Tip</h3><p>In various examples in this chapter and others, the file path strings are hardcoded. We have used forward slashes for the file path. Although this works on Windows platform, the convention is to use backward slashes. For example,<code class="literal"> images/car.png</code> is represented as<code class="literal"> images\car.png</code>. Additionally, you can also specify a complete path to the file by using the<code class="literal"> os.path.join</code> method in Python. Regardless of what slashes you use, the<code class="literal"> os.path.normpath</code> will make sure it modifies the slashes to fit to the ones used for the platform. The use of<code class="literal"> os.path.normpath</code> is illustrated in the following snippet:</p><p>
<code class="literal">import os</code>
</p><p>
<code class="literal">original_path = 'C:/images/car.png</code>"</p><p>
<code class="literal">new_path = os.path.normpath(original_path)</code>
</p></div></div><div><img src="img/0165_4_2.jpg" alt="Displaying an image"/></div><p>The preceding image illustrates Pyglet window showing a still image.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec06"/>Mouse and keyboard controls</h2></div></div></div><p>The<code class="literal"> Window</code> module of Pyglet implements some API methods that enable user input to a playing animation. The API methods such as<code class="literal"> on_mouse_press</code> and<code class="literal"> on_key_press</code> are used to capture mouse and keyboard events during the animation. These methods can be overridden to perform a specific operation.<a id="id152" class="indexterm"/>
</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec07"/>Adding sound effects</h2></div></div></div><p>The<code class="literal"> media</code> module of Pyglet supports audio and video playback. The following code loads a media file and plays it during the animation.<a id="id153" class="indexterm"/>
</p><div><pre class="programlisting">1 background_sound = pyglet.media.load(
2 'C:/AudioFiles/background.mp3',
3 streaming=False)
4 background_sound.play()
</pre></div><p>The second optional argument provided on line 3 decodes the media file completely in the memory at the time the media is loaded. This is important if the media needs to be played several times during the animation. The API method<code class="literal"> play()</code> starts streaming the specified media file.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec03"/>Animations with Pyglet</h1></div></div></div><p>The Pyglet framework provides a number of modules required to develop animations. Many of these were discussed briefly in earlier sections. Lets now learn techniques to create 2D animations using Pyglet.<a id="id154" class="indexterm"/>
</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec08"/>Viewing an existing animation</h2></div></div></div><p>If you already have an animation in, for example,<code class="literal"> .gif</code> file format, it can be loaded and displayed directly with Pyglet. The API method to use here is<code class="literal"> pyglet.image.load_animation</code>.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec04"/>Time for action -  viewing an existing animation</h1></div></div></div><p>This is going to be a short exercise. The goal of this section is to develop a primary understanding on use of Pyglet for viewing animations. So let's get on with it.<a id="id155" class="indexterm"/>
</p><div><ol class="orderedlist arabic"><li class="listitem">Download the file<code class="literal"> SimpleAnimation.py</code> from the Packt website. Also download the file<code class="literal"> SimpleAnimation.gif</code> and place it in a sub-directory<code class="literal"> images</code>. The code is illustrated as follows:<div><pre class="programlisting">1 import pyglet
2
3 animation = pyglet.image.load_animation(
4 "images/SimpleAnimation.gif")
5
6 # Create a sprite object as an instance of this animation.
7 animSprite = pyglet.sprite.Sprite(animation)
8
9 # The main pyglet window with OpenGL context
10 w = animSprite.width
11 h = animSprite.height
12 win = pyglet.window.Window(width=w, height=h)
13
14 # r,g b, color values and transparency for the background
15 r, g, b, alpha = 0.5, 0.5, 0.8, 0.5
16
17 # OpenGL method for setting the background.
18 pyglet.gl.glClearColor(r, g, b, alpha)
19
20 # Draw the sprite in the API method on_draw of
21 # pyglet.Window
22 @win.event
23 def on_draw():
24 win.clear()
25 animSprite.draw()
26
27 pyglet.app.run()
</pre></div></li><li class="listitem">The code is self-explanatory. On line 3, the API method image.load_animation creates an instance of class image.Animation using the specified animation file. For this animation, a Sprite object is created on line 7. The Pyglet window created on line 12 will be used to display the animation. The size of this window is specified by the height and width of the animSprite. The background color for the window is set using OpenGL call glClearColor.<a id="id156" class="indexterm"/></li><li class="listitem">Next, we need to draw this animation sprite into the Pyglet window. The<code class="literal"> pyglet.window</code> defines API method<code class="literal"> on_draw</code> which gets called when an event occurs. The call to the<code class="literal"> draw()</code> method of animation<code class="literal"> Sprite</code> is made on line 25 to render the animation on screen. The code on line 22 is important. The<code class="literal"> decorator, @win.event</code> allows us to modify the<code class="literal"> on_draw</code> API method of<code class="literal"> pyglet.window.Window</code> when an event occurs. Finally code on line 27 runs this application.<div><div><h3 class="title"><a id="tip12"/>Tip</h3><p>You can create your own animation file like<code class="literal"> SimpleAnimation.gif</code> using freely available image editing software packages like GIMP. This animation file was created using GIMP 2.6.7, by drawing each of the characters on a separate layer and then blending all the layers using<strong> Filters</strong> |<strong> Animation</strong> |<strong> Blend</strong>.</p></div></div></li><li class="listitem">Put the file<code class="literal"> SimpleAnimation.py</code> along with the animation file<code class="literal"> SimpleAnimation.gif</code> in the same directory and then run the program as follows:<div><pre class="programlisting">$python SimpleAnimation.py
</pre></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">This will show the animation in a Pyglet window. You can use a different animation file instead of SimpleAnimation.gif. Just modify the related code in this file or add code to accept any GIF file as a command-line argument for this program. The next illustration shows some of the frames from this animation at different time intervals.</li></ul></div><div><img src="img/0165_4_3.jpg" alt="Time for action - viewing an existing animation"/></div><div><img src="img/0165_4_4.jpg" alt="Time for action - viewing an existing animation"/></div><div><img src="img/0165_4_5.jpg" alt="Time for action - viewing an existing animation"/></div><div><img src="img/0165_4_6.jpg" alt="Time for action - viewing an existing animation"/></div><p>The preceding image is a screen capture of a running animation at different time intervals.<a id="id157" class="indexterm"/>
</p></li></ol></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec09"/>What just happened?</h2></div></div></div><p>We worked out an example where an already created animation file was loaded and viewed using Pyglet. This short exercise taught us some preliminary things about viewing animations using Pyglet. For example, we learned how to create a Pyglet window and load an animation using<code class="literal"> pyglet.Sprite</code> object. These fundamentals will be used throughout this chapter.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec10"/>Animation using a sequence of images</h2></div></div></div><p>The API method<code class="literal"> Animation.from_image_sequence</code> enables creation of an animation using a bunch of sequential images. Each of the images is displayed as a frame in the animation, one after the other. The time for which each frame is displayed can be specified as an argument while creating the animation object. It can also be set after the animation instance is created.<a id="id158" class="indexterm"/>
</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec05"/>Time for action -  animation using a sequence of images</h1></div></div></div><p>Let's develop a tool that can create an animation and display it on the screen. This tool will create and display the animation using the given image files. Each of the image files will be displayed as a frame in the animation for a specified amount of time. This is going to be a fun little animation that shows a grandfather clock with a pendulum. We will animate the pendulum oscillations with other things, including making the dial remaining still. This animation has only three image frames; two of them show the pendulum at opposite extremes. These images are sequenced as shown in the next illustration.<a id="id159" class="indexterm"/>
</p><div><img src="img/0165_4_7.jpg" alt="Time for action - animation using a sequence of images"/></div><div><img src="img/0165_4_8.jpg" alt="Time for action - animation using a sequence of images"/></div><div><img src="img/0165_4_9.jpg" alt="Time for action - animation using a sequence of images"/></div><p>Clock image frames to be animated appear in the preceding image.</p><div><ol class="orderedlist arabic"><li class="listitem">Download the file<code class="literal"> ImageSequenceAnimation.py</code> from the Packt website.</li><li class="listitem">The code in this file is presented below.<div><pre class="programlisting">1 import pyglet
2
3 image_frames = ('images/clock1.png',
4 'images/clock2.png',
5 'images/clock3.png')
6
7 # Create the list of pyglet images
8 images = map(lambda img: pyglet.image.load(img),
9 image_frames)
10
11 # Each of the image frames will be displayed for 0.33
12 # seconds
13 # 0.33 seconds chosen so that the 'pendulam in the clock
14 # animation completes one oscillation in ~ 1 second !
15
16 animation = pyglet.image.Animation.from_image_sequence(
17 images, 0.33)
18 # Create a sprite instance.
19 animSprite = pyglet.sprite.Sprite(animation)
20
21 # The main pyglet window with OpenGL context
22 w = animSprite.width
23 h = animSprite.height
24 win = pyglet.window.Window(width=w, height=h)
25
26 # Set window background color to white.
27 pyglet.gl.glClearColor(1, 1, 1, 1)
28
29 # The @win.event is a decorator that helps modify the API
30 # methods such as
31 # on_draw called when draw event occurs.
32 @win.event
33 def on_draw():
34 win.clear()
35 animSprite.draw()
36
37 pyglet.app.run()
</pre></div></li><li class="listitem">The tuple, image_frames contains the paths for the images. The map function call on line 8 creates pyglet.image objects corresponding to each of the image paths and stores the resultant images in a list. On line 16, the animation is created using the API method Animation.from_image_sequence. This method takes the list of image objects as an argument. The other optional argument is the time in seconds for which each of the frames will be shown. We set this time as 0.33 seconds per image so that the total time for a complete animation loop is nearly 1 second. Thus, in the animation, one complete oscillation of the pendulum will be complete in about one second. We already discussed the rest of the code in an earlier section.<a id="id160" class="indexterm"/><div><pre class="programlisting">$python ImageSequenceAnimation.py
</pre></div></li><li class="listitem">Place the image files in a sub-directory<code class="literal"> images</code> within the directory in which file<code class="literal"> ImageSequenceAnimation.py</code> is placed. Then run the program using:<a id="id161" class="indexterm"/><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">You will see a clock with an oscillating pendulum in the window. The animation will continue in a loop and closing the window will end it.</li></ul></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec11"/>What just happened?</h2></div></div></div><p>By rapidly displaying still images, we just created something like a 'flipbook' cartoon! We developed a simple utility that takes a sequence of images as an input and creates an animation using Pyglet. To accomplish this task, we used<code class="literal"> Animation.from_image_sequence</code> to create the animation and re-used most of the framework from the<em> Viewing an existing animation</em> section.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec12"/>Single image animation</h2></div></div></div><p>Imagine that you are creating a cartoon movie where you want to animate the motion of an arrow or a bullet hitting a target. In such cases, typically it is just a single image. The desired animation effect is accomplished by performing appropriate translation or rotation of the image.<a id="id162" class="indexterm"/>
</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec06"/>Time for action -  bouncing ball animation</h1></div></div></div><p>Lets create a simple animation of a 'bouncing ball'. We will use a single image file,<code class="literal"> ball.png</code>, which can be downloaded from the Packt website. The dimensions of this image in pixels are 200x200, created on a transparent background. The following screenshot shows this image opened in GIMP image editor. The three dots on the ball identify its side. We will see why this is needed. Imagine this as a ball used in a bowling game.<a id="id163" class="indexterm"/>
</p><div><img src="img/0165_4_10.jpg" alt="Time for action - bouncing ball animation"/></div><p>The image of a ball opened in GIMP appears as shown in the preceding image. The ball size in pixels is 200x200.<a id="id164" class="indexterm"/>
</p><div><ol class="orderedlist arabic"><li class="listitem">Download the files<code class="literal"> SingleImageAnimation.py</code> and<code class="literal"> ball.png</code> from the Packt website. Place the<code class="literal"> ball.png</code> file in a sub-directory 'images' within the directory in which<code class="literal"> SingleImageAnimation.py</code> is saved.</li><li class="listitem">The following code snippet shows the overall structure of the code.<div><pre class="programlisting">1 import pyglet
2 import time
3
4 class SingleImageAnimation(pyglet.window.Window):
5 def __init__(self, width=600, height=600):
6 pass
7 def createDrawableObjects(self):
8 pass
9 def adjustWindowSize(self):
10 pass
11 def moveObjects(self, t):
12 pass
13 def on_draw(self):
14 pass
15 win = SingleImageAnimation()
16 # Set window background color to gray.
17 pyglet.gl.glClearColor(0.5, 0.5, 0.5, 1)
18
19 pyglet.clock.schedule_interval(win.moveObjects, 1.0/20)
20
21 pyglet.app.run()
</pre></div></li><li class="listitem">Although it is not required, we will encapsulate event handling and other functionality within a class SingleImageAnimation. The program to be developed is short, but in general, it is a good coding practice. It will also be good for any future extension to the code. An instance of SingleImageAnimation is created on line 14. This class is inherited from pyglet.window.Window. It encapsulates the functionality we need here. The API method on_draw is overridden by the class. on_draw is called when the window needs to be redrawn. Note that we no longer need a decorator statement such as @win.event above the on_draw method because the window API method is simply overridden by this inherited class.<a id="id165" class="indexterm"/></li><li class="listitem">The constructor of the class<code class="literal"> SingleImageAnimation</code> is as follows:<div><pre class="programlisting">1 def __init__(self, width=None, height=None):
2 pyglet.window.Window.__init__(self,
3 width=width,
4 height=height,
5 resizable = True)
6 self.drawableObjects = []
7 self.rising = False
8 self.ballSprite = None
9 self.createDrawableObjects()
10 self.adjustWindowSize()
</pre></div></li><li class="listitem">As mentioned earlier, the class SingleImageAnimation inherits pyglet.window.Window. However, its constructor doesn't take all the arguments supported by its super class. This is because we don't need to change most of the default argument values. If you want to extend this application further and need these arguments, you can do so by adding them as __init__ arguments. The constructor initializes some instance variables and then calls methods to create the animation sprite and resize the window respectively.</li><li class="listitem">The method<code class="literal"> createDrawableObjects</code> creates a sprite instance using the<code class="literal"> ball.png</code> image.<div><pre class="programlisting">1 def createDrawableObjects(self):
2 """
3 Create sprite objects that will be drawn within the
4 window.
5 """
6 ball_img= pyglet.image.load('images/ball.png')
7 ball_img.anchor_x = ball_img.width / 2
8 ball_img.anchor_y = ball_img.height / 2
9
10 self.ballSprite = pyglet.sprite.Sprite(ball_img)
11 self.ballSprite.position = (
12 self.ballSprite.width + 100,
13 self.ballSprite.height*2 - 50)
14 self.drawableObjects.append(self.ballSprite)
</pre></div></li><li class="listitem">The anchor_x and anchor_y properties of the image instance are set such that the image has an anchor exactly at its center. This will be useful while rotating the image later. On line 10, the sprite instance self.ballSprite is created. Later, we will be setting the width and height of the Pyglet window as twice of the sprite width and thrice of the sprite height. The position of the image within the window is set on line 11. The initial position is chosen as shown in the next screenshot. In this case, there is only one Sprite instance. However, to make the program more general, a list of drawable objects called self.drawableObjects is maintained.<a id="id166" class="indexterm"/></li><li class="listitem">To continue the discussion from the previous step, we will now review the<code class="literal"> on_draw</code> method.<div><pre class="programlisting">def on_draw(self):
self.clear()
for d in self.drawableObjects:
d.draw()
</pre></div></li><li class="listitem">As mentioned previously, the on_draw function is an API method of class pyglet.window.Window that is called when a window needs to be redrawn. This method is overridden here. The self.clear() call clears the previously drawn contents within the window. Then, all the Sprite objects in the list self.drawableObjects are drawn in the for loop.<div><img src="img/0165_4_11.jpg" alt="Time for action - bouncing ball animation"/></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">The preceding image illustrates the initial ball position in the animation.<a id="id167" class="indexterm"/></li></ul></div></li><li class="listitem">The method<code class="literal"> adjustWindowSize</code> sets the<code class="literal"> width</code> and<code class="literal"> height</code> parameters of the Pyglet window. The code is self-explanatory:<div><pre class="programlisting">def adjustWindowSize(self):
w = self.ballSprite.width * 3
h = self.ballSprite.height * 3
self.width = w
self.height = h
</pre></div></li><li class="listitem">So far, we have set up everything for the animation to play. Now comes the fun part. We will change the position of the sprite representing the image to achieve the animation effect. During the animation, the image will also be rotated, to give it the natural feel of a bouncing ball.<div><pre class="programlisting">1 def moveObjects(self, t):
2 if self.ballSprite.y - 100 &lt; 0:
3 self.rising = True
4 elif self.ballSprite.y &gt; self.ballSprite.height*2 - 50:
5 self.rising = False
6
7 if not self.rising:
8 self.ballSprite.y -= 5
9 self.ballSprite.rotation -= 6
10 else:
11 self.ballSprite.y += 5
12 self.ballSprite.rotation += 5
</pre></div></li><li class="listitem">This method is scheduled to be called 20 times per second using the following code in the program.<div><pre class="programlisting">pyglet.clock.schedule_interval(win.moveObjects, 1.0/20)
</pre></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">To start with, the ball is placed near the top. The animation should be such that it gradually falls down, hits the bottom, and bounces back. After this, it continues its upward journey to hit a boundary somewhere near the top and again it begins its downward journey. The code block from lines 2 to 5 checks the current y position of self.ballSprite. If it has hit the upward limit, the flag self.rising is set to False. Likewise, when the lower limit is hit, the flag is set to True. The flag is then used by the next code snippet to increment or decrement the y position of self.ballSprite.<a id="id168" class="indexterm"/></li></ul></div></li><li class="listitem">The highlighted lines of code rotate the<code class="literal"> Sprite</code> instance. The current rotation angle is incremented or decremented by the given value. This is the reason why we set the image anchors,<code class="literal"> anchor_x</code> and<code class="literal"> anchor_y</code> at the center of the image. The<code class="literal"> Sprite</code> object honors these image anchors. If the anchors are not set this way, the ball will be seen wobbling in the resultant animation.</li><li class="listitem">Once all the pieces are in place, run the program from the command line as:<div><pre class="programlisting">$python SingleImageAnimation.py
</pre></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">This will pop up a window that will play the bouncing ball animation. The next illustration shows some intermediate frames from the animation while the ball is falling down.<a id="id169" class="indexterm"/><div><img src="img/0165_4_11.jpg" alt="Time for action - bouncing ball animation"/></div><div><img src="img/0165_4_12.jpg" alt="Time for action - bouncing ball animation"/></div><div><img src="img/0165_4_13.jpg" alt="Time for action - bouncing ball animation"/></div><div><img src="img/0165_4_14.jpg" alt="Time for action - bouncing ball animation"/></div></li></ul></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec13"/>What just happened?</h2></div></div></div><p>We learned how to create an animation using just a single image. The image of a ball was represented by a sprite instance. This sprite was then translated and rotated on the screen to accomplish a bouncing ball animation. The whole functionality, including the event handling, was encapsulated in the class<code class="literal"> SingleImageAnimation</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec14"/>Project: a simple bowling animation</h2></div></div></div><p>It's time for a small project. We will re-use most of the code we used in the<em> Single Image Animation</em> section and some more stuff to create an animation where a rolling ball hits a pin in a bowling game. Although this chapter covers animation, this project will give you a preliminary understanding on how to turn an animation into a game. This is not a real game as such, but it will involve some user interactions to control the animation.<a id="id170" class="indexterm"/>
</p><div><img src="img/0165_4_15.jpg" alt="Project: a simple bowling animation"/></div><p>The starting position in the bowling animation, showing ball and pin images.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec07"/>Time for action -  a simple bowling animation</h1></div></div></div><p>Let's develop the code for this application. As mentioned earlier, a big chunk of the code comes from the<em> Single Image Animation</em> section. So we will only discuss the new and modified methods needed to create a bowling animation.</p><div><ol class="orderedlist arabic"><li class="listitem">Download the Python source file<code class="literal"> BowlingAnimation.py</code> from the Packt website. The overall class design is the same as the one developed in the<em> Single Image Animation</em> section. We will only discuss the new and modified methods. You can review the rest of the code from this file.</li><li class="listitem">Also, download the image files used in this project. These files are<code class="literal"> ball.png</code> and<code class="literal"> pin.png</code>. Place these files in a sub-directory<code class="literal"> images</code>. The<code class="literal"> images</code> directory should be placed in the directory in which the above Python source file is located.</li><li class="listitem">The<code class="literal"> __init__</code> method of the class is identical to that of class<code class="literal"> SingleImageAnimation</code>. The only change here is that it initializes the following flags:<a id="id171" class="indexterm"/><div><pre class="programlisting">self.paused = False
self.pinHorizontal = False
</pre></div></li><li class="listitem">The flag self.pinHorizontal is used later to check if the pin is knocked out by the ball. Whereas, self.paused is used to pause or resume the animation depending on its value.</li><li class="listitem">The<code class="literal"> createDrawable</code> object method is modified to create a sprite instance for the pin image. Also, the position of the ball and pin sprites are adjusted for our animation needs. The code is presented as follows:<div><pre class="programlisting">1 def createDrawableObjects(self):
2 ball_img= pyglet.image.load('images/ball.png')
3 ball_img.anchor_x = ball_img.width / 2
4 ball_img.anchor_y = ball_img.height / 2
5
6 pin_img = pyglet.image.load('images/pin.png')
7 pin_img.anchor_x = pin_img.width / 2
8 pin_img.anchor_y = pin_img.height / 2
9
10 self.ballSprite = pyglet.sprite.Sprite(ball_img)
11 self.ballSprite.position = (0 + 100,
12 self.ballSprite.height)
13
14 self.pinSprite = pyglet.sprite.Sprite(pin_img)
15 self.pinSprite.position = (
16 (self.ballSprite.width*2 + 100,
17 self.ballSprite.height) )
18
19 # Add these sprites to the list of drawables
20 self.drawableObjects.append(self.ballSprite)
21 self.drawableObjects.append(self.pinSprite)
</pre></div></li><li class="listitem">The code block 6-8 creates an image instance for the pin image and then sets the image anchor at its center. The Sprite instances representing ball and pin images are created on lines 10 and 14 respectively. Their positions are set such that the initial positions appear as shown in the earlier illustration. Finally these sprites are added to the list of drawable objects that are drawn in on_draw method.</li><li class="listitem">Next, let's review the<code class="literal"> moveObjects</code> method. As before, this method is called every<code class="literal"> 0.05</code> seconds.<div><pre class="programlisting">1 def moveObjects(self, t):
2 if self.pinHorizontal:
3 self.ballSprite.x = 100
4 self.pinSprite.x -= 100
5
6 if self.ballSprite.x &lt; self.ballSprite.width*2:
7 if self.ballSprite.x == 100:
8 time.sleep(1)
9 self.pinSprite.rotation = 0
10 self.pinHorizontal = False
11
12 self.ballSprite.x += 5
13 self.ballSprite.rotation += 5
14
15 if self.ballSprite.x &gt;= self.ballSprite.width*2:
16 self.pinSprite.rotation = 90
17 self.pinSprite.x += 100
18 self.pinHorizontal = True
</pre></div></li><li class="listitem">The if block, from lines 6 to 13, is called for when the x position of the ball sprite is between 100 pixels to twice the width of the self.ballSprite. On line 12, the x position of self.ballSprite is incremented by 5 pixels. Also, the sprite is rotated by 5 degrees. The combination of these two transforms creates an effect where we see the ball rolling horizontally, from left to right, inside the Pyglet window. As seen earlier, the center of the pin is located at x = self.ballSprite.width*2 + 100 and y = self.ballSprite.height.<a id="id172" class="indexterm"/><p>The if block from lines 15 to 18 is where the ball appears to have hit the pin. That is, the x coordinate of ball sprite center is about 100 pixels away from the center of the pin. The 100-pixel value is chosen to account for the ball radius. Therefore, once the ball hits the pin, the pin image is rotated by 90 degrees (line 16). This creates a visual effect where the pin appears to be knocked down by the ball. The x coordinate of the pin is incremented by 100 pixels so that, after the pin rotation, the ball and pin images don't overlap. You can do some more improvement here. Shift the y position of the pin sprite further down, so that the pin appears lying on the ground. In this if block, we also set the flag self.pinHorizontal to True. When the moveObjects method is called the next time, the first thing that is checked is whether the pin is vertical or horizontal. If the pin is horizontal, the original positions of the ball and pin are restored by the code on lines 2 to 4. This is a preparation for the next animation loop. On line 9, the pin is rotated back to 0 degree, whereas on line 10, the flag self.pinHorizontal is reset to False.
</p></li><li class="listitem">With the code we developed so far, and with the remaining code from class<code class="literal"> SingleImageAnimation</code>, if you run the program, it will show the bowling animation. Now let's add some controls to this animation. A flag,<code class="literal"> self.paused</code>, was initialized in the constructor. It will be used here. Just like<code class="literal"> on_draw, on_key_press</code> is another API method of<code class="literal"> pyglet.window.Window</code>. It is overridden here to implement pause and resume controls.<a id="id173" class="indexterm"/><div><pre class="programlisting">1 def on_key_press(self, key, modifiers):
2 if key == pyglet.window.key.P and not self.paused:
3 pyglet.clock.unschedule(self.moveObjects)
4 self.paused = True
5 elif key == pyglet.window.key.R and self.paused:
6 pyglet.clock.schedule_interval(
7 self.moveObjects, 1.0/20)
8 self.paused = False
</pre></div></li><li class="listitem">The key argument is one of the keyboard keys pressed by the user. The if block from lines 2 to 4 pauses the animation when P key is pressed. The method self.moveObjects is scheduled to be called every 0.05 seconds. The scheduled callback to this method is canceled using the pyglet.clock.unschedule method. To resume the animation, the schedule_interval method is called on line 6. The self.paused flag ensures that the multiple keypresses won't have any undesirable effect on the animation. For example, if you press the R key multiple times, the code will just ignore the keypress events that follow.</li><li class="listitem">Refer to the file<code class="literal"> BowlingAnimation.py</code> to review or develop the rest of the code and then run the program from the command line as:<div><pre class="programlisting">$python BowlingAnimation.py
</pre></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">This will pop up a window in which the animation will be played. Press the P key on the keyboard to pause the animation. To resume a paused animation, press the R key. The next illustration shows a few intermediate frames in this animation.<div><img src="img/0165_4_16.jpg" alt="Time for action - a simple bowling animation"/></div><div><img src="img/0165_4_17.jpg" alt="Time for action - a simple bowling animation"/></div><div><img src="img/0165_4_18.jpg" alt="Time for action - a simple bowling animation"/></div><div><img src="img/0165_4_19.jpg" alt="Time for action - a simple bowling animation"/></div><p>The intermediate frames in the bowling animation appear as shown in the preceding image.<a id="id174" class="indexterm"/>
</p></li></ul></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec15"/>What just happened?</h2></div></div></div><p>We completed a simple but exciting project where an animation of a bowl hitting a pin was developed. This was accomplished by moving and rotating the image sprites on the screen. Several methods from the<code class="literal"> SingleImageAnimation</code> class were re-used. Additionally, we learned how to control the animation by overriding the<code class="literal"> on_key_press</code> API method.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec16"/>Animations using different image regions</h2></div></div></div><p>It is possible to create an animation using different regions of a single image. Each of these regions can be treated as a separate animation frame. In order to achieve the desired animation effect, it is important to properly create the image with regions. In the following example, the animation will be created using such regions. We will also be using the default position parameters for each of the regions within that image. Thus, our main task in this section is simply to use these regions in their original form and create animation frames out of them. We will first see how the image looks. The following illustration shows this image.<a id="id175" class="indexterm"/>
</p><div><img src="img/0165_4_20.jpg" alt="Animations using different image regions"/></div><p>A single image file with an imaginary 'grid' on top of it appears in the previous image.<a id="id176" class="indexterm"/>
</p><p>The horizontal dotted lines overlaying this image indicate how an imaginary image grid divides the image into different regions. Here we have four rows and just a single column. Thus, during the animation, each of these image regions will be shown as a single animation frame. Notice how the droplet images are drawn. In the first row, the four droplets are drawn at the top. Then in the next row, these images are slightly offset to the south-west direction compared to the droplets in the first row. This offset is increased further in the third and fourth rows.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec08"/>Time for action -  raindrops animation</h1></div></div></div><p>Let's create an animation of falling raindrops by using different regions of a single image.<a id="id177" class="indexterm"/>
</p><div><ol class="orderedlist arabic"><li class="listitem">Download the Python source file<code class="literal"> RainDropsAnimation.py</code> and the image file<code class="literal"> droplet.png</code> from the Packt website. As done before, place the image file in a sub-directory<code class="literal"> images</code>. The<code class="literal"> images</code> directory should be placed in the directory in which the Python source file is located.</li><li class="listitem">The<code class="literal"> __init__</code> method of the class<code class="literal"> RainDropsAnimation</code> is presented.<div><pre class="programlisting">1 def __init__(self, width=None, height=None):
2 pyglet.window.Window.__init__(self,
3 width=width,
4 height=height)
5 self.drawableObjects = []
6 self.createDrawableObjects()
</pre></div></li><li class="listitem">The code is self-explanatory. The class<code class="literal"> RainDropsAnimation</code> inherits<code class="literal"> pyglet.window.Window</code>. The constructor of the class calls the method that creates the<code class="literal"> Sprite</code> instance for displaying the animation on the screen.</li><li class="listitem">Let's review the<code class="literal"> createDrawableObjects</code> method.<a id="id178" class="indexterm"/><div><pre class="programlisting">1 def createDrawableObjects(self):
2 num_rows = 4
3 num_columns = 1
4 droplet = 'images/droplet.png'
5 animation = self.setup_animation(droplet,
6 num_rows,
7 num_columns)
8
9 self.dropletSprite = pyglet.sprite.Sprite(animation)
10 self.dropletSprite.position = (0,0)
11
12 # Add these sprites to the list of drawables
13 self.drawableObjects.append(self.dropletSprite)
</pre></div></li><li class="listitem">The pyglet.image.Animation instance is created on line 5, by calling setup_animation method. On line 9, the Sprite instance is created for this animation object.</li><li class="listitem">The<code class="literal"> setup_animation</code> method is the main worker method that uses regions within the image file to create individual animation frames.<div><pre class="programlisting">1 def setup_animation(self, img, num_rows, num_columns):
2 base_image = pyglet.image.load(img)
3 animation_grid = pyglet.image.ImageGrid(base_image,
4 num_rows,
5 num_columns)
6 image_frames = []
7
8 for i in range(num_rows*num_columns, 0, -1):
9 frame = animation_grid[i-1]
10 animation_frame = (
11 pyglet.image.AnimationFrame(frame,
12 0.2))
13 image_frames.append(animation_frame)
14
15 animation = pyglet.image.Animation(image_frames)
16 return animation
</pre></div></li><li class="listitem">First, the instance of image is created on line 2. The ImageGrid is an imaginary grid placed over the droplet image. Each 'cell' or the 'image region' within this image grid can be viewed as a separate image frame in an animation. The ImageGrid instance is constructed by providing the image object and the number of rows and columns as arguments. The number of rows in this case is 4 and there is only a single column. Thus, there will be four such image frames in the animation corresponding to each of these rows in the ImageGrid. The AnimationFrame object is created on line 10. The code on line 8 increments the value of i from maximum to minimum region or cell of the imaginary grid. Line 9 gets the specific image region and this is then used to create the pyglet.image.AnimationFrame instance, as we did on line 10. The second argument is the time for which each frame will be displayed on the screen. Here, we are displaying each frame for 0.2 seconds. All such animation frame forms are stored in a list image_frames and then the pyglet.image.Animation instance is created using this list.</li><li class="listitem">Refer to the file<code class="literal"> RainDropsAnimation.py</code> to review the rest of the code and then run the program from the command line as:<a id="id179" class="indexterm"/><div><pre class="programlisting">$python RainDropsAnimation.py
</pre></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">This animation displays four image regions of a single image, one after another. The next illustration shows these four images.<div><img src="img/0165_4_21.jpg" alt="Time for action - raindrops animation"/></div><div><img src="img/0165_4_22.jpg" alt="Time for action - raindrops animation"/></div><div><img src="img/0165_4_23.jpg" alt="Time for action - raindrops animation"/></div><div><img src="img/0165_4_24.jpg" alt="Time for action - raindrops animation"/></div><p>The four image frames that display different regions of a single image appear in the previous illustration. These four image frames are repeated in the animation loop.<a id="id180" class="indexterm"/>
</p></li></ul></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec17"/>What just happened?</h2></div></div></div><p>We created an animation using different regions of a single image. Each of these regions was treated as a separate animation frame. The creation of an image used in this animation was briefly discussed. Among many other things, we learned how to create and use Pyglet classes such as<code class="literal"> ImageGrid</code> and<code class="literal"> AnimationFrame</code>.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec09"/>Project: drive on a rainy day!</h1></div></div></div><p>This project is essentially a summary of what we have learned so far in this chapter. Additionally, it will cover a few other things such as adding sound effects to an animation, showing or hiding certain image sprites while the animation is being played, and so on. In this animation, there will be a stationary cloud image. We will re-use the code from the<em> raindrops animation</em> section to animate falling rain. There will be an image sprite to animate lightning effect. Finally, a car cartoon will be shown passing by from left to right in this heavy rain. The following snapshot is an animation frame that captures all these component images.<a id="id181" class="indexterm"/>
</p><div><img src="img/0165_4_25.jpg" alt="Project: drive on a rainy day!"/></div><p>Component images of animation<em> drive on a rainy day</em> illustrated in the preceding image.</p></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec10"/>Time for action -  drive on a rainy day!</h1></div></div></div><p>It's time to write the code for this animation.</p><div><ol class="orderedlist arabic"><li class="listitem">Download the Python source file<code class="literal"> RainyDayAnimation.py</code>. We will discuss some of the important methods from this file. You can go through the rest of the code from this file.</li><li class="listitem">Download the image files,<code class="literal"> droplet.png, cloud.png, car.png</code>, and<code class="literal"> lightening.png</code> from the Packt website. Place these image files in a sub-directory called<code class="literal"> images</code>. The<code class="literal"> images</code> directory should be placed in the directory where the Python source file is located.<a id="id182" class="indexterm"/></li><li class="listitem">The constructor of the class is written as follows:<div><pre class="programlisting">1 def __init__(self, width=None, height=None):
2 pyglet.window.Window.__init__(self,
3 width=width,
4 height=height,
5 resizable=True)
6 self.drawableObjects = []
7 self.paused = False
8
9
10 self.createDrawableObjects()
11 self.adjustWindowSize()
12 # Make sure to replace the following media path to
13 # with an appropriate path on your computer.
14 self.horn_sound = (
15 pyglet.media.load('C:/AudioFiles/horn.wav',
16 streaming=False) )
</pre></div></li><li class="listitem">The code is same as the one developed in the raindrops animation. The media file horn.wav is decoded on line 14. The flag streaming is set to False so that the media can be played multiple times during the animation. Make sure you specify an appropriate audio file path on your computer on line 15.</li><li class="listitem">Let's review the<code class="literal"> createDrawableObjects</code> method:<div><pre class="programlisting">1 def createDrawableObjects(self):
2
3 num_rows = 4
4 num_columns = 1
5 droplet = 'images/droplet.png'
6 animation = self.setup_animation(droplet,
7 num_rows,
8 num_columns)
9
10 self.dropletSprite = pyglet.sprite.Sprite(animation)
11 self.dropletSprite.position = (0,200)
12
13 cloud = pyglet.image.load('images/cloud.png')
14 self.cloudSprite = pyglet.sprite.Sprite(cloud)
15 self.cloudSprite.y = 100
16
17 lightening = pyglet.image.load('images/lightening.png')
18 self.lSprite = pyglet.sprite.Sprite(lightening)
19 self.lSprite.y = 200
20
21 car = pyglet.image.load('images/car.png')
22 self.carSprite = pyglet.sprite.Sprite(car, -500, 0)
23
24 # Add these sprites to the list of drawables
25 self.drawableObjects.append(self.cloudSprite)
26 self.drawableObjects.append(self.lSprite)
27 self.drawableObjects.append(self.dropletSprite)
28 self.drawableObjects.append(self.carSprite)
</pre></div></li><li class="listitem">The code block from lines 3 to 10 is identical to the one developed in the raindrops animation. The self.dropletSprite image is placed at an appropriate position. Next, we just create sprites to load images of clouds, lightning, and car in the Pyglet window. These sprites are placed at appropriate locations within the window. For example, the starting position of the car is off the screen. It is anchored at x = -500 and y = 0. The code block from lines 24 to 28 adds all the Sprite instances to self.drawableObjects . The draw() method of each one of these instances is called in on_draw method.</li><li class="listitem">To achieve the desired animation effect, we have to move around various sprites during the animation. This is done by scheduling a few methods to be called at specified time intervals. These methods update the coordinates of the sprite or toggle its visibility when the Pyglet window is redrawn. The code is illustrated as follows:<a id="id183" class="indexterm"/><div><pre class="programlisting"># Schedule the method RainyDayAnimation.moveObjects to be
# called every 0.05 seconds.
pyglet.clock.schedule_interval(win.moveObjects, 1.0/20)
# Show the lightening every 1 second
pyglet.clock.schedule_interval(win.show_lightening, 1.0)
</pre></div></li><li class="listitem">We have already seen an example of the moveObjects method in earlier sections. In this project, we schedule another method, RainyDayAnimation.show_lightening, to be called every second. This method created an animation effect where lightning strikes every second at different positions.</li><li class="listitem">We will now review the method<code class="literal"> show_lightening</code>.<div><pre class="programlisting">1 def show_lightening(self, t):
2 if self.lSprite.visible:
3 self.lSprite.visible = False
4 else:
5 if(self.lSprite.x == 100):
6 self.lSprite.x += 200
7 else:
8 self.lSprite.x = 100
9
10 self.lSprite.visible = True
</pre></div></li><li class="listitem">self.lSprite is the sprite representing the lightning image. Our target is to create an animation effect where the lightning flashes for a moment and then disappears. This can be accomplished by toggling the Sprite.visible property. When this property is set to False, the lightning is not shown. When it is set to True, the else block 4-10 is executed. The position of self.lSprite is changed so that the lightning appears at different locations the next time this method is called.</li><li class="listitem">The<code class="literal"> moveObjects</code> method is scheduled to be called every<code class="literal"> 0.05</code> seconds.<a id="id184" class="indexterm"/><div><pre class="programlisting">1 def moveObjects(self, t):
2 if self.carSprite.x &lt;= self.cloudSprite.width:
3 self.carSprite.x += 10
4 else:
5 self.carSprite.x = -500
6 self.horn_sound.play()
</pre></div></li><li class="listitem">Every time it is called, it moves the position of the Sprite representing the car by 10 pixels in the positive direction of x axis. However, if the x coordinate of the self.carSprite exceeds its width, the car is reset to its original position. Also, at the starting position of the car, the horn sound is played.</li><li class="listitem">Review the rest of the code from file<code class="literal"> RainyDayAnimation.py</code>. Make sure to replace the audio file path for<code class="literal"> self.horn_sound</code> with an appropriate file path on your computer. Once everything is all set, run the program from the command line as:<div><pre class="programlisting">$python RainyDayAnimation.py
</pre></div></li></ol></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">This will pop up a window that will play the animation in which a fun car cruises along in a thunderstorm. The next illustration shows some intermediate frames from the animation.</li></ul></div><div><img src="img/0165_4_26.jpg" alt="Time for action - drive on a rainy day!"/></div><div><img src="img/0165_4_27.jpg" alt="Time for action - drive on a rainy day!"/></div><div><img src="img/0165_4_28.jpg" alt="Time for action - drive on a rainy day!"/></div><div><img src="img/0165_4_29.jpg" alt="Time for action - drive on a rainy day!"/></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">Intermediate frames from an animation where a car drives along on a rainy day appear in the preceding image.</li></ul></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec18"/>What just happened?</h2></div></div></div><p>The animation developed in this project used four different images. We learned how to add sound effects and change the visibility of the image sprites during the animation. Some of the images were translated or made intermittently visible to achieve the desired animation effect. Different regions of a single image were used to animate raindrops. Overall, this fun project covered most of the things we learned throughout this book.<a id="id185" class="indexterm"/>
</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec19"/>Have a go hero add more effects</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Additional sound effects whenever lightning strikes in the animation, play a thunderstorm sound.</li><li class="listitem">In the code presented earlier, the lightning image position is toggled between two fixed locations. Use random module in Python to get a random coordinate between 0 to<code class="literal"> self.cloudSprite.width</code> and use that as the x coordinate of<code class="literal"> self.lSprite</code>.</li><li class="listitem">Add keyboard controls to change the speed of the car, the frequency of lightning, and so on.</li></ol></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec11"/>Summary</h1></div></div></div><p>We learned a lot in this chapter about creating 2D animations in Python using Pyglet. Specifically, we:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Learned some fundamental components of the Pyglet framework for creating animations. Modules such as<code class="literal"> Window, Image, Animation, Sprite, AnimationFrame, ImageGrid</code>, and so on were discussed.</li><li class="listitem" style="list-style-type: disc">Wrote code to create an animation using a sequence of images or to play a pre-created animation.</li><li class="listitem" style="list-style-type: disc">Learned things such as modifying the position of the Pyglet sprite, adding keyboard and mouse controls and adding sound effects to the animation.</li><li class="listitem" style="list-style-type: disc">Worked on a cartoon animation project 'Drive on a Rainy Day'. Here we applied several of the techniques learned throughout the chapter.</li></ul></div></div></div>
</body></html>