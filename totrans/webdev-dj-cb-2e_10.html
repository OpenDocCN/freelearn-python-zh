<html><head></head><body><div class="chapter" title="Chapter&#xA0;10.&#xA0;Bells and Whistles"><div class="titlepage"><div><div><h1 class="title"><a id="ch10"/>Chapter 10. Bells and Whistles</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Using the Django shell</li><li class="listitem" style="list-style-type: disc">Using database query expressions</li><li class="listitem" style="list-style-type: disc">Monkey-patching the slugify() function for better internationalization support</li><li class="listitem" style="list-style-type: disc">Toggling the Debug Toolbar</li><li class="listitem" style="list-style-type: disc">Using ThreadLocalMiddleware</li><li class="listitem" style="list-style-type: disc">Caching the method return value</li><li class="listitem" style="list-style-type: disc">Using Memcached to cache Django views</li><li class="listitem" style="list-style-type: disc">Using signals to notify administrators about new entries</li><li class="listitem" style="list-style-type: disc">Checking for missing settings</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec92"/>Introduction</h1></div></div></div><p>In this chapter, we will go through several other important bits and pieces that will help you understand and utilize Django even better. You will get an overview of how to use the Django shell to experiment with the code before writing it in the files. You will be introduced to monkey patching, also known as guerrilla patching, which is a powerful feature of dynamical languages such as Python and Ruby. You will learn how to debug your code and check its performance. You will see how to access the currently logged in user and other request parameters from any module. Also, you will learn how to cache values, handle signals, and create system checks. Get ready for an interesting programming experience!</p></div></div>
<div class="section" title="Using the Django shell"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec93"/>Using the Django shell</h1></div></div></div><p>With the virtual environment activated and your project directory selected as the current directory, enter the following command in your command-line tool:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ python manage shell</strong></span>
</pre></div><p>By executing<a class="indexterm" id="id521"/> the preceding command, you will get in an interactive Python shell configured for your Django project, where you can play around with the code, inspect classes, try out methods, or execute scripts on the fly. In this recipe, we will go through the most important functions that you need to know in order to work with the Django shell.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec316"/>Getting ready</h2></div></div></div><p>You can either install IPython or bpython using one of the following commands, which will highlight the syntax for the output of your Django shell and add some other helpers:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ pip install ipython</strong></span>
<span class="strong"><strong>(myproject_env)$ pip install bpython</strong></span>
</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec317"/>How to do it...</h2></div></div></div><p>Learn the basics of using the Django shell by following these instructions:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Run the Django shell by typing the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ python manage.py shell</strong></span>
</pre></div><p>The prompt will change to <code class="literal">In [1]: or &gt;&gt;&gt;</code>, depending on whether you use IPython or not. If you use bpython, the shell will be shown in full terminal window with the available shortcuts at the bottom (similar to the nano editor) and you will also get code highlighting and text autocompletion when typing.</p></li><li class="listitem">Now, you can import classes, functions, or variables and play around with them. For example, to see the version of an installed module, you can import the module and then try to read its <code class="literal">__version__</code>, <code class="literal">VERSION</code>, or <code class="literal">version</code> variables, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; import re</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; re.__version__</strong></span>
<span class="strong"><strong>'2.2.1'</strong></span>
</pre></div></li><li class="listitem">To get a comprehensive description of a module, class, function, method, keyword, or documentation topic, use the <code class="literal">help()</code> function. You can either pass a string with the path to a specific entity, or the entity itself, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; help("django.forms")</strong></span>
</pre></div><p>This will open the help page for the <code class="literal">django.forms</code> module. Use the arrow keys to scroll the page up and down. Press <span class="emphasis"><em>Q</em></span> to get back to the shell.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip17"/>Tip</h3><p>If you run <code class="literal">help()</code> without the parameters, it opens an interactive help. Here you can enter any path of a module, class, function, and so on and get information on what it does and how to use it. To quit the interactive help press <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>D</em></span>.</p></div></div></li><li class="listitem">This is an <a class="indexterm" id="id522"/>example of passing an entity to the <code class="literal">help()</code> function. This will open a help page for the <code class="literal">ModelForm</code> class, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; from django.forms import ModelForm</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; help(ModelForm)</strong></span>
</pre></div></li><li class="listitem">To quickly see what fields and values are available for a model instance, use the <code class="literal">__dict__</code> attribute. Also, use the <code class="literal">pprint()</code> function to get the dictionaries printed in a more readable format (not just one long line), as shown in the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; from pprint import pprint</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; from django.contrib.contenttypes.models import ContentType</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; pprint(ContentType.objects.all()[0].__dict__)</strong></span>
<span class="strong"><strong>{'_state': &lt;django.db.models.base.ModelState object at 0x10756d250&gt;,</strong></span>
<span class="strong"><strong> 'app_label': u'bulletin_board',</strong></span>
<span class="strong"><strong> 'id': 11,</strong></span>
<span class="strong"><strong> 'model': u'bulletin',</strong></span>
<span class="strong"><strong> 'name': u'Bulletin'}</strong></span>
</pre></div><p>Note that using <code class="literal">__dict__</code>, we don't get many-to-many relationships. However, this might be enough for a quick overview of the fields and values.</p></li><li class="listitem">To get all the available properties and methods of an object, you can use the <code class="literal">dir()</code> function, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; dir(ContentType())</strong></span>
<span class="strong"><strong>['DoesNotExist', 'MultipleObjectsReturned', '__class__', '__delattr__', '__dict__', '__doc__', '__eq__', '__format__', '__getattribute__', '__hash__', '__init__', u'__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', '__unicode__', '__weakref__', '_base_manager', '_default_manager', '_deferred', '_do_insert', '_do_update', '_get_FIELD_display', '_get_next_or_previous_by_FIELD', '_get_next_or_previous_in_order', '_get_pk_val', '_get_unique_checks', '_meta', '_perform_date_checks', '_perform_unique_checks', '_save_parents', '_save_table', '_set_pk_val', '_state', 'app_label', 'clean', 'clean_fields', 'content_type_set_for_comment', 'date_error_message', 'delete', 'full_clean', 'get_all_objects_for_this_type', 'get_object_for_this_type', 'id', 'logentry_set', 'model', 'model_class', 'name', 'natural_key', 'objects', 'permission_set', 'pk', 'prepare_database_save', 'save', 'save_base', 'serializable_value', 'unique_error_message', 'validate_unique']</strong></span>
</pre></div><p>To get these attributes printed one per line, you can use the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; pprint(dir(ContentType()))</strong></span>
</pre></div></li><li class="listitem">The Django <a class="indexterm" id="id523"/>shell is useful to experiment with <code class="literal">QuerySets</code> or regular expressions before putting them in your model methods, views, or management commands. For example, to check the e-mail validation regular expression, you can type the following in the Django shell:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; import re</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; email_pattern = re.compile(r"[^@]+@[^@]+\.[^@]+")</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; email_pattern.match("aidas@bendoraitis.lt")</strong></span>
<span class="strong"><strong>&lt;_sre.SRE_Match object at 0x1075681d0&gt;</strong></span>
</pre></div></li><li class="listitem">If you want to try out different <code class="literal">QuerySets</code>, you need to execute the setup of the models and apps in your project, as shown in the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; import django</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; django.setup()</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; from django.contrib.auth.models import User</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; User.objects.filter(groups__name="Editors")</strong></span>
<span class="strong"><strong>[&lt;User: admin&gt;]</strong></span>
</pre></div></li><li class="listitem">To exit the Django shell, press <span class="emphasis"><em>Ctrl</em></span> + <span class="emphasis"><em>D</em></span> or type the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; exit()</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec318"/>How it works...</h2></div></div></div><p>The difference between a normal Python shell and the Django shell is that when you run the Django shell, <code class="literal">manage.py</code> sets the <code class="literal">DJANGO_SETTINGS_MODULE</code> environment variable to the project's settings path, and then all the code in the Django shell is handled in the context<a class="indexterm" id="id524"/> of your project.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec319"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using database query expressions</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Monkey-patching the slugify() function for better internationalization support</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Using database query expressions"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec94"/>Using database query expressions</h1></div></div></div><p>Django <span class="strong"><strong>Object-relational mapping</strong></span> (<span class="strong"><strong>ORM</strong></span>) comes with special abstraction constructs that can<a class="indexterm" id="id525"/> be used to build complex database queries. They are <a class="indexterm" id="id526"/>called <span class="strong"><strong>Query Expressions</strong></span> and they allow <a class="indexterm" id="id527"/>you to filter data, order it, annotate new columns, and aggregate relations. In this recipe, we will see how that can be used in practice. We will create an app that shows viral videos and counts how many times each video has been seen on mobile and desktop devices.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec320"/>Getting ready</h2></div></div></div><p>To start with, install <code class="literal">django-mobile</code> to your virtual environment. This module will be necessary to differentiate between desktop devices and mobile devices:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ pip install django-mobile</strong></span>
</pre></div><p>To configure it, you will need to modify several project settings as follows. Besides that, let's create the <code class="literal">viral_videos</code> app. Put both of them under <code class="literal">INSTALLED_APPS</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># conf/base.py or settings.py</strong></span>
INSTALLED_APPS = (
    # ...
    # third party
<span class="strong"><strong>    "django_mobile",</strong></span>

    # project-specific
    "utils",
<span class="strong"><strong>    "viral_videos",</strong></span>
)

TEMPLATE_CONTEXT_PROCESSORS = (
    # ...
    "django_mobile.context_processors.flavour",
)

TEMPLATE_LOADERS = (
    # ...
    "django_mobile.loader.Loader",
)

MIDDLEWARE_CLASSES = (
    # ...
    "django_mobile.middleware.MobileDetectionMiddleware",
    "django_mobile.middleware.SetFlavourMiddleware",
)</pre></div><p>Next, create a model for viral videos with a creation and modification timestamps, title, embedded<a class="indexterm" id="id528"/> code, impressions on desktop devices, and impressions on mobile devices, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># viral_videos/models.py</strong></span>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.db import models
from django.utils.translation import ugettext_lazy as _
from django.utils.encoding import python_2_unicode_compatible
from utils.models import CreationModificationDateMixin, UrlMixin

@python_2_unicode_compatible
class ViralVideo(CreationModificationDateMixin, UrlMixin):
    title = models.CharField(
        _("Title"), max_length=200, blank=True)
    embed_code = models.TextField(_("YouTube embed code"), blank=True)
    desktop_impressions = models.PositiveIntegerField(
        _("Desktop impressions"), default=0)
    mobile_impressions = models.PositiveIntegerField(
        _("Mobile impressions"), default=0)

    class Meta:
        verbose_name = _("Viral video")
        verbose_name_plural = _("Viral videos")

    def __str__(self):
        return self.title

    def get_url_path(self):
        from django.core.urlresolvers import reverse
        return reverse(
            "viral_video_detail",
            kwargs={"id": str(self.id)}
        )</pre></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec321"/>How to do it...</h2></div></div></div><p>To illustrate the query expressions, let's create the viral video detail view and plug it in the URL <a class="indexterm" id="id529"/>configuration, as shown in the following:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">viral_video_detail()</code> view in the <code class="literal">views.py</code>, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># viral_videos/views.py</strong></span>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
import datetime
from django.shortcuts import render, get_object_or_404
from django.db import models
from django.conf import settings
from .models import ViralVideo

POPULAR_FROM = getattr(
    settings, "VIRAL_VIDEOS_POPULAR_FROM", 500
)

def viral_video_detail(request, id):
    yesterday = datetime.date.today() - \
        datetime.timedelta(days=1)

    qs = ViralVideo.objects.annotate(
        total_impressions=\
            models.F("desktop_impressions") + \
            models.F("mobile_impressions"),
        label=models.Case(
            models.When(
                total_impressions__gt=OPULAR_FROM,
                then=models.Value("popular")
            ),
            models.When(
                created__gt=yesterday,
                then=models.Value("new")
            ),
            default=models.Value("cool"),
            output_field=models.CharField(),
        ),
    )

<span class="strong"><strong>    # DEBUG: check the SQL query that Django ORM generates</strong></span>
<span class="strong"><strong>    print(qs.query)</strong></span>

    qs = qs.filter(pk=id)
    if request.flavour == "mobile":
        qs.update(
            mobile_impressions=\
                models.F("mobile_impressions") + 1
        )
    else:
        qs.update(
            desktop_impressions=\
                models.F("desktop_impressions") + 1
        )

    video = get_object_or_404(qs)

    return render(
        request,
        "viral_videos/viral_video_detail.html",
        {'video': video}
    )</pre></div></li><li class="listitem">Define<a class="indexterm" id="id530"/> the URL configuration for the app, as shown in the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># viral_videos/urls.py</strong></span>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.conf.urls import *
urlpatterns = [
    url(
        r"^(?P&lt;id&gt;\d+)/",
        "viral_videos.views.viral_video_detail",
        name="viral_video_detail"
    ),
]</pre></div></li><li class="listitem">Include the URL configuration of the app in the project's root URL configuration, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># myproject/urls.py</strong></span>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.conf.urls import include, url
from django.conf import settings
from django.conf.urls.i18n import i18n_patterns

urlpatterns = i18n_patterns("",
    # ...
    url(r"^viral-videos/", include("viral_videos.urls")),
)</pre></div></li><li class="listitem">Create a<a class="indexterm" id="id531"/> template for the <code class="literal">viral_video_detail()</code> view, as shown in the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>{# templates/viral_videos/viral_video_detail.html #}</strong></span>
{% extends "base.html" %}
{% load i18n %}

{% block content %}
    &lt;h1&gt;{{ video.title }}
        &lt;span class="badge"&gt;{{ video.label }}&lt;/span&gt;
    &lt;/h1&gt;
    &lt;div&gt;{{ video.embed_code|safe }}&lt;/div&gt;
    &lt;div&gt;
        &lt;h2&gt;{% trans "Impressions" %}&lt;/h2&gt;
        &lt;ul&gt;
            &lt;li&gt;{% trans "Desktop impressions" %}:
                {{ video.desktop_impressions }}&lt;/li&gt;
            &lt;li&gt;{% trans "Mobile impressions" %}:
                {{ video.mobile_impressions }}&lt;/li&gt;
            &lt;li&gt;{% trans "Total impressions" %}:
                {{ video.total_impressions }}&lt;/li&gt;
        &lt;/ul&gt;
    &lt;/div&gt;
{% endblock %}</pre></div></li><li class="listitem">Set up administration for the <code class="literal">viral_videos</code> app and add some videos to the database.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec322"/>How it works...</h2></div></div></div><p>You might have noticed the <code class="literal">print()</code> statement in the view. It is there temporarily for debugging purposes. If you run local development server and access the first video in the browser at <code class="literal">http://127.0.0.1:8000/en/viral-videos/1/</code>, you will see the following SQL query printed in the console:</p><div class="informalexample"><pre class="programlisting">SELECT "viral_videos_viralvideo"."id", "viral_videos_viralvideo"."created", "viral_videos_viralvideo"."modified", "viral_videos_viralvideo"."title", "viral_videos_viralvideo"."embed_code", "viral_videos_viralvideo"."desktop_impressions", "viral_videos_viralvideo"."mobile_impressions", <span class="strong"><strong>("viral_videos_viralvideo"."desktop_impressions" + "viral_videos_viralvideo"."mobile_impressions") AS "total_impressions", CASE WHEN ("viral_videos_viralvideo"."desktop_impressions" + "viral_videos_viralvideo"."mobile_impressions") &gt; 500 THEN popular WHEN "viral_videos_viralvideo"."created" &gt; 2015-11-06 00:00:00 THEN new ELSE cool END AS "label</strong></span>" FROM "viral_videos_viralvideo"</pre></div><p>Then, in<a class="indexterm" id="id532"/> the browser, you will see a simple page similar to the following image, showing the title of a video, label of the video, embedded video, and impressions on desktop devices, mobile devices and in total:</p><div class="mediaobject"><img alt="How it works..." src="graphics/B04912_10_01.jpg"/></div><p>The <code class="literal">annotate()</code> method in Django <code class="literal">QuerySets</code> allows you to add extra columns to the <code class="literal">SELECT SQL</code> statement as well as on-the-fly created properties for the objects retrieved from <code class="literal">QuerySets</code>. With <code class="literal">models.F()</code>, we can reference different field values from the selected database table. In this example, we will create the <code class="literal">total_impressions</code> property, which is the sum of the impressions on the desktop devices and the impressions on mobile devices.</p><p>With <code class="literal">models.Case()</code> and <code class="literal">models.When()</code>, we can return the values depending on different conditions. To mark the values, we are using <code class="literal">models.Value()</code>. In our example, we will create the <code class="literal">label</code> column for SQL query and the property for the objects returned by <code class="literal">QuerySet</code>. It will be set to <span class="emphasis"><em>popular</em></span> if it has more than 500 impressions, <span class="emphasis"><em>new</em></span> if it has been created today, and <span class="emphasis"><em>cool</em></span> otherwise.</p><p>At the end <a class="indexterm" id="id533"/>of the view, we have the <code class="literal">qs.update()</code> methods called. They increment <code class="literal">mobile_impressions</code> or <code class="literal">desktop_impressions</code> of the current video, depending on the device used by the visitor. The incrementation happens at the SQL level. This solves the so-called race conditions, when two or more visitors are accessing the view at the same time and try to increase the impressions count simultaneously.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec323"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using the Django shell</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a model mixin with URL-related methods</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. Database Structure">Chapter 2</a>, <span class="emphasis"><em>Database Structure</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a model mixin to handle creation and modification dates</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. Database Structure">Chapter 2</a>, <span class="emphasis"><em>Database Structure</em></span></li></ul></div></div></div>
<div class="section" title="Monkey-patching the slugify() function for better internationalization support"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec95"/>Monkey-patching the slugify() function for better internationalization support</h1></div></div></div><p>Monkey patch or guerrilla patch is a piece of code that extends or modifies another piece of code<a class="indexterm" id="id534"/> at runtime. It is not recommended to use monkey patch often; however, sometimes, it is the only possible way to fix a bug in third-party modules without creating a separate branch of the module. Also, monkey patching might be used to prepare functional or unit tests <a class="indexterm" id="id535"/>without using complex database or file<a class="indexterm" id="id536"/> manipulations. In this recipe, you will learn how to exchange the default <code class="literal">slugify()</code> function with the one from the third-party <code class="literal">awesome-slugify</code> module, which handles German, Greek, and Russian words smarter and allows to create customized slugs for other languages. As a quick reminder, we uses the <code class="literal">slugify()</code> function to create a URL-friendly version of the object's title or the uploaded filename; it strips the leading and trailing whitespace, converts the text to lowercase, removes nonword characters, and converts spaces to hyphens.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec324"/>Getting ready</h2></div></div></div><p>To get started, execute the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install <code class="literal">awesome-slugify</code> in your virtual environment, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ pip install awesome-slugify</strong></span>
</pre></div></li><li class="listitem">Create a <code class="literal">guerrilla_patches</code> app in your project and put it under <code class="literal">INSTALLED_APPS</code> in the settings.</li></ol></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec325"/>How to do it...</h2></div></div></div><p>In the <code class="literal">models.py</code> file of the <code class="literal">guerrilla_patches</code> app, add the following content:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># guerrilla_patches/models.py</strong></span>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.utils import text
from slugify import slugify_de as awesome_slugify
awesome_slugify.to_lower = True
text.slugify = awesome_slugify</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec326"/>How it works...</h2></div></div></div><p>The default <a class="indexterm" id="id537"/>Django <code class="literal">slugify()</code> function<a class="indexterm" id="id538"/> handles German diacritical symbols incorrectly. To see this for yourself, run the following code in the Django shell without the monkey patch:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ python manage.py shell</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; from django.utils.text import slugify</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; slugify("Heizölrückstoßabdämpfung")</strong></span>
<span class="strong"><strong>u'heizolruckstoabdampfung'</strong></span>
</pre></div><p>This is incorrect in German as the letter <code class="literal">ß</code> is totally stripped out instead of substituting it with <code class="literal">ss</code> and the letters <code class="literal">ä</code>, <code class="literal">ö</code>, and <code class="literal">ü</code> are changed to <code class="literal">a</code>, <code class="literal">o</code>, and <code class="literal">u</code>; whereas, they should be substituted with <code class="literal">ae</code>, <code class="literal">oe</code>, and <code class="literal">ue</code>.</p><p>The monkey patch that we did loads the <code class="literal">django.utils.text</code> module at initialization and assigns the callable instance of the <code class="literal">Slugify</code> class as the <code class="literal">slugify()</code> function. Now, if you run the same code in the Django shell, you will get different but correct results, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ python manage.py shell</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; from django.utils.text import slugify</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; slugify("Heizölrückstoßabdämpfung")</strong></span>
<span class="strong"><strong>u'heizoelrueckstossabdaempfung'</strong></span>
</pre></div><p>To read<a class="indexterm" id="id539"/> more about how to utilize the <code class="literal">awesome-slugify</code> module, refer to the following: <a class="ulink" href="https://pypi.python.org/pypi/awesome-slugify">https://pypi.python.org/pypi/awesome-slugify</a>.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec327"/>There's more...</h2></div></div></div><p>Before creating any monkey patch, we need to completely understand how the code that we want to modify works. This can be done by analyzing the existing code and inspecting the values of different variables. To do this, there is a useful built-in Python debugger <code class="literal">pdb</code> module, which can temporarily be added to the Django code or any third-party module to <a class="indexterm" id="id540"/>stop the execution of a development<a class="indexterm" id="id541"/> server at any breakpoint. Use the following code to debug an unclear part of a Python module:</p><div class="informalexample"><pre class="programlisting">import pdb
pdb.set_trace()</pre></div><p>This launches the interactive shell, where you can type the variables to see their values. If you type <code class="literal">c</code> or <code class="literal">continue</code>, the code execution will continue until the next breakpoint. If you type <code class="literal">q</code> or <code class="literal">quit</code>, the management command will be aborted. You can learn more commands<a class="indexterm" id="id542"/> of the Python debugger and how to inspect the traceback of the code at <a class="ulink" href="https://docs.python.org/2/library/pdb.html">https://docs.python.org/2/library/pdb.html</a>.</p><p>Another quick way to see a value of a variable in the development server is to raise a warning with the variable as a message, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>raise Warning, some_variable</strong></span>
</pre></div><p>When you are in the <code class="literal">DEBUG</code> mode, the Django logger will provide you with the traceback and other local variables.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip18"/>Tip</h3><p>Don't forget to remove the debugging functions before committing the code to a repository.</p></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec328"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using the Django shell</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Toggling the Debug Toolbar"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec96"/>Toggling the Debug Toolbar</h1></div></div></div><p>While developing with Django, you will want to inspect request headers and parameters, check the current template context, or measure the performance of SQL queries. All this and more is<a class="indexterm" id="id543"/> possible with the Django Debug Toolbar. It is a configurable set of panels that displays various debug information about the current request and response. In this recipe, I will guide you on how to toggle the visibility of the Debug Toolbar, depending on a cookie, set by bookmarklet. A bookmarklet is a bookmark of a small piece of JavaScript code that you can run on any page in a browser.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec329"/>Getting ready</h2></div></div></div><p>To get started with toggling the visibility of the Debug Toolbar, take a look at the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install the Django Debug Toolbar to your virtual environment:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ pip install django-debug-toolbar==1.4</strong></span>
</pre></div></li><li class="listitem">Put <code class="literal">debug_toolbar</code> under <code class="literal">INSTALLED_APPS</code> in the settings.</li></ol></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec330"/>How to do it...</h2></div></div></div><p>Follow these steps to set up the Django Debug Toolbar, which can be switched on or off using bookmarklets in the browser:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add<a class="indexterm" id="id544"/> the following project settings:<div class="informalexample"><pre class="programlisting">MIDDLEWARE_CLASSES = (
    # ...
    "debug_toolbar.middleware.DebugToolbarMiddleware",
)

DEBUG_TOOLBAR_CONFIG = {
    "DISABLE_PANELS": [],
<span class="strong"><strong>    "SHOW_TOOLBAR_CALLBACK": \</strong></span>
<span class="strong"><strong>        "utils.misc.custom_show_toolbar",</strong></span>
    "SHOW_TEMPLATE_CONTEXT": True,
}

DEBUG_TOOLBAR_PANELS = [
    "debug_toolbar.panels.versions.VersionsPanel",
    "debug_toolbar.panels.timer.TimerPanel",
    "debug_toolbar.panels.settings.SettingsPanel",
    "debug_toolbar.panels.headers.HeadersPanel",
    "debug_toolbar.panels.request.RequestPanel",
    "debug_toolbar.panels.sql.SQLPanel",
    "debug_toolbar.panels.templates.TemplatesPanel",
    "debug_toolbar.panels.staticfiles.StaticFilesPanel",
    "debug_toolbar.panels.cache.CachePanel",
    "debug_toolbar.panels.signals.SignalsPanel",
    "debug_toolbar.panels.logging.LoggingPanel",
    "debug_toolbar.panels.redirects.RedirectsPanel",
]</pre></div></li><li class="listitem">In the <code class="literal">utils</code> module, create a <code class="literal">misc.py</code> file with the <code class="literal">custom_show_toolbar()</code> function, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># utils/misc.py</strong></span>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals

def custom_show_toolbar(request):
    return "1" == request.COOKIES.get("DebugToolbar", False)</pre></div></li><li class="listitem">Open the Chrome or Firefox browser and go to <span class="strong"><strong>Bookmark Manager</strong></span>. Then, create two new JavaScript links. The first link shows the toolbar. It looks similar<a class="indexterm" id="id545"/> to the following:<div class="informalexample"><pre class="programlisting">Name: Debug Toolbar On
URL: javascript:(function(){document.cookie="DebugToolbar=1; path=/";location.reload();})();</pre></div></li><li class="listitem">The second JavaScript link hides the toolbar and looks similar to the following:<div class="informalexample"><pre class="programlisting">Name: Debug Toolbar Off
URL: javascript:(function(){document.cookie="DebugToolbar=0; path=/";location.reload();})();</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec331"/>How it works...</h2></div></div></div><p>The <code class="literal">DEBUG_TOOLBAR_PANELS</code> setting defines the panels to show in the toolbar. The <code class="literal">DEBUG_TOOLBAR_CONFIG</code> dictionary defines the configuration for the toolbar, including a path to the function that is used to check whether or not to show the toolbar.</p><p>By default, when you browse through your project the Django Debug Toolbar will not be shown. However, as you click on your bookmarklet, <span class="strong"><strong>Debug Toolbar On</strong></span>, the <code class="literal">DebugToolbar</code> cookie will be set to <code class="literal">1</code>, the page will be refreshed, and you will see the toolbar with debugging panels. For example, you will be able to inspect the performance of SQL statements for optimization, as shown in the following screenshot:</p><div class="mediaobject"><img alt="How it works..." src="graphics/B04912_10_02.jpg"/></div><p>You <a class="indexterm" id="id546"/>will also be able to check the template context variables for the current view, as shown in the following screenshot:</p><div class="mediaobject"><img alt="How it works..." src="graphics/B04912_10_03.jpg"/></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec332"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Getting detailed error reporting via e-mail</em></span> recipe in <a class="link" href="ch11.html" title="Chapter 11. Testing and Deployment">Chapter 11</a>, <span class="emphasis"><em>Testing and Deployment</em></span></li></ul></div></div></div>
<div class="section" title="Using ThreadLocalMiddleware"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec97"/>Using ThreadLocalMiddleware</h1></div></div></div><p>The <code class="literal">HttpRequest</code> object contains useful information about the current user, language, server variables, cookies, session, and so on. As a matter of fact, <code class="literal">HttpRequest</code> is provided in the<a class="indexterm" id="id547"/> views and middlewares, and then you can pass it or its attribute values to forms, model methods, model managers, templates, and so on. To make life easier, you can use the <code class="literal">ThreadLocalMiddleware</code> middleware that stores the current <code class="literal">HttpRequest</code> object in the globally-accessed Python thread. Therefore, you can access it from model methods, forms, signal handlers, and any other place that didn't have direct access to the <code class="literal">HttpRequest</code> object previously. In this recipe, we will define this middleware.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec333"/>Getting ready</h2></div></div></div><p>Create the <code class="literal">utils</code> app and put it under <code class="literal">INSTALLED_APPS</code> in the settings.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec334"/>How to do it...</h2></div></div></div><p>Execute<a class="indexterm" id="id548"/> the following two steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Add a <code class="literal">middleware.py</code> file in the <code class="literal">utils</code> app with the following content:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># utils/middleware.py</strong></span>
# -*- coding: UTF-8 -*-
from threading import local
_thread_locals = local()

def get_current_request():
    """ returns the HttpRequest object for this thread """
    return getattr(_thread_locals, "request", None)

def get_current_user():
    """ returns the current user if it exists
        or None otherwise """
    request = get_current_request()
    if request:
        return getattr(request, "user", None)

class ThreadLocalMiddleware(object):
    """ Middleware that adds the HttpRequest object
        to thread local storage """
    def process_request(self, request):
        _thread_locals.request = request</pre></div></li><li class="listitem">Add this middleware to <code class="literal">MIDDLEWARE_CLASSES</code> in the settings:<div class="informalexample"><pre class="programlisting">MIDDLEWARE_CLASSES = (
    # ...
    "utils.middleware.ThreadLocalMiddleware",
)</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec335"/>How it works...</h2></div></div></div><p>The<code class="literal"> ThreadLocalMiddleware</code> processes each request and stores the current <code class="literal">HttpRequest</code> object in the current thread. Each request-response cycle in Django is single threaded. There are two functions: <code class="literal">get_current_request()</code> and <code class="literal">get_current_user()</code>. These functions can be used from anywhere to grab the current <code class="literal">HttpRequest</code> object or the current user.</p><p>For example, you can create and use <code class="literal">CreatorMixin</code>, which saves the current user as the creator of a<a class="indexterm" id="id549"/> model, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># utils/models.py</strong></span>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.db import models
from django.utils.translation import ugettext_lazy as _

class CreatorMixin(models.Model):
    """
    Abstract base class with a creator
    """
    creator = models.ForeignKey(
        "auth.User",
        verbose_name=_("creator"),
        editable=False,
        blank=True,
        null=True,
    )

    def save(self, *args, **kwargs):
<span class="strong"><strong>        from utils.middleware import get_current_user</strong></span>
        if not self.creator:
<span class="strong"><strong>            self.creator = get_current_user()</strong></span>
        super(CreatorMixin, self).save(*args, **kwargs)
    save.alters_data = True

    class Meta:
        abstract = True</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec336"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a model mixin with URL-related methods</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. Database Structure">Chapter 2</a>, <span class="emphasis"><em>Database Structure</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a model mixin to handle creation and modification dates</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. Database Structure">Chapter 2</a>, <span class="emphasis"><em>Database Structure</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a model mixin to take care of meta tags</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. Database Structure">Chapter 2</a>, <span class="emphasis"><em>Database Structure</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a model mixin to handle generic relations</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. Database Structure">Chapter 2</a>, <span class="emphasis"><em>Database Structure</em></span></li></ul></div></div></div>
<div class="section" title="Caching the method return value"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec98"/>Caching the method return value</h1></div></div></div><p>If you call the same model method with heavy calculations or database queries multiple times in the request-response cycle, the performance of the view might be very slow. In this recipe, you <a class="indexterm" id="id550"/>will learn about a pattern that you can use to cache the return value of a method for later repetitive use. Note that we are not using the Django cache framework here, we are just using what Python provides us by default.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec337"/>Getting ready</h2></div></div></div><p>Choose an app with a model that has a time-consuming method that will be used repetitively in the same request-response cycle.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec338"/>How to do it...</h2></div></div></div><p>This is a pattern that you can use to cache a method return value of a model for repetitive use in views, forms, or templates, as follows:</p><div class="informalexample"><pre class="programlisting">class SomeModel(models.Model):
    # ...
    def some_expensive_function(self):
        if not hasattr(self, "_expensive_value_cached"):
            # do some heavy calculations...
            # ... and save the result to result variable
            self._expensive_value_cached = result
        return self._expensive_value_cached</pre></div><p>For example, let's create a <code class="literal">get_thumbnail_url()</code>method for the <code class="literal">ViralVideo</code> model that we created in the <span class="emphasis"><em>Using database query expressions</em></span> recipe earlier in this chapter:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># viral_videos/models.py</strong></span>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
import re
# ... other imports ...


@python_2_unicode_compatible
class ViralVideo(CreationModificationDateMixin, UrlMixin):
    # ...
    def get_thumbnail_url(self):
        if not hasattr(self, "_thumbnail_url_cached"):
            url_pattern = re.compile(
                r'src="https://www.youtube.com/embed/([^"]+)"'
            )
            match = url_pattern.search(self.embed_code)
            self._thumbnail_url_cached = ""
            if match:
                video_id = match.groups()[0]
                self._thumbnail_url_cached = \
                    "http://img.youtube.com/vi/{}/0.jpg".format(
                        video_id
                    )
        return self._thumbnail_url_cached</pre></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec339"/>How it works...</h2></div></div></div><p>The method <a class="indexterm" id="id551"/>checks whether the <code class="literal">_expensive_value_cached</code> attribute exists for the model instance. If it doesn't exist, the time-consuming calculations are done and the result is assigned to this new attribute. At the end of the method, the cached value is returned. Of course, if you have several weighty methods, you will need to use different attribute names to save each calculated value.</p><p>You can now use something like <code class="literal">{{ object.some_expensive_function }}</code> in the header and footer of a template, and the time-consuming calculations will be done just once.</p><p>In a template, you can use the function in both, the <code class="literal">{% if %}</code> condition, and output of the value, as follows:</p><div class="informalexample"><pre class="programlisting">{% if <span class="strong"><strong>object.some_expensive_function</strong></span> %}
    &lt;span class="special"&gt;
        {{ <span class="strong"><strong>object.some_expensive_function</strong></span> }}
    &lt;/span&gt;
{% endif %}</pre></div><p>In this example, we are checking the thumbnail of a YouTube video by parsing the URL of the video's embed code, getting its ID, and then composing the URL of the thumbnail image. Then, you can use it in a template as follows:</p><div class="informalexample"><pre class="programlisting">{% if video.get_thumbnail_url %}
    &lt;figure&gt;
        &lt;img src="{{ video.get_thumbnail_url }}"
            alt="{{ video.title }}" /&gt;
        &lt;figcaption&gt;{{ video.title }}&lt;/figcaption&gt;
    &lt;/figure&gt;
{% endif %}</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec340"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Refer to <a class="link" href="ch04.html" title="Chapter 4. Templates and JavaScript">Chapter 4</a>, <span class="emphasis"><em>Templates and JavaScript</em></span> for more details</li></ul></div></div></div>
<div class="section" title="Using Memcached to cache Django views"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec99"/>Using Memcached to cache Django views</h1></div></div></div><p>Django provides a possibility to speed up the request-response cycle by caching the most expensive<a class="indexterm" id="id552"/> parts such as database queries <a class="indexterm" id="id553"/>or template rendering. The fastest and most reliable caching natively supported by Django is the memory-based cache server, Memcached. In this recipe, you will learn how to use Memcached to cache a view for our <code class="literal">viral_videos</code> app that we created in the <span class="emphasis"><em>Using database query expressions</em></span> recipe earlier in this chapter.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec341"/>Getting ready</h2></div></div></div><p>There are several things to do in order to prepare caching for your Django project:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Install Memcached server, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ wget http://memcached.org/files/memcached-1.4.23.tar.gz</strong></span>
<span class="strong"><strong>$ tar -zxvf memcached-1.4.23.tar.gz</strong></span>
<span class="strong"><strong>$ cd memcached-1.4.23</strong></span>
<span class="strong"><strong>$ ./configure &amp;&amp; make &amp;&amp; make test &amp;&amp; sudo make install</strong></span>
</pre></div></li><li class="listitem">Start Memcached server, as shown in the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ memcached -d</strong></span>
</pre></div></li><li class="listitem">Install Memcached Python bindings in your virtual environment, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ pip install python-memcached</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec342"/>How to do it...</h2></div></div></div><p>To integrate caching for your specific views, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Set <code class="literal">CACHES</code> in the project settings, as follows:<div class="informalexample"><pre class="programlisting">CACHES = {
    "default": {
        "BACKEND": "django.core.cache.backends."
            "memcached.MemcachedCache",
        "LOCATION": "127.0.0.1:11211",
        "TIMEOUT": 60,  # 1 minute
        "KEY_PREFIX": "myproject_production",
    }
}</pre></div></li><li class="listitem">Modify the views of the <code class="literal">viral_videos</code> app, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># viral_videos/views.py</strong></span>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.views.decorators.vary import vary_on_cookie
from django.views.decorators.cache import cache_page

@vary_on_cookie
@cache_page(60)
def viral_video_detail(request, id):
  # ...</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec343"/>How it works...</h2></div></div></div><p>Now, if you access the first viral video at <code class="literal">http://127.0.0.1:8000/en/viral-videos/1/</code> and refresh the page a few times, you will see that the number of impressions changes only once a minute. This is because for every visitor, caching is enabled for 60 seconds. Caching is set for the view using the <code class="literal">@cache_page</code> decorator.</p><p>Memcached is <a class="indexterm" id="id554"/>a key-value store and by default<a class="indexterm" id="id555"/> for each cached page, the full URL is used to generate the key. When two visitors access the same page simultaneously, the first visitor will get the page generated by the Python code and the second one will get the HTML code from the Memcached server.</p><p>In our example, to ensure that each visitor gets treated separately even if they access the same URL, we are using the <code class="literal">@vary_on_cookie</code> decorator. This decorator checks the uniqueness of the <code class="literal">Cookie</code> header of the HTTP request.</p><p>Learn more<a class="indexterm" id="id556"/> about Django's cache framework from the official documentation at <a class="ulink" href="https://docs.djangoproject.com/en/1.8/topics/cache/">https://docs.djangoproject.com/en/1.8/topics/cache/</a>.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec344"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using database query expressions</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Caching the method return value</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Using signals to notify administrators about new entries"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec100"/>Using signals to notify administrators about new entries</h1></div></div></div><p>Django framework has a concept of signals, which are similar to events in JavaScript. There is a <a class="indexterm" id="id557"/>handful of built-in signals that you can<a class="indexterm" id="id558"/> use to trigger actions before and after initialization of a model, saving or deleting an instance, migrating the database schema, handling a request, and so on. Moreover, you can create your own signals in your reusable apps and handle them in other apps. In this recipe, you will learn how to use signals to send emails to administrators whenever a specific model is saved.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec345"/>Getting ready</h2></div></div></div><p>Let's start with the <code class="literal">viral_videos</code> app that we created in the <span class="emphasis"><em>Using database query expressions</em></span> recipe.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec346"/>How to do it...</h2></div></div></div><p>Follow<a class="indexterm" id="id559"/> these steps to create notifications<a class="indexterm" id="id560"/> to administrators:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">signals.py</code> file with the following content:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># viral_videos/signals.py</strong></span>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.db.models.signals import post_save
from django.dispatch import receiver
from .models import ViralVideo

@receiver(post_save, sender=ViralVideo)
def inform_administrators(sender, **kwargs):
    from django.core.mail import mail_admins
    instance = kwargs["instance"]
    created = kwargs["created"]
    if created:
        context = {
            "title": instance.title,
            "link": instance.get_url(),
        }
        plain_text_message = """
A new viral video called "%(title)s" has been created.
You can preview it at %(link)s.""" % context
        html_message = """
&lt;p&gt;A new viral video called "%(title)s" has been created.&lt;/p&gt;
&lt;p&gt;You can preview it &lt;a href="%(link)s"&gt;here&lt;/a&gt;.&lt;/p&gt;""" % context

        mail_admins(
            subject="New Viral Video Added at example.com",
            message=plain_text_message,
            html_message=html_message,
            fail_silently=True,
        )</pre></div></li><li class="listitem">Create the <code class="literal">apps.py</code> file with the following content:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># viral_videos/apps.py</strong></span>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.apps import AppConfig
from django.utils.translation import ugettext_lazy as _

class ViralVideosAppConfig(AppConfig):
    name = "viral_videos"
    verbose_name = _("Viral Videos")

    def ready(self):
        from .signals import inform_administrators</pre></div></li><li class="listitem">Update the <code class="literal">__init__.py</code> file with the following content:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># viral_videos/__init__.py</strong></span>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals

default_app_config = \
    "viral_videos.apps.ViralVideosAppConfig"</pre></div></li><li class="listitem">Make sure that you have <code class="literal">ADMINS</code> set in the project settings, as follows:<div class="informalexample"><pre class="programlisting">ADMINS = (
    ("Aidas Bendoraitis", "aidas.bendoraitis@example.com"),
)</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec347"/>How it works...</h2></div></div></div><p>The <code class="literal">ViralVideosAppConfig</code> app configuration class has the <code class="literal">ready()</code> method, which will be called <a class="indexterm" id="id561"/>when all the models of the project<a class="indexterm" id="id562"/> are loaded in the memory. According to the Django documentation, <span class="emphasis"><em>signals allow certain senders to notify a set of receivers that some action has taken place</em></span>. In the <code class="literal">ready()</code> method, we will import, therefore, registering the <code class="literal">inform_administrators()</code> signal receiver for the <code class="literal">post_save</code> signal, and limiting it to handle only signals, where the <code class="literal">ViralVideo</code> model is the sender. Therefore, whenever we save the <code class="literal">ViralVideo</code> model, the <code class="literal">inform_administrators()</code> function will be called. The function checks whether a video is newly created. In that case, it sends an e-mail to the system administrators that are listed in <code class="literal">ADMINS</code> in the settings.</p><p>Learn more <a class="indexterm" id="id563"/>about Django's signals from the official documentation at <a class="ulink" href="https://docs.djangoproject.com/en/1.8/topics/signals/">https://docs.djangoproject.com/en/1.8/topics/signals/</a>.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec348"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using database query expressions</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating app configuration</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Getting Started with Django 1.8">Chapter 1</a>, <span class="emphasis"><em>Getting Started with Django 1.8</em></span></li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Checking for missing settings</em></span> recipe</li></ul></div></div></div>
<div class="section" title="Checking for missing settings"><div class="titlepage"><div><div><h1 class="title"><a id="ch10lvl1sec101"/>Checking for missing settings</h1></div></div></div><p>Since Django 1.7, you can<a class="indexterm" id="id564"/> use an extensible <span class="strong"><strong>System Check Framework</strong></span>, which replaces the old validate management command. In this recipe, you <a class="indexterm" id="id565"/>will learn how to create a check if the <code class="literal">ADMINS</code> setting is set. Similarly, you will be able to check whether different secret keys or access tokens are set for the APIs that you are using.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec349"/>Getting ready</h2></div></div></div><p>Let's start with the <code class="literal">viral_videos</code> app that we created in the <span class="emphasis"><em>Using database query expressions</em></span> recipe and extended in the previous recipe.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec350"/>How to do it...</h2></div></div></div><p>To use System Check Framework, follow these simple steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">checks.py</code> file with the following content:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># viral_videos/checks.py</strong></span>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.core.checks import Warning, register, Tags

@register(Tags.compatibility)
def settings_check(app_configs, **kwargs):
    from django.conf import settings
    errors = []
    if not settings.ADMINS:
        errors.append(
            Warning(
                """The system admins are not set in the project settings""",
                hint="""In order to receive notifications when new videos are created, define system admins like ADMINS=(("Admin", "admin@example.com"),) in your settings""",
                id="viral_videos.W001",
            )
        )
    return errors</pre></div></li><li class="listitem">Import the checks in the <code class="literal">ready()</code> method of the app configuration, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># viral_videos/apps.py</strong></span>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.apps import AppConfig
from django.utils.translation import ugettext_lazy as _

class ViralVideosAppConfig(AppConfig):
    name = "viral_videos"
    verbose_name = _("Viral Videos")

    def ready(self):
        from .signals import inform_administrators
<span class="strong"><strong>        from .checks import settings_check</strong></span>
</pre></div></li><li class="listitem">To try the<a class="indexterm" id="id566"/> check that you just created, remove or comment out the <code class="literal">ADMINS</code> setting and run the <code class="literal">check</code> management command in your virtual environment, as shown in the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>(myproject_env)$ python manage.py check</strong></span>
<span class="strong"><strong>System check identified some issues:</strong></span>

<span class="strong"><strong>WARNINGS:</strong></span>
<span class="strong"><strong>?: (viral_videos.W001) The system admins are not set in the project settings</strong></span>
<span class="strong"><strong>  HINT: define system admins like ADMINS=(("Admin", "admin@example.com"),) in your settings</strong></span>

<span class="strong"><strong>System check identified 1 issue (0 silenced).</strong></span>
</pre></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec351"/>How it works...</h2></div></div></div><p>The System Check Framework has a bunch of checks in the models, fields, database, administration, authentication, content types, and security, where it raises errors or warnings if something in the project is not set correctly. Additionally, you can create your own checks similar to what we did in this recipe.</p><p>We have registered the <code class="literal">settings_check()</code> function, which returns a list with a warning if there is no <code class="literal">ADMINS</code> setting defined for the project.</p><p>Besides the <code class="literal">Warning</code> instances from the <code class="literal">django.core.checks</code> module, the returned list can also contain instances of the <code class="literal">Debug</code>, <code class="literal">Info</code>, <code class="literal">Error</code>, and <code class="literal">Critical</code> classes or any other class inheriting from <code class="literal">django.core.checks.CheckMessage</code>. Debugs, infos, and warnings would fail silently; whereas, errors and criticals would prevent the project from running.</p><p>In this<a class="indexterm" id="id567"/> example, the check is tagged as a <code class="literal">compatibility</code> check. The other options are: <code class="literal">models</code>, <code class="literal">signals</code>, <code class="literal">admin</code>, and <code class="literal">security</code>.</p><p>Learn more<a class="indexterm" id="id568"/> about System Check Framework from the official documentation at <a class="ulink" href="https://docs.djangoproject.com/en/1.8/topics/checks/">https://docs.djangoproject.com/en/1.8/topics/checks/</a>.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch10lvl2sec352"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using database query expressions</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using signals to notify administrators about new entries</em></span> recipe</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating app configuration</em></span> recipe in <a class="link" href="ch01.html" title="Chapter 1. Getting Started with Django 1.8">Chapter 1</a>, <span class="emphasis"><em>Getting Started with Django 1.8</em></span></li></ul></div></div></div></body></html>