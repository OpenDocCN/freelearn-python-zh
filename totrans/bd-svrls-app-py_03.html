<html><head></head><body>
        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Setting Up Serverless Architectures</h1>
                
            
            <article>
                
<p class="calibre2">So far, we have understood what the serverless paradigm is, and also how serverless systems work. We have also understood how AWS Lambda's serverless tool works. We have also learned the basics of how triggers work in AWS Lambda as well as a detailed understanding of the system settings and configuration available to the user in the Lambda environment. We have also learned how the Lambda console works, and also how to identify and use various parts of the Lambda console in detail, including code deployment, trigger manipulation, deploying tests in the console, versioning our Lambda function, and also the different settings available. </p>
<p class="calibre2">By the end of this chapter, you will have a clear understanding of all the important triggers available for AWS Lambda and how you can use them to set up efficient Lambda architectures. You will also understand what an event structure is, and what an event structure looks like for some AWS resources, and how you can use that knowledge to write and deploy better trigger-based Lambda architectures.</p>
<p class="calibre2">This chapter will cover the following points:</p>
<ul class="calibre9">
<li class="calibre10"><span>S3 trigger</span></li>
<li class="calibre10"><span>SNS trigger</span></li>
<li class="calibre10"><span>SQS trigger</span></li>
<li class="calibre10"><span>CloudWatch Event and Logs trigger</span>
<div class="title-page-name"/>
</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">S3 trigger</h1>
                
            
            <article>
                
<p class="calibre2">S3 is the AWS object storage service, where the user can store and retrieve any type of object. In this section, we shall be learning how the S3 trigger works, what the event structure of an S3 event looks like, and also how to make use of them in the learning to build a Lambda function.</p>
<p class="calibre2">We will be building a Lambda function that does the following:</p>
<ol class="calibre13">
<li value="1" class="calibre10">Receives a PUT request event from the S3 service</li>
<li value="2" class="calibre10">Prints the name of the file and other major details</li>
<li value="3" class="calibre10">Transfers that file to a different bucket</li>
</ol>
<p class="calibre2"><span class="calibre11">So, let's get started on learning how to use the S3 trigger efficiently. We will be working on this task step-by-step, as follows:</span></p>
<ol class="calibre13">
<li value="1" class="calibre10">Firstly, we need to create two S3 buckets for the task. One will be the bucket where the file will be uploaded by the user. The other will be the one where the file is transferred and uploaded by the Lambda function.</li>
<li value="2" class="calibre10">The S3 console looks like the following screenshot when there are no pre-existing buckets. You can go there by selecting the <span>S3</span> service from the drop-down <span>Services</span> menu in the top-left of your AWS console:
<div class="cdpaligncenter"><img src="../images/00048.jpeg" class="calibre59"/></div>
</li>
</ol>
<ol start="3" class="calibre13">
<li value="3" class="calibre10">Let's create two buckets, namely <kbd class="calibre12">receiver-bucket</kbd> and <kbd class="calibre12">sender-bucket</kbd>.</li>
<li value="4" class="calibre10">The <kbd class="calibre12">sender-bucket</kbd> bucket will be used as the bucket where the user uploads the files. The <kbd class="calibre12">receiver-bucket</kbd> bucket is the one where the Lambda function uploads the files. So, as per our problem statement, whenever we upload files to the <kbd class="calibre12">sender-bucket</kbd> bucket, the Lambda function gets triggered and the files get uploaded to <kbd class="calibre12">receiver-bucket</kbd>.</li>
<li value="5" class="calibre10">When we click on the<span> Create bucket</span> button in the S3 console, we get a dialog that looks like this:<br class="title-page-name"/>
<div class="cdpaligncenter"><img src="../images/00049.jpeg" class="calibre60"/></div>
</li>
</ol>
<ol start="6" class="calibre13">
<li value="6" class="calibre10">In the preceding dialog, we need to enter the following settings:
<ul class="calibre20">
<li class="calibre10"><span>Bucket Name</span>:<strong class="calibre1"> </strong>As the name suggests, we need to enter the name of the bucket we are creating. For the creation of the first bucket, name it <kbd class="calibre12">sender-bucket</kbd> and name the second bucket <kbd class="calibre12">receiver-bucket</kbd>.</li>
<li class="calibre10"><span>Region</span>: This is an AWS region we want the bucket to reside in. You can use the default region for this or the region closest to wherever you are located.</li>
<li class="calibre10"><span>Copy settings from an existing bucket</span>: This specifies whether we want to use the same settings as in some other bucket in the console for this bucket too. As we do not currently  have any other bucket in our console, we can skip this setting by leaving it empty. After this, you can click on the <span>Next</span> button in the bottom-right part of the popup.</li>
</ul>
</li>
<li value="7" class="calibre10">Once we click <span>Next</span>, we get redirected to the second tab of the popup, which is the <span>Set properties</span> menu and looks like this:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00050.jpeg" class="calibre61"/></div>
<ol start="8" class="calibre13">
<li value="8" class="calibre10">In this part of the popup, we need to decide on the following settings:<br class="title-page-name"/>
<ul class="calibre20">
<li class="calibre10"><span>Versioning</span>:<strong class="calibre1"> </strong>This is relevant if we want to keep multiple versions of the files in the S3 bucket. This setting is required when you need a Git style versioning for your S3 bucket. Note that the storage cost would be included in line with the number of versioned documents.</li>
<li class="calibre10"><span>Server access logging</span>: This will log all the access requests to the S3 bucket. This helps debug any security breaches and secure the S3 bucket and the files.</li>
<li class="calibre10"><span>Tags</span>: This will tag the bucket using a <em class="calibre28">Name:Value</em> style, the same style of tagging as we learned for Lambda functions.</li>
<li class="calibre10"><span>Object-level logging</span>: This will use the CloudTrail service of AWS to log all the access requests and other details and activities on the S3 bucket. This will also include CloudTrail costs too. So, use this feature only if you need detailed logging. We shall skip using this for this section.</li>
</ul>
</li>
<li value="9" class="calibre10">After finishing creating the buckets, the S3 console will look like this, with both the created buckets listed:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00051.jpeg" class="calibre62"/></div>
<ol start="10" class="calibre13">
<li value="10" class="calibre10">We have successfully created S3 buckets for our task. Now, we have to create a Lambda function that can recognize an object upload in the <kbd class="calibre12">sender-bucket</kbd> bucket and send that file to the <kbd class="calibre12">receiver-bucket</kbd> bucket.</li>
</ol>
<ol start="11" class="calibre13">
<li value="11" class="calibre10">While creating the Lambda function, this time choose the <span>s3-get-object-python</span>  blueprint from the listed options available:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00052.jpeg" class="calibre63"/></div>
<ol start="12" class="calibre13">
<li value="12" class="calibre10">Configure the bucket details in the next step. In the <span>Bucket</span> section, select the <span>sender-bucket</span> bucket and select the <span>Object Created (All)</span> option in the <span>Event type</span> action. This is because we want to send a notification to Lambda whenever an object gets created in the <kbd class="calibre12">sender-bucket</kbd> bucket. The completed part of the section will look like this:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00053.jpeg" class="calibre64"/></div>
<ol start="13" class="calibre13">
<li value="13" class="calibre10">Once you have enabled the trigger, Lambda helps you by creating a boilerplate code for the task. All we need to do is write the code to put the object into the <kbd class="calibre12">receiver-bucket</kbd> bucket. The boilerplate code can be seen in the <span>Lambda function code</span> section:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00054.jpeg" class="calibre65"/></div>
<ol start="14" class="calibre13">
<li value="14" class="calibre10">When this step has been completed and you have clicked the <span>Create function</span> button, you can see the <span>Triggers</span> section of the Lambda console, which displays a success message in green at the top:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00055.jpeg" class="calibre66"/></div>
<ol start="15" class="calibre13">
<li value="15" class="calibre10">I have uploaded a small image file into the <kbd class="calibre12">sender-bucket</kbd> bucket. So, now the contents of the <span>sender-bucket</span> bucket look like this:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00056.jpeg" class="calibre67"/></div>
<ol start="16" class="calibre13">
<li value="16" class="calibre10"><span>As soon as this file had been uploaded, the Lambda function got triggered. The Lambda function code looks like this:</span></li>
</ol>
<pre class="calibre17">from __future__ import print_function<br class="title-page-name"/><br class="title-page-name"/>import json<br class="title-page-name"/>import urllib<br class="title-page-name"/>import boto3<br class="title-page-name"/>from botocore.client import Config<br class="title-page-name"/><br class="title-page-name"/>print('Loading function')<br class="title-page-name"/>sts_client = boto3.client('sts', use_ssl=True)<br class="title-page-name"/><br class="title-page-name"/># Assume a Role for temporary credentials<br class="title-page-name"/>assumedRoleObject = sts_client.assume_role(<br class="title-page-name"/>RoleArn="arn:aws:iam::080983167913:role/service-role/Pycontw-Role",<br class="title-page-name"/>RoleSessionName="AssumeRoleSession1"<br class="title-page-name"/>)<br class="title-page-name"/>credentials = assumedRoleObject['Credentials']<br class="title-page-name"/>region = 'us-east-1'<br class="title-page-name"/><br class="title-page-name"/>def lambda_handler(event, context):<br class="title-page-name"/>    #print("Received event: " + json.dumps(event, indent=2))<br class="title-page-name"/><br class="title-page-name"/>    # Get the object from the event and show its content type<br class="title-page-name"/>    bucket = event['Records'][0]['s3']['bucket']['name']<br class="title-page-name"/>    key = urllib.unquote_plus(event['Records'][0]['s3']       ['object']['key'].encode('utf8'))<br class="title-page-name"/>    try:<br class="title-page-name"/>        # Creates a session<br class="title-page-name"/>        session = boto3.Session(credentials['AccessKeyId'],      credentials['SecretAccessKey'] ,      aws_session_token=credentials['SessionToken'],      region_name=region)<br class="title-page-name"/><br class="title-page-name"/>        #Instantiates an S3 resource<br class="title-page-name"/>        s3 = session.resource('s3',  config=Config(signature_version='s3v4'), use_ssl=True)<br class="title-page-name"/><br class="title-page-name"/>        #Instantiates an S3 client<br class="title-page-name"/>        client = session.client('s3',   config=Config(signature_version='s3v4'), use_ssl=True)<br class="title-page-name"/><br class="title-page-name"/>        # Gets the list of objects of a bucket<br class="title-page-name"/>        response = client.list_objects(Bucket=bucket)<br class="title-page-name"/><br class="title-page-name"/>        destination_bucket = 'receiver-bucket'<br class="title-page-name"/>        source_bucket = 'sender-bucket'<br class="title-page-name"/><br class="title-page-name"/>        # Adding all the file names in the S3 bucket in an  array<br class="title-page-name"/>        keys = []<br class="title-page-name"/>        if 'Contents' in response:<br class="title-page-name"/>            for item in response['Contents']:<br class="title-page-name"/>                keys.append(item['Key']);<br class="title-page-name"/><br class="title-page-name"/>        # Add all the files in the bucket into the receiver bucket<br class="title-page-name"/>        for key in keys:<br class="title-page-name"/>            path = source_bucket + '/' + key<br class="title-page-name"/>            print(key)<br class="title-page-name"/>        s3.Object(destination_bucket,  key).copy_from(CopySource=path)<br class="title-page-name"/><br class="title-page-name"/>    Exception as e:<br class="title-page-name"/>        print(e)<br class="title-page-name"/>print('Error getting object {} from bucket {}. Make sure they exist and your bucket is in the same region as this function.'.format(key, bucket))<br class="title-page-name"/>raise e</pre>
<ol start="17" class="calibre13">
<li value="17" class="calibre10">Now, when you run the Lambda function, you can see the same file in the <span>receiver-bucket</span> bucket:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00057.jpeg" class="calibre68"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">SNS trigger</h1>
                
            
            <article>
                
<p class="calibre2">The SNS notification service can be used across multiple use cases, one of which involves triggering Lambda functions. The SNS trigger is popularly used as an interface between the AWS CloudWatch service and Lambda.</p>
<p class="calibre2">So, in this section, we will do the following:</p>
<ol class="calibre13">
<li value="1" class="calibre10">Create an SNS topic</li>
<li value="2" class="calibre10">Create a CloudWatch alarm for our <kbd class="calibre12">receiver-bucket</kbd> bucket to monitor the number of objects in the bucket</li>
<li value="3" class="calibre10">Once the objects count reaches 5, the alarm will be set to <span>ALERT</span> and the corresponding notification will be sent to the SNS topic that we have just created</li>
<li value="4" class="calibre10">This SNS topic will then trigger a Lambda function, which prints out a <span>Hello World</span> message for us</li>
</ol>
<p class="calibre2">This will help you understand how to monitor different AWS services and set up alarms for some thresholds for those metrics. And depending on whether the service's metrics have hit that threshold or not, the Lambda function will get triggered.</p>
<p class="calibre2">The process flow for this is as follows:</p>
<ol class="calibre13">
<li class="calibre10" value="1">SNS topics can be created from the SNS dashboard. By clicking on the <span>Create topic</span> option, you will be redirected to the topic creation dashboard of SNS. The SNS dashboard of AWS looks like this:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00058.jpeg" class="calibre69"/></div>
<p class="calibre34">The SNS topic creation wizard in the next step looks like this:</p>
<div class="cdpaligncenter"><img src="../images/00059.jpeg" class="calibre70"/></div>
<p class="calibre34">In this creation wizard, you can name the SNS topic that you are creating, and add any meta information you want to.</p>
<ol start="2" class="calibre13">
<li value="2" class="calibre10">Once the topic is created, you can view it in the <span>Topics</span> menu, which is on the left of your SNS dashboard. The button looks like this:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00060.jpeg" class="calibre71"/></div>
<p class="calibre44">Upon clicking the <span class="calibre11">Topics</span> tab, a list of topics will be displayed, as shown in the following screenshot:</p>
<div class="cdpaligncenter"><img src="../images/00061.jpeg" class="calibre72"/></div>
<ol start="3" class="calibre13">
<li value="3" class="calibre10">Now that we have successfully created an SNS topic, we shall create a CloudWatch alarm to monitor our S3 bucket for files. The AWS <span>CloudWatch</span> dashboard looks something like this:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00062.jpeg" class="calibre73"/></div>
<ol start="4" class="calibre13">
<li value="4" class="calibre10">Now, we can go to the <span>Alarms</span> page by clicking the <span>Alarms</span> button in the list on the left of the dashboard. The AWS <span>Alarms</span> page of looks like this:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00063.jpeg" class="calibre74"/></div>
<ol start="5" class="calibre13">
<li value="5" class="calibre10">Next, click on <span>Create Alarm</span> to create an alarm. This will open an alarm creation wizard with multiple options. The wizard looks like this, depending on the services running in your AWS ecosystem:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00064.jpeg" class="calibre75"/></div>
<ol start="6" class="calibre13">
<li value="6" class="calibre10">As we intend to create an alarm for our S3 bucket, we can go to the <span>S3 Metrics</span> tab and ignore the rest of the available metrics. If you click on the <span>Storage Metrics</span> option in the <span>S3 Metrics</span> category, you will be re-directed to another alarm creation wizard that looks like the following, depending on the number of buckets you have in your S3:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00065.jpeg" class="calibre76"/></div>
<ol start="7" class="calibre13">
<li value="7" class="calibre10">If you observe the options in the <span>Metric Name</span> column, you will see two options available for each bucket: <span>NumberOfObjects</span> and <span>BucketSizeBytes</span>. They are self-explanatory  and we will only need the <span><span>NumberOfObjects</span></span> option for the <kbd class="calibre12">receiver-bucket</kbd> bucket. So, select that option and click <span>Next</span>:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00066.jpeg" class="calibre77"/></div>
<p class="calibre34">This will take you to the alarm definition wizard, where you need to specify the details of the SNS topic and the threshold for the alarm. The wizard looks like this:</p>
<div class="cdpaligncenter"><img src="../images/00067.jpeg" class="calibre78"/></div>
<ol start="8" class="calibre13">
<li value="8" class="calibre10">Add in the details for the threshold and the name of the alarm. The threshold is five files, which means that the alarm will be triggered as soon as the number of files in the corresponding bucket (<kbd class="calibre12">receiver-bucket</kbd> in our case) reaches a total of five. The wizard looks like this:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00068.jpeg" class="calibre79"/></div>
<ol start="9" class="calibre13">
<li value="9" class="calibre10">In the <span>Actions</span> option, we can configure the alarm to send the notification to the SNS topic that we have just created. You can select the topic from the drop-down list, as follows:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00069.jpeg" class="calibre80"/></div>
<ol start="10" class="calibre13">
<li value="10" class="calibre10">Once we have configured the SNS topic, we can click on the blue <span>Create Alarm</span> button at the bottom. This will create the alarm that is linked to the SNS topic as a notification pipeline. The created alarm will look like this on the dashboard:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00070.jpeg" class="calibre81"/></div>
<ol start="11" class="calibre13">
<li value="11" class="calibre10">Now, we can move on to building the Lambda function for the task. For this particular task, use the <span>sns-message-python</span> blueprint while creating our Lambda function:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00071.jpeg" class="calibre82"/></div>
<ol start="11" class="calibre13">
<li value="11" class="calibre10">In the previous step, when you have selected the blueprint, you will be asked to enter some meta information regarding your Lambda function, just like we did previously while creating Lambda functions. In the same wizard, you will also be asked to mention the name of the SNS topic. You can specify it here:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00072.jpeg" class="calibre48"/></div>
<ol start="12" class="calibre13">
<li value="12" class="calibre10">Now that we have selected all the options for the Lambda function correctly, we can now go on to the code. The desired code will look like this:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00073.jpeg" class="calibre48"/></div>
<p class="calibre34">The preceding code will display a <kbd class="calibre12">Hello World</kbd> message whenever the Lambda function gets triggered. This we have completed the setup for this task.</p>
<ol start="13" class="calibre13">
<li value="13" class="calibre10">To test the preceding setup, you can simply upload more than five files to your <kbd class="calibre12">receiver-bucket</kbd> bucket and check for Lambda function's execution.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">SQS trigger</h1>
                
            
            <article>
                
<p class="calibre2">The <strong class="calibre4">AWS Simple Queue Service (SQS)</strong> is the AWS queue service. This service is similar to the queuing mechanisms that are used generally in software engineering. This enables us to add, store, and remove messages inside the queue. </p>
<p class="calibre2">We will learn how to trigger a Lambda function, depending on the number of messages in a SQS queue. This task will help you understand how serverless batch data architectures can be built and how to build one yourself.</p>
<p class="calibre2">We will do this by monitoring our SQS queue with a CloudWatch alarm and relaying the information to Lambda via an SNS topic, just like we did in the previous task.</p>
<p class="calibre2">So, in this section, we will do the following:</p>
<ol class="calibre13">
<li value="1" class="calibre10">Create an SQS queue</li>
<li value="2" class="calibre10">Create an SNS topic</li>
<li value="3" class="calibre10">Create a CloudWatch alarm for our SQS queue to monitor the number of messages in the queue</li>
<li value="4" class="calibre10">Once the messages count reaches 5, the alarm will be set to <span>ALERT</span> and the corresponding notification will be sent to the SNS topic we have just created</li>
<li value="5" class="calibre10">This SNS topic will then trigger a Lambda function, which prints out a <kbd class="calibre12">Hello World</kbd> message for us</li>
</ol>
<p class="calibre2">This will help you understand how to monitor queues and build efficient serverless data architectures that are batched, instead of in real time.</p>
<p class="calibre2"><span class="calibre11"> The process flow for this is as follows:<br class="calibre5"/></span></p>
<ol class="calibre13">
<li value="1" class="calibre10"><span>We will start by creating an AWS SQS queue. We need to go to the SQS dashboard of our AWS account. The dashboard looks like this: </span></li>
</ol>
<div class="cdpaligncenter"><span><img src="../images/00074.jpeg" class="calibre83"/></span></div>
<ol start="2" class="calibre13">
<li value="2" class="calibre10">Click on the <span>Get Started Now</span> button to create an SQS queue. It will redirect you to the queue creation wizard, where you need to enter details such as the name, type of queue, and so on. The queue creation wizard looks like this:</li>
</ol>
<div class="cdpaligncenter">
<div class="cdpaligncenter"><img src="../images/00075.jpeg" class="calibre84"/></div>
</div>
<ol start="3" class="calibre13">
<li value="3" class="calibre10">You can enter the name of the queue in <span>Queue Name</span>. In the <span>What type of queue do you need?</span> option, select the <span>Standard Queue</span> option. In the options at the bottom, select the blue <span>Quick-Create Queue</span> option:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00076.jpeg" class="calibre48"/></div>
<p class="calibre34">The <span class="calibre11">Configure Queue</span> option is for advanced settings. It is not necessary to tweak those settings for this task. This is what the advanced settings look like:</p>
<div class="cdpaligncenter">
<div class="cdpaligncenter"><img src="../images/00077.jpeg" class="calibre85"/></div>
</div>
<ol start="5" class="calibre13">
<li value="5" class="calibre10">Once you have created the queue, you will be taken to the SQS page, where all the queues that you have created are listed similarly to the SNS list. This page looks like this:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00078.jpeg" class="calibre86"/></div>
<ol start="6" class="calibre13">
<li value="6" class="calibre10">As we have already created an SNS topic in the previous task, we will use the same topic for this purpose. If you haven't created an SNS topic, you can refer to the previous task for instructions on how to create one. The list of SNS topics looks like this:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00079.jpeg" class="calibre87"/></div>
<ol start="7" class="calibre13">
<li value="7" class="calibre10">Now, we will go to the <span>CloudWatch</span> dashboard to create an alarm to monitor our SQS queue and send a notification to Lambda via the SNS topic that we have already created. We can now see the SQS queue metrics in the alarm creation wizard:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00080.jpeg" class="calibre48"/></div>
<ol start="8" class="calibre13">
<li value="8" class="calibre10">By clicking on the <span>Queue Metrics</span> option under <span>SQS Metrics</span>, we will be taken to the page where all queue metrics are listed, and we need to select one of them for our alarm:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00081.jpeg" class="calibre48"/></div>
<ol start="9" class="calibre13">
<li value="9" class="calibre10">Here, we are interested in the <span>ApproximateNumberOfMessagesVisible</span> metric, which gives the number of messages in the queue. It says Approximate, as SQS is a distributed queue and the number of messages can only be determined stochastically.</li>
</ol>
<ol start="10" class="calibre13">
<li value="10" class="calibre10">In the next page, after selecting the <span><span>ApproximateNumberOfMessagesVisible</span></span> metric from the list, the necessary settings can be configured as we did for the <span>S3 Metrics</span> in the previous task. The page should look like this:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00082.jpeg" class="calibre48"/></div>
<ol start="11" class="calibre13">
<li value="11" class="calibre10">In the <span>Actions</span> section, configure the SNS topic to which we want to send our notification. This step is also similar to how we configured the SNS topic in the previous task:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00083.jpeg" class="calibre48"/></div>
<ol start="12" class="calibre13">
<li value="12" class="calibre10">Once you are satisfied with the metadata and the settings you have configured for the alarm, you can click the blue <span>Create Alarm</span> button on the bottom-right side of the screen. That will successfully create an alarm that monitors your SQS queue and sends a notification to the SNS topic that you have configured:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00084.jpeg" class="calibre48"/></div>
<ol start="13" class="calibre13">
<li value="13" class="calibre10">We can use the Lambda function that we created in the previous task. Make sure the trigger is the SNS topic that we are using to configure the notification system of the alarm:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00085.jpeg" class="calibre48"/></div>
<ol start="14" class="calibre13">
<li value="14" class="calibre10">The Lambda function code for this task is as follows:</li>
</ol>
<pre class="calibre88">from __future__ import print_function<br class="title-page-name"/>import json<br class="title-page-name"/>print('Loading function')<br class="title-page-name"/>def lambda_handler(event, context):<br class="title-page-name"/>    #print("Received event: " + json.dumps(event, indent=2))<br class="title-page-name"/>    message = event['Records'][0]['Sns']['Message']<br class="title-page-name"/>    print("From SNS: " + message)<br class="title-page-name"/>    print('Hello World')<br class="title-page-name"/>    return message</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">CloudWatch trigger</h1>
                
            
            <article>
                
<p class="calibre2"><strong class="calibre4">CloudWatch</strong> is the logging and monitoring service for AWS, where logs from most services get stored and monitored. In this section, we will learn how CloudWatch trigger works, how CloudWatch querying works in practice, configuring this in the Lambda function, and also how to make use of this knowledge to build a Lambda function.</p>
<p class="calibre2">So, in this section, we will do the following:</p>
<ol class="calibre13">
<li value="1" class="calibre10">Create a CloudWatch log</li>
<li value="2" class="calibre10">Briefly understand how a CloudWatch log works</li>
<li value="3" class="calibre10">Create a Lambda function that gets triggered by the CloudWatch trigger</li>
</ol>
<p class="calibre2">This will help you understand and build resilient and stable serverless architectures. </p>
<p class="calibre2"><span class="calibre11"> The process flow for this is as follows:<br class="calibre5"/></span></p>
<ol class="calibre13">
<li value="1" class="calibre10">To create a CloudWatch Logs group, click on the <span>Logs</span> option to the left of the <span>CloudWatch</span> console:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00086.jpeg" class="calibre48"/></div>
<ol start="2" class="calibre13">
<li value="2" class="calibre10">Once you are on the AWS CloudWatch <span>Logs</span> page, you will see a list of log groups that are already present. The CloudWatch <span>Logs</span> page looks something like this:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00087.jpeg" class="calibre48"/></div>
<ol start="3" class="calibre13">
<li value="3" class="calibre10">Let's go ahead and create a new CloudWatch log. You can see the option to create a new log group from the <span>Actions</span> drop-down menu at the top:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00088.jpeg" class="calibre48"/></div>
<ol start="4" class="calibre13">
<li value="4" class="calibre10">In the next step, you will be asked to name the log group that you are creating. Go ahead and enter the relevant information and click <span>Create log group</span>:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00089.jpeg" class="calibre89"/></div>
<ol start="5" class="calibre13">
<li value="5" class="calibre10">So, now we have a new log group listed in the list of log groups in our <span>CloudWatch</span> console:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00090.jpeg" class="calibre90"/></div>
<ol start="6" class="calibre13">
<li value="6" class="calibre10">Once the log group has been created, we can now start working on our Lambda function. So, let's move on to the Lambda console and start creating a new function.</li>
<li value="7" class="calibre10">From the blueprints, choose the <span>cloudwatch-logs-process-data</span> blueprint. The description reads: <span>A real-time consumer of log events ingested by an Amazon CloudWatch Logs log group</span>:<span> </span></li>
</ol>
<p class="cdpaligncenter1"><img src="../images/00091.jpeg" class="calibre91"/></p>
<ol start="8" class="calibre13">
<li value="8" class="calibre10">After selecting the corresponding blueprint option, you will be redirected to the Lambda creation wizard, as usual:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00092.jpeg" class="calibre48"/></div>
<ol start="9" class="calibre13">
<li value="9" class="calibre10">Just as we did in the previous task, we will also enter relevant information about the log name and other details in the <span>cloudwatch-logs</span> pane of the Lambda creation panel:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00093.jpeg" class="calibre48"/></div>
<ol start="10" class="calibre13">
<li value="10" class="calibre10">After clicking <span>Create function</span>, we will be directed to a <span>Triggers</span> page with the success message.</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00094.jpeg" class="calibre92"/></div>
<ol start="11" class="calibre13">
<li value="11" class="calibre10">So, now we write the Lambda function code to identify the log group and print <kbd class="calibre12">Hello World </kbd> message:</li>
</ol>
<div class="cdpaligncenter"><img src="../images/00095.jpeg" class="calibre93"/></div>
<ol start="12" class="calibre13">
<li value="12" class="calibre10">We have now successfully completed another task where we understood how to trigger a Lambda function via AWS CloudWatch Logs. The Lambda function code for this task is as follows:</li>
</ol>
<pre class="calibre17"> import boto3<br class="title-page-name"/> import logging<br class="title-page-name"/> import json<br class="title-page-name"/> logger = logging.getLogger()<br class="title-page-name"/> logger.setLevel(logging.INFO)<br class="title-page-name"/> def lambda_handler(event, context):<br class="title-page-name"/> #capturing the CloudWatch log data<br class="title-page-name"/> LogEvent = str(event['awslogs']['data'])<br class="title-page-name"/> #converting the log data from JSON into a dictionary<br class="title-page-name"/> cleanEvent = json.loads(LogEvent)<br class="title-page-name"/> print 'Hello World'<br class="title-page-name"/> print cleanEvent['logEvents']</pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    </header><h1 class="header-title" id="calibre_pb_0">Summary</h1>
                
            
            <article>
                
<p class="calibre2">In this chapter, we have learned a great deal about how various Lambda triggers work, and how to configure them, set up the triggers, and write Lambda function code to handle the data from them. </p>
<p class="calibre2">In the first task, we learned how S3 events work and how to understand and receive events from the S3 service to AWS Lambda. We have understood how to monitor S3 buckets for file details via their metrics in CloudWatch and then send that notification via AWS SNS to a Lambda functions.</p>
<p class="calibre2">We have also learned how to create SNS topics and how to use them as an intermediate route between several metrics of AWS services from CloudWatch to AWS Lambda.</p>
<p class="calibre2">We have learned briefly about how AWS CloudWatch works. We understood what the metrics of various AWS services, such as S3, SQS, and CloudWatch, look like. We also learned how to set thresholds for CloudWatch Alarms, and how to connect those alarms to notification services, such as AWS SNS.</p>
<p class="calibre2">We learned how AWS CloudWatch Logs work and how to connect and use the CloudWatch trigger in Lambda so it's triggered whenever a new log event is added/received. Overall, we have successfully created new AWS services, such as SQS, CloudWatch Logs, SNS, and S3 buckets in this chapter, and successfully built and deployed three serverless tasks/pipelines.</p>
<p class="calibre2">In the next chapter, we will learn how to build serverless APIs, on which we will perform some tasks just like we did in this chapter, and get a hands-on understanding of how APIs work and, most importantly, how serverless APIs work.</p>


            </article>

            
        </section>
    </body></html>