<html><head></head><body>
<div><h1 class="chapterNumber">8</h1>
<h1 class="chapterTitle" id="_idParaDest-225">Building an Online Shop</h1>
<p class="normal">In the previous chapter, you created a follow system and built a user activity stream. You also learned how Django signals work and integrated Redis into your project to count image views.</p>
<p class="normal">In this chapter, you will start a new Django project that consists of a fully featured online shop. This chapter and the following two chapters will show you how to build the essential functionalities of an e-commerce platform. Your online shop will enable clients to browse products, add them to the cart, apply discount codes, go through the checkout process, pay with a credit card, and obtain an invoice. You will also implement a recommendation engine to recommend products to your customers, and you will use internationalization to offer your site in multiple languages.</p>
<p class="normal">In this chapter, you will learn how to:</p>
<ul>
<li class="bulletList">Create a product catalog</li>
<li class="bulletList">Build a shopping cart using Django sessions</li>
<li class="bulletList">Create custom template context processors</li>
<li class="bulletList">Manage customer orders</li>
<li class="bulletList">Configure Celery in your project with RabbitMQ as a message broker</li>
<li class="bulletList">Send asynchronous notifications to customers using Celery</li>
<li class="bulletList">Monitor Celery using Flower</li>
</ul>
<h1 class="heading-1" id="_idParaDest-226">Functional overview</h1>
<p class="normal"><em class="italic">Figure 8.1</em> shows a representation of the views, templates, and main functionalities that will be built in this chapter:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_08_01.png"/></figure>
<p class="packt_figref">Figure 8.1: Diagram of functionalities built in Chapter 8</p>
<p class="normal">In this chapter, you will implement the <code class="inlineCode">product_list</code> view to list all products and the <code class="inlineCode">product_detail</code> view to display a single product. You will allow filtering products by category in the <code class="inlineCode">product_list</code> view using the <code class="inlineCode">category_slug</code> parameter. You will implement a shopping cart using sessions and you will build the <code class="inlineCode">cart_detail</code> view to display the cart items. You will create the <code class="inlineCode">cart_add</code> view to add products to the cart and update quantities, and the <code class="inlineCode">cart_remove</code> view to remove products from the cart. You will implement the <code class="inlineCode">cart</code> template context processor to display the number of cart items and total cost on the site header. You will also create the <code class="inlineCode">order_create</code> view to place orders, and you will use Celery to implement the <code class="inlineCode">order_created</code> asynchronous task that sends out an email confirmation to clients when they place an order. This chapter will provide you with the knowledge to implement user sessions in your application and show you how to work with asynchronous tasks. Both are very common use cases that you can apply to almost any project.</p>
<p class="normal">The source code for this chapter can be found at <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter08">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter08</a>.</p>
<p class="normal">All Python modules used in this chapter are included in the <code class="inlineCode">requirements.txt</code> file in the source code that comes along with this chapter. You can follow the instructions to install each Python module below or you can install all requirements at once with the command <code class="inlineCode">python</code> <code class="inlineCode">-m</code> <code class="inlineCode">pip</code> <code class="inlineCode">install</code> <code class="inlineCode">-r</code> <code class="inlineCode">requirements.txt</code>.</p>
<h1 class="heading-1" id="_idParaDest-227">Creating an online shop project</h1>
<p class="normal">Let’s start with a new Django project to build an online shop. Your users will be able to browse through a product catalog and add products to a shopping cart. Finally, they will be able to check out the <a id="_idIndexMarker723"/>cart and place an order. This chapter will cover the following functionalities of an online shop:</p>
<ul>
<li class="bulletList">Creating the product catalog models, adding them to the administration site, and building the basic views to display the catalog</li>
<li class="bulletList">Building a shopping cart system using Django sessions to allow users to keep selected products while they browse the site</li>
<li class="bulletList">Creating the form and functionality to place orders on the site</li>
<li class="bulletList">Sending an asynchronous email confirmation to users when they place an order</li>
</ul>
<p class="normal">Open a shell and use the following command to create a new virtual environment for this project within the <code class="inlineCode">env/</code> directory:</p>
<pre class="programlisting con"><code class="hljs-con">python -m venv env/myshop
</code></pre>
<p class="normal">If you are using Linux or macOS, run the following command to activate your virtual environment:</p>
<pre class="programlisting con"><code class="hljs-con">source env/myshop/bin/activate
</code></pre>
<p class="normal">If you are using Windows, use the following command instead:</p>
<pre class="programlisting con"><code class="hljs-con">.\env\myshop\Scripts\activate
</code></pre>
<p class="normal">The shell prompt will display your active virtual environment, as follows:</p>
<pre class="programlisting con"><code class="hljs-con">(myshop)laptop:~ zenx$
</code></pre>
<p class="normal">Install Django in your virtual environment with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install Django~=5.0.4
</code></pre>
<p class="normal">Start a new project called <code class="inlineCode">myshop</code> with an application called <code class="inlineCode">shop</code> by opening a shell and running the following command:</p>
<pre class="programlisting con"><code class="hljs-con">django-admin startproject myshop
</code></pre>
<p class="normal">The initial project structure<a id="_idIndexMarker724"/> has been created. Use the following commands to get into your project directory and create a new application named <code class="inlineCode">shop</code>:</p>
<pre class="programlisting con"><code class="hljs-con">cd myshop/
django-admin startapp shop
</code></pre>
<p class="normal">Edit <code class="inlineCode">settings.py</code> and add the following line highlighted in bold to the <code class="inlineCode">INSTALLED_APPS</code> list:</p>
<pre class="programlisting code"><code class="hljs-code">INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'shop.apps.ShopConfig'</strong><strong class="hljs-slc">,</strong>
]
</code></pre>
<p class="normal">Your application is now active for this project. Let’s define the models for the product catalog.</p>
<h2 class="heading-2" id="_idParaDest-228">Creating product catalog models</h2>
<p class="normal">The catalog of your shop will consist <a id="_idIndexMarker725"/>of products that are organized into different categories. Each product will have a name, an optional description, an optional image, a price, and its availability.</p>
<p class="normal">Edit the <code class="inlineCode">models.py</code> file of the <code class="inlineCode">shop</code> application that you just created and add the following code:</p>
<pre class="programlisting code"><code class="hljs-code">from django.db import models
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Category</strong><strong class="hljs-slc">(models.Model):</strong>
<strong class="hljs-slc">    name = models.CharField(max_length=</strong><strong class="hljs-number-slc">200</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    slug = models.SlugField(max_length=</strong><strong class="hljs-number-slc">200</strong><strong class="hljs-slc">, unique=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Meta</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">        ordering = [</strong><strong class="hljs-string-slc">'name'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">        indexes = [</strong>
<strong class="hljs-slc">            models.Index(fields=[</strong><strong class="hljs-string-slc">'name'</strong><strong class="hljs-slc">]),</strong>
<strong class="hljs-slc">        ]</strong>
<strong class="hljs-slc">        verbose_name = </strong><strong class="hljs-string-slc">'category'</strong>
<strong class="hljs-slc">        verbose_name_plural = </strong><strong class="hljs-string-slc">'categories'</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">__str__</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> self.name</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Product</strong><strong class="hljs-slc">(models.Model):</strong>
<strong class="hljs-slc">    category = models.ForeignKey(</strong>
<strong class="hljs-slc">        Category,</strong>
<strong class="hljs-slc">        related_name=</strong><strong class="hljs-string-slc">'products'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        on_delete=models.CASCADE</strong>
<strong class="hljs-slc">    )</strong>
<strong class="hljs-slc">    name = models.CharField(max_length=</strong><strong class="hljs-number-slc">200</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    slug = models.SlugField(max_length=</strong><strong class="hljs-number-slc">200</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    image = models.ImageField(</strong>
<strong class="hljs-slc">        upload_to=</strong><strong class="hljs-string-slc">'products/%Y/%m/%d'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        blank=</strong><strong class="hljs-literal-slc">True</strong>
<strong class="hljs-slc">    )</strong>
<strong class="hljs-slc">    description = models.TextField(blank=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    price = models.DecimalField(max_digits=</strong><strong class="hljs-number-slc">10</strong><strong class="hljs-slc">, decimal_places=</strong><strong class="hljs-number-slc">2</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    available = models.BooleanField(default=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    created = models.DateTimeField(auto_now_add=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    updated = models.DateTimeField(auto_now=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Meta</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">        ordering = [</strong><strong class="hljs-string-slc">'name'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">        indexes = [</strong>
<strong class="hljs-slc">            models.Index(fields=[</strong><strong class="hljs-string-slc">'id'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'slug'</strong><strong class="hljs-slc">]),</strong>
<strong class="hljs-slc">            models.Index(fields=[</strong><strong class="hljs-string-slc">'name'</strong><strong class="hljs-slc">]),</strong>
<strong class="hljs-slc">            models.Index(fields=[</strong><strong class="hljs-string-slc">'-created'</strong><strong class="hljs-slc">]),</strong>
<strong class="hljs-slc">        ]</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">__str__</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> self.name</strong>
</code></pre>
<p class="normal">These are the <code class="inlineCode">Category</code> and <code class="inlineCode">Product</code> models. The <code class="inlineCode">Category</code> model consists of a <code class="inlineCode">name</code> field and a unique <code class="inlineCode">slug</code> field (<code class="inlineCode">unique</code> implies the creation of an index). In the <code class="inlineCode">Meta</code> class of the <code class="inlineCode">Category</code> model, we<a id="_idIndexMarker726"/> have defined an index for the <code class="inlineCode">name</code> field.</p>
<p class="normal">The <code class="inlineCode">Product</code> model fields are as follows:</p>
<ul>
<li class="bulletList"><code class="inlineCode">category</code>: A <code class="inlineCode">ForeignKey</code> to the <code class="inlineCode">Category</code> model. This is a one-to-many relationship: a product belongs to one category and a category contains multiple products.</li>
<li class="bulletList"><code class="inlineCode">name</code>: The name of the product.</li>
<li class="bulletList"><code class="inlineCode">slug</code>: The slug for this product to build beautiful URLs.</li>
<li class="bulletList"><code class="inlineCode">image</code>: An optional product image.</li>
<li class="bulletList"><code class="inlineCode">description</code>: An optional description of the product.</li>
<li class="bulletList"><code class="inlineCode">price</code>: This field uses Python’s <code class="inlineCode">decimal.Decimal</code> type to store a fixed-precision decimal number. The maximum number of digits (including the decimal places) is set using the <code class="inlineCode">max_digits</code> attribute and decimal places with the <code class="inlineCode">decimal_places</code> attribute.</li>
<li class="bulletList"><code class="inlineCode">available</code>: A Boolean value that indicates whether the product is available or not. It will be used to enable/disable the product in the catalog.</li>
<li class="bulletList"><code class="inlineCode">created</code>: This field stores when the object was created.</li>
<li class="bulletList"><code class="inlineCode">updated</code>: This field stores when the object was last updated.</li>
</ul>
<p class="normal">For the <code class="inlineCode">price</code> field, we use <code class="inlineCode">DecimalField</code> instead of <code class="inlineCode">FloatField</code> to avoid rounding issues.</p>
<div><p class="normal">Always use <code class="inlineCode">DecimalField</code> to store monetary amounts. <code class="inlineCode">FloatField</code> uses Python’s <code class="inlineCode">float</code> type internally, whereas <code class="inlineCode">DecimalField</code> uses Python’s <code class="inlineCode">Decimal</code> type. By using the <code class="inlineCode">Decimal</code> type, you will avoid <code class="inlineCode">float</code> rounding issues.</p>
</div>
<p class="normal">In the <code class="inlineCode">Meta</code> class of the <code class="inlineCode">Product</code> model, we have defined a multiple-field index for the <code class="inlineCode">id</code> and <code class="inlineCode">slug</code> fields. Both fields are indexed together to improve performance for queries that utilize the two fields.</p>
<p class="normal">We plan to query products<a id="_idIndexMarker727"/> by both <code class="inlineCode">id</code> and <code class="inlineCode">slug</code>. We have added an index for the <code class="inlineCode">name</code> field and an index for the <code class="inlineCode">created</code> field. We have used a hyphen before the field name to define the index in descending order.</p>
<p class="normal"><em class="italic">Figure 8.2</em> shows the two data models you have created:</p>
<figure class="mediaobject"><img alt="Diagram  Description automatically generated" src="img/B21088_08_02.png"/></figure>
<p class="packt_figref">Figure 8.2: Models for the product catalog</p>
<p class="normal">In <em class="italic">Figure 8.2</em>, you can see the different fields of the data models and the one-to-many relationship between the <code class="inlineCode">Category</code> and the <code class="inlineCode">Product</code> models.</p>
<p class="normal">These models will result in the following database tables displayed in <em class="italic">Figure 8.3</em>:</p>
<figure class="mediaobject"><img alt="A picture containing diagram  Description automatically generated" src="img/B21088_08_03.png"/></figure>
<p class="packt_figref">Figure 8.3: Database tables for the product catalog models</p>
<p class="normal">The one-to-many relationship between both tables is defined with the <code class="inlineCode">category_id</code> field in the <code class="inlineCode">shop_product</code> table, which is <a id="_idIndexMarker728"/>used to store the ID of the related <code class="inlineCode">Category</code> for each <code class="inlineCode">Product</code> object.</p>
<p class="normal">Let’s create the initial database migrations for the <code class="inlineCode">shop</code> application. Since you are going to deal with images in your models, you will need to install the Pillow library. Remember that in <em class="italic">Chapter 4</em>, <em class="italic">Building a Social Website</em>, you learned how to install the Pillow library to manage images. Open the shell and install <code class="inlineCode">Pillow</code> with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install Pillow==10.3.0
</code></pre>
<p class="normal">Now run the next command to create initial migrations for your project:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py makemigrations
</code></pre>
<p class="normal">You will see the following output:</p>
<pre class="programlisting con"><code class="hljs-con">Migrations for 'shop':
  shop/migrations/0001_initial.py
    - Create model Category
    - Create model Product
</code></pre>
<p class="normal">Run the next command to sync the database:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py migrate
</code></pre>
<p class="normal">You will see output that includes the following line:</p>
<pre class="programlisting con"><code class="hljs-con">Applying shop.0001_initial... OK
</code></pre>
<p class="normal">The database is now<a id="_idIndexMarker729"/> synced with your models.</p>
<h2 class="heading-2" id="_idParaDest-229">Registering catalog models on the administration site</h2>
<p class="normal">Let’s add your models to the<a id="_idIndexMarker730"/> administration site so that you can easily manage categories and products. Edit the <code class="inlineCode">admin.py</code> file of the <code class="inlineCode">shop</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.contrib import admin
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> .models </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> Category, Product</strong>
<strong class="hljs-meta-slc">@admin.register(</strong><strong class="hljs-params-slc">Category</strong><strong class="hljs-meta-slc">)</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">CategoryAdmin</strong><strong class="hljs-slc">(admin.ModelAdmin):</strong>
<strong class="hljs-slc">    list_display = [</strong><strong class="hljs-string-slc">'name'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'slug'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">    prepopulated_fields = {</strong><strong class="hljs-string-slc">'</strong><strong class="hljs-string-slc">slug'</strong><strong class="hljs-slc">: (</strong><strong class="hljs-string-slc">'name'</strong><strong class="hljs-slc">,)}</strong>
<strong class="hljs-meta-slc">@admin.register(</strong><strong class="hljs-params-slc">Product</strong><strong class="hljs-meta-slc">)</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">ProductAdmin</strong><strong class="hljs-slc">(admin.ModelAdmin):</strong>
<strong class="hljs-slc">    list_display = [</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'name'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'slug'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'price'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'available'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'</strong><strong class="hljs-string-slc">created'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'updated'</strong>
<strong class="hljs-slc">    ]</strong>
<strong class="hljs-slc">    list_filter = [</strong><strong class="hljs-string-slc">'available'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'created'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'updated'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">    list_editable = [</strong><strong class="hljs-string-slc">'price'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'available'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">    prepopulated_fields = {</strong><strong class="hljs-string-slc">'slug'</strong><strong class="hljs-slc">: (</strong><strong class="hljs-string-slc">'name'</strong><strong class="hljs-slc">,)}</strong>
</code></pre>
<p class="normal">Remember that you use the <code class="inlineCode">prepopulated_fields</code> attribute to specify fields where the value is automatically set using the value of other fields. As you have seen before, this is convenient for generating slugs.</p>
<p class="normal">You use the <code class="inlineCode">list_editable</code> attribute in the <code class="inlineCode">ProductAdmin</code> class to set the fields that can be edited from the list display page of the administration site. This will allow you to edit multiple rows at once. Any field in <code class="inlineCode">list_editable</code> must also be listed in the <code class="inlineCode">list_display</code> attribute since <a id="_idIndexMarker731"/>only the fields displayed can be edited.</p>
<p class="normal">Now create a superuser for your site using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py createsuperuser
</code></pre>
<p class="normal">Enter the desired username, email, and password. Run the development server with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/admin/shop/product/add/</code> in your browser and log in with the user that you just created. Add a new category and product using the administration interface. The <strong class="keyWord">Add product</strong> form should look as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_08_04.png"/></figure>
<p class="packt_figref">Figure 8.4: The product creation form</p>
<p class="normal">Click on the <strong class="screenText">SAVE</strong> button. The<a id="_idIndexMarker732"/> product change list page of the administration page will then look like this:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_08_05.png"/></figure>
<p class="packt_figref">Figure 8.5: The product change list page</p>
<h2 class="heading-2" id="_idParaDest-230">Building catalog views</h2>
<p class="normal">In order to display the product catalog, you <a id="_idIndexMarker733"/>need to create a view to list all the products or filter products by a given category. Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">shop</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django.shortcuts import <strong class="hljs-slc">get_object_or_404, </strong>render
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> .models </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> Category, Product</strong>
<strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">product_list</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">request, category_slug=</strong><strong class="hljs-literal-slc">None</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc">    category = </strong><strong class="hljs-literal-slc">None</strong>
<strong class="hljs-slc">    categories = Category.objects.</strong><strong class="hljs-built_in-slc">all</strong><strong class="hljs-slc">()</strong>
<strong class="hljs-slc">    products = Product.objects.</strong><strong class="hljs-built_in-slc">filter</strong><strong class="hljs-slc">(available=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> category_slug:</strong>
<strong class="hljs-slc">        category = get_object_or_404(Category, </strong><strong class="hljs-slc">slug=category_slug)</strong>
<strong class="hljs-slc">        products = products.</strong><strong class="hljs-built_in-slc">filter</strong><strong class="hljs-slc">(category=category)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> render(</strong>
<strong class="hljs-keyword-slc"> </strong><strong class="hljs-slc">request,</strong>
<strong class="hljs-keyword-slc"> </strong><strong class="hljs-string-slc">'shop/product/list.html'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-keyword-slc"> </strong><strong class="hljs-slc">{</strong>
<strong class="hljs-keyword-slc"> </strong><strong class="hljs-string-slc">'category'</strong><strong class="hljs-slc">: category,</strong>
<strong class="hljs-keyword-slc"> </strong><strong class="hljs-string-slc">'categories'</strong><strong class="hljs-slc">: categories,</strong>
<strong class="hljs-keyword-slc"> </strong><strong class="hljs-string-slc">'</strong><strong class="hljs-string-slc">products'</strong><strong class="hljs-slc">: products</strong>
<strong class="hljs-keyword-slc"> </strong><strong class="hljs-slc">}</strong>
<strong class="hljs-slc">    )</strong>
</code></pre>
<p class="normal">In the preceding code, you filter the <code class="inlineCode">QuerySet</code> with <code class="inlineCode">available=True</code> to retrieve only available products. You<a id="_idIndexMarker734"/> use an optional <code class="inlineCode">category_slug</code> parameter to optionally filter products by a given category.</p>
<p class="normal">You also need a view to retrieve and display a single product. Add the following view to the <code class="inlineCode">views.py</code> file:</p>
<pre class="programlisting code"><code class="hljs-code">def product_detail(request, id, slug):
    product = get_object_or_404(
        Product, id=id, slug=slug, available=True
 )
    return render(
 request,
 shop/product/detail.html',
 {'product': product}
    )
</code></pre>
<p class="normal">The <code class="inlineCode">product_detail</code> view expects the <code class="inlineCode">id</code> and <code class="inlineCode">slug</code> parameters in order to retrieve the <code class="inlineCode">Product</code> instance. You can get this instance just through the ID since it’s a unique attribute. However, you include the slug in the URL to build SEO-friendly URLs for products.</p>
<p class="normal">After building the product list and detail views, you have to define URL patterns for them. Create a new file inside the <code class="inlineCode">shop</code> application directory and name it <code class="inlineCode">urls.py</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.urls import path
from . import views
app_name = 'shop'
urlpatterns = [
    path('', views.product_list, name='product_list'),
    path(
        '&lt;slug:category_slug&gt;/',
        views.product_list,
        name='product_list_by_category'
    ),
    path(
        '&lt;int:id&gt;/&lt;slug:slug&gt;/',
        views.product_detail,
        name='product_detail'
    ),
]
</code></pre>
<p class="normal">These are the URL patterns for your product catalog. You have defined two different URL patterns for the <code class="inlineCode">product_list</code> view: a pattern named <code class="inlineCode">product_list</code>, which calls the <code class="inlineCode">product_list</code> view without any parameters, and a pattern named <code class="inlineCode">product_list_by_category</code>, which provides a <code class="inlineCode">category_slug</code> parameter to the view for filtering products according to a given category. You added a pattern for the <code class="inlineCode">product_detail</code> view, which <a id="_idIndexMarker735"/>passes the <code class="inlineCode">id</code> and <code class="inlineCode">slug</code> parameters to the view in order to retrieve a specific product.</p>
<p class="normal">Edit the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">myshop</code> project to make it look like this:</p>
<pre class="programlisting code"><code class="hljs-code">from django.contrib import admin
from django.urls import <strong class="hljs-slc">include, </strong>path
urlpatterns = [
    path('admin/', admin.site.urls),
    <strong class="hljs-slc">path(</strong><strong class="hljs-string-slc">''</strong><strong class="hljs-slc">, include(</strong><strong class="hljs-string-slc">'shop.urls'</strong><strong class="hljs-slc">, namespace=</strong><strong class="hljs-string-slc">'shop'</strong><strong class="hljs-slc">)),</strong>
]
</code></pre>
<p class="normal">In the main URL patterns of the project, you include URLs for the <code class="inlineCode">shop</code> application under a custom namespace named <code class="inlineCode">shop</code>.</p>
<p class="normal">Next, edit the <code class="inlineCode">models.py</code> file of the <code class="inlineCode">shop</code> application, import the <code class="inlineCode">reverse()</code> function, and add a <code class="inlineCode">get_absolute_url()</code> method<a id="_idIndexMarker736"/> to the <code class="inlineCode">Category</code> and <code class="inlineCode">Product</code> models, as follows. The new code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django.db import models
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.urls </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> reverse</strong>
class Category(models.Model):
    # ...
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">get_absolute_url</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> reverse(</strong>
<strong class="hljs-keyword-slc"> </strong><strong class="hljs-string-slc">'shop:product_list_by_category'</strong><strong class="hljs-slc">, args=[self.slug]</strong>
<strong class="hljs-slc">        )</strong>
class Product(models.Model):
    # ...
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">get_absolute_url</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> reverse(</strong><strong class="hljs-string-slc">'shop:product_detail'</strong><strong class="hljs-slc">, args=[self.</strong><strong class="hljs-built_in-slc">id</strong><strong class="hljs-slc">, self.slug])</strong>
</code></pre>
<p class="normal">As you already know, <code class="inlineCode">get_absolute_url()</code> is the convention to retrieve the URL for a given object. Here, you use the URL patterns that you just defined in the <code class="inlineCode">urls.py</code> file.</p>
<h2 class="heading-2" id="_idParaDest-231">Creating catalog templates</h2>
<p class="normal">Now you need to create<a id="_idIndexMarker737"/> templates for the product list and detail views. Create the following directory and file structure inside the <code class="inlineCode">shop</code> application directory:</p>
<pre class="programlisting con"><code class="hljs-con">templates/
    shop/
        base.html
        product/
            list.html
            detail.html
</code></pre>
<p class="normal">You need to define a base template and then extend it in the product list and detail templates. Edit the <code class="inlineCode">shop/base.html</code> template and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% load static %}
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta charset="utf-8" /&gt;
&lt;title&gt;{% block title %}My shop{% endblock %}&lt;/title&gt;
&lt;link href="{% static "css/base.css" %}" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div id="header"&gt;
&lt;a href="/" class="logo"&gt;My shop&lt;/a&gt;
&lt;/div&gt;
&lt;div id="subheader"&gt;
&lt;div class="cart"&gt;
        Your cart is empty.
      &lt;/div&gt;
&lt;/div&gt;
&lt;div id="content"&gt;
      {% block content %}
      {% endblock %}
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p class="normal">This is the base template that you will use for your shop. In order to include the CSS styles and images that are used by the templates, you need to copy the static files that accompany this chapter, which are <a id="_idIndexMarker738"/>located in the <code class="inlineCode">static/</code> directory of the <code class="inlineCode">shop</code> application. Copy them to the same location in your project. You can find the contents of the directory at <a href="https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter08/myshop/shop/static">https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter08/myshop/shop/static</a>.</p>
<p class="normal">Edit the <code class="inlineCode">shop/product/list.html</code> template and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "shop/base.html" %}
{% load static %}
{% block title %}
  {% if category %}{{ category.name }}{% else %}Products{% endif %}
{% endblock %}
{% block content %}
  &lt;div id="sidebar"&gt;
&lt;h3&gt;Categories&lt;/h3&gt;
&lt;ul&gt;
&lt;li {% if not category %}class="selected"{% endif %}&gt;
&lt;a href="{% url "shop:product_list" %}"&gt;All&lt;/a&gt;
&lt;/li&gt;
      {% for c in categories %}
        &lt;li {% if category.slug == c.slug %}class="selected"
        {% endif %}&gt;
&lt;a href="{{ c.get_absolute_url }}"&gt;{{ c.name }}&lt;/a&gt;
&lt;/li&gt;
      {% endfor %}
    &lt;/ul&gt;
&lt;/div&gt;
&lt;div id="main" class="product-list"&gt;
&lt;h1&gt;{% if category %}{{ category.name }}{% else %}Products
    {% endif %}&lt;/h1&gt;
    {% for product in products %}
      &lt;div class="item"&gt;
&lt;a href="{{ product.get_absolute_url }}"&gt;
&lt;img src="img/{% if product.image %}{{ product.image.url }}{% else %}{% static "img/no_image.png" %}{% endif %}"&gt;
&lt;/a&gt;
&lt;a href="{{ product.get_absolute_url }}"&gt;{{ product.name }}&lt;/a&gt;
&lt;br&gt;
        ${{ product.price }}
      &lt;/div&gt;
    {% endfor %}
  &lt;/div&gt;
{% endblock %}
</code></pre>
<p class="normal">Make sure that no template tag is split across multiple lines.</p>
<p class="normal">This is the product list<a id="_idIndexMarker739"/> template. It extends the <code class="inlineCode">shop/base.html</code> template and uses the <code class="inlineCode">categories</code> context variable to display all the categories in a sidebar, and <code class="inlineCode">products</code> to display the products of the current page. The same template is used for both listing all available products and listing products filtered by category. Since the <code class="inlineCode">image</code> field of the <code class="inlineCode">Product</code> model can be blank, you need to provide a default image for the products that don’t have an image. The image is located in your static files directory with the relative path <code class="inlineCode">img/no_image.png</code>.</p>
<p class="normal">Since you are using <code class="inlineCode">ImageField</code> to store product images, you need the development server to serve uploaded image files.</p>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of <code class="inlineCode">myshop</code> and add the following settings:</p>
<pre class="programlisting code"><code class="hljs-code">MEDIA_URL = 'media/'
MEDIA_ROOT = BASE_DIR / 'media'
</code></pre>
<p class="normal"><code class="inlineCode">MEDIA_URL</code> is the base URL that serves media files uploaded by users. <code class="inlineCode">MEDIA_ROOT</code> is the local path where these files reside, which you build by dynamically prepending the <code class="inlineCode">BASE_DIR</code> variable.</p>
<p class="normal">For Django to serve the<a id="_idIndexMarker740"/> uploaded media files using the development server, edit the main <code class="inlineCode">urls.py</code> file of <code class="inlineCode">myshop</code> and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.conf </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> settings</strong>
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.conf.urls.static </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> static</strong>
from django.contrib import admin
from django.urls import include, path
urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('shop.urls', namespace='shop')),
]
<strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> settings.DEBUG:</strong>
<strong class="hljs-slc">    urlpatterns += static(</strong>
<strong class="hljs-slc">        settings.MEDIA_URL, document_root=settings.MEDIA_ROOT</strong>
<strong class="hljs-slc">    )</strong>
</code></pre>
<p class="normal">Remember that you only serve static files this way during development. In a production environment, you should never serve static files with Django; the Django development server doesn’t serve static files in an efficient manner. <em class="italic">Chapter 17</em>, <em class="italic">Going Live</em>, will teach you how to serve static files in a production environment.</p>
<p class="normal">Run the development server with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Add a couple of products to your shop using the administration site and open <code class="inlineCode">http://127.0.0.1:8000/</code> in your browser. You will see the product list page, which will look similar to this:</p>
<figure class="mediaobject"><img alt="Graphical user interface, website  Description automatically generated" src="img/B21088_08_06.png"/></figure>
<p class="packt_figref">Figure 8.6: The product list page</p>
<div><p class="normal">Credits for images in this chapter:</p>
<ul>
<li class="bulletList"><em class="italic">Green tea</em>: Photo by Jia Ye on Unsplash</li>
<li class="bulletList"><em class="italic">Red tea</em>: Photo by Manki Kim on Unsplash</li>
<li class="bulletList"><em class="italic">Tea powder</em>: Photo by Phuong Nguyen on Unsplash</li>
</ul>
</div>
<p class="normal">If you create a product <a id="_idIndexMarker741"/>using the administration site and don’t upload an image for it, the default <code class="inlineCode">no_image.png</code> image will be displayed instead:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_08_07.png"/></figure>
<p class="packt_figref">Figure 8.7: The product list displaying a default image for products that have no image</p>
<p class="normal">Edit the <code class="inlineCode">shop/product/detail.html</code> template and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "shop/base.html" %}
{% load static %}
{% block title %}
  {{ product.name }}
{% endblock %}
{% block content %}
  &lt;div class="product-detail"&gt;
&lt;img src="{% if product.image %}{{ product.image.url }}{% else %}
    {% static "img/no_image.png" %}{% endif %}"&gt;
&lt;h1&gt;{{ product.name }}&lt;/h1&gt;
&lt;h2&gt;
&lt;a href="{{ product.category.get_absolute_url }}"&gt;
        {{ product.category }}
      &lt;/a&gt;
&lt;/h2&gt;
&lt;p class="price"&gt;${{ product.price }}&lt;/p&gt;
    {{ product.description|linebreaks }}
  &lt;/div&gt;
{% endblock %}
</code></pre>
<p class="normal">In the preceding code, you<a id="_idIndexMarker742"/> call the <code class="inlineCode">get_absolute_url()</code> method on the related category object to display the available products that belong to the same category.</p>
<p class="normal">Now open <code class="inlineCode">http://127.0.0.1:8000/</code> in your browser and click on any product to see the product detail page. It will look as follows:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" src="img/B21088_08_08.png"/></figure>
<p class="packt_figref">Figure 8.8: The product detail page</p>
<p class="normal">You have now created a basic product catalog. Next, you will implement a shopping cart that allows users to add <a id="_idIndexMarker743"/>any product to it while browsing the online shop.</p>
<h1 class="heading-1" id="_idParaDest-232">Building a shopping cart</h1>
<p class="normal">After building the product catalog, the next step is to create a shopping cart so that users can pick the products that they want to purchase. A shopping cart allows users to select products and set the amount they want to order, and then store this information temporarily while they browse the<a id="_idIndexMarker744"/> site until they eventually place an order. The cart has to be persisted in the session so that the cart items are maintained during a user’s visit.</p>
<p class="normal">You will use Django’s session framework to persist the cart. The cart will be kept in the session until it finishes or the user checks out the cart. You will also need to build additional Django models for the cart and its items.</p>
<h2 class="heading-2" id="_idParaDest-233">Using Django sessions</h2>
<p class="normal">Django provides a session framework that<a id="_idIndexMarker745"/> supports anonymous and user sessions. The session framework allows you to store arbitrary data for each visitor. Session data is stored on the server side, and cookies contain the session ID unless you use the cookie-based session engine. The session middleware manages the sending and receiving of cookies. The default session engine stores session data in the database, but you can choose other session engines.</p>
<p class="normal">To use sessions, you have to make sure that the <code class="inlineCode">MIDDLEWARE</code> setting of your project contains <code class="inlineCode">django.contrib.sessions.middleware.SessionMiddleware</code>. This middleware manages sessions. It’s added by default to the <code class="inlineCode">MIDDLEWARE</code> setting when you create a new project using the <code class="inlineCode">startproject</code> command.</p>
<p class="normal">The session middleware <a id="_idIndexMarker746"/>makes the current session available in the <code class="inlineCode">request</code> object. You can access the current session using <code class="inlineCode">request.session</code>, treating it like a Python dictionary to store and retrieve session data. The <code class="inlineCode">session</code> dictionary accepts any Python object by default that can be serialized to JSON. You can set a variable in the session like this:</p>
<pre class="programlisting code"><code class="hljs-code">request.session['foo'] = 'bar'
</code></pre>
<p class="normal">You can retrieve a session key as follows:</p>
<pre class="programlisting code"><code class="hljs-code">request.session.get('foo')
</code></pre>
<p class="normal">You can delete a key you previously stored in the session as follows:</p>
<pre class="programlisting code"><code class="hljs-code">del request.session['foo']
</code></pre>
<div><p class="normal">When users log in to the site, their anonymous session is lost, and a new session is created for authenticated users. If you store items in an anonymous session that you need to keep after the user logs in, you will have to copy the old session data into the new session. You can do this by retrieving the session data before you log in the user using the <code class="inlineCode">login()</code> function of the Django authentication system and storing it in the session after that.</p>
</div>
<h2 class="heading-2" id="_idParaDest-234">Session settings</h2>
<p class="normal">There are several settings you can<a id="_idIndexMarker747"/> use to configure sessions for your project. The most important is <code class="inlineCode">SESSION_ENGINE</code>. This setting allows you to set the place where sessions are stored. By default, Django stores sessions in the database using the <code class="inlineCode">Session</code> model of the <code class="inlineCode">django.contrib.sessions</code> application.</p>
<p class="normal">Django offers the following options for storing session data:</p>
<ul>
<li class="bulletList"><strong class="keyWord">Database sessions</strong>: Session data is stored in the database. This is the default session engine.</li>
<li class="bulletList"><strong class="keyWord">File-based sessions</strong>: Session data is stored in the filesystem.</li>
<li class="bulletList"><strong class="keyWord">Cached sessions</strong>: Session data is stored in a cache backend. You can specify cache backends using the <code class="inlineCode">CACHES</code> setting. Storing session data in a cache system provides the best performance.</li>
<li class="bulletList"><strong class="keyWord">Cached database sessions</strong>: Session data is stored in a write-through cache and database. Reads only use the database if the data is not already in the cache.</li>
<li class="bulletList"><strong class="keyWord">Cookie-based sessions</strong>: Session data is stored in the cookies that are sent to the browser.</li>
</ul>
<div><p class="normal">For better performance use a cache-based session engine. Django supports Memcached out of the box and you can find third-party cache backends for Redis and other cache systems.</p>
</div>
<p class="normal">You can customize sessions with <a id="_idIndexMarker748"/>specific settings. Here are some of the important session-related settings:</p>
<ul>
<li class="bulletList"><code class="inlineCode">SESSION_COOKIE_AGE</code>: The duration of session cookies in seconds. The default value is <code class="inlineCode">1209600</code> (two weeks).</li>
<li class="bulletList"><code class="inlineCode">SESSION_COOKIE_DOMAIN</code>: The domain used for session cookies. Set this to <code class="inlineCode">mydomain.com</code> to enable cross-domain cookies or use <code class="inlineCode">None</code> for a standard domain cookie.</li>
<li class="bulletList"><code class="inlineCode">SESSION_COOKIE_HTTPONLY</code>: Whether to use the <code class="inlineCode">HttpOnly</code> flag on the session cookie. If this is set to <code class="inlineCode">True</code>, client-side JavaScript will not be able to access the session cookie. The default value is <code class="inlineCode">True</code> for increased security against user session hijacking.</li>
<li class="bulletList"><code class="inlineCode">SESSION_COOKIE_SECURE</code>: A Boolean indicating that the cookie should only be sent if the connection is an HTTPS connection. The default value is <code class="inlineCode">False</code>.</li>
<li class="bulletList"><code class="inlineCode">SESSION_EXPIRE_AT_BROWSER_CLOSE</code>: A Boolean indicating that the session has to expire when the browser is closed. The default value is <code class="inlineCode">False</code>.</li>
<li class="bulletList"><code class="inlineCode">SESSION_SAVE_EVERY_REQUEST</code>: A Boolean that, if <code class="inlineCode">True</code>, will save the session to the database on every request. The session expiration is also updated each time it’s saved. The default value is <code class="inlineCode">False</code>.</li>
</ul>
<p class="normal">You can see all the session settings and their default values at <a href="https://docs.djangoproject.com/en/5.0/ref/settings/#sessions">https://docs.djangoproject.com/en/5.0/ref/settings/#sessions</a>.</p>
<h2 class="heading-2" id="_idParaDest-235">Session expiration</h2>
<p class="normal">You can choose to use browser-length <a id="_idIndexMarker749"/>sessions or persistent sessions using the <code class="inlineCode">SESSION_EXPIRE_AT_BROWSER_CLOSE</code> setting. This is set to <code class="inlineCode">False</code> by default, forcing the session duration to the value stored in the <code class="inlineCode">SESSION_COOKIE_AGE</code> setting. If you set <code class="inlineCode">SESSION_EXPIRE_AT_BROWSER_CLOSE</code> to <code class="inlineCode">True</code>, the session will expire when the user closes the browser, and the <code class="inlineCode">SESSION_COOKIE_AGE</code> setting will not have any effect.</p>
<p class="normal">You can use the <code class="inlineCode">set_expiry()</code> method of <code class="inlineCode">request.session</code> to overwrite the duration of the current session.</p>
<h2 class="heading-2" id="_idParaDest-236">Storing shopping carts in sessions</h2>
<p class="normal">You need to create a simple<a id="_idIndexMarker750"/> structure that can be serialized to JSON for storing cart items in a session. The cart has to include the following data for each item contained in it:</p>
<ul>
<li class="bulletList">The ID of a <code class="inlineCode">Product</code> instance</li>
<li class="bulletList">The quantity selected for the product</li>
<li class="bulletList">The unit price for the product</li>
</ul>
<p class="normal">Since product prices may vary, let’s take the approach of storing the product’s price along with the product itself when it’s added to the cart. By doing so, you use the current price of the product when users add it to their cart, no matter whether the product’s price is changed afterward. This means that the price that the item has when the client adds it to the cart is maintained for that client in the session until checkout is completed or the session finishes.</p>
<p class="normal">Next, you have to build functionality to create shopping carts and associate them with sessions. This has to work as follows:</p>
<ul>
<li class="bulletList">When a cart is needed, you check whether a custom session key is set. If no cart is set in the session, you create a new cart and save it in the cart session key.</li>
<li class="bulletList">For successive requests, you perform the same check and get the cart items from the cart session key. You retrieve the cart items from the session and their related <code class="inlineCode">Product</code> objects from the database.</li>
</ul>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of your project and add the following setting to it:</p>
<pre class="programlisting code"><code class="hljs-code">CART_SESSION_ID = 'cart'
</code></pre>
<p class="normal">This is the key that you are going to use to store the cart in the user session. Since Django sessions are managed per visitor, you can use the same cart session key for all sessions.</p>
<p class="normal">Let’s create an application for<a id="_idIndexMarker751"/> managing shopping carts. Open the terminal and create a new application, running the following command from the project directory:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py startapp cart
</code></pre>
<p class="normal">Then, edit the <code class="inlineCode">settings.py</code> file of your project and add the new application to the <code class="inlineCode">INSTALLED_APPS</code> setting with the following line highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">INSTALLED_APPS = [
    # ...
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'</strong><strong class="hljs-string-slc">cart.apps.CartConfig'</strong><strong class="hljs-slc">,</strong>
'shop.apps.ShopConfig',
]
</code></pre>
<p class="normal">Create a new file inside the <code class="inlineCode">cart</code> application directory and name it <code class="inlineCode">cart.py</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from decimal import Decimal
from django.conf import settings
from shop.models import Product
class Cart:
    def __init__(self, request):
        """
        Initialize the cart.
        """
        self.session = request.session
        cart = self.session.get(settings.CART_SESSION_ID)
        if not cart:
            # save an empty cart in the session
            cart = self.session[settings.CART_SESSION_ID] = {}
        self.cart = cart
</code></pre>
<p class="normal">This is the <code class="inlineCode">Cart</code> class that will allow you to manage the shopping cart. You require the cart to be initialized with a <code class="inlineCode">request</code> object. You store the current session using <code class="inlineCode">self.session = request.session</code> to make it accessible to the other methods of the <code class="inlineCode">Cart</code> class.</p>
<p class="normal">First, you try to get the cart from the current session using <code class="inlineCode">self.session.get(settings.CART_SESSION_ID)</code>. If no cart is present in the session, you create an empty cart by setting an empty dictionary in the session.</p>
<p class="normal">You will build your <code class="inlineCode">cart</code> dictionary with product IDs as keys, and for each product key, a dictionary will be a value that includes quantity and price. By doing this, you can guarantee that a product will not be added more than once to the cart. This way, you can also simplify retrieving <a id="_idIndexMarker752"/>cart items.</p>
<p class="normal">Let’s create a method to add products to the cart or update their quantity. Add the following <code class="inlineCode">add()</code> and <code class="inlineCode">save()</code> methods to the <code class="inlineCode">Cart</code> class:</p>
<pre class="programlisting code"><code class="hljs-code">class Cart:
    # ...
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">add</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self, product, quantity=</strong><strong class="hljs-number-slc">1</strong><strong class="hljs-params-slc">, override_quantity=</strong><strong class="hljs-literal-slc">False</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"""</strong>
<strong class="hljs-string-slc">        Add a product to the cart or update its quantity.</strong>
<strong class="hljs-string-slc">        """</strong>
<strong class="hljs-slc">        product_id = </strong><strong class="hljs-built_in-slc">str</strong><strong class="hljs-slc">(product.</strong><strong class="hljs-built_in-slc">id</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> product_id </strong><strong class="hljs-keyword-slc">not</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">in</strong><strong class="hljs-slc"> self.cart:</strong>
<strong class="hljs-slc">            self.cart[product_id] = {</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'quantity'</strong><strong class="hljs-slc">: </strong><strong class="hljs-number-slc">0</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'price'</strong><strong class="hljs-slc">: </strong><strong class="hljs-built_in-slc">str</strong><strong class="hljs-slc">(product.price)</strong>
<strong class="hljs-slc">            }</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> override_quantity:</strong>
<strong class="hljs-slc">            self.cart[product_id][</strong><strong class="hljs-string-slc">'quantity'</strong><strong class="hljs-slc">] = quantity</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">else</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">            self.cart[product_id][</strong><strong class="hljs-string-slc">'quantity'</strong><strong class="hljs-slc">] += quantity</strong>
<strong class="hljs-slc">        self.save()</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">save</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># mark the session as "modified" to make sure it gets saved</strong>
<strong class="hljs-slc">        self.session.modified = </strong><strong class="hljs-literal-slc">True</strong>
</code></pre>
<p class="normal">The <code class="inlineCode">add()</code> method takes the following parameters as input:</p>
<ul>
<li class="bulletList"><code class="inlineCode">product</code>: The <code class="inlineCode">product</code> instance to add or update in the cart.</li>
<li class="bulletList"><code class="inlineCode">quantity</code>: An optional integer with the product quantity. This defaults to <code class="inlineCode">1</code>.</li>
<li class="bulletList"><code class="inlineCode">override_quantity</code>: A Boolean that indicates whether the quantity needs to be overridden with the given quantity (<code class="inlineCode">True</code>) or whether the new quantity has to be added to the existing quantity (<code class="inlineCode">False</code>).</li>
</ul>
<p class="normal">You use the product ID as a key<a id="_idIndexMarker753"/> in the cart’s content dictionary. You convert the product ID into a string because Django uses JSON to serialize session data, and JSON only allows string key names. The product ID is the key, and the value that you persist is a dictionary with quantity and price figures for the product. The product’s price is converted from decimal into a string to serialize it. Finally, you call the <code class="inlineCode">save()</code> method to save the cart in the session.</p>
<p class="normal">The <code class="inlineCode">save()</code> method marks the session as modified using <code class="inlineCode">session.modified = True</code>. This tells Django that the session has changed and needs to be saved.</p>
<p class="normal">You also need a method for removing products from the cart. Add the following method to the <code class="inlineCode">Cart</code> class:</p>
<pre class="programlisting code"><code class="hljs-code">class Cart:
    # ...
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">remove</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self, product</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"""</strong>
<strong class="hljs-string-slc">        Remove a product from the cart.</strong>
<strong class="hljs-string-slc">        """</strong>
<strong class="hljs-slc">        product_id = </strong><strong class="hljs-built_in-slc">str</strong><strong class="hljs-slc">(product.</strong><strong class="hljs-built_in-slc">id</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> product_id </strong><strong class="hljs-keyword-slc">in</strong><strong class="hljs-slc"> self.cart:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">del</strong><strong class="hljs-slc"> self.cart[product_id]</strong>
<strong class="hljs-slc">            self.save()</strong>
</code></pre>
<p class="normal">The <code class="inlineCode">remove()</code> method removes a given product from the <code class="inlineCode">cart</code> dictionary and calls the <code class="inlineCode">save()</code> method to update the cart in the session.</p>
<p class="normal">You will have to iterate through the items contained in the cart and access the related <code class="inlineCode">Product</code> instances. To do so, you can define an <code class="inlineCode">__iter__()</code> method in your class. Add the following method to the <code class="inlineCode">Cart</code> class:</p>
<pre class="programlisting code"><code class="hljs-code">class Cart:
    # ...
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">__iter__</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"""</strong>
<strong class="hljs-string-slc">        Iterate over the items in the cart and get the products</strong>
<strong class="hljs-string-slc">        from the database.</strong>
<strong class="hljs-string-slc">        """</strong>
<strong class="hljs-slc">        product_ids = self.cart.keys()</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># get the product objects and add them to the cart</strong>
<strong class="hljs-slc">        products = Product.objects.</strong><strong class="hljs-built_in-slc">filter</strong><strong class="hljs-slc">(id__in=product_ids)</strong>
<strong class="hljs-slc">        cart = self.cart.copy()</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">for</strong><strong class="hljs-slc"> product </strong><strong class="hljs-keyword-slc">in</strong><strong class="hljs-slc"> products:</strong>
<strong class="hljs-slc">            cart[</strong><strong class="hljs-built_in-slc">str</strong><strong class="hljs-slc">(product.</strong><strong class="hljs-built_in-slc">id</strong><strong class="hljs-slc">)][</strong><strong class="hljs-string-slc">'product'</strong><strong class="hljs-slc">] = product</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">for</strong><strong class="hljs-slc"> item </strong><strong class="hljs-keyword-slc">in</strong><strong class="hljs-slc"> cart.values():</strong>
<strong class="hljs-slc">            item[</strong><strong class="hljs-string-slc">'price'</strong><strong class="hljs-slc">] = Decimal(item[</strong><strong class="hljs-string-slc">'price'</strong><strong class="hljs-slc">])</strong>
<strong class="hljs-slc">            item[</strong><strong class="hljs-string-slc">'total_price'</strong><strong class="hljs-slc">] = item[</strong><strong class="hljs-string-slc">'price'</strong><strong class="hljs-slc">] * item[</strong><strong class="hljs-string-slc">'quantity'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">yield</strong><strong class="hljs-slc"> item</strong>
</code></pre>
<p class="normal">In the <code class="inlineCode">__iter__()</code> method, you retrieve the <code class="inlineCode">Product</code> instances that are present in the cart to include them in the cart <a id="_idIndexMarker754"/>items. You copy the current cart in the <code class="inlineCode">cart</code> variable and add the <code class="inlineCode">Product</code> instances to it. Finally, you iterate over the cart items, converting each item’s price back into decimal, and adding a <code class="inlineCode">total_price</code> attribute to each item. This <code class="inlineCode">__iter__()</code> method will allow you to easily iterate over the items in the cart in views and templates.</p>
<p class="normal">You also need a way to return the total number of items in the cart. When the <code class="inlineCode">len()</code> function is executed on an object, Python calls its <code class="inlineCode">__len__()</code> method to retrieve its length. Next, you are going to define a custom <code class="inlineCode">__len__()</code> method to return the total number of items stored in the cart.</p>
<p class="normal">Add the following <code class="inlineCode">__len__()</code> method to the <code class="inlineCode">Cart</code> class:</p>
<pre class="programlisting code"><code class="hljs-code">class Cart:
    # ...
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">__len__</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"""</strong>
<strong class="hljs-string-slc">        Count all items in the cart.</strong>
<strong class="hljs-string-slc">        """</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">sum</strong><strong class="hljs-slc">(item[</strong><strong class="hljs-string-slc">'quantity'</strong><strong class="hljs-slc">] </strong><strong class="hljs-keyword-slc">for</strong><strong class="hljs-slc"> item </strong><strong class="hljs-keyword-slc">in</strong><strong class="hljs-slc"> self.cart.values())</strong>
</code></pre>
<p class="normal">You return the sum of the quantities of all the cart items.</p>
<p class="normal">Add the following method to calculate the total cost of the items in the cart:</p>
<pre class="programlisting code"><code class="hljs-code">class Cart:
    # ...
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">get_total_price</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">sum</strong><strong class="hljs-slc">(</strong>
<strong class="hljs-keyword-slc"> </strong><strong class="hljs-slc">Decimal(item[</strong><strong class="hljs-string-slc">'price'</strong><strong class="hljs-slc">]) * item[</strong><strong class="hljs-string-slc">'quantity'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">for</strong><strong class="hljs-slc"> item </strong><strong class="hljs-keyword-slc">in</strong><strong class="hljs-slc"> self.cart.values()</strong>
<strong class="hljs-slc">        )</strong>
</code></pre>
<p class="normal">Finally, add a method to clear the cart session:</p>
<pre class="programlisting code"><code class="hljs-code">class Cart:
    # ...
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">clear</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># remove cart from session</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">del</strong><strong class="hljs-slc"> self.session[settings.CART_SESSION_ID]</strong>
<strong class="hljs-slc">        self.save()</strong>
</code></pre>
<p class="normal">Your <code class="inlineCode">Cart</code> class is now ready to <a id="_idIndexMarker755"/>manage shopping carts.</p>
<h2 class="heading-2" id="_idParaDest-237">Creating shopping cart views</h2>
<p class="normal">Now that you have a <code class="inlineCode">Cart</code> class to <a id="_idIndexMarker756"/>manage the cart, you need to create the <a id="_idIndexMarker757"/>views to add, update, or remove items from it. You need to create the following views:</p>
<ul>
<li class="bulletList">A view to add or update items in the cart that can handle current and new quantities</li>
<li class="bulletList">A view to remove items from the cart</li>
<li class="bulletList">A view to display cart items and totals</li>
</ul>
<h3 class="heading-3" id="_idParaDest-238">Adding items to the cart</h3>
<p class="normal">To add items to the cart, you need a form that<a id="_idIndexMarker758"/> allows the user to select a quantity. Create a <code class="inlineCode">forms.py</code> file inside the <code class="inlineCode">cart</code> application directory and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django import forms
PRODUCT_QUANTITY_CHOICES = [(i, str(i)) for i in range(1, 21)]
class CartAddProductForm(forms.Form):
    quantity = forms.TypedChoiceField(
        choices=PRODUCT_QUANTITY_CHOICES,
        coerce=int
    )
    override = forms.BooleanField(
        required=False,
        initial=False,
        widget=forms.HiddenInput
    )
</code></pre>
<p class="normal">You will use this form to add products to the cart. Your <code class="inlineCode">CartAddProductForm</code> class contains the following two fields:</p>
<ul>
<li class="bulletList"><code class="inlineCode">quantity</code>: This allows the user to select a quantity between 1 and 20. You use a <code class="inlineCode">TypedChoiceField</code> field with <code class="inlineCode">coerce=int</code> to convert the input into an integer.</li>
<li class="bulletList"><code class="inlineCode">override</code>: This allows<a id="_idIndexMarker759"/> you to indicate whether the quantity has to be added to any existing quantity in the cart for this product (<code class="inlineCode">False</code>) or whether the existing quantity has to be overridden with the given quantity (<code class="inlineCode">True</code>). You use a <code class="inlineCode">HiddenInput</code> widget for this field since you don’t want to display it to the user.</li>
</ul>
<p class="normal">Let’s create a view for adding items to the cart. Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">cart</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django.shortcuts import <strong class="hljs-slc">get_object_or_404, redirect, </strong>render
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.views.decorators.http </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> require_POST</strong>
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> shop.models </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> Product</strong>
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> .cart </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> Cart</strong>
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> .forms </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> CartAddProductForm</strong>
<strong class="hljs-meta-slc">@require_POST</strong>
<strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">cart_add</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">request, product_id</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc">    cart = Cart(request)</strong>
<strong class="hljs-slc">    product = get_object_or_404(Product, </strong><strong class="hljs-built_in-slc">id</strong><strong class="hljs-slc">=product_id)</strong>
<strong class="hljs-slc">    form = CartAddProductForm(request.POST)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> form.is_valid():</strong>
<strong class="hljs-slc">        cd = form.cleaned_data</strong>
<strong class="hljs-slc">        cart.add(</strong>
<strong class="hljs-slc">            product=product,</strong>
<strong class="hljs-slc">            quantity=cd[</strong><strong class="hljs-string-slc">'quantity'</strong><strong class="hljs-slc">],</strong>
<strong class="hljs-slc">            override_quantity=cd[</strong><strong class="hljs-string-slc">'override'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">        )</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> redirect(</strong><strong class="hljs-string-slc">'cart:cart_detail'</strong><strong class="hljs-slc">)</strong>
</code></pre>
<p class="normal">This is the view for adding products to the cart or updating quantities for existing products. You use the <code class="inlineCode">require_POST</code> decorator to allow only <code class="inlineCode">POST</code> requests. The view receives the product ID as a parameter. You retrieve the <code class="inlineCode">Product</code> instance with the given ID and validate <code class="inlineCode">CartAddProductForm</code>. If the form is valid, you either add or update the product in the cart. The view redirects to the <code class="inlineCode">cart_detail</code> URL, which will display the contents of the cart. You are<a id="_idIndexMarker760"/> going to create the <code class="inlineCode">cart_detail</code> view shortly.</p>
<p class="normal">You also need a view to remove items from the cart. Add the following code to the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">cart</code> application:</p>
<pre class="programlisting code"><code class="hljs-code">@require_POST
def cart_remove(request, product_id):
    cart = Cart(request)
    product = get_object_or_404(Product, id=product_id)
    cart.remove(product)
    return redirect('cart:cart_detail')
</code></pre>
<p class="normal">The <code class="inlineCode">cart_remove</code> view receives the product ID as a parameter. You use the <code class="inlineCode">require_POST</code> decorator to allow only <code class="inlineCode">POST</code> requests. You retrieve the <code class="inlineCode">Product</code> instance with the given ID and remove the product from the cart. Then, you redirect the user to the <code class="inlineCode">cart_detail</code> URL.</p>
<p class="normal">Finally, you need a view to display the cart and its items. Add the following view to the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">cart</code> application:</p>
<pre class="programlisting code"><code class="hljs-code">def cart_detail(request):
    cart = Cart(request)
    return render(request, 'cart/detail.html', {'cart': cart})
</code></pre>
<p class="normal">The <code class="inlineCode">cart_detail</code> view gets the current cart to display it.</p>
<p class="normal">You have created views to add items to the cart, update quantities, remove items from the cart, and display the cart’s contents. Let’s add URL patterns for these views. Create a new file inside the <code class="inlineCode">cart</code> application directory and name it <code class="inlineCode">urls.py</code>. Add the following URL patterns to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.urls import path
from . import views
app_name = 'cart'
urlpatterns = [
    path('', views.cart_detail, name='cart_detail'),
    path('add/&lt;int:product_id&gt;/', views.cart_add, name='cart_add'),
    path(
        'remove/&lt;int:product_id&gt;/',
        views.cart_remove,
        name='cart_remove'
 ),
]
</code></pre>
<p class="normal">Edit the main <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">myshop</code> project and add the following URL pattern highlighted in bold to include the <a id="_idIndexMarker761"/>cart URLs:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    path('admin/', admin.site.urls),
<strong class="hljs-slc">    path(</strong><strong class="hljs-string-slc">'cart/'</strong><strong class="hljs-slc">, include(</strong><strong class="hljs-string-slc">'cart.urls'</strong><strong class="hljs-slc">, namespace=</strong><strong class="hljs-string-slc">'cart'</strong><strong class="hljs-slc">)),</strong>
    path('', include('shop.urls', namespace='shop')),
]
</code></pre>
<p class="normal">Make sure that you include this URL pattern before the <code class="inlineCode">shop.urls</code> pattern since it’s more restrictive than the latter.</p>
<h3 class="heading-3" id="_idParaDest-239">Building a template to display the cart</h3>
<p class="normal">The <code class="inlineCode">cart_add</code> and <code class="inlineCode">cart_remove</code> views don’t render <a id="_idIndexMarker762"/>any templates, but you need to create a template for the <code class="inlineCode">cart_detail</code> view to display cart items and totals.</p>
<p class="normal">Create the following file structure inside the <code class="inlineCode">cart</code> application directory:</p>
<pre class="programlisting con"><code class="hljs-con">templates/
    cart/
        detail.html
</code></pre>
<p class="normal">Edit the <code class="inlineCode">cart/detail.html</code> template and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "shop/base.html" %}
{% load static %}
{% block title %}
  Your shopping cart
{% endblock %}
{% block content %}
  &lt;h1&gt;Your shopping cart&lt;/h1&gt;
&lt;table class="cart"&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Image&lt;/th&gt;
&lt;th&gt;Product&lt;/th&gt;
&lt;th&gt;Quantity&lt;/th&gt;
&lt;th&gt;Remove&lt;/th&gt;
&lt;th&gt;Unit price&lt;/th&gt;
&lt;th&gt;Price&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
      {% for item in cart %}
        {% with product=item.product %}
          &lt;tr&gt;
&lt;td&gt;
&lt;a href="{{ product.get_absolute_url }}"&gt;
&lt;img src="{% if product.image %}{{ product.image.url }}
                {% else %}{% static "img/no_image.png" %}{% endif %}"&gt;
&lt;/a&gt;
&lt;/td&gt;
&lt;td&gt;{{ product.name }}&lt;/td&gt;
&lt;td&gt;{{ item.quantity }}&lt;/td&gt;
&lt;td&gt;
&lt;form action="{% url "cart:cart_remove" product.id %}" method="post"&gt;
&lt;input type="submit" value="Remove"&gt;
                {% csrf_token %}
              &lt;/form&gt;
&lt;/td&gt;
&lt;td class="num"&gt;${{ item.price }}&lt;/td&gt;
&lt;td class="num"&gt;${{ item.total_price }}&lt;/td&gt;
&lt;/tr&gt;
        {% endwith %}
      {% endfor %}
      &lt;tr class="total"&gt;
&lt;td&gt;Total&lt;/td&gt;
&lt;td colspan="4"&gt;&lt;/td&gt;
&lt;td class="num"&gt;${{ cart.get_total_price }}&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p class="text-right"&gt;
&lt;a href="{% url "shop:product_list" %}" class="button
    light"&gt;Continue shopping&lt;/a&gt;
&lt;a href="#" class="button"&gt;Checkout&lt;/a&gt;
&lt;/p&gt;
{% endblock %}
</code></pre>
<p class="normal">Make sure that no template tag is split across multiple lines.</p>
<p class="normal">This is the template that is used to<a id="_idIndexMarker763"/> display the cart’s contents. It contains a table with the items stored in the current cart. You allow users to change the quantity of the selected products using a form that is posted to the <code class="inlineCode">cart_add</code> view. You also allow users to remove items from the cart by providing a <strong class="keyWord">Remove</strong> button for each of them. Finally, you use an HTML form with an <code class="inlineCode">action</code> attribute that points to the <code class="inlineCode">cart_remove</code> URL including the product ID.</p>
<h3 class="heading-3" id="_idParaDest-240">Adding products to the cart</h3>
<p class="normal">Now you need to add an <strong class="screenText">Add to cart</strong> button to the product detail page. Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">shop</code> application<a id="_idIndexMarker764"/> and add <code class="inlineCode">CartAddProductForm</code> to the <code class="inlineCode">product_detail</code> view, as follows:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> cart.forms </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> CartAddProductForm</strong>
# ...
def product_detail(request, id, slug):
    product = get_object_or_404(
        Product, id=id, slug=slug, available=True
 )
<strong class="hljs-slc">    cart_product_form = CartAddProductForm()</strong>
return render(
        request,
        'shop/product/detail.html',
        {'product': product<strong class="hljs-slc">,</strong><strong class="hljs-string-slc"> 'cart_product_form'</strong><strong class="hljs-slc">: cart_product_form</strong>}
    )
</code></pre>
<p class="normal">Edit the <code class="inlineCode">shop/product/detail.html</code> template of the <code class="inlineCode">shop</code> application and add the following form to the product<a id="_idIndexMarker765"/> price, as follows. New lines are highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">...
&lt;p class="price"&gt;${{ product.price }}&lt;/p&gt;
<strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">form</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">action</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"{% url "</strong><strong class="hljs-attr-slc">cart:cart_add</strong><strong class="hljs-tag-slc">" </strong><strong class="hljs-attr-slc">product.id</strong><strong class="hljs-tag-slc"> %}" </strong><strong class="hljs-attr-slc">method</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"post"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">  {{ cart_product_form }}</strong>
<strong class="hljs-slc">  {% csrf_token %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">input</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">type</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"submit"</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">value</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"Add to cart"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">form</strong><strong class="hljs-tag-slc">&gt;</strong>
{{ product.description|linebreaks }}
...
</code></pre>
<p class="normal">Run the development server with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Now open <code class="inlineCode">http://127.0.0.1:8000/</code> in your browser and navigate to a product’s detail page. It will contain a form to choose a quantity before adding the product to the cart. The page will look like this:</p>
<figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="img/B21088_08_09.png"/></figure>
<p class="packt_figref">Figure 8.9: The product detail page, including the Add to cart button</p>
<p class="normal">Choose a quantity and click on the <strong class="screenText">Add to cart</strong> button. The form is submitted to the <code class="inlineCode">cart_add</code> view via <code class="inlineCode">POST</code>. The<a id="_idIndexMarker766"/> view adds the product to the cart in the session, including its current price and the selected quantity. Then, it redirects the user to the cart detail page, which will look like <em class="italic">Figure 8.10</em>:</p>
<figure class="mediaobject"><img alt="Graphical user interface, timeline  Description automatically generated with medium confidence" src="img/B21088_08_10.png"/></figure>
<p class="packt_figref">Figure 8.10: The cart detail page</p>
<h3 class="heading-3" id="_idParaDest-241">Updating product quantities in the cart</h3>
<p class="normal">When users see the cart, they <a id="_idIndexMarker767"/>might want to change product quantities before placing an order. You are going to allow users to change quantities from the cart detail page.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">cart</code> application and add the following lines highlighted in bold to the <code class="inlineCode">cart_detail</code> view:</p>
<pre class="programlisting code"><code class="hljs-code">def cart_detail(request):
    cart = Cart(request)
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">for</strong><strong class="hljs-slc"> item </strong><strong class="hljs-keyword-slc">in</strong><strong class="hljs-slc"> cart:</strong>
<strong class="hljs-slc">        item[</strong><strong class="hljs-string-slc">'update_quantity_form'</strong><strong class="hljs-slc">] = CartAddProductForm(</strong>
<strong class="hljs-slc">            initial={</strong><strong class="hljs-string-slc">'quantity'</strong><strong class="hljs-slc">: item[</strong><strong class="hljs-string-slc">'quantity'</strong><strong class="hljs-slc">], </strong><strong class="hljs-string-slc">'override'</strong><strong class="hljs-slc">: </strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">}</strong>
<strong class="hljs-slc">        )</strong>
return render(request, 'cart/detail.html', {'cart': cart})
</code></pre>
<p class="normal">You create an instance of <code class="inlineCode">CartAddProductForm</code> for each item in the cart to allow changing product quantities. You initialize the form with the current item quantity and set the <code class="inlineCode">override</code> field to <code class="inlineCode">True</code> so that when you submit the form to the <code class="inlineCode">cart_add</code> view, the current quantity is replaced <a id="_idIndexMarker768"/>with the new one.</p>
<p class="normal">Now edit the <code class="inlineCode">cart/detail.html</code> template of the <code class="inlineCode">cart</code> application and find the following line:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;td&gt;{{ item.quantity }}&lt;/td&gt;
</code></pre>
<p class="normal">Replace the previous line with the following code:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;td&gt;
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">form</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">action</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"{% url "</strong><strong class="hljs-attr-slc">cart:cart_add</strong><strong class="hljs-tag-slc">" </strong><strong class="hljs-attr-slc">product.id</strong><strong class="hljs-tag-slc"> %}" </strong><strong class="hljs-attr-slc">method</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"post"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">    {{ item.update_quantity_form.quantity }}</strong>
<strong class="hljs-slc">    {{ item.update_quantity_form.override }}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">input</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">type</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"submit"</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">value</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"Update"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">    {% csrf_token %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">form</strong><strong class="hljs-tag-slc">&gt;</strong>
&lt;/td&gt;
</code></pre>
<p class="normal">Run the development server with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/cart/</code> in your browser.</p>
<p class="normal">You will see a form to edit the quantity for each cart item, as follows:</p>
<figure class="mediaobject"><img alt="Graphical user interface, website  Description automatically generated" src="img/B21088_08_11.png"/></figure>
<p class="packt_figref">Figure 8.11: The cart detail page, including the form to update product quantities</p>
<p class="normal">Change the quantity of an item and click on the <strong class="screenText">Update</strong> button to test the new functionality. You can also<a id="_idIndexMarker769"/> remove an item from the cart by clicking the <strong class="screenText">Remove</strong> button.</p>
<h2 class="heading-2" id="_idParaDest-242">Creating a context processor for the current cart</h2>
<p class="normal">You might have noticed that the message <strong class="screenText">Your cart is empty</strong> is displayed in the header of the site, even when the cart contains items. You should display the total number of items in the cart and the total cost instead. Since this has to be displayed on all pages, you need to build a context processor to include the current cart in the request context, regardless of the view that processes the request.</p>
<h3 class="heading-3" id="_idParaDest-243">Context processors</h3>
<p class="normal">A context processor is a<a id="_idIndexMarker770"/> Python function that takes the <code class="inlineCode">request</code> object as an argument and returns a dictionary that gets added to the request context. Context processors come in handy when you need to make something available globally to all templates.</p>
<p class="normal">By default, when you create a new project using the <code class="inlineCode">startproject</code> command, your project contains the following template context processors in the <code class="inlineCode">context_processors</code> option inside the <code class="inlineCode">TEMPLATES</code> setting:</p>
<ul>
<li class="bulletList"><code class="inlineCode">django.template.context_processors.debug</code>: This sets the Boolean <code class="inlineCode">debug</code> and <code class="inlineCode">sql_queries</code> variables in the context, representing the list of SQL queries executed in the request.</li>
<li class="bulletList"><code class="inlineCode">django.template.context_processors.request</code>: This sets the <code class="inlineCode">request</code> variable in the context.</li>
<li class="bulletList"><code class="inlineCode">django.contrib.auth.context_processors.auth</code>: This sets the <code class="inlineCode">user</code> variable in the request.</li>
<li class="bulletList"><code class="inlineCode">django.contrib.messages.context_processors.messages</code>: This sets a <code class="inlineCode">messages</code> variable in the context containing all the messages that have been generated using the messages framework.</li>
</ul>
<p class="normal">Django also enables <code class="inlineCode">django.template.context_processors.csrf</code> to avoid <strong class="keyWord">cross-site request forgery</strong> (<strong class="keyWord">CSRF</strong>) attacks. This context <a id="_idIndexMarker771"/>processor is not present in the settings, but it is always enabled and can’t be<a id="_idIndexMarker772"/> turned off for security reasons.</p>
<p class="normal">You can see the list of all built-in context processors at <a href="https://docs.djangoproject.com/en/5.0/ref/templates/api/#built-in-template-context-processors">https://docs.djangoproject.com/en/5.0/ref/templates/api/#built-in-template-context-processors</a>.</p>
<h3 class="heading-3" id="_idParaDest-244">Setting the cart in the request context</h3>
<p class="normal">Let’s create a context processor to set <a id="_idIndexMarker773"/>the current cart in the request context. With it, you will be able to access the cart in any template.</p>
<p class="normal">Create a new file inside the <code class="inlineCode">cart</code> application directory and name it <code class="inlineCode">context_processors.py</code>. Context processors can reside anywhere in your code but creating them here will keep your code well organized. Add the following code to the file:</p>
<pre class="programlisting code"><code class="hljs-code">from .cart import Cart
def cart(request):
    return {'cart': Cart(request)}
</code></pre>
<p class="normal">In your context processor, you instantiate the cart using the <code class="inlineCode">request</code> object and make it available for the templates as a variable named <code class="inlineCode">cart</code>.</p>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of your project and add <code class="inlineCode">cart.context_processors.cart</code> to the <code class="inlineCode">context_processors</code> option inside the <code class="inlineCode">TEMPLATES</code> setting, as follows. The new line is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'cart.context_processors.cart'</strong><strong class="hljs-slc">,</strong>
            ],
        },
    },
]
</code></pre>
<p class="normal">The <code class="inlineCode">cart</code> context processor will be executed every time a template is rendered using Django’s <code class="inlineCode">RequestContext</code>. The <code class="inlineCode">cart</code> variable will be set in the context of your templates. You can read more about <code class="inlineCode">RequestContext</code> at <a href="https://docs.djangoproject.com/en/5.0/ref/templates/api/#django.template.RequestContext">https://docs.djangoproject.com/en/5.0/ref/templates/api/#django.template.RequestContext</a>.</p>
<div><p class="normal">Context processors are executed in all the requests that use <code class="inlineCode">RequestContext</code>. You might want to create<a id="_idIndexMarker774"/> a custom template tag instead of a context processor if your functionality is not needed in all templates, especially if it involves database queries.</p>
</div>
<p class="normal">Next, edit the <code class="inlineCode">shop/base.html</code> template of the <code class="inlineCode">shop</code> application and find the following lines:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;div class="cart"&gt;
  Your cart is empty.
&lt;/div&gt;
</code></pre>
<p class="normal">Replace the previous lines with the following code:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;div class="cart"&gt;
<strong class="hljs-slc">  {% with total_items=cart|length %}</strong>
<strong class="hljs-slc">    {% if total_items &gt; 0 %}</strong>
<strong class="hljs-slc">      Your cart:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">href</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"{% url "</strong><strong class="hljs-attr-slc">cart:cart_detail</strong><strong class="hljs-tag-slc">" %}"&gt;</strong>
<strong class="hljs-slc">        {{ total_items }} item{{ total_items|pluralize }},</strong>
<strong class="hljs-slc">        ${{ cart.get_total_price }}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">    {% else %}</strong>
<strong class="hljs-slc">      Your cart is empty.</strong>
<strong class="hljs-slc">    {% endif %}</strong>
<strong class="hljs-slc">  {% endwith %}</strong>
&lt;/div&gt;
</code></pre>
<p class="normal">Restart the development server with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/</code> in your browser and add some products to the cart.</p>
<p class="normal">In the header of the website, you can now<a id="_idIndexMarker775"/> see the total number of items in the cart and the total cost, as follows:</p>
<figure class="mediaobject"><img alt="Graphical user interface, website  Description automatically generated" src="img/B21088_08_12.png"/></figure>
<p class="packt_figref">Figure 8.12: The site header displaying the current items in the cart</p>
<p class="normal">Congratulations! You have completed the shopping cart functionality. This is a significant milestone in your online shop project. Next, you are going to create the functionality to register customer orders, which is another foundational element of any e-commerce platform.</p>
<h1 class="heading-1" id="_idParaDest-245">Registering customer orders</h1>
<p class="normal">When a shopping cart is checked out, you need to save an order in the database. Orders will contain information <a id="_idIndexMarker776"/>about customers and the products they are buying.</p>
<p class="normal">Create a new application for managing customer orders using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py startapp orders
</code></pre>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of your project and add the new application to the <code class="inlineCode">INSTALLED_APPS</code> setting, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">INSTALLED_APPS = [
    # ...
'cart.apps.CartConfig',
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'orders.apps.OrdersConfig'</strong><strong class="hljs-slc">,</strong>
'shop.apps.ShopConfig',
]
</code></pre>
<p class="normal">You have activated the <code class="inlineCode">orders</code> application.</p>
<h2 class="heading-2" id="_idParaDest-246">Creating order models</h2>
<p class="normal">You will need a model to store<a id="_idIndexMarker777"/> the order details and a second model to store items bought, including their price and quantity. Edit the <code class="inlineCode">models.py</code> file of the <code class="inlineCode">orders</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.db import models
class Order(models.Model):
    first_name = models.CharField(max_length=50)
    last_name = models.CharField(max_length=50)
    email = models.EmailField()
    address = models.CharField(max_length=250)
    postal_code = models.CharField(max_length=20)
    city = models.CharField(max_length=100)
    created = models.DateTimeField(auto_now_add=True)
    updated = models.DateTimeField(auto_now=True)
    paid = models.BooleanField(default=False)
    class Meta:
        ordering = ['-created']
        indexes = [
            models.Index(fields=['-created']),
        ]
    def __str__(self):
        return f'Order {self.id}'
def get_total_cost(self):
        return sum(item.get_cost() for item in self.items.all())
class OrderItem(models.Model):
    order = models.ForeignKey(
        Order,
        related_name='items',
        on_delete=models.CASCADE
)
    product = models.ForeignKey(
        'shop.Product',
        related_name='order_items',
        on_delete=models.CASCADE
    )
    price = models.DecimalField(
        max_digits=10,
        decimal_places=2
 )
    quantity = models.PositiveIntegerField(default=1)
    def __str__(self):
        return str(self.id)
    def get_cost(self):
        return self.price * self.quantity
</code></pre>
<p class="normal">The order model contains <a id="_idIndexMarker778"/>several fields to store customer information and a <code class="inlineCode">paid</code> Boolean field, which defaults to <code class="inlineCode">False</code>. Later on, you are going to use this field to differentiate between paid and unpaid orders. We have also defined a <code class="inlineCode">get_total_cost()</code> method to obtain the total cost of the items bought in this order.</p>
<p class="normal">The <code class="inlineCode">OrderItem</code> model allows you to store the product, quantity, and price paid for each item. We have defined a <code class="inlineCode">get_cost()</code> method that returns the cost of the item by multiplying the item price with the quantity. In the <code class="inlineCode">product</code> field, we use the string <code class="inlineCode">'shop.Product'</code> with the format <code class="inlineCode">app.Model</code>, which is another way to point to related models and also a good method to avoid circular imports.</p>
<p class="normal">Run the next command to <a id="_idIndexMarker779"/>create initial migrations for the <code class="inlineCode">orders</code> application:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py makemigrations
</code></pre>
<p class="normal">You will see output similar to the following:</p>
<pre class="programlisting con"><code class="hljs-con">Migrations for 'orders':
  orders/migrations/0001_initial.py
    - Create model Order
    - Create model OrderItem
</code></pre>
<p class="normal">Run the following command to apply the new migration:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py migrate
</code></pre>
<p class="normal">You will see the following output:</p>
<pre class="programlisting con"><code class="hljs-con">Applying orders.0001_initial... OK
</code></pre>
<p class="normal">Your order models are now synced to the database.</p>
<h2 class="heading-2" id="_idParaDest-247">Including order models in the administration site</h2>
<p class="normal">Let’s add the order models to the <a id="_idIndexMarker780"/>administration site. Edit the <code class="inlineCode">admin.py</code> file of the <code class="inlineCode">orders</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django.contrib import admin
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> .models </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> Order, OrderItem</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">OrderItemInline</strong><strong class="hljs-slc">(admin.TabularInline):</strong>
<strong class="hljs-slc">    model = OrderItem</strong>
<strong class="hljs-slc">    raw_id_fields = [</strong><strong class="hljs-string-slc">'product'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-meta-slc">@admin.register(</strong><strong class="hljs-params-slc">Order</strong><strong class="hljs-meta-slc">)</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">OrderAdmin</strong><strong class="hljs-slc">(admin.ModelAdmin):</strong>
<strong class="hljs-slc">    list_display = [</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'id'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'first_name'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'last_name'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'email'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'address'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'postal_code'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'city'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'paid'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'created'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'updated'</strong>
<strong class="hljs-string-slc"> </strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">    list_filter = [</strong><strong class="hljs-string-slc">'paid'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'created'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'updated'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">    inlines = [OrderItemInline]</strong>
</code></pre>
<p class="normal">You use a <code class="inlineCode">ModelInline</code> class for the <code class="inlineCode">OrderItem</code> model to include it as an <em class="italic">inline</em> in the <code class="inlineCode">OrderAdmin</code> class. An inline allows you to include a model on the same edit page as its related model.</p>
<p class="normal">Run the development <a id="_idIndexMarker781"/>server with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/admin/orders/order/add/</code> in your browser. You will see the following page:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_08_13.png"/></figure>
<p class="packt_figref">Figure 8.13: The Add order form, including OrderItemInline</p>
<h2 class="heading-2" id="_idParaDest-248">Creating customer orders</h2>
<p class="normal">You will use the order models that you <a id="_idIndexMarker782"/>created to persist the items contained in the shopping cart when the user finally places an order. A new order will be created following these steps:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">Present a user with an order form to fill in their data.</li>
<li class="numberedList">Create a new <code class="inlineCode">Order</code> instance with the data entered, and create an associated <code class="inlineCode">OrderItem</code> instance for each item in the cart.</li>
<li class="numberedList">Clear all the cart’s contents and redirect the user to a success page.</li>
</ol>
<p class="normal">First, you need a form to enter the order details. Create a new file inside the <code class="inlineCode">orders</code> application directory and <a id="_idIndexMarker783"/>name it <code class="inlineCode">forms.py</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django import forms
from .models import Order
class OrderCreateForm(forms.ModelForm):
    class Meta:
        model = Order
        fields = [
            'first_name',
            'last_name',
            'email',
            'address',
            'postal_code',
            'city'
 ]
</code></pre>
<p class="normal">This is the form that you are going to use to create new <code class="inlineCode">Order</code> objects. Now you need a view to handle the form and create a new order. Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">orders</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> cart.cart </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> Cart</strong>
from django.shortcuts import render
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> .forms </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> OrderCreateForm</strong>
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> .models </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> OrderItem</strong>
<strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">order_create</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">request</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc">    cart = Cart(request)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> request.method == </strong><strong class="hljs-string-slc">'POST'</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">        form = OrderCreateForm(request.POST)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> form.is_valid():</strong>
<strong class="hljs-slc">            order = form.save()</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">for</strong><strong class="hljs-slc"> item </strong><strong class="hljs-keyword-slc">in</strong><strong class="hljs-slc"> cart:</strong>
<strong class="hljs-slc">                OrderItem.objects.create(</strong>
<strong class="hljs-slc">                    order=order,</strong>
<strong class="hljs-slc">                    product=item[</strong><strong class="hljs-string-slc">'product'</strong><strong class="hljs-slc">],</strong>
<strong class="hljs-slc">                    price=item[</strong><strong class="hljs-string-slc">'price'</strong><strong class="hljs-slc">],</strong>
<strong class="hljs-slc">                    quantity=item[</strong><strong class="hljs-string-slc">'quantity'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">                )</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># clear the cart</strong>
<strong class="hljs-slc">            cart.clear()</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> render(</strong>
<strong class="hljs-slc">                request, </strong><strong class="hljs-string-slc">'orders/order/created.html'</strong><strong class="hljs-slc">, {</strong><strong class="hljs-string-slc">'order'</strong><strong class="hljs-slc">: order}</strong>
<strong class="hljs-slc">            )</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">else</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">        form = OrderCreateForm()</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> render(</strong>
<strong class="hljs-slc">        request,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'orders/order/create.html'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        {</strong><strong class="hljs-string-slc">'cart'</strong><strong class="hljs-slc">: cart, </strong><strong class="hljs-string-slc">'form'</strong><strong class="hljs-slc">: form}</strong>
<strong class="hljs-slc">    )</strong>
</code></pre>
<p class="normal">In the <code class="inlineCode">order_create</code> view, you <a id="_idIndexMarker784"/>obtain the current cart from the session with <code class="inlineCode">cart = Cart(request)</code>. Depending on the request method, you perform the following tasks:</p>
<ul>
<li class="bulletList"><strong class="keyWord">GET request</strong>: Instantiates <a id="_idIndexMarker785"/>the <code class="inlineCode">OrderCreateForm</code> form and renders the <code class="inlineCode">orders/order/create.html</code> template.</li>
<li class="bulletList"><strong class="keyWord">POST request</strong>: Validates the<a id="_idIndexMarker786"/> data sent in the request. If the data is valid, you create a new order in the database using <code class="inlineCode">order = form.save()</code>. You iterate over the cart items and create an <code class="inlineCode">OrderItem</code> for each of them. Finally, you clear the cart’s contents and render the template <code class="inlineCode">orders/order/created.html</code>.</li>
</ul>
<p class="normal">Create a new file inside the <code class="inlineCode">orders</code> application directory and name it <code class="inlineCode">urls.py</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.urls import path
from . import views
app_name = 'orders'
urlpatterns = [
    path('create/', views.order_create, name='order_create'),
]
</code></pre>
<p class="normal">This is the URL pattern for the <code class="inlineCode">order_create</code> view.</p>
<p class="normal">Edit the <code class="inlineCode">urls.py</code> file of <code class="inlineCode">myshop</code> and include the following pattern. Remember to place it before the <code class="inlineCode">shop.urls</code> pattern, as follows. The new line is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    path('admin/', admin.site.urls),
    path('cart/', include('cart.urls', namespace='cart')),
<strong class="hljs-slc">    path(</strong><strong class="hljs-string-slc">'orders/'</strong><strong class="hljs-slc">, include(</strong><strong class="hljs-string-slc">'orders.urls'</strong><strong class="hljs-slc">, namespace=</strong><strong class="hljs-string-slc">'orders'</strong><strong class="hljs-slc">)),</strong>
    path('', include('shop.urls', namespace='shop')),
]
</code></pre>
<p class="normal">Edit the <code class="inlineCode">cart/detail.html</code> template<a id="_idIndexMarker787"/> of the <code class="inlineCode">cart</code> application and find this line:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;a href="#" class="button"&gt;Checkout&lt;/a&gt;
</code></pre>
<p class="normal">Add the <code class="inlineCode">order_create</code> URL to the <code class="inlineCode">href</code> HTML attribute, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;a href="<strong class="hljs-string-slc">{% url "</strong><strong class="hljs-attr-slc">orders:order_create</strong><strong class="hljs-string-slc">" %}</strong>" class="button"&gt;
  Checkout
&lt;/a&gt;
</code></pre>
<p class="normal">Users can now navigate from the cart detail page to the order form.</p>
<p class="normal">You still need to define templates for creating orders. Create the following file structure inside the <code class="inlineCode">orders</code> application directory:</p>
<pre class="programlisting con"><code class="hljs-con">templates/
    orders/
        order/
            create.html
            created.html
</code></pre>
<p class="normal">Edit the <code class="inlineCode">orders/order/create.html</code> template and add the following code:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "shop/base.html" %}
{% block title %}
  Checkout
{% endblock %}
{% block content %}
  &lt;h1&gt;Checkout&lt;/h1&gt;
&lt;div class="order-info"&gt;
&lt;h3&gt;Your order&lt;/h3&gt;
&lt;ul&gt;
      {% for item in cart %}
        &lt;li&gt;
          {{ item.quantity }}x {{ item.product.name }}
          &lt;span&gt;${{ item.total_price }}&lt;/span&gt;
&lt;/li&gt;
      {% endfor %}
    &lt;/ul&gt;
&lt;p&gt;Total: ${{ cart.get_total_price }}&lt;/p&gt;
&lt;/div&gt;
&lt;form method="post" class="order-form"&gt;
    {{ form.as_p }}
    &lt;p&gt;&lt;input type="submit" value="Place order"&gt;&lt;/p&gt;
    {% csrf_token %}
  &lt;/form&gt;
{% endblock %}
</code></pre>
<p class="normal">This template displays the cart<a id="_idIndexMarker788"/> items, including totals and the form to place an order.</p>
<p class="normal">Edit the <code class="inlineCode">orders/order/created.html</code> template and add the following code:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "shop/base.html" %}
{% block title %}
  Thank you
{% endblock %}
{% block content %}
  &lt;h1&gt;Thank you&lt;/h1&gt;
&lt;p&gt;Your order has been successfully completed. Your order number is
  &lt;strong&gt;{{ order.id }}&lt;/strong&gt;.&lt;/p&gt;
{% endblock %}
</code></pre>
<p class="normal">This is the template that you render when the order is successfully created.</p>
<p class="normal">Start the web development server to load new files. Open <code class="inlineCode">http://127.0.0.1:8000/</code> in your browser, add a couple of products to the cart, and continue to the checkout page. You will see the following form:</p>
<figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="img/B21088_08_14.png"/></figure>
<p class="packt_figref">Figure 8.14: The order creation page, including the chart checkout form and order details</p>
<p class="normal">Fill in the form with<a id="_idIndexMarker789"/> valid data and click on the <strong class="screenText">Place order</strong> button. The order will be created, and you will see a success page like this:</p>
<figure class="mediaobject"><img alt="A picture containing text  Description automatically generated" src="img/B21088_08_15.png"/></figure>
<p class="packt_figref">Figure 8.15: The order created template displaying the order number</p>
<p class="normal">The order has been registered and the cart has been cleared.</p>
<p class="normal">You might have <a id="_idIndexMarker790"/>noticed that the message <strong class="screenText">Your cart is empty</strong> is displayed in the header when an order is completed. This is because the cart has been cleared. We can easily avoid this message for views that have an <code class="inlineCode">order</code> object in the template context.</p>
<p class="normal">Edit the <code class="inlineCode">shop/base.html</code> template of the <code class="inlineCode">shop</code> application and replace the following line highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">...
&lt;div class="cart"&gt;
  {% with total_items=cart|length %}
    {% if total_items &gt; 0 %}
      Your cart:
      &lt;a href="{% url "cart:cart_detail" %}"&gt;
        {{ total_items }} item{{ total_items|pluralize }},
        ${{ cart.get_total_price }}
      &lt;/a&gt;
<strong class="hljs-slc">    {% elif not order %}</strong>
      Your cart is empty.
    {% endif %}
  {% endwith %}
&lt;/div&gt;
...
</code></pre>
<p class="normal">The message <strong class="screenText">Your cart is empty</strong> will not be displayed anymore when an order is created.</p>
<p class="normal">Now open the administration site at <code class="inlineCode">http://127.0.0.1:8000/admin/orders/order/</code>. You will see that the order has been successfully created, like this:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_08_16.png"/></figure>
<p class="packt_figref">Figure 8.16: The order change list section of the administration site, including the order created</p>
<p class="normal">You have implemented<a id="_idIndexMarker791"/> the order system. Now you will learn how to create asynchronous tasks to send confirmation emails to users when they place an order.</p>
<h1 class="heading-1" id="_idParaDest-249">Creating asynchronous tasks</h1>
<p class="normal">When receiving an HTTP request, you need to<a id="_idIndexMarker792"/> return a response to the user as quickly as possible. Remember that in <em class="chapterRef">Chapter 7</em>, <em class="italic">Tracking User Actions</em>, you used the Django Debug Toolbar to check the time for the different phases of the request/response cycle and the execution time for the SQL queries performed. </p>
<p class="normal">Every task executed during the course of the request/response cycle adds up to the total response time. Long-running tasks can seriously slow down the server response. How do we return a fast response to the user while still completing time-consuming tasks? We can do it with asynchronous execution.</p>
<h2 class="heading-2" id="_idParaDest-250">Working with asynchronous tasks</h2>
<p class="normal">We can offload work from the<a id="_idIndexMarker793"/> request/response cycle by executing certain tasks in the background. For example, a video-sharing platform allows users to upload videos but requires a long time to transcode uploaded videos. When the user uploads a video, the site might return a response informing them that the transcoding will start soon and start transcoding the video asynchronously. Another<a id="_idIndexMarker794"/> example is sending emails to users. If your site sends email notifications from a view, the <strong class="keyWord">Simple Mail Transfer Protocol</strong> (<strong class="keyWord">SMTP</strong>) connection might fail or slow down the response. By sending the email asynchronously, you avoid blocking the code execution.</p>
<p class="normal">Asynchronous execution is <a id="_idIndexMarker795"/>especially relevant for data-intensive, resource-intensive, and time-consuming processes or processes subject to failure, which might require a retry policy.</p>
<h2 class="heading-2" id="_idParaDest-251">Workers, message queues, and message brokers</h2>
<p class="normal">While your web server processes requests and returns responses, you need a second task-based server, named <strong class="keyWord">worker</strong>, to process<a id="_idIndexMarker796"/> the asynchronous tasks. One or multiple workers can be running and executing tasks in the background. These workers can access the database, process files, send emails, and so on. Workers can even queue future tasks, all while keeping the main web server free to process HTTP requests.</p>
<p class="normal">To tell the workers what tasks to execute, we need to<a id="_idIndexMarker797"/> send <strong class="keyWord">messages</strong>. We communicate with brokers by adding messages to a <strong class="keyWord">message queue</strong>, which is basically a <strong class="keyWord">first in, first out</strong> (<strong class="keyWord">FIFO</strong>) data structure. When<a id="_idIndexMarker798"/> a broker becomes available, it takes <a id="_idIndexMarker799"/>the first message from the queue and starts executing the corresponding task. When finished, the broker takes the next message from the queue and executes the corresponding task. Brokers become idle when the message queue is empty. When using multiple brokers, each broker takes the first available message in order when they become available. The queue ensures that each broker only gets one task at a time and that no task is processed by more than one worker.</p>
<p class="normal"><em class="italic">Figure 8.17</em> shows how a message queue works:</p>
<figure class="mediaobject"><img alt="Shape  Description automatically generated with medium confidence" src="img/B21088_08_17.png"/></figure>
<p class="packt_figref">Figure 8.17: Asynchronous execution using a message queue and workers</p>
<p class="normal">A producer sends a message to the queue, and the worker(s) consumes the messages on a first-come, first-served basis; the first message added to the message queue is the first message to be processed by the worker(s).</p>
<p class="normal">In order to manage the message queue, we need a <strong class="keyWord">message broker</strong>. The message broker is used to translate messages to a <a id="_idIndexMarker800"/>formal messaging protocol and manage message queues for multiple receivers. It provides reliable storage and guaranteed message delivery. The message broker allows us to create message queues, route messages, distribute messages among workers, and so on.</p>
<p class="normal">To implement asynchronous tasks in your project, you will use Celery for managing task queues and RabbitMQ as the message broker Celery employs. Both technologies will be introduced in the following section.</p>
<h3 class="heading-3" id="_idParaDest-252">Using Django with Celery and RabbitMQ</h3>
<p class="normal">Celery is a distributed task queue that can<a id="_idIndexMarker801"/> process vast amounts of messages. We will use Celery to define asynchronous tasks as Python functions within our Django applications. We will run Celery workers that will listen to the message broker to get new messages to<a id="_idIndexMarker802"/> process asynchronous tasks.</p>
<p class="normal">Using Celery, not only can <a id="_idIndexMarker803"/>you create asynchronous tasks easily and let them be executed by workers as soon as possible but you can also schedule them to run at a specific time. You can find the Celery documentation at <a href="https://docs.celeryq.dev/en/stable/index.html">https://docs.celeryq.dev/en/stable/index.html</a>.</p>
<p class="normal">Celery communicates via messages and requires a message broker to mediate between clients and workers. There are<a id="_idIndexMarker804"/> several options for a message broker for Celery, including key/value stores such as Redis, or an actual message broker such as RabbitMQ.</p>
<p class="normal">RabbitMQ is the most widely deployed message broker. It supports multiple messaging protocols, such as the <strong class="keyWord">Advanced Message Queuing Protocol</strong> (<strong class="keyWord">AMQP</strong>), and it is the recommended message <a id="_idIndexMarker805"/>worker for Celery. RabbitMQ is lightweight, easy to deploy, and can be configured for scalability and high availability.</p>
<p class="normal"><em class="italic">Figure 8.18</em> shows how we will use Django, Celery, and RabbitMQ to execute asynchronous tasks:</p>
<figure class="mediaobject"><img alt="A picture containing diagram  Description automatically generated" src="img/B21088_08_18.png"/></figure>
<p class="packt_figref">Figure 8.18: Architecture for asynchronous tasks with Django, RabbitMQ, and Celery</p>
<h4 class="heading-4">Installing Celery</h4>
<p class="normal">Let’s install Celery and integrate it into<a id="_idIndexMarker806"/> the project. Install Celery via <code class="inlineCode">pip</code> using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install celery==5.4.0
</code></pre>
<p class="normal">You can find an introduction to Celery at <a href="https://docs.celeryq.dev/en/stable/getting-started/introduction.html">https://docs.celeryq.dev/en/stable/getting-started/introduction.html</a>.</p>
<h4 class="heading-4">Installing RabbitMQ</h4>
<p class="normal">The RabbitMQ community provides a<a id="_idIndexMarker807"/> Docker image that makes it very easy to deploy a RabbitMQ server with a standard configuration. Remember that you learned how to install Docker in <em class="chapterRef">Chapter 3</em>, <em class="italic">Extending Your Blog Application</em>.</p>
<p class="normal">After installing Docker on your machine, you can easily pull the RabbitMQ Docker image by running the following command from the shell:</p>
<pre class="programlisting con"><code class="hljs-con">docker pull rabbitmq:3.13.1-management
</code></pre>
<p class="normal">This will download the RabbitMQ Docker image to your local machine. You can find information about the official RabbitMQ Docker image at <a href="https://hub.docker.com/_/rabbitmq">https://hub.docker.com/_/rabbitmq</a>.</p>
<p class="normal">If you want to install RabbitMQ natively on your machine instead of using Docker, you will find detailed installation guides for different operating systems at <a href="https://www.rabbitmq.com/download.html">https://www.rabbitmq.com/download.html</a>.</p>
<p class="normal">Execute the following command in the shell to start the RabbitMQ server with Docker:</p>
<pre class="programlisting con"><code class="hljs-con">docker run -it --rm --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3.13.1-management
</code></pre>
<p class="normal">With this command, we are<a id="_idIndexMarker808"/> telling RabbitMQ to run on port <code class="inlineCode">5672</code>, and we are running its web-based management user interface on port <code class="inlineCode">15672</code>.</p>
<p class="normal">You will see output that includes the following lines:</p>
<pre class="programlisting con"><code class="hljs-con">Starting broker...
...
completed with 4 plugins.
Server startup complete; 4 plugins started.
</code></pre>
<p class="normal">RabbitMQ is running on port <code class="inlineCode">5672</code> and ready to receive messages.</p>
<h4 class="heading-4">Accessing RabbitMQ’s management interface</h4>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:15672/</code> in your <a id="_idIndexMarker809"/>browser. You will see the login screen for the management UI of RabbitMQ. It will look like this:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="img/B21088_08_19.png"/></figure>
<p class="packt_figref">Figure 8.19: The RabbitMQ management UI login screen</p>
<p class="normal">Enter <code class="inlineCode">guest</code> as both the username and the password and click on <strong class="screenText">Login</strong>. You will see the following screen:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_08_20.png"/></figure>
<p class="packt_figref">Figure 8.20: The RabbitMQ management UI dashboard</p>
<p class="normal">This is the default admin user for RabbitMQ. On this screen, you can monitor the current activity for <a id="_idIndexMarker810"/>RabbitMQ. You can see that there is one node running with no connections or queues registered.</p>
<p class="normal">If you use RabbitMQ in a production environment, you will need to create a new admin user and remove the default <code class="inlineCode">guest</code> user. You can do that in the <strong class="screenText">Admin</strong> section of the management UI.</p>
<p class="normal">Now we will add Celery to the project. Then, we will run Celery and test the connection to RabbitMQ.</p>
<h4 class="heading-4">Adding Celery to your project</h4>
<p class="normal">You have to provide a configuration for the <a id="_idIndexMarker811"/>Celery instance. Create a new file next to the <code class="inlineCode">settings.py</code> file of <code class="inlineCode">myshop</code> and name it <code class="inlineCode">celery.py</code>. This file will contain the Celery configuration for your project. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">import os
from celery import Celery
# set the default Django settings module for the 'celery' program.
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'myshop.settings')
app = Celery('myshop')
app.config_from_object('django.conf:settings', namespace='CELERY')
app.autodiscover_tasks()
</code></pre>
<p class="normal">In this code, you do the following:</p>
<ul>
<li class="bulletList">You set the <code class="inlineCode">DJANGO_SETTINGS_MODULE</code> variable for the Celery command-line program.</li>
<li class="bulletList">You create an instance of the application with <code class="inlineCode">app = Celery('myshop')</code>.</li>
<li class="bulletList">You load any <a id="_idIndexMarker812"/>custom configuration from your project settings using the <code class="inlineCode">config_from_object()</code> method. The <code class="inlineCode">namespace</code> attribute specifies the prefix that Celery-related settings will have in your <code class="inlineCode">settings.py</code> file. By setting the <code class="inlineCode">CELERY</code> namespace, all Celery settings need to include the <code class="inlineCode">CELERY_</code> prefix in their name (for example, <code class="inlineCode">CELERY_BROKER_URL</code>).</li>
<li class="bulletList">Finally, you tell Celery to auto-discover asynchronous tasks for your applications. Celery will look for a <code class="inlineCode">tasks.py</code> file in each application directory of applications added to <code class="inlineCode">INSTALLED_APPS</code> in order to load asynchronous tasks defined in it.</li>
</ul>
<p class="normal">You need to import the <code class="inlineCode">celery</code> module in the <code class="inlineCode">__init__.py</code> file of your project to ensure it is loaded when Django starts.</p>
<p class="normal">Edit the <code class="inlineCode">myshop/__init__.py</code> file and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code"># import celery
from .celery import app as celery_app
__all__ = ['celery_app']
</code></pre>
<p class="normal">You have added Celery to the Django project, and you can now start using it.</p>
<h4 class="heading-4">Running a Celery worker</h4>
<p class="normal">A Celery worker is a process that<a id="_idIndexMarker813"/> handles bookkeeping features like sending/receiving queue messages, registering tasks, killing hung tasks, tracking status, and so on. A worker instance can consume from any number of message queues.</p>
<p class="normal">Open another shell and start a Celery worker from your project directory, using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">celery -A myshop worker -l info
</code></pre>
<p class="normal">The Celery worker is now running and ready to process tasks. Let’s check if there is a connection between Celery and <a id="_idIndexMarker814"/>RabbitMQ.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:15672/</code> in your browser to access the RabbitMQ management UI. You will now see a graph under <strong class="screenText">Queued messages</strong> and another graph under <strong class="screenText">Message rates</strong>, as in <em class="italic">Figure 8.21</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_08_21.png"/></figure>
<p class="packt_figref">Figure 8.21: The RabbitMQ management dashboard displaying connections and queues</p>
<p class="normal">Obviously, there are no queued messages as we haven’t sent any messages to the message queue yet. The graph under <strong class="screenText">Message rates</strong> should update every five seconds; you can see the refresh rate at the top right of the screen. This time, both <strong class="screenText">Connections</strong> and <strong class="screenText">Queues</strong> should display a number higher than zero.</p>
<p class="normal">Now we can start programming asynchronous tasks.</p>
<div><p class="normal">The <code class="inlineCode">CELERY_ALWAYS_EAGER</code> setting allows you to execute tasks locally in a synchronous manner instead of sending them to the queue. This is useful for running unit tests or executing the application in your local environment without running Celery.</p>
</div>
<h4 class="heading-4">Adding asynchronous tasks to your application</h4>
<p class="normal">Let’s send a confirmation email to the user whenever an order is placed in the online shop. We will implement <a id="_idIndexMarker815"/>sending the email in a Python function and register it as a task with Celery. Then, we will add it to the <code class="inlineCode">order_create</code> view to execute the task asynchronously.</p>
<p class="normal">When the <code class="inlineCode">order_create</code> view is executed, Celery will send the message to a message queue managed by RabbitMQ and then a Celery broker will execute the asynchronous task that we defined with a Python function.</p>
<p class="normal">The convention for easy task discovery by Celery is to define asynchronous tasks for your application in a <code class="inlineCode">tasks</code> module within the application directory.</p>
<p class="normal">Create a new file inside the <code class="inlineCode">orders</code> application and name it <code class="inlineCode">tasks.py</code>. This is the place where Celery will look for asynchronous tasks. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from celery import shared_task
from django.core.mail import send_mail
from .models import Order
@shared_task
def order_created(order_id):
    """
    Task to send an e-mail notification when an order is
    successfully created.
    """
    order = Order.objects.get(id=order_id)
    subject = f'Order nr. {order.id}'
    message = (
        f'Dear {order.first_name},\n\n'
f'You have successfully placed an order.'
f'Your order ID is {order.id}.'
    )
    mail_sent = send_mail(
        subject, message, 'admin@myshop.com', [order.email]
    )
    return mail_sent
</code></pre>
<p class="normal">We have defined the <code class="inlineCode">order_created</code> task by using the <code class="inlineCode">@shared_task</code> decorator. As you can see, a Celery task is just a Python function decorated with <code class="inlineCode">@shared_task</code>. The <code class="inlineCode">order_created</code> task function receives an <code class="inlineCode">order_id</code> parameter. It’s always recommended to only pass IDs to task functions and retrieve objects from the database when the task is executed. By doing so, we avoid accessing outdated information since the data in the database might have changed<a id="_idIndexMarker816"/> while the task was queued. We have used the <code class="inlineCode">send_mail()</code> function provided by Django to send an email notification to the user who placed the order.</p>
<p class="normal">You learned how to configure Django to use your SMTP server in <em class="italic">Chapter 2</em>, <em class="italic">Enhancing Your Blog with Advanced Features</em>. If you don’t want to set up email settings, you can tell Django to write emails to the console by adding the following setting to the <code class="inlineCode">settings.py</code> file:</p>
<pre class="programlisting code"><code class="hljs-code">EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'
</code></pre>
<div><p class="normal">Use asynchronous tasks not only for time-consuming processes but also for other processes that do not take so much time to be executed but that are subject to connection failures or require a retry policy.</p>
</div>
<p class="normal">Now you have to add the task to your <code class="inlineCode">order_create</code> view. Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">orders</code> application, import the task, and call the <code class="inlineCode">order_created</code> asynchronous task after clearing the cart, as follows:</p>
<pre class="programlisting code"><code class="hljs-code"># ...
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> .tasks </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> order_created</strong>
def order_create(request):
    # ...
if request.method == 'POST':
        # ...
if form.is_valid():
            # ...
            cart.clear()
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># launch asynchronous task</strong>
<strong class="hljs-slc">            order_created.delay(order.</strong><strong class="hljs-built_in-slc">id</strong><strong class="hljs-slc">)</strong>
# ...
</code></pre>
<p class="normal">You call the <code class="inlineCode">delay()</code> method of the task to execute it asynchronously. The task will be added to the message queue and executed by the Celery worker as soon as possible.</p>
<p class="normal">Make sure RabbitMQ is running. Then, stop the Celery worker process and start it again with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">celery -A myshop worker -l info
</code></pre>
<p class="normal">The Celery worker has now registered the task. In another shell, start the development server from the project directory with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/</code> in your browser, add some products to your shopping cart, and complete an order. In the <a id="_idIndexMarker817"/>shell where you started the Celery worker, you will see output similar to the following:</p>
<pre class="programlisting con"><code class="hljs-con">[2024-01-02 20:25:19,569: INFO/MainProcess] Task orders.tasks.order_created[a94dc22e-372b-4339-bff7-52bc83161c5c] received
...
[2024-01-02 20:25:19,605: INFO/ForkPoolWorker-8] Task orders.tasks.order_created[a94dc22e-372b-4339-bff7-52bc83161c5c] succeeded in 0.015824042027816176s: 1
</code></pre>
<p class="normal">The <code class="inlineCode">order_created</code> task has been executed and an email notification for the order has been sent. If you are using the email backend <code class="inlineCode">console.EmailBackend</code>, no email is sent but you should see the rendered text of the email in the output of the console.</p>
<h3 class="heading-3" id="_idParaDest-253">Monitoring Celery with Flower</h3>
<p class="normal">Besides the RabbitMQ <a id="_idIndexMarker818"/>management UI, you can use other tools to monitor the<a id="_idIndexMarker819"/> asynchronous tasks that are executed with Celery. Flower is a useful web-based tool for monitoring Celery. You can find the documentation for Flower at <a href="https://flower.readthedocs.io/">https://flower.readthedocs.io/</a>.</p>
<p class="normal">Install Flower using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install flower==2.0.1
</code></pre>
<p class="normal">Once installed, you can launch Flower by running<a id="_idIndexMarker820"/> the following command in a new shell from your project directory:</p>
<pre class="programlisting con"><code class="hljs-con">celery -A myshop flower
</code></pre>
<p class="normal">Open <code class="inlineCode">http://localhost:5555/</code> in your browser. You will be able to see the active Celery workers and<a id="_idIndexMarker821"/> asynchronous task statistics. The screen should look as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_08_22.png"/></figure>
<p class="packt_figref">Figure 8.22: The Flower dashboard</p>
<p class="normal">You will see an active worker whose name starts with <strong class="screenText">celery@</strong> and whose status is <strong class="screenText">Online</strong>.</p>
<p class="normal">Click on the worker’s name and then click on the <strong class="screenText">Queues</strong> tab. You will see the following screen:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_08_23.png"/></figure>
<p class="packt_figref">Figure 8.23: Flower – Worker Celery task queues</p>
<p class="normal">Here you can see the active queue <a id="_idIndexMarker822"/>named <strong class="screenText">celery</strong>. This is the active queue consumer connected to the message <a id="_idIndexMarker823"/>broker.</p>
<p class="normal">Click the <strong class="screenText">Tasks</strong> tab. You will see the following screen:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_08_24.png"/></figure>
<p class="packt_figref">Figure 8.24: Flower – Worker Celery tasks</p>
<p class="normal">Here you can see the tasks that have been processed and the number of times that they have been executed. You should see the <code class="inlineCode">order_created</code> task and the total times that it has been executed. This number might vary depending on how many orders you have placed.</p>
<p class="normal">Open <code class="inlineCode">http://localhost:8000/</code> in your browser. Add some items to the cart and then complete the checkout process.</p>
<p class="normal">Open <code class="inlineCode">http://localhost:5555/</code> in your browser. Flower has registered the task as processed. You should now see <code class="inlineCode">1</code> under <strong class="screenText">Processed</strong> and <code class="inlineCode">1</code> under <strong class="screenText">Succeeded</strong> as well:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_08_25.png"/></figure>
<p class="packt_figref">Figure 8.25: Flower – Celery workers</p>
<p class="normal">Under <strong class="screenText">Tasks</strong>, you can see additional details about each task registered with Celery:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_08_26.png"/></figure>
<p class="packt_figref">Figure 8.26: Flower – Celery tasks</p>
<p class="normal">Flower should never be deployed openly in a production environment without security. Let’s add authentication to<a id="_idIndexMarker824"/> the Flower instance. Stop Flower using <em class="italic">Ctrl + C</em>, and restart it with the <code class="inlineCode">--basic-auth</code> option by executing the following command:</p>
<pre class="programlisting con"><code class="hljs-con">celery -A myshop flower --basic-auth=user:pwd
</code></pre>
<p class="normal">Replace <code class="inlineCode">user</code> and <code class="inlineCode">pwd</code> with your desired username and password. Open <code class="inlineCode">http://localhost:5555/</code> in your browser. The browser will now prompt you for credentials, as shown in <em class="italic">Figure 8.27</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_08_27.png"/></figure>
<p class="packt_figref">Figure 8.27: Basic authentication required to access Flower</p>
<p class="normal">Flower provides other authentication options, such as Google, GitHub, or Okta OAuth. You can read more about Flower’s authentication methods at <a href="https://flower.readthedocs.io/en/latest/auth.html">https://flower.readthedocs.io/en/latest/auth.html</a>.</p>
<h1 class="heading-1" id="_idParaDest-254">Summary</h1>
<p class="normal">In this chapter, you created a basic e-commerce application. You made a product catalog and built a shopping cart using sessions. You implemented a custom context processor to make the cart available to all templates and created a form for placing orders. You also learned how to implement asynchronous tasks using Celery and RabbitMQ. Having completed this chapter, you now understand the foundational elements of building an e-commerce platform with Django, including managing products, processing orders, and handling asynchronous tasks. You are now also capable of developing projects that efficiently process user transactions and scale to handle complex background operations seamlessly.</p>
<p class="normal">In the next chapter, you will discover how to integrate a payment gateway into your shop, add custom actions to the administration site, export data in CSV format, and generate PDF files dynamically.</p>
<h1 class="heading-1" id="_idParaDest-255">Additional resources</h1>
<p class="normal">The following resources provide additional information related to the topics covered in this chapter:</p>
<ul>
<li class="bulletList">Source code for this chapter – <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter08">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter08</a></li>
<li class="bulletList">Static files for the project – <a href="https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter08/myshop/shop/static ">https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter08/myshop/shop/static</a></li>
<li class="bulletList">Django session settings – <a href="https://docs.djangoproject.com/en/5.0/ref/settings/#sessions">https://docs.djangoproject.com/en/5.0/ref/settings/#sessions</a></li>
<li class="bulletList">Django built-in context processors – <a href="https://docs.djangoproject.com/en/5.0/ref/templates/api/#built-in-template-context-processors">https://docs.djangoproject.com/en/5.0/ref/templates/api/#built-in-template-context-processors</a></li>
<li class="bulletList">Information about <code class="inlineCode">RequestContext</code> – <a href="https://docs.djangoproject.com/en/5.0/ref/templates/api/#django.template.RequestContext">https://docs.djangoproject.com/en/5.0/ref/templates/api/#django.template.RequestContext</a></li>
<li class="bulletList">Celery documentation – <a href="https://docs.celeryq.dev/en/stable/index.html">https://docs.celeryq.dev/en/stable/index.html</a></li>
<li class="bulletList">Introduction to Celery – <a href="https://docs.celeryq.dev/en/stable/getting-started/introduction.html">https://docs.celeryq.dev/en/stable/getting-started/introduction.html</a></li>
<li class="bulletList">Official RabbitMQ Docker image – <a href="https://hub.docker.com/_/rabbitmq">https://hub.docker.com/_/rabbitmq</a></li>
<li class="bulletList">RabbitMQ installation instructions – <a href="https://www.rabbitmq.com/download.html">https://www.rabbitmq.com/download.html</a></li>
<li class="bulletList">Flower documentation – <a href="https://flower.readthedocs.io/">https://flower.readthedocs.io/</a></li>
<li class="bulletList">Flower authentication methods – <a href="https://flower.readthedocs.io/en/latest/auth.html">https://flower.readthedocs.io/en/latest/auth.html</a></li>
</ul>
<h1 class="heading-1" id="_idParaDest-256">Join us on Discord!</h1>
<p class="normal">Read this book alongside other users, Django development experts, and the author himself. Ask questions, provide solutions to other readers, chat with the author via Ask Me Anything sessions, and much more.Scan the QR code or visit the link to join the community.</p>
<p class="normal"><a href="https://packt.link/Django5ByExample">https://packt.link/Django5ByExample</a></p>
<p class="normal"><img alt="" role="presentation" src="img/QR_Code287089408934129031.png"/></p>
</div>
</body></html>