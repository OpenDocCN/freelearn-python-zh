- en: Chapter 8. Authentication and Authorization
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In this chapter, we will cover the following recipes:'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
- en: Customizing Auth
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using CAPTCHA on login failure
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Using pyGravatar to get avatars for user profile pages
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Multi-user and teacher modes
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Authenticating with Facebook using OAuth 2.0
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Introduction
  id: totrans-7
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Almost every application needs to be able to authenticate users and set permissions.
    web2py comes with an extensive and customizable role-based access control mechanism.
    In this chapter, we show you how to customize it by adding fields to the user
    table, adding **CAPTCHA** security after repeated failed logins, and how to create
    **Globally Recognized Avatars** (Gravatars&mdash;icons representing the users).
    We also discuss the `teacher` mode of web2py that allows students to share one
    web2py instance to develop and deploy their applications. Finally, we provide
    an example of integration with **OAuth 2.0**, one of the newest protocols for
    federated authentication. Web2py also supports `ofthe` protocols, such as CAS,
    OpenID, OAuth 1.0, LDAP, PAM, X509, and many more. But, once you learn one, it
    should be easy to learn the others using the official documentation.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
- en: Customizing Auth
  id: totrans-9
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: There are two ways to customize Auth. The old way of doing it consists of defining
    a custom `db.auth_user` table from scratch. A new way consists of letting web2py
    define the `auth` table, but listing extra fields that web2py should include in
    the table. Here, we will review the latter method.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
- en: Specifically, we will assume that each user must also have a username, a phone
    number, and an address.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  id: totrans-12
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In the `db.py` model, replace the following line:'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-14
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'Replace it with the following code:'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-16
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: How it works...
  id: totrans-17
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '`auth.settings.extra_fields` is a dictionary of extra fields. The `key` is
    the name of the `auth` table to which to add the extra fields. The `value` is
    a list of extra fields. Notice that we have added two extra fields (phone_number
    and `address)`, but not `username`, here, for `auth_user`.'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
- en: '`username` has to be treated in a special way, because it is involved in the
    authentication process, which is normally based on the `email` field. By passing
    the username argument to the following line, we tell web2py that we want the `username`
    field, and we want to use it for login instead of the `email` field.'
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  id: totrans-20
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: The username will also be made unique.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
- en: There's more...
  id: totrans-22
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'There may be cases when registration happens outside the normal registration
    form (for example, when using `Janrain`, or when users are registered by the administrator).
    Yet you may need to force a new user, after their first login, to complete their
    registration. This can be done using a dummy hidden extra field, `complete_registration`
    that is set to `False`, by default, and is set to `True` when they update their
    profile:'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  id: totrans-24
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Then, we may want to force new users, upon login, to complete their registration.
    In `db.py`, we can append the following code:'
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-26
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: This will force new users to edit their profile.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
- en: Using CAPTCHA on login failure
  id: totrans-28
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: web2py has built-in **ReCaptcha** support ([http://www.google.com/recaptcha](http://www.google.com/recaptcha)),
    but it is usually `ON` or `OFF`. It's useful to have it `ON`, which prevents brute
    force attacks on the application forms, yet it can be annoying to regular users.
    Here, we propose a solution, a plugin that conditionally turns `ON` ReCaptcha
    after a fixed number of login failures.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  id: totrans-30
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'All you need to do is create a new `models/plugin_conditionalrecaptcha.py`,
    which contains the following code, and your job is done:'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  id: totrans-32
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: There's more...
  id: totrans-33
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'You can customize the ReCaptcha appearance, by passing parameters to it through
    JavaScript. If you are using the default user controller for exposing `auth` login
    forms, you can simply edit the `user.html` view, and add the following code:'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  id: totrans-35
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'Add it before the following line:'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  id: totrans-37
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'The full ReCaptcha client API can be viewed at the following URL:'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
- en: '[http://recaptcha.net/apidocs/captcha/client.html](http://recaptcha.net/apidocs/captcha/client.html)'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
- en: Using pyGravatar to get avatars for user profile pages
  id: totrans-40
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'First download **pyGravatar** from the following URL:'
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
- en: '[https://bitbucket.org/gridaphobe/pygravatar/src](http://https://bitbucket.org/gridaphobe/pygravatar/src)'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
- en: 'Put the `gravatar.py` in `applications/yourapp/modules`. If you prefer, you
    can use the following command:'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  id: totrans-44
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'In any of your models source files, you have to import the Gravatar library
    to be able to use it, as shown in the following example:'
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  id: totrans-46
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'If you are using the scaffold application, edit the `default/user.html` view,
    as follows:'
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  id: totrans-48
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'You will now have a profile page that will look like the following screenshot:'
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
- en: '![Using pyGravatar to get avatars for user profile pages](img/5467OS_08_40.jpg)'
  id: totrans-50
  prefs: []
  type: TYPE_IMG
- en: 'Now, in any page, if you want the user avatar, then you just need to use the
    following code:'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  id: totrans-52
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: You can go further and get the user profile bio from [http://en.gravatar.com/](http://en.gravatar.com/).
    Add the following code to `default/user.html`.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  id: totrans-54
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'Then, you get the following:'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
- en: '![Using pyGravatar to get avatars for user profile pages](img/5467OS_08_41.jpg)'
  id: totrans-56
  prefs: []
  type: TYPE_IMG
- en: 'You can also get extra services that your user has registered in Gravatar,
    in the `default/user.html` view:'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  id: totrans-58
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'And then, you will see the additional information (about me and URL of registered
    services), in your web page:'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
- en: '![Using pyGravatar to get avatars for user profile pages](img/5467OS_08_42.jpg)'
  id: totrans-60
  prefs: []
  type: TYPE_IMG
- en: Tell your users to register in [http://en.gravatar.com/](http://en.gravatar.com/),
    using the same e-mail address used in your application.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
- en: Multi-user and teacher modes
  id: totrans-62
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Since version 1.92, you can set up web2py in a `mult-iuser` or `teaching` mode.
    There is one instance of web2py installed on a system, one account is the `admin`
    (or `teacher)`, and the other accounts are the `students`. Students can only see
    their own applications. It works as follows: The admin page is changed and now
    contains a login and register header. The first user to log in, in this mode,
    gets the role of `teacher`. Subsequent registrations will become `students`, after
    approval by the `teacher`. In the following recipe, I assume running web2py locally
    at `127.0.0.1` on port `8000`. The `teacher` and the `students` will need an **SSL-secured**
    web2py instance. See [Chapter 11](ch11.html "Chapter 11. Other Tips and Tricks"),
    *Other Tips and Tricks*, for more details.'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
- en: Note that in the `multi-user` mode, there is no security mechanism to prevent
    interference between administrators.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
- en: How to do it...
  id: totrans-65
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Install web2py in a folder; let's say `web2py_mu`.
  id: totrans-66
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Set `MULTI_USER_MODE = True`, in `admin/appadmin/0.py`.
  id: totrans-67
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Start web2py in the usual way, and click on the link for the administrative
    interface. Now you see the adapted administrative login.
  id: totrans-68
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click register to create the teacher account. You now enter the admin application.
  id: totrans-69
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Click on `logout`, and click on `register` to create the first `student` account
    (you can let the students do this; provide them with the link).
  id: totrans-70
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: After a student registers, his/her status is **Pending.Approving the students.**
  id: totrans-71
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Enter into the web2py `appadmin`, of the admin application, using the following
    URL: `http://127.0.0.1:8000/admin/appadmin`.'
  id: totrans-72
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Click on the `auth_user` table.
  id: totrans-73
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'You''re now looking at the teacher and students accounts. For each approved
    student:'
  id: totrans-74
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Click on its ID (leftmost column)
  id: totrans-75
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: Remove the word **pending** in the field `registration_key`
  id: totrans-76
  prefs:
  - PREF_IND
  - PREF_UL
  type: TYPE_NORMAL
- en: If available, you can also import a list of students by using a CSV file (to
    be expanded upon).
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
- en: There's more...
  id: totrans-78
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: For students just starting with Python and webapps, starting with a minimal
    application could be helpful. This simple setup will not include Ajax, and it
    will cover just minimal templating features.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
- en: Note
  id: totrans-80
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: On the right side, we need an extra option to load a minimal application, based
    on a file `minimal.w2p`.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
- en: The components of `appadmin` are not relevant for the beginning student, and
    intimidating, a configuration option `BASIC_STUDENT` as `False`, by default, could
    help. The teacher can turn this on, and at a later stage off. When `False`, these
    files can be hidden from sight, the admin screen, the wizard, and other advanced
    options.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
- en: Authenticating with Facebook using OAuth 2.0
  id: totrans-83
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: The following recipe will show how to build a simple application that authenticates
    users using Facebook's OAuth 2.0 authentication service.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
- en: 'OAuth 2.0 is the evolution of the OAuth 1.0a protocol. You can find the exact
    description of the protocol at the following URL:'
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
- en: '[http://oauth.net/2](http://oauth.net/2)'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
- en: Without entering in details, the main object of the protocol is allowing sites
    (**providers**) give trusted authentication credentials to other sites (**consumers**).
    This is very similar in scope to CAS authentication system, which is already implemented
    by web2py.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 不深入细节，协议的主要对象是允许网站（提供者）向其他网站（消费者）提供受信任的身份验证凭据。这在范围上与已经由web2py实现的CAS身份验证系统非常相似。
- en: At the moment, web2py implements OAuth 2.0 as consumer only. But, that is enough
    to allow any web2py application to authenticate against a provider of OAuth 2.0
    services.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 目前，web2py仅作为消费者实现OAuth 2.0。但这已经足够允许任何web2py应用程序对OAuth 2.0服务提供者进行身份验证。
- en: We show how to implement a small application that uses Facebook as OAuth 2.0
    provider, since it is the provider that was tested more in depth.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将展示如何实现一个小型应用程序，该程序使用Facebook作为OAuth 2.0提供者，因为它是最深入测试过的提供者。
- en: Getting ready
  id: totrans-90
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: 'Before you start, you need to register an application on Facebook:'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 在开始之前，你需要在Facebook上注册一个应用程序：
- en: '[http://developers.facebook.com](http://developers.facebook.com)'
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: '[http://developers.facebook.com](http://developers.facebook.com)'
- en: '![Getting ready](img/5467OS_08_39.jpg)'
  id: totrans-93
  prefs: []
  type: TYPE_IMG
  zh: '![准备工作](img/5467OS_08_39.jpg)'
- en: You must be careful about using the exact same URL (including the TCP port)
    that you use with the application.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 你必须小心使用与应用程序相同的精确URL（包括TCP端口）。
- en: 'Now, it is suggested that you use the Facebook Graph API Python library, to
    access the `REST` interface in a programmatic way. This recipe uses that library.
    You can download it here: https://github.com/facebook/python-sdk. Copy it to the
    `*modules*` directory of your application.'
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，建议你使用Facebook Graph API Python库，以编程方式访问`REST`接口。这个配方使用了这个库。你可以从这里下载它：https://github.com/facebook/python-sdk。将其复制到你应用程序的`*modules*`目录中。
- en: 'If you want to use the JSON engine that comes with web2py, change the `import`
    code at the beginning of the file to look simply like the following (the other
    statements are not needed):'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想要使用web2py附带的JSON引擎，将文件开头的`import`代码更改为以下样子（其他语句不需要）：
- en: '[PRE14]'
  id: totrans-97
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: How to do it...
  id: totrans-98
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: Create a file containing the **App Id** and the **App Secret**, shown in the
    registration page. Save it in the `modules` directory of you application, with
    the name `fbappauth.py:`
  id: totrans-99
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建一个包含注册页面中显示的**App Id**和**App Secret**的文件。将其保存在你应用程序的`modules`目录中，文件名为`fbappauth.py`：
- en: '[PRE15]'
  id: totrans-100
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE15]'
- en: Now, you only need to change the `auth` code in your model. You can put it in
    the usual `db.py` model that comes with the scaffolding application.
  id: totrans-101
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，你只需要更改模型中的`auth`代码。你可以将它放在与脚手架应用程序一起提供的常规`db.py`模型中。
- en: '[PRE16]'
  id: totrans-102
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE16]'
- en: As you can see, this class specializes the generic `OAuthAccount` class from
    `gluon.contrib.login_methods.oauth20_account.py`, so that it can work with the
    Facebook authentication server.
  id: totrans-103
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 正如你所见，这个类将`gluon.contrib.login_methods.oauth20_account.py`中的通用`OAuthAccount`类进行了特殊化，以便它可以与Facebook身份验证服务器一起工作。
- en: The following line defines where the user lands after the authentication server
    has positively accepted the user identity. Change it to whatever you need.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 以下行定义了在身份验证服务器确认用户身份后用户将到达的位置。将其更改为你需要的内容。
- en: '[PRE17]'
  id: totrans-105
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: There's more...
  id: totrans-106
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多...
- en: Often, you cannot test your application on the public server, where you will
    deploy the final application. Usually you can test it using `localhost` or `127.0.0.1`
    as a host.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 通常，你无法在最终部署应用程序的公共服务器上测试你的应用程序。通常你可以使用`localhost`或`127.0.0.1`作为主机进行测试。
- en: In the common case, using `localhost` as hostname does not work with your application.
    Add the proper entry in `/etc/hosts` (in the previous registered example application).
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 在常见情况下，使用`localhost`作为主机名与你的应用程序不兼容。在`/etc/hosts`（在先前注册的示例应用程序中）中添加适当的条目。
- en: '[PRE18]'
  id: totrans-109
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: But, be aware that, in either case, you need to use port `80` to avoid problems.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 但是，请注意，在两种情况下，你都需要使用端口`80`以避免问题。
- en: '[PRE19]'
  id: totrans-111
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: This often requires administrator permissions when starting web2py, or using
    capabilities where your system supports them.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 这通常在启动web2py或使用系统支持的功能时需要管理员权限。
