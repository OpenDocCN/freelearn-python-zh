<html><head></head><body>
<div><div><div><h1 id="_idParaDest-360"><em class="italic"><a id="_idTextAnchor341"/>Chapter 23</em>: Other Structural Patterns</h1>
			<p>Besides the patterns we covered in the previous chapters, there are other structural patterns we can cover: <strong class="bold">flyweight</strong>, <strong class="bold">model-view-controller</strong> (<strong class="bold">MVC</strong>), and <strong class="bold">proxy</strong>. These patterns are different from those discussed in previous chapters. The flyweight pattern is an optimization design pattern that's suitable for memory usage minimization. The MVC pattern, on the other hand, is popular in object-orient programming and is designed to separate different parts of a larger application. Finally, the proxy pattern is used to maintain actions that are taken on important objects.</p>
			<p>These three patterns will complete our discussion on structural patterns. </p>
			<p>In this chapter, we will cover the following topics:</p>
			<ul>
				<li>Implementing the flyweight pattern</li>
				<li>Implementing the model-view-controller pattern</li>
				<li>Applying the proxy pattern</li>
			</ul>
			<p>By the end of this chapter, we will have gained an overall understanding of various structural patterns and the use cases of each.</p>
			<h1 id="_idParaDest-361"><a id="_idTextAnchor342"/>Technical requirements</h1>
			<p>The code files for this chapter can be found at <a href="https://github.com/PacktPublishing/Advanced-Python-Programming-Second-Edition/tree/main/Chapter23">https://github.com/PacktPublishing/Advanced-Python-Programming-Second-Edition/tree/main/Chapter23</a>.</p>
			<h1 id="_idParaDest-362"><a id="_idTextAnchor343"/>Implementing the flyweight pattern</h1>
			<p><em class="italic">What is the flyweight pattern?</em> Object-oriented systems can face performance issues due to the <a id="_idIndexMarker1295"/>overhead of object creation. Performance issues usually appear in embedded systems with limited resources, such as smartphones and tablets. They can also appear in large and complex systems where we need to create a very large number of objects (and possibly users) that need to coexist at the same time. The <strong class="bold">flyweight</strong> pattern teaches programmers how to minimize memory usage by sharing resources with similar objects as much as possible.</p>
			<p>Whenever we create a new object, extra memory needs to be allocated. Although virtual memory provides us, theoretically, with unlimited memory, the reality is different. If all the physical memory of a system gets exhausted, it will start swapping pages with the secondary <a id="_idIndexMarker1296"/>storage – usually a <strong class="bold">hard disk drive</strong> (<strong class="bold">HDD</strong>) – which, in most cases, is unacceptable due to the performance differences <a id="_idIndexMarker1297"/>between the main memory and the HDD. <strong class="bold">Solid-state drives</strong> (<strong class="bold">SSDs</strong>) generally have better performance than HDDs, but not everybody is expected to use SSDs. So, SSDs are not going to completely replace HDDs anytime soon.</p>
			<p>Apart from memory <a id="_idIndexMarker1298"/>usage, performance is also a consideration. Graphics software, including computer games, should be able to render 3D information (for example, a forest with thousands of trees, a village full of soldiers, or an urban area with a lot of cars) extremely quickly. If each object in a 3D terrain is created individually and no data sharing is used, the performance will be prohibitive.</p>
			<p>As software engineers, we should solve software problems by writing better software, instead of forcing the customer to buy extra or better hardware. The flyweight design pattern is a <a id="_idIndexMarker1299"/>technique that's used to minimize memory usage and improve performance by introducing data sharing between similar objects (<a href="http://j.mp/wflyw">http://j.mp/wflyw</a>). A flyweight is a shared object that contains state-independent, immutable (also <a id="_idIndexMarker1300"/>known as <strong class="bold">intrinsic</strong>) data. The state-dependent, mutable (also <a id="_idIndexMarker1301"/>known as <strong class="bold">extrinsic</strong>) data should not be part of the flyweight pattern because this information cannot be shared since it differs per object. If the flyweight pattern needs extrinsic data, it should be provided explicitly by the client code.</p>
			<p>An example may help clarify how the flyweight pattern can be used practically. Let's assume that <a id="_idIndexMarker1302"/>we are creating a performance-critical game, such as a <strong class="bold">first-person shooter</strong> (<strong class="bold">FPS</strong>). In FPS games, the players (soldiers) share some states, such as representation and behavior. In <em class="italic">Counter-Strike</em>, for instance, all the soldiers on the same team (counter-terrorists versus terrorists) look the same (representation). In the same game, all the soldiers (on both teams) have some common actions, such as <em class="italic">jump</em>, <em class="italic">duck</em>, and so forth (behavior). This means that we can create a flyweight that will contain all of the common data. Of course, the soldiers also have a lot of data that is different per soldier and will not be a part of the flyweight, such as weapons, health, and location.</p>
			<p><em class="italic">What are other real-world examples of the flyweight pattern?</em> We will discuss them in the next section.</p>
			<h2 id="_idParaDest-363"><a id="_idTextAnchor344"/>Real-world examples</h2>
			<p>Flyweight is an optimization design pattern. Therefore, it is not easy to find a good non-computing <a id="_idIndexMarker1303"/>example of it. We can think of flyweight as caching in real life. For example, many bookstores have dedicated shelves containing the newest and most popular publications. This is a cache: first, you can look at the dedicated shelves for the book you are looking for, and if you cannot find it, you can ask the bookseller to assist you.</p>
			<p>The <em class="italic">Exaile</em> music player uses flyweight to reuse objects (in this case, music tracks) that are identified by the same URL. There's no point in creating a new object if it has the same URL as an existing object, so the same object is reused to save resources.</p>
			<p><em class="italic">Peppy</em>, an XEmacs-like editor that's implemented in Python, uses the flyweight pattern to store the state of a major mode status bar. That's because, unless they're modified by the user, all the status bars share the same properties.</p>
			<h2 id="_idParaDest-364"><a id="_idTextAnchor345"/>Use cases</h2>
			<p>Flyweight is <a id="_idIndexMarker1304"/>all about improving performance and memory usage. All embedded systems (phones, tablets, games consoles, microcontrollers, and so forth) and performance-critical applications (games, 3D graphics processing, real-time systems, and so forth) can benefit from it.</p>
			<p>The <em class="italic">Gang of Four</em> (<em class="italic">GoF</em>) book lists the following requirements that need to be satisfied to effectively use the flyweight pattern:</p>
			<ul>
				<li>The application needs to use many objects.</li>
				<li>There are so many objects that it's too expensive to store/render them. Once the mutable state is removed (because if it is required, it should be passed explicitly to the flyweight pattern by the client code), many groups of distinct objects can be replaced by relatively few shared objects.</li>
				<li>Object identity is not important for the application. We cannot rely on object identity because object sharing causes identity comparisons to fail (objects that appear different to the client code end up having the same identity).</li>
			</ul>
			<p>Now, let's look at our hands-on implementation of the flyweight pattern.</p>
			<h2 id="_idParaDest-365"><a id="_idTextAnchor346"/>Implementation</h2>
			<p>Let's see how we <a id="_idIndexMarker1305"/>can implement the example that we briefly mentioned in the introduction to this section for cars in an area. We will create a small car park to illustrate the idea, making sure that the whole output can be read on a single Terminal page. However, no matter how large you make the car park, the memory allocation stays the same.</p>
			<p>Before diving into the code, let's spend a moment noting the differences between memoization <a id="_idIndexMarker1306"/>and the flyweight pattern. <strong class="bold">Memoization</strong> is an optimization technique that uses a cache to avoid recomputing results that were already computed in an earlier execution step. Memoization does not focus on a specific programming <a id="_idIndexMarker1307"/>paradigm such as <strong class="bold">object-oriented programming</strong> (<strong class="bold">OOP</strong>). In Python, memoization can be applied to both methods and simple functions. Flyweight is an OOP-specific optimization design pattern that focuses on sharing object data.</p>
			<p>First, we need an <code>Enum</code> parameter that describes the three different types of cars that are in the car park:</p>
			<pre>CarType = Enum('CarType', 'subcompact compact suv')</pre>
			<p>Then, we will define the class at the core of our implementation: <code>Car</code>. The <code>pool</code> variable is the object pool (in other words, our cache). Notice that <code>pool</code> is a class attribute (a variable that's shared by all instances).</p>
			<p>Using the <code>__new__()</code> special method, which is called before <code>__init__()</code>, we are converting the <code>Car</code> class into a metaclass that supports self-references. This means that <code>cls</code> references the <code>Car</code> class. When the client code creates an instance of <code>Car</code>, it passes the type of the car as <code>car_type</code>. The car's type is used to check if a car of the same type has already been created. If that's the case, the previously created object is returned; otherwise, the new car type is added to the pool and returned:</p>
			<pre>class Car: 
    pool = dict() 
 
    def __new__(cls, car_type): 
        obj = cls.pool.get(car_type, None) 
        if not obj: 
            obj = object.__new__(cls) 
            cls.pool[car_type] = obj 
            obj.car_type = car_type 
        return obj</pre>
			<p>The <code>render()</code> method is what will be used to render a car on the screen. Notice how all the mutable information not known by flyweight needs to be explicitly passed by the client code. In this case, a random color and the coordinates of a location (of the <em class="italic">x, y</em> form) are used for each car.</p>
			<p>Also, note that <a id="_idIndexMarker1308"/>to make <code>render()</code> more useful, it is necessary to ensure that no cars are rendered on top of each other. Consider this as an exercise: if you want to make rendering more fun, you can use a graphics toolkit such as Tkinter, Pygame, or Kivy.</p>
			<p>The <code>render()</code> method is defined as follows:</p>
			<pre>    def render(self, color, x, y):
        type = self.car_type
        msg = f'render a car of type {type} and color \
          {color} at ({x}, {y})'
        print(msg)</pre>
			<p>The <code>main()</code> function shows how we can use the flyweight pattern. The color of a car is a random value from a predefined list of colors. The coordinates use random values between <code>1</code> and <code>100</code>. As we will see shortly, although 18 cars are rendered, memory is only allocated for 3. The last line of the output, which we will see later, proves that when using flyweight, we cannot rely on object identity.</p>
			<p>The <code>id()</code> function returns the memory address of an object. This is not the default behavior in Python because, by default, <code>id()</code> returns a unique ID (the memory address of an object as an integer) for each object. In our case, even if two objects appear to be different, they have the same identity if they belong to the same flyweight family (in this case, the family is defined by <code>car_type</code>). Of course, different identity comparisons can still be used <a id="_idIndexMarker1309"/>for objects of different families, but that is only possible if the client knows the implementation details.</p>
			<p>Our example <code>main()</code> function's code is as follows:</p>
			<pre>def main():
    rnd = random.Random() 
    colors = 'white black silver gray red blue brown \
      beige yellow green'.split()
    min_point, max_point = 0, 100 
    car_counter = 0 
 
    for _ in range(10): 
        c1 = Car(CarType.subcompact) 
        c1.render(random.choice(colors), 
                  rnd.randint(min_point, max_point), 
                  rnd.randint(min_point, max_point)) 
        car_counter += 1 
 
    ...
 
    print(f'cars rendered: {car_counter}') 
    print(f'cars actually created: {len(Car.pool)}') 
 
    c4 = Car(CarType.subcompact) 
    c5 = Car(CarType.subcompact) 
    c6 = Car(CarType.suv) 
    print(f'{id(c4)} == {id(c5)}? {id(c4) == id(c5)}') 
    print(f'{id(c5)} == {id(c6)}? {id(c5) == id(c6)}')</pre>
			<p>Here is the <a id="_idIndexMarker1310"/>full code listing (the <code>flyweight.py</code> file) to show you how the flyweight pattern is implemented and used:</p>
			<ol>
				<li>First, we need a couple of imports:<pre>import random 
from enum import Enum</pre></li>
				<li>The <code>Enum</code> for the types of cars is shown here:<pre>CarType = Enum('CarType', 'subcompact compact suv')</pre></li>
				<li>Then, we have the <code>Car</code> class, with its <code>pool</code> attribute and the <code>__new__()</code> and <code>render()</code> methods:<pre>class Car: 
    pool = dict() 
 
    def __new__(cls, car_type): 
        obj = cls.pool.get(car_type, None) 
        if not obj: 
            obj = object.__new__(cls) 
            cls.pool[car_type] = obj 
            obj.car_type = car_type 
        return obj 
 
    def render(self, color, x, y):
        type = self.car_type
        msg = f'render a car of type {type} and  \
          color {color} at ({x}, {y})'
        print(msg)</pre></li>
				<li>In the <a id="_idIndexMarker1311"/>first part of the <code>main</code> function, we define some variables and render a set of cars of the <code>subcompact</code> type:<pre>def main(): 
    rnd = random.Random() 
    colors = 'white black silver gray red blue \
      brown beige yellow green'.split()
    min_point, max_point = 0, 100 
    car_counter = 0 
 
    for _ in range(10): 
        c1 = Car(CarType.subcompact) 
        c1.render(random.choice(colors), 
                  rnd.randint(min_point, max_point), 
                  rnd.randint(min_point, max_point)) 
        car_counter += 1  </pre></li>
				<li>The second part of the <code>main</code> function is as follows, which renders another set of cars of the <code>compact</code> type:<pre>for _ in range(3): 
    c2 = Car(CarType.compact) 
    c2.render(random.choice(colors), 
              rnd.randint(min_point, max_point), 
              rnd.randint(min_point, max_point)) 
    car_counter += 1 </pre></li>
				<li>The third <a id="_idIndexMarker1312"/>part of the <code>main</code> function is as follows, this time with <code>suv</code> cars:<pre>for _ in range(5):   c3 = Car(CarType.suv) 
        c3.render(random.choice(colors), 
                  rnd.randint(min_point, max_point), 
                  rnd.randint(min_point, max_point)) 
        car_counter += 1 
 
    print(f'cars rendered: {car_counter}') 
    print(f'cars actually created: {len(Car.pool)}')</pre></li>
				<li>Finally, here is the fourth part of the <code>main</code> function, where we create three additional cars of the three types:<pre>c4 = Car(CarType.subcompact)
c5 = Car(CarType.subcompact)
c6 = Car(CarType.suv)
print(f'{id(c4)} == {id(c5)}? {id(c4) == id(c5)}')
print(f'{id(c5)} == {id(c6)}? {id(c5) == id(c6)}')  </pre></li>
				<li>We do not forget our usual <code>__name__ == '__main__'</code> trick and good practice, as follows:<pre>if __name__ == '__main__':
     main()</pre></li>
			</ol>
			<p>The execution of the Python <code>flyweight.py</code> command shows the type, random color, and coordinates of the rendered objects, as well as the identity comparison results between flyweight <a id="_idIndexMarker1313"/>objects of the same/different families:</p>
			<pre>render a car of type CarType.subcompact and color yellow at 
(57, 51)
render a car of type CarType.subcompact and color blue at 
(10, 61)
render a car of type CarType.subcompact and color gray at 
(65, 74)
render a car of type CarType.subcompact and color red at 
(10, 19)
render a car of type CarType.subcompact and color green at 
(89, 5)
render a car of type CarType.subcompact and color green at 
(88, 76)
render a car of type CarType.subcompact and color black at 
(0, 18)
render a car of type CarType.subcompact and color silver at 
(43, 12)
render a car of type CarType.subcompact and color red at 
(25, 71)
render a car of type CarType.subcompact and color blue at 
(68, 38)
render a car of type CarType.compact and color white at 
(79, 48)
render a car of type CarType.compact and color green at 
(18, 93)
render a car of type CarType.compact and color brown at 
(71, 43)
render a car of type CarType.suv and color silver at 
(2, 71)
render a car of type CarType.suv and color blue at (70, 42)
render a car of type CarType.suv and color silver at 
(100, 98)
render a car of type CarType.suv and color gray at (83, 49)
render a car of type CarType.suv and color brown at (77, 2)
cars rendered: 18
cars actually created: 3
140569248959360 == 140569248959360? True
140569248959360 == 140569298067216? False</pre>
			<p>Do not <a id="_idIndexMarker1314"/>expect to see the same output since the colors and coordinates are random, and the object identities depend on the memory map.</p>
			<p>This program marks the end of our discussion of the flyweight pattern. In the next section, we will learn about the MVC pattern.</p>
			<h1 id="_idParaDest-366"><a id="_idTextAnchor347"/>Implementing the model-view-controller pattern</h1>
			<p>The MVC pattern <a id="_idIndexMarker1315"/>is useful mainly in application development and helps developers improve the maintainability of their applications by avoiding mixing the business logic with the user interface.</p>
			<p>One of the <a id="_idIndexMarker1316"/>design principles related to software engineering is the <strong class="bold">separation of concerns</strong> (<strong class="bold">SoC</strong>) principle. The idea behind the SoC principle is to split an application into distinct sections, where each section addresses a separate concern. Examples of such concerns are the layers that are used in a layered design (data access layer, business logic layer, presentation layer, and so forth). Using the SoC principle simplifies the development and maintenance of software applications.</p>
			<p>The MVC pattern is nothing more than the SoC principle applied to OOP. The name of the pattern <a id="_idIndexMarker1317"/>comes from <a id="_idIndexMarker1318"/>the three <a id="_idIndexMarker1319"/>main components that are used to split a software application: the <strong class="bold">model</strong>, the <strong class="bold">view</strong>, and the <strong class="bold">controller</strong>. MVC is considered an architectural pattern rather than a design pattern. The difference between an architectural and a design pattern is that the former has a broader scope than the latter. Nevertheless, MVC is too important to skip just for this reason. Even if we will never have to implement it from scratch, we need to be familiar with it because all common frameworks use MVC or a slightly different version of it (more on this shortly).</p>
			<p>The model is <a id="_idIndexMarker1320"/>the core component. It represents knowledge. It contains and manages the (business) logic, data, state, and rules of an application. The view is a visual representation of the model. Examples of views include a computer GUI, the text output of a computer terminal, a smartphone's application GUI, a PDF document, a pie chart, a bar chart, and so forth. The view only displays the data; it doesn't handle it. The controller is the link/glue between the model and view. All communication between the model and the view happens through a controller.</p>
			<p>A typical use case <a id="_idIndexMarker1321"/>for an application that uses MVC, after the initial screen is rendered for the user, is as follows:</p>
			<ol>
				<li value="1">The user triggers a view by clicking (typing, touching, and so on) a button.</li>
				<li>The view informs the controller of the user's action.</li>
				<li>The controller processes user input and interacts with the model.</li>
				<li>The model performs all the necessary validation and state changes and informs the controller about what should be done.</li>
				<li>The controller instructs the view to update and display the output appropriately, following the instructions that are given by the model.</li>
			</ol>
			<p>This is summarized in the following diagram:</p>
			<div><div><img src="img/Figure_23.1_B17499.jpg" alt="Figure 23.1 — An MVC diagram for a typical computer program " width="1565" height="960"/>
				</div>
			</div>
			<p class="figure-caption">Figure 23.1 — An MVC diagram for a typical computer program</p>
			<p><em class="italic">You might be wondering, why is the controller part necessary? Can't we just skip it?</em> We could, but then we would lose a big benefit that MVC provides: the ability to use more than <a id="_idIndexMarker1322"/>one view (even at the same time, if that's what we want) without modifying the model. To achieve decoupling between the model and its representation, every view typically needs a controller. If the model communicated directly with a specific view, we wouldn't be able to use multiple views (or at least, not in a clean and modular way).</p>
			<p>Now, let's see where the MVC pattern is used in the real world.</p>
			<h2 id="_idParaDest-367"><a id="_idTextAnchor348"/>Real-world examples</h2>
			<p>As we <a id="_idIndexMarker1323"/>mentioned previously, MVC is the SoC principle applied to OOP. The SoC principle is used a lot in real life. For example, if you build a new house, you usually assign different professionals to do the following:</p>
			<ul>
				<li>Install the plumbing and electricity</li>
				<li>Paint the house</li>
			</ul>
			<p>Another <a id="_idIndexMarker1324"/>example is a restaurant. In a restaurant, the waiters receive orders and serve dishes to the customers, but the meals are cooked by the chefs.</p>
			<p>In web development, several frameworks use the MVC idea:</p>
			<ul>
				<li>The <strong class="bold">Web2py</strong> framework (<a href="http://j.mp/webtopy">http://j.mp/webtopy</a>) is a <a id="_idIndexMarker1325"/>lightweight Python framework that embraces the MVC pattern. If you <a id="_idIndexMarker1326"/>have never tried Web2py, I encourage you to do so since it is extremely simple to install. Many examples demonstrate how MVC can be used in Web2py on the project's web page.</li>
				<li><strong class="bold">Django</strong> is also <a id="_idIndexMarker1327"/>an MVC framework, although it uses different <a id="_idIndexMarker1328"/>naming conventions. The controller is called <a id="_idIndexMarker1329"/>view, and the <a id="_idIndexMarker1330"/>view is called <strong class="bold">template</strong>. Django <a id="_idIndexMarker1331"/>uses the name <strong class="bold">Model-Template-View</strong> (<strong class="bold">MTV</strong>). According to the designers of Django, the view describes what data is seen by the user, so it uses the name view as the Python callback function for a particular URL. The term <em class="italic">template</em> in Django is used to separate content from its representation. It describes <em class="italic">how</em> the data is seen by the user, not <em class="italic">which</em> data is seen.</li>
			</ul>
			<p>In the next section, we will detail the specific use cases of the MVC pattern.</p>
			<h2 id="_idParaDest-368"><a id="_idTextAnchor349"/>Use cases</h2>
			<p>MVC is a <a id="_idIndexMarker1332"/>very generic and useful design pattern. All popular web frameworks (Django, Rails, and Symfony or Yii) and application frameworks (iPhone <a id="_idIndexMarker1333"/>SDK, Android, and QT) make use of MVC or <a id="_idIndexMarker1334"/>a variation of it – <strong class="bold">model-view-adapter</strong> (<strong class="bold">MVA</strong>), <strong class="bold">model-view-presenter</strong> (<strong class="bold">MVP</strong>), and so forth. However, even if we don't use any of these frameworks, it makes sense to implement the pattern on our own because of the benefits it provides, which are as follows:</p>
			<ul>
				<li>The separation between the view and model allows graphic designers to focus on the <a id="_idIndexMarker1335"/>UI part and programmers to focus on development, without them interfering with each other.</li>
				<li>Because of the loose coupling between the view and the model, each part can be modified/extended without them affecting the other. For example, adding a new view is trivial – just implement a new controller for it.</li>
				<li>Maintaining each part is easier because the responsibilities are clear.</li>
			</ul>
			<p>When you implement MVC from scratch, ensure that you create smart models, thin controllers, and dumb views.</p>
			<p>A model is <a id="_idIndexMarker1336"/>considered smart because it does the following:</p>
			<ul>
				<li>Contains all the validation/business rules/logic</li>
				<li>Handles the state of the application</li>
				<li>Has access to application data (database, cloud, and so on)</li>
				<li>Does not depend on the UI</li>
			</ul>
			<p>A controller is <a id="_idIndexMarker1337"/>considered thin because it does the following:</p>
			<ul>
				<li>Updates the model when the user interacts with the view</li>
				<li>Updates the view when the model changes</li>
				<li>Processes the data before delivering it to the model/view, if necessary</li>
				<li>Does not display the data</li>
				<li>Does not access the application data directly</li>
				<li>Does not contain validation/business rules/logic</li>
			</ul>
			<p>A view is <a id="_idIndexMarker1338"/>considered dumb because it does the following:</p>
			<ul>
				<li>Displays the data</li>
				<li>Allows the user to interact with it</li>
				<li>Does only minimal processing, usually provided by a template language (for example, using simple variables and loop controls)</li>
				<li>Does not store any data</li>
				<li>Does <a id="_idIndexMarker1339"/>not access the application data directly</li>
				<li>Does not contain validation/business rules/logic</li>
			</ul>
			<p>If you <a id="_idIndexMarker1340"/>are implementing MVC from scratch and want to find out if you did it right, you can try answering some key questions:</p>
			<ul>
				<li><em class="italic">If your application has a GUI, is it skinnable? How easily can you change the skin/look and feel of it? Can you give the user the ability to change the skin of your application during runtime?</em> If these tasks cannot be done easily, it means that something is going wrong with your MVC implementation.</li>
				<li><em class="italic">If your application has no GUI (for instance, if it's a terminal application), how hard is it to add GUI support? Or, if adding a GUI is irrelevant, is it easy to add views to display the results in a chart (pie chart, bar chart, and so on) or a document (PDF, spreadsheet, and so on)?</em> If these changes are not trivial (a matter of creating a new controller with a view attached to it, without modifying the model), MVC has not been implemented properly.</li>
			</ul>
			<p>If you make sure that these conditions are satisfied, your application will be more flexible and maintainable compared to an application that does not use MVC. We'll look at an example of this in the next section, where we will implement an application to maintain a collection of quotes.</p>
			<h2 id="_idParaDest-369"><a id="_idTextAnchor350"/>Implementation</h2>
			<p>I could use <a id="_idIndexMarker1341"/>any of the common frameworks to demonstrate how to use MVC, but I feel that the picture would be incomplete. So, I have decided to show you how to implement MVC from scratch using a very simple example: a quote printer. The idea is extremely simple. The user enters a number and sees the quote related to that number. The quotes are stored in a <code>quotes</code> tuple. This is the data that normally exists in a database, a file, and so on, and only the model has direct access to it.</p>
			<p>Let's consider the following code example:</p>
			<pre>quotes = 
(
  'A man is not complete until he is married. Then he is \
    finished.',
  'As I said before, I never repeat myself.',
  'Behind a successful man is an exhausted woman.',
  'Black holes really suck...',
  'Facts are stubborn things.'
)</pre>
			<p>The model <a id="_idIndexMarker1342"/>is minimalistic; it only has a <code>get_quote()</code> method that returns the quote (string) of the <code>quotes</code> tuple based on its index, <em class="italic">n</em>. Note that <em class="italic">n</em> can be less than or equal to <code>0</code>, due to the way indexing works in Python:</p>
			<pre>class QuoteModel:
     def get_quote(self, n):
         try:
             value = quotes[n]
         except IndexError as err:
             value = 'Not found!'
         return value</pre>
			<p>The view has three methods:</p>
			<ul>
				<li><code>Show()</code>, which is <a id="_idIndexMarker1343"/>used to print a quote (or the message; that is, <code>Not found!</code>) on the screen.</li>
				<li><code>error()</code>, which is <a id="_idIndexMarker1344"/>used to print an error message on the screen.</li>
				<li><code>select_quote()</code>, which <a id="_idIndexMarker1345"/>reads the user's selection.</li>
			</ul>
			<p>This can be seen in the following code:</p>
			<pre>class QuoteTerminalView:
     def show(self, quote):
         print(f'And the quote is: "{quote}"')
  
     def error(self, msg):
         print(f'Error: {msg}')
  
     def select_quote(self):
         return input('Which quote number would you like  \
           to see? ')</pre>
			<p>The controller <a id="_idIndexMarker1346"/>does the coordination. The <code>__init__()</code> method <a id="_idIndexMarker1347"/>initializes the model and view. The <code>run()</code> method validates <a id="_idIndexMarker1348"/>the quoted index that's been given by the user, gets the quote from the model, and passes it back to the view to be displayed, as shown in the following code:</p>
			<pre>class QuoteTerminalController:
     def __init__(self):
         self.model = QuoteModel()
         self.view = QuoteTerminalView()
  
     def run(self):
         valid_input = False
         while not valid_input:
             try:
                 n = self.view.select_quote()
                 n = int(n)
                 valid_input = True
             except ValueError as err:
                 self.view.error(f"Incorrect index '{n}'")
         quote = self.model.get_quote(n)
         self.view.show(quote)</pre>
			<p>Last but <a id="_idIndexMarker1349"/>not least, the <code>main()</code> function initializes and fires the controller, as shown in the following code:</p>
			<pre>def main():
     controller = QuoteTerminalController()
     while True:
         controller.run()</pre>
			<p>The following is the complete workflow for this example (the <code>mvc.py</code> file):</p>
			<ol>
				<li value="1">We start by defining a variable for the list of quotes.</li>
				<li>We implement the model class, <code>QuoteModel</code>.</li>
				<li>Then, we implement the view class, <code>QuoteTerminalView</code>. </li>
				<li>Finally, we implement the controller class, <code>QuoteTerminalController</code>. </li>
				<li>At the end of our example code with the <code>main()</code> function, we initialize and run the controller.</li>
			</ol>
			<p>The following sample execution of the Python <code>mvc.py</code> command shows how the program prints out quotes for the user:</p>
			<pre>Which quote number would you like to see? 2
And the quote is: "Behind a successful man is an exhausted 
woman."
Which quote number would you like to see? 4
And the quote is: "Facts are stubborn things."
Which quote number would you like to see? 1
And the quote is: "As I said before, I never repeat 
myself."
Which quote number would you like to see? 6
And the quote is: "Not found!"
Which quote number would you like to see? 3
And the quote is: "Black holes really suck..."
Which quote number would you like to see? 0
And the quote is: "A man is not complete until he is 
married. Then he is finished."
Which quote number would you like to see?   </pre>
			<p>Here, we <a id="_idIndexMarker1350"/>can see that everything is working as intended!</p>
			<p>And with that, we will move on to the last topic of this chapter: the proxy pattern.</p>
			<h1 id="_idParaDest-370"><a id="_idTextAnchor351"/>Applying the proxy pattern</h1>
			<p>In some applications, we want to execute one or more important actions before accessing <a id="_idIndexMarker1351"/>an object. This is where the <strong class="bold">proxy pattern</strong> comes in. An <a id="_idIndexMarker1352"/>example is accessing sensitive information. Before we allow any user to access sensitive information, we want to make sure that the user has sufficient privileges. The <a id="_idIndexMarker1353"/>important action is not necessarily related to <a id="_idIndexMarker1354"/>security issues. <strong class="bold">Lazy initialization</strong> (<a href="http://j.mp/wikilazy">http://j.mp/wikilazy</a>) is another case; we want to delay the creation of a computationally expensive object until the first time the user needs to use it. The idea of the proxy pattern is to help with performing such an action before accessing the actual object.</p>
			<p>The proxy design pattern <a id="_idIndexMarker1355"/>gets its name from the <em class="italic">proxy</em> (also known as <em class="italic">surrogate</em>) object, which is used to perform an important <a id="_idIndexMarker1356"/>action before the actual object is accessed. There are four different well-known proxy types (<a href="http://j.mp/proxypat">http://j.mp/proxypat</a>). They are as follows:</p>
			<ul>
				<li>A <strong class="bold">remote proxy</strong>, which <a id="_idIndexMarker1357"/>acts as the local <a id="_idIndexMarker1358"/>representation of an object that exists in a different address space (for example, a network server).</li>
				<li>A <strong class="bold">virtual proxy</strong>, which <a id="_idIndexMarker1359"/>uses lazy initialization <a id="_idIndexMarker1360"/>to defer the creation of a computationally expensive object until the moment it is needed.</li>
				<li>A <strong class="bold">protection/protective proxy</strong>, which <a id="_idIndexMarker1361"/>controls <a id="_idIndexMarker1362"/>access to a sensitive object.</li>
				<li>A <strong class="bold">smart (reference) proxy</strong>, which <a id="_idIndexMarker1363"/>performs extra actions when an object is accessed. Examples <a id="_idIndexMarker1364"/>of such actions include reference counting and thread-safety checks.</li>
			</ul>
			<p>I find virtual <a id="_idIndexMarker1365"/>proxies very useful, so let's look at an example of how we can implement them in Python right now. In the <em class="italic">Implementation</em> subsection of this section, you will learn how to create protective proxies.</p>
			<p>There are many ways to create a virtual proxy in Python, but I always like focusing on the idiomatic/Pythonic implementations. The code shown here is based on the great answer by Cyclone, a user of the following site: <a href="http://stackoverflow.com/">http://stackoverflow.com/</a> (<a href="http://j.mp/solazyinit">http://j.mp/solazyinit</a>). To avoid confusion, I should clarify that in this section, the terms <em class="italic">property</em>, <em class="italic">variable</em>, and <em class="italic">attribute</em> are used interchangeably.</p>
			<p>First, we must create a <code>LazyProperty</code> class that can be used as a decorator. When it decorates a property, <code>LazyProperty</code> loads the property lazily (on the first use), instead of instantly. The <code>__init__()</code> method creates two variables that are used as aliases to the method that initializes a property. The <code>method</code> variable is an alias to the actual method, while the <code>method_name</code> variable is an alias to the method's name. To get a better understanding of how the two aliases are used, print their values to the output (uncomment the two commented lines in the following code):</p>
			<pre>class LazyProperty:
    def __init__(self, method):
        self.method = method
        self.method_name = method.__name__
        # print(f"function overriden: {self.fget}")
        # print(f"function's name: {self.func_name}")</pre>
			<p>The <code>LazyProperty</code> class is a descriptor (<a href="http://j.mp/pydesc">http://j.mp/pydesc</a>). Descriptors are the recommended <a id="_idIndexMarker1366"/>mechanisms to use in Python to override the default behavior of its attribute access methods: <code>__get__()</code>, <code>__set__()</code>, and <code>__delete__()</code>. The <code>LazyProperty</code> class only overrides <code>__set__()</code> because that is the only access method it needs to override. In other words, we don't have to override all the access methods. The <code>__get__()</code> method accesses the value of the property the underlying method wants to assign and uses <code>setattr()</code> to do the assignment manually.</p>
			<p>What <code>__get()__</code>does is very neat: it replaces the method with the value! This means that not only is the property lazily loaded, but it can also only be set once. We will see what this means in a moment. Again, uncomment the commented line in the following code to get some extra information:</p>
			<pre>def __get__(self, obj, cls):
    if not obj:
        return None
    value = self.method(obj)
    # print(f'value {value}')
    setattr(obj, self.method_name, value)
    return value</pre>
			<p>The <code>Test</code> class shows how we can use the <code>LazyProperty</code> class. There are three attributes: <code>x</code>, <code>y</code>, and <code>_resource</code>. We want the <code>_resource</code> variable to be loaded lazily; thus, we must initialize it to <code>None</code>, as shown in the following code:</p>
			<pre>class Test:
    def __init__(self):
        self.x = 'foo'
        self.y = 'bar'
        self._resource = None</pre>
			<p>The <code>resource()</code> method is decorated with the <code>LazyProperty</code> class. For demonstration purposes, the <code>LazyProperty</code> class initializes the <code>_resource</code> attribute as a tuple, as shown in <a id="_idIndexMarker1367"/>the following code. Normally, this would be a slow/expensive initialization process (database, graphics, and so on):</p>
			<pre>@LazyProperty
def resource(self):
    print(f'initializing self._resource which is: \
      {self._resource}')        
    self._resource = tuple(range(5)) # expensive
    return self._resource</pre>
			<p>The <code>main()</code> function, as follows, shows how lazy initialization behaves:</p>
			<pre>def main():     
     t = Test()
     print(t.x)
     print(t.y)
     # do more work...
     print(t.resource)
     print(t.resource)</pre>
			<p>Notice how overriding the <code>__get()__</code> access method makes it possible to treat the <code>resource()</code> method as a simple attribute (we can use <code>t.resource</code> instead of <code>t.resource()</code>).</p>
			<p>In the execution output of this example (the <code>lazy.py</code> file), we can see the following:</p>
			<ul>
				<li>The <code>_resource</code> variable is initialized not by the time the <code>t</code> instance is created, but the first time that we use <code>t.resource</code>.</li>
				<li>The second time <code>t.resource</code> is used, the variable is not initialized again. That's why the initialization string that's initializing <code>self._resource</code> is shown only once.</li>
			</ul>
			<p>Here is the output we get when we execute the Python <code>lazy.py</code> command:</p>
			<pre>foo
bar
initializing self._resource which is: None
(0, 1, 2, 3, 4)
(0, 1, 2, 3, 4)  </pre>
			<p>There <a id="_idIndexMarker1368"/>are two<a id="_idIndexMarker1369"/> basic, different kinds of lazy initialization in OOP. They are as follows:</p>
			<ul>
				<li><strong class="bold">At the instance level</strong>: This means that an object's property is initialized lazily, but the property has an object scope. Each instance (object) of the same class has its own (different) copy of the property.</li>
				<li><strong class="bold">At the class or module level</strong>: In this case, we do not want a different copy per instance, but all the instances share the same property, which is lazily initialized. This case is not covered in this chapter. If you find it interesting, consider it as an exercise.</li>
			</ul>
			<p>Now, let's see what real-world examples follow the proxy pattern.</p>
			<h2 id="_idParaDest-371"><a id="_idTextAnchor352"/>Real-world examples</h2>
			<p><strong class="bold">Chip</strong> (also <a id="_idIndexMarker1370"/>known as <strong class="bold">Chip and PIN</strong>) cards (<a href="http://j.mp/wichpin">http://j.mp/wichpin</a>) offer a good <a id="_idIndexMarker1371"/>example of how <a id="_idIndexMarker1372"/>a protective proxy is used in real life. A debit/credit card contains a chip that needs to be read by the ATM or card reader. Once the chip <a id="_idIndexMarker1373"/>has been verified, a password (PIN) is required to complete the transaction. This means that you cannot make any transactions without physically presenting the card and knowing the PIN.</p>
			<p>A bank check, which is used instead of cash to make purchases and deals, is an example of a remote proxy. The check gives access to a bank account.</p>
			<p>In software, the <code>weakref</code> module of Python contains a <code>proxy()</code> method, which accepts an input object and returns a smart proxy to it. Weak references are the recommended way to add reference-counting support to an object.</p>
			<h2 id="_idParaDest-372"><a id="_idTextAnchor353"/>Use cases</h2>
			<p>Since there <a id="_idIndexMarker1374"/>are at least four common proxy types, the proxy design pattern has many use cases, as follows:</p>
			<ul>
				<li>It is used to create a distributed system using either a private network or the cloud. In a distributed system, some objects exist in the local memory, while other objects exist in the memory of remote computers. If we don't want the client code to be aware of such differences, we can create a remote proxy that hides/encapsulates them, making the distributed nature of the application transparent.</li>
				<li>It is used when our application is suffering from performance issues due to the early creation of expensive objects. Introducing lazy initialization using a virtual proxy to create the objects only at the moment they are required can give us significant performance improvements.</li>
				<li>It is used to check if a user has sufficient privileges to access a piece of information. If our application handles sensitive information (for example, medical data), we want to make sure that the user who's trying to access/modify it is allowed to do so. A protection/protective proxy can handle all security-related actions.</li>
				<li>It is used when our application (or library, toolkit, framework, and so forth) uses multiple threads and we want to move the burden of thread safety from the client code <a id="_idIndexMarker1375"/>to the application. In this case, we can create a smart proxy to hide the thread-safety complexities from the client.</li>
				<li>An <strong class="bold">object-relational mapping</strong> (<strong class="bold">ORM</strong>) API is also an example of how to use a remote <a id="_idIndexMarker1376"/>proxy. Many popular web frameworks, including Django, use an ORM to provide OOP-like access to a relational database. An ORM acts as a proxy to a relational database that can be located anywhere, either at a local or remote server.</li>
			</ul>
			<p>Now, let's apply the proxy pattern to build a simple interface that provides example users' information.</p>
			<h2 id="_idParaDest-373"><a id="_idTextAnchor354"/>Implementation</h2>
			<p>To demonstrate <a id="_idIndexMarker1377"/>the proxy pattern, we will implement a simple protection proxy to view and add users. The service provides two options:</p>
			<ul>
				<li><strong class="bold">Viewing the list of users</strong>: This operation does not require special privileges.</li>
				<li><strong class="bold">Adding a new user</strong>: This operation requires the client to provide a special secret message.</li>
			</ul>
			<p>The <code>SensitiveInfo</code> class contains the information that we want to protect. The <code>users</code> variable contains the list of existing users. The <code>read()</code> method prints the list of users. The <code>add()</code> method adds a new user to the list.</p>
			<p>Let's consider the following code:</p>
			<pre>class SensitiveInfo:
     def __init__(self):
         self.users = ['nick', 'tom', 'ben', 'mike']
  
     def read(self):
         nb = len(self.users)
         print(f"There are {nb} users: {' ' \
           .join(self.users)}")
  
     def add(self, user):
         self.users.append(user)
         print(f'Added user {user}')</pre>
			<p>The <code>Info</code> class is a protection proxy of <code>SensitiveInfo</code>. The <code>secret</code> variable is the message that's required <a id="_idIndexMarker1378"/>to be known/provided by the client code to add a new user. Note that this is just an example. In reality, you should never do the following:</p>
			<ul>
				<li>Store passwords in the source code</li>
				<li>Store passwords in a cleartext form</li>
				<li>Use a weak (for example, MD5) or custom form of encryption</li>
			</ul>
			<p>In the <code>Info</code> class, as shown in the following code, the <code>read()</code> method is a wrapper to <code>SensitiveInfo.read()</code>, and the <code>add()</code> method ensures that a new user can only be added if the client code knows the secret message:</p>
			<pre>class Info:  
     '''protection proxy to SensitiveInfo'''
  
     def __init__(self):
         self.protected = SensitiveInfo()
         self.secret = '0xdeadbeef'
  
     def read(self):
         self.protected.read()
  
     def add(self, user):
         sec = input('what is the secret? ')
         self.protected.add(user) if sec == self.secret \
           else print("That's wrong!")</pre>
			<p>The <code>main()</code> function shows how the proxy pattern can be used by the client code. The client code <a id="_idIndexMarker1379"/>creates an instance of the <code>Info</code> class and uses the displayed menu to read the list, add a new user, or exit the application. Let's consider the following code:</p>
			<pre>def main():
     info = Info()
  
     while True:
         print('1. read list |==| 2. add user |==| 3. \
           quit')
         key = input('choose option: ')
         if key == '1':
             info.read()
         elif key == '2':
             name = input('choose username: ')
             info.add(name)
         elif key == '3':
             exit()
         else:
             print(f'unknown option: {key}')</pre>
			<p>The following is the sample output of the program when executing the Python <code>proxy.py</code> command:</p>
			<pre>1. read list |==| 2. add user |==| 3. quit
choose option: 1
There are 4 users: nick tom ben mike
1. read list |==| 2. add user |==| 3. quit
choose option: 2
choose username: bill
what is the secret? 12345
That's wrong!
1. read list |==| 2. add user |==| 3. quit
choose option: 2
choose username: bill
what is the secret? 0xdeadbeef
Added user bill
1. read list |==| 2. add user |==| 3. quit
choose option: 1
There are 5 users: nick tom ben mike bill
1. read list |==| 2. add user |==| 3. quit</pre>
			<p><em class="italic">Have you already spotted flaws or missing features that could improve our proxy example?</em> I have a <a id="_idIndexMarker1380"/>few suggestions. They are as follows:</p>
			<ul>
				<li>This example has a very big security flaw. Nothing prevents the client code from bypassing the security of the application by creating an instance of <code>SensitiveInfo</code> directly. Improve this example to prevent this situation. One way to do this is to use the <code>abc</code> module to forbid direct instantiation of <code>SensitiveInfo</code>. <em class="italic">What other code changes are required in this case?</em></li>
				<li>A basic security rule is that we should never store cleartext passwords. Storing a password safely is not very hard, so long as we know which libraries to use (<a href="http://j.mp/hashsec">http://j.mp/hashsec</a>). If you are interested in security, try to implement a secure way <a id="_idIndexMarker1381"/>to store the secret message externally (for example, in a file or database).</li>
				<li><em class="italic">The application only supports adding new users, but what about removing an existing user?</em> Add a <code>remove()</code> method.</li>
			</ul>
			<h1 id="_idParaDest-374"><a id="_idTextAnchor355"/>Summary</h1>
			<p>In this chapter, we covered three other structural design patterns: flyweight, MVC, and proxy. Throughout this chapter, we learned about the differences between these and the other structural patterns we have discussed. Then, we implemented each of these patterns in hands-on examples. As we saw, the flyweight pattern is designed for memory usage minimization, the MVC pattern maintains a logical organization of different parts of an application, and the proxy pattern is typically used when sensitive information is accessed.</p>
			<p>In the next chapter, we will start exploring behavioral design patterns. Behavioral patterns cope with object interconnection and algorithms. The first behavioral pattern we will cover is the chain of responsibility.</p>
			<h1 id="_idParaDest-375"><a id="_idTextAnchor356"/>Questions</h1>
			<ol>
				<li value="1">What is the main motivation for the flyweight pattern?</li>
				<li>What is the main motivation for the MVC pattern?</li>
				<li>What is the main motivation for the proxy pattern?</li>
			</ol>
		</div>
	</div>
</div>
</body></html>