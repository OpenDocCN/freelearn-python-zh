<html><head></head><body>
<div class="Basic-Text-Frame" id="_idContainer174">
<h1 class="chapterNumber"><span class="koboSpan" id="kobo.1.1">5</span></h1>
<h1 class="chapterTitle" id="_idParaDest-161"><span class="koboSpan" id="kobo.2.1">Implementing Social Authentication</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">In the previous chapter, you built user registration and authentication into your website. </span><span class="koboSpan" id="kobo.3.2">You implemented password change, reset, and recovery functionalities, and you learned how to create a custom profile model for your users.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4.1">In this chapter, you will add social authentication to your site using Google. </span><span class="koboSpan" id="kobo.4.2">You will use </span><strong class="keyWord"><span class="koboSpan" id="kobo.5.1">Python Social Auth for Django</span></strong><span class="koboSpan" id="kobo.6.1"> to</span><a id="_idIndexMarker447"/><span class="koboSpan" id="kobo.7.1"> implement social authentication using OAuth 2.0, the industry-standard protocol for authorization. </span><span class="koboSpan" id="kobo.7.2">You will also modify the social authentication pipeline to create a user profile for new users automatically.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.8.1">This chapter will cover the following points:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.9.1">Using the messages framework</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.10.1">Building a custom authentication backend</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.11.1">Preventing users from using an existing email</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.12.1">Adding social authentication with Python Social Auth</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.13.1">Running the development server through HTTPS using Django Extensions</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.14.1">Adding authentication using Google</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.15.1">Creating a profile for users that register with social authentication</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-162"><span class="koboSpan" id="kobo.16.1">Functional overview</span></h1>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.17.1">Figure 5.1</span></em><span class="koboSpan" id="kobo.18.1"> shows a representation of the views, templates, and functionalities that will be built in this chapter:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.19.1"><img alt="" role="presentation" src="../Images/B21088_05_01.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.20.1">Figure 5.1: Diagram of functionalities built in Chapter 5</span></p>
<p class="normal"><span class="koboSpan" id="kobo.21.1">In this chapter, you will generate success and error messages in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.22.1">edit</span></code><span class="koboSpan" id="kobo.23.1"> view using the Django messages framework. </span><span class="koboSpan" id="kobo.23.2">You will build a new authentication backend named </span><code class="inlineCode"><span class="koboSpan" id="kobo.24.1">EmailAuthBackend</span></code><span class="koboSpan" id="kobo.25.1"> for users to authenticate using their email addresses. </span><span class="koboSpan" id="kobo.25.2">You will serve your site over HTTPS during development using Django Extensions, and you will implement social authentication with Google on your site using Python Social Auth. </span><span class="koboSpan" id="kobo.25.3">Users will be redirected to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.26.1">dashboard</span></code><span class="koboSpan" id="kobo.27.1"> view after successful authentication. </span><span class="koboSpan" id="kobo.27.2">You will customize the authentication pipeline to create user profiles automatically when a new user is created with social authentication.</span></p>
<h1 class="heading-1" id="_idParaDest-163"><span class="koboSpan" id="kobo.28.1">Technical requirements</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.29.1">The source code for this chapter can be found at </span><a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter05"><span class="url"><span class="koboSpan" id="kobo.30.1">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter05</span></span></a><span class="koboSpan" id="kobo.31.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.32.1">All Python packages used in this chapter are included in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.33.1">requirements.txt</span></code><span class="koboSpan" id="kobo.34.1"> file in the source code for the chapter. </span><span class="koboSpan" id="kobo.34.2">You can follow the instructions to install each Python package in the following sections, or you can install all requirements at once with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.35.1">python</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.36.1">-m</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.37.1">pip</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.38.1">install</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.39.1">-r</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.40.1">requirements.txt</span></code><span class="koboSpan" id="kobo.41.1"> command.</span></p>
<h1 class="heading-1" id="_idParaDest-164"><span class="koboSpan" id="kobo.42.1">Using the messages framework</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.43.1">When users are </span><a id="_idIndexMarker448"/><span class="koboSpan" id="kobo.44.1">interacting with the platform, there are many cases where you might want to inform them about the result of specific actions, such as successfully creating an object in the database or successfully submitting a form. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.45.1">Django has a built-in messages framework that allows you to display one-time notifications to your users. </span><span class="koboSpan" id="kobo.45.2">This enhances user experience by providing immediate feedback on their actions, making the interface more intuitive and user friendly.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.46.1">The messages framework is located at </span><code class="inlineCode"><span class="koboSpan" id="kobo.47.1">django.contrib.messages</span></code><span class="koboSpan" id="kobo.48.1"> and is included in the default </span><code class="inlineCode"><span class="koboSpan" id="kobo.49.1">INSTALLED_APPS</span></code><span class="koboSpan" id="kobo.50.1"> list of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.51.1">settings.py</span></code><span class="koboSpan" id="kobo.52.1"> file when you create new projects using </span><code class="inlineCode"><span class="koboSpan" id="kobo.53.1">python manage.py startproject</span></code><span class="koboSpan" id="kobo.54.1">. </span><span class="koboSpan" id="kobo.54.2">The settings file also contains the </span><code class="inlineCode"><span class="koboSpan" id="kobo.55.1">django.contrib.messages.middleware.MessageMiddleware</span></code><span class="koboSpan" id="kobo.56.1"> middleware in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.57.1">MIDDLEWARE</span></code><span class="koboSpan" id="kobo.58.1"> setting.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.59.1">The messages framework provides a simple way to add messages to users. </span><span class="koboSpan" id="kobo.59.2">Messages are stored in a cookie by default (falling back to session storage), and they are displayed and cleared in the next request from the user. </span><span class="koboSpan" id="kobo.59.3">You can use the messages framework in your views by importing the </span><code class="inlineCode"><span class="koboSpan" id="kobo.60.1">messages</span></code><span class="koboSpan" id="kobo.61.1"> module and adding new messages with simple shortcuts, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.62.1">from</span></span><span class="koboSpan" id="kobo.63.1"> django.contrib </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.64.1">import</span></span><span class="koboSpan" id="kobo.65.1"> messages
messages.error(request, </span><span class="hljs-string"><span class="koboSpan" id="kobo.66.1">'Something went wrong'</span></span><span class="koboSpan" id="kobo.67.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.68.1">You can create new messages using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.69.1">add_message()</span></code><span class="koboSpan" id="kobo.70.1"> method or any of the following shortcut methods:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.71.1">success()</span></code><span class="koboSpan" id="kobo.72.1">: Success messages are used to display when an action was successful</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.73.1">info()</span></code><span class="koboSpan" id="kobo.74.1">: Informational messages</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.75.1">warning()</span></code><span class="koboSpan" id="kobo.76.1">: This shows that a failure has not yet occurred but it may be imminent</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.77.1">error()</span></code><span class="koboSpan" id="kobo.78.1">: This shows that an action was not successful or a failure occurred</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.79.1">debug()</span></code><span class="koboSpan" id="kobo.80.1">: This shows debug messages that will be removed or ignored in a production environment</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.81.1">Let’s add messages to the project. </span><span class="koboSpan" id="kobo.81.2">The messages framework applies globally to the project. </span><span class="koboSpan" id="kobo.81.3">We will use the base template to display any available messages to the client. </span><span class="koboSpan" id="kobo.81.4">This will allow us to notify the client of the results of any action on any page.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.82.1">Open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.83.1">templates/base.html</span></code><span class="koboSpan" id="kobo.84.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.85.1">account</span></code><span class="koboSpan" id="kobo.86.1"> application and add the following code </span><a id="_idIndexMarker449"/><span class="koboSpan" id="kobo.87.1">highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.88.1">{% load static %}
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.89.1">&lt;!DOCTYPE </span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.90.1">html</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.91.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.92.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.93.1">html</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.94.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.95.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.96.1">head</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.97.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.98.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.99.1">title</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.100.1">&gt;</span></span><span class="koboSpan" id="kobo.101.1">{% block title %}{% endblock %}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.102.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.103.1">title</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.104.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.105.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.106.1">link</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.107.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.108.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.109.1">"{% static "</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.110.1">css</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.111.1">/</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.112.1">base.css</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.113.1">" %}" </span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.114.1">rel</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.115.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.116.1">"stylesheet"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.117.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.118.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.119.1">head</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.120.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.121.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.122.1">body</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.123.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.124.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.125.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.126.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.127.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.128.1">"header"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.129.1">&gt;</span></span><span class="koboSpan" id="kobo.130.1">
    ...
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.131.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.132.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.133.1">&gt;</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.134.1">  {% if messages %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.135.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.136.1">ul</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.137.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.138.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.139.1">"messages"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.140.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.141.1">      {% for message in messages %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.142.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.143.1">li</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.144.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.145.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.146.1">"{{ message.tags }}"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.147.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.148.1">          {{ message|safe }}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.149.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.150.1">a</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.151.1">href</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.152.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.153.1">"#"</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.154.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.155.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.156.1">"close"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.157.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.158.1">x</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.159.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.160.1">a</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.161.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.162.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.163.1">li</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.164.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.165.1">      {% endfor %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.166.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.167.1">ul</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.168.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.169.1">  {% endif %}</span></strong></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.170.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.171.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.172.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.173.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.174.1">"content"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.175.1">&gt;</span></span><span class="koboSpan" id="kobo.176.1">
    {% block content %}
    {% endblock %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.177.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.178.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.179.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.180.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.181.1">body</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.182.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.183.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.184.1">html</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.185.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.186.1">The messages framework includes the </span><code class="inlineCode"><span class="koboSpan" id="kobo.187.1">django.contrib.messages.context_processors.messages</span></code><span class="koboSpan" id="kobo.188.1"> context processor, which adds a </span><code class="inlineCode"><span class="koboSpan" id="kobo.189.1">messages</span></code><span class="koboSpan" id="kobo.190.1"> variable to the request context. </span><span class="koboSpan" id="kobo.190.2">You can find it in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.191.1">context_processors</span></code><span class="koboSpan" id="kobo.192.1"> list in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.193.1">TEMPLATES</span></code><span class="koboSpan" id="kobo.194.1"> setting of your project. </span><span class="koboSpan" id="kobo.194.2">You can use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.195.1">messages</span></code><span class="koboSpan" id="kobo.196.1"> variable in templates to display all existing messages to the user.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.197.1">A context processor is a Python function that takes the request object as an argument and returns a dictionary that gets added to the request context. </span><span class="koboSpan" id="kobo.197.2">You will learn how to create your own context processors in </span><em class="chapterRef"><span class="koboSpan" id="kobo.198.1">Chapter 8</span></em><span class="koboSpan" id="kobo.199.1">, </span><em class="italic"><span class="koboSpan" id="kobo.200.1">Building an Online Shop</span></em><span class="koboSpan" id="kobo.201.1">.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.202.1">Let’s modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.203.1">edit</span></code><span class="koboSpan" id="kobo.204.1"> view to use the messages framework.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.205.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.206.1">views.py</span></code><span class="koboSpan" id="kobo.207.1"> file </span><a id="_idIndexMarker450"/><span class="koboSpan" id="kobo.208.1">of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.209.1">account</span></code><span class="koboSpan" id="kobo.210.1"> application and add the following lines highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.211.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.212.1"> django.contrib </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.213.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.214.1"> messages</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.215.1"># ...</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.216.1">@login_required</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.217.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.218.1">edit</span></span><span class="koboSpan" id="kobo.219.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.220.1">request</span></span><span class="koboSpan" id="kobo.221.1">):
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.222.1">if</span></span><span class="koboSpan" id="kobo.223.1"> request.method == </span><span class="hljs-string"><span class="koboSpan" id="kobo.224.1">'POST'</span></span><span class="koboSpan" id="kobo.225.1">:
        user_form = UserEditForm(
            instance=request.user,
            data=request.POST
        )
        profile_form = ProfileEditForm(
            instance=request.user.profile,
            data=request.POST,
            files=request.FILES
        )
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.226.1">if</span></span><span class="koboSpan" id="kobo.227.1"> user_form.is_valid() </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.228.1">and</span></span><span class="koboSpan" id="kobo.229.1"> profile_form.is_valid():
            user_form.save()
            profile_form.save()
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.230.1">            messages.success(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.231.1">                request,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.232.1">'Profile updated successfully'</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.233.1">            )</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.234.1">else</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.235.1">:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.236.1">            messages.error(request, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.237.1">'Error updating your profile'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.238.1">)</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.239.1">else</span></span><span class="koboSpan" id="kobo.240.1">:
        user_form = UserEditForm(instance=request.user)
        profile_form = ProfileEditForm(
                                    instance=request.user.profile)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.241.1">return</span></span><span class="koboSpan" id="kobo.242.1"> render(
        request,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.243.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.244.1">account/edit.html'</span></span><span class="koboSpan" id="kobo.245.1">,
        {</span><span class="hljs-string"><span class="koboSpan" id="kobo.246.1">'user_form'</span></span><span class="koboSpan" id="kobo.247.1">: user_form, </span><span class="hljs-string"><span class="koboSpan" id="kobo.248.1">'profile_form'</span></span><span class="koboSpan" id="kobo.249.1">: profile_form}
    )
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.250.1">A success message is generated when users successfully update their profile. </span><span class="koboSpan" id="kobo.250.2">If any of the forms contain invalid data, an error message is generated instead.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.251.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.252.1">http://127.0.0.1:8000/account/edit/</span></code><span class="koboSpan" id="kobo.253.1"> in your browser and edit the profile of the user. </span><span class="koboSpan" id="kobo.253.2">You should see the following message when the profile is successfully updated:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.254.1"><img alt="A green screen with white text  Description automatically generated with low confidence" src="../Images/B21088_05_02.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.255.1">Figure 5.2: The successfully edited profile message</span></p>
<p class="normal"><span class="koboSpan" id="kobo.256.1">Enter an invalid </span><a id="_idIndexMarker451"/><span class="koboSpan" id="kobo.257.1">date in the </span><strong class="screenText"><span class="koboSpan" id="kobo.258.1">Date of birth</span></strong><span class="koboSpan" id="kobo.259.1"> field and submit the form again. </span><span class="koboSpan" id="kobo.259.2">You should see the following message:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.260.1"><img alt="A picture containing graphical user interface  Description automatically generated" src="../Images/B21088_05_03.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.261.1">Figure 5.3: The error updating profile message</span></p>
<p class="normal"><span class="koboSpan" id="kobo.262.1">Generating messages to inform your users about the results of their actions is straightforward. </span><span class="koboSpan" id="kobo.262.2">You can easily add messages to other views as well.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.263.1">You can learn more about the messages framework at </span><a href="https://docs.djangoproject.com/en/5.0/ref/contrib/messages/"><span class="url"><span class="koboSpan" id="kobo.264.1">https://docs.djangoproject.com/en/5.0/ref/contrib/messages/</span></span></a><span class="koboSpan" id="kobo.265.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.266.1">Now that we’ve built all the functionality related to user authentication and profile editing, we will dig deeper into customizing authentication. </span><span class="koboSpan" id="kobo.266.2">We will learn how to build custom backend </span><a id="_idIndexMarker452"/><span class="koboSpan" id="kobo.267.1">authentication so that users can log in to the site using their email addresses.</span></p>
<h1 class="heading-1" id="_idParaDest-165"><span class="koboSpan" id="kobo.268.1">Building a custom authentication backend</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.269.1">Django allows</span><a id="_idIndexMarker453"/><span class="koboSpan" id="kobo.270.1"> you to authenticate users against different sources, such as the built-in Django authentication system, external authentication systems like </span><strong class="keyWord"><span class="koboSpan" id="kobo.271.1">Lightweight Directory Access Protocol</span></strong><span class="koboSpan" id="kobo.272.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.273.1">LDAP</span></strong><span class="koboSpan" id="kobo.274.1">) servers, or even</span><a id="_idIndexMarker454"/><span class="koboSpan" id="kobo.275.1"> third-party providers. </span><span class="koboSpan" id="kobo.275.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.276.1">AUTHENTICATION_BACKENDS</span></code><span class="koboSpan" id="kobo.277.1"> setting includes a list of authentication backends available in the project. </span><span class="koboSpan" id="kobo.277.2">Django enables you to specify multiple authentication backends for flexible authentication schemes. </span><span class="koboSpan" id="kobo.277.3">The default value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.278.1">AUTHENTICATION_BACKENDS</span></code><span class="koboSpan" id="kobo.279.1"> setting is the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.280.1">['django.contrib.auth.backends.ModelBackend']
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.281.1">The default </span><code class="inlineCode"><span class="koboSpan" id="kobo.282.1">ModelBackend</span></code><span class="koboSpan" id="kobo.283.1"> authenticates users against the database using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.284.1">User</span></code><span class="koboSpan" id="kobo.285.1"> model of </span><code class="inlineCode"><span class="koboSpan" id="kobo.286.1">django.contrib.auth</span></code><span class="koboSpan" id="kobo.287.1">. </span><span class="koboSpan" id="kobo.287.2">This is suitable for most web projects. </span><span class="koboSpan" id="kobo.287.3">However, you can create custom backends to authenticate your users against other sources.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.288.1">You can read more information about customizing authentication at </span><a href="https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#other-authentication-sources"><span class="url"><span class="koboSpan" id="kobo.289.1">https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#other-authentication-sources</span></span></a><span class="koboSpan" id="kobo.290.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.291.1">Whenever the </span><code class="inlineCode"><span class="koboSpan" id="kobo.292.1">authenticate()</span></code><span class="koboSpan" id="kobo.293.1"> function of </span><code class="inlineCode"><span class="koboSpan" id="kobo.294.1">django.contrib.auth</span></code><span class="koboSpan" id="kobo.295.1"> is used, Django tries to authenticate the user against each of the backends defined in </span><code class="inlineCode"><span class="koboSpan" id="kobo.296.1">AUTHENTICATION_BACKENDS</span></code><span class="koboSpan" id="kobo.297.1"> one by one, until one of them successfully authenticates the user. </span><span class="koboSpan" id="kobo.297.2">Only if all of the backends fail to authenticate will the user not be authenticated.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.298.1">Django provides a simple way to define your own authentication backends. </span><span class="koboSpan" id="kobo.298.2">An authentication backend is a class that provides the following two methods:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.299.1">authenticate()</span></code><span class="koboSpan" id="kobo.300.1">: It takes the </span><code class="inlineCode"><span class="koboSpan" id="kobo.301.1">request</span></code><span class="koboSpan" id="kobo.302.1"> object and user credentials as parameters. </span><span class="koboSpan" id="kobo.302.2">It has to return a </span><code class="inlineCode"><span class="koboSpan" id="kobo.303.1">user</span></code><span class="koboSpan" id="kobo.304.1"> object that matches those credentials if the credentials are valid, or </span><code class="inlineCode"><span class="koboSpan" id="kobo.305.1">None</span></code><span class="koboSpan" id="kobo.306.1"> otherwise. </span><span class="koboSpan" id="kobo.306.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.307.1">request</span></code><span class="koboSpan" id="kobo.308.1"> parameter is an </span><code class="inlineCode"><span class="koboSpan" id="kobo.309.1">HttpRequest</span></code><span class="koboSpan" id="kobo.310.1"> object, or </span><code class="inlineCode"><span class="koboSpan" id="kobo.311.1">None</span></code><span class="koboSpan" id="kobo.312.1"> if it’s not provided to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.313.1">authenticate()</span></code><span class="koboSpan" id="kobo.314.1"> function.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.315.1">get_user()</span></code><span class="koboSpan" id="kobo.316.1">: It takes a user ID parameter and has to return a </span><code class="inlineCode"><span class="koboSpan" id="kobo.317.1">user</span></code><span class="koboSpan" id="kobo.318.1"> object.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.319.1">Creating a custom authentication backend is as simple as writing a Python class that implements both methods. </span><span class="koboSpan" id="kobo.319.2">Let’s create an authentication backend to allow users to authenticate on the site using their email address instead of their username.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.320.1">Create a new file inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.321.1">account</span></code><span class="koboSpan" id="kobo.322.1"> application directory and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.323.1">authentication.py</span></code><span class="koboSpan" id="kobo.324.1">. </span><span class="koboSpan" id="kobo.324.2">Add</span><a id="_idIndexMarker455"/><span class="koboSpan" id="kobo.325.1"> the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.326.1">from</span></span><span class="koboSpan" id="kobo.327.1"> django.contrib.auth.models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.328.1">import</span></span><span class="koboSpan" id="kobo.329.1"> User
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.330.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.331.1">EmailAuthBackend</span></span><span class="koboSpan" id="kobo.332.1">:
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.333.1">"""</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.334.1">    Authenticate using an e-mail address.</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.335.1">    """</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.336.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.337.1">authenticate</span></span><span class="koboSpan" id="kobo.338.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.339.1">self, request, username=</span></span><span class="hljs-literal"><span class="koboSpan" id="kobo.340.1">None</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.341.1">, password=</span></span><span class="hljs-literal"><span class="koboSpan" id="kobo.342.1">None</span></span><span class="koboSpan" id="kobo.343.1">):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.344.1">try</span></span><span class="koboSpan" id="kobo.345.1">:
            user = User.objects.get(email=username)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.346.1">if</span></span><span class="koboSpan" id="kobo.347.1"> user.check_password(password):
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.348.1">return</span></span><span class="koboSpan" id="kobo.349.1"> user
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.350.1">return</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.351.1">None</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.352.1">except</span></span><span class="koboSpan" id="kobo.353.1"> (User.DoesNotExist, User.MultipleObjectsReturned):
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.354.1">return</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.355.1">None</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.356.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.357.1">get_user</span></span><span class="koboSpan" id="kobo.358.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.359.1">self, user_id</span></span><span class="koboSpan" id="kobo.360.1">):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.361.1">try</span></span><span class="koboSpan" id="kobo.362.1">:
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.363.1">return</span></span><span class="koboSpan" id="kobo.364.1"> User.objects.get(pk=user_id)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.365.1">except</span></span><span class="koboSpan" id="kobo.366.1"> User.DoesNotExist:
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.367.1">return</span></span> <span class="hljs-literal"><span class="koboSpan" id="kobo.368.1">None</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.369.1">The preceding code is a simple authentication backend. </span><span class="koboSpan" id="kobo.369.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.370.1">authenticate()</span></code><span class="koboSpan" id="kobo.371.1"> method receives a </span><code class="inlineCode"><span class="koboSpan" id="kobo.372.1">request</span></code><span class="koboSpan" id="kobo.373.1"> object and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.374.1">username</span></code><span class="koboSpan" id="kobo.375.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.376.1">password</span></code><span class="koboSpan" id="kobo.377.1"> optional parameters. </span><span class="koboSpan" id="kobo.377.2">We could use different parameters, but we use </span><code class="inlineCode"><span class="koboSpan" id="kobo.378.1">username</span></code><span class="koboSpan" id="kobo.379.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.380.1">password</span></code><span class="koboSpan" id="kobo.381.1"> to make our backend work with the authentication framework views right away. </span><span class="koboSpan" id="kobo.381.2">The preceding code works as follows:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.382.1">authenticate()</span></code><span class="koboSpan" id="kobo.383.1">: The user with the given email address is retrieved, and the password is checked using the built-in </span><code class="inlineCode"><span class="koboSpan" id="kobo.384.1">check_password()</span></code><span class="koboSpan" id="kobo.385.1"> method of the user model. </span><span class="koboSpan" id="kobo.385.2">This method handles the password hashing to compare the given password with the password stored in the database. </span><span class="koboSpan" id="kobo.385.3">Two different QuerySet exceptions are captured: </span><code class="inlineCode"><span class="koboSpan" id="kobo.386.1">DoesNotExist</span></code><span class="koboSpan" id="kobo.387.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.388.1">MultipleObjectsReturned</span></code><span class="koboSpan" id="kobo.389.1">. </span><span class="koboSpan" id="kobo.389.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.390.1">DoesNotExist</span></code><span class="koboSpan" id="kobo.391.1"> exception is raised if no user is found with the given email address. </span><span class="koboSpan" id="kobo.391.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.392.1">MultipleObjectsReturned</span></code><span class="koboSpan" id="kobo.393.1"> exception is raised if multiple users are found with the same email address. </span><span class="koboSpan" id="kobo.393.2">We will modify the registration and edit views later to prevent users from using an existing email address.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.394.1">get_user()</span></code><span class="koboSpan" id="kobo.395.1">: You get a user through the ID provided in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.396.1">user_id</span></code><span class="koboSpan" id="kobo.397.1"> parameter. </span><span class="koboSpan" id="kobo.397.2">Django uses the backend that authenticated the user to retrieve the </span><code class="inlineCode"><span class="koboSpan" id="kobo.398.1">User</span></code><span class="koboSpan" id="kobo.399.1"> object for the duration of the user session. </span><strong class="keyWord"><span class="koboSpan" id="kobo.400.1">pk</span></strong><span class="koboSpan" id="kobo.401.1"> is a short for </span><strong class="keyWord"><span class="koboSpan" id="kobo.402.1">primary key</span></strong><span class="koboSpan" id="kobo.403.1">, which is </span><a id="_idIndexMarker456"/><span class="koboSpan" id="kobo.404.1">a unique identifier for each record in the database. </span><span class="koboSpan" id="kobo.404.2">Every Django model has a field that serves as its primary key. </span><span class="koboSpan" id="kobo.404.3">By default, the primary key is the automatically generated ID field. </span><span class="koboSpan" id="kobo.404.4">You can find more information about automatic</span><a id="_idIndexMarker457"/><span class="koboSpan" id="kobo.405.1"> primary key fields at </span><a href="https://docs.djangoproject.com/en/5.0/topics/db/models/#automatic-primary-key-fields"><span class="url"><span class="koboSpan" id="kobo.406.1">https://docs.djangoproject.com/en/5.0/topics/db/models/#automatic-primary-key-fields</span></span></a><span class="koboSpan" id="kobo.407.1">.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.408.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.409.1">settings.py</span></code><span class="koboSpan" id="kobo.410.1"> file of your project and add the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.411.1">AUTHENTICATION_BACKENDS = [
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.412.1">'django.contrib.auth.backends.ModelBackend'</span></span><span class="koboSpan" id="kobo.413.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.414.1">'account.authentication.EmailAuthBackend'</span></span><span class="koboSpan" id="kobo.415.1">,
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.416.1">In the preceding setting, we keep the default </span><code class="inlineCode"><span class="koboSpan" id="kobo.417.1">ModelBackend</span></code><span class="koboSpan" id="kobo.418.1"> that is used to authenticate with the username and password and include our own email-based authentication backend </span><code class="inlineCode"><span class="koboSpan" id="kobo.419.1">EmailAuthBackend</span></code><span class="koboSpan" id="kobo.420.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.421.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.422.1">http://127.0.0.1:8000/account/login/</span></code><span class="koboSpan" id="kobo.423.1"> in your browser. </span><span class="koboSpan" id="kobo.423.2">Remember that Django will try to authenticate the user against each of the backends, so now you should be able to log in seamlessly using your username or email account.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.424.1">The user credentials will be checked using </span><code class="inlineCode"><span class="koboSpan" id="kobo.425.1">ModelBackend</span></code><span class="koboSpan" id="kobo.426.1">, and if no user is returned, the credentials will be checked using </span><code class="inlineCode"><span class="koboSpan" id="kobo.427.1">EmailAuthBackend</span></code><span class="koboSpan" id="kobo.428.1">.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.429.1">The order of the backends listed in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.430.1">AUTHENTICATION_BACKENDS</span></code><span class="koboSpan" id="kobo.431.1"> setting matters. </span><span class="koboSpan" id="kobo.431.2">If the same credentials are valid for multiple backends, Django will authenticate</span><a id="_idIndexMarker458"/><span class="koboSpan" id="kobo.432.1"> the user using the first backend in the list that successfully validates these credentials. </span><span class="koboSpan" id="kobo.432.2">This means Django does not proceed to check the remaining backends once a match is found.</span></p>
</div>
<h2 class="heading-2" id="_idParaDest-166"><span class="koboSpan" id="kobo.433.1">Preventing users from using an existing email address</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.434.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.435.1">User</span></code><span class="koboSpan" id="kobo.436.1"> model</span><a id="_idIndexMarker459"/><span class="koboSpan" id="kobo.437.1"> of </span><a id="_idIndexMarker460"/><span class="koboSpan" id="kobo.438.1">the authentication framework does not prevent creating users with the same email address. </span><span class="koboSpan" id="kobo.438.2">If two or more user accounts share the same email address, we won’t be able to discern which user is authenticating. </span><span class="koboSpan" id="kobo.438.3">Now that users can log in using their email address, we have to prevent users from registering with an existing email address.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.439.1">We will now change the user registration form to prevent multiple users from registering with the same email address.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.440.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.441.1">forms.py</span></code><span class="koboSpan" id="kobo.442.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.443.1">account</span></code><span class="koboSpan" id="kobo.444.1"> application and add the following lines highlighted in bold to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.445.1">UserRegistrationForm</span></code><span class="koboSpan" id="kobo.446.1"> class:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.447.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.448.1">UserRegistrationForm</span></span><span class="koboSpan" id="kobo.449.1">(forms.ModelForm):
    password = forms.CharField(
        label=</span><span class="hljs-string"><span class="koboSpan" id="kobo.450.1">'Password'</span></span><span class="koboSpan" id="kobo.451.1">,
        widget=forms.PasswordInput
    )
    password2 = forms.CharField(
        label=</span><span class="hljs-string"><span class="koboSpan" id="kobo.452.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.453.1">Repeat password'</span></span><span class="koboSpan" id="kobo.454.1">,
        widget=forms.PasswordInput
    )
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.455.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.456.1">Meta</span></span><span class="koboSpan" id="kobo.457.1">:
        model = User
        fields = [</span><span class="hljs-string"><span class="koboSpan" id="kobo.458.1">'username'</span></span><span class="koboSpan" id="kobo.459.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.460.1">'first_name'</span></span><span class="koboSpan" id="kobo.461.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.462.1">'email'</span></span><span class="koboSpan" id="kobo.463.1">]
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.464.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.465.1">clean_password2</span></span><span class="koboSpan" id="kobo.466.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.467.1">self</span></span><span class="koboSpan" id="kobo.468.1">):
        cd = self.cleaned_data
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.469.1">if</span></span><span class="koboSpan" id="kobo.470.1"> cd[</span><span class="hljs-string"><span class="koboSpan" id="kobo.471.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.472.1">password'</span></span><span class="koboSpan" id="kobo.473.1">] != cd[</span><span class="hljs-string"><span class="koboSpan" id="kobo.474.1">'password2'</span></span><span class="koboSpan" id="kobo.475.1">]:
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.476.1">raise</span></span><span class="koboSpan" id="kobo.477.1"> forms.ValidationError(</span><span class="hljs-string"><span class="koboSpan" id="kobo.478.1">'Passwords don\'t match.'</span></span><span class="koboSpan" id="kobo.479.1">)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.480.1">return</span></span><span class="koboSpan" id="kobo.481.1"> cd[</span><span class="hljs-string"><span class="koboSpan" id="kobo.482.1">'password2'</span></span><span class="koboSpan" id="kobo.483.1">]
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.484.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.485.1">clean_email</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.486.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.487.1">self</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.488.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.489.1">        data = self.cleaned_data[</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.490.1">'email'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.491.1">]</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.492.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.493.1"> User.objects.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.494.1">filter</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.495.1">(email=data).exists():</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.496.1">raise</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.497.1"> forms.ValidationError(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.498.1">'Email already in use.'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.499.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.500.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.501.1"> data</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.502.1">We have added validation for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.503.1">email</span></code><span class="koboSpan" id="kobo.504.1"> field that prevents users from registering with an existing email address. </span><span class="koboSpan" id="kobo.504.2">We build a QuerySet to look up existing users with the same email address. </span><span class="koboSpan" id="kobo.504.3">We check whether there are any results with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.505.1">exists()</span></code><span class="koboSpan" id="kobo.506.1"> method. </span><span class="koboSpan" id="kobo.506.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.507.1">exists()</span></code><span class="koboSpan" id="kobo.508.1"> method returns </span><code class="inlineCode"><span class="koboSpan" id="kobo.509.1">True</span></code><span class="koboSpan" id="kobo.510.1"> if the QuerySet contains any results, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.511.1">False</span></code><span class="koboSpan" id="kobo.512.1"> otherwise.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.513.1">Now, add the following lines highlighted in bold to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.514.1">UserEditForm</span></code><span class="koboSpan" id="kobo.515.1"> class:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.516.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.517.1">UserEditForm</span></span><span class="koboSpan" id="kobo.518.1">(forms.ModelForm):
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.519.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.520.1">Meta</span></span><span class="koboSpan" id="kobo.521.1">:
        model = User
        fields = [</span><span class="hljs-string"><span class="koboSpan" id="kobo.522.1">'first_name'</span></span><span class="koboSpan" id="kobo.523.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.524.1">'last_name'</span></span><span class="koboSpan" id="kobo.525.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.526.1">'email'</span></span><span class="koboSpan" id="kobo.527.1">]
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.528.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.529.1">clean_email</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.530.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.531.1">self</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.532.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.533.1">        data = self.cleaned_data[</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.534.1">'email'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.535.1">]</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.536.1">        qs = User.objects.exclude(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.537.1">id</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.538.1">=self.instance.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.539.1">id</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.540.1">        ).</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.541.1">filter</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.542.1">(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.543.1">            email=data</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.544.1">        )</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.545.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.546.1"> qs.exists():</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.547.1">raise</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.548.1"> forms.ValidationError(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.549.1">'Email already in use.'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.550.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.551.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.552.1"> data</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.553.1">In this case, we have added validation for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.554.1">email</span></code><span class="koboSpan" id="kobo.555.1"> field that prevents users from changing their </span><a id="_idIndexMarker461"/><span class="koboSpan" id="kobo.556.1">existing</span><a id="_idIndexMarker462"/><span class="koboSpan" id="kobo.557.1"> email address to an existing email address of another user. </span><span class="koboSpan" id="kobo.557.2">We exclude the current user from the QuerySet. </span><span class="koboSpan" id="kobo.557.3">Otherwise, the current email address of the user would be considered an existing email address, and the form won’t validate.</span></p>
<h1 class="heading-1" id="_idParaDest-167"><span class="koboSpan" id="kobo.558.1">Adding social authentication to your site</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.559.1">Social authentication</span><a id="_idIndexMarker463"/><span class="koboSpan" id="kobo.560.1"> is a widely used feature that allows users to authenticate using their existing account of a service provider</span><a id="_idIndexMarker464"/><span class="koboSpan" id="kobo.561.1"> using </span><strong class="keyWord"><span class="koboSpan" id="kobo.562.1">single sign-on</span></strong><span class="koboSpan" id="kobo.563.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.564.1">SSO</span></strong><span class="koboSpan" id="kobo.565.1">). </span><span class="koboSpan" id="kobo.565.2">The authentication process allows users to authenticate into the site using their existing account from social services like Google, Facebook, or Twitter. </span><span class="koboSpan" id="kobo.565.3">In this section, we will add social authentication to the site using Google.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.566.1">To implement social authentication, we will use the </span><strong class="keyWord"><span class="koboSpan" id="kobo.567.1">OAuth 2.0</span></strong><span class="koboSpan" id="kobo.568.1"> industry-standard protocol for authorization. </span><strong class="keyWord"><span class="koboSpan" id="kobo.569.1">OAuth</span></strong><span class="koboSpan" id="kobo.570.1"> stands </span><a id="_idIndexMarker465"/><span class="koboSpan" id="kobo.571.1">for </span><strong class="keyWord"><span class="koboSpan" id="kobo.572.1">Open Authorization</span></strong><span class="koboSpan" id="kobo.573.1">. </span><span class="koboSpan" id="kobo.573.2">OAuth 2.0 is a standard designed to allow a website or application to access resources hosted by other web apps on behalf of a user. </span><span class="koboSpan" id="kobo.573.3">Google uses the OAuth 2.0 protocol for authentication and authorization.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.574.1">Python Social Auth is a Python module that simplifies the process of adding social authentication to your website. </span><span class="koboSpan" id="kobo.574.2">Using this module, you can let your users log in to your website using their accounts from other services. </span><span class="koboSpan" id="kobo.574.3">You can find the code for this module at </span><a href="https://github.com/python-social-auth/social-app-django"><span class="url"><span class="koboSpan" id="kobo.575.1">https://github.com/python-social-auth/social-app-django</span></span></a><span class="koboSpan" id="kobo.576.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.577.1">This module comes with authentication backends for different Python frameworks, including Django.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.578.1">Run the</span><a id="_idIndexMarker466"/><span class="koboSpan" id="kobo.579.1"> following command in the shell:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.580.1">python -m pip install social-auth-app-django==5.4.0
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.581.1">This will install Python Social Auth.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.582.1">Then, add </span><code class="inlineCode"><span class="koboSpan" id="kobo.583.1">social_django</span></code><span class="koboSpan" id="kobo.584.1"> to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.585.1">INSTALLED_APPS</span></code><span class="koboSpan" id="kobo.586.1"> setting in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.587.1">settings.py</span></code><span class="koboSpan" id="kobo.588.1"> file of the project as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.589.1">INSTALLED_APPS = [
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.590.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.591.1">'social_django'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.592.1">,</span></strong></span><span class="koboSpan" id="kobo.593.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.594.1">This is the default application to add Python Social Auth to Django projects. </span><span class="koboSpan" id="kobo.594.2">Now, run the following command to sync Python Social Auth models with your database:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.595.1">python -m python manage.py migrate
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.596.1">You should see that the migrations for the default application are applied as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.597.1">Applying social_django.0001_initial... </span><span class="koboSpan" id="kobo.597.2">OK
...
</span><span class="koboSpan" id="kobo.597.3">Applying social_django .0015_rename_extra_data_new_usersocialauth_extra_data... </span><span class="koboSpan" id="kobo.597.4">OK
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.598.1">Python Social Auth includes authentication backends for multiple services. </span><span class="koboSpan" id="kobo.598.2">You can find the list with all available backends at </span><a href="https://python-social-auth.readthedocs.io/en/latest/backends/index.html#supported-backends"><span class="url"><span class="koboSpan" id="kobo.599.1">https://python-social-auth.readthedocs.io/en/latest/backends/index.html#supported-backends</span></span></a><span class="koboSpan" id="kobo.600.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.601.1">We will add social authentication to our project, allowing our users to authenticate with the Google backend.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.602.1">First, we need to add the social login URL patterns to the project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.603.1">Open the main </span><code class="inlineCode"><span class="koboSpan" id="kobo.604.1">urls.py</span></code><span class="koboSpan" id="kobo.605.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.606.1">bookmarks</span></code><span class="koboSpan" id="kobo.607.1"> project and include the </span><code class="inlineCode"><span class="koboSpan" id="kobo.608.1">social_django</span></code><span class="koboSpan" id="kobo.609.1"> URL patterns as follows. </span><span class="koboSpan" id="kobo.609.2">The new lines are highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.610.1">urlpatterns = [
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.611.1">'admin/'</span></span><span class="koboSpan" id="kobo.612.1">, admin.site.urls),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.613.1">'account/'</span></span><span class="koboSpan" id="kobo.614.1">, include(</span><span class="hljs-string"><span class="koboSpan" id="kobo.615.1">'account.urls'</span></span><span class="koboSpan" id="kobo.616.1">)),
    </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.617.1">path(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.618.1">'social-auth/'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.619.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.620.1">        include(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.621.1">'social_django.urls'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.622.1">, namespace=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.623.1">'social'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.624.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.625.1">    ),</span></strong></span><span class="koboSpan" id="kobo.626.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.627.1">Our web application is currently accessible via the localhost IP, </span><code class="inlineCode"><span class="koboSpan" id="kobo.628.1">127.0.0.1</span></code><span class="koboSpan" id="kobo.629.1">, or using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.630.1">localhost</span></code><span class="koboSpan" id="kobo.631.1"> hostname. </span><span class="koboSpan" id="kobo.631.2">Google allows the redirection of users to </span><code class="inlineCode"><span class="koboSpan" id="kobo.632.1">localhost</span></code><span class="koboSpan" id="kobo.633.1"> after successful authentication, but other social services expect a domain name for the URL redirect. </span><span class="koboSpan" id="kobo.633.2">In this</span><a id="_idIndexMarker467"/><span class="koboSpan" id="kobo.634.1"> project, we will simulate a real environment by serving our site under a domain name in our local machine.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.635.1">Locate the </span><code class="inlineCode"><span class="koboSpan" id="kobo.636.1">hosts</span></code><span class="koboSpan" id="kobo.637.1"> file of your machine. </span><span class="koboSpan" id="kobo.637.2">If you are using Linux or macOS, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.638.1">hosts</span></code><span class="koboSpan" id="kobo.639.1"> file is located at </span><code class="inlineCode"><span class="koboSpan" id="kobo.640.1">/etc/hosts</span></code><span class="koboSpan" id="kobo.641.1">. </span><span class="koboSpan" id="kobo.641.2">If you are using Windows, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.642.1">hosts</span></code><span class="koboSpan" id="kobo.643.1"> file is located at </span><code class="inlineCode"><span class="koboSpan" id="kobo.644.1">C:\Windows\System32\Drivers\etc\hosts</span></code><span class="koboSpan" id="kobo.645.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.646.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.647.1">hosts</span></code><span class="koboSpan" id="kobo.648.1"> file of your machine and add the following line to it:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.649.1">127.0.0.1 mysite.com
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.650.1">This will tell your computer to point the </span><code class="inlineCode"><span class="koboSpan" id="kobo.651.1">mysite.com</span></code><span class="koboSpan" id="kobo.652.1"> hostname to your own machine.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.653.1">Let’s verify that the hostname association worked. </span><span class="koboSpan" id="kobo.653.2">Run the development server using the following command from the shell prompt:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.654.1">python manage.py runserver
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.655.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.656.1">http://mysite.com:8000/account/login/</span></code><span class="koboSpan" id="kobo.657.1"> in your browser. </span><span class="koboSpan" id="kobo.657.2">You will see the following error:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.658.1"><img alt="" role="presentation" src="../Images/B21088_05_04.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.659.1">Figure 5.4: The invalid host header message</span></p>
<p class="normal"><span class="koboSpan" id="kobo.660.1">Django controls the hosts that can serve the application using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.661.1">ALLOWED_HOSTS</span></code><span class="koboSpan" id="kobo.662.1"> setting. </span><span class="koboSpan" id="kobo.662.2">This is a security measure to prevent HTTP host header attacks. </span><span class="koboSpan" id="kobo.662.3">Django will only allow the hosts included in this list to serve the application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.663.1">You can learn more about the </span><code class="inlineCode"><span class="koboSpan" id="kobo.664.1">ALLOWED_HOSTS</span></code><span class="koboSpan" id="kobo.665.1"> setting at </span><a href="https://docs.djangoproject.com/en/5.0/ref/settings/#allowed-hosts"><span class="url"><span class="koboSpan" id="kobo.666.1">https://docs.djangoproject.com/en/5.0/ref/settings/#allowed-hosts</span></span></a><span class="koboSpan" id="kobo.667.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.668.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.669.1">settings.py</span></code><span class="koboSpan" id="kobo.670.1"> file of the project and modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.671.1">ALLOWED_HOSTS</span></code><span class="koboSpan" id="kobo.672.1"> setting as follows. </span><span class="koboSpan" id="kobo.672.2">The new code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.673.1">ALLOWED_HOSTS = [</span><span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.674.1">'mysite.com'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.675.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.676.1">'localhost'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.677.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.678.1">'127.0.0.1'</span></strong></span><span class="koboSpan" id="kobo.679.1">]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.680.1">Besides the </span><code class="inlineCode"><span class="koboSpan" id="kobo.681.1">mysite.com</span></code><span class="koboSpan" id="kobo.682.1"> host, we have explicitly included </span><code class="inlineCode"><span class="koboSpan" id="kobo.683.1">localhost</span></code><span class="koboSpan" id="kobo.684.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.685.1">127.0.0.1</span></code><span class="koboSpan" id="kobo.686.1">. </span><span class="koboSpan" id="kobo.686.2">This allows access to the site through </span><code class="inlineCode"><span class="koboSpan" id="kobo.687.1">localhost</span></code><span class="koboSpan" id="kobo.688.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.689.1">127.0.0.1</span></code><span class="koboSpan" id="kobo.690.1">, which is the default Django behavior when </span><code class="inlineCode"><span class="koboSpan" id="kobo.691.1">DEBUG</span></code><span class="koboSpan" id="kobo.692.1"> is </span><code class="inlineCode"><span class="koboSpan" id="kobo.693.1">True</span></code><span class="koboSpan" id="kobo.694.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.695.1">ALLOWED_HOSTS</span></code><span class="koboSpan" id="kobo.696.1"> is empty.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.697.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.698.1">http://mysite.com:8000/account/login/</span></code><span class="koboSpan" id="kobo.699.1"> again in your browser. </span><span class="koboSpan" id="kobo.699.2">Now, you should see the </span><a id="_idIndexMarker468"/><span class="koboSpan" id="kobo.700.1">login page of the site instead of an error.</span></p>
<h2 class="heading-2" id="_idParaDest-168"><span class="koboSpan" id="kobo.701.1">Running the development server through HTTPS</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.702.1">Next, we are going</span><a id="_idIndexMarker469"/><span class="koboSpan" id="kobo.703.1"> to run the development server through HTTPS to simulate a real environment where the content exchanged with the browser is secured. </span><span class="koboSpan" id="kobo.703.2">This will help us later in </span><em class="chapterRef"><span class="koboSpan" id="kobo.704.1">Chapter 6</span></em><span class="koboSpan" id="kobo.705.1">, </span><em class="italic"><span class="koboSpan" id="kobo.706.1">Sharing Content on Your Website</span></em><span class="koboSpan" id="kobo.707.1">, to serve our site securely and load our image bookmarking tool on top of any secure website. </span><span class="koboSpan" id="kobo.707.2">The </span><strong class="keyWord"><span class="koboSpan" id="kobo.708.1">Transport Layer Security</span></strong><span class="koboSpan" id="kobo.709.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.710.1">TLS</span></strong><span class="koboSpan" id="kobo.711.1">) protocol is the standard for serving websites through a secure connection. </span><span class="koboSpan" id="kobo.711.2">The TLS predecessor is the </span><strong class="keyWord"><span class="koboSpan" id="kobo.712.1">Secure Sockets Layer</span></strong><span class="koboSpan" id="kobo.713.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.714.1">SSL</span></strong><span class="koboSpan" id="kobo.715.1">).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.716.1">Although SSL is now deprecated, you will find references to both the terms TLS and SSL in multiple libraries and online documentation. </span><span class="koboSpan" id="kobo.716.2">The Django development server is not able to serve your site through HTTPS since that is not its intended use. </span><span class="koboSpan" id="kobo.716.3">To test the social authentication functionality serving the site through HTTPS, we are going to use the RunServerPlus extension of the package Django Extensions. </span><span class="koboSpan" id="kobo.716.4">This package contains a collection of useful Django tools. </span><span class="koboSpan" id="kobo.716.5">Please note that you should never use the development server to run your site in a production environment.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.717.1">Use the following command to install Django Extensions:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.718.1">python -m pip install django-extensions==3.2.3
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.719.1">You will need to install Werkzeug, which contains a debugger layer required by the RunServerPlus extension of Django Extensions. </span><span class="koboSpan" id="kobo.719.2">Use the following command to install Werkzeug:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.720.1">python -m pip install werkzeug==3.0.2
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.721.1">Finally, use the</span><a id="_idIndexMarker470"/><span class="koboSpan" id="kobo.722.1"> following command to install pyOpenSSL, which is required to use the SSL/TLS functionality of RunServerPlus:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.723.1">python -m pip install pyOpenSSL==24.1.0
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.724.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.725.1">settings.py</span></code><span class="koboSpan" id="kobo.726.1"> file of your project and add Django Extensions to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.727.1">INSTALLED_APPS</span></code><span class="koboSpan" id="kobo.728.1"> setting, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.729.1">INSTALLED_APPS = [
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.730.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.731.1">'django_extensions'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.732.1">,</span></strong></span><span class="koboSpan" id="kobo.733.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.734.1">Now, use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.735.1">runserver_plus</span></code><span class="koboSpan" id="kobo.736.1"> management command provided by Django Extensions to run the development server, as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.737.1">python manage.py runserver_plus --cert-file cert.crt
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.738.1">We have provided a file name to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.739.1">runserver_plus</span></code><span class="koboSpan" id="kobo.740.1"> command for the SSL/TLS certificate. </span><span class="koboSpan" id="kobo.740.2">Django Extensions will generate a key and certificate automatically.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.741.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.742.1">https://mysite.com:8000/account/login/</span></code><span class="koboSpan" id="kobo.743.1"> in your browser. </span><span class="koboSpan" id="kobo.743.2">Now, you are accessing your site through HTTPS. </span><span class="koboSpan" id="kobo.743.3">Note we are now using </span><code class="inlineCode"><span class="koboSpan" id="kobo.744.1">https://</span></code><span class="koboSpan" id="kobo.745.1"> instead of </span><code class="inlineCode"><span class="koboSpan" id="kobo.746.1">http://</span></code><span class="koboSpan" id="kobo.747.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.748.1">Your browser will show a security warning because you are using a self-generated certificate instead of a certificate trusted by a </span><strong class="screenText"><span class="koboSpan" id="kobo.749.1">certification authority</span></strong><span class="koboSpan" id="kobo.750.1"> (</span><strong class="screenText"><span class="koboSpan" id="kobo.751.1">CA</span></strong><span class="koboSpan" id="kobo.752.1">).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.753.1">If you are using </span><a id="_idIndexMarker471"/><span class="koboSpan" id="kobo.754.1">Google Chrome, you will see the following screen:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.755.1"><img alt="" role="presentation" src="../Images/B21088_05_05.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.756.1">Figure 5.5: The safety error in Google Chrome</span></p>
<p class="normal"><span class="koboSpan" id="kobo.757.1">In this case, click on </span><strong class="screenText"><span class="koboSpan" id="kobo.758.1">Advanced</span></strong><span class="koboSpan" id="kobo.759.1"> and then click on </span><strong class="screenText"><span class="koboSpan" id="kobo.760.1">Proceed to mysite.com (unsafe)</span></strong><span class="koboSpan" id="kobo.761.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.762.1">If you are using Safari, you will see the following screen:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.763.1"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B21088_05_06.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.764.1">Figure 5.6: The safety error in Safari</span></p>
<p class="normal"><span class="koboSpan" id="kobo.765.1">In this case, click on </span><strong class="screenText"><span class="koboSpan" id="kobo.766.1">Show details</span></strong><span class="koboSpan" id="kobo.767.1"> and then click on </span><strong class="screenText"><span class="koboSpan" id="kobo.768.1">visit this website</span></strong><span class="koboSpan" id="kobo.769.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.770.1">If you are using</span><a id="_idIndexMarker472"/><span class="koboSpan" id="kobo.771.1"> Microsoft Edge, you will see the following screen:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.772.1"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B21088_05_07.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.773.1">Figure 5.7: The safety error in Microsoft Edge</span></p>
<p class="normal"><span class="koboSpan" id="kobo.774.1">In this case, click on </span><strong class="screenText"><span class="koboSpan" id="kobo.775.1">Advanced</span></strong><span class="koboSpan" id="kobo.776.1"> and then on </span><strong class="screenText"><span class="koboSpan" id="kobo.777.1">Continue to mysite.com (unsafe)</span></strong><span class="koboSpan" id="kobo.778.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.779.1">If you are using any other browser, access the advanced information displayed by your browser and accept the self-signed certificate so that your browser trusts the certificate.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.780.1">You will see that the URL starts with </span><code class="inlineCode"><span class="koboSpan" id="kobo.781.1">https://</span></code><span class="koboSpan" id="kobo.782.1"> and, in some cases, a lock icon that indicates that the connection is secure. </span><span class="koboSpan" id="kobo.782.2">Some browsers might display a broken lock icon because you are using a self-signed certificate instead of a trusted one. </span><span class="koboSpan" id="kobo.782.3">That won’t be a problem for our tests:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.783.1"><img alt="" role="presentation" src="../Images/B21088_05_08.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.784.1">Figure 5.8: The URL with the secured connection icon</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.785.1">Django Extensions includes many other interesting tools and features. </span><span class="koboSpan" id="kobo.785.2">You can find more information about this package at </span><span class="url"><span class="koboSpan" id="kobo.786.1">https://django-extensions.readthedocs.io/en/latest/</span></span><span class="koboSpan" id="kobo.787.1">.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.788.1">You can now </span><a id="_idIndexMarker473"/><span class="koboSpan" id="kobo.789.1">serve your site through HTTPS during development.</span></p>
<h2 class="heading-2" id="_idParaDest-169"><span class="koboSpan" id="kobo.790.1">Authentication using Google</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.791.1">Google offers social</span><a id="_idIndexMarker474"/><span class="koboSpan" id="kobo.792.1"> authentication </span><a id="_idIndexMarker475"/><span class="koboSpan" id="kobo.793.1">using OAuth 2.0, which allows users to sign in with Google accounts. </span><span class="koboSpan" id="kobo.793.2">You can read about Google’s OAuth2 implementation at </span><a href="https://developers.google.com/identity/protocols/OAuth2"><span class="url"><span class="koboSpan" id="kobo.794.1">https://developers.google.com/identity/protocols/OAuth2</span></span></a><span class="koboSpan" id="kobo.795.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.796.1">To implement authentication using Google, add the following line highlighted in bold to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.797.1">AUTHENTICATION_BACKENDS</span></code><span class="koboSpan" id="kobo.798.1"> setting in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.799.1">settings.py</span></code><span class="koboSpan" id="kobo.800.1"> file of your project:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.801.1">AUTHENTICATION_BACKENDS = [
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.802.1">'django.contrib.auth.backends.ModelBackend'</span></span><span class="koboSpan" id="kobo.803.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.804.1">'account.authentication.EmailAuthBackend'</span></span><span class="koboSpan" id="kobo.805.1">,
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.806.1">'social_core.backends.google.GoogleOAuth2'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.807.1">,</span></strong></span><span class="koboSpan" id="kobo.808.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.809.1">First, you will need to create an API key in your Google Developer Console. </span><span class="koboSpan" id="kobo.809.2">Open </span><a href="https://console.cloud.google.com/projectcreate"><span class="url"><span class="koboSpan" id="kobo.810.1">https://console.cloud.google.com/projectcreate</span></span></a><span class="koboSpan" id="kobo.811.1"> in your browser. </span><span class="koboSpan" id="kobo.811.2">You will see the following screen:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.812.1"><img alt="" role="presentation" src="../Images/B21088_05_09.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.813.1">Figure 5.9: The Google project creation form</span></p>
<p class="normal"><span class="koboSpan" id="kobo.814.1">Under </span><strong class="screenText"><span class="koboSpan" id="kobo.815.1">Project name</span></strong><span class="koboSpan" id="kobo.816.1">, enter </span><code class="inlineCode"><span class="koboSpan" id="kobo.817.1">Bookmarks</span></code><span class="koboSpan" id="kobo.818.1"> and click the </span><strong class="screenText"><span class="koboSpan" id="kobo.819.1">CREATE</span></strong><span class="koboSpan" id="kobo.820.1"> button.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.821.1">When the new</span><a id="_idIndexMarker476"/><span class="koboSpan" id="kobo.822.1"> project is ready, make sure</span><a id="_idIndexMarker477"/><span class="koboSpan" id="kobo.823.1"> the project is selected in the top navigation bar as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.824.1"><img alt="" role="presentation" src="../Images/B21088_05_10.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.825.1">Figure 5.10: The Google Developer Console top navigation bar</span></p>
<p class="normal"><span class="koboSpan" id="kobo.826.1">After the project is created, under </span><strong class="screenText"><span class="koboSpan" id="kobo.827.1">APIs &amp; Services</span></strong><span class="koboSpan" id="kobo.828.1">, click on </span><strong class="screenText"><span class="koboSpan" id="kobo.829.1">Credentials</span></strong><span class="koboSpan" id="kobo.830.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.831.1"><img alt="" role="presentation" src="../Images/B21088_05_11.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.832.1">Figure 5.11: Google APIs and services menu</span></p>
<p class="normal"><span class="koboSpan" id="kobo.833.1">You will see </span><a id="_idIndexMarker478"/><span class="koboSpan" id="kobo.834.1">the</span><a id="_idIndexMarker479"/><span class="koboSpan" id="kobo.835.1"> following screen:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.836.1"><img alt="" role="presentation" src="../Images/B21088_05_12.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.837.1">Figure 5.12: Google API creation of API credentials</span></p>
<p class="normal"><span class="koboSpan" id="kobo.838.1">Then, click on </span><strong class="screenText"><span class="koboSpan" id="kobo.839.1">CREATE CREDENTIALS</span></strong><span class="koboSpan" id="kobo.840.1"> and click on </span><strong class="screenText"><span class="koboSpan" id="kobo.841.1">OAuth client ID</span></strong><span class="koboSpan" id="kobo.842.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.843.1">Google will ask you to configure the consent screen first, like this:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.844.1"><img alt="" role="presentation" src="../Images/B21088_05_13.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.845.1">Figure 5.13: The alert to configure the OAuth consent screen</span></p>
<p class="normal"><span class="koboSpan" id="kobo.846.1">We will configure the page that will be shown to users to give their consent to access your site with</span><a id="_idIndexMarker480"/><span class="koboSpan" id="kobo.847.1"> their Google account. </span><span class="koboSpan" id="kobo.847.2">Click</span><a id="_idIndexMarker481"/><span class="koboSpan" id="kobo.848.1"> on the </span><strong class="screenText"><span class="koboSpan" id="kobo.849.1">CONFIGURE CONSENT SCREEN</span></strong><span class="koboSpan" id="kobo.850.1"> button. </span><span class="koboSpan" id="kobo.850.2">You will be redirected to the following screen:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.851.1"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B21088_05_14.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.852.1">Figure 5.14: The User Type selection in the Google OAuth consent screen setup</span></p>
<p class="normal"><span class="koboSpan" id="kobo.853.1">Choose </span><strong class="screenText"><span class="koboSpan" id="kobo.854.1">External</span></strong><span class="koboSpan" id="kobo.855.1"> for </span><strong class="screenText"><span class="koboSpan" id="kobo.856.1">User Type </span></strong><span class="koboSpan" id="kobo.857.1">and click the </span><strong class="screenText"><span class="koboSpan" id="kobo.858.1">CREATE</span></strong><span class="koboSpan" id="kobo.859.1"> button. </span><span class="koboSpan" id="kobo.859.2">You will see the following screen:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.860.1"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B21088_05_15.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.861.1">Figure 5.15: The Google OAuth consent screen setup</span></p>
<p class="normal"><span class="koboSpan" id="kobo.862.1">Under </span><strong class="screenText"><span class="koboSpan" id="kobo.863.1">App name</span></strong><span class="koboSpan" id="kobo.864.1">, enter </span><code class="inlineCode"><span class="koboSpan" id="kobo.865.1">Bookmarks</span></code><span class="koboSpan" id="kobo.866.1"> and select </span><a id="_idIndexMarker482"/><span class="koboSpan" id="kobo.867.1">your</span><a id="_idIndexMarker483"/><span class="koboSpan" id="kobo.868.1"> email for </span><strong class="screenText"><span class="koboSpan" id="kobo.869.1">User support email</span></strong><span class="koboSpan" id="kobo.870.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.871.1">Under </span><strong class="screenText"><span class="koboSpan" id="kobo.872.1">Authorised domains</span></strong><span class="koboSpan" id="kobo.873.1">, enter </span><code class="inlineCode"><span class="koboSpan" id="kobo.874.1">mysite.com</span></code><span class="koboSpan" id="kobo.875.1"> as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.876.1"><img alt="Text  Description automatically generated with low confidence" src="../Images/B21088_05_16.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.877.1">Figure 5.16: Google OAuth authorized domains</span></p>
<p class="normal"><span class="koboSpan" id="kobo.878.1">Enter your email under </span><strong class="screenText"><span class="koboSpan" id="kobo.879.1">Developer contact information</span></strong><span class="koboSpan" id="kobo.880.1"> and click on </span><strong class="screenText"><span class="koboSpan" id="kobo.881.1">SAVE AND CONTINUE</span></strong><span class="koboSpan" id="kobo.882.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.883.1">In step 2,</span><strong class="screenText"><span class="koboSpan" id="kobo.884.1"> Scopes</span></strong><span class="koboSpan" id="kobo.885.1">, don’t change anything and click on </span><strong class="screenText"><span class="koboSpan" id="kobo.886.1">SAVE AND CONTINUE</span></strong><span class="koboSpan" id="kobo.887.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.888.1">In step 3,</span><strong class="screenText"><span class="koboSpan" id="kobo.889.1"> Test users, </span></strong><span class="koboSpan" id="kobo.890.1">add your Google</span><a id="_idIndexMarker484"/><span class="koboSpan" id="kobo.891.1"> user to </span><strong class="screenText"><span class="koboSpan" id="kobo.892.1">Test users</span></strong><span class="koboSpan" id="kobo.893.1"> and click on </span><strong class="screenText"><span class="koboSpan" id="kobo.894.1">SAVE AND CONTINUE</span></strong><span class="koboSpan" id="kobo.895.1"> as </span><a id="_idIndexMarker485"/><span class="koboSpan" id="kobo.896.1">follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.897.1"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B21088_05_17.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.898.1">Figure 5.17: Google OAuth test users</span></p>
<p class="normal"><span class="koboSpan" id="kobo.899.1">You will see a summary of your consent screen configuration. </span><span class="koboSpan" id="kobo.899.2">Click on </span><strong class="screenText"><span class="koboSpan" id="kobo.900.1">BACK TO DASHBOARD</span></strong><span class="koboSpan" id="kobo.901.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.902.1">In the menu on the left sidebar, click on </span><strong class="screenText"><span class="koboSpan" id="kobo.903.1">Credentials</span></strong><span class="koboSpan" id="kobo.904.1">, click again on </span><strong class="screenText"><span class="koboSpan" id="kobo.905.1">Create credentials</span></strong><span class="koboSpan" id="kobo.906.1">, and then on </span><strong class="screenText"><span class="koboSpan" id="kobo.907.1">OAuth client ID</span></strong><span class="koboSpan" id="kobo.908.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.909.1">As the next step, enter the following information:</span></p>
<ul>
<li class="bulletList"><strong class="screenText"><span class="koboSpan" id="kobo.910.1">Application type</span></strong><span class="koboSpan" id="kobo.911.1">: Select </span><strong class="screenText"><span class="koboSpan" id="kobo.912.1">Web application</span></strong></li>
<li class="bulletList"><strong class="screenText"><span class="koboSpan" id="kobo.913.1">Name</span></strong><span class="koboSpan" id="kobo.914.1">: Enter </span><code class="inlineCode"><span class="koboSpan" id="kobo.915.1">Bookmarks</span></code></li>
<li class="bulletList"><strong class="screenText"><span class="koboSpan" id="kobo.916.1">Authorised JavaScript origins</span></strong><span class="koboSpan" id="kobo.917.1">: Add </span><code class="inlineCode"><span class="koboSpan" id="kobo.918.1">https://mysite.com:8000</span></code></li>
<li class="bulletList"><strong class="screenText"><span class="koboSpan" id="kobo.919.1">Authorised redirect URIs</span></strong><span class="koboSpan" id="kobo.920.1">: Add </span><code class="inlineCode"><span class="koboSpan" id="kobo.921.1">https://mysite.com:8000/social-auth/complete/google-oauth2/</span></code></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.922.1">The </span><a id="_idIndexMarker486"/><span class="koboSpan" id="kobo.923.1">form </span><a id="_idIndexMarker487"/><span class="koboSpan" id="kobo.924.1">should look like this:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.925.1"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B21088_05_18.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.926.1">Figure 5.18: The Google OAuth client ID creation form</span></p>
<p class="normal"><span class="koboSpan" id="kobo.927.1">Click the </span><strong class="screenText"><span class="koboSpan" id="kobo.928.1">CREATE</span></strong><span class="koboSpan" id="kobo.929.1"> button. </span><span class="koboSpan" id="kobo.929.2">You will get the </span><strong class="screenText"><span class="koboSpan" id="kobo.930.1">Client ID</span></strong><span class="koboSpan" id="kobo.931.1"> and </span><strong class="screenText"><span class="koboSpan" id="kobo.932.1">Client secret</span></strong><span class="koboSpan" id="kobo.933.1"> keys:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.934.1"><img alt="" role="presentation" src="../Images/B21088_05_19.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.935.1">Figure 5.19: Google OAuth – Client ID and Client secret</span></p>
<p class="normal"><span class="koboSpan" id="kobo.936.1">Create a new </span><a id="_idIndexMarker488"/><span class="koboSpan" id="kobo.937.1">file inside your project’s root </span><a id="_idIndexMarker489"/><span class="koboSpan" id="kobo.938.1">directory and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.939.1">.env</span></code><span class="koboSpan" id="kobo.940.1">. </span><span class="koboSpan" id="kobo.940.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.941.1">.env</span></code><span class="koboSpan" id="kobo.942.1"> file will contain key-value pairs of environment variables. </span><span class="koboSpan" id="kobo.942.2">Add the OAuth2 credentials to the new file, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.943.1">GOOGLE_OAUTH2_KEY=xxxx
GOOGLE_OAUTH2_SECRET=xxxx
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.944.1">Replace </span><code class="inlineCode"><span class="koboSpan" id="kobo.945.1">xxxx</span></code><span class="koboSpan" id="kobo.946.1"> with the OAuth2 key and secret respectively.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.947.1">To facilitate the separation of configuration from code, we are going to use </span><code class="inlineCode"><span class="koboSpan" id="kobo.948.1">python-decouple</span></code><span class="koboSpan" id="kobo.949.1">. </span><span class="koboSpan" id="kobo.949.2">You already used this library in </span><em class="chapterRef"><span class="koboSpan" id="kobo.950.1">Chapter 2</span></em><span class="koboSpan" id="kobo.951.1">, </span><em class="italic"><span class="koboSpan" id="kobo.952.1">Enhancing Your Blog and Adding Social Features</span></em><span class="koboSpan" id="kobo.953.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.954.1">Install </span><code class="inlineCode"><span class="koboSpan" id="kobo.955.1">python-decouple</span></code><span class="koboSpan" id="kobo.956.1"> via </span><code class="inlineCode"><span class="koboSpan" id="kobo.957.1">pip</span></code><span class="koboSpan" id="kobo.958.1"> by running the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.959.1">python -m pip install python-decouple==3.8
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.960.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.961.1">settings.py</span></code><span class="koboSpan" id="kobo.962.1"> file of your project and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.963.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.964.1"> decouple </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.965.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.966.1"> config</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.967.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.968.1">SOCIAL_AUTH_GOOGLE_OAUTH2_KEY = config(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.969.1">'GOOGLE_OAUTH2_KEY'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.970.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.971.1">SOCIAL_AUTH_GOOGLE_OAUTH2_SECRET = config(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.972.1">'GOOGLE_OAUTH2_SECRET'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.973.1">)</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.974.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.975.1">SOCIAL_AUTH_GOOGLE_OAUTH2_KEY</span></code><span class="koboSpan" id="kobo.976.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.977.1">SOCIAL_AUTH_GOOGLE_OAUTH2_SECRET</span></code><span class="koboSpan" id="kobo.978.1"> settings are loaded from the environment variables defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.979.1">.env</span></code><span class="koboSpan" id="kobo.980.1"> file.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.981.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.982.1">registration/login.html</span></code><span class="koboSpan" id="kobo.983.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.984.1">account</span></code><span class="koboSpan" id="kobo.985.1"> application and append the following code </span><a id="_idIndexMarker490"/><span class="koboSpan" id="kobo.986.1">highlighted in bold at the bottom of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.987.1">content</span></code><span class="koboSpan" id="kobo.988.1"> block:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.989.1">{% block content %}
  ...
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.990.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.991.1">div</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.992.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.993.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.994.1">"social"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.995.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.996.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.997.1">ul</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.998.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.999.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1000.1">li</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1001.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1002.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1003.1">"google"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1004.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1005.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1006.1">a</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1007.1">href</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1008.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1009.1">"{% url "</span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1010.1">social:begin</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1011.1">"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1012.1"> "</span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1013.1">google-oauth2</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1014.1">" %}"&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1015.1">          Sign in with Google</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1016.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1017.1">a</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1018.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1019.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1020.1">li</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1021.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1022.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1023.1">ul</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1024.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1025.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1026.1">div</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1027.1">&gt;</span></strong></span><span class="koboSpan" id="kobo.1028.1">
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1029.1">Use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1030.1">runserver_plus</span></code><span class="koboSpan" id="kobo.1031.1"> management command provided by Django Extensions to run the development server, as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1032.1">python manage.py runserver_plus --cert-file cert.crt
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1033.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.1034.1">https://mysite.com:8000/account/login/</span></code><span class="koboSpan" id="kobo.1035.1"> in your browser. </span><span class="koboSpan" id="kobo.1035.2">The login page should now look as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1036.1"><img alt="" role="presentation" src="../Images/B21088_05_20.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1037.1">Figure 5.20: The login page including the button for Google authentication</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1038.1">Click on</span><a id="_idIndexMarker491"/><span class="koboSpan" id="kobo.1039.1"> the </span><strong class="screenText"><span class="koboSpan" id="kobo.1040.1">Sign in with Google</span></strong><span class="koboSpan" id="kobo.1041.1"> button. </span><span class="koboSpan" id="kobo.1041.2">You</span><a id="_idIndexMarker492"/><span class="koboSpan" id="kobo.1042.1"> will see the following screen:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1043.1"><img alt="" role="presentation" src="../Images/B21088_05_21.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1044.1">Figure 5.21: The Google application authorization screen</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1045.1">Click on your Google account to authorize the application. </span><span class="koboSpan" id="kobo.1045.2">You will be logged in and redirected to the dashboard page of your site. </span><span class="koboSpan" id="kobo.1045.3">Remember that you have set this URL in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1046.1">LOGIN_REDIRECT_URL</span></code><span class="koboSpan" id="kobo.1047.1"> setting. </span><span class="koboSpan" id="kobo.1047.2">As you can see, adding social authentication to your site is pretty straightforward.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1048.1">You have now added social authentication to your project with Google. </span><span class="koboSpan" id="kobo.1048.2">You can easily implement social </span><a id="_idIndexMarker493"/><span class="koboSpan" id="kobo.1049.1">authentication with </span><a id="_idIndexMarker494"/><span class="koboSpan" id="kobo.1050.1">other online services using Python Social Auth. </span><span class="koboSpan" id="kobo.1050.2">In the next section, we will address creating user profiles when registering with social authentication.</span></p>
<h2 class="heading-2" id="_idParaDest-170"><span class="koboSpan" id="kobo.1051.1">Creating a profile for users that register with social authentication</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1052.1">When a user </span><a id="_idIndexMarker495"/><span class="koboSpan" id="kobo.1053.1">authenticates using social authentication, a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1054.1">User</span></code><span class="koboSpan" id="kobo.1055.1"> object is created if there isn’t an existing user associated with that social profile. </span><span class="koboSpan" id="kobo.1055.2">Python Social Auth uses a pipeline consisting of a set of functions that are executed in a specific order during the authentication flow. </span><span class="koboSpan" id="kobo.1055.3">These functions take care of retrieving any user details, creating a social profile in the database, and associating it with an existing user or creating a new one.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1056.1">Currently, no </span><code class="inlineCode"><span class="koboSpan" id="kobo.1057.1">Profile</span></code><span class="koboSpan" id="kobo.1058.1"> object is created when new users are created via social authentication. </span><span class="koboSpan" id="kobo.1058.2">We will add a new step to the pipeline to automatically create a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1059.1">Profile</span></code><span class="koboSpan" id="kobo.1060.1"> object in the database when a new user is created.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1061.1">Add the following </span><code class="inlineCode"><span class="koboSpan" id="kobo.1062.1">SOCIAL_AUTH_PIPELINE</span></code><span class="koboSpan" id="kobo.1063.1"> setting to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1064.1">settings.py</span></code><span class="koboSpan" id="kobo.1065.1"> file of your project:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1066.1">SOCIAL_AUTH_PIPELINE = [
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1067.1">'social_core.pipeline.social_auth.social_details'</span></span><span class="koboSpan" id="kobo.1068.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1069.1">'social_core.pipeline.social_auth.social_uid'</span></span><span class="koboSpan" id="kobo.1070.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1071.1">'social_core.pipeline.social_auth.auth_allowed'</span></span><span class="koboSpan" id="kobo.1072.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1073.1">'social_core.pipeline.social_auth.social_user'</span></span><span class="koboSpan" id="kobo.1074.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1075.1">'social_core.pipeline.user.get_username'</span></span><span class="koboSpan" id="kobo.1076.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1077.1">'social_core.pipeline.user.create_user'</span></span><span class="koboSpan" id="kobo.1078.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1079.1">'social_core.pipeline.social_auth.associate_user'</span></span><span class="koboSpan" id="kobo.1080.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1081.1">'social_core.pipeline.social_auth.load_extra_data'</span></span><span class="koboSpan" id="kobo.1082.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1083.1">'social_core.pipeline.user.user_details'</span></span><span class="koboSpan" id="kobo.1084.1">,
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1085.1">This is the default authentication pipeline used by Python Social Auth. </span><span class="koboSpan" id="kobo.1085.2">It consists of several functions that perform different tasks when authenticating a user. </span><span class="koboSpan" id="kobo.1085.3">You can find more details about the default authentication pipeline at </span><a href="https://python-social-auth.readthedocs.io/en/latest/pipeline.html"><span class="url"><span class="koboSpan" id="kobo.1086.1">https://python-social-auth.readthedocs.io/en/latest/pipeline.html</span></span></a><span class="koboSpan" id="kobo.1087.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1088.1">Let’s build a function that creates a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1089.1">Profile</span></code><span class="koboSpan" id="kobo.1090.1"> object in the database whenever a new user is created. </span><span class="koboSpan" id="kobo.1090.2">We will then add this function to the social authentication pipeline.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1091.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1092.1">account/authentication.py</span></code><span class="koboSpan" id="kobo.1093.1"> file and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1094.1">from</span></span><span class="koboSpan" id="kobo.1095.1"> account.models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1096.1">import</span></span><span class="koboSpan" id="kobo.1097.1"> Profile
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1098.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1099.1">create_profile</span></span><span class="koboSpan" id="kobo.1100.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1101.1">backend, user, *args, **kwargs</span></span><span class="koboSpan" id="kobo.1102.1">):
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1103.1">"""</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1104.1">    Create user profile for social authentication</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1105.1">    """</span></span><span class="koboSpan" id="kobo.1106.1">
    Profile.objects.get_or_create(user=user)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1107.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1108.1">create_profile</span></code><span class="koboSpan" id="kobo.1109.1"> function</span><a id="_idIndexMarker496"/><span class="koboSpan" id="kobo.1110.1"> takes two required arguments:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1111.1">backend</span></code><span class="koboSpan" id="kobo.1112.1">: The social auth backend used for user authentication. </span><span class="koboSpan" id="kobo.1112.2">Remember that you added the social authentication backends to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1113.1">AUTHENTICATION_BACKENDS</span></code><span class="koboSpan" id="kobo.1114.1"> setting in your project.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1115.1">user</span></code><span class="koboSpan" id="kobo.1116.1">: The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1117.1">User</span></code><span class="koboSpan" id="kobo.1118.1"> instance of the new or existing authenticated user.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1119.1">You can check the different arguments that are passed to the pipeline functions at </span><a href="https://python-social-auth.readthedocs.io/en/latest/pipeline.html#extending-the-pipeline"><span class="url"><span class="koboSpan" id="kobo.1120.1">https://python-social-auth.readthedocs.io/en/latest/pipeline.html#extending-the-pipeline</span></span></a><span class="koboSpan" id="kobo.1121.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1122.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1123.1">create_profile</span></code><span class="koboSpan" id="kobo.1124.1"> function, we check that a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1125.1">user</span></code><span class="koboSpan" id="kobo.1126.1"> object is present and we use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1127.1">get_or_create()</span></code><span class="koboSpan" id="kobo.1128.1"> method to look up a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1129.1">Profile</span></code><span class="koboSpan" id="kobo.1130.1"> object for the given user, and we create one if necessary.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1131.1">Now, we need to add the new function to the authentication pipeline. </span><span class="koboSpan" id="kobo.1131.2">Add the following line highlighted in bold to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1132.1">SOCIAL_AUTH_PIPELINE</span></code><span class="koboSpan" id="kobo.1133.1"> setting in your </span><code class="inlineCode"><span class="koboSpan" id="kobo.1134.1">settings.py</span></code><span class="koboSpan" id="kobo.1135.1"> file:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1136.1">SOCIAL_AUTH_PIPELINE = [
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1137.1">'social_core.pipeline.social_auth.social_details'</span></span><span class="koboSpan" id="kobo.1138.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1139.1">'social_core.pipeline.social_auth.social_uid'</span></span><span class="koboSpan" id="kobo.1140.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1141.1">'social_core.pipeline.social_auth.auth_allowed'</span></span><span class="koboSpan" id="kobo.1142.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1143.1">'social_core.pipeline.social_auth.social_user'</span></span><span class="koboSpan" id="kobo.1144.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1145.1">'social_core.pipeline.user.get_username'</span></span><span class="koboSpan" id="kobo.1146.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1147.1">'social_core.pipeline.user.create_user'</span></span><span class="koboSpan" id="kobo.1148.1">,
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1149.1">'account.authentication.create_profile'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1150.1">,</span></strong></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1151.1">'social_core.pipeline.social_auth.associate_user'</span></span><span class="koboSpan" id="kobo.1152.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1153.1">'social_core.pipeline.social_auth.load_extra_data'</span></span><span class="koboSpan" id="kobo.1154.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1155.1">'social_core.pipeline.user.user_details'</span></span><span class="koboSpan" id="kobo.1156.1">,
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1157.1">We have added the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1158.1">create_profile</span></code><span class="koboSpan" id="kobo.1159.1"> function after </span><code class="inlineCode"><span class="koboSpan" id="kobo.1160.1">social_core.pipeline.create_user</span></code><span class="koboSpan" id="kobo.1161.1">. </span><span class="koboSpan" id="kobo.1161.2">At this point, a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1162.1">User</span></code><span class="koboSpan" id="kobo.1163.1"> instance is available. </span><span class="koboSpan" id="kobo.1163.2">The user can be an existing user or a new one created in this step of the pipeline. </span><span class="koboSpan" id="kobo.1163.3">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1164.1">create_profile</span></code><span class="koboSpan" id="kobo.1165.1"> function uses the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1166.1">User</span></code><span class="koboSpan" id="kobo.1167.1"> instance to look up the related </span><code class="inlineCode"><span class="koboSpan" id="kobo.1168.1">Profile</span></code><span class="koboSpan" id="kobo.1169.1"> object and create a new one if necessary.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1170.1">Access the user list in the administration site at </span><code class="inlineCode"><span class="koboSpan" id="kobo.1171.1">https://mysite.com:8000/admin/auth/user/</span></code><span class="koboSpan" id="kobo.1172.1">. </span><span class="koboSpan" id="kobo.1172.2">Remove any users created through social authentication.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1173.1">Then, open </span><code class="inlineCode"><span class="koboSpan" id="kobo.1174.1">https://mysite.com:8000/account/login/</span></code><span class="koboSpan" id="kobo.1175.1"> and perform social authentication for the user you deleted. </span><span class="koboSpan" id="kobo.1175.2">A new user will be created and now a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1176.1">Profile</span></code><span class="koboSpan" id="kobo.1177.1"> object will be created as well. </span><span class="koboSpan" id="kobo.1177.2">Access </span><code class="inlineCode"><span class="koboSpan" id="kobo.1178.1">https://mysite.com:8000/admin/account/profile/</span></code><span class="koboSpan" id="kobo.1179.1"> to verify that a profile has been created for the new user.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1180.1">We have successfully added the functionality to create the user profile automatically for social authentication.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1181.1">Python Social </span><a id="_idIndexMarker497"/><span class="koboSpan" id="kobo.1182.1">Auth also offers a pipeline mechanism for the disconnection flow. </span><span class="koboSpan" id="kobo.1182.2">You can find more details at </span><a href="https://python-social-auth.readthedocs.io/en/latest/pipeline.html#disconnection-pipeline"><span class="url"><span class="koboSpan" id="kobo.1183.1">https://python-social-auth.readthedocs.io/en/latest/pipeline.html#disconnection-pipeline</span></span></a><span class="koboSpan" id="kobo.1184.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-171"><span class="koboSpan" id="kobo.1185.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1186.1">In this chapter, you significantly improved your social site authentication capabilities by creating an email-based authentication backend and adding social authentication with Google. </span><span class="koboSpan" id="kobo.1186.2">You also improved the user experience by providing feedback for their actions using the Django messages framework. </span><span class="koboSpan" id="kobo.1186.3">Finally, you customized the authentication pipeline to create user profiles for new users automatically.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1187.1">In the next chapter, you will create an image bookmarking system. </span><span class="koboSpan" id="kobo.1187.2">You will learn about many-to-many relationships and customizing the behavior of forms. </span><span class="koboSpan" id="kobo.1187.3">You will learn how to generate image thumbnails and how to build AJAX functionalities using JavaScript and Django.</span></p>
<h1 class="heading-1" id="_idParaDest-172"><span class="koboSpan" id="kobo.1188.1">Additional resources</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1189.1">The following resources provide additional information related to the topics covered in this chapter:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.1190.1">Source code for this chapter – </span><a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter05"><span class="url"><span class="koboSpan" id="kobo.1191.1">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter05</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1192.1">The Django messages framework – </span><a href="https://docs.djangoproject.com/en/5.0/ref/contrib/messages/"><span class="url"><span class="koboSpan" id="kobo.1193.1">https://docs.djangoproject.com/en/5.0/ref/contrib/messages/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1194.1">Custom authentication sources – </span><a href="https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#other-authentication-sources"><span class="url"><span class="koboSpan" id="kobo.1195.1">https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#other-authentication-sources</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1196.1">Automatic primary key fields – </span><a href="https://docs.djangoproject.com/en/5.0/topics/db/models/#automatic-primary-key-fields"><span class="url"><span class="koboSpan" id="kobo.1197.1">https://docs.djangoproject.com/en/5.0/topics/db/models/#automatic-primary-key-fields</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1198.1">Python Social Auth – </span><a href="https://github.com/python-social-auth"><span class="url"><span class="koboSpan" id="kobo.1199.1">https://github.com/python-social-auth</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1200.1">Python Social Auth’s authentication backends – </span><a href="https://python-social-auth.readthedocs.io/en/latest/backends/index.html#supported-backends"><span class="url"><span class="koboSpan" id="kobo.1201.1">https://python-social-auth.readthedocs.io/en/latest/backends/index.html#supported-backends</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1202.1">Django allowed hosts setting – </span><a href="https://docs.djangoproject.com/en/5.0/ref/settings/#allowed-hosts"><span class="url"><span class="koboSpan" id="kobo.1203.1">https://docs.djangoproject.com/en/5.0/ref/settings/#allowed-hosts</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1204.1">Django Extensions documentation – </span><a href="https://django-extensions.readthedocs.io/en/latest/"><span class="url"><span class="koboSpan" id="kobo.1205.1">https://django-extensions.readthedocs.io/en/latest/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1206.1">Google’s OAuth2 implementation – </span><a href="https://developers.google.com/identity/protocols/OAuth2"><span class="url"><span class="koboSpan" id="kobo.1207.1">https://developers.google.com/identity/protocols/OAuth2</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1208.1">Google API credentials – </span><a href="https://console.developers.google.com/apis/credentials"><span class="url"><span class="koboSpan" id="kobo.1209.1">https://console.developers.google.com/apis/credentials</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1210.1">Python Social Auth pipeline – </span><a href="https://python-social-auth.readthedocs.io/en/latest/pipeline.html"><span class="url"><span class="koboSpan" id="kobo.1211.1">https://python-social-auth.readthedocs.io/en/latest/pipeline.html</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1212.1">Extending the Python Social Auth pipeline – </span><a href="https://python-social-auth.readthedocs.io/en/latest/pipeline.html#extending-the-pipeline"><span class="url"><span class="koboSpan" id="kobo.1213.1">https://python-social-auth.readthedocs.io/en/latest/pipeline.html#extending-the-pipeline</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1214.1">Python Social Auth pipeline for disconnection – </span><a href="https://python-social-auth.readthedocs.io/en/latest/pipeline.html#disconnection-pipeline"><span class="url"><span class="koboSpan" id="kobo.1215.1">https://python-social-auth.readthedocs.io/en/latest/pipeline.html#disconnection-pipeline</span></span></a></li>
</ul>
</div>
</body></html>