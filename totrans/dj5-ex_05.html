<html><head></head><body>
<div><h1 class="chapterNumber">5</h1>
<h1 class="chapterTitle" id="_idParaDest-161">Implementing Social Authentication</h1>
<p class="normal">In the previous chapter, you built user registration and authentication into your website. You implemented password change, reset, and recovery functionalities, and you learned how to create a custom profile model for your users.</p>
<p class="normal">In this chapter, you will add social authentication to your site using Google. You will use <strong class="keyWord">Python Social Auth for Django</strong> to<a id="_idIndexMarker447"/> implement social authentication using OAuth 2.0, the industry-standard protocol for authorization. You will also modify the social authentication pipeline to create a user profile for new users automatically.</p>
<p class="normal">This chapter will cover the following points:</p>
<ul>
<li class="bulletList">Using the messages framework</li>
<li class="bulletList">Building a custom authentication backend</li>
<li class="bulletList">Preventing users from using an existing email</li>
<li class="bulletList">Adding social authentication with Python Social Auth</li>
<li class="bulletList">Running the development server through HTTPS using Django Extensions</li>
<li class="bulletList">Adding authentication using Google</li>
<li class="bulletList">Creating a profile for users that register with social authentication</li>
</ul>
<h1 class="heading-1" id="_idParaDest-162">Functional overview</h1>
<p class="normal"><em class="italic">Figure 5.1</em> shows a representation of the views, templates, and functionalities that will be built in this chapter:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_05_01.png"/></figure>
<p class="packt_figref">Figure 5.1: Diagram of functionalities built in Chapter 5</p>
<p class="normal">In this chapter, you will generate success and error messages in the <code class="inlineCode">edit</code> view using the Django messages framework. You will build a new authentication backend named <code class="inlineCode">EmailAuthBackend</code> for users to authenticate using their email addresses. You will serve your site over HTTPS during development using Django Extensions, and you will implement social authentication with Google on your site using Python Social Auth. Users will be redirected to the <code class="inlineCode">dashboard</code> view after successful authentication. You will customize the authentication pipeline to create user profiles automatically when a new user is created with social authentication.</p>
<h1 class="heading-1" id="_idParaDest-163">Technical requirements</h1>
<p class="normal">The source code for this chapter can be found at <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter05">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter05</a>.</p>
<p class="normal">All Python packages used in this chapter are included in the <code class="inlineCode">requirements.txt</code> file in the source code for the chapter. You can follow the instructions to install each Python package in the following sections, or you can install all requirements at once with the <code class="inlineCode">python</code> <code class="inlineCode">-m</code> <code class="inlineCode">pip</code> <code class="inlineCode">install</code> <code class="inlineCode">-r</code> <code class="inlineCode">requirements.txt</code> command.</p>
<h1 class="heading-1" id="_idParaDest-164">Using the messages framework</h1>
<p class="normal">When users are <a id="_idIndexMarker448"/>interacting with the platform, there are many cases where you might want to inform them about the result of specific actions, such as successfully creating an object in the database or successfully submitting a form. </p>
<p class="normal">Django has a built-in messages framework that allows you to display one-time notifications to your users. This enhances user experience by providing immediate feedback on their actions, making the interface more intuitive and user friendly.</p>
<p class="normal">The messages framework is located at <code class="inlineCode">django.contrib.messages</code> and is included in the default <code class="inlineCode">INSTALLED_APPS</code> list of the <code class="inlineCode">settings.py</code> file when you create new projects using <code class="inlineCode">python manage.py startproject</code>. The settings file also contains the <code class="inlineCode">django.contrib.messages.middleware.MessageMiddleware</code> middleware in the <code class="inlineCode">MIDDLEWARE</code> setting.</p>
<p class="normal">The messages framework provides a simple way to add messages to users. Messages are stored in a cookie by default (falling back to session storage), and they are displayed and cleared in the next request from the user. You can use the messages framework in your views by importing the <code class="inlineCode">messages</code> module and adding new messages with simple shortcuts, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">from django.contrib import messages
messages.error(request, 'Something went wrong')
</code></pre>
<p class="normal">You can create new messages using the <code class="inlineCode">add_message()</code> method or any of the following shortcut methods:</p>
<ul>
<li class="bulletList"><code class="inlineCode">success()</code>: Success messages are used to display when an action was successful</li>
<li class="bulletList"><code class="inlineCode">info()</code>: Informational messages</li>
<li class="bulletList"><code class="inlineCode">warning()</code>: This shows that a failure has not yet occurred but it may be imminent</li>
<li class="bulletList"><code class="inlineCode">error()</code>: This shows that an action was not successful or a failure occurred</li>
<li class="bulletList"><code class="inlineCode">debug()</code>: This shows debug messages that will be removed or ignored in a production environment</li>
</ul>
<p class="normal">Let’s add messages to the project. The messages framework applies globally to the project. We will use the base template to display any available messages to the client. This will allow us to notify the client of the results of any action on any page.</p>
<p class="normal">Open the <code class="inlineCode">templates/base.html</code> template of the <code class="inlineCode">account</code> application and add the following code <a id="_idIndexMarker449"/>highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">{% load static %}
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;{% block title %}{% endblock %}&lt;/title&gt;
&lt;link href="{% static "css/base.css" %}" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div id="header"&gt;
    ...
  &lt;/div&gt;
<strong class="hljs-slc">  {% if messages %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">ul</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"messages"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">      {% for message in messages %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">li</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"{{ message.tags }}"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">          {{ message|safe }}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">href</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"#"</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"close"</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">x</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">li</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">      {% endfor %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">ul</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">  {% endif %}</strong>
&lt;div id="content"&gt;
    {% block content %}
    {% endblock %}
  &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p class="normal">The messages framework includes the <code class="inlineCode">django.contrib.messages.context_processors.messages</code> context processor, which adds a <code class="inlineCode">messages</code> variable to the request context. You can find it in the <code class="inlineCode">context_processors</code> list in the <code class="inlineCode">TEMPLATES</code> setting of your project. You can use the <code class="inlineCode">messages</code> variable in templates to display all existing messages to the user.</p>
<div><p class="normal">A context processor is a Python function that takes the request object as an argument and returns a dictionary that gets added to the request context. You will learn how to create your own context processors in <em class="chapterRef">Chapter 8</em>, <em class="italic">Building an Online Shop</em>.</p>
</div>
<p class="normal">Let’s modify the <code class="inlineCode">edit</code> view to use the messages framework.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file <a id="_idIndexMarker450"/>of the <code class="inlineCode">account</code> application and add the following lines highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.contrib </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> messages</strong>
# ...
@login_required
def edit(request):
    if request.method == 'POST':
        user_form = UserEditForm(
            instance=request.user,
            data=request.POST
        )
        profile_form = ProfileEditForm(
            instance=request.user.profile,
            data=request.POST,
            files=request.FILES
        )
        if user_form.is_valid() and profile_form.is_valid():
            user_form.save()
            profile_form.save()
<strong class="hljs-slc">            messages.success(</strong>
<strong class="hljs-slc">                request,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'Profile updated successfully'</strong>
<strong class="hljs-slc">            )</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">else</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">            messages.error(request, </strong><strong class="hljs-string-slc">'Error updating your profile'</strong><strong class="hljs-slc">)</strong>
else:
        user_form = UserEditForm(instance=request.user)
        profile_form = ProfileEditForm(
                                    instance=request.user.profile)
    return render(
        request,
        'account/edit.html',
        {'user_form': user_form, 'profile_form': profile_form}
    )
</code></pre>
<p class="normal">A success message is generated when users successfully update their profile. If any of the forms contain invalid data, an error message is generated instead.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/account/edit/</code> in your browser and edit the profile of the user. You should see the following message when the profile is successfully updated:</p>
<figure class="mediaobject"><img alt="A green screen with white text  Description automatically generated with low confidence" src="img/B21088_05_02.png"/></figure>
<p class="packt_figref">Figure 5.2: The successfully edited profile message</p>
<p class="normal">Enter an invalid <a id="_idIndexMarker451"/>date in the <strong class="screenText">Date of birth</strong> field and submit the form again. You should see the following message:</p>
<figure class="mediaobject"><img alt="A picture containing graphical user interface  Description automatically generated" src="img/B21088_05_03.png"/></figure>
<p class="packt_figref">Figure 5.3: The error updating profile message</p>
<p class="normal">Generating messages to inform your users about the results of their actions is straightforward. You can easily add messages to other views as well.</p>
<p class="normal">You can learn more about the messages framework at <a href="https://docs.djangoproject.com/en/5.0/ref/contrib/messages/">https://docs.djangoproject.com/en/5.0/ref/contrib/messages/</a>.</p>
<p class="normal">Now that we’ve built all the functionality related to user authentication and profile editing, we will dig deeper into customizing authentication. We will learn how to build custom backend <a id="_idIndexMarker452"/>authentication so that users can log in to the site using their email addresses.</p>
<h1 class="heading-1" id="_idParaDest-165">Building a custom authentication backend</h1>
<p class="normal">Django allows<a id="_idIndexMarker453"/> you to authenticate users against different sources, such as the built-in Django authentication system, external authentication systems like <strong class="keyWord">Lightweight Directory Access Protocol</strong> (<strong class="keyWord">LDAP</strong>) servers, or even<a id="_idIndexMarker454"/> third-party providers. The <code class="inlineCode">AUTHENTICATION_BACKENDS</code> setting includes a list of authentication backends available in the project. Django enables you to specify multiple authentication backends for flexible authentication schemes. The default value of the <code class="inlineCode">AUTHENTICATION_BACKENDS</code> setting is the following:</p>
<pre class="programlisting con"><code class="hljs-con">['django.contrib.auth.backends.ModelBackend']
</code></pre>
<p class="normal">The default <code class="inlineCode">ModelBackend</code> authenticates users against the database using the <code class="inlineCode">User</code> model of <code class="inlineCode">django.contrib.auth</code>. This is suitable for most web projects. However, you can create custom backends to authenticate your users against other sources.</p>
<p class="normal">You can read more information about customizing authentication at <a href="https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#other-authentication-sources">https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#other-authentication-sources</a>.</p>
<p class="normal">Whenever the <code class="inlineCode">authenticate()</code> function of <code class="inlineCode">django.contrib.auth</code> is used, Django tries to authenticate the user against each of the backends defined in <code class="inlineCode">AUTHENTICATION_BACKENDS</code> one by one, until one of them successfully authenticates the user. Only if all of the backends fail to authenticate will the user not be authenticated.</p>
<p class="normal">Django provides a simple way to define your own authentication backends. An authentication backend is a class that provides the following two methods:</p>
<ul>
<li class="bulletList"><code class="inlineCode">authenticate()</code>: It takes the <code class="inlineCode">request</code> object and user credentials as parameters. It has to return a <code class="inlineCode">user</code> object that matches those credentials if the credentials are valid, or <code class="inlineCode">None</code> otherwise. The <code class="inlineCode">request</code> parameter is an <code class="inlineCode">HttpRequest</code> object, or <code class="inlineCode">None</code> if it’s not provided to the <code class="inlineCode">authenticate()</code> function.</li>
<li class="bulletList"><code class="inlineCode">get_user()</code>: It takes a user ID parameter and has to return a <code class="inlineCode">user</code> object.</li>
</ul>
<p class="normal">Creating a custom authentication backend is as simple as writing a Python class that implements both methods. Let’s create an authentication backend to allow users to authenticate on the site using their email address instead of their username.</p>
<p class="normal">Create a new file inside the <code class="inlineCode">account</code> application directory and name it <code class="inlineCode">authentication.py</code>. Add<a id="_idIndexMarker455"/> the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.contrib.auth.models import User
class EmailAuthBackend:
    """
    Authenticate using an e-mail address.
    """
def authenticate(self, request, username=None, password=None):
        try:
            user = User.objects.get(email=username)
            if user.check_password(password):
                return user
            return None
except (User.DoesNotExist, User.MultipleObjectsReturned):
            return None
def get_user(self, user_id):
        try:
            return User.objects.get(pk=user_id)
        except User.DoesNotExist:
            return None
</code></pre>
<p class="normal">The preceding code is a simple authentication backend. The <code class="inlineCode">authenticate()</code> method receives a <code class="inlineCode">request</code> object and the <code class="inlineCode">username</code> and <code class="inlineCode">password</code> optional parameters. We could use different parameters, but we use <code class="inlineCode">username</code> and <code class="inlineCode">password</code> to make our backend work with the authentication framework views right away. The preceding code works as follows:</p>
<ul>
<li class="bulletList"><code class="inlineCode">authenticate()</code>: The user with the given email address is retrieved, and the password is checked using the built-in <code class="inlineCode">check_password()</code> method of the user model. This method handles the password hashing to compare the given password with the password stored in the database. Two different QuerySet exceptions are captured: <code class="inlineCode">DoesNotExist</code> and <code class="inlineCode">MultipleObjectsReturned</code>. The <code class="inlineCode">DoesNotExist</code> exception is raised if no user is found with the given email address. The <code class="inlineCode">MultipleObjectsReturned</code> exception is raised if multiple users are found with the same email address. We will modify the registration and edit views later to prevent users from using an existing email address.</li>
<li class="bulletList"><code class="inlineCode">get_user()</code>: You get a user through the ID provided in the <code class="inlineCode">user_id</code> parameter. Django uses the backend that authenticated the user to retrieve the <code class="inlineCode">User</code> object for the duration of the user session. <strong class="keyWord">pk</strong> is a short for <strong class="keyWord">primary key</strong>, which is <a id="_idIndexMarker456"/>a unique identifier for each record in the database. Every Django model has a field that serves as its primary key. By default, the primary key is the automatically generated ID field. You can find more information about automatic<a id="_idIndexMarker457"/> primary key fields at <a href="https://docs.djangoproject.com/en/5.0/topics/db/models/#automatic-primary-key-fields">https://docs.djangoproject.com/en/5.0/topics/db/models/#automatic-primary-key-fields</a>.</li>
</ul>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of your project and add the following code:</p>
<pre class="programlisting code"><code class="hljs-code">AUTHENTICATION_BACKENDS = [
    'django.contrib.auth.backends.ModelBackend',
    'account.authentication.EmailAuthBackend',
]
</code></pre>
<p class="normal">In the preceding setting, we keep the default <code class="inlineCode">ModelBackend</code> that is used to authenticate with the username and password and include our own email-based authentication backend <code class="inlineCode">EmailAuthBackend</code>.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/account/login/</code> in your browser. Remember that Django will try to authenticate the user against each of the backends, so now you should be able to log in seamlessly using your username or email account.</p>
<p class="normal">The user credentials will be checked using <code class="inlineCode">ModelBackend</code>, and if no user is returned, the credentials will be checked using <code class="inlineCode">EmailAuthBackend</code>.</p>
<div><p class="normal">The order of the backends listed in the <code class="inlineCode">AUTHENTICATION_BACKENDS</code> setting matters. If the same credentials are valid for multiple backends, Django will authenticate<a id="_idIndexMarker458"/> the user using the first backend in the list that successfully validates these credentials. This means Django does not proceed to check the remaining backends once a match is found.</p>
</div>
<h2 class="heading-2" id="_idParaDest-166">Preventing users from using an existing email address</h2>
<p class="normal">The <code class="inlineCode">User</code> model<a id="_idIndexMarker459"/> of <a id="_idIndexMarker460"/>the authentication framework does not prevent creating users with the same email address. If two or more user accounts share the same email address, we won’t be able to discern which user is authenticating. Now that users can log in using their email address, we have to prevent users from registering with an existing email address.</p>
<p class="normal">We will now change the user registration form to prevent multiple users from registering with the same email address.</p>
<p class="normal">Edit the <code class="inlineCode">forms.py</code> file of the <code class="inlineCode">account</code> application and add the following lines highlighted in bold to the <code class="inlineCode">UserRegistrationForm</code> class:</p>
<pre class="programlisting code"><code class="hljs-code">class UserRegistrationForm(forms.ModelForm):
    password = forms.CharField(
        label='Password',
        widget=forms.PasswordInput
    )
    password2 = forms.CharField(
        label='Repeat password',
        widget=forms.PasswordInput
    )
    class Meta:
        model = User
        fields = ['username', 'first_name', 'email']
    def clean_password2(self):
        cd = self.cleaned_data
        if cd['password'] != cd['password2']:
            raise forms.ValidationError('Passwords don\'t match.')
        return cd['password2']
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">clean_email</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc">        data = self.cleaned_data[</strong><strong class="hljs-string-slc">'email'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> User.objects.</strong><strong class="hljs-built_in-slc">filter</strong><strong class="hljs-slc">(email=data).exists():</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">raise</strong><strong class="hljs-slc"> forms.ValidationError(</strong><strong class="hljs-string-slc">'Email already in use.'</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> data</strong>
</code></pre>
<p class="normal">We have added validation for the <code class="inlineCode">email</code> field that prevents users from registering with an existing email address. We build a QuerySet to look up existing users with the same email address. We check whether there are any results with the <code class="inlineCode">exists()</code> method. The <code class="inlineCode">exists()</code> method returns <code class="inlineCode">True</code> if the QuerySet contains any results, and <code class="inlineCode">False</code> otherwise.</p>
<p class="normal">Now, add the following lines highlighted in bold to the <code class="inlineCode">UserEditForm</code> class:</p>
<pre class="programlisting code"><code class="hljs-code">class UserEditForm(forms.ModelForm):
    class Meta:
        model = User
        fields = ['first_name', 'last_name', 'email']
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">clean_email</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc">        data = self.cleaned_data[</strong><strong class="hljs-string-slc">'email'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">        qs = User.objects.exclude(</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">id</strong><strong class="hljs-slc">=self.instance.</strong><strong class="hljs-built_in-slc">id</strong>
<strong class="hljs-slc">        ).</strong><strong class="hljs-built_in-slc">filter</strong><strong class="hljs-slc">(</strong>
<strong class="hljs-slc">            email=data</strong>
<strong class="hljs-slc">        )</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> qs.exists():</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">raise</strong><strong class="hljs-slc"> forms.ValidationError(</strong><strong class="hljs-string-slc">'Email already in use.'</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> data</strong>
</code></pre>
<p class="normal">In this case, we have added validation for the <code class="inlineCode">email</code> field that prevents users from changing their <a id="_idIndexMarker461"/>existing<a id="_idIndexMarker462"/> email address to an existing email address of another user. We exclude the current user from the QuerySet. Otherwise, the current email address of the user would be considered an existing email address, and the form won’t validate.</p>
<h1 class="heading-1" id="_idParaDest-167">Adding social authentication to your site</h1>
<p class="normal">Social authentication<a id="_idIndexMarker463"/> is a widely used feature that allows users to authenticate using their existing account of a service provider<a id="_idIndexMarker464"/> using <strong class="keyWord">single sign-on</strong> (<strong class="keyWord">SSO</strong>). The authentication process allows users to authenticate into the site using their existing account from social services like Google, Facebook, or Twitter. In this section, we will add social authentication to the site using Google.</p>
<p class="normal">To implement social authentication, we will use the <strong class="keyWord">OAuth 2.0</strong> industry-standard protocol for authorization. <strong class="keyWord">OAuth</strong> stands <a id="_idIndexMarker465"/>for <strong class="keyWord">Open Authorization</strong>. OAuth 2.0 is a standard designed to allow a website or application to access resources hosted by other web apps on behalf of a user. Google uses the OAuth 2.0 protocol for authentication and authorization.</p>
<p class="normal">Python Social Auth is a Python module that simplifies the process of adding social authentication to your website. Using this module, you can let your users log in to your website using their accounts from other services. You can find the code for this module at <a href="https://github.com/python-social-auth/social-app-django">https://github.com/python-social-auth/social-app-django</a>.</p>
<p class="normal">This module comes with authentication backends for different Python frameworks, including Django.</p>
<p class="normal">Run the<a id="_idIndexMarker466"/> following command in the shell:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install social-auth-app-django==5.4.0
</code></pre>
<p class="normal">This will install Python Social Auth.</p>
<p class="normal">Then, add <code class="inlineCode">social_django</code> to the <code class="inlineCode">INSTALLED_APPS</code> setting in the <code class="inlineCode">settings.py</code> file of the project as follows:</p>
<pre class="programlisting code"><code class="hljs-code">INSTALLED_APPS = [
    # ...
<strong class="hljs-string-slc">'social_django'</strong><strong class="hljs-slc">,</strong>
]
</code></pre>
<p class="normal">This is the default application to add Python Social Auth to Django projects. Now, run the following command to sync Python Social Auth models with your database:</p>
<pre class="programlisting con"><code class="hljs-con">python -m python manage.py migrate
</code></pre>
<p class="normal">You should see that the migrations for the default application are applied as follows:</p>
<pre class="programlisting con"><code class="hljs-con">Applying social_django.0001_initial... OK
...
Applying social_django .0015_rename_extra_data_new_usersocialauth_extra_data... OK
</code></pre>
<p class="normal">Python Social Auth includes authentication backends for multiple services. You can find the list with all available backends at <a href="https://python-social-auth.readthedocs.io/en/latest/backends/index.html#supported-backends">https://python-social-auth.readthedocs.io/en/latest/backends/index.html#supported-backends</a>.</p>
<p class="normal">We will add social authentication to our project, allowing our users to authenticate with the Google backend.</p>
<p class="normal">First, we need to add the social login URL patterns to the project.</p>
<p class="normal">Open the main <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">bookmarks</code> project and include the <code class="inlineCode">social_django</code> URL patterns as follows. The new lines are highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    path('admin/', admin.site.urls),
    path('account/', include('account.urls')),
    <strong class="hljs-slc">path(</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'social-auth/'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        include(</strong><strong class="hljs-string-slc">'social_django.urls'</strong><strong class="hljs-slc">, namespace=</strong><strong class="hljs-string-slc">'social'</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    ),</strong>
]
</code></pre>
<p class="normal">Our web application is currently accessible via the localhost IP, <code class="inlineCode">127.0.0.1</code>, or using the <code class="inlineCode">localhost</code> hostname. Google allows the redirection of users to <code class="inlineCode">localhost</code> after successful authentication, but other social services expect a domain name for the URL redirect. In this<a id="_idIndexMarker467"/> project, we will simulate a real environment by serving our site under a domain name in our local machine.</p>
<p class="normal">Locate the <code class="inlineCode">hosts</code> file of your machine. If you are using Linux or macOS, the <code class="inlineCode">hosts</code> file is located at <code class="inlineCode">/etc/hosts</code>. If you are using Windows, the <code class="inlineCode">hosts</code> file is located at <code class="inlineCode">C:\Windows\System32\Drivers\etc\hosts</code>.</p>
<p class="normal">Edit the <code class="inlineCode">hosts</code> file of your machine and add the following line to it:</p>
<pre class="programlisting con"><code class="hljs-con">127.0.0.1 mysite.com
</code></pre>
<p class="normal">This will tell your computer to point the <code class="inlineCode">mysite.com</code> hostname to your own machine.</p>
<p class="normal">Let’s verify that the hostname association worked. Run the development server using the following command from the shell prompt:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://mysite.com:8000/account/login/</code> in your browser. You will see the following error:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_05_04.png"/></figure>
<p class="packt_figref">Figure 5.4: The invalid host header message</p>
<p class="normal">Django controls the hosts that can serve the application using the <code class="inlineCode">ALLOWED_HOSTS</code> setting. This is a security measure to prevent HTTP host header attacks. Django will only allow the hosts included in this list to serve the application.</p>
<p class="normal">You can learn more about the <code class="inlineCode">ALLOWED_HOSTS</code> setting at <a href="https://docs.djangoproject.com/en/5.0/ref/settings/#allowed-hosts">https://docs.djangoproject.com/en/5.0/ref/settings/#allowed-hosts</a>.</p>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of the project and modify the <code class="inlineCode">ALLOWED_HOSTS</code> setting as follows. The new code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">ALLOWED_HOSTS = [<strong class="hljs-string-slc">'mysite.com'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'localhost'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'127.0.0.1'</strong>]
</code></pre>
<p class="normal">Besides the <code class="inlineCode">mysite.com</code> host, we have explicitly included <code class="inlineCode">localhost</code> and <code class="inlineCode">127.0.0.1</code>. This allows access to the site through <code class="inlineCode">localhost</code> and <code class="inlineCode">127.0.0.1</code>, which is the default Django behavior when <code class="inlineCode">DEBUG</code> is <code class="inlineCode">True</code> and <code class="inlineCode">ALLOWED_HOSTS</code> is empty.</p>
<p class="normal">Open <code class="inlineCode">http://mysite.com:8000/account/login/</code> again in your browser. Now, you should see the <a id="_idIndexMarker468"/>login page of the site instead of an error.</p>
<h2 class="heading-2" id="_idParaDest-168">Running the development server through HTTPS</h2>
<p class="normal">Next, we are going<a id="_idIndexMarker469"/> to run the development server through HTTPS to simulate a real environment where the content exchanged with the browser is secured. This will help us later in <em class="chapterRef">Chapter 6</em>, <em class="italic">Sharing Content on Your Website</em>, to serve our site securely and load our image bookmarking tool on top of any secure website. The <strong class="keyWord">Transport Layer Security</strong> (<strong class="keyWord">TLS</strong>) protocol is the standard for serving websites through a secure connection. The TLS predecessor is the <strong class="keyWord">Secure Sockets Layer</strong> (<strong class="keyWord">SSL</strong>).</p>
<p class="normal">Although SSL is now deprecated, you will find references to both the terms TLS and SSL in multiple libraries and online documentation. The Django development server is not able to serve your site through HTTPS since that is not its intended use. To test the social authentication functionality serving the site through HTTPS, we are going to use the RunServerPlus extension of the package Django Extensions. This package contains a collection of useful Django tools. Please note that you should never use the development server to run your site in a production environment.</p>
<p class="normal">Use the following command to install Django Extensions:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install django-extensions==3.2.3
</code></pre>
<p class="normal">You will need to install Werkzeug, which contains a debugger layer required by the RunServerPlus extension of Django Extensions. Use the following command to install Werkzeug:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install werkzeug==3.0.2
</code></pre>
<p class="normal">Finally, use the<a id="_idIndexMarker470"/> following command to install pyOpenSSL, which is required to use the SSL/TLS functionality of RunServerPlus:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install pyOpenSSL==24.1.0
</code></pre>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of your project and add Django Extensions to the <code class="inlineCode">INSTALLED_APPS</code> setting, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">INSTALLED_APPS = [
    # ...
<strong class="hljs-string-slc">'django_extensions'</strong><strong class="hljs-slc">,</strong>
]
</code></pre>
<p class="normal">Now, use the <code class="inlineCode">runserver_plus</code> management command provided by Django Extensions to run the development server, as follows:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver_plus --cert-file cert.crt
</code></pre>
<p class="normal">We have provided a file name to the <code class="inlineCode">runserver_plus</code> command for the SSL/TLS certificate. Django Extensions will generate a key and certificate automatically.</p>
<p class="normal">Open <code class="inlineCode">https://mysite.com:8000/account/login/</code> in your browser. Now, you are accessing your site through HTTPS. Note we are now using <code class="inlineCode">https://</code> instead of <code class="inlineCode">http://</code>.</p>
<p class="normal">Your browser will show a security warning because you are using a self-generated certificate instead of a certificate trusted by a <strong class="screenText">certification authority</strong> (<strong class="screenText">CA</strong>).</p>
<p class="normal">If you are using <a id="_idIndexMarker471"/>Google Chrome, you will see the following screen:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_05_05.png"/></figure>
<p class="packt_figref">Figure 5.5: The safety error in Google Chrome</p>
<p class="normal">In this case, click on <strong class="screenText">Advanced</strong> and then click on <strong class="screenText">Proceed to mysite.com (unsafe)</strong>.</p>
<p class="normal">If you are using Safari, you will see the following screen:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="img/B21088_05_06.png"/></figure>
<p class="packt_figref">Figure 5.6: The safety error in Safari</p>
<p class="normal">In this case, click on <strong class="screenText">Show details</strong> and then click on <strong class="screenText">visit this website</strong>.</p>
<p class="normal">If you are using<a id="_idIndexMarker472"/> Microsoft Edge, you will see the following screen:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="img/B21088_05_07.png"/></figure>
<p class="packt_figref">Figure 5.7: The safety error in Microsoft Edge</p>
<p class="normal">In this case, click on <strong class="screenText">Advanced</strong> and then on <strong class="screenText">Continue to mysite.com (unsafe)</strong>.</p>
<p class="normal">If you are using any other browser, access the advanced information displayed by your browser and accept the self-signed certificate so that your browser trusts the certificate.</p>
<p class="normal">You will see that the URL starts with <code class="inlineCode">https://</code> and, in some cases, a lock icon that indicates that the connection is secure. Some browsers might display a broken lock icon because you are using a self-signed certificate instead of a trusted one. That won’t be a problem for our tests:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_05_08.png"/></figure>
<p class="packt_figref">Figure 5.8: The URL with the secured connection icon</p>
<div><p class="normal">Django Extensions includes many other interesting tools and features. You can find more information about this package at https://django-extensions.readthedocs.io/en/latest/.</p>
</div>
<p class="normal">You can now <a id="_idIndexMarker473"/>serve your site through HTTPS during development.</p>
<h2 class="heading-2" id="_idParaDest-169">Authentication using Google</h2>
<p class="normal">Google offers social<a id="_idIndexMarker474"/> authentication <a id="_idIndexMarker475"/>using OAuth 2.0, which allows users to sign in with Google accounts. You can read about Google’s OAuth2 implementation at <a href="https://developers.google.com/identity/protocols/OAuth2">https://developers.google.com/identity/protocols/OAuth2</a>.</p>
<p class="normal">To implement authentication using Google, add the following line highlighted in bold to the <code class="inlineCode">AUTHENTICATION_BACKENDS</code> setting in the <code class="inlineCode">settings.py</code> file of your project:</p>
<pre class="programlisting code"><code class="hljs-code">AUTHENTICATION_BACKENDS = [
    'django.contrib.auth.backends.ModelBackend',
    'account.authentication.EmailAuthBackend',
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'social_core.backends.google.GoogleOAuth2'</strong><strong class="hljs-slc">,</strong>
]
</code></pre>
<p class="normal">First, you will need to create an API key in your Google Developer Console. Open <a href="https://console.cloud.google.com/projectcreate">https://console.cloud.google.com/projectcreate</a> in your browser. You will see the following screen:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_05_09.png"/></figure>
<p class="packt_figref">Figure 5.9: The Google project creation form</p>
<p class="normal">Under <strong class="screenText">Project name</strong>, enter <code class="inlineCode">Bookmarks</code> and click the <strong class="screenText">CREATE</strong> button.</p>
<p class="normal">When the new<a id="_idIndexMarker476"/> project is ready, make sure<a id="_idIndexMarker477"/> the project is selected in the top navigation bar as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_05_10.png"/></figure>
<p class="packt_figref">Figure 5.10: The Google Developer Console top navigation bar</p>
<p class="normal">After the project is created, under <strong class="screenText">APIs &amp; Services</strong>, click on <strong class="screenText">Credentials</strong>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_05_11.png"/></figure>
<p class="packt_figref">Figure 5.11: Google APIs and services menu</p>
<p class="normal">You will see <a id="_idIndexMarker478"/>the<a id="_idIndexMarker479"/> following screen:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_05_12.png"/></figure>
<p class="packt_figref">Figure 5.12: Google API creation of API credentials</p>
<p class="normal">Then, click on <strong class="screenText">CREATE CREDENTIALS</strong> and click on <strong class="screenText">OAuth client ID</strong>.</p>
<p class="normal">Google will ask you to configure the consent screen first, like this:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_05_13.png"/></figure>
<p class="packt_figref">Figure 5.13: The alert to configure the OAuth consent screen</p>
<p class="normal">We will configure the page that will be shown to users to give their consent to access your site with<a id="_idIndexMarker480"/> their Google account. Click<a id="_idIndexMarker481"/> on the <strong class="screenText">CONFIGURE CONSENT SCREEN</strong> button. You will be redirected to the following screen:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="img/B21088_05_14.png"/></figure>
<p class="packt_figref">Figure 5.14: The User Type selection in the Google OAuth consent screen setup</p>
<p class="normal">Choose <strong class="screenText">External</strong> for <strong class="screenText">User Type </strong>and click the <strong class="screenText">CREATE</strong> button. You will see the following screen:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="img/B21088_05_15.png"/></figure>
<p class="packt_figref">Figure 5.15: The Google OAuth consent screen setup</p>
<p class="normal">Under <strong class="screenText">App name</strong>, enter <code class="inlineCode">Bookmarks</code> and select <a id="_idIndexMarker482"/>your<a id="_idIndexMarker483"/> email for <strong class="screenText">User support email</strong>.</p>
<p class="normal">Under <strong class="screenText">Authorised domains</strong>, enter <code class="inlineCode">mysite.com</code> as follows:</p>
<figure class="mediaobject"><img alt="Text  Description automatically generated with low confidence" src="img/B21088_05_16.png"/></figure>
<p class="packt_figref">Figure 5.16: Google OAuth authorized domains</p>
<p class="normal">Enter your email under <strong class="screenText">Developer contact information</strong> and click on <strong class="screenText">SAVE AND CONTINUE</strong>.</p>
<p class="normal">In step 2,<strong class="screenText"> Scopes</strong>, don’t change anything and click on <strong class="screenText">SAVE AND CONTINUE</strong>.</p>
<p class="normal">In step 3,<strong class="screenText"> Test users, </strong>add your Google<a id="_idIndexMarker484"/> user to <strong class="screenText">Test users</strong> and click on <strong class="screenText">SAVE AND CONTINUE</strong> as <a id="_idIndexMarker485"/>follows:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="img/B21088_05_17.png"/></figure>
<p class="packt_figref">Figure 5.17: Google OAuth test users</p>
<p class="normal">You will see a summary of your consent screen configuration. Click on <strong class="screenText">BACK TO DASHBOARD</strong>.</p>
<p class="normal">In the menu on the left sidebar, click on <strong class="screenText">Credentials</strong>, click again on <strong class="screenText">Create credentials</strong>, and then on <strong class="screenText">OAuth client ID</strong>.</p>
<p class="normal">As the next step, enter the following information:</p>
<ul>
<li class="bulletList"><strong class="screenText">Application type</strong>: Select <strong class="screenText">Web application</strong></li>
<li class="bulletList"><strong class="screenText">Name</strong>: Enter <code class="inlineCode">Bookmarks</code></li>
<li class="bulletList"><strong class="screenText">Authorised JavaScript origins</strong>: Add <code class="inlineCode">https://mysite.com:8000</code></li>
<li class="bulletList"><strong class="screenText">Authorised redirect URIs</strong>: Add <code class="inlineCode">https://mysite.com:8000/social-auth/complete/google-oauth2/</code></li>
</ul>
<p class="normal">The <a id="_idIndexMarker486"/>form <a id="_idIndexMarker487"/>should look like this:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="img/B21088_05_18.png"/></figure>
<p class="packt_figref">Figure 5.18: The Google OAuth client ID creation form</p>
<p class="normal">Click the <strong class="screenText">CREATE</strong> button. You will get the <strong class="screenText">Client ID</strong> and <strong class="screenText">Client secret</strong> keys:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_05_19.png"/></figure>
<p class="packt_figref">Figure 5.19: Google OAuth – Client ID and Client secret</p>
<p class="normal">Create a new <a id="_idIndexMarker488"/>file inside your project’s root <a id="_idIndexMarker489"/>directory and name it <code class="inlineCode">.env</code>. The <code class="inlineCode">.env</code> file will contain key-value pairs of environment variables. Add the OAuth2 credentials to the new file, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">GOOGLE_OAUTH2_KEY=xxxx
GOOGLE_OAUTH2_SECRET=xxxx
</code></pre>
<p class="normal">Replace <code class="inlineCode">xxxx</code> with the OAuth2 key and secret respectively.</p>
<p class="normal">To facilitate the separation of configuration from code, we are going to use <code class="inlineCode">python-decouple</code>. You already used this library in <em class="chapterRef">Chapter 2</em>, <em class="italic">Enhancing Your Blog and Adding Social Features</em>.</p>
<p class="normal">Install <code class="inlineCode">python-decouple</code> via <code class="inlineCode">pip</code> by running the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install python-decouple==3.8
</code></pre>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of your project and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> decouple </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> config</strong>
# ...
<strong class="hljs-slc">SOCIAL_AUTH_GOOGLE_OAUTH2_KEY = config(</strong><strong class="hljs-string-slc">'GOOGLE_OAUTH2_KEY'</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">SOCIAL_AUTH_GOOGLE_OAUTH2_SECRET = config(</strong><strong class="hljs-string-slc">'GOOGLE_OAUTH2_SECRET'</strong><strong class="hljs-slc">)</strong>
</code></pre>
<p class="normal">The <code class="inlineCode">SOCIAL_AUTH_GOOGLE_OAUTH2_KEY</code> and <code class="inlineCode">SOCIAL_AUTH_GOOGLE_OAUTH2_SECRET</code> settings are loaded from the environment variables defined in the <code class="inlineCode">.env</code> file.</p>
<p class="normal">Edit the <code class="inlineCode">registration/login.html</code> template of the <code class="inlineCode">account</code> application and append the following code <a id="_idIndexMarker490"/>highlighted in bold at the bottom of the <code class="inlineCode">content</code> block:</p>
<pre class="programlisting code"><code class="hljs-code">{% block content %}
  ...
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">div</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"social"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">ul</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">li</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"google"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">href</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"{% url "</strong><strong class="hljs-attr-slc">social:begin</strong><strong class="hljs-tag-slc">"</strong><strong class="hljs-tag-slc"> "</strong><strong class="hljs-attr-slc">google-oauth2</strong><strong class="hljs-tag-slc">" %}"&gt;</strong>
<strong class="hljs-slc">          Sign in with Google</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">li</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">ul</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">div</strong><strong class="hljs-tag-slc">&gt;</strong>
{% endblock %}
</code></pre>
<p class="normal">Use the <code class="inlineCode">runserver_plus</code> management command provided by Django Extensions to run the development server, as follows:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver_plus --cert-file cert.crt
</code></pre>
<p class="normal">Open <code class="inlineCode">https://mysite.com:8000/account/login/</code> in your browser. The login page should now look as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_05_20.png"/></figure>
<p class="packt_figref">Figure 5.20: The login page including the button for Google authentication</p>
<p class="normal">Click on<a id="_idIndexMarker491"/> the <strong class="screenText">Sign in with Google</strong> button. You<a id="_idIndexMarker492"/> will see the following screen:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_05_21.png"/></figure>
<p class="packt_figref">Figure 5.21: The Google application authorization screen</p>
<p class="normal">Click on your Google account to authorize the application. You will be logged in and redirected to the dashboard page of your site. Remember that you have set this URL in the <code class="inlineCode">LOGIN_REDIRECT_URL</code> setting. As you can see, adding social authentication to your site is pretty straightforward.</p>
<p class="normal">You have now added social authentication to your project with Google. You can easily implement social <a id="_idIndexMarker493"/>authentication with <a id="_idIndexMarker494"/>other online services using Python Social Auth. In the next section, we will address creating user profiles when registering with social authentication.</p>
<h2 class="heading-2" id="_idParaDest-170">Creating a profile for users that register with social authentication</h2>
<p class="normal">When a user <a id="_idIndexMarker495"/>authenticates using social authentication, a new <code class="inlineCode">User</code> object is created if there isn’t an existing user associated with that social profile. Python Social Auth uses a pipeline consisting of a set of functions that are executed in a specific order during the authentication flow. These functions take care of retrieving any user details, creating a social profile in the database, and associating it with an existing user or creating a new one.</p>
<p class="normal">Currently, no <code class="inlineCode">Profile</code> object is created when new users are created via social authentication. We will add a new step to the pipeline to automatically create a <code class="inlineCode">Profile</code> object in the database when a new user is created.</p>
<p class="normal">Add the following <code class="inlineCode">SOCIAL_AUTH_PIPELINE</code> setting to the <code class="inlineCode">settings.py</code> file of your project:</p>
<pre class="programlisting code"><code class="hljs-code">SOCIAL_AUTH_PIPELINE = [
    'social_core.pipeline.social_auth.social_details',
    'social_core.pipeline.social_auth.social_uid',
    'social_core.pipeline.social_auth.auth_allowed',
    'social_core.pipeline.social_auth.social_user',
    'social_core.pipeline.user.get_username',
    'social_core.pipeline.user.create_user',
    'social_core.pipeline.social_auth.associate_user',
    'social_core.pipeline.social_auth.load_extra_data',
    'social_core.pipeline.user.user_details',
]
</code></pre>
<p class="normal">This is the default authentication pipeline used by Python Social Auth. It consists of several functions that perform different tasks when authenticating a user. You can find more details about the default authentication pipeline at <a href="https://python-social-auth.readthedocs.io/en/latest/pipeline.html">https://python-social-auth.readthedocs.io/en/latest/pipeline.html</a>.</p>
<p class="normal">Let’s build a function that creates a <code class="inlineCode">Profile</code> object in the database whenever a new user is created. We will then add this function to the social authentication pipeline.</p>
<p class="normal">Edit the <code class="inlineCode">account/authentication.py</code> file and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from account.models import Profile
def create_profile(backend, user, *args, **kwargs):
    """
    Create user profile for social authentication
    """
    Profile.objects.get_or_create(user=user)
</code></pre>
<p class="normal">The <code class="inlineCode">create_profile</code> function<a id="_idIndexMarker496"/> takes two required arguments:</p>
<ul>
<li class="bulletList"><code class="inlineCode">backend</code>: The social auth backend used for user authentication. Remember that you added the social authentication backends to the <code class="inlineCode">AUTHENTICATION_BACKENDS</code> setting in your project.</li>
<li class="bulletList"><code class="inlineCode">user</code>: The <code class="inlineCode">User</code> instance of the new or existing authenticated user.</li>
</ul>
<p class="normal">You can check the different arguments that are passed to the pipeline functions at <a href="https://python-social-auth.readthedocs.io/en/latest/pipeline.html#extending-the-pipeline">https://python-social-auth.readthedocs.io/en/latest/pipeline.html#extending-the-pipeline</a>.</p>
<p class="normal">In the <code class="inlineCode">create_profile</code> function, we check that a <code class="inlineCode">user</code> object is present and we use the <code class="inlineCode">get_or_create()</code> method to look up a <code class="inlineCode">Profile</code> object for the given user, and we create one if necessary.</p>
<p class="normal">Now, we need to add the new function to the authentication pipeline. Add the following line highlighted in bold to the <code class="inlineCode">SOCIAL_AUTH_PIPELINE</code> setting in your <code class="inlineCode">settings.py</code> file:</p>
<pre class="programlisting code"><code class="hljs-code">SOCIAL_AUTH_PIPELINE = [
    'social_core.pipeline.social_auth.social_details',
    'social_core.pipeline.social_auth.social_uid',
    'social_core.pipeline.social_auth.auth_allowed',
    'social_core.pipeline.social_auth.social_user',
    'social_core.pipeline.user.get_username',
    'social_core.pipeline.user.create_user',
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'account.authentication.create_profile'</strong><strong class="hljs-slc">,</strong>
'social_core.pipeline.social_auth.associate_user',
    'social_core.pipeline.social_auth.load_extra_data',
    'social_core.pipeline.user.user_details',
]
</code></pre>
<p class="normal">We have added the <code class="inlineCode">create_profile</code> function after <code class="inlineCode">social_core.pipeline.create_user</code>. At this point, a <code class="inlineCode">User</code> instance is available. The user can be an existing user or a new one created in this step of the pipeline. The <code class="inlineCode">create_profile</code> function uses the <code class="inlineCode">User</code> instance to look up the related <code class="inlineCode">Profile</code> object and create a new one if necessary.</p>
<p class="normal">Access the user list in the administration site at <code class="inlineCode">https://mysite.com:8000/admin/auth/user/</code>. Remove any users created through social authentication.</p>
<p class="normal">Then, open <code class="inlineCode">https://mysite.com:8000/account/login/</code> and perform social authentication for the user you deleted. A new user will be created and now a <code class="inlineCode">Profile</code> object will be created as well. Access <code class="inlineCode">https://mysite.com:8000/admin/account/profile/</code> to verify that a profile has been created for the new user.</p>
<p class="normal">We have successfully added the functionality to create the user profile automatically for social authentication.</p>
<p class="normal">Python Social <a id="_idIndexMarker497"/>Auth also offers a pipeline mechanism for the disconnection flow. You can find more details at <a href="https://python-social-auth.readthedocs.io/en/latest/pipeline.html#disconnection-pipeline">https://python-social-auth.readthedocs.io/en/latest/pipeline.html#disconnection-pipeline</a>.</p>
<h1 class="heading-1" id="_idParaDest-171">Summary</h1>
<p class="normal">In this chapter, you significantly improved your social site authentication capabilities by creating an email-based authentication backend and adding social authentication with Google. You also improved the user experience by providing feedback for their actions using the Django messages framework. Finally, you customized the authentication pipeline to create user profiles for new users automatically.</p>
<p class="normal">In the next chapter, you will create an image bookmarking system. You will learn about many-to-many relationships and customizing the behavior of forms. You will learn how to generate image thumbnails and how to build AJAX functionalities using JavaScript and Django.</p>
<h1 class="heading-1" id="_idParaDest-172">Additional resources</h1>
<p class="normal">The following resources provide additional information related to the topics covered in this chapter:</p>
<ul>
<li class="bulletList">Source code for this chapter – <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter05">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter05</a></li>
<li class="bulletList">The Django messages framework – <a href="https://docs.djangoproject.com/en/5.0/ref/contrib/messages/">https://docs.djangoproject.com/en/5.0/ref/contrib/messages/</a></li>
<li class="bulletList">Custom authentication sources – <a href="https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#other-authentication-sources">https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#other-authentication-sources</a></li>
<li class="bulletList">Automatic primary key fields – <a href="https://docs.djangoproject.com/en/5.0/topics/db/models/#automatic-primary-key-fields">https://docs.djangoproject.com/en/5.0/topics/db/models/#automatic-primary-key-fields</a></li>
<li class="bulletList">Python Social Auth – <a href="https://github.com/python-social-auth">https://github.com/python-social-auth</a></li>
<li class="bulletList">Python Social Auth’s authentication backends – <a href="https://python-social-auth.readthedocs.io/en/latest/backends/index.html#supported-backends">https://python-social-auth.readthedocs.io/en/latest/backends/index.html#supported-backends</a></li>
<li class="bulletList">Django allowed hosts setting – <a href="https://docs.djangoproject.com/en/5.0/ref/settings/#allowed-hosts">https://docs.djangoproject.com/en/5.0/ref/settings/#allowed-hosts</a></li>
<li class="bulletList">Django Extensions documentation – <a href="https://django-extensions.readthedocs.io/en/latest/">https://django-extensions.readthedocs.io/en/latest/</a></li>
<li class="bulletList">Google’s OAuth2 implementation – <a href="https://developers.google.com/identity/protocols/OAuth2">https://developers.google.com/identity/protocols/OAuth2</a></li>
<li class="bulletList">Google API credentials – <a href="https://console.developers.google.com/apis/credentials">https://console.developers.google.com/apis/credentials</a></li>
<li class="bulletList">Python Social Auth pipeline – <a href="https://python-social-auth.readthedocs.io/en/latest/pipeline.html">https://python-social-auth.readthedocs.io/en/latest/pipeline.html</a></li>
<li class="bulletList">Extending the Python Social Auth pipeline – <a href="https://python-social-auth.readthedocs.io/en/latest/pipeline.html#extending-the-pipeline">https://python-social-auth.readthedocs.io/en/latest/pipeline.html#extending-the-pipeline</a></li>
<li class="bulletList">Python Social Auth pipeline for disconnection – <a href="https://python-social-auth.readthedocs.io/en/latest/pipeline.html#disconnection-pipeline">https://python-social-auth.readthedocs.io/en/latest/pipeline.html#disconnection-pipeline</a></li>
</ul>
</div>
</body></html>