- en: 8\. Media Serving and File Uploads
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 8. 媒体服务和文件上传
- en: Overview
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 概述
- en: This chapter starts by introducing you to media files and then teaching you
    how to set up Django to serve them. Once you have understood this, you will learn
    how to build a form in HTML that can upload files to a view for storage to disk.
    To enhance this process and reduce the amount of code, you will use Django forms
    to generate and validate a form and learn how to process file uploads through
    it. You will then look at some enhancements that Django provides specifically
    for working with image files and use the `FileField` and `ImageField` to store
    a file and image respectively and upload to it using a Django form. After this,
    you will build a `ModelForm` instance automatically from the model and save the
    model and the files using just one line of code. At the end of this chapter, you
    will enhance the Bookr app by adding a cover image and book excerpt to the `Book`
    model.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 本章首先向您介绍媒体文件，然后教您如何设置Django以服务它们。一旦您理解了这一点，您将学习如何使用HTML构建一个表单，该表单可以将文件上传到一个视图以存储到磁盘。为了增强这个过程并减少代码量，您将使用Django表单来生成和验证表单，并学习如何通过它处理文件上传。然后，您将查看Django为处理图像文件提供的特定增强功能，并使用`FileField`和`ImageField`分别存储文件和图像，并通过Django表单上传它们。在此之后，您将自动从模型构建一个`ModelForm`实例，并仅用一行代码保存模型和文件。在本章结束时，您将通过向`Book`模型添加封面图像和书籍摘录来增强Bookr应用。
- en: Introduction
  id: totrans-3
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 简介
- en: Media files refer to extra files that can be added after deployment to enrich
    your Django application. Usually, they are extra images that you would use in
    your site, but any type of file (including video, audio, PDF, text, documents,
    or even HTML) can be served as media.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 媒体文件是指在部署后可以添加的额外文件，用于丰富您的Django应用。通常，它们是您在网站上使用的额外图像，但任何类型的文件（包括视频、音频、PDF、文本、文档，甚至是HTML）都可以作为媒体提供服务。
- en: You can think of them as somewhere between dynamic data and static assets. They
    are not dynamic data that Django generates on the fly, like when rendering a template.
    They also are not the static files that are included by the site developer when
    the site is deployed. Instead, they are extra files that can be uploaded by users
    or generated by your application for later retrieval.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以将它们视为介于动态数据和静态资产之间。它们不是Django在动态生成时产生的动态数据，例如在渲染模板时。它们也不是网站开发者在网站部署时包含的静态文件。相反，它们是可以由用户上传或由您的应用程序生成以供以后检索的额外文件。
- en: Some common examples of media files (that you will see in *Activity 8.01*, *Image
    and PDF Uploads of Books*, later in this chapter) are book covers and preview
    PDFs that can be attached to a `Book` object. You can also use media files to
    allow users to upload images for a blog post or avatars for a social media site.
    If you wanted to use Django to build your own video sharing platform, you would
    store the uploaded videos as media. Your website will not function well if all
    these files are static files, as users won't be able to upload their own book
    covers, videos, and so on, and will be stuck with the ones you deployed.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 媒体文件的常见示例（您将在本章后面的*活动8.01*、*书籍图像和PDF上传*中看到）包括书籍封面和可以附加到`Book`对象的预览PDF。您还可以使用媒体文件允许用户上传博客文章的图像或社交媒体网站的头像。如果您想使用Django构建自己的视频分享平台，您将存储上传的视频作为媒体。如果所有这些文件都是静态文件，您的网站将无法很好地运行，因为用户将无法上传自己的书籍封面、视频等，并将陷入您部署的状态。
- en: Settings for Media Uploads and Serving
  id: totrans-7
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 媒体上传和服务的设置
- en: 'In *Chapter 5*, *Serving Static Files*, we looked at how Django can be used
    to serve static files. Serving media files is quite similar. Two settings must
    be configured in `settings.py`: `MEDIA_ROOT` and `MEDIA_URL`. These are analogous
    to `STATIC_ROOT` and `STATIC_URL` for serving static files.'
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 在*第5章*，*服务静态文件*中，我们探讨了如何使用Django来服务静态文件。服务媒体文件相当类似。必须在`settings.py`中配置两个设置：`MEDIA_ROOT`和`MEDIA_URL`。这些与用于服务静态文件的`STATIC_ROOT`和`STATIC_URL`类似。
- en: '`MEDIA_ROOT`'
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`MEDIA_ROOT`'
- en: This is the path on the disk where the media (such as uploaded files) will be
    stored. As with static files, your web server should be configured to serve directly
    from this directory, to take the load off Django.
  id: totrans-10
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这是磁盘上存储媒体（如上传的文件）的路径。与静态文件一样，您的Web服务器应该配置为直接从这个目录提供服务，以减轻Django的负担。
- en: '`MEDIA_URL`'
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`MEDIA_URL`'
- en: This is similar to `STATIC_URL`, but as you might guess, it's the URL that should
    be used to serve media. It must end in a `/`. Generally, you will use something
    like `/media/`.
  id: totrans-12
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这与`STATIC_URL`类似，但正如您可能猜到的，这是应该用于服务媒体的URL。它必须以`/`结尾。通常，您将使用类似`/media/`的东西。
- en: Note
  id: totrans-13
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 注意
- en: For security reasons, the path for `MEDIA_ROOT` must not be the same as the
    path for `STATIC_ROOT`, and `MEDIA_URL` must not be the same as `STATIC_URL`.
    If they were the same, a user might replace your static files (such as JavaScript
    or CSS files) with malicious code and exploit your users.
  id: totrans-14
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 由于安全原因，`MEDIA_ROOT` 的路径必须与 `STATIC_ROOT` 的路径不同，并且 `MEDIA_URL` 必须与 `STATIC_URL`
    不同。如果它们相同，用户可能会用恶意代码替换你的静态文件（如 JavaScript 或 CSS 文件），并利用你的用户。
- en: '`MEDIA_URL` is designed to be used in templates so that you are not hardcoding
    the URL and it can be changed easily. For example, you might want to set it to
    a specific host or `MEDIA_URL` in templates in an upcoming section.'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: '`MEDIA_URL` 设计用于在模板中使用，这样你就不需要硬编码 URL，并且可以轻松更改。例如，你可能希望将其设置为特定主机或在下文中的模板中的
    `MEDIA_URL`。'
- en: Serving Media Files in Development
  id: totrans-16
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 开发中服务媒体文件
- en: As with static files, when serving media in production, your web server should
    be configured to serve directly from the `MEDIA_ROOT` directory to prevent Django
    from being tied up servicing the request. The Django dev server can serve media
    files in development. However, unlike static files, the URL mapping and view is
    not set up automatically for media files.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 就像静态文件一样，在生产环境中服务媒体时，你的 Web 服务器应该配置为直接从 `MEDIA_ROOT` 目录服务，以防止 Django 被绑定在服务请求上。Django
    开发服务器可以在开发中服务媒体文件。然而，与静态文件不同，媒体文件的 URL 映射和视图不是自动设置的。
- en: 'Django provides the `static` URL mapping that can be added to your existing
    URL maps to serve media files. It is added to your `urls.py` file like this:'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: Django 提供了 `static` URL 映射，可以添加到现有的 URL 映射中，以服务媒体文件。它像这样添加到你的 `urls.py` 文件中：
- en: '[PRE0]'
  id: totrans-19
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: This will serve the `MEDIA_ROOT` setting defined in `settings.py` to the `MEDIA_URL`
    setting that is also defined there. The reason we check for `settings.DEBUG` before
    appending the map is so we don't add this map in production.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 这会将 `settings.py` 中定义的 `MEDIA_ROOT` 设置服务到那里也定义的 `MEDIA_URL` 设置。我们在添加映射之前检查 `settings.DEBUG`
    的原因是为了确保在生产环境中不添加此映射。
- en: For example, if your `MEDIA_ROOT` was set to `/var/www/bookr/media`, and your
    `MEDIA_URL` was set to `/media/`, then the `/var/www/bookr/media/image.jpg` file
    would be available at `http://127.0.0.1:8000/media/image.jpg`.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，如果你的 `MEDIA_ROOT` 设置为 `/var/www/bookr/media`，而你的 `MEDIA_URL` 设置为 `/media/`，那么
    `/var/www/bookr/media/image.jpg` 文件将在 `http://127.0.0.1:8000/media/image.jpg`
    处可用。
- en: The `static` URL map does not work when the Django `DEBUG` setting is `False`,
    and so it can't be used in production. However, as mentioned earlier, in production
    your web server should be serving these requests, so Django will not need to handle
    them.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 当 Django 的 `DEBUG` 设置为 `False` 时，`static` URL 映射不起作用，因此不能在生产环境中使用。然而，如前所述，在生产环境中，你的
    Web 服务器应该服务这些请求，因此 Django 不需要处理它们。
- en: In the first exercise, you will create and add a new `MEDIA_ROOT` and `MEDIA_URL`
    to your `settings.py` file. You will then add the `static` media serving URL map
    and add a test file to ensure media serving is configured correctly.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 在第一个练习中，你将在 `settings.py` 文件中创建并添加一个新的 `MEDIA_ROOT` 和 `MEDIA_URL`。然后，你将添加 `static`
    媒体服务 URL 映射，并添加一个测试文件以确保媒体服务配置正确。
- en: 'Exercise 8.01: Configuring Media Storage and Serving Media Files'
  id: totrans-24
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 练习 8.01：配置媒体存储和服务媒体文件
- en: In this exercise, you will set up a new Django project as an example project
    to use throughout this chapter. Then you'll configure it to be able to serve media
    files. You'll do this by creating a `media` directory and adding the `MEDIA_ROOT`
    and `MEDIA_URL` settings. Then you'll set up the URL mapping for `MEDIA_URL`.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个练习中，你将设置一个新的 Django 项目作为本章中使用的示例项目。然后，你将配置它以能够服务媒体文件。你将通过创建一个 `media` 目录并添加
    `MEDIA_ROOT` 和 `MEDIA_URL` 设置来实现这一点。然后，你将为 `MEDIA_URL` 设置 URL 映射。
- en: 'To check that everything is configured and being served correctly, you will
    put a test file inside the `media` directory:'
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 为了检查一切配置正确并且正确服务，你将在 `media` 目录中放置一个测试文件：
- en: 'As with the previous example Django projects you''ve set up, you can reuse
    the existing `bookr` virtual environment. In a terminal, activate the `bookr`
    virtual environment. Then, start a new project named `media_project`, using `django-admin.py`:'
  id: totrans-27
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 就像之前你设置的 Django 项目一样，你可以重用现有的 `bookr` 虚拟环境。在终端中激活 `bookr` 虚拟环境。然后，使用 `django-admin.py`
    启动一个名为 `media_project` 的新项目：
- en: '[PRE1]'
  id: totrans-28
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Change (or `cd`) into the `media_project` directory that was created, then
    use the `startapp` management command to start an app called `media_example`:'
  id: totrans-29
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 切换（或 `cd`）到创建的 `media_project` 目录，然后使用 `startapp` 管理命令启动一个名为 `media_example`
    的应用：
- en: '[PRE2]'
  id: totrans-30
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Open the `media_project` directory in PyCharm. Set up a run configuration for
    the `runserver` command in the same manner as for the other Django projects you''ve
    opened:![Figure 8.1: Runserver configuration'
  id: totrans-31
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在PyCharm中打开`media_project`目录。以与其他你打开的Django项目相同的方式设置`runserver`命令的运行配置：![图8.1：Runserver配置
- en: '](img/B15509_08_01.jpg)'
  id: totrans-32
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/B15509_08_01.jpg)'
- en: 'Figure 8.1: Runserver configuration'
  id: totrans-33
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图8.1：Runserver配置
- en: '*Figure 8.1* shows the `runserver` configuration of the project in PyCharm.'
  id: totrans-34
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '*图8.1*显示了PyCharm中项目的`runserver`配置。'
- en: 'Create a new directory named `media` inside the `media_project` project directory.
    Then, create a new file in this directory named `test.txt`. The directory structure
    of this will look like *Figure 8.2*:![Figure 8.2: media directory and test.txt
    layout'
  id: totrans-35
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在`media_project`项目目录内创建一个名为`media`的新目录。然后，在这个目录中创建一个名为`test.txt`的新文件。这个目录结构将看起来像*图8.2*：![图8.2：媒体目录和test.txt布局
- en: '](img/B15509_08_02.jpg)'
  id: totrans-36
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/B15509_08_02.jpg)'
- en: 'Figure 8.2: media directory and test.txt layout'
  id: totrans-37
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图8.2：媒体目录和test.txt布局
- en: '`test.txt` will also open automatically. Enter the text `Hello, world!` into
    it, then you can save and close the file.'
  id: totrans-38
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`test.txt`也会自动打开。将文本`Hello, world!`输入其中，然后你可以保存并关闭文件。'
- en: 'Open `settings.py` inside the `media_project` package directory. At the end
    of the file, add a setting for `MEDIA_ROOT`, using the path to the media directory
    you just created. Make sure to import the `os` module at the top of the file:'
  id: totrans-39
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在`media_project`包目录内打开`settings.py`。在文件末尾添加一个`MEDIA_ROOT`的设置，使用你刚刚创建的媒体目录的路径。确保在文件顶部导入`os`模块：
- en: '[PRE3]'
  id: totrans-40
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Then use it to join it to `BASE_DIR` using the `os.path.join` function:'
  id: totrans-41
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 然后使用`os.path.join`函数将其与`BASE_DIR`连接：
- en: '[PRE4]'
  id: totrans-42
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'Directly below the line added in *step 5*, add another setting for `MEDIA_URL`.
    This should just be `''/media/''`:'
  id: totrans-43
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在*步骤5*中添加的行下面，为`MEDIA_URL`添加另一个设置。这应该只是`'/media/'`：
- en: '[PRE5]'
  id: totrans-44
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'After this, save `settings.py`. Here''s what it should look like:'
  id: totrans-45
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 然后，保存`settings.py`。它应该看起来像这样：
- en: '[PRE6]'
  id: totrans-46
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'Open the `media_project` package''s `urls.py` file. After the `urlpatterns`
    definition, add the following code to add the media serving URL if running in
    `DEBUG` mode. First, you will need to import the Django settings and static serving
    view by adding the highlighted import lines above the `urlpatterns` definition:'
  id: totrans-47
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开`media_project`包的`urls.py`文件。在`urlpatterns`定义之后，添加以下代码以在`DEBUG`模式下运行时添加媒体服务URL。首先，您需要通过在`urlpatterns`定义上方添加突出显示的导入行来导入Django设置和静态服务视图：
- en: '[PRE7]'
  id: totrans-48
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'Then, add the following code right after your `urlpatterns` definition (refer
    to the code block in the previous step) to conditionally add a mapping from `MEDIA_URL`
    to the `static` view, which will serve from `MEDIA_ROOT`:'
  id: totrans-49
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 然后，在你的`urlpatterns`定义之后（参考上一步中的代码块）添加以下代码，以有条件地添加从`MEDIA_URL`到`static`视图的映射，它将从`MEDIA_ROOT`提供服务：
- en: '[PRE8]'
  id: totrans-50
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'You can now save this file. It should look like this: [http://packt.live/3nVUiPn](http://packt.live/3nVUiPn).'
  id: totrans-51
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 你现在可以保存这个文件了。它应该看起来像这样：[http://packt.live/3nVUiPn](http://packt.live/3nVUiPn)。
- en: 'Start the Django dev server if it is not already running, then visit `http://127.0.0.1:8000/media/test.txt`.
    If you did everything correctly, then you should see the text `Hello, world!`
    in your browser:![Figure 8.3: Serving a media file'
  id: totrans-52
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果Django开发服务器尚未运行，请启动它，然后访问`http://127.0.0.1:8000/media/test.txt`。如果你一切都做对了，那么你应该在你的浏览器中看到文本`Hello,
    world!`：![图8.3：服务媒体文件
- en: '](img/B15509_08_03.jpg)'
  id: totrans-53
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/B15509_08_03.jpg)'
- en: 'Figure 8.3: Serving a media file'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 图8.3：服务媒体文件
- en: If your browser looks like *Figure 8.3*, it means that the media files are being
    served from the `MEDIA_ROOT` directory. The `test.txt` file we created was just
    for testing, but we will use it in *Exercise 8.02*, *Template Settings and Using
    MEDIA_URL in Templates*, so don't delete it yet.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你的浏览器看起来像*图8.3*，这意味着媒体文件正在从`MEDIA_ROOT`目录提供服务。我们创建的`test.txt`文件只是为了测试，但我们将它在*练习8.02*，*模板设置和使用MEDIA_URL在模板中*中使用，所以现在不要删除它。
- en: In this exercise, we configured Django to serve media files. We served a test
    file just to make sure everything works as expected, and it did. We'll now look
    at how we can automatically generate media URLs in templates.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个练习中，我们配置了Django来服务媒体文件。我们只服务了一个测试文件以确保一切按预期工作，并且确实如此。我们现在将看看我们如何在模板中自动生成媒体URL。
- en: Context Processors and Using MEDIA_URL in Templates
  id: totrans-57
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 上下文处理器和在模板中使用MEDIA_URL
- en: 'To use `MEDIA_URL` in a template, we could pass it in through the rendering
    context dictionary, in our view. For example:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 要在模板中使用`MEDIA_URL`，我们可以在视图中通过渲染上下文字典传递它。例如：
- en: '[PRE9]'
  id: totrans-59
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: This will work, but the problem is that `MEDIA_URL` is a common variable that
    we might want to use in many places, and so we'd have to pass it through in practically
    every view.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 这将有效，但问题是`MEDIA_URL`是一个我们可能在许多地方想要使用的通用变量，因此我们几乎必须在每个视图中传递它。
- en: Instead, we can use a `render` call.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 相反，我们可以使用`render`调用。
- en: A context processor is a function that accepts one argument, the current request.
    It returns a dictionary of context information that will be merged with the dictionary
    that was passed to the `render` call.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 上下文处理器是一个接受一个参数的函数，即当前请求。它返回一个包含上下文信息的字典，该字典将与传递给`render`调用的字典合并。
- en: 'We can look at the source code of the `media` context processor, which illustrates
    how they work:'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以查看`media`上下文处理器的源代码，它说明了它们是如何工作的：
- en: '[PRE10]'
  id: totrans-64
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'With the media context processor activated, `MEDIA_URL` will be added to our
    context dictionaries. We could change our `render` call, seen previously, to this:'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 启用媒体上下文处理器后，`MEDIA_URL`将被添加到我们的上下文字典中。我们可以将之前看到的`render`调用更改为以下内容：
- en: '[PRE11]'
  id: totrans-66
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: The same data would be sent to the template, as the context processor would
    add `MEDIA_URL`.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 同样的数据将被发送到模板，因为上下文处理器会添加`MEDIA_URL`。
- en: 'The full module path to the `media` context processor is `django.template.context_processors.media`.
    Some examples of other context processors that Django provides are:'
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: '`media`上下文处理器的完整模块路径是`django.template.context_processors.media`。Django提供的其他上下文处理器的示例包括：'
- en: '`django.template.context_processors.debug`'
  id: totrans-69
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`django.template.context_processors.debug`'
- en: 'This returns the dictionary `{"DEBUG": settings.DEBUG}`.'
  id: totrans-70
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '这返回字典 `{"DEBUG": settings.DEBUG}`。'
- en: '`django.template.context_processors.request`'
  id: totrans-71
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`django.template.context_processors.request`'
- en: 'This returns the dictionary `{"request": request}`, that is, it just adds the
    current HTTP request to the context.'
  id: totrans-72
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '这将返回字典 `{"request": request}`，也就是说，它只是将当前的HTTP请求添加到上下文中。'
- en: To enable a context processor, its module path must be added to the `context_processors`
    option of your `TEMPLATES` setting. For example, to enable the media context processor,
    add `django.template.context_processors.media`. We will cover how to do this in
    detail in *Exercise 8.02*, *Template Settings and Using MEDIA_URL in Templates*.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 要启用上下文处理器，必须将其模块路径添加到`TEMPLATES`设置的`context_processors`选项中。例如，要启用媒体上下文处理器，请添加`django.template.context_processors.media`。我们将在*练习8.02*，*模板设置和使用MEDIA_URL在模板中*中详细说明如何做到这一点。
- en: 'Once the `media` context processor is enabled, the `MEDIA_URL` variable can
    be accessed inside a template just like a normal variable:'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦启用`media`上下文处理器，`MEDIA_URL`变量就可以像普通变量一样在模板中访问：
- en: '[PRE12]'
  id: totrans-75
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'You could use it, for example, to source an image:'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，您可以使用它来获取图像：
- en: '[PRE13]'
  id: totrans-77
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: Note that, unlike with static files, there is no template tag for loading media
    files (that is, there is no equivalent to the `{% static %}` template tag).
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，与静态文件不同，没有用于加载媒体文件的模板标签（也就是说，没有`{% static %}`模板标签的等效物）。
- en: 'Custom context processors can also be written. For example, referring back
    to the Bookr application that we have been building, we might want to show a list
    of the five latest reviews in a sidebar that''s on every page. A context processor
    like this would perform this:'
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 也可以编写自定义上下文处理器。例如，回顾我们一直在构建的Bookr应用，我们可能希望在每一页的侧边栏中显示最新的五条评论列表。这样的上下文处理器将执行以下操作：
- en: '[PRE14]'
  id: totrans-80
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: This would be saved in a file named `context_processors.py` in the Bookr project
    directory, then referred to in the `context_processors` setting by its module
    path, `context_processors.latest_reviews`. Or we could save it inside the `reviews`
    app and refer to it as `reviews.context_processors.latest_reviews`. It is up to
    you to decide whether a context processor should be considered project-wide or
    app-specific. However, bear in mind that regardless of where it is stored, once
    activated, it applies to all `render` calls for all apps.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 这将在Bookr项目目录下的名为`context_processors.py`的文件中保存，然后在`context_processors`设置中通过其模块路径`context_processors.latest_reviews`进行引用。或者我们也可以将其保存在`reviews`应用中，并作为`reviews.context_processors.latest_reviews`进行引用。是否将上下文处理器视为项目级或应用级取决于您。然而，请注意，无论其存储位置如何，一旦激活，它将应用于所有应用的`render`调用。
- en: A context processor can return a dictionary with multiple items, or even zero
    items. It would do this if it had conditions to only add items if certain criteria
    were met, for example, showing the latest reviews only if the user is logged in.
    Let's explore this in detail in the next exercise.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 上下文处理器可以返回包含多个项的字典，甚至可以是零项。如果它有条件，只有当满足某些标准时才添加项，例如，只有当用户登录时才显示最新的评论。让我们在下一项练习中详细探讨这一点。
- en: 'Exercise 8.02: Template Settings and Using MEDIA_URL in Templates'
  id: totrans-83
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 练习8.02：模板设置和使用模板中的MEDIA_URL
- en: 'In this exercise, you will continue with `media_project` and configure Django
    to automatically add the `MEDIA_URL` setting to every template. You do this by
    adding `django.template.context_processors.media` to the `TEMPLATES` `context_processors`
    setting. You''ll then add a template that uses this new variable, and an example
    view to render it. You will make changes to the view and template throughout the
    exercises in this chapter:'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个练习中，你将继续使用`media_project`并配置Django以自动将`MEDIA_URL`设置添加到每个模板中。你通过将`django.template.context_processors.media`添加到`TEMPLATES`的`context_processors`设置来实现这一点。然后，你将添加一个使用这个新变量的模板和一个示例视图来渲染它。你将在本章的练习中修改视图和模板：
- en: 'In PyCharm, open `settings.py`. First, you will need to add `media_example`
    to the `INSTALLED_APPS` setting, since it wasn''t done when the project was set up:'
  id: totrans-85
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在PyCharm中打开`settings.py`。首先，你需要将`media_example`添加到`INSTALLED_APPS`设置中，因为项目设置时没有完成：
- en: '[PRE15]'
  id: totrans-86
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE15]'
- en: About halfway down the file, you will find the `TEMPLATES` setting, which is
    a dictionary. Inside it is the item `OPTIONS` (another dictionary). Inside `OPTIONS`
    is the `context_processors` setting.
  id: totrans-87
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在文件大约一半的位置，你会找到`TEMPLATES`设置，它是一个字典。在这个字典中是`OPTIONS`项（另一个字典）。在`OPTIONS`中是`context_processors`设置。
- en: 'To the end of this list, add this:'
  id: totrans-88
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 将以下内容添加到列表末尾：
- en: '[PRE16]'
  id: totrans-89
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'The full list should look like this:'
  id: totrans-90
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 完整的列表应该看起来像这样：
- en: '[PRE17]'
  id: totrans-91
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'The complete file should look like this: [http://packt.live/3nVOpSx](http://packt.live/3nVOpSx).'
  id: totrans-92
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 完整的文件应该看起来像这样：[http://packt.live/3nVOpSx](http://packt.live/3nVOpSx)。
- en: 'Open the `media_example` app''s `views.py` and create a new view called `media_example`.
    For now, it can just render a template named `media-example.html` (you will create
    this in *step 5*). The entire code of the view function is like this:'
  id: totrans-93
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开`media_example`应用的`views.py`并创建一个名为`media_example`的新视图。目前，它只需渲染一个名为`media-example.html`的模板（你将在*步骤5*中创建它）。视图函数的整个代码如下：
- en: '[PRE18]'
  id: totrans-94
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'Save `views.py`. It should look like this: [http://packt.live/3pvEGCB](http://packt.live/3pvEGCB).'
  id: totrans-95
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 保存`views.py`。它应该看起来像这样：[http://packt.live/3pvEGCB](http://packt.live/3pvEGCB)。
- en: You need a URL mapping to the `media_example` view. Open the `media_project`
    package's `urls.py` file.
  id: totrans-96
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 你需要一个指向`media_example`视图的URL映射。打开`media_project`包的`urls.py`文件。
- en: 'First, `import` `media_example.views` with the other imports in the file:'
  id: totrans-97
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 首先，使用文件中的其他导入导入`media_example.views`：
- en: '[PRE19]'
  id: totrans-98
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'Then add a `path` into `urlpatterns` to map `media-example/` to the `media_example`
    view:'
  id: totrans-99
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 然后在`urlpatterns`中添加一个`path`，将`media-example/`映射到`media_example`视图：
- en: '[PRE20]'
  id: totrans-100
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'Your full `urlpatterns` should look like this code block:'
  id: totrans-101
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 你的完整`urlpatterns`应该像以下代码块所示：
- en: '[PRE21]'
  id: totrans-102
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE21]'
- en: You can save and close the file.
  id: totrans-103
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 你可以保存并关闭文件。
- en: 'Create a `templates` directory inside the `media_example` app directory. Then,
    create a new HTML file inside the `media_project` project''s `templates` directory.
    Select `HTML 5 file` and name the file `media-example.html`:![Figure 8.4: Create
    media-example.html'
  id: totrans-104
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在`media_example`应用目录内创建一个`templates`目录。然后，在`media_project`项目的`templates`目录内创建一个新的HTML文件。选择`HTML
    5 file`并将文件命名为`media-example.html`：![图8.4：创建media-example.html
- en: '](img/B15509_08_04.jpg)'
  id: totrans-105
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/B15509_08_04.jpg)'
- en: 'Figure 8.4: Create media-example.html'
  id: totrans-106
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图8.4：创建media-example.html
- en: 'The `media-example.html` file should open automatically. You are just going
    to add a link inside the file to the `test.txt` file you created in *Exercise
    8.01*, *Configuring Media Storage and Serving*. Inside the `<body>` element, add
    the highlighted code:'
  id: totrans-107
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`media-example.html`文件应该会自动打开。你只需要在文件内添加一个指向你在*练习8.01*，*配置媒体存储和提供媒体文件*中创建的`test.txt`文件的链接。在`<body>`元素中添加高亮代码：'
- en: '[PRE22]'
  id: totrans-108
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'Start the Django dev server if it is not already running, then visit `http://127.0.0.1:8000/media-example/`.
    You should see a simple page, like in *Figure 8.5*:![Figure 8.5: Basic media link
    page'
  id: totrans-109
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果Django开发服务器尚未运行，请启动它，然后访问`http://127.0.0.1:8000/media-example/`。你应该会看到一个简单的页面，就像*图8.5*所示：![图8.5：基本的媒体链接页面
- en: '](img/B15509_08_05.jpg)'
  id: totrans-110
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '](img/B15509_08_05.jpg)'
- en: 'Figure 8.5: Basic media link page'
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 图8.5：基本的媒体链接页面
- en: If you click the link, you will be taken to the `test.txt` display and see the
    `Hello, world!` text you created in *Exercise 8.01*, *Configuring Media Storage
    and Serving Media Files* (*Figure 8.3*). This means you have configured the Django
    `context_processors` settings correctly.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你点击链接，你将被带到`test.txt`显示页面，并看到你在*练习8.01*，*配置媒体存储和提供媒体文件*中创建的`Hello, world!`文本（*图8.3*）。这意味着你已经正确配置了Django的`context_processors`设置。
- en: We have finished with `test.txt`, so you can delete the file now. We will use
    the `media_example` view and template in the other exercises, so leave them around.
    In the next section, we will talk about how to upload files using a web browser,
    and how Django accesses them in a view.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
- en: File Uploads Using HTML Forms
  id: totrans-114
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In *Chapter 6*, *Forms*, we learned about HTML forms. We discussed how to use
    the `method` attribute of `<form>` for `GET` or `POST` requests. Though we have
    only submitted text data using a form so far, it is also possible to submit one
    or more files using a form.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
- en: 'When submitting files, we must ensure that there are at least two attributes
    on the form: `method` and `enctype`. You may still also need other attributes,
    such as `action`. A form that supports file uploads might look like this:'
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE23]'
  id: totrans-117
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: File uploads are only available for `POST` requests. They are not possible with
    `GET` requests as it would be impossible to send all the data for a file through
    a URL. The `enctype` attribute must be set to let the browser know it should send
    the form data as multiple parts, one part for the text data of the form, and separate
    parts for each of the files that have been attached to the form. This encoding
    is seamless to the user; they do not know how the browser is encoding the form,
    nor do they need to do anything different.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
- en: 'To attach files to a form, you need to create an input of type `file`. You
    can manually write the HTML code, like this:'
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE24]'
  id: totrans-120
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'When the input is rendered in the browser it looks like this when empty:'
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 8.6: Empty file input'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
- en: '](img/B15509_08_06.jpg)'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
- en: 'Figure 8.6: Empty file input'
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
- en: The title of the button might be different depending on your browser.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
- en: 'Clicking the `Browse…` button will display a *file open* dialog box:'
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 8.7: File browser on macOS'
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
- en: '](img/B15509_08_07.jpg)'
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
- en: 'Figure 8.7: File browser on macOS'
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
- en: 'And after selecting a file, the name of the file is shown in the field:'
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 8.8: File input with cover.jpg selected'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
- en: '](img/B15509_08_08.jpg)'
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
- en: 'Figure 8.8: File input with cover.jpg selected'
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 8.8* shows a file input with a file named `cover.jpg` having been selected.'
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
- en: Working with Uploaded Files in a View
  id: totrans-135
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In addition to text data, if a form also contains file uploads, Django will
    populate the `request.FILES` attribute with these files. `request.FILES` is a
    dictionary-like object that is keyed on the `name` attribute given to the `file`
    input.
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
- en: In the form example in the previous section, the file input had the name `file-upload-name`.
    So, the file would be accessible in the view using `request.FILES["file-upload-name"]`.
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
- en: 'The objects that `request.FILES` contains are file-like objects (specifically,
    a `django.core.files.uploadedfile.UploadedFile` instance), so to use them, you
    must read their data. For example, to get the content of an uploaded file in your
    view, you can write:'
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE25]'
  id: totrans-139
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: A more common action is to write the file contents to disk. When files are uploaded,
    they are stored in a temporary location (in memory if they are under 2.5 MB, otherwise
    in a temporary file on disk). To store the file data in a known location, the
    contents must be read and then written to disk at the desired location. An `UploadedFile`
    instance has a `chunks` method that will read the file data one chunk at a time
    to prevent too much memory from being used by reading the entirety of the file
    at once.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 更常见的操作是将文件内容写入磁盘。当文件上传时，它们被存储在临时位置（如果文件大小小于2.5 MB，则在内存中，否则在磁盘上的临时文件中）。要将文件数据存储在已知位置，必须读取内容并将其写入磁盘的期望位置。`UploadedFile`实例有一个`chunks`方法，它将一次读取文件数据的一个块，以防止一次性读取整个文件而占用太多内存。
- en: 'So, instead of simply using the `read` and `write` functions, use the `chunks`
    method to only read small chunks of the file into memory at a time:'
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，而不是简单地使用`read`和`write`函数，使用`chunks`方法一次只读取文件的小块到内存中：
- en: '[PRE26]'
  id: totrans-142
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'Note that in some of the upcoming examples, we will refer to this code as the
    `save_file_upload` function. Assume the function is defined like this:'
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，在即将到来的某些示例中，我们将把这个代码称为`save_file_upload`函数。假设函数定义如下：
- en: '[PRE27]'
  id: totrans-144
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: 'The previous example code could then be refactored to call the function:'
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 前面的示例代码可以重构为调用以下函数：
- en: '[PRE28]'
  id: totrans-146
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: 'Each `UploadedFile` object (the `uploaded_file` variable in the previous example
    code snippets) also contains extra metadata about the uploaded file, such as the
    file''s name, size, and content type. The attributes you will find most useful
    are:'
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 每个`UploadedFile`对象（前一个示例代码片段中的`uploaded_file`变量）还包含有关上传文件的额外元数据，例如文件名、大小和内容类型。你将发现最有用的属性是：
- en: '`size`: As the name suggests, this is the size of the uploaded file in bytes.'
  id: totrans-148
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`size`：正如其名所示，这是上传文件的字节数。'
- en: '`name`: This refers to the name of the uploaded file, for example, `image.jpg`,
    `file.txt`, `document.pdf`, and so on. This value is sent by the browser.'
  id: totrans-149
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`name`：这指的是上传文件的名称，例如，`image.jpg`、`file.txt`、`document.pdf`等等。这个值是由浏览器发送的。'
- en: '`content_type`: The content type (MIME type) of the uploaded file. For example,
    `image/jpeg`, `text/plain`, `application/pdf`, and so on. Like `name`, this value
    is sent by the browser.'
  id: totrans-150
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`content_type`：这是上传文件的内容类型（MIME类型）。例如，`image/jpeg`、`text/plain`、`application/pdf`等等。像`name`一样，这个值是由浏览器发送的。'
- en: '`charset`: This refers to the charset or text encoding of the uploaded file,
    for text files. This will be something like `utf8` or `ascii`. Once again, this
    value is also determined and sent by the browser.'
  id: totrans-151
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`charset`：这指的是上传文件的字符集或文本编码，对于文本文件。这将是类似`utf8`或`ascii`的东西。同样，这个值也是由浏览器确定并发送的。'
- en: 'Here is a quick example of accessing these attributes (such as inside a view):'
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 这里是一个快速示例，展示如何访问这些属性（例如在视图中）：
- en: '[PRE29]'
  id: totrans-153
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: Security and Trust of Browsers' Sent Values
  id: totrans-154
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 浏览器发送值的 安全性和信任
- en: As we just described, the values of an `UploadedFile` for `name`, `content_type`,
    and `charset` are determined by the browser. This is important to consider because
    a malicious user could send fake values in place of real ones to disguise the
    actual files being uploaded. Django does not automatically try to determine the
    content type or charset of the uploaded file, and so it relies on the client to
    be accurate when it sends this information.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 正如我们刚才描述的，`UploadedFile`的`name`、`content_type`和`charset`值是由浏览器确定的。这一点很重要，因为恶意用户可能会发送虚假值来代替真实值，以伪装实际上传的文件。Django不会自动尝试确定上传文件的类型或字符集，因此它依赖于客户端在发送此信息时准确无误。
- en: 'If we manually handle the saving of tile uploads without suitable checks, then
    a scenario like this could happen:'
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我们手动处理文件上传的保存而没有适当的检查，那么可能会发生如下场景：
- en: A user of the site uploads a malicious executable `malware.exe` but sends the
    content type `image/jpeg`.
  id: totrans-157
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 网站的用户上传了一个恶意可执行文件`malware.exe`，但发送的内容类型为`image/jpeg`。
- en: Our code checks the content type and considers it to be safe, and so saves `malware.exe`
    to the `MEDIA_ROOT` file.
  id: totrans-158
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 我们的代码检查内容类型，并认为它是安全的，因此将`malware.exe`保存到`MEDIA_ROOT`文件。
- en: Another user of the site downloads what they think is a book cover image but
    is the `malware.exe` executable. They open the file, and their computer is infected
    with malware.
  id: totrans-159
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 网站的另一用户下载了他们认为是一本封面图片的文件，但实际上是`malware.exe`可执行文件。他们打开了文件，然后他们的电脑被恶意软件感染。
- en: This scenario has been simplified – the malicious file would probably have a
    name that was not so obvious (maybe something like `cover.jpg.exe`), but the general
    process has been illustrated.
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 这种场景已经被简化了——恶意文件可能有一个不那么明显的名字（比如 `cover.jpg.exe`），但总体过程已经被说明了。
- en: 'How you choose to handle the security of your uploads will depend on the specific
    use case, but for most cases, these tips will help:'
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 你如何选择处理上传的安全性将取决于特定的用例，但对于大多数情况，这些提示将有所帮助：
- en: When you save the file to disk, generate a name instead of using the one provided
    by the uploader. You should replace the file extension with what you expect. For
    example, if a file is named `cover.exe` but the content type is `image/jpeg`,
    save the file as `cover.jpg`. You could also generate a completely random filename
    for extra security.
  id: totrans-162
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 当你将文件保存到磁盘时，生成一个名称而不是使用上传者提供的名称。你应该将文件扩展名替换为你期望的。例如，如果一个文件被命名为 `cover.exe` 但内容类型是
    `image/jpeg`，则将文件保存为 `cover.jpg`。你也可以为额外的安全性生成一个完全随机的文件名。
- en: 'Check that the file name extension matches the content type. This method is
    not foolproof as there are so many mime types that if you are handling uncommon
    files you might not get a match. The built-in `mimetypes` Python module can help
    you here. Its `guess_type` function takes a filename and returns a tuple of `mimetype`
    (content type) and `encoding`. Here is a short snippet showing its use, in a Python
    console:'
  id: totrans-163
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 检查文件扩展名是否与内容类型匹配。这种方法并不是万无一失的，因为存在如此多的 MIME 类型，如果你处理不常见的文件，你可能不会得到匹配。内置的 `mimetypes`
    Python 模块可以在这里帮助你。它的 `guess_type` 函数接受一个文件名，并返回一个包含 `mimetype`（内容类型）和 `encoding`
    的元组。以下是一个展示其使用的简短片段，在 Python 控制台中：
- en: '[PRE30]'
  id: totrans-164
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE30]'
- en: 'Either element of the tuple might be `None` if the type or encoding cannot
    be guessed. Once it is imported into your file by doing `import mimetypes`, you
    would use it like this in your view function:'
  id: totrans-165
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 如果类型或编码无法猜测，元组的任一元素都可能为 `None`。一旦通过 `import mimetypes` 将其导入到你的文件中，你可以在你的视图函数中使用它：
- en: '[PRE31]'
  id: totrans-166
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE31]'
- en: This method will work for common file types such as images, but as mentioned,
    many uncommon types may return `None` for `mimetype`.
  id: totrans-167
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这种方法适用于常见的文件类型，如图像，但如前所述，许多不常见的类型可能会返回 `mimetype` 为 `None`。
- en: If you are expecting image uploads, use the `Pillow` library to try to open
    the uploaded file as an image. If it is not a valid image, then `Pillow` will
    be unable to open it. This is what Django does when using its `ImageField` to
    upload images. We will show how to use this technique to open and manipulate an
    image in *Exercise 8.05*, *Image Uploads using Django Forms*.
  id: totrans-168
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果你预计会有图像上传，请使用 `Pillow` 库尝试以图像的形式打开上传的文件。如果它不是一个有效的图像，那么 `Pillow` 将无法打开它。这就是
    Django 在使用其 `ImageField` 上传图像时所做的。我们将在 *练习 8.05*，*使用 Django 表单的图像上传* 中展示如何使用这种技术打开和操作图像。
- en: 'You can also consider the `python-magic` Python package, which examines the
    actual content of files to try to determine their type. It is installable using
    `pip`, and its GitHub project is [https://github.com/ahupp/python-magic](https://github.com/ahupp/python-magic).
    Once installed, and imported into your file with `import magic`, you can use it
    like this in your view function:'
  id: totrans-169
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你还可以考虑使用 `python-magic` Python 包，该包检查文件的实际内容以尝试确定其类型。它可以通过 `pip` 安装，其 GitHub
    项目是 [https://github.com/ahupp/python-magic](https://github.com/ahupp/python-magic)。一旦安装，并通过
    `import magic` 导入到你的文件中，你可以在你的视图函数中使用它：
- en: '[PRE32]'
  id: totrans-170
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE32]'
- en: You could then verify that `mimetype` was in a list of allowed types.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，你可以验证 `mimetype` 是否在允许的类型列表中。
- en: This is not a definitive list of all the ways of protecting against malicious
    file uploads. The best approach will depend on what type of application you are
    building. You might build a site for hosting arbitrary files, in which case you
    would not need any kind of content checking at all.
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 这不是一个保护恶意文件上传的所有方法的完整列表。最佳方法将取决于你正在构建的应用程序类型。你可能正在构建一个用于托管任意文件的网站，在这种情况下，你根本不需要进行任何内容检查。
- en: Let us now see how we can build an HTML form and view that will allow files
    to be uploaded. We will then store them inside the `media` directory and retrieve
    the downloaded files in our browser.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们看看我们如何构建一个 HTML 表单和视图，允许上传文件。然后我们将它们存储在 `media` 目录中，并在我们的浏览器中检索下载的文件。
- en: 'Exercise 8.03: File Upload and Download'
  id: totrans-174
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 练习 8.03：文件上传和下载
- en: 'In this exercise, you will add a form with a file field to the `media-example.html`
    template. This will allow you to upload a file to the `media_example` view using
    your browser. You will also update the `media_example` view to save the file to
    the `MEDIA_ROOT` directory so that it''s available for download. You will then
    test that this all works by downloading the file again:'
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个练习中，您将向 `media-example.html` 模板添加一个带有文件字段的表单。这将允许您使用浏览器将文件上传到 `media_example`
    视图。您还将更新 `media_example` 视图，以便将文件保存到 `MEDIA_ROOT` 目录，以便可供下载。然后，您将通过再次下载文件来测试这一切是否正常工作：
- en: 'In PyCharm, open the `media-example.html` template located inside the `templates`
    folder. Inside the `<body>` element, remove the `<a>` link that was added in *step
    6* of *Exercise 8.02*, *Template Settings and Using MEDIA_URL in Templates*. Replace
    it with a `<form>` element (highlighted here). Make sure the opening tag has `method="post"`
    and `enctype="multipart/form-data"`:'
  id: totrans-176
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在 PyCharm 中，打开位于 `templates` 文件夹内的 `media-example.html` 模板。在 `<body>` 元素内部，移除在
    *练习 8.02* 的 *步骤 6* 中添加的 `<a>` 链接，用 `<form>` 元素（如图所示）替换它。确保打开标签具有 `method="post"`
    和 `enctype="multipart/form-data"`：
- en: '[PRE33]'
  id: totrans-177
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE33]'
- en: Insert the `{% csrf_token %}` template tag inside the `<form>` body.
  id: totrans-178
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在 `<form>` 主体内部插入 `{% csrf_token %}` 模板标签。
- en: 'After `{% csrf_token %}`, add an `<input>` element, with `type="file"` and
    `name="file_upload"`:'
  id: totrans-179
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在 `{% csrf_token %}` 之后，添加一个 `type="file"` 和 `name="file_upload"` 的 `<input>`
    元素：
- en: '[PRE34]'
  id: totrans-180
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE34]'
- en: 'Finally, before the closing `</form>` tag, add a `<button>` element with `type="submit"`
    and the text content `Submit`:'
  id: totrans-181
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 最后，在关闭 `</form>` 标签之前，添加一个 `type="submit"` 并具有文本内容 `提交` 的 `<button>` 元素：
- en: '[PRE35]'
  id: totrans-182
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE35]'
- en: 'Your HTML body should now look like this:'
  id: totrans-183
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 您的 HTML 主体现在应该看起来像这样：
- en: '[PRE36]'
  id: totrans-184
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE36]'
- en: 'Now, save and close the file. It should look like this: [http://packt.live/37XJPh3](http://packt.live/37XJPh3).'
  id: totrans-185
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 现在，保存并关闭文件。它应该看起来像这样：[http://packt.live/37XJPh3](http://packt.live/37XJPh3)。
- en: 'Open the `media_example` app''s `views.py`. Inside the `media_example` view,
    add code to save the uploaded file to the `MEDIA_ROOT` directory. For this, you
    need access to `MEDIA_ROOT` from settings, so import the Django settings at the
    top of the file:'
  id: totrans-186
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开 `media_example` 应用程序的 `views.py` 文件。在 `media_example` 视图中，添加代码以将上传的文件保存到
    `MEDIA_ROOT` 目录。为此，您需要从设置中访问 `MEDIA_ROOT`，因此请在文件顶部导入 Django 设置：
- en: '[PRE37]'
  id: totrans-187
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE37]'
- en: 'You will also need to use the `os` module to build the save path, so import
    that as well (also at the top of the file):'
  id: totrans-188
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 您还需要使用 `os` 模块来构建保存路径，因此也要导入它（同样在文件顶部）：
- en: '[PRE38]'
  id: totrans-189
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE38]'
- en: 'The uploaded file should only be saved if the request method is `POST`. Inside
    the `media_example` view, add an `if` statement to validate that `request.method`
    is `POST`:'
  id: totrans-190
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 只有当请求方法是 `POST` 时，上传的文件才应该被保存。在 `media_example` 视图中，添加一个 `if` 语句来验证 `request.method`
    是否为 `POST`：
- en: '[PRE39]'
  id: totrans-191
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE39]'
- en: 'Inside the `if` statement added in the previous step, generate the output path
    by joining the uploaded filename to `MEDIA_ROOT`. Then, open this path in `wb`
    mode and iterate over the uploaded file using the `chunks` method. Finally, write
    each chunk to the saved file:'
  id: totrans-192
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在之前步骤中添加的 `if` 语句内部，通过将上传的文件名与 `MEDIA_ROOT` 连接来生成输出路径。然后，以 `wb` 模式打开此路径，并使用
    `chunks` 方法遍历上传的文件。最后，将每个块写入保存的文件：
- en: '[PRE40]'
  id: totrans-193
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE40]'
- en: 'Start the Django dev server if it is not already running, then navigate to
    `http://127.0.0.1:8000/media-example/`. You should see the file upload field and
    `Submit` button, as can be seen here:![Figure 8.9: File upload form'
  id: totrans-194
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果尚未运行，请启动 Django 开发服务器，然后导航到 `http://127.0.0.1:8000/media-example/`。您应该看到文件上传字段和
    `提交` 按钮，如图所示：![图 8.9：文件上传表单
- en: '](img/B15509_08_09.jpg)'
  id: totrans-195
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![图片 B15509_08_09.jpg](img/B15509_08_09.jpg)'
- en: 'Figure 8.9: File upload form'
  id: totrans-196
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![图 8.9：文件上传表单'
- en: Click `Browse…` (or the equivalent in your browser) and select a file to upload.
    The name of the file will appear in the file input. Then, click `Submit`. The
    page will reload, and the form will be empty again. This is normal – in the background,
    the file should have been saved.
  id: totrans-197
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 点击 `浏览…`（或在您的浏览器中对应的选项）并选择一个文件进行上传。文件名将出现在文件输入框中。然后，点击 `提交`。页面将重新加载，表单将再次为空。这是正常的——在后台，文件应该已经被保存。
- en: 'Try to download the file you uploaded using `MEDIA_URL`. In this example, a
    file named `cover.jpg` was uploaded. It will be downloadable at `http://127.0.0.1:8000/media/cover.jpg`.
    Your URL will depend on the name of the file you uploaded.![Figure 8.10: Uploaded
    file visible inside MEDIA_URL'
  id: totrans-198
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 尝试使用 `MEDIA_URL` 下载您上传的文件。在这个例子中，上传了一个名为 `cover.jpg` 的文件。它将在 `http://127.0.0.1:8000/media/cover.jpg`
    可以下载。您的 URL 将取决于您上传的文件名。![图 8.10：可见于 MEDIA_URL 的上传文件
- en: '](img/B15509_08_10.jpg)'
  id: totrans-199
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![图片 B15509_08_10.jpg](img/B15509_08_10.jpg)'
- en: 'Figure 8.10: Uploaded file visible inside MEDIA_URL'
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: '![图 8.10：可见于 MEDIA_URL 的上传文件'
- en: If you uploaded an image file, HTML file, or another type of file your browser
    can display, you will be able to view it inside the browser. Otherwise, your browser
    will just download it to disk again. In both cases, it means the upload was successful.
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
- en: 'You can also confirm the upload was successful by looking inside the `media`
    directory in the `media_project` project directory:'
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 8.11: cover.jpg inside the media directory'
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
- en: '](img/B15509_08_11.jpg)'
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
- en: 'Figure 8.11: cover.jpg inside the media directory'
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 8.11* shows `cover.jpg` inside the `media` directory in PyCharm.'
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
- en: In this exercise, you added an HTML form with `enctype` set to `multipart/form-data`
    so that it would allow file uploads. It contained a `file` input to select a file
    to upload. You then added saving functionality to the `media_example` view to
    save the uploaded file to disk.
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
- en: In the next section, we will look at how to simplify form generation and add
    validation using Django forms.
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
- en: File Uploads with Django Forms
  id: totrans-209
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In *Chapter 6*, *Forms*, we saw how Django makes it easy to define forms and
    automatically render them to HTML. In the previous example, we defined our form
    manually and wrote the HTML. We can replace this with a Django form, and implement
    the file input with a `FileField` constructor.
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
- en: 'Here is how a `FileField` is defined on a form:'
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE41]'
  id: totrans-212
  prefs: []
  type: TYPE_PRE
  zh: '[PRE41]'
- en: 'The `FileField` constructor can take the following keyword arguments:'
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
- en: '`required`: This should be `True` for required fields and `False` if the field
    is optional.'
  id: totrans-214
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`max_length`: This refers to the maximum length of the filename of the file
    being uploaded.'
  id: totrans-215
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`allow_empty_file`: A field with this argument is valid even if the uploaded
    file is empty (has a size of `0`).'
  id: totrans-216
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Apart from these three keyword arguments, the constructor can also accept the
    standard `Field` arguments, such as `widget`. The default widget class for a `FileField`
    is `ClearableFileInput`. This is a file input that can display a checkbox that
    can be checked to send a null value and clear the saved file on a model field.
  id: totrans-217
  prefs: []
  type: TYPE_NORMAL
- en: Using a form with a `FileField` in a view is similar to other forms, but when
    the form has been submitted (that is, `request.METHOD` is `POST`), then `request.FILES`
    should be passed into the form constructor as well. This is because Django needs
    to access `request.FILES` to find information about uploaded files when validating
    the form.
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
- en: 'The basic flow in a `view` function is therefore like this:'
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE42]'
  id: totrans-220
  prefs: []
  type: TYPE_PRE
  zh: '[PRE42]'
- en: 'When working with uploaded files and forms, you can interact with the uploaded
    files by accessing them through `request.FILES`, or through `form.cleaned_data`:
    the values will return to the same object. In our above example, we could process
    the uploaded file like this:'
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE43]'
  id: totrans-222
  prefs: []
  type: TYPE_PRE
  zh: '[PRE43]'
- en: 'Or, since they contain the same object, you can use `form.cleaned_data`:'
  id: totrans-223
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE44]'
  id: totrans-224
  prefs: []
  type: TYPE_PRE
  zh: '[PRE44]'
- en: The data that is saved will be the same.
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
- en: Note
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
- en: In *Chapter 6*, *Forms*, you experimented with forms and submitting them with
    invalid values. When the page refreshed to show the form errors, the data that
    you had previously entered was populated when the page reloaded. This does not
    occur with file fields; instead, the user will have to navigate and select the
    file again if the form is invalid.
  id: totrans-227
  prefs: []
  type: TYPE_NORMAL
  zh: 在 *第 6 章*，*表单* 中，你尝试了表单和提交无效值。当页面刷新以显示表单错误时，你之前输入的数据会在页面重新加载时被填充。对于文件字段来说，这种情况不会发生；相反，如果表单无效，用户将不得不再次导航并选择文件。
- en: In the next exercise, we will put what we have seen with `FileFields` into practice
    by building an example form, then modifying our view to save the file only if
    the form is valid.
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一个练习中，我们将通过构建一个示例表单，然后修改我们的视图，仅在表单有效时保存文件，来将我们之前看到的 `FileFields` 应用到实践中。
- en: 'Exercise 8.04: File Uploads with a Django Form'
  id: totrans-229
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 练习 8.04：使用 Django 表单上传文件
- en: In the previous exercise, you created a form in HTML and used it to upload a
    file to a Django view. If you tried submitting the form without selecting a file,
    you would get a Django exception screen. You did not do any validation on the
    form, so this method is quite fragile.
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: 在之前的练习中，你创建了一个 HTML 表单，并使用它将文件上传到 Django 视图。如果你尝试提交没有选择文件的表单，你会得到一个 Django 异常屏幕。你没有对表单进行任何验证，所以这种方法相当脆弱。
- en: 'In this exercise, you will create a Django form with a `FileFIeld`, which will
    allow you to use form validation functions to make the view more robust as well
    to reduce the amount of code:'
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个练习中，你将创建一个带有 `FileField` 的 Django 表单，这将允许你使用表单验证函数使视图更加健壮，同时减少代码量：
- en: 'In PyCharm, inside the `media_example` app, create a new file named `forms.py`.
    It will open automatically. At the start of the file, import the Django `forms` library:'
  id: totrans-232
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在 PyCharm 中，在 `media_example` 应用程序内部，创建一个名为 `forms.py` 的新文件。它将自动打开。在文件开头，导入
    Django 的 `forms` 库：
- en: '[PRE45]'
  id: totrans-233
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE45]'
- en: 'Then, create a `forms.Form` subclass, and name it `UploadForm`. Add one field
    to it, a `FileField` named `file_upload`. Your class should have this code:'
  id: totrans-234
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 然后，创建一个 `forms.Form` 子类，并将其命名为 `UploadForm`。向其中添加一个字段，一个名为 `file_upload` 的 `FileField`。你的类应该有如下代码：
- en: '[PRE46]'
  id: totrans-235
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE46]'
- en: 'You can save and close this file. The complete file should look like this:
    [http://packt.live/34S5hBV](http://packt.live/34S5hBV).'
  id: totrans-236
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 你可以保存并关闭此文件。完整的文件应如下所示：[http://packt.live/34S5hBV](http://packt.live/34S5hBV)。
- en: 'Open the `form_example` app''s `views.py` file. At the start of the file, right
    below the existing `import` statements, you will need to import your new class,
    like this:'
  id: totrans-237
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开 `form_example` 应用的 `views.py` 文件。在文件的开头，现有 `import` 语句的下方，你需要导入你的新类，如下所示：
- en: '[PRE47]'
  id: totrans-238
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE47]'
- en: 'If you are in the `POST` branch of the view, `UploadForm` needs to be instantiated
    with both `request.POST` and `request.FILES`. If you do not pass in `request.FILES`,
    then the `form` instance will not be able to access the uploaded files. Under
    the `if request.method == "POST"` check, instantiate the `UploadForm` with these
    two arguments:'
  id: totrans-239
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果你处于视图的 `POST` 分支，`UploadForm` 需要使用 `request.POST` 和 `request.FILES` 两个参数进行实例化。如果你没有传入
    `request.FILES`，那么 `form` 实例将无法访问上传的文件。在 `if request.method == "POST"` 检查下，使用这两个参数实例化
    `UploadForm`：
- en: '[PRE48]'
  id: totrans-240
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE48]'
- en: 'The existing lines that define the `save_path` and store the file contents
    can be retained, but they should be indented by one block and put inside a form
    validity check, so they are only executed if the form is valid. Add the `if form.is_valid():`
    line and then indent the other lines so the code looks like this:'
  id: totrans-241
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 定义 `save_path` 和存储文件内容的现有行可以保留，但它们应该缩进一个块，并放在表单有效性检查内部，这样它们只有在表单有效时才会执行。添加 `if
    form.is_valid():` 行，然后缩进其他行，使代码看起来像这样：
- en: '[PRE49]'
  id: totrans-242
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE49]'
- en: 'Since you are using a form now, you can access the file upload through the
    form. Replace usages of `request.FILES["file_upload"]` with `form.cleaned_data["file_upload"]`:'
  id: totrans-243
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 由于你现在正在使用表单，你可以通过表单访问文件上传。将 `request.FILES["file_upload"]` 的使用替换为 `form.cleaned_data["file_upload"]`：
- en: '[PRE50]'
  id: totrans-244
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE50]'
- en: 'Finally, add an `else` branch to handle non-`POST` requests, which simply instantiates
    a form without any arguments:'
  id: totrans-245
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 最后，添加一个 `else` 分支来处理非 `POST` 请求，它只是实例化一个不带任何参数的表单：
- en: '[PRE51]'
  id: totrans-246
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE51]'
- en: 'Add a context dictionary argument to the `render` call and set the `form` variable
    in the `form` key:'
  id: totrans-247
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将上下文字典参数添加到 `render` 调用中，并将 `form` 变量设置在 `form` 键中：
- en: '[PRE52]'
  id: totrans-248
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE52]'
- en: 'You can now save and close this file. It should look like this: [http://packt.live/3psXxyc](http://packt.live/3psXxyc).'
  id: totrans-249
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 你现在可以保存并关闭此文件。它应该如下所示：[http://packt.live/3psXxyc](http://packt.live/3psXxyc)。
- en: 'Finally, open the `media-example.html` template and remove your manually defined
    file `<input>`. Replace it with `form`, rendered using the `as_p` method (highlighted):'
  id: totrans-250
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 最后，打开 `media-example.html` 模板，删除你手动定义的文件 `<input>`。用使用 `as_p` 方法渲染的 `form` 替换它（高亮显示）：
- en: '[PRE53]'
  id: totrans-251
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE53]'
- en: 'You should not change any other parts of the file. You can save and close this
    file. It should look like this: [http://packt.live/3qHHSMi](http://packt.live/3qHHSMi).'
  id: totrans-252
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 你不应该更改文件的任何其他部分。你可以保存并关闭此文件。它应该看起来像这样：[http://packt.live/3qHHSMi](http://packt.live/3qHHSMi)。
- en: 'Start the Django dev server if it is not already running, then navigate to
    `http://127.0.0.1:8000/media-example/`. You should see the `File upload` field
    and the `Submit` button, as follows:![Figure 8.12: File upload Django form rendered
    in the browser'
  id: totrans-253
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果Django开发服务器尚未运行，请启动它，然后导航到 `http://127.0.0.1:8000/media-example/`。你应该会看到 `文件上传`
    字段和 `提交` 按钮，如下所示：![图8.12：在浏览器中渲染的文件上传Django表单
- en: '](img/B15509_08_12.jpg)'
  id: totrans-254
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![图片](img/B15509_08_12.jpg)'
- en: 'Figure 8.12: File upload Django form rendered in the browser'
  id: totrans-255
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图8.12：在浏览器中渲染的文件上传Django表单
- en: 'Since we are using a Django form, we get its built-in validation automatically.
    If you try to submit the form without selecting a file, your browser should prevent
    you and show an error, as can be seen here:![Figure 8.13: Form submission prevented
    by the browser'
  id: totrans-256
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 由于我们使用的是Django表单，我们自动获得其内置验证。如果你尝试不选择文件就提交表单，你的浏览器应该阻止你并显示错误，如下所示：![图8.13：浏览器阻止表单提交
- en: '](img/B15509_08_13.jpg)'
  id: totrans-257
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![图片](img/B15509_08_13.jpg)'
- en: 'Figure 8.13: Form submission prevented by the browser'
  id: totrans-258
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图8.13：浏览器阻止表单提交
- en: 'Finally, repeat the upload test that you performed in *Exercise 8.03*, *File
    Upload and Download*, by selecting a file and submitting the form. You should
    then be able to retrieve the file using `MEDIA_URL`. In this case, a file named
    `cover.jpg` is being uploaded again (see the following figure):![Figure 8.14:
    Uploading a file named cover.jpg'
  id: totrans-259
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 最后，重复你在 *练习8.03*，*文件上传和下载* 中进行的上传测试，通过选择一个文件并提交表单。然后你应该能够使用 `MEDIA_URL` 检索文件。在这种情况下，正在再次上传一个名为
    `cover.jpg` 的文件（见下图）：![图8.14：上传名为cover.jpg的文件
- en: '](img/B15509_08_14.jpg)'
  id: totrans-260
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '![图片](img/B15509_08_14.jpg)'
- en: 'Figure 8.14: Uploading a file named cover.jpg'
  id: totrans-261
  prefs: []
  type: TYPE_NORMAL
  zh: 图8.14：上传名为cover.jpg的文件
- en: 'You can then retrieve the file at `http://127.0.0.1:8000/media/cover.jpg`,
    and you can see it in the browser as follows:'
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以随后在 `http://127.0.0.1:8000/media/cover.jpg` 上检索文件，你可以在浏览器中看到如下所示：
- en: '![Figure 8.15: The file uploaded using a Django form is also visible in the
    browser'
  id: totrans-263
  prefs: []
  type: TYPE_NORMAL
  zh: '![图8.15：使用Django表单上传的文件在浏览器中也是可见的'
- en: '](img/B15509_08_15.jpg)'
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
  zh: '![图片](img/B15509_08_15.jpg)'
- en: 'Figure 8.15: The file uploaded using a Django form is also visible in the browser'
  id: totrans-265
  prefs: []
  type: TYPE_NORMAL
  zh: 图8.15：使用Django表单上传的文件在浏览器中也是可见的
- en: In this exercise, we replaced a manually built form with a Django form containing
    a `FileField`. We instantiated the form in the view by passing in both `request.POST`
    and `request.FILES`. We then used the standard `is_valid` method to check the
    validity of the form, and only saved the file upload if the form was valid. We
    tested the file uploading and saw we were able to retrieve uploaded files using
    `MEDIA_URL`.
  id: totrans-266
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个练习中，我们用一个包含 `FileField` 的Django表单替换了手动构建的表单。我们在视图中通过传递 `request.POST` 和 `request.FILES`
    来实例化表单。然后我们使用标准的 `is_valid` 方法来检查表单的有效性，并且只有在表单有效的情况下才保存文件上传。我们测试了文件上传，并看到我们能够使用
    `MEDIA_URL` 检索上传的文件。
- en: In the next section, we will look at `ImageField`, which is like a `FileField`
    but specifically for images.
  id: totrans-267
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一节中，我们将查看 `ImageField`，它类似于 `FileField`，但专门用于图像。
- en: Image Uploads with Django Forms
  id: totrans-268
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用Django表单进行图像上传
- en: 'If you want to work with images in Python, the most common library that you
    will use is called `Image` object is imported from PIL:'
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想在Python中处理图像，你将最常使用的库叫做 `Image`，它从PIL导入：
- en: '[PRE54]'
  id: totrans-270
  prefs: []
  type: TYPE_PRE
  zh: '[PRE54]'
- en: Note
  id: totrans-271
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: The terms Python Imaging Library, PIL, and Pillow are often used interchangeably.
    You can assume that if someone refers to PIL, they mean the latest Pillow library.
  id: totrans-272
  prefs: []
  type: TYPE_NORMAL
  zh: Python Imaging Library、PIL和Pillow这些术语经常可以互换使用。你可以假设如果有人提到PIL，他们指的是最新的Pillow库。
- en: Pillow provides various methods of retrieving data about or manipulating images.
    You can find out the width and height of images, or scale, crop, and apply transformations
    to them. There are too many operations available to cover in this chapter, so
    we will just introduce a simple example (scaling an image), which you will use
    in the next exercise.
  id: totrans-273
  prefs: []
  type: TYPE_NORMAL
  zh: Pillow提供了各种检索图像数据或操作图像的方法。你可以找出图像的宽度和高度，或者缩放、裁剪并对它们应用变换。由于本章中可用的操作太多，我们只介绍一个简单的例子（缩放图像），你将在下一个练习中使用它。
- en: Since images are one of the most common types of files that a user may want
    to upload, Django also includes an `ImageField` instance. This behaves similarly
    to `FileField` instance but also automatically validates that the data is an image
    file. This helps mitigate security issues where we expect an image, but the user
    uploads a malicious file.
  id: totrans-274
  prefs: []
  type: TYPE_NORMAL
  zh: 由于图片是用户可能想要上传的最常见的文件类型之一，Django也包含了一个`ImageField`实例。这个实例的行为与`FileField`实例类似，但也会自动验证数据是否为图片文件。这有助于减轻我们期望是图片但用户上传了恶意文件时的安全问题。
- en: 'An `UploadedFile` from an `ImageField` has all the same attributes and methods
    as that of a `FileField` (`size`, `content_type`, `name`, `chunks()`, and so on)
    but adds an extra attribute: `image`. This is an instance of the PIL `Image` object
    that is used to verify that the file being uploaded is a valid image.'
  id: totrans-275
  prefs: []
  type: TYPE_NORMAL
  zh: 来自`ImageField`的`UploadedFile`具有与`FileField`相同的所有属性和方法（`size`、`content_type`、`name`、`chunks()`等），但增加了一个额外的属性：`image`。这是一个PIL
    `Image`对象的实例，用于验证上传的文件是否为有效的图片。
- en: After checking that the form is valid, the underlying PIL `Image` object is
    closed. This is to free up memory and prevent the Python process from holding
    too many files open, which could cause performance issues. What this means for
    the developer is that you can access some of the metadata about the image (such
    as its `width`, `height`, and `format`) but you can't access the actual image
    data without re-opening the image.
  id: totrans-276
  prefs: []
  type: TYPE_NORMAL
  zh: 在检查表单有效后，底层的PIL `Image`对象被关闭。这是为了释放内存并防止Python进程打开太多文件，这可能会引起性能问题。对于开发者来说，这意味着你可以访问一些关于图片的元数据（如其`width`、`height`和`format`），但如果不重新打开图片，你无法访问实际的图片数据。
- en: 'To illustrate, we will have a form with an `ImageField`, named `picture`:'
  id: totrans-277
  prefs: []
  type: TYPE_NORMAL
  zh: 为了说明，我们将有一个包含`ImageField`的表单，命名为`picture`：
- en: '[PRE55]'
  id: totrans-278
  prefs: []
  type: TYPE_PRE
  zh: '[PRE55]'
- en: 'Inside the view function, the `picture` field can be accessed in the form''s
    `cleaned_data`:'
  id: totrans-279
  prefs: []
  type: TYPE_NORMAL
  zh: 在视图函数内部，可以在表单的`cleaned_data`中访问`picture`字段：
- en: '[PRE56]'
  id: totrans-280
  prefs: []
  type: TYPE_PRE
  zh: '[PRE56]'
- en: 'Then, the `picture` field''s `Image` object can be retrieved:'
  id: totrans-281
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，可以检索`picture`字段的`Image`对象：
- en: '[PRE57]'
  id: totrans-282
  prefs: []
  type: TYPE_PRE
  zh: '[PRE57]'
- en: 'Now that we have a reference to the image in the view, we can get some metadata:'
  id: totrans-283
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经在视图中有了图片的引用，我们可以获取一些元数据：
- en: '[PRE58]'
  id: totrans-284
  prefs: []
  type: TYPE_PRE
  zh: '[PRE58]'
- en: Django will also automatically update the `content_type` attribute of `UploadedFile`
    to the correct type for the `picture` field. This overwrites the value that the
    browser sent when uploading the file.
  id: totrans-285
  prefs: []
  type: TYPE_NORMAL
  zh: Django还会自动更新`UploadedFile`的`content_type`属性，使其适用于`picture`字段。这将覆盖浏览器上传文件时发送的值。
- en: Attempting to use a method that accesses the actual image data (rather than
    just the metadata) will cause an exception to be raised. This is because Django
    has already closed the underlying image file.
  id: totrans-286
  prefs: []
  type: TYPE_NORMAL
  zh: 尝试使用访问实际图片数据的方法（而不是仅访问元数据）将引发异常。这是因为Django已经关闭了底层的图片文件。
- en: 'For example, the following code snippet will raise an `AttributeError`:'
  id: totrans-287
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，以下代码片段将引发`AttributeError`：
- en: '[PRE59]'
  id: totrans-288
  prefs: []
  type: TYPE_PRE
  zh: '[PRE59]'
- en: 'Instead, we need to re-open the image. The image data can be opened with the
    `ImageField` reference, after importing the `Image` class:'
  id: totrans-289
  prefs: []
  type: TYPE_NORMAL
  zh: 相反，我们需要重新打开图片。在导入`Image`类后，可以使用`ImageField`引用打开图片数据：
- en: '[PRE60]'
  id: totrans-290
  prefs: []
  type: TYPE_PRE
  zh: '[PRE60]'
- en: Now that the image has been opened, you can perform operations on it. In the
    next section, we will look at a simple example – resizing the uploaded image.
  id: totrans-291
  prefs: []
  type: TYPE_NORMAL
  zh: 现在图片已经打开，你可以对它进行操作。在下一节中，我们将查看一个简单的示例——调整上传的图片大小。
- en: Resizing an Image with Pillow
  id: totrans-292
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用Pillow调整图片大小
- en: 'Pillow supports many operations that you might want to perform on an image
    before saving it. We cannot explain them all in this book, so we will just use
    a common operation: resizing an image to a specific size before saving it. This
    will help us save storage space and improve the download speed. For example, a
    user may upload large cover images in Bookr that are bigger than are needed for
    our purposes. When saving the file (writing it back to disk) we must specify the
    format to use. We could determine the type of image that was uploading with a
    number of methods (such as checking the `content_type` of the uploaded file or
    the `format` from the `Image` object), but in our example, we will always just
    save the image as a `JPEG` file.'
  id: totrans-293
  prefs: []
  type: TYPE_NORMAL
  zh: Pillow支持许多在保存图片之前你可能想要执行的操作。我们无法在这本书中解释所有这些操作，所以我们只使用一个常见的操作：在保存之前将图片调整到特定大小。这将帮助我们节省存储空间并提高下载速度。例如，用户可能在Bookr上传了比我们所需更大的封面图片。当保存文件（将其写回磁盘）时，我们必须指定要使用的格式。我们可以通过多种方法确定上传的图片类型（例如检查上传文件的`content_type`或`Image`对象的`format`），但在我们的示例中，我们总是将图片保存为`JPEG`文件。
- en: 'The PIL `Image` class has a `thumbnail` method that will resize an image to
    a maximum size while retaining the aspect ratio. For example, we could set a maximum
    size of 50px by 50px. A 200px by 100px image would be resized to 50px by 25px:
    the aspect ratio is retained by setting the maximum dimension to 50px. Each dimension
    is scaled by a factor of 0.25:'
  id: totrans-294
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE61]'
  id: totrans-295
  prefs: []
  type: TYPE_PRE
  zh: '[PRE61]'
- en: 'At this point, the resize has been done in memory only. The change is not saved
    to disk until the `save` method is called, like so:'
  id: totrans-296
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE62]'
  id: totrans-297
  prefs: []
  type: TYPE_PRE
  zh: '[PRE62]'
- en: 'The output format is automatically determined from the file extension used,
    in this case, JPEG. The `save` method can also take a format argument to override
    it. For example:'
  id: totrans-298
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE63]'
  id: totrans-299
  prefs: []
  type: TYPE_PRE
  zh: '[PRE63]'
- en: Despite having the extension `png`, the format is specified as `JPEG` and so
    the output will be in JPEG format. As you might imagine, this can be very confusing,
    so you might decide to stick with specifying the extension only.
  id: totrans-300
  prefs: []
  type: TYPE_NORMAL
- en: In the next exercise, we will change the `UploadForm` we have been working with
    to use an `ImageField` instead of a `FileField`, then implement the resizing of
    an uploaded image before saving it to the media directory.
  id: totrans-301
  prefs: []
  type: TYPE_NORMAL
- en: 'Exercise 8.05: Image Uploads using Django Forms'
  id: totrans-302
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In this exercise, you will update the `UploadForm` class you created in *Exercise
    8.04*, *File Uploads with a Django Form*, to use an `ImageField` instead of a
    `FileField` (this will involve simply changing the field''s class). You will then
    see that the form renders it in the browser. Next, you will try uploading some
    non-image files and see how Django validates the form to disallow them. Finally,
    you will update your view to use PIL to resize the image before saving it, and
    then test it in action:'
  id: totrans-303
  prefs: []
  type: TYPE_NORMAL
- en: 'Open the `media_example` app''s `forms.py` file. In the `UploadForm` class,
    change `file_upload` so it''s an instance of `ImageField` instead of `FileField`.
    After updating, your `UploadForm` should look like this:'
  id: totrans-304
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE64]'
  id: totrans-305
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE64]'
- en: 'Start the Django dev server if it is not already running, then navigate to
    `http://127.0.0.1:8000/media-example/`. You should see the form rendered, and
    it will look identical as to when we used a `FileField` (see the following figure):![Figure
    8.16: The ImageField looks the same as a FileField'
  id: totrans-306
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '](img/B15509_08_16.jpg)'
  id: totrans-307
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Figure 8.16: The ImageField looks the same as a FileField'
  id: totrans-308
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'You will notice the difference when you try to upload a non-image file. Click
    the `Browse…` button and try to select a non-image file. Depending on your browser
    or operating system, you might not be able to select anything other than an image
    file, as in *Figure 8.17*:![Figure 8.17: Only image files are selectable'
  id: totrans-309
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '](img/B15509_08_17.jpg)'
  id: totrans-310
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Figure 8.17: Only image files are selectable'
  id: totrans-311
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Your browser may allow selecting an image but show an error in the form after
    selection. Or your browser may allow you to select a file and submit the form,
    and Django will raise a `ValidationError`. Regardless, you can be sure that in
    your view, the form's `is_valid` view will only return `True` if an image has
    been uploaded.
  id: totrans-312
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Note
  id: totrans-313
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: You do not need to test uploading a file at this point, as the result would
    be the same as in *Exercise 8.04*, *File Uploads with a Django Form*.
  id: totrans-314
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'The first thing you will need to do is to make sure the Pillow library is installed.
    In a terminal (making sure your virtual environment has been activated), run:'
  id: totrans-315
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE65]'
  id: totrans-316
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE65]'
- en: '(In Windows, this is `pip install pillow`.) You will get output like *Figure 8.18*:'
  id: totrans-317
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '![Figure 8.18: pip3 installing Pillow'
  id: totrans-318
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '](img/B15509_08_18.jpg)'
  id: totrans-319
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Figure 8.18: pip3 installing Pillow'
  id: totrans-320
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Or if Pillow was already installed, you will see the output message `Requirement
    already satisfied`.
  id: totrans-321
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Now we can update the `media_example` view to resize the image before saving
    it. Switch back to PyCharm and open the `media_example` app''s `views.py` file,
    then import PIL''s `Image` class. So, add this import line below the `import os`
    statement near the top of the file:'
  id: totrans-322
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE66]'
  id: totrans-323
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE66]'
- en: 'Go to the `media_example` view. Under the line that generates the `save_path`,
    take out the three lines that open the output file, iterate over the uploaded
    file, and write out its chunks. Replace this with the code that opens the uploaded
    file with PIL, resizes it, then saves it:'
  id: totrans-324
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE67]'
  id: totrans-325
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE67]'
- en: 'The first line creates an `Image` instance by opening the uploaded file, the
    next performs the thumbnail conversion (to a maximum size of 50px by 50px), and
    the third line saves the file to the same save path that we have been generating
    in previous exercises. You can save the file. It should look like this: [http://packt.live/34PWvof](http://packt.live/34PWvof).'
  id: totrans-326
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: The Django dev server should still be running from *step 2*, but you should
    start it if it is not. Then, navigate to `http://127.0.0.1:8000/media-example/`.
    You will see the familiar `UploadForm`. Select an image and submit the form. If
    the upload and resize was successful, the form will refresh and be empty again.
  id: totrans-327
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'View the uploaded image using `MEDIA_URL`. For example, a file named `cover.jpg`
    will be downloadable from `http://127.0.0.1:8000/media/cover.jpg`. You should
    see the image has been resized to have a maximum dimension of just 50px:![Figure
    8.19: Resized logo'
  id: totrans-328
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '](img/B15509_08_19.jpg)'
  id: totrans-329
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Figure 8.19: Resized logo'
  id: totrans-330
  prefs: []
  type: TYPE_NORMAL
- en: While a thumbnail this size might not be that useful, it at least lets us be
    sure that the image resize has worked correctly.
  id: totrans-331
  prefs: []
  type: TYPE_NORMAL
- en: In this exercise, we changed the `FileField` on `UploadForm` to an `ImageField`.
    We saw that the browser wouldn't let us upload anything other than images. We
    then added code to the `media_example` view to resize the uploaded image using
    PIL.
  id: totrans-332
  prefs: []
  type: TYPE_NORMAL
- en: We have encouraged the use of a separate web server to serve static and media
    files, for performance reasons. However, in some cases, you might want to use
    Django to serve files, for example, to provide authentication before allowing
    access. In the next section, we will discuss how to use Django to serve media
    files.
  id: totrans-333
  prefs: []
  type: TYPE_NORMAL
- en: Serving Uploaded (and Other) Files Using Django
  id: totrans-334
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Throughout this chapter and *Chapter 5*, *Serving Static Files*, we have discouraged
    serving files using Django. This is because it would needlessly tie up a Python
    process just serving a file – something that the web server is capable of handling.
    Unfortunately, web servers do not usually provide dynamic access control, that
    is, allowing only authenticated users to download a file. Depending on your web
    server used in production, you might be able to have it authenticate against Django
    and then serve the file itself; however, the specific configuration of specific
    web servers is outside the scope of this book.
  id: totrans-335
  prefs: []
  type: TYPE_NORMAL
- en: One approach you can take is to specify a subdirectory of your `MEDIA_ROOT`
    directory and have your web server prevent access to just this specific folder.
    Any protected media should be stored inside it. If you do this, only Django will
    be able to read the files inside. For example, your web server could serve everything
    in the `MEDIA_ROOT` directory, except for a `MEDIA_ROOT/protected` directory.
  id: totrans-336
  prefs: []
  type: TYPE_NORMAL
- en: Another approach would be to configure a Django view to serve a specific file
    from disk. The view will determine the path of the file on disk to send, then
    send it using the `FileResponse` class. The `FileResponse` class takes an open
    filehandle as an argument and tries to determine the correct content type from
    the file's content. Django will close the filehandle after the request completes.
  id: totrans-337
  prefs: []
  type: TYPE_NORMAL
- en: The view function will accept the request and a relative path to the file to
    be downloaded, as parameters. This relative path is the path inside the `MEDIA_ROOT/protected`
    folder.
  id: totrans-338
  prefs: []
  type: TYPE_NORMAL
- en: 'In our case, we will just check whether the user is anonymous (not logged in).
    We will do this by checking the `request.user.is_anonymous` property. If they
    are not logged in then we will raise a `django.core.exceptions.PermissionDenied`
    exception, which returns an HTTP `403 Forbidden` response to the browser. This
    will stop the execution of the view and not return any file:'
  id: totrans-339
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE68]'
  id: totrans-340
  prefs: []
  type: TYPE_PRE
  zh: '[PRE68]'
- en: 'The URL mapping to this view could be like this, using the `<path>` path converter.
    Inside your `urls.py` file:'
  id: totrans-341
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE69]'
  id: totrans-342
  prefs: []
  type: TYPE_PRE
  zh: '[PRE69]'
- en: There are many ways that you could choose to implement a view that sends files.
    The important thing is that you use the `FileResponse` class, which is designed
    to stream the file to the client in chunks instead of loading it all into memory.
    This will reduce the load on the server and lessen the impact on resource usage
    if you have to resort to sending files with Django.
  id: totrans-343
  prefs: []
  type: TYPE_NORMAL
- en: Storing Files on Model Instances
  id: totrans-344
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: So far, we have manually managed the uploading and saving of files. You can
    also associate a file with a model instance by assigning the path to which it
    was saved to a `CharField`. However, as with much of Django, this capability (and
    more) is already provided with the `models.FileField` class. `FileField` instances
    do not actually store the file data; instead, they store the path where the file
    is stored (like a `CharField` would), but they also provide helper methods. These
    methods assist with loading files (so you do not have to manually open them) and
    generating disk paths for you based on the ID of the instance (or other attributes).
  id: totrans-345
  prefs: []
  type: TYPE_NORMAL
- en: '`FileField` can accept two specific optional arguments in its constructor (as
    well as the base `Field` arguments, such as `required`, `unique`, `help_text`,
    and so on):'
  id: totrans-346
  prefs: []
  type: TYPE_NORMAL
- en: '`max_length`: Like `max_length` in the form''s `ImageField`, this is the maximum
    length of the filename that is allowed.'
  id: totrans-347
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`upload_to`: The `upload_to` argument has three different behaviors depending
    on what type of variable is passed to it. Its simplest use is with a string or
    `pathlib.Path` object. The path is simply appended to `MEDIA_ROOT`.'
  id: totrans-348
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'In this example, `upload_to` is just defined as a string:'
  id: totrans-349
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE70]'
  id: totrans-350
  prefs: []
  type: TYPE_PRE
  zh: '[PRE70]'
- en: Files saved to this `FileField` would be stored in the `MEDIA_ROOT/files` directory.
  id: totrans-351
  prefs: []
  type: TYPE_NORMAL
- en: 'You could achieve the same result using a `pathlib.Path` instance too:'
  id: totrans-352
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE71]'
  id: totrans-353
  prefs: []
  type: TYPE_PRE
  zh: '[PRE71]'
- en: The next way of using `upload_to` is with a string that contains `strftime`
    formatting directives (for example, `%Y` to substitute the current year, `%m`
    for the current month, and `%d` for the current day of the month). The full list
    of these directives is extensive and can be found at [https://docs.python.org/3/library/time.html#time.strftime](https://docs.python.org/3/library/time.html#time.strftime).
    Django will automatically interpolate these values when saving the file.
  id: totrans-354
  prefs: []
  type: TYPE_NORMAL
- en: 'For example, say you defined the model and `FileField` like this:'
  id: totrans-355
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE72]'
  id: totrans-356
  prefs: []
  type: TYPE_PRE
  zh: '[PRE72]'
- en: For the first file uploaded on a specific day, Django would create the directory
    structure for that day. For example, for the first file uploaded on January 1,
    2020, Django would create the directory `MEDIA_ROOT/2020/01/01` and then store
    the uploaded file in there. The next file (and all subsequent ones) uploaded on
    the same day would also be stored in that directory. Similarly, on January 2,
    2020, Django would create the `MEDIA_ROOT/2020/01/02` directory, and files would
    be stored there.
  id: totrans-357
  prefs: []
  type: TYPE_NORMAL
- en: If you have many thousands of files being uploaded every day, you could even
    have the files split up further by including the hour and minute in the `upload_to`
    argument (`upload_to="files/%Y/%m/%d/%H/%M/"`). This may not be necessary if you
    only have a small volume of uploads though.
  id: totrans-358
  prefs: []
  type: TYPE_NORMAL
- en: By utilizing this method of the `upload_to` argument, you can have Django automatically
    segregate uploads and prevent too many files from being stored within a single
    directory (which can be hard to manage).
  id: totrans-359
  prefs: []
  type: TYPE_NORMAL
- en: 'The final method of using `upload_to` is by passing a function that will be
    called to generate the storage path. Note that this is different than the other
    uses of `upload_to` as it should generate the full path, including filename, rather
    than just the directory. The function takes two arguments: `instance` and `filename`.
    `instance` is the model instance that the `FileField` is attached to, and `filename`
    is the name of the uploaded file.'
  id: totrans-360
  prefs: []
  type: TYPE_NORMAL
- en: 'Here is an example function that takes the first two characters of a filename
    to generate the saved directory. This will mean that each uploaded file will be
    grouped into parent directories, which can help organize files and prevent there
    from being too many in one directory:'
  id: totrans-361
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE73]'
  id: totrans-362
  prefs: []
  type: TYPE_PRE
  zh: '[PRE73]'
- en: 'If this function is called with the filename `Test.jpg`, it will return `<username>/t/e/Test.jpg`.
    If called with `example.txt`, it will return `<username>e/x/example.txt`, and
    so on. `username` is retrieved from the instance that is being saved. To illustrate,
    here is a model with a `FileField` that uses this function. It also has a username,
    which is a `CharField`:'
  id: totrans-363
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE74]'
  id: totrans-364
  prefs: []
  type: TYPE_PRE
  zh: '[PRE74]'
- en: You can use any attribute of the instance in the `upload_to` function, but be
    aware that if this instance is in the process of being created, then the file
    save function will be called before it is saved to the database. Therefore, some
    of the automatically generated attributes on the instance (such as `id`/`pk`)
    will not yet be populated and should not be used to generate a path.
  id: totrans-365
  prefs: []
  type: TYPE_NORMAL
- en: Whatever path is returned from the `upload_to` function, it is appended to `MEDIA_ROOT`
    so the uploaded files would be saved at `MEDIA_ROOT/<username>/t/e/Test.jpg` and
    `MEDIA_ROOT/<username>/e/x/example.txt` respectively.
  id: totrans-366
  prefs: []
  type: TYPE_NORMAL
- en: Note that `user_grouped_file_path` is just an illustrative function that has
    intentionally been kept short, so it will not work correctly with single-character
    filenames or if the username has invalid characters. For example, if the username
    has a `/` in it, then this would act as a directory separator in the generated
    path.
  id: totrans-367
  prefs: []
  type: TYPE_NORMAL
- en: 'Now we have done a deep dive into setting up a `FileField` on a model, but
    how do we actually save an uploaded file to it? It is as easy as assigning the
    uploaded file to the attribute of the model, as you would with any type of value.
    Here is a quick example with a view, and the simple `ExampleModel` class we were
    using as an example earlier in this section:'
  id: totrans-368
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE75]'
  id: totrans-369
  prefs: []
  type: TYPE_PRE
  zh: '[PRE75]'
- en: In this example, we create a new `ExampleModel` class and assign the uploaded
    file (which had the name `uploaded_file` in the form) to its `file_field` attribute.
    When we save the model instance, Django automatically writes the file with its
    name to the `upload_to` directory path. If the uploaded file had the name `image.jpg`,
    the save path would be `MEDIA_ROOT/upload_to/image.jpg`.
  id: totrans-370
  prefs: []
  type: TYPE_NORMAL
- en: 'We could just have easily updated the file field on an existing model or used
    a form (validating it before saving). Here is another simple example demonstrating
    this:'
  id: totrans-371
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE76]'
  id: totrans-372
  prefs: []
  type: TYPE_PRE
  zh: '[PRE76]'
- en: You can see that updating a `FileField` on an existing model instance is the
    same process as setting it on a new instance; and if you choose to use a Django
    form, or just access `request.FILES` directly, the process is just as simple.
  id: totrans-373
  prefs: []
  type: TYPE_NORMAL
- en: Storing Images on Model Instances
  id: totrans-374
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: While a `FileField` can store any type of file, including images, there is also
    an `ImageField`. As you would expect, this is only for storing images. The relationship
    between models' `forms.FileField` and `forms.ImageField` is similar to that between
    `models.FileField` and `models.ImageField`, that is, `ImageField` extends `FileField`
    and adds extra methods for working with images.
  id: totrans-375
  prefs: []
  type: TYPE_NORMAL
- en: 'The `ImageField` constructor takes the same arguments as `FileField`, and adds
    two extra optional arguments:'
  id: totrans-376
  prefs: []
  type: TYPE_NORMAL
- en: '`height_field`: This is the name of the field of the model that will be updated
    with the height of the image every time the model instance is saved.'
  id: totrans-377
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`width_field`: The width counterpart to `height_field`, the field that stores
    the width of the image that is updated every time the model instance is saved.'
  id: totrans-378
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Both of these arguments are optional, but the fields they name must exist if
    used. That is, it is valid to have `height_field` or `width_field` unset, but
    if they are set to the name of a field that does not exist, then an error will
    occur. The purpose of this is to assist with searching the database for files
    of a particular dimension.
  id: totrans-379
  prefs: []
  type: TYPE_NORMAL
- en: 'Here is an example model using an `ImageField`, which updates the image dimension
    fields:'
  id: totrans-380
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE77]'
  id: totrans-381
  prefs: []
  type: TYPE_PRE
  zh: '[PRE77]'
- en: Notice that the `ImageField` is using the `upload_to` parameter with date formatting
    directives that are updated on save. The behavior of `upload_to` is identical
    to that of `FileField`.
  id: totrans-382
  prefs: []
  type: TYPE_NORMAL
- en: Upon saving an `ExampleModel` instance, its `image_height` field would be updated
    with the height of the image, and `image_width` with the width of the image.
  id: totrans-383
  prefs: []
  type: TYPE_NORMAL
- en: We will not show examples for setting `ImageField` values in a view, as the
    process is the same as for a plain `FileField`.
  id: totrans-384
  prefs: []
  type: TYPE_NORMAL
- en: Working with FieldFile
  id: totrans-385
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: When you access a `FileField` or `ImageField` attribute of a model instance,
    you will not get a native Python `file` object. Instead, you will be working with
    a `FieldFile` object. The `FieldFile` class is a wrapper around a `file` that
    adds extra methods. Yes, it can be confusing to have classes called `FileField`
    and `FieldFile`.
  id: totrans-386
  prefs: []
  type: TYPE_NORMAL
- en: The reason that Django uses `FieldFile` instead of just a `file` object is twofold.
    First, it adds extra methods to open, read, delete, and generate the URL of the
    file. Second, it provides an abstraction to allow alternative storage engines
    to be used.
  id: totrans-387
  prefs: []
  type: TYPE_NORMAL
- en: Custom Storage Engines
  id: totrans-388
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: We looked at custom storage engines in *Chapter 5*, *Serving Static Files*,
    regarding storing static files. We will not examine custom storage engines in
    detail about media files, since the code outlined in *Chapter 5*, *Serving Static
    Files*, for static files also applies to media files. The important thing to note
    is that the storage engine you are using can be changed without updating your
    other code. This means that you can have your media files stored on your local
    drive during development and then saved to a CDN when your application is deployed
    to production.
  id: totrans-389
  prefs: []
  type: TYPE_NORMAL
- en: 'The default storage engine class can be set with `DEFAULT_FILE_STORAGE` in
    `settings.py`. The storage engine can also be specified on a per-field basis (for
    `FileField` or `ImageField`) with the `storage` argument. For example:'
  id: totrans-390
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE78]'
  id: totrans-391
  prefs: []
  type: TYPE_PRE
  zh: '[PRE78]'
- en: This demonstrates what actually happens when you upload or retrieve a file.
    Django delegates to the storage engine to write or read it, respectively. This
    happens even while saving to disk; however, it is fundamental and is invisible
    to the user.
  id: totrans-392
  prefs: []
  type: TYPE_NORMAL
- en: Reading a Stored FieldFile
  id: totrans-393
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Now that we have learned about custom storage engines, let us look at reading
    from a `FieldFile`. In the previous sections, we saw how to set the file on the
    model instance. Reading the data back again is just as easy – we have a couple
    of different methods that can help us, depending on our use case.
  id: totrans-394
  prefs: []
  type: TYPE_NORMAL
- en: 'In the following few code snippets, assume we are inside a view and have retrieved
    our model instance in some manner, and it is stored in a variable, `m`. For example:'
  id: totrans-395
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE79]'
  id: totrans-396
  prefs: []
  type: TYPE_PRE
  zh: '[PRE79]'
- en: 'We can read all the data from the file with the `read` method:'
  id: totrans-397
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE80]'
  id: totrans-398
  prefs: []
  type: TYPE_PRE
  zh: '[PRE80]'
- en: 'Or we can manually open the file with the `open` method. This might be useful
    if we want to write our own generated data to the file:'
  id: totrans-399
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE81]'
  id: totrans-400
  prefs: []
  type: TYPE_PRE
  zh: '[PRE81]'
- en: 'If we wanted to read the file in chunks, we can use the `chunks` method. This
    works the same as reading chunks from the uploaded file, as we saw earlier:'
  id: totrans-401
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE82]'
  id: totrans-402
  prefs: []
  type: TYPE_PRE
  zh: '[PRE82]'
- en: 'We can also manually open the file ourselves by using its `path` attribute:'
  id: totrans-403
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE83]'
  id: totrans-404
  prefs: []
  type: TYPE_PRE
  zh: '[PRE83]'
- en: 'If we want to stream a `FileField` for download, the best way is by using the
    `FileResponse` class as we saw earlier. Combine this with the `open` method on
    the `FileField`. Note that if we are just trying to serve a media file, we should
    only implement a view to do this if we are trying to restrict access to the file.
    Otherwise, we should just serve the file using `MEDIA_URL` and allow the web server
    to handle the request. Here is how we''d write our `download_view` to use a `FileField`
    instead of the manually specified path:'
  id: totrans-405
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE84]'
  id: totrans-406
  prefs: []
  type: TYPE_PRE
  zh: '[PRE84]'
- en: Django opens the correct path and closes it after the response. Django will
    also attempt to determine the correct mime type for the file. We assume that this
    `FileField` has its `upload_to` attribute set to a protected directory that the
    web server is preventing direct access to.
  id: totrans-407
  prefs: []
  type: TYPE_NORMAL
- en: Storing Existing Files or Content in FileField
  id: totrans-408
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'We''ve seen how to store an uploaded file in an image field – simply assign
    it to the field like so:'
  id: totrans-409
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE85]'
  id: totrans-410
  prefs: []
  type: TYPE_PRE
  zh: '[PRE85]'
- en: 'But how can we set the `field` value to that of an existing file that we might
    already have on disk? You might think you can use a standard Python `file` object,
    but this won''t work:'
  id: totrans-411
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE86]'
  id: totrans-412
  prefs: []
  type: TYPE_PRE
  zh: '[PRE86]'
- en: 'You might also try setting the file using some content:'
  id: totrans-413
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE87]'
  id: totrans-414
  prefs: []
  type: TYPE_PRE
  zh: '[PRE87]'
- en: This won't work either.
  id: totrans-415
  prefs: []
  type: TYPE_NORMAL
- en: You instead need to use the `save` method of `FileField`, which accepts an instance
    of a Django `File` or `ContentFile` object (these classes' full paths are `django.core.files.File`
    and `django.core.files.base.ContentFile`, respectively). We will briefly discuss
    the `save` method and its arguments then return to these classes.
  id: totrans-416
  prefs: []
  type: TYPE_NORMAL
- en: 'The `save` method of `FileField` takes three arguments:'
  id: totrans-417
  prefs: []
  type: TYPE_NORMAL
- en: '`name`: The name of the file you are saving. This is the name the file will
    have when saved to the storage engine (in our case, to disk, inside `MEDIA_ROOT`).'
  id: totrans-418
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`Content`: This is an instance of `File` or `ContentFile`, which we just saw;
    again, we will discuss these soon.'
  id: totrans-419
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`Save`: This argument is optional and defaults to `True`. This indicates whether
    or not to save the model instance to the database after saving the file. If set
    to `False` (that is, the model is not saved), then the file will still be written
    to the storage engine (to disk), but the association is not stored on the model.
    The previous file path (or no file if one was not set) will still be stored in
    the database until the model instance''s `save` method is called manually. You
    should only set this argument to `False` if you intend to make other changes to
    the model instance and then save it manually.'
  id: totrans-420
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'Back to `File` and `ContentFile`: the one to use depends on what you want to
    store in a `FileField`.'
  id: totrans-421
  prefs: []
  type: TYPE_NORMAL
- en: '`File` is used as a wrapper around a Python `file` object, and you should use
    it if you have an existing `file` or file-like object that you want to save. File-like
    objects include `io.BytesIO` or `io.StringIO` instances. To instantiate a `File`
    instance, just pass the native `file` object to the constructor, for example:'
  id: totrans-422
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE88]'
  id: totrans-423
  prefs: []
  type: TYPE_PRE
  zh: '[PRE88]'
- en: 'Use `ContentFile` when you already have some data loaded, either a `str` or
    `bytes` object. Pass the data to the `ContentFile` constructor:'
  id: totrans-424
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE89]'
  id: totrans-425
  prefs: []
  type: TYPE_PRE
  zh: '[PRE89]'
- en: 'Now that you have either a `File` or `ContentFile` instance, saving the data
    to the `FileField` is easy, using the `save` method:'
  id: totrans-426
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE90]'
  id: totrans-427
  prefs: []
  type: TYPE_PRE
  zh: '[PRE90]'
- en: Since we did not pass a value for `save` to the `save` method, it will default
    to `True`, so the model instance is automatically persisted to the database.
  id: totrans-428
  prefs: []
  type: TYPE_NORMAL
- en: Next, we will look at how to store an image that has been manipulated with a
    PIL back to an image field.
  id: totrans-429
  prefs: []
  type: TYPE_NORMAL
- en: Writing PIL Images to ImageField
  id: totrans-430
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'In *Exercise 8.05*, *Image Uploads Using Django Forms*, you used PIL to resize
    an image and save it to disk. When working with a model, you might want to perform
    a similar operation, but have Django handle the file storage using the `ImageField`
    so that you do not have to do it manually. As in the exercise, you could save
    the image to disk and then use the `File` class to wrap the stored path – something
    like this:'
  id: totrans-431
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE91]'
  id: totrans-432
  prefs: []
  type: TYPE_PRE
  zh: '[PRE91]'
- en: In this example, we're having PIL stored to a temporary location with the `Image.save()`
    method, and then re-opening the file.
  id: totrans-433
  prefs: []
  type: TYPE_NORMAL
- en: This method works but is not ideal as it involves writing the file to disk and
    then reading it out again, which can sometimes be slow. Instead, we can perform
    this whole process in memory.
  id: totrans-434
  prefs: []
  type: TYPE_NORMAL
- en: Note
  id: totrans-435
  prefs: []
  type: TYPE_NORMAL
- en: '`io.BytesIO` and `io.StringIO` are useful objects. They behave like files but
    exist in memory only. `BytesIO` is used for storing raw bytes, and `StringIO`
    accepts Python 3''s native Unicode strings. You can `read`, `write`, and `seek`
    them, just like a normal file. Unlike a normal file though, they do not get written
    to disk and instead will disappear when your program terminates, or they go out
    of scope and are garbage-collected. They are very useful if a function wants to
    write to something like a file, but you want to access the data immediately.'
  id: totrans-436
  prefs: []
  type: TYPE_NORMAL
- en: First, we will save the image data to an `io.BytesIO` object. Then, we will
    wrap the `BytesIO` object in a `django.core.files.images.ImageFile` instance (a
    subclass of `File` that is specifically for images and provides `width` and `height`
    attributes). Once we have this `ImageFile` instance, we can use it in the `save`
    method of `ImageField`.
  id: totrans-437
  prefs: []
  type: TYPE_NORMAL
- en: Note
  id: totrans-438
  prefs: []
  type: TYPE_NORMAL
- en: 'An `ImageFile` is a file or file-like wrapper just like `File`. It provides
    two extra attributes: `width`, and `height`. `ImageFile` does not generate any
    errors if you use it to wrap a non-image. For example, you could `open()` a text
    file and pass the filehandle to the `ImageFile` constructor without any issue.
    You can check whether the image file you passed in was valid by trying to access
    the `width` or `height` attributes: if these are `None`, then PIL was unable to
    decode the image data. You could check for the validity of these values yourself
    and throw an exception if they were `None`.'
  id: totrans-439
  prefs: []
  type: TYPE_NORMAL
- en: 'Let us have a look at this in practice, in a view:'
  id: totrans-440
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE92]'
  id: totrans-441
  prefs: []
  type: TYPE_PRE
  zh: '[PRE92]'
- en: You can see this is a little bit more code, but it saves on writing the data
    to disk. You can choose to use either method (or another one that you come up
    with) depending on your needs.
  id: totrans-442
  prefs: []
  type: TYPE_NORMAL
- en: Referring to Media in Templates
  id: totrans-443
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Once we have uploaded a file, we want to be able to refer to it in a template.
    For an uploaded image, such as a book cover, we will want to be able to display
    the image on the page. We saw in *Exercise 8.02*, *Template Settings and Using
    MEDIA_URL in Templates*, how to build a URL using `MEDIA_URL` in a template. When
    working with `FileField` or `ImageField` on a model instance, it is not necessary
    to do this as Django provides this functionality for you.
  id: totrans-444
  prefs: []
  type: TYPE_NORMAL
- en: The `url` attribute of a `FileField` will automatically generate the full URL
    to the media file, based on the `MEDIA_URL` in your settings.
  id: totrans-445
  prefs: []
  type: TYPE_NORMAL
- en: Note
  id: totrans-446
  prefs: []
  type: TYPE_NORMAL
- en: Note that references we make to a `FileField` in this section also apply to
    `ImageField`, as it is a subclass of `FileField`.
  id: totrans-447
  prefs: []
  type: TYPE_NORMAL
- en: 'This can be used anywhere that you have access to the instance and field, such
    as in a view or a template. For example, in a view:'
  id: totrans-448
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE93]'
  id: totrans-449
  prefs: []
  type: TYPE_PRE
  zh: '[PRE93]'
- en: 'Or in a template (assuming the `instance` has been passed to the template context):'
  id: totrans-450
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE94]'
  id: totrans-451
  prefs: []
  type: TYPE_PRE
  zh: '[PRE94]'
- en: In the next exercise, we will create a new model with a `FileField` and `ImageField`,
    then show how Django can automatically save these. We'll also demonstrate how
    to retrieve the URL for an uploaded file.
  id: totrans-452
  prefs: []
  type: TYPE_NORMAL
- en: 'Exercise 8.06: FileField and ImageField on Models'
  id: totrans-453
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In this exercise, we will create a model with a `FileField` and `ImageField`.
    After doing this, we will have to generate a migration and apply it. We will then
    change the `UploadForm` we have been using so it has both a `FileField` and an
    `ImageField`. The `media_example` view will be updated to store the uploaded files
    in the model instance. Finally, we will add an `<img>` into the example template
    to show the previously uploaded image:'
  id: totrans-454
  prefs: []
  type: TYPE_NORMAL
- en: 'In PyCharm, open the `media_example` app''s `models.py` file. Create a new
    model called `ExampleModel`, with two fields: an `ImageField` named `image_field`,
    and a `FileField` called `file_field`. The `ImageField` should have its `upload_to`
    set to `images/`, and the `FileField` should have its `upload_to` set to `files/`.
    The finished model should look like this:'
  id: totrans-455
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE95]'
  id: totrans-456
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE95]'
- en: 'Your `models.py` should now look like this: [http://packt.live/3p4bfrr](http://packt.live/3p4bfrr).'
  id: totrans-457
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Open a terminal and navigate to the `media_project` project directory. Make
    sure your `bookr` virtual environment is active. Run the `makemigrations` management
    command to generate the migrations for this new model (for Windows, you can use
    `python` instead of `python3` in the following code):'
  id: totrans-458
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE96]'
  id: totrans-459
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE96]'
- en: 'Apply the migration by running the `migrate` management command:'
  id: totrans-460
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE97]'
  id: totrans-461
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE97]'
- en: 'The output is like the following:'
  id: totrans-462
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE98]'
  id: totrans-463
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE98]'
- en: Note that all the initial Django migrations will also be applied since we did
    not apply those after creating the project.
  id: totrans-464
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Switch back to PyCharm and open the `reviews` app''s `forms.py` file. Rename
    the existing `ImageField` from `file_upload` to `image_upload`. Then, add a new
    `FileField` named `file_upload`. After making these changes, your `UploadForm`
    code should look like this:'
  id: totrans-465
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE99]'
  id: totrans-466
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE99]'
- en: 'You can save and close the file. It should look like this: [http://packt.live/37RZcaG](http://packt.live/37RZcaG).'
  id: totrans-467
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Open the `media_example` app''s `views.py` file. First, import `ExampleModel`
    into the file. To do this, add this line at the top of the file after the existing
    `import` statements:'
  id: totrans-468
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE100]'
  id: totrans-469
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE100]'
- en: 'Some imports will no longer be required, so you can remove these lines:'
  id: totrans-470
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE101]'
  id: totrans-471
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE101]'
- en: 'In the `media_example` view, set a default for the instance that you will render,
    in case one is not created. After the function definition, define a variable called
    `instance`, and set it to `None`:'
  id: totrans-472
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE102]'
  id: totrans-473
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE102]'
- en: You can completely remove the contents of the `form.is_valid()` branch as you
    no longer need to manually save the file. Instead, it will automatically be saved
    when the `ExampleModel` instance is saved. You will instantiate an `ExampleModel`
    instance and set the `file` and `image` fields from the uploaded form.
  id: totrans-474
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'Add this code under the `if form.is_valid():` line:'
  id: totrans-475
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '[PRE103]'
  id: totrans-476
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE103]'
- en: 'Pass the instance through to the template in the context dictionary that is
    passed to `render`. Use the key `instance`:'
  id: totrans-477
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE104]'
  id: totrans-478
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE104]'
- en: 'Now, your completed `media_example` view should look like this: [http://packt.live/3hqyYz7](http://packt.live/3hqyYz7).'
  id: totrans-479
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: You can now save and close this file.
  id: totrans-480
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Open the `media-example.html` template. Add an `<img>` element that displays
    the last uploaded image. Under the closing `</form>` tag, add an `if` template
    tag that checks if an `instance` has been provided. If so, display an `<img>`
    with a `src` attribute of `instance.image_field.url`:'
  id: totrans-481
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE105]'
  id: totrans-482
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE105]'
- en: 'You can save and close this file. It should now look like this: [http://packt.live/2X5d5w9](http://packt.live/2X5d5w9).'
  id: totrans-483
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Start the Django dev server if it is not already running, then navigate to
    `http://127.0.0.1:8000/media-example/`. You should see the form rendered with
    two fields:![Figure 8.20: UploadForm with two fields'
  id: totrans-484
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '](img/B15509_08_20.jpg)'
  id: totrans-485
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Figure 8.20: UploadForm with two fields'
  id: totrans-486
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Select a file for each field – for the `ImageField` you must select an image,
    but any type of file is allowed for the `FileField`. See *Figure 8.21*, which
    shows the fields with files selected:![Figure 8.21: ImageField and FileField with
    files selected'
  id: totrans-487
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '](img/B15509_08_21.jpg)'
  id: totrans-488
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Figure 8.21: ImageField and FileField with files selected'
  id: totrans-489
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Then, submit the form. If the submission was successful, the page will reload
    and the last image you uploaded will be displayed (*Figure 8.22*):'
  id: totrans-490
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '![Figure 8.22: The last image that was uploaded is displayed'
  id: totrans-491
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: '](img/B15509_08_22.jpg)'
  id: totrans-492
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Figure 8.22: The last image that was uploaded is displayed'
  id: totrans-493
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'You can see how Django stores the files by looking in the `MEDIA_ROOT` directory.
    *Figure 8.23* shows the directory layout in PyCharm:![Figure 8.23: Uploaded files
    that Django has created'
  id: totrans-494
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '](img/B15509_08_23.jpg)'
  id: totrans-495
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Figure 8.23: Uploaded files that Django has created'
  id: totrans-496
  prefs: []
  type: TYPE_NORMAL
- en: You can see that Django has created the `files` and `images` directories. These
    were what you set in the `upload_to` arguments on the `ImageField` and `FileField`
    of the model. You could also verify these uploads by attempting to download them,
    for example, at `http://127.0.0.1:8000/media/files/sample.txt` or `http://127.0.0.1:8000/media/images/cover.jpg`.
  id: totrans-497
  prefs: []
  type: TYPE_NORMAL
- en: In this exercise, we created `ExampleModel` with `FileField` and `ImageField`
    and saw how to store uploaded files in it. We saw how to generate a URL to an
    uploaded file for use in a template. We tried uploading some files and saw that
    Django automatically created the `upload_to` directories (`media/files` and `media/images`),
    then stored the files inside.
  id: totrans-498
  prefs: []
  type: TYPE_NORMAL
- en: In the next section, we will look at how we can simplify the process even further
    by using a `ModelForm` to generate the form and save the model without having
    to manually set the files in the view.
  id: totrans-499
  prefs: []
  type: TYPE_NORMAL
- en: ModelForms and File Uploads
  id: totrans-500
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We have seen how using a `form.ImageField` on a form can prevent non-images
    being uploaded. We have also seen how `models.ImageField` makes it easy to store
    an image for a model. But we need to be aware that Django does not stop you from
    setting a non-image file to an `ImageField`. For example, consider a form that
    has both a `FileField` and `ImageField`:'
  id: totrans-501
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE106]'
  id: totrans-502
  prefs: []
  type: TYPE_PRE
  zh: '[PRE106]'
- en: 'In the following view, the form would not validate if the `uploaded_image`
    field on the form was not an image, so some data validity is ensured for uploaded
    data. For example:'
  id: totrans-503
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE107]'
  id: totrans-504
  prefs: []
  type: TYPE_PRE
  zh: '[PRE107]'
- en: Since we are sure the form is valid, we know that `forms.cleaned_data["uploaded_image"]`
    must contain an image. Therefore, we would never assign a non-image to the model
    instance's `image_field`.
  id: totrans-505
  prefs: []
  type: TYPE_NORMAL
- en: 'However, say we made a mistake in our code and wrote something like this:'
  id: totrans-506
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE108]'
  id: totrans-507
  prefs: []
  type: TYPE_PRE
  zh: '[PRE108]'
- en: That is, if we accidentally reference the `FileField` by mistake, Django does
    not validate that a (potential) non-image is being assigned to an `ImageField`,
    and so it does not throw an exception or generate any kind of error. We can mitigate
    the potential for issues like this by using a `ModelForm`.
  id: totrans-508
  prefs: []
  type: TYPE_NORMAL
- en: We introduced `ModelForm` in *Chapter 7*, *Advanced Form Validation and Model
    Forms* – these are forms whose fields are automatically defined from a model.
    We saw that a `ModelForm` has a `save` method that automatically creates or updates
    the model data in the database. When used with a model that has a `FileFIeld`
    or `ImageField`, then the `ModelForm` `save` method will also save uploaded files.
  id: totrans-509
  prefs: []
  type: TYPE_NORMAL
- en: 'Here is an example of using a `ModelForm` to save a new model instance in a
    view. Here, we are just making sure to pass `request.FILES` to the `ModelForm` constructor:'
  id: totrans-510
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE109]'
  id: totrans-511
  prefs: []
  type: TYPE_PRE
  zh: '[PRE109]'
- en: 'As with any `ModelForm`, the `save` method can be called with the `commit`
    argument set to `False`. Then the model instance will not be saved to the database,
    and the `FileField`/`ImageField` files will not be saved to disk. The `save` method
    should be called on the model instance itself – this will commit changes to the
    database and save the files. In this next short example, we set a value on the
    model instance before saving it:'
  id: totrans-512
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE110]'
  id: totrans-513
  prefs: []
  type: TYPE_PRE
  zh: '[PRE110]'
- en: Calling the `save` method on the model instance both saves the model data to
    the database and the uploaded files to disk. In the next exercise, we will build
    a `ModelForm` from `ExampleModel`, which we created in *Exercise 8.06*, *FileField
    and ImageField on Models*, then test uploading files with it.
  id: totrans-514
  prefs: []
  type: TYPE_NORMAL
- en: 'Exercise 8.07: File and Image Uploads Using a ModelForm'
  id: totrans-515
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In this exercise, you will update `UploadForm` to be a subclass of `ModelForm`
    and have it built automatically from `ExampleModel`. You will then change the
    `media_example` view to save the instance automatically from the form, so you
    can see how the amount of code can be reduced:'
  id: totrans-516
  prefs: []
  type: TYPE_NORMAL
- en: 'In PyCharm, open the `media_example` apps'' `forms.py` file. You need to use
    `ExampleModel` in this chapter, so `import` it at the top of the file after the
    `from django import forms` statement. Insert this line:'
  id: totrans-517
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE111]'
  id: totrans-518
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE111]'
- en: 'Change `UploadForm` to be a subclass of `forms.ModelForm`. Remove the `class`
    body and replace it with a `class Meta` definition; its `model` should be `ExampleModel`.
    Set the `fields` attribute to `__all__`. After completing this step, your `UploadForm`
    should look like this:'
  id: totrans-519
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE112]'
  id: totrans-520
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE112]'
- en: 'Save and close the file. It should now look like this: [http://packt.live/37X49ig](http://packt.live/37X49ig).'
  id: totrans-521
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Open the `media_example` app''s `views.py` file. Since you no longer need to
    reference the `ExampleModel` directly, you can remove its `import` at the top
    of the file. Remove the following line:'
  id: totrans-522
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE113]'
  id: totrans-523
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE113]'
- en: 'In the `media_example` view, remove the entirety of the `form.is_valid()` branch
    and replace it with a single line:'
  id: totrans-524
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '[PRE114]'
  id: totrans-525
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE114]'
- en: The form's `save` method will handle persisting the instance to the database
    and saving the files. It will return an instance of `ExampleModel`, the same as
    the other instances of `ModelForm` we have worked with in *Chapter 7*, *Advanced
    Form Validation and Model Forms*.
  id: totrans-526
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'After completing this step, your `media_example` function should look like
    this: [http://packt.live/37V0ly2](http://packt.live/37V0ly2). Save and close `views.py`.'
  id: totrans-527
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Start the Django dev server if it is not already running, then navigate to
    `http://127.0.0.1:8000/media-example/`. You should see the form rendered with
    two fields, `Image field` and `File field` (*Figure 8.24*):![Figure 8.24: UploadForm
    as a ModelForm rendered in the browser'
  id: totrans-528
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '](img/B15509_08_24.jpg)'
  id: totrans-529
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Figure 8.24: UploadForm as a ModelForm rendered in the browser'
  id: totrans-530
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Note that the names of these fields now match those of the model rather than
    the form, as the form just uses the model's fields.
  id: totrans-531
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Browse and select an image and file (*Figure 8.25*), then submit the form:![Figure
    8.25: Image and file selected'
  id: totrans-532
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '](img/B15509_08_25.jpg)'
  id: totrans-533
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Figure 8.25: Image and file selected'
  id: totrans-534
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'The page will reload, and as in *Exercise 8.06*, *FileField and ImageField
    on Models*, you will see the previously uploaded image (*Figure 8.26*):![Figure
    8.26: Image being displayed after upload'
  id: totrans-535
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '](img/B15509_08_26.jpg)'
  id: totrans-536
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Figure 8.26: Image being displayed after upload'
  id: totrans-537
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Finally, examine the contents of the `media` directory. You should see the
    directory layout matches that of *Exercise 8.06*, *FileField and ImageField on
    Models*, with images inside the `images` directory, and files inside the `files`
    directory:![Figure 8.27: The uploaded files directory matches Exercise 8.06'
  id: totrans-538
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '](img/B15509_08_27.jpg)'
  id: totrans-539
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'Figure 8.27: The uploaded files directory matches Exercise 8.06'
  id: totrans-540
  prefs: []
  type: TYPE_NORMAL
- en: In this exercise, we changed `UploadForm` to be a `ModelForm` subclass, which
    allowed us to automatically generate the upload fields. We could replace the code
    that stored the uploaded files on the models with a call to the form's `save`
    method.
  id: totrans-541
  prefs: []
  type: TYPE_NORMAL
- en: We have now covered everything you need to start enhancing Bookr with file uploads.
    In the activity for this chapter, we will add support for uploading a cover image
    and sample document (PDF, text file, and more) for a book. The book cover will
    be resized using PIL before it is saved.
  id: totrans-542
  prefs: []
  type: TYPE_NORMAL
- en: 'Activity 8.01: Image and PDF Uploads of Books'
  id: totrans-543
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In this activity, you will start by cleaning up (deleting) the example views,
    templates, forms, models, and URL maps that we have used throughout the exercises
    in this chapter. You will then need to generate and apply a migration to delete
    `ExampleModel` from the database.
  id: totrans-544
  prefs: []
  type: TYPE_NORMAL
- en: You can then start adding the Bookr enhancements, first by adding an `ImageField`
    and `FileField` to the `Book` model to store the book `cover` and `sample`. Then
    you will create a migration and apply it to add these fields to the database.
    You can then build a form that will display just these new fields. You will add
    a view that uses this form to save the model instance with the uploaded files,
    after first resizing the image to thumbnail size. You will be able to reuse the
    `instance-form.html` template from *Chapter 7*, *Advanced Form Validation and
    Model Forms*, with a minor change to allow file uploads.
  id: totrans-545
  prefs: []
  type: TYPE_NORMAL
- en: 'These steps will help you complete the activity:'
  id: totrans-546
  prefs: []
  type: TYPE_NORMAL
- en: Update the Django settings to add the settings `MEDIA_ROOT` and `MEDIA_URL`.
  id: totrans-547
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The `/media/` URL mapping should be added to `urls.py`. Use the `static` view
    and utilize `MEDIA_ROOT` and `MEDIA_URL` from Django settings. Remember, this
    mapping should only be added if `DEBUG` is true.
  id: totrans-548
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Add an `ImageField` (named `cover`) and `FileField` (named `sample`) to the
    `Book` model. The fields should upload to `book_covers/` and `book_samples/`,
    respectively. They should both allow `null` and `blank` values.
  id: totrans-549
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Run `makemigrations` and `migrate` again to apply the `Book` model changes to
    the database.
  id: totrans-550
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Create a `BookMediaForm` as a subclass of `ModelForm`. Its model should be `Book`,
    and the fields should only be the fields you added in *step 3*.
  id: totrans-551
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Add a `book_media` view. This will not allow you to create a `Book`, instead,
    it will only allow you to add media to an existing `Book` (so it must take `pk`
    as a required argument).
  id: totrans-552
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The `book_media` view should validate the form, and `save` it, but not `commit`
    the instance. The uploaded cover should first be resized using the `thumbnail`
    method as demonstrated in the *Writing PIL Images to ImageField* section. The
    maximum size should be 300 by 300 pixels. It should then be stored on the instance
    and the instance saved. Remember that the `cover` field is not required so you
    should check this before trying to manipulate the image. On a successful `POST`,
    register a success message that the `Book` was updated, then redirect to the `book_detail`
    view.
  id: totrans-553
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Render the `instance-form.html`, passing a context dictionary containing `form`,
    `model_type,` and `instance`, as you did in *Chapter 6*, *Forms*. Also pass another
    item, `is_file_upload`, set to `True`. This variable will be used in the next
    step.
  id: totrans-554
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the `instance-form.html` template, use the `is_file_upload` variable to add
    the correct `enctype` attribute to the form. This will allow you to switch the
    modes for the form to enable file uploads when required.
  id: totrans-555
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Finally, add a URL map that maps `/books/<pk>/media/` to the `book_media` view.
  id: totrans-556
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'When you are finished, you should be able to start the Django dev server and
    load the `book_media` view at `http://127.0.0.1:8000/books/<pk>/media/`, for example,
    `http://127.0.0.1:8000/books/2/media/`. You should see the `BookMediaForm` rendered
    in the browser, like in *Figure 8.28*:'
  id: totrans-557
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 8.28: BookMediaForm in the browser'
  id: totrans-558
  prefs: []
  type: TYPE_NORMAL
- en: '](img/B15509_08_28.jpg)'
  id: totrans-559
  prefs: []
  type: TYPE_NORMAL
- en: 'Figure 8.28: BookMediaForm in the browser'
  id: totrans-560
  prefs: []
  type: TYPE_NORMAL
- en: Select a cover image and sample file for the book. You can use the image at
    [http://packt.live/2KyIapl](http://packt.live/2KyIapl) and PDF at [http://packt.live/37VycHn](http://packt.live/37VycHn)
    (or you can use any other image/PDF of your choosing).
  id: totrans-561
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 8.29: Book Cover image and Sample selected'
  id: totrans-562
  prefs: []
  type: TYPE_NORMAL
- en: '](img/B15509_08_29.jpg)'
  id: totrans-563
  prefs: []
  type: TYPE_NORMAL
- en: 'Figure 8.29: Book Cover image and Sample selected'
  id: totrans-564
  prefs: []
  type: TYPE_NORMAL
- en: 'After submitting the form, you will be redirected to the `Book Details` view
    and see the success message (*Figure 8.30*):'
  id: totrans-565
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 8.30: Success message on the Book Details page'
  id: totrans-566
  prefs: []
  type: TYPE_NORMAL
- en: '](img/B15509_08_30.jpg)'
  id: totrans-567
  prefs: []
  type: TYPE_NORMAL
- en: 'Figure 8.30: Success message on the Book Details page'
  id: totrans-568
  prefs: []
  type: TYPE_NORMAL
- en: 'If you go back to the same book''s media page, you should see the fields are
    now filled in, with an option to clear the data from them:'
  id: totrans-569
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 8.31: BookMediaForm with existing values'
  id: totrans-570
  prefs: []
  type: TYPE_NORMAL
- en: '](img/B15509_08_31.jpg)'
  id: totrans-571
  prefs: []
  type: TYPE_NORMAL
- en: 'Figure 8.31: BookMediaForm with existing values'
  id: totrans-572
  prefs: []
  type: TYPE_NORMAL
- en: 'In *Activity 8.02*, *Displaying Cover and Sample Links*, you will add these
    uploaded files to the `Book Details` view, but for now, if you want to check that
    uploads have worked, you can look inside the `media` directory in the Bookr project:'
  id: totrans-573
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 8.32: Book media'
  id: totrans-574
  prefs: []
  type: TYPE_NORMAL
- en: '](img/B15509_08_32.jpg)'
  id: totrans-575
  prefs: []
  type: TYPE_NORMAL
- en: 'Figure 8.32: Book media'
  id: totrans-576
  prefs: []
  type: TYPE_NORMAL
- en: You should see the directories that were created and the uploaded files, as
    per *Figure 8.32*. Open an uploaded image, and you should see its maximum dimension
    is 300 pixels.
  id: totrans-577
  prefs: []
  type: TYPE_NORMAL
- en: Note
  id: totrans-578
  prefs: []
  type: TYPE_NORMAL
- en: The solution to this activity can be found at [http://packt.live/2Nh1NTJ](http://packt.live/2Nh1NTJ).
  id: totrans-579
  prefs: []
  type: TYPE_NORMAL
- en: 'Activity 8.02: Displaying Cover and Sample Links'
  id: totrans-580
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In this activity, you will update the `book_detail.html` template to show the
    cover for the `Book` (if one is set). You will also add a link to download the
    sample, again, only if one is set. You will use the `FileField` and `ImageField`
    `url` attributes to generate the URLs to the media files.
  id: totrans-581
  prefs: []
  type: TYPE_NORMAL
- en: 'These steps will help you complete this activity:'
  id: totrans-582
  prefs: []
  type: TYPE_NORMAL
- en: Inside the `Book Details` display in the `book_detail.html` view, add an `<img>`
    element if the book has a `cover` image. Then, display the cover of the book inside
    it. Use `<br>` after the `<img>` tag so the image is on its own line.
  id: totrans-583
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: After the `Publication Date` display, add a link to the sample file. It should
    only be displayed if a `sample` file has been uploaded. Make sure you add another
    `<br>` tag so it displays correctly.
  id: totrans-584
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: In the section that has a link to add a review, add another link that goes to
    the media page for the book. Follow the same styling as the `Add Review` link.
  id: totrans-585
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'When you have completed these steps, you should be able to load a book detail
    page. If the book has no `cover` or `sample`, then the page should look very similar
    to what it did before, except you should see the new link to the `Media` page
    at the bottom (*Figure 8.33*):'
  id: totrans-586
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 8.33: New Media button visible on the book detail page'
  id: totrans-587
  prefs: []
  type: TYPE_NORMAL
- en: '](img/B15509_08_33.jpg)'
  id: totrans-588
  prefs: []
  type: TYPE_NORMAL
- en: 'Figure 8.33: New Media button visible on the book detail page'
  id: totrans-589
  prefs: []
  type: TYPE_NORMAL
- en: 'Once you have uploaded a `cover` and/or a `sample` for a `Book`, the cover
    image and sample link should be displayed (*Figure 8.34*):'
  id: totrans-590
  prefs: []
  type: TYPE_NORMAL
- en: '![Figure 8.34: Book cover and sample link displayed'
  id: totrans-591
  prefs: []
  type: TYPE_NORMAL
- en: '](img/B15509_08_34.jpg)'
  id: totrans-592
  prefs: []
  type: TYPE_NORMAL
- en: 'Figure 8.34: Book cover and sample link displayed'
  id: totrans-593
  prefs: []
  type: TYPE_NORMAL
- en: Note
  id: totrans-594
  prefs: []
  type: TYPE_NORMAL
- en: The solution to this activity can be found at [http://packt.live/2Nh1NTJ](http://packt.live/2Nh1NTJ).
  id: totrans-595
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  id: totrans-596
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, we added the `MEDIA_ROOT` and `MEDIA_URL` settings and a special
    URL map to serve media files. We then created a form and a view to upload files
    and save them to the `media` directory. We saw how to add the media context processor
    to automatically have access to the `MEDIA_URL` setting in all our templates.
    We then enhanced and simplified our form code by using a Django form with a `FileField`
    or `ImageField`, instead of manually defining one in HTML.
  id: totrans-597
  prefs: []
  type: TYPE_NORMAL
- en: We looked at some of the enhancements Django provides for images with the `ImageField`,
    and how to interact with an image using Pillow. We showed an example view that
    would be able to serve files that required authentication, using the `FileResponse`
    class. Then, we saw how to store files on models using the `FileField` and `ImageField`
    and refer to them in a template using the `FileField.url` attribute. We were able
    to reduce the amount of code we had to write by automatically building a `ModelForm`
    from a `model` instance. Finally, in the two activities at the end, we enhanced
    Bookr by adding a cover image and sample file to the `Book` model. In *Chapter
    9*, *Sessions and Authentication*, we will learn how to add authentication to
    a Django application to protect it from unauthorized users.
  id: totrans-598
  prefs: []
  type: TYPE_NORMAL
