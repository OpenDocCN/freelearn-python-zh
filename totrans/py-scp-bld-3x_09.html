<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer176">
<h1 class="chapter-number" id="_idParaDest-216"><a id="_idTextAnchor226"/>9</h1>
<h1 id="_idParaDest-217"><a id="_idTextAnchor227"/>Animation Drivers</h1>
<p>A <strong class="bold">driver</strong> is<a id="_idIndexMarker607"/> a function that controls the value of a property. It can take the value of other properties as input, creating a connection between two or more properties. For example, a driver might set the <em class="italic">X</em> location of an object based on the rotation of <span class="No-Break">another object.</span></p>
<p>Drivers are similar to animations, with which they share the update system and f-curve data but are way more flexible and can be combined with Python to create <span class="No-Break">custom setups.</span></p>
<p>They are an essential part of technical animation and are used for creating simple controls or complex mechanics. Drivers don’t have a specific purpose: they are designed to create custom behaviors. For that reason, they are ubiquitous in rigging and help connect properties, even between entities of different types, such as objects <span class="No-Break">and shaders.</span></p>
<p>In this chapter, you will learn how to create and test your Python drivers easily, as well as how to script their creation. Besides helping with automating rig mechanics, this knowledge will also make it easier for you to understand formulas and implement them <span class="No-Break">in Blender.</span></p>
<p>This chapter will cover the <span class="No-Break">following topics:</span></p>
<ul>
<li><span class="No-Break">Creating drivers</span></li>
<li>Using Python expressions <span class="No-Break">in drivers</span></li>
<li>Scripting <span class="No-Break">mathematic formulas</span></li>
<li>Automating the <span class="No-Break">driver setup</span></li>
</ul>
<h1 id="_idParaDest-218"><a id="_idTextAnchor228"/>Technical requirements</h1>
<p>We will use Blender and <strong class="bold">Visual Studio Code</strong> in this chapter, but any IDE will do. The examples that were created for this chapter can be found <span class="No-Break">at </span><a href="https://github.com/PacktPublishing/Python-Scripting-in-Blender/tree/main/ch9"><span class="No-Break">https://github.com/PacktPublishing/Python-Scripting-in-Blender/tree/main/ch9</span></a><span class="No-Break">.</span></p>
<h1 id="_idParaDest-219"><a id="_idTextAnchor229"/>Creating drivers</h1>
<p>The <a id="_idIndexMarker608"/>procedure for creating <strong class="bold">drivers</strong> is very similar to the one for creating animations. While the animation time is the only input of animation curves, drivers can depend on one or more of <span class="No-Break">the following:</span></p>
<ul>
<li>The result of <span class="No-Break">Python expressions</span></li>
<li>Any property that can <span class="No-Break">be animated</span></li>
<li>The transform channels <span class="No-Break">of objects</span></li>
<li>The difference in rotations <span class="No-Break">between objects</span></li>
<li>The distance <span class="No-Break">between objects</span></li>
</ul>
<p>When we create a driver, we must specify at least one input. In this section, we will learn how to set up a simple wheel by creating new drivers with the <span class="No-Break">user interface.</span></p>
<h2 id="_idParaDest-220"><a id="_idTextAnchor230"/>Creating quick drivers via the right-click menu</h2>
<p>There are <a id="_idIndexMarker609"/>a few shortcuts for creating <span class="No-Break">drivers quickly.</span></p>
<p>Let’s take a look at an example to understand these shortcuts. Suppose that, to animate a wheel, we want an object’s <strong class="bold">Location Y</strong> to drive its <strong class="bold">Rotation X</strong> channel. We can set this up for Blender’s <span class="No-Break">default cube:</span></p>
<ol>
<li>Open Blender or go back to the default scene via <strong class="bold">File</strong> | <strong class="bold">New</strong> | <span class="No-Break"><strong class="bold">General</strong></span><span class="No-Break">.</span></li>
<li>Select the default <strong class="bold">Cube</strong> to make <span class="No-Break">it active.</span></li>
<li>Press <em class="italic">N</em> to display the <span class="No-Break">Transform properties.</span></li>
</ol>
<p><strong class="bold">Location Y</strong> is our input. Rather than look for its data path, we will copy it to <span class="No-Break">the clipboard:</span></p>
<ol>
<li>Right-click on <strong class="bold">Location Y</strong> to display the <span class="No-Break"><strong class="bold">Y:</strong></span><span class="No-Break"> menu.</span></li>
<li>From the menu, pick <strong class="bold">Copy As </strong><span class="No-Break"><strong class="bold">New Driver</strong></span><span class="No-Break">.</span></li>
</ol>
<p>The driver doesn’t exist yet, so we must create it for the property we want <span class="No-Break">to affect:</span></p>
<ol>
<li>Right-click on <strong class="bold">Rotation X</strong> to display the <span class="No-Break"><strong class="bold">X:</strong></span><span class="No-Break"> menu.</span></li>
<li>From the menu, pick <span class="No-Break"><strong class="bold">Paste Driver</strong></span><span class="No-Break">.</span></li>
</ol>
<p>The <strong class="bold">Rotation X</strong> channel will be colored purple, which is the color that’s used for driven properties. Moving the <strong class="bold">Cube</strong> object along its <strong class="bold">Y</strong>-axis will also make <span class="No-Break">it roll:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer158">
<img alt="Figure 9.1: The Y location drives the X rotation" height="640" src="image/Figure_9.01_B18375.jpg" width="1024"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.1: The Y location drives the X rotation</p>
<p>The <a id="_idIndexMarker610"/>driver that’s using <strong class="bold">Copy As New Driver</strong> is a one-to-one connection driver, in that it copies the exact amount from one property to another. It is less evident in a location-to-rotation connection because, as we know from <a href="B18375_04.xhtml#_idTextAnchor075"><span class="No-Break"><em class="italic">Chapter 4</em></span></a>, rotations are stored as radians but displayed in degrees by default. A value of <strong class="source-inline">5</strong> radians is equivalent to about <strong class="source-inline">286</strong> degrees of rotation, as reflected in the values we can see in <span class="No-Break"><em class="italic">Figure 9</em></span><span class="No-Break"><em class="italic">.1</em></span><span class="No-Break">.</span></p>
<p>Switching <strong class="bold">Rotation Unit</strong> to <strong class="bold">Radians</strong>, as shown in <span class="No-Break"><em class="italic">Figure 9</em></span><em class="italic">.2</em>, makes a one-to-one relationship between <strong class="bold">Location Y</strong> and <strong class="bold">Rotation </strong><span class="No-Break"><strong class="bold">X</strong></span><span class="No-Break"> evident:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer159">
<img alt="Figure 9.2: Location X and Rotation X display the same value using radians" height="640" src="image/Figure_9.02_B18375.jpg" width="1024"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.2: Location X and Rotation X display the same value using radians</p>
<p>Even if the<a id="_idIndexMarker611"/> cube rolls when it is moved, it doesn’t look like a wheel: a wheel rotates the other way around. We can set that up using the <strong class="bold">Drivers </strong><span class="No-Break"><strong class="bold">Editor</strong></span><span class="No-Break"> area.</span></p>
<h2 id="_idParaDest-221"><a id="_idTextAnchor231"/>Setting up a wheel with the Drivers Editor</h2>
<p>In the <strong class="bold">Drivers Editor</strong> area, we <a id="_idIndexMarker612"/>can display and edit the drivers of the <a id="_idIndexMarker613"/>objects present in the scene. It can be brought up following <span class="No-Break">these steps:</span></p>
<ol>
<li>Right-click on a <span class="No-Break"><strong class="bold">Driven Property</strong></span><span class="No-Break">.</span></li>
<li>Select <strong class="bold">Open </strong><span class="No-Break"><strong class="bold">Drivers Editor</strong></span><span class="No-Break">.</span></li>
</ol>
<p>It’s very similar to the <strong class="bold">Graph Editor</strong> area that we looked at in first <em class="italic">section </em>of <a href="B18375_07.xhtml#_idTextAnchor171"><span class="No-Break"><em class="italic">Chapter 7</em></span></a>, except it displays drivers rather than <span class="No-Break">animation curves:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer160">
<img alt="Figure 9.3: The driver f-curve in the Drivers Editor area" height="651" src="image/Figure_9.03_B18375.jpg" width="1189"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.3: The driver f-curve in the Drivers Editor area</p>
<p>We can get a better view of the curve by selecting <strong class="bold">View</strong> | <strong class="bold">Frame All</strong> from the <strong class="bold">Drivers Editor</strong> menu bar or pressing <em class="italic">Home</em> on <span class="No-Break">the keyboard.</span></p>
<p>The default driver’s f-curve is the diagonal of the positive cartesian plane, with control points at coordinates (<strong class="source-inline">0.0</strong>, <strong class="source-inline">0.0</strong>) and (<strong class="source-inline">1.0</strong>, <strong class="source-inline">1.0</strong>). We can see that the result of the curve, displayed in the <strong class="bold">Driver</strong> panel as the <strong class="bold">Driver Value</strong> property, equals <strong class="source-inline">5.0</strong>, the same value as the <strong class="bold">location</strong> <span class="No-Break">input variable.</span></p>
<p>Since the <a id="_idIndexMarker614"/>rotation of a wheel is opposite to its motion, we need to <a id="_idIndexMarker615"/>invert that result by changing the curve. To do that, follow <span class="No-Break">these steps:</span></p>
<ol>
<li>In the <strong class="bold">Drivers Editor</strong> properties, select the <span class="No-Break"><strong class="bold">F-Curve</strong></span><span class="No-Break"> tab.</span></li>
<li>Select the top-right point of the f-curve <span class="No-Break">by left-clicking.</span></li>
<li>In the <strong class="bold">Active Keyframe</strong> properties, change <strong class="bold">Value</strong> from <strong class="source-inline">1.0</strong> <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">-1.0</strong></span><span class="No-Break">:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer161">
<img alt="Figure 9.4: The driver’s f-curve pointing downwards" height="665" src="image/Figure_9.04_B18375.jpg" width="1336"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.4: The driver’s f-curve pointing downwards</p>
<p>Now, moving the cube over its <strong class="bold">Y</strong>-axis makes it roll in the right direction. If you look carefully, something will still be off: this driver is rolling slightly <span class="No-Break">too slowly.</span></p>
<p>The ratio between a circle of size 1 and the length it covers in one round is π, the mathematical constant pi, which is <span class="No-Break">approximately 3.14.</span></p>
<p>That distance only takes a half round to a wheel twice as large, like our default cube of size <strong class="source-inline">2</strong> x <strong class="source-inline">2</strong> x <strong class="source-inline">2</strong>, so typing <strong class="source-inline">pi/2</strong> in the <strong class="bold">Key Frame</strong> field sets the ratio between <strong class="bold">Location</strong> and <strong class="bold">Rotation</strong> to approximately <strong class="source-inline">1.571</strong>, a multiplier slightly faster than <strong class="source-inline">1</strong>. Translating the cube on its <strong class="bold">Y</strong>-axis now <a id="_idIndexMarker616"/>makes it roll like a wheel, albeit a <span class="No-Break">square</span><span class="No-Break"><a id="_idIndexMarker617"/></span><span class="No-Break"> one.</span></p>
<p>We used a division to get that result, but we can also use Python formulas in drivers. We can also create drivers by just typing <span class="No-Break">a formula.</span></p>
<h2 id="_idParaDest-222"><a id="_idTextAnchor232"/>Creating driver expressions in properties</h2>
<p>A different type of driver, one <a id="_idIndexMarker618"/>that relies on Python math formulas, can be created by typing a hash symbol (<strong class="source-inline">#</strong>) in a property field. Here are the steps for creating a <span class="No-Break">driver expression:</span></p>
<ol>
<li>Open Blender or go back to the default scene via <strong class="bold">File</strong> | <strong class="bold">New</strong> | <span class="No-Break"><strong class="bold">General</strong></span><span class="No-Break">.</span></li>
<li>Select the default cube to make <span class="No-Break">it active.</span></li>
<li>Left-click on the <strong class="source-inline">rotation_euler.x</strong> property to edit <span class="No-Break">its value.</span></li>
<li>Type <strong class="source-inline">#sin(frame)</strong> and <span class="No-Break">press </span><span class="No-Break"><em class="italic">Enter</em></span><span class="No-Break">:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer162">
<img alt="Figure 9. 5: Typing Python expressions in object properties" height="158" src="image/Figure_9.05_B18375.jpg" width="276"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9. 5: Typing Python expressions in object properties</p>
<p>The expression we have just written is already active. If we start the playback by pressing the triangular <strong class="bold">Play</strong> button in the <strong class="bold">media controls</strong> area, or with <em class="italic">Alt</em> + <em class="italic">A</em>, the cube will jitter quickly on <span class="No-Break">its </span><span class="No-Break"><strong class="bold">X</strong></span><span class="No-Break">-axis.</span></p>
<p>The <strong class="source-inline">sin(frame)</strong> expression<a id="_idIndexMarker619"/> depends on time, as animations do, but the value per frame is the output of a Python instruction, and we can enrich it for more <span class="No-Break">complex results.</span></p>
<p>In the next section, we will combine the <strong class="source-inline">frame</strong> variable, the <strong class="source-inline">sin</strong> function, and the driver inputs to create a procedural, parametric animation of <span class="No-Break">a pendulum.</span></p>
<p class="callout-heading">We DON’T want results!</p>
<p class="callout">Omitting the <strong class="source-inline">#</strong> symbol will set the result of the expression rather than creating a driver. Typing <strong class="source-inline">frame</strong> sets the property to the numeric value of the current frame, such as <strong class="source-inline">1</strong> or <strong class="source-inline">24</strong>. If we type <strong class="source-inline">#frame</strong>, the value will change as we play <span class="No-Break">the animation.</span></p>
<h1 id="_idParaDest-223"><a id="_idTextAnchor233"/>Driving a cyclic motion</h1>
<p>A pendulum<a id="_idIndexMarker620"/> is a weight suspended from a fixed point, free to swing back and forth. It has many real-life applications in time, gravity, and geographic measurements, while in 3D, an oscillating motion is used for displaying clock mechanisms, hanging <a id="_idIndexMarker621"/>props, and other cyclic motions. The trigonometric function <strong class="bold">sine</strong> is commonly used to simulate this kind <span class="No-Break">of motion.</span></p>
<p>The <strong class="source-inline">sin</strong> function<a id="_idIndexMarker622"/> from the <strong class="source-inline">math</strong> module is the Python syntax for <em class="italic">sine</em>. We encountered <em class="italic">sine</em> in <a href="B18375_07.xhtml#_idTextAnchor171"><span class="No-Break"><em class="italic">Chapter 7</em></span></a>, where we used its inverse, <em class="italic">arcsine</em>, to orient objects using Python. Sine is a periodic wave function – it repeats itself at <span class="No-Break">fixed intervals:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer163">
<img alt="Figure 9.6: The sine function" height="606" src="image/Figure_9.6_B18375.jpg" width="1236"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.6: The sine function</p>
<p>Playing the <a id="_idIndexMarker623"/>animation will make the cube jitter very fast. To slow it down, we can click <strong class="bold">Driven Property</strong> and give the formula a <span class="No-Break">slower pace.</span></p>
<p>For instance, we can change it to <strong class="source-inline">sin(frame/10)</strong> and it will slow down tenfold. Now, the cube rocks back and forth gently. We can do even better and set up a rotation pivot for a <span class="No-Break">proper swing.</span></p>
<h2 id="_idParaDest-224"><a id="_idTextAnchor234"/>Changing the rotation pivot via constraints</h2>
<p>The easier way <a id="_idIndexMarker624"/>to affect an object’s pivot is by using <strong class="bold">constraints</strong>. We came across constraints in <a href="B18375_04.xhtml#_idTextAnchor075"><span class="No-Break"><em class="italic">Chapter 4</em></span></a>, and <a id="_idIndexMarker625"/>used them to change an object’s position without altering its transform properties. This time, we will use a <strong class="bold">Pivot Constraint</strong> to alter the center <span class="No-Break">of rotation.</span></p>
<h3>Adding a Pivot Constraint in Blender</h3>
<p>A <a id="_idIndexMarker626"/><strong class="bold">Pivot Constraint</strong> moves an object’s center of rotation to a different object’s position or specific coordinates. We are going to use an <strong class="bold">Empty</strong>, a Blender object that doesn’t contain <span class="No-Break">any geometry:</span></p>
<ol>
<li>Add an empty to the scene via <strong class="bold">Add</strong> | <strong class="bold">Empty</strong> | <strong class="bold">Plain Axes</strong> from the <strong class="bold">3D View</strong> area. This object will be the new <span class="No-Break">rotation pivot.</span></li>
<li>Move this <strong class="bold">Empty</strong> somewhere above the <strong class="bold">Cube</strong> object so that it can act as a <span class="No-Break">suspension point.</span></li>
</ol>
<p>Now, we can create <span class="No-Break">the constraint:</span></p>
<ol>
<li>Select the <strong class="bold">Cube</strong> object and reach its <strong class="bold">Constraints</strong> tab in the properties. It is marked with the icon of a <span class="No-Break">connection rod.</span></li>
<li>Select <strong class="bold">Pivot</strong> from<a id="_idIndexMarker627"/> the <strong class="bold">Add Object Constraint</strong> drop-down. A new constraint will <span class="No-Break">be created:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer164">
<img alt="Figure 9.7: Creating a Pivot Constraint" height="558" src="image/Figure_9.07_B18375.jpg" width="837"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.7: Creating a Pivot Constraint</p>
<ol>
<li value="3">Click the <strong class="bold">Target</strong> field in the <strong class="bold">Pivot Constraint</strong> panel, and select <strong class="bold">Empty</strong> among the list <span class="No-Break">of objects.</span></li>
<li>Now, click the <strong class="bold">Rotation Range</strong> property and change it to <strong class="bold">Always</strong> so that rotations in all directions <span class="No-Break">are affected.</span></li>
</ol>
<p>If we play the animation, the cube oscillates left <span class="No-Break">and right:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer165">
<img alt="Figure 9.8: The Pivot Constraint changing the rotation center of the Cube object" height="560" src="image/Figure_9.08_B18375.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.8: The Pivot Constraint changing the rotation center of the Cube object</p>
<p>It starts to<a id="_idIndexMarker628"/> look like a pendulum, but the speed of a swinging motion should depend on the length of the cord, which we are not considering in our formula. To improve our driver, we must learn how the sine function works and how to control its period. Then, we must study pendulum physics and write an expression that takes the cord length <span class="No-Break">into account.</span></p>
<h2 id="_idParaDest-225"><a id="_idTextAnchor235"/>Controlling the period of the sin function</h2>
<p>To have better <a id="_idIndexMarker629"/>control of the sine period, we need to observe its graph, as shown in <span class="No-Break"><em class="italic">Figure 9</em></span><em class="italic">.9</em>. Its value is <strong class="source-inline">0</strong> at frame <strong class="source-inline">0</strong>, and after rising between frames <strong class="source-inline">1</strong> and <strong class="source-inline">2</strong>, it goes back to zero just a little bit after <span class="No-Break">frame </span><span class="No-Break"><strong class="source-inline">3</strong></span><span class="No-Break">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer166">
<img alt="Figure 9.9: The sine function" height="605" src="image/Figure_9.9_B18375.jpg" width="1236"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.9: The sine function</p>
<p>This happens because sine, an angle-related function, depends on the mathematical constant π, and its value is zero at points <strong class="source-inline">3.14</strong>, <strong class="source-inline">6.28</strong>, and so on. The relationship between angles and circles is due to how angles describe <span class="No-Break">circular arcs.</span></p>
<p>If the sine function repeats at every full circle, and a full circle measures 2 * π radians, we can say that the period of the <strong class="source-inline">sin(frame)</strong> formula is <strong class="source-inline">2 * </strong><span class="No-Break"><strong class="source-inline">pi</strong></span><span class="No-Break"> frames.</span></p>
<p>By using <strong class="source-inline">2 * pi</strong> as an argument of <strong class="source-inline">sin</strong>, we get a formula whose period is just <span class="No-Break">one frame:</span></p>
<pre class="source-code">
sin(frame * 2 * pi)</pre>
<p>The result of this formula is always <strong class="source-inline">0</strong>, but that’s more useful than it seems: dividing <strong class="source-inline">frame * 2 * pi</strong> by a specific number of frames, we can set how much it takes for the formula to repeat – that is, we now have control over <span class="No-Break">the period.</span></p>
<p>For instance, the<a id="_idIndexMarker630"/> result of the following formula repeats every <span class="No-Break">10 frames:</span></p>
<pre class="source-code">
sin(frame * 2 * pi <strong class="source-inline">/ 10</strong>)</pre>
<p>Now, we can look up the pendulum formula and set up a physically <span class="No-Break">correct oscillation.</span></p>
<h2 id="_idParaDest-226"><a id="_idTextAnchor236"/>Implementing the pendulum equation</h2>
<p>According to<a id="_idIndexMarker631"/> Wikipedia (<a href="https://en.wikipedia.org/wiki/Pendulum">en.wikipedia.org/wiki/Pendulum</a>), the period of a pendulum<a id="_idIndexMarker632"/> depends on the <a id="_idIndexMarker633"/>length of its cord, and is approximated with the <span class="No-Break">following formula:</span></p>
<p class="author-quote"><em class="italic">2π√(L/g)</em></p>
<p>It reads <strong class="source-inline">2</strong> times <strong class="source-inline">pi</strong> times the <strong class="bold">square root</strong> of <strong class="source-inline">length</strong> over <strong class="source-inline">gravity</strong>. In Python, this <a id="_idTextAnchor237"/>looks <span class="No-Break">as follows:</span></p>
<pre class="source-code">
2 * pi * <strong class="bold">sqrt</strong>(length / 9.8)</pre>
<p>Here, <strong class="source-inline">sqrt</strong> is the square root operation and <strong class="source-inline">9.8</strong> is the gravity on Earth following the <strong class="bold">International System of Units</strong> (<strong class="bold">SI</strong>). The time <a id="_idIndexMarker634"/>unit is seconds in this system, so we need to express the formulas in our driver <span class="No-Break">in seconds.</span></p>
<p>The expression for repeating <strong class="source-inline">sin</strong> in one frame was <span class="No-Break">as follows:</span></p>
<pre class="source-code">
sin(frame * 2 * pi)</pre>
<p>And since we need to apply a period in seconds, we divide that expression by the frames <span class="No-Break">per second:</span></p>
<pre class="source-code">
sin(frame/fps * 2 * pi)</pre>
<p>This slows down our expression to a period of <span class="No-Break">1 second.</span></p>
<p>We aim to end up with a period of <strong class="source-inline">2 * pi * sqrt(length / 9.8)</strong> seconds, so we divide the argument of <strong class="source-inline">sin</strong> by <span class="No-Break">that amount.</span></p>
<p>After the division, we end up with a function of two variables, <strong class="source-inline">fps</strong> <span class="No-Break">and </span><span class="No-Break"><strong class="source-inline">length</strong></span><span class="No-Break">:</span></p>
<pre class="source-code">
sin((frame / <strong class="source-inline">fps</strong>) * <strong class="bold">2 * pi / (2 * pi</strong> * sqrt(<strong class="source-inline">length</strong>/9.8)))</pre>
<p>The value of <strong class="source-inline">2 * pi / 2 *pi</strong> is <strong class="source-inline">1</strong> and can be removed from the multiplication. Now, our formula looks <span class="No-Break">much better:</span></p>
<pre class="source-code">
sin(frame / <strong class="source-inline">fps</strong> / sqrt(<strong class="source-inline">length</strong>/9.8))</pre>
<p>Typing it inside <strong class="bold">Rotation X</strong> creates <span class="No-Break">a </span><span class="No-Break"><em class="italic">driver</em></span><span class="No-Break">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer167">
<img alt="Figure 9.10: Implementation of the pendulum formula" height="333" src="image/Figure_9.10_B18375.jpg" width="454"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.10: Implementation of the pendulum formula</p>
<p>The driver won’t<a id="_idIndexMarker635"/> work yet, though – the <strong class="source-inline">frame</strong> variable is <a id="_idIndexMarker636"/>already defined by Blender, but <strong class="source-inline">length</strong> and <strong class="source-inline">fps</strong> do not exist and cause an error. We need to add these two variables to the <span class="No-Break">driver properties.</span></p>
<h3>Adding variables to drivers</h3>
<p>We could <a id="_idIndexMarker637"/>perform this operation in the <strong class="bold">Drivers Editor</strong> area we used in the <em class="italic">Creating drivers</em> section of this chapter, but since we don’t need to edit the <em class="italic">f-curve</em>, we can use a <span class="No-Break">simpler interface.</span></p>
<h4>Displaying the Driven Property window</h4>
<p>The <strong class="bold">Driven Property</strong> window <a id="_idIndexMarker638"/>displays the details of a single driver. It is quick to access, and its content is the same as the <strong class="bold">Drivers</strong> tab in the <strong class="bold">Drivers </strong><span class="No-Break"><strong class="bold">Editor</strong></span><span class="No-Break"> area.</span></p>
<p>The steps for displaying and editing a driven property are <span class="No-Break">as follows:</span></p>
<ol>
<li>Right-click on a <span class="No-Break">driven property.</span></li>
<li>Select <strong class="bold">Edit Driver</strong> from the <span class="No-Break">context menu.</span></li>
</ol>
<p>The <strong class="bold">Driven Property</strong> window recaps the path of the affected property, which <strong class="bold">Type</strong> of driver it is, if there are errors in the driver, and which variables have <span class="No-Break">been created:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer168">
<img alt="Figure 9.11: Properties of a scripted expression driver" height="558" src="image/Figure_9.11_B18375.jpg" width="330"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.11: Properties of a scripted expression driver</p>
<p>At this stage, the driver type will be set to <strong class="bold">Scripted Expression</strong>; the <strong class="bold">Expression</strong> field contains our pendulum formula, while the error label informs us that something went wrong with the <span class="No-Break">Python expression.</span></p>
<p>This error is caused by the<a id="_idIndexMarker639"/> missing <strong class="source-inline">fps</strong> and <strong class="source-inline">length</strong> variables. Adding them will <span class="No-Break">fix it.</span></p>
<p class="callout-heading">Hold on to your window!</p>
<p class="callout"><strong class="bold">Driven Property</strong> is a popover window that disappears when the mouse pointer moves back outside of its borders. Don’t worry, though; every change will still be there when you open the <span class="No-Break">window again.</span></p>
<h4>Getting the frame per seconds property</h4>
<p>Clicking the <strong class="bold">+ Add Input Variable</strong> button <a id="_idIndexMarker640"/>adds a new variable to the driver. By default, this variable’s name is <strong class="source-inline">var</strong>, and it’s an <strong class="bold">RNA property</strong> variable – that is, it reads the value from another property in Blender. To get that value, we need to specify <span class="No-Break">the following:</span></p>
<ul>
<li>The type of the entity (object, scene, action, and <span class="No-Break">so on)</span></li>
<li>The name of <span class="No-Break">the entity</span></li>
<li>The name of <span class="No-Break">the property</span></li>
</ul>
<p>These properties can be set in the <span class="No-Break"><strong class="bold">Variable</strong></span><span class="No-Break"> panel:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer169">
<img alt="Figure 9.12: A newly created variable" height="177" src="image/Figure_9.12_B18375.jpg" width="330"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.12: A newly created variable</p>
<p>Here are the steps to get the <strong class="bold">Frames Per Second</strong> render setting of the scene through <span class="No-Break">this variable:</span></p>
<ol>
<li>Select <strong class="bold">Scene</strong> from the property type list, which is displayed with the left button below the <span class="No-Break">variable’s name:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer170">
<img alt="Figure 9.13: Setting the property variable type" height="587" src="image/Figure_9.13_B18375.jpg" width="550"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.13: Setting the property variable type</p>
<ol>
<li value="2">A Blender file can contain more than one scene. We can display a list of them with the right list button and pick one. The name of the default scene <span class="No-Break">is </span><span class="No-Break"><strong class="bold">Scene</strong></span><span class="No-Break">.</span></li>
<li>Now that<a id="_idIndexMarker641"/> a scene has been selected, another field, <strong class="bold">Path</strong>, will appear. Here, we can set the attribute that can be accessed by the variable. Typing <strong class="source-inline">render.fps</strong> gets the frame per second, as set in the <span class="No-Break">render settings.</span></li>
<li>We must rename the variable from <strong class="source-inline">var</strong> to <strong class="source-inline">fps</strong> by clicking the current name just right of the genetic code (<span class="No-Break">RNA) icon:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer171">
<img alt="Figure 9.14: The fps variable in the render settings" height="226" src="image/Figure_9.14_B18375.jpg" width="315"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.14: The fps variable in the render settings</p>
<p>Now, the variable<a id="_idIndexMarker642"/> name matches the one used in the driver expression so that <strong class="source-inline">frame/fps</strong> is the time at the current frame, in seconds. This allows the next variable, <strong class="source-inline">length</strong>, to influence the period with a <span class="No-Break">seconds-based formula.</span></p>
<h4>Getting the pendulum length with a distance variable</h4>
<p>There <a id="_idIndexMarker643"/>are four types of <span class="No-Break">driver variables:</span></p>
<ul>
<li><span class="No-Break"><strong class="bold">Single Property</strong></span></li>
<li><span class="No-Break"><strong class="bold">Transform Channel</strong></span></li>
<li><span class="No-Break"><strong class="bold">Rotational Difference</strong></span></li>
<li><span class="No-Break"><strong class="bold">Distance</strong></span></li>
</ul>
<p>While the first two, <strong class="bold">Single Property</strong> and <strong class="bold">Transform Channel</strong>, depend on the value of a property, <strong class="bold">Rotational Difference</strong> and <strong class="bold">Distance</strong> result from the difference between the transformations of <span class="No-Break">two objects.</span></p>
<p>In this case, the length of the cord is the distance between the driven object and its pivot – that is, between <strong class="bold">Cube</strong> and <strong class="bold">Empty</strong>. So, we will use their <strong class="bold">Distance</strong> <span class="No-Break">for </span><span class="No-Break"><strong class="source-inline">length</strong></span><span class="No-Break">:</span></p>
<ol>
<li>Add a new variable by clicking the <strong class="bold">+ Add Input </strong><span class="No-Break"><strong class="bold">Variable</strong></span><span class="No-Break"> button.</span></li>
<li>Click the RNA icon to change the type to <strong class="bold">Distance</strong>. The panel will change, allowing you to select <span class="No-Break">two objects:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer172">
<img alt="Figure 9.15: Changing the variable type" height="225" src="image/Figure_9.15_B18375.jpg" width="316"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.15: Changing the variable type</p>
<ol>
<li value="3">Select <strong class="bold">Cube</strong> and <strong class="bold">Empty</strong> and change the name of the variable <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">length</strong></span><span class="No-Break">:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer173">
<img alt="Figure 9.16: Variables settings for the pendulum driver" height="903" src="image/Figure_9.16_B18375.jpg" width="541"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.16: Variables settings for the pendulum driver</p>
<p>Moving the <strong class="bold">Empty</strong> or <strong class="bold">Cube</strong> object closer to each other while the animation plays makes the swing becomes faster, while setting them apart slows <span class="No-Break">them down.</span></p>
<p>The maximum value of sin is <strong class="source-inline">1</strong>, which, converted from <em class="italic">radians</em>, gives us the maximum angle reached by <span class="No-Break">this driver:</span></p>
<pre class="source-code">
&gt;&gt;&gt; degrees(1)
57.29577951308232</pre>
<p>This <a id="_idIndexMarker644"/>value is the amplitude of the oscillation. The amplitude of a pendulum depends on its initial position. In real life, the amplitude decreases progressively because of the friction of air, until the pendulum reaches its resting position and stops. We are not implementing air drag in our driver, but we can still add a control to influence the amplitude of <span class="No-Break">the motion.</span></p>
<h2 id="_idParaDest-227"><a id="_idTextAnchor238"/>Controlling the amplitude</h2>
<p>While the <a id="_idIndexMarker645"/>term <strong class="bold">amplitude</strong> has a specific meaning when dealing with wave graphs, for our goal, we can consider it a multiplier <span class="No-Break">of motion.</span></p>
<p>Since we are programming for animation, it’s more important for our amplitude control to make sense visually rather <span class="No-Break">than physically.</span></p>
<h3>Adding a custom property</h3>
<p>We already control the <a id="_idIndexMarker646"/>pivot’s position with an object of the <strong class="bold">empty</strong> type. Since moving <strong class="bold">Empty</strong> already alters the periodic motion, we can add a new property to it, to control the amplitude of the oscillation. This way, we can affect the behavior of the pendulum by selecting a <span class="No-Break">single object.</span></p>
<p>The procedure for adding a property to an object is <span class="No-Break">as follows:</span></p>
<ol>
<li>Select the <strong class="bold">Empty</strong> object that we are using as <span class="No-Break">a pivot.</span></li>
<li>In the <strong class="bold">Object Properties</strong> panel, find the <strong class="bold">Custom </strong><span class="No-Break"><strong class="bold">Properties</strong></span><span class="No-Break"> section.</span></li>
<li>Click the <strong class="bold">+ New</strong> button to add a property. It will be named <strong class="bold">prop</strong> <span class="No-Break">by default:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer174">
<img alt="Figure 9.17: Adding custom properties to the active object" height="623" src="image/Figure_9.17_B18375.jpg" width="378"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.17: Adding custom properties to the active object</p>
<ol>
<li value="4">Click the cog icon and change <strong class="bold">Property Name</strong> <span class="No-Break">to </span><span class="No-Break"><strong class="bold">amplitude</strong></span><span class="No-Break">.</span></li>
<li>Right-click on the value (the default, <strong class="source-inline">1.00</strong>, is good) and select <strong class="bold">Copy </strong><span class="No-Break"><strong class="bold">Data Path</strong></span><span class="No-Break">.</span></li>
</ol>
<p>This copies the path of the property to the clipboard. This will be useful when we add the next <span class="No-Break">driver variable.</span></p>
<h3>Using custom properties in drivers</h3>
<p>Multiplying the driver <a id="_idIndexMarker647"/>expression by the <strong class="source-inline">amp</strong> variable affects its result and allows us to modulate its amplitude. To do that, follow <span class="No-Break">these steps:</span></p>
<ol>
<li>Select the <span class="No-Break">oscillating </span><span class="No-Break"><strong class="bold">Cube</strong></span><span class="No-Break">.</span></li>
<li>Right-click on the driven rotation channel and select <strong class="bold">Edit Driver</strong> to bring up the <strong class="bold">Driven </strong><span class="No-Break"><strong class="bold">Property</strong></span><span class="No-Break"> editor.</span></li>
<li>Click <strong class="bold">+ Add Input Variable</strong> and name the new <span class="No-Break">variable </span><span class="No-Break"><strong class="source-inline">amp</strong></span><span class="No-Break">.</span></li>
<li>Click the <strong class="bold">Prop:</strong> field on the right and pick <strong class="bold">Empty</strong> as the <span class="No-Break">property object.</span></li>
<li>Click the <strong class="bold">Path:</strong> field and paste the data path stored in the <em class="italic">clipboard</em> using <em class="italic">Ctrl</em> + <em class="italic">V</em>, or type <strong class="source-inline">["amplitude"]</strong>. The square brackets are part of the <em class="italic">custom properties</em> <span class="No-Break">Python path:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer175">
<img alt="Figure 9.18: Custom property as a driver variable" height="140" src="image/Figure_9.18_B18375.jpg" width="311"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.18: Custom property as a driver variable</p>
<p>We could just add <strong class="source-inline">* amp</strong> to the driver expression, but we can do even better: since the driver affects a rotation, we can add <strong class="source-inline">pi</strong> to the <span class="No-Break">multiplication too:</span></p>
<pre class="source-code">
sin(frame / fps / sqrt(length/9.8)) * <strong class="source-inline">amp * pi</strong></pre>
<p>The <strong class="source-inline">sin</strong> function oscillates between <strong class="source-inline">-1.0</strong> and <strong class="source-inline">1.0</strong>, so the result of our driver when <strong class="bold">amplitude</strong> is set to <strong class="source-inline">1.0</strong> ranges between <strong class="source-inline">-pi</strong> <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">pi</strong></span><span class="No-Break">.</span></p>
<p>Keeping in mind that a full circle arc measures <strong class="source-inline">2 * pi</strong>, it’s fair to expect a value of <strong class="source-inline">pi</strong> to describe a half-circle rotation in radians. If we play the animation now, we’ll see the pendulum oscillate up to its vertical direction – that is, rotate half circle to the left, go back, and then rotate half circle to the right: an amplitude of <strong class="source-inline">1.0</strong> makes the pendulum describe a <span class="No-Break">full circle.</span></p>
<p>If we select the <strong class="bold">Empty</strong> object and change its amplitude to <strong class="source-inline">0.5</strong>, the pendulum will swing through a half-circle arc. An amplitude equal to <strong class="source-inline">0.25</strong> gives better results: a 45-degree maximum rotation on each side; a value of <strong class="source-inline">0.0</strong> would stop <span class="No-Break">the pendulum.</span></p>
<p>A control<a id="_idIndexMarker648"/> ranging from <strong class="source-inline">0.0</strong> for a still pendulum to <strong class="source-inline">1.0</strong> for an entire rotation has an immediate meaning to animators and 3D users because it allows them to set up the fraction of the circle that they wish by changing <span class="No-Break">the amplitude.</span></p>
<p>We used a Python formula in our driver, but we created the entire setup manually. In the next section, we will write a Python add-on to automate <span class="No-Break">this procedure.</span></p>
<h1 id="_idParaDest-228"><a id="_idTextAnchor239"/>Writing the pendulum add-on</h1>
<p>Using <a id="_idIndexMarker649"/>what we have learned so far, we can write an add-on that sets up a pendulum for the <span class="No-Break">active object.</span></p>
<p>We will start with the steps from <a href="B18375_03.xhtml#_idTextAnchor049"><span class="No-Break"><em class="italic">Chapter 3</em></span></a>, and create a <strong class="source-inline">.py</strong> file for <span class="No-Break">our add-on.</span></p>
<h2 id="_idParaDest-229"><a id="_idTextAnchor240"/>Setting the environment</h2>
<p>Let’s create a <a id="_idIndexMarker650"/>folder for <a href="B18375_09.xhtml#_idTextAnchor226"><span class="No-Break"><em class="italic">Chapter 9</em></span></a> in our <strong class="bold">PythonScriptingBlender</strong> project. In the <strong class="bold">Blender Preferences</strong> area, set the <strong class="source-inline">ch9</strong> folder as the <strong class="bold">Scripts Folder</strong> property and restart the application. We can create our new files and folder in our IDE (VS Code in this book) so that we can <span class="No-Break">start editing:</span></p>
<ol>
<li>Select <strong class="source-inline">PythonScriptingBlender/ch9/addons</strong> in <span class="No-Break"><strong class="bold">VS Code</strong></span><span class="No-Break">.</span></li>
<li>Create a new file by clicking the <strong class="bold">New </strong><span class="No-Break"><strong class="bold">File</strong></span><span class="No-Break"> icon.</span></li>
<li>Name the new <span class="No-Break">file </span><span class="No-Break"><strong class="source-inline">pendulum.py</strong></span><span class="No-Break">.</span></li>
<li>Open the file by <span class="No-Break">double-clicking it.</span></li>
</ol>
<p>We can now add the standard elements of <span class="No-Break">most add-ons:</span></p>
<ul>
<li><span class="No-Break">Add-on information</span></li>
<li>The <span class="No-Break"><strong class="source-inline">Operator</strong></span><span class="No-Break"> class</span></li>
<li>The <span class="No-Break">menu function</span></li>
<li><span class="No-Break">Registration</span><span class="No-Break"><a id="_idIndexMarker651"/></span><span class="No-Break"> functions</span></li>
</ul>
<p>Next, we’ll learn how to write <span class="No-Break">this information.</span></p>
<h2 id="_idParaDest-230"><a id="_idTextAnchor241"/>Writing the information</h2>
<p>As usual, the information about<a id="_idIndexMarker652"/> our add-on goes into the <span class="No-Break"><strong class="source-inline">bl_info</strong></span><span class="No-Break"> dictionary:</span></p>
<pre class="source-code">
bl_info = {
    "name": "Object Pendulum",
    "author": "John Packt",
    "version": (1, 0),
    "blender": (3, 00, 0),
    "description": "Add swing motion to active object",
    "category": "Learning",
}</pre>
<p>This dictionary is just for Blender to display the add-on’s name and description in the list. The next step is writing the <span class="No-Break"><strong class="source-inline">Operator</strong></span><span class="No-Break"> class.</span></p>
<h2 id="_idParaDest-231"><a id="_idTextAnchor242"/>Writing the Operator class</h2>
<p>The <strong class="source-inline">Operator</strong> class<a id="_idIndexMarker653"/> carries on the actual work. We derive <strong class="source-inline">bpy.types.Operator</strong> and fill in the information in the static section of <span class="No-Break">the class:</span></p>
<pre class="source-code">
import bpy
class ObjectPendulum(bpy.types.Operator):
    """Set up swinging motion on active object"""
    bl_idname = "object.shaker_animation"
    bl_label = "Make Pendulum"
    bl_description = "Add swinging motion to Active Object"
    bl_options = {'REGISTER', 'UNDO'}</pre>
<p><strong class="source-inline">bl_idname</strong> starts with <strong class="source-inline">object.</strong> so that it will be added to the <strong class="source-inline">bpy.ops.object</strong> operators. We are doing that because everything we do in this operator affects the scene at the <span class="No-Break">object level.</span></p>
<p>Now, we must add the oscillation parameters to the <span class="No-Break">static attributes:</span></p>
<pre class="source-code">
    amplitude: bpy.props.FloatProperty(default=0.25,
                                       min=0.0)
    length: bpy.props.FloatProperty(default=5.0, min=0.0)</pre>
<p>They will determine the <strong class="source-inline">amplitude</strong> and <strong class="source-inline">length</strong> variables of the motion. By using <strong class="source-inline">'REGISTER'</strong> and <strong class="source-inline">'UNDO'</strong> as <strong class="source-inline">bl_options</strong>, the operator will allow <span class="No-Break">live changes:</span></p>
<pre class="source-code">
bl_options = {'REGISTER', 'UNDO'}</pre>
<p>Now, it’s the <strong class="source-inline">poll</strong> method’s turn, where the conditions for running the operator are checked. It must return <strong class="source-inline">True</strong> if there is an active object. We can use the <strong class="source-inline">bool</strong> function to convert <strong class="source-inline">context.object</strong> on <span class="No-Break">the fly:</span></p>
<pre class="source-code">
    @classmethod
    def poll(cls, context):
        return bool(context.object)</pre>
<p>Finally, we have<a id="_idIndexMarker654"/> the <strong class="source-inline">execute</strong> method. It performs all the operations from the previous section of <span class="No-Break">this chapter:</span></p>
<ul>
<li>Creates the <span class="No-Break">pivot object</span></li>
<li>Adds a custom property for <span class="No-Break">the amplitude</span></li>
<li>Creates a driver with the pendulum formula <span class="No-Break">and variables</span></li>
</ul>
<p>At the start of the function, we store the active object in the <strong class="source-inline">ob</strong> variable, then create a new object that will be the pivot. In <a href="B18375_02.xhtml#_idTextAnchor033"><span class="No-Break"><em class="italic">Chapter 2</em></span></a>, we learned that new objects can be created in <span class="No-Break">two steps:</span></p>
<ol>
<li>Get a new object <span class="No-Break">via </span><span class="No-Break"><strong class="source-inline">bpy.data.objects.new</strong></span><span class="No-Break">.</span></li>
<li>Link the object to a <strong class="source-inline">Collection</strong> present in <span class="No-Break">the scene.</span></li>
</ol>
<p>We will use <strong class="source-inline">context.collection</strong> and link the pivot to the <span class="No-Break">active collection:</span></p>
<pre class="source-code">
    def execute(self, context):
        ob = context.object
        pivot_name = f"EMP-{ob.name}_pivot"
        pivot = bpy.data.objects.new(pivot_name, None)
        context.collection.objects.link(pivot)</pre>
<p>Using <strong class="source-inline">None</strong> as the second argument of <strong class="source-inline">new</strong> creates a transform with no geometry data – that is, an <strong class="bold">Empty</strong>. As we know from <a href="B18375_04.xhtml#_idTextAnchor075"><span class="No-Break"><em class="italic">Chapter 4</em></span></a>, we can copy the world location from the active object’s <strong class="source-inline">matrix_world</strong>. The pivot should be placed above the active object, and since <strong class="source-inline">location</strong> is stored in the fourth column of the transform matrix, we can raise the value of <strong class="bold">Location Z</strong> by increasing the fourth element of the third row (<span class="No-Break">index </span><span class="No-Break"><strong class="source-inline">[2][3]</strong></span><span class="No-Break">):</span></p>
<pre class="source-code">
        pivot.matrix_world = ob.matrix_world
        pivot.matrix_world[2][3] += self.length</pre>
<p>Now, it’s time for the<a id="_idIndexMarker655"/> custom properties. We have seen how the data path to our <em class="italic">amplitude</em> property was <strong class="source-inline">["amplitude"]</strong>. That’s because Python’s access to custom properties follows the same syntax as <span class="No-Break">Python dictionaries.</span></p>
<p>In Python dictionaries, the <strong class="source-inline">dictionary["new_key"] = new_value</strong> syntax adds a new item. Likewise, the Python code for creating the <strong class="source-inline">amplitude</strong> float property and assigning it the value of the operator’s parameter of the same name is <span class="No-Break">as follows:</span></p>
<pre class="source-code">
        pivot["amplitude"] = self.amplitude</pre>
<p><strong class="source-inline">amplitude</strong> will now appear under our pivot object. We will use that later in the driver. For now, we will add a <strong class="bold">Pivot Constraint</strong> to the <span class="No-Break">active object:</span></p>
<pre class="source-code">
        constr = ob.constraints.new('PIVOT')
        constr.target = pivot
        constr.rotation_range = 'ALWAYS_ACTIVE'</pre>
<p>Now, it’s time to create our driver. Drivers, as objects, are slightly more complex than constraints as they contain other entities, such as the f-curve, and are part of the animation data. So, rather than using the <strong class="source-inline">drivers.new</strong> method from <strong class="source-inline">animation_data</strong>, we will resort to the <strong class="source-inline">driver_add</strong> method of the object, which sets up all the requirements. It returns the <span class="No-Break">driver curve:</span></p>
<pre class="source-code">
        driver_crv = ob.driver_add('rotation_euler', 0)
        driver = driver_crv.driver</pre>
<p class="callout-heading">Who drives the driver?</p>
<p class="callout">The <strong class="source-inline">driver_add</strong> method returns the f-curve rather than the driver itself. The actual driver can be accessed via the <strong class="source-inline">curve.driver</strong> attribute. This makes it easier to access the new curve, but it would have been reasonable to expect that <strong class="source-inline">driver_add</strong> would return the <span class="No-Break">driver instead.</span></p>
<p>Our driver uses a <a id="_idIndexMarker656"/>Python expression, so must we set the <strong class="source-inline">type</strong> and <span class="No-Break"><strong class="source-inline">expression</strong></span><span class="No-Break"> attributes:</span></p>
<pre class="source-code">
        driver.type = "SCRIPTED"
        xpr = "sin(frame/fps/sqrt(length/9.8)) * amp * pi"
        driver.expression = xpr</pre>
<p>The <strong class="source-inline">fps</strong>, <strong class="source-inline">length</strong>, and <strong class="source-inline">amp</strong> variables can be added <span class="No-Break">using </span><span class="No-Break"><strong class="source-inline">variables.new</strong></span><span class="No-Break">.</span></p>
<p>Once we’ve created a variable, we can set its targets. The current <strong class="bold">Frames Per Seconds</strong> rate is the <strong class="source-inline">render.fps</strong> property of <strong class="source-inline">context.scene</strong>, so it’s only one target. We will set the variable type to a single property and fill <strong class="source-inline">id_type</strong>, <strong class="source-inline">id</strong>, and <strong class="source-inline">data_path</strong> <span class="No-Break">of </span><span class="No-Break"><strong class="source-inline">targets[0]</strong></span><span class="No-Break">:</span></p>
<pre class="source-code">
        fps = driver.variables.new()
        fps.name = "fps"
        fps.type = <strong class="source-inline">"SINGLE_PROP"</strong>
        fps.targets[0].id_type = <strong class="bold">'SCENE'</strong>
        fps.targets[0].id = context.scene
        fps.targets[0].data_path = <strong class="source-inline">"render.fps"</strong></pre>
<p>Our pendulum length is the distance between <strong class="source-inline">pivot</strong> and <strong class="source-inline">ob</strong>, so it has <span class="No-Break">two targets:</span></p>
<pre class="source-code">
        len = driver.variables.new()
        len.name = "length"
        len.type = <strong class="source-inline">"LOC_DIFF"</strong>
        len.targets[0].id = pivot
        len.targets[1].id = ob</pre>
<p>Finally, we can<a id="_idIndexMarker657"/> look at the amplitude. It’s a custom property of the pivot and the variable is of the <strong class="source-inline">'SINGLE_PROP'</strong> type, but this time, <strong class="source-inline">id_type</strong> is a Blender object. Once the driver setup is complete, we can exit the function by returning the <strong class="source-inline">'</strong><span class="No-Break"><strong class="source-inline">FINISHED'</strong></span><span class="No-Break"> state:</span></p>
<pre class="source-code">
        amp = driver.variables.new()
        amp.name = "amp"
        amp.type = <strong class="source-inline">"SINGLE_PROP"</strong>
        amp.targets[0].id_type = <strong class="source-inline">"OBJECT"</strong>
        amp.targets[0].id = pivot
        amp.targets[0].data_path =<a id="_idTextAnchor243"/> <strong class="source-inline">"["amplitude"]"</strong>
        return {'FINISHED'}</pre>
<p>The <strong class="source-inline">ObjectPendulum</strong> class is complete as it now covers the entire setup process. As usual, we must also add an entry to one of the Blender menus to make it easier <span class="No-Break">to launch.</span></p>
<h2 id="_idParaDest-232"><a id="_idTextAnchor244"/>Writing the menu and registering the class</h2>
<p>In <a href="B18375_03.xhtml#_idTextAnchor049"><span class="No-Break"><em class="italic">Chapter 3</em></span></a>, we<a id="_idIndexMarker658"/> learned that we can add our<a id="_idIndexMarker659"/> items to menus by writing a menu function. The argument self and context are, respectively, the menu instance and the application context. We must add the operator’s <strong class="source-inline">bl_idname</strong> to the <span class="No-Break">menu’s </span><span class="No-Break"><strong class="source-inline">layout</strong></span><span class="No-Break">:</span></p>
<pre class="source-code">
def menu_func(self, context):
    self.layout.separator()
    <strong class="source-inline">self.layout</strong>.operator(ObjectPendulum.bl_idname)</pre>
<p>Then, in the register function, we must add <strong class="source-inline">menu_func</strong> to one of Blender’s menus. In this example, we will use the right-click menu that’s available in object mode. We learned how to look for menu class names in <a href="B18375_08.xhtml#_idTextAnchor206"><span class="No-Break"><em class="italic">Chapter 8</em></span></a>, and the object context menu class is <strong class="source-inline">VIEW3D_MT_object_context_menu</strong>. We must also register the operator <span class="No-Break">class, </span><span class="No-Break"><strong class="source-inline">ObjectPendulum</strong></span><span class="No-Break">:</span></p>
<pre class="source-code">
def register():
    bpy.utils.register_class(ObjectPendulum)
    ob_menu =  bpy.types.VIEW3D_MT_object_context_menu
    ob_menu.append(menu_func)</pre>
<p>This adds our new functionality to Blender when the <strong class="bold">Object Pendulum</strong> add-on is enabled. Of course, we must reverse those operations to clean up our add-on elements when it <span class="No-Break">is disabled:</span></p>
<pre class="source-code">
def unregister():
    ob_menu =  bpy.types.VIEW3D_MT_object_context_menu
    ob_menu.remove(menu_func)
    bpy.utils.unregister_class(ObjectPendulum)</pre>
<p>Now that our add-on is ready, the steps for setting up a pendulum instantly are <span class="No-Break">as follows:</span></p>
<ol>
<li>In <strong class="bold">Object Mode</strong>, select an object to make <span class="No-Break">it active.</span></li>
<li>Right-click and choose <strong class="bold">Make Pendulum</strong> to invoke <span class="No-Break">the add-on.</span></li>
<li>Set<a id="_idIndexMarker660"/> values for <strong class="source-inline">length</strong> and <strong class="source-inline">amplitude</strong> in the <a id="_idIndexMarker661"/><span class="No-Break">operator properties.</span></li>
</ol>
<p>Writing this add-on put many of the techniques you learned in the previous chapters to use. Drivers are a very creative area of scripting, and this was just a taste of what we can do <span class="No-Break">with them.</span></p>
<h1 id="_idParaDest-233"><a id="_idTextAnchor245"/>Summary</h1>
<p>Drivers are powerful tools that sit at a crossroads between animation, rigging, and programming. On one hand, they can contain Python expressions and implement custom mechanics on their own, while on the other hand, the entire driver setup process can be automated <span class="No-Break">via scripting.</span></p>
<p>The tool we wrote in this chapter is a small <strong class="bold">auto-rig</strong> that replicates the same mechanism, with editable parameters, on any <span class="No-Break">Blender object.</span></p>
<p>The ability to combine drivers, constraints, and custom properties, as well as automate the whole procedure, is an essential part of 3D production as it allows non-technical users to carry on with <span class="No-Break">technical tasks.</span></p>
<p>As a plus, by using Python, we converted a formula from physics into a working driver expression, a task that can sometimes be intimidating but can be carried out with observation and a <span class="No-Break">little ingenuity.</span></p>
<p>This topic ends our tour of the animation system. In the next chapter, <a href="B18375_10.xhtml#_idTextAnchor247"><span class="No-Break"><em class="italic">Chapter 10</em></span></a>, we will learn how our operators can interact with the user and listen <span class="No-Break">to events.</span></p>
<h1 id="_idParaDest-234"><a id="_idTextAnchor246"/>Questions</h1>
<ol>
<li>What color is used for driven properties in <span class="No-Break">the interface?</span></li>
<li>Can we set keyframes for <span class="No-Break">purple properties?</span></li>
<li>Can a metric property, such as <strong class="bold">Location</strong>, drive an angular property, such <span class="No-Break">as </span><span class="No-Break"><strong class="bold">Rotation</strong></span><span class="No-Break">?</span></li>
<li>Can we change the ratio between the driving and <span class="No-Break">driven properties?</span></li>
<li>Can we type Python expressions when we set values in <span class="No-Break">the interface?</span></li>
<li>How do we tell Blender that the expressions we have typed should be <span class="No-Break">a driver?</span></li>
<li>How do we edit a driver property in the user interface? Is there only <span class="No-Break">one way?</span></li>
<li>Can we add custom properties to an object and use them to control <span class="No-Break">other objects?</span></li>
<li>In Python, can we create new drivers using the <strong class="source-inline">collection.new</strong> method, as we do with constraints? If yes, why do we use <span class="No-Break"><strong class="source-inline">object.driver_add</strong></span><span class="No-Break"> instead?</span></li>
<li>Why is the <strong class="source-inline">targets</strong> attribute of driver variables a list? Which type of variable has more than <span class="No-Break">one target?</span></li>
</ol>
</div>
</div></body></html>