<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer040" class="Basic-Text-Frame">&#13;
    <h1 class="chapterNumber">1</h1>&#13;
    <h1 id="_idParaDest-13" class="chapterTitle">Getting Started – One Environment per Project</h1>&#13;
    <p class="normal">In this chapter, you’ll learn about the different ways of setting up Python environments for your projects and how to use multiple Python versions on a single system outside of what your package manager offers.</p>&#13;
    <p class="normal">After the environment is set up, we will continue with the installation of packages using both the <strong class="keyWord">Python Package Index</strong> (<strong class="keyWord">PyPI</strong>) and <code class="inlineCode">conda-forge</code>, the package index that is coupled with Anaconda.</p>&#13;
    <p class="normal">Lastly, we will look at several methods of keeping track of project dependencies.</p>&#13;
    <p class="normal">To summarize, the following topics will be covered:</p>&#13;
    <ul>&#13;
      <li class="bulletList">Creating environments using <code class="inlineCode">venv</code>, <code class="inlineCode">pipenv</code>, <code class="inlineCode">poetry</code>, <code class="inlineCode">pyenv</code>, and <code class="inlineCode">anaconda</code></li>&#13;
      <li class="bulletList">Package installation through <code class="inlineCode">pip</code>, <code class="inlineCode">poetry</code>, <code class="inlineCode">pipenv</code>, and <code class="inlineCode">conda</code></li>&#13;
      <li class="bulletList">Managing dependencies using <code class="inlineCode">requirements.txt</code>, <code class="inlineCode">poetry</code>, and <code class="inlineCode">pipenv</code></li>&#13;
    </ul>&#13;
    <h1 id="_idParaDest-14" class="heading-1">Virtual environments</h1>&#13;
    <p class="normal">The Python ecosystem offers many methods of installing and managing packages. You can simply download and extract code to your project directory, use the package manager from your operating system, or use a tool such as <code class="inlineCode">pip</code> to install a package. To make sure your packages don’t collide, it is recommended that you use a virtual environment. A virtual environment is a lightweight Python installation with its own package directories and a Python binary copied (or linked) from the binary used to create the environment.</p>&#13;
    <h2 id="_idParaDest-15" class="heading-2">Why virtual environments are a good idea</h2>&#13;
    <p class="normal">It might seem like a hassle to create a virtual environment for every Python project, but it offers enough advantages to do so. More importantly, there are several reasons why installing packages globally using <code class="inlineCode">pip</code> is a really bad idea:</p>&#13;
    <ul>&#13;
      <li class="bulletList">Installing packages globally usually requires elevated privileges (such as <code class="inlineCode">sudo</code>, <code class="inlineCode">root</code>, or <code class="inlineCode">administrator</code>), which is a huge security risk. When executing <code class="inlineCode">pip install &lt;package&gt;</code>, the <code class="inlineCode">setup.py</code> of that package is executed as the user that executed the <code class="inlineCode">pip install</code> command. That means that if the package contains malware, it now has superuser privileges to do whatever it wants. Don’t forget that anyone can upload a package to PyPI (<a href="http://pypi.org"><span class="url">pypi.org</span></a>) without any vetting. As you will see later in this book, it only takes a couple of minutes for anyone to create and upload a package.</li>&#13;
      <li class="bulletList">Depending on how you installed Python, it can mess with the existing packages that are installed by your package manager. On an Ubuntu Linux system, that means you could break <code class="inlineCode">pip</code> or even <code class="inlineCode">apt</code> itself because a <code class="inlineCode">pip install -U &lt;package&gt;</code> installs and updates both the package and all of the dependencies.</li>&#13;
      <li class="bulletList">It can break your other projects. Many projects try their best to remain backward compatible, but every <code class="inlineCode">pip install</code> could pull in new/updated dependencies that could break compatibility with other packages and projects. The Django Web Framework, for example, changes enough between versions that many projects using Django will need several changes after an upgrade to the latest release. So, when you’re upgrading Django on your system to the latest version and have a project that was written for a previous version, your project will most likely be broken.</li>&#13;
      <li class="bulletList">It pollutes your list of packages, making it hard to keep track of your project’s dependencies.</li>&#13;
    </ul>&#13;
    <p class="normal">In addition to alleviating the issues above, there is a major advantage as well. You can specify the Python version (assuming you have it installed) when creating the virtual environment. This allows you to test and debug your projects in multiple Python versions easily while keeping the exact same package versions beyond that.</p>&#13;
    <h2 id="_idParaDest-16" class="heading-2">Using venv and virtualenv</h2>&#13;
    <p class="normal">You are probably already familiar with <code class="inlineCode">virtualenv</code>, a library used to create a virtual environment for your Python installation. What you might not know is the <code class="inlineCode">venv</code> command, which has been included with Python since version 3.3 and can be used as a drop-in replacement for <code class="inlineCode">virtualenv</code> in most cases. To keep things simple, I recommend creating a directory where you keep all of your environments. Some people opt for an <code class="inlineCode">env</code>, .<code class="inlineCode">venv</code>, or <code class="inlineCode">venv</code> directory within the project, but I advise against that for several reasons:</p>&#13;
    <ul>&#13;
      <li class="bulletList">Your project files are important, so you probably want to back them up as often as possible. By keeping the bulky environment with all of the installed packages outside of your backups, your backups become faster and lighter.</li>&#13;
      <li class="bulletList">Your project directory stays portable. You can even keep it on a remote drive or flash drive without having to worry that the virtual environment will only work on a single system.</li>&#13;
      <li class="bulletList">It prevents you from accidentally adding the virtual environment files to your source control system.</li>&#13;
    </ul>&#13;
    <p class="normal">If you do decide to keep your virtual environment inside your project directory, make sure that you add that directory to your <code class="inlineCode">.gitignore</code> file (or similar) for your version control system. And if you want to keep your backups faster and lighter, exclude it from the backups. With correct dependency tracking, the virtual environment should be easy enough to rebuild.</p>&#13;
    <h3 id="_idParaDest-17" class="heading-3">Creating a venv</h3>&#13;
    <p class="normal">Creating a <code class="inlineCode">venv</code> is a reasonably simple process, but it varies slightly according to the operating system being used.</p>&#13;
    <div class="packt_tip">&#13;
      <p class="normal">The following examples use the <code class="inlineCode">virtualenv</code> module directly, but for ease I recommend using <code class="inlineCode">poetry</code> instead, which is covered later in this chapter. This module will automatically create a virtual environment for you when you first use it. Before you make the step up to <code class="inlineCode">poetry</code>, however, it is important to understand how virtual environments work.</p>&#13;
    </div>&#13;
    <div class="note">&#13;
      <p class="normal">Since Python 3.6, the <code class="inlineCode">pyvenv</code> command has been deprecated in favor of <code class="inlineCode">python -m venv</code>.</p>&#13;
      <p class="normal">In the case of Ubuntu, the <code class="inlineCode">python3-venv</code> package has to be installed through <code class="inlineCode">apt</code> because the Ubuntu developers have mutilated the default Python installation by not including <code class="inlineCode">ensurepip</code>.</p>&#13;
    </div>&#13;
    <p class="normal">For Linux/Unix/OS X, using <code class="inlineCode">zsh</code> or <code class="inlineCode">bash</code> as a shell, it is:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> python3 -m venv envs/your_env&#13;
<span class="hljs-con-meta">$</span> <span class="hljs-con-built_in">source</span> envs/your_env/bin/activate&#13;
(your_env) <span class="hljs-con-meta">$</span>&#13;
</code></pre>&#13;
    <p class="normal">And for Windows <code class="inlineCode">cmd.exe</code> (assuming <code class="inlineCode">python.exe</code> is in your <code class="inlineCode">PATH</code>), it is:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con">C:\Users\wolph&gt;python.exe -m venv envs\your_env&#13;
C:\Users\wolph&gt;envs\your_env\Scripts\activate.bat&#13;
(your_env) C:\Users\wolph&gt;&#13;
</code></pre>&#13;
    <p class="normal">PowerShell is also supported and can be used in a similar fashion:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con">PS C:\Users\wolph&gt;python.exe -m venv envs\your_env&#13;
PS C:\Users\wolph&gt; envs\your_env\Scripts\Activate.ps1&#13;
(your_env) PS C:\Users\wolph&gt;&#13;
</code></pre>&#13;
    <p class="normal">The first command creates the environment and the second activates the environment. After activating the environment, commands such as <code class="inlineCode">python</code> and <code class="inlineCode">pip</code> use the environment-specific versions, so <code class="inlineCode">pip</code> <code class="inlineCode">install</code> only installs within your virtual environment. A useful side effect of activating the environment is the prefix with the name of your environment, which is <code class="inlineCode">(your_env)</code> in this case.</p>&#13;
    <div class="note">&#13;
      <p class="normal">Note that we are <strong class="keyWord">not</strong> using <code class="inlineCode">sudo</code> or other methods of elevating privileges. Elevating privileges is both unnecessary and a potential security risk, as explained in the <em class="italic">Why virtual environments are a good idea</em> section.</p>&#13;
    </div>&#13;
    <p class="normal">Using <code class="inlineCode">virtualenv</code> instead of <code class="inlineCode">venv</code> is as simple as replacing the following command:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> python3 -m venv envs/your_env&#13;
</code></pre>&#13;
    <p class="normal">with this one:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> virtualenv envs/your_env&#13;
</code></pre>&#13;
    <p class="normal">An additional advantage of using <code class="inlineCode">virtualenv</code> instead of <code class="inlineCode">venv</code>, in that case, is that you can specify the Python interpreter:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> virtualenv -p python3.8 envs/your_env&#13;
</code></pre>&#13;
    <p class="normal">Whereas with the <code class="inlineCode">venv</code> command, it uses the currently running Python installation, so you need to change it through the following invocation:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> python3.8 -m venv envs/your_env&#13;
</code></pre>&#13;
    <h3 id="_idParaDest-18" class="heading-3">Activating a venv/virtualenv</h3>&#13;
    <p class="normal">Every time you get back to your project after closing the shell, you need to reactivate the environment. The activation of a virtual environment consists of:</p>&#13;
    <ul>&#13;
      <li class="bulletList">Modifying your <code class="inlineCode">PATH</code> environment variable to use <code class="inlineCode">envs\your_env\Script</code> or <code class="inlineCode">envs/your_env/bin</code> for Windows or Linux/Unix, respectively</li>&#13;
      <li class="bulletList">Modifying your prompt so that instead of <code class="inlineCode">$</code>, you see <code class="inlineCode">(your_env) $</code>, indicating that you are working in a virtual environment</li>&#13;
    </ul>&#13;
    <div class="packt_tip">&#13;
      <p class="normal">In the case of <code class="inlineCode">poetry</code>, you can use the <code class="inlineCode">poetry shell</code> command to create a new shell with the activated environment.</p>&#13;
    </div>&#13;
    <p class="normal">While you can easily modify those manually, an easier method is to run the <code class="inlineCode">activate</code> script that was generated when creating the virtual environment.</p>&#13;
    <p class="normal">For Linux/Unix with <code class="inlineCode">zsh</code> or <code class="inlineCode">bash</code> as the shell, it is:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> <span class="hljs-con-built_in">source</span> envs/your_env/bin/activate&#13;
(your_env) <span class="hljs-con-meta">$</span>&#13;
</code></pre>&#13;
    <p class="normal">For Windows using <code class="inlineCode">cmd.exe</code>, it is:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con">C:\Users\wolph&gt;envs\your_env\Scripts\activate.bat&#13;
(your_env) C:\Users\wolph&gt;&#13;
</code></pre>&#13;
    <p class="normal">For Windows using PowerShell, it is:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con">PS C:\Users\wolph&gt; envs\your_env\Scripts\Activate.ps1&#13;
(your_env) PS C:\Users\wolph&gt;&#13;
</code></pre>&#13;
    <div class="packt_tip">&#13;
      <p class="normal">By default, the PowerShell permissions might be too restrictive to allow this. You can change this policy for the current PowerShell session by executing:</p>&#13;
      <pre class="programlisting con"><code class="hljs-con">Set-ExecutionPolicy Unrestricted -Scope Process&#13;
</code></pre>&#13;
      <p class="normal">If you wish to permanently change it for every PowerShell session for the current user, execute:</p>&#13;
      <pre class="programlisting con"><code class="hljs-con">Set-ExecutionPolicy Unrestricted -Scope CurrentUser&#13;
</code></pre>&#13;
    </div>&#13;
    <p class="normal">Different shells, such as <code class="inlineCode">fish</code> and <code class="inlineCode">csh</code>, are also supported by using the <code class="inlineCode">activate.fish</code> and <code class="inlineCode">activate.csh</code> scripts, respectively.</p>&#13;
    <p class="normal">When not using an interactive shell (with a cron job, for example), you can still use the environment by using the Python interpreter in the <code class="inlineCode">bin</code> or <code class="inlineCode">scripts</code> directory for Linux/Unix or Windows, respectively. Instead of running <code class="inlineCode">python script.py</code> or <code class="inlineCode">/usr/bin/python script.py</code>, you can use:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con">/home/wolph/envs/your_env/bin/python script.py&#13;
</code></pre>&#13;
    <p class="normal">Note that commands installed through <code class="inlineCode">pip</code> (and <code class="inlineCode">pip</code> itself) can be run in a similar fashion:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con">/home/wolph/envs/your_env/bin/pip&#13;
</code></pre>&#13;
    <h3 id="_idParaDest-19" class="heading-3">Installing packages</h3>&#13;
    <p class="normal">Installing packages within your virtual environment can be done using <code class="inlineCode">pip</code> as normal:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> pip3 install &lt;package&gt;&#13;
</code></pre>&#13;
    <p class="normal">The great advantage comes when looking at the list of installed packages:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> pip3 freeze&#13;
</code></pre>&#13;
    <p class="normal">Because our environment is isolated from the system, we only see the packages and dependencies that we have explicitly installed.</p>&#13;
    <p class="normal">Fully isolating the virtual environment from the system Python packages can be a downside in some cases. It takes up more disk space and the package might not be in sync with the C/C++ libraries on the system. The PostgreSQL database server, for example, is often used together with the <code class="inlineCode">psycopg2</code> package. While binaries are available for most platforms and building the package from the source is fairly easy, it can sometimes be more convenient to use the package that is bundled with your system. That way, you are certain that the package is compatible with both the installed Python and PostgreSQL versions.</p>&#13;
    <p class="normal">To mix your virtual environment with system packages, you can use the <code class="inlineCode">--system-site-packages</code> flag when creating the environment:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> python3 -m venv --system-site-packages envs/your_env&#13;
</code></pre>&#13;
    <p class="normal">When enabling this flag, the environment will have the system Python environment <code class="inlineCode">sys.path</code> appended to your virtual environment’s <code class="inlineCode">sys.path</code>, effectively providing the system packages as a fallback when an <code class="inlineCode">import</code> from the virtual environment fails.</p>&#13;
    <div class="note">&#13;
      <p class="normal">Explicitly installing or updating a package within your virtual environment will effectively hide the system package from within your virtual environment. Uninstalling the package from your virtual environment will make it reappear.</p>&#13;
    </div>&#13;
    <p class="normal">As you might suspect, this also affects the results of <code class="inlineCode">pip freeze</code>. Luckily, <code class="inlineCode">pip freeze</code> can be told to only list the packages local to the virtual environment, which excludes the system packages:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> pip3 freeze --local&#13;
</code></pre>&#13;
    <div class="note">&#13;
      <p class="normal">Later in this chapter, we will discuss <code class="inlineCode">pipenv,</code> which transparently handles the creation of the virtual environment for you.</p>&#13;
    </div>&#13;
    <h2 id="_idParaDest-20" class="heading-2">Using pyenv</h2>&#13;
    <p class="normal">The <code class="inlineCode">pyenv</code> library makes it really easy to quickly install and switch between multiple Python versions. A common issue with many Linux and Unix systems is that the package managers opt for stability over recency. In most cases, this is definitely an advantage, but if you are running a project that requires the latest and greatest Python version, or a really old version, it requires you to compile and install it manually. The <code class="inlineCode">pyenv</code> package makes this process really easy for you but does still require the compiler to be installed.</p>&#13;
    <div class="note">&#13;
      <p class="normal">A nice addition to <code class="inlineCode">pyenv</code> for testing purposes is the <code class="inlineCode">tox</code> library. This library allows you to run your tests on a whole list of Python versions simultaneously. The usage of <code class="inlineCode">tox</code> is covered in <em class="chapterRef">Chapter 10, </em><em class="italic">Testing and Logging – Preparing for Bugs</em>.</p>&#13;
    </div>&#13;
    <p class="normal">To install <code class="inlineCode">pyenv</code>, I recommend visiting the <code class="inlineCode">pyenv</code> project page, since it depends highly on your operating system and operating system version. For Linux/Unix, you can use the regular <code class="inlineCode">pyenv</code> installation manual or the <code class="inlineCode">pyenv-installer</code> (<a href="https://github.com/pyenv/pyenv-installer"><span class="url">https://github.com/pyenv/pyenv-installer</span></a>) one-liner, if you deem it safe enough:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> curl https://pyenv.run | bash&#13;
</code></pre>&#13;
    <p class="normal">Make sure that you follow the instructions given by the installer. To ensure <code class="inlineCode">pyenv</code> works properly, you will need to modify your <code class="inlineCode">.zshrc</code> or <code class="inlineCode">.bashrc</code>.</p>&#13;
    <p class="normal">Windows does not support <code class="inlineCode">pyenv</code> natively (outside of Windows Subsystem for Linux) but has a <code class="inlineCode">pyenv</code> fork available: <a href="https://github.com/pyenv-win/pyenv-win#installation%20"><span class="url">https://github.com/pyenv-win/pyenv-win#installation</span></a></p>&#13;
    <p class="normal">After installing <code class="inlineCode">pyenv</code>, you can view the list of supported Python versions using:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> pyenv install --list&#13;
</code></pre>&#13;
    <p class="normal">The list is rather long, but can be shortened with <code class="inlineCode">grep</code> on Linux/Unix:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> pyenv install --list | grep 3.10&#13;
  3.10.0&#13;
  3.10-dev&#13;
...&#13;
</code></pre>&#13;
    <p class="normal">Once you’ve found the version you like, you can install it through the <code class="inlineCode">install</code> command:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> pyenv install 3.10-dev&#13;
Cloning https://github.com/python/cpython...&#13;
Installing Python-3.10-dev...&#13;
Installed Python-3.10-dev to /home/wolph/.pyenv/versions/3.10-dev&#13;
</code></pre>&#13;
    <div class="packt_tip">&#13;
      <p class="normal">The <code class="inlineCode">pyenv install</code> command takes an optional <code class="inlineCode">--debug</code> parameter, which builds a debug version of Python that makes debugging C/C++ extensions possible using a debugger such as <code class="inlineCode">gdb</code>.</p>&#13;
    </div>&#13;
    <p class="normal">Once the Python version has been built, you can activate it globally, but you can also use the <code class="inlineCode">pyenv-virtualenv</code> plugin (<a href="https://github.com/pyenv/pyenv-virtualenv"><span class="url">https://github.com/pyenv/pyenv-virtualenv</span></a>) to create a <code class="inlineCode">virtualenv</code> for your newly created Python environment:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> pyenv virtualenv 3.10-dev your_pyenv&#13;
</code></pre>&#13;
    <p class="normal">you can see in the preceding example, as opposed to the <code class="inlineCode">venv</code> and <code class="inlineCode">virtualenv</code> commands, <code class="inlineCode">pyenv virtualenv</code> automatically creates the environment in the <code class="inlineCode">~/.pyenv/versions/&lt;version&gt;/envs/</code> directory so you’re not allowed to fully specify your own path. You can change the base path (<code class="inlineCode">~/.pyenv/</code>) through the <code class="inlineCode">PYENV_ROOT</code> environment variable, however. Activating the environment using the <code class="inlineCode">activate</code> script in the environment directory is still possible, but more complicated than it needs to be since there’s an easy shortcut:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> pyenv activate your_pyenv&#13;
</code></pre>&#13;
    <p class="normal">Now that the environment is activated, you can run environment-specific commands, such as <code class="inlineCode">pip</code>, and they will only modify your environment.</p>&#13;
    <h2 id="_idParaDest-21" class="heading-2">Using Anaconda</h2>&#13;
    <p class="normal">Anaconda is a distribution that supports both the Python and R programming languages. It is much more than simply a virtual environment manager, though; it’s a whole different Python distribution with its own virtual environment system and even a completely different package system. In addition to supporting PyPI, it also supports <code class="inlineCode">conda-forge</code>, which features a very impressive number of packages focused on scientific computing.</p>&#13;
    <p class="normal">For the end user, the most important difference is that packages are installed through the <code class="inlineCode">conda</code> command instead of <code class="inlineCode">pip</code>. This brings a much more advanced dependency check when installing packages. Whereas <code class="inlineCode">pip</code> will simply install a package and all of its dependencies without regard for other installed packages, <code class="inlineCode">conda</code> will look at all of the installed packages and make sure it won’t install a version that is not supported by the installed packages.</p>&#13;
    <div class="note">&#13;
      <p class="normal">The <code class="inlineCode">conda</code> package manager is not alone in smart dependency checking. The <code class="inlineCode">pipenv</code> package manager (discussed later in this chapter) does something similar.</p>&#13;
    </div>&#13;
    <h3 id="_idParaDest-22" class="heading-3">Getting started with Anaconda Navigator</h3>&#13;
    <p class="normal">Installing Anaconda is quite easy on all common platforms. For Windows, OS X, and Linux, you can go to the Anaconda site and download the (graphical) installer: <a href="https://www.anaconda.com/products/distribution#Downloads"><span class="url">https://www.anaconda.com/products/distribution#Downloads</span></a><a href="https://www.anaconda.com/products/individual#Downloads%20"/></p>&#13;
    <p class="normal">Once it’s installed, the easiest way to continue is by launching Anaconda Navigator, which should look something like this:</p>&#13;
    <figure class="mediaobject"><img src="Images/B15882_01_01.png" alt="" width="878" height="438"/></figure>&#13;
    <p class="packt_figref">Figure 1.1: Anaconda Navigator – Home</p>&#13;
    <p class="normal">Creating an environment and installing packages is pretty straightforward as well:</p>&#13;
    <ol class="numberedList" style="list-style-type: decimal;">&#13;
      <li class="numberedList" value="1">Click on the <strong class="screenText">Environments </strong>button on the left.</li>&#13;
      <li class="numberedList">Click on the <strong class="screenText">Create </strong>button below.</li>&#13;
      <li class="numberedList">Enter your name and Python version.</li>&#13;
      <li class="numberedList">Click on <strong class="screenText">Create </strong>to create your environment and wait a bit until Anaconda is done:<figure class="mediaobject"><img src="Images/B15882_01_02.png" alt="" width="812" height="461"/></figure>&#13;
        <p class="packt_figref">Figure 1.2: Anaconda Navigator – Creating an environment</p>&#13;
      </li>&#13;
    </ol>&#13;
    <p class="normal">Once Anaconda<a id="_idIndexMarker000"/> has finished creating your environment, you should see a list of installed packages. Installing packages can be done by changing the filter of the package list from <strong class="screenText">Installed </strong>to <strong class="screenText">All</strong>, marking the checkbox near the packages you want to install, and applying the changes.</p>&#13;
    <div class="packt_tip">&#13;
      <p class="normal">While creating an environment, Anaconda Navigator shows you where the environment will be created.</p>&#13;
    </div>&#13;
    <h3 id="_idParaDest-23" class="heading-3">Getting started with conda</h3>&#13;
    <p class="normal">While Anaconda Navigator is a really nice tool to use to get an overview, being able to run your code from the<a id="_idIndexMarker001"/> command line can be convenient too. With the <code class="inlineCode">conda</code> command, that is luckily very easy.</p>&#13;
    <p class="normal">First, you need to open the <code class="inlineCode">conda</code> shell. You can do this from Anaconda Navigator if you wish, but you can also run it straightaway. On Windows, you can open Anaconda Prompt or Anaconda PowerShell Prompt from the start menu. On Linux and OS X, the most convenient method is to initialize the shell integration. For zsh, you can use:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> conda init zsh&#13;
</code></pre>&#13;
    <p class="normal">For other shells, the process is similar. Note that this process modifies your shell configuration to automatically activate the <code class="inlineCode">base</code> environment every time you open a shell. This can be disabled with a simple configuration option:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> conda config --<span class="hljs-con-built_in">set</span> auto_activate_base <span class="hljs-con-literal">false</span>&#13;
</code></pre>&#13;
    <p class="normal">If automatic activation is not enabled, you will need to run the <code class="inlineCode">activate</code> command to get back into the <code class="inlineCode">conda base</code> environment:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> conda activate&#13;
(base) <span class="hljs-con-meta">$</span>&#13;
</code></pre>&#13;
    <p class="normal">If, instead of the <code class="inlineCode">conda base</code> environment, you wish to activate the environment you created earlier, you need to specify the name:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> conda activate conda_env&#13;
(conda_env) <span class="hljs-con-meta">$</span>&#13;
</code></pre>&#13;
    <p class="normal">If you have not created the environment yet, you can do so using the command line as well:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> conda create --name conda_env&#13;
Collecting package metadata (current_repodata.json): done&#13;
Solving environment: done&#13;
...&#13;
Proceed ([y]/n)? y&#13;
&#13;
Preparing transaction: done&#13;
Verifying transaction: done&#13;
Executing transaction: done&#13;
...&#13;
</code></pre>&#13;
    <p class="normal">To list the available environments, you can use the <code class="inlineCode">conda info</code> command:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> conda info --envs&#13;
# conda environments&#13;
#&#13;
base                  *  /usr/<span class="hljs-con-built_in">local</span>/anaconda3&#13;
conda_env                /usr/local/anaconda3/envs/conda_env&#13;
</code></pre>&#13;
    <h4 class="heading-4">Installing conda packages</h4>&#13;
    <p class="normal">Now it’s time to install a<a id="_idIndexMarker002"/> package. For <code class="inlineCode">conda</code> packages, you can simply use the <code class="inlineCode">conda install</code> command. For example, to install the <code class="inlineCode">progressbar2</code> package that I maintain, use:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con">(conda_env) <span class="hljs-con-meta">$</span> conda install progressbar2&#13;
Collecting package metadata (current_repodata.json): done&#13;
Solving environment: done&#13;
&#13;
<span class="hljs-con-comment">## Package Plan ##</span>&#13;
  environment location: /usr/local/anaconda3/envs/conda_env&#13;
&#13;
  added / updated specs:&#13;
    - progressbar2&#13;
The following packages will be downloaded:&#13;
...&#13;
The following NEW packages will be INSTALLED:&#13;
...&#13;
Proceed ([y]/n)? y&#13;
&#13;
Downloading and Extracting Packages&#13;
...&#13;
</code></pre>&#13;
    <p class="normal">Now you can run Python and see that the package has been installed and is working properly:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con">(conda_env) <span class="hljs-con-meta">$</span> python&#13;
Python 3.8.0 (default, Nov  6 2019, 15:49:01)&#13;
[Clang 4.0.1 (tags/RELEASE_401/final)] :: Anaconda, Inc. on darwin&#13;
Type "help", "copyright", "credits" or "license" for more information.&#13;
<span class="hljs-con-meta">&gt;&gt;&gt;</span> <span class="hljs-con-keyword">import</span> progressbar&#13;
&#13;
<span class="hljs-con-meta">&gt;&gt;&gt;</span> <span class="hljs-con-keyword">for</span> _ <span class="hljs-con-keyword">in</span> progressbar.progressbar(<span class="hljs-con-built_in">range</span>(<span class="hljs-con-number">5</span>)): <span class="hljs-con-keyword">pass</span>&#13;
<span class="hljs-con-meta">...</span>&#13;
100% (5 of 5) |##############################| Elapsed Time: 0:00:00 Time:  0:00:00&#13;
</code></pre>&#13;
    <p class="normal">Another way to verify whether the package has been installed is by running the <code class="inlineCode">conda</code> <code class="inlineCode">list</code> command, which lists the installed packages similarly to <code class="inlineCode">pip list</code>:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con">(conda_env) <span class="hljs-con-meta">$</span> conda list&#13;
# packages <span class="hljs-con-keyword">in</span> environment at /usr/<span class="hljs-con-built_in">local</span>/anaconda3/envs/conda_env:&#13;
#&#13;
# Name                    Version                   Build  Channel&#13;
...&#13;
</code></pre>&#13;
    <h4 class="heading-4">Installing PyPI packages</h4>&#13;
    <p class="normal">With PyPI packages, we<a id="_idIndexMarker003"/> have two options within the Anaconda distribution. The most obvious is using <code class="inlineCode">pip</code>, but this has the downside of partially circumventing the <code class="inlineCode">conda</code> dependency checker. While <code class="inlineCode">conda install</code> will take the packages installed through PyPI into consideration, the <code class="inlineCode">pip</code> command might upgrade packages undesirably. This behavior can be improved by enabling the <code class="inlineCode">conda</code>/<code class="inlineCode">pip</code> interoperability setting, but this seriously impacts the performance of <code class="inlineCode">conda</code> commands:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> conda config --<span class="hljs-con-built_in">set</span> pip_interop_enabled True&#13;
</code></pre>&#13;
    <p class="normal">Depending on how important fixed versions or <code class="inlineCode">conda</code> performance is for you, you can also opt for converting the package to a <code class="inlineCode">conda</code> package:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con">(conda_env) <span class="hljs-con-meta">$</span> conda skeleton pypi progressbar2&#13;
Warning, the following versions were found for progressbar2&#13;
...&#13;
Use --version to specify a different version.&#13;
...&#13;
<span class="hljs-con-comment">## Package Plan ##</span>&#13;
...&#13;
The following NEW packages will be INSTALLED:&#13;
...&#13;
INFO:conda_build.config:--dirty flag and --keep-old-work not specified. Removing build/test folder after successful build/test.&#13;
</code></pre>&#13;
    <p class="normal">Now that we have a package, we can modify the files if needed, but using the automatically generated files works most of the time. All that is left now is to build and install the package:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con">(conda_env) <span class="hljs-con-meta">$</span> conda build progressbar2&#13;
...&#13;
(conda_env) <span class="hljs-con-meta">$</span> conda install --use-local progressbar2&#13;
Collecting package metadata (current_repodata.json): done&#13;
Solving environment: done&#13;
...&#13;
</code></pre>&#13;
    <p class="normal">And now we are done! The package has been installed through <code class="inlineCode">conda</code> instead of <code class="inlineCode">pip</code>.</p>&#13;
    <h4 class="heading-4">Sharing your environment</h4>&#13;
    <p class="normal">When collaborating with others, it is <a id="_idIndexMarker004"/>essential to have environments that are as similar as possible to avoid debugging local issues. With <code class="inlineCode">pip</code>, we can simply create a requirements file by using <code class="inlineCode">pip freeze</code>, but that will not include the <code class="inlineCode">conda</code> packages. With <code class="inlineCode">conda</code>, there’s actually an even better solution, which stores not only the dependencies and versions but also the installation channels, environment name, and environment location:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con">(conda_env) <span class="hljs-con-meta">$</span> conda env export –file environment.yml&#13;
(conda_env) <span class="hljs-con-meta">$</span> cat environment.yml&#13;
name: conda_env&#13;
channels:&#13;
  - defaults&#13;
dependencies:&#13;
...&#13;
prefix: /usr/local/anaconda3/envs/conda_env&#13;
</code></pre>&#13;
    <p class="normal">Installing the packages from that environment file can be done while creating the environment:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> conda env create --name conda_env –file environment.yml&#13;
</code></pre>&#13;
    <p class="normal">Or they can be added to an existing environment:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con">(conda_env) <span class="hljs-con-meta">$</span> conda env update --file environment.yml&#13;
Collecting package metadata (repodata.json): done&#13;
...&#13;
</code></pre>&#13;
    <h1 id="_idParaDest-24" class="heading-1">Managing dependencies</h1>&#13;
    <p class="normal">The simplest way of <a id="_idIndexMarker005"/>managing dependencies is storing them in a <code class="inlineCode">requirements.txt </code>file. In its simplest form, this is a list of package names and nothing else. This file can be extended with version requirements and can even support environment-specific installations.</p>&#13;
    <p class="normal">A fancier method of installing and managing your dependencies is by using a tool such as <code class="inlineCode">poetry</code> or <code class="inlineCode">pipenv</code>. Internally, these use the regular <code class="inlineCode">pip</code> installation method, but they build a full dependency graph of all the packages. This makes sure that all package versions are compatible with each other and allows the parallel installation of non-dependent packages.</p>&#13;
    <h2 id="_idParaDest-25" class="heading-2">Using pip and a requirements.txt file</h2>&#13;
    <p class="normal">The <code class="inlineCode">requirements.txt</code> format <a id="_idIndexMarker006"/>allows you to list all of the dependencies of your project as broadly or as specifically as you feel is necessary. You can easily create this file yourself, but you can also tell <code class="inlineCode">pip</code> to generate it for you, or even to generate a new file based on a previous <code class="inlineCode">requirements.txt</code> file so you can view the changes. I recommend using <code class="inlineCode">pip freeze</code> to generate an initial file and cherry-picking the dependencies (versions) you want.</p>&#13;
    <p class="normal">For example, assuming that we run <code class="inlineCode">pip freeze</code> in our virtual environment from before:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con">(your_env) <span class="hljs-con-meta">$</span> pip3 freeze&#13;
pkg-resources==0.0.0&#13;
</code></pre>&#13;
    <p class="normal">If we store that file in a <code class="inlineCode">requirements.txt</code> file, install a package, and look at the difference, we get this result:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con">(your_env) <span class="hljs-con-meta">$</span> pip3 freeze &gt; requirements.txt&#13;
(your_env) <span class="hljs-con-meta">$</span> pip3 install progressbar2&#13;
Collecting progressbar2&#13;
...&#13;
Installing collected packages: six, python-utils, progressbar2&#13;
Successfully installed progressbar2-3.47.0 python-utils-2.3.0 six-1.13.0&#13;
(your_env) <span class="hljs-con-meta">$</span> pip3 freeze -r requirements.txt &#13;
pkg-resources==0.0.0&#13;
<span class="hljs-con-comment">## The following requirements were added by pip freeze:</span>&#13;
progressbar2==3.47.0&#13;
python-utils==2.3.0&#13;
six==1.13.0&#13;
</code></pre>&#13;
    <p class="normal">As you<a id="_idIndexMarker007"/> can see, the <code class="inlineCode">pip freeze</code> command automatically detected the addition of the <code class="inlineCode">six</code>, <code class="inlineCode">progressbar2</code>, and <code class="inlineCode">python-utils</code> packages, and it immediately pinned those versions to the currently installed ones.</p>&#13;
    <div class="packt_tip">&#13;
      <p class="normal">The lines in the <code class="inlineCode">requirements.txt</code> file are understood by <code class="inlineCode">pip</code> on the command line as well, so to install a specific version, you can run:</p>&#13;
      <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> pip3 install 'progressbar2==3.47.0'&#13;
</code></pre>&#13;
    </div>&#13;
    <h2 id="_idParaDest-26" class="heading-2">Version specifiers</h2>&#13;
    <p class="normal">Often, pinning a version <a id="_idIndexMarker008"/>as strictly as that is not desirable, however, so let’s change the requirements file to only contain what we actually care about:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"># We want a progressbar that is at least version 3.47.0 since we've tested that.</span>&#13;
<span class="hljs-comment"># But newer versions are ok as well.</span>&#13;
progressbar2&gt;=<span class="hljs-number">3</span>.<span class="hljs-number">47</span>.<span class="hljs-number">0</span>&#13;
</code></pre>&#13;
    <p class="normal">If someone else wants to install all of the requirements in this file, they can simply tell <code class="inlineCode">pip</code> to include that requirement:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con">(your_env) <span class="hljs-con-meta">$</span> pip3 install -r requirements.txt &#13;
Requirement already satisfied: progressbar2&gt;=3.47.0 in your_env/lib/python3.9/site-packages (from -r requirements.txt (line 1))&#13;
Requirement already satisfied: python-utils&gt;=2.3.0 in your_env/lib/python3.9/site-packages (from progressbar2&gt;=3.47.0-&gt;-r requirements.txt (line 1))&#13;
Requirement already satisfied: six in your_env/lib/python3.9/site-packages (from progressbar2&gt;=3.47.0-&gt;-r requirements.txt (line 1))&#13;
</code></pre>&#13;
    <p class="normal">In this case, <code class="inlineCode">pip</code> checks to see whether all packages are installed and will install or update them if needed.</p>&#13;
    <div class="packt_tip">&#13;
      <p class="normal"><code class="inlineCode">-r requirements.txt</code> works recursively, allowing you to include multiple requirements files.</p>&#13;
    </div>&#13;
    <p class="normal">Now let’s assume we’ve encountered a bug in the latest version and we wish to skip it. We can assume that only this specific version is affected, so we will only blacklist that version:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"># Progressbar 2 version 3.47.0 has a silly bug but anything beyond 3.46.0 still works with our code</span>&#13;
progressbar2&gt;=<span class="hljs-number">3</span>.<span class="hljs-number">46</span>,!=<span class="hljs-number">3</span>.<span class="hljs-number">47</span>.<span class="hljs-number">0</span>&#13;
</code></pre>&#13;
    <p class="normal">Lastly, we should talk about wildcards. One of the most common scenarios is needing a specific major version number but still wanting the latest security update and bug fixes. There are a few ways to specify these:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"># Basic wildcard:</span>&#13;
progressbar2 ==<span class="hljs-number">3</span>.<span class="hljs-number">47</span>.*&#13;
<span class="hljs-comment"># Compatible release:</span>&#13;
progressbar2 ~=<span class="hljs-number">3</span>.<span class="hljs-number">47</span>.<span class="hljs-number">1</span>&#13;
<span class="hljs-comment"># Compatible release above is identical to:</span>&#13;
progressbar2 &gt;=<span class="hljs-number">3</span>.<span class="hljs-number">47</span>.<span class="hljs-number">1</span>, ==<span class="hljs-number">3</span>.<span class="hljs-number">47</span>.*&#13;
</code></pre>&#13;
    <p class="normal">With the compatible<a id="_idIndexMarker009"/> release pattern (~=), you can select the newest version that is within the same major release but is at least the specified version.</p>&#13;
    <div class="packt_tip">&#13;
      <p class="normal">The version identification and dependency specification standard is described thoroughly in PEP 440:</p>&#13;
      <p class="normal"><a href="https://peps.python.org/pep-0440/"><span class="url">https://peps.python.org/pep-0440/</span></a></p>&#13;
    </div>&#13;
    <h2 id="_idParaDest-27" class="heading-2">Installing through source control repositories</h2>&#13;
    <p class="normal">Now let’s say<a id="_idIndexMarker010"/> that we’re really unlucky and <a id="_idIndexMarker011"/>there is no working release of the package yet, but it has been fixed in the <code class="inlineCode">develop</code> branch of the Git repository. We can install that either through <code class="inlineCode">pip</code> or through a <code class="inlineCode">requirements.txt</code> file, like this:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con">(your_env) <span class="hljs-con-meta">$</span> pip3 install --editable 'git+https://github.com/wolph/python-progressbar@develop#egg=progressbar2'&#13;
Obtaining progressbar2 from git+https://github.com/wolph/python-progressbar@develop#egg=progressbar2&#13;
  Updating your_env/src/progressbar2 clone (to develop)&#13;
Requirement already satisfied: python-utils&gt;=2.3.0 in your_env/lib/python3.9/site-packages (from progressbar2)&#13;
Requirement already satisfied: six in your_env/lib/python3.9/site-packages (from progressbar2)&#13;
Installing collected packages: progressbar2&#13;
  Found existing installation: progressbar2 3.47.0&#13;
    Uninstalling progressbar2-3.47.0:&#13;
      Successfully uninstalled progressbar2-3.47.0&#13;
  Running setup.py develop for progressbar2&#13;
Successfully installed progressbar2&#13;
</code></pre>&#13;
    <p class="normal">You may notice that <code class="inlineCode">pip</code> not only installed the package but actually did a <code class="inlineCode">git clone</code> to <code class="inlineCode">your_env/src/progressbar2</code>. This is an optional step caused by the <code class="inlineCode">--editable</code> (short option: <code class="inlineCode">-e</code>) flag, which has the additional advantage that every time you re-run the command, the <code class="inlineCode">git</code> clone will be updated. It also makes it rather easy to go to that directory, modify the<a id="_idIndexMarker012"/> code, and create a pull<a id="_idIndexMarker013"/> request with a fix.</p>&#13;
    <div class="note">&#13;
      <p class="normal">In addition to Git, other source control systems such as Bazaar, Mercurial, and Subversion are also supported.</p>&#13;
    </div>&#13;
    <h2 id="_idParaDest-28" class="heading-2">Additional dependencies using extras</h2>&#13;
    <p class="normal">Many packages offer optional<a id="_idIndexMarker014"/> dependencies for specific use cases. In the case of the <code class="inlineCode">progressbar2</code> library, I have added <code class="inlineCode">tests</code> and <code class="inlineCode">docs</code> extras to install the test or documentation building dependencies needed to run the tests for the package. Extras can be specified using square brackets separated by commas:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"># Install the documentation and test extras in addition to the progressbar</span>&#13;
progressbar2[docs,tests]&#13;
<span class="hljs-comment"># A popular example is the installation of encryption libraries when using the requests library:</span>&#13;
requests[security]&#13;
</code></pre>&#13;
    <h2 id="_idParaDest-29" class="heading-2">Conditional dependencies using environment markers</h2>&#13;
    <p class="normal">If your project needs to <a id="_idIndexMarker015"/>run on multiple systems, you will most likely encounter dependencies that are not required on all systems. One example of this is libraries that are required on some operating systems but not on others. An example of this is the <code class="inlineCode">portalocker</code> package I maintain; on Linux/Unix systems, the locking mechanisms needed are supported out of the box. On Windows, however, they require the <code class="inlineCode">pywin32</code> package to work. The <code class="inlineCode">install_requires</code> part of the package (which uses the same syntax as <code class="inlineCode">requirements.txt</code>) contains this line:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code">pywin32!=<span class="hljs-number">226</span>; platform_system == "Windows"&#13;
</code></pre>&#13;
    <p class="normal">This specifies that on Windows, the <code class="inlineCode">pywin32</code> package is required, and version <code class="inlineCode">226</code> was blacklisted due to a bug.</p>&#13;
    <p class="normal">In addition to <code class="inlineCode">platform_system</code>, there are several more markers, such as <code class="inlineCode">python_version</code> and <code class="inlineCode">platform_machine</code> (contains architecture <code class="inlineCode">x86_64</code>, for example).</p>&#13;
    <div class="note">&#13;
      <p class="normal">The full list of markers can be found in PEP 496: <a href="https://peps.python.org/pep-0496/"><span class="url">https://peps.python.org/pep-0496/</span></a>.</p>&#13;
    </div>&#13;
    <p class="normal">One other useful <a id="_idIndexMarker016"/>example of this is the <code class="inlineCode">dataclasses</code> library. This library has been included with Python since version 3.7, so we only need to install the backport for older Python versions:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code">dataclasses; python_version &lt; <span class="hljs-string">'3.7'</span>&#13;
</code></pre>&#13;
    <h2 id="_idParaDest-30" class="heading-2">Automatic project management using poetry</h2>&#13;
    <p class="normal">The <code class="inlineCode">poetry</code> tool provides a <a id="_idIndexMarker017"/>really easy-to-use solution for<a id="_idIndexMarker018"/> creating, updating, and sharing your Python projects. It’s also very fast, which makes it a fantastic starting point for a project.</p>&#13;
    <h3 id="_idParaDest-31" class="heading-3">Creating a new poetry project</h3>&#13;
    <p class="normal">Starting a new project is very <a id="_idIndexMarker019"/>easy. It will automatically handle virtual environments, dependencies, and other project-related tasks for you. To start, we will use the <code class="inlineCode">poetry init</code> wizard:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> poetry init&#13;
This command will guide you through creating your pyproject.toml config.&#13;
&#13;
Package name [t_00_poetry]:&#13;
Version [0.1.0]:&#13;
Description []:&#13;
Author [Rick van Hattem &lt;Wolph@wol.ph&gt;, n to skip]:&#13;
License []:&#13;
Compatible Python versions [^3.10]:&#13;
&#13;
Would you like to define your main dependencies interactively? (yes/no) [yes] no&#13;
Would you like to define your development dependencies interact...? (yes/no) [yes] no&#13;
...&#13;
Do you confirm generation? (yes/no) [yes]&#13;
</code></pre>&#13;
    <p class="normal">Following these few questions, it automatically creates a <code class="inlineCode">pyproject.toml</code> file for us that contains all the data we entered and some automatically generated data. As you may have noticed, it automatically prefilled several values for us:</p>&#13;
    <ul>&#13;
      <li class="bulletList">The project name. This is based on the current directory name.</li>&#13;
      <li class="bulletList">The version. This is fixed to <code class="inlineCode">0.1.0</code>.</li>&#13;
      <li class="bulletList">The author field. This looks at your <code class="inlineCode">git</code> user information. This can be set using:&#13;
        <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> git config --global user.name "Rick van Hattem"&#13;
<span class="hljs-con-meta">$</span> git config --global user.email "Wolph@wol.ph"&#13;
</code></pre>&#13;
      </li>&#13;
      <li class="bulletList">The Python version. This is based on the Python version you are running <code class="inlineCode">poetry</code> with, but it can be customized using <code class="inlineCode">poetry init --python=...</code></li>&#13;
    </ul>&#13;
    <p class="normal">Looking at the <a id="_idIndexMarker020"/>generated <code class="inlineCode">pyproject.toml</code>, we can see the following:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-section">[tool.poetry]</span>&#13;
<span class="hljs-attr">name</span> = <span class="hljs-string">"t_00_poetry"</span>&#13;
<span class="hljs-attr">version</span> = <span class="hljs-string">"0.1.0"</span>&#13;
<span class="hljs-attr">description</span> = <span class="hljs-string">""</span>&#13;
<span class="hljs-attr">authors</span> = [<span class="hljs-string">"Rick van Hattem &lt;Wolph@wol.ph&gt;"</span>]&#13;
&#13;
<span class="hljs-section">[tool.poetry.dependencies]</span>&#13;
<span class="hljs-attr">python</span> = <span class="hljs-string">"^3.10"</span>&#13;
&#13;
<span class="hljs-section">[tool.poetry.dev-dependencies]</span>&#13;
&#13;
<span class="hljs-section">[build-system]</span>&#13;
<span class="hljs-attr">requires</span> = [<span class="hljs-string">"poetry-core&gt;=1.0.0"</span>]&#13;
<span class="hljs-attr">build-backend</span> = <span class="hljs-string">"poetry.core.masonry.api"</span>&#13;
</code></pre>&#13;
    <h3 id="_idParaDest-32" class="heading-3">Adding dependencies</h3>&#13;
    <p class="normal">Once we have the<a id="_idIndexMarker021"/> project up and running, we can now add dependencies:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> poetry add progressbar2&#13;
Using version ^3.55.0 for progressbar2&#13;
...&#13;
Writing lock file&#13;
...&#13;
  • Installing progressbar2 (3.55.0)&#13;
</code></pre>&#13;
    <p class="normal">This automatically installs the package, adds it to the <code class="inlineCode">pyproject.toml</code> file, and adds the specific version to the <code class="inlineCode">poetry.lock</code> file. After this command, the <code class="inlineCode">pyproject.toml</code> file has a new line added to the <code class="inlineCode">tool.poetry.dependencies</code> section:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-section">[tool.poetry.dependencies]</span>&#13;
<span class="hljs-attr">python</span> = <span class="hljs-string">"^3.10"</span>&#13;
<span class="hljs-attr">progressbar2</span> = <span class="hljs-string">"</span><span class="hljs-string">^3.55.0"</span>&#13;
</code></pre>&#13;
    <p class="normal">The <code class="inlineCode">poetry.lock</code> <a id="_idIndexMarker022"/>file is a bit more specific. Whereas the <code class="inlineCode">progressbar2</code> dependency could have a wildcard version, the <code class="inlineCode">poetry.lock</code> file stores the exact version, the file hashes, and all the dependencies that were installed:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code">[[package]]&#13;
name = <span class="hljs-string">"progressbar2"</span>&#13;
version = <span class="hljs-string">"3.55.0"</span>&#13;
... &#13;
[package.dependencies]&#13;
python-utils = <span class="hljs-string">"&gt;=2.3.0"</span>&#13;
...&#13;
[package.extras]&#13;
docs = [<span class="hljs-string">"sphinx (&gt;=1.7.4)"</span>]&#13;
...&#13;
[metadata]&#13;
lock-version = <span class="hljs-string">"1.1"</span>&#13;
python-versions = <span class="hljs-string">"^3.10"</span>&#13;
content-hash = <span class="hljs-string">"c4235fba0428ce7877f5a94075e19731e5d45caa73ff2e0345e5dd269332bff0"</span>&#13;
&#13;
[metadata.files]&#13;
progressbar2 = [&#13;
    {file = <span class="hljs-string">"progressbar2-3.55.0-py2.py3-none-any.whl"</span>, hash = <span class="hljs-string">"sha256:..."</span>},&#13;
    {file = <span class="hljs-string">"progressbar2-3.55.0.tar.gz"</span>, hash = <span class="hljs-string">"sha256:..."</span>},&#13;
]&#13;
...&#13;
</code></pre>&#13;
    <p class="normal">By having all this data, we can build or rebuild a virtual environment for a <code class="inlineCode">poetry</code>-based project on another system exactly as it was created on the original system. To install, upgrade, and/or downgrade the packages exactly as specified in the <code class="inlineCode">poetry.lock</code> file, we need a single command:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> poetry install&#13;
Installing dependencies from lock file&#13;
...&#13;
</code></pre>&#13;
    <p class="normal">This is very <a id="_idIndexMarker023"/>similar to how the <code class="inlineCode">npm</code> and <code class="inlineCode">yarn</code> commands work if you are familiar with those.</p>&#13;
    <h3 id="_idParaDest-33" class="heading-3">Upgrading dependencies</h3>&#13;
    <p class="normal">In the previous<a id="_idIndexMarker024"/> examples, we simply added a dependency without specifying an explicit version. Often this is a safe approach, as the default version requirement will allow for any version within that major version.</p>&#13;
    <p class="normal">If the project uses normal Python versioning or semantic versioning (more about that in <em class="chapterRef">Chapter 18, </em><em class="italic">Packaging - Creating Your Own Libraries or Applications</em>), that should be perfect. At the very least, all of my projects (such as progressbar2) are generally both backward and largely forward compatible, so simply fixing the major version is enough. In this case, <code class="inlineCode">poetry</code> defaulted to version <code class="inlineCode">^3.55.0</code>, which means that any version newer than or equal to 3.55.0, up to (but not including) 4.0.0, is valid.</p>&#13;
    <p class="normal">Due to the <code class="inlineCode">poetry.lock</code> file, a <code class="inlineCode">poetry install</code> will result in those exact versions being installed instead of the new versions, however. So how can we upgrade the dependencies? For this purpose, we will start by installing an older version of the <code class="inlineCode">progressbar2</code> library:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> poetry add <span class="hljs-con-string">'progressbar2=3.1.0'</span>&#13;
</code></pre>&#13;
    <p class="normal">Now we will relax the version in the <code class="inlineCode">pyproject.toml</code> file to <code class="inlineCode">^3.1.0</code>:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-section">[tool.poetry.dependencies]</span>&#13;
<span class="hljs-attr">progressbar2</span> = <span class="hljs-string">"^3.1.0"</span>&#13;
</code></pre>&#13;
    <p class="normal">Once we have done this, a <code class="inlineCode">poetry install</code> will still keep the <code class="inlineCode">3.1.0</code> version, but we can make <code class="inlineCode">poetry</code> update the dependencies for us:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> poetry update&#13;
...&#13;
  • Updating progressbar2 (3.1.0 -&gt; 3.55.0)&#13;
</code></pre>&#13;
    <p class="normal">Now, poetry has <a id="_idIndexMarker025"/>nicely updated the dependencies in our project while still adhering to the requirements we set in the <code class="inlineCode">pyproject.toml</code> <code class="inlineCode">file</code>. If you set the version requirements of all packages to <code class="inlineCode">*</code>, it will always update everything to the latest available versions that are compatible with each other.</p>&#13;
    <h3 id="_idParaDest-34" class="heading-3">Running commands</h3>&#13;
    <p class="normal">To run a single <a id="_idIndexMarker026"/>command using the <code class="inlineCode">poetry</code> environment, you <a id="_idIndexMarker027"/>can use <code class="inlineCode">poetry run</code>:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> poetry run pip&#13;
</code></pre>&#13;
    <p class="normal">For an entire development session, however, I would suggest using the <code class="inlineCode">shell</code> command:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> poetry shell&#13;
</code></pre>&#13;
    <p class="normal">After this, you can run all Python commands as normal, but these will now be running from the activated virtual environment.</p>&#13;
    <p class="normal">For cron jobs this is similar, but you will need to make sure that you change directories first:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con">0 3 * * *       cd /home/wolph/workspace/poetry_project/ &amp;&amp; poetry run python script.py&#13;
</code></pre>&#13;
    <p class="normal">This command runs every day at 03:00 (24-hour clock, so A.M.).</p>&#13;
    <p class="normal">Note that cron might not be able to find the <code class="inlineCode">poetry</code> command due to having a different environment. In that case, I would recommend using the absolute path to the <code class="inlineCode">poetry</code> command, which can be found using <code class="inlineCode">which</code>:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> <span class="hljs-con-built_in">which</span> poetry&#13;
/usr/local/bin/poetry&#13;
</code></pre>&#13;
    <h2 id="_idParaDest-35" class="heading-2">Automatic dependency tracking using pipenv</h2>&#13;
    <p class="normal">For large projects, your <a id="_idIndexMarker028"/>dependencies can change <a id="_idIndexMarker029"/>often, which makes the manual manipulation of the <code class="inlineCode">requirements.txt</code> file rather tedious. Additionally, having to create a virtual environment before you can install your packages is also a pretty repetitive task if you work on many projects. The <code class="inlineCode">pipenv</code> tool aims to transparently solve these issues for you, while also making sure that all of your dependencies are compatible and updated. And as a final bonus, it combines the strict and loose dependency versions so you can make sure your production environment uses the exact same versions you tested.</p>&#13;
    <p class="normal">Initial usage is simple; go to your project directory and install a package. Let’s give it a try:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> pipenv install progressbar2&#13;
Creating a virtualenv for this project...&#13;
...&#13;
Using /usr/local/bin/python3 (3.10.4) to create virtualenv...&#13;
...&#13;
<img src="Images/B15882_01_001.png" alt="" width="26" height="23"/> Successfully created virtual environment!&#13;
...&#13;
Creating a Pipfile for this project...&#13;
Installing progressbar2...&#13;
Adding progressbar2 to Pipfile's [packages]...&#13;
<img src="Images/B15882_01_001.png" alt="" width="26" height="23"/> Installation Succeeded&#13;
Pipfile.lock not found, creating...&#13;
...&#13;
<img src="Images/B15882_01_001.png" alt="" width="26" height="23"/> Success!&#13;
Updated Pipfile.lock (996b11)!&#13;
Installing dependencies from Pipfile.lock (996b11)...&#13;
  <img src="Images/B15882_01_002.png" alt="" width="367" height="27"/> 0/0 — 00:00:0&#13;
</code></pre>&#13;
    <p class="normal">That’s quite a bit of output even when abbreviated. But let’s look at what happened:</p>&#13;
    <ul>&#13;
      <li class="bulletList">A virtual environment was created.</li>&#13;
      <li class="bulletList">A <code class="inlineCode">Pipfile</code> was created, which contains the dependency as you specified it. If you specify a specific version, that will be added to the <code class="inlineCode">Pipfile</code>; otherwise, it will be a wildcard requirement, meaning that any version will be accepted as long as there are no conflicts with other packages.</li>&#13;
      <li class="bulletList">A <code class="inlineCode">Pipfile.lock</code> was created containing the exact list of packages and versions as installed. This allows an identical install on a different machine with the exact same versions.</li>&#13;
    </ul>&#13;
    <p class="normal">The <a id="_idIndexMarker030"/>generated <code class="inlineCode">Pipfile</code> contains<a id="_idIndexMarker031"/> the following:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code">[[source]]&#13;
name = <span class="hljs-string">"pypi"</span>&#13;
url = <span class="hljs-string">"https://pypi.org/simple"</span>&#13;
verify_ssl = <span class="hljs-literal">true</span>&#13;
&#13;
[dev-packages]&#13;
&#13;
[packages]&#13;
progressbar2 = <span class="hljs-string">"*"</span>&#13;
&#13;
[requires]&#13;
python_version = <span class="hljs-string">"3.10"</span>&#13;
</code></pre>&#13;
    <p class="normal">And the <code class="inlineCode">Pipfile.lock</code> is a bit larger, but immediately shows another advantage of this method:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code">{&#13;
    ...&#13;
    "default": {&#13;
        "progressbar2": {&#13;
            "hashes": [&#13;
                "sha256:14d3165a1781d053...",&#13;
                "sha256:2562ba3e554433f0..."&#13;
            ],&#13;
            "index": "pypi",&#13;
            "version": "==4.0.0"&#13;
        },&#13;
        "python-utils": {&#13;
            "hashes": [&#13;
                "sha256:4dace6420c5f50d6...",&#13;
                "sha256:93d9cdc8b8580669..."&#13;
            ],&#13;
            "markers": "python_version &gt;= '3.7'",&#13;
            "version": "==3.1.0"&#13;
        },&#13;
        ...&#13;
    },&#13;
    "develop": {}&#13;
}&#13;
</code></pre>&#13;
    <p class="normal">As you can see, in addition to the exact package versions, the <code class="inlineCode">Pipfile.lock</code> contains the hashes of the packages as well. In this case, the package provides both a <code class="inlineCode">.tar.gz</code> (source) and a <code class="inlineCode">.whl</code> (wheel) file, which is why there are two hashes. Additionally, the <code class="inlineCode">Pipfile.lock</code> contains all packages installed by <code class="inlineCode">pipenv</code>, including all dependencies.</p>&#13;
    <p class="normal">Using these hashes, you can be certain that during a deployment, you will receive the exact same file and not some corrupt or even malicious file.</p>&#13;
    <p class="normal">Because the <a id="_idIndexMarker032"/>versions are completely fixed, you can also be<a id="_idIndexMarker033"/> certain that anyone deploying your project using the <code class="inlineCode">Pipfile.lock</code> will get the exact same package versions. This is very useful when working together with other developers. </p>&#13;
    <p class="normal">To install all the necessary packages as specified in the <code class="inlineCode">Pipfile</code> (even for the initial install), you can simply run: </p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> pipenv install&#13;
Installing dependencies from Pipfile.lock (5c99e1)…&#13;
  <img src="Images/B15882_01_002.png" alt="" width="367" height="27"/> 3/3 — 00:00:00&#13;
To activate this project's virtualenv, run pipenv shell.&#13;
Alternatively, run a command inside the virtualenv with pipenv run.&#13;
</code></pre>&#13;
    <p class="normal">Any time you run <code class="inlineCode">pipenv install package</code>, the <code class="inlineCode">Pipfile</code> will be automatically modified with your changes and checked for incompatible packages. The big downside is that <code class="inlineCode">pipenv</code> can become terribly slow for large projects. I have encountered multiple projects where a no-op <code class="inlineCode">pip install</code> would take several minutes due to the fetching and checking of the entire dependency graph. In most cases, it’s still worth it, however; the added functionality can save you a lot of headaches.</p>&#13;
    <div class="packt_tip">&#13;
      <p class="normal">Don’t forget to run your regular Python commands with the <code class="inlineCode">pipenv run</code> prefix or from <code class="inlineCode">pipenv shell</code>.</p>&#13;
    </div>&#13;
    <h3 id="_idParaDest-36" class="heading-3">Updating your packages</h3>&#13;
    <p class="normal">Because of the<a id="_idIndexMarker034"/> dependency graph, you can easily update your packages without having to worry about dependency conflicts. With one command, you’re done:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> pipenv update&#13;
</code></pre>&#13;
    <p class="normal">Should you still encounter issues with the versions because some packages haven’t been checked against each other, you can fix that by specifying the versions of the package you do or do not want:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> pipenv install <span class="hljs-con-string">'progressbar2!=3.47.0'</span>&#13;
Installing progressbar2!=3.47.0…&#13;
Adding progressbar2 to Pipfile's [packages]…&#13;
<img src="Images/B15882_01_001.png" alt="" width="26" height="23"/> Installation Succeeded &#13;
Pipfile.lock (c9327e) out of date, updating to (5c99e1)…&#13;
<img src="Images/B15882_01_001.png" alt="" width="26" height="23"/> Success! &#13;
Updated Pipfile.lock (c9327e)!&#13;
Installing dependencies from Pipfile.lock (c9327e)…&#13;
  <img src="Images/B15882_01_002.png" alt="" width="367" height="27"/> 3/3 — 00:00:00&#13;
</code></pre>&#13;
    <p class="normal">By running that command, the <code class="inlineCode">packages</code> section of the <code class="inlineCode">Pipfile</code> changes to:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code">[packages]&#13;
progressbar2 = <span class="hljs-string">"!=3.47.0"</span>&#13;
</code></pre>&#13;
    <h3 id="_idParaDest-37" class="heading-3">Deploying to production</h3>&#13;
    <p class="normal">Getting the exact<a id="_idIndexMarker035"/> same versions on all of your production servers is absolutely essential to prevent hard-to-trace bugs. For this very purpose, you can tell <code class="inlineCode">pipenv</code> to install everything as specified in the <code class="inlineCode">Pipenv.lock</code> file while still checking to see whether <code class="inlineCode">Pipfile.lock</code> is out of date. With one command, you have a fully functioning production virtual environment with all packages installed.</p>&#13;
    <p class="normal">Let’s create a new directory and see if it all works out:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$</span> mkdir ../pipenv_production&#13;
<span class="hljs-con-meta">$</span> cp Pipfile Pipfile.lock ../pipenv_production/&#13;
<span class="hljs-con-meta">$</span> cd ../pipenv_production/&#13;
<span class="hljs-con-meta">$</span> pipenv install --deploy&#13;
Creating a virtualenv for this project...&#13;
Pipfile: /home/wolph/workspace/pipenv_production/Pipfile&#13;
Using /usr/bin/python3 (3.10.4) to create virtualenv...&#13;
...&#13;
<img src="Images/B15882_01_001.png" alt="" width="26" height="23"/> Successfully created virtual environment!&#13;
...&#13;
Installing dependencies from Pipfile.lock (996b11)...&#13;
  <img src="Images/B15882_01_002.png" alt="" width="367" height="27"/> 2/2 — 00:00:01&#13;
<span class="hljs-con-meta">$</span> pipenv shell&#13;
Launching subshell in virtual environment...&#13;
(pipenv_production) <span class="hljs-con-meta">$</span> pip3 freeze&#13;
progressbar2==4.0.0&#13;
python-utils==3.1.0&#13;
</code></pre>&#13;
    <p class="normal">All of the versions are exactly as expected and ready for use.</p>&#13;
    <h3 id="_idParaDest-38" class="heading-3">Running cron commands</h3>&#13;
    <p class="normal">To run your Python <a id="_idIndexMarker036"/>commands outside of the <code class="inlineCode">pipenv shell</code>, you can use the <code class="inlineCode">pipenv run</code> prefix. Instead of <code class="inlineCode">python</code>, you would run <code class="inlineCode">pipenv run python</code>. In normal usage, this is a lot less practical than activating the <code class="inlineCode">pipenv shell</code>, but for non-interactive sessions, such as cron jobs, this is an essential feature. For example, a cron job that runs at 03:00 (24-hour clock, so A.M.) every day would look something like this:</p>&#13;
    <pre class="programlisting con"><code class="hljs-con">0 3 * * *       cd /home/wolph/workspace/pipenv_project/ &amp;&amp; pipenv run python script.py&#13;
</code></pre>&#13;
    <h1 id="_idParaDest-39" class="heading-1">Exercises</h1>&#13;
    <p class="normal">Many of the topics discussed in this chapter already gave full examples, leaving little room for exercises. There are additional resources to discover, however.</p>&#13;
    <h2 id="_idParaDest-40" class="heading-2">Reading the Python Enhancement Proposals (PEPs)</h2>&#13;
    <p class="normal">A good way to learn more about the topics discussed in this chapter (and all the following chapters) is to read the PEP pages. These proposals were written before the changes were accepted into the Python core. Note that not all of the PEPs on the Python site have been accepted, but they will remain on the Python site:</p>&#13;
    <ul>&#13;
      <li class="bulletList">PEP 440 – Version Identification and Dependency Specification: <a href="https://peps.python.org/pep-0440/"><span class="url">https://peps.python.org/pep-0440/</span></a></li>&#13;
      <li class="bulletList">PEP 496 – Environment Markers: <a href="https://peps.python.org/pep-0496/"><span class="url">https://peps.python.org/pep-0496/</span></a></li>&#13;
    </ul>&#13;
    <h2 id="_idParaDest-41" class="heading-2">Combining pyenv and poetry or pipenv</h2>&#13;
    <p class="normal">Even though the chapter did not cover it, there is nothing stopping you from telling <code class="inlineCode">poetry</code> or <code class="inlineCode">pipenv</code> to use a <code class="inlineCode">pyenv</code>-based Python interpreter. Give it a try!</p>&#13;
    <h2 id="_idParaDest-42" class="heading-2">Converting an existing project to a poetry project</h2>&#13;
    <p class="normal">Part of this exercise should be to either create a brand new <code class="inlineCode">pyproject.toml</code> or to convert an existing <code class="inlineCode">requirements.txt</code> file to a <code class="inlineCode">pyproject.toml</code>.</p>&#13;
    <h1 id="_idParaDest-43" class="heading-1">Summary</h1>&#13;
    <p class="normal">In this chapter, you learned why virtual environments are useful and you discovered several implementations of them and their advantages. We explored how to create virtual environments and how to install multiple different Python versions. Finally, we covered how to manage the dependencies for your Python projects.</p>&#13;
    <p class="normal">Since Python is an interpreted language, it is easily possible to run code from the interpreter directly instead of through a Python file.</p>&#13;
    <p class="normal">The default Python interpreter already features command history and depending on your install, basic autocompletion.</p>&#13;
    <p class="normal">But with alternative interpreters we can have many more features in our interpreter such as syntax highlighting, smart autocompletion which includes documentation, and more. </p>&#13;
    <p class="normal">The next chapter will show us several alternative interpreters and their advantages.</p>&#13;
    <h1 class="heading-1">Join our community on Discord</h1>&#13;
    <p class="normal">Join our community’s Discord space for discussions with the author and other readers: <a href="https://discord.gg/QMzJenHuJf"><span class="url">https://discord.gg/QMzJenHuJf</span></a></p>&#13;
    <p class="normal"><img src="Images/QR_Code156081100001293319171.png" alt="" width="177" height="177"/></p>&#13;
  </div>&#13;
</div></body></html>