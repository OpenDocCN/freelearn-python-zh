<html><head></head><body>
<div><h1 class="chapterNumber">4</h1>
<h1 class="chapterTitle" id="_idParaDest-142">Building a Social Website</h1>
<p class="normal">In the preceding chapter, you learned how to implement a tagging system and how to recommend similar posts. You implemented custom template tags and filters. You also learned how to create sitemaps and feeds for your site, and you built a full-text search engine using PostgreSQL.</p>
<p class="normal">In this chapter, you will learn how to develop user account functionalities to create a social website, including user registration, password management, profile editing, and authentication. We will implement social features on this site in the next few chapters, to let users share images and interact with each other. Users will be able to bookmark any image on the internet and share it with other users. They will also be able to see activity on the platform from the users they follow and like/unlike the images shared by them.</p>
<p class="normal">This chapter will cover the following topics:</p>
<ul>
<li class="bulletList">Creating a login view</li>
<li class="bulletList">Using the Django authentication framework</li>
<li class="bulletList">Creating templates for Django login, logout, password change, and password reset views</li>
<li class="bulletList">Creating user registration views</li>
<li class="bulletList">Extending the user model with a custom profile model</li>
<li class="bulletList">Configuring the project for media file uploads</li>
</ul>
<h1 class="heading-1" id="_idParaDest-143">Functional overview</h1>
<p class="normal"><em class="italic">Figure 4.1</em> shows a<a id="_idIndexMarker372"/> representation of the views, templates, and functionalities that will be built in this chapter:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_04_01.png"/></figure>
<p class="packt_figref">Figure 4.1: Diagram of functionalities built in Chapter 4</p>
<p class="normal">In this chapter, you will create a new project and use the login, logout, password change, and password recovery views provided by Django in the <code class="inlineCode">django.contrib.auth</code> package. You will create templates for the authentication views, and you will create a <code class="inlineCode">dashboard</code> view that users will have access to when they successfully authenticate. You will implement user registration with the <code class="inlineCode">register</code> view. Finally, you will extend the user model with a custom <code class="inlineCode">Profile</code> model and create the <code class="inlineCode">edit</code> view to allow users to edit their profile.</p>
<p class="normal">The source code for this chapter can be found at <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter04">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter04</a>.</p>
<p class="normal">All Python packages used in this chapter are included in the <code class="inlineCode">requirements.txt</code> file in the source code for the chapter. You can follow the instructions to install each Python package in the<a id="_idIndexMarker373"/> following sections, or you can install all requirements at once with the command <code class="inlineCode">python -m pip install -r requirements.txt</code>.</p>
<h1 class="heading-1" id="_idParaDest-144">Creating a social website project</h1>
<p class="normal">We are going to <a id="_idIndexMarker374"/>create a social application that will allow users to share images that they find on the internet. This project is relevant because it will help you understand how to build social capabilities into your site, as well as how to implement advanced functionalities with Django and JavaScript.</p>
<p class="normal">For our image-sharing website, we will need to build the following elements:</p>
<ul>
<li class="bulletList">An authentication system for users to register, log in, edit their profile, and change or reset their password</li>
<li class="bulletList">Social authentication to sign in with services such as Google</li>
<li class="bulletList">Functionality to display shared images and a system for users to share images from any website</li>
<li class="bulletList">An activity stream that allows users to see the content uploaded by the people that they follow</li>
<li class="bulletList">A follow system to allow users to follow each other on the website</li>
</ul>
<p class="normal">This chapter will address the first point on the list. The rest of the points will be covered in <em class="italic">Chapters</em> 5 to 7.</p>
<h2 class="heading-2" id="_idParaDest-145">Starting the social website project</h2>
<p class="normal">We will start by<a id="_idIndexMarker375"/> setting up the virtual environment for the project and creating the initial project structure.</p>
<p class="normal">Open the terminal and use the following commands to create a virtual environment for your project:</p>
<pre class="programlisting con"><code class="hljs-con">mkdir env
python -m venv env/bookmarks
</code></pre>
<p class="normal">If you are using Linux or macOS, run the following command to activate your virtual environment:</p>
<pre class="programlisting con"><code class="hljs-con">source env/bookmarks/bin/activate
</code></pre>
<p class="normal">If you are using Windows, use the following command instead:</p>
<pre class="programlisting con"><code class="hljs-con">.\env\bookmarks\Scripts\activate
</code></pre>
<p class="normal">The shell prompt will display your active virtual environment, as follows:</p>
<pre class="programlisting con"><code class="hljs-con">(bookmarks)laptop:~ zenx$
</code></pre>
<p class="normal">Install Django in your virtual environment with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install Django~=5.0.4
</code></pre>
<p class="normal">Run the following command to create a new project:</p>
<pre class="programlisting con"><code class="hljs-con">django-admin startproject bookmarks
</code></pre>
<p class="normal">The initial project structure has been created. Use the following commands to get into your project directory and create a new application named <code class="inlineCode">account</code>:</p>
<pre class="programlisting con"><code class="hljs-con">cd bookmarks/
django-admin startapp account
</code></pre>
<p class="normal">Remember that you <a id="_idIndexMarker376"/>should add the new application to your project by adding the applicationâ€™s name to the <code class="inlineCode">INSTALLED_APPS</code> setting in the <code class="inlineCode">settings.py</code> file.</p>
<p class="normal">Edit <code class="inlineCode">settings.py</code> and add the following line highlighted in bold to the <code class="inlineCode">INSTALLED_APPS</code> list before any of the other installed apps:</p>
<pre class="programlisting code"><code class="hljs-code">INSTALLED_APPS = [
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'account.apps.AccountConfig'</strong><strong class="hljs-slc">,</strong>
'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]
</code></pre>
<p class="normal">Django looks for templates in the application template directories by order of appearance in the <code class="inlineCode">INSTALLED_APPS</code> setting. The <code class="inlineCode">django.contrib.admin</code> app includes standard authentication templates, which we will override in the <code class="inlineCode">account</code> application. Usually, we place our own apps at the end of the list. In this case, we place the application first in the <code class="inlineCode">INSTALLED_APPS</code> setting to ensure that our custom authentication templates will be used, instead of the authentication templates contained in <code class="inlineCode">django.contrib.admin</code>.</p>
<p class="normal">Run the following command to sync the database with the models of the default applications included in the <code class="inlineCode">INSTALLED_APPS</code> setting:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py migrate
</code></pre>
<p class="normal">You will see that all the initial Django database migrations get applied. The database tables corresponding <a id="_idIndexMarker377"/>to the Django models of the installed applications have been created. Next, we will build an authentication system into our project using the Django authentication framework.</p>
<h1 class="heading-1" id="_idParaDest-146">Using the Django authentication framework</h1>
<p class="normal">Django comes with <a id="_idIndexMarker378"/>a built-in authentication framework that can handle user authentication, sessions, permissions, and user groups. The authentication system includes views for common user actions such as logging in, logging out, password change, and password reset.</p>
<p class="normal">The authentication framework is located at <code class="inlineCode">django.contrib.auth</code> and is used by other Django <code class="inlineCode">contrib</code> packages. Remember that we already used the authentication framework in <em class="chapterRef">Chapter 1</em>, <em class="italic">Building a Blog Application</em>, to create a superuser for the blog application to access the administration site.</p>
<p class="normal">When we create a new Django project using the <code class="inlineCode">startproject</code> command, the authentication framework is included in the default settings of our project. It consists of the <code class="inlineCode">django.contrib.auth</code> application and the following two middleware classes found in the <code class="inlineCode">MIDDLEWARE</code> setting of our project:</p>
<ul>
<li class="bulletList"><code class="inlineCode">AuthenticationMiddleware</code>: Associates users with requests using sessions</li>
<li class="bulletList"><code class="inlineCode">SessionMiddleware</code>: Handles the current session across requests</li>
</ul>
<p class="normal">Middleware is classes with methods that are globally executed during the request or response phase. You will use middleware classes on several occasions throughout this book, and you will learn how to create custom middleware in <em class="chapterRef">Chapter 17</em>, <em class="italic">Going Live</em>.</p>
<p class="normal">The authentication framework also includes the following models that are defined in <code class="inlineCode">django.contrib.auth.models</code>:</p>
<ul>
<li class="bulletList"><code class="inlineCode">User</code>: A user model with basic fields; the main fields of this model are <code class="inlineCode">username</code>, <code class="inlineCode">password</code>, <code class="inlineCode">email</code>, <code class="inlineCode">first_name</code>, <code class="inlineCode">last_name</code>, and <code class="inlineCode">is_active</code></li>
<li class="bulletList"><code class="inlineCode">Group</code>: A group model to categorize users</li>
<li class="bulletList"><code class="inlineCode">Permission</code>: Flags for users or groups to perform certain actions</li>
</ul>
<p class="normal">The framework <a id="_idIndexMarker379"/>also includes default authentication views and forms, which you will use later.</p>
<h2 class="heading-2" id="_idParaDest-147">Creating a login view</h2>
<p class="normal">We will start this <a id="_idIndexMarker380"/>section by using the Django authentication framework to allow users to log in to the website. We will create a view that will perform the following actions to log in a user:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">Present the user with a login form</li>
<li class="numberedList">Get the username and password provided by the user when they submit the form</li>
<li class="numberedList">Authenticate the user against the data stored in the database</li>
<li class="numberedList">Check whether the user is active</li>
<li class="numberedList">Log the user into the website and start an authenticated session</li>
</ol>
<p class="normal">We will start by creating the login form.</p>
<p class="normal">Create a new <code class="inlineCode">forms.py</code> file in the <code class="inlineCode">account</code> application directory and add the following lines to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django import forms
class LoginForm(forms.Form):
    username = forms.CharField()
    password = forms.CharField(widget=forms.PasswordInput)
</code></pre>
<p class="normal">This form will be used to authenticate users against the database. The <code class="inlineCode">PasswordInput</code> widget is used to render the <code class="inlineCode">password</code> HTML element. This will include <code class="inlineCode">type="password"</code> in the HTML so that the browser treats it as a password input.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">account</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.contrib.auth import authenticate, login
from django.http import HttpResponse
from django.shortcuts import render
from .forms import LoginForm
def user_login(request):
    if request.method == 'POST':
        form = LoginForm(request.POST)
        if form.is_valid():
            cd = form.cleaned_data
            user = authenticate(
                request,
                username=cd['username'],
                password=cd['password']
            )
            if user is not None:
                if user.is_active:
                    login(request, user)
                    return HttpResponse('Authenticated successfully')
                else:
                    return HttpResponse('Disabled account')
            else:
                return HttpResponse('Invalid login')
    else:
        form = LoginForm()
    return render(request, 'account/login.html', {'form': form})
</code></pre>
<p class="normal">This is what <a id="_idIndexMarker381"/>the basic login view does:</p>
<p class="normal">When the <code class="inlineCode">user_login</code> view is called with a <code class="inlineCode">GET</code> request, a new login form is instantiated with <code class="inlineCode">form = LoginForm()</code>. The form is then passed to the template.</p>
<p class="normal">When the user submits the form via <code class="inlineCode">POST</code>, the following actions are performed:</p>
<p class="normal">The form is instantiated with the submitted data with <code class="inlineCode">form = LoginForm(request.POST)</code>.</p>
<p class="normal">The form is validated with <code class="inlineCode">form.is_valid()</code>. If it is not valid, the form errors will be displayed later in the template (for example, if the user didnâ€™t fill in one of the fields).</p>
<p class="normal">If the submitted data is valid, the user gets authenticated against the database using the <code class="inlineCode">authenticate()</code> method. This method takes the <code class="inlineCode">request</code> object, the <code class="inlineCode">username</code>, and the <code class="inlineCode">password</code> parameters and returns the <code class="inlineCode">User</code> object if the user has been successfully authenticated, or <code class="inlineCode">None</code> otherwise. If the user has not been successfully authenticated, a raw <code class="inlineCode">HttpResponse</code> is returned with an <strong class="keyWord">Invalid login</strong> message.</p>
<p class="normal">If the user is successfully authenticated, the user status is checked by accessing the <code class="inlineCode">is_active</code> attribute. This is an attribute of Djangoâ€™s user model. If the user is not active, an <code class="inlineCode">HttpResponse</code> is returned with a <strong class="keyWord">Disabled account</strong> message.</p>
<p class="normal">If the user is active, the user is <a id="_idIndexMarker382"/>logged into the site. The user is set in the session by calling the <code class="inlineCode">login()</code> method. An <strong class="keyWord">Authenticated successfully</strong> message is returned.</p>
<div><p class="normal">Note the difference between <code class="inlineCode">authenticate()</code> and <code class="inlineCode">login()</code>: <code class="inlineCode">authenticate()</code> verifies the userâ€™s credentials and, upon validation, returns a <code class="inlineCode">User</code> object representing the authenticated user. In contrast, <code class="inlineCode">login()</code> sets the user in the current session by incorporating the authenticated <code class="inlineCode">User</code> object into the current session context.</p>
</div>
<p class="normal">Now, we will create a URL pattern for this view:</p>
<p class="normal">Create a new <code class="inlineCode">urls.py</code> file in the <code class="inlineCode">account</code> application directory and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.urls import path
from . import views
urlpatterns = [
    path('login/', views.user_login, name='login'),
]
</code></pre>
<p class="normal">Edit the main <code class="inlineCode">urls.py</code> file located in your <code class="inlineCode">bookmarks</code> project directory, import <code class="inlineCode">include</code>, and add the URL patterns of the <code class="inlineCode">account</code> application, as follows. The new code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django.contrib import admin
from django.urls import <strong class="hljs-slc">include, </strong>path
urlpatterns = [
    path('admin/', admin.site.urls),
    <strong class="hljs-slc">path(</strong><strong class="hljs-string-slc">'account/'</strong><strong class="hljs-slc">, include(</strong><strong class="hljs-string-slc">'account.urls'</strong><strong class="hljs-slc">)),</strong>
]
</code></pre>
<p class="normal">The login view can now be accessed with a URL.</p>
<p class="normal">Letâ€™s create a template for this view. Since there are no templates in the project yet, we will start by creating a base template that will be extended by the login template:</p>
<p class="normal">Create the following<a id="_idIndexMarker383"/> files and directories inside the <code class="inlineCode">account</code> application directory:</p>
<pre class="programlisting con"><code class="hljs-con">templates/
    account/
        login.html
    base.html
</code></pre>
<p class="normal">Edit the <code class="inlineCode">base.html</code> template and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% load static %}
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;{% block title %}{% endblock %}&lt;/title&gt;
&lt;link href="{% static "css/base.css" %}" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div id="header"&gt;
&lt;span class="logo"&gt;Bookmarks&lt;/span&gt;
&lt;/div&gt;
&lt;div id="content"&gt;
    {% block content %}
    {% endblock %}
  &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p class="normal">This will be the base template for the website. As you did in your previous project, include the CSS styles in the main template. You can find these static files in the code that comes with this chapter. Copy the <code class="inlineCode">static/</code> directory of the <code class="inlineCode">account</code> application from the chapterâ€™s source code to the same location in your project so that you can use the static files. You can find the directoryâ€™s contents at <a href="https://github.com/PacktPublishing/Django-5-by-Example/tree/master/Chapter04/bookmarks/account/static">https://github.com/PacktPublishing/Django-5-by-Example/tree/master/Chapter04/bookmarks/account/static</a>.</p>
<p class="normal">The base template defines a <code class="inlineCode">title</code> block and a <code class="inlineCode">content</code> block that can be filled with content by the templates that extend from it.</p>
<p class="normal">Letâ€™s fill in the template for your login form.</p>
<p class="normal">Open<a id="_idIndexMarker384"/> the <code class="inlineCode">account/login.html</code> template and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Log-in{% endblock %}
{% block content %}
  &lt;h1&gt;Log-in&lt;/h1&gt;
&lt;p&gt;Please, use the following form to log-in:&lt;/p&gt;
&lt;form method="post"&gt;
    {{ form.as_p }}
    {% csrf_token %}
    &lt;p&gt;&lt;input type="submit" value="Log in"&gt;&lt;/p&gt;
&lt;/form&gt;
{% endblock %}
</code></pre>
<p class="normal">This template includes the form that is instantiated in the view. Since your form will be submitted via <code class="inlineCode">POST</code>, you will <a id="_idIndexMarker385"/>include the <code class="inlineCode">{% csrf_token %}</code> template tag for <strong class="keyWord">cross-site request forgery</strong> (<strong class="keyWord">CSRF</strong>) protection. You learned about CSRF protection in <em class="chapterRef">Chapter 2</em>, <em class="italic">Enhancing Your Blog with Advanced Features</em>.</p>
<p class="normal">There are no users in the database yet. You will need to create a superuser first to access the administration site to manage other users.</p>
<p class="normal">Execute the following command in the shell prompt:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py createsuperuser
</code></pre>
<p class="normal">You will see the following output. Enter your desired username, email, and password, as follows:</p>
<pre class="programlisting con"><code class="hljs-con">Username (leave blank to use 'admin'): admin
Email address: admin@admin.com
Password: ********
Password (again): ********
</code></pre>
<p class="normal">Then, you will see the following success message:</p>
<pre class="programlisting con"><code class="hljs-con">Superuser created successfully.
</code></pre>
<p class="normal">Run the development server using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/admin/</code> in your browser. Access the administration site using the credentials of the user you just created. You will see the Django administration site, including <a id="_idIndexMarker386"/>the <code class="inlineCode">User</code> and <code class="inlineCode">Group</code> models of the Django authentication framework.</p>
<p class="normal">It will look as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_04_02.png"/></figure>
<p class="packt_figref">Figure 4.2: The Django administration site index page including Users and Groups</p>
<p class="normal">In the <strong class="screenText">Users</strong> row, click on the <strong class="screenText">Add</strong> link.</p>
<p class="normal">Create a new user using the administration site as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_04_03.png"/></figure>
<p class="packt_figref">Figure 4.3: The Add user form on the Django administration site</p>
<p class="normal">Enter the user <a id="_idIndexMarker387"/>details and click on the <strong class="screenText">SAVE</strong> button to save the new user in the database.</p>
<p class="normal">Then, in <strong class="screenText">Personal info</strong>, fill in the <strong class="screenText">First name</strong>, <strong class="screenText">Last name</strong>, and <strong class="screenText">Email address</strong> fields as follows, and then click on the <strong class="screenText">SAVE</strong> button to save the changes:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_04_04.png"/></figure>
<p class="packt_figref">Figure 4.4: The user editing form on the Django administration site</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/account/login/</code> in your browser. You should see the rendered template, including the login form:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" src="img/B21088_04_05.png"/></figure>
<p class="packt_figref">Figure 4.5: The user Log-in page</p>
<p class="normal">Enter invalid <a id="_idIndexMarker388"/>credentials and submit the form. You should get the following <strong class="screenText">Invalid login</strong> response:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_04_06.png"/></figure>
<p class="packt_figref">Figure 4.6: The invalid login plain text response</p>
<p class="normal">Enter valid credentials; you will get the following <strong class="screenText">Authenticated successfully</strong> response:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_04_07.png"/></figure>
<p class="packt_figref">Figure 4.7: The successful authentication plain text response</p>
<p class="normal">Now, you have learned how to authenticate users and create your own authentication view. You can<a id="_idIndexMarker389"/> build your own auth views, but Django ships with ready-to-use authentication views that you can leverage.</p>
<h2 class="heading-2" id="_idParaDest-148">Using Djangoâ€™s built-in authentication views</h2>
<p class="normal">Django includes<a id="_idIndexMarker390"/> several forms and views in the authentication framework that you can use right away. The login view we have created is a good exercise to understand the process of user authentication in Django. However, you can use the default Django authentication views in most cases.</p>
<p class="normal">Django provides the following class-based views to deal with authentication. All of them are located in <code class="inlineCode">django.contrib.auth.views</code>:</p>
<ul>
<li class="bulletList"><code class="inlineCode">LoginView</code>: Handles a login form and logs in a user</li>
<li class="bulletList"><code class="inlineCode">LogoutView</code>: Logs out a user</li>
</ul>
<p class="normal">Django provides the following views to handle password changes:</p>
<ul>
<li class="bulletList"><code class="inlineCode">PasswordChangeView</code>: Handles a form to change the userâ€™s password</li>
<li class="bulletList"><code class="inlineCode">PasswordChangeDoneView</code>: The success view that the user is redirected to after a successful password change</li>
</ul>
<p class="normal">Django also includes the following views to allow users to reset their password:</p>
<ul>
<li class="bulletList"><code class="inlineCode">PasswordResetView</code>: Allows users to reset their password. It generates a one-time-use link with a token and sends it to a userâ€™s email account</li>
<li class="bulletList"><code class="inlineCode">PasswordResetDoneView</code>: Tells users that an emailâ€”including a link to reset their passwordâ€”has been sent to them</li>
<li class="bulletList"><code class="inlineCode">PasswordResetConfirmView</code>: Allows users to set a new password</li>
<li class="bulletList"><code class="inlineCode">PasswordResetCompleteView</code>: The success view that the user is redirected to after successfully resetting their password</li>
</ul>
<p class="normal">These views can save you a lot of time when building any web application with user accounts. The views use default values that can be overridden, such as the location of the template to be rendered, or the form to be used by the view.</p>
<p class="normal">You can get more<a id="_idIndexMarker391"/> information about the built-in authentication views at <a href="https://docs.djangoproject.com/en/5.0/topics/auth/default/#all-authentication-views">https://docs.djangoproject.com/en/5.0/topics/auth/default/#all-authentication-views</a>.</p>
<h2 class="heading-2" id="_idParaDest-149">Login and logout views</h2>
<p class="normal">To learn how to<a id="_idIndexMarker392"/> use Djangoâ€™s authentication views, we will substitute our custom login view with Djangoâ€™s built-in equivalent and also integrate a logout view.</p>
<p class="normal">Edit the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">account</code> application and add the code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.contrib.auth </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> views </strong><strong class="hljs-keyword-slc">as</strong><strong class="hljs-slc"> auth_views</strong>
from django.urls import path
from . import views
urlpatterns = [
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># previous login url</strong>
<strong class="hljs-comment-slc">#</strong> path('login/', views.user_login, name='login'),
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># login / logout urls</strong>
<strong class="hljs-slc">    path(</strong><strong class="hljs-string-slc">'login/'</strong><strong class="hljs-slc">, auth_views.LoginView.as_view(), name=</strong><strong class="hljs-string-slc">'login'</strong><strong class="hljs-slc">),</strong>
<strong class="hljs-slc">    path(</strong><strong class="hljs-string-slc">'logout/'</strong><strong class="hljs-slc">, auth_views.LogoutView.as_view(), name=</strong><strong class="hljs-string-slc">'logout'</strong><strong class="hljs-slc">),</strong>
]
</code></pre>
<p class="normal">In the preceding code, we have commented out the URL pattern for the <code class="inlineCode">user_login</code> view that we created previously. Weâ€™ll now use the <code class="inlineCode">LoginView</code> view of Djangoâ€™s authentication framework. We have also added a URL pattern for the <code class="inlineCode">LogoutView</code> view.</p>
<p class="normal">Create a new directory inside the <code class="inlineCode">templates/</code> directory of the <code class="inlineCode">account</code> application and name it <code class="inlineCode">registration</code>. This is the default path where the Django authentication views expect your authentication templates to be.</p>
<p class="normal">The <code class="inlineCode">django.contrib.admin</code> module includes authentication templates that are used for the administration site, like the login template. By placing the <code class="inlineCode">account</code> application at the top of the <code class="inlineCode">INSTALLED_APPS</code> setting when configuring the project, we ensured that Django would use our authentication templates instead of the ones defined in any other application.</p>
<p class="normal">Create a new file inside the <code class="inlineCode">templates/registration/</code> directory, name it <code class="inlineCode">login.html</code>, and add the <a id="_idIndexMarker393"/>following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Log-in{% endblock %}
{% block content %}
  &lt;h1&gt;Log-in&lt;/h1&gt;
  {% if form.errors %}
    &lt;p&gt;
      Your username and password didn't match.
      Please try again.
    &lt;/p&gt;
  {% else %}
    &lt;p&gt;Please, use the following form to log-in:&lt;/p&gt;
  {% endif %}
  &lt;div class="login-form"&gt;
&lt;form action="{% url 'login' %}" method="post"&gt;
      {{ form.as_p }}
      {% csrf_token %}
      &lt;input type="hidden" name="next" value="{{ next }}" /&gt;
&lt;p&gt;&lt;input type="submit" value="Log-in"&gt;&lt;/p&gt;
&lt;/form&gt;
&lt;/div&gt;
{% endblock %}
</code></pre>
<p class="normal">This login template is quite similar to the one we created before. Django uses the <code class="inlineCode">AuthenticationForm</code> form located at <code class="inlineCode">django.contrib.auth.forms</code> by default. This form tries to authenticate the user and raises a validation error if the login is unsuccessful. We use <code class="inlineCode">{% if form.errors %}</code> in the template to check whether the credentials provided are wrong.</p>
<p class="normal">We have added a hidden HTML <code class="inlineCode">&lt;input&gt;</code> element to submit the value of a variable called <code class="inlineCode">next</code>. This variable is provided to the login view if you pass a parameter named <code class="inlineCode">next</code> to the request, for example, by accessing <code class="inlineCode">http://127.0.0.1:8000/account/login/?next=/account/</code>.</p>
<p class="normal">The <code class="inlineCode">next</code> parameter has to be a URL. If this parameter is given, the Django login view will redirect the user to the given URL after a successful login.</p>
<p class="normal">Now, create a <code class="inlineCode">logged_out.html</code> template inside the <code class="inlineCode">templates/registration/</code> directory and make it look like this:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Logged out{% endblock %}
{% block content %}
  &lt;h1&gt;Logged out&lt;/h1&gt;
&lt;p&gt;
    You have been successfully logged out.
    You can &lt;a href="{% url "login" %}"&gt;log-in again&lt;/a&gt;.
  &lt;/p&gt;
{% endblock %}
</code></pre>
<p class="normal">This is the template <a id="_idIndexMarker394"/>that Django will display after the user logs out.</p>
<p class="normal">We have added the URL patterns and templates for the login and logout views. Users can now log in and out using Djangoâ€™s authentication views.</p>
<p class="normal">Now, we will create a new view to display a dashboard when users log in to their accounts.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">account</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.contrib.auth.decorators import login_required
@login_required
def dashboard(request):
    return render(
 request,
 'account/dashboard.html',
 {'section': 'dashboard'}
 )
</code></pre>
<p class="normal">We have created the <code class="inlineCode">dashboard</code> view, and we have applied to it the <code class="inlineCode">login_required</code> decorator of the authentication framework. The <code class="inlineCode">login_required</code> decorator checks whether the current user is authenticated.</p>
<p class="normal">If the user is authenticated, it executes the decorated view; if the user is not authenticated, it redirects the user to the login URL, with the originally requested URL as a <code class="inlineCode">GET</code> parameter named <code class="inlineCode">next</code>.</p>
<p class="normal">By doing this, the login view redirects users to the URL that they were trying to access after they successfully logged in. Remember that we added a hidden <code class="inlineCode">&lt;input&gt;</code> HTML element named <code class="inlineCode">next</code> in the login template for this purpose.</p>
<p class="normal">We have also defined a <code class="inlineCode">section</code> variable. We will use this variable to highlight the current section in the main menu of the site.</p>
<p class="normal">Next, we need to create a template for the dashboard view.</p>
<p class="normal">Create a new file <a id="_idIndexMarker395"/>inside the <code class="inlineCode">templates/account/</code> directory and name it <code class="inlineCode">dashboard.html</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
  &lt;h1&gt;Dashboard&lt;/h1&gt;
&lt;p&gt;Welcome to your dashboard.&lt;/p&gt;
{% endblock %}
</code></pre>
<p class="normal">Edit the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">account</code> application and add the following URL pattern for the view. The new code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    # previous login url
# path('login/', views.user_login, name='login'),
# login / logout urls
    path('login/', auth_views.LoginView.as_view(), name='login'),
    path('logout/', auth_views.LogoutView.as_view(), name='logout'),
<strong class="hljs-slc">    path(</strong><strong class="hljs-string-slc">''</strong><strong class="hljs-slc">, views.dashboard, name=</strong><strong class="hljs-string-slc">'dashboard'</strong><strong class="hljs-slc">),</strong>
]
</code></pre>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of the project and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">LOGIN_REDIRECT_URL = 'dashboard'
LOGIN_URL = 'login'
LOGOUT_URL = 'logout'
</code></pre>
<p class="normal">We have defined the following settings:</p>
<ul>
<li class="bulletList"><code class="inlineCode">LOGIN_REDIRECT_URL</code>: Tells Django which URL to redirect the user to after a successful login if no <code class="inlineCode">next</code> parameter is present in the request</li>
<li class="bulletList"><code class="inlineCode">LOGIN_URL</code>: The URL to redirect the user to log in (for example, views using the <code class="inlineCode">login_required</code> decorator)</li>
<li class="bulletList"><code class="inlineCode">LOGOUT_URL</code>: The URL to redirect the user to log out</li>
</ul>
<p class="normal">We have used the names of the URLs that we previously defined with the <code class="inlineCode">name</code> attribute of the <code class="inlineCode">path()</code> function in the URL patterns. Hardcoded URLs instead of URL names can also be used for these settings.</p>
<p class="normal">Letâ€™s summarize what we have done so far:</p>
<ul>
<li class="bulletList">We have added the built-in Django authentication login and logout views to the project.</li>
<li class="bulletList">We have created custom templates for both views and defined a simple dashboard view to redirect users after they log in.</li>
<li class="bulletList">Finally, we have added settings for Django to use these URLs by default.</li>
</ul>
<p class="normal">Now, we will add a<a id="_idIndexMarker396"/> link to the login URL and a button to log out to the base template. In order to do this, we have to determine whether the current user is logged in or not to display the appropriate action for each case. The current user is set in the <code class="inlineCode">HttpRequest</code> object by the authentication middleware. You can access it with <code class="inlineCode">request.user</code>. The <code class="inlineCode">request</code> object contains a <code class="inlineCode">User</code> object even if the user is not authenticated. A non-authenticated user is set in the request as an instance of <code class="inlineCode">AnonymousUser</code>. The best way to check if the current user is authenticated is by accessing the read-only attribute, <code class="inlineCode">is_authenticated</code>.</p>
<p class="normal">Edit the <code class="inlineCode">templates/base.html</code> template by adding the following lines highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">{% load static %}
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;{% block title %}{% endblock %}&lt;/title&gt;
&lt;link href="{% static "css/base.css" %}" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div id="header"&gt;
&lt;span class="logo"&gt;Bookmarks&lt;/span&gt;
<strong class="hljs-slc">    {% if request.user.is_authenticated %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">ul</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"menu"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">li</strong><strong class="hljs-tag-slc"> {% </strong><strong class="hljs-attr-slc">if</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">section</strong><strong class="hljs-tag-slc"> == </strong><strong class="hljs-string-slc">"dashboard"</strong><strong class="hljs-tag-slc"> %}</strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"selected"</strong><strong class="hljs-tag-slc">{% </strong><strong class="hljs-attr-slc">endif</strong><strong class="hljs-tag-slc"> %}&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">href</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"{% url "</strong><strong class="hljs-attr-slc">dashboard</strong><strong class="hljs-tag-slc">" %}"&gt;</strong><strong class="hljs-slc">My dashboard</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">li</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">li</strong><strong class="hljs-tag-slc"> {% </strong><strong class="hljs-attr-slc">if</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">section</strong><strong class="hljs-tag-slc"> == </strong><strong class="hljs-string-slc">"images"</strong><strong class="hljs-tag-slc"> %}</strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"selected"</strong><strong class="hljs-tag-slc">{% </strong><strong class="hljs-attr-slc">endif</strong><strong class="hljs-tag-slc"> %}&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">href</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"#"</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">Images</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">li</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">li</strong><strong class="hljs-tag-slc"> {% </strong><strong class="hljs-attr-slc">if</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">section</strong><strong class="hljs-tag-slc"> == </strong><strong class="hljs-string-slc">"people"</strong><strong class="hljs-tag-slc"> %}</strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"selected"</strong><strong class="hljs-tag-slc">{% </strong><strong class="hljs-attr-slc">endif</strong><strong class="hljs-tag-slc"> %}&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">href</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"#"</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">People</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">li</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">ul</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">    {% endif %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">span</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"user"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">      {% if request.user.is_authenticated %}</strong>
<strong class="hljs-slc">        Hello {{ request.user.first_name|default:request.user.username }},</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">form</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">action</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"{% url "</strong><strong class="hljs-attr-slc">logout</strong><strong class="hljs-tag-slc">" %}" </strong><strong class="hljs-attr-slc">method</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"post"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">button</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">type</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"submit"</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">Logout</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">button</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">          {% csrf_token %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">form</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">      {% else %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">href</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"{% url "</strong><strong class="hljs-attr-slc">login</strong><strong class="hljs-tag-slc">" %}"&gt;</strong><strong class="hljs-slc">Log-in</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">      {% endif %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">span</strong><strong class="hljs-tag-slc">&gt;</strong>
&lt;/div&gt;
&lt;div id="content"&gt;
    {% block content %}
    {% endblock %}
  &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p class="normal">The siteâ€™s menu is only displayed to authenticated users. The <code class="inlineCode">section</code> variable is checked to add a <code class="inlineCode">selected</code> class attribute to the menu <code class="inlineCode">&lt;li&gt;</code> list item of the current section. By doing so, the menu item that corresponds to the current section will be highlighted using CSS. The userâ€™s first name and a button to log out are displayed if the user is authenticated; a link to log in is displayed otherwise. If the userâ€™s name is empty, the username is displayed instead by using <code class="inlineCode">request.user.first_name|default:request.user.username</code>. Note that for the logout action, we use a form with the method <code class="inlineCode">POST</code> and a button to submit the form. This is because the <code class="inlineCode">LogoutView</code> requires <code class="inlineCode">POST</code> requests.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/account/login/</code> in your browser. You should see the <strong class="screenText">Log-in</strong> page. Enter a<a id="_idIndexMarker397"/> valid username and password and click on the <strong class="screenText">Log-in</strong> button. You should see the following screen:</p>
<figure class="mediaobject"><img alt="Graphical user interface  Description automatically generated with medium confidence" src="img/B21088_04_08.png"/></figure>
<p class="packt_figref">Figure 4.8: The Dashboard page</p>
<p class="normal">The <strong class="screenText">My dashboard</strong> menu item is highlighted with CSS because it has a <code class="inlineCode">selected</code> class. Since the user is authenticated, the first name of the user is displayed on the right side of the header. Click on the <strong class="screenText">Logout</strong> button. You should see the following page:</p>
<figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="img/B21088_04_09.png"/></figure>
<p class="packt_figref">Figure 4.9: The Logged out page</p>
<p class="normal">On this page, you can see that the user is logged out, and therefore, the menu of the website is not<a id="_idIndexMarker398"/> displayed. The link displayed on the right side of the header is now <strong class="screenText">Log-in</strong>.</p>
<div><p class="normal">If you see the <strong class="screenText">Logged out</strong> page of the Django administration site instead of your own <strong class="screenText">Logged out</strong> page, check the <code class="inlineCode">INSTALLED_APPS</code> setting of your project and make sure that <code class="inlineCode">django.contrib.admin</code> comes after the <code class="inlineCode">account</code> application. Both applications contain logged-out templates located in the same relative path. The Django template loader will go through the different applications in the <code class="inlineCode">INSTALLED_APPS</code> list and use the first template it finds.</p>
</div>
<h2 class="heading-2" id="_idParaDest-150">Change password views</h2>
<p class="normal">We need users to<a id="_idIndexMarker399"/> be able to change their password after they log in to the site. We will integrate the Django authentication views to change passwords.</p>
<p class="normal">Open the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">account</code> application and add the following URL patterns highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    # previous login url
# path('login/', views.user_login, name='login'),
# login / logout urls
    path('login/', auth_views.LoginView.as_view(), name='login'),
    path('logout/', auth_views.LogoutView.as_view(), name='logout'),
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># change password urls</strong>
<strong class="hljs-slc">    path(</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'password-change/'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        auth_views.PasswordChangeView.as_view(),</strong>
<strong class="hljs-slc">        name=</strong><strong class="hljs-string-slc">'password_change'</strong>
<strong class="hljs-slc">    ),</strong>
<strong class="hljs-slc">    path(</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'password-change/done/'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        auth_views.PasswordChangeDoneView.as_view(),</strong>
<strong class="hljs-slc">        name=</strong><strong class="hljs-string-slc">'password_change_done'</strong>
<strong class="hljs-slc">    ),</strong>
    path('', views.dashboard, name='dashboard'),
]
</code></pre>
<p class="normal">The <code class="inlineCode">PasswordChangeView</code> view will handle the form to change the password, and the <code class="inlineCode">PasswordChangeDoneView</code> view will display a success message after the user has successfully<a id="_idIndexMarker400"/> changed their password. Letâ€™s create a template for each view.</p>
<p class="normal">Add a new file inside the <code class="inlineCode">templates/registration/</code> directory of the <code class="inlineCode">account</code> application and name it <code class="inlineCode">password_change_form.html</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Change your password{% endblock %}
{% block content %}
  &lt;h1&gt;Change your password&lt;/h1&gt;
&lt;p&gt;Use the form below to change your password.&lt;/p&gt;
&lt;form method="post"&gt;
    {{ form.as_p }}
    &lt;p&gt;&lt;input type="submit" value="Change"&gt;&lt;/p&gt;
    {% csrf_token %}
  &lt;/form&gt;
{% endblock %}
</code></pre>
<p class="normal">The <code class="inlineCode">password_change_form.html</code> template includes the form to change the password.</p>
<p class="normal">Now, create another file in the same directory and name it <code class="inlineCode">password_change_done.html</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Password changed{% endblock %}
{% block content %}
  &lt;h1&gt;Password changed&lt;/h1&gt;
&lt;p&gt;Your password has been successfully changed.&lt;/p&gt;
{% endblock %}
</code></pre>
<p class="normal">The <code class="inlineCode">password_change_done.html</code> template only contains the success message to be displayed <a id="_idIndexMarker401"/>when the user has successfully changed their password.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/account/password-change/</code> in your browser. If you are not logged in, the browser will redirect you to the <strong class="screenText">Log-in</strong> page. After you are successfully authenticated, you will see the following change password page:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="img/B21088_04_10.png"/></figure>
<p class="packt_figref">Figure 4.10: The change password form</p>
<p class="normal">Fill in the form <a id="_idIndexMarker402"/>with your current password and your new password, and then click on the <strong class="screenText">CHANGE</strong> button. You will see the following success page:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" src="img/B21088_04_11.png"/></figure>
<p class="packt_figref">Figure 4.11: The successful change password page</p>
<p class="normal">Log out and log in <a id="_idIndexMarker403"/>again using your new password to verify that everything works as expected.</p>
<h2 class="heading-2" id="_idParaDest-151">Reset password views</h2>
<p class="normal">If users forget<a id="_idIndexMarker404"/> their password, they should be able to recover their account. We will implement a password reset feature. This will enable users to regain access to their account by receiving a password reset email that contains a secure link, generated with a unique token, allowing them to create a new password.</p>
<p class="normal">Edit the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">account</code> application and add the following URL patterns highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    # previous login url
# path('login/', views.user_login, name='login'),
# login / logout urls
    path('login/', auth_views.LoginView.as_view(), name='login'),
    path('logout/', auth_views.LogoutView.as_view(), name='logout'),
  
    # change password urls
    path(
        'password-change/',
        auth_views.PasswordChangeView.as_view(),
        name='password_change'
 ),
    path(
        'password-change/done/',
        auth_views.PasswordChangeDoneView.as_view(),
        name='password_change_done'
 ),
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># reset password urls</strong>
<strong class="hljs-slc">    path(</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'password-reset/'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        auth_views.PasswordResetView.as_view(),</strong>
<strong class="hljs-slc">        name=</strong><strong class="hljs-string-slc">'password_reset'</strong>
<strong class="hljs-slc">    ),</strong>
<strong class="hljs-slc">    path(</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'password-reset/done/'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        auth_views.PasswordResetDoneView.as_view(),</strong>
<strong class="hljs-slc">        name=</strong><strong class="hljs-string-slc">'password_reset_done'</strong>
<strong class="hljs-slc">    ),</strong>
<strong class="hljs-slc">    path(</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'</strong><strong class="hljs-string-slc">password-reset/&lt;uidb64&gt;/&lt;token&gt;/'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        auth_views.PasswordResetConfirmView.as_view(),</strong>
<strong class="hljs-slc">        name=</strong><strong class="hljs-string-slc">'password_reset_confirm'</strong>
<strong class="hljs-slc">    ),</strong>
<strong class="hljs-slc">    path(</strong><strong class="hljs-string-slc">'password-reset/complete/'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        auth_views.PasswordResetCompleteView.as_view(),</strong>
<strong class="hljs-slc">        name=</strong><strong class="hljs-string-slc">'password_reset_complete'</strong>
<strong class="hljs-slc">    ),</strong>
    path('', views.dashboard, name='dashboard'),
]
</code></pre>
<p class="normal">Add a new <a id="_idIndexMarker405"/>file to the <code class="inlineCode">templates/registration/</code> directory of the <code class="inlineCode">account</code> application and name it <code class="inlineCode">password_reset_form.html</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Reset your password{% endblock %}
{% block content %}
  &lt;h1&gt;Forgotten your password?&lt;/h1&gt;
&lt;p&gt;Enter your e-mail address to obtain a new password.&lt;/p&gt;
&lt;form method="post"&gt;
    {{ form.as_p }}
    &lt;p&gt;&lt;input type="submit" value="Send e-mail"&gt;&lt;/p&gt;
    {% csrf_token %}
  &lt;/form&gt;
{% endblock %}
</code></pre>
<p class="normal">Now, create another file in the same directory and name it <code class="inlineCode">password_reset_email.html</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">Someone asked for password reset for email {{ email }}. Follow the link below:
{{ protocol }}://{{ domain }}{% url "password_reset_confirm" uidb64=uid token=token %}
Your username, in case you've forgotten: {{ user.get_username }}
</code></pre>
<p class="normal">The <code class="inlineCode">password_reset_email.html</code> template will be used to render the email sent to users to reset their password. It includes a reset token that is generated by the view.</p>
<p class="normal">Create another file<a id="_idIndexMarker406"/> in the same directory and name it <code class="inlineCode">password_reset_done.html</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Reset your password{% endblock %}
{% block content %}
  &lt;h1&gt;Reset your password&lt;/h1&gt;
&lt;p&gt;We've emailed you instructions for setting your password.&lt;/p&gt;
&lt;p&gt;If you don't receive an email, please make sure you've entered the address you registered with.&lt;/p&gt;
{% endblock %}
</code></pre>
<p class="normal">Create another template in the same directory and name it <code class="inlineCode">password_reset_confirm.html</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Reset your password{% endblock %}
{% block content %}
  &lt;h1&gt;Reset your password&lt;/h1&gt;
  {% if validlink %}
    &lt;p&gt;Please enter your new password twice:&lt;/p&gt;
&lt;form method="post"&gt;
      {{ form.as_p }}
      {% csrf_token %}
      &lt;p&gt;&lt;input type="submit" value="Change my password" /&gt;&lt;/p&gt;
&lt;/form&gt;
  {% else %}
    &lt;p&gt;The password reset link was invalid, possibly because it has already been used. Please request a new password reset.&lt;/p&gt;
  {% endif %}
{% endblock %}
</code></pre>
<p class="normal">In this template, we confirm whether the link to reset the password is valid by checking the <code class="inlineCode">validlink</code> variable. The view <code class="inlineCode">PasswordResetConfirmView</code> checks the validity of the token provided in the URL and passes the <code class="inlineCode">validlink</code> variable to the template. If the link is valid, the user password reset form is displayed. Users can only set a new password if they have a valid reset password link.</p>
<p class="normal">Create another<a id="_idIndexMarker407"/> template and name it <code class="inlineCode">password_reset_complete.html</code>. Enter the following code into it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Password reset{% endblock %}
{% block content %}
  &lt;h1&gt;Password set&lt;/h1&gt;
&lt;p&gt;Your password has been set. You can &lt;a href="{% url "login" %}"&gt;log in now&lt;/a&gt;&lt;/p&gt;
{% endblock %}
</code></pre>
<p class="normal">Finally, edit the <code class="inlineCode">registration/login.html</code> template of the <code class="inlineCode">account</code> application, and add the following lines highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Log-in{% endblock %}
{% block content %}
  &lt;h1&gt;Log-in&lt;/h1&gt;
  {% if form.errors %}
    &lt;p&gt;
      Your username and password didn't match.
      Please try again.
    &lt;/p&gt;
  {% else %}
    &lt;p&gt;Please, use the following form to log-in:&lt;/p&gt;
  {% endif %}
  &lt;div class="login-form"&gt;
&lt;form action="{% url 'login' %}" method="post"&gt;
      {{ form.as_p }}
      {% csrf_token %}
      &lt;input type="hidden" name="next" value="{{ next }}" /&gt;
&lt;p&gt;&lt;input type="submit" value="Log-in"&gt;&lt;/p&gt;
&lt;/form&gt;
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">p</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">href</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"{% url "</strong><strong class="hljs-attr-slc">password_reset</strong><strong class="hljs-tag-slc">" %}"&gt;</strong>
<strong class="hljs-slc">        Forgotten your password?</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">p</strong><strong class="hljs-tag-slc">&gt;</strong>
&lt;/div&gt;
{% endblock %}
</code></pre>
<p class="normal">Now, open <code class="inlineCode">http://127.0.0.1:8000/account/login/</code> in your browser. The <strong class="screenText">Log-in </strong>page should now<a id="_idIndexMarker408"/> include a link to the reset password page, as follows:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="img/B21088_04_12.png"/></figure>
<p class="packt_figref">Figure 4.12: The Log-in page, including a link to the reset password page</p>
<p class="normal">Click on the <strong class="screenText">Forgotten your password?</strong> link. You should see the following page:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" src="img/B21088_04_13.png"/></figure>
<p class="packt_figref">Figure 4.13: The restore password form</p>
<p class="normal">At this point, we <a id="_idIndexMarker409"/>need to add <a id="_idIndexMarker410"/>a <strong class="keyWord">Simple Mail Transfer Protocol</strong> (<strong class="keyWord">SMTP</strong>) configuration to the <code class="inlineCode">settings.py</code> file of your project so that Django is able to send emails. You learned how to add email settings to your project in <em class="chapterRef">Chapter 2</em>, <em class="italic">Enhancing Your Blog with Advanced Features</em>. However, during development, you can configure Django to write emails to the standard output instead of sending them through an SMTP server. Django provides an email backend to write emails to the console.</p>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of your project, and add the following line to it:</p>
<pre class="programlisting code"><code class="hljs-code">EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'
</code></pre>
<p class="normal">The <code class="inlineCode">EMAIL_BACKEND</code> setting indicates the class that will be used to send emails.</p>
<p class="normal">Return to your browser, enter the email address of an existing user, and click on the <strong class="screenText">SEND E-MAIL</strong> button. You should see the following page:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" src="img/B21088_04_14.png"/></figure>
<p class="packt_figref">Figure 4.14: The reset password email sent page</p>
<p class="normal">Take a look at the<a id="_idIndexMarker411"/> shell prompt, where you are running the development server. You will see the generated email, as follows:</p>
<pre class="programlisting con"><code class="hljs-con">Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Subject: Password reset on 127.0.0.1:8000
From: webmaster@localhost
To: test@gmail.com
Date: Mon, 10 Jan 2024 19:05:18 -0000
Message-ID: &lt;162896791878.58862.14771487060402279558@MBP-amele.local&gt;
Someone asked for password reset for email test@gmail.com. Follow the link below:
http://127.0.0.1:8000/account/password-reset/MQ/ardx0u-b4973cfa2c70d652a190e79054bc479a/
Your username, in case you've forgotten: test
</code></pre>
<p class="normal">The email is rendered using the <code class="inlineCode">password_reset_email.html</code> template that you created earlier. The URL to reset the password includes a token that was generated dynamically by Django.</p>
<p class="normal">Copy the URL from the email, which should look similar to <code class="inlineCode">http://127.0.0.1:8000/account/password-reset/MQ/ardx0u-b4973cfa2c70d652a190e79054bc479a/</code>, and open it in your browser. You should see the following page:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, chat or text message, email  Description automatically generated" src="img/B21088_04_15.png"/></figure>
<p class="packt_figref">Figure 4.15: The reset password form</p>
<p class="normal">The page to set a<a id="_idIndexMarker412"/> new password uses the <code class="inlineCode">password_reset_confirm.html</code> template. Fill in a new password and click on the <strong class="screenText">CHANGE MY PASSWORD</strong> button. </p>
<p class="normal">Django will create a new hashed password and save it in the database. You will see the following success page:</p>
<figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="img/B21088_04_16.png"/></figure>
<p class="packt_figref">Figure 4.16: The successful password reset page</p>
<p class="normal">Now, you can log back into the user account using the new password.</p>
<p class="normal">Each token to set a new password can be used only once. If you open the link that you received again, you will get a message stating that the token is invalid.</p>
<p class="normal">We have now integrated the views of the Django authentication framework into the project. These views are suitable for most cases. However, you can create your own views if you need different behavior.</p>
<p class="normal">Django provides URL patterns for the authentication views that are equivalent to the ones we just <a id="_idIndexMarker413"/>created. We will replace the authentication URL patterns with the ones provided by Django.</p>
<p class="normal">Comment out the authentication URL patterns that you added to the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">account</code> application and include <code class="inlineCode">django.contrib.auth.urls</code> instead, as follows. The new code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django.urls import <strong class="hljs-slc">include,</strong> path
from django.contrib.auth import views as auth_views
from . import views
urlpatterns = [
    # previous login view
# path('login/', views.user_login, name='login'),
<strong class="hljs-comment-slc">#</strong> path('login/', auth_views.LoginView.as_view(), name='login'),
<strong class="hljs-comment-slc">#</strong> path('logout/', auth_views.LogoutView.as_view(), name='logout'),
# change password urls
<strong class="hljs-comment-slc">#</strong> path(
<strong class="hljs-comment-slc">#</strong>     'password-change/',
<strong class="hljs-comment-slc">#</strong>     auth_views.PasswordChangeView.as_view(),
<strong class="hljs-comment-slc">#</strong>     name='password_change'
<strong class="hljs-comment-slc">#</strong> ),
<strong class="hljs-comment-slc">#</strong> path(
<strong class="hljs-comment-slc">#</strong>     'password-change/done/',
<strong class="hljs-comment-slc">#</strong>     auth_views.PasswordChangeDoneView.as_view(),
<strong class="hljs-comment-slc">#</strong>     name='password_change_done'
<strong class="hljs-comment-slc">#</strong> ),
# reset password urls
<strong class="hljs-comment-slc">#</strong> path(
<strong class="hljs-comment-slc">#</strong>     'password-reset/',
<strong class="hljs-comment-slc">#</strong>     auth_views.PasswordResetView.as_view(),
<strong class="hljs-comment-slc">#</strong>     name='password_reset'
<strong class="hljs-comment-slc">#</strong> ),
<strong class="hljs-comment-slc">#</strong> path(
<strong class="hljs-comment-slc">#</strong>     'password-reset/done/',
<strong class="hljs-comment-slc">#</strong>     auth_views.PasswordResetDoneView.as_view(),
<strong class="hljs-comment-slc">#</strong>     name='password_reset_done'
<strong class="hljs-comment-slc">#</strong> ),
<strong class="hljs-comment-slc">#</strong> path(
<strong class="hljs-comment-slc">#</strong>     'password-reset/&lt;uidb64&gt;/&lt;token&gt;/',
<strong class="hljs-comment-slc">#</strong>     auth_views.PasswordResetConfirmView.as_view(),
<strong class="hljs-comment-slc">#</strong>     name='password_reset_confirm'
<strong class="hljs-comment-slc">#</strong> ),
<strong class="hljs-comment-slc">#</strong> path(
<strong class="hljs-comment-slc">#</strong>     'password-reset/complete/',
<strong class="hljs-comment-slc">#</strong>     auth_views.PasswordResetCompleteView.as_view(),
<strong class="hljs-comment-slc">#</strong>     name='password_reset_complete'
<strong class="hljs-comment-slc">#</strong> ),
<strong class="hljs-slc">path(</strong><strong class="hljs-string-slc">''</strong><strong class="hljs-slc">, include(</strong><strong class="hljs-string-slc">'django.contrib.auth.urls'</strong><strong class="hljs-slc">)),</strong>
    path('', views.dashboard, name='dashboard'),
]
</code></pre>
<p class="normal">You can see the <a id="_idIndexMarker414"/>authentication URL patterns included at <a href="https://github.com/django/django/blob/stable/5.0.x/django/contrib/auth/urls.py">https://github.com/django/django/blob/stable/5.0.x/django/contrib/auth/urls.py</a>.</p>
<p class="normal">We have now added all the necessary authentication views to our project. Next, we will implement<a id="_idIndexMarker415"/> user registration.</p>
<h1 class="heading-1" id="_idParaDest-152">User registration and user profiles</h1>
<p class="normal">Site users can <a id="_idIndexMarker416"/>now<a id="_idIndexMarker417"/> log in, log out, change their password, and reset their password. However, we need to build a view to allow visitors to create a user account. They should be able to register and create a profile on our site. Once registered, users will be able to log in to our site using their credentials.</p>
<h2 class="heading-2" id="_idParaDest-153">User registration</h2>
<p class="normal">Letâ€™s create a<a id="_idIndexMarker418"/> simple view to allow user registration on your website. Initially, you have to create a form to let the user enter a username, their real name, and a password.</p>
<p class="normal">Edit the <code class="inlineCode">forms.py</code> file located inside the <code class="inlineCode">account</code> application directory and add the following lines highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django import forms
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.contrib.auth </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> get_user_model</strong>
class LoginForm(forms.Form):
    username = forms.CharField()
    password = forms.CharField(widget=forms.PasswordInput)
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">UserRegistrationForm</strong><strong class="hljs-slc">(forms.ModelForm):</strong>
<strong class="hljs-slc">    password = forms.CharField(</strong>
<strong class="hljs-slc">        label=</strong><strong class="hljs-string-slc">'Password'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        widget=forms.PasswordInput</strong>
<strong class="hljs-slc">    )</strong>
<strong class="hljs-slc">    password2 = forms.CharField(</strong>
<strong class="hljs-slc">        label=</strong><strong class="hljs-string-slc">'Repeat password'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        widget=forms.PasswordInput</strong>
<strong class="hljs-slc">    )</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Meta</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">        model = get_user_model()</strong>
<strong class="hljs-slc">        fields = [</strong><strong class="hljs-string-slc">'username'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'first_name'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'email'</strong><strong class="hljs-slc">]</strong>
</code></pre>
<p class="normal">We have created a model form for the user model. This form includes the fields <code class="inlineCode">username</code>, <code class="inlineCode">first_name</code>, and <code class="inlineCode">email</code> of the user model. We retrieve the user model dynamically by using the <code class="inlineCode">get_user_model()</code> function provided by the <code class="inlineCode">auth</code> application. This retrieves the user model, which could be a custom model instead of the default <code class="inlineCode">auth</code> <code class="inlineCode">User</code> model, since Django allows you to define custom user models. These fields will be validated according to the validations of their corresponding model fields. For example, if the user chooses a username that already exists, they will get a validation error because <code class="inlineCode">username</code> is a field defined with <code class="inlineCode">unique=True</code>.</p>
<div><p class="normal">In order to keep your code generic, use the <code class="inlineCode">get_user_model()</code> method to retrieve the user model and the <code class="inlineCode">AUTH_USER_MODEL</code> setting to refer to it when defining a modelâ€™s relationship with in to it, instead of referring to the <code class="inlineCode">auth</code> user model directly. You can read more information about this at <a href="https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#django.contrib.auth.get_user_model">https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#django.contrib.auth.get_user_model</a>.</p>
</div>
<p class="normal">We have also<a id="_idIndexMarker419"/> added two additional fieldsâ€”<code class="inlineCode">password</code> and <code class="inlineCode">password2</code>â€”for users to set a password and to repeat it. Letâ€™s add the field validation to check that both passwords are the same.</p>
<p class="normal">Edit the <code class="inlineCode">forms.py</code> file in the <code class="inlineCode">account</code> application and add the following <code class="inlineCode">clean_password2()</code> method to the <code class="inlineCode">UserRegistrationForm</code> class. The new code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">class UserRegistrationForm(forms.ModelForm):
    password = forms.CharField(
        label='Password',
        widget=forms.PasswordInput
    )
    password2 = forms.CharField(
        label='Repeat password',
        widget=forms.PasswordInput
    )
    class Meta:
        model = get_user_model()
        fields = ['username', 'first_name', 'email']
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">clean_password2</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc">        cd = self.cleaned_data</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> cd[</strong><strong class="hljs-string-slc">'password'</strong><strong class="hljs-slc">] != cd[</strong><strong class="hljs-string-slc">'password2'</strong><strong class="hljs-slc">]:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">raise</strong><strong class="hljs-slc"> forms.ValidationError(</strong><strong class="hljs-string-slc">"Passwords don't match."</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> cd[</strong><strong class="hljs-string-slc">'password2'</strong><strong class="hljs-slc">]</strong>
</code></pre>
<p class="normal">We have defined a <code class="inlineCode">clean_password2()</code> method to compare the second password against the first one and raise a validation error if the passwords donâ€™t match. This method is executed when the form is validated by calling its <code class="inlineCode">is_valid()</code> method. You can provide a <code class="inlineCode">clean_&lt;fieldname&gt;()</code> method to any of your form fields to clean the value or raise form validation errors for a specific field. Forms also include a general <code class="inlineCode">clean()</code> method to validate the entire form, which is useful to validate fields that depend on each other. In this case, we use the field-specific <code class="inlineCode">clean_password2()</code> validation instead of overriding the <code class="inlineCode">clean()</code> method of the form. This avoids overriding other field-specific checks that the <code class="inlineCode">ModelForm</code> gets from the restrictions set in the model (for example, validating<a id="_idIndexMarker420"/> that the username is unique).</p>
<p class="normal">Django also provides a <code class="inlineCode">UserCreationForm</code> form that resides in <code class="inlineCode">django.contrib.auth.forms</code> and is very similar to the one we have created.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">account</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django.contrib.auth import authenticate, login
from django.contrib.auth.decorators import login_required
from django.http import HttpResponse
from django.shortcuts import render
from .forms import LoginForm<strong class="hljs-slc">, UserRegistrationForm</strong>
# ...
<strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">register</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">request</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> request.method == </strong><strong class="hljs-string-slc">'POST'</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">        user_form = UserRegistrationForm(request.POST)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> user_form.is_valid():</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># Create a new user object but avoid saving it yet</strong>
<strong class="hljs-slc">            new_user = user_form.save(commit=</strong><strong class="hljs-literal-slc">False</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># Set the chosen password</strong>
<strong class="hljs-slc">            new_user.set_password(</strong>
<strong class="hljs-slc">                user_form.cleaned_data[</strong><strong class="hljs-string-slc">'password'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">            )</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># Save the User object</strong>
<strong class="hljs-slc">            new_user.save()</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> render(</strong>
<strong class="hljs-keyword-slc"> </strong><strong class="hljs-slc">request,</strong>
<strong class="hljs-keyword-slc"> </strong><strong class="hljs-string-slc">'account/register_done.html'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-keyword-slc"> </strong><strong class="hljs-slc">{</strong><strong class="hljs-string-slc">'new_user'</strong><strong class="hljs-slc">: new_user}</strong>
<strong class="hljs-keyword-slc"> </strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">else</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">        user_form = UserRegistrationForm()</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> render(</strong>
<strong class="hljs-slc">        request,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'account/register.html'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        {</strong><strong class="hljs-string-slc">'user_form'</strong><strong class="hljs-slc">: user_form}</strong>
<strong class="hljs-slc">    )</strong>
</code></pre>
<p class="normal">The view for creating user accounts is quite simple. For security reasons, instead of saving the raw password entered by the user, we use the <code class="inlineCode">set_password()</code> method of the user model. This method handles password hashing before storing the password in the database.</p>
<p class="normal">Django doesnâ€™t store clear text passwords; it stores hashed passwords instead. Hashing is the process of transforming a given key into another value. A hash function is used to generate a fixed-length<a id="_idIndexMarker421"/> value according to a mathematical algorithm. By hashing passwords with secure algorithms, Django ensures that user passwords stored in the database require massive amounts of computing time to break.</p>
<p class="normal">By default, Django uses the <code class="inlineCode">PBKDF2</code> hashing algorithm with a SHA256 hash to store all passwords. However, Django not only supports checking existing passwords hashed with <code class="inlineCode">PBKDF2</code> but also supports checking stored passwords hashed with other algorithms, such as <code class="inlineCode">PBKDF2SHA1</code>, <code class="inlineCode">argon2</code>, <code class="inlineCode">bcrypt</code>, and <code class="inlineCode">scrypt</code>.</p>
<p class="normal">The <code class="inlineCode">PASSWORD_HASHERS</code> setting defines the password hashers that the Django project supports. The following is the default <code class="inlineCode">PASSWORD_HASHERS</code> list:</p>
<pre class="programlisting code"><code class="hljs-code">PASSWORD_HASHERS = [
    'django.contrib.auth.hashers.PBKDF2PasswordHasher',
    'django.contrib.auth.hashers.PBKDF2SHA1PasswordHasher',
    'django.contrib.auth.hashers.Argon2PasswordHasher',
    'django.contrib.auth.hashers.BCryptSHA256PasswordHasher',
    'django.contrib.auth.hashers.ScryptPasswordHasher',
]
</code></pre>
<p class="normal">Django uses the first entry of the list (in this case, <code class="inlineCode">PBKDF2PasswordHasher</code>) to hash all passwords. The rest of the hashers can be used by Django to check existing passwords.</p>
<div><p class="normal">The <code class="inlineCode">scrypt</code> hasher was introduced in Django 4.0. It is more secure and recommended over <code class="inlineCode">PBKDF2</code>. However, <code class="inlineCode">PBKDF2</code> is still the default hasher, as <code class="inlineCode">scrypt</code> requires OpenSSL 1.1+ and more memory.</p>
</div>
<p class="normal">You can learn more about how Django stores passwords and about the password hashers included at <a href="https://docs.djangoproject.com/en/5.0/topics/auth/passwords/">https://docs.djangoproject.com/en/5.0/topics/auth/passwords/</a>.</p>
<p class="normal">Now, edit the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">account</code> application and add the following URL pattern highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    # ...
    path('', include('django.contrib.auth.urls')),
    path('', views.dashboard, name='dashboard'),
    <strong class="hljs-slc">path(</strong><strong class="hljs-string-slc">'register/'</strong><strong class="hljs-slc">, views.register, name=</strong><strong class="hljs-string-slc">'register'</strong><strong class="hljs-slc">),</strong>
]
</code></pre>
<p class="normal">Finally, create<a id="_idIndexMarker422"/> a new template in the <code class="inlineCode">templates/account/</code> template directory of the <code class="inlineCode">account</code> application, name it <code class="inlineCode">register.html</code>, and make it look as follows:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Create an account{% endblock %}
{% block content %}
  &lt;h1&gt;Create an account&lt;/h1&gt;
&lt;p&gt;Please, sign up using the following form:&lt;/p&gt;
&lt;form method="post"&gt;
    {{ user_form.as_p }}
    {% csrf_token %}
    &lt;p&gt;&lt;input type="submit" value="Create my account"&gt;&lt;/p&gt;
&lt;/form&gt;
{% endblock %}
</code></pre>
<p class="normal">Create an additional template file in the same directory and name it <code class="inlineCode">register_done.html</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Welcome{% endblock %}
{% block content %}
  &lt;h1&gt;Welcome {{ new_user.first_name }}!&lt;/h1&gt;
&lt;p&gt;
    Your account has been successfully created.
    Now you can &lt;a href="{% url "login" %}"&gt;log in&lt;/a&gt;.
  &lt;/p&gt;
{% endblock %}
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/account/register/</code> in your browser. You will see the registration<a id="_idIndexMarker423"/> page you have created:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_04_17.png"/></figure>
<p class="packt_figref">Figure 4.17: The account creation form</p>
<p class="normal">Fill in the details<a id="_idIndexMarker424"/> for a new user and click on the <strong class="screenText">CREATE MY ACCOUNT</strong> button.</p>
<p class="normal">If all fields are valid, the user will be created, and you will see the following success message:</p>
<figure class="mediaobject"><img alt="Graphical user interface, application, website  Description automatically generated" src="img/B21088_04_18.png"/></figure>
<p class="packt_figref">Figure 4.18: The account is successfully created page</p>
<p class="normal">Click on the <strong class="screenText">log in</strong> link and enter your username and password to verify that you can access your newly created account.</p>
<p class="normal">Letâ€™s add a link to <a id="_idIndexMarker425"/>register on the login template. Edit the <code class="inlineCode">registration/login.html</code> template and find the following line:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;p&gt;Please, use the following form to log-in:&lt;/p&gt;
</code></pre>
<p class="normal">Replace it with the following lines:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;p&gt;
  Please, use the following form to log-in.
  <strong class="hljs-slc">If you don't have an account </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">href</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"{% url "</strong><strong class="hljs-attr-slc">register</strong><strong class="hljs-string-slc">" %}"</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">register here</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">.</strong>
&lt;/p&gt;
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/account/login/</code> in your browser. The page should now look as follows:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="img/B21088_04_19.png"/></figure>
<p class="packt_figref">Figure 4.19: The Log-in page including a link to register</p>
<p class="normal">We have now <a id="_idIndexMarker426"/>made the registration page accessible from the <strong class="screenText">Log-in</strong> page.</p>
<h2 class="heading-2" id="_idParaDest-154">Extending the user model</h2>
<p class="normal">While the user<a id="_idIndexMarker427"/> model provided by Djangoâ€™s authentication framework is sufficient for most typical scenarios, it does have a limited set of predefined fields. If you want to capture additional details relevant to your application, you may want to extend the default user model. For example, the default user model comes with the <code class="inlineCode">first_name</code> and <code class="inlineCode">last_name</code> fields, a structure that may not align with naming conventions in various countries. Additionally, you may want to store further user details or construct a more comprehensive user profile.</p>
<p class="normal">A simple way to extend the user model is by creating a profile model that contains a one-to-one relationship with the Django user model, and any additional fields. A one-to-one relationship is similar to a <code class="inlineCode">ForeignKey</code> field with the parameter <code class="inlineCode">unique=True</code>. The reverse side of the relationship is an implicit one-to-one relationship with the related model instead of a manager for multiple elements. From each side of the relationship, you access a single related object.</p>
<p class="normal">Edit the <code class="inlineCode">models.py</code> file of your <code class="inlineCode">account</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django.db import models
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.conf </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> settings</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Profile</strong><strong class="hljs-slc">(models.Model):</strong>
<strong class="hljs-slc">    user = models.OneToOneField(</strong>
<strong class="hljs-slc">        settings.AUTH_USER_MODEL,</strong>
<strong class="hljs-slc">        on_delete=models.CASCADE</strong>
<strong class="hljs-slc">    )</strong>
<strong class="hljs-slc">    date_of_birth = models.DateField(blank=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">, null=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    photo = models.ImageField(</strong>
<strong class="hljs-slc">        upload_to=</strong><strong class="hljs-string-slc">'users/%Y/%m/%d/'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        blank=</strong><strong class="hljs-literal-slc">True</strong>
<strong class="hljs-slc">    )</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">__str__</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">f'Profile of </strong><strong class="hljs-subst-slc">{self.user.username}</strong><strong class="hljs-string-slc">'</strong>
</code></pre>
<p class="normal">Our user profile <a id="_idIndexMarker428"/>will include the userâ€™s date of birth and an image of the user.</p>
<p class="normal">The one-to-one field <code class="inlineCode">user</code> will be used to associate profiles with users. We use <code class="inlineCode">AUTH_USER_MODEL</code> to refer to the user model instead of pointing to the <code class="inlineCode">auth.User</code> model directly. This makes our code more generic, as it can operate with custom-defined user models. With <code class="inlineCode">on_delete=models.CASCADE</code>, we force the deletion of the related <code class="inlineCode">Profile</code> object when a <code class="inlineCode">User</code> object gets deleted.</p>
<p class="normal">The <code class="inlineCode">date_of_birth</code> field is a <code class="inlineCode">DateField</code>. We have made this field optional with <code class="inlineCode">blank=True</code>, and we allow <code class="inlineCode">null</code> values with <code class="inlineCode">null=True</code>.</p>
<p class="normal">The <code class="inlineCode">photo</code> field is an <code class="inlineCode">ImageField</code>. We have made this field optional with <code class="inlineCode">blank=True</code>. An <code class="inlineCode">ImageField</code> field manages the storage of image files. It validates that the file provided is a valid image, stores the image file in the directory indicated with the <code class="inlineCode">upload_to</code> parameter, and stores the relative path to the file in the related database field. An <code class="inlineCode">ImageField</code> field is translated to a <code class="inlineCode">VARHAR(100)</code> column in the database by default. A blank string will be <a id="_idIndexMarker429"/>stored if the value is left empty.</p>
<h2 class="heading-2" id="_idParaDest-155">Installing Pillow and serving media files</h2>
<p class="normal">We need to <a id="_idIndexMarker430"/>install the Pillow library to manage images. Pillow <a id="_idIndexMarker431"/>is <a id="_idIndexMarker432"/>the<a id="_idIndexMarker433"/> de facto standard library for image processing in Python. It supports multiple image formats and provides powerful image processing functions. Pillow is required by Django to handle images with <code class="inlineCode">ImageField</code>.</p>
<p class="normal">Install Pillow by running the following command from the shell prompt:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install Pillow==10.3.0
</code></pre>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of the project and add the following lines:</p>
<pre class="programlisting code"><code class="hljs-code">MEDIA_URL = 'media/'
MEDIA_ROOT = BASE_DIR / 'media'
</code></pre>
<p class="normal">This will enable Django to manage file uploads and serve media files. <code class="inlineCode">MEDIA_URL</code> is the base URL used to serve the media files uploaded by users. <code class="inlineCode">MEDIA_ROOT</code> is the local path where they reside. Paths and URLs for files are built dynamically by prepending the project path or the media URL to them for portability.</p>
<p class="normal">Now, edit the main <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">bookmarks</code> project and modify the code, as follows. The new lines are highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.conf </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> settings</strong>
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.conf.urls.static </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> static</strong>
from django.contrib import admin
from django.urls import path, include
urlpatterns = [
    path('admin/', admin.site.urls),
    path('account/', include('account.urls')),
]
<strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> settings.DEBUG:</strong>
<strong class="hljs-slc">    urlpatterns += static(</strong>
<strong class="hljs-slc">        settings.MEDIA_URL,</strong>
<strong class="hljs-slc">        document_root=settings.MEDIA_ROOT</strong>
<strong class="hljs-slc">    )</strong>
</code></pre>
<p class="normal">We have added the <code class="inlineCode">static()</code> helper function to serve media files with the Django development<a id="_idIndexMarker434"/> server during<a id="_idIndexMarker435"/> development (that is, when the <code class="inlineCode">DEBUG</code> setting<a id="_idIndexMarker436"/> is <a id="_idIndexMarker437"/>set to <code class="inlineCode">True</code>).</p>
<div><p class="normal">The <code class="inlineCode">static()</code> helper function is suitable for development but not for production use. Django is very inefficient at serving static files. Never serve your static files with Django in a production environment. You will learn how to serve static files in a production environment in <em class="chapterRef">Chapter 17</em>, <em class="italic">Going Live</em>.</p>
</div>
<h2 class="heading-2" id="_idParaDest-156">Creating migrations for the profile model</h2>
<p class="normal">Letâ€™s create the <a id="_idIndexMarker438"/>database table for the new <code class="inlineCode">Profile</code> model. Open the shell and run the following command to create the database migration for the new model:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py makemigrations
</code></pre>
<p class="normal">You will get the following output:</p>
<pre class="programlisting con"><code class="hljs-con">Migrations for 'account':
  account/migrations/0001_initial.py
    - Create model Profile
</code></pre>
<p class="normal">Next, sync the database with the following command in the shell prompt:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py migrate
</code></pre>
<p class="normal">You will see output that includes the following line:</p>
<pre class="programlisting con"><code class="hljs-con">Applying account.0001_initial... OK
</code></pre>
<p class="normal">Edit the <code class="inlineCode">admin.py</code> file of the <code class="inlineCode">account</code> application and register the <code class="inlineCode">Profile</code> model in the administration site by adding the code in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django.contrib import admin
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> .models </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> Profile</strong>
<strong class="hljs-meta-slc">@admin.register(</strong><strong class="hljs-params-slc">Profile</strong><strong class="hljs-meta-slc">)</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">ProfileAdmin</strong><strong class="hljs-slc">(admin.ModelAdmin):</strong>
<strong class="hljs-slc">    list_display = [</strong><strong class="hljs-string-slc">'user'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'date_of_birth'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'photo'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">    raw_id_fields = [</strong><strong class="hljs-string-slc">'user'</strong><strong class="hljs-slc">]</strong>
</code></pre>
<p class="normal">Run the development server using the following command from the shell prompt:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/admin/</code> in your browser. Now, you should be able to see the <code class="inlineCode">Profile</code> model<a id="_idIndexMarker439"/> on the administration site of your project, as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_04_20.png"/></figure>
<p class="packt_figref">Figure 4.20: The ACCOUNT block on the administration site index page</p>
<p class="normal">Click on the <strong class="screenText">Add</strong> link of the <strong class="screenText">Profiles</strong> row. You will see the following form to add a new profile:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_04_21.png"/></figure>
<p class="packt_figref">Figure 4.21: The Add profile form</p>
<p class="normal">Create a <code class="inlineCode">Profile</code> object manually for each of the existing users in the database.</p>
<p class="normal">Next, we will let users edit their profiles on the website.</p>
<p class="normal">Edit the <code class="inlineCode">forms.py</code> file of the <code class="inlineCode">account</code> application and add the following lines highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"># ...
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> .models </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> Profile</strong>
# ...
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">UserEditForm</strong><strong class="hljs-slc">(forms.ModelForm):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Meta</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">        model = get_user_model()</strong>
<strong class="hljs-slc">        fields = [</strong><strong class="hljs-string-slc">'first_name'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'last_name'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'email'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">ProfileEditForm</strong><strong class="hljs-slc">(forms.ModelForm):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Meta</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">        model = Profile</strong>
<strong class="hljs-slc">        fields = [</strong><strong class="hljs-string-slc">'date_of_birth'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'photo'</strong><strong class="hljs-slc">]</strong>
</code></pre>
<p class="normal">These forms<a id="_idIndexMarker440"/> are as follows:</p>
<ul>
<li class="bulletList"><code class="inlineCode">UserEditForm</code>: This will allow users to edit their first name, last name, and email, which are attributes of the built-in Django user model.</li>
<li class="bulletList"><code class="inlineCode">ProfileEditForm</code>: This will allow users to edit the profile data that is saved in the custom <code class="inlineCode">Profile</code> model. Users will be able to edit their date of birth and upload an image for their profile picture.</li>
</ul>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">account</code> application and add the following lines highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"># ...
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> .models </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> Profile</strong>
# ...
def register(request):
    if request.method == 'POST':
        user_form = UserRegistrationForm(request.POST)
        if user_form.is_valid():
            # Create a new user object but avoid saving it yet
            new_user = user_form.save(commit=False)
            # Set the chosen password
            new_user.set_password(
                user_form.cleaned_data['password']
            )
            # Save the User object
            new_user.save()
            <strong class="hljs-comment-slc"># Create the user profile</strong>
<strong class="hljs-slc">Profile.objects.create(user=new_user)</strong>
return render(
 request,
 'account/register_done.html',
 {'new_user': new_user}
 )
    else:
        user_form = UserRegistrationForm()
    return render(
        request,
        'account/register.html',
        {'user_form': user_form}
    )
</code></pre>
<p class="normal">When users register on the site, a corresponding <code class="inlineCode">Profile</code> object will be automatically created and associated<a id="_idIndexMarker441"/> with the <code class="inlineCode">User</code> object created. However, users created through the administration site wonâ€™t automatically get an associated <code class="inlineCode">Profile</code> object. Both users with and without a profile (for example, staff users) can co-exist.</p>
<p class="normal">If you want to force profile creation for all users, you can use Django signals to trigger the creation of a <code class="inlineCode">Profile</code> object whenever a user is created. You will learn about signals in <em class="italic">Chapter 7</em>, <em class="italic">Tracking User Actions</em>, where you will engage in an exercise to implement this feature in the section <em class="italic">Expanding your project using AI</em>.</p>
<p class="normal">Now, we will let users edit their profiles.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">account</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django.contrib.auth import authenticate, login
from django.contrib.auth.decorators import login_required
from django.http import HttpResponse
from django.shortcuts import render
from .forms import <strong class="hljs-slc">(</strong>
    LoginForm,
 UserRegistrationForm<strong class="hljs-slc">,</strong>
<strong class="hljs-slc">UserEditForm,</strong>
<strong class="hljs-slc">ProfileEditForm</strong>
<strong class="hljs-slc">)</strong>
from .models import Profile
# ...
<strong class="hljs-meta-slc">@login_required</strong>
<strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">edit</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">request</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> request.method == </strong><strong class="hljs-string-slc">'POST'</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">        user_form = UserEditForm(</strong>
<strong class="hljs-slc">            instance=request.user,</strong>
<strong class="hljs-slc">            data=request.POST</strong>
<strong class="hljs-slc">        )</strong>
<strong class="hljs-slc">        profile_form = ProfileEditForm(</strong>
<strong class="hljs-slc">            instance=request.user.profile,</strong>
<strong class="hljs-slc">            data=request.POST,</strong>
<strong class="hljs-slc">            files=request.FILES</strong>
<strong class="hljs-slc">        )</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> user_form.is_valid() </strong><strong class="hljs-keyword-slc">and</strong><strong class="hljs-slc"> profile_form.is_valid():</strong>
<strong class="hljs-slc">            user_form.save()</strong>
<strong class="hljs-slc">            profile_form.save()</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">else</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">        user_form = UserEditForm(instance=request.user)</strong>
<strong class="hljs-slc">        profile_form = ProfileEditForm(instance=request.user.profile)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> render(</strong>
<strong class="hljs-slc">        request,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'account/edit.html'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        {</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'user_form'</strong><strong class="hljs-slc">: user_form,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'profile_form'</strong><strong class="hljs-slc">: profile_form</strong>
<strong class="hljs-slc">        }</strong>
<strong class="hljs-slc">    )</strong>
</code></pre>
<p class="normal">We have added the new <code class="inlineCode">edit</code> view to allow users to edit their personal information. We have added the <code class="inlineCode">login_required</code> decorator to the view because only authenticated users will be able to edit their profiles. For this view, we use two model forms: <code class="inlineCode">UserEditForm</code> to store the data of the built-in user model and <code class="inlineCode">ProfileEditForm</code> to store the additional personal data in the custom <code class="inlineCode">Profile</code> model. To validate the data submitted, we call the <code class="inlineCode">is_valid()</code> method of both forms. If both forms contain valid data, we save both forms by calling the <code class="inlineCode">save()</code> method to update the corresponding objects in the database.</p>
<p class="normal">Add the following <a id="_idIndexMarker442"/>URL pattern to the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">account</code> application:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    #...
    path('', include('django.contrib.auth.urls')),
    path('', views.dashboard, name='dashboard'),
    path('register/', views.register, name='register'),
    <strong class="hljs-slc">path(</strong><strong class="hljs-string-slc">'edit/'</strong><strong class="hljs-slc">, views.edit, name=</strong><strong class="hljs-string-slc">'edit'</strong><strong class="hljs-slc">),</strong>
]
</code></pre>
<p class="normal">Finally, create a template for this view in the <code class="inlineCode">templates/account/</code> directory and name it <code class="inlineCode">edit.html</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Edit your account{% endblock %}
{% block content %}
  &lt;h1&gt;Edit your account&lt;/h1&gt;
&lt;p&gt;You can edit your account using the following form:&lt;/p&gt;
&lt;form method="post" enctype="multipart/form-data"&gt;
    {{ user_form.as_p }}
    {{ profile_form.as_p }}
    {% csrf_token %}
    &lt;p&gt;&lt;input type="submit" value="Save changes"&gt;&lt;/p&gt;
&lt;/form&gt;
{% endblock %}
</code></pre>
<p class="normal">In the preceding code, we have added <code class="inlineCode">enctype="multipart/form-data"</code> to the <code class="inlineCode">&lt;form&gt;</code> HTML element to enable file uploads. We use an HTML form to submit both the <code class="inlineCode">user_form</code> and <code class="inlineCode">profile_form</code> forms.</p>
<p class="normal">Open the URL <code class="inlineCode">http://127.0.0.1:8000/account/register/</code> and register a new user. Then, log in with the new user and open the URL <code class="inlineCode">http://127.0.0.1:8000/account/edit/</code>. You should see the following page:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="img/B21088_04_22.png"/></figure>
<p class="packt_figref">Figure 4.22: The profile edit form</p>
<p class="normal">You can now<a id="_idIndexMarker443"/> add the profile information and save the changes.</p>
<p class="normal">We will edit the dashboard template to include links to the edit profile and change password pages.</p>
<p class="normal">Open the <code class="inlineCode">templates/account/dashboard.html</code> template and add the following lines highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
  &lt;h1&gt;Dashboard&lt;/h1&gt;
&lt;p&gt;
    Welcome to your dashboard. <strong class="hljs-slc">You can </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">href</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"{% url "</strong><strong class="hljs-attr-slc">edit</strong><strong class="hljs-tag-slc">" %}"&gt;</strong><strong class="hljs-slc">edit your profile</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc"> or </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">href</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"{% url "</strong><strong class="hljs-attr-slc">password_change</strong><strong class="hljs-tag-slc">"</strong><strong class="hljs-tag-slc"> %}"&gt;</strong><strong class="hljs-slc">change your password</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">.</strong>
&lt;/p&gt;
{% endblock %}
</code></pre>
<p class="normal">Users can now access the form to edit their profile from the dashboard. Open <code class="inlineCode">http://127.0.0.1:8000/account/</code> in your browser and test the new link to edit a userâ€™s profile. The <a id="_idIndexMarker444"/>dashboard should now look like this:</p>
<figure class="mediaobject"><img alt="Graphical user interface  Description automatically generated with medium confidence" src="img/B21088_04_23.png"/></figure>
<p class="packt_figref">Figure 4.23: Dashboard page content, including links to edit a profile and change a password</p>
<h3 class="heading-3" id="_idParaDest-157">Using a custom user model</h3>
<p class="normal">Django also offers a <a id="_idIndexMarker445"/>way to substitute the user model with a custom model. The <code class="inlineCode">User</code> class should inherit from Djangoâ€™s <code class="inlineCode">AbstractUser</code> class, which provides the full implementation of the default user as an abstract model. You can read more about this method at <a href="https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#substituting-a-custom-user-model">https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#substituting-a-custom-user-model</a>.</p>
<p class="normal">Using a custom user model will give you more flexibility, but it might also result in more difficult integration<a id="_idIndexMarker446"/> with pluggable applications that interact directly with Djangoâ€™s <code class="inlineCode">auth</code> user model.</p>
<h1 class="heading-1" id="_idParaDest-158">Summary</h1>
<p class="normal">In this chapter, you learned how to build an authentication system for your site. You implemented all the necessary views for users to register, log in, log out, edit their password, and reset their password. You also built a model to store custom user profiles.</p>
<p class="normal">In the next chapter, you will improve the user experience by providing feedback on userâ€™s actions through the Django messages framework. You will also broaden the scope of authentication methods, enabling users to authenticate with their email address, and integrate social authentication via Google. You will also learn how to serve the development server over HTTPS using Django Extensions, and you will customize the authentication pipeline to create user profiles automatically.</p>
<h1 class="heading-1" id="_idParaDest-159">Additional resources</h1>
<p class="normal">The following resources provide additional information related to the topics covered in this chapter:</p>
<ul>
<li class="bulletList">Source code for this chapter: <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter04">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter04</a></li>
<li class="bulletList">Built-in authentication views: <a href="https://docs.djangoproject.com/en/5.0/topics/auth/default/#all-authentication-views">https://docs.djangoproject.com/en/5.0/topics/auth/default/#all-authentication-views</a></li>
<li class="bulletList">Authentication URL patterns: <a href="https://github.com/django/django/blob/stable/3.0.x/django/contrib/auth/urls.py">https://github.com/django/django/blob/stable/3.0.x/django/contrib/auth/urls.py</a></li>
<li class="bulletList">How Django manages passwords and available password hashers: <a href="https://docs.djangoproject.com/en/5.0/topics/auth/passwords/">https://docs.djangoproject.com/en/5.0/topics/auth/passwords/</a></li>
<li class="bulletList">Generic user model and the <code class="inlineCode">get_user_model()</code> method: <a href="https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#django.contrib.auth.get_user_model">https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#django.contrib.auth.get_user_model</a></li>
<li class="bulletList">Using a custom user model: <a href="https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#substituting-a-custom-user-model">https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#substituting-a-custom-user-model</a></li>
</ul>
<h1 class="heading-1" id="_idParaDest-160">Join us on Discord!</h1>
<p class="normal">Read this book alongside other users, Django development experts, and the author himself. Ask questions, provide solutions to other readers, chat with the author via Ask Me Anything sessions, and much more.Scan the QR code or visit the link to join the community.</p>
<p class="normal"><a href="https://packt.link/Django5ByExample">https://packt.link/Django5ByExample</a></p>
<p class="normal"><img alt="" role="presentation" src="img/QR_Code287089408934129031.png"/></p>
</div>
</body></html>