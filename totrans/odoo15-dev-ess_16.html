<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer097">
			<h1 id="_idParaDest-405"><em class="italic"><a id="_idTextAnchor410"/></em><a href="B16119_15_Final_PD_ePub.xhtml#_idTextAnchor410"><em class="italic">Chapter 15</em></a>: Deploying and Maintaining Production Instances</h1>
			<p>In this chapter, you'll learn the basics of preparing an Odoo server for use in a production environment.</p>
			<p>Setting up and maintaining servers is a non-trivial topic in itself and should be done by specialists. The information given here is not enough to ensure an average user can create a resilient and secure environment that hosts sensitive data and services.</p>
			<p>The goal of this chapter is to introduce the most important configuration aspects and the best practices specific to Odoo deployments. This will help system administrators prepare their Odoo server hosts.</p>
			<p>You will start by setting up the host system, and then you will install the Odoo prerequisites and Odoo itself. <strong class="bold">Ubuntu</strong> is a popular choice for cloud servers, and it will be used here. Then, the Odoo configuration file needs to be prepared. Until this point, the setup is similar to the one used for the development environment.</p>
			<p>Next, Odoo needs to be configured as a system service so that it is automatically started when the server starts.</p>
			<p>For servers hosted on a public cloud, Odoo should be served through <strong class="bold">HTTPS</strong>. For this, you will learn how to install and configure an <strong class="bold">Nginx</strong> reverse proxy by using a self-signed certificate.</p>
			<p>The final section discusses how to perform server upgrades and prepare a staging environment that will allow us to perform dry-runs before the actual updates are applied.</p>
			<p>The topics discussed in this chapter are as follows:</p>
			<ul>
				<li>Preparing the host system</li>
				<li>Installing Odoo from source code</li>
				<li>Configuring Odoo</li>
				<li>Setting up Odoo as a system service</li>
				<li>Setting up an Nginx reverse proxy</li>
				<li>Configuring and enforcing HTTPS</li>
				<li>Maintaining the Odoo service and modules</li>
			</ul>
			<p>By the end of this chapter, you will be able to set up a reasonably secure Odoo server that is good enough for low-profile production use. However, the recipes given in this chapter aren't the only valid way to deploy Odoo – other approaches are also possible.</p>
			<h1 id="_idParaDest-406"><a id="_idTextAnchor411"/>Technical requirements</h1>
			<p>To follow this chapter, you will need a clean Ubuntu 20.04 server – for example, a <strong class="bold">virtual private server</strong> (<strong class="bold">VPS</strong>) hosted on the cloud.</p>
			<p>The code and scripts used in this chapter can be found in the <strong class="source-inline">ch15/</strong> directory of the <strong class="bold">GitHub</strong> repository at <a href="https://github.com/PacktPublishing/Odoo-15-Development-Essentials">https://github.com/PacktPublishing/Odoo-15-Development-Essentials</a>.</p>
			<h1 id="_idParaDest-407"><a id="_idTextAnchor412"/>Preparing the host system</h1>
			<p>Odoo is usually deployed <a id="_idIndexMarker1180"/>on <strong class="bold">Debian</strong>-based <strong class="bold">Linux</strong> systems. Ubuntu is a <a id="_idIndexMarker1181"/>popular choice, and <a id="_idIndexMarker1182"/>the latest <strong class="bold">long-term support</strong> (<strong class="bold">LTS</strong>) version <a id="_idIndexMarker1183"/>is 20.04 <strong class="bold">Focal Fossa</strong>.</p>
			<p>Other Linux <a id="_idIndexMarker1184"/>distributions can also be used. The <strong class="bold">CentOS</strong>/<strong class="bold">Red Hat Enterprise Linux</strong> (<strong class="bold">RHEL</strong>) system <a id="_idIndexMarker1185"/>is also popular in corporate circles.</p>
			<p>The installation process requires elevated access, using the <strong class="source-inline">root</strong> superuser or the <strong class="source-inline">sudo</strong> command. When using a Debian distribution, the default login is <strong class="source-inline">root</strong>, which has administration access, and the command prompt shows <strong class="source-inline">#</strong>. On Ubuntu systems, the <strong class="source-inline">root</strong> account <a id="_idIndexMarker1186"/>is disabled. Instead, the initial user is configured during the installation process and is a <strong class="bold">sudoer</strong>, meaning that the user is allowed to use the <strong class="source-inline">sudo</strong> command to elevate access and run commands with the <strong class="source-inline">root</strong> privileges.</p>
			<p>Before starting the Odoo installation, the host system dependencies must be installed, and a specific user should be created to run the Odoo service.</p>
			<p>The next section explains <a id="_idIndexMarker1187"/>the required system dependencies on a Debian system.</p>
			<h2 id="_idParaDest-408"><a id="_idTextAnchor413"/>Installing the system dependencies</h2>
			<p>When running Odoo <a id="_idIndexMarker1188"/>from the source, some dependencies need to be installed in the system.</p>
			<p>Before starting, it is a good practice to update the package index and then perform an upgrade to ensure that all installed programs are up to date, as follows:</p>
			<p class="source-code">$ sudo apt update</p>
			<p class="source-code">$ sudo apt upgrade -y</p>
			<p>Next, the <strong class="bold">PostgreSQL</strong> database can be installed. Our user should be made a database superuser so that they have <a id="_idIndexMarker1189"/>administration access to the database. These are the commands for this:</p>
			<p class="source-code">$ sudo apt install postgresql -y</p>
			<p class="source-code">$ sudo su -c "createuser -s $USER" postgres</p>
			<p class="callout-heading">Note</p>
			<p class="callout">Odoo can use an existing PostgreSQL database, which is installed in its own server. If this is the case, the PostgreSQL service does not need to be installed in the Odoo server and the corresponding connection details should be set in the Odoo configuration file.</p>
			<p>These are the Debian dependencies required to run Odoo:</p>
			<p class="source-code">$ sudo apt install git python3-dev python3-pip \</p>
			<p class="source-code">python3-wheel python3-venv -y</p>
			<p class="source-code">$ sudo apt install build-essential libpq-dev libxslt-dev \</p>
			<p class="source-code">libzip-dev libldap2-dev libsasl2-dev libssl-dev</p>
			<p>To have report printing capabilities, <strong class="source-inline">wkhtmltox</strong> must be installed. The recommended version for Odoo 10 and later is 0.12.5-1. The download links can be found at <a href="https://github.com/wkhtmltopdf/wkhtmltopdf/releases/tag/0.12.5">https://github.com/wkhtmltopdf/wkhtmltopdf/releases/tag/0.12.5</a>. The Ubuntu <strong class="bold">code names</strong> are <strong class="bold">bionic</strong> for version 18.04 and <strong class="bold">focal</strong> for version 20.04.</p>
			<p>The following commands perform this installation for Ubuntu 20.04 Focal:</p>
			<p class="source-code">$ wget "https://github.com/wkhtmltopdf/wkhtmltopdf\</p>
			<p class="source-code">/releases""/download/0.12.5/\</p>
			<p class="source-code">wkhtmltox_0.12.5-1.focal_amd64.deb" \</p>
			<p class="source-code">-O /tmp/wkhtml.deb</p>
			<p class="source-code">$ sudo dpkg -i /tmp/wkhtml.deb</p>
			<p class="source-code">$ sudo apt-get -fy install  # Fix dependency errors</p>
			<p>The package installation <a id="_idIndexMarker1190"/>may report missing dependencies errors. In this case, the last command will force the installation of those dependencies and correctly complete the installation.</p>
			<p>Next, you will create a system user to be used for the Odoo processes.</p>
			<h2 id="_idParaDest-409"><a id="_idTextAnchor414"/>Preparing a dedicated system user</h2>
			<p>A good security practice is <a id="_idIndexMarker1191"/>to run Odoo using a dedicated user, who has no special privileges on the host system.</p>
			<p>A popular choice for this username is <strong class="source-inline">odoo</strong>. This is the command to create it:</p>
			<p class="source-code">$ sudo adduser --home=/opt/odoo --disabled-password \</p>
			<p class="source-code">--gecos "Odoo" odoo</p>
			<p>Linux system users can have a <strong class="source-inline">home</strong> directory. For the Odoo user, this is a convenient place to store the Odoo files. A popular choice for this is <strong class="source-inline">/opt/odoo</strong>. The <strong class="source-inline">--home</strong> option used automatically creates this directory and sets it as the <strong class="source-inline">odoo</strong> user home.</p>
			<p>This user does not have access to the PostgreSQL database yet. The following commands add that access and create the database for it to initialize the Odoo production environment:</p>
			<p class="source-code">$ sudo su -c "createuser odoo" postgres</p>
			<p class="source-code">$ createdb --owner=odoo odoo-prod</p>
			<p>Here, <strong class="source-inline">odoo</strong> is the username and <strong class="source-inline">odoo-prod</strong> is the name of the database to support our Odoo instance. The <strong class="source-inline">odoo</strong> user was made the owner of the <strong class="source-inline">odoo-prod</strong> database. This means that it has <em class="italic">create and drop</em> privileges over that database, including the ability to drop it.</p>
			<p class="callout-heading">Tip</p>
			<p class="callout">To run, Odoo does not require elevated privileges to the database being used. These may only be needed for some maintenance operations, such as installing or upgrading modules. So, for improved security, the Odoo system user can be a non-owner database user. Note that in this case, the maintenance should be done running Odoo with a different user than the owner of the database.</p>
			<p>To start a session with the Odoo system user, use the following command:</p>
			<p class="source-code">$ sudo su - odoo</p>
			<p class="source-code">$ exit</p>
			<p>This will be used to run <a id="_idIndexMarker1192"/>installation steps as the Odoo user. When done, the <strong class="source-inline">exit</strong> command terminates that session and returns to the original user.</p>
			<p>In the next section, we will continue with the installation of the Odoo code and <strong class="bold">Python</strong> dependencies in the <strong class="source-inline">/opt/odoo</strong> directory.</p>
			<h1 id="_idParaDest-410"><a id="_idTextAnchor415"/>Installing Odoo from source code</h1>
			<p>While Odoo provides <a id="_idIndexMarker1193"/>Debian/Ubuntu and CentOS/RHEL system <a id="_idIndexMarker1194"/>packages, installing from source code is a popular option due to the flexibility and control it provides.</p>
			<p>Using source code provides better control over what is deployed and makes it easier to manage changes and fixes once in production. For example, it allows us to tie the deployment process to a Git workflow.</p>
			<p>At this point, the Odoo system dependencies are already installed, and the database is ready to use. Now, the Odoo source code can be downloaded and installed, along with the required Python dependencies.</p>
			<p>Let's see how to download the Odoo source code.</p>
			<h2 id="_idParaDest-411"><a id="_idTextAnchor416"/>Downloading the Odoo source code</h2>
			<p>Sooner or later, your server will need upgrades and patches. A version control repository can be of great <a id="_idIndexMarker1195"/>help when this time comes. We use <strong class="source-inline">git</strong> to get our code from a repository, just like we did when installing the development environment.</p>
			<p>Next, we'll impersonate the <strong class="source-inline">odoo</strong> user and download the code into its home directory, as follows:</p>
			<p class="source-code">$ sudo su - odoo</p>
			<p class="source-code">$ git clone https://github.com/odoo/odoo.git \</p>
			<p class="source-code">/opt/odoo/odoo15 \</p>
			<p class="source-code">-b 15.0 --depth=1</p>
			<p>The <strong class="source-inline">-b</strong> option ensures that we get the right branch, and the <strong class="source-inline">--depth=1</strong> option retrieves only the latest code revision, ignoring the (long) change history and making the download smaller and faster.</p>
			<p class="callout-heading">Tip</p>
			<p class="callout"><strong class="bold">Git</strong> is an important tool to manage code versions of your Odoo deployments. If you're not familiar with Git, it is worth <a id="_idIndexMarker1196"/>learning more about it. A good starting point is <a href="http://git-scm.com/doc">http://git-scm.com/doc</a>.</p>
			<p>Custom modules will usually also be managed with Git and should also be cloned to the production server. For example, the following code will add the library custom modules into the <strong class="source-inline">/opt/odoo/odoo15/library</strong> directory:</p>
			<p class="source-code">$ git clone https://github.com/PacktPublishing/Odoo-15-Development-Essentials/opt/odoo/library</p>
			<p>The Odoo source code is available on the server, but it can't run yet because the required Python dependencies are not installed yet. Let's install these in the next section.</p>
			<h2 id="_idParaDest-412"><a id="_idTextAnchor417"/>Installing the Python dependencies</h2>
			<p>Once the Odoo source <a id="_idIndexMarker1197"/>code is downloaded, the Python packages required by Odoo should be installed.</p>
			<p>Many of them also have Debian or Ubuntu system packages. The official Odoo installation package for Debian uses them, and the dependency package names can be found in the Odoo source code in the <strong class="source-inline">debian/control</strong> file: <a href="https://github.com/odoo/odoo/blob/15.0/debian/control">https://github.com/odoo/odoo/blob/15.0/debian/control</a>.</p>
			<p>These Python dependencies can also be installed directly from the <strong class="bold">Python Package Index</strong> (<strong class="bold">PyPI</strong>). Doing this <a id="_idIndexMarker1198"/>using a Python <strong class="bold">virtual environment</strong> provides better <a id="_idIndexMarker1199"/>protection from changes being made to the host system.</p>
			<p>The following commands create a virtual environment, activate it, and then install Odoo from source, along with all the required Python dependencies:</p>
			<p class="source-code">$ python3 -m venv /opt/odoo/env15</p>
			<p class="source-code">$ source /opt/odoo/env15/bin/activate</p>
			<p class="source-code">(env15) $ pip install -r /opt/odoo/odoo15/requirements.txt</p>
			<p class="source-code">(env15) $ pip install -e /opt/odoo/odoo15</p>
			<p>And Odoo should be ready now. Any of the following commands can be used to confirm this:</p>
			<p class="source-code">(env15) $ odoo --version</p>
			<p class="source-code">Odoo Server 15.0</p>
			<p class="source-code">(env15) $ /opt/odoo/odoo15/odoo-bin --version</p>
			<p class="source-code">Odoo Server 15.0</p>
			<p class="source-code">$ /opt/odoo/env15/bin/python3 /opt/odoo/odoo15/odoo-bin --version</p>
			<p class="source-code">Odoo Server 15.0</p>
			<p class="source-code">$ /opt/odoo/env15/bin/odoo --version</p>
			<p class="source-code">Odoo Server 15.0</p>
			<p>Let's understand these commands one by one:</p>
			<ul>
				<li>The first command relies on the <strong class="source-inline">odoo</strong> command made available by <strong class="source-inline">pip install -e /opt/odoo/odoo15</strong>.</li>
				<li>The second command does not rely on the <strong class="source-inline">odoo</strong> command, and it directly calls the Odoo start script, <strong class="source-inline">/opt/odoo/odoo15/odoo-bin</strong>.</li>
				<li>The third command does not need the virtual environment to be activated beforehand, as it uses <a id="_idIndexMarker1200"/>the corresponding Python executable directly, which has the same effect.</li>
				<li>The final command does the same in a more compact way. It uses directly the <strong class="source-inline">odoo</strong> command available in that virtual environment. This can be useful for some scripts.</li>
			</ul>
			<p>Odoo is now ready to run. The next step is to take care of the configuration file to use, which we will explain in the following section.</p>
			<h1 id="_idParaDest-413"><a id="_idTextAnchor418"/>Configuring Odoo</h1>
			<p>Once Odoo is installed, the configuration <a id="_idIndexMarker1201"/>file to be used by the production service needs to be prepared.</p>
			<p>The next sub-section provides guidance on how to do this.</p>
			<h2 id="_idParaDest-414"><a id="_idTextAnchor419"/>Setting up the configuration file</h2>
			<p>Configuration files <a id="_idIndexMarker1202"/>are expected to be in the <strong class="source-inline">/etc</strong> system directory. So, the Odoo production configuration file will be stored at <strong class="source-inline">/etc/odoo/odoo.conf</strong>.</p>
			<p>To make it easier to see all of the available options, a default configuration file can be generated. This should be done by the user that will run the service.</p>
			<p>If not done yet, create a session for the <strong class="source-inline">odoo</strong> user and activate the virtual environment:</p>
			<p class="source-code">$ sudo su - odoo</p>
			<p class="source-code">$ python3 -m venv /opt/odoo/env15</p>
			<p>Now, the following command can be used to create a default configuration file:</p>
			<p class="source-code">(env15) $ odoo -c /opt/odoo/odoo.conf --save --stop-after-init</p>
			<p>In the previous command, the <strong class="source-inline">-c</strong> option sets the location of the configuration file. If not given, it defaults to <strong class="source-inline">~/.odoorc</strong>. The <strong class="source-inline">--save</strong> option writes the options to it. If the file does not exist, it will be created with all default options. If it already exists, it will be updated with the options used in the command.</p>
			<p>The following commands set a few important options for it:</p>
			<p class="source-code">(env15) $ odoo -c /opt/odoo/odoo.conf --save \</p>
			<p class="source-code">--stop-after-init \</p>
			<p class="source-code">-d odoo-prod --db-filter="^odoo-prod$" \</p>
			<p class="source-code">--without-demo=all --proxy-mode</p>
			<p>The options set are as follows:</p>
			<ul>
				<li><strong class="source-inline">-d</strong>: This is the default database to use.</li>
				<li><strong class="source-inline">--db-filter</strong>: This is a regular expression filtering the databases available for the Odoo service. The expression used makes available only the <strong class="source-inline">odoo-prod</strong> database.</li>
				<li><strong class="source-inline">--without-demo=all</strong>: This disables demonstration data so that the Odoo initialized databases start clean.</li>
				<li><strong class="source-inline">--proxy-mode</strong>: This enables the proxy mode, meaning that Odoo should expect requests forwarded from a reverse proxy.</li>
			</ul>
			<p>The next step is to <a id="_idIndexMarker1203"/>copy this default file to the <strong class="source-inline">/etc</strong> directory and set the necessary access rights so that the Odoo user can read it:</p>
			<p class="source-code">$ exit  # exit from the odoo user session</p>
			<p class="source-code">$ sudo mkdir /etc/odoo</p>
			<p class="source-code">$ sudo cp /opt/odoo/odoo.conf /etc/odoo/odoo.conf</p>
			<p class="source-code">$ sudo chown -R odoo /etc/odoo</p>
			<p class="source-code">$ sudo chmod u=r,g=rw,o=r /etc/odoo/odoo.conf  # for extra hardening</p>
			<p>The last command ensures that the user running the Odoo process can read but can't change the configuration file, thereby providing better security.</p>
			<p>The Odoo log file directory also needs to be created and given access to the <strong class="source-inline">odoo</strong> user. This should go inside the <strong class="source-inline">/var/log</strong> directory. The following commands do this:</p>
			<p class="source-code">$ sudo mkdir /var/log/odoo</p>
			<p class="source-code">$ sudo chown odoo /var/log/odoo</p>
			<p>Finally, the Odoo configuration file should be edited to ensure that a few important parameters <a id="_idIndexMarker1204"/>are correctly configured. For example, the following command opens the file using the <strong class="source-inline">nano</strong> editor:</p>
			<p class="source-code">$ sudo nano /etc/odoo/odoo.conf</p>
			<p>These are the suggested values for some of the most important parameters:</p>
			<p class="source-code">[options]</p>
			<p class="source-code">addons_path = /opt/odoo/odoo15/odoo/addons,/opt/odoo/odoo15/addons,/opt/odoo/library</p>
			<p class="source-code">admin_passwd = StrongRandomPassword</p>
			<p class="source-code">db_name = odoo-prod</p>
			<p class="source-code">dbfilter = ^odoo-prod$</p>
			<p class="source-code">http_interface = 127.0.0.1</p>
			<p class="source-code">http_port = 8069</p>
			<p class="source-code">limit_time_cpu = 600</p>
			<p class="source-code">limit_time_real = 1200</p>
			<p class="source-code">list_db = False</p>
			<p class="source-code">logfile = /var/log/odoo/odoo-server.log</p>
			<p class="source-code">proxy_mode = True</p>
			<p class="source-code">without_demo = all</p>
			<p class="source-code">workers = 6</p>
			<p>Let's explain them in detail:</p>
			<ul>
				<li><strong class="source-inline">addons_path</strong>: This is a comma-separated list of the paths where add-on modules will be looked up. It's read from left to right, with the leftmost directories considered a higher priority.</li>
				<li><strong class="source-inline">admin_passwd</strong>: This is the master password used to access the web client database management functions. It's critical to set this with a strong password or, even better, to set it to <strong class="source-inline">False</strong> to deactivate the function.</li>
				<li><strong class="source-inline">db_name</strong>: This is the database instance to initialize during the server startup sequence.</li>
				<li><strong class="source-inline">dbfilter</strong>: This is a filter for the databases to be made accessible. It's a Python-interpreted regex expression. For the user not to be prompted to select a database and for unauthenticated URLs to work properly, it should be set with <strong class="source-inline">^dbname$</strong>, for example, <strong class="source-inline">dbfilter=^odoo-prod$</strong>. It supports the <strong class="source-inline">%h</strong> and <strong class="source-inline">%d</strong> placeholders, which are replaced by the HTTP request hostname and subdomain name.</li>
				<li><strong class="source-inline">http_interface</strong>: This is the TCP/IP address Odoo will listen to. By default, it is <strong class="source-inline">0.0.0.0</strong>, meaning all addresses. For a deployment behind a reverse proxy, this can be set <a id="_idIndexMarker1205"/>to the reverse proxy address so that only requests from there are considered. Use <strong class="source-inline">127.0.0.1</strong> if the reverse proxy is in the same server as the Odoo service.</li>
				<li><strong class="source-inline">http_port</strong>: This is the port number at which the server will listen. By default, port <strong class="source-inline">8069</strong> is used.</li>
				<li><strong class="source-inline">limit_time_cpu</strong> / <strong class="source-inline">limit_time_real</strong>: This sets CPU time limits for the workers. The default settings, <strong class="source-inline">60</strong> and <strong class="source-inline">120</strong>, may be too low, and it could be convenient to increase them.</li>
				<li><strong class="source-inline">list_db = False</strong>: This blocks database listing, both at the <strong class="bold">remote procedure calls</strong> (<strong class="bold">RPCs</strong>)-level and in the UI, and it blocks the database management screens and <a id="_idIndexMarker1206"/>the underlying RPC functions.</li>
				<li><strong class="source-inline">logfile</strong>:  This is where the server log should be written. For system services, the expected location is somewhere inside <strong class="source-inline">/var/log</strong>. If left empty, the log prints to standard output instead.</li>
				<li><strong class="source-inline">proxy_mode</strong>: This should be set to <strong class="source-inline">True</strong> when Odoo is accessed behind a reverse proxy, as we will be doing.</li>
				<li><strong class="source-inline">without_demo</strong>: This should be set to <strong class="source-inline">all</strong> in production environments so that new databases don't have demo data on them.</li>
				<li><strong class="source-inline">workers</strong>: This, with a value of two or more, enables the multiprocessing mode. We'll discuss this in more detail shortly.</li>
			</ul>
			<p>From a security <a id="_idIndexMarker1207"/>point of view, the <strong class="source-inline">admin_passwd</strong> and <strong class="source-inline">list_db=False</strong> options are particularly important. They block web access to the database management features and should be set in any production or internet-facing Odoo server.</p>
			<p class="callout-heading">Tip</p>
			<p class="callout">The <strong class="source-inline">openssl rand -base64 32</strong> command can be used to generate a random password in the command line. Change the <strong class="source-inline">32</strong> number to whatever password size you prefer.</p>
			<p>The following parameters can also be helpful:</p>
			<ul>
				<li><strong class="source-inline">data_dir</strong>: This is the path where session data and attachment files are stored; remember to keep backups of this directory.</li>
				<li><strong class="source-inline">http_interface</strong>: This sets the addresses that will be listened to. By default, it listens to <strong class="source-inline">0.0.0.0</strong>, but when using a reverse proxy, it can be set to <strong class="source-inline">127.0.0.1</strong> in order to respond to local requests only.</li>
			</ul>
			<p>We can check the effect of the configuration made by running the Odoo manually, as follows:</p>
			<p class="source-code">$ sudo su - odoo</p>
			<p class="source-code">$ source /opt/odoo/env15/bin/activate</p>
			<p class="source-code">$ odoo -c /etc/odoo/odoo.conf</p>
			<p>The last command will not display any output to the console, as log messages are being written to the log file instead of to the standard output.</p>
			<p>To follow the log for a running Odoo server, the <strong class="source-inline">tail</strong> command can be used:</p>
			<p class="source-code">$ tail -f /var/log/odoo/odoo-server.log</p>
			<p>This can be <a id="_idIndexMarker1208"/>done from a different terminal window while the manual command is running in the original terminal.</p>
			<p>To run multiple terminal sessions on the same terminal window, you can use <strong class="bold">multiplexing</strong> applications such as <strong class="source-inline">tmux</strong> or <strong class="bold">GNU</strong> <strong class="source-inline">screen</strong>. Ubuntu also has available <a id="_idIndexMarker1209"/>the <strong class="bold">Byobu</strong> utility, which is a wrapper for <strong class="source-inline">tmux</strong> or <strong class="source-inline">screen</strong>. For more <a id="_idIndexMarker1210"/>details, see <a href="https://help.ubuntu.com/community/Byobu">https://help.ubuntu.com/community/Byobu</a>.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">Unfortunately, the <strong class="source-inline">logfile</strong> configuration option can't be unset directly from the Odoo command. If we want to temporarily send the log output back to the standard output, the best solution is to use a copy of the configuration file without the <strong class="source-inline">logfile</strong> option set.</p>
			<p>It may be the case that the <strong class="source-inline">odoo-prod</strong> database has not been initialized by Odoo and that this needs to be done manually. In this case, the initialization can be done by installing the <strong class="source-inline">base</strong> module:</p>
			<p class="source-code">$ /opt/odoo/env15/bin/odoo -c /etc/odoo/odoo.conf -i base \</p>
			<p class="source-code">--stop-after-init</p>
			<p>At this point, the Odoo configuration should be ready. Before continuing, it is worth learning more about the multiprocessing workers in Odoo.</p>
			<h2 id="_idParaDest-415"><a id="_idTextAnchor420"/>Understanding multiprocessing workers</h2>
			<p>A production instance <a id="_idIndexMarker1211"/>is expected to handle a significant workload. By default, the server runs one process and can use only one CPU core for processing due to the Python language <strong class="bold">Global Interpreter Lock</strong> (<strong class="bold">GIL</strong>). However, a multiprocessing <a id="_idIndexMarker1212"/>mode is available so that concurrent requests can be handled, allowing us to take advantage of multiple cores.</p>
			<p>The <strong class="source-inline">workers=N</strong> option sets the number of worker processes to use. As a guideline, it can be set to <strong class="source-inline">1+2*P</strong>, where <strong class="source-inline">P</strong> is the number of processor cores. Finding the best setting might involve some experimentation by using different numbers and checking how busy the server processors are. Having PostgreSQL running on the same machine also has an impact on this, and this will reduce the number of workers that should be enabled.</p>
			<p>It is better to set workers that are too high for the load rather than too low. The minimum should be six, due to the parallel connections used by most browsers. The maximum is generally limited by the amount of RAM on the machine, as each worker will consume some server memory. As a rule of thumb for normal usage patterns, the Odoo server should be able to handle <strong class="source-inline">(1+2*P)*6</strong> simultaneous users, where <strong class="source-inline">P</strong> is the number of processors.</p>
			<p>There are a few <strong class="source-inline">limit-</strong> configuration parameters that can be used to tune workers. Workers are recycled when they reach these limits, where the corresponding process is stopped and a new one is started. This protects the server from memory leaks and particular processes overloading the server resources.</p>
			<p>The official <a id="_idIndexMarker1213"/>documentation provides additional advice on how to tune the worker parameters. It can be found at <a href="https://www.odoo.com/documentation/15.0/setup/deploy.html#builtin-server">https://www.odoo.com/documentation/15.0/setup/deploy.html#builtin-server</a>.</p>
			<p>At this point, Odoo is installed, configured, and ready to run. The next step is to have it running as an unattended system service. Let's look at this in detail in the next section.</p>
			<h1 id="_idParaDest-416"><a id="_idTextAnchor421"/>Setting up Odoo as a system service</h1>
			<p>Odoo should run <a id="_idIndexMarker1214"/>as a system service so that it is automatically started when the system boots and runs unattended, not requiring a user session.</p>
			<p>In Debian/Ubuntu systems, the <strong class="source-inline">init</strong> system is responsible for starting services. Historically, Debian and its derived operating systems used <strong class="source-inline">sysvinit</strong>. This has changed, and recent Debian/Ubuntu systems use <strong class="source-inline">systemd</strong>. This is true for Ubuntu 16.04 and later.</p>
			<p>To confirm that <strong class="source-inline">systemd</strong> is used in your system, try the following command:</p>
			<p class="source-code">$ man init</p>
			<p>This command opens the documentation for the current <strong class="source-inline">init</strong> system in use, so you can check <a id="_idIndexMarker1215"/>what is being used. At the top of the manual page, you should see <strong class="source-inline">SYSTEMD</strong> mentioned.</p>
			<p>Let's continue with the <strong class="source-inline">systemd</strong> service configuration.</p>
			<h2 id="_idParaDest-417"><a id="_idTextAnchor422"/>Creating a systemd service</h2>
			<p>If the operating system <a id="_idIndexMarker1216"/>is recent – such as Debian 8 and Ubuntu 16.04 or later – <strong class="source-inline">systemd</strong> should be the <strong class="source-inline">init</strong> system being used.</p>
			<p>To add a new service to the system, simply create a file describing it. Create a <strong class="source-inline">/lib/systemd/system/odoo.service</strong> file with the following content:</p>
			<p class="source-code">[Unit]</p>
			<p class="source-code">Description=Odoo Open Source ERP and CRM</p>
			<p class="source-code">After=network.target</p>
			<p class="source-code">[Service]</p>
			<p class="source-code">Type=simple</p>
			<p class="source-code">User=odoo</p>
			<p class="source-code">Group=odoo</p>
			<p class="source-code">ExecStart=/opt/odoo/env/bin/odoo -c /etc/odoo/odoo.conf --log-file=/var/log/odoo/odoo-server.log</p>
			<p class="source-code">KillMode=mixed</p>
			<p class="source-code">[Install]</p>
			<p class="source-code">WantedBy=multi-user.target</p>
			<p>This service configuration file is based on the sample provided in the Odoo source code, which can be found at <a href="https://github.com/odoo/odoo/blob/15.0/debian/odoo.service">https://github.com/odoo/odoo/blob/15.0/debian/odoo.service</a>. The <strong class="source-inline">ExecStart</strong> option should be adjusted to the specific paths to use in this system.</p>
			<p>Next, the new service can be registered with the following command:</p>
			<p class="source-code">$ sudo systemctl enable odoo.service</p>
			<p>To start this new service, run the following:</p>
			<p class="source-code">$ sudo systemctl start odoo</p>
			<p>To check its status, use the following:</p>
			<p class="source-code">$ sudo systemctl status odoo</p>
			<p>And it can be stopped using the following command:</p>
			<p class="source-code">$ sudo systemctl stop odoo</p>
			<p>When running <a id="_idIndexMarker1217"/>Odoo as a system service, it is useful to confirm that the client can access it. Let's see how that can be done from the command line.</p>
			<h2 id="_idParaDest-418"><a id="_idTextAnchor423"/>Checking the Odoo service from the command line</h2>
			<p>To confirm that <a id="_idIndexMarker1218"/>the Odoo service is up and responsive, we can <a id="_idIndexMarker1219"/>check that it is responding to requests. We should be able to get a response from it and see no errors in the log file.</p>
			<p>We can check whether Odoo is responding to HTTP requests inside the server by using the following command:</p>
			<p class="source-code">$ curl http://localhost:8069</p>
			<p class="source-code">&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN"&gt;</p>
			<p class="source-code">&lt;title&gt;Redirecting...&lt;/title&gt;</p>
			<p class="source-code">&lt;h1&gt;Redirecting...&lt;/h1&gt;</p>
			<p class="source-code">&lt;p&gt;You should be redirected automatically to target URL: &lt;a href="/web"&gt;/web&lt;/a&gt;.  If not click the link.</p>
			<p>In addition, to see what is in the <strong class="source-inline">log</strong> file, use the following command:</p>
			<p class="source-code">$ less /var/log/odoo/odoo-server.log</p>
			<p>To follow <a id="_idIndexMarker1220"/>what is being added to the log file <a id="_idIndexMarker1221"/>live, <strong class="source-inline">tail -f</strong> can be used, as follows:</p>
			<p class="source-code">$ tail -f /var/log/odoo/odoo-server.log</p>
			<p>Odoo is now installed and running as a service. Next, the setup can be improved by adding a reverse proxy. The next section explains this.</p>
			<h1 id="_idParaDest-419"><a id="_idTextAnchor424"/>Setting up an Nginx reverse proxy</h1>
			<p>While Odoo itself <a id="_idIndexMarker1222"/>can serve web pages, it is recommended to have a reverse proxy in front of it. A reverse proxy receives the traffic from the clients and then forwards it to the Odoo servers responding to them. Doing this has several benefits.</p>
			<p>On the security side, it can provide the following:</p>
			<ul>
				<li>Handle (and enforce) HTTPS protocols to encrypt traffic.</li>
				<li>Hide the internal network characteristics.</li>
				<li>Act as an application firewall, limiting the URLs accepted for processing.</li>
			</ul>
			<p>On the performance side, it can provide the following:</p>
			<ul>
				<li>Cache static content, avoiding burdening the Odoo services with these requests and thereby reducing their load.</li>
				<li>Compress content to speed up loading time.</li>
				<li>Act as a load balancer, distributing load between several Odoo services.</li>
			</ul>
			<p>There are several options that can serve as a reverse proxy. Historically, <strong class="bold">Apache</strong> has been a popular choice. In recent years, Nginx has become widely used and is referred to in the Odoo official documentation. In our example, Nginx will be used for a reverse proxy, and the presented security and performance features will be implemented with it.</p>
			<p>First, Nginx should be installed and set to be listening on the default HTTP port. It is possible that this port is already being used by another installed service. To ensure that the port is free and available, use the following command, which should result in an error:</p>
			<p class="source-code">$ curl http://localhost</p>
			<p class="source-code">curl: (7) Failed to connect to localhost port 80: Connection refused</p>
			<p>If it does not return the previous error message, an installed service is using port <strong class="source-inline">80</strong> and should be disabled or uninstalled.</p>
			<p>For example, if an <a id="_idIndexMarker1223"/>Apache server is installed, use the <strong class="source-inline">sudo service apache2 stop</strong> command to stop it, or even uninstall it with the <strong class="source-inline">sudo apt remove apache2</strong> command.</p>
			<p>With port <strong class="source-inline">80</strong> free, Nginx can be installed and configured. The following command installs Nginx:</p>
			<p class="source-code">$ sudo apt-get install nginx</p>
			<p class="source-code">$ sudo service nginx start  # start nginx, if not already started</p>
			<p>To confirm that <strong class="source-inline">nginx</strong> is working correctly, visit the server address with a browser or with the <strong class="source-inline">curl http://localhost</strong> command in the server. This should return a <strong class="bold">Welcome to nginx</strong> page.</p>
			<p>The Nginx configuration files are stored at <strong class="source-inline">/etc/nginx/available-sites/</strong> and are activated by adding them to <strong class="source-inline">/etc/nginx/enabled-sites/</strong>, which is usually done with a symbolic link to the file in the available sites directory.</p>
			<p>To prepare for the Odoo Nginx configuration, the default configuration should be removed and an Odoo configuration file added, as follows:</p>
			<p class="source-code">$ sudo rm /etc/nginx/sites-enabled/default</p>
			<p class="source-code">$ sudo touch /etc/nginx/sites-available/odoo</p>
			<p class="source-code">$ sudo ln -s /etc/nginx/sites-available/odoo \</p>
			<p class="source-code">/etc/nginx/sites-enabled/odoo</p>
			<p>Next, using an editor such as <strong class="source-inline">nano</strong> or <strong class="source-inline">vi</strong>, edit the configuration file as follows:</p>
			<p class="source-code">$ sudo nano /etc/nginx/sites-available/odoo</p>
			<p>The following <a id="_idIndexMarker1224"/>example provides a basic Nginx configuration for Odoo:</p>
			<p class="source-code">upstream odoo {</p>
			<p class="source-code">  server 127.0.0.1:8069;</p>
			<p class="source-code">}</p>
			<p class="source-code">upstream odoochat {</p>
			<p class="source-code">  server 127.0.0.1:8072;</p>
			<p class="source-code">}</p>
			<p class="source-code">server {</p>
			<p class="source-code">  listen 80;</p>
			<p class="source-code">  server_name odoo.mycompany.com;</p>
			<p class="source-code">  proxy_read_timeout 720s;</p>
			<p class="source-code">  proxy_connect_timeout 720s;</p>
			<p class="source-code">  proxy_send_timeout 720s;</p>
			<p class="source-code">  # Add Headers for odoo proxy mode</p>
			<p class="source-code">  proxy_set_header X-Forwarded-Host  $host;</p>
			<p class="source-code">  proxy_set_header X-Forwarded-For   $proxy_add_x_</p>
			<p class="source-code">    forwarded_for;</p>
			<p class="source-code">  proxy_set_header X-Forwarded-Proto $scheme;</p>
			<p class="source-code">  proxy_set_header X-Real-IP         $remote_addr;</p>
			<p class="source-code">  # log</p>
			<p class="source-code">  access_log /var/log/nginx/odoo.access.log;</p>
			<p class="source-code">  error_log /var/log/nginx/odoo.error.log;</p>
			<p class="source-code">  # Redirect longpoll requests to odoo longpolling port</p>
			<p class="source-code">  location /longpolling {</p>
			<p class="source-code">    proxy_pass http://odoochat;</p>
			<p class="source-code">  }</p>
			<p class="source-code">  # Redirect requests to odoo backend server</p>
			<p class="source-code">  location / {</p>
			<p class="source-code">    proxy_redirect off;</p>
			<p class="source-code">    proxy_pass http://odoo;</p>
			<p class="source-code">  }</p>
			<p class="source-code">  # common gzip</p>
			<p class="source-code">  gzip_types text/css text/scss text/plain text/xml </p>
			<p class="source-code">   application/xml application/json application/javascript;</p>
			<p class="source-code">  gzip on;</p>
			<p class="source-code">}</p>
			<p>At the top of the configuration file, there are the <strong class="source-inline">upstream</strong> configuration sections. These point to the Odoo service, which is listening on ports <strong class="source-inline">8069</strong> and <strong class="source-inline">8072</strong> by default. The <strong class="source-inline">8069</strong> port serves the web client and RPC requests, and <strong class="source-inline">8072</strong> serves the long polling requests used by instant messaging features.</p>
			<p>The <strong class="source-inline">server</strong> configuration section defines what happens to the traffic received on the <strong class="source-inline">80</strong> default HTTP port. Here, it is redirected to upstream Odoo services with the <strong class="source-inline">proxy_pass</strong> configuration <a id="_idIndexMarker1225"/>directive. Any traffic for the <strong class="source-inline">/longpolling</strong> address is passed on to the <strong class="source-inline">odoochat</strong> upstream, and the <strong class="source-inline">/</strong> remaining traffic is passed on to the <strong class="source-inline">odoo</strong> upstream.</p>
			<p>A few <strong class="source-inline">proxy_set_header</strong> directives add information to the request header to let the Odoo backend service know that it is being proxied.</p>
			<p class="callout-heading">Tip</p>
			<p class="callout">For security reasons, it is important for Odoo to ensure that the <strong class="source-inline">proxy_mode</strong> parameter is set to <strong class="source-inline">True</strong>. The reason for this is that with Nginx, all requests hitting Odoo are coming from the Nginx server instead of the original remote IP address. Setting the <strong class="source-inline">X-Forwarded-For</strong> header in the proxy and enabling <strong class="source-inline">--proxy-mode</strong> allows Odoo to be aware of the original source of the request. Note that enabling <strong class="source-inline">--proxy-mode</strong> without forcing the header at the proxy level allows malicious clients to spoof their request address.</p>
			<p>At the end of the configuration file, a couple of <strong class="source-inline">gzip</strong>-related directives can be found. These enable the compression of some files, thereby improving performance.</p>
			<p>Once edited and saved, the Nginx configuration can be verified for correctness with the following command:</p>
			<p class="source-code">$ sudo nginx -t</p>
			<p class="source-code">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</p>
			<p class="source-code">nginx: configuration file /etc/nginx/nginx.conf test is successful</p>
			<p>Now, the Nginx service can reload the new configuration, using one of the following commands, depending on the <strong class="source-inline">init</strong> system used:</p>
			<p class="source-code">$ sudo /etc/init.d/nginx reload</p>
			<p class="source-code">$ sudo systemctl reload nginx  # using systemd</p>
			<p class="source-code">$ sudo service nginx reload  # on Ubuntu systems</p>
			<p>This will have <a id="_idIndexMarker1226"/>Nginx reload the configuration used without interrupting the service, as would have happened if <strong class="source-inline">restart</strong> was used instead of <strong class="source-inline">reload</strong>.</p>
			<p>To be properly secured, Odoo should be accessed through HTTPS. The next section will address this.</p>
			<h1 id="_idParaDest-420"><a id="_idTextAnchor425"/>Configuring and enforcing HTTPS</h1>
			<p>Web traffic should <a id="_idIndexMarker1227"/>not travel through the internet in plain text. When exposing <a id="_idIndexMarker1228"/>the Odoo server on a network, HTTPS should be used to encrypt the traffic.</p>
			<p>In some cases, it might be acceptable to use a self-signed certificate. Keep in mind that using a self-signed certificate provides limited security. While it allows for traffic to be encrypted, it has some security limitations, such as not being able to prevent man-in-the-middle attacks, or not being able to present security warnings on recent web browsers.</p>
			<p>A more robust solution is to use a certificate signed by a recognized authority. This is particularly important when running e-commerce websites. Another option is to use a <strong class="bold">Let's Encrypt</strong> certificate, and <a id="_idIndexMarker1229"/>the <strong class="bold">Certbot</strong> program automates getting SSL certificates for it. See <a href="https://certbot.eff.org/instructions">https://certbot.eff.org/instructions</a> to learn more.</p>
			<p>Next, we will see how to create a self-signed certificate, in case this is the preferred choice.</p>
			<h2 id="_idParaDest-421"><a id="_idTextAnchor426"/>Creating a self-signed SSL certificate</h2>
			<p>A certificate needs <a id="_idIndexMarker1230"/>to be installed on Nginx to enable SSL. We can either have one provided by a certificate authority or generate a self-signed one.</p>
			<p>To create a self-signed certificate, use these commands:</p>
			<p class="source-code">$ sudo mkdir /etc/ssl/nginx &amp;&amp; cd /etc/ssl/nginx</p>
			<p class="source-code">$ sudo openssl req -x509 -newkey rsa:2048 \</p>
			<p class="source-code">-keyout server.key -out server.crt -days 365 -nodes</p>
			<p class="source-code">$ sudo chmod a-wx *            # make files read only</p>
			<p class="source-code">$ sudo chown www-data:root *   # access only to www-data group</p>
			<p>The preceding code creates an <strong class="source-inline">/etc/ssl/nginx</strong> directory and a passwordless SSL certificate. When running the <strong class="source-inline">openssl</strong> command, the user will be asked for some additional information, and then a certificate and key files will be generated. Finally, the ownership of <a id="_idIndexMarker1231"/>these files is given to the <strong class="source-inline">www-data</strong> user, which is used to run the web server.</p>
			<p>With an SSL certificate ready to be used, the next step is to install it on the Nginx service.</p>
			<h2 id="_idParaDest-422"><a id="_idTextAnchor427"/>Configuring HTTPS access on Nginx</h2>
			<p>To enforce HTTPS, an <a id="_idIndexMarker1232"/>SSL certificate is needed. The Nginx service <a id="_idIndexMarker1233"/>will use it to encrypt the traffic between the server and the web browser.</p>
			<p>For this, the Odoo Nginx configuration file needs to be revisited. Edit it to replace the <strong class="source-inline">server</strong> directive with the following:</p>
			<p class="source-code">server {</p>
			<p class="source-code">  listen 80;</p>
			<p class="source-code">  rewrite ^(.*) https://$host$1 permanent;</p>
			<p class="source-code">}</p>
			<p>With this change, requests for the <strong class="source-inline">http://</strong> address are converted into <strong class="source-inline">https://</strong> equivalent addresses, ensuring that the non-secure transport is not used by accident.</p>
			<p>The HTTPS service still needs to be configured. This can be done by adding the following <strong class="source-inline">server</strong> directive to the configuration:</p>
			<p class="source-code"># odoo server</p>
			<p class="source-code">upstream odoo {</p>
			<p class="source-code">  server 127.0.0.1:8069;</p>
			<p class="source-code">}</p>
			<p class="source-code">upstream odoochat {</p>
			<p class="source-code">  server 127.0.0.1:8072;</p>
			<p class="source-code">}</p>
			<p class="source-code"># http -&gt; https</p>
			<p class="source-code">server {</p>
			<p class="source-code">  listen 80;</p>
			<p class="source-code">  server_name odoo.mycompany.com;</p>
			<p class="source-code">  rewrite ^(.*) https://$host$1 permanent;</p>
			<p class="source-code">}</p>
			<p class="source-code">server {</p>
			<p class="source-code">  listen 443;</p>
			<p class="source-code">  server_name odoo.mycompany.com;</p>
			<p class="source-code">  proxy_read_timeout 720s;</p>
			<p class="source-code">  proxy_connect_timeout 720s;</p>
			<p class="source-code">  proxy_send_timeout 720s;</p>
			<p class="source-code">  # Add Headers for odoo proxy mode</p>
			<p class="source-code">  proxy_set_header X-Forwarded-Host $host;</p>
			<p class="source-code">  proxy_set_header X-Forwarded-For $proxy_add_x_for</p>
			<p class="source-code">    warded_for;</p>
			<p class="source-code">  proxy_set_header X-Forwarded-Proto $scheme;</p>
			<p class="source-code">  proxy_set_header X-Real-IP $remote_addr;</p>
			<p class="source-code">  # SSL parameters</p>
			<p class="source-code">  ssl on;</p>
			<p class="source-code">  ssl_certificate /etc/ssl/nginx/server.crt;</p>
			<p class="source-code">  ssl_certificate_key /etc/ssl/nginx/server.key;</p>
			<p class="source-code">  ssl_session_timeout 30m;</p>
			<p class="source-code">  ssl_protocols TLSv1.2;</p>
			<p class="source-code">  ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-</p>
			<p class="source-code">    AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-</p>
			<p class="source-code">    RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-</p>
			<p class="source-code">    POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-</p>
			<p class="source-code">    GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;</p>
			<p class="source-code">  ssl_prefer_server_ciphers off;</p>
			<p class="source-code">  # log</p>
			<p class="source-code">  access_log /var/log/nginx/odoo.access.log;</p>
			<p class="source-code">  error_log /var/log/nginx/odoo.error.log;</p>
			<p class="source-code">  # Redirect longpoll requests to odoo longpolling port</p>
			<p class="source-code">  location /longpolling {</p>
			<p class="source-code">    proxy_pass http://odoochat;</p>
			<p class="source-code">  }</p>
			<p class="source-code">  # Redirect requests to odoo backend server</p>
			<p class="source-code">  location / {</p>
			<p class="source-code">    proxy_redirect off;</p>
			<p class="source-code">    proxy_pass http://odoo;</p>
			<p class="source-code">  }</p>
			<p class="source-code">  # common gzip</p>
			<p class="source-code">  gzip_types text/css text/scss text/plain text/xml </p>
			<p class="source-code">   application/xml application/json application/javascript;</p>
			<p class="source-code">  gzip on;</p>
			<p class="source-code">}</p>
			<p>This additional <strong class="source-inline">server</strong> directive <a id="_idIndexMarker1234"/>listens to the HTTPS port and <a id="_idIndexMarker1235"/>uses the certificate files at <strong class="source-inline">/etc/ssl/nginx/</strong> to encrypt the traffic.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">The Nginx configuration <a id="_idIndexMarker1236"/>proposed here is based on the official documentation found at <a href="https://www.odoo.com/documentation/15.0/administration/install/deploy.html#https">https://www.odoo.com/documentation/15.0/administration/install/deploy.html#https</a>.</p>
			<p>Once this configuration is reloaded, Odoo should work through HTTPS only, as shown in the following commands:</p>
			<p class="source-code">$ sudo nginx -t</p>
			<p class="source-code">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</p>
			<p class="source-code">nginx: configuration file /etc/nginx/nginx.conf test is successful</p>
			<p class="source-code">$ sudo service nginx reload  # or: sudo systemctl reload nginx</p>
			<p class="source-code">* Reloading nginx configuration nginx</p>
			<p class="source-code">...done.</p>
			<p class="source-code">$ curl -k https://localhost</p>
			<p>Encrypting the web traffic is not the only thing Nginx can do for us. It can also help to reduce the load on the Odoo upstream service. Let's look at this in detail in the next section.</p>
			<h2 id="_idParaDest-423"><a id="_idTextAnchor428"/>Caching static content</h2>
			<p>Nginx can cache the <a id="_idIndexMarker1237"/>static files served – this means that later requests for the cached files are served directly from Nginx and don't need to be requested by the upstream Odoo service.</p>
			<p>This not only improves response time but also improves the Odoo service capacity to serve more users, as it is now focused on responding to dynamic requests.</p>
			<p>To enable static content caching, add the following section to the Nginx configuration file after the <strong class="source-inline"># comming gzip</strong> directives:</p>
			<p class="source-code">  # cache static data</p>
			<p class="source-code">  location ~* /web/static/ {</p>
			<p class="source-code">    proxy_cache_valid 200 60m;</p>
			<p class="source-code">    proxy_buffering on;</p>
			<p class="source-code">    expires 864000;</p>
			<p class="source-code">    proxy_pass http://odoo;</p>
			<p class="source-code">  }</p>
			<p>With this configuration, static data is cached for 60 minutes. Odoo static content is defined as any file served from the <strong class="source-inline">/web/static</strong> path.</p>
			<p>At this point, the server should be fully functional, with Nginx handling requests through HTTPS and then handing them over to the Odoo service for processing.</p>
			<p>The Odoo service will require maintenance and updates, so the next section discusses how to do this.</p>
			<h1 id="_idParaDest-424"><a id="_idTextAnchor429"/>Maintaining the Odoo service and modules</h1>
			<p>Once the Odoo server is <a id="_idIndexMarker1238"/>up and running, it is expected for some maintenance to <a id="_idIndexMarker1239"/>be needed – for example, installing or updating modules.</p>
			<p>These actions involve some risk for the production system, and it is best to test them in a staging environment before applying in production. Let's start with a basic recipe to create a staging environment.</p>
			<h2 id="_idParaDest-425"><a id="_idTextAnchor430"/>Creating a staging environment</h2>
			<p>The staging environment should <a id="_idIndexMarker1240"/>be a copy of the production system and ideally should have its own dedicated server.</p>
			<p>A simplification, which is safe enough for most cases, is to have the staging environment in the same server as the production system.</p>
			<p>To create a copy of the <strong class="source-inline">odoo-prod</strong> production database as the <strong class="source-inline">odoo-stage</strong> database, use the following commands:</p>
			<p class="source-code">$ dropdb odoo-stage</p>
			<p class="source-code">$ createdb --owner=odoo odoo-stage</p>
			<p class="source-code">$ pg_dump odoo-prod | psql -d odoo-stage</p>
			<p class="source-code">$ sudo su - odoo</p>
			<p class="source-code">$ cd ~/.local/share/Odoo/filestore/</p>
			<p class="source-code">$ cp -r odoo-prod odoo-stage</p>
			<p class="source-code">$ exit</p>
			<p>Note that some configurations are copied over, such as the connections to email servers, and you may want to have additional commands disabling them. The specific actions needed to do this depend on the database setup, but it's likely they can be automated by a script. For this, it is good to know that the <strong class="source-inline">psql</strong> command can be used to run SQL directly from the command line, for example, <strong class="source-inline">psql -d odoo-stage -c "&lt;SQL command&gt;"</strong>.</p>
			<p class="callout-heading">Tip</p>
			<p class="callout">A database copy can be made in a much faster way using the following command:</p>
			<p class="callout"><strong class="source-inline">$ createdb --owner=odoo --template=odoo-prod odoo-stage</strong>.</p>
			<p class="callout">The caveat here is that in order for it to run, there can't be any open connections to the <strong class="source-inline">odoo-prod</strong> database, so the Odoo production server needs to be stopped before the command can be used.</p>
			<p>Now that we have a copy of the production database for staging, the next step is to create a copy of the source to be used. This can be in a subdirectory called <strong class="source-inline">/opt/odoo/stage</strong>, for example.</p>
			<p>The following shell commands copy the relevant files and create the staging environment:</p>
			<p class="source-code">$ sudo su - odoo</p>
			<p class="source-code">$ mkdir /opt/odoo/stage</p>
			<p class="source-code">$ cp -r /opt/odoo/odoo15/ /opt/odoo/stage/</p>
			<p class="source-code">$ cp -r /opt/odoo/library/ /opt/odoo/stage/  # custom code</p>
			<p class="source-code">$ python3 -m venv /opt/odoo/env-stage</p>
			<p class="source-code">$ source /opt/odoo/env-stage/bin/activate</p>
			<p class="source-code">(env-stage) $ pip install -r \</p>
			<p class="source-code">/opt/odoo/stage/odoo15/requirements.txt</p>
			<p class="source-code">(env-stage) $ pip install -e /opt/odoo/stage/odoo15</p>
			<p class="source-code">(env-stage) $ exit</p>
			<p>Finally, a specific Odoo configuration file should be prepared for the staging environment, as the <a id="_idIndexMarker1241"/>path to the files used is different. The HTTP ports used should also be changed so that the staging environment can run at the same time as the main production service.</p>
			<p>This staging environment can now be used for testing purposes. So, the next section describes how a production update would be applied.</p>
			<h2 id="_idParaDest-426"><a id="_idTextAnchor431"/>Updating Odoo source code</h2>
			<p>Odoo and custom <a id="_idIndexMarker1242"/>module code will usually have versions managed through Git.  </p>
			<p>To get the latest Odoo source code from the GitHub repository, use the <strong class="source-inline">git pull</strong> command. Before doing that, the <strong class="source-inline">git tag</strong> command can be used to create a tag for the current commit being used so that it's easier to revert the code update, as follows:</p>
			<p class="source-code">$ sudo su - odoo</p>
			<p class="source-code">$ cd /opt/odoo/odoo15</p>
			<p class="source-code">$ git tag --force 15-last-prod</p>
			<p class="source-code">$ git pull</p>
			<p class="source-code">$ exit</p>
			<p>For code changes to take effect, the Odoo service should be restarted. For data file changes to take effect, an upgrade to the modules is needed.</p>
			<p class="callout-heading">Tip</p>
			<p class="callout">As a general rule, changes to Odoo stable versions are considered code fixes, and it's therefore not often worth the risk of performing module upgrades. If you need to perform a module upgrade, however, this can be achieved using the <strong class="source-inline">-u &lt;module&gt;</strong> additional option (or <strong class="source-inline">-u base</strong>), which upgrades all modules.</p>
			<p>We can test the <a id="_idIndexMarker1243"/>actions using the staging database before applying them in the production database, as follows:</p>
			<p class="source-code">$ source /opt/odoo/env15/bin/activate</p>
			<p class="source-code">(env15) $ odoo -c /etc/odoo/odoo.conf -d odoo-stage \</p>
			<p class="source-code">--http-port=8080 -u library  # modules to updgrade</p>
			<p class="source-code">(env15) $ exit</p>
			<p>This Odoo staging server was configured to listen on port <strong class="source-inline">8080</strong>. We can navigate there with our web browser to check whether the upgraded code works correctly.</p>
			<p>If something goes wrong, we can revert the code to an earlier version with the following commands:</p>
			<p class="source-code">$ sudo su - odoo</p>
			<p class="source-code">$ cd /opt/odoo/odoo15</p>
			<p class="source-code">$ git checkout 15-last-prod</p>
			<p class="source-code">$ exit</p>
			<p>If everything works as expected, it should be safe to perform an upgrade on the production service, which is usually done by restarting it. If you want to perform an actual module upgrade, the suggested approach is to stop the server, run the upgrade, and then restart the service, as follows:</p>
			<p class="source-code">$ sudo service odoo stop</p>
			<p class="source-code">$ sudo su -c "/opt/odoo/env15/bin/odoo -c /etc/odoo/odoo.conf" \</p>
			<p class="source-code">" -u base --stop-after-init" odoo</p>
			<p class="source-code">$ sudo service odoo start</p>
			<p>Making a backup <a id="_idIndexMarker1244"/>of the database before running an upgrade is also advised.</p>
			<p>In this section, you learned how to create a staging environment alongside the main Odoo environment to be used for testing. Updates to Odoo code or to custom modules can be tried on the staging environment before applying them in the production system. This allows us to identify and correct any issues you might find with the upgrades ahead of time.</p>
			<h1 id="_idParaDest-427"><a id="_idTextAnchor432"/>Summary</h1>
			<p>In this chapter, we learned about the additional steps required for setting up and running Odoo on a Debian-based production server. We looked at the most important settings in the configuration file, and we learned how to take advantage of the multiprocessing mode.</p>
			<p>For improved security and scalability, we also learned how to use Nginx as a reverse proxy in front of Odoo server processes and how to configure it to use HTTPS-encrypted traffic.</p>
			<p>Finally, some advice was provided on how to create a staging environment and perform updates to Odoo code or custom modules.</p>
			<p>This covers the essentials of what's needed to run an Odoo server and provide a reasonably stable and secure service to your users. We can now use it to host our library management system!</p>
			<h1 id="_idParaDest-428"><a id="_idTextAnchor433"/>Further reading</h1>
			<p>To learn more about Odoo, you should take a look at the official documentation at <a href="https://www.odoo.com/documentation">https://www.odoo.com/documentation</a>. Some topics are covered in more detail there, and you'll find topics not covered in this book.</p>
			<p>There are also other published books on Odoo that you might find useful. <strong class="bold">Packt Publishing</strong> has a few in its catalog, and in particular, <em class="italic">Odoo Development Cookbook</em> provides more advanced material on topics not discussed in this book. At the time of writing, the last edition available was for Odoo 14, which is available at <a href="https://www.packtpub.com/product/odoo-14-development-cookbook-fourth-edition/9781800200319">https://www.packtpub.com/product/odoo-14-development-cookbook-fourth-edition/9781800200319</a>.</p>
			<p>Finally, Odoo is an open source product with a vibrant community. Getting involved, asking questions, and contributing is a great way not only to learn but also to build a business network. With this in mind, we should also mention the <strong class="bold">Odoo Community Association</strong> (<strong class="bold">OCA</strong>), which promotes collaboration and quality open source code. You can learn more about it at <a href="https://odoo-community.org/">https://odoo-community.org/</a> or <a href="https://github.com/OCA">https://github.com/OCA</a>.</p>
			<p>Enjoy your Odoo journey!</p>
		</div>
	</div></body></html>