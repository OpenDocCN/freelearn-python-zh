<html><head></head><body>
  <div id="sbo-rt-content"><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Building Your First Application</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Improving the scaffolding application</p></li><li class="listitem"><p>Building a simple contacts application</p></li><li class="listitem"><p>Building a Reddit clone</p></li><li class="listitem"><p>Building a Facebook clone</p></li><li class="listitem"><p>Using<code class="literal"> crud.archive</code>
</p></li><li class="listitem"><p>Converting an existing static site into a web2py application</p></li><li class="listitem"><p>Creating semi-static pages (flatpages)</p></li><li class="listitem"><p>Adding your custom logo</p></li><li class="listitem"><p>Creating menus and submenus</p></li><li class="listitem"><p>Customizing menus with icons</p></li><li class="listitem"><p>Creating a navigation bar</p></li><li class="listitem"><p>Using cookies to set the language</p></li><li class="listitem"><p>Designing modular applications</p></li><li class="listitem"><p>Speeding up downloads</p></li></ul></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec01"/>Introduction</h1></div></div></div><p>Now that you have web2py installed and running, you are ready to start building your first application. The recipes in this chapter will provide examples of complete applications, comprising models, views, and controllers. They range from simple<span class="strong"><strong> contacts</strong></span> applications to a more complex<span class="strong"><strong> Facebook</strong></span> clone. Other recipes in this chapter will show you how to solve some recurrent problems that new users typically encounter, from adding a logo to creating a navigation bar.</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec02"/>Improving the scaffolding application</h1></div></div></div><p>In this recipe, we discuss how to create your own scaffolding application and add your own configuration file. The<span class="strong"><strong> scaffolding application</strong></span> is the collection of files that come with any new web2py application.<a id="id54" class="indexterm"/>
</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec01"/>How to do it...</h2></div></div></div><p>The scaffolding app includes several files. One of them is<code class="literal"> models/db.py</code>, which imports four classes from<code class="literal"> gluon.tools</code> (Mail,<code class="literal"> Auth, Crud</code>, and<code class="literal"> Service)</code>, and defines the following global objects:<code class="literal"> db, mail, auth, crud</code>, and<code class="literal"> service</code>.</p><p>The scaffolding application also defines tables required by the<code class="literal"> auth</code> object, such as<code class="literal"> db.auth_user</code>.</p><p>The default scaffolding application is designed to minimize the number of files, not to be modular. In particular, the model file,<code class="literal"> db.py</code>, contains the configuration, which in a production environment, is best kept in separate files.</p><p>Here, we suggest creating a configuration file,<code class="literal"> models/0.py</code>, that contains something like the following:</p><div class="informalexample"><pre class="programlisting">
from gluon.storage import Storage
settings = Storage()

settings.production = False

if settings.production:
	settings.db_uri = 'sqlite://production.sqlite'
	settings.migrate = False
else:
	settings.db_uri = 'sqlite://development.sqlite'
	settings.migrate = True
	
settings.title = request.application
settings.subtitle = 'write something here'
settings.author = 'you'
settings.author_email = 'you@example.come'
settings.keywords = ''
settings.description = ''
settings.layout_theme = 'Default'
settings.security_key = 'a098c897-724b-4e05-b2d8-8ee993385ae6'
settings.email_server = 'localhost'
settings.email_sender = 'you@example.com'
settings.email_login = ''
settings.login_method = 'local'
settings.login_config = ''
</pre></div><p>We also modify<code class="literal"> models/db.py</code>, so that it uses the information from the configuration file, and it defines the<code class="literal"> auth_user</code> table explicitly (this makes it easier to add custom fields):</p><div class="informalexample"><pre class="programlisting">
from gluon.tools import *

db = DAL(settings.db_uri)
if settings.db_uri.startswith('gae'):
	session.connect(request, response, db = db)
	
mail = Mail() 			# mailer
auth = Auth(db) 		# authentication/authorization
crud = Crud(db) 		# for CRUD helpers using auth
service = Service() 	# for json, xml, jsonrpc, xmlrpc, amfrpc
plugins = PluginManager()

# enable generic views for all actions for testing purpose
response.generic_patterns = ['*']

mail.settings.server = settings.email_server
mail.settings.sender = settings.email_sender
mail.settings.login = settings.email_login
auth.settings.hmac_key = settings.security_key

# add any extra fields you may want to add to auth_user
auth.settings.extra_fields['auth_user'] = []

# user username as well as email
auth.define_tables(migrate=settings.migrate,username=True)
auth.settings.mailer = mail
auth.settings.registration_requires_verification = False
auth.settings.registration_requires_approval = False

auth.messages.verify_email = 'Click on the link http://' \
	+ request.env.http_host + URL('default','user',
	args=['verify_email']) \
	+ '/%(key)s to verify your email'
	
auth.settings.reset_password_requires_verification = True

auth.messages.reset_password = 'Click on the link http://' \
	+ request.env.http_host + URL('default','user',
	args=['reset_password']) \
	+ '/%(key)s to reset your password'
	
if settings.login_method=='janrain':
	from gluon.contrib.login_methods.rpx_account import RPXAccount
	auth.settings.actions_disabled=['register', 'change_password',
		'request_reset_password']
	auth.settings.login_form = RPXAccount(request,
		api_key = settings.login_config.split(':')[-1],
		domain = settings.login_config.split(':')[0],
		url = "http://%s/%s/default/user/login" % \
		(request.env.http_host, request.application))
</pre></div><p>Normally, after a web2py installation or upgrade, the welcome application is tar-gzipped into<code class="literal"> welcome.w2p</code>, and is used as the scaffolding application. You can create your own scaffolding application from an existing application using the following commands from a<code class="literal"> bash</code> shell:<a id="id55" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>cd applications/app
tar zcvf ../../welcome.w2p *</strong></span>
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec02"/>There's more...</h2></div></div></div><p>The web2py wizard uses a similar approach, and creates a similar<code class="literal"> 0.py</code> configuration file. You can add more settings to the<code class="literal"> 0.py</code> file as needed.</p><p>The<code class="literal"> 0.py</code> file may contain sensitive information, such as the<code class="literal"> security_key</code> used to encrypt passwords, the<code class="literal"> email_login</code> containing the password of your smtp account, and the<code class="literal"> login_config</code> with your Janrain password (<a class="ulink" href="http://www.janrain.com/">http://www.janrain.com/</a>). You may want to write this sensitive information in a read-only file outside the web2py tree, and read them from your<code class="literal"> 0.py</code> instead of hardcoding them. In this way, if you choose to commit your application to a version-control system, you will not be committing the sensitive information.<a id="id56" class="indexterm"/>
</p><p>The scaffolding application includes other files that you may want to customize, including<code class="literal"> views/layout.html</code> and<code class="literal"> views/default/users.html</code>. Some of them are the subject of upcoming recipes.</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec03"/>Building a simple contacts application</h1></div></div></div><p>When you start designing a new web2py application, you go through three phases that are characterized by looking for the answer to the following three questions:<a id="id57" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>What data should the application store?</p></li><li class="listitem"><p>Which pages should be presented to the visitors?</p></li><li class="listitem"><p>How should the page content, for each page, be presented?</p></li></ul></div><p>The answer to these three questions is implemented in the<span class="strong"><strong> models</strong></span>, the<span class="strong"><strong> controllers</strong></span>, and the<span class="strong"><strong> views</strong></span> respectively.</p><p>It is important for a good application design to try answering those questions exactly in this order, and as accurately as possible. Such answers can later be revised, and more tables, more pages, and more bells and whistles can be added in an iterative fashion. A good web2py application is designed in such a way that you can change the table definitions (add and remove fields), add pages, and change page views, without breaking the application.</p><p>A distinctive feature of web2py is that everything has a default. This means you can work on the first of those three steps without the need to write code for the second and third step. Similarly, you can work on the second step without the need to code for the third. At each step, you will be able to immediately see the result of your work; thanks to<code class="literal"> appadmin</code> (the default database administrative interface) and generic views (every action has a view by default, until you write a custom one).<a id="id58" class="indexterm"/>
</p><p>Here we consider, as a first example, an application to manage our business contacts, a CRM. We will call it<code class="literal"> Contacts</code>. The application needs to maintain a list of companies, and a list of people who work at those companies.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec03"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>First of all we create the model.</p><p>In this step we identify which tables are needed and their fields. For each field, we determine whether they:
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Must contain unique values (<code class="literal">unique=True</code>)</p></li><li class="listitem"><p>Contain empty values (<code class="literal">notnull=True</code>)</p></li><li class="listitem"><p>Are references (contain a list of a record in another table)</p></li><li class="listitem"><p>Are used to represent a record (format attribute)</p><p>From now on, we will assume we are working with a copy of the default scaffolding application, and we only describe the code that needs to be added or replaced. In particular, we will assume the default <code class="literal">views/layout.html and models/db.py.
</code>
</p><p>Here is a possible model representing the data we need to store in <code class="literal">models/db_contacts.py:
</code>
</p></li></ul></div><div class="informalexample"><pre class="programlisting">
# in file: models/db_custom.py

db.define_table('company',
	Field('name', notnull=True, unique=True),
	format='%(name)s')
	
db.define_table('contact',
	Field('name', notnull=True),
	Field('company', 'reference company'),
	Field('picture', 'upload'),
	Field('email', requires=IS_EMAIL()),
	Field('phone_number', requires=IS_MATCH('[\d\-\(\) ]+')),
	Field('address'),
	format='%(name)s')
	
db.define_table('log',
	Field('body', 'text',notnull=True),
	Field('posted_on', 'datetime'),
	Field('contact', 'reference contact'))
</pre></div><p>Of course, a more complex data representation is possible. You may want to allow, for example, multiple users for the system, allow the same person to work for multiple companies, and keep track of changes in time. Here, we will keep it simple.
</p><p>The name of this file is important. In particular, models are executed in alphabetical order, and this one must follow db.py.
</p></li><li class="listitem"><p>After this file has been created, you can try it by visiting the following url:<a class="ulink" href="http://127.0.0.1:8000/contacts/appadmin"> http://127.0.0.1:8000/contacts/appadmin</a>, to access the web2py database administrative interface,<code class="literal"> appadmin</code>. Without any controller or view, it provides a way to insert, select, update, and delete records.</p></li><li class="listitem"><p>Now we are ready to build the controller. We need to identify which pages are required by the application. This depends on the required workflow. At a minimum we need the following pages:<a id="id59" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>An index page (the home page)</p></li><li class="listitem"><p>A page to list all companies</p></li><li class="listitem"><p>A page that lists all contacts for one selected company</p></li><li class="listitem"><p>A page to create a company</p></li><li class="listitem"><p>A page to edit/delete a company</p></li><li class="listitem"><p>A page to create a contact</p></li><li class="listitem"><p>A page to edit/delete a contact</p></li><li class="listitem"><p>A page that allows to read the information about one contact and the communication logs, as well as add a new communication log</p></li></ul></div></li><li class="listitem"><p>Such pages can be implemented as follows:</p><div class="informalexample"><pre class="programlisting">
# in file: controllers/default.py

def index():
	return locals()
	
def companies():
	companies = db(db.company).select(orderby=db.company.name)
	return locals()
	
def contacts():
	company = db.company(request.args(0)) or
		redirect(URL('companies'))
	contacts = db(db.contact.company==company.id).select(
		orderby=db.contact.name)
	return locals()
	
@auth.requires_login()
def company_create():
	form = crud.create(db.company, next='companies')
	return locals()
	
@auth.requires_login()
def company_edit():
	company = db.company(request.args(0)) or
		redirect(URL('companies'))
	form = crud.update(db.company, company, next='companies')
	return locals()
	
@auth.requires_login()
def contact_create():
	db.contact.company.default = request.args(0)
	form = crud.create(db.contact, next='companies')
	return locals()
	
@auth.requires_login()
def contact_edit():
	contact = db.contact(request.args(0)) or
		redirect(URL('companies'))
	form = crud.update(db.contact, contact, next='companies')
	return locals()
	
@auth.requires_login()
def contact_logs():
	contact = db.contact(request.args(0)) or
		redirect(URL('companies'))
	db.log.contact.default = contact.id
	db.log.contact.readable = False
	db.log.contact.writable = False
	db.log.posted_on.default = request.now
	db.log.posted_on.readable = False
	db.log.posted_on.writable = False
	form = crud.create(db.log)
	logs = db(
		db.log.contact==contact.id).select(orderby=db.log.posted_on)
	return locals()
	
def download(): return response.download(request, db)

def user(): return dict(form=auth())
</pre></div></li><li class="listitem"><p>Make sure that you do not delete the existing<code class="literal"> user, download</code>, and<code class="literal"> service</code> functions in the scaffolding<code class="literal"> default.py</code>.</p></li><li class="listitem"><p>Notice how all pages are built using the same ingredients:<span class="strong"><strong> select queries</strong></span> and<span class="strong"><strong> crud forms</strong></span>. You rarely need anything else.</p></li><li class="listitem"><p>Also notice the following:<a id="id60" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Some pages require a<code class="literal"> request.args(0)</code> argument (a company ID for contacts and<code class="literal"> company_edit</code>, a contact ID for<code class="literal"> contact_edit</code>, and<code class="literal"> contact_logs)</code>.</p></li><li class="listitem"><p>All selects have an<code class="literal"> orderby</code> argument.</p></li><li class="listitem"><p>All crud forms have a next argument that determines the redirection after form submission.</p></li><li class="listitem"><p>All actions return<code class="literal"> locals()</code>, which is a Python dictionary containing the local variables defined in the function. This is a shortcut. It is of course possible to return a dictionary with any subset of<code class="literal"> locals()</code>.</p></li><li class="listitem"><p>
<code class="literal">contact_create</code> sets a default value for the new contact company to the value passed as<code class="literal"> args(0)</code>.</p></li><li class="listitem"><p>The<code class="literal"> contacts_logs</code> retrieves past logs after processing<code class="literal"> crud.create</code> for a new log entry. This avoid unnecessarily reloading of the page, when a new log is inserted.</p></li></ul></div></li><li class="listitem"><p>At this point our application is fully functional, although the look-and-feel and navigation can be improved.:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>You can create a new company at:<code class="literal"> http://127.0.0.1:8000/contacts/default/company_create</code>
</p></li><li class="listitem"><p>You can list all companies at:<code class="literal"> http://127.0.0.1:8000/contacts/default/companies</code>
</p></li><li class="listitem"><p>You can edit company<code class="literal"> #1</code> at:<code class="literal"> http://127.0.0.1:8000/contacts/default/company_edit/1</code>
</p></li><li class="listitem"><p>You can create a new contact at:<code class="literal"> http://127.0.0.1:8000/contacts/default/contact_create</code>
</p></li><li class="listitem"><p>You can list all contacts for company<code class="literal"> #1</code> at:<code class="literal"> http://127.0.0.1:8000/contacts/default/contacts/1</code>
</p></li><li class="listitem"><p>You can edit contact<code class="literal"> #1</code> at:<code class="literal"> http://127.0.0.1:8000/contacts/default/contact_edit/1</code>
</p></li><li class="listitem"><p>And you can access the communication log for contact<code class="literal"> #1</code> at:<code class="literal"> http://127.0.0.1:8000/contacts/default/contact_logs/1</code>
</p></li></ul></div></li><li class="listitem"><p>You should also edit the<code class="literal"> models/menu.py</code> file, and replace the content with the following:</p><div class="informalexample"><pre class="programlisting">
response.menu = [['Companies', False, URL('default',
	'companies')]]
</pre></div><p>The application now works, but we can improve it by designing a better look and feel for the actions. That's done in the views.
</p></li><li class="listitem"><p>Create and edit file<code class="literal"> views/default/companies.html:</code>
</p><div class="informalexample"><pre class="programlisting">
{{extend 'layout.html'}}
&lt;h2&gt;Companies&lt;/h2&gt;
&lt;table&gt;
	{{for company in companies:}}
	&lt;tr&gt;
		&lt;td&gt;{{=A(company.name, _href=URL('contacts',
			args=company.id))}}&lt;/td&gt;
		&lt;td&gt;{{=A('edit', _href=URL('company_edit',
			args=company.id))}}&lt;/td&gt;
	&lt;/tr&gt;
	{{pass}}
	&lt;tr&gt;
		&lt;td&gt;{{=A('add company', _href=URL('company_create'))}}&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
</pre></div><p>Here is how this page looks:
</p><div class="mediaobject"><img src="images/5467OS_02_16.jpg" alt="How to do it..."/></div></li><li class="listitem"><p>Create and edit file<code class="literal"> views/default/contacts.html:</code>
</p><div class="informalexample"><pre class="programlisting">
{{extend 'layout.html'}}
&lt;h2&gt;Contacts at {{=company.name}}&lt;/h2&gt;
&lt;table&gt;
	{{for contact in contacts:}}
	&lt;tr&gt;
		&lt;td&gt;{{=A(contact.name, _href=URL('contact_logs',
			args=contact.id))}}&lt;/td&gt;
		&lt;td&gt;{{=A('edit', _href=URL('contact_edit',
			args=contact.id))}}&lt;/td&gt;
	&lt;/tr&gt;
	{{pass}}
	&lt;tr&gt;
		&lt;td&gt;{{=A('add contact', _href=URL('contact_create',
			args=company.id))}}&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
</pre></div><p>Here is how this page looks:
</p><div class="mediaobject"><img src="images/5467OS_02_17.jpg" alt="How to do it..."/></div></li><li class="listitem"><p>Create and edit file<code class="literal"> views/default/company_create.html:</code>
</p><div class="informalexample"><pre class="programlisting">{{extend 'layout.html'}}
&lt;h2&gt;New company&lt;/h2&gt;
{{=form}}
</pre></div></li><li class="listitem"><p>Create and edit file<code class="literal"> views/default/contact_create.html:</code>
</p><div class="informalexample"><pre class="programlisting">{{extend 'layout.html'}}
&lt;h2&gt;New contact&lt;/h2&gt;
{{=form}}
</pre></div></li><li class="listitem"><p>Create and edit file:<code class="literal"> views/default/company_edit.html:</code>
<a id="id61" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">{{extend 'layout.html'}}
&lt;h2&gt;Edit company&lt;/h2&gt;
{{=form}}
</pre></div></li><li class="listitem"><p>Create and edit file<code class="literal"> views/default/contact_edit.html:</code>
</p><div class="informalexample"><pre class="programlisting">{{extend 'layout.html'}}
&lt;h2&gt;Edit contact&lt;/h2&gt;
{{=form}}
</pre></div></li><li class="listitem"><p>Create and edit file<code class="literal"> views/default/contact_logs.html:</code>
<a id="id62" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
{{extend 'layout.html'}}
&lt;h2&gt;Logs for contact {{=contact.name}}&lt;/h2&gt;
&lt;table&gt;
	{{for log in logs:}}
	&lt;tr&gt;
		&lt;td&gt;{{=log.posted_on}}&lt;/td&gt;
		&lt;td&gt;{{=MARKMIN(log.body)}}&lt;/td&gt;
	&lt;/tr&gt;
	{{pass}}
	&lt;tr&gt;
		&lt;td&gt;&lt;/td&gt;
		&lt;td&gt;{{=form}}&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
</pre></div><p>Here is how this page looks:
</p></li></ol></div><div class="mediaobject"><img src="images/5467OS_02_18.jpg" alt="How to do it..."/></div><p>Notice that in the last view, we used the function<code class="literal"> MARKMIN</code> to render the content of the<code class="literal"> db.log.body</code>, using the<code class="literal"> MARKMIN</code> markup. This allows embedding links, images, anchors, font formatting information, and tables in the logs. For details about the<code class="literal"> MARKMIN</code> syntax we refer to:<a class="ulink" href="http://web2py.com/examples/static/markmin.html"> http://web2py.com/examples/static/markmin.html</a>.<a id="id63" class="indexterm"/>
</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec04"/>Building a Reddit clone</h1></div></div></div><p>Here we show how to build an application to post and rank links to online news items, similar to the<a class="ulink" href="http://www.reddit.com/"> http://www.reddit.com/</a> website. The links are organized into categories, and users can post, vote, and comment on them. As in the previous recipe, the code only shows additions or changes to the default scaffolding application. We will call our application<code class="literal"> reddit</code>.<a id="id64" class="indexterm"/>
</p><p>In this recipe, we will not support threaded comments (as in the actual<a class="ulink" href="http://www.reddit.com/"> http://www.reddit.com/</a> website), because it would be an unnecessary complication. We will discuss threaded comments in a subsequent recipe.</p><p>We will follow the same steps discussed in the previous recipe.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec04"/>How to do it...</h2></div></div></div><p>This application is very similar to the<code class="literal"> contacts</code> of the previous recipe. In fact, the data model is almost identical, provided that we map table<code class="literal"> company</code> into a table<code class="literal"> category</code>, and table<code class="literal"> contact</code> into a table<code class="literal"> news</code>. The main differences are that news items do not have a<code class="literal"> name</code>, but they have a<code class="literal"> title</code> and a<code class="literal"> link</code> instead. Moreover,<code class="literal"> news</code> items must be sorted by user votes, and not alphabetically. We also need to add a mechanism to allow users to vote, record votes, and prevent double counting. We need an extra table for this. We will also not deal with pagination, since this is discussed in a separate recipe.<a id="id65" class="indexterm"/>
</p><p>Here is the complete model:</p><div class="informalexample"><pre class="programlisting">
# in file: models/db_reddit.py
db.define_table('category',
	Field('name' ,notnull=True, unique=True),
	format='%(name)s')
	
db.define_table('news',
	Field('title', notnull=True),
	Field('link', requires=IS_URL()),
	Field('category', 'reference category', readable=False,
		writable=False),
	Field('votes', 'integer', readable=False, writable=False),
	Field('posted_on', 'datetime', readable=False, writable=False),
	Field('posted_by', 'reference auth_user', readable=False, writable=False),
	format='%(title)s')
	
db.define_table('comment',
	Field('news', 'reference news', readable=False, writable=False),
	Field('body', 'text', notnull=True),
	Field('posted_on', 'datetime', readable=False, writable=False),
	Field('posted_by', 'reference auth_user', readable=False,
		writable=False))
		
db.define_table('vote',
	Field('news', 'reference news'),
	Field('value', 'integer'),
	Field('posted_on', 'datetime', readable=False, writable=False),
	Field('posted_by', 'reference auth_user', readable=False,
		writable=False))
</pre></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>As discussed previously, many of the needed actions are equivalent to the<code class="literal"> contacts</code> application of the previous recipe. In particular, we need actions to list categories, to list news for a given category, to create and edit categories, to create and edit news, to list comments, and vote for<code class="literal"> news</code> items.<a id="id66" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
def index():
	return locals()
	
def categories():
	categories = db(db.category).select(orderby=db.category.name)
	return locals()
	
def news():
	category = db.category(request.args(0)) or
		redirect(URL('categories'))
	news = db(db.news.category==category.id).select(
		orderby=~db.news.votes, limitby=(0, 25))
	return locals()
	
@auth.requires_membership('manager')
def category_create():
	form = crud.create(db.category, next='categories')
	return locals()
	
@auth.requires_membership('manager')
def category_edit():
	category = db.category(request.args(0)) or
		redirect(URL('categories'))
	form = crud.update(db.category, category, next='categories')
	return locals()
	
@auth.requires_login()
def news_create():
	db.news.category.default = request.args(0)
	db.news.votes.default = 0
	form = crud.create(db.news, next='news_comments/[id]')
	return locals()
	
@auth.requires_login()
def news_edit():
	news = db.news(request.args(0)) or redirect(URL('categories'))
	if not news.posted_by==auth.user.id:
		redirect(URL('not_authorized'))
	form = crud.update(db.news, category, next='news_comments/[id]')
	return locals()
	
def news_comments():
	news = db.news(request.args(0)) or redirect(URL('categories'))
	if auth.user:
		db.comment.news.default = news.id
		db.comment.posted_on.default = request.now
		db.comment.posted_by.default = auth.user.id
		form = crud.create(db.comment)
	comments = db(db.comment.news==news.id).select(
		orderby=db.comment.posted_on)
	return locals()
	
@auth.requires_login()
def vote():
	if not request.env.request_method=='POST': raise HTTP(400)
	news_id, mode = request.args(0), request.args(1)
	news = db.news(id=news_id)
	vote = db.vote(posted_by=auth.user.id, news=news_id)
	votes = news.votes
	value = (mode=='plus') and +1 or -1
	if vote and value*vote.value==1:
		message = 'you voted already'
	else:
		if vote:
			votes += value - vote.value
			vote.update_record(value=value)
		else:
			votes += value
			db.vote.insert(value=value, posted_by=auth.user.id,
				posted_on=request.now, news=news_id)
			news.update_record(votes=votes)
			message = 'vote recorded'
		return "jQuery('#votes').html('%s');jQuery('.flash').\
			html('%s').slideDown();" % (votes, message)
</pre></div><p>Most of these actions are very standard, and composed of the usual <code class="literal">select</code> and <code class="literal">crud</code> forms.
<a id="id67" class="indexterm"/>
</p></li><li class="listitem"><p>We used two types of decorators to make sure that only logged-in users can edit content, and only managers can create and edit categories. You can use<code class="literal"> appadmin</code> to create a<code class="literal"> manager</code> group and give membership to users:</p><div class="mediaobject"><img src="images/5467OS_02_19.jpg" alt="How to do it..."/></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The only special action is the last <code class="literal">vote</code>. The vote action is designed to be an Ajax callback. To avoid indirect reference attacks, the first line makes sure the action is called with a <code class="literal">POST</code> request. Then we parse the request args: it expects a news ID as <code class="literal">args(0)</code>, and plus or minus as <code class="literal">args(0)</code>, depending on whether we want to vote the news item up or down. If we vote up (<code class="literal">plus</code>), it creates a new db.vote entry with value equal to <code class="literal">+1</code>. If we vote down (<code class="literal">minus</code>), it creates a new <code class="literal">db.vote</code> entry with value equal to<code class="literal"> -1</code>. The action also checks whether we voted already. We are allowed to change our vote, but not to vote twice.
</p><p>This action returns a JavaScript string that updates the votes HTML element with the latest vote count, and flashes a new message. The last line of the action is tightly coupled with the view that will perform the Ajax call (views/default/news_comments.html).
<a id="id68" class="indexterm"/>
</p></li></ul></div></li><li class="listitem"><p>We also want to list all possible categories in the menu:</p><div class="informalexample"><pre class="programlisting">
# in file: models/menu.py"
categories = db(db.category).select(orderby=db.category.name,
	cache=(cache.ram, 60))
response.menu = [(c.name, False, URL('default', 'news',
	args=c.id)) for c in categories]
</pre></div></li><li class="listitem"><p>Finally, we need to create the following views:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
<code class="literal">views/default/categories.html:</code>
</p></li></ul></div><div class="informalexample"><pre class="programlisting">
{{extend 'layout.html'}}
&lt;h2&gt;Categories&lt;/h2&gt;
&lt;table&gt;
	{{for category in categories:}}
	&lt;tr&gt;
		&lt;td&gt;{{=A(category.name, _href=URL('news',
			args=category.id))}}&lt;/td&gt;
		&lt;td&gt;{{=A('edit', _href=URL('category_edit',
			args=category.id))}}
		&lt;/td&gt;
	&lt;/tr&gt;
	{{pass}}
	&lt;tr&gt;
		&lt;td&gt;{{=A('add category', _href=URL('category_create'))}}&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
</pre></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
<code class="literal">views/default/news.html:</code>
</p></li></ul></div><div class="informalexample"><pre class="programlisting">
{{extend 'layout.html'}}
&lt;h2&gt;News at {{=category.name}}&lt;/h2&gt;
&lt;table&gt;
	{{for news in news:}}
	&lt;tr&gt;
		&lt;td&gt;{{=A(news.title, _href=news.link)}}&lt;/td&gt;
		&lt;td&gt;{{=A('comments', _href=URL('news_comments',
			args=news.id))}}
		&lt;/td&gt;
		&lt;td&gt;{{=A('edit', _href=URL('news_edit', args=news.id))}}&lt;/td&gt;
	&lt;/tr&gt;
	{{pass}}
	&lt;tr&gt;
		&lt;td&gt;{{=A('post news item', _href=URL('news_create',
			args=category.id))}}
		&lt;/td&gt;
		&lt;td&gt;&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;
</pre></div><p>Here is how this page looks:
</p><div class="mediaobject"><img src="images/5467OS_02_20.jpg" alt="How to do it..."/></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
<code class="literal">views/default/category_create.html:</code>
</p><div class="informalexample"><pre class="programlisting">{{extend 'layout.html'}}
&lt;h2&gt;New category&lt;/h2&gt;
{{=form}}
</pre></div></li><li class="listitem"><p>
<code class="literal">views/default/news_create.html:</code>
</p><div class="informalexample"><pre class="programlisting">{{extend 'layout.html'}}
&lt;h2&gt;Post news item&lt;/h2&gt;
{{=form}}
</pre></div></li><li class="listitem"><p>
<code class="literal">views/default/category_edit.html:</code>
</p><div class="informalexample"><pre class="programlisting">{{extend 'layout.html'}}
&lt;h2&gt;Edit category&lt;/h2&gt;
{{=form}}
</pre></div></li><li class="listitem"><p>
<code class="literal">views/default/categories.html:</code>
</p><div class="informalexample"><pre class="programlisting">{{extend 'layout.html'}}
&lt;h2&gt;Edit news item&lt;/h2&gt;
{{=form}}
</pre></div></li><li class="listitem"><p>
<code class="literal">views/default/news_comments.html:</code>
</p><div class="informalexample"><pre class="programlisting">
{{extend 'layout.html'}}
&lt;h2&gt;Comments for {{=A(news.title, _href=news.link)}}&lt;/h2&gt;
{{if auth.user:}}
	&lt;span id="votes"&gt;{{=news.votes}}&lt;/span&gt;
	&lt;button id="plus"
		onclick="ajax('{{=URL('vote', args=(news.id, 'plus'))}}', [], ':eval')"&gt;
		plus
	&lt;/button&gt;
	
	&lt;button id="minus"
		onclick="ajax('{{=URL('vote', args=(news.id, 'minus'))}}', [],
		':eval')"&gt;
		minus
	&lt;/button&gt;
	{{=form}}
{{pass}}
&lt;table&gt;
	{{for comment in comments:}}
	&lt;tr&gt;
		&lt;td&gt;{{=comment.posted_on}}&lt;/td&gt;
		&lt;td&gt;{{=comment.posted_by.first_name}} says &lt;/td&gt;
		&lt;td&gt;{{=MARKMIN(comment.body)}}&lt;/td&gt;
	&lt;/tr&gt;
{{pass}}
&lt;/table&gt;
</pre></div><p>Notice the code:
</p><div class="informalexample"><pre class="programlisting">
&lt;button id="plus"
	onclick="ajax('{{=URL('vote', args=(news.id, 'plus'))}}', [],
	':eval')"&gt;
	plus
&lt;/button&gt;
</pre></div><p>On clicking, it performs an Ajax request that records our vote. The return value of the Ajax request is evaluated (<code class="literal">:eval</code>). The URL(<code class="literal">vote</code>) returns a JavaScript code that will be evaluated:
</p><div class="informalexample"><pre class="programlisting">
def vote():
	...
	return
		"jQuery('#votes').html('%s');jQuery('.flash').
		html('%s').slideDown();" % (votes, message)
</pre></div></li></ul></div></li><li class="listitem"><p>In particular, it will alter the content of the following code, and flash a new message (slidedown):<a id="id69" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">&lt;span id="votes"&gt;{{=news.votes}}&lt;/span&gt;
</pre></div><p>Here is how this page looks:
</p><div class="mediaobject"><img src="images/5467OS_02_21.jpg" alt="How to do it..."/></div></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec05"/>Building a Facebook clone</h1></div></div></div><p>At its fundamental level, Facebook handles friendship relations between users, and allows friends to see each other's posts. Users can register, log in, search for other users, request friendship, and accept friendship. When a user posts a message, the post will be visible on the wall (web page) of all his/her friends.<a id="id70" class="indexterm"/>
</p><p>Of course, the real Facebook application is quite complex, and our version is greatly simplified, but it captures the most important features. In particular, we will omit the ability to attach comments after posts, and we will omit e-mail notification features. We will also omit the code to handle photos, videos, and chat. We are only interested in the friendship relations and display wall posts, based on friendship. We will call our application<code class="literal"> friends</code>.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec05"/>How to do it...</h2></div></div></div><p>The core of our design is a table to link two people: a<code class="literal"> source</code> and a<code class="literal"> target</code> of a friendship relation. The friendship relation is requested by a<code class="literal"> source</code>, and must be approved by a<code class="literal"> target</code>. When approved, the<code class="literal"> source</code> user can see the posts and profile info of the<code class="literal"> target</code>. While the real Facebook friendship relations are bi-directional (although friends can be hidden/blocked), in our case we assume unidirectional friendship (two users must give friendship to each other to see each other's posts).</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>The model is therefore quite simple, and we only need two tables:</p><div class="informalexample"><pre class="programlisting">
# in file: models:

# a table to store posted messages
db.define_table('post',
	Field('body', 'text', requires=IS_NOT_EMPTY(), label='What is on
		your mind?'),
	Field('posted_on', 'datetime', readable=False, writable=False),
	Field('posted_by', 'reference auth_user', readable=False,
		writable=False))
		
# a table to link two people
db.define_table('link',
	Field('source', 'reference auth_user'),
	Field('target', 'reference auth_user'),
	Field('accepted', 'boolean', default=False))
	
# and define some global variables that will make code more
compact

User, Link, Post = db.auth_user, db.link, db.post
me, a0, a1 = auth.user_id, request.args(0), request.args(1)
myfriends = db(Link.source==me)(Link.accepted==True)
alphabetical = User.first_name|User.last_name
def name_of(user): return '%(first_name)s %(last_name)s' % user
</pre></div><p>The last five lines define various shortcuts that will make our controllers and views more compact. For example, they allow the user to use User instead of <code class="literal">db.user</code>, and <code class="literal">orderby=alphabetical</code> instead of the more verbose equivalent.
</p><p>myfriends is the set of people that have accepted our friendship, which means we can see their posts.
</p><p>The following list line allows us to print the first name followed by last name of a user, given a user object or a user reference:
</p><div class="informalexample"><pre class="programlisting">{{=name_of(user)}}
</pre></div></li><li class="listitem"><p>We are going to need the following pages:<a id="id71" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>An<span class="strong"><strong> index</strong></span> page that, if we are logged in, redirects to our home page</p></li><li class="listitem"><p>A<span class="strong"><strong> private</strong></span> home page that shows our messages, the posts of our friends, and allows us to post a new post</p></li><li class="listitem"><p>A page to search for new friends by name</p></li><li class="listitem"><p>A page to check who our current friends are, check pending friend requests, and approve or deny friendship</p></li><li class="listitem"><p>A wall page to see the status of one particular friend (or our own)</p></li></ul></div></li><li class="listitem"><p>We also need a callback action to implement to allow users to<span class="strong"><strong> request</strong></span> friendship, to<span class="strong"><strong> accept</strong></span> friendship, to<span class="strong"><strong> deny</strong></span> a friendship request, and to<span class="strong"><strong> cancel</strong></span> a previous request for friendship. We implement these through a single Ajax callback in a function called<code class="literal"> friendship:</code>
<a id="id72" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
# in file: controllers/default.py
def index():
	if auth.user: redirect(URL('home'))
	return locals()
	
def user():
	return dict(form=auth())
	
def download():
	return response.download(request, db)
	
def call():
	session.forget()
	return service()
	
# our home page, will show our posts and posts by friends
@auth.requires_login()
def home():
	Post.posted_by.default = me
	Post.posted_on.default = request.now
	crud.settings.formstyle = 'table2cols'
	form = crud.create(Post)
	friends = [me]+[row.target for row in
		myfriends.select(Link.target)]
	posts = db(Post.posted_by.belongs(friends))\
		.select(orderby=~Post.posted_on, limitby=(0, 100))
	return locals()
	
# our wall will show our profile and our own posts
@auth.requires_login()
def wall():
	user = User(a0 or me)
	if not user or not (user.id==me or \
		myfriends(Link.target==user.id).count()):
		redirect(URL('home'))
	posts = db(Post.posted_by==user.id)\
		.select(orderby=~Post.posted_on, limitby=(0, 100))
	return locals()
	
# a page for searching friends and requesting friendship
@auth.requires_login()
def search():
	form = SQLFORM.factory(Field('name', requires=IS_NOT_EMPTY()))
	if form.accepts(request):
		tokens = form.vars.name.split()
		query = reduce(lambda a,b:a&amp;b,
		[User.first_name.contains(k)|User.last_name.contains(k) \
		for k in tokens])
			people = db(query).select(orderby=alphabetical)
		else:
			people = []
	return locals()
	
# a page for accepting and denying friendship requests
@auth.requires_login()
def friends():
	friends = db(User.id==Link.source)(Link.target==me)\
		.select(orderby=alphabetical)
	requests = db(User.id==Link.target)(Link.source==me)\
		.select(orderby=alphabetical)
	return locals()
	
# this is the Ajax callback
@auth.requires_login()
def friendship():
	"""Ajax callback!"""
	if request.env.request_method != 'POST': raise HTTP(400)
	if a0=='request' and not Link(source=a1, target=me):
		# insert a new friendship request
		Link.insert(source=me, target=a1)
	elif a0=='accept':
		# accept an existing friendship request
		db(Link.target==me)(Link.source==a1).update(accepted=True)
	if not db(Link.source==me)(Link.target==a1).count():
		Link.insert(source=me, target=a1)
	elif a0=='deny':
		# deny an existing friendship request
		db(Link.target==me)(Link.source==a1).delete()
	elif a0=='remove':
		# delete a previous friendship request
		db(Link.source==me)(Link.target==a1).delete()
</pre></div></li><li class="listitem"><p>We also include the<span class="strong"><strong> home, wall, friends</strong></span>, and<span class="strong"><strong> search</strong></span> pages in the menu:<a id="id73" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
# in file: models/menu.py
response.menu = [
	(T('Home'), False, URL('default', 'home')),
	(T('Wall'), False, URL('default', 'wall')),
	(T('Friends'), False, URL('default', 'friends')),
	(T('Search'), False, URL('default', 'search')),
]
</pre></div><p>Most of the views are straightforward.
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Here is<code class="literal"> views/default/home.html:</code>
</p></li></ul></div><div class="informalexample"><pre class="programlisting">
{{extend 'layout.html'}}
{{=form}}
&lt;script&gt;jQuery('textarea').css('width','600px').
	css('height','50px');&lt;/script&gt;
{{for post in posts:}}
&lt;div style="background: #f0f0f0; margin-bottom: 5px; padding:
	8px;"&gt;
	&lt;h3&gt;{{=name_of(post.posted_by)}} on {{=post.posted_on}}:&lt;/h3&gt;
	{{=MARKMIN(post.body)}}
&lt;/div&gt;
{{pass}}
</pre></div><p>Notice the jQuery script that resizes the input message box, and the use of MARKMIN for rendering message markup.
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Here is<code class="literal"> views/default/wall.html</code>, which is very similar to the previous view (the difference is that there is no form, and the posts are relative to a single user, specified by<code class="literal"> request.args(0)):</code>
</p></li></ul></div><div class="informalexample"><pre class="programlisting">
{{extend 'layout.html'}}
&lt;h2&gt;Profile&lt;/h2&gt;
{{=crud.read(db.auth_user, user)}}
&lt;h2&gt;Messages&lt;/h2&gt;
{{for post in posts:}}
&lt;div style="background: #f0f0f0; margin-bottom: 5px; padding:
	8px;"&gt;
	&lt;h3&gt;{{=name_of(post.posted_by)}} on {{=post.posted_on}}:&lt;/h3&gt;
	{{=MARKMIN(post.body)}}
&lt;/div&gt;
{{pass}}
</pre></div><p>Here is what this page looks like:
</p></li></ol></div><div class="mediaobject"><img src="images/5467OS_02_22.jpg" alt="How to do it..."/></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Here is<code class="literal"> views/default/search.html:</code>
</p><div class="informalexample"><pre class="programlisting">
{{extend 'layout.html'}}
&lt;h2&gt;Search for friends&lt;/h2&gt;
{{=form}}
{{if people:}}
&lt;h3&gt;Results&lt;/h3&gt;
&lt;table&gt;
	{{for user in people:}}
	&lt;td&gt;
		{{=A(name_of(user), _href=URL('wall', args=user.id))}}
	&lt;/td&gt;
	&lt;td&gt;
		&lt;button onclick="ajax(
			'{{=URL('friendship', args=('request', user.id))}}',
			[], null);
			jQuery(this).parent().html('pending')"&gt;
			request friendship
		&lt;/button&gt;
	&lt;/td&gt;
	{{pass}}
&lt;/table&gt;
{{pass}}
</pre></div></li><li class="listitem"><p>Here is what this page looks like:
</p></li></ul></div><div class="mediaobject"><img src="images/5467OS_02_23.jpg" alt="How to do it..."/></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Notice how the buttons perform Ajax calls to <code class="literal">request</code> friendship to <code class="literal">user.id</code>. Upon click, the button is replaced by a message that says pending.
<a id="id74" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Below is<code class="literal"> views/default/friends.html</code>. It lists current friends and pending friendship requests:</p></li></ul></div><div class="informalexample"><pre class="programlisting">
{{extend 'layout.html'}}
&lt;h2&gt;Friendship Offered&lt;/h2&gt;
&lt;table&gt;
	{{for friend in friends:}}
	&lt;tr&gt;
		&lt;td&gt;
			{{=A(name_of(friend.auth_user), _href=URL('wall', args=friend.auth_user.id))}}
		&lt;/td&gt;
		&lt;td&gt;
			{{if friend.link.accepted:}}accepted{{else:}}
				&lt;button onclick="ajax(
					'{{=URL('friendship', args=('accept',
					friend.auth_user.id))}}',
					[], null);
					jQuery(this).parent().html('accepted')"&gt;
					accept
				&lt;/button&gt;
			{{pass}}
		&lt;/td&gt;
		&lt;td&gt;
			&lt;button onclick="ajax(
				'{{=URL('friendship', args=('deny',
				friend.auth_user.id))}}',
				[], null);
				jQuery(this).parent().html('denied')"&gt;
				deny
			&lt;/button&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	{{pass}}
&lt;/table&gt;
&lt;h2&gt;Friendship Requested&lt;/h2&gt;
&lt;table&gt;
	{{for friend in requests:}}
	&lt;tr&gt;
		&lt;td&gt;
			{{=A(name_of(friend.auth_user), _href=URL('wall',
				args=friend.auth_user.id))}}
		&lt;/td&gt;
		&lt;td&gt;
			{{if friend.link.accepted:}}accepted{{else:}}
pending{{pass}}
		&lt;/td&gt;
		&lt;td&gt;
			&lt;button onclick="ajax(
				'{{=URL('friendship', args=('deny',
				friend.auth_user.id))}}',
				[], null);
				jQuery(this).parent().html('removed')"&gt;
				remove
			&lt;/button&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	{{pass}}
&lt;/table&gt;
</pre></div></li><li class="listitem"><p>Here is what this page looks like:
<a id="id75" class="indexterm"/>
</p></li></ul></div><div class="mediaobject"><img src="images/5467OS_02_24.jpg" alt="How to do it..."/></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>This view displays two tables: a list of friendships <span class="strong"><strong>offered</strong></span> to us (by accepting, we give them the permission to see our profile and posts), and friendship <span class="strong"><strong>requests</strong></span> that we sent (people we want to see profile and posts of). For each user in the first table, there are two buttons. A button that performs an Ajax call to <span class="strong"><strong>accept</strong></span> a pending friendship request, and a button to <span class="strong"><strong>deny</strong></span> friendship. For each user in the second table, there is a column that informs us of whether our request was accepted, and a column with a button to cancel the friendship relation (whether pending or established).
</p><p>Notice how <code class="literal">{{=name_of(user)}}</code> and <code class="literal">{{=name_of(message.posted_by)}}</code> require a database lookup. Our application can be sped up by caching the output of this function.
</p></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec06"/>Using crud.archive</h1></div></div></div><p>In this recipe, we discuss how to create full versioning for records in any application.<a id="id76" class="indexterm"/>
</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec06"/>How to do it...</h2></div></div></div><p>If you have any table, for example,<code class="literal"> db.mytable</code>, that needs versioning, and you use<code class="literal"> crud.update</code>, you can store a full revision history for your records, by passing<code class="literal"> onaccept=crud.archive</code> to<code class="literal"> crud.update</code>. Here is an example:</p><div class="informalexample"><pre class="programlisting">
form = crud.update(db.mytable, myrecord,
	onaccept=crud.archive,
	deletable=False)
</pre></div><p>
<code class="literal">crud.archive</code> will create a hidden table<code class="literal"> db.mytable_archive</code>, and store the old record, before update, in the newly created table, including a reference to the current record.</p><p>Normally, this new table is hidden and only visible to web2py internals, but you can have access to it by defining it explicitly in the model. If the original table was called<code class="literal"> db.mytable</code>, the archive table must be called<code class="literal"> db.mytable_archive</code> (postfix the original one with<code class="literal"> _archive)</code>, and it must extend the original table with a reference field called<code class="literal"> current_record</code>. Here is a concrete example:</p><div class="informalexample"><pre class="programlisting">
db.define_table('mytable_archive',
	Field('current_record', db.mytable),
	db.mytable)
</pre></div><p>For a different table, just replace<code class="literal"> mytable</code> with the actual table name. Everything else stays the same.</p><p>Notice such table includes all fields of<code class="literal"> db.mytable</code> plus one<code class="literal"> current_record</code>.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec07"/>There's more...</h2></div></div></div><p>Let's take a look at other features of<code class="literal"> crud.archive</code>.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec01"/>Timestamping the stored record</h3></div></div></div><p>
<code class="literal">crud.archive</code> does not timestamp the stored record, unless your original table has a timestamp and signature. For example:<a id="id77" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
db.define_table('mytable',
	...
	auth.signature)
</pre></div><p>By adding<code class="literal"> auth.signature</code> to the table, we are adding the following fields:</p><div class="informalexample"><pre class="programlisting">
Field('is_active', 'boolean', default=True),
Field('created_on', 'datetime', default=request.now,
	writable=False, readable=False),
Field('created_by', db.auth_user, default=auth.user_id, writable=False, readable=False),
Field('modified_on', 'datetime',
	update=default.now, default=request.now,
	writable=False, readable=False),
Field('modified_by', db.table_user,
	default=auth.user_id, update=auth.user_id,
	writable=False, readable=False)
</pre></div><p>You can also do this manually (without<code class="literal"> auth.signature)</code>, and give any name to the signature and timestamp fields.<code class="literal"> crud.archive</code> handles them transparently. They are filled by the<code class="literal"> SQLFORM.accepts</code> function.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl3sec02"/>Storing the history of each record</h3></div></div></div><p>The main idea behind<code class="literal"> crud.archive</code> is that of storing the history of each record that is edited, and storing previous revisions in a separate table. This allows you to edit the record without breaking references to it. Moreover, if you alter (migrate) the original table, the archive table will migrate as well. The only catch is that deleting a record in the original table will cause a cascade delete in the archive table, and the entire previous history for the record is deleted. Hence, probably, you do not want to ever delete records, but just make them<span class="strong"><strong> disabled</strong></span>, by unchecking the<code class="literal"> is_active</code> field.<a id="id78" class="indexterm"/>
</p><p>You will also have to change the query in some<code class="literal"> select</code> statements to hide records that are disabled, by filtering records with the following:</p><div class="informalexample"><pre class="programlisting">db.mytable.is_active==True
</pre></div></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec07"/>Converting an existing static site into a web2py application</h1></div></div></div><p>We will assume that you have a collection of static HTML files, CSS files, JavaScript files, and images in one folder, and that you wish to turn them into a web2py application. There are two ways to do it: a naive way, in which existing HTML files continue to be treated as static, and a more complex way, in which HTML files are associated to controller actions, so that one can add some dynamic content later on.<a id="id79" class="indexterm"/>
</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec08"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>A naive way consists simply of creating a new web2py application (or using an existing one), and using a static folder. For example, create a new application called<code class="literal"> app</code>, and copy the entire directory structure of your existing site under<code class="literal"> applications/app/static/</code>.</p><p>In this way, a static file, <code class="literal">applications/app/static/example.html</code> can be accessed at the URL: <code class="literal">http://127.0.0.1:8000/app/static/example.html.
</code>
</p><p>While this process does not break relative URLs (URLs that do not start with a forward slash), such as: <code class="literal">&lt;a href="../path/to/example2.html"&gt;click me&lt;/a&gt;</code>, it may break absolute URLs (which start with a forward slash) such as: <code class="literal">&lt;a href="/path/to/example2.html"&gt;click me&lt;/a&gt;.
</code>
<a id="id80" class="indexterm"/>
</p><p>This is not a web2py-specific problem, but rather an indication of poor design of those HTML files, since the absolute links break every time the folder structure is moved into another folder.
</p></li><li class="listitem"><p>The proper way to solve this problem, in case it occurs, consists of replacing all absolute URLS with relative ones. Here is an example.</p><p>If a file, <code class="literal">static/path1/example1.html</code>, contains a link like <code class="literal">&lt;a href="/path/to/example2.html"&gt;click me&lt;/a&gt;</code>, and the file <code class="literal">example2.html</code>, appears under <code class="literal">static/path2/example2.html</code>, then the link should be replaced by <code class="literal">&lt;a href="../path2/example2.html"&gt;click me&lt;/a&gt;.
</code>
</p><p>Here the ../ moves out of the <code class="literal">static/path</code>1 folder into the static folder, and the rest of the path (<code class="literal">path2/example2.html</code>) correctly identifies the desired file.
</p></li><li class="listitem"><p>A simple search for<code class="literal"> href, src</code>, and<code class="literal"> url</code> should allow you to locate all the URLS in the HTML, CSS, and JavaScript files. All the URLS starting with a<code class="literal"> /</code> need to be fixed.</p></li><li class="listitem"><p>A more sophisticated approach consists of moving all images, movies, CSS, and JavaScript files into the static folder, and converting HTML files into views.</p><p>We proceed in five steps:
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>We move all static files (except those ending in<code class="literal"> html)</code> to the application<code class="literal"> static/</code> folder.</p></li><li class="listitem"><p>We create a new controller (for example, one called<code class="literal"> controllers/legacy.py)</code>, and a new<code class="literal"> views</code> folder (for example<code class="literal"> views/legacy)</code>.</p></li><li class="listitem"><p>We move all the HTML files (for example,<code class="literal"> page.html)</code> under the new views folder.</p></li><li class="listitem"><p>For each<code class="literal"> view</code> file, we create a controller action with the same name returning<code class="literal"> dict()</code>.</p></li><li class="listitem"><p>We replace all internal links and references with<code class="literal"> URL(...)</code>.</p></li></ul></div></li><li class="listitem"><p>Let's consider a concrete example consisting of the following files:</p><div class="informalexample"><pre class="programlisting">page.html
image.png
</pre></div><p>Here, page.html contains &lt;img src="image.png" /&gt;. We end up with the following file structure in our web2py application folder:
<a id="id81" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">controllers/legacy.py
views/legacy/page.html
static/image.png
</pre></div><p>Here, legacy.py contains
</p><div class="informalexample"><pre class="programlisting">def page(): return dict()
</pre></div><p>and &lt;img src="image.png"/&gt; in page.html is replaced by
</p><div class="informalexample"><pre class="programlisting">&lt;img src="{{=URL('static', 'image.png')}}"/&gt;
</pre></div></li></ol></div><p>The page is now accessible at the following URL:</p><p>
<code class="literal">http://127.0.0.1:8000/app/legacy/page.html</code>.</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec08"/>Creating semi-static pages (flatpages)</h1></div></div></div><p>Any web application contains pages that are static, and whose content does not change very often. They are called<span class="strong"><strong> flatpages</strong></span>. They can be handled by embedding a CMS into the application (for example<code class="literal"> plugin_wiki)</code> or using the explicit mechanism described in this recipe.<a id="id82" class="indexterm"/>
</p><p>Examples of flatpages are:<a id="id83" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Basic home and indexes</p></li><li class="listitem"><p>About us</p></li><li class="listitem"><p>License and disclaimer</p></li></ul></div><p>With web2py, for these pages, we could set up simple controllers such as:</p><div class="informalexample"><pre class="programlisting">def about(): return dict()
</pre></div><p>And you can then code the page in the view directly, or store the page content in the database. This second approach is better, because it would allow easy in-place user editing, multiple-language internationalization support, log change history for audits, and much more.</p><p>The idea of this recipe is to store the flatpages in the database, and display them according the user request (controller, function, args, preferred language, and so on.)</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec09"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>First, define a flatpage table to store the page contents, create a file in models called<code class="literal"> flatpages.py</code>, and add the following definition:<a id="id84" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
LANGUAGES = ('en', 'es', 'pt', 'fr', 'hi', 'hu', 'it', 'pl', 'ru')
FLATPAGES_ADMIN = 'you@example.com'
DEFAULT_FLATPAGE_VIEW = "flatpage.html"
db.define_table('flatpage',
	Field('title', notnull=True),
	Field('subtitle', notnull=True),
	Field('c', label='controller'),
	Field('f', label='function'),
	Field('args', label='arguments'),
	Field('view', default=DEFAULT_FLATPAGE_VIEW),
	Field('lang', requires=IS_IN_SET(LANGUAGES), default='en'),
	Field('body', 'text', default=''),
	auth.signature,
)
</pre></div><p>The fields are:
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
<code class="literal">title:</code> This is the main title</p></li><li class="listitem"><p>
<code class="literal">subtitle:</code> This is the optional subtitle</p></li><li class="listitem"><p>
<code class="literal">c:</code> This is the controller for who this page belongs to (see URL helper)</p></li><li class="listitem"><p>
<code class="literal">f:</code> This is the function for who this page belongs to (see URL helper)</p></li><li class="listitem"><p>
<code class="literal">args:</code> This is the string argument to add several pages to a function (see URL helper)</p></li><li class="listitem"><p>
<code class="literal">lang:</code> This is the language to match user preferences</p></li><li class="listitem"><p>
<code class="literal">body:</code> This is the the page HTML body</p><p>Notice that the <code class="literal">FLATPAGES_ADMIN</code> will be used to limit the edit access to the flatpages. This variable contains the e-mail of the user that will be allowed to edit.
</p></li></ul></div></li><li class="listitem"><p>At this point, you should be able to populate this table using the<code class="literal"> appadmin</code> administrative interface, or you can do it programmatically, that is, creating a<code class="literal"> setup_flatpage</code> function in a controller, such as the following:</p><div class="informalexample"><pre class="programlisting">
if not db(db.flatpage).count():
	db.flatpage.insert(title="Home", subtitle="Main Index",
		c="default", f='index', body="&lt;h3&gt;Hello world!&lt;/h3&gt;")
	db.flatpage.insert(title="About us", subtitle="The company",
		c="company", f='about_us', body="&lt;h3&gt;My company!&lt;/h3&gt;")
	db.flatpage.insert(title="Mision &amp; Vision", subtitle="The company",
		c="company", f='mision_vision', body="&lt;h3&gt; Our vision is...&lt;/h3&gt;")
	db.flatpage.insert(title="Our Team", subtitle="Who we are",
		c="company", f='our_team', body="&lt;h1&gt;We are...&lt;/h3&gt;") db.flatpage.insert(title="Contact Us", subtitle="Where we are", c="company", f='contact_us', body="&lt;h3&gt;Contact form:...&lt;/h3&gt;")
</pre></div><p>This example page will look as follows:
</p><div class="informalexample"><pre class="programlisting">
Home: Hello world
About Us
	The Company : My company!
Mission &amp; Vision: Our vision is...
Our Team: We are...
Contact Us: Contact Form:...
</pre></div></li><li class="listitem"><p>To be able to render a page, add to the previously created file<code class="literal"> models/flatpage.py</code> the following function flatpage:</p><div class="informalexample"><pre class="programlisting">
def flatpage():
	# define languages that don't need translation:
	T.current_languages = ['en', 'en-en']
	
	# select user specified language (via session or browser config)
	if session.lang:
		lang = session.lang
	elif T.accepted_language is not None:
		lang = T.accepted_language[:2]
	else:
		lang = "en"
		T.force(lang)
		
title = subtitle = body = ""
flatpage_id = None
form = ''
view = DEFAULT_FLATPAGE_VIEW

if request.vars and auth.user and
	auth.user.email==FLATPAGES_ADMIN:
	# create a form to edit the page:
	record = db.flatpage(request.get_vars.id)
	form = SQLFORM(db.flatpage, record)
if form.accepts(request, session):
	response.flash = T("Page saved")
elif form.errors:
	response.flash = T("Errors!")
else:
	response.flash = T("Edit Page")
	
if not form:
	# search flatpage according to the current request
	query = db.flatpage.c==request.controller
	query &amp;= db.flatpage.f==request.function
if request.args:
	query &amp;= db.flatpage.args==request.args(0)
else:
	query &amp;= (db.flatpage.args==None)|(db.flatpage.args=='')
	query &amp;= db.flatpage.lang==lang
	# execute the query, fetch one record (if any)
	flatpage =
		db(query).select(orderby=~db.flatpage.created_on,
	limitby=(0, 1), cache=(cache.ram, 60)).first()
if flatpage:
	flatpage_id = flatpage.id
	title = flatpage.title
	subtitle = flatpage.subtitle
	body = flatpage.body
	view = flatpage.view
else:
	response.flash = T("Page Not Found!")
if auth.user and auth.user.email==FLATPAGES_ADMIN:
	# if user is authenticated, show edit button:
	form = A(T('edit'),
		_href=URL(vars=dict(id=flatpage_id)))
		
# render the page:
response.title = title
response.subtitle = subtitle
response.view = view
body = XML(body)
return dict(body=body, form=form)
</pre></div><p>This function:
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Checks user language preferences (or session setting)</p></li><li class="listitem"><p>Checks action URL (according to request controller, function, and args)<a id="id85" class="indexterm"/>
</p></li><li class="listitem"><p>Fetches stored flatpage</p></li><li class="listitem"><p>Renders the page HTML</p><p>If the user <code class="literal">FLATPAGES_ADMIN</code> is logged in, the function flatpage:
</p></li><li class="listitem"><p>Prepares/processes an<code class="literal"> SQLFORM</code> if editing the page</p></li><li class="listitem"><p>Or shows an<span class="strong"><strong> EDIT</strong></span> button to edit the page</p></li></ul></div></li><li class="listitem"><p>Finally, you should create a<code class="literal"> flatpage.html</code> view, so that web2py can render the page, for example:</p><div class="informalexample"><pre class="programlisting">{{extend 'layout.html'}}
&lt;h1&gt;{{=response.title}}&lt;/h1&gt;
&lt;h2&gt;{{=response.subtitle}}&lt;/h2&gt;
{{=form}}
{{=body}}
</pre></div><p>The placeholders are:
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
<code class="literal">form:</code> This is the edit<code class="literal"> FORM</code> (or the link to edit)</p></li><li class="listitem"><p>
<code class="literal">body:</code> These are the actual page contents (stored in the database as HTML)</p></li></ul></div></li><li class="listitem"><p>To tell web2py to show a flatpage in the desired controller (that is,<code class="literal"> index</code> in<code class="literal"> default.py)</code>, write the following:</p><div class="informalexample"><pre class="programlisting">def index(): return flatpage()
</pre></div><p>This will render the flatpage for the home page.
<a id="id86" class="indexterm"/>
</p><p><code class="literal">company.py</code> sample controller will look as follows:
</p><div class="informalexample"><pre class="programlisting">def about_us(): return flatpage()
def mision_vision(): return flatpage()
def our_team(): return flatpage()
</pre></div><p>When you go to <code class="literal">default/index.php</code> or <code class="literal">company/about_us</code>, you should get a flatpage with an <code class="literal">EDIT</code> button, if you are logged in.
</p></li></ol></div><p>Remember that, for performance reasons, flatpages are cached. So, changes may not be seen immediately (you can change this by clearing the cache or removing the cache parameter at the database query).</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec10"/>How it works...</h2></div></div></div><p>With web2py, you can completely choose what content will be displayed, what view will be used, and so on.</p><p>In this case, when web2py executes your controller, the function<code class="literal"> flatpage()</code> will try to fetch the stored page in the database according the request variables.</p><p>An<code class="literal"> SQLFORM</code> will be rendered if the<span class="strong"><strong> Edit</strong></span> button is pressed, to allow page editing by normal authenticated users. Page updates are inserted, so you'll get a history of page changes. It shows the latest record of the page, trying to match the preferred language (for example, use<code class="literal"> session.lang = 'es'</code> to change the language).</p><p>You can add a<code class="literal"> view</code> field to flatpage table, so you could have multiple views to show this kind of content. You can even add a<code class="literal"> format</code> field, so that you can render the page body in other markup languages other than HTML (wiki, ReST, and so on).</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec09"/>Adding your custom logo</h1></div></div></div><p>We are going to change the default logo that came with web2py, and add our logo instead. We need an image editor; use your preferred one, or use the ones that come with the operating system. Paint, GIMP, or Photoshop are appropriate.<a id="id87" class="indexterm"/>
</p><div class="mediaobject"><img src="images/5467OS_02_25.jpg" alt="Adding your custom logo"/></div><p>This is the look of the default application:</p><div class="mediaobject"><img src="images/5467OS_02_26.jpg" alt="Adding your custom logo"/></div><p>This is the result of customizing the logo.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec11"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>First, we need to create a new application. You can do that through the<code class="literal"> admin</code> application. Choose<span class="strong"><strong> Create a new application</strong></span>, and name it. The name of my application is<code class="literal"> changelogo</code>. By default, the new application is a copy of the<code class="literal"> welcome</code> scaffolding application. Now, if you run your application, you will see at the top of the application the title of your application followed by the word<code class="literal"> App</code>, in my case<code class="literal"> changelogoApp</code>.<a id="id88" class="indexterm"/>
</p></li><li class="listitem"><p>Fire up your image editor, and make your logo, if you are going to start a new one. Choose a pixel dimension, according to the layout you are using. I chose a dimension of<code class="literal"> 300x90</code> pixels for my new logo. When you finish editing it, save it in PNG or JPEG format. Name it (for example,<code class="literal"> mylogoapp.png)</code>, and copy to the<code class="literal"> static/images</code> directory inside your application.</p></li><li class="listitem"><p>The next step is to edit<code class="literal"> views/layout.html</code> of your application. You can use the admin or your own editor. Scroll down to the header section looking for the following:</p><div class="informalexample"><pre class="programlisting">
&lt;div id="header"&gt; &lt;!-- header and login nav --&gt;
	{{block header}} &lt;!-- this is default header --&gt;
	{{try:}}{{=auth.navbar(action=URL('default',
		'user'))}}{{except:pass}}
	&lt;h1&gt;
		&lt;span id="appname"&gt;
			{{=request.application.capitalize()}}
		&lt;/span&gt;
		App
	&lt;/h1&gt;
	&lt;div style="clear: both;"&gt;&lt;/div&gt;&lt;!-- Clear the divs --&gt;
	{{end}}
&lt;/div&gt;&lt;!-- header --&gt;
</pre></div></li><li class="listitem"><p>Let me explain the code a bit.<a id="id89" class="indexterm"/>
</p><p>The following code prints the user actions, such as login, register, and lost-password:
</p><div class="informalexample"><pre class="programlisting">
{{try:}}{{=auth.navbar(action=URL('default',
	'user'))}}{{except:pass}}
</pre></div><p>The following code prints the application name followed by <code class="literal">App:
</code>
</p><div class="informalexample"><pre class="programlisting">
&lt;h1&gt;
	&lt;span id="appname"&gt;
		{{=request.application.capitalize()}}
	&lt;/span&gt;
	App
&lt;/h1&gt;
</pre></div><p>We need to change this to show the new logo. We will replace the &lt;h1&gt;... &lt;/h1&gt; with the following:
</p><div class="informalexample"><pre class="programlisting">
{{=IMG(_src=URL('static', 'images/mylogoapp.png'), _style="width:
	100%;")}}
</pre></div><p>This will print the logo image instead of the title.
</p><p>The header section now looks as follows:
</p><div class="informalexample"><pre class="programlisting">
&lt;div id="header"&gt; &lt;!-- header and login nav --&gt;
	{{block header}} &lt;!-- this is default header --&gt;
	{{try:}}{{=auth.navbar(action=URL('default',
		'user'))}}{{except:pass}}
	{{=IMG(_src=URL('static', 'images/mylogoapp.png'))}}
	&lt;div style="clear: both;"&gt;&lt;/div&gt;&lt;!-- Clear the divs --&gt;
	{{end}}
&lt;/div&gt;&lt;!-- header --&gt;
</pre></div></li><li class="listitem"><p>Finally, it's a good practice that the logo links to the main page, so we will make a link to<code class="literal"> default/index:</code>
</p><div class="informalexample"><pre class="programlisting">
{{=A(IMG(_src=URL('static', 'images/mylogoapp.png')),
	_href=URL('default', 'index'))}}
</pre></div></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec10"/>Creating menus and submenus</h1></div></div></div><p>web2py handles menus in a transparent way, as follows:<a id="id90" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>A list of menu items is stored, by convention, in<code class="literal"> response.menu</code>
</p></li><li class="listitem"><p>The menu is embedded in a view with<code class="literal"> {{=MENU(response.menu)}}</code>
</p></li></ul></div><p>You can have more than one menu in different places of the same view, or in different views. The value of<code class="literal"> response.menu</code> is a list of menu items. Normally, each menu item is a list of tuple containing the following elements:<span class="strong"><strong> title, status, link</strong></span>, and<span class="strong"><strong> submenu</strong></span>.</p><p>Where title is the title of the menu, status is a Boolean that can be used to determine whether the menu link is the current page, link is the link to be redirected to when selecting the menu item, and submenu is a list of menu items.</p><p>Here is an example of code that one would normally put in the file<code class="literal"> models/menu.py:</code>
</p><div class="informalexample"><pre class="programlisting">
response.menu = [
	('Home', URL()==URL('default', 'home'), URL('default', 'home'),
		[]),
	('Search', URL()==URL('default', 'search'), URL('default',
		'search'), []),
]
</pre></div><p>The condition we used as the second argument checks whether the current page<code class="literal"> URL()</code> is the page linked.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec12"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Submenus can easily be built explicitly, as follows:</p><div class="informalexample"><pre class="programlisting">
response.menu = [
	('Home', URL()==URL('default', 'home'), URL('default', 'home'),
		[]),
	('Search', False, None,
		[
			('Local', URL()==URL('default', 'search'), URL('default',
				'search')),
			('Google', False, 'http://google.com'),
			('Bing', False, 'http://bing.com'),
		]
	),
]
</pre></div></li><li class="listitem"><p>The parent of a submenu may or may not have a link. In this example, we moved the link from<code class="literal"> Search</code> to its<code class="literal"> Local</code> submenu item. It is good practice to internationalize the menu titles.</p><div class="informalexample"><pre class="programlisting">
response.menu = [
	(T('Home'), URL()==URL('default', 'home'), URL('default',
		'home'), []),
]
</pre></div></li><li class="listitem"><p>It is also important to specify the controller name (<code class="literal">default</code> in the example) for each link; otherwise, menus break when there are multiple controllers (and that is almost always the case; think of<code class="literal"> appadmin)</code>.<a id="id91" class="indexterm"/>
</p></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec11"/>Customizing menus with icons</h1></div></div></div><p>Sometimes, you want to customize a menu item more than the usual syntax seems to allow, for example, by adding icons to your menu items. This recipe shows you how.<a id="id92" class="indexterm"/>
</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec13"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>The first thing to realize is that the following:</p><div class="informalexample"><pre class="programlisting">
response.menu = [
	('Home', False, URL('default', 'home'), []),
		...]
</pre></div><p>Is equivalent to the following:
</p><div class="informalexample"><pre class="programlisting">
response.menu = [
	(A('Home', _href=URL('default', 'home')), False, None, []),
		...]
</pre></div><p>Here, A is the anchor (link) helper. You can use the latter syntax, and you can replace the A helper with any other combination of helpers. For example:
</p><div class="informalexample"><pre class="programlisting">
response.menu = [
	(A(IMG(_src=URL('static', 'home.png'), _href=URL('default',
		'home'))), False, None, []),
			...
]
</pre></div><p>Or:
</p><div class="informalexample"><pre class="programlisting">
response.menu = [
	(SPAN(IMG(_src=URL('static', 'home.png')),	
		A('home', _href=URL('default', 'home'))), False, None, []),
			...
]
</pre></div></li><li class="listitem"><p>You can create functions that build your menu items:</p><div class="informalexample"><pre class="programlisting">
def item(name):
	return SPAN(IMG(_src=URL('static', name+'.png')), A(name,
	_href=URL('default', name)))
	
response.menu = [
	(item(home), False, None, []),
	...
<a id="id93" class="indexterm"/>
</pre></div></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec12"/>Creating a navigation bar</h1></div></div></div><p>web2py includes built-in support for menus, rendering using basic Python structures. In most cases, this is enough, but for more complex menus, it is difficult to maintain them using Python code exclusively. This recipe shows how to make a more dynamic menu, storing the menu entries in the database, and building the menu tree automatically.<a id="id94" class="indexterm"/>
</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec14"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>First, let's define a navigation bar table to store the menu entries. Create a file in<code class="literal"> models</code> called<code class="literal"> navbar.py</code>, and add the following definition:</p><div class="informalexample"><pre class="programlisting">
db.define_table('navbar',
	Field("title", "string"),
	Field("url", "string", requires=IS_EMPTY_OR(IS_URL())),
	Field("c", label="Controller"),
	Field("f", label="Function"),
	Field("args", label="Arguments"),
	Field("sortable", "integer"),
	Field("parent_id", "reference navbar"),
	format="%(title)s",
)
</pre></div><p>The fields are:
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
<code class="literal">title:</code> This is the text shown to the user</p></li><li class="listitem"><p>
<code class="literal">url:</code> This is the optional URL to link to</p></li><li class="listitem"><p>
<code class="literal">c:</code> This is the controller to build a link (see URL helper)</p></li><li class="listitem"><p>
<code class="literal">f:</code> This is the function to build a link (see URL helper)</p></li><li class="listitem"><p>
<code class="literal">args:</code> This is the string argument to build a link (see URL helper)</p></li><li class="listitem"><p>
<code class="literal">sortable:</code> This is a numeric value to sort the entries</p></li><li class="listitem"><p>
<code class="literal">parent_id:</code> This is the reference (<code class="literal">navbar.id</code>) of the higher-level menu ancestor (whose item is a submenu)</p></li></ul></div></li><li class="listitem"><p>At this point, you should be able to populate this table using the<code class="literal"> appadmin</code> administrative interface, or you can do it programmatically by creating a<code class="literal"> setup_navbar</code> function in a controller, such as the following:</p><div class="informalexample"><pre class="programlisting">
if not db(db.navbar).count():
	# create default index entry:
	home_id = db.navbar.insert(title="Home", c="default")
	
	# create a "Company" leaf with typical options:
	company_id = db.navbar.insert(title="Company", c="company")
	db.navbar.insert(title="About Us", f='about_us',
		parent_id=company_id)
	db.navbar.insert(title="Mision &amp; Vision", f='mision_vision',
		parent_id=company_id)
	db.navbar.insert(title="Our Team", f='our_team',
		parent_id=company_id)
		
	products_id = db.navbar.insert(title="Products", c="products")
	# Add some "Computers models" to products entry:
	computers_id = db.navbar.insert(title="Computers",
		f='computers', parent_id=products_id)
	for model in 'basic', 'pro', 'gamer':
		db.navbar.insert(title="Model %s" % model, args=model,
			parent_id=computers_id)
</pre></div><p>This example menu looks like the following:
</p><div class="informalexample"><pre class="programlisting">
Home
Company
	About Us
	Mission &amp; Vision
	Our Team
Products
	Computers
		Model basic
		Model pro
		Model gamer
</pre></div><p>Each top-level menu links to a specific controller, second-level submenus link to functions on that controller, and third-level entries supply arguments to those functions (note that you can use the same defaults for URL parameters c and f, which will be used hierarchically, using the inherited value).
</p></li><li class="listitem"><p>Now, to show the menu, add to the previously created file<code class="literal"> navbar.py</code> in<code class="literal"> models</code> the following functions of<code class="literal"> get_sub_menus:</code>
<a id="id95" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
def get_sub_menus(parent_id, default_c=None, default_f=None):
	children = db(db.navbar.parent_id==parent_id)
	for menu_entry in children.select(orderby=db.navbar.sortable):
		# get action or use defaults:
		c = menu_entry.c or default_c
		f = menu_entry.f or default_f
	# is this entry selected? (current page)
	sel = (request.controller==c and request.function==f and
		(request.args and request.args==menu_entry.args or True))
	# return each menu item
	yield (T(menu_entry.title),
	sel, menu_entry.url or URL(c, f, args=menu_entry.args),
	get_sub_menus(menu_entry.id, c, f)
)
</pre></div><p>This function recursively builds the Python structure needed to render the menu in the HTML page, and does the following:
<a id="id96" class="indexterm"/>
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Fetches the<code class="literal"> navbar</code> menu entries for the solicited level</p></li><li class="listitem"><p>Checks action destination or uses defaults (for<code class="literal"> URL</code> helper)</p></li><li class="listitem"><p>Calculates if this entry is the current selected one</p></li><li class="listitem"><p>Makes and gives back the item to be used with the<code class="literal"> MENU</code> helper</p></li></ul></div></li><li class="listitem"><p>To tell web2py to build the menu, use the following in the same<code class="literal"> navbar</code> model:</p><div class="informalexample"><pre class="programlisting">response.menu = get_sub_menus(parent_id=None)
</pre></div><p>This will build the menu each time a page is viewed.
</p></li><li class="listitem"><p>If you have a complex menu that doesn't change often, you can reuse it several times, using a cache to keep it in memory:</p><div class="informalexample"><pre class="programlisting">
response.menu = cache.ram('navbar_menu', lambda:
	get_sub_menus(parent_id=None), time_expire=60)
</pre></div></li></ol></div><p>The menu is usually rendered in a page with the<code class="literal"> MENU</code> helper that interprets this structure (see<code class="literal"> views, layout.html):</code>
</p><div class="informalexample"><pre class="programlisting">{{=MENU(response.menu, _class='sf-menu')}}
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec13"/>Using cookies to set the language</h1></div></div></div><p>By default, web2py determines the preferred user language from the<span class="strong"><strong> HTTP Accept- Language header</strong></span>.<a id="id97" class="indexterm"/>
</p><p>Here is an example of the normal workflow:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>A user sets the browser preferences to<code class="literal"> en</code> (English),<code class="literal"> en-us</code> (English spoken in US), and<code class="literal"> fr-fr</code> (French spoken in France)</p></li><li class="listitem"><p>When visiting our website, the browser sends the list of accepted languages in the HTTP header<code class="literal"> Accept-Language</code>
</p></li><li class="listitem"><p>web2py parses the HTTP headers, validates the<code class="literal"> Accept-Language</code> list, and loops over its languages</p></li><li class="listitem"><p>web2py stops looping when a language appears in<code class="literal"> T.current_languages</code>, or when a corresponding language file (for example<code class="literal"> fr-fr.py)</code> is found in the language subfolder of the request application (<code class="literal">applications/app/languages</code>)</p></li></ul></div><p>If web2py stops looping because a language, for example<code class="literal"> en-en</code>, appears in<code class="literal"> T.current_languages</code>, it means that the language does not need translation. If, instead, web2py stops looping because a language file if found, that language file will be used for translation. If neither of the two conditions are met for all of the languages in<code class="literal"> Accept-Language</code>, there is no translation.</p><p>Normally, this selection is performed by web2py before calling the application code.</p><p>Within the application code (for example, in a model), you can override default settings. You can change the list of current languages:</p><div class="informalexample"><pre class="programlisting">T.set_current_languages('en', 'en-en')
</pre></div><p>You can also force web2py to pick a language from a different list than the one provided in the HTTP header:<a id="id98" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">T.force('it-it')
</pre></div><p>Often, you do not want the web application to rely on the browser to determine the language preference, but you want to ask the visitor explicitly through buttons, links, or a drop-down box. When this happens, the application needs to remember the selection as the user browses through the application pages.</p><p>If the application requires a login, this preference can be stored in the user profile, for example, in a custom field of the<code class="literal"> auth_user</code> table.</p><p>But not all applications require a login, and often, the language preference is expressed before registration. A convenient and transparent way to set and remember the language that does not require a database, is to store the preference in a cookie. This can be achieved in the following way.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec15"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Create a<code class="literal"> model</code> file, for example<code class="literal"> 0_select_language.py</code>, that contains the following code:</p><div class="informalexample"><pre class="programlisting">
if 'all_lang' in request.cookies and not
	(request.cookies['all_lang'] is None):
	T.force(request.cookies['all_lang'].value)
</pre></div></li><li class="listitem"><p>Insert the following somewhere in<code class="literal"> views/layout.html:</code>
</p><div class="informalexample"><pre class="programlisting">
&lt;span&gt;
	&lt;script&gt;
		function set_lang(lang) {
			var date = new Date();
			cookieDate=date.setTime(date.getTime()+(100*24*60*60*1000));
			document.cookie='all_lang='+lang+';expires='+cookieDate+';
				path=/{{=request.application}}';
			window.location.reload();
		};
	&lt;/script&gt;
	&lt;select name="adminlanguage"
		onchange="set_lang(jQuery(this).val())"&gt;
		{{for language in T.get_possible_languages():}}
		&lt;option {{=T.accepted_language==language and 'selected' or
			''}}&gt;
			{{=T(language)}}
		&lt;/option&gt;
		{{pass}}
	&lt;/select&gt;
&lt;/span&gt;
</pre></div><p>The previous code produces a select-language drop-down box, listing all languages for which web2py can find a translation file. When the value of the drop-down box changes, it forces a reload of the page. Upon reload, the code sets a cookie called <code class="literal">all_lang</code> that contains the selected language. When another page is loaded, if the code above finds the cookie, it uses the information in the cookie to choose and force the language selection.
</p></li><li class="listitem"><p>The same can be achieved more explicitly using links instead of a drop-down box:<a id="id99" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
&lt;span&gt;
	&lt;script&gt;
		function set_lang(lang) {
			var date = new Date();
			cookieDate=date.setTime(date.getTime()+(100*24*60*60*1000));
			document.cookie='all_lang='+lang+';expires='+cookieDate+';
				path=/{{=request.application}}';
			window.location.reload();
			return false;
		};
	&lt;/script&gt;
		{{for language in T.get_possible_languages():}} {{if not T.accepted_language==language:}}
			&lt;a href="#" onclick="set_lang('{{=language}}')"&gt;
				{{=T(language)}}
			&lt;/a&gt;
			{{else:}}{{=T(language)}}{{pass}}{{pass}}
	&lt;/select&gt;
&lt;/span&gt;
</pre></div><p>This solution works even if the application does not use sessions.
</p></li></ol></div><p>Notice that the name of the language is itself translated, that is<code class="literal"> {{=T(language)}}</code>, because it should be listed in the current selected language.</p><p>Also notice the following string is inside the cookie, which makes sure the preference applies only to the current application. This line is interpreted by the client-side, and may need to be changed, if custom URLs are enabled through routes:</p><div class="informalexample"><pre class="programlisting">path=/{{=request.application}}
</pre></div><p>In this case, a simple solution is to replace it with the following, and the preference will apply to all the applications under the same web2py installation, regardless of the URL:<a id="id100" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">path=/
</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec14"/>Designing modular applications</h1></div></div></div><p>In this recipe, we will show you how to create a modular application using web2py components.<a id="id101" class="indexterm"/>
</p><p>In particular, we will consider, as an example, an application that will allow you to create items, list items, and have the list updated dynamically when new items are created/updated.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec16"/>Getting ready</h2></div></div></div><p>We will consider the scaffolding application with the following additional model<code class="literal"> models/db_items.py:</code>
</p><div class="informalexample"><pre class="programlisting">
db.define_table('mytable',
	Field('name'),
	Field('quantity','integer'))
</pre></div><p>Notice that there is nothing specific about this table or its field structure, but we will use the<code class="literal"> db.mytable</code> in the following example.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec17"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>In<code class="literal"> controllers/default.py</code>, create a base action to load the components in the view and the controllers, to actually list and edit items:</p><div class="informalexample"><pre class="programlisting">
def index():
	"index will load the list and the create/edit forms as
	components"
	return dict()
	
def list_items():
	""" shows a list of items that were created
	each items is clickable and can be edited """
   rows = db(db.mytable.id&gt;0).select()
	return dict(rows=rows)
	
def edit_item():
	""" return a creation form if no item is specified,
	return an edit form if the item is known """
	def display_changed(data):
		response.ajax = \
		'web2py_component("%s","show_itemlist")' % URL('showitems')
	form = crud.update(db.mytable,
		request.args(0),onaccept=display_changed)
	return form
</pre></div></li><li class="listitem"><p>In the view<code class="literal"> views/default/index.html</code>, just load the component to list the items and link the edit function (using a placeholder that will be used to insert the form to create or edit items):</p><div class="informalexample"><pre class="programlisting">
{{=LOAD('default', 'list_items', ajax = True, target =
'showitems')}}
{{=A('create',component=URL('edit_item'),target='placeholder')}}
&lt;div id="placeholder"&gt;&lt;/div&gt;
</pre></div></li><li class="listitem"><p>In the view<code class="literal"> views/default/list_items.html</code>, each item on the item list will load the specified URL into the<code class="literal"> div</code> with the ID<code class="literal"> placeholder</code>.</p><div class="informalexample"><pre class="programlisting">
&lt;ul&gt;
	{{for item in rows:}}
		{{=LI(A('edit %s' % item.name,
			component=URL('edit_item',args=item.id),
			target='placeholder'))}}
	{{pass}}
&lt;/ul&gt;
</pre></div></li></ol></div><p>A view for the action<code class="literal"> edit_item</code> is not necessary, since it returns a helper, not a dict.<a id="id102" class="indexterm"/>
</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec18"/>How it works...</h2></div></div></div><p>The view index loads a list of items through Ajax into<code class="literal"> div#showitems</code>. It also displays a link and a<code class="literal"> div#placeholder</code>. Clicking on the link causes an Ajax request to<code class="literal"> edit_item</code>, without<code class="literal"> args</code> to return a<code class="literal"> create form</code> that is rendered inside<code class="literal"> div#placeholder</code>. The list also contains a link to<code class="literal"> edit_item</code>, which also displays an<code class="literal"> update form</code> into the<code class="literal"> div#placeholder</code>. The form is not just displayed tharough Ajax. The component is always loaded by clicking an<code class="literal"> A(...,component=URL(...),target="placeholder")</code>.</p><p>This ensures that the component is loaded through Ajax, and the forms in the component will be submitted through Ajax, thus refreshing the component only. Any form submission will return a<code class="literal"> response.ajax</code>, which refreshes the other component<code class="literal"> div@list_items</code>.</p><p>Notice that all the logic is generated at the server-side, translated under the hood in the JS code that is embedded in the page, and executed at the client-side. Clicking on a link causes a form to be displayed. Submitting a form causes a form to be processed, and, if accepted, the list of items is refreshed.<a id="id103" class="indexterm"/>
</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec15"/>Speeding up downloads</h1></div></div></div><p>By default, the download function in the scaffolding controller sets the following HTTP response headers, preventing client-side caching:<a id="id104" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">Expires: Thu, 27 May 2010 05:06:44 GMT
Pragma: no-cache
Cache-Control: no-store, no-cache, must-revalidate, post-check=0,
pre-check=0
</pre></div><p>This may be good for some dynamic content, but, for example, a client browsing a site with several non static images, will see how each image loads every time the page is shown, slowing down navigation.</p><p>Caching download with the<code class="literal"> @cache</code> decorator does not help, because caching would be done at server-side, while we want client-side caching.</p><p>Moreover, the download function also performs some authorization checks, which, in some cases, are not necessary, and therefore cause an unwanted slow-down.</p><p>A better approach consists of using a custom download function, which allows client-side caching, and skips authorization.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec19"/>How to do it...</h2></div></div></div><p>We need to write a custom download function. We could edit the scaffolding one, but it's preferable to simply add another one that is call<code class="literal"> fast_download</code>, so we will have the choice to use one or the other in different parts of our application.</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>First of all, we want our application to return the following HTTP header:</p><div class="informalexample"><pre class="programlisting">Last-Modified: Tue, 04 May 2010 19:41:16 GMT
</pre></div></li><li class="listitem"><p>But omit these ones:</p><div class="informalexample"><pre class="programlisting">Expires removed
Pragma removed
Cache-control removed
</pre></div><p>This can be done by explicitly removing the unwanted headers before streaming back the file:
</p><div class="informalexample"><pre class="programlisting">
def fast_download():
	filename = request.args(0)
	if not qualify_for_fast_download(filename)
		return download()
	else:
		del response.headers['Cache-Control']
		del response.headers['Pragma']
		del response.headers['Expires']
		filepath = os.path.join(request.folder, 'uploads', filename)
		response.headers['Last-Modified'] = \
			time.strftime("%a, %d %b %Y %H:%M:%S +0000",
			time.localtime(os.path.getmtime(filename)))
		return response.stream(open(filepath, 'rb'))
</pre></div></li><li class="listitem"><p>Notice that<code class="literal"> response.stream</code> will handle<code class="literal"> Range requests</code> and<code class="literal"> If-Modified-Since</code> for you. Also notice that such an action could be used to download more files than it is intended to, so we insert a check, as follows:</p><div class="informalexample"><pre class="programlisting">qualify_for_fast_download(filename)
</pre></div><p>We leave this for you to implement.
</p><p>It will check if this function can be used, or the normal download function should be used.
</p></li><li class="listitem"><p>In your view, remember to make URLs using<code class="literal"> fast_download</code> instead of download:<a id="id105" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">URL('fast_download', args='filename')
</pre></div></li></ol></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ch02lvl2sec20"/>There's more...</h3></div></div></div><p>If the filename you want to make sure<code class="literal"> fast-download</code> is stored in an<span class="strong"><strong> upload</strong></span> type field, for example,<code class="literal"> mytable.myfield</code>, then you can configure your web server to serve it directly, and by-pass web2py completely. For example, if you are using Apache:</p><div class="informalexample"><pre class="programlisting">
AliasMatch ^/([^/]+)/static/(mytable\.myfield.*) \
	/home/www-data/web2py/applications/$1/static/$2
&lt;Directory /home/www-data/web2py/applications/*/static/&gt;
	Options -Indexes
	Order Allow,Deny
	Allow from all
&lt;/Directory&gt;
</pre></div><p>This works, because all filenames stored in<code class="literal"> mytable.myfield</code> are renamed by web2py upon upload, and their names start with <code class="literal">mytable.myfield</code>.</p></div></div></div></div></div>
</body></html>