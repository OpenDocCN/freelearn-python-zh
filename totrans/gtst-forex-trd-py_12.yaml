- en: '12'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '12'
- en: Sample Strategy – Trend-Following
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 样本策略 – 趋势跟踪
- en: 'In the previous chapter, we developed two trading applications: one to use
    in production and another one to facilitate the testing and research of trading
    strategies. Better said, these are two versions of the same application, with
    different data processing modules. We designed them so that the trading logic
    developed in the backtesting app could be used in the production one without modifications
    (or with just minimal modifications in complex cases). We also tested the code
    using a sample "*strategy"* and saw that the code worked correctly, but the "*strategy"*
    was steadily losing money – fortunately only on paper (and that’s why I consistently
    put this word in "italics").'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 在上一章中，我们开发了两个交易应用：一个用于生产，另一个用于促进交易策略的测试和研究。更好的说法是，这些都是同一应用的两个版本，具有不同的数据处理模块。我们设计它们，以便在回测应用中开发的交易逻辑可以在生产应用中使用，无需修改（或在复杂情况下只需进行最小修改）。我们还使用一个样本“策略”测试了代码，发现代码运行正确，但“策略”一直在亏损——幸运的是，只是在纸上（这就是为什么我始终用斜体这个词的原因）。
- en: Now it’s time to learn the process of researching and developing one of the
    most popular classical trading strategies applied to the FX market. We already
    discussed it earlier in the book, but only from a qualitative, not a quantitative,
    perspective. Now we will suggest a formal mathematical model and implement it
    in code. And, of course, we will backtest and check whether the result can be
    used for live trading.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，是时候学习研究并开发应用于外汇市场的一种最流行的经典交易策略的过程了。我们已经在书中讨论过它，但只是从定性而不是定量的角度。现在我们将提出一个正式的数学模型，并在代码中实现它。当然，我们还将进行回测，以检查结果是否可用于实际交易。
- en: 'In this chapter, we will consider trend-following strategies and learn about
    the following topics:'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将考虑趋势跟踪策略，并学习以下主题：
- en: Trend-following revisited – trading setup
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 回顾趋势跟踪 – 交易设置
- en: Choosing the market and preparing data
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 选择市场和准备数据
- en: Trend-following strategy – implementation
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 趋势跟踪策略 – 实施
- en: Trend-following revisited – trading setup
  id: totrans-8
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 回顾趋势跟踪 – 交易设置
- en: 'In [*Chapter 9*](B19145_09.xhtml#_idTextAnchor152), *Trading Strategies and
    Their Core Elements*, we considered trend-following and came to the conclusion
    that although it is one of the simplest and most intuitive trading strategies,
    we still need a set of rules that determine the following:'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 在[第9章](B19145_09.xhtml#_idTextAnchor152)《交易策略及其核心要素》中，我们考虑了趋势跟踪，并得出结论，尽管它是最简单和最直观的交易策略之一，我们仍然需要一套规则来确定以下内容：
- en: Whether there is a trend in the market
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 市场中是否存在趋势
- en: Whether the trend goes north or south (up or down, that is)
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 趋势是向北还是向南（即上升或下降）
- en: When it’s time to join the trend (buy or sell respectively)
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 当是时候加入趋势时（分别买入或卖出）
- en: When it’s time to exit the existing position (so we expect the trend to end
    and/or reverse)
  id: totrans-13
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 当是时候退出现有头寸时（因此我们预计趋势将结束和/或反转）
- en: Let’s understand more in the upcoming sections.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们在接下来的章节中了解更多。
- en: Determining a trend, part 1 – market model
  id: totrans-15
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 确定趋势，第1部分 – 市场模型
- en: If I ask you whether it’s sunny or rainy outdoors, I’m sure you won’t hesitate
    with an answer in most cases. You can easily tell one from another because you
    are very familiar with a number of attributes that help you make the decision.
    Indeed, it’s easy to tell light from darkness, warmth from cold, moisture from
    dryness, and so on.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我问你户外是晴天还是雨天，我确信在大多数情况下你不会犹豫给出答案。你可以很容易地区分它们，因为你非常熟悉许多帮助你做出决定的属性。确实，区分光明与黑暗、温暖与寒冷、湿润与干燥等都很简单。
- en: Now, say I ask you whether it’s slightly rainy or foggy and do so in the middle
    of the night. I imagine you’d have a really hard time telling one from another.
    Most likely, you would even go outside, try to feel the air on your skin and smell
    the air, and finally return with something such as *“well, it seems to be rain.”*
    In this case, you had to do several tests and use their results to make your judgment.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，假设我问你是否有轻微的雨或雾，并在半夜这么做。我想象你会很难区分它们。很可能会出去，试图感受皮肤上的空气，闻闻空气，最后带着某种像“嗯，看起来像是在下雨。”这样的东西回来。在这种情况下，你必须进行多项测试并使用它们的结果来做出判断。
- en: Why were you able to do these tests and use their results?
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 你为什么能够进行这些测试并使用它们的结果？
- en: Because you have a *model* in your mind, a model of the weather. You wouldn’t
    think about it unless it’s your profession and, in most cases, you make decisions
    intuitively and instantly. However, if put under pressure, you can find some more
    or less formal attributes – such as humidity, temperature, and wind – to decide
    upon the weather, again within the framework of the weather model.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 因为你在心中有一个*模型*，一个天气模型。除非你是这个职业，否则你不会去想它。在大多数情况下，你都会直觉和即时地做出决定。然而，如果你处于压力之下，你可以找到一些或多或少正式的属性——如湿度、温度和风——来决定天气，再次在天气模型的框架内。
- en: Let’s now develop a model of market trends following the same example with the
    weather.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，让我们以天气为例，开发一个市场趋势模型。
- en: 'First, and above all, we should decide whether trends are something that always
    exists or occurs only at times. If we compare both models (permanent trends and
    occasional trends) with our weather example, we will see the following parallels:'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，最重要的是，我们应该决定趋势是始终存在还是偶尔发生。如果我们将这两个模型（永久趋势和偶尔趋势）与我们的天气例子进行比较，我们会看到以下类比：
- en: '| **Market** | **Weather** |'
  id: totrans-22
  prefs: []
  type: TYPE_TB
  zh: '| **市场** | **天气** |'
- en: '| The market is always in an uptrend or downtrend. Trends may be more or less
    visible. | The wind blows all the time, only sometimes stronger and other times
    weaker. |'
  id: totrans-23
  prefs: []
  type: TYPE_TB
  zh: '| 市场总是处于上升趋势或下降趋势。趋势可能更明显或不太明显。 | 风总是吹着，只是有时强有时弱。 |'
- en: '| The market can be in *trend mode* or *non-trend* mode. | Sometimes the wind
    blows and other times the wind doesn’t blow at all. |'
  id: totrans-24
  prefs: []
  type: TYPE_TB
  zh: '| 市场可以是*趋势模式*或*非趋势模式*。 | 有时风在吹，有时风根本就不吹。 |'
- en: Table 12.1 – Drawing parallels between market trends and the weather
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 表12.1 – 市场趋势与天气之间的类比
- en: Despite looking quite simple, this table perfectly illustrates the fundamental
    difference in approaches to modeling the process (market or weather). It is up
    to the model’s developer to decide either that the observed process can only be
    in one state (only in trend; only wind blowing) or that it can be in multiple
    states (trend or non-trend in the market example; windy or not windy in the weather
    example).
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管看起来相当简单，但这个表格完美地说明了在建模过程（市场或天气）的方法上的基本差异。模型开发者必须决定观察到的过程只能处于一种状态（只有趋势；只有风在吹）或者可以处于多种状态（市场例子中的趋势或非趋势；天气例子中的有风或无风）。
- en: This said, we come to a very important conclusion.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 话虽如此，我们得出一个非常重要的结论。
- en: There is no such thing as a *true* or *false* model. A model only tries to explain
    the observed phenomena with certain precision and serves the purpose of making
    decisions.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 没有这样的东西叫做*真*或*假*模型。模型只是试图以一定的精确度解释观察到的现象，并服务于做出决策的目的。
- en: So, the ability of a model to help make a practical decision is the only criterion
    of the model’s validity. If looking outside the window is enough to know how to
    dress for the day, then the weather model is valid. If you make decisions whether
    to take an umbrella with you by consulting sophisticated equipment and still regularly
    get wet to the skin, most likely, the model used in this sophisticated equipment
    is not valid.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，模型帮助做出实际决策的能力是模型有效性的唯一标准。如果你通过看窗外就能知道如何为一天穿衣，那么天气模型就是有效的。如果你通过咨询复杂的设备来决定是否带伞，但仍然经常全身湿透，那么很可能，这个复杂设备中使用的模型是无效的。
- en: In the market, the situation is similar. If we can suggest a simplistic market
    model that nevertheless is able to consistently outperform a benchmark (see [*Chapter
    9*](B19145_09.xhtml#_idTextAnchor152), *Trading Strategies and Their Core Elements*),
    then this is an acceptable model. At the same time, we may have an extremely sophisticated
    model that uses artificial intelligence and quantum mechanics, but if in the long
    run it doesn’t beat the market, then it may only be interesting from an academic
    standpoint.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 在市场中，情况类似。如果我们能提出一个简单的市场模型，尽管如此，它仍然能够持续优于基准（见[*第9章*](B19145_09.xhtml#_idTextAnchor152)，*交易策略及其核心要素*），那么这是一个可接受的模型。同时，我们可能有一个极其复杂的模型，它使用人工智能和量子力学，但如果从长远来看它不能打败市场，那么它可能只对学术研究有吸引力。
- en: As we’re making our first steps in algo trading, let’s start with something
    simple. We can make our model more complicated later if a simplistic model doesn’t
    work.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 随着我们迈出算法交易的第一步，让我们从简单的事物开始。如果简单的模型不起作用，我们可以在之后使我们的模型更加复杂。
- en: 'In our present case, we should make a decision regarding how we model the market
    from a trending standpoint:'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们目前的案例中，我们应该决定如何从趋势的角度来建模市场。
- en: The market is always in a trend, up or down; it’s just the duration of these
    trends that may be long or short
  id: totrans-33
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 市场总是处于趋势中，无论是上升还是下降；只是这些趋势的持续时间可能长或短
- en: The market is in either a trend or non-trend state, and we should distinguish
    between the two before determining an uptrend or downtrend
  id: totrans-34
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 市场处于趋势或非趋势状态，我们在确定上升趋势或下降趋势之前应该区分这两种状态
- en: 'Of course, the first model is simpler: we don’t need to suggest a method to
    tell trend from non-trend, focusing now only on technical setups that tell an
    uptrend from a downtrend. Again, if this approach doesn’t work, we can return
    to this decision point, change our model, and start the research all over.'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，第一个模型更简单：我们不需要提出一个区分趋势和非趋势的方法，现在我们只关注那些能够区分上升趋势和下降趋势的技术设置。如果这种方法不起作用，我们可以回到这个决策点，改变我们的模型，然后从头开始研究。
- en: 'So, we have decided upon the first point in our checklist: we choose the *always-in-trend*
    market model for further research.'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，我们在我们的清单上确定了第一个要点：我们选择“始终处于趋势”的市场模型进行进一步研究。
- en: 'Now that we have decided upon the market model, let’s move on to finding a
    proper tool to distinguish an uptrend from a downtrend. Again, we start this step
    with the simplest solution: moving averages.'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 既然我们已经确定了市场模型，接下来让我们寻找一个合适的工具来区分上升趋势和下降趋势。同样，我们从这个最简单的解决方案开始：移动平均线。
- en: Determining a trend, part 2 – moving averages
  id: totrans-38
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 确定趋势，第二部分 – 移动平均线
- en: One of the classical technical analysis studies typically used to determine
    trends is the moving average. In [*Chapter 7*](B19145_07.xhtml#_idTextAnchor114),
    *Technical Analysis and Its Implementation in Python*, we already considered moving
    averages and found that they act as digital filters that eliminate higher frequencies
    (short-term price fluctuations) and keep lower frequencies, which we consider
    as dominating long-term tendencies in price movements. Let’s quickly refresh our
    knowledge of this by plotting a 20-period moving average (MA20) over a price chart.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 经常用于确定趋势的经典技术分析研究之一是移动平均线。在[*第7章*](B19145_07.xhtml#_idTextAnchor114)《技术分析及其在Python中的应用》中，我们已经考虑了移动平均线，并发现它们作为数字滤波器，消除高频（短期价格波动），并保留低频，我们将这些视为价格运动中的主导长期趋势。让我们通过在价格图表上绘制20周期移动平均线（MA20）来快速更新我们的知识。
- en: '![Figure 12.1 – 20-period moving average on top of a 1-minute chart of EURJPY.
    Chart by Multicharts](img/B19145_12_01.jpg)'
  id: totrans-40
  prefs: []
  type: TYPE_IMG
  zh: '![图12.1 – EURJPY 1分钟图表上的20周期移动平均。图表由Multicharts提供](img/B19145_12_01.jpg)'
- en: Figure 12.1 – 20-period moving average on top of a 1-minute chart of EURJPY.
    Chart by Multicharts
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.1 – EURJPY 1分钟图表上的20周期移动平均。图表由Multicharts提供
- en: We can see that sometimes, the bars’ closing prices tend to remain above the
    MA20, while sometimes they are below it. It is reasonable to suppose that as long
    as these closing prices remain above the MA20, the market is in an uptrend, and
    while they remain below it, it is in a downtrend.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以看到，有时，柱状图的收盘价倾向于保持在MA20之上，而有时则低于它。合理地假设，只要这些收盘价保持在MA20之上，市场就处于上升趋势，而如果它们保持在之下，市场就处于下降趋势。
- en: The problem with this technical setup is that sometimes prices remain above
    or below a moving average for too short a period of time. We already agreed that
    in our model the market is always in trend and we do not separate any special
    non-trending condition. However, maybe there’s a better technical setup, something
    that would better indicate an uptrend or downtrend without so many *short-term
    trends*, which we intuitively wouldn’t like to even call *trends*.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 这个技术设置的问题有时价格在移动平均线之上或之下停留的时间太短。我们之前已经同意，在我们的模型中市场总是处于趋势中，我们不区分任何特殊的非趋势条件。然而，可能存在更好的技术设置，某种能够更好地指示上升趋势或下降趋势，而不需要那么多*短期趋势*，这是我们直觉上甚至不愿意称之为*趋势*的。
- en: 'Yes, there is, and this is one of the oldest classical technical trading setups:
    we use two moving averages, one with a short period and another one with a long
    period. Then, we consider an uptrend only when both of the following two conditions
    are met:'
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 是的，有，这是最古老的技术交易设置之一：我们使用两个移动平均线，一个短期，另一个长期。然后，我们只有在以下两个条件都满足时才认为存在上升趋势：
- en: The price is above the short-period moving average
  id: totrans-45
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 价格高于短期移动平均线
- en: The short-period moving average is itself above the long-period moving average
  id: totrans-46
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 短期移动平均线本身位于长期移动平均线之上
- en: 'It is similar for downtrends:'
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 对于下降趋势来说，情况类似：
- en: The price is below the short-term moving average
  id: totrans-48
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 价格低于短期移动平均线
- en: The short-period moving average is itself below the long-period moving average
  id: totrans-49
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 短期移动平均本身位于长期移动平均之下
- en: Let’s see what it may look like on a chart.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们看看它在图表上可能是什么样子。
- en: '![Figure 12.2 – Adding a longer-term moving average helps exclude unwanted
    situations](img/B19145_12_02.jpg)'
  id: totrans-51
  prefs: []
  type: TYPE_IMG
  zh: '![图12.2 – 添加长期移动平均有助于排除不希望出现的情况](img/B19145_12_02.jpg)'
- en: Figure 12.2 – Adding a longer-term moving average helps exclude unwanted situations
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.2 – 添加长期移动平均有助于排除不希望出现的情况
- en: In the preceding figure, I added a 50-period moving average (MA50) to the existing
    MA20 and zoomed the figure in to see more details. The area encompassed by a dotted
    oval illustrates how adding the second moving average may filter out certain (but,
    of course, not all) unwanted situations. If we decide whether it’s an uptrend
    or a downtrend only by closing prices being above or below MA20, then during the
    phase shown in *Figure 12**.2*, we would have to decide whether there was a downtrend.
    However, if we use a setup with both requirements as we suggested previously (that
    the price should be below MA20 and MA20 should be below MA50), then we can qualify
    it neither as an uptrend nor as a downtrend. So, in the trade logic, we simply
    skip this interval – and then we can see that the following price movement develops
    into a *true* uptrend.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 在前面的图中，我添加了一个50期移动平均（MA50）到现有的MA20，并放大了图形以查看更多细节。由虚线椭圆形包围的区域说明了添加第二个移动平均如何过滤掉某些（但当然不是所有）不希望出现的情况。如果我们仅仅通过收盘价高于或低于MA20来决定是上升趋势还是下降趋势，那么在*图12.2*中显示的阶段，我们就必须决定是否存在下降趋势。然而，如果我们使用我们之前建议的设置（即价格应该在MA20和MA50之下），那么我们既不能将其认定为上升趋势也不能认定为下降趋势。因此，在交易逻辑中，我们简单地跳过这个区间——然后我们可以看到随后的价格变动发展成为一个*真正的*上升趋势。
- en: Great, now we have covered two points in our list– we know when there’s a trend
    in the market and know its direction. Now we need to decide when we actually enter
    and exit a position in the market.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 太好了，现在我们已经覆盖了我们列表中的两个要点——我们知道市场何时有趋势以及其方向。现在我们需要决定何时实际进入和退出市场中的头寸。
- en: Entry and exit rules
  id: totrans-55
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 进入和退出规则
- en: 'After all the elements of a technical trading setup are determined, the key
    question remains of when to actually enter and exit a position. In some cases,
    it may be a non-trivial question and the answer to it may seriously affect the
    resulting performance of a strategy. However, within our simplistic model, we
    can assume that we can enter the market as soon as the trend conditions are met.
    This means that we open a new long position when the following apply:'
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 在确定技术交易设置的各个要素之后，关键问题仍然是何时实际进入和退出头寸。在某些情况下，这可能是一个非平凡的问题，对这个问题的回答可能会严重影响策略的结果性能。然而，在我们的简单模型中，我们可以假设一旦满足趋势条件，我们就可以进入市场。这意味着当以下条件成立时，我们就会开立新的多头头寸：
- en: The bar’s closing price is above the short-period moving average
  id: totrans-57
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 条的收盘价高于短期移动平均
- en: The short-period moving average is above the long-period moving average
  id: totrans-58
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 短期移动平均位于长期移动平均之上
- en: Currently, we don’t have a long position in the market (so we don’t add to an
    existing position, and we don’t buy more if we’re already long)
  id: totrans-59
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 目前，我们在市场上没有多头头寸（因此我们不会增加现有头寸，如果我们已经多头，我们也不会再买入）
- en: As to exiting from an open position – again, within our market model there’s
    no need to actually exit a position because the model assumes that the market
    is always in a trend. So, we exit a long position only when we open a short position
    and vice versa.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 至于退出开放的头寸——同样，在我们的市场模型中，实际上没有必要退出头寸，因为该模型假设市场总是处于趋势中。因此，我们只在开立空头头寸时退出多头头寸，反之亦然。
- en: In other words, we plan a strategy that is *always in the market* and changes
    the trade’s direction as soon as the change in the trend is detected.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 换句话说，我们计划一个*始终在市场*的策略，并在检测到趋势变化时立即改变交易的方向。
- en: As with the market model, we can change this approach later, if testing the
    current simplistic model doesn’t produce acceptable results.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 与市场模型一样，如果我们测试当前简单模型的结果不可接受，我们可以稍后改变这种方法。
- en: Money management
  id: totrans-63
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 资金管理
- en: '**Money management** means how much you trade with each new order. There are
    many money management theories and techniques, from very simple to quite sophisticated.
    Unfortunately, we cannot really cover all of them in one chapter – it would require
    a separate book! But since we are keeping things simple at the moment and are
    more interested in learning how the trade logic works in general, let’s use the
    most simplistic money management concept as well: we will use the same constant
    trading size for all trades, doubling it when we should make a reversal from long
    to short or from short to long. We already did that in the previous chapter when
    we developed our backtesting platform.'
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: '**资金管理**意味着每次新订单你将交易多少。有许多资金管理理论和技巧，从非常简单到相当复杂。不幸的是，我们无法在一个章节中涵盖所有这些内容——那需要一本书！但既然我们现在保持简单，并且更感兴趣于了解交易逻辑是如何在一般情况下工作的，那么我们也使用最简单的资金管理概念：我们将对所有交易使用相同的恒定交易规模，当我们应该从多头转为空头或从空头转为多头时，我们将将其翻倍。我们在上一章开发回测平台时已经这样做过了。'
- en: 'The rule of thumb is: if your strategy performs acceptably well with a constant
    trading size, its performance may be improved with money management. If the strategy
    doesn’t perform well with constant trading size then attempts to improve its performance
    by using various money management rules fail most of the time.'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 一个经验法则是：如果你的策略在恒定交易规模下表现良好，那么通过资金管理可以进一步提高其表现。如果策略在恒定交易规模下表现不佳，那么尝试通过使用各种资金管理规则来提高其表现通常会失败。
- en: 'So, we have successfully covered the four key points that we outlined at the
    beginning of this chapter:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，我们已经成功覆盖了我们在本章开头概述的四个关键点：
- en: We know when the market is in trend
  id: totrans-67
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们知道市场何时处于趋势中
- en: We know the trend’s direction
  id: totrans-68
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们知道趋势的方向
- en: We know when to enter the market
  id: totrans-69
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们知道何时进入市场
- en: We know when to exit it
  id: totrans-70
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们知道何时退出市场
- en: Plus, we also know how much we have at stake with each trade.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，我们还知道每次交易我们有多少风险。
- en: Great, now we can proceed to choose the market we’re going to trade using trend-following
    and prepare the data.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 太好了，现在我们可以继续选择我们将要使用趋势跟踪进行交易的市场，并准备相关数据。
- en: Choosing the market and preparing data
  id: totrans-73
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 选择市场和准备数据
- en: 'There is one very common misconception regarding systematic trading: it is
    believed that a technical trading strategy should work in any market. I hope that
    the previous chapters have already dispelled this myth. Just as an example, let’s
    recall the famous EURCHF market while the Swiss national bank was keeping the
    rate of the Swiss franc pegged to the euro (see [*Chapter 9*](B19145_09.xhtml#_idTextAnchor152),
    *Trading Strategies and Their Core Elements*) – go and trade it using trend-following
    if the price virtually doesn’t move at all!'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 关于系统交易有一个非常常见的误解：人们认为技术交易策略应该在任何市场上都有效。我希望前几章已经消除了这个神话。举个例子，让我们回忆一下著名的EURCHF市场，当时瑞士国家银行正在将瑞士法郎的汇率钉住欧元（参见[*第9章*](B19145_09.xhtml#_idTextAnchor152)，*交易策略及其核心要素*）——如果价格几乎没有任何变动，就去用趋势跟踪策略进行交易吧！
- en: Even if we set aside such extreme examples, anyway, choosing the market can
    be a non-trivial task. Most of the time, we have to try many markets even if we
    can make an educated guess about which should perform better with a specific kind
    of strategy. However, there are some general guidelines that we are going to use
    now.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 即使我们将这样的极端例子放在一边，选择市场本身也可以是一个非同寻常的任务。大多数时候，即使我们能够对哪种策略应该表现更好有一个明智的猜测，我们也必须尝试许多市场。然而，现在我们将使用一些一般性的指导方针。
- en: First, since we’re focused on trend-following, we would like to trade a market
    that is full of trends (however much it may sound like a truism). If we are in
    the FX domain, we may want to focus on currency pairs with the greatest difference
    in the interest rates between the two currencies (see the *Fundamental analysis*
    section of [*Chapter 6*](B19145_06.xhtml#_idTextAnchor101), *Basics of Fundamental
    Analysis and Its Possible Use in FX Trading*, for a brief discussion on interest
    rates and carry trading) because this is one of the very few factors that may
    lead to forming a more or less long-term trend. So, pairs with currencies such
    as the Australian dollar or the New Zealand dollar versus the Japanese yen or
    even the US dollar (especially when the US rates were low) may be good to start
    with.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，由于我们专注于趋势跟踪，我们希望交易一个充满趋势的市场（尽管这听起来可能像是一个不言而喻的真理）。如果我们处于外汇领域，我们可能希望关注两种货币之间利率差异最大的货币对（参见[*第6章*](B19145_06.xhtml#_idTextAnchor101)的[*基本分析*](https://wiki.example.org/fundamental_analysis)部分，其中简要讨论了利率和息差交易，以了解利率和息差交易），因为这是非常少数可能导致形成或多或少长期趋势的因素之一。因此，像澳大利亚元或新西兰元与日元或甚至美元（尤其是当美国利率较低时）这样的货币对可能是一个好的开始。
- en: Another reason to choose the Australian dollar for trading with a trend-following
    strategy is that the Australian economy is dependent on gold production, much
    like the Canadian economy depends on oil (though perhaps to a lesser extent).
    As a result, the rate of the Australian dollar is prone to corresponding changes
    in the price of gold and other export commodities. Since commodity prices exhibit
    cyclic behavior due to manufacturing cycles, we can see this reflected in AUDUSD
    or AUDJPY. Therefore, with these two considerations in mind, choosing AUDUSD as
    the first currency pair to try a trend-following strategy seems like a natural
    choice.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 选择澳大利亚元作为趋势跟踪策略交易的原因之一是，澳大利亚经济依赖于黄金生产，就像加拿大经济依赖于石油（尽管可能程度较小）。因此，澳大利亚元的汇率容易受到黄金和其他出口商品价格相应变化的影响。由于商品价格由于生产周期而表现出周期性行为，我们可以看到这一点在AUDUSD或AUDJPY中有所反映。因此，考虑到这两个因素，选择AUDUSD作为尝试趋势跟踪策略的第一个货币对似乎是一个自然的选择。
- en: Second, we should decide upon the timeframe or data resolution. Although the
    previous sample charts with moving averages were made using a resolution of 1
    minute, intraday data is not really good for trend-following strategies. The reason
    is that intraday the FX market exhibits strongly cyclical behavior in volatility
    patterns (see the *Liquidity and volatility – how one transforms into another*
    section of [*Chapter 3*](B19145_03.xhtml#_idTextAnchor044), *FX Market Overview
    from a Developer’s Standpoint*). These markets are active during the daytime and
    slow during the night. This periodicity will produce many *false trends* and make
    the task of determining a *true trend* significantly more difficult. At the same
    time, the daily timeframe is free from this feature and we may expect more steady
    trending behavior with this data resolution (of course, depending on whether the
    market is prone to trending at all). So, when we have a choice of making our model
    more complicated by adding a module to the trading logic, which would distinguish
    between *true* and *false* trends, we’d rather use data with higher resolution
    to eliminate the problem completely.
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 第二，我们应该决定时间框架或数据分辨率。尽管之前使用移动平均线的样本图表是以1分钟分辨率制作的，但日内数据实际上并不适合趋势跟踪策略。原因是日内外汇市场在波动模式上表现出强烈的周期性行为（参见[*第3章*](B19145_03.xhtml#_idTextAnchor044)的[*流动性和波动性
    – 如何一个转化为另一个*](https://wiki.example.org/liquidity_and_volatility)部分，从开发者的角度来看，外汇市场概述）。这些市场在白天活跃，在夜间缓慢。这种周期性会产生许多*虚假趋势*，使确定*真实趋势*的任务变得显著更加困难。同时，日时间框架没有这种特性，我们可能期望在这个数据分辨率（当然，取决于市场是否倾向于趋势）上有更稳定的趋势行为。因此，当我们有选择通过向交易逻辑中添加一个模块来使我们的模型更加复杂，该模块可以区分*真实*和*虚假*趋势时，我们宁愿使用更高分辨率的
    数据来完全消除这个问题。
- en: Thus, we have decided upon the market (let’s start with AUDUSD) and the data
    resolution (daily). As always, let me note that if we get unsatisfactory results,
    we can try different markets and timeframes.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，我们已经确定了市场（让我们从AUDUSD开始）和数据分辨率（每日）。一如既往，让我指出，如果我们得到不满意的结果，我们可以尝试不同的市场和时间框架。
- en: Now that we have settled upon all the prerequisites, let’s get to coding.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经确定了所有先决条件，让我们开始编码。
- en: Compressing data to a daily timeframe
  id: totrans-81
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 将数据压缩到日时间框架
- en: Let’s start with writing a simple utility that would compress the market data
    to the required resolution and convert it into the desired format, compatible
    with our backtesting and live trading code (see [*Chapter 11*](B19145_11.xhtml#_idTextAnchor186),
    *Backtesting and Theoretical Performance*). We will use the `getBarRealtime()`
    function from the live version and slightly adapt it as a stand-alone utility.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们从编写一个简单的实用程序开始，该实用程序将市场数据压缩到所需的分辨率，并将其转换为所需的格式，与我们的回测和实时交易代码兼容（见[*第11章*](B19145_11.xhtml#_idTextAnchor186)，*回测和理论表现*）。我们将使用实时版本的`getBarRealtime()`函数，并稍作修改作为独立的实用程序。
- en: 'This utility should do the following:'
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 此实用程序应执行以下操作：
- en: Read the source data file (tick or 1-minute bars)
  id: totrans-84
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 读取源数据文件（tick或1分钟条）
- en: Aggregate data into any greater timeframe
  id: totrans-85
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将数据聚合到任何更大的时间框架
- en: Save data to disk using a format compatible with the backtester
  id: totrans-86
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用与回测兼容的格式将数据保存到磁盘
- en: 'As always, we start with imports:'
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 像往常一样，我们从导入开始：
- en: '[PRE0]'
  id: totrans-88
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'We add a sliding window class similar to the one we used in [*Chapter 6*](B19145_06.xhtml#_idTextAnchor101),
    *Basics of Fundamental Analysis and Its Possible Use in FX Trading*, but we will
    use it in a bit of a different way: to store values of any parameter (price, time,
    volume, or whatever) on the current bar and the previous bar. Thus, we add two
    respective methods to quickly retrieve these values:'
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 我们添加了一个类似于[*第6章*](B19145_06.xhtml#_idTextAnchor101)，*基本面分析的基础及其在FX交易中的可能用途*中使用的滑动窗口类，但我们将以不同的方式使用它：在当前条形图和上一个条形图上存储任何参数（价格、时间、成交量或任何其他）的值。因此，我们添加了两个相应的方法来快速检索这些值：
- en: '[PRE1]'
  id: totrans-90
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Then, we specify the source file and the destination file and read the saved
    data (tick or 1 minute) – pretty much like we did in the previous chapter:'
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，我们指定源文件和目标文件，并读取保存的数据（tick或1分钟数据）——这与我们在上一章中做的大致相同：
- en: '[PRE2]'
  id: totrans-92
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'We immediately write the first line to the destination file – this line will
    act as a header for further processing the file as a CSV:'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 我们立即将第一行写入目标文件——这一行将作为进一步处理文件作为CSV的标题：
- en: '[PRE3]'
  id: totrans-94
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Then, we create an instance of the `slidingWindow` class and initiate the first
    bar, which we’re going to aggregate and then save to the destination file:'
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，我们创建`slidingWindow`类的实例，并初始化第一个条形图，我们将对其进行聚合并保存到目标文件：
- en: '[PRE4]'
  id: totrans-96
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'Now, we start iterating over all samples in the source file, convert the data,
    and add the timestamp to the timestamp sliding window:'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，我们开始遍历源文件中的所有样本，转换数据，并将时间戳添加到时间滑动窗口中：
- en: '[PRE5]'
  id: totrans-98
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: Note
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 备注
- en: 'The header format of the source file may be different. In the files that I
    use in this book, there are at least two different formats: plain words (`''Open''`,
    `''High''`, etc.) and words in triangle brackets (`<Open>`, etc.). Be careful
    and don’t forget to adapt this piece of code to the source data you’re going to
    use yourself!'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 源文件的标题格式可能不同。在我这本书中使用的文件中，至少有两种不同的格式：普通单词（`'Open'`，`'High'`等）和三角括号中的单词（`<Open>`等）。请小心，不要忘记根据你将要使用的数据源调整这段代码！
- en: 'If the date of the timestamp is not equal to that of the previous timestamp
    – meaning that a new day had started – we save the updated daily bar to the destination
    file and reinitialize the bar:'
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 如果时间戳的日期与上一个时间戳的日期不相等——这意味着新的一天开始了——我们将保存更新的每日条形图到目标文件，并重新初始化条形图：
- en: '[PRE6]'
  id: totrans-102
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'Finally, we update the currently forming bar:'
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，我们更新正在形成的条形图：
- en: '[PRE7]'
  id: totrans-104
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'Don’t forget to close the destination file after the `for` loop has finished:'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 在`for`循环完成后，不要忘记关闭目标文件：
- en: '[PRE8]'
  id: totrans-106
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'If you run this code using the same AUDUSD 1-minute historical data as I used
    (you can find it on GitHub along with the code), you will get a CSV file with
    daily bars where the `''Time''` column features two different times: `17:00` and
    `23:59`. Why is that?'
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你使用与我相同的AUDUSD 1分钟历史数据运行此代码（你可以在GitHub上找到它以及代码），你将得到一个CSV文件，其中`'Time'`列有两个不同的时间：`17:00`和`23:59`。为什么会这样？
- en: In fact, this is a very important question that deserves an insightful answer.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 实际上，这是一个非常重要的问题，值得一个深刻的答案。
- en: Be careful with time!
  id: totrans-109
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 注意时间！
- en: No, this doesn’t mean that you should be looking at your watch every other minute.
    It means that when working with market data, time is the very thing that leads
    to confusion, especially in cases where you work with data from decentralized
    markets such as forex.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 不，这并不意味着你应该每隔一分钟就看看你的手表。这意味着在处理市场数据时，时间是导致混淆的非常因素，尤其是在处理来自如外汇等去中心化市场的数据时。
- en: 'Working with data from a centralized exchange is somewhat easier: in this case,
    we always know in which time zone the exchange is located and its working hours.
    So, in any market data from that exchange, all timestamps will be in the same
    time zone as the exchange and only between market open and close.'
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 使用来自集中交易所的数据相对容易一些：在这种情况下，我们始终知道交易所位于哪个时区以及其工作时间。因此，从这个交易所获取的任何市场数据中，所有时间戳都将与交易所所在的时区相同，并且仅在市场开盘和收盘之间。
- en: With forex, it’s different. We know that there’s no single exchange in this
    market and that it works almost 24 hours, 5 days a week.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 在外汇市场中，情况不同。我们知道这个市场没有单一的交易所，并且它几乎每周工作24小时，5天。
- en: '*Almost*, mind you.'
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，是“几乎”。
- en: First, we must consider time zones. Every FX data vendor and every FX broker
    may deliver data in any time zone they think is correct. Most frequently used
    are GMT (UTC) or BST (UTC+1) for London, CET (UTC+1) or CEST (UTC+2) for Frankfurt,
    and EST (UTC-5) or EDT (UTC-4) for New York. You should check the data source
    about the time zone used before you do any manipulations with timestamps.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，我们必须考虑时区。每个外汇数据供应商和每个外汇经纪商都可能以他们认为正确的任何时区提供数据。最常用的是GMT（UTC）或BST（UTC+1）用于伦敦，CET（UTC+1）或CEST（UTC+2）用于法兰克福，以及EST（UTC-5）或EDT（UTC-4）用于纽约。在处理时间戳之前，你应该检查数据源使用的时区。
- en: 'Second, we must consider working hours. Most FX trading venues open on Sunday
    at around 5 p.m. New York time (New York bank settlement time; see the *FX instruments*
    section of [*Chapter 3*](B19145_03.xhtml#_idTextAnchor044), *FX Market Overview
    from a Developer’s Standpoint*), but some may open at a later time. Same with
    the market close before the weekend: most venues close on Friday at that same
    time of 5 p.m. in New York, but some even offer weekend trading. We can’t consider
    this weekend trading seriously because the trading volume for weekend deals is
    negligible, but you may get hold of market data from a venue which provides weekend
    trading and this weekend data will add quite some confusion to your research process.
    If you plan to trade exotic currencies, most likely they will only be traded during
    the work hours of the respective state central bank or just a bit longer.'
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 其次，我们必须考虑工作时间。大多数外汇交易场所周日大约在下午5点开始交易（纽约时间；纽约银行结算时间；参见[*第3章*](B19145_03.xhtml#_idTextAnchor044)，*从开发者角度的外汇市场概述*），但有些可能更晚开始。同样，周末收盘时间：大多数场所周五在纽约的同一时间下午5点关闭，但有些甚至提供周末交易。我们无法认真考虑这种周末交易，因为周末交易的成交量可以忽略不计，但你可能会从提供周末交易的场所获取市场数据，这些周末数据将给你的研究过程带来相当多的混乱。如果你计划交易外币，很可能是它们只在各自国家中央银行的工作时间内或稍长一点的时间内进行交易。
- en: Besides regular working hours, there are exceptions, mostly around holidays.
    For example, don’t be surprised if you see an early close before or a late open
    after Christmas.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 除了正常的工作时间外，还有一些例外，大多在节假日。例如，如果你在圣诞节前后看到提前收盘或延迟开盘，不要感到惊讶。
- en: Third, we must consider how 0:00 time is interpreted. Some data providers treat
    this time as the start of a new day, while others believe it refers to the previous
    day. Moreover, some data providers even don’t have such a timestamp and the last
    time of the day in their data is 23:59 (for 1-minute data).
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 第三，我们必须考虑如何解释0:00时间。一些数据提供商将这个时间视为新的一天的开始，而另一些则认为它指的是前一天。此外，一些数据提供商甚至没有这样的时间戳，他们数据中的最后时间是23:59（对于1分钟数据）。
- en: This 0:00 time is quite confusing. When we work with data compressed in bars,
    the bar’s timestamp means the time when the bar closes. Therefore, 0:00 means
    that the bar closed at midnight. But it still represents price movements that
    happened before midnight, so they belong to the day that just finished! So, if
    you want to be absolutely precise when working with time, you may want to add
    some additional checks to your code that take into account the issues we’ve just
    discussed.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 这个0:00的时间很令人困惑。当我们处理以条形图压缩的数据时，条形图的时间戳表示条形图关闭的时间。因此，0:00表示条形图在午夜关闭。但它们仍然代表午夜之前发生的价格变动，所以它们属于刚刚结束的那一天！所以，如果你在处理时间时想绝对精确，你可能需要在你的代码中添加一些额外的检查，以考虑我们刚才讨论的问题。
- en: Now, let’s look at the data we used in our example and see what we actually
    did. This data is in the New York time zone, so the last time of the week is 17:00
    – and this is what we see in the compressed daily data for every Friday. This
    data provider treats 0:00 as the first time of the new day, so since we divide
    days by date and do not take time into consideration, the last time of a day is
    now 23:59.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，让我们看看我们例子中使用的数据，看看我们实际上做了什么。这些数据是在纽约时区，所以一周的最后时间是17:00 – 这就是我们每周五压缩的每日数据中所看到的。这个数据提供商将0:00视为新一天的第一时间，因此由于我们按日期划分日期而不考虑时间，一天的最后时间现在是23:59。
- en: 'We may want to modify the new day conditions in the code of the bar-making
    utility. One of the possible solutions could be a condition like this:'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可能想要修改条形图工具代码中的新一天条件。一个可能的解决方案可能是这样的条件：
- en: '[PRE9]'
  id: totrans-121
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: If we now run the modified code, we get correctly compressed data, but keep
    in mind that 0:00 timestamps now denote the end of the day, not its beginning!
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我们现在运行修改后的代码，我们会得到正确压缩的数据，但请注意，现在0:00的时间戳表示一天的结束，而不是开始！
- en: Now we have all the data prepared and it’s time to try writing the code for
    our first strategy.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们已经准备好了所有数据，是时候尝试编写我们第一个策略的代码了。
- en: Trend-following strategy – implementation
  id: totrans-124
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 跟随趋势策略 – 实现
- en: Since we’re going to use the backtesting code that we developed in the previous
    chapter (see the *Backtesting platform with historical data feed* section in [*Chapter
    11*](B19145_11.xhtml#_idTextAnchor186), *Backtesting and Theoretical Performance*),
    we need to add only small pieces of code that support the required objects.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 由于我们打算使用上一章中开发的回测代码（参见[*第11章*](B19145_11.xhtml#_idTextAnchor186)，*回测和理论表现*）中的*带有历史数据馈送回测平台*部分），我们只需要添加支持所需对象的小段代码。
- en: Note
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: Don’t forget to change the data source to the file with the daily AUDUSD data
    that we’ve just created!
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 不要忘记将数据源更改为我们刚刚创建的包含每日AUDUSD数据的文件！
- en: 'Let’s start with adding the `slidingWindow` class to implement moving averages.
    Obviously, we copy it from the code in the preceding section. The code (as usual
    with class declaration) goes somewhere after the imports and before the declaration
    of the first function:'
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们从添加`slidingWindow`类来实现移动平均开始。显然，我们从上一节中的代码中复制它。代码（像类声明一样）通常放在导入之后和第一个函数声明之前：
- en: '[PRE10]'
  id: totrans-129
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: As you progress in developing various strategies, sooner or later you will find
    that many classes or functions are used in most strategies, so you can move them
    to a separate module and import the module into any strategy prototype.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 随着你逐渐开发各种策略，迟早你会发现在大多数策略中都会使用到许多类或函数，因此你可以将它们移动到一个单独的模块中，并将该模块导入到任何策略原型中。
- en: 'We add two sliding windows to implement moving averages:'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 我们添加两个滑动窗口来实现移动平均：
- en: '[PRE11]'
  id: totrans-132
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'Why `5` and `20` for periods of moving averages? Well, no real reason in particular:
    when we work with daily data, `5` is usually used to represent a work week and
    `20` a work month. These values can often be found in technical analysis studies.
    Other popular periods are `50` (for a quarter) and `200` (for a year). In any
    case, this is only a draft, so we will be able to modify these values later, after
    having evaluated the strategy performance.'
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 为什么移动平均周期使用`5`和`20`？嗯，没有特别的原因：当我们处理每日数据时，`5`通常用来表示一个工作周，而`20`表示一个工作月。这些值通常可以在技术分析研究中找到。其他流行的周期是`50`（代表一个季度）和`200`（代表一年）。无论如何，这只是一个草案，所以我们将在评估策略性能后，能够修改这些值。
- en: 'Then we have the function that actually calculates a moving average:'
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 然后我们有实际计算移动平均值的函数：
- en: '[PRE12]'
  id: totrans-135
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'All that we need to modify now is part of the `tradeLogic()` function. It is
    the block of code between the `trade logic starts here` and `trade logic ends`
    `here` comments:'
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 我们现在需要修改的是`tradeLogic()`函数的一部分。它是位于`trade logic starts here`和`trade logic ends
    here`注释之间的代码块：
- en: '[PRE13]'
  id: totrans-137
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'First of all, we retrieve a new closing price and add it to both sliding windows.
    Then we calculate the moving averages:'
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，我们检索一个新的收盘价并将其添加到两个滑动窗口中。然后我们计算移动平均值：
- en: '[PRE14]'
  id: totrans-139
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'Now the main part: the entry condition. We sell if the close is below the short-period
    MA and the short-period MA is below the long-period MA. Don’t forget that we do
    that only if we don’t have an open short position already (see the *Trading application
    with live data feed* section in [*Chapter 11*](B19145_11.xhtml#_idTextAnchor186),
    *Backtesting and* *Theoretical Performance*):'
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 现在是主要部分：入场条件。如果收盘价低于短期移动平均线，且短期移动平均线低于长期移动平均线，我们就卖出。别忘了，我们只有在没有已经开放空头头寸的情况下才这样做（参见[*第11章*](B19145_11.xhtml#_idTextAnchor186)中的*带有实时数据流的交易应用*部分，*回测和理论表现*）：
- en: '[PRE15]'
  id: totrans-141
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'The rest of the trade logic code in the `''Sell''` clause remains untouched,
    and I have reproduced it here only to maintain integrity:'
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: '`''Sell''`子句中的其余交易逻辑代码保持不变，我将其复制在这里只是为了保持完整性：'
- en: '[PRE16]'
  id: totrans-143
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'And symmetrical for a buy order: we buy when the close is greater than the
    short-period MA and the short-period MA is greater than the long-period MA:'
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 对于买入订单来说是对称的：当收盘价高于短期移动平均线，且短期移动平均线高于长期移动平均线时，我们买入：
- en: '[PRE17]'
  id: totrans-145
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: This is it. Nothing else needs any modification.
  id: totrans-146
  prefs: []
  type: TYPE_NORMAL
  zh: 就这样。不需要对其他任何内容进行修改。
- en: Are you ready to test your first trading strategy? Let’s run the code and look
    at the equity curve.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 你准备好测试你的第一个交易策略了吗？让我们运行代码并查看权益曲线。
- en: If you did everything correctly so far, you should see an equity curve similar
    to the one shown in *Figure 12**.3*.
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你到目前为止一切操作正确，你应该会看到一个类似于*图12.3*中所示的权益曲线。
- en: '![Figure 12.3 – Equity curve of the backtest of the trend-following strategy
    using AUDUSD daily data](img/B19145_12_03.jpg)'
  id: totrans-149
  prefs: []
  type: TYPE_IMG
  zh: '![图12.3 – 使用AUDUSD每日数据对趋势跟踪策略进行回测的权益曲线](img/B19145_12_03.jpg)'
- en: Figure 12.3 – Equity curve of the backtest of the trend-following strategy using
    AUDUSD daily data
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 图12.3 – 使用AUDUSD每日数据对趋势跟踪策略进行回测的权益曲线
- en: Not a bad start! In [*Chapter 11*](B19145_11.xhtml#_idTextAnchor186), *Backtesting
    and Theoretical Performance*, we talked about the equity curve and noted that
    traders (and investors, above all!) are looking for strategies that demonstrate
    consistent growth over time. Since our equity curve is a representation of our
    trend-following strategy PnL day by day, we can agree that this strategy indeed
    demonstrates growth in equity.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 还不错！在[*第11章*](B19145_11.xhtml#_idTextAnchor186)的*回测和理论表现*中，我们讨论了权益曲线，并指出交易者（尤其是投资者！）正在寻找能够随着时间的推移展示持续增长的策略。由于我们的权益曲线是我们趋势跟踪策略的PnL每日表示，我们可以同意这个策略确实展示了权益的增长。
- en: However, this result raises further questions. What is the meaning of the numbers
    on the *x* and *y* axes? How do we interpret this result in terms of money or
    percent growth? Can we say that the growth demonstrated by the backtest is consistent?
    These and other questions will be discussed in the very next chapter.
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，这个结果引发了一些进一步的问题。*x*轴和*y*轴上的数字意味着什么？我们如何从金钱或百分比增长的角度来解释这个结果？我们能否说回测展示的增长是一致的？这些问题以及其他问题将在下一章中进行讨论。
- en: Summary
  id: totrans-153
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 摘要
- en: Let’s quickly recap what we learned in this chapter. It indeed is the ultimate
    point where all the knowledge and skills we obtained in previous chapters unite
    and transform into a working trading application. More than that, in fact, we’ve
    got now a scalable *trading platform* suitable for both research and live trading.
    We suggested a robust design of the platform that keeps the architecture modular
    and scalable. We learned how to synchronize threads to ensure the correct order
    of execution of the platform modules while keeping these modules isolated. We
    saw practical examples of using various data sources that allow the platform to
    work with both live data feeds and historical data. We completely isolated the
    trade logic from the rest of the app so now we can develop a strategy using a
    backtest and then immediately copy and paste the code into the production version
    of our platform. Finally, using our knowledge of FX markets from previous chapters,
    we developed a simple trend-following strategy, tested it, and saw a promising
    result.
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们快速回顾一下本章所学的内容。这确实是所有我们在前几章中获得的知识和技能汇聚并转化为一个工作交易应用的关键点。不仅如此，实际上，我们现在拥有了一个可扩展的*交易平台*，适用于研究和实时交易。我们提出了一种稳健的平台设计，保持了架构的模块化和可扩展性。我们学习了如何同步线程，以确保平台模块执行的正确顺序，同时保持这些模块的隔离。我们看到了使用各种数据源的实用示例，这些数据源允许平台同时处理实时数据流和历史数据。我们将交易逻辑完全从应用程序的其他部分隔离出来，因此现在我们可以使用回测来开发策略，然后立即将代码复制粘贴到我们平台的版本中。最后，利用前几章中关于外汇市场的知识，我们开发了一个简单的趋势跟踪策略，对其进行了测试，并看到了有希望的结果。
- en: Now it’s time to analyze our result to get a full understanding of the strategy’s
    behavior and performance.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 现在是时候分析我们的结果，以全面了解策略的行为和性能了。
