<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch01"/>Chapter 1. Our Espionage Toolkit</h1></div></div></div><p>The job of <a id="id0" class="indexterm"/>espionage is to gather and analyze data. This requires us to use computers and software tools.</p><p>The ordinary <em>desktop</em> tools (word processor, spreadsheet, and so on) will not measure up for the kinds of jobs we need to tackle. For serious data gathering, analysis, and dissemination, we need more powerful tools. As we look at automating our data gathering, we can't easily use a desktop tool that requires manual pointing and clicking. We want a tool that can be left to run autonomously working for us without anyone sitting at a desk.</p><p>One of the most powerful data analysis tools we can use is Python. We're going to step through a series of examples of real data collection and analysis using Python. This chapter will cover the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Firstly, we're going to download and install the latest and greatest Python release.</li><li class="listitem" style="list-style-type: disc">We're going to supplement Python with the <code class="literal">easy_install</code> (or <code class="literal">pip</code>) tools to help us gather additional software tools in the later chapters.</li><li class="listitem" style="list-style-type: disc">We'll look at Python's internal help system briefly.</li><li class="listitem" style="list-style-type: disc">We'll look at how Python works with numbers. After all, a secret agent's job of collecting data is going to involve numbers.</li><li class="listitem" style="list-style-type: disc">We'll spend some time on the first steps of writing Python applications. We'll call our applications scripts as well as modules.</li><li class="listitem" style="list-style-type: disc">We'll break file input and output into several sections. We will have a quick overview as well as an in-depth look at ZIP archive files. In the later chapters, we'll look at more kinds of files.</li><li class="listitem" style="list-style-type: disc">Our big mission will be to apply our skills for recovering a lost password for a ZIP file. This won't be easy, but we should have covered enough of the basics to be successful.</li></ul></div><p>This will give us enough Python skills so that we can advance to more complex missions in the next chapters.</p><div><div><div><div><h1 class="title"><a id="ch01lvl1sec08"/>Getting the tools of the trade – Python 3.3</h1></div></div></div><p>The first step toward using Python is getting the Python language onto our computer. If your computer uses Mac OS X or Linux, you <a id="id1" class="indexterm"/>may already have Python available. At the time of this writing, it's Python 2.7, not 3.3. In this case, we will need to install Python 3.3 in addition to Python 2.7 we already have.</p><p>Windows agents generally don't have any version of Python, and need to install Python 3.3.</p><div><div><h3 class="title"><a id="tip02"/>Tip</h3><p>Python 3 is<a id="id2" class="indexterm"/> not <em>Python 2.7 plus a few features</em>. Python 3 is a distinct language. We don't cover Python 2.7 in this book. The examples won't work in Python 2. Really.</p></div></div><p>Python downloads<a id="id3" class="indexterm"/> are available at <a class="ulink" href="http://www.python.org/download/">http://www.python.org/download/</a>.</p><p>Locate the proper version for your computer. There are many pre-built binaries for Windows, Linux, and Mac OS X. Linux agents should focus on the binary appropriate to their distribution. Each download and install will be a bit different; we can't cover all the details.</p><p>There are several implementations of Python. We'll focus on<a id="id4" class="indexterm"/> CPython. For some missions, you might want to look at <a id="id5" class="indexterm"/>Jython, which is Python implemented using the Java Virtual Machine. If you're working with other .NET products, you might need<a id="id6" class="indexterm"/> Iron Python. In some cases, you might be interested in <a id="id7" class="indexterm"/>PyPy, which is Python implemented in Python. (And, yes, it seems circular and contradictory. It's really interesting, but well outside our focus.)</p><p>Python<a id="id8" class="indexterm"/> isn't the only tool. It's the starting point. We'll be downloading additional tools in the later chapters. It seems like half of our job as a secret agent is locating the tools required to crack open a particularly complex problem. The other half is actually getting the information.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec07"/>Windows secrets</h2></div></div></div><p>Download the Windows installer for Python 3.3 (or higher) for your version of Windows. When you<a id="id9" class="indexterm"/> run the installer, you'll be asked a number of questions about where to install it and what to install.</p><p>It's essential that Python be<a id="id10" class="indexterm"/> installed in a directory with a simple name. Under Windows, the common choice is <code class="literal">C:\Python33</code>. Using the Windows directories with spaces in their name (<code class="literal">Program Files</code>, <code class="literal">My Documents</code>, or <code class="literal">Documents and Settings</code>) can cause confusion.</p><p>Be sure to install the Tcl/Tk components too. This will assure that you have all the elements required to support IDLE. <strong>IDLE</strong> is a<a id="id11" class="indexterm"/> handy text editor that comes with Python. For Windows agents, this is generally bundled into the installation kit. All you<a id="id12" class="indexterm"/> need to do is be sure it has a check mark in the installation wizard.</p><p>With Windows, the <code class="literal">python.exe</code> program doesn't have a version number as part of its name. This is atypical.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec08"/>Mac OS X secrets</h2></div></div></div><p>In Mac OS X, there is already<a id="id13" class="indexterm"/> a Python installation, usually Python 2.7. This must be left intact.</p><p>Download the Mac OS X installer for Python 3.3 (or higher). When you run this, you will be adding a second version of Python. This means that many add-on modules and tools must be associated<a id="id14" class="indexterm"/> with the proper version of Python. This requires a little bit of care. It's not good to use the vaguely-named tool like <code class="literal">easy_install</code>. It's important to use the more specific <code class="literal">easy_install-3.3</code>, which identifies the version of Python you're working with.</p><p>The program named <code class="literal">python</code> is usually going to be an alias for <code class="literal">python2.7</code>. This, too, must be left intact. We'll always explicitly use <code class="literal">python3</code> (also known as <code class="literal">python3.3</code>) for this book. You can confirm this by using the shell command.</p><p>Note that there are several versions of Tcl/Tk available for Mac OS X. The Python website directs you to a specific version. At the time of this writing, this version was ActiveTCL 8.5.14 from ActiveState software. You'll need to install this, too. This software allows us to use IDLE.</p><p>Visit <a class="ulink" href="http://www.activestate.com/activetcl/downloads">http://www.activestate.com/activetcl/downloads</a> for the proper version.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec09"/>Getting more tools – a text editor</h1></div></div></div><p>To create Python applications, we're going to need a <a id="id15" class="indexterm"/>proper programmers' text editor. A word processor won't do because the files created by a word processor are too complex. We need simple text. Our <a id="id16" class="indexterm"/>emphasis is on simplicity. Python3 works in Unicode without bolding or italicizing the content. (Python 2 didn't work as well with Unicode. This is one of the reasons to leave it behind.)</p><p>If you've worked with text editors or <strong>integrated development environments</strong> (<strong>IDEs</strong>), you may already have a favorite. Feel free to use it. Some of the<a id="id17" class="indexterm"/> popular IDEs have Python support.</p><p>Python is called a dynamic language. It's not always simple to determine what names or keywords are legal in a given context. The Python compiler doesn't perform a lot of static checking. An IDE can't easily prompt with a short list of all legal alternatives. Some IDEs do take a stab<a id="id18" class="indexterm"/> at having logical suggestions, but they're not necessarily complete.</p><p>If you haven't worked with a programmer's editor (or an IDE), your first mission is to locate a text<a id="id19" class="indexterm"/> editor you can work with. Python includes an editor named IDLE that is easy to use. It's a good place to start.</p><p>The Active State Komodo Edit <a id="id20" class="indexterm"/>might be suitable (<a class="ulink" href="http://komodoide.com/ komodo-edit/">http://komodoide.com/komodo-edit/</a>). It's a lightweight version of a commercial product. It's got some very clever ways to handle the dynamic language aspects of Python.</p><p>There are many other code editors. Your first training mission is to locate something you can work with. You're on your own. We have faith in you.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec09"/>Getting other developer tools</h2></div></div></div><p>Most GNU/Linux agents have various C compilers and other developer tools available. Many Linux distributions are already configured to <a id="id21" class="indexterm"/>support developers, so the tools are already there.</p><p>Mac OS X agents will usually <a id="id22" class="indexterm"/>need Xcode. Get it from <a class="ulink" href="https://developer.apple.com/xcode/downloads/">https://developer.apple.com/xcode/downloads/</a>. Every Mac OS X agent should have this.</p><p>When installing this, be sure to also install the command line developer tools. This is another big download above and beyond the basic Xcode download.</p><p>Windows agents will generally find that pre-built binaries are available for most packages of interest. If, in a rare case, that pre-built code isn't available, tools such as <a id="id23" class="indexterm"/>Cygwin may be necessary. See <a class="ulink" href="http://www.cygwin.com">http://www.cygwin.com</a>.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec10"/>Getting a tool to get more Python components</h2></div></div></div><p>In order to effectively and simply download additional Python modules, we often use a tool to get tools. There are two popular ways to add Python<a id="id24" class="indexterm"/> modules: PIP and the <code class="literal">easy_install</code> script.</p><p>To<a id="id25" class="indexterm"/> install <code class="literal">easy_install</code>, go to <a class="ulink" href="https://pypi.python.org/pypi/setuptools/3.6">https://pypi.python.org/pypi/setuptools/3.6</a>.</p><p>The <code class="literal">setuptools</code> package will include the <code class="literal">easy_install</code> script, which we'll use to add modules to Python.</p><p>If you've got multiple versions of Python installed, be sure to download and then install the correct easy install version for Python 3.3. This means that you'll generally be using the <code class="literal">easy_install-3.3</code> script to add new software tools.</p><p>To<a id="id26" class="indexterm"/> install PIP, go to <a class="ulink" href="https://pypi.python.org/pypi/pip/1.5.6">https://pypi.python.org/pypi/pip/1.5.6</a>.</p><p>We'll be adding the <code class="literal">Pillow</code><a id="id27" class="indexterm"/> package in <a class="link" href="ch03.html" title="Chapter 3. Encoding Secret Messages with Steganography">Chapter 3</a>, <em>Encoding Secret Messages with Steganography</em>. We'll also be adding the <code class="literal">Beautiful Soup</code> package in <a class="link" href="ch04.html" title="Chapter 4. Drops, Hideouts, Meetups, and Lairs">Chapter 4</a>, <em>Drops, Hideouts, Meetups, and Lairs</em>.</p><p>The Python 3.4 distribution should include the PIP tool. You don't need to download it separately.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec10"/>Confirming our tools</h1></div></div></div><p>To be sure we have a working Python tool, it's best to check things from the command prompt. We're going<a id="id28" class="indexterm"/> to do a lot of our work using the command prompt. It involves the least overhead and is the most direct connection to Python.</p><p>The Python 3.3 program shows a startup message that looks like this:</p><div><pre class="programlisting">MacBookPro-SLott:Secret Agent's Python slott$ python3
Python 3.3.4 (v3.3.4:7ff62415e426, Feb  9 2014, 00:29:34)
[GCC 4.2.1 (Apple Inc. build 5666) (dot 3)] on darwin
Type help, copyright, credits or license for more information.
&gt;&gt;&gt;</pre></div><p>We've shown the operating system's prompt (<code class="literal">MacBookPro-SLott:Secret Agent's Python slott$</code>), the command we entered (<code class="literal">python3</code>), and the response from Python.</p><p>Python provides three lines of introduction followed by its own <code class="literal">&gt;&gt;&gt;</code> prompt. The first line shows that it's Python 3.3.4. The second line shows the tools used to build Python (GCC 4.2.1). The third line provides some hints about things we might do next.</p><p>We've interacted with Python. Things are working.</p><div><div><h3 class="title"><a id="tip03"/>Tip</h3><p>
<strong>Downloading the example code</strong>
</p><p>You can download the example code files for all Packt books you have purchased from your account at <a class="ulink" href="http://www.packtpub.com">http://www.packtpub.com</a>. If you purchased this book elsewhere, you can visit <a class="ulink" href="http://www.packtpub.com/support">http://www.packtpub.com/support</a> and register to have the files e-mailed directly to you.</p></div></div><p>Feel free to enter <code class="literal">copyright</code>, <code class="literal">credits</code>, and <code class="literal">license</code> at the <code class="literal">&gt;&gt;&gt;</code> prompt. They may be boring, but they serve as confirmation that things are working.</p><p>It's important to note that these objects (<code class="literal">copyright</code>, <code class="literal">credits</code>, and <code class="literal">license</code>) are not commands or verbs in the Python language. They're global variables that were created as a convenience for first-time<a id="id29" class="indexterm"/>  Python agents. When evaluated, they display blocks of text.</p><p>There are two other startup objects we'll use: <code class="literal">exit</code> and <code class="literal">help</code>. These provide little messages that remind us to use the <code class="literal">help()</code> and <code class="literal">exit()</code> functions.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec11"/>How do we stop?</h2></div></div></div><p>We can always enter<a id="id30" class="indexterm"/> <code class="literal">exit</code> to get a reminder on how to exit from interactive Python, as follows:</p><div><pre class="programlisting">&gt;&gt;&gt; exit</pre></div><p>Use <code class="literal">exit()</code> or <em>Ctrl</em> + <em>D</em> (that is<a id="id31" class="indexterm"/> <strong>EOF</strong> (<strong>end-of-file</strong>)) to exit.</p><p>Windows agents will see that they must use <em>Ctrl</em> + <em>Z</em> and <code class="literal">Return</code> to exit.</p><p>Python is a programming language that also has an interactive prompt of <code class="literal">&gt;&gt;&gt;</code>. To confirm that Python is working, we're responding<a id="id32" class="indexterm"/> to that prompt, using a feature called the <strong>Read-Execute-Print Loop</strong> (<strong>REPL</strong>).</p><p>In the long run, we'll be writing scripts to process our data. Our data might be an image or a secret message. The end of a script file will exit from Python. This is the same as pressing <em>Ctrl</em> + <em>D</em> (or <em>Ctrl</em> + <em>Z</em> and <code class="literal">Return</code>) to send the EOF sequence.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec12"/>Using the help() system</h2></div></div></div><p>Python has a help mode, which is started with the <code class="literal">help()</code> function. The <code class="literal">help()</code> function provides help on a specific topic. Almost anything you see in Python can be the subject of help.</p><p>For pieces of <a id="id33" class="indexterm"/>Python syntax, such as the <code class="literal">+</code> operator, you'll need to use a string meaning you should enclose the syntax in quotes. For example, <code class="literal">help("+")</code> will provide detailed help on operator precedence.</p><p>For<a id="id34" class="indexterm"/> other objects (such as numbers, strings, functions, classes, and modules) you can simply ask for help on the object itself; quotes aren't used. Python will locate the class of the object and provide help on the class.</p><p>For example, <code class="literal">help(3)</code> will provide a lot of detailed, technical help on integers, as shown in the following snippet:</p><div><pre class="programlisting">&gt;&gt;&gt; help(3)
Help on int object:
class int(object)
|  int(x=0) -&gt; integer
|  int(x, base=10) -&gt; integer
|
etc.</pre></div><p>When using the <code class="literal">help()</code> module from the command line, the output will be presented in pages. At the end of the first page of output, we see a new kind of non-Python prompt. This is usually <code class="literal">:</code>, but on Windows it may be <code class="literal">-- More --</code>.</p><p>Python<a id="id35" class="indexterm"/> normally prompts us with <code class="literal">&gt;&gt;&gt;</code> or <code class="literal">...</code>. A non-Python prompt must<a id="id36" class="indexterm"/> come from one of the help viewers.</p><div><div><div><div><h3 class="title"><a id="ch01lvl3sec01"/>Mac OS and GNU/Linux secrets</h3></div></div></div><p>In POSIX-compatible OSes, we'll be interacting with a program named <code class="literal">less</code>; it will prompt with <code class="literal">:</code> for all but the last page of your document. For the last page, it will prompt with <code class="literal">(END)</code>.</p><p>This program is very sophisticated; you can read more about it on Wikipedia at <a class="ulink" href="http://en.wikipedia.org/wiki/Less_(Unix)">http://en.wikipedia.org/wiki/Less_(Unix)</a>.</p><p>The four most important commands are as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">q</code>: This command is used <a id="id37" class="indexterm"/>to quit the <code class="literal">less</code> help viewer</li><li class="listitem" style="list-style-type: disc"><code class="literal">h</code>: This command is used to<a id="id38" class="indexterm"/> get help on all the commands that are available</li><li class="listitem" style="list-style-type: disc"><code class="literal">˽</code>: This command<a id="id39" class="indexterm"/> is used to enter a space to see the next page</li><li class="listitem" style="list-style-type: disc"><code class="literal">b</code>: This command is<a id="id40" class="indexterm"/> used to go back one page</li></ul></div></div><div><div><div><div><h3 class="title"><a id="ch01lvl3sec02"/>Windows secrets</h3></div></div></div><p>In Windows, we'll usually interact with a program named <code class="literal">more</code>; it will prompt you with <code class="literal">-- More --</code>. You <a id="id41" class="indexterm"/>can read more about it on Wikipedia from <a class="ulink" href="http://en.wikipedia.org/wiki/More_(command)">http://en.wikipedia.org/wiki/More_(command)</a>.</p><p>The three<a id="id42" class="indexterm"/> important commands <a id="id43" class="indexterm"/>here are: <code class="literal">q</code>, <code class="literal">h</code>, and <a id="id44" class="indexterm"/>˽.</p></div></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec13"/>Using the help mode</h2></div></div></div><p>When we enter <code class="literal">help()</code> with <a id="id45" class="indexterm"/>no object or <a id="id46" class="indexterm"/>string value, we wind up in help mode. This uses Python's <code class="literal">help&gt;</code> prompt to make it very clear that we're getting help, not entering Python statements. To go back to ordinary Python programming mode, and enter <code class="literal">quit</code>.</p><p>The prompt then changes back to <code class="literal">&gt;&gt;&gt;</code> to confirm that we can go back to entering code.</p><p>Your next training mission is to experiment with the <code class="literal">help()</code> function and help mode before we can move on.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec11"/>Background briefing – math and numbers</h1></div></div></div><p>We'll review basics of Python programming before we start any of our more serious missions. If you already<a id="id47" class="indexterm"/> know a little Python, this should be a review. If you don't know any Python, this is just an overview and many details will be omitted.</p><p>If you've never done any programming before, this<a id="id48" class="indexterm"/> briefing may be a bit too brief. You might want to get a more in-depth tutorial. If you're completely new to programming, you might want to look <a id="id49" class="indexterm"/>over this page for additional tutorials: <a class="ulink" href="https://wiki.python.org/moin/BeginnersGuide/NonProgrammers">https://wiki.python.org/moin/BeginnersGuide/NonProgrammers</a>. For more help to start with expert Python programming, go to <a class="ulink" href="http://www.packtpub.com/expert-python-programming/book">http://www.packtpub.com/expert-python-programming/book</a>.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec14"/>The usual culprits</h2></div></div></div><p>Python provides the usual mix of arithmetic and comparison operators. However, there are some important wrinkles and features. Rather than assuming you're aware of them, we'll review the details.</p><p>The <a id="id50" class="indexterm"/>conventional arithmetic operators are: <code class="literal">+</code>, <code class="literal">-</code>, <code class="literal">*</code>, <code class="literal">/</code>, <code class="literal">//</code>, <code class="literal">%</code>, and <code class="literal">**</code>. There are two variations on division: an<a id="id51" class="indexterm"/> exact division (<code class="literal">/</code>) and an <a id="id52" class="indexterm"/>integer division (<code class="literal">//</code>). You must choose whether you want an <a id="id53" class="indexterm"/>exact, floating-point result, or an integer result:</p><div><pre class="programlisting">&gt;&gt;&gt; 355/113
3.1415929203539825
&gt;&gt;&gt; 355//113
3
&gt;&gt;&gt; 355.0/113.0
3.1415929203539825
&gt;&gt;&gt; 355.0//113.0
3.0</pre></div><p>The exact division (<code class="literal">/</code>) produces a <code class="literal">float</code> result from two integers. The integer division produces an integer result. When we use <code class="literal">float</code> values, we expect exact division to produce <code class="literal">float</code>. Even with two floating-point values, the integer division produces a rounded-down floating-point result.</p><p>We have this extra division operator to avoid having to use wordy constructs such as <code class="literal">int(a/b)</code> or <code class="literal">math.floor(a/b)</code>.</p><p>Beyond conventional arithmetic, there are<a id="id54" class="indexterm"/> some additional <strong>bit fiddling</strong> operators<a id="id55" class="indexterm"/> that are available: <code class="literal">&amp;</code>, <code class="literal">|</code>, <code class="literal">^</code>, <code class="literal">&gt;&gt;</code>, <code class="literal">&lt;&lt;</code>, and <code class="literal">~</code>. These operators work on integers (and sets). These are emphatically not Boolean operators; they don't work on the narrow domain of <code class="literal">True</code> and <code class="literal">False</code>. They work on the individual bits of an integer.</p><p>We'll use binary values with the <code class="literal">0b</code> prefix to show what the operators do, as shown in the following code. We'll look at details of this <code class="literal">0b</code> prefix later.</p><div><pre class="programlisting">&gt;&gt;&gt; bin(0b0101 &amp; 0b0110)
'0b100'
&gt;&gt;&gt; bin(0b0101 ^ 0b0110)
'0b11'
&gt;&gt;&gt; bin(0b0101 | 0b0110)
'0b111'
&gt;&gt;&gt; bin(~0b0101)
'-0b110'</pre></div><p>The <code class="literal">&amp;</code> operator does bitwise <code class="literal">AND</code>. The <code class="literal">^</code> operator <a id="id56" class="indexterm"/>does bitwise exclusive <code class="literal">OR</code> (<code class="literal">XOR</code>). The <code class="literal">|</code> operator does inclusive <code class="literal">OR</code>. The <code class="literal">~</code> operator <a id="id57" class="indexterm"/>is the complement of the bits. The result has many 1 bits and is shown as a negative number.</p><p>The <code class="literal">&lt;&lt;</code> and <code class="literal">&gt;&gt;</code> operators are <a id="id58" class="indexterm"/>for doing left and right<a id="id59" class="indexterm"/> shifts of the bits, as shown in the following code:</p><div><pre class="programlisting">&gt;&gt;&gt; bin( 0b110 &lt;&lt; 4 )
'0b1100000'
&gt;&gt;&gt; bin( 0b1100000 &gt;&gt; 3 )
'0b1100'</pre></div><p>It may not be obvious, but shifting left <code class="literal">x</code> bits is like multiplying it by <code class="literal">2**x</code>, except it may operate faster. Similarly, shifting right by b bits amounts to division by <code class="literal">2**b</code>.</p><p>We also have all of the usual <a id="id60" class="indexterm"/>comparison operators: <code class="literal">&lt;</code>, <code class="literal">&lt;=</code>, <code class="literal">&gt;</code>, <code class="literal">&gt;=</code>, <code class="literal">==</code>, and <code class="literal">!=</code>.</p><p>In Python, we can combine comparison operators without including the <code class="literal">AND</code> operator:</p><div><pre class="programlisting">&gt;&gt;&gt; 7 &lt;= 11 &lt; 17
True
&gt;&gt;&gt; 7 &lt;= ll and 11 &lt; 17
True</pre></div><p>This simplification really does implement our conventional mathematical understanding of how comparisons can be written. We don't need to say <code class="literal">7 &lt;= 11 and 11 &lt; 17</code>.</p><p>There's another comparison operator that's used in some specialized situations: <code class="literal">is</code>. The <code class="literal">is</code> operator will appear, for now, to be the same as <code class="literal">==</code>. Try it. <code class="literal">3 is 3</code> and <code class="literal">3 == 3</code> seem to do the same thing. Later, when we start using the <code class="literal">None</code> object, we'll see the most common use for the <code class="literal">is</code> operator. For more advanced Python programming, there's a need to distinguish between two references to the same object (<code class="literal">is</code>) and two objects which claim to have the same value (<code class="literal">==</code>).</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec15"/>The ivory tower of numbers</h2></div></div></div><p>Python gives us a variety of numbers, plus the ability to easily add new kinds of numbers. We'll focus on the built-in numbers here. Adding new kinds of numbers is the sort of thing that takes up whole chapters in more advanced books.</p><p>Python ranks the numbers into a kind of tower. At the top are numbers with fewest features. Each subclass extends that number with more and more features. We'll look at the tower from bottom up, starting <a id="id61" class="indexterm"/>with the integers that have the most features, and moving towards the complex numbers that have the least features. The following sections cover the various kinds of numbers we'll need to use.</p><div><div><div><div><h3 class="title"><a id="ch01lvl3sec03"/>Integer numbers</h3></div></div></div><p>We can write <a id="id62" class="indexterm"/>integer values in base 10, 16, 8, or 2. Base 10 <a id="id63" class="indexterm"/>numbers don't need a prefix, the other bases will use a simple two-character prefix, as shown in the following snippet:</p><div><pre class="programlisting">48813
0xbead 
0b1011111010101101
0o137255</pre></div><p>We also have functions that will convert numbers into handy strings in different bases. We can use the <code class="literal">hex()</code>, <code class="literal">oct()</code>, and <code class="literal">bin()</code> functions to see a value in base 16, 8, or 2.</p><p>The question of integer size is common. Python integers don't have a maximum size. They're not artificially limited to 32 or 64 bits. Try this:</p><div><pre class="programlisting">&gt;&gt;&gt; 2**256
115792089237316195423570985008687907853269984665640564039457584007913129639936</pre></div><p>Large numbers work. They may be a bit slow, but they work perfectly fine.</p></div><div><div><div><div><h3 class="title"><a id="ch01lvl3sec04"/>Rational numbers</h3></div></div></div><p>Rational numbers are not commonly<a id="id64" class="indexterm"/> used. They must be imported<a id="id65" class="indexterm"/> from the standard library. We must import the <code class="literal">fractions</code>.<code class="literal">Fraction</code> class definition. It looks like this:</p><div><pre class="programlisting">&gt;&gt;&gt; from fractions import Fraction</pre></div><p>Once we have the <code class="literal">Fraction</code> class defined, we can use it to create numbers. Let's say we were sent out to track down a missing device. Details of the device are strictly need-to-know. Since we're new agents, all that HQ will release to us is the overall size in square inches.</p><p>Here's an exact calculation of the area of a device we found. It is measured as 4⅞" multiplied by 2¼":</p><div><pre class="programlisting">&gt;&gt;&gt; length=4+Fraction("7/8")
&gt;&gt;&gt; width=2+Fraction("1/4")
&gt;&gt;&gt; length*width
Fraction(351, 32)</pre></div><p>Okay, the area is 351/32, which is—what?—in real inches and fractions.</p><p>We can use Python's <code class="literal">divmod()</code> function to work this out. The<a id="id66" class="indexterm"/> <code class="literal">divmod()</code> function gives us a quotient<a id="id67" class="indexterm"/> and a remainder, as shown<a id="id68" class="indexterm"/> in the following code:</p><div><pre class="programlisting">&gt;&gt;&gt; divmod(351,32)
(10, 31)</pre></div><p>It's about 5 × 2, so the value seems to fit within our rough approximation. We can transmit that as the proper result. If we found the right device, we'll be instructed on what to do with it. Otherwise, we might have blown the assignment.</p></div><div><div><div><div><h3 class="title"><a id="ch01lvl3sec05"/>Floating-point numbers</h3></div></div></div><p>We can write floating-point values in common or scientific notation as follows:</p><div><pre class="programlisting">3.1415926
6.22E12</pre></div><p>The presence of the decimal point<a id="id69" class="indexterm"/> distinguishes an integer from a float.</p><p>These are ordinary <a id="id70" class="indexterm"/>double-precision floating-point numbers. It's important to remember that floating-point values are only approximations. They usually have a 64-bit implementation.</p><p>If you're using CPython, they're explicitly based on the C compiler that was shown in the <code class="literal">sys.version</code> startup message. We can also get information from the <code class="literal">platform</code> package as shown in the following code snippet:</p><div><pre class="programlisting">&gt;&gt;&gt; import platform
&gt;&gt;&gt; platform.python_build()
('v3.3.4:7ff62415e426', 'Feb  9 2014 00:29:34')
&gt;&gt;&gt; platform.python_compiler()
'GCC 4.2.1 (Apple Inc. build 5666) (dot 3)'</pre></div><p>This tells us which compiler was used. That, in turn, can tell us what floating-point libraries were used. This may help determine which underlying mathematical libraries are in use.</p></div><div><div><div><div><h3 class="title"><a id="ch01lvl3sec06"/>Decimal numbers</h3></div></div></div><p>We need to<a id="id71" class="indexterm"/> be careful with <a id="id72" class="indexterm"/>money. <em>Words to live by: the accountants watching over spies are a tight-fisted bunch</em>.</p><p>What's important is that floating-point numbers are an approximation. We can't rely on approximations when working with money. For currency, we need exact decimal values, nothing else will do. Decimal numbers can be used with the help of an extension module. We'll import the <code class="literal">decimal.Decimal</code> class definition to work with currency. It looks like this:</p><div><pre class="programlisting">&gt;&gt;&gt; from decimal import Decimal</pre></div><p>The informant we bribed to locate the device wants to be paid 50,000 Greek Drachma for the information on the missing device. When we submit our expenses, we'll need to include everything, including the cab fare (23.50 dollars) and the expensive lunch we had to buy her (12,900 GRD).</p><p>
<em>Why wouldn't the informant accept Dollars or Euros? We don't want to know, we just want their information</em>. Recently, Greek Drachma were trading at 247.616 per dollar.</p><p>What's the exact <a id="id73" class="indexterm"/>budget for the information? In drachma and dollars?</p><p>First, we will convert currency exact to the mil (1000 of a dollar):</p><div><pre class="programlisting">&gt;&gt;&gt; conversion=Decimal("247.616")
&gt;&gt;&gt; conversion
Decimal('247.616')</pre></div><p>The tab for our lunch, converted from drachma to dollars, is calculated as follows:</p><div><pre class="programlisting">&gt;&gt;&gt; lunch=Decimal("12900")
&gt;&gt;&gt; lunch/conversion
Decimal('52.09679503747738433703799431')</pre></div><p>What? How is that mess going to satisfy the accountants?</p><p>All those digits are a consequence of exact division: we get a lot of decimal places of precision; not all of them are really relevant. We need to formalize the idea of <em>rounding off</em> the value so that the government accountants will be happy. The nearest penny will do. In the <code class="literal">Decimal</code> method, we'll use the <code class="literal">quantize</code> method. The term <a id="id74" class="indexterm"/>
<strong>quantize</strong> refers to rounding up, rounding down, and truncating a given value. The <code class="literal">decimal</code> module offers a number of quantizing rules. The default rule is <code class="literal">ROUND_HALF_EVEN</code>: round to the nearest value; in the case of a tie, prefer the even value. The code looks as follows:</p><div><pre class="programlisting">&gt;&gt;&gt; penny=Decimal('.00')
&gt;&gt;&gt; (lunch/conversion).quantize(penny)
Decimal('52.10')
That's much better. How much was the bribe we needed to pay?
&gt;&gt;&gt; bribe=50000
&gt;&gt;&gt; (bribe/conversion).quantize(penny)
Decimal('201.93')</pre></div><p>Notice that the division involved an integer and a decimal. Python's definition of decimal will quietly create a new<a id="id75" class="indexterm"/> decimal number from the integer so that the math will be done using decimal objects.</p><p>The cab driver charged us US Dollars. We don't need to do much of a conversion. So, we will add this amount to the final amount, as shown in the following code:</p><div><pre class="programlisting">&gt;&gt;&gt; cab=Decimal('23.50')
That gets us to the whole calculation: lunch plus bribe, converted, plus cab.
&gt;&gt;&gt; ((lunch+bribe)/conversion).quantize(penny)+cab
Decimal('277.52')</pre></div><p>Wait. We seem to be off by a penny. Why didn't we get 277.53 dollars as an answer?</p><p>Rounding. The basic rule is called <em>round half up</em>. Each individual <a id="id76" class="indexterm"/>amount (<code class="literal">52.10</code> and <code class="literal">201.93</code>) had a fraction of a penny value rounded up. (The more detailed values were <code class="literal">52.097</code> and <code class="literal">201.926</code>.) When we computed the sum of the drachma before converting, the total didn't include the two separately rounded-up half-penny values.</p><p>We have a very fine <a id="id77" class="indexterm"/>degree of control over this. There are a number of rounding schemes, and there are a number of ways to define when and how to round. Also, some algebra may be required to see how it all fits together.</p></div><div><div><div><div><h3 class="title"><a id="ch01lvl3sec07"/>Complex numbers</h3></div></div></div><p>We also have <a id="id78" class="indexterm"/>complex numbers in Python. They're written<a id="id79" class="indexterm"/> with two parts: a real and an imaginary value, as shown in the following code:</p><div><pre class="programlisting">&gt;&gt;&gt; 2+3j
(2+3j)</pre></div><p>If we mix complex values with most other kinds of numbers, the results will be complex. The exception is decimal numbers. But why would we be mixing engineering data and currency? If any mission involves scientific and engineering data, we have a way to deal with the complex values.</p></div></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec16"/>Outside the numbers</h2></div></div></div><p>Python includes a variety of data types, which aren't numbers. In the <em>Handling text and strings</em> section, we'll look at Python strings. We'll look at collections in <a class="link" href="ch02.html" title="Chapter 2. Acquiring Intelligence Data">Chapter 2</a>, <em>Acquiring Intelligence Data</em>.</p><p>Boolean values, <code class="literal">True</code> and <code class="literal">False</code>, form their own <a id="id80" class="indexterm"/>little domain. We can extract a Boolean value from most objects using the <code class="literal">bool()</code> function. Here are some examples:</p><div><pre class="programlisting">&gt;&gt;&gt; bool(5)
True
&gt;&gt;&gt; bool(0)
False
&gt;&gt;&gt; bool('')
False
&gt;&gt;&gt; bool(None)
False
&gt;&gt;&gt; bool('word')
True</pre></div><p>The general pattern is that most objects have a value <code class="literal">True</code> and a few exceptional objects have a value <code class="literal">False</code>. Empty collections, <code class="literal">0</code>, and <code class="literal">None</code> have a value <code class="literal">False</code>. Boolean values have their own special operators: <code class="literal">and</code>, <code class="literal">or</code>, and <code class="literal">not</code>. These have an additional feature. Here's an example:</p><div><pre class="programlisting">&gt;&gt;&gt; True and 0
0
&gt;&gt;&gt; False and 0
False</pre></div><p>When we evaluate <code class="literal">True and 0</code>, both sides of the <code class="literal">and</code> operator are evaluated; the right-hand value was the result. But when we evaluated <code class="literal">False and 0</code>, only the left-hand side of <code class="literal">and</code> was evaluated. Since it was already <code class="literal">False</code>, there was no reason to evaluate the right-hand side.</p><p>The <code class="literal">and</code> and <code class="literal">or</code> operators are <em>short-circuit </em>operators. If <a id="id81" class="indexterm"/>the left side of <code class="literal">and</code> is <code class="literal">False</code>, that's sufficient<a id="id82" class="indexterm"/> and the right-hand <a id="id83" class="indexterm"/>side is ignored. If the left-hand side of <code class="literal">or</code> is <code class="literal">True</code>, that's sufficient and the right-hand side is ignored.</p><p>Python's rules for evaluation follow <a id="id84" class="indexterm"/>mathematic practice closely. Arithmetic operations have the highest priority. Comparison operators have a lower priority than arithmetic operations. The logical operators have a very low priority. This means that <code class="literal">a+2 &gt; b/3 or c==15</code> will be done in phases: first the arithmetic, then the comparison, and finally the logic.</p><p>Mathematical rules are followed by arithmetic rules. <code class="literal">**</code> has a higher priority than <code class="literal">*</code>, <code class="literal">/</code>, <code class="literal">//</code>, or <code class="literal">%</code>. The <code class="literal">+</code> and <code class="literal">–</code> operators come next. When we write <code class="literal">2*3+4</code>, the <code class="literal">2*3</code> operation must be performed first. The <a id="id85" class="indexterm"/>bit fiddling is even lower in priority. When you have a sequence of operations of the same priority (<code class="literal">a+b+c</code>), the computations are performed from left to right. If course, if there's any doubt, it's sensible to use parenthesis.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec17"/>Assigning values to variables</h2></div></div></div><p>We've been using the REPL feature of our Python toolset. In the long run, this isn't ideal. We'll be much happier writing scripts. The point behind using a computer for intelligence gathering is to automate data collection. Our scripts will require assignment to variables. It will also require explicit output and input.</p><p>We've shown the simple, obvious <a id="id86" class="indexterm"/>assignment statement in several examples previously. Note that we don't declare variables in Python. We<a id="id87" class="indexterm"/> simply assign values to variables. If the variable doesn't exist, it gets created. If the variable does exist, the previous value is replaced.</p><p>Let's look at some more sophisticated technology for creating and changing variables. We have multiple assignment statements. The following code will assign values to several variables at once:</p><div><pre class="programlisting">&gt;&gt;&gt; length, width = 2+Fraction(1,4), 4+Fraction(7,8)
&gt;&gt;&gt; length
Fraction(9, 4)
&gt;&gt;&gt; width
Fraction(39, 8)
&gt;&gt;&gt; length &gt;= width
False</pre></div><p>We've set two variables, <code class="literal">length</code> and <code class="literal">width</code>. However, we also made a small mistake. The length isn't the larger value; we've switched the values of <code class="literal">length</code> and <code class="literal">width</code>. We can swap them very simply using a multiple assignment statement as follows:</p><div><pre class="programlisting">&gt;&gt;&gt; length, width = width, length
&gt;&gt;&gt; length
Fraction(39, 8)
&gt;&gt;&gt; width
Fraction(9, 4)</pre></div><p>This works because the right-hand side is computed in its entirety. In this case, it's really simple. Then all of the values are broken down and assigned to the named variables. Clearly, the number of values on the right have to match the number of variables on the left or this won't work.</p><p>We also have <em>augmented</em> assignment statements. These couple an arithmetic operator with the assignment statement. The following code is an example of <code class="literal">+=</code>: using assignment augmented with addition. Here's an <a id="id88" class="indexterm"/>example of computing a sum from various bits and pieces:</p><div><pre class="programlisting">&gt;&gt;&gt; total= 0
&gt;&gt;&gt; total += (lunch/conversion).quantize(penny)
&gt;&gt;&gt; total += (bribe/conversion).quantize(penny)
&gt;&gt;&gt; total += cab
&gt;&gt;&gt; total
Decimal('277.53')</pre></div><p>We don't have to write <code class="literal">total = total +...</code>. Instead, we can simply write <code class="literal">total += ...</code>. It's a nice clarification of what our intent is.</p><p>All of the arithmetic operators are available as augmented assignment statements. We might have a hard time finding a use for <code class="literal">%=</code> or <code class="literal">**=</code>, but the statements are part of the language.</p><p>The idea of a nice<a id="id89" class="indexterm"/> clarification should lead to some additional thinking. For example, the variable named <code class="literal">conversion</code> is a perfectly opaque name. Secrecy for data is one thing: we'll look at ways to encrypt data. Obscurity through shabby processing of that data often leads to a nightmarish mess. Maybe we should have called it something that defines more clearly what it means. We'll revisit this problem of obscurity in some examples later on.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec18"/>Writing scripts and seeing output</h2></div></div></div><p>Most of our missions will involve gathering and analyzing data. We won't be creating a very sophisticated<a id="id90" class="indexterm"/> <strong>User Interface</strong> (<strong>UI</strong>). Python has tools for building websites and complex<a id="id91" class="indexterm"/> <strong>graphical user interfaces</strong> (<strong>GUIs</strong>). The complexity of those topics leads to entire books to cover GUI and web development.</p><p>We don't want to type<a id="id92" class="indexterm"/> each individual Python statement at the <code class="literal">&gt;&gt;&gt;</code> prompt. That makes it easy to learn Python, but our goal is to create programs. In GNU/Linux parlance, our Python application programs can be called <a id="id93" class="indexterm"/>
<strong>scripts</strong>. This is because Python programs fit the definition for a <em>scripting</em> language.</p><p>For our purposes, we'll focus on scripts that use the <a id="id94" class="indexterm"/>
<strong>command-line interface</strong> (<strong>CLI</strong>) Everything we'll write will run in a simple terminal window. The advantage of this approach is speed and simplicity. We can add graphic user interfaces later. Or we can expand the essential core of a small script into a web service, once it works.</p><p>What is an <a id="id95" class="indexterm"/>application or a script? A script is simply a plain text file. We can use any text editor to create this file. A word processor is rarely a good idea, since word processors aren't good at producing plain text files.</p><p>If we're not working from the <code class="literal">&gt;&gt;&gt;</code> REPL prompt, we'll need to explicitly display the output. We'll display output from a script using the <code class="literal">print()</code> function.</p><p>Here's a simple script <a id="id96" class="indexterm"/>we can use to produce a receipt for bribing (<em>encouraging</em>) our informant.</p><p>From decimal import <code class="literal">Decimal</code>:</p><div><pre class="programlisting">PENNY= Decimal('.00')

grd_usd= Decimal('247.616')
lunch_grd= Decimal('12900')
bribe_grd= 50000
cab_usd= Decimal('23.50')

lunch_usd= (lunch_grd/grd_usd).quantize(PENNY)
bribe_usd= (bribe_grd/grd_usd).quantize(PENNY)

print( "Lunch", lunch_grd, "GRD", lunch_usd, "USD" )
print( "Bribe", bribe_grd, "GRD", bribe_usd, "USD" )
print( "Cab", cab_usd, "USD" )
print( "Total", lunch_usd+bribe_usd+cab_usd, "USD" )</pre></div><p>Let's break this script down so that we can follow it. Reading a script is a lot like putting a tail on an informant. We want to see where the script goes and what it does.</p><p>First, we imported the <code class="literal">Decimal</code> definition. This is essential for working with currency. We defined a<a id="id97" class="indexterm"/> value, <code class="literal">PENNY</code>, that we'll use to round off currency calculations to the nearest penny. We used a name in all caps to make this variable distinctive. It's not an ordinary variable; we should <em>never</em> see it on the left-hand side of an assignment statement again in the script.</p><p>We created the currency conversion factor, and named it <code class="literal">grd_usd</code>. That's a name that seems meaningful than <code class="literal">conversion</code> in this context. Note that we also added a small suffix to our amount names. We used names such as <code class="literal">lunch_grd</code>, <code class="literal">bribe_grd</code>, and <code class="literal">cab_usd</code> to emphasize which currency is being used. This can help prevent head-scrambling problems.</p><p>Given the <code class="literal">grd_usd</code> conversion factor, we created two more variables, <code class="literal">lunch_usd</code> and <code class="literal">bribe_usd</code>, with the amounts converted to dollars and rounded to the nearest penny. If the accountants want to fiddle with the conversion factor—perhaps they can use a different bank than us spies—they can tweak the number and prepare a different receipt.</p><p>The final step was to use the<a id="id98" class="indexterm"/> <code class="literal">print()</code> function to write the receipt. We printed the three items we spent money on, showing the amounts in GRD and USD. We also computed the total. This will help the accountants to properly reimburse us for the mission.</p><p>We'll describe the output as <em>primitive but acceptable</em>. After all, they're only accountants. We'll look into pretty formatting separately.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec19"/>Gathering user input</h2></div></div></div><p>The simplest way to gather input is<a id="id99" class="indexterm"/> to copy and paste it into the script. That's what we did previously. We pasted the Greek Drachma conversion into the script: <code class="literal">grd_usd= Decimal('247.616')</code>. We could annotate this with a comment to help the accountants make any changes.</p><p>Additional comments come at the end of the line, after a <code class="literal">#</code> sign. They look like this:</p><div><pre class="programlisting">grd_usd= Decimal('247.616') # Conversion from Mihalis Bank 5/15/14</pre></div><p>This extra text is part of the application, but it doesn't actually do anything. It's a note to ourselves, our accountants, our handler, or the person who takes over our assignments when we disappear.</p><p>This kind of data line is easy to edit. But sometimes the people we work with want more flexibility. In that case, we can gather this value as input from a person. For this, we'll use the <code class="literal">input()</code> function.</p><p>We often break user input down into two steps like this:</p><div><pre class="programlisting">        entry= input("GRD conversion: ")
        grd_usd= Decimal(entry)</pre></div><p>The first line will write a prompt and wait for the user to enter the amount. The amount will be a string of characters, assigned to the variable <code class="literal">entry</code>. Python can't use the characters directly in <a id="id100" class="indexterm"/>arithmetic statements, so we need to explicitly convert them to a useful numeric type.</p><p>The second line will try to convert the user's input to a useful <code class="literal">Decimal</code> object. We have to emphasize the <code class="literal">try</code> part of this. If the user doesn't enter a string that represents valid <code class="literal">Decimal</code> number, there will be a major crisis. Try it.</p><p>The crisis will look like this:</p><div><pre class="programlisting">&gt;&gt;&gt; entry= input("GRD conversion: ")
GRD conversion: 123.%$6
&gt;&gt;&gt; grd_usd= Decimal(entry)
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
decimal.InvalidOperation: [&lt;class 'decimal.ConversionSyntax'&gt;]</pre></div><p>Rather than this, enter a good number. We entered <code class="literal">123.%$6</code>.</p><p>The bletch starting with <code class="literal">Traceback</code> indicates that Python raised an exception. A crisis in Python always results in an exception being raised. Python defines a variety of exceptions to make it possible for us to write scripts that deal with these kinds of crises.</p><p>Once we've seen how to deal with crises, we can look at string data and some simple clean-up steps that can make the user's life a little easier. We can't fix their mistakes, but we can handle a few common problems that stem from trying to type numbers on a keyboard.</p><div><div><div><div><h3 class="title"><a id="ch01lvl3sec08"/>Handling exceptions</h3></div></div></div><p>An exception <a id="id101" class="indexterm"/>such as <code class="literal">decimal.InvalidOperation</code> is raised when the <code class="literal">Decimal</code> class can't parse the given string to create a valid <code class="literal">Decimal</code> object. What can we do with this exception?</p><p>We can ignore it. In that case, our application program crashes. It stops running and the agents using it are unhappy. Not really the best approach.</p><p>Here's the basic technique for catching an exception:</p><div><pre class="programlisting">    entry= input("GRD conversion: ")
    try:
        grd_usd= Decimal(entry)
    except decimal.InvalidOperation:
        print("Invalid: ", entry)</pre></div><p>We've wrapped the <code class="literal">Decimal()</code> conversion and assignment in a <code class="literal">try:</code> statement. If every statement in the <code class="literal">try:</code> block works, the <code class="literal">grd_usd</code> variable will be set. If, on the other hand, a <code class="literal">decimal.InvalidOperation</code> exception is raised inside the <code class="literal">try:</code> block, the <code class="literal">except</code> clause will be processed. This writes a message and does not set the <code class="literal">grd_usd</code> variable.</p><p>We can handle an<a id="id102" class="indexterm"/> exception in a variety of ways. The most common kind of exception handling will clean up in the event of some failure. For example, a script that attempts to create a file might delete the useless file if an exception was raised. The problem hasn't been solved: the program still has to stop. But it can stop in a clean, pleasant way instead of a messy way.</p><p>We can also handle an exception by computing an alternate answer. We might be gathering information from a variety of web services. If one doesn't respond in time, we'll get a timeout exception. In this case, we may try an alternate web service.</p><p>In another common exception-handling case, we may reset the state of the computation so that an action can be tried again. In this case, we'll wrap the exception handler in a loop that can repeatedly ask the user for input until they provide a valid number.</p><p>These choices aren't exclusive and some handlers can perform combinations of the previous exception handlers. We'll look at the third choice, trying again, in detail.</p></div><div><div><div><div><h3 class="title"><a id="ch01lvl3sec09"/>Looping and trying again</h3></div></div></div><p>Here's a common <a id="id103" class="indexterm"/>recipe for getting input from the user:</p><div><pre class="programlisting">grd_usd= None
while grd_usd is None:
    entry= input("GRD conversion: ")
    try:
        grd_usd= Decimal(entry)
    except decimal.InvalidOperation:
        print("Invalid: ", entry)
print( grd_usd, "GRD = 1 USD" )</pre></div><p>We'll add a tail to this and follow it around for a bit. The goal is to get a valid decimal value for our currency conversion, <code class="literal">grd_usd</code>. We'll initialize that variable as Python's special <code class="literal">None</code> object.</p><p>The <code class="literal">while</code> statement makes a formal declaration of our intent. We're going to execute the body of the <code class="literal">while</code> statement while the <code class="literal">grd_usd</code> variable remains set to <code class="literal">None</code>. Note that we're using the <code class="literal">is</code> operator to compare <code class="literal">grd_usd</code> to <code class="literal">None</code>. We're emphasizing a detail here: there's only one <code class="literal">None</code> object in Python and we're using that single instance. It's technically possible to tweak the definition of <code class="literal">==</code>; we can't tweak the definition of <code class="literal">is</code>.</p><p>At the end of the <code class="literal">while</code> statement, <code class="literal">grd_usd is None</code> must be <code class="literal">False</code>; we can say <code class="literal">grd_usd is not None</code>. When we look at the body of the statement, we can see that only one statement sets <code class="literal">grd_usd</code>, so we're assured that it must be a valid <code class="literal">Decimal</code> object.</p><p>Within the<a id="id104" class="indexterm"/> body of the <code class="literal">while</code> statement, we've used our exception-handling recipe. First, we prompt and get some input, setting the <code class="literal">entry</code> variable. Then, inside the <code class="literal">try</code> statement, we attempt to convert the string to a <code class="literal">Decimal</code> value. If that conversion works, then <code class="literal">grd_usd</code> will have that <code class="literal">Decimal</code> object assigned. The object will not be <code class="literal">None</code> and the loop will terminate. Victory!</p><p>If the conversion of entry to a <code class="literal">Decimal</code> value fails, the exception will be raised. We'll print a message, and leave <code class="literal">grd_usd</code> alone. It will still have a value of <code class="literal">None</code>. The loop will continue until a valid value is entered.</p><p>Python has other kinds of loops, we'll get to them later in this chapter.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec12"/>Handling text and strings</h1></div></div></div><p>We've glossed<a id="id105" class="indexterm"/> over Python's use<a id="id106" class="indexterm"/> of string objects. Expressions such as <code class="literal">Decimal('247.616')</code> and <code class="literal">input(GRD conversion: )</code> involve string literal values. Python gives us several ways to put strings into our programs; there's a lot of flexibility available.</p><p>Here are some examples<a id="id107" class="indexterm"/> of strings:</p><div><pre class="programlisting">&gt;&gt;&gt; "short"
'short'
&gt;&gt;&gt; 'short'
'short'
&gt;&gt;&gt; """A multiple line,
... very long string."""
'A multiple line,\nvery long string.'
&gt;&gt;&gt; '''another multiple line
... very long string.'''
'another multiple line\nvery long string.'</pre></div><p>We've used single quotes and apostrophes to create short strings. These must be complete within a single line of programming. We<a id="id108" class="indexterm"/> used triple quotes and triple apostrophes to create long strings. These strings can stretch over multiple lines of a program.</p><p>Note that Python echoes the strings back to us with a <code class="literal">\n</code> character to show the line break. This is called a<a id="id109" class="indexterm"/> <strong>character escape</strong>. The <code class="literal">\</code> character escapes the normal meaning of <code class="literal">n</code>. The sequence <code class="literal">\n</code> doesn't mean <code class="literal">n</code>; <code class="literal">\n</code> means the often invisible newline character. Python has a number of escapes. The newline character is perhaps the most commonly used escape.</p><p>Sometimes we'll need to use characters which aren't present on our computer keyboards. For example, we might want to print one of the wide variety of Unicode special characters.</p><p>The following example works well when we know the Unicode number for a particular symbol:</p><div><pre class="programlisting">&gt;&gt;&gt; "\u2328"
'⌨'</pre></div><p>The following example is better because we don't need to know the obscure code for a symbol:</p><div><pre class="programlisting">&gt;&gt;&gt; "\N{KEYBOARD}"
'⌨'</pre></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec20"/>Converting between numbers and strings</h2></div></div></div><p>We have two kinds<a id="id110" class="indexterm"/> of interesting string conversions: strings to<a id="id111" class="indexterm"/> numbers and numbers to strings.</p><p>We've seen functions such as <code class="literal">Decimal()</code> to convert a string to a number. We also have the functions: <code class="literal">int(), float(), fractions.Fraction()</code>, and <code class="literal">complex()</code>. When we have numbers that aren't in base 10, we can also use <code class="literal">int()</code> to convert those, as shown in the following code:</p><div><pre class="programlisting">&gt;&gt;&gt; int( 'dead', 16 )
57005
&gt;&gt;&gt; int( '0b1101111010101101', 2 )
57005</pre></div><p>We can create strings from numbers too. We can use functions such as <code class="literal">hex()</code>, <code class="literal">oct()</code>, and <code class="literal">bin()</code> to create strings in base 16, 8, and 2. We also have the <code class="literal">str()</code> function, which is the most general-purpose function to convert any Python object into a string of some kind.</p><p>More valuable than these is the <code class="literal">format()</code> method of a string. This performs a variety of value-to-string conversions. It uses <a id="id112" class="indexterm"/>a conversion format specification or template string to define what the resulting string will look like.</p><p>Here's an example of using <code class="literal">format()</code> to convert several values into a single string. It uses a rather complex format specification string:</p><div><pre class="programlisting"> &gt;&gt;&gt; "{0:12s} {1:6.2f} USD {2:8.0f} GRD".format( "lunch", lunch_usd, lunch_grd )
'lunch         52.10 USD    12900 GRD'</pre></div><p>The format string has three conversion specifications: <code class="literal">{0:12s}</code>, <code class="literal">{1:6.2f}</code>, and <code class="literal">{2:8.0f}</code>. It also has some literal text, mostly spaces, but <code class="literal">USD</code> and <code class="literal">GRD</code> are part of the background literal text into which the data will be merged.</p><p>Each conversion <a id="id113" class="indexterm"/>specification has two parts: the item to convert and the format for that item. These two parts separated by a <code class="literal">:</code> inside <code class="literal">{}</code>. We'll look at each conversion:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The item <code class="literal">0</code> is converted using the <code class="literal">12s</code> format. This format produces a twelve-position string. The string <code class="literal">lunch</code> was padded out to 12 positions.</li><li class="listitem" style="list-style-type: disc">The item <code class="literal">1</code> is converted using the <code class="literal">6.2f</code> format. This format produces a six-position string. There will be two positions to the right of the decimal point. The value of <code class="literal">lunch_usd</code> was formatted using this.</li><li class="listitem" style="list-style-type: disc">The item <code class="literal">2</code> is converted using an <code class="literal">8.0f</code> format. This format produces an eight-position string with no positions to the right of the decimal point. The value of <code class="literal">lunch_grd</code> was formatted using this specification.</li></ul></div><p>We can do something like the following to improve our receipt:</p><div><pre class="programlisting">receipt_1 = "{0:12s}              {1:6.2f} USD"
receipt_2 = "{0:12s} {1:8.0f} GRD {2:6.2f} USD"
print( receipt_2.format("Lunch", lunch_grd, lunch_usd) )
print( receipt_2.format("Bribe", bribe_grd, bribe_usd) )
print( receipt_1.format("Cab", cab_usd) )
print( receipt_1.format("Total", lunch_usd+bribe_usd+cab_usd) )</pre></div><p>We've used two parallel format specifications. The <code class="literal">receipt_1</code> string can be used to format a label and a<a id="id114" class="indexterm"/> single dollar value. The <code class="literal">receipt_2</code> string can be used to format a label and two numeric<a id="id115" class="indexterm"/> values: one in dollars and the other in Greek Drachma.</p><p>This makes a better-looking receipt. That should keep the accountants off our back and let us focus on the real work: working on data files and folders.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec21"/>Parsing strings</h2></div></div></div><p>String objects can also be decomposed or parsed into substrings. We could easily write an entire chapter on all the various parsing methods that string objects offer. A common transformation is to strip <a id="id116" class="indexterm"/>extraneous whitespace from the beginning and end of a string. The idea is to remove spaces and tabs (and a few other nonobvious characters). It looks like this:</p><div><pre class="programlisting">entry= input("GRD conversion: ").strip()</pre></div><p>We've applied the <code class="literal">input()</code> function to get a string from the user. Then we've applied the <code class="literal">strip()</code> method of that string object to create a new string, stripped bare of whitespace characters. We can try it from the <code class="literal">&gt;&gt;&gt;</code> prompt like this:</p><div><pre class="programlisting">&gt;&gt;&gt; "   123.45     ".strip()
'123.45'</pre></div><p>This shows how a string with junk was pared down to the essentials. This can simplify a user's life; a few extra spaces won't be a problem.</p><p>Another transformation might be to split a string into pieces. Here's just one of the many techniques available:</p><div><pre class="programlisting">&gt;&gt;&gt; amount, space, currency = "123.45 USD".partition(" ")
&gt;&gt;&gt; amount
'123.45'
&gt;&gt;&gt; space
' '
&gt;&gt;&gt; currency
'USD'</pre></div><p>Let's look at this in detail. First, it's a multiple-assignment statement, where three variables are going to be set: <code class="literal">amount</code>, <code class="literal">space</code>, and <code class="literal">currency</code>.</p><p>The expression, <code class="literal">"123.45 USD".partition(" ")</code>, works by applying the <code class="literal">partition()</code> method to a literal string value. We're going to partition the string on the space character. The <code class="literal">partition()</code> method returns three things: the substring in front of the partition, the partition character, and the substring after the partition.</p><p>The actual partition variable may also be assigned an empty string, <code class="literal">''</code>. Try this:</p><div><pre class="programlisting">amount, space, currency = "word".partition(" ") </pre></div><p>What are the values for <code class="literal">amount</code>, <code class="literal">space</code>, and <code class="literal">currency</code>?</p><p>If you use <code class="literal">help(str)</code>, you'll <a id="id117" class="indexterm"/>see all of the various kinds of things a string can do. The names that have <code class="literal">__</code> around them map to Python operators. <code class="literal">__add__()</code>, for example, is how the <code class="literal">+</code> operator is implemented.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec13"/>Organizing our software</h1></div></div></div><p>Python gives us a number of ways to organize software into conceptual units. Long, sprawling scripts are hard to read, repair, or extend. Python<a id="id118" class="indexterm"/> offers us packages, modules, classes, and functions. We'll see different organizing techniques throughout our agent training. We'll start with function definition.</p><p>We've used a number of Python's built-in functions in the previous sections. Defining our own function is something we do with the <code class="literal">def</code> statement. A function definition allows us to summarize (and in some cases generalize) some processing. Here's a simple function we can use to get a decimal value from a user:</p><div><pre class="programlisting">def get_decimal(prompt):
    value= None
    while value is None:
        entry= input(prompt)
        try:
            value= Decimal(entry)
        except decimal.InvalidOperation:
            print("Invalid: ", entry)
    return value</pre></div><p>This follows the design we showed previously, packaged as a separate function. This function will return a proper <code class="literal">Decimal</code> object: the value of the <code class="literal">value</code> variable. We can use our <code class="literal">get_decimal()</code> function like this:</p><div><pre class="programlisting">grd_usd= get_decimal("GRD conversion: ")</pre></div><p>Python allows a great deal of variability in how argument values are supplied to functions. One common technique is to have an optional parameter, which can be provided using a keyword argument. The<a id="id119" class="indexterm"/> <code class="literal">print()</code> function has this feature, we can name a file by providing a keyword argument value.</p><div><pre class="programlisting">import sys
print("Error", file=sys.stderr)</pre></div><p>If we don't provide the <code class="literal">file</code> parameter, the <code class="literal">sys.stdout</code> file is used by default.</p><p>We can do this in our own functions with the following syntax:</p><div><pre class="programlisting">def report( grd_usd, target=sys.stdout ):
    lunch_grd= Decimal('12900')
    bribe_grd= 50000
    cab_usd= Decimal('23.50')

    lunch_usd= (lunch_grd/grd_usd).quantize(PENNY)
    bribe_usd= (bribe_grd/grd_usd).quantize(PENNY)

    receipt_1 = "{0:12s}              {1:6.2f} USD"
    receipt_2 = "{0:12s} {1:8.0f} GRD {2:6.2f} USD"
    print( receipt_2.format("Lunch", lunch_grd, lunch_usd), file=target )
    print( receipt_2.format("Bribe", bribe_grd, bribe_usd), file=target )
    print( receipt_1.format("Cab", cab_usd), file=target )
    print( receipt_1.format("Total", lunch_usd+bribe_usd+cab_usd), file=target )</pre></div><p>We defined our <code class="literal">report</code> function to have two parameters. The <code class="literal">grd_usd</code> parameter is required. The <code class="literal">target</code> parameter has a default value, so it's optional.</p><p>We're also using a global <a id="id120" class="indexterm"/>variable, <code class="literal">PENNY</code>. This was something we set outside the function. The value is usable inside the function.</p><p>The four <code class="literal">print()</code> functions provide the file parameter using the keyword syntax: <code class="literal">file=target</code>. If we provided a value for the <code class="literal">target</code> parameter, that will be used; if we did not provide a value for <code class="literal">target</code>, the default value of the <code class="literal">sys.stdout</code> file will be used. We can use this function in several ways. Here's one version:</p><div><pre class="programlisting">rate= get_decimal("GRD conversion: ")
print(rate, "GRD = 1 USD")
report(rate)</pre></div><p>We provided the <code class="literal">grd_usd</code> parameter value positionally: it's first. We didn't provide a value for the <code class="literal">target</code> parameter; the default value will be used.</p><p>Here's another version:</p><div><pre class="programlisting">rate= get_decimal("GRD conversion: ")
print(rate, "GRD = 1 USD", file=sys.stdout)
report(grd_usd=rate, target=sys.stdout)</pre></div><p>In this example, we used the keyword parameter syntax for both the <code class="literal">grd_usd</code> and <code class="literal">target</code> parameters. Yes, the <code class="literal">target</code> parameter value recapitulated the default value. We'll look at how to create our own files in the next section.</p></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec14"/>Working with files and folders</h1></div></div></div><p>Our computer is full of files. One of the most important features of our operating system is the way it handles files and devices. Python gives us an outstanding level of access to various kinds of files.</p><p>However, we've got to draw a few lines. All files consist of bytes. This is a reductionist view that's not always helpful. Sometimes<a id="id121" class="indexterm"/> those bytes represent Unicode characters which makes reading the file is relatively easy. Sometimes those bytes represent more complex objects which makes reading the file may be quite difficult.</p><p>Pragmatically, files come in a wide variety of physical formats. Our various desktop applications (word processors, spread sheets, and so on) all have unique formats for the data. Some of those physical formats are proprietary products, and this makes them exceptionally difficult to work with. The <a id="id122" class="indexterm"/>contents are obscure (not secure) and the cost of ferreting out the information can be extraordinary. We can always resort to examining the low-level bytes and recovering information that way.</p><p>Many applications work with files in widely standardized formats. This makes our life much simpler. The format may be complex, but the fact that it conforms to a standard means that we can recover all of the data. We'll look at a number of standardized formats for subsequent missions. For now, we need to get the basics under our belts.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec22"/>Creating a file</h2></div></div></div><p>We'll start by creating<a id="id123" class="indexterm"/> a text file that we can work with. There are several interesting aspects to working with files. We'll focus on the following two aspects:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating a <code class="literal">file</code> object. The <code class="literal">file</code> object is the Python view of an operating system resource. It's actually rather complex, but we can access it very easily.</li><li class="listitem" style="list-style-type: disc">Using the file context. A file has a particular life: open, read or write, and then close. To be sure that we close the file and properly disentangle the OS resources from the<a id="id124" class="indexterm"/> Python object, we're usually happiest using a file as a context manager. Using a <code class="literal">with</code> statement guarantees that the file is properly closed.</li></ul></div><p>Our general template, with <code class="literal">open("message1.txt", "w")</code> as target, for creating a file looks like this:</p><div><pre class="programlisting">    print( "Message to HQ", file=target )
    print( "Device Size 10 31/32", file=target )</pre></div><p>We'll open the file with the<a id="id125" class="indexterm"/> <code class="literal">open()</code> function. In this case, the file is opened in write mode. We've used the <code class="literal">print()</code> function<a id="id126" class="indexterm"/> to write some data into the file.</p><p>Once the program<a id="id127" class="indexterm"/> finishes the indented context of the <code class="literal">with</code> statement, the file is properly closed and the OS resources are released. We don't need to explicitly close the <code class="literal">file</code> object.</p><p>We can also use something like this to create our file:</p><div><pre class="programlisting">text="""Message to HQ\n Device Size 10 31/32\n"""
with open("message1.txt", "w") as target:
    target.write(text)</pre></div><p>Note the important difference here. The <code class="literal">print()</code> function automatically ends each line with a <code class="literal">\n</code> character. The <code class="literal">write()</code> method of a file object doesn't add anything.</p><p>In many cases, we may have more complex physical formatting for a file. We'll look at JSON or CSV files in a later section. We'll also look at reading and writing image files in <a class="link" href="ch03.html" title="Chapter 3. Encoding Secret Messages with Steganography">Chapter 3</a>, <em>Encoding Secret Messages with Steganography</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec23"/>Reading a file</h2></div></div></div><p>Our general template for reading a file looks like this:</p><div><pre class="programlisting">with open("message1.txt", "r") as source:
    text= source.read()
print( text )</pre></div><p>This will create the <code class="literal">file</code> object, but it will<a id="id128" class="indexterm"/> be in read mode. If the file doesn't exist, we'll get an exception. The<a id="id129" class="indexterm"/> <code class="literal">read()</code> function will slurp the entire file into a single block of text. Once we're done reading the content of the file, we're also done with the <code class="literal">with</code> context. The file can be closed and the resources can be released. The text variable that we created will have the file's contents ready for further processing.</p><p>In many cases, we want to process the lines of the text separately. For this, Python gives us the <code class="literal">for</code> loop. This statement interacts with files to iterate through each line of the file, as shown in the following code:</p><div><pre class="programlisting">with open("message1.txt", "r") as source:
    for line in source:
        print(line)</pre></div><p>The output looks a bit odd, doesn't it?</p><p>It's double-spaced because each line read from the file contains a <code class="literal">\n</code> character at the end. The <code class="literal">print()</code> function automatically includes a <code class="literal">\n</code> character. This leads to double-spaced output.</p><p>We have two candidate fixes. We can tell the <code class="literal">print()</code> function not to include a <code class="literal">\n</code> character. For example, <code class="literal">print(line, end="")</code> does this.</p><p>A slightly better<a id="id130" class="indexterm"/> fix is to use the <code class="literal">rstrip()</code> method<a id="id131" class="indexterm"/> to remove the trailing whitespace from the right-hand end of line. This is slightly better because it's something we'll do often in a number of contexts. Attempting to suppress the output of the extra <code class="literal">\n</code> character in the <code class="literal">print()</code> function is too specialized to this one situation.</p><p>In some cases, we may have files where we need to filter the lines, looking for particular patterns. We might have a loop that includes conditional processing via the <code class="literal">if</code> statement, as shown in the following code:</p><div><pre class="programlisting">with open("message1.txt", "r") as source:
    for line in source:
        junk1, keyword, size= line.rstrip().partition("Size")
        if keyword != '':
            print( size )</pre></div><p>This shows a typical structure for text processing programs. First, we open the file via a <code class="literal">with</code> statement context; this assures us that the file will be closed properly no matter what happens.</p><p>We use the <code class="literal">for</code> statement to iterate through all lines of the file. Each line has a two-step process: the <code class="literal">rstrip()</code> method<a id="id132" class="indexterm"/> removes trailing whitespace, the<a id="id133" class="indexterm"/> <code class="literal">partition()</code> method breaks the line around the keyword <code class="literal">Size</code>.</p><p>The <code class="literal">if</code> statement defines a condition (<code class="literal">keyword != ''</code>) and some processing that's done only if the condition is <code class="literal">True</code>. If the condition is <code class="literal">False</code> (the value of <code class="literal">keyword</code> is <code class="literal">''</code>), the indented body of the <code class="literal">if</code> statement is silently skipped.</p><p>The assignment and <code class="literal">if</code> statements form the body of the <code class="literal">for</code> statement. These two statements are executed once for every line in the file. When we get to the end of the <code class="literal">for</code> statement, we can be assured that all lines were processed.</p><p>We have to note that we can create an exception to the usual <em>for all lines</em> assumption about processing files with the <code class="literal">for</code> statement. We can use the <code class="literal">break</code> statement to exit early from the loop, breaking the usual assumption. We'd prefer to avoid the <code class="literal">break</code> statement, making it easy to see that a <code class="literal">for</code> statement works for all lines of a file.</p><p>At the end of the <code class="literal">for</code> statement, we're done processing the file. We're done with the <code class="literal">with</code> context, too. The file<a id="id134" class="indexterm"/> will be closed.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec24"/>Defining more complex logical conditions</h2></div></div></div><p>What if we have more patterns<a id="id135" class="indexterm"/> than what we're looking for? What if we're processing more complex data?</p><p>Let's say we've got something like this in a file:</p><div><pre class="programlisting">Message to Field Agent 006 1/2 
Proceed to Rendezvous FM16uu62
Authorization to Pay $250 USD</pre></div><p>We're looking for two keywords: <code class="literal">Rendezvous</code> and <code class="literal">Pay</code>. Python gives us the <code class="literal">elif</code> clause as part of the <code class="literal">if</code> statement. This clause provides a tidy way to handle multiple conditions gracefully. Here's a script to parse a message to us from the headquarters:</p><div><pre class="programlisting">amount= None
location= None
with open("message2.txt", "r") as source:
    for line in source:
        clean= line.lower().rstrip()
        junk, pay, pay_data= clean.partition("pay")
        junk, meet, meet_data= clean.partition("rendezvous")
        if pay != '':
            amount= pay_data
        elif meet != '':
            location= meet_data
        else:
            pass # ignore this line 
print("Budget", amount, "Meet", location)</pre></div><p>We're searching the contents in the file for two pieces of information: the rendezvous location and the amount we can use to bribe our contact. In effect, we're going to summarize this file down to two short facts, discarding the parts we don't care about.</p><p>As with the previous examples, we're using a <code class="literal">with</code> statement to create a processing context. We're also using the <code class="literal">for</code> statement to iterate through all lines of the file.</p><p>We've used a two-step process to clean each line. First, we used the <code class="literal">lower()</code> method to create a string in lowercase. Then we used the <code class="literal">rstrip()</code> method to remove any trailing whitespace from the line.</p><p>We applied the <code class="literal">partition()</code> method to the cleaned line twice. One partition looked for <code class="literal">pay</code> and the other partition looked for <code class="literal">rendezvous</code>. If the line could be partitioned on <code class="literal">pay</code>, the <code class="literal">pay</code> variable (and <code class="literal">pay_data</code>) would have values not equal to a zero-length string. If the line could be partitioned on <code class="literal">rendezvous</code>, then the <code class="literal">meet</code> variable (and <code class="literal">meet_data</code>) would have values not equal to a zero-length string. The <code class="literal">else, if</code> is abbreviated <code class="literal">elif</code> in Python.</p><p>If none of the previous conditions are true, we don't need to do anything. We don't need an <code class="literal">else:</code> clause. But we decided to include the <code class="literal">else:</code> clause in case we later needed to add some processing. For <a id="id136" class="indexterm"/>now, there's nothing more to do. In Python, the <code class="literal">pass</code> statement does nothing. It's a syntactic placeholder; a thing to write when we must write something.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec15"/>Solving problems – recovering a lost password</h1></div></div></div><p>We'll apply many of our techniques to writing a program to help us poke around inside a locked ZIP file. It's important to note that any competent encryption scheme doesn't encrypt a password. Passwords are, at worst, reduced to a hash value. When someone enters a password, the hash values are compared. The original password remains essentially unrecoverable except by guessing.</p><p>We'll look at a kind of <a id="id137" class="indexterm"/>brute-force password recovery scheme. It will simply try all of the words in a dictionary. More elaborate guessing schemes will use dictionary words and punctuation to form longer and longer candidate passwords. Even more elaborate guessing will include <em>leet speak</em> replacements of characters. For example, using <code class="literal">1337 sp3@k</code> instead of <code class="literal">leet speak</code>.</p><p>Before we look into how ZIP files work, we'll have to find a usable word corpus. A common stand-in for a corpus is a spell-check dictionary. For GNU/Linux or Mac OS X computers, there are several places a dictionary can be found. Three common places are: <code class="literal">/usr/dict/words</code>, <code class="literal">/usr/share/dict/words</code>, or possibly <code class="literal">/usr/share/myspell/dicts</code>.</p><p>Windows agents may have to search around a bit for similar dictionary resources. Look in <code class="literal">%AppData%\Microsoft\Spelling\EN</code> as a possible location. The dictionaries are often a <code class="literal">.dic</code> file. There may also be an associated .<code class="literal">aff</code> (affix rules) file, with additional rules for building words from the stem words (or lemmas) in the <code class="literal">.dic</code> file.</p><p>If we can't track down a usable word corpus, it may be best to install a standalone spell checking program, along with its dictionaries. Programs such as aspell, ispell, Hunspell, Open Office, and LibreOffice contain extensive collections of spelling dictionaries for a variety of languages.</p><p>There are other ways to get various word corpora. One way is to search all of the text files for all of the words in all of those files. The words we used to create a password may be reflected in words we actually use in other files.</p><p>Another good approach is to use the Python <strong>Natural Language Toolkit</strong> (<strong>NLTK</strong>), <a id="id138" class="indexterm"/>which has a number of resources for handling natural language processing. As this manual was going to press, a version has been released which works with Python3. See <a class="ulink" href="https://pypi.python.org/pypi/nltk">https://pypi.python.org/pypi/nltk</a>. This library provides lexicons, several wordlist corpora, and word stemming tools that are far better than simplistic spell-checking dictionaries.</p><p>Your mission is to locate a dictionary on your computer. If you can't find one, then download a good <a id="id139" class="indexterm"/>spell-check program and use its dictionary. A web search for <code class="literal">web2 (Webster's Second International)</code> may turn up a usable corpus.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec25"/>Reading a word corpus</h2></div></div></div><p>The first thing we<a id="id140" class="indexterm"/> need to do is read our spell-check corpus. We'll call it a corpus—a body of words—not a dictionary. The examples will <a id="id141" class="indexterm"/>be based on <strong>web2 (Webster's Second International) all 234,936 words worth</strong>. This is generally <a id="id142" class="indexterm"/>available in BSD Unix and Mac OS X.</p><p>Here's a typical script that will examine a corpus:</p><div><pre class="programlisting">count= 0
corpus_file = "/usr/share/dict/words" 
with open( corpus_file ) as corpus:
    for line in corpus:
        word= line.strip()
        if len(word) == 10:
            print(word)
            count += 1
print( count )</pre></div><p>We've opened the corpus file and read all of the lines. The word was located by stripping whitespace from the line; this removes the trailing <code class="literal">\n</code> character. An <code class="literal">if</code> statement was used to filter the 10-letter words. There are 30,878 of those, from abalienate to Zyzzogeton.</p><p>This little script isn't really part of any larger application. It's a kind of technology spike—something we're using to nail down a detail. When writing little scripts like this, we'll often skip careful design of classes or functions and just slap some Python statements into a file.</p><p>In POSIX-compliant OSes, we can do two more things to make a script easy to work with. First, we can add a special comment on the very first line of the file to help the OS figure out what to do with it. The line looks like this:</p><div><pre class="programlisting">#!/usr/bin/env python3</pre></div><p>This tells the OS how to handle the script. Specifically, it tells the OS to use the <code class="literal">env</code> program. The <code class="literal">env</code> program will then locate our installation of Python 3. Responsibility will be handed off to the <code class="literal">python3</code> program.</p><p>The second step is to mark the script as executable. We use the OS command, <code class="literal">chmod +x some_file.py</code>, to mark a Python file as an executable script.</p><p>If we've done these two steps, we can execute a script by simply typing its name at the command prompt.</p><p>In Windows, the file extension (<code class="literal">.py</code>) is associated with the Python program. There is an <strong>Advanced Settings</strong> panel that defines these file associations. When you installed Python, the association was built<a id="id143" class="indexterm"/> by the installer. This means that you can enter the name of a Python script and Windows will search through the<a id="id144" class="indexterm"/> directories named in your <code class="literal">PATH</code> value and execute that script properly.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec26"/>Reading a ZIP archive</h2></div></div></div><p>We'll use Python's <code class="literal">zipfile</code> module to work with a ZIP archive. This means we'll need to use <code class="literal">import zipfile</code> before we can do anything else. Since a ZIP archive contains multiple files, we'll often<a id="id145" class="indexterm"/> want to get a listing of the available files in the archive. Here's how we can survey an archive:</p><div><pre class="programlisting">import zipfile
with zipfile.ZipFile( "demo.zip", "r" ) as archive:
    archive.printdir()</pre></div><p>We've opened the archive, creating a file processing context. We then used the archive's <code class="literal">printdir()</code> method to<a id="id146" class="indexterm"/> dump the members of the archive.</p><p>We can't, however, extract any of the files because the ZIP archive was encrypted and we lost the password. Here's a script that will try to read the first member:</p><div><pre class="programlisting">import zipfile
with zipfile.ZipFile( "demo.zip", "r" ) as archive:
    archive.printdir()
    first = archive.infolist()[0]
    with archive.open(first) as member:
        text= member.read()
        print( text )</pre></div><p>We've created a file processing context using the open archive. We used the <code class="literal">infolist()</code> method to get information on each member. The <code class="literal">archive.infolist()[0]</code> statement will pick item zero from the list, that is, the first item.</p><p>We tried to create a file processing context for this specific member. Instead of seeing the content of the<a id="id147" class="indexterm"/>  member, we get an exception. The details will vary, but your exception message will look like this:</p><div><pre class="programlisting">RuntimeError: File &lt;zipfile.ZipInfo object at 0x1007e78e8&gt; is encrypted, password required for extraction</pre></div><p>The hexadecimal number (<code class="literal">0x1007e78e8</code>) may not match your output, but you'll still get an error trying to read <a id="id148" class="indexterm"/>an encrypted ZIP file.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec27"/>Using brute-force search</h2></div></div></div><p>To recover the files, we'll need to<a id="id149" class="indexterm"/> resort to brute-force search for a workable password. This means inserting our corpora reading loop into our <a id="id150" class="indexterm"/>archive processing context. It's a bit of flashy copy-and-paste that leads to a script like the following:</p><div><pre class="programlisting">import zipfile
import zlib
corpus_file = "/usr/share/dict/words"

with zipfile.ZipFile( "demo.zip", "r" ) as archive:
    first = archive.infolist()[0]
    print( "Reading", first.filename )
    with open( corpus_file ) as corpus:
        for line in corpus:
            word= line.strip().encode("ASCII")
            try:
                with archive.open(first, 'r', pwd=word) as member:
                    text= member.read()
                print( "Password", word )
                print( text )
                break
            except (RuntimeError, zlib.error, zipfile.BadZipFile):
                pass</pre></div><p>We've imported two libraries: <code class="literal">zipfile</code> as well as <code class="literal">zlib</code>. We added <code class="literal">zlib</code> because it turns out that we'll sometimes see <code class="literal">zlib.error</code> exceptions when guessing passwords. We created a context for our open archive file. We used the <code class="literal">infolist()</code> method<a id="id151" class="indexterm"/> to get names of members and fetched just the first file from that list. If we can read one file, we can read them all.</p><p>Then we opened our corpus file, and created a file processing context for that file. For each line in the corpora, we used two methods of the line: the <code class="literal">strip()</code> method<a id="id152" class="indexterm"/> will remove the trailing <code class="literal">"\n"</code>, and the <code class="literal">encode("ASCII")</code> method<a id="id153" class="indexterm"/> will transform the line from Unicode characters to ASCII bytes. We need this because ZIP library passwords are ASCII bytes, not proper Unicode character strings.</p><p>The <code class="literal">try:</code> block attempts to open and read the first member. We created a file processing context for this member within the archive. We tried to read the member. If anything goes wrong while we are trying to read the encrypted member, an exception will be raised. The usual culprit, of course, is attempting to read the member with the wrong password.</p><p>If everything works well, then we guessed the correct password. We can print the recovered password, as well as the text of the member as a confirmation.</p><p>Note that we've used a <code class="literal">break</code> statement to end the corpora processing <code class="literal">for</code> loop. This changes the <code class="literal">for</code> loop's semantics from <code class="literal">for all words</code> to <code class="literal">there exists a word</code>. The <code class="literal">break</code> statement means the loop ends as soon as a valid password is found. No further words in the corpus<a id="id154" class="indexterm"/> need to be processed.</p><p>We've listed three<a id="id155" class="indexterm"/> kinds of exceptions that might be raised from attempting to use a bad password. It's not obvious why different kinds of exceptions may be raised by wrong passwords. But it's easy to run some experiments to confirm that a variety of different exceptions really are raised by a common underlying problem.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch01lvl1sec16"/>Summary</h1></div></div></div><p>In this chapter, we saw the basics of our espionage toolkit: Python and our text editor of choice. We've worked with Python to manipulate numbers, strings, and files. We saw a number of Python statements: assignment, <code class="literal">while</code>, <code class="literal">for</code>, <code class="literal">if</code>, <code class="literal">elif</code>, <code class="literal">break</code>, and <code class="literal">def</code>. We saw how an expression (such as <code class="literal">print("hello world")</code>) can be used as a Python statement.</p><p>We also looked at the Python API for processing a ZIP file. We saw how Python works with popular file-archive formats. We even saw how to use a simple corpus of words to recover a simple password.</p><p>Now that we have the basics, we're ready for more advanced missions. The next thing we've got to do is start using the World Wide Web (WWW) to gather information and carry it back to our computer.</p></div></body></html>