<html><head></head><body>
  <div><div><div><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Working with Images</h1></div></div></div><div><blockquote class="blockquote"><p>In this chapter, we will learn basic image conversion and manipulation techniques using the Python Imaging Library. The chapter ends with an exciting project where we create an image processing application.</p></blockquote></div><p>In this chapter, we shall:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Learn various image I/O operations for reading and writing images using the<strong> Python Imaging Library</strong> (PIL)</li><li class="listitem" style="list-style-type: disc">With the help of several examples and code snippets, perform some basic manipulations on the image, such as resizing, rotating/ flipping, cropping, pasting, and so on.</li><li class="listitem" style="list-style-type: disc">Write an image-processing application by making use of PIL</li></ul></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Use the QT library as a frontend (GUI) for this application</li></ul></div><p>So let's get on with it!</p><div><div><div><div><h1 class="title"><a id="ch02lvl1sec01"/>Installation prerequisites</h1></div></div></div><p>Before we jump in to the main chapter, it is necessary to install the following packages.</p><div><div><div><div><h2 class="title"><a id="ch02lvl2sec01"/>Python</h2></div></div></div><p>In this book we will use Python Version 2.6, or to be more specific, Version 2.6.4. It can be downloaded from the following location:<a class="ulink" href="http://python.org/download/releases/"> http://python.org/download/releases/</a>
<a id="id37" class="indexterm"/>
</p><p><a id="id38" class="indexterm"/>
</p><div><div><div><div><h3 class="title"><a id="ch02lvl3sec01"/>Windows platform</h3></div></div></div><p>For Windows, just download and install the platform-specific binary distribution of Python 2.6.4.<a id="id39" class="indexterm"/>
</p></div><div><div><div><div><h3 class="title"><a id="ch02lvl3sec02"/>Other platforms</h3></div></div></div><p>For other platforms, such as Linux, Python is probably already installed on your machine. If the installed version is not 2.6, build and install it from the source distribution. If you are using a package manager on a Linux system, search for Python 2.6. It is likely that you will find the Python distribution there. Then, for instance, Ubuntu users can install Python from the command prompt as:<a id="id40" class="indexterm"/>
</p><div><pre class="programlisting">$sudo apt-get python2.6
</pre></div><p>Note that for this, you must have administrative permission on the machine on which you are installing Python.</p></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec02"/>Python Imaging Library (PIL)</h2></div></div></div><p>We will learn image-processing techniques by making extensive use of the Python Imaging Library (PIL) throughout this chapter. As mentioned in<a class="link" href="ch01.html" title="Chapter 1. Python and Multimedia"> Chapter 1</a>, PIL is an open source library. You can download it from<a class="ulink" href="http://www.pythonware.com/products/pil/"> http://www.pythonware.com/products/pil/</a>. Install the PIL Version 1.1.6 or later.<a id="id41" class="indexterm"/>
</p><div><div><div><div><h3 class="title"><a id="ch02lvl3sec03"/>Windows platform</h3></div></div></div><p>For Windows users, installation is straightforward use the binary distribution PIL 1.1.6 for Python 2.6.<a id="id42" class="indexterm"/>
</p></div><div><div><div><div><h3 class="title"><a id="ch02lvl3sec04"/>Other platforms</h3></div></div></div><p>For other platforms, install PIL 1.1.6 from the source. Carefully review the README file in the source distribution for the platform-specific instructions. Libraries listed in the following table are required to be installed before installing PIL from the source. For some platforms like Linux, the libraries provided in the OS should work fine. However, if those do not work, install a pre-built "libraryName-devel" version of the library. For example, for JPEG support, the name will contain "jpeg-devel-", and something similar for the others. This is generally applicable to rpm-based distributions. For Linux flavors like Ubuntu, you can use the following command in a shell window.<a id="id43" class="indexterm"/>
</p><div><pre class="programlisting">$sudo apt-get install python-imaging.
</pre></div><p>However, you should make sure that this installs Version 1.1.6 or later. Check PIL documentation for further platform-specific instructions. For Mac OSX, see if you can use<code class="literal"> fink</code> to install these libraries. See<a class="ulink" href="http://www.finkproject.org/"> http://www.finkproject.org/</a> for more details. You can also check the website<a class="ulink" href="http://pythonmac.org"> http://pythonmac.org</a> or Darwin ports website<a class="ulink" href="http://darwinports.com/"> http://darwinports.com/</a> to see if a binary package installer is available. If such a pre-built version is not available for any library, install it from the source.</p><p>The PIL prerequisites for installing PIL from source are listed in the following table:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Library</p>
</th><th style="text-align: left" valign="bottom">
<p>URL</p>
</th><th style="text-align: left" valign="bottom">
<p>Version</p>
</th><th style="text-align: left" valign="bottom">
<p>Installation options</p>
<p>(a) or (b)</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">libjpeg</code>
</p>
<p>(JPEG support)</p>
</td><td style="text-align: left" valign="top">
<p>
<a class="ulink" href="http://www.ijg.org/files">http://www.ijg.org/files</a>
</p>
</td><td style="text-align: left" valign="top">
<p>7 or 6a or 6b</p>
</td><td style="text-align: left" valign="top">
<p>(a) Pre-built version. For example:</p>
<p>
<code class="literal">jpeg-devel-7</code>
</p>
<p>Check if you can do:</p>
<p>
<code class="literal">sudo apt-install libjpeg</code> (works on some flavors of Linux)</p>
<p>(b) Source tarball. For example:<code class="literal"> jpegsrc.v7.tar.gz</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">zib</code>
</p>
<p>(PNG support)</p>
</td><td style="text-align: left" valign="top">
<p>
<a class="ulink" href="http://www.gzip.org/zlib/">http://www.gzip.org/zlib/</a>
</p>
</td><td style="text-align: left" valign="top">
<p>1.2.3 or later</p>
</td><td style="text-align: left" valign="top">
<p>(a) Pre-built version. For example:</p>
<p>
<code class="literal">zlib-devel-1.2.3.</code>.</p>
<p>(b) Install from the source.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">freetype2</code>
</p>
<p>(OpenType /TrueType support)</p>
</td><td style="text-align: left" valign="top">
<p>
<a class="ulink" href="http://www.freetype.org">http://www.freetype.org</a>
</p>
</td><td style="text-align: left" valign="top">
<p>2.1.3 or later</p>
</td><td style="text-align: left" valign="top">
<p>(a) Pre-built version. For example:</p>
<p>
<code class="literal">freetype2-devel-2.1.3.</code>.</p>
<p>(b) Install from the source.</p>
</td></tr></tbody></table></div></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec03"/>PyQt4</h2></div></div></div><p>This package provides Python bindings for Qt libraries. We will use PyQt4 to generate GUI for the image-processing application that we will develop later in this chapter. The GPL version is available at:<a class="ulink" href="http://www.riverbankcomputing.co.uk/software/pyqt/download"> http://www.riverbankcomputing.co.uk/software/pyqt/download</a>.<a id="id44" class="indexterm"/>
</p><div><div><div><div><h3 class="title"><a id="ch02lvl3sec05"/>Windows platform</h3></div></div></div><p>Download and install the binary distribution pertaining to Python 2.6. For example, the executable file's name could be 'PyQt-Py2.6-gpl-4.6.2-2.exe'. Other than Python, it includes everything needed for GUI development using PyQt.<a id="id45" class="indexterm"/>
</p></div><div><div><div><div><h3 class="title"><a id="ch02lvl3sec06"/>Other platforms</h3></div></div></div><p>Before building PyQt, you must install SIP Python binding generator. For further details, refer to the SIP homepage:<a class="ulink" href="http://www.riverbankcomputing.com/software/sip/"> http://www.riverbankcomputing.com/software/sip/</a>.<a id="id46" class="indexterm"/>
</p><p>After installing SIP, download and install PyQt 4.6.2 or later, from the source tarball. For Linux/Unix source, the filename will start with<code class="literal"> PyQt-x11-gpl-.</code>. and for Mac OS X,<code class="literal"> PyQt-mac-gpl-..</code>. Linux users should also check if PyQt4 distribution is already available through the package manager.</p></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec04"/>Summary of installation prerequisites</h2></div></div></div><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Package</p>
</th><th style="text-align: left" valign="bottom">
<p>Download location</p>
</th><th style="text-align: left" valign="bottom">
<p>Version</p>
</th><th style="text-align: left" valign="bottom">
<p>Windows platform</p>
</th><th style="text-align: left" valign="bottom">
<p>Linux/Unix/OS X platforms</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Python</p>
</td><td style="text-align: left" valign="top">
<p>
<a class="ulink" href="http://python.org/download/releases/">http://python.org/download/releases/</a>
</p>
</td><td style="text-align: left" valign="top">
<p>2.6.4 (or any 2.6.x)</p>
</td><td style="text-align: left" valign="top">
<p>Install using binary distribution</p>
</td><td style="text-align: left" valign="top">
<p>(a) Install from binary; Also install additional developer packages (For example, with<code class="literal"> python-devel</code> in the package name in the rpm systems) OR</p>
<p>(b) Build and install from the source tarball.</p>
<p>(c) MAC users can also check websites such as<a class="ulink" href="http://darwinports.com/"> http://darwinports.com/</a> or<a class="ulink" href="http://pythonmac.org/"> http://pythonmac.org/</a>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>PIL</p>
</td><td style="text-align: left" valign="top">
<p>
<a class="ulink" href="http://www.pythonware.com/products/pil/">www.pythonware.com/products/pil/</a>
</p>
</td><td style="text-align: left" valign="top">
<p>1.1.6 or later</p>
</td><td style="text-align: left" valign="top">
<p>Install PIL 1.1.6 (binary) for Python 2.6</p>
</td><td style="text-align: left" valign="top">
<p>(a) Install prerequisites if needed. Refer to Table #1 and the README file in PIL source distribution.</p>
<p>(b) Install PIL from source.</p>
<p>(c) MAC users can also check websites like<a class="ulink" href="http://darwinports.com/"> http://darwinports.com/</a> or<a class="ulink" href="http://pythonmac.org/"> http://pythonmac.org/</a>.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>PyQt4</p>
</td><td style="text-align: left" valign="top">
<p>
<a class="ulink" href="http://www.riverbankcomputing.co.uk/software/pyqt/download">http://www.riverbankcomputing.co.uk/software/pyqt/download</a>
</p>
</td><td style="text-align: left" valign="top">
<p>4.6.2 or later</p>
</td><td style="text-align: left" valign="top">
<p>Install using binary pertaining to Python 2.6</p>
</td><td style="text-align: left" valign="top">
<p>(a) First install SIP 4.9 or later.</p>
<p>(b) Then install PyQt4.</p>
</td></tr></tbody></table></div></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec02"/>Reading and writing images</h1></div></div></div><p>To manipulate an existing image, we must open it first for editing and we also require the ability to save the image in a suitable file format after making changes. The<code class="literal"> Image</code> module in PIL provides methods to read and write images in the specified image file format. It supports a wide range of file formats.</p><p>To open an image, use<code class="literal"> Image.open</code> method. Start the Python interpreter and write the following code. You should specify an appropriate path on your system as an argument to the<code class="literal"> Image.open</code> method.</p><div><pre class="programlisting">&gt;&gt;&gt;import Image
&gt;&gt;&gt;inputImage = Image.open("C:\\PythonTest\\image1.jpg")
</pre></div><p>This will open an image file by the name<code class="literal"> image1.jpg</code>. If the file can't be opened, an<code class="literal"> IOError</code> will be raised, otherwise, it returns an instance of class<code class="literal"> Image</code>.</p><p>For saving image, use the<code class="literal"> save</code> method of the<code class="literal"> Image</code> class. Make sure you replace the following string with an appropriate<code class="literal"> /path/to/your/image/file</code>.</p><div><pre class="programlisting">&gt;&gt;&gt;inputImage.save("C:\\PythonTest\\outputImage.jpg")
</pre></div><p>You can view the image just saved, using the<code class="literal"> show</code> method of<code class="literal"> Image</code> class.</p><div><pre class="programlisting">&gt;&gt;&gt;outputImage = Image.open("C:\\PythonTest\\outputImage.jpg")
&gt;&gt;&gt;outputImage.show()
</pre></div><p>Here, it is essentially the same image as the input image, because we did not make any changes to the output image.</p></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec03"/>Time for action -  image file converter</h1></div></div></div><p>With this basic information, let's build a simple image file converter. This utility will batch-process image files and save them in a user-specified file format.</p><p>To get started, download the file<code class="literal"> ImageFileConverter.py</code> from the Packt website,<a class="ulink" href="http://www.packtpub.com"> www.packtpub.com</a>. This file can be run from the command line as:</p><div><pre class="programlisting">python ImageConverter.py [arguments]
</pre></div><p>Here,<code class="literal"> [arguments]</code> are:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">--input_dir:</code> The directory path where the image files are located.</li><li class="listitem" style="list-style-type: disc"><code class="literal">--input_format:</code> The format of the image files to be converted. For example,<code class="literal"> jpg</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">--output_dir:</code> The location where you want to save the converted images.</li></ul></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">--output_format:</code> The output image format. For example,<code class="literal"> jpg, png, bmp</code>, and so on.</li></ul></div><p>The following screenshot shows the image conversion utility in action on Windows XP, that is, running image converter from the command line.</p><p>Here, it will batch-process all the<code class="literal"> .jpg</code> images within<code class="literal"> C:\PythonTest\images</code> and save them in<code class="literal"> png</code> format in the directory<code class="literal"> C:\PythonTest\images\OUTPUT_IMAGES</code>.</p><div><img src="img/0165_2_1.jpg" alt="Time for action - image file converter"/></div><p>The file defines<code class="literal"> class ImageConverter</code> . We will discuss the most important methods in this class.</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">def processArgs:</code> This method processes all the command-line arguments listed earlier. It makes use of Python's built-in module<code class="literal"> getopts</code> to process these arguments. Readers are advised to review the code in the file<code class="literal"> ImageConverter.py</code> in the code bundle of this book for further details on how these arguments are processed.</li><li class="listitem" style="list-style-type: disc"><code class="literal">def convertImage:</code> This is the workhorse method of the image-conversion utility.<div><pre class="programlisting">1 def convertImage(self):
2 pattern = "*." + self.inputFormat
3 filetype = os.path.join(self.inputDir, pattern)
4 fileList = glob.glob(filetype)
5 inputFileList = filter(imageFileExists, fileList)
6
7 if not len(inputFileList):
8 print "\n No image files with extension %s located \
9 in dir %s"%(self.outputFormat, self.inputDir)
10 return
11 else:
12 # Record time before beginning image conversion
13 starttime = time.clock()
14 print "\n Converting images.."
15
16 # Save image into specified file format.
17 for imagePath in inputFileList:
18 inputImage = Image.open(imagePath)
19 dir, fil = os.path.split(imagePath)
20 fil, ext = os.path.splitext(fil)
21 outPath = os.path.join(self.outputDir,
22 fil + "." + self.outputFormat)
23 inputImage.save(outPath)
24
25 endtime = time.clock()
26 print "\n Done!"
27 print "\n %d image(s) written to directory:\
28 %s" %(len(inputFileList), self.outputDir)
29 print "\n Approximate time required for conversion: \
30 %.4f seconds" % (endtime starttime)
</pre></div></li></ul></div><p>Now let's review the preceding code.<a id="id47" class="indexterm"/>
</p><div><ol class="orderedlist arabic"><li class="listitem">Our first task is to get a list of all the image files to be saved in a different format. This is achieved by using<code class="literal"> glob</code> module in Python. Line 4 in the code snippet finds all the file path names that match the pattern specified by the local variable<code class="literal"> fileType</code>. On line 5, we check whether the image file in<code class="literal"> fileList</code> exists. This operation can be efficiently performed over the whole list using the built-in<code class="literal"> filter</code> functionality in Python.</li><li class="listitem">The code block between lines 7 to 14 ensures that one or more images exist. If so, it will record the time before beginning the image conversion.<a id="id48" class="indexterm"/></li><li class="listitem">The next code block (lines 17-23) carries out the image file conversion. On line 18, we use<code class="literal"> Image.open</code> to open the image file. Line 18 creates an<code class="literal"> Image</code> object. Then the appropriate output path is derived and finally the output image is saved using the<code class="literal"> save</code> method of the<code class="literal"> Image</code> module.</li></ol></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec05"/>What just happened?</h2></div></div></div><p>In this simple example, we learned how to open and save image files in a specified image format. We accomplished this by writing an image file converter that batch-processes a specified image file. We used PIL's<code class="literal"> Image.open</code> and<code class="literal"> Image.save</code> functionality along with Python's built-in modules such as<code class="literal"> glob</code> and<code class="literal"> filter</code>.</p><p>Now we will discuss other key aspects related to the image reading and writing.</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec06"/>Creating an image from scratch</h2></div></div></div><p>So far we have seen how to open an existing image. What if we want to create our own image? As an example, it you want to create fancy text as an image, the functionality that we are going to discuss now comes in handy. Later in this book, we will learn how to use such an image containing some text to embed into another image. The basic syntax for creating a new image is:<a id="id49" class="indexterm"/>
</p><div><pre class="programlisting">foo = Image.new(mode, size, color)
</pre></div><p>Where,<code class="literal"> new</code> is the built-in method of class<code class="literal"> Image. Image.new</code> takes three arguments, namely,<code class="literal"> mode, size</code>, and<code class="literal"> color</code>. The<code class="literal"> mode</code> argument is a string that gives information about the number and names of image bands. Following are the most common values for mode argument:<code class="literal"> L</code> (gray scale) and<code class="literal"> RGB</code> (true color). The<code class="literal"> size</code> is a<code class="literal"> tuple</code> specifying dimensions of the image in pixels, whereas,<code class="literal"> color</code> is an optional argument. It can be assigned an RGB value (a<code class="literal"> 3-tuple)</code> if it's a multi-band image. If it is not specified, the image is filled with black color.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec04"/>Time for action -  creating a new image containing some text</h1></div></div></div><p>As already stated, it is often useful to generate an image containing only some text or a common shape. Such an image can then be pasted onto another image at a desired angle and location. We will now create an image with text that reads, "Not really a fancy text!"<a id="id50" class="indexterm"/>
</p><div><ol class="orderedlist arabic"><li class="listitem">Write the following code in a Python source file:<div><pre class="programlisting">1 import Image
2 import ImageDraw
3 txt = "Not really a fancy text!"
4 size = (150, 50)
5 color = (0, 100, 0)
6 img = Image.new('RGB', size, color)
7 imgDrawer = ImageDraw.Draw(img)
8 imgDrawer.text((5, 20), txt) 9 img.show()
</pre></div></li><li class="listitem">Let's analyze the code line by line. The first two lines import the necessary modules from PIL. The variable<code class="literal"> txt</code> is the text we want to include in the image. On line 7, the new image is created using<code class="literal"> Image.new</code>. Here we specify the<code class="literal"> mode</code> and<code class="literal"> size</code> arguments. The optional<code class="literal"> color</code> argument is specified as a<code class="literal"> tuple</code> with RGB values pertaining to the "dark green" color.<a id="id51" class="indexterm"/></li><li class="listitem">The<code class="literal"> ImageDraw</code> module in PIL provides graphics support for an<code class="literal"> Image</code> object. The function<code class="literal"> ImageDraw.Draw</code> takes an image object as an argument to create a<code class="literal"> Draw</code> instance. In output code, it is called<code class="literal"> imgDrawer</code>, as used on line 7. This<code class="literal"> Draw</code> instance enables drawing various things in the given image.</li><li class="listitem">On line 8, we call the text method of the Draw instance and supply position (a<code class="literal"> tuple)</code> and the text (stored in the string<code class="literal"> txt)</code> as arguments.</li><li class="listitem">Finally, the image can be viewed using<code class="literal"> img.show()</code> call. You can optionally save the image using<code class="literal"> Image.save</code> method. The following screenshot shows the resultant image.<div><img src="img/0165_2_2.jpg" alt="Time for action - creating a new image containing some text"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec07"/>What just happened?</h2></div></div></div><p>We just learned how to create an image from scratch. An empty image was created using the<code class="literal"> Image.new</code> method. Then, we used the<code class="literal"> ImageDraw</code> module in PIL to add text to this image.</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec08"/>Reading images from archive</h2></div></div></div><p>If the image is part of an archived container, for example, a TAR archive, we can use the<code class="literal"> TarIO</code> module in PIL to open it and then call<code class="literal"> Image.open</code> to pass this<code class="literal"> TarIO</code> instance as an argument.<a id="id52" class="indexterm"/>
</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec05"/>Time for action -  reading images from archives</h1></div></div></div><p>Suppose there is an archive file<code class="literal"> images.tar</code> containing image file<code class="literal"> image1.jpg</code>. The following code snippet shows how to read<code class="literal"> image1.jpg</code> from the tarball.<a id="id53" class="indexterm"/>
</p><div><pre class="programlisting">&gt;&gt;&gt;import TarIO
&gt;&gt;&gt;import Images
&gt;&gt;&gt;fil = TarIO.TarIO("images.tar", "images/image1.jpg")
&gt;&gt;&gt;img = Image.open(fil)
&gt;&gt;&gt;img.show()
</pre></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec09"/>What just happened?</h2></div></div></div><p>We learned how to read an image located in an archived container.</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec10"/>Have a go hero add new features to the image file converter</h2></div></div></div><p>Modify the image conversion code so that it supports the following new functionality, which:<a id="id54" class="indexterm"/>
</p><div><ol class="orderedlist arabic"><li class="listitem">Takes a ZIP file containing images as input</li><li class="listitem">Creates a TAR archive of the converted images</li></ol></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec06"/>Basic image manipulations</h1></div></div></div><p>Now that we know how to open and save images, let's learn some basic techniques to manipulate images. PIL supports a variety of geometric manipulation operations, such as resizing an image, rotating it by an angle, flipping it top to bottom or left to right, and so on. It also facilitates operations such as cropping, cutting and pasting pieces of images, and so on.<a id="id55" class="indexterm"/>
</p><div><div><div><div><h2 class="title"><a id="ch02lvl2sec11"/>Resizing</h2></div></div></div><p>Changing the dimensions of an image is one of the most frequently used image manipulation operations. The image resizing is accomplished using<code class="literal"> Image.resize</code> in PIL. The following line of code explains how it is achieved.<a id="id56" class="indexterm"/>
</p><div><pre class="programlisting">foo = img.resize(size, filter)
</pre></div><p>Here,<code class="literal"> img</code> is an image (an instance of class<code class="literal"> Image)</code> and the result of resizing operation is stored in<code class="literal"> foo</code> (another instance of class<code class="literal"> Image)</code>. The<code class="literal"> size</code> argument is a<code class="literal"> tuple</code> (width,<code class="literal"> height)</code>. Note that the<code class="literal"> size</code> is specified in pixels. Thus, resizing the image means modifying the number of pixels in the image. This is also known as<strong> image re-sampling.</strong> The<code class="literal"> Image.resize</code> method also takes<code class="literal"> filter</code> as an optional argument. A<code class="literal"> filter</code> is an interpolation algorithm used while re-sampling the given image. It handles deletion or addition of pixels during re-sampling, when the resize operation is intended to make image smaller or larger in size respectively. There are four filters available. The resize filters in the increasing order of quality are<code class="literal"> NEAREST, BILINEAR, BICUBIC</code>, and<code class="literal"> ANTIALIAS</code>. The default filter option is<code class="literal"> NEAREST</code>.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec07"/>Time for action -  resizing</h1></div></div></div><p>Let's now resize images by modifying their pixel dimensions and applying various filters for re-sampling.<a id="id57" class="indexterm"/>
</p><div><ol class="orderedlist arabic"><li class="listitem">Download the file<code class="literal"> ImageResizeExample.bmp</code> from the Packt website. We will use this as the reference file to create scaled images. The original dimensions of<code class="literal"> ImageResizeExample.bmp</code> are<code class="literal"> 200 x 212</code> pixels.</li><li class="listitem">Write the following code in a file or in Python interpreter. Replace the<code class="literal"> inPath</code> and<code class="literal"> outPath</code> strings with the appropriate image path on your machine.<div><pre class="programlisting">1 import Image
2 inPath = "C:\\images\\ImageResizeExample.jpg"
3 img = Image.open(inPath)
4 width , height = (160, 160)
5 size = (width, height)
6 foo = img.resize(size)
7 foo.show()
8 outPath = "C:\\images\\foo.jpg"
9 foo.save(outPath)
</pre></div></li><li class="listitem">The image specified by the<code class="literal"> inPath</code> will be resized and saved as the image specified by the<code class="literal"> outPath</code>. Line 6 in the code snippet does the resizing job and finally we save the new image on line 9. You can see how the resized image looks by calling<code class="literal"> foo.show()</code>.</li><li class="listitem">Let's now specify the<code class="literal"> filter</code> argument. In the following code, on line 14, the<code class="literal"> filterOpt</code> argument is specified in the<code class="literal"> resize</code> method. The valid<code class="literal"> filter</code> options are specified as values in the dictionary<code class="literal"> filterDict</code>. The keys of<code class="literal"> filterDict</code> are used as the filenames of the output images. The four images thus obtained are compared in the next illustration. You can clearly notice the difference between the<code class="literal"> ANTIALIAS</code> image and the others (particularly, look at the flower petals in these images). When the processing time is not an issue, choose the<code class="literal"> ANTIALIAS</code> filter option as it gives the best quality image.<div><pre class="programlisting">1 import Image
2 inPath = "C:\\images\\ImageResizeExample.jpg"
3 img = Image.open(inPath)
4 width , height = (160, 160)
5 size = (width, height)
6 filterDict = {'NEAREST':Image.NEAREST,
7 'BILINEAR':Image.BILINEAR,
8 'BICUBIC':Image.BICUBIC,
9 'ANTIALIAS':Image.ANTIALIAS }
10
11 for k in filterDict.keys():
12 outPath= "C:\\images\\" + k + ".jpg"
13 filterOpt = filterDict[k]
14 foo = img.resize(size, filterOpt)
15 foo.save(outPath)
</pre></div></li><li class="listitem">The resized images with different filter options appear as follows. Clockwise from left, Image.NEAREST, Image.BILENEAR, Image.BICUBIC, and Image.ANTIALIAS:<a id="id58" class="indexterm"/><div><img src="img/0165_2_3.jpg" alt="Time for action - resizing"/></div><div><img src="img/0165_2_4.jpg" alt="Time for action - resizing"/></div><div><img src="img/0165_2_5.jpg" alt="Time for action - resizing"/></div><div><img src="img/0165_2_6.jpg" alt="Time for action - resizing"/></div></li><li class="listitem">The<code class="literal"> resize</code> functionality illustrated here, however, doesn't preserve the aspect ratio of the resulting image. The image will appear distorted if one dimension is stretched more or stretched less in comparison with the other dimension. PIL's<code class="literal"> Image</code> module provides another built-in method to fix this. It will override the larger of the two dimensions, such that the aspect ratio of the image is maintained.<a id="id59" class="indexterm"/><div><pre class="programlisting">import Image
inPath = "C:\\images\\ResizeImageExample.jpg"
img = Image.open(inPath)
width , height = (100, 50)
size = (width, height)
outPath = "C:\\images\\foo.jpg"
img.thumbnail(size, Image.ANTIALIAS)
img.save(outPath)
</pre></div></li><li class="listitem">This code will override the maximum pixel dimension value (width in this case) specified by the programmer and replace it with a value that maintains the aspect ratio of the image. In this case, we have an image with pixel dimensions (47, 50). The resultant images are compared in the following illustration.<a id="id60" class="indexterm"/><p>It shows the comparison of output images for methods Image.thumbnail and Image.resize.
</p><div><img src="img/0165_2_7.jpg" alt="Time for action - resizing"/></div><div><img src="img/0165_2_8.jpg" alt="Time for action - resizing"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec12"/>What just happened?</h2></div></div></div><p>We just learned how image resizing is done using PIL's<code class="literal"> Image</code> module, by writing a few lines of code. We also learned different types of filters used in image resizing (re-sampling). And finally, we also saw how to resize an image while still keeping the aspect ratio intact (that is, without distortion), using the<code class="literal"> Image.thumbnail</code> method.</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec13"/>Rotating</h2></div></div></div><p>Like image resizing, rotating an image about its center is another commonly performed transformation. For example, in a composite image, one may need to rotate the text by certain degrees before embedding it in another image. For such needs, there are methods such as<code class="literal"> rotate</code> and<code class="literal"> transpose</code> available in PIL's<code class="literal"> Image</code> module. The basic syntax to rotate an image using<code class="literal"> Image.rotate</code> is as follows:<a id="id61" class="indexterm"/>
</p><div><pre class="programlisting">foo = img.rotate(angle, filter)
</pre></div><p>Where, the<code class="literal"> angle</code> is provided in degrees and<code class="literal"> filter</code>, the optional argument, is the image-re-sampling filter. The valid<code class="literal"> filter</code> value can be<code class="literal"> NEAREST, BILINEAR</code>, or<code class="literal"> BICUBIC</code>. You can rotate the image using<code class="literal"> Image.transpose</code> only for 90-, 180-, and 270-degree rotation angles.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec08"/>Time for action -  rotating</h1></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Download the file<code class="literal"> Rotate.png</code> from the Packt website. Alternatively, you can use any supported image file of your choice.</li><li class="listitem">Write the following code in Python interpreter or in a Python file. As always, specify the appropriate path strings for<code class="literal"> inPath</code> and<code class="literal"> outPath</code> variables.<div><pre class="programlisting">1 import Image
2 inPath = "C:\\images\\Rotate.png"
3 img = Image.open(inPath)
4 deg = 45
5 filterOpt = Image.BICUBIC
6 outPath = "C:\\images\\Rotate_out.png"
7 foo = img.rotate(deg, filterOpt)
8 foo.save(outPath)
</pre></div></li><li class="listitem">Upon running this code, the output image, rotated by 45 degrees, is saved to the<code class="literal"> outPath</code>. The filter option<code class="literal"> Image.BICUBIC</code> ensures highest quality. The next illustration shows the original and the images rotated by 45 and 180 degrees respectively the original and rotated images.<div><img src="img/0165_2_9.jpg" alt="Time for action - rotating"/></div><div><img src="img/0165_2_10.jpg" alt="Time for action - rotating"/></div><div><img src="img/0165_2_11.jpg" alt="Time for action - rotating"/></div></li><li class="listitem">There is another way to accomplish rotation for certain angles by using the<code class="literal"> Image.transpose</code> functionality. The following code achieves a 270-degree rotation. Other valid options for rotation are<code class="literal"> Image.ROTATE_90</code> and<code class="literal"> Image.ROTATE_180</code>.<a id="id62" class="indexterm"/><div><pre class="programlisting">import Image
inPath = "C:\\images\\Rotate.png"
img = Image.open(inPath)
outPath = "C:\\images\\Rotate_out.png"
foo = img.transpose(Image.ROTATE_270)
foo.save(outPath)
</pre></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec14"/>What just happened?</h2></div></div></div><p>In the previous section, we used<code class="literal"> Image.rotate</code> to accomplish rotating an image by the desired angle. The image filter<code class="literal"> Image.BICUBIC</code> was used to obtain better quality output image after rotation. We also saw how<code class="literal"> Image.transpose</code> can be used for rotating the image by certain angles.<a id="id63" class="indexterm"/>
</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec15"/>Flipping</h2></div></div></div><p>There are multiple ways in PIL to flip an image horizontally or vertically. One way to achieve this is using the<code class="literal"> Image.transpose</code> method. Another option is to use the functionality from the<code class="literal"> ImageOps</code> module . This module makes the image-processing job even easier with some ready-made methods. However, note that the PIL documentation for Version 1.1.6 states that<code class="literal"> ImageOps</code> is still an experimental module.<a id="id64" class="indexterm"/>
</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec09"/>Time for action -  flipping</h1></div></div></div><p>Imagine that you are building a symmetric image using a bunch of basic shapes. To create such an image, an operation that can flip (or mirror) the image would come in handy. So let's see how image flipping can be accomplished.</p><div><ol class="orderedlist arabic"><li class="listitem">Write the following code in a Python source file.<div><pre class="programlisting">1 import Image
2 inPath = "C:\\images\\Flip.png"
3 img = Image.open(inPath)
4 outPath = "C:\\images\\Flip_out.png"
5 foo = img.transpose(Image.FLIP_LEFT_RIGHT)
6 foo.save(outPath)
</pre></div></li><li class="listitem">In this code, the image is flipped horizontally by calling the<code class="literal"> transpose</code> method. To flip the image vertically, replace line 5 in the code with the following:<a id="id65" class="indexterm"/><div><pre class="programlisting">foo = img.transpose(Image.FLIP_TOP_BOTTOM)
</pre></div></li><li class="listitem">The following illustration shows the output of the preceding code when the image is flipped horizontally and vertically.<a id="id66" class="indexterm"/><div><img src="img/0165_2_12.jpg" height="44" alt="Time for action - flipping"/></div><div><img src="img/0165_2_13.jpg" height="44" alt="Time for action - flipping"/></div><div><img src="img/0165_2_14.jpg" height="44" alt="Time for action - flipping"/></div></li><li class="listitem">The same effect can be achieved using the<code class="literal"> ImageOps</code> module. To flip the image horizontally, use<code class="literal"> ImageOps.mirror</code>, and to flip the image vertically, use<code class="literal"> ImageOps.flip</code>.<div><pre class="programlisting">import ImageOps
# Flip image horizontally
foo1 = ImageOps.mirror(img)
# Flip image vertically
foo2 = ImageOps.flip(img)
</pre></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec16"/>What just happened?</h2></div></div></div><p>With the help of example, we learned how to flip an image horizontally or vertically using<code class="literal"> Image.transpose</code> and also by using methods in class<code class="literal"> ImageOps</code>. This operation will be applied later in this book for further image processing such as preparing composite images.</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec17"/>Capturing screenshots</h2></div></div></div><p>How do you capture the desktop screen or a part of it using Python? There is<code class="literal"> ImageGrab</code> module in PIL. This simple line of code will capture the whole screen.</p><div><pre class="programlisting">img = ImageGrab.grab()
</pre></div><p>Where,<code class="literal"> img</code> is an instance of class<code class="literal"> Image</code>.</p><p>However, note that in PIL Version 1.1.6, the<code class="literal"> ImageGrab</code> module supports screen grabbing only for Windows platform.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec10"/>Time for action -  capture screenshots at intervals</h1></div></div></div><p>Imagine that you are developing an application, where, after certain time interval, the program needs to automatically capture the whole screen or a part of the screen. Let's develop code that achieves this.</p><div><ol class="orderedlist arabic"><li class="listitem">Write the following code in a Python source file. When the code is executed, it will capture part of the screen after every two seconds. The code will run for about three seconds.<div><pre class="programlisting">1 import ImageGrab
2 import time
3 startTime = time.clock()
4 print "\n The start time is %s sec" % startTime
5 # Define the four corners of the bounding box.
6 # (in pixels)
7 left = 150
8 upper = 200
9 right = 900
10 lower = 700
11 bbox = (left, upper, right, lower)
12
13 while time.clock() &lt; 3:
14 print " \n Capturing screen at time %.4f sec" \
15 %time.clock()
16 screenShot = ImageGrab.grab(bbox)
17 name = str("%.2f"%time.clock())+ "sec.png"
18 screenShot.save("C:\\images\\output\\" + name)
19 time.sleep(2)
</pre></div></li><li class="listitem">We will now review the important aspects of this code. First, import the necessary modules. The<code class="literal"> time.clock()</code> keeps track of the time spent. On line 11, a bounding box is defined. It is a<code class="literal"> 4-tuple</code> that defines the boundaries of a rectangular region. The elements in this<code class="literal"> tuple</code> are specified in pixels. In PIL, the origin (0, 0) is defined in the top-left corner of an image. The next illustration is a representation of a bounding box for image cropping; see how left, upper and right, lower are specified as the ends of a diagonal of rectangle.<p>Example of a bounding box used for image cropping.
</p><div><img src="img/0165_02_15.jpg" width="100" alt="Time for action - capture screenshots at intervals"/></div></li><li class="listitem">The<code class="literal"> while</code> loop runs till the<code class="literal"> time.clock()</code> reaches three seconds. Inside the loop, the part of the screen bounded within<code class="literal"> bbox</code> is captured (see line 16) and then the image is saved on line 18. The image name corresponds to the time at which it is taken.</li><li class="listitem">The<code class="literal"> time.sleep(2)</code> call suspends the execution of the application for two seconds. This ensures that it grabs the screen every two seconds. The loop repeats until the given time is reached.</li><li class="listitem">In this example, it will capture two screenshots, one when it enters the loop for the first time and the next after a two-second time interval. In the following illustration, the two images grabbed by the code are shown. Notice the time and console prints in these images.<a id="id67" class="indexterm"/><div><img src="img/0165_2_16.jpg" alt="Time for action - capture screenshots at intervals"/></div><p>The preceding screenshot is taken at time 00:02:15 as shown dialog. The next screenshot is taken after 2 seconds, at wall clock time, 00:02:17.</p><div><img src="img/0165_2_17.jpg" alt="Time for action - capture screenshots at intervals"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec18"/>What just happened?</h2></div></div></div><p>In the preceding example, we wrote a simple application that captures the screen at regular time intervals. This helped us to learn how to grab a screen region using<code class="literal"> ImageGrab</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec19"/>Cropping</h2></div></div></div><p>In previous section, we learned how to grab a part of the screen with<code class="literal"> ImageGrab</code>. Cropping is a very similar operation performed on an image. It allows you to modify a region within an image.<a id="id68" class="indexterm"/>
</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec11"/>Time for action -  cropping an image</h1></div></div></div><p>This simple code snippet crops an image and applies some changes on the cropped portion.</p><div><ol class="orderedlist arabic"><li class="listitem">Download the file<code class="literal"> Crop.png</code> from Packt website. The size of this image is<code class="literal"> 400 x 400</code> pixels. You can also use your own image file.</li><li class="listitem">Write the following code in a Python source file. Modify the path of the image file to an appropriate path.<div><pre class="programlisting">import Image
img = Image.open("C:\\images\\Crop.png")
left = 0
upper = 0
right = 180
lower = 215
bbox = (left, upper, right, lower)
img = img.crop(bbox)
img.show()
</pre></div></li><li class="listitem">This will crop a region of the image bounded by<code class="literal"> bbox</code>. The specification of the bounding box is identical to what we have seen in the<em> Capturing screenshots</em> section. The output of this example is shown in the following illustration.<a id="id69" class="indexterm"/><p>Original image (left) and its cropped region (right).
</p><div><img src="img/0165_2_18.jpg" alt="Time for action - cropping an image"/></div><div><img src="img/0165_2_19.jpg" alt="Time for action - cropping an image"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec20"/>What just happened?</h2></div></div></div><p>In the previous section, we used<code class="literal"> Image.crop</code> functionality to crop a region within an image and save the resultant image. In the next section, we will apply this while pasting a region of an image onto another.</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec21"/>Pasting</h2></div></div></div><p>Pasting a copied or cut image onto another one is a commonly performed operation while processing images. Following is the simplest syntax to paste one image on another.<a id="id70" class="indexterm"/>
</p><div><pre class="programlisting">img = img.paste(image, box)
</pre></div><p>Here<code class="literal"> image</code> is an instance of class<code class="literal"> Image</code> and<code class="literal"> box</code> is a rectangular bounding box that defines the region of<code class="literal"> img</code>, where the<code class="literal"> image</code> will be pasted. The<code class="literal"> box</code> argument can be a<code class="literal"> 4-tupleError: Reference source not found</code> or a<code class="literal"> 2-tuple</code>. If a<code class="literal"> 4-tuple</code> box is specified, the size of the image to be pasted must be same as the size of the region. Otherwise, PIL will throw an error with a message<code class="literal"> ValueError: images do not match</code>. The<code class="literal"> 2-tuple</code> on the other hand, provides pixel coordinates of the upper-left corner of the region to be pasted.</p><p>Now look at the following line of code. It is a copy operation on an image.</p><div><pre class="programlisting">img2 = img.copy(image)
</pre></div><p>The copy operation can be viewed as pasting the whole image onto a new image. This operation is useful when, for instance, you want to keep the original image unaltered and make alterations to the copy of the image.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec12"/>Time for action -  pasting: mirror the smiley face!</h1></div></div></div><p>Consider the example in earlier section where we cropped a region of an image. The cropped region contained a smiley face. Let's modify the original image so that it has a 'reflection' of the smiley face.</p><div><ol class="orderedlist arabic"><li class="listitem">If not already, download the file<code class="literal"> Crop.png</code> from the Packt website.</li><li class="listitem">Write this code by replacing the file path with appropriate file path on your system.<div><pre class="programlisting">1 import Image
2 img = Image.open("C:\\images\\Crop.png")
3 # Define the elements of a 4-tuple that represents
4 # a bounding box ( region to be cropped)
5 left = 0
6 upper = 25
7 right = 180
8 lower = 210
9 bbox = (left, upper, right, lower)
10 # Crop the smiley face from the image
11 smiley = img.crop(bbox_1)
12 # Flip the image horizontally
13 smiley = smiley.transpose(Image.FLIP_TOP_BOTTOM)
14 # Define the box as a 2-tuple.
15 bbox_2 = (0, 210)
16 # Finally paste the 'smiley' on to the image.
17 img.paste(smiley, bbox_2)
18 img.save("C:\\images\\Pasted.png")
19 img.show()
</pre></div></li><li class="listitem">First we open an image and crop it to extract a region containing the smiley face. This was already done in section<code class="literal"> Error: Reference source not found'Cropping'</code>. The only minor difference you will notice is the value of the tuple element<code class="literal"> upper</code>. It is intentionally kept as 25 pixels from the top to make sure that the crop image has a size that can fit in the blank portion below the original smiley face.<a id="id71" class="indexterm"/></li><li class="listitem">The cropped image is then flipped horizontally with code on line 13.</li><li class="listitem">Now we define a box,<code class="literal"> bbox_2</code>, for pasting the cropped smiley face back on to the original image. Where should it be pasted? We intend to make a 'reflection' of the original smiley face. So the coordinate of the top-right corner of the pasted image should be greater than or equal to the bottom y coordinate of the cropped region, indicated by 'lower' variable (see line 8) . The bounding box is defined on line 15, as a<code class="literal"> 2-tuple</code> representing the upper-left coordinates of the smiley.</li><li class="listitem">Finally, on line 17, the paste operation is performed to paste the smiley on the original image. The resulting image is then saved with a different name.</li><li class="listitem">The original image and the output image after the paste operation is shown in the next illustration.<div><img src="img/0165_2_20.jpg" alt="Time for action - pasting: mirror the smiley face!"/></div><div><img src="img/0165_2_21.jpg" alt="Time for action - pasting: mirror the smiley face!"/></div></li></ol></div><p>The illustration shows the comparison of original and resulting images after the paste operation.</p><div><div><div><div><h2 class="title"><a id="ch02lvl2sec22"/>What just happened?</h2></div></div></div><p>Using a combination of<code class="literal"> Image.crop</code> and<code class="literal"> Image.paste</code>, we accomplished cropping a region, making some modifications, and then pasting the region back on the image.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec13"/>Project: Thumbnail Maker</h1></div></div></div><p>Let's take up a project now. We will apply some of the operations we learned in this chapter to create a simple Thumbnail Maker utility. This application will accept an image as an input and will create a resized image of that image. Although we are calling it a thumbnail maker, it is a multi-purpose utility that implements some basic image-processing functionality.</p><p>Before proceeding further, make sure that you have installed all the packages discussed at the beginning of this chapter. The screenshot of the Thumbnail Maker dialog is show in the following illustration.</p><div><img src="img/0165_2_22.jpg" alt="Project: Thumbnail Maker"/></div><p>The Thumbnail Maker GUI has two components:</p><div><ol class="orderedlist arabic"><li class="listitem">The left panel is a 'control area', where you can specify certain image parameters along with options for input and output paths.</li><li class="listitem">A graphics area on the right-hand side where you can view the generated image.<p>In short, this is how it works:</p></li><li class="listitem">The application takes an image file as an input.</li><li class="listitem">It accepts user input for image parameters such as dimensions in pixel, filter for re-sampling and rotation angle in degrees.</li><li class="listitem">When the user clicks the<strong> OK</strong> button in the dialog, the image is processed and saved at a location indicated by the user in the specified output image format.</li></ol></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec14"/>Time for action -  play with Thumbnail Maker application</h1></div></div></div><p>First, we will run the Thumbnail Maker application as an end user. This warm-up exercise intends to give us a good understanding of how the application works. This, in turn, will help us develop/learn the involved code quickly. So get ready for action!</p><div><ol class="orderedlist arabic"><li class="listitem">Download the files<code class="literal"> ThumbnailMaker.py, ThumbnailMakeDialog.py</code>, and<code class="literal"> Ui_ThumbnailMakerDialog.py</code> from Packt website. Place these files in some directory.</li><li class="listitem">From the command prompt, change to this directory location and type the following command:<div><pre class="programlisting">python ThumbnailMakerDialog.py
</pre></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">The Thumbnail Maker dialog that pops up was shown in the earlier screenshot. Next, we will specify the input-output paths and various image parameters. You can open any image file of your choice. Here, the flower image shown in some previous sections will be used as an input image. To specify an input image, click on the small button with three dots …. It will open a file dialog. The following illustration shows the dialog with all the parameters specified.<div><img src="img/0165_2_23.jpg" alt="Time for action - play with Thumbnail Maker application"/></div></li></ul></div></li><li class="listitem">If<strong> Maintain Aspect Ratio</strong> checkbox is checked, internally it will scale the image dimension so that the aspect ratio of the output image remains the same. When the<strong> OK</strong> button is clicked, the resultant image is saved at the location specified by the<strong> Output Location</strong> field and the saved image is displayed in the right-hand panel of the dialog. The following screenshot shows the dialog after clicking<strong> OK</strong> button.<div><img src="img/0165_2_24.jpg" alt="Time for action - play with Thumbnail Maker application"/></div></li><li class="listitem">You can now try modifying different parameters such as output image format or rotation angle and save the resulting image.</li><li class="listitem">See what happens when the<strong> Maintain Aspect Ratio</strong> checkbox is unchecked. The aspect ratio of the resulting image will not be preserved and the image may appear distorted if the width and height dimensions are not properly specified.<a id="id72" class="indexterm"/></li><li class="listitem">Experiment with different re-sampling filters; you can notice the difference between the quality of the resultant image and the earlier image.</li><li class="listitem">There are certain limitations to this basic utility. It is required to specify reasonable values for all the parameters fields in the dialog. The program will print an error if any of the parameters is not specified.</li></ol></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec23"/>What just happened?</h2></div></div></div><p>We got ourselves familiar with the user interface of the thumbnail maker dialog and saw how it works for processing an image with different dimensions and quality. This knowledge will make it easier to understand the Thumbnail Maker code.</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec24"/>Generating the UI code</h2></div></div></div><p>The Thumbnail Maker GUI is written using PyQt4 (Python bindings for Qt4 GUI framework). Detailed discussion on how the GUI is generated and how the GUI elements are connected to the main functions is beyond the scope of this book. However, we will cover certain main aspects of this GUI to get you going. The GUI-related code in this application can simply be used 'as-is' and if this is something that interests you, go ahead and experiment with it further! In this section, we will briefly discuss how the UI code is generated using PyQt4.<a id="id73" class="indexterm"/>
</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec15"/>Time for action -  generating the UI code</h1></div></div></div><p>PyQt4 comes with an application called QT Designer. It is a GUI designer for QT-based applications and provides a quick way to develop a graphical user interface containing some basic widgets. With this, let's see how the Thumbnail Maker dialog looks in QT Designer and then run a command to generate Python source code from the<code class="literal"> .ui</code> file.</p><div><ol class="orderedlist arabic"><li class="listitem">Download the<code class="literal"> thumbnailMaker.ui</code> file from the Packt website.</li><li class="listitem">Start the QT Designer application that comes with PyQt4 installation.</li><li class="listitem">Open the file<code class="literal"> thumbnailMaker.ui</code> in QT Designer. Notice the red-colored borders around the UI elements in the dialog. These borders indicate a 'layout' in which the widgets are arranged. Without a layout in place, the UI elements may appear distorted when you run the application and, for instance, resize the dialog. Three types of<code class="literal"> QLayouts</code> are used, namely<code class="literal"> Horizontal, Vertical</code>, and<code class="literal"> Grid layout</code>.<a id="id74" class="indexterm"/><div><img src="img/0165_2_25.jpg" alt="Time for action - generating the UI code"/></div></li><li class="listitem">You can add new UI elements, such as a<code class="literal"> QCheckbox</code> or a<code class="literal"> QLabel</code>, by dragging and dropping it from the 'Widget Box' of QT Designer. It is located in the left panel by default.<a id="id75" class="indexterm"/></li><li class="listitem">Click on the field next to the label "Input file". In the right-hand panel of QT Designer, there is a Property Editor that displays the properties of the selected widget (in this case it's a<code class="literal"> QLineEdit)</code>. This is shown in the following illustration. The Property Editor allows us to assign values to various attributes such as the<code class="literal"> objectName, width</code>, and<code class="literal"> height</code> of the widget, and so on.<p>Qt Designer shows the details of the selected widget in Property Editor.
</p><div><img src="img/0165_2_26.jpg" alt="Time for action - generating the UI code"/></div></li><li class="listitem">QT designer saves the file with extension<code class="literal"> .ui</code>. To convert this into Python source code, PyQt4 provides a conversion utility called<code class="literal"> pyuic4</code>. On Windows XP, for standard Python installation, it is present at the following location<code class="literal"> C:\Python26\Lib\site-packages\PyQt4\pyuic4.bat</code>. Add this path to your environment variable. Alternatively specify the whole path each time you want to convert<code class="literal"> ui</code> file to Python source file. The conversion utility can be run from the command prompt as:<a id="id76" class="indexterm"/></li><li class="listitem">This script will generate<code class="literal"> Ui_ThumbnailMakerDialog.py</code> with all the GUI elements defined. You can further review this file to understand how the UI elements are defined.<div><pre class="programlisting">pyuic4 thumbnailMaker.ui -o Ui_ThumbnailMakerDialog.py
</pre></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec25"/>What just happened?</h2></div></div></div><p>We learned how to autogenerate the Python source code defining UI elements of Thumbnail Maker Dialog from a Qt designer file.</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec26"/>Have a go hero tweak UI of Thumbnail Maker dialog</h2></div></div></div><p>Modify the<code class="literal"> thumbnailMaker.ui</code> file in QT Designer and implement the following list of things in the Thumbnail Maker dialog.<a id="id77" class="indexterm"/>
</p><div><ol class="orderedlist arabic"><li class="listitem">Change the color of all the line edits in the left panel to pale yellow.</li><li class="listitem">Tweak the default file extension displayed in the<strong> Output file Format</strong> combobox such that the first option is<code class="literal"> .png</code> instead of<code class="literal"> .jpeg</code><div><div><h3 class="title"><a id="tip01"/>Tip</h3><p>Double click on this combobox to edit it.</p></div></div></li><li class="listitem">Add new option<code class="literal"> .tiff</code> to the output format combobox.</li><li class="listitem">Align the<strong> OK</strong> and<strong> Cancel</strong> buttons to the right corner.</li><li class="listitem">Set the range of rotation angle 0 to 360 degrees instead of the current -180 to +180 degrees.<div><div><h3 class="title"><a id="tip02"/>Tip</h3><p>You will need to break layouts, move the spacer around, and recreate the layouts.</p></div></div><p>After this, create<code class="literal"> Ui_ThumbnailMakerDialog.py</code> by running the<code class="literal"> pyuic4</code> script and then run the Thumbnail Maker application.<a id="id78" class="indexterm"/>
</p></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec27"/>Connecting the widgets</h2></div></div></div><p>In the earlier section, the Python source code representing UI was automatically generated using the<code class="literal"> pyuic4</code> script. This, however, only has the widgets defined and placed in a nice layout. We need to teach these widgets what they should do when a certain event occurs. To do this, QT's slots and signals will be used. A signal is emitted when a particular GUI event occurs. For example, when the user clicks on the<strong> OK</strong> button, internally, a<code class="literal"> clicked()</code> signal is emitted. A slot is a function that is called when a particular signal is emitted. Thus, in this example, it will call a specified method, whenever the<strong> OK</strong> button is clicked. See PyQt4 documentation for a complete list of available signals for various widgets.<a id="id79" class="indexterm"/>
</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec16"/>Time for action -  connecting the widgets</h1></div></div></div><p>You will notice several different widgets in the dialog. For example, the field which accepts the input image path or the output directory path is a<code class="literal"> QLineEdit</code>. The widget where image format is specified is a<code class="literal"> QCombobox</code>. On similar lines, the<strong> OK</strong> and<strong> Cancel</strong> buttons are<code class="literal"> QPushButton</code>. As an exercise, you can open up the<code class="literal"> thumbnailMaker.ui</code> file and click on each element to see the associated QT class from the Property Editor.</p><p>With this, let's learn how the widgets are connected.</p><div><ol class="orderedlist arabic"><li class="listitem">Open the file<code class="literal"> ThumbnailMakerDialog.py</code>. The<code class="literal"> _connect</code> method of class<code class="literal"> ThumbnailMakerDialog</code> is copied. The method is called in the constructor of this class.<div><pre class="programlisting">def _connect(self):
"""
Connect slots with signals.
"""
self.connect(self._dialog.inputFileDialogButton,
SIGNAL("clicked()"), self._openFileDialog)
self.connect(self._dialog.outputLocationDialogButton,
SIGNAL("clicked()"), self._outputLocationPath)
self.connect(self._dialog.okPushButton,
SIGNAL("clicked()"), self._processImage)
self.connect(self._dialog.closePushButton,
SIGNAL("clicked()"), self.close)
self.connect(self._dialog.aspectRatioCheckBox,
SIGNAL('stateChanged(int)'),
self._aspectRatioOptionChanged)
</pre></div></li><li class="listitem"><code class="literal"> self._dialog</code> is an instance of class<code class="literal"> Ui_ThumbnailMakerDialog. self.connect</code> is the inherited method of Qt class<code class="literal"> QDialog</code>. Here, it takes the following arguments (QObject,<code class="literal"> signal, callable)</code>, where<code class="literal"> QObject</code> is any widget type (all inherit<code class="literal"> QObject), signal</code> is the QT<code class="literal"> SIGNAL</code> that tells us about what event occurred and<code class="literal"> callable</code> is any method handling this event.<a id="id80" class="indexterm"/></li><li class="listitem">For example, consider the highlighted lines of the code snippet. They connect the<strong> OK</strong> button to a method that handles image processing. The first argument ,<code class="literal"> self._dialog.okPushButton</code> refers to the button widget defined in class<code class="literal"> Ui_ThumbnailMakerDialog</code>. Referring to<code class="literal"> QPushButton</code> documentation, you will find there is a "clicked()" signal that it can emit. The second argument<code class="literal"> SIGNAL("clicked()")</code> tells Qt that we want to know when that button is clicked by the user. The third argument is the method<code class="literal"> self._processImage</code> that gets called when this signal is emitted.</li><li class="listitem">Similarly, you can review the other connections in this method. Each of these connects a widget to a method of the class<code class="literal"> ThumbnailMakerDialog</code>.</li></ol></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec28"/>What just happened?</h2></div></div></div><p>We reviewed<code class="literal"> ThumbnailMakerDialog._connect()</code> method to understand how the UI elements are connected to various internal methods. The previous two sections helped us learn some preliminary concepts of GUI programming using QT.</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec29"/>Developing the image processing code</h2></div></div></div><p>The previous sections were intended to get ourselves familiar with the application as an end user and to understand some basic aspects of the GUI elements in the application. With all necessary pieces together, let's focus our attention on the class that does all the main image processing in the application.<a id="id81" class="indexterm"/>
</p><p>The class<code class="literal"> ThumbnailMaker</code> handles the pure image processing code. It defines various methods to achieve this. For example, the class methods such as<code class="literal"> _rotateImage, _makeThumbnail</code>, and<code class="literal"> _resizeImage</code> manipulate the given image to accomplish rotation, thumbnail generation, and resizing respectively. This class accepts input from<code class="literal"> ThumbnailMakerDialog</code>. Thus, no QT related UI code is required here. If you want to use some other GUI framework to process input, you can do that easily. Just make sure to implement the public API methods defined in class<code class="literal"> ThumbnailMakerDialog</code>, as those are used by the<code class="literal"> ThumbnailMaker</code> class.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec17"/>Time for action -  developing image processing code</h1></div></div></div><p>Thus, with<code class="literal"> ThumbnailMakerDialog</code> at your disposal, you can develop your own code in scratch, in class<code class="literal"> ThumbnailMaker</code>. Just make sure to implement the method<code class="literal"> processImage</code> as this is the only method called by<code class="literal"> ThumbnailMakerDialog</code>.</p><p>Let's develop some important methods of class<code class="literal"> ThumbnailMaker</code>.</p><div><ol class="orderedlist arabic"><li class="listitem">Write the constructor for class<code class="literal"> ThumbnailMaker</code>. It takes<code class="literal"> dialog</code> as an argument. In the constructor, we only initialize<code class="literal"> self._dialog</code>, which is an instance of class<code class="literal"> ThumbnailMakerDialog</code>. Here is the code.<div><pre class="programlisting">def __init__(self, dialog):
"""
Constructor for class ThumbnailMaker.
"""
# This dialog can be an instance of
# ThumbnailMakerDialog class. Alternatively, if
# you have some other way to process input,
</pre></div><div><pre class="programlisting"># it will be that class. Just make sure to implement
# the public API methods defined in
# ThumbnailMakerDialog class!
self._dialog = dialog
</pre></div></li><li class="listitem">Next, write the<code class="literal"> processImage</code> method in class<code class="literal"> ThumbnailMaker</code>. The code is as follows:<div><div><h3 class="title"><a id="tip03"/>Tip</h3><p>Note: You can download the file<code class="literal"> ThumbnailMaker.py</code> from Packt website. The code written is from this file. The only difference is that some code comments are removed here.</p><div><pre class="programlisting">1 def processImage(self):
2 filePath = self._dialog.getInputImagePath()
3 imageFile = Image.open(filePath)
4
5 if self._dialog.maintainAspectRatio:
6 resizedImage = self._makeThumbnail(imageFile)
7 else:
8 resizedImage = self._resizeImage(imageFile)
9
10 rotatedImage = self._rotateImage(resizedImage)
11
12 fullPath = self._dialog.getOutImagePath()
13
14 # Finally save the image.
15 rotatedImage.save(fullPath)
</pre></div></div></div></li><li class="listitem">On line 2, it gets the full path of the input image file. Note that it relies on<code class="literal"> self._dialog</code> to provide this information.<a id="id82" class="indexterm"/></li><li class="listitem">Then the image file is opened the usual way. On line 4, it checks a flag that decides whether or not to process the image by maintaining the aspect ratio. Accordingly,<code class="literal"> _makeThumbnail</code> or<code class="literal"> _resizeImage</code> methods are called.</li><li class="listitem">On line 10, it rotates the image resized earlier, using the<code class="literal"> _rotateImage</code> method.</li><li class="listitem">Finally, on line 15, the processed image is saved at a path obtained from the<code class="literal"> getOutImagePath</code> method of class<code class="literal"> ThumbnailMakerDialog</code>.</li><li class="listitem">We will now write the<code class="literal"> _makeThumbnail</code> method.<div><pre class="programlisting">1 def _makeThumbnail(self, imageFile):
2 foo = imageFile.copy()
3 size = self._dialog.getSize()
4 imageFilter = self._getImageFilter()
5 foo.thumbnail(size, imageFilter)
6 return foo
</pre></div></li><li class="listitem">First a copy of the original image is made. We will manipulate this copy and the method will return it for further processing.</li><li class="listitem">Then the necessary parameters such as the image dimension and filter for re-sampling are obtained from<code class="literal"> self._dialog</code> and<code class="literal"> _getImageFilter</code> respectively.</li><li class="listitem">Finally the thumbnail is created on line 5 and then method returns this image instance.</li><li class="listitem">We have already discussed how to resize and rotate image. The related code is straightforward to write and the readers are suggested to write it as an exercise. You will need to review the code from file<code class="literal"> ThumbnailMakerDialog.py</code> for getting appropriate parameters. Write remaining routines namely,<code class="literal"> _resizeImage, _rotateImage</code> and<code class="literal"> _getImageFilter</code>.<a id="id83" class="indexterm"/></li><li class="listitem">Once all methods are in place, run the code from the command line as:</li><li class="listitem">It should show our application dialog. Play around with it to make sure everything works!<div><pre class="programlisting">python Thumbnailmaker.py
</pre></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec30"/>What just happened?</h2></div></div></div><p>In the previous section, we completed an exciting project. Several things learned in this chapter, such as image I/O, resizing, and so on, were applied in the project. We developed a GUI application where some basic image manipulation features, such as creating thumbnails, were implemented. This project also helped us gain some insight into various aspects of GUI programming using QT.</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec31"/>Have a go hero enhance the ThumbnailMaker application</h2></div></div></div><p>Want to do something more with the Thumbnail Maker. Here you go! As you will add more features to this application, the first thing you would need to do is to change its name at least from the caption of the dialog that pops up! Edit the<code class="literal"> thumbnailMaker.ui</code> file in QT designer, change the name to something like "Image Processor", and recreate the corresponding<code class="literal"> .py</code> file. Next, add the following features to this application.<a id="id84" class="indexterm"/>
</p><div><div><h3 class="title"><a id="tip04"/>Tip</h3><p>If you don't want to deal with any UI code, that is fine too! You can write a class similar to<code class="literal"> ThumbnailMakerDialog</code>. Do the input argument processing in your own way. All that class<code class="literal"> ThumbnailMaker</code> requires is implementation of certain public methods in this new class, to get various input parameters.</p></div></div><div><ol class="orderedlist arabic"><li class="listitem">Accept output filename from the user. Currently, it gives the same name as the input file.<p>Edit the .ui file. You would need to break the layouts before adding a QLineEdit and its QLabel and then recreate the layouts.
<a id="id85" class="indexterm"/>
</p></li><li class="listitem">If there is a previously created output image file in the output directory, clicking<strong> OK</strong> would simply overwrite that file. Add a checkbox reading, "Overwrite existing file (if any)". If the checkbox in deselected, it should pop up a warning dialog and exit.<p>For the latter part, there is a commented out code block in ThumbnailMakerDialog._processImage. Just enable the code.
</p></li><li class="listitem">Add a feature that can add specified text in the lower-left corner of the output image.</li><li class="listitem">Create an image with this text, and use the combination of crop and paste to achieve desired results. For user input, you will need to add a new<code class="literal"> QLineEdit</code> for accepting text input and then connect signals with a callable method in<code class="literal"> ThumbnailMakerDialog._connect</code>.</li></ol></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec18"/>Summary</h1></div></div></div><p>We learned a lot in this chapter about basic image manipulation.</p><p>Specifically, we covered image input-output operations that enable reading and writing of images, and creation of images from scratch.
</p><p>With the help of numerous examples and code snippets, we learned several image manipulation operations. Some of them are:
</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">How to resize an image with or without maintaining aspect ratio</li><li class="listitem" style="list-style-type: disc">Rotating or flipping an image</li><li class="listitem" style="list-style-type: disc">Cropping an image, manipulating it using techniques learned earlier in the chapter, and then pasting it on the original image</li><li class="listitem" style="list-style-type: disc">Creating an image with a text</li><li class="listitem" style="list-style-type: disc">We developed a small application that captures a region of your screen at regular time intervals</li><li class="listitem" style="list-style-type: disc">We created an interesting project implementing some image processing functionality learned in this chapter</li></ul></div><p>With this basic image manipulation knowledge, we are ready to learn how to add some cool effects to an image. In the next chapter, we will see how to enhance an image.
</p></div></div>
</body></html>