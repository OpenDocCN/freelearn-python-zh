<html><head></head><body>
<div><h1 class="chapterNumber">12</h1>
<h1 class="chapterTitle" id="_idParaDest-332">Building an E-Learning Platform</h1>
<p class="normal">In the previous chapter, you learned the basics of the internationalization and localization of Django projects, adapting your project to meet the local formats and languages for your users.</p>
<p class="normal">In this chapter, you will start a new Django project that will consist of an e-learning platform with your own <strong class="keyWord">content management system</strong> (<strong class="keyWord">CMS</strong>). Online learning platforms are a great example of applications that require tools for advanced content handling. You will learn how to create flexible data models that accommodate diverse data types and discover how to implement custom model functionalities that you can apply to your future Django projects.</p>
<p class="normal">In this chapter, you will learn how to:</p>
<ul>
<li class="bulletList">Create models for the CMS</li>
<li class="bulletList">Create fixtures for your models and apply them</li>
<li class="bulletList">Use model inheritance to create data models for polymorphic content</li>
<li class="bulletList">Create custom model fields</li>
<li class="bulletList">Order course contents and modules</li>
<li class="bulletList">Build authentication views for the CMS</li>
</ul>
<h1 class="heading-1" id="_idParaDest-333">Functional overview</h1>
<p class="normal">In previous chapters, diagrams at the start represented views, templates, and end-to-end functionalities. This chapter, however, shifts the focus to implementing model inheritance and creating custom model fields, topics not easily captured in our usual diagrams. Instead, you will see specific diagrams to illustrate these concepts throughout the chapter.</p>
<p class="normal">The source code for this chapter can be found at <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter12">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter12</a>.</p>
<p class="normal">All the Python modules used in this chapter are included in the <code class="inlineCode">requirements.txt</code> file in the source code that comes with this chapter. You can follow the instructions to install each Python module below, or you can install all the requirements at once with the command <code class="inlineCode">python</code> <code class="inlineCode">-m</code> <code class="inlineCode">pip</code> <code class="inlineCode">install</code> <code class="inlineCode">-r requirements.txt</code>.</p>
<h1 class="heading-1" id="_idParaDest-334">Setting up the e-learning project</h1>
<p class="normal">Your final practical project<a id="_idIndexMarker1091"/> will be an e-learning platform. First, create a virtual environment for your new project within the <code class="inlineCode">env/</code> directory with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m venv env/educa
</code></pre>
<p class="normal">If you are using Linux or macOS, run the following command to activate your virtual environment:</p>
<pre class="programlisting con"><code class="hljs-con">source env/educa/bin/activate
</code></pre>
<p class="normal">If you are using Windows, use the following command instead:</p>
<pre class="programlisting con"><code class="hljs-con">.\env\educa\Scripts\activate
</code></pre>
<p class="normal">Install Django in your virtual environment with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install Django~=5.0.4
</code></pre>
<p class="normal">You are going to manage image uploads in your project, so you also need to install <code class="inlineCode">Pillow</code> with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install Pillow==10.3.0
</code></pre>
<p class="normal">Create a new project using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">django-admin startproject educa
</code></pre>
<p class="normal">Enter the new <code class="inlineCode">educa</code> directory and create a new application using the following commands:</p>
<pre class="programlisting con"><code class="hljs-con">cd educa
django-admin startapp courses
</code></pre>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of the <code class="inlineCode">educa</code> project and add <code class="inlineCode">courses</code> to the <code class="inlineCode">INSTALLED_APPS</code> setting, as follows. The <a id="_idIndexMarker1092"/>new line is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">INSTALLED_APPS = [
    <strong class="hljs-string-slc">'courses.apps.CoursesConfig'</strong><strong class="hljs-slc">,</strong>
'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]
</code></pre>
<p class="normal">The <code class="inlineCode">courses</code> application is now active for the project. Next, we are going to prepare our project to serve media files and we will define the models for the courses and course contents.</p>
<h1 class="heading-1" id="_idParaDest-335">Serving media files</h1>
<p class="normal">Before creating the models for courses and<a id="_idIndexMarker1093"/> course contents, we will prepare the project to serve media files. Course instructors will be able to upload media files to course content using the CMS that we will build. Therefore, we will configure the project to serve media files.</p>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of the project and add the following lines:</p>
<pre class="programlisting code"><code class="hljs-code">MEDIA_URL = 'media/'
MEDIA_ROOT = BASE_DIR / 'media'
</code></pre>
<p class="normal">This will enable Django to manage file uploads and serve media files. <code class="inlineCode">MEDIA_URL</code> is the base URL used to serve the media files uploaded by users. <code class="inlineCode">MEDIA_ROOT</code> is the local path where they reside. Paths and URLs for files are built dynamically by prepending the project path or the media URL to them for portability.</p>
<p class="normal">Now, edit the main <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">educa</code> project and modify the code, as follows. New lines are highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.conf </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> settings</strong>
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.conf.urls.static </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> static</strong>
from django.contrib import admin
from django.urls import path
urlpatterns = [
    path('admin/', admin.site.urls),
]
<strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> settings.DEBUG:</strong>
<strong class="hljs-slc">    urlpatterns += static(</strong>
<strong class="hljs-slc">        settings.MEDIA_URL, document_root=settings.MEDIA_ROOT</strong>
<strong class="hljs-slc">    )</strong>
</code></pre>
<p class="normal">We have added the <code class="inlineCode">static()</code> helper <a id="_idIndexMarker1094"/>function to serve media files with the Django development server during development (that is, when the <code class="inlineCode">DEBUG</code> setting is set to <code class="inlineCode">True</code>).</p>
<div><p class="normal">Remember that the <code class="inlineCode">static()</code> helper function is suitable for development but not for production use. Django is inefficient at serving static files. Never serve your static files with the Django development server in a production environment. You will learn how to serve static files in a production environment in <em class="italic">Chapter 17</em>, <em class="italic">Going Live</em>.</p>
</div>
<p class="normal">The project is now ready to serve media files. Let’s create the models for the courses and course contents.</p>
<h1 class="heading-1" id="_idParaDest-336">Building the course models</h1>
<p class="normal">Your e-learning platform will <a id="_idIndexMarker1095"/>offer courses on various subjects. Each course will be divided into a configurable number of modules, and each module will contain a configurable number of contents. The contents will be of various types: text, files, images, or videos. The following example shows what the data structure of your course <a id="_idIndexMarker1096"/>catalog will look like:</p>
<pre class="programlisting con"><code class="hljs-con">Subject 1
  Course 1
    Module 1
      Content 1 (image)
      Content 2 (text)
    Module 2
      Content 3 (text)
      Content 4 (file)
      Content 5 (video)
      ...
</code></pre>
<p class="normal">Let’s build the course models. Edit the <code class="inlineCode">models.py</code> file of the <code class="inlineCode">courses</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.contrib.auth.models </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> User</strong>
from django.db import models
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Subject</strong><strong class="hljs-slc">(models.Model):</strong>
<strong class="hljs-slc">    title = models.CharField(max_length=</strong><strong class="hljs-number-slc">200</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    slug = models.SlugField(max_length=</strong><strong class="hljs-number-slc">200</strong><strong class="hljs-slc">, unique=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Meta</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">        ordering = [</strong><strong class="hljs-string-slc">'title'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">__str__</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> self.title</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Course</strong><strong class="hljs-slc">(models.Model):</strong>
<strong class="hljs-slc">    owner = models.ForeignKey(</strong>
<strong class="hljs-slc">        User,</strong>
<strong class="hljs-slc">        related_name=</strong><strong class="hljs-string-slc">'</strong><strong class="hljs-string-slc">courses_created'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        on_delete=models.CASCADE</strong>
<strong class="hljs-slc">    )</strong>
<strong class="hljs-slc">    subject = models.ForeignKey(</strong>
<strong class="hljs-slc">        Subject,</strong>
<strong class="hljs-slc">        related_name=</strong><strong class="hljs-string-slc">'courses'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        on_delete=models.CASCADE</strong>
<strong class="hljs-slc">    )</strong>
<strong class="hljs-slc">    title = models.CharField(max_length=</strong><strong class="hljs-number-slc">200</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    slug = models.SlugField(max_length=</strong><strong class="hljs-number-slc">200</strong><strong class="hljs-slc">, unique=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    overview = models.TextField()</strong>
<strong class="hljs-slc">    created = models.DateTimeField(auto_now_add=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Meta</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">        ordering = [</strong><strong class="hljs-string-slc">'-created'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">__str__</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> self.title</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Module</strong><strong class="hljs-slc">(models.Model):</strong>
<strong class="hljs-slc">    course = models.ForeignKey(</strong>
<strong class="hljs-slc">        Course, related_name=</strong><strong class="hljs-string-slc">'modules'</strong><strong class="hljs-slc">, on_delete=models.CASCADE</strong>
<strong class="hljs-slc">    )</strong>
<strong class="hljs-slc">    title = models.CharField(max_length=</strong><strong class="hljs-number-slc">200</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    description = models.TextField(blank=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">__str__</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> self.title</strong>
</code></pre>
<p class="normal">These are the initial <code class="inlineCode">Subject</code>, <code class="inlineCode">Course</code>, and <code class="inlineCode">Module</code> models. The <code class="inlineCode">Course</code> model fields are as follows:</p>
<ul>
<li class="bulletList"><code class="inlineCode">owner</code>: The instructor who created this course.</li>
<li class="bulletList"><code class="inlineCode">subject</code>: The subject that this course belongs to. It is a <code class="inlineCode">ForeignKey</code> field that points to the <code class="inlineCode">Subject</code> model.</li>
<li class="bulletList"><code class="inlineCode">title</code>: The title of the course.</li>
<li class="bulletList"><code class="inlineCode">slug</code>: The slug of the course. This will be used in URLs later.</li>
<li class="bulletList"><code class="inlineCode">overview</code>: A <code class="inlineCode">TextField</code> column to store an overview of the course.</li>
<li class="bulletList"><code class="inlineCode">created</code>: The date and time when the course was created. It will be automatically set by <a id="_idIndexMarker1097"/>Django when creating new objects because of <code class="inlineCode">auto_now_add=True</code>.</li>
</ul>
<p class="normal">Each course is divided into several modules. Therefore, the <code class="inlineCode">Module</code> model contains a <code class="inlineCode">ForeignKey</code> field that points to the <code class="inlineCode">Course</code> model.</p>
<p class="normal">Open the shell and run the following command to create the initial migration for this application:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py makemigrations
</code></pre>
<p class="normal">You will see the following output:</p>
<pre class="programlisting con"><code class="hljs-con">Migrations for 'courses':
  courses/migrations/0001_initial.py:
    - Create model Course
    - Create model Module
    - Create model Subject
    - Add field subject to course
</code></pre>
<p class="normal">Then, run the following command to apply all migrations to the database:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py migrate
</code></pre>
<p class="normal">You should see output that includes all applied migrations, including those of Django. The output will contain the following line:</p>
<pre class="programlisting con"><code class="hljs-con">Applying courses.0001_initial... OK
</code></pre>
<p class="normal">The models of your <code class="inlineCode">courses</code> application have been synced with the database. Next, we are going to add the course<a id="_idIndexMarker1098"/> models to the administration site.</p>
<h2 class="heading-2" id="_idParaDest-337">Registering the models in the administration site</h2>
<p class="normal">Let’s register the course models on the <a id="_idIndexMarker1099"/>administration site so that we can manage the data easily. Edit the <code class="inlineCode">admin.py</code> file inside the <code class="inlineCode">courses</code> application directory and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.contrib import admin
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> .models </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> Subject, Course, Module</strong>
<strong class="hljs-meta-slc">@admin.register(</strong><strong class="hljs-params-slc">Subject</strong><strong class="hljs-meta-slc">)</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">SubjectAdmin</strong><strong class="hljs-slc">(admin.ModelAdmin):</strong>
<strong class="hljs-slc">    list_display = [</strong><strong class="hljs-string-slc">'title'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'slug'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">    prepopulated_fields = {</strong><strong class="hljs-string-slc">'slug'</strong><strong class="hljs-slc">: (</strong><strong class="hljs-string-slc">'title'</strong><strong class="hljs-slc">,)}</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">ModuleInline</strong><strong class="hljs-slc">(admin.StackedInline):</strong>
<strong class="hljs-slc">    model = Module</strong>
<strong class="hljs-meta-slc">@admin.register(</strong><strong class="hljs-params-slc">Course</strong><strong class="hljs-meta-slc">)</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">CourseAdmin</strong><strong class="hljs-slc">(admin.ModelAdmin):</strong>
<strong class="hljs-slc">    list_display = [</strong><strong class="hljs-string-slc">'title'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'subject'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'created'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">    list_filter = [</strong><strong class="hljs-string-slc">'created'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'subject'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">    search_fields = [</strong><strong class="hljs-string-slc">'title'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'overview'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">    prepopulated_fields = {</strong><strong class="hljs-string-slc">'slug'</strong><strong class="hljs-slc">: (</strong><strong class="hljs-string-slc">'title'</strong><strong class="hljs-slc">,)}</strong>
<strong class="hljs-slc">    inlines = [ModuleInline]</strong>
</code></pre>
<p class="normal">The models for the <code class="inlineCode">courses</code> application are now registered on the administration site. Remember that you use the <code class="inlineCode">@admin.register()</code> decorator to register models on the administration site.</p>
<p class="normal">In the next section, you will learn <a id="_idIndexMarker1100"/>how to create initial data to populate your models.</p>
<h2 class="heading-2" id="_idParaDest-338">Using fixtures to provide initial data for models</h2>
<p class="normal">Sometimes, you might want to prepopulate your database with hardcoded data. This is useful for automatically including initial <a id="_idIndexMarker1101"/>data in the project setup, instead of having to add it manually. Django comes with a simple way to load and dump data from the database into files that are called <strong class="keyWord">fixtures</strong>. Django supports<a id="_idIndexMarker1102"/> fixtures in JSON, XML, or YAML formats. The structure of a fixture closely resembles the API representation of a model, making it straightforward to translate data between internal database formats and external applications. You are going to create a fixture to include several initial <code class="inlineCode">Subject</code> objects for your project.</p>
<p class="normal">First, create a superuser using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py createsuperuser
</code></pre>
<p class="normal">Then, run the development server using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/admin/courses/subject/</code> in your browser. Create several subjects using the administration site. The change list page should look as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_12_01.png"/></figure>
<p class="packt_figref">Figure 12.1: The subject change list view on the administration site</p>
<p class="normal">Run the following <a id="_idIndexMarker1103"/>command from<a id="_idIndexMarker1104"/> the shell:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py dumpdata courses --indent=2
</code></pre>
<p class="normal">You will see an output similar to the following:</p>
<pre class="programlisting con"><code class="hljs-con">[
{
  "model": "courses.subject",
  "pk": 1,
  "fields": {
    "title": "Mathematics",
    "slug": "mathematics"
  }
},
{
  "model": "courses.subject",
  "pk": 2,
  "fields": {
    "title": "Music",
    "slug": "music"
  }
},
{
  "model": "courses.subject",
  "pk": 3,
  "fields": {
    "title": "Physics",
    "slug": "physics"
  }
},
{
  "model": "courses.subject",
  "pk": 4,
  "fields": {
    "title": "Programming",
    "slug": "programming"
  }
}
]
</code></pre>
<p class="normal">The <code class="inlineCode">dumpdata</code> command dumps data from the database into the standard output, serialized in JSON format by<a id="_idIndexMarker1105"/> default. The resulting data structure includes information about the model and its fields for Django to be able to load it into the database.</p>
<p class="normal">You can limit the output <a id="_idIndexMarker1106"/>to the models of an application by providing the application names to the command or specifying single models for outputting data using the <code class="inlineCode">app.Model</code> format. </p>
<p class="normal">You can also specify the format using the <code class="inlineCode">--format</code> flag. By default, <code class="inlineCode">dumpdata</code> outputs the serialized data to the standard output. However, you can indicate an output file using the <code class="inlineCode">--output</code> flag, which allows you to store the output. The <code class="inlineCode">--indent</code> flag allows you to specify indentations. For more information on <code class="inlineCode">dumpdata</code> parameters, run <code class="inlineCode">python manage.py dumpdata --help</code>.</p>
<p class="normal">Save this dump to a fixtures file in a new <code class="inlineCode">fixtures/</code> directory in the <code class="inlineCode">courses</code> application using the following commands:</p>
<pre class="programlisting con"><code class="hljs-con">mkdir courses/fixtures
python manage.py dumpdata courses --indent=2 --output=courses/fixtures/subjects.json
</code></pre>
<p class="normal">Run the development server and use the administration site to remove the subjects you created, as shown in <em class="italic">Figure 12.2</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_12_02.png"/></figure>
<p class="packt_figref">Figure 12.2: Deleting all existing subjects</p>
<p class="normal">After deleting all subjects, load <a id="_idIndexMarker1107"/>the fixture into<a id="_idIndexMarker1108"/> the database using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py loaddata subjects.json
</code></pre>
<p class="normal">All <code class="inlineCode">Subject</code> objects included in the fixture are loaded into the database again:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_12_03.png"/></figure>
<p class="packt_figref">Figure 12.3: Subjects from the fixture are now loaded into the database</p>
<p class="normal">By default, Django looks for files in the <code class="inlineCode">fixtures/</code> directory of each application, but you can specify the complete path to the fixture file for the <code class="inlineCode">loaddata</code> command. You can also use the <code class="inlineCode">FIXTURE_DIRS</code> setting to tell Django about additional directories to look in for fixtures.</p>
<div><p class="normal">Fixtures are not only useful for setting up initial data but also for providing sample data for your application or data required for your tests. You can also use fixtures to populate necessary data for production environments.</p>
</div>
<p class="normal">You can read about how to use fixtures for testing at <a href="https://docs.djangoproject.com/en/5.0/topics/testing/tools/#fixture-loading">https://docs.djangoproject.com/en/5.0/topics/testing/tools/#fixture-loading</a>.</p>
<p class="normal">If you want to load fixtures<a id="_idIndexMarker1109"/> in model migrations, look at Django’s documentation about data migrations. You can find the documentation for migrating data at <a href="https://docs.djangoproject.com/en/5.0/topics/migrations/#data-migrations">https://docs.djangoproject.com/en/5.0/topics/migrations/#data-migrations</a>.</p>
<p class="normal">You have created the models to <a id="_idIndexMarker1110"/>manage course subjects, courses, and course modules. Next, you will create models to manage different types of module content.</p>
<h1 class="heading-1" id="_idParaDest-339">Creating models for polymorphic content</h1>
<p class="normal">You plan to add different types of content to the course modules, such as text, images, files, and videos. <strong class="keyWord">Polymorphism</strong> is the provision of a single interface to entities of different types. You need a versatile <a id="_idIndexMarker1111"/>data model that allows you to store diverse content<a id="_idIndexMarker1112"/> that is accessible through a single interface. In <em class="italic">Chapter 7</em>, <em class="italic">Tracking User Actions</em>, you learned about the convenience of using generic relations to create foreign keys that can point to the objects of any model. You are going to create a <code class="inlineCode">Content</code> model that represents the modules’ contents and define a generic relation to associate any object with the content object.</p>
<p class="normal">Edit the <code class="inlineCode">models.py</code> file of the <code class="inlineCode">courses</code> application and add the following imports:</p>
<pre class="programlisting code"><code class="hljs-code">from django.contrib.contenttypes.fields import GenericForeignKey
from django.contrib.contenttypes.models import ContentType
</code></pre>
<p class="normal">Then, add the following code to the end of the file:</p>
<pre class="programlisting code"><code class="hljs-code">class Content(models.Model):
    module = models.ForeignKey(
        Module,
        related_name='contents',
        on_delete=models.CASCADE
    )
    content_type = models.ForeignKey(
        ContentType,
        on_delete=models.CASCADE
    )
    object_id = models.PositiveIntegerField()
    item = GenericForeignKey('content_type', 'object_id')
</code></pre>
<p class="normal">This is the <code class="inlineCode">Content</code> model. A module contains multiple contents, so you define a <code class="inlineCode">ForeignKey</code> field that points to the <code class="inlineCode">Module</code> model. You can also set up a generic relation to associate objects from different <a id="_idIndexMarker1113"/>models that represent different types of content. Remember that you need three different fields to set up a generic relation. In your <code class="inlineCode">Content</code> model, these are:</p>
<ul>
<li class="bulletList"><code class="inlineCode">content_type</code>: A <code class="inlineCode">ForeignKey</code> field to the <code class="inlineCode">ContentType</code> model</li>
<li class="bulletList"><code class="inlineCode">object_id</code>: A <code class="inlineCode">PositiveIntegerField</code> to store the primary key of the related object</li>
<li class="bulletList"><code class="inlineCode">item</code>: A <code class="inlineCode">GenericForeignKey</code> field to the related object combining the two previous fields</li>
</ul>
<p class="normal">Only the <code class="inlineCode">content_type</code> and <code class="inlineCode">object_id</code> fields have a corresponding column in the database table of this model. The <code class="inlineCode">item</code> field allows you to retrieve or set the related object directly, and its functionality is built on top of the other two fields.</p>
<p class="normal">You are going to use a distinct model for each type of content; text, image, video, and document. Your <code class="inlineCode">Content</code> models will share some common fields but they will vary in the specific data that they store. For example, for text content, you will store the actual text, but for video content, you will store the video URL. To accomplish this, you will need to employ model inheritance. We will dive into the options that Django offers for model inheritance before building our <code class="inlineCode">Content</code> models.</p>
<h2 class="heading-2" id="_idParaDest-340">Using model inheritance</h2>
<p class="normal">Django supports model inheritance. It works in a similar way to standard class inheritance in Python. If you are<a id="_idIndexMarker1114"/> not familiar with class inheritance, it involves defining a new class that inherits methods and properties <a id="_idIndexMarker1115"/>from an existing class. This facilitates code reusability and can simplify the creation of related classes. You can read more about class inheritance at <a href="https://docs.python.org/3/tutorial/classes.html#inheritance">https://docs.python.org/3/tutorial/classes.html#inheritance</a>.</p>
<p class="normal">Django offers the following three options to use model inheritance:</p>
<ul>
<li class="bulletList"><strong class="keyWord">Abstract models</strong>: Useful when you want to put some common information into several models</li>
<li class="bulletList"><strong class="keyWord">Multi-table model inheritance</strong>: Applicable when each model in the hierarchy is considered a complete model by itself</li>
<li class="bulletList"><strong class="keyWord">Proxy models</strong>: Useful when you need to change the behavior of a model, for example, by including additional methods, changing the default manager, or using different meta options</li>
</ul>
<p class="normal">Let’s take a closer look at<a id="_idIndexMarker1116"/> each of them.</p>
<h3 class="heading-3" id="_idParaDest-341">Abstract models</h3>
<p class="normal">An abstract model is a base class in<a id="_idIndexMarker1117"/> which you define the fields you want to include in all child models. Django doesn’t create any database tables for abstract models. A database table is created for each child model, including the fields inherited from the <a id="_idIndexMarker1118"/>abstract class and the ones defined in the child model.</p>
<p class="normal">To mark a model as abstract, you need to include <code class="inlineCode">abstract=True</code> in its <code class="inlineCode">Meta</code> class. Django will recognize that it is an abstract model and will not create a database table for it. To create child models, you just need to subclass the abstract model.</p>
<p class="normal">The following example shows an abstract <code class="inlineCode">BaseContent</code> model and a child <code class="inlineCode">Text</code> model:</p>
<pre class="programlisting code"><code class="hljs-code">from django.db import models
class BaseContent(models.Model):
    title = models.CharField(max_length=100)
    created = models.DateTimeField(auto_now_add=True)
    class Meta:
        abstract = True
class Text(BaseContent):
    body = models.TextField()
</code></pre>
<p class="normal">In this case, Django would create a table for the <code class="inlineCode">Text</code> model only, including the <code class="inlineCode">title</code>, <code class="inlineCode">created</code>, and <code class="inlineCode">body</code> fields.</p>
<p class="normal"><em class="italic">Figure 12.4</em> shows the models and associated database tables for the code example provided:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_12_04.png"/></figure>
<p class="packt_figref">Figure 12.4: Sample models and database tables for inheritance using abstract models</p>
<p class="normal">Next, we are going to learn <a id="_idIndexMarker1119"/>about a different model inheritance approach, where <a id="_idIndexMarker1120"/>multiple database tables are created.</p>
<h3 class="heading-3" id="_idParaDest-342">Multi-table model inheritance</h3>
<p class="normal">In multi-table inheritance, each model <a id="_idIndexMarker1121"/>corresponds to a database table. Django creates a <code class="inlineCode">OneToOneField</code> field for the relationship between the child model and its parent model. To use multi-table inheritance, you have to subclass an existing model. Django will create a database table for both the original model and the sub-model. The following example shows multi-table inheritance:</p>
<pre class="programlisting code"><code class="hljs-code">from django.db import models
class BaseContent(models.Model):
    title = models.CharField(max_length=100)
    created = models.DateTimeField(auto_now_add=True)
class Text(BaseContent):
    body = models.TextField()
</code></pre>
<p class="normal">Django will include an automatically generated <code class="inlineCode">OneToOneField</code> field in the <code class="inlineCode">Text</code> model that points to the <code class="inlineCode">BaseContent</code> model. The name for this field is <code class="inlineCode">basecontent_ptr</code>, where <code class="inlineCode">ptr</code> stands for <em class="italic">pointer</em>. A database table is created for each model.</p>
<p class="normal"><em class="italic">Figure 12.5</em> shows the models and <a id="_idIndexMarker1122"/>associated database tables for the multi-table model inheritance code example provided:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_12_05.png"/></figure>
<p class="packt_figref">Figure 12.5: Sample models and database tables for multi-table model inheritance</p>
<p class="normal">Next, we are going to learn about another model inheritance approach, where multiple models serve as a proxy to a single database table.</p>
<h3 class="heading-3" id="_idParaDest-343">Proxy models</h3>
<p class="normal">A proxy model changes the behavior<a id="_idIndexMarker1123"/> of a model. Both models operate on the database table of<a id="_idIndexMarker1124"/> the original model. This allows you to customize behavior for different models without creating a new database table, creating different versions of the same model that are tailored for different purposes. To create a proxy model, add <code class="inlineCode">proxy=True</code> to the <code class="inlineCode">Meta</code> class of the model. The following example illustrates how to create a proxy model:</p>
<pre class="programlisting code"><code class="hljs-code">from django.db import models
from django.utils import timezone
class BaseContent(models.Model):
    title = models.CharField(max_length=100)
    created = models.DateTimeField(auto_now_add=True)
class OrderedContent(BaseContent):
    class Meta:
        proxy = True
        ordering = ['created']
    def created_delta(self):
        return timezone.now() - self.created
</code></pre>
<p class="normal">Here, you define an <code class="inlineCode">OrderedContent</code> model that is a proxy model for the <code class="inlineCode">Content</code> model. This model provides a default ordering for QuerySets and an additional <code class="inlineCode">created_delta()</code> method. Both<a id="_idIndexMarker1125"/> models, <code class="inlineCode">Content</code> and <code class="inlineCode">OrderedContent</code>, operate on the same database table, and objects are accessible via the ORM through either model.</p>
<p class="normal"><em class="italic">Figure 12.6</em> shows the models <a id="_idIndexMarker1126"/>and associated database tables for the proxy model inheritance code example provided:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_12_06.png"/></figure>
<p class="packt_figref">Figure 12.6: Sample models and database tables for inheritance using proxy models</p>
<p class="normal">You have now become familiar with the three types of model inheritance. For additional information on model<a id="_idIndexMarker1127"/> inheritance, you can visit <a href="https://docs.djangoproject.com/en/5.0/topics/db/models/#model-inheritance">https://docs.djangoproject.com/en/5.0/topics/db/models/#model-inheritance</a>. Now, we will apply model inheritance in practice by using a base abstract model to develop models for <a id="_idIndexMarker1128"/>various content types.</p>
<h2 class="heading-2" id="_idParaDest-344">Creating the Content models</h2>
<p class="normal">Let’s use model inheritance to implement polymorphic models. You will create a versatile data model that<a id="_idIndexMarker1129"/> enables storing diverse content accessible through a unified interface. The ideal approach for this use case is to create <a id="_idIndexMarker1130"/>an abstract base model that is then extended by models – each designed to store a particular type of data: text, image, video, and file. This flexible approach will equip you with the tools needed for scenarios where polymorphism is required.</p>
<p class="normal">The <code class="inlineCode">Content</code> model of your <code class="inlineCode">courses</code> application contains a generic relation to associate different types of content with it. You will create a different model for each type of content. All <code class="inlineCode">Content</code> models will have some fields in common and additional fields to store custom data. You are going to create an abstract model that provides the common fields for all <code class="inlineCode">Content</code> models.</p>
<p class="normal">Edit the <code class="inlineCode">models.py</code> file of the <code class="inlineCode">courses</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">class ItemBase(models.Model):
    owner = models.ForeignKey(User,
        related_name='%(class)s_related',
        on_delete=models.CASCADE
    )
    title = models.CharField(max_length=250)
    created = models.DateTimeField(auto_now_add=True)
    updated = models.DateTimeField(auto_now=True)
    class Meta:
        abstract = True
def __str__(self):
        return self.title
class Text(ItemBase):
    content = models.TextField()
class File(ItemBase):
    file = models.FileField(upload_to='files')
class Image(ItemBase):
    file = models.FileField(upload_to='images')
class Video(ItemBase):
    url = models.URLField()
</code></pre>
<p class="normal">In this code, you define an abstract model named <code class="inlineCode">ItemBase</code>. Therefore, you set <code class="inlineCode">abstract=True</code> in its <code class="inlineCode">Meta</code> class.</p>
<p class="normal">In this model, you define the <code class="inlineCode">owner</code>, <code class="inlineCode">title</code>, <code class="inlineCode">created</code>, and <code class="inlineCode">updated</code> fields. These common fields will be used for all types of content.</p>
<p class="normal">The <code class="inlineCode">owner</code> field allows<a id="_idIndexMarker1131"/> you to store which user created the <a id="_idIndexMarker1132"/>content. Since this field is defined in an abstract class, you need a different <code class="inlineCode">related_name</code> for each sub-model. Django allows you to specify a placeholder for the model class name in the <code class="inlineCode">related_name</code> attribute as <code class="inlineCode">%(class)s</code>. By doing so, the <code class="inlineCode">related_name</code> for each child model will be generated automatically. Since you are using <code class="inlineCode">'%(class)s_related'</code> as the <code class="inlineCode">related_name</code>, the reverse relationship for child models will be <code class="inlineCode">text_related</code>, <code class="inlineCode">file_related</code>, <code class="inlineCode">image_related</code>, and <code class="inlineCode">video_related</code>, respectively.</p>
<p class="normal">You have defined four different <code class="inlineCode">Content</code> models that inherit from the <code class="inlineCode">ItemBase</code> abstract model. They are as follows:</p>
<ul>
<li class="bulletList"><code class="inlineCode">Text</code>: To store text content</li>
<li class="bulletList"><code class="inlineCode">File</code>: To store files, such as PDFs</li>
<li class="bulletList"><code class="inlineCode">Image</code>: To store image files</li>
<li class="bulletList"><code class="inlineCode">Video</code>: To store videos; you use a <code class="inlineCode">URLField</code> field to provide a video URL in order to embed it</li>
</ul>
<p class="normal">Each child model contains the fields defined in the <code class="inlineCode">ItemBase</code> class in addition to its own fields. A database table will be <a id="_idIndexMarker1133"/>created for the <code class="inlineCode">Text</code>, <code class="inlineCode">File</code>, <code class="inlineCode">Image</code>, and <code class="inlineCode">Video</code> models, respectively. There will be no database table associated with the <code class="inlineCode">ItemBase</code> model since it is an abstract model.</p>
<p class="normal"><em class="italic">Figure 12.7</em> shows the <code class="inlineCode">Content</code> models and the associated database tables:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_12_07.png"/></figure>
<p class="packt_figref">Figure 12.7: Content models and associated database tables</p>
<p class="normal">Edit the <code class="inlineCode">Content</code> model you created previously and modify its <code class="inlineCode">content_type</code> field, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">content_type = models.ForeignKey(
        ContentType,
        on_delete=models.CASCADE,
<strong class="hljs-slc">        limit_choices_to={</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'model__in'</strong><strong class="hljs-slc">:(</strong><strong class="hljs-string-slc">'text'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'video'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'image'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'file'</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">        }</strong>
    )
</code></pre>
<p class="normal">You add a <code class="inlineCode">limit_choices_to</code> argument to<a id="_idIndexMarker1134"/> limit the <code class="inlineCode">ContentType</code> objects that can be used for the generic relation. You use the <code class="inlineCode">model__in</code> field lookup to filter the query to the <code class="inlineCode">ContentType</code> objects <a id="_idIndexMarker1135"/>with a <code class="inlineCode">model</code> attribute that is <code class="inlineCode">'text'</code>, <code class="inlineCode">'video'</code>, <code class="inlineCode">'image'</code>, or <code class="inlineCode">'file'</code>.</p>
<p class="normal">Let’s create a migration to include the new models you have added. Run the following command from the command line:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py makemigrations
</code></pre>
<p class="normal">You will see the following output:</p>
<pre class="programlisting con"><code class="hljs-con">Migrations for 'courses':
  courses/migrations/0002_video_text_image_file_content.py
    - Create model Video
    - Create model Text
    - Create model Image
    - Create model File
    - Create model Content
</code></pre>
<p class="normal">Then, run the following command to apply the new migration:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py migrate
</code></pre>
<p class="normal">The output you see should end with the following line:</p>
<pre class="programlisting con"><code class="hljs-con">Applying courses.0002_video_text_image_file_content... OK
</code></pre>
<p class="normal">You have created models that are suitable for adding diverse content to the course modules. However, there is still something missing in your models: the course modules and contents should<a id="_idIndexMarker1136"/> follow a particular order. You need a field that allows you to order them easily.</p>
<h2 class="heading-2" id="_idParaDest-345">Creating custom model fields</h2>
<p class="normal">Django comes with a complete collection of model fields that you can use to build your models. However, you can<a id="_idIndexMarker1137"/> also create your own model fields to store custom data or alter the behavior of existing fields. Custom fields allow <a id="_idIndexMarker1138"/>you to store unique data types, implement custom validations, encapsulate complex data logic related to the field, or define specific rendering forms using custom widgets.</p>
<p class="normal">You need a field that allows you to define an order for the objects. An easy way to specify an order for objects using existing Django fields is by adding a <code class="inlineCode">PositiveIntegerField</code> to your models. Using integers, you can easily specify the order of the objects. You can create a custom order field that inherits from <code class="inlineCode">PositiveIntegerField</code> and provides additional behavior.</p>
<p class="normal">There are two relevant functionalities that you will build into your order field:</p>
<ul>
<li class="bulletList"><strong class="keyWord">Automatically assign an order value when no specific order is provided</strong>: When saving a new object with no specific order, your field should automatically assign the number that comes after the last existing ordered object. If there are two objects with orders <code class="inlineCode">1</code> and <code class="inlineCode">2</code> respectively, when saving a third object, you should automatically assign order <code class="inlineCode">3</code> to it if no specific order has been provided.</li>
<li class="bulletList"><strong class="keyWord">Order objects with respect to other fields</strong>: Course modules will be ordered with respect to the course they belong to and module contents with respect to the module they belong to.</li>
</ul>
<p class="normal">Create a new <code class="inlineCode">fields.py</code> file inside the <code class="inlineCode">courses</code> application directory and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.core.exceptions import ObjectDoesNotExist
from django.db import models
class OrderField(models.PositiveIntegerField):
    def __init__(self, for_fields=None, *args, **kwargs):
        self.for_fields = for_fields
        super().__init__(*args, **kwargs)
    def pre_save(self, model_instance, add):
        if getattr(model_instance, self.attname) is None:
            # no current value
try:
                qs = self.model.objects.all()
                if self.for_fields:
                    # filter by objects with the same field values
# for the fields in "for_fields"
                    query = {
                        field: getattr(model_instance, field)
                        for field in self.for_fields
                    }
                    qs = qs.filter(**query)
                # get the order of the last item
                last_item = qs.latest(self.attname)
                value = getattr(last_item, self.attname) + 1
except ObjectDoesNotExist:
                value = 0
setattr(model_instance, self.attname, value)
            return value
        else:
            return super().pre_save(model_instance, add)
</code></pre>
<p class="normal">This is the custom <code class="inlineCode">OrderField</code>. It inherits from the <code class="inlineCode">PositiveIntegerField</code> field provided by Django. Your <code class="inlineCode">OrderField</code> field takes an optional <code class="inlineCode">for_fields</code> parameter, which allows you to indicate the<a id="_idIndexMarker1139"/> fields used to order the data.</p>
<p class="normal">Your field overrides the <code class="inlineCode">pre_save()</code> method of the <code class="inlineCode">PositiveIntegerField</code> field, which is executed before saving<a id="_idIndexMarker1140"/> the field to the database. In this method, you perform the following actions:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">You check whether a value already exists for this field in the model instance. You use <code class="inlineCode">self.attname</code>, which is the attribute name given to the field in the model. If the attribute’s value is different from <code class="inlineCode">None</code>, you calculate the order you should give it as follows:<ol class="alphabeticList" style="list-style-type: lower-alpha;">
<li class="alphabeticList" value="1">You build a QuerySet to retrieve all objects for the field’s model. You retrieve the model class the field belongs to by accessing <code class="inlineCode">self.model</code>.</li>
<li class="alphabeticList">If there are any field names in the <code class="inlineCode">for_fields</code> attribute of the field, you filter the QuerySet by the current value of the model fields in <code class="inlineCode">for_fields</code>. By doing so, you calculate the order with respect to the given fields.</li>
<li class="alphabeticList">You retrieve the object with the highest order with <code class="inlineCode">last_item = qs.latest(self.attname)</code> from the database. If no object is found, you assume this object is the first one and assign order <code class="inlineCode">0</code> to it.</li>
<li class="alphabeticList">If an object is found, you add <code class="inlineCode">1</code> to the highest order found.</li>
<li class="alphabeticList">You assign the calculated order to the field’s value in the model instance using <code class="inlineCode">setattr()</code> and return it.</li>
</ol>
</li>
<li class="numberedList">If the model instance <a id="_idIndexMarker1141"/>has a value for<a id="_idIndexMarker1142"/> the current field, you use it instead of calculating it.</li>
</ol>
<div><p class="normal">When you create custom model fields, make them generic. Avoid hardcoding data that depends on a specific model or field. Your field should work in any model.</p>
</div>
<p class="normal">You can find more information about writing custom model fields at <a href="https://docs.djangoproject.com/en/5.0/howto/custom-model-fields/">https://docs.djangoproject.com/en/5.0/howto/custom-model-fields/</a>.</p>
<p class="normal">Next, we are going to use the custom field we have created.</p>
<h2 class="heading-2" id="_idParaDest-346">Adding ordering to Module and Content objects</h2>
<p class="normal">Let’s add the new field to your <a id="_idIndexMarker1143"/>models. Edit the <code class="inlineCode">models.py</code> file of the <code class="inlineCode">courses</code> application, and import the <code class="inlineCode">OrderField</code> class and a field to the <code class="inlineCode">Module</code> model, as follows:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> .fields </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> OrderField</strong>
class Module(models.Model):
    # ...
<strong class="hljs-slc">    order = OrderField(blank=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">, for_fields=[</strong><strong class="hljs-string-slc">'course'</strong><strong class="hljs-slc">])</strong>
</code></pre>
<p class="normal">You name the new field <code class="inlineCode">order</code> and specify that the ordering is calculated with respect to the course by setting <code class="inlineCode">for_fields=['course']</code>. This means that the order for a new module will be assigned by adding <code class="inlineCode">1</code> to the last module of the same <code class="inlineCode">Course</code> object.</p>
<p class="normal">Now, you can edit the <code class="inlineCode">__str__()</code> method of the <code class="inlineCode">Module</code> model to include its order, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">class Module(models.Model):
    # ...
def __str__(self):
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc">f'</strong><strong class="hljs-subst-slc">{self.order}</strong><strong class="hljs-string-slc">. </strong><strong class="hljs-subst-slc">{self.title}</strong><strong class="hljs-string-slc">'</strong>
</code></pre>
<p class="normal">Module contents also need to follow a particular order. Add an <code class="inlineCode">OrderField</code> field to the <code class="inlineCode">Content</code> model, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">class Content(models.Model):
    # ...
<strong class="hljs-slc">    order = OrderField(blank=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">, for_fields=[</strong><strong class="hljs-string-slc">'module'</strong><strong class="hljs-slc">])</strong>
</code></pre>
<p class="normal">This time, you specify that the order is calculated with respect to the <code class="inlineCode">module</code> field.</p>
<p class="normal">Finally, let’s add a default <a id="_idIndexMarker1144"/>ordering for both models. Add the following <code class="inlineCode">Meta</code> class to the <code class="inlineCode">Module</code> and <code class="inlineCode">Content</code> models:</p>
<pre class="programlisting code"><code class="hljs-code">class Module(models.Model):
    # ...
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Meta</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">        ordering = [</strong><strong class="hljs-string-slc">'order'</strong><strong class="hljs-slc">]</strong>
class Content(models.Model):
    # ...
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Meta</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">        ordering = [</strong><strong class="hljs-string-slc">'order'</strong><strong class="hljs-slc">]</strong>
</code></pre>
<p class="normal">The <code class="inlineCode">Module</code> and <code class="inlineCode">Content</code> models should now look as follows:</p>
<pre class="programlisting code"><code class="hljs-code">class Module(models.Model):
    course = models.ForeignKey(
        Course, related_name='modules', on_delete=models.CASCADE
    )
    title = models.CharField(max_length=200)
    description = models.TextField(blank=True)
    order = OrderField(blank=True, for_fields=['course'])
    class Meta:
        ordering = ['order']
    def __str__(self):
        return f'{self.order}. {self.title}'
class Content(models.Model):
    module = models.ForeignKey(
        Module,
        related_name='contents',
        on_delete=models.CASCADE
    )
    content_type = models.ForeignKey(
        ContentType,
        on_delete=models.CASCADE,
        limit_choices_to={
            'model__in':('text', 'video', 'image', 'file')
        }
    )
    object_id = models.PositiveIntegerField()
    item = GenericForeignKey('content_type', 'object_id')
    order = OrderField(blank=True, for_fields=['module'])
    class Meta:
            ordering = ['order']
</code></pre>
<p class="normal">Let’s create a new <a id="_idIndexMarker1145"/>model migration that reflects the new <code class="inlineCode">order</code> fields. Open the shell and run the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py makemigrations courses
</code></pre>
<p class="normal">You will see the following output:</p>
<pre class="programlisting con"><code class="hljs-con">It is impossible to add a non-nullable field 'order' to content without specifying a default. This is because the database needs something to populate existing rows.
Please select a fix:
 1) Provide a one-off default now (will be set on all existing rows with a null value for this column)
 2) Quit and manually define a default value in models.py.
Select an option:
</code></pre>
<p class="normal">Django is telling you that you have to provide a default value for the new <code class="inlineCode">order</code> field for existing rows in the database. If the field includes <code class="inlineCode">null=True</code>, it accepts null values and Django creates the migration automatically instead of asking for a default value. You can specify a default value or cancel the migration and add a <code class="inlineCode">default</code> attribute to the <code class="inlineCode">order</code> field in the <code class="inlineCode">models.py</code> file <a id="_idIndexMarker1146"/>before creating the migration.</p>
<p class="normal">Enter <code class="inlineCode">1</code> and press <em class="italic">Enter</em> to provide a default value for existing records. You will see the following output:</p>
<pre class="programlisting con"><code class="hljs-con">Please enter the default value as valid Python.
The datetime and django.utils.timezone modules are available, so it is possible to provide e.g. timezone.now as a value.
Type 'exit' to exit this prompt
&gt;&gt;&gt;
</code></pre>
<p class="normal">Enter <code class="inlineCode">0</code> so that this is the default value for existing records and press <em class="italic">Enter</em>. Django will ask you for a default value for the <code class="inlineCode">Module</code> model, too. Choose the first option and enter <code class="inlineCode">0</code> as the default value again. Finally, you will see an output similar to the following one:</p>
<pre class="programlisting con"><code class="hljs-con">Migrations for 'courses':
courses/migrations/0003_alter_content_options_alter_module_options_and_more.py
    - Change Meta options on content
    - Change Meta options on module
    - Add field order to content
    - Add field order to module
</code></pre>
<p class="normal">Then, apply the new migrations with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py migrate
</code></pre>
<p class="normal">The output of the command will inform you that the migration was successfully applied, as follows:</p>
<pre class="programlisting con"><code class="hljs-con">Applying courses.0003_alter_content_options_alter_module_options_and_more... OK
</code></pre>
<p class="normal">Let’s test your new field. Open the shell with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py shell
</code></pre>
<p class="normal">Create a new course, as follows:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; from django.contrib.auth.models import User
&gt;&gt;&gt; from courses.models import Subject, Course, Module
&gt;&gt;&gt; user = User.objects.last()
&gt;&gt;&gt; subject = Subject.objects.last()
&gt;&gt;&gt; c1 = Course.objects.create(subject=subject, owner=user, title='Course 1', slug='course1')
</code></pre>
<p class="normal">You have created a course in the database. Now, you will add modules to the course and see how their order is automatically calculated. You create an initial module and check its order:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; m1 = Module.objects.create(course=c1, title='Module 1')
&gt;&gt;&gt; m1.order
0
</code></pre>
<p class="normal"><code class="inlineCode">OrderField</code> sets its value to <code class="inlineCode">0</code> since<a id="_idIndexMarker1147"/> this is the first <code class="inlineCode">Module</code> object created for the given course. You can create a second module for the same course:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; m2 = Module.objects.create(course=c1, title='Module 2')
&gt;&gt;&gt; m2.order
1
</code></pre>
<p class="normal"><code class="inlineCode">OrderField</code> calculates the next order value, adding <code class="inlineCode">1</code> to the highest order for existing objects. Let’s create a third module, forcing a specific order:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; m3 = Module.objects.create(course=c1, title='Module 3', order=5)
&gt;&gt;&gt; m3.order
5
</code></pre>
<p class="normal">If you provide a custom order when creating or saving an object, <code class="inlineCode">OrderField</code> will use that value instead of calculating the order.</p>
<p class="normal">Let’s add a fourth module:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; m4 = Module.objects.create(course=c1, title='Module 4')
&gt;&gt;&gt; m4.order
6
</code></pre>
<p class="normal">The order for this module has been automatically set. Your <code class="inlineCode">OrderField</code> field does not guarantee that all order values are consecutive. However, it respects existing order values and always assigns the next order based on the highest existing order.</p>
<p class="normal">Let’s create a second<a id="_idIndexMarker1148"/> course and add a module to it:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; c2 = Course.objects.create(subject=subject, title='Course 2', slug='course2', owner=user)
&gt;&gt;&gt; m5 = Module.objects.create(course=c2, title='Module 1')
&gt;&gt;&gt; m5.order
0
</code></pre>
<p class="normal">To calculate the new module’s order, the field only takes into consideration existing modules that belong to the same course. Since this is the first module of the second course, the resulting order is <code class="inlineCode">0</code>. This is because you specified <code class="inlineCode">for_fields=['course']</code> in the <code class="inlineCode">order</code> field of the <code class="inlineCode">Module</code> model.</p>
<p class="normal">Congratulations! You have successfully created your first custom model field. Next, you are going to create an authentication system for the CMS.</p>
<h1 class="heading-1" id="_idParaDest-347">Adding authentication views</h1>
<p class="normal">Now that you have <a id="_idIndexMarker1149"/>created a polymorphic data model, you are going to build a CMS to manage the courses and their contents. The first step is to add an authentication system for the CMS.</p>
<h2 class="heading-2" id="_idParaDest-348">Adding an authentication system</h2>
<p class="normal">You are going to use Django’s authentication <a id="_idIndexMarker1150"/>framework for users to authenticate to the e-learning platform. You learned how to use the Django authentication views in <em class="italic">Chapter 4, Building a Social Website</em>.</p>
<p class="normal">Both instructors and students will<a id="_idIndexMarker1151"/> be instances of Django’s <code class="inlineCode">User</code> model, so they will be able to log in to the site using the authentication views of <code class="inlineCode">django.contrib.auth</code>.</p>
<p class="normal">Edit the main <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">educa</code> project and include the <code class="inlineCode">login</code> and <code class="inlineCode">logout</code> views of Django’s authentication framework:</p>
<pre class="programlisting code"><code class="hljs-code">from django.conf import settings
from django.conf.urls.static import static
from django.contrib import admin
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.contrib.auth </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> views </strong><strong class="hljs-keyword-slc">as</strong><strong class="hljs-slc"> auth_views</strong>
from django.urls import path
urlpatterns = [
<strong class="hljs-slc">    path(</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'accounts/login/'</strong><strong class="hljs-slc">, auth_views.LoginView.as_view(), name=</strong><strong class="hljs-string-slc">'login'</strong>
<strong class="hljs-slc">    ),</strong>
<strong class="hljs-slc">    path(</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'accounts/logout/'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        auth_views.LogoutView.as_view(),</strong>
<strong class="hljs-slc">        name=</strong><strong class="hljs-string-slc">'logout'</strong>
<strong class="hljs-slc">    ),</strong>
    path('admin/', admin.site.urls),
]
if settings.DEBUG:
    urlpatterns += static(
        settings.MEDIA_URL, document_root=settings.MEDIA_ROOT
    )
</code></pre>
<p class="normal">Next, we are going to create<a id="_idIndexMarker1152"/> the authentication templates for <a id="_idIndexMarker1153"/>the Django authentication views.</p>
<h2 class="heading-2" id="_idParaDest-349">Creating the authentication templates</h2>
<p class="normal">Create the following file <a id="_idIndexMarker1154"/>structure inside the <code class="inlineCode">courses</code> application <a id="_idIndexMarker1155"/>directory:</p>
<pre class="programlisting con"><code class="hljs-con">templates/
    base.html
    registration/
        login.html
        logged_out.html
</code></pre>
<p class="normal">Before building the authentication templates, you need to prepare the base template for your project. Edit the <code class="inlineCode">base.html</code> template file and add the following content to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% load static %}
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta charset="utf-8" /&gt;
&lt;title&gt;{% block title %}Educa{% endblock %}&lt;/title&gt;
&lt;link href="{% static "css/base.css" %}" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div id="header"&gt;
&lt;a href="/" class="logo"&gt;Educa&lt;/a&gt;
&lt;ul class="menu"&gt;
        {% if request.user.is_authenticated %}
          &lt;li&gt;
&lt;form action="{% url "logout" %}" method="post"&gt;
&lt;button type="submit"&gt;Sign out&lt;/button&gt;
&lt;/form&gt;
&lt;/li&gt;
        {% else %}
          &lt;li&gt;&lt;a href="{% url "login" %}"&gt;Sign in&lt;/a&gt;&lt;/li&gt;
        {% endif %}
      &lt;/ul&gt;
&lt;/div&gt;
&lt;div id="content"&gt;
      {% block content %}
      {% endblock %}
    &lt;/div&gt;
&lt;script&gt;
 document.addEventListener('DOMContentLoaded', (event) =&gt; {
 // DOM loaded
        {% block domready %}
        {% endblock %}
      })
 &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p class="normal">This is the base template<a id="_idIndexMarker1156"/> that will be extended by the rest of the templates. In this template, you define the following <a id="_idIndexMarker1157"/>blocks:</p>
<ul>
<li class="bulletList"><code class="inlineCode">title</code>: The block for other templates to add a custom title for each page.</li>
<li class="bulletList"><code class="inlineCode">content</code>: The main block for content. All templates that extend the base template should add content to this block.</li>
<li class="bulletList"><code class="inlineCode">domready</code>: Located inside the JavaScript event listener for the <code class="inlineCode">DOMContentLoaded</code> event. This allows you to execute code when the <strong class="keyWord">Document Object Model</strong> (<strong class="keyWord">DOM</strong>) has finished<a id="_idIndexMarker1158"/> loading.</li>
</ul>
<p class="normal">The CSS styles used in this template are located in the <code class="inlineCode">static/</code> directory of the <code class="inlineCode">courses</code> application in the code that comes<a id="_idIndexMarker1159"/> with this chapter. Copy the <code class="inlineCode">static/</code> directory into the same directory of your project to use them. You can find the contents of the directory at <a href="https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter12/educa/courses/static">https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter12/educa/courses/static</a>.</p>
<p class="normal">Edit the <code class="inlineCode">registration/login.html</code> template <a id="_idIndexMarker1160"/>and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Log-in{% endblock %}
{% block content %}
  &lt;h1&gt;Log-in&lt;/h1&gt;
&lt;div class="module"&gt;
    {% if form.errors %}
      &lt;p&gt;Your username and password didn't match. Please try again.&lt;/p&gt;
    {% else %}
      &lt;p&gt;Please, use the following form to log-in:&lt;/p&gt;
    {% endif %}
    &lt;div class="login-form"&gt;
&lt;form action="{% url 'login' %}" method="post"&gt;
        {{ form.as_p }}
        {% csrf_token %}
        &lt;input type="hidden" name="next" value="{{ next }}" /&gt;
&lt;p&gt;&lt;input type="submit" value="Log-in"&gt;&lt;/p&gt;
&lt;/form&gt;
&lt;/div&gt;
&lt;/div&gt;
{% endblock %}
</code></pre>
<p class="normal">This is a standard login template for Django’s <code class="inlineCode">login</code> view.</p>
<p class="normal">Edit the <code class="inlineCode">registration/logged_out.html</code> template and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Logged out{% endblock %}
{% block content %}
  &lt;h1&gt;Logged out&lt;/h1&gt;
&lt;div class="module"&gt;
&lt;p&gt;
      You have been successfully logged out.
      You can &lt;a href="{% url "login" %}"&gt;log-in again&lt;/a&gt;.
     &lt;/p&gt;
&lt;/div&gt;
{% endblock %}
</code></pre>
<p class="normal">This is the template that<a id="_idIndexMarker1161"/> will be displayed to the user after logging out. Run the development server with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/accounts/login/</code> in your browser. You should see the login page:</p>
<figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="img/B21088_12_08.png"/></figure>
<p class="packt_figref">Figure 12.8: The account login page</p>
<p class="normal">Log in with the superuser credentials. You will be redirected to the URL <code class="inlineCode">http://127.0.0.1:8000/accounts/profile/</code>, which is the default redirect URL for the <code class="inlineCode">auth</code> module. You will get an HTTP <code class="inlineCode">404</code> response because the given URL doesn’t exist yet. The URL to redirect users after a successful login is defined in the setting <code class="inlineCode">LOGIN_REDIRECT_URL</code>. You will define a custom redirect URL in <em class="italic">Chapter 14, Rendering and Caching Content</em>.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/accounts/login/</code> again in your browser. Now, you should see the <strong class="screenText">Sign out</strong> button<a id="_idIndexMarker1162"/> in the header of the page. Click on the <strong class="screenText">Sign out</strong> button. You should see the <strong class="screenText">Logged out</strong> page now, as shown in <em class="italic">Figure 12.9</em>:</p>
<figure class="mediaobject"><img alt="Text  Description automatically generated" src="img/B21088_12_09.png"/></figure>
<p class="packt_figref">Figure 12.9: The account Logged out page</p>
<p class="normal">You have successfully <a id="_idIndexMarker1163"/>created an authentication system for the CMS.</p>
<h1 class="heading-1" id="_idParaDest-350">Summary</h1>
<p class="normal">In this chapter, you learned how to use fixtures to provide initial data for models. By using model inheritance, you created a flexible system to manage different types of content for the course modules. You also implemented a custom model field on order objects and created an authentication system for the e-learning platform.</p>
<p class="normal">In the next chapter, you will implement the CMS functionality to manage course contents using class-based views. You will use the Django groups and permissions system to restrict access to views, and you will implement formsets to edit the content of courses. You will also create a drag-and-drop functionality to reorder course modules and their content using JavaScript and Django.</p>
<h1 class="heading-1" id="_idParaDest-351">Additional resources</h1>
<p class="normal">The following resources provide additional information related to the topics covered in this chapter:</p>
<ul>
<li class="bulletList">Source code for this chapter: <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter12">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter12</a></li>
<li class="bulletList">Using Django fixtures for testing: <a href="https://docs.djangoproject.com/en/5.0/topics/testing/tools/#fixture-loading">https://docs.djangoproject.com/en/5.0/topics/testing/tools/#fixture-loading</a></li>
<li class="bulletList">Data migrations: <a href="https://docs.djangoproject.com/en/5.0/topics/migrations/#data-migrations">https://docs.djangoproject.com/en/5.0/topics/migrations/#data-migrations</a></li>
<li class="bulletList">Class inheritance in Python: <a href="https://docs.python.org/3/tutorial/classes.html#inheritance ">https://docs.python.org/3/tutorial/classes.html#inheritance</a></li>
<li class="bulletList">Django model inheritance: <a href="https://docs.djangoproject.com/en/5.0/topics/db/models/#model-inheritance">https://docs.djangoproject.com/en/5.0/topics/db/models/#model-inheritance</a></li>
<li class="bulletList">Creating custom model fields: <a href="https://docs.djangoproject.com/en/5.0/howto/custom-model-fields/">https://docs.djangoproject.com/en/5.0/howto/custom-model-fields/</a></li>
<li class="bulletList">Static directory for the e-learning project: <a href="https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter12/educa/courses/static ">https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter12/educa/courses/static</a></li>
</ul>
<h1 class="heading-1" id="_idParaDest-352">Join us on Discord!</h1>
<p class="normal">Read this book alongside other users, Django development experts, and the author himself. Ask questions, provide solutions to other readers, chat with the author via Ask Me Anything sessions, and much more.Scan the QR code or visit the link to join the community.</p>
<p class="normal"><a href="https://packt.link/Django5ByExample">https://packt.link/Django5ByExample</a></p>
<p class="normal"><img alt="" role="presentation" src="img/QR_Code287089408934129031.png"/></p>
</div>
</body></html>