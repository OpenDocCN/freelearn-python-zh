<html><head></head><body>
		<div><h1 id="_idParaDest-265" class="chapter-number"><a id="_idTextAnchor330"/>15</h1>
			<h1 id="_idParaDest-266"><a id="_idTextAnchor331"/>Deploying Our React App on AWS</h1>
			<p>In the previous chapter, we automated the deployment of the Django application using GitHub Actions and by making some configurations on the AWS EC2 instance. The Postagram API is live and now we must deploy the React application to have the full Postagram application available on the internet.</p>
			<p>In this chapter, we will deploy the React application using AWS <strong class="bold">Simple Storage Service</strong> (<strong class="bold">S3</strong>) and automate the deployment using GitHub Actions. We will cover the following topics:</p>
			<ul>
				<li>Deployment of React applications</li>
				<li>Deploying on AWS S3</li>
				<li>Automating deployment with GitHub Actions</li>
			</ul>
			<h1 id="_idParaDest-267"><a id="_idTextAnchor332"/>Technical requirements</h1>
			<p>For this chapter, you will need to have an account on AWS. You will also need to create an <strong class="bold">Identity and Access Management</strong> (<strong class="bold">IAM</strong>) user and save the credentials. You can do this by following the official documentation at <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html#id_users_create_cliwpsapi">https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html#id_users_create_cliwpsapi</a>. You can find the code for this chapter at <a href="https://github.com/PacktPublishing/Full-stack-Django-and-React/tree/chap15">https://github.com/PacktPublishing/Full-stack-Django-and-React/tree/chap15</a>.</p>
			<h1 id="_idParaDest-268"><a id="_idTextAnchor333"/>Deployment of React applications</h1>
			<p>A <a id="_idIndexMarker826"/>React application is built using JavaScript and JSX. However, to make the application accessible on the internet, we need a version of the application that a browser can interpret and understand, basically having an application with HTML, CSS, and JavaScript.</p>
			<p>In development mode, React provides an environment for detecting warnings and tools to detect and fix problems in the application and eliminate potential issues. This adds extra code to the project, increasing the bundle size and resulting in a bigger and slower application.</p>
			<p>It is crucial to only<a id="_idIndexMarker827"/> deploy production-built applications on the internet because of<a id="_idIndexMarker828"/> the <strong class="bold">user experience</strong> (<strong class="bold">UX</strong>). According to Google studies, <em class="italic">53% of users leave a website if it takes more than 3 seconds to load</em>. Thus, we must build the React application we created and deploy the production version.</p>
			<h2 id="_idParaDest-269"><a id="_idTextAnchor334"/>What is a production build?</h2>
			<p>In development, the React application<a id="_idIndexMarker829"/> runs in development mode or local mode. This is where you can see all the warnings and the traceback in case your code crashes. The production mode requires the developers to build the application. This build minifies the code, optimizes the assets (image, CSS files, and so on), produces lighter source maps, and suppresses the warning messages displayed in development mode.</p>
			<p>Therefore, the bundle size of the application is drastically reduced, and this improves page load speed. In this chapter, we will build a production-ready application and deploy it on AWS S3 as a static website.</p>
			<h1 id="_idParaDest-270"><a id="_idTextAnchor335"/>Deploying on AWS S3</h1>
			<p><strong class="bold">AWS S3</strong> is <a id="_idIndexMarker830"/>one of the most popular services of AWS. It is a cloud-based storage service providing high performance, availability, reliability, security, and a ridiculous potential for scaling. AWS S3 is mostly used to store static assets so that they are effectively distributed to the internet, and because of the distribution characteristic, AWS S3 is suitable for hosting static websites.</p>
			<p>In this chapter, we will create an S3 bucket, upload the content of the built React application, and allow public access from the internet. An <strong class="bold">S3 bucket</strong> is<a id="_idIndexMarker831"/> just a public storage resource available in AWS that is like an online folder where you can store objects (like a folder on your Google Drive). In the next section, we will create a production-ready version of the React application.</p>
			<h2 id="_idParaDest-271"><a id="_idTextAnchor336"/>Creating a build of Postagram</h2>
			<p>We can create a bui<a id="_idTextAnchor337"/>ld of the React application with just one command:</p>
			<pre class="console">
Yarn build</pre>
			<p>The <code>yarn build</code> command creates a bundle of static files of a React application. This bundle is <a id="_idIndexMarker832"/>optimized enough to go into production. The production <a id="_idIndexMarker833"/>Postagram application will use the online version of the API. This means we need to make some readjustments in the React code, mainly concerning the API URLs used in the code.</p>
			<p>In <em class="italic">Part 2</em> of this book, <em class="italic">Build Reactive UI with React</em>, we built the React application using data from the localhost server at port <code>8000</code>. In this chapter, it won’t be the case, and we will take the occasion to add environment variables to the React application. Integrating environment variables into a React application is straightforward. Let’s configure the environment variables in the Postagram React application.</p>
			<h2 id="_idParaDest-272"><a id="_idTextAnchor338"/>Adding environment variables and building the application</h2>
			<p>According to the<a id="_idIndexMarker834"/> documentation of <em class="italic">Create React App</em> regarding environment variables (<a href="https://create-react-app.dev/docs/adding-custom-environment-variables/">https://create-react-app.dev/docs/adding-custom-environment-variables/</a>),</p>
			<p class="author-quote">“Your project can consume variables declared in your environment as if they were declared locally in your JS files. By default, you will have NODE_ENV defined for you, and any other environment variables starting with REACT_APP_”.</p>
			<p>To <a id="_idIndexMarker835"/>access the values of the environment variables, we will use <code>process.env.REACT_APP_VALUE</code> syntax because these environment variables are defined on <code>process.env</code>.</p>
			<p>At the root of the React project, crea<a id="_idTextAnchor339"/>te a file called <code>.env</code>. Inside this file, add the following content and the name of the API URL you have deployed on the EC2 AWS server:</p>
			<pre class="source-code">
REACT_APP_API_URL=https://name_of_EC2_instance.compute-1.amazonaws.com/api</pre>
			<p>You then need to modify some pieces of code at <code>src/helpers/axios.js</code> and <code>src/hooks/user.actio<a id="_idTextAnchor340"/>ns.js</code>. We must update the <code>baseURL</code> variable to read the values from the <code>.</code><code>env</code> file:</p>
			<p class="SC---Heading" lang="en-US" xml:lang="en-US">src/hooks/user.actions.js</p>
			<pre class="source-code">
function useUserActions() {
 const navigate = useNavigate();
 const baseURL = process.env.REACT_APP_API_URL;
 return {
   login,
   register,
   logout,
   edit,
 };</pre>
			<p>And we <a id="_idIndexMarker836"/>do the <a id="_idIndexMarker837"/>same on the <code>axios.js</code> file:</p>
			<p class="SC---Heading" lang="en-US" xml:lang="en-US">src/helpers/axios.js</p>
			<pre class="source-code">
const axiosService = axios.create({
 baseURL: process.env.REACT_APP_API_URL,
 headers: {
   "Content-Type": "application/json",
 },
});
…
const refreshAuthLogic = async (failedRequest) =&gt; {
 return axios
   .post(
     "/auth/refresh/",
     {
       refresh: getRefreshToken(),
     },
     {
       baseURL: process.env.REACT_APP_API_URL,
...</pre>
			<p>Great! The <a id="_idIndexMarker838"/>application can be built now. Run the <a id="_idIndexMarker839"/>following command:</p>
			<pre class="console">
yarn build</pre>
			<p>You will have a similar result to this:</p>
			<div><div><img src="img/Figure_15.01_B18221.jpg" alt="Figure 15.1 – Output of yarn build command"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.1 – Output of yarn build command</p>
			<p>The build is available in the newly created <code>build</code> directory, where you will find the following content:</p>
			<div><div><img src="img/Figure_15.02_B18221.jpg" alt="Figure 15.2 – build direc﻿tory"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.2 – build direc<a id="_idTextAnchor341"/>tory</p>
			<p>With a <a id="_idIndexMarker840"/>production-ready React application, we <a id="_idIndexMarker841"/>can then deploy the application on S3. Next,<a id="_idTextAnchor342"/> let’s create an S3 bucket and upload the files and folders.</p>
			<h2 id="_idParaDest-273"><a id="_idTextAnchor343"/>Deploying the React application on S3</h2>
			<p>We have <a id="_idIndexMarker842"/>a build-ready version of the application and<a id="_idIndexMarker843"/> an optimized version for production. Before deploying on S3, we need to make some configurations on AWS S3 by creating a bucket and telling AWS that we are going to serve a static website. In the AWS console menu, choose the S3 service and create a bucket. Follow these steps to deploy a React application on AWS using the S3 service:</p>
			<ol>
				<li>You will need to enter some configurations such as the <strong class="bold">Bucket name</strong> value and others, as shown in the following figure:</li>
			</ol>
			<div><div><img src="img/Figure_15.03_B18221.jpg" alt="Figure 15.3 – General configuration for AWS S3 bucket"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.3 – General configuration for AWS S3 bucket</p>
			<ol>
				<li value="2">After that, you<a id="_idIndexMarker844"/> need to disable the <strong class="bold">Block all public access</strong> settings<a id="_idIndexMarker845"/> so that the React application is visible to the public:</li>
			</ol>
			<div><div><img src="img/Figure_15.04_B18221.jpg" alt="Figure 15.4 – Public access configuration"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.4 – Public access configuration</p>
			<ol>
				<li value="3">With the <a id="_idIndexMarker846"/>basic configurations now done, you<a id="_idIndexMarker847"/> can proceed to create the S3 bucket. Access the newly created bucket, select the <strong class="bold">Properties</strong> tab, and go to <strong class="bold">Static website hosting</strong>. On the page, enable <strong class="bold">Static </strong><strong class="bold">web hosting</strong>:</li>
			</ol>
			<div><div><img src="img/Figure_15.05_B18221.jpg" alt="Figure 15.5 – Static website hosting configuration"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.5 – Static website hosting configuration</p>
			<ol>
				<li value="4">You should<a id="_idIndexMarker848"/> also fill in the <strong class="bold">Index document</strong> and <strong class="bold">Error document</strong> fields. This will help with routing in the React application. Save<a id="_idIndexMarker849"/> the change, and you will see the bucket website endpoint, which will be the URL of your website:</li>
			</ol>
			<div><div><img src="img/Figure_15.06_B18221.jpg" alt="Figure 15.6 – Static website hosting configuration done"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.6 – Static website hosting configuration done</p>
			<ol>
				<li value="5">Finally, select <a id="_idIndexMarker850"/>the <strong class="bold">Permissions</strong> tab and<a id="_idIndexMarker851"/> select <strong class="bold">Bucket Policy</strong>. We will add a policy to grant public access to the bucket, like so:<pre class="source-code">
{</pre><pre class="source-code">
    "Version": "2012-10-17",</pre><pre class="source-code">
    "Statement": [</pre><pre class="source-code">
        {</pre><pre class="source-code">
            "Sid": "Statement1",</pre><pre class="source-code">
            "Effect": "Allow",</pre><pre class="source-code">
            "Principal": {</pre><pre class="source-code">
                "AWS": "*"</pre><pre class="source-code">
            },</pre><pre class="source-code">
            "Action": "s3:GetObject",</pre><pre class="source-code">
            "Resource": "arn:aws:s3:::postagram/*"</pre><pre class="source-code">
        }</pre><pre class="source-code">
    ]</pre><pre class="source-code">
}</pre></li>
			</ol>
			<p>In your case, replace Postagram with the name of your React application.</p>
			<ol>
				<li value="6">Save the<a id="_idIndexMarker852"/> changes. You will notice that a piece of <a id="_idIndexMarker853"/>new information will appear next to the name of the bucket:</li>
			</ol>
			<div><div><img src="img/Figure_15.07_B18221.jpg" alt="Figure 15.7 – Publicly accessible badge"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.7 – Publicly accessible badge</p>
			<ol>
				<li value="7">Now, click on the <code>build</code> directory of the React application. After the upload is finished, you will have a similar result to this:</li>
			</ol>
			<div><div><img src="img/Figure_15.08_B18221.jpg" alt="Figure 15.8 – Bucket content"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.8 – Bucket content</p>
			<ol>
				<li value="8">Click on the bucket website endpoint, and you will access the Postagram React application in your browser:</li>
			</ol>
			<div><div><img src="img/Figure_15.09_B18221.jpg" alt="Figure 15.9 – Deployed React application&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.9 – Deployed React application</p>
			<p>Great! We have <a id="_idIndexMarker854"/>deployed a React application on AWS using the <a id="_idIndexMarker855"/>S3 service. You will surely encounter <code>CORS_ALLOW_ORIGINS</code> environment variables in the <code>.env</code> file of the Django application on the AWS EC2 instance. The following is an example of how you can define the environment variable:</p>
			<p class="SC---Heading" lang="en-US" xml:lang="en-US">.env</p>
			<pre class="source-code">
CORS_ALLOW_ORIGINS="S3_WEBSITE_URL"</pre>
			<p>Then, in the <code>settings.py</code> file of the Django project, replace the line where you define <code>CORS_ALLOW_ORIGINS</code> with the following:</p>
			<p class="SC---Heading" lang="en-US" xml:lang="en-US">CoreRoot/settings.py</p>
			<pre class="console">
...
CORS_ALLOWED_ORIGINS = os.getenv("CORS_ALLOWED_ORIGINS", "").split(",")
...</pre>
			<p>We have learned how to configure a bucket, change the policies for public access, and activate the website hosting feature of AWS S3. However, the deployment was done manually and, in the future, if you are pushing regularly, it might be a hassle to upload the change manually every time. In the next section, we will explore how to automate the deployment of a React application using GitHub Actions.</p>
			<h1 id="_idParaDest-274"><a id="_idTextAnchor344"/>Automating deployment with GitHub Actions</h1>
			<p>In the previous chapter, we explored how GitHub Actions make the flow of deployment easier, more secure, and more reliable for developers. That is why in this chap<a id="_idTextAnchor345"/>ter, we are also using <a id="_idIndexMarker857"/>GitHub Actions to automate the deployment of the React application.</p>
			<p>There is a GitHub action for AWS called <code>configure-aws-credentials</code>. We will use this action to configure AWS credentials in the workflow to execute a command to upload the content of the <code>build</code> folder in the S3 bucket created earlier. But before that, we will follow the same workflow of CI/CD:</p>
			<ol>
				<li value="1">Install the dependencies of the project.</li>
				<li>Run tests to make sure the application won’t break in production and to ensure there are no regressions.</li>
				<li>Run the <code>build</code> command to have a production-ready application.</li>
				<li>Deploy on AWS S3.</li>
			</ol>
			<p>Let’s add a new workflow file in the repository for the deployment of the React application.</p>
			<p class="callout-heading">Important note</p>
			<p class="callout">For this book, the Django application and the React application are in the same repository. The choice was made to make it easier for you to go through the code and the project. Thus, you will find two workflows in the <code>.github/workflows</code> directory. If you have split the code of the Django application and the React project into different repositories, make sure to not mix the GitHub Actions files.</p>
			<h2 id="_idParaDest-275"><a id="_idTextAnchor346"/>Writing the workflow file</h2>
			<p>Inside the <code>.github/workflows</code> directory, create a file called <code>deploy-frontend.yml</code>. The first <a id="_idIndexMarker858"/>step, <a id="_idTextAnchor347"/>as usual, when writing a GitHub Actions file is to define the name of the workflow and the condition that will trigger this workflow:</p>
			<p class="SC---Heading" lang="en-US" xml:lang="en-US">.github/workflows/deploy-frontend.yml</p>
			<pre class="source-code">
name: Build and deploy frontend
on:
 push:
   branches: [ main ]</pre>
			<p>Let’s then create a job called <code>build-test-deploy</code>. Inside this job, we will write the commands to install the React dependencies, run the tests, build the project, and deploy the application to S3. Let’s start by injecting the environment variables:</p>
			<p class="SC---Heading" lang="en-US" xml:lang="en-US">.github/workflows/deploy-frontend.yml</p>
			<pre class="source-code">
jobs:
 build-test-deploy:
   name: Tests
   runs-on: ubuntu-latest
   defaults:
     run:
       working-directory: ./social-media-react
   steps:
     - uses: actions/checkout@v2
     - name: Injecting environment variables
       run: echo "REACT_APP_API_URL=${{ secrets.API_URL }}"
            &gt;&gt; .env</pre>
			<p>We can now add the commands to install the dependencies, run the tests, and build the application:</p>
			<p class="SC---Heading" lang="en-US" xml:lang="en-US"> .github/workflows/deploy-frontend.yml</p>
			<pre class="source-code">
     - name: Installing dependencies
       run: yarn install
     - name: Running tests
       run: yarn test
     - name: Building project
       run: yarn build</pre>
			<p>And we can add the <a id="_idIndexMarker859"/>AWS credentials action to configure the AWS credentials in the workflow and run the command to deploy to S3:</p>
			<p class="SC---Heading" lang="en-US" xml:lang="en-US">.github/workflows/deploy-frontend.yml</p>
			<pre class="source-code">
     - name: Configure AWS Credentials
       uses: aws-actions/configure-aws-credentials@v1
       with:
         aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID
                             }}
         aws-secret-access-key:
           ${{ secrets.AWS_SECRET_ACCESS_KEY }}
         aws-region: us-west-1
     - name: Deploy to S3 bucket
       run: aws s3 sync ./build/ s3://postagram --delete</pre>
			<p>In the last command, we are uploading the content of the <code>build</code> directory to the Postagram bucket. While using this configuration, ensure to use the na<a id="_idTextAnchor348"/>me of your S3 bucket. The GitHub actions file is written and can be deployed. Commit the changes and push them to the GitHub repository.</p>
			<p>Congratulations! You <a id="_idIndexMarker860"/>have deployed a React application to AWS S3 using GitHub Actions.</p>
			<p>We have successfully deployed the full-stack application we have been building in this book. We have deployed the Django API application on an AWS instance, deployed the React frontend on AWS S3, and automated CI/CD pipelines using GitHub Actions. However, before going fully live, we need to make some optimization on the backend and the frontend, secure the deployed version of the applications on AWS using HTTPS, and talk more about caching and SQL query optimization.</p>
			<h1 id="_idParaDest-276"><a id="_idTextAnchor349"/>Summary</h1>
			<p>In this cha<a id="_idTextAnchor350"/>pter, we have deployed the frontend React application on AWS. We have explored the AWS S3 service created and developed by AWS for storing objects on the internet. We have learned how to add environment variables to a React application but also how to have a production-ready bundle by building the application.</p>
			<p>The production bundle has been used for deployment on AWS S3 using a bucket and configuring the bucket for static website hosting. And to make the deployment process smooth, we have created a GitHub action to automate the CI/CD pipeline for the React frontend project from building and testing to deploying the application on AWS S3.</p>
			<p>In the next chapter, we will focus on the optimization of the Django API and the React frontend by optimizing queries, adding caching, adding a logout endpoint, and securing the communication between servers and the client using HTTPS.</p>
			<h1 id="_idParaDest-277"><a id="_idTextAnchor351"/>Questions</h1>
			<ol>
				<li value="1">What is AWS S3?</li>
				<li>How to create an IAM user on AWS?</li>
				<li>What is the command used to build a React application?</li>
				<li>Where are the environment variables in a Node.js project retrieved from?</li>
			</ol>
		</div>
		<div><div></div>
		</div>
	</body></html>