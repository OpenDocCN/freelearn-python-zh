<html><head></head><body>
		<div id="_idContainer046">
			<h1 id="_idParaDest-184" class="chapter-number"><a id="_idTextAnchor238"/>5</h1>
			<h1 id="_idParaDest-185"><a id="_idTextAnchor239"/>Basic Server-Side Development</h1>
			<p>We learned how to declare or extend business models in custom modules in <a href="B20997_04.xhtml#_idTextAnchor118"><span class="No-Break"><em class="italic">Chapter 4</em></span></a>, <em class="italic">Application Models</em>. Writing methods for calculated fields and ways to restrict the field values are both addressed in that chapter’s tutorials. This chapter focuses on the fundamentals of server-side programming in Odoo method declarations, record set manipulation, and extending inherited methods. You may use this to create or alter business logins in the <span class="No-Break">Odoo module.</span></p>
			<p>In this chapter, we will cover the <span class="No-Break">following tutorials:</span></p>
			<ul>
				<li>Specifying model methods and implementing <span class="No-Break">API decorators</span></li>
				<li>Notifying errors to <span class="No-Break">the user</span></li>
				<li>Getting a blank recordset for a <span class="No-Break">different model</span></li>
				<li>Creating <span class="No-Break">new records</span></li>
				<li>Updating values of <span class="No-Break">recordset records</span></li>
				<li>Searching <span class="No-Break">for records</span></li>
				<li><span class="No-Break">Combining recordsets</span></li>
				<li><span class="No-Break">Filtering recordsets</span></li>
				<li>Traversing <span class="No-Break">recordset relations</span></li>
				<li><span class="No-Break">Sorting recordsets</span></li>
				<li>Extending a model’s established <span class="No-Break">business logic</span></li>
				<li>Extending <strong class="source-inline">write()</strong> <span class="No-Break">and </span><span class="No-Break"><strong class="source-inline">create()</strong></span></li>
				<li>Customizing how records <span class="No-Break">are searched</span></li>
				<li>Fetching data in groups <span class="No-Break">using </span><span class="No-Break"><strong class="source-inline">read_group()</strong></span></li>
			</ul>
			<h1 id="_idParaDest-186"><a id="_idTextAnchor240"/>Technical requirements</h1>
			<p>The online platform for Odoo is one of the prerequisites for <span class="No-Break">this chapter.</span></p>
			<p>You can obtain all the code used in this chapter from the following GitHub <span class="No-Break">repository: </span><a href="https://github.com/PacktPublishing/Odoo-17-Development-Cookbook-Fifth-Edition/tree/main/Chapter05"><span class="No-Break">https://github.com/PacktPublishing/Odoo-17-Development-Cookbook-Fifth-Edition/tree/main/Chapter05</span></a></p>
			<h1 id="_idParaDest-187"><a id="_idTextAnchor241"/>Specifying model methods and using API decorators</h1>
			<p>A class in Odoo models consists of both business logic methods and field declarations. We learned <a id="_idIndexMarker281"/>how to add fields to a model in <a href="B20997_04.xhtml#_idTextAnchor118"><span class="No-Break"><em class="italic">Chapter 4</em></span></a>, <em class="italic">Application Models</em>. We will now see how to include business logic and methods in <span class="No-Break">a model.</span></p>
			<p>In this tutorial, we’ll learn <a id="_idIndexMarker282"/>how to create a function that may be used by our application’s user interface buttons or another piece of code. This method will operate on <strong class="source-inline">HostelRoom</strong> and take the necessary steps to modify the state of a number <span class="No-Break">of rooms<a id="_idTextAnchor242"/>.</span></p>
			<h2 id="_idParaDest-188"><a id="_idTextAnchor243"/>Getting ready</h2>
			<p>This tutorial assumes that you have an instance ready, with the <strong class="source-inline">my_hostel</strong> add-on module available, as described in <a href="B20997_03.xhtml#_idTextAnchor083"><span class="No-Break"><em class="italic">Chapter 3</em></span></a>, <em class="italic">Creating Odoo Add-On Modules</em>. You will need to add a <strong class="source-inline">state</strong> field to the <strong class="source-inline">HostelRoom</strong> model, which is defined <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
from odoo import api, fields, models
class HostelRoom(models.Model):
    # [...]
    state = fields.Selection([
        ('draft', 'Unavailable'),
        ('available', 'Available'),
        ('closed', 'Closed')],
        'State', default="draft")</pre>			<p>Refer to the <em class="italic">Adding models</em> tutorial in <a href="B20997_03.xhtml#_idTextAnchor083"><span class="No-Break"><em class="italic">Chapter 3</em></span></a>, <em class="italic">Creating Odoo Add-On Modules</em>, for <span class="No-Break">more information.</span></p>
			<h2 id="_idParaDest-189"><a id="_idTextAnchor244"/>How to do it…</h2>
			<p>To define a <a id="_idIndexMarker283"/>method for hostel rooms to change the state of a <a id="_idIndexMarker284"/>selection of rooms, you need to add the following code to the <span class="No-Break">model definition:</span></p>
			<ol>
				<li>Add a helper method to check whether a state transition <span class="No-Break">is allowed:</span><pre class="source-code">
    @api.model
    def is_allowed_transition(self, old_state, new_state):
        allowed = [('draft', 'available'),
                   ('available', 'closed'),
                   ('closed', 'draft')]
        return (old_state, new_state) in allowed</pre></li>				<li>Add a method to change the state of a  room to a new state that is passed as <span class="No-Break">an argument:</span><pre class="source-code">
    def change_state(self, new_state):
        for room in self:
            if room.is_allowed_transition(room.state,\ 
            new_state):
                room.state = new_state
            else:
                continue</pre></li>				<li>Add a method to change the room state by calling the <span class="No-Break"><strong class="source-inline">change_state</strong></span><span class="No-Break"> method:</span><pre class="source-code">
    def make_available(self):
        self.change_state('available')
    def make_closed(self):
        self.change_state('closed')</pre></li>				<li>Add a button <a id="_idIndexMarker285"/>and status bar in the <strong class="source-inline">&lt;form&gt;</strong> view. This will <a id="_idIndexMarker286"/>help us trigger these methods from the <span class="No-Break">user interface:</span><pre class="source-code">
&lt;form&gt;
...
    &lt;button name="make_available" string="Make Available" type="object"/&gt;
    &lt;button name="make_closed" string="Make Borrowed" type="object"/&gt;
    &lt;field name="state" widget="statusbar"/&gt;
...
&lt;/form&gt;</pre></li>			</ol>
			<p>To access these updates, you must update the module or <span class="No-Break">install it.</span></p>
			<h2 id="_idParaDest-190"><a id="_idTextAnchor245"/>How it works…</h2>
			<p>Several methods are defined in the tutorial’s code. They are typical Python methods with <strong class="source-inline">self</strong> as their first argument and the option of receiving additional arguments. The <strong class="source-inline">odoo.api</strong> module’s <strong class="bold">decorators</strong> are used to adorn <span class="No-Break">some methods.</span></p>
			<p class="callout-heading">TIP</p>
			<p class="callout">In Odoo 9.0, the API decorators were first added to support both the old and new frameworks. The previous API is no longer supported as of Odoo 10.0, however, some decorators, such <strong class="source-inline">@api.model</strong>, are still <span class="No-Break">in use.</span></p>
			<p>When writing a new method, if you don’t use a decorator, then the method is executed on a recordset. In such methods, <strong class="source-inline">self</strong> is a recordset that can refer to an arbitrary number of database records (this includes empty recordsets), and the code will often loop over the records in <strong class="source-inline">self</strong> to do something on each <span class="No-Break">individual record.</span></p>
			<p>The <strong class="source-inline">@api.model</strong> decorator is similar, but it’s used on methods for which only the model is important, not the contents of the recordset, which is not acted upon by the method. The concept is similar to Python’s <strong class="source-inline">@</strong><span class="No-Break"><strong class="source-inline">classmethod</strong></span><span class="No-Break"> decorator.</span></p>
			<p>In <em class="italic">Step 1</em>, we created the <strong class="source-inline">is_allowed_transition()</strong> method. The purpose of this method is to verify whether a transition from one state to another is valid. The tuples in the <strong class="source-inline">allowed</strong> list are the available transitions. For example, we don’t want to allow a transition from <strong class="source-inline">closed</strong> to <strong class="source-inline">available</strong>, which is why we haven’t put <strong class="source-inline">('</strong><span class="No-Break"><strong class="source-inline">closed, 'available')</strong></span><span class="No-Break">.</span></p>
			<p>In <em class="italic">Step 2</em>, we created the <strong class="source-inline">change_state()</strong> method. The purpose of this method is to change the <a id="_idIndexMarker287"/>status of the room. When this method is called, it changes <a id="_idIndexMarker288"/>the status of the room to the state given by the <strong class="source-inline">new_state</strong> parameter. It only changes the room status if the transition is allowed. We used a <strong class="source-inline">for</strong> loop here because <strong class="source-inline">self</strong> can contain <span class="No-Break">multiple recordsets.</span></p>
			<p>In <em class="italic">Step 3</em>, we created the methods that change the state of the room by calling the <strong class="source-inline">change_state()</strong> method. In our case, this method will be triggered by the buttons that were added to the <span class="No-Break">user interface.</span></p>
			<p>In <em class="italic">Step 4</em>, we added <strong class="source-inline">&lt;button&gt;</strong> in the <strong class="source-inline">&lt;form&gt;</strong> view. Upon clicking this button, the Odoo web client will invoke the Python function mentioned in the <strong class="source-inline">name</strong> attribute. Refer to the <em class="italic">Adding buttons to forms</em> tutorial in <a href="B20997_09.xhtml#_idTextAnchor446"><span class="No-Break"><em class="italic">Chapter 9</em></span></a>, <em class="italic">Backend Views</em>, to learn how to call such a method from the user interface. We have also added the <strong class="source-inline">state</strong> field with the <strong class="source-inline">statusbar</strong> widget to display the status of the room in the <strong class="source-inline">&lt;</strong><span class="No-Break"><strong class="source-inline">form&gt;</strong></span><span class="No-Break"> view.</span></p>
			<p>When the user clicks on the button from the user interface, one of the methods from <em class="italic">Step 3</em> will be called. Here, <strong class="source-inline">self</strong> will be the recordset that contains the record of the <strong class="source-inline">hostel.room</strong> model. After that, we call the <strong class="source-inline">change_state()</strong> method and pass the appropriate parameter based on the button that <span class="No-Break">was clicked.</span></p>
			<p>When <strong class="source-inline">change_state()</strong> is called, <strong class="source-inline">self</strong> is the same recordset of the <strong class="source-inline">hostel.room</strong> model. The body of the <strong class="source-inline">change_state()</strong> method loops over <strong class="source-inline">self</strong> to process each room in the recordset. Looping on <strong class="source-inline">self</strong> looks strange at first, but you will get used to this pattern <span class="No-Break">very quickly.</span></p>
			<p>Inside the loop, <strong class="source-inline">change_state()</strong> calls <strong class="source-inline">is_allowed_transition()</strong>. The call is made using the <strong class="source-inline">room</strong> local variable, but it can be made on any recordset for the <strong class="source-inline">hostel.room</strong> model, including, for example, <strong class="source-inline">self</strong>, since <strong class="source-inline">is_allowed_transition()</strong> is decorated with <strong class="source-inline">@api.model</strong>. If the transition is allowed, <strong class="source-inline">change_state()</strong> assigns the new state to the room by assigning a value to the attribute of the recordset. This is only valid on recordsets with a length of <strong class="source-inline">1</strong>, which is guaranteed to be the case when iterating <span class="No-Break">over </span><span class="No-Break"><strong class="source-inline">self</strong></span><span class="No-Break">.</span></p>
			<h1 id="_idParaDest-191"><a id="_idTextAnchor246"/>Reporting errors to the user</h1>
			<p>Sometimes, it’s required to stop processing during method execution because the user’s activity is invalid <a id="_idIndexMarker289"/>or an error condition has been satisfied. By displaying an informative error message, this tutorial demonstrates how to handle <span class="No-Break">these situations.</span></p>
			<p>The <strong class="source-inline">UserError</strong> exception is commonly utilized to inform users about errors or exceptional situations. It is typically employed when the user’s input fails to meet the expected criteria or when a particular operation cannot be executed due to <span class="No-Break">specific conditions.</span></p>
			<h2 id="_idParaDest-192"><a id="_idTextAnchor247"/>Getting ready</h2>
			<p>This tutorial requires that you set up an instance with the <strong class="source-inline">my_hostel</strong> add-on module installed, as per the instructions <span class="No-Break">from before.</span></p>
			<h2 id="_idParaDest-193"><a id="_idTextAnchor248"/>How to do it…</h2>
			<p>We will make a change to the <strong class="source-inline">change_state</strong> method from the previous tutorial and display a helpful message when the user is trying to change the state that is not allowed by the <strong class="source-inline">is_allowed_transition</strong> method. Perform the following steps to <span class="No-Break">get started:</span></p>
			<ol>
				<li>Add the following import at the beginning of the <span class="No-Break">Python file:</span><pre class="source-code">
from odoo.exceptions import UserError
from odoo.tools.translate import _</pre></li>				<li>Modify the <strong class="source-inline">change_state</strong> method and raise a <strong class="source-inline">UserError</strong> exception from the <span class="No-Break"><strong class="source-inline">else</strong></span><span class="No-Break"> part:</span><pre class="source-code">
def change_state(self, new_state):
    for room in self:
        if room.is_allowed_transition(room.state, new_state):
            room.state = new_state
        else:
            msg = _('Moving from %s to %s is not
allowed') % (room.state, new_state)
            raise UserError(msg)</pre></li>			</ol>
			<h2 id="_idParaDest-194"><a id="_idTextAnchor249"/>How it works…</h2>
			<p>When an <a id="_idIndexMarker290"/>exception is raised in Python, it propagates up the call stack until <a id="_idIndexMarker291"/>it is processed. In Odoo, the <strong class="bold">remote procedure call</strong> (<strong class="bold">RPC</strong>) layer that answers the calls made by the web client catches all exceptions and, depending on the exception class, triggers different possible behaviors on the <span class="No-Break">web client.</span></p>
			<p>Any exception not defined in <strong class="source-inline">odoo.exceptions</strong> will be handled as an internal server error (<strong class="bold">HTTP status</strong> <strong class="bold">500</strong>) with the stack trace. <strong class="source-inline">UserError</strong> will display an error message in the user interface. The code of the tutorial raises <strong class="source-inline">UserError</strong> to ensure that the message is displayed in a user-friendly way. In all cases, the current database transaction is <span class="No-Break">rolled back.</span></p>
			<p>We are using a function with a strange name, <strong class="source-inline">_()</strong>, which is defined in <strong class="source-inline">odoo.tools.translate</strong>. This function is used to mark a string as translatable and to retrieve the translated string at runtime, given the language of the end user that’s found in the execution context. More information on this is available in <a href="B20997_11.xhtml#_idTextAnchor595"><span class="No-Break"><em class="italic">Chapter </em></span><span class="No-Break"><em class="italic">11</em></span></a><span class="No-Break">, </span><span class="No-Break"><em class="italic">Internationalisation</em></span><span class="No-Break">.</span></p>
			<p class="callout-heading">Important note</p>
			<p class="callout">When using the <strong class="source-inline">_()</strong> function, ensure that you pass only strings with the interpolation placeholder, not the whole interpolated string. For example, <strong class="source-inline">_('Warning: could not find %s') % value</strong> is correct, but <strong class="source-inline">_('Warning: could not find %s' % value)</strong> is incorrect because the first one will not find the string with the substituted value in the <span class="No-Break">translation database.</span></p>
			<h2 id="_idParaDest-195"><a id="_idTextAnchor250"/>There’s more…</h2>
			<p>Sometimes, you are working on error-prone code, meaning that the operation you are performing may generate an error. Odoo will catch this error and display a traceback to the user. If you don’t want to show a full error log to the user, you can catch the error and raise a custom <a id="_idIndexMarker292"/>exception with a meaningful message. In the example provided, we are generating <strong class="source-inline">UserError</strong> from the <strong class="source-inline">try...catch</strong> block so that instead of showing a full error log, Odoo will now show a warning with a <span class="No-Break">meaningful message:</span></p>
			<pre class="source-code">
def post_to_webservice(self, data):
    try:
        req = requests.post('http://my-test-service.com', data=data, timeout=10)
        content = req.json()
    except IOError:
        error_msg = _("Something went wrong during data submission")
        raise UserError(error_msg)
    return content</pre>			<p>There are a few more exception classes defined in <strong class="source-inline">odoo.exceptions</strong>, all deriving from the base legacy <strong class="source-inline">except_orm</strong> exception class. Most of them are only used internally, apart from <span class="No-Break">the following:</span></p>
			<ul>
				<li><strong class="source-inline">ValidationError</strong>: This exception is raised when a Python constraint on a field is not respected. In <a href="B20997_04.xhtml#_idTextAnchor118"><span class="No-Break"><em class="italic">Chapter 4</em></span></a>, <em class="italic">Application Models</em>, refer to the <em class="italic">Adding constraint validations to a model</em> tutorial for <span class="No-Break">more information.</span></li>
				<li><strong class="source-inline">AccessError</strong>: This error is usually generated automatically when the user tries to access something that is not allowed. You can raise the error manually if you want to show the access error from <span class="No-Break">your code.</span></li>
				<li><strong class="source-inline">RedirectWarning</strong>: With this error, you can show a redirection button with the error message. You need to pass two parameters to this exception: the first parameter is <a id="_idIndexMarker293"/>the action ID, and the second parameter is the <span class="No-Break">error message.</span></li>
				<li><strong class="source-inline">Warning</strong>: In Odoo 8.0, <strong class="source-inline">odoo.exceptions.Warning</strong> played the same role as <strong class="source-inline">UserError</strong> in 9.0 and later. It is now deprecated because the name was deceptive (it is an error, not a warning) and it collided with the Python built-in <strong class="source-inline">Warning</strong> class. It is kept for backward compatibility only, and you should use <strong class="source-inline">UserError</strong> in <span class="No-Break">your code.</span></li>
			</ul>
			<h1 id="_idParaDest-196"><a id="_idTextAnchor251"/>Obtaining an empty recordset for a different model</h1>
			<p>The current model’s methods are accessible through <strong class="source-inline">self</strong> while creating Odoo code. It is not <a id="_idIndexMarker294"/>feasible to start working on a different model by simply instantiating its class; you must first obtain a recordset for <span class="No-Break">that model.</span></p>
			<p>This tutorial shows you how to get an empty recordset for any model that’s registered in Odoo inside a <span class="No-Break">model method.</span></p>
			<h2 id="_idParaDest-197"><a id="_idTextAnchor252"/>Getting ready</h2>
			<p>This tutorial will reuse the setup of the library example in the <strong class="source-inline">my_hostel</strong> <span class="No-Break">add-on module.</span></p>
			<p>We will write a small method in the <strong class="source-inline">hostel.room</strong> model and search for all <strong class="source-inline">hostel.room.members</strong>. To do this, we need to get an empty recordset for <strong class="source-inline">hostel.room.members</strong>. Make sure you have added the <strong class="source-inline">hostel.room.members</strong> model and access rights for <span class="No-Break">that model.</span></p>
			<h2 id="_idParaDest-198"><a id="_idTextAnchor253"/>How to do it…</h2>
			<p>To get a recordset for <strong class="source-inline">hostel.room.members</strong> in a method of <strong class="source-inline">hostel.room</strong>, you need to perform the <span class="No-Break">following steps:</span></p>
			<div>
				<div id="_idContainer041" class="IMG---Figure">
					<img src="image/B20997_05_1.jpg" alt="Figure 5.1 – log_all_room_members"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.1 – log_all_room_members</p>
			<ol>
				<li>In <a id="_idIndexMarker295"/>the <strong class="source-inline">HostelRoom</strong> class, write a method <a id="_idIndexMarker296"/><span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">log_all_room_members</strong></span><span class="No-Break">:</span><pre class="source-code">
class HostelRoom(models.Model):
    # ...
    def log_all_room_members(self):
        # This is an empty recordset of model hostel.room.member
        hostel_room_obj = self.env['hostel.room.member']
        all_members = hostel_room_obj.search([])
        print("ALL MEMBERS:", all_members)
        return True</pre></li>				<li>Add a button to the <strong class="source-inline">&lt;form&gt;</strong> view to invoke <span class="No-Break">our method:</span><pre class="source-code">
&lt;button name="log_all_room_members"  string="Log Members" type="object"/&gt;</pre></li>			</ol>
			<p>Update the module to apply the changes. After that, you will see the <strong class="bold">Log Members</strong> button in the room’s <strong class="source-inline">&lt;form&gt;</strong> view. You may view the member’s recordset in the server log by clicking <span class="No-Break">that button.</span></p>
			<h2 id="_idParaDest-199"><a id="_idTextAnchor254"/>How it works…</h2>
			<p>At startup, Odoo loads <a id="_idIndexMarker297"/>all the modules and combines the various classes that derive from <strong class="source-inline">Model</strong>, and also defines or extends the given model. These classes are stored in the <strong class="bold">Odoo</strong> <strong class="bold">registry</strong>, indexed by name. The <strong class="source-inline">env</strong> attribute of any recordset, available as <strong class="source-inline">self.env</strong>, is an instance of the <strong class="source-inline">Environment</strong> class defined in the <span class="No-Break"><strong class="source-inline">odoo.api</strong></span><span class="No-Break"> module.</span></p>
			<p>The <strong class="source-inline">Environment</strong> class plays a central role in <span class="No-Break">Odoo development:</span></p>
			<ul>
				<li>It provides shortcut access to the registry by emulating a Python dictionary. If you know the name of the model you’re looking for, <strong class="source-inline">self.env[model_name]</strong> will get you an empty recordset for that model. Moreover, the recordset will share the environment <span class="No-Break">of </span><span class="No-Break"><strong class="source-inline">self</strong></span><span class="No-Break">.</span></li>
				<li>It has a <strong class="source-inline">cr</strong> attribute, which is a database cursor you may use to pass raw SQL queries. Refer to the <em class="italic">Executing raw SQL queries</em> tutorial in <a href="B20997_08.xhtml#_idTextAnchor388"><span class="No-Break"><em class="italic">Chapter 8</em></span></a>, <em class="italic">Advanced Server-Side Development Techniques</em>, for more information <span class="No-Break">on this.</span></li>
				<li>It has a <strong class="source-inline">user</strong> attribute, which is a reference to the current user performing the call. Take a look at <a href="B20997_08.xhtml#_idTextAnchor388"><span class="No-Break"><em class="italic">Chapter 8</em></span></a>, <em class="italic">Advanced Server-Side Development Techniques</em>, and the <em class="italic">Changing the user performing an action</em> tutorial for more <span class="No-Break">on this.</span></li>
				<li>It has a <strong class="source-inline">context</strong> attribute, which is a dictionary that contains the context of the call. This includes information about the language of the user, the time zone, and the current selection of records. Refer to the <em class="italic">Calling a method with a modified context</em> tutorial in <a href="B20997_08.xhtml#_idTextAnchor388"><span class="No-Break"><em class="italic">Chapter 8</em></span></a>, <em class="italic">Advanced Server-Side Development Techniques</em>, for more <span class="No-Break">on this.</span></li>
			</ul>
			<p>The call to <strong class="source-inline">search()</strong> is explained in the <em class="italic">Searching for records</em> <span class="No-Break">tutorial later.</span></p>
			<h2 id="_idParaDest-200"><a id="_idTextAnchor255"/>See also</h2>
			<p>Sometimes, you want to use a modified version of the environment. One such example is that you want an environment with a different user and language. In <a href="B20997_08.xhtml#_idTextAnchor388"><span class="No-Break"><em class="italic">Chapter 8</em></span></a>, <em class="italic">Advanced Server-Side Development Techniques</em>, you will learn how to modify the environment <span class="No-Break">at runtime.</span></p>
			<h1 id="_idParaDest-201"><a id="_idTextAnchor256"/>Creating new records</h1>
			<p>Creating new records is a regular requirement when putting business logic processes into practice. How you <a id="_idIndexMarker298"/>can build records for the <strong class="source-inline">hostel.room.category</strong> model is included in this tutorial. We’ll add a function to the <strong class="source-inline">hostel.room.category</strong> model to generate dummy categories for the purposes of our example. We will add  the <strong class="source-inline">&lt;form&gt;</strong> view to activate <span class="No-Break">this approach.</span></p>
			<h2 id="_idParaDest-202"><a id="_idTextAnchor257"/>Getting ready</h2>
			<p>You need to understand the structure of the models for which you want to create a record, especially their names and types, as well as any constraints that exist on these fields (for example, whether some of them <span class="No-Break">are mandatory).</span></p>
			<p>For this tutorial, we will reuse the <strong class="source-inline">my_hostel</strong> module from <a href="B20997_04.xhtml#_idTextAnchor118"><span class="No-Break"><em class="italic">Chapter 4</em></span></a>, <em class="italic">Application Models</em>. Take a look at the following example to quickly recall the <span class="No-Break"><strong class="source-inline">hostel.room<a id="_idTextAnchor258"/>.category</strong></span><span class="No-Break"> model:</span></p>
			<pre class="source-code">
class RoomCategory(models.Model):
    _name = 'hostel.room.category'
    _description = 'Hostel Room Category'
    name = fields.Char('Category')
    description = fields.Text('Description')
    parent_id = fields.Many2one(
        'hostel.room.category',
        string='Parent Category',
        ondelete='restrict',
        index=True
    )
    child_ids = fields.One2many(
        'hostel.room.category', 'parent_id',
        string='Child Categories')</pre>			<p>Make sure you <a id="_idIndexMarker299"/>have added menus, views, and access rights for the <span class="No-Break"><strong class="source-inline">hostel.room.category</strong></span><span class="No-Break"> model.</span></p>
			<h2 id="_idParaDest-203"><a id="_idTextAnchor259"/>How to do it…</h2>
			<p>To create a category with some child categories, you need to perform the <span class="No-Break">following steps:</span></p>
			<div>
				<div id="_idContainer042" class="IMG---Figure">
					<img src="image/B20997_05_2.jpg" alt="Figure 5.2 – Create a category"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 5.2 – Create a category</p>
			<ol>
				<li>Create a <a id="_idIndexMarker300"/>method in the <strong class="source-inline">hostel.room.category</strong> model with the <span class="No-Break">name </span><span class="No-Break"><strong class="source-inline">create_categories</strong></span><span class="No-Break">:</span><pre class="source-code">
def create_categories(self):
    ......</pre></li>				<li>Inside the body of this method, prepare a dictionary of values for the fields of the first <span class="No-Break">child category:</span><pre class="source-code">
categ1 = {
    'name': 'Child category 1',
    'description': 'Description for child 1'
}</pre></li>				<li>Prepare a dictionary of values for the fields of the <span class="No-Break">second category:</span><pre class="source-code">
categ2 = {
    'name': 'Child category 2',
    'description': 'Description for child 2'
}</pre></li>				<li>Prepare a <a id="_idIndexMarker301"/>dictionary of values for the fields of the <span class="No-Break">parent category:</span><pre class="source-code">
parent_category_val = {
    'name': 'Parent category',
    'description': 'Description for parent category',
    'child_ids': [
        (0, 0, categ1),
        (0, 0, categ2),
    ]
}</pre></li>				<li>Call the <strong class="source-inline">create()</strong> method to creat<a id="_idTextAnchor260"/>e the <span class="No-Break">new records:</span><pre class="source-code">
record = self.env['hostel.room.category'].create(parent_category_val)</pre></li>				<li>Add a button in the <strong class="source-inline">&lt;form&gt;</strong> view to trigger the <strong class="source-inline">create_categories</strong> method from t<a id="_idTextAnchor261"/>he <span class="No-Break">user interface:</span><pre class="source-code">
&lt;button name="create_categories" string="Create Categories" type="object"/&gt;</pre></li>			</ol>
			<h2 id="_idParaDest-204"><a id="_idTextAnchor262"/>How it works…</h2>
			<p>To add a new record for a model, we can call the <strong class="source-inline">create(values)</strong> method on any recordset related to the model. This method returns a new recordset with a length of <strong class="source-inline">1</strong> and contains the new record, with the field values specified in the <span class="No-Break"><strong class="source-inline">values</strong></span><span class="No-Break"> dictionary.</span></p>
			<p>The keys in the <a id="_idIndexMarker302"/>dictionary identify the fields by name, while the accompanying values reflect the field’s value. Depending on the field type, you need to pass different Python types for <span class="No-Break">the values:</span></p>
			<ul>
				<li>A <strong class="source-inline">Text</strong> field value is given with <span class="No-Break">Python strings.</span></li>
				<li>The <strong class="source-inline">Float</strong> and <strong class="source-inline">Integer</strong> field values are given using Python floats <span class="No-Break">or integers.</span></li>
				<li>A <strong class="source-inline">boolean</strong> field value is given preferably using Python Booleans <span class="No-Break">or integers.</span></li>
				<li>A <strong class="source-inline">Date</strong> field value is given with the Python <span class="No-Break"><strong class="source-inline">datetime.date</strong></span><span class="No-Break"> object.</span></li>
				<li>A <strong class="source-inline">Datetime</strong> field value is given with the Python <span class="No-Break"><strong class="source-inline">datetime.datetime</strong></span><span class="No-Break"> object.</span></li>
				<li>A <strong class="source-inline">Binary</strong> field value is passed as a Base64-encoded string. The <strong class="source-inline">base64</strong> module from the Python standard library provides methods such as <strong class="source-inline">encodebytes(bytestring)</strong> to encode a string <span class="No-Break">in Base64.</span></li>
				<li>A <strong class="source-inline">Many2one</strong> field value is given with an integer, which has to be the database ID of the <span class="No-Break">related record.</span></li>
				<li><strong class="source-inline">One2many</strong> and <strong class="source-inline">Many2many</strong> fields use a special syntax. The value is a list that contains tuples of three elements, <span class="No-Break">as follows:</span></li>
			</ul>
			<div>
				<div id="_idContainer043" class="IMG---Figure">
					<img src="image/B20997_05_3.jpg" alt="Table 5.1 – Relational field write"/>
				</div>
			</div>
			<p class="IMG---Figure">Table 5.1 – Relational field write</p>
			<p>In this tutorial, we create the dictionaries for two categories in the hostel room we want to create, and then we use these dictionaries in the <strong class="source-inline">child_ids</strong> entry of the dictionary for the hostel <a id="_idIndexMarker303"/>room categories being created by using the <strong class="source-inline">(0, 0, dict_val)</strong> syntax we <span class="No-Break">explained earlier.</span></p>
			<p>When <strong class="source-inline">create()</strong> is called in <em class="italic">Step 5</em>, three records <span class="No-Break">are created:</span></p>
			<ul>
				<li>One for the parent room category, which is returned <span class="No-Break">by </span><span class="No-Break"><strong class="source-inline">create</strong></span></li>
				<li>Two records for the child room category, which are available <span class="No-Break">in </span><span class="No-Break"><strong class="source-inline">record.child_ids</strong></span></li>
			</ul>
			<h2 id="_idParaDest-205"><a id="_idTextAnchor263"/>There’s more…</h2>
			<p>If the model defined some default values for some fields, nothing special needs to be done. <strong class="source-inline">create()</strong> will take care of computing the default values for the fields that aren’t present in the <span class="No-Break">supplied dictionary.</span></p>
			<p>The <strong class="source-inline">create()</strong> method also <a id="_idIndexMarker304"/>supports the creation of records in a batch. To create multiple records in a batch, you need to pass a list of multiple values to the <strong class="source-inline">create()</strong> method, as shown in the <span class="No-Break">following example:</span></p>
			<pre class="source-code">
categ1 = {
    'name': 'Category 1',
    'description': 'Description for Category 1'
}
categ2 = {
    'name': 'Category 2',
    'description': 'Description for Category 2'
}
multiple_records = self.env['hostel.room.category'].create([categ1, categ2])</pre>			<p>This code will return the recordset of created categories of the hostel <span class="No-Break">room category.</span></p>
			<h1 id="_idParaDest-206"><a id="_idTextAnchor264"/>Updating values of recordset records</h1>
			<p>Business logic <a id="_idIndexMarker305"/>often requires us to update records by changing the values of some of their fields. This tutorial shows you how to modify the <strong class="source-inline">room_no</strong> field of the partner as <span class="No-Break">we go.</span></p>
			<h2 id="_idParaDest-207"><a id="_idTextAnchor265"/>Getting ready</h2>
			<p>This tutorial will use the same simplified <strong class="source-inline">hostel.room</strong> definition of the <em class="italic">Creating new records</em> tutorial. You may refer to this simplified definition to find out about <span class="No-Break">the fields.</span></p>
			<p>We have the <strong class="source-inline">room_no</strong> field in the <strong class="source-inline">hostel.room</strong> model. For illustration purposes, we will write in this field with the click of <span class="No-Break">a button.</span></p>
			<h2 id="_idParaDest-208"><a id="_idTextAnchor266"/>How to do it…</h2>
			<ol>
				<li>To update a room’s <strong class="source-inline">room_no</strong> field, you can write a new method called <strong class="source-inline">update_room_no()</strong>, which is defined <span class="No-Break">as follows:</span><pre class="source-code">
def update_room_no(self):
<a id="_idTextAnchor267"/>    self.ensure_one()
    self.room_no = "RM002"</pre></li>				<li>Then, you can add a button to the room’s <strong class="source-inline">&lt;form&gt;</strong> vie<a id="_idTextAnchor268"/>w in <strong class="source-inline">xml</strong>, <span class="No-Break">as follows:</span><pre class="source-code">
&lt;button name="update_room_no" string="Update Room No" type="object"/&gt;</pre></li>				<li>Restart the server and update the <strong class="source-inline">my_hostel</strong> module to see the changes. Upon clicking the <strong class="bold">Update Room No</strong> button, <strong class="source-inline">room_no</strong> will <span class="No-Break">be changed.</span></li>
			</ol>
			<h2 id="_idParaDest-209"><a id="_idTextAnchor269"/>How it works…</h2>
			<p>The method starts by checking whether the room recordset that’s passed as <strong class="source-inline">self</strong> contains exactly one record by calling <strong class="source-inline">ensure_one()</strong>. If this is not the case, this procedure will generate an exception, and processing will stop. This is necessary because we don’t want to change the room number of multiple records. If you want to update multiple values, you can remove <strong class="source-inline">ensure_one()</strong> and update the attribute using a loop on <span class="No-Break">the recordset.</span></p>
			<p>Finally, the method <a id="_idIndexMarker306"/>modifies the values of the attributes of the room record. It updates the <strong class="source-inline">room_no</strong> field with the defined room number. Just by modifying the field attributes of the recordset, you can perform <span class="No-Break">write operations.</span></p>
			<h2 id="_idParaDest-210"><a id="_idTextAnchor270"/>There’s more…</h2>
			<p>There are three options available if you want to add new values to the fields <span class="No-Break">of records:</span></p>
			<ul>
				<li>Option one is the one that was explained in this tutorial. It works in all contexts by assigning values directly to the attribute representing the field of the record. It isn’t possible to assign a value to all recordset elements in one go, so, you need to iterate on the recordset, unless you are certain that you are only handling a <span class="No-Break">single record.</span></li>
				<li>Option two is to use the <strong class="source-inline">update()</strong> method by passing dictionary mapping field names to the values you want to set. This also only works for recordsets with a length of <strong class="source-inline">1</strong>. It can save some typing when you need to update the values of several fields at once on the same record. Here’s <em class="italic">Step 2</em> of the tutorial, rewritten to use <span class="No-Break">this option:</span><pre class="source-code">
def change_room_no(self):
    self.ensure_one()
    self.update({
        'room_no': "RM002",
        'another_field': 'value'
        ...
    })</pre></li>				<li>Option three is to call the <strong class="source-inline">write()</strong> method, passing a dictionary that maps the field names to the values you want to set. This method works for recordsets of arbitrary size and will update all records with the specified values in one single database operation when the two previous options perform one database call per record and per field. However, it has some limitations: it does not work if the records are not yet present in the database (refer to the <em class="italic">Writing on change methods</em> tutorial in <a href="B20997_08.xhtml#_idTextAnchor388"><span class="No-Break"><em class="italic">Chapter 8</em></span></a>, <em class="italic">Advanced Server-Side Development Techniques</em>, for more information on this). Also, it requires a special format when writing relational fields, similar to the one used by the <strong class="source-inline">create()</strong> method. Check the <a id="_idIndexMarker307"/>following table for the format that’s used to generate different values for the <span class="No-Break">relational fields:</span></li>
			</ul>
			<div>
				<div id="_idContainer044" class="IMG---Figure">
					<img src="image/B20997_05_4.jpg" alt="Table 5.2 – Relational field update"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 5.2 – Relational field update</p>
			<p class="callout-heading">Important note</p>
			<p class="callout">The <strong class="source-inline">1</strong>, <strong class="source-inline">2</strong>, <strong class="source-inline">3</strong>, and <strong class="source-inline">5</strong> operation types cannot be used with the <span class="No-Break"><strong class="source-inline">create()</strong></span><span class="No-Break"> method.</span></p>
			<h1 id="_idParaDest-211"><a id="_idTextAnchor271"/>Searching for records</h1>
			<p>Searching for <a id="_idIndexMarker308"/>records is also a common operation in business logic methods. There are many cases where we need to search the data based on different criteria. Finding the room by name and category is demonstrated in <span class="No-Break">this tutorial.</span></p>
			<h2 id="_idParaDest-212"><a id="_idTextAnchor272"/>Getting ready</h2>
			<p>This tutorial will use the same <strong class="source-inline">hostel.room</strong> definition as the <em class="italic">Creating new records</em> tutorial did previously. We will write the code in a method <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">find_room(self)</strong></span><span class="No-Break">.</span></p>
			<h2 id="_idParaDest-213"><a id="_idTextAnchor273"/>How to do it…</h2>
			<p>To find the <a id="_idIndexMarker309"/>rooms, you need to perform the <span class="No-Break">following steps:</span></p>
			<ol>
				<li>Add the <strong class="source-inline">find_room</strong> method to the <span class="No-Break"><strong class="source-inline">hostel.room</strong></span><span class="No-Break"> model:</span><pre class="source-code">
def find_room(self):
    ...</pre></li>				<li>Write the search domain for <span class="No-Break">your criteria:</span><pre class="source-code">
domain = [
    '|',
        '&amp;', ('name', 'ilike', 'Room Name'),
             ('category_id.name', 'ilike', 'Category Name'),
        '&amp;', ('name', 'ilike', 'Second Room Name 2'),
             ('category_id.name', 'ilike', 'SecondCategory Name 2')
]</pre></li>				<li>Call the <strong class="source-inline">search()</strong> method with the domain, which will return <span class="No-Break">the recordset:</span><pre class="source-code">
rooms = self.search(domain)</pre></li>			</ol>
			<p>The <strong class="source-inline">rooms</strong> variable will have a recordset of searched rooms. You can print or log that variable to see the result in the <span class="No-Break">server log.</span></p>
			<h2 id="_idParaDest-214"><a id="_idTextAnchor274"/>How it works…</h2>
			<p><em class="italic">Step 1</em> defines the method name prefixed with the <span class="No-Break"><strong class="source-inline">def</strong></span><span class="No-Break"> keyword.</span></p>
			<p><em class="italic">Step 2</em> creates a search domain in a local variable. Often, you’ll see this creation inline in the call to search, but with complex domains, it is good practice to define <span class="No-Break">it separately.</span></p>
			<p>For a full explanation of the search domain syntax, refer to the <em class="italic">Defining filters on record lists – domain</em> tutorial in <a href="B20997_09.xhtml#_idTextAnchor446"><span class="No-Break"><em class="italic">Chapter 9</em></span></a>, <span class="No-Break"><em class="italic">Backend Views</em></span><span class="No-Break">.</span></p>
			<p><em class="italic">Step 3</em> calls the <strong class="source-inline">search()</strong> method with the domain. The method returns a recordset that contains <a id="_idIndexMarker310"/>all the records that match the domain, which can then be processed further. In this tutorial, we call the method with just the domain, but the following keyword arguments are <span class="No-Break">also supported:</span></p>
			<ul>
				<li><strong class="source-inline">offset=N</strong>: This is <a id="_idIndexMarker311"/>used to skip the first <strong class="source-inline">N</strong> records that match the query. This can be used along with <strong class="source-inline">limit</strong> to implement pagination or to reduce memory consumption when processing a very large number of records. It defaults <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">0</strong></span><span class="No-Break">.</span></li>
				<li><strong class="source-inline">limit=N</strong>: This indicates <a id="_idIndexMarker312"/>that, at most, <strong class="source-inline">N</strong> records should be returned. By default, there is <span class="No-Break">no limit.</span></li>
				<li><strong class="source-inline">order=sort_specification</strong>: This is used to force the order in the recordset <a id="_idIndexMarker313"/>returned. By default, the order is given by the <strong class="source-inline">_order</strong> attribute of the <span class="No-Break">model class.</span></li>
				<li><strong class="source-inline">count=boolean</strong>: If <strong class="source-inline">True</strong>, this returns <a id="_idIndexMarker314"/>the number of records instead of the recordset. It defaults <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">False</strong></span><span class="No-Break">.</span></li>
			</ul>
			<p class="callout-heading">Important note</p>
			<p class="callout">We <a id="_idIndexMarker315"/>recommend using the <strong class="source-inline">search_count(domain)</strong> method rather than<em class="italic"> </em><strong class="source-inline">search(domain, count=True)</strong>, as the name of the method conveys the behavior in a much clearer way. Both will give the <span class="No-Break">same result.</span></p>
			<p>Sometimes, you need to search from another model so that searching for <strong class="source-inline">self</strong> will return a recordset of the current model. To search from another model, we need to get an empty recordset for the model. For example, let’s say we want to search for some contacts. To do that, we will <a id="_idIndexMarker316"/>need to use the <strong class="source-inline">search()</strong> method on the <strong class="source-inline">res.partner</strong> model. Refer to the following code. Here, we get the empty recordset of <strong class="source-inline">res.partner</strong> to search <span class="No-Break">the contacts:</span></p>
			<pre class="source-code">
def find_partner(self):
    PartnerObj = self.env['res.partner']
    domain = [
        '&amp;', ('name', 'ilike', 'SerpentCS'),
             ('company_id.name', '=', 'SCS')
    ]
    partner = PartnerObj.search(domain)</pre>			<p>In the preceding code, we have two conditions in the domain. You can omit the <strong class="source-inline">'&amp;'</strong> from the domain when you have two conditions to compare, because when you do not specify the domain; then, Odoo will take <strong class="source-inline">'&amp;'</strong> as <span class="No-Break">a default.</span></p>
			<h2 id="_idParaDest-215"><a id="_idTextAnchor275"/>There’s more…</h2>
			<p>We said previously that the <strong class="source-inline">search()</strong> method returned all the records matching the domain. This is not actually completely true. The security rules ensure that the user only gets those records to which they have <strong class="source-inline">read</strong> access rights. Additionally, if the model has a <strong class="source-inline">boolean</strong> field called <strong class="source-inline">active</strong> and no term of the search domain specifies a condition on that field, then an implicit condition is added by search to only return <strong class="source-inline">active=True</strong> records. So, if you expect a search to return something, but you only get empty recordsets, ensure that you check the value of the <strong class="source-inline">active</strong> field (if present) to check for <span class="No-Break">record rules.</span></p>
			<p>Refer to the <em class="italic">Calling a method with a different context</em> tutorial in <a href="B20997_08.xhtml#_idTextAnchor388"><span class="No-Break"><em class="italic">Chapter 8</em></span></a>, <em class="italic">Advanced Server-Side Development Techniques</em>, for a way to not have the implicit <strong class="source-inline">active=True</strong> condition added. Take a look at the <em class="italic">Limiting record access using record rules</em> tutorial in <a href="B20997_10.xhtml#_idTextAnchor549"><span class="No-Break"><em class="italic">Chapter 10</em></span></a>, <em class="italic">Security Access</em>, for more information about record-level <span class="No-Break">access rules.</span></p>
			<p>If, for some reason, you find yourself writing raw SQL queries to find record IDs, ensure that you use <strong class="source-inline">self.env['record.model'].search([('id', 'in', tuple(ids))]).ids</strong> after retrieving the IDs to ensure that security rules are applied. This is <a id="_idIndexMarker317"/>especially important in <strong class="bold">multi-company</strong> Odoo instances where the record rules are used to ensure proper discrimination <span class="No-Break">between companies.</span></p>
			<h1 id="_idParaDest-216"><a id="_idTextAnchor276"/>Combining recordsets</h1>
			<p>Sometimes, you will <a id="_idIndexMarker318"/>find that you have obtained recordsets that are not exactly what you need. This tutorial shows various ways of <span class="No-Break">combining them.</span></p>
			<h2 id="_idParaDest-217"><a id="_idTextAnchor277"/>Getting ready</h2>
			<p>To use this tutorial, you need to have two or more recordsets for the <span class="No-Break">same model.</span></p>
			<h2 id="_idParaDest-218"><a id="_idTextAnchor278"/>How to do it…</h2>
			<p>Follow these steps to perform common operations <span class="No-Break">on recordsets:</span></p>
			<ol>
				<li>To merge two recordsets into one while preserving their order, use the <span class="No-Break">following operation:</span><pre class="source-code">
result = recordset1 + recordset2</pre></li>				<li>To merge two recordsets into one while ensuring that there are no duplicates in the result, use the <span class="No-Break">following operation:</span><pre class="source-code">
result = recordset1 | recordset2</pre></li>				<li>To find the records that are common to two recordsets, use the <span class="No-Break">following operation:</span><pre class="source-code">
result = recordset1 &amp; recordset2</pre></li>			</ol>
			<h2 id="_idParaDest-219"><a id="_idTextAnchor279"/>How it works…</h2>
			<p>The class for recordsets implements various Python operator redefinitions, which are used here. Here’s a <a id="_idIndexMarker319"/>summary table of the most useful Python operators that can be used <span class="No-Break">on recordsets:</span></p>
			<div>
				<div id="_idContainer045" class="IMG---Figure">
					<img src="image/Image96870.jpg" alt="Table 5.3 – Operators used with the domain"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 5.3 – Operators used with the domain</p>
			<p>There are also in-place operators, <strong class="source-inline">+=</strong>, <strong class="source-inline">-=</strong>, <strong class="source-inline">&amp;=</strong>, and <strong class="source-inline">|=</strong>, which modify the left-hand side operand instead of creating a new recordset. These are very useful when updating a record’s <strong class="source-inline">One2many</strong> or <strong class="source-inline">Many2many</strong> fields. Refer to the <em class="italic">Updating values of recordset records</em> tutorial for an example <span class="No-Break">of this.</span></p>
			<h1 id="_idParaDest-220"><a id="_idTextAnchor280"/>Filtering recordsets</h1>
			<p>Sometimes, you already have a recordset, but you just need to work on a subset of those records. Of course, you may iterate over the recordset, checking for the condition each time and <a id="_idIndexMarker320"/>taking action in accordance with the outcome of the check. The construction of a new recordset comprising only the interesting records and the use of a single operation on that recordset can be simpler and, in certain situations, <span class="No-Break">more efficient.</span></p>
			<p>This tutorial shows you how to use the <strong class="source-inline">filter()</strong> method to extract a subset of recordsets based on <span class="No-Break">a condition.</span></p>
			<h2 id="_idParaDest-221"><a id="_idTextAnchor281"/>Getting ready</h2>
			<p>We will reuse the simplified <strong class="source-inline">hostel.room</strong> model that was shown in the <em class="italic">Creating new records</em> tutorial. This tutorial defines a method to extract rooms that have multiple members from a <span class="No-Break">supplied recordset.</span></p>
			<h2 id="_idParaDest-222"><a id="_idTextAnchor282"/>How to do it…</h2>
			<p>To extract records that have multiple members from a recordset, you need to perform the <span class="No-Break">following steps:</span></p>
			<ol>
				<li>Define the method to filter <span class="No-Break">the recordset:</span><pre class="source-code">
       def filter_members(room):
        all_rooms = self.search([])
        filtered_rooms = self.rooms_with_multiple_members(all_rooms)</pre></li>				<li>Define the method to accept the <span class="No-Break">original recordset:</span><pre class="source-code">
    @api.model
    def room_with_multiple_members(self, all_rooms):</pre></li>				<li>Define an inner <span class="No-Break"><strong class="source-inline">predicate</strong></span><span class="No-Break"> function:</span><pre class="source-code">
    def predicate(room):
        if len(room.member_ids) &gt; 1:
            return True
        return False</pre></li>				<li>Call <strong class="source-inline">filter()</strong>, <span class="No-Break">as follows:</span><pre class="source-code">
return all_room.filter (predicate)</pre></li>			</ol>
			<p>The outcome of this procedure can be printed or logged so that a server log can include it. For further information, see the tutorial’s <span class="No-Break">sample code.</span></p>
			<h2 id="_idParaDest-223"><a id="_idTextAnchor283"/>How it works…</h2>
			<p>The recordset that is created by the <strong class="source-inline">filter()</strong> method’s implementation is empty. This blank recordset <a id="_idIndexMarker321"/>receives all the records that the predicate function evaluates to <strong class="source-inline">True</strong>. Finally, the fresh recordset is given back. Records in the original recordset are still in the <span class="No-Break">same sequence.</span></p>
			<p>A named internal function was used in the last tutorial. You will frequently see an anonymous Lambda function being utilized for such <span class="No-Break">straightforward predicates:</span></p>
			<pre class="source-code">
@api.model
def <strong class="source-inline">room_wi<a id="_idTextAnchor284"/>th_multiple_rooms</strong>(self, all_rooms):
    return all_<strong class="source-inline">rooms</strong>.filter(lambda b: len(b.member<strong class="source-inline">_ids</strong>) &gt; 1)</pre>			<p>Actually, you need to filter a recordset based on the fact that the value of a field is <em class="italic">truthy</em> in the Python sense (non-empty strings, non-zero numbers, non-empty containers, and so on). So, if you want to filter records that have a category set, you can pass the field name to filter like <span class="No-Break">this: </span><span class="No-Break"><strong class="source-inline">all_rooms.filter('category_id')</strong></span><span class="No-Break">.</span></p>
			<h2 id="_idParaDest-224"><a id="_idTextAnchor285"/>There’s more…</h2>
			<p>Remember that <strong class="source-inline">filter()</strong> uses memory <a id="_idIndexMarker322"/>to work. Use a search domain or even switch to SQL to improve the speed of a method on the critical route at the cost <span class="No-Break">of readability.</span></p>
			<h1 id="_idParaDest-225"><a id="_idTextAnchor286"/>Traversing recordset relations</h1>
			<p>When working with a recordset with a length of <strong class="source-inline">1</strong>, various fields are available as record attributes. Relational attributes (<strong class="source-inline">One2many</strong>, <strong class="source-inline">Many2one</strong>, and <strong class="source-inline">Many2many</strong>) are also available with <a id="_idIndexMarker323"/>values that are recordsets, too. As an example, let’s say we want to access the name of the category from the recordset of the <strong class="source-inline">hostel.room</strong> model. You can access the category name by traversing through the <strong class="source-inline">Many2one</strong> field’s <strong class="source-inline">category_id</strong> as follows: <strong class="source-inline">room.category_id.name</strong>. However, when working with recordsets with more than one record, the attributes cannot <span class="No-Break">be used.</span></p>
			<p>This tutorial demonstrates how to navigate recordset relations using the <strong class="source-inline">mapped()</strong> function. We’ll create a function to extract the members’ names from the list of rooms that are supplied <span class="No-Break">as input.</span></p>
			<h2 id="_idParaDest-226"><a id="_idTextAnchor287"/>Getting ready</h2>
			<p>We will reuse the <strong class="source-inline">hostel.room</strong> model that was shown in the <em class="italic">Creating new records</em> tutorial in <span class="No-Break">this chapter.</span></p>
			<h2 id="_idParaDest-227"><a id="_idTextAnchor288"/>How to do it…</h2>
			<p>You must do the following actions in order to retrieve the names of members from the <span class="No-Break">room recordset:</span></p>
			<ol>
				<li>Define a method <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">get_members_names()</strong></span><span class="No-Break">:</span><pre class="source-code">
    @api.model
    def get_members_names(self, rooms):</pre></li>				<li>Call <strong class="source-inline">mapped()</strong> to get the name of the contacts of <span class="No-Break">the member:</span><pre class="source-code">
    return rooms.mapped('member_ids.name')</pre></li>			</ol>
			<h2 id="_idParaDest-228"><a id="_idTextAnchor289"/>How it works…</h2>
			<p>Simply defining the method is <em class="italic">Step 1</em>. The fields of the recordset are traversed in <em class="italic">Step 2</em> by calling the <strong class="source-inline">mapped(path)</strong> function; <strong class="source-inline">path</strong> is a string that comprises field names separated by dots. The next element in the route is applied to the new recordset created by <strong class="source-inline">mapped()</strong> for each field in the path. This new recordset comprises all the records connected by that field to every element in the current recordset. A recordset is returned by <strong class="source-inline">mapped()</strong> if the final field in the route is a relational field; otherwise, a Python list <span class="No-Break">is returned.</span></p>
			<p>The <strong class="source-inline">mapped()</strong> method has two <span class="No-Break">useful properties:</span></p>
			<ul>
				<li>When the route is a single scalar field name, the returned list is in the same chronological order as the recordset that <span class="No-Break">was processed</span></li>
				<li>If a relational <a id="_idIndexMarker324"/>field is present in the route, the result’s order is not retained, but duplicates <span class="No-Break">are eliminated</span></li>
			</ul>
			<p class="callout-heading">Important note</p>
			<p class="callout">This second property is very useful when you want to perform an operation on all the records that are pointed to by a <strong class="source-inline">Many2many</strong> field for all the records in <strong class="source-inline">self</strong>, but you need to ensure that the action is performed only once (even if two records of <strong class="source-inline">self</strong><em class="italic"> </em>share the same <span class="No-Break">target record).</span></p>
			<h2 id="_idParaDest-229"><a id="_idTextAnchor290"/>There’s more…</h2>
			<p>When using <strong class="source-inline">mapped()</strong>, keep in mind that it operates in memory inside the Odoo server by repeatedly <a id="_idIndexMarker325"/>traversing relations and therefore making SQL queries, which may not be efficient. However, the code is terse and expressive. If you are trying to optimize a method on the critical path of the performance of your instance, you may want to rewrite the call to <strong class="source-inline">mapped()</strong> and express it as <strong class="source-inline">search()</strong> with the appropriate domain, or even move to SQL (at the cost <span class="No-Break">of readability).</span></p>
			<p>The <strong class="source-inline">mapped()</strong> method can also be called with a function as an argument. In this case, it returns a list containing the result of the function that’s applied to each record of <strong class="source-inline">self</strong>, or the union of the recordsets that’s returned by the function, if the function returns <span class="No-Break">a recordset.</span></p>
			<h2 id="_idParaDest-230"><a id="_idTextAnchor291"/>See also</h2>
			<p>For more information, refer to <span class="No-Break">the following:</span></p>
			<ul>
				<li>The <em class="italic">Searching for records</em> tutorial in <span class="No-Break">this chapter</span></li>
				<li>The <em class="italic">Executing raw SQL queries</em> tutorial in <a href="B20997_08.xhtml#_idTextAnchor388"><span class="No-Break"><em class="italic">Chapter 8</em></span></a>, <em class="italic">Advanced Server-Side </em><span class="No-Break"><em class="italic">Development Techniques</em></span></li>
			</ul>
			<h1 id="_idParaDest-231"><a id="_idTextAnchor292"/>Sorting recordsets</h1>
			<p>When you fetch a recordset <a id="_idIndexMarker326"/>with the <strong class="source-inline">search()</strong> method, you can pass an optional argument order to get a recordset that’s in a particular order. This is useful if you already have a <a id="_idIndexMarker327"/>recordset from a previous bit of code and you want to sort it. It may also be useful if you use a set operation to combine two recordsets, for example, which would cause the order to <span class="No-Break">be lost.</span></p>
			<p>This tutorial shows <a id="_idIndexMarker328"/>you how to use the <strong class="source-inline">sorted()</strong> method to sort an existing recordset. We will sort rooms <span class="No-Break">by rating.</span></p>
			<h2 id="_idParaDest-232"><a id="_idTextAnchor293"/>Getting ready</h2>
			<p>We will reuse the <strong class="source-inline">hostel.room</strong> model that was shown in the <em class="italic">Creating new records</em> tutorial in <span class="No-Break">this chapter.</span></p>
			<h2 id="_idParaDest-233"><a id="_idTextAnchor294"/>How to do it…</h2>
			<p>You need to perform the following steps to get the sorted recordset of rooms based <span class="No-Break">on </span><span class="No-Break"><strong class="source-inline">rating</strong></span><span class="No-Break">:</span></p>
			<ol>
				<li>Define a method <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">sort_rooms_by_rating()</strong></span><span class="No-Break">:</span><pre class="source-code">
    @api.model
    def sort_rooms_by_rating(self, rooms):</pre></li>				<li>Use the <strong class="source-inline">sorted()</strong> method, as in the given example, to sort room records based on the <span class="No-Break"><strong class="source-inline">room_rating</strong></span><span class="No-Break"> field:</span><pre class="source-code">
    return rooms.sorted(key='room_rating')</pre></li>			</ol>
			<h2 id="_idParaDest-234"><a id="_idTextAnchor295"/>How it works…</h2>
			<p>Simply defining the method is <em class="italic">Step 1</em>. In <em class="italic">Step 2</em>, we use the recordset of the rooms’ <strong class="source-inline">sorted()</strong> function. The field that is supplied as the key parameter will have its data fetched internally by the <strong class="source-inline">sorted()</strong> function. Then, it returns a <strong class="source-inline">sorted</strong> recordset using Python’s native <span class="No-Break">sorted method.</span></p>
			<p>It also has one <a id="_idIndexMarker329"/>optional argument, <strong class="source-inline">reverse=True</strong>, which returns a recordset in reverse order. <strong class="source-inline">reverse</strong> is used <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
rooms.sorted(key='room_rating', reverse=True)</pre>			<h2 id="_idParaDest-235"><a id="_idTextAnchor296"/>There’s more…</h2>
			<p>The <strong class="source-inline">sorted()</strong> method will sort the records in a recordset. Called without arguments, the <strong class="source-inline">_order</strong> attribute of the model will be used. Otherwise, a function can be passed to compute a comparison key in the same way as the Python built-in sorted (sequence, <span class="No-Break">key) function.</span></p>
			<p class="callout-heading">Important note</p>
			<p class="callout">When the default <strong class="source-inline">_order</strong> parameter of the model is used, the sorting is delegated to the database, and a new <strong class="source-inline">SELECT</strong> function is performed to get the order. Otherwise, the sorting is performed by Odoo. Depending on what is being manipulated, and depending on the size of the recordsets, there might be some important <span class="No-Break">performance differences.</span></p>
			<h1 id="_idParaDest-236"><a id="_idTextAnchor297"/>Extending the business logic defined in a model</h1>
			<p>Dividing application functionalities into various modules is a popular practice in Odoo. You may easily <a id="_idIndexMarker330"/>accomplish this by installing or uninstalling the application, which will enable or disable functionalities. Furthermore, you must modify the behavior of some methods that were predefined in the original app when you add new features to it. An old model could occasionally benefit from the addition of fresh fields. This is one of the most useful functions of the underlying framework and the process is quite simple <span class="No-Break">in Odoo.</span></p>
			<p>In this tutorial, we will see how you can extend the business logic of one method from the method in another module. Additionally, we will use the new module to add new fields to an <span class="No-Break">existing module.</span></p>
			<h2 id="_idParaDest-237"><a id="_idTextAnchor298"/>Getting ready</h2>
			<p>For this tutorial, we will continue to use the <strong class="source-inline">my_hostel</strong> module from the last tutorial. Make sure that you have the <strong class="source-inline">hostel.room.category</strong> model in the <span class="No-Break"><strong class="source-inline">my_hostel</strong></span><span class="No-Break"> module.</span></p>
			<p>For this tutorial, we will create a new module called <strong class="source-inline">my_hostel_terminate</strong>, which depends on the <strong class="source-inline">my_ hostel</strong> module. In this module, we will manage termination dates from the hostel. We will also automatically calculate the withdrawal date based on <span class="No-Break">the category.</span></p>
			<p>In the <em class="italic">How to add features to a model using inheritance</em> tutorial in <a href="B20997_04.xhtml#_idTextAnchor118"><span class="No-Break"><em class="italic">Chapter 4</em></span></a>, <em class="italic">Application Models</em>, we saw how <a id="_idIndexMarker331"/>to add a field to the existing model. In this module, extend the <strong class="source-inline">hostel.room</strong> model <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
class HostelRoom(models.Model):
    _inherit = 'hostel.room'
    date_terminate = fields.Date('Date of Termination')</pre>			<p>Then, extend the <strong class="source-inline">hostel.room.category</strong> model, <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
class RoomCategory(models.Model):
    _inherit = 'hostel.room.category'
    max_allow_days = fields.Integer(
        'Maximum allows days',
        help="For how many days room can be borrowed",
        default=365)</pre>			<p>To add this field in views, you need to follow the <em class="italic">Changing existing views – view inheritance</em> tutorial from <a href="B20997_09.xhtml#_idTextAnchor446"><span class="No-Break"><em class="italic">Chapter 9</em></span></a>, <em class="italic">Backend Views</em>. You can find a full example of the code <span class="No-Break">at </span><a href="https://github.com/PacktPublishing/Odoo-17-Development-Cookbook-Fifth-Edition"><span class="No-Break">https://github.com/PacktPublishing/Odoo-17-Development-Cookbook-Fifth-Edition</span></a><span class="No-Break">.</span></p>
			<h2 id="_idParaDest-238"><a id="_idTextAnchor299"/>How to do it…</h2>
			<p>To extend <a id="_idIndexMarker332"/>the business logic in the <strong class="source-inline">hostel.room</strong> model, you need to perform the <span class="No-Break">following steps:</span></p>
			<ol>
				<li>From <strong class="source-inline">my_hostel_terminate</strong>, we want to set <strong class="source-inline">date_terminate</strong> in the <strong class="source-inline">rooms</strong> record when we change the room status to <strong class="source-inline">Closed</strong>. For this, we will override the <strong class="source-inline">make_closed</strong> method from the <strong class="source-inline">my_ </strong><span class="No-Break"><strong class="source-inline">hostel_terminate</strong></span><span class="No-Break"> module:</span><pre class="source-code">
def make_closed(self):
    day_to_allocate = self.category_id.max_allow_days or 10
    self.date_return = fields.Date.today() + timedelta(days=day_to_allocate)
    return super(HostelRoom, self).make_closed()</pre></li>				<li>We also want to reset <strong class="source-inline">date_terminate</strong> when the room is returned and available to borrow, so we will override the <strong class="source-inline">make_available</strong> method to reset <span class="No-Break">the date:</span><pre class="source-code">
    def make_available(self):
        self.date_terminate = False
        return super(HostelRoom, self).make_available()</pre></li>			</ol>
			<h2 id="_idParaDest-239"><a id="_idTextAnchor300"/>How it works…</h2>
			<p><em class="italic">Steps 1</em> and <em class="italic">2</em>, in the preceding section, carry out the extension of the business logic. We define a model that extends <strong class="source-inline">hostel.room</strong> and redefines the <strong class="source-inline">make_closed()</strong> and <strong class="source-inline">make_available()</strong> methods. In the last line of both methods, the result that was implemented by the parent class <span class="No-Break">is returned:</span></p>
			<pre class="source-code">
return super(HostelRoom, self).make_closed()</pre>			<p>In the case of Odoo models, the parent class is not what you’d expect by looking at the Python class definition. The framework has dynamically generated a class hierarchy for our recordset, and the parent class is the definition of the model from the modules that we depend on. So, the call to <strong class="source-inline">super()</strong> brings back the implementation of <strong class="source-inline">hostel.room</strong> from <strong class="source-inline">my_hostel</strong>. In this implementation, <strong class="source-inline">make_closed()</strong> changes the state of the <a id="_idIndexMarker333"/>room to <strong class="source-inline">Closed</strong>. So, calling <strong class="source-inline">super()</strong> will invoke the parent method and it will set the room state <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">Closed</strong></span><span class="No-Break">.</span></p>
			<h2 id="_idParaDest-240"><a id="_idTextAnchor301"/>There’s more…</h2>
			<p>In this tutorial, we choose <a id="_idIndexMarker334"/>to extend the default implementation <a id="_idIndexMarker335"/>of the methods. In the <strong class="source-inline">make_closed()</strong> and <strong class="source-inline">make_available()</strong> methods, we modified the returned result <em class="italic">before</em> the <strong class="source-inline">super()</strong> call. Note that, when you call <strong class="source-inline">super()</strong>, it will execute the default implementation. It is also possible to perform some actions <em class="italic">after</em> the <strong class="source-inline">super()</strong> call. Of course, we can also do both at the <span class="No-Break">same time.</span></p>
			<p>To alter a method’s behavior in the midst, though, is more challenging. To do this, we must restructure the code in order to extract an extension point to a different function, which we can then override in the <span class="No-Break">extension module.</span></p>
			<p>You might be inspired to rewrite a function from scratch. Always proceed with extreme caution. The extension mechanism and maybe the add-ons that extend the method are broken if you do not use the <strong class="source-inline">super()</strong> implementation of your method, which means that the extension methods will never be invoked. Avoid doing this unless you are working in a controlled environment where you are certain which add-ons are installed and you have verified that you are not breaking them. Additionally, if necessary, make sure to clearly document everything <span class="No-Break">you do.</span></p>
			<p>What can you do before and after calling the original implementation of the method? There are lots of things, including (but not limited to) <span class="No-Break">the following:</span></p>
			<ul>
				<li>Change the arguments that are sent to the initial implementation (in <span class="No-Break">the past)</span></li>
				<li>Alter the context that was previously provided to the <span class="No-Break">original implementation</span></li>
				<li>Change the outcome that the initial implementation <span class="No-Break">returned (after)</span></li>
				<li>Call another method (before <span class="No-Break">and after)</span></li>
				<li>Create records (before <span class="No-Break">and after)</span></li>
				<li>Raise a <strong class="source-inline">UserError</strong> error to cancel the execution in forbidden cases (before <span class="No-Break">and after)</span></li>
				<li>Split <strong class="source-inline">self</strong> into smaller recordsets and call the original implementation on each of the subsets in a different <span class="No-Break">way (before)</span></li>
			</ul>
			<h1 id="_idParaDest-241"><a id="_idTextAnchor302"/>Extending write() and create()</h1>
			<p>Extending the business logic defined in a model tutorial from this chapter showed us how to extend <a id="_idIndexMarker336"/>methods that are defined on a model class. If you think about it, methods that are defined on the parent class of the model are also part of the <a id="_idIndexMarker337"/>model. This means that all the base methods that are defined on <strong class="source-inline">models.Model</strong> (actually, on <strong class="source-inline">models.BaseModel</strong>, which is the parent class of <strong class="source-inline">models.Model</strong>) are also available and can <span class="No-Break">be extended.</span></p>
			<p>This tutorial shows you how to extend <strong class="source-inline">create()</strong> and <strong class="source-inline">write()</strong> to control access to some fields of <span class="No-Break">the records.</span></p>
			<h2 id="_idParaDest-242"><a id="_idTextAnchor303"/>Getting ready</h2>
			<p>We will extend the library example from the <strong class="source-inline">my_hostel</strong> add-on module in <a href="B20997_03.xhtml#_idTextAnchor083"><span class="No-Break"><em class="italic">Chapter 3</em></span></a>, <em class="italic">Creating Odoo </em><span class="No-Break"><em class="italic">Add-On Modules</em></span><span class="No-Break">.</span></p>
			<p>Add a <strong class="source-inline">remarks</strong> field to the <strong class="source-inline">hostel.room</strong> model. We only want members of the <strong class="source-inline">Hostel Managers</strong> group to be able to write to <span class="No-Break">that field:</span></p>
			<pre class="source-code">
from odoo import models, api, exceptions
class HostelRoom(models.Model):
    _name = 'hostel.room'
    remarks = fields.Text('Remarks')</pre>			<p>Add the <strong class="source-inline">remarks</strong> field to the <strong class="source-inline">&lt;form&gt;</strong> view of the <strong class="source-inline">view/hostel_room.xml</strong> file to access this field from the <span class="No-Break">user interface:</span></p>
			<pre class="source-code">
&lt;field name="remarks"/&gt;</pre>			<p>Modify the <strong class="source-inline">security/ir.model.access.csv</strong> file to give write access to <span class="No-Break">library users:</span></p>
			<pre class="source-code">
id,name,model_id:id,group_id:id,perm_read,perm_write,perm_create,perm_unlink
access_hostel,hostel.room.user,model_hostel_room,base.group_user,1,1,0,0</pre>			<h2 id="_idParaDest-243"><a id="_idTextAnchor304"/>How to do it…</h2>
			<p>To prevent users <a id="_idIndexMarker338"/>who are not members of the manager group from modifying <a id="_idIndexMarker339"/>the value of <strong class="source-inline">remarks</strong>, you need to perform the <span class="No-Break">following steps:</span></p>
			<ol>
				<li>Extend the <strong class="source-inline">create()</strong> method, <span class="No-Break">as follows:</span><pre class="source-code">
    @api.model
    def create(self, values):
        if not self.user_has_groups('my_hostel.group_hostel_manager'):
            if values.get('remarks'):
                raise UserError(
                    'You are not allowed to modify '
                    'remarks'
                )
        return super(HostelRoom, self).create(values)</pre></li>				<li>Extend the <strong class="source-inline">write()</strong> method, <span class="No-Break">as follows:</span><pre class="source-code">
    def write(self, values):
        if not self.user_has_groups('my_hostel.group_hostel_manager'):
            if values.get('remarks'):
                raise UserError(
                    'You are not allowed to modify '
                    'manager_remarks'
                )
        return super(HostelRoom, self).write(values)</pre></li>			</ol>
			<p>Install the module to see the code in action. Now, only a manager type of user can modify the <strong class="source-inline">remarks</strong> field. To test this implementation, you can log in as a demo user or revoke manager access from the <span class="No-Break">current user.</span></p>
			<h2 id="_idParaDest-244"><a id="_idTextAnchor305"/>How it works…</h2>
			<p><em class="italic">Step 1</em> in the preceding <a id="_idIndexMarker340"/>section redefines the <strong class="source-inline">create()</strong> method. Before <a id="_idIndexMarker341"/>calling the base implementation of <strong class="source-inline">create()</strong>, our method uses the <strong class="source-inline">user_has_groups()</strong> method to check whether the user belongs to the <strong class="source-inline">my_hostel.group_hostel_manager</strong> group (this is the XML ID of the group). If this is not the case and a value is passed for <strong class="source-inline">remarks</strong>, a <strong class="source-inline">UserError</strong> exception is raised, preventing the creation of the record. This check is performed before the base implementation <span class="No-Break">is called.</span></p>
			<p><em class="italic">Step 2</em> does the same thing for the <strong class="source-inline">write()</strong> method. Prior to writing, we check the group and the presence of the field in the values so we can write and raise a <strong class="source-inline">UserError</strong> exception if there is <span class="No-Break">a problem.</span></p>
			<p class="callout-heading">Important note</p>
			<p class="callout">Having the field set to read only in the web client does not prevent RPC calls from writing it. This is why we extend <strong class="source-inline">create()</strong> <span class="No-Break">and </span><span class="No-Break"><strong class="source-inline">write()</strong></span><span class="No-Break">.</span></p>
			<p>In this tutorial, you have seen how you can override the <strong class="source-inline">create()</strong> and <strong class="source-inline">write()</strong> methods. However, note that this is not limited to the <strong class="source-inline">create()</strong> and <strong class="source-inline">write()</strong> methods. You can override any model method. For example, let’s say you want to do something when the record is deleted. To do so, you need to override the <strong class="source-inline">unlink()</strong> method (the <strong class="source-inline">unlink()</strong> method will be called when the record is deleted). Here is the small code snippet to override the <span class="No-Break"><strong class="source-inline">unlink()</strong></span><span class="No-Break"> method:</span></p>
			<pre class="source-code">
def unlink(self):
    # your logic
    return super(HostelRoom, self).unlink()</pre>			<p class="callout-heading">Warning</p>
			<p class="callout">When overriding a method in Odoo, never forget to call the <strong class="source-inline">super()</strong> method, otherwise, you will encounter an issue. This is because when you don’t use the<em class="italic"> </em><strong class="source-inline">super()</strong> method, the code in the original method is never executed. If, in our previous code snippet, we didn’t call <strong class="source-inline">super(…).unlink()</strong>, records would not <span class="No-Break">be deleted.</span></p>
			<h2 id="_idParaDest-245"><a id="_idTextAnchor306"/>There’s more…</h2>
			<p>When extending <strong class="source-inline">write()</strong>, note that, before calling the <strong class="source-inline">super()</strong> implementation of <strong class="source-inline">write()</strong>, <strong class="source-inline">self</strong> is still unmodified. You can use this to compare the current values of the fields to the ones in the <span class="No-Break"><strong class="source-inline">values</strong></span><span class="No-Break"> dictionary.</span></p>
			<p>In this tutorial, we chose <a id="_idIndexMarker342"/>to raise an exception, but we could have also <a id="_idIndexMarker343"/>chosen to remove the offending field from the <strong class="source-inline">values</strong> dictionary and silently skipped updating that field in <span class="No-Break">the record:</span></p>
			<pre class="source-code">
def write(self, values):
    if not self.user_has_groups('my_hostel.group_hostel_manager'):
        if values.get('remarks'):
            del values['remarks']
    return super(HostelRoom, self).write(values)</pre>			<p>After calling <strong class="source-inline">super().write()</strong>, if you want to perform additional actions, you have to be wary of anything that can cause another call to <strong class="source-inline">write()</strong>, or you will create an infinite recursion loop. The workaround is to put a marker in the context that will be checked to break <span class="No-Break">the recursion:</span></p>
			<pre class="source-code">
class MyModel(models.Model):
    def write(self, values):
        sup = super(MyModel, self).write(values)
        if self.env.context.get('MyModelLoopBreaker'):
            return
        self = self.with_context(MyModelLoopBreaker=True)
        self.compute_things() # can cause calls to writes
        return sup</pre>			<p>In the <a id="_idIndexMarker344"/>preceding example, we have added the <strong class="source-inline">MyModelLoopBreaker</strong> key before calling <a id="_idIndexMarker345"/>the <strong class="source-inline">compute_things()</strong> method. So, if the <strong class="source-inline">write()</strong> method is called again, it doesn’t go in an <span class="No-Break">infinite loop.</span></p>
			<h1 id="_idParaDest-246"><a id="_idTextAnchor307"/>Customizing how records are searched</h1>
			<p>The <em class="italic">Defining the model representation and order</em> tutorial in <a href="B20997_03.xhtml#_idTextAnchor083"><span class="No-Break"><em class="italic">Chapter 3</em></span></a>, <em class="italic">Creating Odoo Add-On Modules</em>, introduced the <strong class="source-inline">name_get()</strong> method, which is used to compute a <a id="_idIndexMarker346"/>representation of the record in various places, including in the widget that’s used to display <strong class="source-inline">Many2one</strong> relations in the <span class="No-Break">web client.</span></p>
			<p>This tutorial will show you how to search for a room in the <strong class="source-inline">Many2one</strong> widget by room number and name by <span class="No-Break">redefining </span><span class="No-Break"><strong class="source-inline">name_search</strong></span><span class="No-Break">.</span></p>
			<h2 id="_idParaDest-247"><a id="_idTextAnchor308"/>Getting ready</h2>
			<p>For this tutorial, we will use the following <span class="No-Break">model definition:</span></p>
			<pre class="source-code">
class HostelRoom(models.Model):
    def name_get(self):
        result = []
        for room in self:
            member = room.member_ids.mapped('name')
            name = '%s (%s)' % (room.name, ', '.join(member))
            result.append((room.id, name))
            return result</pre>			<p>When using this model, a room in a <strong class="source-inline">Many2one</strong> widget is displayed as <strong class="bold">Room Title</strong> (<strong class="bold">Member1, Member2,..</strong>). Users expect to be able to type in a member’s name and find the list filtered according to this name, but this will not work since the default implementation of <strong class="source-inline">name_search</strong> only uses the attribute referred to by the <strong class="source-inline">_rec_name</strong> attribute of the model class, which, in our case, is <strong class="source-inline">'name'</strong>. We also want to allow filtering by <span class="No-Break">room number.</span></p>
			<h2 id="_idParaDest-248"><a id="_idTextAnchor309"/>How to do it…</h2>
			<p>You need to <a id="_idIndexMarker347"/>perform the following steps in order to execute <span class="No-Break">this tutorial:</span></p>
			<ol>
				<li>To be able to search for <strong class="source-inline">hostel.room</strong> either by the room’s name, one of the members, or the room number, you need to define the <strong class="source-inline">_name_search()</strong> method in the <strong class="source-inline">HostelRoom</strong> class, <span class="No-Break">as follows:</span><pre class="source-code">
@api.model
def _name_search(self, name='', args=None, operator='ilike',
                  limit=100, name_get_uid=None):
     args = [] if args is None else args.copy()
     if not(name == '' and operator == 'ilike'):
         args += ['|', '|',
                  ('name', operator, name),
                  ('isbn', operator, name),
                  ('author_ids.name', operator, name)
                  ]
     return super(HostelRoom, self)._name_search(
         name=name, args=args, operator=operator,
         limit=limit, name_get_uid=name_get_uid)</pre></li>				<li>Add the <strong class="source-inline">previous_room_id</strong> <strong class="source-inline">Many2one</strong> field in t<a id="_idTextAnchor310"/>he <strong class="source-inline">hostel.room</strong> model to test the <span class="No-Break"><strong class="source-inline">_name_search</strong></span><span class="No-Break"> implementation:</span><pre class="source-code">
previous_room = fields.Many2one('hostel.room', string='Previous Room')</pre></li>				<li>Add the following field to the <span class="No-Break">user interface:</span><pre class="source-code">
&lt;field name="previous_room_id" /&gt;</pre></li>				<li>Restart and update the module to reflect <span class="No-Break">these changes.</span></li>
			</ol>
			<p>You can invoke the <strong class="source-inline">_name_search</strong> method by searching in the <strong class="source-inline">previous_room_id</strong> <span class="No-Break"><strong class="source-inline">Many2one</strong></span><span class="No-Break"> field.</span></p>
			<h2 id="_idParaDest-249"><a id="_idTextAnchor311"/>How it works…</h2>
			<p>The default <a id="_idIndexMarker348"/>implementation of <strong class="source-inline">name_search()</strong> actually only calls the <strong class="source-inline">_name_search()</strong> method, which does the real job. This <strong class="source-inline">_name_search()</strong> method has an additional argument, <strong class="source-inline">name_get_uid</strong>, which is used in some corner cases such as if you want to compute the results using <strong class="source-inline">sudo()</strong> or with a <span class="No-Break">different user.</span></p>
			<p>We pass most of the arguments that we receive unchanged to the <strong class="source-inline">super()</strong> implementation of <span class="No-Break">the method:</span></p>
			<ul>
				<li><strong class="source-inline">name</strong> is a string that contains the value the user has typed <span class="No-Break">so far.</span></li>
				<li><strong class="source-inline">args</strong> is either <strong class="source-inline">None</strong> or a search domain that’s used as a prefilter for the possible records. (It can come from the domain parameter of the <strong class="source-inline">Many2one</strong> relation, <span class="No-Break">for instance.)</span></li>
				<li><strong class="source-inline">operator</strong> is a string containing the match operator. Generally, you will have <strong class="source-inline">'ilike'</strong> <span class="No-Break">or </span><span class="No-Break"><strong class="source-inline">'='</strong></span><span class="No-Break">.</span></li>
				<li><strong class="source-inline">limit</strong> is the maximum number of rows <span class="No-Break">to retrieve.</span></li>
				<li><strong class="source-inline">name_get_uid</strong> can be used to specify a different user when calling <strong class="source-inline">name_get()</strong> to compute the strings to display in <span class="No-Break">the widget.</span></li>
			</ul>
			<p>Our implementation of the method does <span class="No-Break">the following:</span></p>
			<ol>
				<li>It generates a new empty list if <strong class="source-inline">args</strong> is <strong class="source-inline">None</strong>, and makes a copy of <strong class="source-inline">args</strong> otherwise. We make a copy to avoid our modifications to the list having side effects on <span class="No-Break">the caller.</span></li>
				<li>Then, we check that <strong class="source-inline">name</strong> is not an empty string or that <strong class="source-inline">operator</strong> is not <strong class="source-inline">'ilike'</strong>. This is to avoid generating a dumb domain, such as <strong class="source-inline">[('name', ilike, '')]</strong>, that doesn’t filter anything. In this case, we jump straight to the <strong class="source-inline">super()</strong> <span class="No-Break">call implementation.</span></li>
				<li>If we have <strong class="source-inline">name</strong>, or if <strong class="source-inline">operator</strong> is not <strong class="source-inline">'ilike'</strong>, then we add some filtering criteria to <strong class="source-inline">args</strong>. In our case, we add clauses that will search for the supplied name in the title of the rooms, in their room number, or the <span class="No-Break">members’ names.</span></li>
				<li>Finally, we call the <strong class="source-inline">super()</strong> implementation with the modified domain in <strong class="source-inline">args</strong> and force <strong class="source-inline">name</strong> to be <strong class="source-inline">''</strong> and <strong class="source-inline">operator</strong> to be <strong class="source-inline">ilike</strong>. We do this to force the <a id="_idIndexMarker349"/>default implementation of <strong class="source-inline">_name_search()</strong> to not alter the domain it receives, so, the one we specified will <span class="No-Break">be used.</span></li>
			</ol>
			<h2 id="_idParaDest-250"><a id="_idTextAnchor312"/>There’s more…</h2>
			<p>We mentioned in the introduction that this method is used in the <strong class="source-inline">Many2one</strong> widget. For completeness, it is also used in the following parts <span class="No-Break">of Odoo:</span></p>
			<ul>
				<li>When using the <strong class="source-inline">in</strong> operator on the <strong class="source-inline">One2many</strong> and <strong class="source-inline">Many2many</strong> fields in <span class="No-Break">the domain</span></li>
				<li>To search for records in the <span class="No-Break"><strong class="source-inline">many2many_tags</strong></span><span class="No-Break"> widget</span></li>
				<li>To search for records in the CSV <span class="No-Break">file import</span></li>
			</ul>
			<h2 id="_idParaDest-251"><a id="_idTextAnchor313"/>See also</h2>
			<p>The <em class="italic">Defining the model representation and order</em> tutorial in <a href="B20997_03.xhtml#_idTextAnchor083"><span class="No-Break"><em class="italic">Chapter 3</em></span></a>, <em class="italic">Creating Odoo Add-On Modules</em>, demonstrates how to define the <strong class="source-inline">name_get()</strong> method, which is used to create a text representation of <span class="No-Break">a record.</span></p>
			<p>The <em class="italic">Defining filters on record lists – domain</em> tutorial in <a href="B20997_09.xhtml#_idTextAnchor446"><span class="No-Break"><em class="italic">Chapter 9</em></span></a>, <em class="italic">Backe<a id="_idTextAnchor314"/>nd Views</em>, provides more information about search <span class="No-Break">domain syntax.</span></p>
			<h1 id="_idParaDest-252"><a id="_idTextAnchor315"/>Fetching data in groups using read_group()</h1>
			<p>In the previous tutorials, we saw how we can search and fetch data from the database. However, sometimes, you <a id="_idIndexMarker350"/>want results by <a id="_idIndexMarker351"/>aggregating records, such as the average cost of last month’s sales order. Usually, we use <strong class="source-inline">group by</strong> and the <strong class="source-inline">aggregate</strong> function in SQL queries for such a result. Luckily, in Odoo, we have the <strong class="source-inline">read_group()</strong> method. In this tutorial, you will learn how to use the <strong class="source-inline">read_group()</strong> method to get the <span class="No-Break">aggregate result.</span></p>
			<h2 id="_idParaDest-253"><a id="_idTextAnchor316"/>Getting ready</h2>
			<p>In this tutorial, we will use the <strong class="source-inline">my_hostel</strong> add-on module from <a href="B20997_03.xhtml#_idTextAnchor083"><span class="No-Break"><em class="italic">Chapter 3</em></span></a>, <em class="italic">Creating Odoo </em><span class="No-Break"><em class="italic">Add-On Modules</em></span><span class="No-Break">.</span></p>
			<p>Modify the <strong class="source-inline">hostel.room</strong> model, as shown in the following <span class="No-Break">model definition:</span></p>
			<pre class="source-code">
class HostelRoom(models.Model):
    _name = 'hostel.room'
    name = fields.Char('Name', required=True)
    cost_price = fields.Float('Room Cost')
    category_id = fields.Many2one('hostel.room.category')</pre>			<p>Add the <strong class="source-inline">hostel.room.category</strong> model. For simplicity, we will just add it to the same <span class="No-Break"><strong class="source-inline">hostel_room.py</strong></span><span class="No-Break"> file:</span></p>
			<pre class="source-code">
class HostelCategory(models.Model):
    _name = 'hostel.room.category'
    name = fields.Char('Category')
    description = fields.Text('Description')</pre>			<p>We will be using the <strong class="source-inline">hostel.room</strong> model and getting an average cost price <span class="No-Break">per category.</span></p>
			<h2 id="_idParaDest-254"><a id="_idTextAnchor317"/>How to do it…</h2>
			<p>To extract <a id="_idIndexMarker352"/>grouped results, we will <a id="_idIndexMarker353"/>add the <strong class="source-inline">_get_average_cost</strong> method to the <strong class="source-inline">hostel.room</strong> model, which will use the <strong class="source-inline">read_group()</strong> method to fetch the data in <span class="No-Break">a group:</span></p>
			<pre class="source-code">
    @api.model
    def _get_average_cost(self):
        grouped_result = self.read_group(
            [('cost_price', "!=", False)], # Domain
            ['category_id', 'cost_price:avg'], # Fields to access
            ['category_id'] # group_by
            )
        return grouped_result</pre>			<p>To test this implementation, you need to add a button to the user interface that triggers this method. Then, you can print the result in the <span class="No-Break">server log.</span></p>
			<h2 id="_idParaDest-255"><a id="_idTextAnchor318"/>How it works…</h2>
			<p>The <strong class="source-inline">read_group()</strong> method internally uses the SQL <strong class="source-inline">groupby</strong> and <strong class="source-inline">aggregate</strong> functions to fetch the data. The most common arguments that are passed to the <strong class="source-inline">read_group()</strong> method <a id="_idIndexMarker354"/>are <span class="No-Break">as follows:</span></p>
			<ul>
				<li><strong class="source-inline">domain</strong>: This is used to filter records for grouping. For more information on <strong class="source-inline">domain</strong>, refer to the <em class="italic">Searching views</em> tutorial in <a href="B20997_09.xhtml#_idTextAnchor446"><span class="No-Break"><em class="italic">Chapter 9</em></span></a>, <span class="No-Break"><em class="italic">Backend Views</em></span><span class="No-Break">.</span></li>
				<li><strong class="source-inline">fields</strong>: This passes the names of fields you want to fetch with the grouped data. Possible values for this argument are <span class="No-Break">as follows:</span><ul><li><strong class="source-inline">field name</strong>: You can pass the field name into the <strong class="source-inline">fields</strong> argument, but if you are using this option, then you must pass this field name to the <strong class="source-inline">groupby</strong> parameter too, otherwise it will generate <span class="No-Break">an error.</span></li><li><strong class="source-inline">field_name:agg</strong>: You can pass the field name with the <strong class="source-inline">aggregate</strong> function. For example, in <strong class="source-inline">cost_price:avg</strong>, <strong class="source-inline">avg</strong> is an SQL aggregate function. A list <a id="_idIndexMarker355"/>of PostgreSQL aggregate functions can be found <span class="No-Break">at </span><a href="https://www.postgresql.org/docs/current/static/functions-aggregate.html"><span class="No-Break">https://www.postgresql.org/docs/current/static/functions-aggregate.html</span></a><span class="No-Break">.</span></li><li><strong class="source-inline">name:agg(field_name)</strong>: This is the same as the previous one, but, with this syntax, you can provide column aliases, such <span class="No-Break">as </span><span class="No-Break"><strong class="source-inline">average_price:avg(cost_price)</strong></span><span class="No-Break">.</span></li></ul></li>
				<li><strong class="source-inline">groupby</strong>: This argument accepts a list of field descriptions. Records will be grouped based on these fields. For the <strong class="source-inline">date</strong> and <strong class="source-inline">datetime</strong> column, you can pass <strong class="source-inline">groupby_function</strong> to apply date groupings based on different time durations. You can do grouping based on months for date <span class="No-Break">type fields.</span></li>
				<li><strong class="source-inline">read_group()</strong> also supports some optional arguments, <span class="No-Break">as follows:</span><ul><li><strong class="source-inline">offset</strong>: This indicates an optional number of records <span class="No-Break">to skip.</span></li><li><strong class="source-inline">limit</strong>: This indicates an optional maximum number of records <span class="No-Break">to return.</span></li><li><strong class="source-inline">orderby</strong>: If this option is passed, the result will be sorted based on the <span class="No-Break">given fields.</span></li><li><strong class="source-inline">lazy</strong>: This accepts Boolean values and, by default, is <strong class="source-inline">True</strong>. If <strong class="source-inline">True</strong> is passed, the results are only grouped by the first <strong class="source-inline">groupby</strong>, and the remaining <strong class="source-inline">groupby</strong> arguments are put in the <strong class="source-inline">__context</strong> key. If <strong class="source-inline">False</strong>, all <strong class="source-inline">groupby</strong> functions are done in <span class="No-Break">one call.</span></li></ul></li>
			</ul>
			<p class="callout-heading">Performance tip</p>
			<p class="callout"><strong class="source-inline">read_group()</strong> is a lot faster <a id="_idIndexMarker356"/>than reading and processing values from a recordset. So, for KPIs or graphs, you should always <span class="No-Break">use </span><span class="No-Break"><strong class="source-inline">read_group()</strong></span><span class="No-Break">.</span></p>
		</div>
	</body></html>