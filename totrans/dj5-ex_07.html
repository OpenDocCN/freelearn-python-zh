<html><head></head><body>
<div class="Basic-Text-Frame" id="_idContainer229">
<h1 class="chapterNumber"><span class="koboSpan" id="kobo.1.1">7</span></h1>
<h1 class="chapterTitle" id="_idParaDest-193"><span class="koboSpan" id="kobo.2.1">Tracking User Actions</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">In the previous chapter, you built a JavaScript bookmarklet to share content from other websites on your platform. </span><span class="koboSpan" id="kobo.3.2">You also implemented asynchronous actions with JavaScript in your project and created an infinite scroll.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4.1">In this chapter, you will learn how to build a follow system and create a user activity stream. </span><span class="koboSpan" id="kobo.4.2">You will also discover how Django signals work and you will integrate Redis’s fast I/O storage into your project to store item views.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.5.1">This chapter will cover the following points:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.6.1">Building a follow system</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.7.1">Creating many-to-many relationships with an intermediate model</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.8.1">Creating an activity stream application</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.9.1">Adding generic relations to models</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.10.1">Optimizing QuerySets for related objects</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.11.1">Using signals for denormalizing counts</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.12.1">Using Django Debug Toolbar to obtain relevant debug information</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.13.1">Counting image views with Redis</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.14.1">Creating a ranking of the most viewed images with Redis</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-194"><span class="koboSpan" id="kobo.15.1">Functional overview</span></h1>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.16.1">Figure 7.1</span></em><span class="koboSpan" id="kobo.17.1"> shows a representation of the views, templates, and functionalities that will be built in this chapter:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.18.1"><img alt="" role="presentation" src="../Images/B21088_07_01.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.19.1">Figure 7.1: Diagram of functionalities built in Chapter 7</span></p>
<p class="normal"><span class="koboSpan" id="kobo.20.1">In this chapter, you will build the </span><code class="inlineCode"><span class="koboSpan" id="kobo.21.1">user_list</span></code><span class="koboSpan" id="kobo.22.1"> view to list all users and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.23.1">user_detail</span></code><span class="koboSpan" id="kobo.24.1"> view to display a single user profile. </span><span class="koboSpan" id="kobo.24.2">You will implement a follow system with JavaScript, using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.25.1">user_follow</span></code><span class="koboSpan" id="kobo.26.1"> view to store user follows. </span><span class="koboSpan" id="kobo.26.2">You will create a system to store user actions, and you will implement the actions for creating an account, following a user, creating an image, and liking an image. </span><span class="koboSpan" id="kobo.26.3">You will use this system to display an activity stream in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.27.1">dashboard</span></code><span class="koboSpan" id="kobo.28.1"> view with the latest actions. </span><span class="koboSpan" id="kobo.28.2">You will also use Redis to store a </span><em class="italic"><span class="koboSpan" id="kobo.29.1">view</span></em><span class="koboSpan" id="kobo.30.1"> every time the </span><code class="inlineCode"><span class="koboSpan" id="kobo.31.1">image_detail</span></code><span class="koboSpan" id="kobo.32.1"> view is loaded and create the view </span><code class="inlineCode"><span class="koboSpan" id="kobo.33.1">image_ranking</span></code><span class="koboSpan" id="kobo.34.1"> to display a ranking of the most viewed images.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.35.1">The source code for this chapter can be found at </span><a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter07"><span class="url"><span class="koboSpan" id="kobo.36.1">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter07</span></span></a><span class="koboSpan" id="kobo.37.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.38.1">All Python packages used in this chapter are included in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.39.1">requirements.txt</span></code><span class="koboSpan" id="kobo.40.1"> file in the source code for the chapter. </span><span class="koboSpan" id="kobo.40.2">You can follow the instructions to install each Python package in the following sections, or you can install all requirements at once with the command </span><code class="inlineCode"><span class="koboSpan" id="kobo.41.1">python</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.42.1">-m</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.43.1">pip</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.44.1">install</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.45.1">-r</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.46.1">requirements.txt</span></code><span class="koboSpan" id="kobo.47.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-195"><span class="koboSpan" id="kobo.48.1">Building a follow system</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.49.1">Let’s build a follow system in your </span><a id="_idIndexMarker624"/><span class="koboSpan" id="kobo.50.1">project. </span><span class="koboSpan" id="kobo.50.2">This means that your users will be able to follow each other and track what other users share on the platform. </span><span class="koboSpan" id="kobo.50.3">The relationship between users is a </span><em class="italic"><span class="koboSpan" id="kobo.51.1">many-to-many</span></em><span class="koboSpan" id="kobo.52.1"> relationship; this means that a user can follow multiple users and they, in turn, can be followed by multiple users.</span></p>
<h2 class="heading-2" id="_idParaDest-196"><span class="koboSpan" id="kobo.53.1">Creating many-to-many relationships with an intermediate model</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.54.1">In previous chapters, you created many-to-many relationships by adding the </span><code class="inlineCode"><span class="koboSpan" id="kobo.55.1">ManyToManyField</span></code><span class="koboSpan" id="kobo.56.1"> to one of the related</span><a id="_idIndexMarker625"/><span class="koboSpan" id="kobo.57.1"> models and letting Django create the database table for the relationship. </span><span class="koboSpan" id="kobo.57.2">This is suitable for most cases, but sometimes you may need to create an intermediate model for the</span><a id="_idIndexMarker626"/><span class="koboSpan" id="kobo.58.1"> relationship. </span><span class="koboSpan" id="kobo.58.2">Creating an intermediate model is necessary when you want to store additional information on the relationship, for example, the date when the relationship was created, or a field that describes the nature of the relationship.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.59.1">Let’s create an intermediate model to build relationships between users. </span><span class="koboSpan" id="kobo.59.2">There are two reasons for using an intermediate model:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.60.1">You are using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.61.1">User</span></code><span class="koboSpan" id="kobo.62.1"> model provided by Django and you want to avoid altering it</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.63.1">You want to store the time when the relationship was created</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.64.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.65.1">models.py</span></code><span class="koboSpan" id="kobo.66.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.67.1">account</span></code><span class="koboSpan" id="kobo.68.1"> application and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.69.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.70.1">Contact</span></span><span class="koboSpan" id="kobo.71.1">(models.Model):
    user_from = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        related_name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.72.1">'rel_from_set'</span></span><span class="koboSpan" id="kobo.73.1">,
        on_delete=models.CASCADE
    )
    user_to = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        related_name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.74.1">'rel_to_set'</span></span><span class="koboSpan" id="kobo.75.1">,
        on_delete=models.CASCADE
    )
    created = models.DateTimeField(auto_now_add=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.76.1">True</span></span><span class="koboSpan" id="kobo.77.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.78.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.79.1">Meta</span></span><span class="koboSpan" id="kobo.80.1">:
        indexes = [
            models.Index(fields=[</span><span class="hljs-string"><span class="koboSpan" id="kobo.81.1">'-created'</span></span><span class="koboSpan" id="kobo.82.1">]),
        ]
        ordering = [</span><span class="hljs-string"><span class="koboSpan" id="kobo.83.1">'-created'</span></span><span class="koboSpan" id="kobo.84.1">]
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.85.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.86.1">__str__</span></span><span class="koboSpan" id="kobo.87.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.88.1">self</span></span><span class="koboSpan" id="kobo.89.1">):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.90.1">return</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.91.1">f'</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.92.1">{self.user_from}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.93.1"> follows </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.94.1">{self.user_to}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.95.1">'</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.96.1">The preceding code shows the </span><code class="inlineCode"><span class="koboSpan" id="kobo.97.1">Contact</span></code><span class="koboSpan" id="kobo.98.1"> model that </span><a id="_idIndexMarker627"/><span class="koboSpan" id="kobo.99.1">you will use for user relationships. </span><span class="koboSpan" id="kobo.99.2">It contains the following fields:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.100.1">user_from</span></code><span class="koboSpan" id="kobo.101.1">: A </span><code class="inlineCode"><span class="koboSpan" id="kobo.102.1">ForeignKey</span></code><span class="koboSpan" id="kobo.103.1"> for</span><a id="_idIndexMarker628"/><span class="koboSpan" id="kobo.104.1"> the user who creates the relationship</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.105.1">user_to</span></code><span class="koboSpan" id="kobo.106.1">: A </span><code class="inlineCode"><span class="koboSpan" id="kobo.107.1">ForeignKey</span></code><span class="koboSpan" id="kobo.108.1"> for the user being followed</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.109.1">created</span></code><span class="koboSpan" id="kobo.110.1">: A </span><code class="inlineCode"><span class="koboSpan" id="kobo.111.1">DateTimeField</span></code><span class="koboSpan" id="kobo.112.1"> field with </span><code class="inlineCode"><span class="koboSpan" id="kobo.113.1">auto_now_add=True</span></code><span class="koboSpan" id="kobo.114.1"> to store the time when the relationship was created</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.115.1">A database index is automatically created on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.116.1">ForeignKey</span></code><span class="koboSpan" id="kobo.117.1"> fields. </span><span class="koboSpan" id="kobo.117.2">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.118.1">Meta</span></code><span class="koboSpan" id="kobo.119.1"> class of the model, we have defined a database index in descending order for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.120.1">created</span></code><span class="koboSpan" id="kobo.121.1"> field. </span><span class="koboSpan" id="kobo.121.2">We have also added the </span><code class="inlineCode"><span class="koboSpan" id="kobo.122.1">ordering</span></code><span class="koboSpan" id="kobo.123.1"> attribute to tell Django that it should sort results by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.124.1">created</span></code><span class="koboSpan" id="kobo.125.1"> field by default. </span><span class="koboSpan" id="kobo.125.2">We indicate descending order by using a hyphen before the field name, like </span><code class="inlineCode"><span class="koboSpan" id="kobo.126.1">-created</span></code><span class="koboSpan" id="kobo.127.1">.</span></p>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.128.1">Figure 7.2</span></em><span class="koboSpan" id="kobo.129.1"> shows the intermediate </span><code class="inlineCode"><span class="koboSpan" id="kobo.130.1">Contact</span></code><span class="koboSpan" id="kobo.131.1"> model and its corresponding database table:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.132.1"><img alt="" role="presentation" src="../Images/B21088_07_02.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.133.1">Figure 7.2: The intermediate Contact model and its database table</span></p>
<p class="normal"><span class="koboSpan" id="kobo.134.1">Using the ORM, you could </span><a id="_idIndexMarker629"/><span class="koboSpan" id="kobo.135.1">create a </span><a id="_idIndexMarker630"/><span class="koboSpan" id="kobo.136.1">relationship for a user, </span><code class="inlineCode"><span class="koboSpan" id="kobo.137.1">user1</span></code><span class="koboSpan" id="kobo.138.1">, following another user, </span><code class="inlineCode"><span class="koboSpan" id="kobo.139.1">user2</span></code><span class="koboSpan" id="kobo.140.1">, like this:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.141.1">user1 = User.objects.get(</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.142.1">id</span></span><span class="koboSpan" id="kobo.143.1">=</span><span class="hljs-number"><span class="koboSpan" id="kobo.144.1">1</span></span><span class="koboSpan" id="kobo.145.1">)
user2 = User.objects.get(</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.146.1">id</span></span><span class="koboSpan" id="kobo.147.1">=</span><span class="hljs-number"><span class="koboSpan" id="kobo.148.1">2</span></span><span class="koboSpan" id="kobo.149.1">)
Contact.objects.create(user_from=user1, user_to=user2)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.150.1">The related managers, </span><code class="inlineCode"><span class="koboSpan" id="kobo.151.1">rel_from_set</span></code><span class="koboSpan" id="kobo.152.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.153.1">rel_to_set</span></code><span class="koboSpan" id="kobo.154.1">, will return a QuerySet for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.155.1">Contact</span></code><span class="koboSpan" id="kobo.156.1"> model. </span><span class="koboSpan" id="kobo.156.2">In order to access the end side of the relationship from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.157.1">User</span></code><span class="koboSpan" id="kobo.158.1"> model, it would be desirable for </span><code class="inlineCode"><span class="koboSpan" id="kobo.159.1">User</span></code><span class="koboSpan" id="kobo.160.1"> to contain a </span><code class="inlineCode"><span class="koboSpan" id="kobo.161.1">ManyToManyField</span></code><span class="koboSpan" id="kobo.162.1">, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.163.1">following = models.ManyToManyField(
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.164.1">'self'</span></span><span class="koboSpan" id="kobo.165.1">,
    through=Contact,
    related_name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.166.1">'followers'</span></span><span class="koboSpan" id="kobo.167.1">,
    symmetrical=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.168.1">False</span></span><span class="koboSpan" id="kobo.169.1">
)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.170.1">In the preceding example, you tell Django to use your custom intermediate model for the relationship by adding </span><code class="inlineCode"><span class="koboSpan" id="kobo.171.1">through=Contact</span></code><span class="koboSpan" id="kobo.172.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.173.1">ManyToManyField</span></code><span class="koboSpan" id="kobo.174.1">. </span><span class="koboSpan" id="kobo.174.2">This is a many-to-many relationship from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.175.1">User</span></code><span class="koboSpan" id="kobo.176.1"> model to itself; you refer to </span><code class="inlineCode"><span class="koboSpan" id="kobo.177.1">'self'</span></code><span class="koboSpan" id="kobo.178.1"> in </span><code class="inlineCode"><span class="koboSpan" id="kobo.179.1">ManyToManyField</span></code><span class="koboSpan" id="kobo.180.1"> to create a relationship to the same model.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.181.1">When you need additional fields in a many-to-many relationship, create a custom model with a </span><code class="inlineCode"><span class="koboSpan" id="kobo.182.1">ForeignKey</span></code><span class="koboSpan" id="kobo.183.1"> for each side of the relationship. </span><span class="koboSpan" id="kobo.183.2">You can manage the relationship using the intermediate model, or you can add a </span><code class="inlineCode"><span class="koboSpan" id="kobo.184.1">ManyToManyField</span></code><span class="koboSpan" id="kobo.185.1"> field in one of the related models and indicate to Django that your intermediate model should be used by including it in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.186.1">through</span></code><span class="koboSpan" id="kobo.187.1"> parameter.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.188.1">If the </span><code class="inlineCode"><span class="koboSpan" id="kobo.189.1">User</span></code><span class="koboSpan" id="kobo.190.1"> model was part</span><a id="_idIndexMarker631"/><span class="koboSpan" id="kobo.191.1"> of your application, you could add the previous field to the model. </span><span class="koboSpan" id="kobo.191.2">However, you can’t alter the </span><code class="inlineCode"><span class="koboSpan" id="kobo.192.1">User</span></code><span class="koboSpan" id="kobo.193.1"> class directly because it belongs to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.194.1">django.contrib.auth</span></code><span class="koboSpan" id="kobo.195.1"> application. </span><span class="koboSpan" id="kobo.195.2">Let’s take</span><a id="_idIndexMarker632"/><span class="koboSpan" id="kobo.196.1"> a slightly different approach by adding this field dynamically to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.197.1">User</span></code><span class="koboSpan" id="kobo.198.1"> model.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.199.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.200.1">models.py</span></code><span class="koboSpan" id="kobo.201.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.202.1">account</span></code><span class="koboSpan" id="kobo.203.1"> application and add the following lines highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.204.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.205.1"> django.contrib.auth </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.206.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.207.1"> get_user_model</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.208.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.209.1"># Add the following field to User dynamically</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.210.1">user_model = get_user_model()</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.211.1">user_model.add_to_class(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.212.1">'following'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.213.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.214.1">    models.ManyToManyField(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.215.1">'self'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.216.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.217.1">        through=Contact,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.218.1">        related_name=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.219.1">'followers'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.220.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.221.1">        symmetrical=</span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.222.1">False</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.223.1">    )</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.224.1">)</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.225.1">In the preceding code, you retrieve the user model with the generic function </span><code class="inlineCode"><span class="koboSpan" id="kobo.226.1">get_user_model()</span></code><span class="koboSpan" id="kobo.227.1"> provided by Django. </span><span class="koboSpan" id="kobo.227.2">You use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.228.1">add_to_class()</span></code><span class="koboSpan" id="kobo.229.1"> method of Django models to monkey patch the </span><code class="inlineCode"><span class="koboSpan" id="kobo.230.1">User</span></code><span class="koboSpan" id="kobo.231.1"> model.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.232.1">Be mindful that using </span><code class="inlineCode"><span class="koboSpan" id="kobo.233.1">add_to_class()</span></code><span class="koboSpan" id="kobo.234.1"> is not the recommended way of adding fields to models. </span><span class="koboSpan" id="kobo.234.2">However, you can take advantage of using it in this case to avoid creating a custom user model, keeping all the advantages of Django’s built-in </span><code class="inlineCode"><span class="koboSpan" id="kobo.235.1">User</span></code><span class="koboSpan" id="kobo.236.1"> model.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.237.1">You also simplify the way that you retrieve related objects using the Django ORM with </span><code class="inlineCode"><span class="koboSpan" id="kobo.238.1">user.followers.all()</span></code><span class="koboSpan" id="kobo.239.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.240.1">user.following.all()</span></code><span class="koboSpan" id="kobo.241.1">. </span><span class="koboSpan" id="kobo.241.2">You use the intermediate </span><code class="inlineCode"><span class="koboSpan" id="kobo.242.1">Contact</span></code><span class="koboSpan" id="kobo.243.1"> model and avoid complex queries that would involve additional database joins, as would have been the case had you defined the relationship in your custom </span><code class="inlineCode"><span class="koboSpan" id="kobo.244.1">Profile</span></code><span class="koboSpan" id="kobo.245.1"> model. </span><span class="koboSpan" id="kobo.245.2">The table for this many-to-many relationship will be created using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.246.1">Contact</span></code><span class="koboSpan" id="kobo.247.1"> model. </span><span class="koboSpan" id="kobo.247.2">Thus, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.248.1">ManyToManyField</span></code><span class="koboSpan" id="kobo.249.1">, added dynamically, will not imply any database changes for the Django </span><code class="inlineCode"><span class="koboSpan" id="kobo.250.1">User</span></code><span class="koboSpan" id="kobo.251.1"> model.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.252.1">Keep in mind that, in most </span><a id="_idIndexMarker633"/><span class="koboSpan" id="kobo.253.1">cases, it is preferable to add fields to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.254.1">Profile</span></code><span class="koboSpan" id="kobo.255.1"> model you created before, instead of monkey patching the </span><code class="inlineCode"><span class="koboSpan" id="kobo.256.1">User</span></code><span class="koboSpan" id="kobo.257.1"> model. </span><span class="koboSpan" id="kobo.257.2">Ideally, you shouldn’t alter the existing Django </span><code class="inlineCode"><span class="koboSpan" id="kobo.258.1">User</span></code><span class="koboSpan" id="kobo.259.1"> model. </span><span class="koboSpan" id="kobo.259.2">Django </span><a id="_idIndexMarker634"/><span class="koboSpan" id="kobo.260.1">allows you to use custom user models. </span><span class="koboSpan" id="kobo.260.2">If you want to use a custom user model, take a look at the documentation at </span><a href="https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#specifying-a-custom-user-model"><span class="url"><span class="koboSpan" id="kobo.261.1">https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#specifying-a-custom-user-model</span></span></a><span class="koboSpan" id="kobo.262.1">.</span></p>
<div class="packt_tip">
<p class="normal"><span class="koboSpan" id="kobo.263.1">When you start a new project, it is highly recommended that you create a custom user model, even if the default </span><code class="inlineCode"><span class="koboSpan" id="kobo.264.1">User</span></code><span class="koboSpan" id="kobo.265.1"> model is sufficient for you. </span><span class="koboSpan" id="kobo.265.2">This is because you gain the option of customizing the model.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.266.1">Note that the relationship includes </span><code class="inlineCode"><span class="koboSpan" id="kobo.267.1">symmetrical=False</span></code><span class="koboSpan" id="kobo.268.1">. </span><span class="koboSpan" id="kobo.268.2">When you define a </span><code class="inlineCode"><span class="koboSpan" id="kobo.269.1">ManyToManyField</span></code><span class="koboSpan" id="kobo.270.1"> in the model creating a relationship with itself, Django forces the relationship to be symmetrical. </span><span class="koboSpan" id="kobo.270.2">In this case, you are setting </span><code class="inlineCode"><span class="koboSpan" id="kobo.271.1">symmetrical=False</span></code><span class="koboSpan" id="kobo.272.1"> to define a non-symmetrical relationship (if I follow you, it doesn’t mean that you automatically follow me).</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.273.1">When you use an intermediate model for many-to-many relationships, some of the related manager’s methods are disabled, such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.274.1">add()</span></code><span class="koboSpan" id="kobo.275.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.276.1">create()</span></code><span class="koboSpan" id="kobo.277.1">, or </span><code class="inlineCode"><span class="koboSpan" id="kobo.278.1">remove()</span></code><span class="koboSpan" id="kobo.279.1">. </span><span class="koboSpan" id="kobo.279.2">You need to create or delete instances of the intermediate model instead.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.280.1">Run the following command to generate the initial migrations for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.281.1">account</span></code><span class="koboSpan" id="kobo.282.1"> application:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.283.1">python manage.py makemigrations account
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.284.1">You will obtain an output like the following one:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.285.1">Migrations for 'account':
  account/migrations/0002_contact.py
    - Create model Contact
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.286.1">Now, run the following command to sync the application with the database:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.287.1">python manage.py migrate account
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.288.1">You should see an output that includes the following line:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.289.1">Applying account.0002_contact... </span><span class="koboSpan" id="kobo.289.2">OK
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.290.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.291.1">Contact</span></code><span class="koboSpan" id="kobo.292.1"> model is now </span><a id="_idIndexMarker635"/><span class="koboSpan" id="kobo.293.1">synced to the database, and you are able to create relationships between users. </span><span class="koboSpan" id="kobo.293.2">However, your </span><a id="_idIndexMarker636"/><span class="koboSpan" id="kobo.294.1">site doesn’t offer a way to browse users or see a particular user’s profile yet. </span><span class="koboSpan" id="kobo.294.2">Let’s build the list and detail views for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.295.1">User</span></code><span class="koboSpan" id="kobo.296.1"> model.</span></p>
<h2 class="heading-2" id="_idParaDest-197"><span class="koboSpan" id="kobo.297.1">Creating list and detail views for user profiles</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.298.1">Open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.299.1">views.py</span></code><span class="koboSpan" id="kobo.300.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.301.1">account</span></code><span class="koboSpan" id="kobo.302.1"> application</span><a id="_idIndexMarker637"/><span class="koboSpan" id="kobo.303.1"> and add the following </span><a id="_idIndexMarker638"/><span class="koboSpan" id="kobo.304.1">code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.305.1">from</span></span><span class="koboSpan" id="kobo.306.1"> django.contrib.auth </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.307.1">import </span></span><span class="koboSpan" id="kobo.308.1">authenticate, </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.309.1">get_user_model, </span></strong></span><span class="koboSpan" id="kobo.310.1">login
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.311.1">from</span></span><span class="koboSpan" id="kobo.312.1"> django.shortcuts </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.313.1">import</span></span> <span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.314.1">get_object_or_404, </span></strong></span><span class="koboSpan" id="kobo.315.1">render
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.316.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.317.1">User = get_user_model()</span></strong></span>
<span class="code-highlight"><strong class="hljs-meta-slc"><span class="koboSpan" id="kobo.318.1">@login_required</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.319.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.320.1">user_list</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.321.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.322.1">request</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.323.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.324.1">    users = User.objects.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.325.1">filter</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.326.1">(is_active=</span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.327.1">True</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.328.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.329.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.330.1"> render(</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"> </strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.331.1">request,</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.332.1">'account/user/list.html'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.333.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"> </strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.334.1">{</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.335.1">'section'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.336.1">: </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.337.1">'people'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.338.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.339.1">'users'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.340.1">: users}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.341.1">    )</span></strong></span>
<span class="code-highlight"><strong class="hljs-meta-slc"><span class="koboSpan" id="kobo.342.1">@login_required</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.343.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.344.1">user_detail</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.345.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.346.1">request, username</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.347.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.348.1">    user = get_object_or_404(User, username=username, is_active=</span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.349.1">True</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.350.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.351.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.352.1"> render(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.353.1">        request,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.354.1">'account/user/detail.html'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.355.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.356.1">        {</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.357.1">'section'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.358.1">: </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.359.1">'people'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.360.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.361.1">'user'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.362.1">: user}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.363.1">    )</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.364.1">These are simple list and detail views for </span><code class="inlineCode"><span class="koboSpan" id="kobo.365.1">User</span></code><span class="koboSpan" id="kobo.366.1"> objects. </span><span class="koboSpan" id="kobo.366.2">We retrieve the </span><code class="inlineCode"><span class="koboSpan" id="kobo.367.1">User</span></code><span class="koboSpan" id="kobo.368.1"> model dynamically using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.369.1">get_user_model()</span></code><span class="koboSpan" id="kobo.370.1"> function. </span><span class="koboSpan" id="kobo.370.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.371.1">user_list</span></code><span class="koboSpan" id="kobo.372.1"> view gets all active users. </span><span class="koboSpan" id="kobo.372.2">The Django </span><code class="inlineCode"><span class="koboSpan" id="kobo.373.1">User</span></code><span class="koboSpan" id="kobo.374.1"> model contains an </span><code class="inlineCode"><span class="koboSpan" id="kobo.375.1">is_active</span></code><span class="koboSpan" id="kobo.376.1"> flag to designate whether the user account is considered active. </span><span class="koboSpan" id="kobo.376.2">You filter the query by </span><code class="inlineCode"><span class="koboSpan" id="kobo.377.1">is_active=True</span></code><span class="koboSpan" id="kobo.378.1"> to return only active users. </span><span class="koboSpan" id="kobo.378.2">This view returns </span><a id="_idIndexMarker639"/><span class="koboSpan" id="kobo.379.1">all results, but you can improve it by </span><a id="_idIndexMarker640"/><span class="koboSpan" id="kobo.380.1">adding pagination in the same way as you did for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.381.1">image_list</span></code><span class="koboSpan" id="kobo.382.1"> view.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.383.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.384.1">user_detail</span></code><span class="koboSpan" id="kobo.385.1"> view uses the </span><code class="inlineCode"><span class="koboSpan" id="kobo.386.1">get_object_or_404()</span></code><span class="koboSpan" id="kobo.387.1"> shortcut to retrieve the active user with the given username. </span><span class="koboSpan" id="kobo.387.2">The view returns an HTTP </span><code class="inlineCode"><span class="koboSpan" id="kobo.388.1">404</span></code><span class="koboSpan" id="kobo.389.1"> response if no active user with the given username is found.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.390.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.391.1">urls.py</span></code><span class="koboSpan" id="kobo.392.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.393.1">account</span></code><span class="koboSpan" id="kobo.394.1"> application and add a URL pattern for each view, as follows. </span><span class="koboSpan" id="kobo.394.2">The new code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.395.1">urlpatterns = [
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.396.1"># ...</span></span><span class="koboSpan" id="kobo.397.1">
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.398.1">''</span></span><span class="koboSpan" id="kobo.399.1">, include(</span><span class="hljs-string"><span class="koboSpan" id="kobo.400.1">'django.contrib.auth.urls'</span></span><span class="koboSpan" id="kobo.401.1">)),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.402.1">''</span></span><span class="koboSpan" id="kobo.403.1">, views.dashboard, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.404.1">'dashboard'</span></span><span class="koboSpan" id="kobo.405.1">),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.406.1">'register/'</span></span><span class="koboSpan" id="kobo.407.1">, views.register, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.408.1">'register'</span></span><span class="koboSpan" id="kobo.409.1">),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.410.1">'edit/'</span></span><span class="koboSpan" id="kobo.411.1">, views.edit, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.412.1">'edit'</span></span><span class="koboSpan" id="kobo.413.1">),
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.414.1">    path(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.415.1">'users/'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.416.1">, views.user_list, name=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.417.1">'user_list'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.418.1">),</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.419.1">    path(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.420.1">'users/&lt;username&gt;/'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.421.1">, views.user_detail, name=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.422.1">'user_detail'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.423.1">),</span></strong></span><span class="koboSpan" id="kobo.424.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.425.1">You will use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.426.1">user_detail</span></code><span class="koboSpan" id="kobo.427.1"> URL pattern to generate the canonical URL for users. </span><span class="koboSpan" id="kobo.427.2">You have already defined a </span><code class="inlineCode"><span class="koboSpan" id="kobo.428.1">get_absolute_url()</span></code><span class="koboSpan" id="kobo.429.1"> method in a model to return the canonical URL for each object. </span><span class="koboSpan" id="kobo.429.2">Another way to specify the URL for a model is by adding the </span><code class="inlineCode"><span class="koboSpan" id="kobo.430.1">ABSOLUTE_URL_OVERRIDES</span></code><span class="koboSpan" id="kobo.431.1"> setting to your </span><a id="_idIndexMarker641"/><span class="koboSpan" id="kobo.432.1">project.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.433.1">By using the username instead of the user ID in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.434.1">user_detail</span></code><span class="koboSpan" id="kobo.435.1"> URL pattern, you enhance both usability and security. </span><span class="koboSpan" id="kobo.435.2">Usernames, unlike sequential IDs, thwart enumeration attacks by obscuring your data structure. </span><span class="koboSpan" id="kobo.435.3">This makes it harder for attackers to predict URLs and formulate attack vectors.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.436.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.437.1">settings.py</span></code><span class="koboSpan" id="kobo.438.1"> file of your project and add the following code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.439.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.440.1"> django.urls </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.441.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.442.1"> reverse_lazy</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.443.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.444.1">ABSOLUTE_URL_OVERRIDES = {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.445.1">'auth.user'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.446.1">: </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.447.1">lambda</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.448.1"> u: reverse_lazy(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.449.1">'user_detail'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.450.1">, args=[u.username])</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.451.1">}</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.452.1">Django adds a </span><code class="inlineCode"><span class="koboSpan" id="kobo.453.1">get_absolute_url()</span></code><span class="koboSpan" id="kobo.454.1"> method dynamically to any models that appear in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.455.1">ABSOLUTE_URL_OVERRIDES</span></code><span class="koboSpan" id="kobo.456.1"> setting. </span><span class="koboSpan" id="kobo.456.2">This method returns the corresponding URL for the given model specified in the setting. </span><span class="koboSpan" id="kobo.456.3">In the </span><a id="_idIndexMarker642"/><span class="koboSpan" id="kobo.457.1">previous code section, you generate the </span><code class="inlineCode"><span class="koboSpan" id="kobo.458.1">user_detail</span></code><span class="koboSpan" id="kobo.459.1"> URL for the given user for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.460.1">auth.user</span></code><span class="koboSpan" id="kobo.461.1"> object. </span><span class="koboSpan" id="kobo.461.2">Now, you can use </span><code class="inlineCode"><span class="koboSpan" id="kobo.462.1">get_absolute_url()</span></code><span class="koboSpan" id="kobo.463.1"> on a </span><code class="inlineCode"><span class="koboSpan" id="kobo.464.1">User</span></code><span class="koboSpan" id="kobo.465.1"> instance to retrieve its corresponding URL.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.466.1">Open the Python shell with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.467.1">python manage.py shell
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.468.1">Then run the following code to test it:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.469.1">&gt;&gt;&gt;</span></span> <span class="hljs-con-keyword"><span class="koboSpan" id="kobo.470.1">from</span></span><span class="koboSpan" id="kobo.471.1"> django.contrib.auth.models </span><span class="hljs-con-keyword"><span class="koboSpan" id="kobo.472.1">import</span></span><span class="koboSpan" id="kobo.473.1"> User
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.474.1">&gt;&gt;&gt;</span></span><span class="koboSpan" id="kobo.475.1"> user = User.objects.latest(</span><span class="hljs-con-string"><span class="koboSpan" id="kobo.476.1">'id'</span></span><span class="koboSpan" id="kobo.477.1">)
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.478.1">&gt;&gt;&gt;</span></span> <span class="hljs-con-built_in"><span class="koboSpan" id="kobo.479.1">str</span></span><span class="koboSpan" id="kobo.480.1">(user.get_absolute_url())
'/account/users/ellington/'
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.481.1">The returned URL follows the expected format, </span><code class="inlineCode"><span class="koboSpan" id="kobo.482.1">/account/users/&lt;username&gt;/</span></code><span class="koboSpan" id="kobo.483.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.484.1">You will need to create templates </span><a id="_idIndexMarker643"/><span class="koboSpan" id="kobo.485.1">for the views that you just built. </span><span class="koboSpan" id="kobo.485.2">Add the following directory and files to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.486.1">templates/account/</span></code><span class="koboSpan" id="kobo.487.1"> directory of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.488.1">account</span></code><span class="koboSpan" id="kobo.489.1"> application:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.490.1">/user/
    detail.html
    list.html
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.491.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.492.1">account/user/list.html</span></code><span class="koboSpan" id="kobo.493.1"> template </span><a id="_idIndexMarker644"/><span class="koboSpan" id="kobo.494.1">and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.495.1">{% extends "base.html" %}
{% load thumbnail %}
{% block title %}People{% endblock %}
{% block content %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.496.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.497.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.498.1">&gt;</span></span><span class="koboSpan" id="kobo.499.1">People</span><span class="hljs-tag"><span class="koboSpan" id="kobo.500.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.501.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.502.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.503.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.504.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.505.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.506.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.507.1">"people-list"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.508.1">&gt;</span></span><span class="koboSpan" id="kobo.509.1">
    {% for user in users %}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.510.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.511.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.512.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.513.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.514.1">"user"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.515.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.516.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.517.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.518.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.519.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.520.1">"{{ user.get_absolute_url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.521.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.522.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.523.1">img</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.524.1">src</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.525.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.526.1">"{% thumbnail user.profile.photo 180x180 %}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.527.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.528.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.529.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.530.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.531.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.532.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.533.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.534.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.535.1">"info"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.536.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.537.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.538.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.539.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.540.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.541.1">"{{ user.get_absolute_url }}"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.542.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.543.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.544.1">"title"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.545.1">&gt;</span></span><span class="koboSpan" id="kobo.546.1">
            {{ user.get_full_name }}
          </span><span class="hljs-tag"><span class="koboSpan" id="kobo.547.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.548.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.549.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.550.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.551.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.552.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.553.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.554.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.555.1">&gt;</span></span><span class="koboSpan" id="kobo.556.1">
    {% endfor %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.557.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.558.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.559.1">&gt;</span></span><span class="koboSpan" id="kobo.560.1">
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.561.1">The preceding template allows you to list all the active users on the site. </span><span class="koboSpan" id="kobo.561.2">You iterate over the given users and use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.562.1">{% thumbnail %}</span></code><span class="koboSpan" id="kobo.563.1"> template tag from </span><code class="inlineCode"><span class="koboSpan" id="kobo.564.1">easy-thumbnails</span></code><span class="koboSpan" id="kobo.565.1"> to generate profile image thumbnails.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.566.1">Note that the users need to have a profile image. </span><span class="koboSpan" id="kobo.566.2">To use a default image for users that don’t have a profile image, you can add an </span><code class="inlineCode"><span class="koboSpan" id="kobo.567.1">if</span></code><span class="koboSpan" id="kobo.568.1">/</span><code class="inlineCode"><span class="koboSpan" id="kobo.569.1">else</span></code><span class="koboSpan" id="kobo.570.1"> statement to check whether the user has a profile photo, like </span><code class="inlineCode"><span class="koboSpan" id="kobo.571.1">{% if user.profile.photo %} {# photo thumbnail #} {% else %} {# default image #} {% endif %}</span></code><span class="koboSpan" id="kobo.572.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.573.1">Open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.574.1">base.html</span></code><span class="koboSpan" id="kobo.575.1"> template of your</span><a id="_idIndexMarker645"/><span class="koboSpan" id="kobo.576.1"> project and include the </span><code class="inlineCode"><span class="koboSpan" id="kobo.577.1">user_list</span></code><span class="koboSpan" id="kobo.578.1"> URL in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.579.1">href</span></code><span class="koboSpan" id="kobo.580.1"> attribute of the following menu item. </span><span class="koboSpan" id="kobo.580.2">The new code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.581.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.582.1">ul</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.583.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.584.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.585.1">"menu"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.586.1">&gt;</span></span><span class="koboSpan" id="kobo.587.1">
  ...
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.588.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.589.1">li</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.590.1"> {% </span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.591.1">if</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.592.1">section</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.593.1"> == </span></span><span class="hljs-string"><span class="koboSpan" id="kobo.594.1">"people"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.595.1"> %}</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.596.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.597.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.598.1">"selected"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.599.1">{% </span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.600.1">endif</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.601.1"> %}&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.602.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.603.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.604.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.605.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.606.1">"</span></span><span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.607.1">{% url "</span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.608.1">user_list</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.609.1">" %}"</span></strong></span><span class="hljs-tag"><span class="koboSpan" id="kobo.610.1">&gt;</span></span><span class="koboSpan" id="kobo.611.1">People</span><span class="hljs-tag"><span class="koboSpan" id="kobo.612.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.613.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.614.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.615.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.616.1">li</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.617.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.618.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.619.1">ul</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.620.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.621.1">Start the development server</span><a id="_idIndexMarker646"/><span class="koboSpan" id="kobo.622.1"> with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.623.1">python manage.py runserver
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.624.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.625.1">http://127.0.0.1:8000/account/users/</span></code><span class="koboSpan" id="kobo.626.1"> in your browser. </span><span class="koboSpan" id="kobo.626.2">You should see a list of users like the following one:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.627.1"><img alt="Graphical user interface, text, website  Description automatically generated" src="../Images/B21088_07_03.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.628.1">Figure 7.3: The user list page with profile image thumbnails</span></p>
<p class="normal"><span class="koboSpan" id="kobo.629.1">Remember that if you have any</span><a id="_idIndexMarker647"/><span class="koboSpan" id="kobo.630.1"> difficulty generating thumbnails, you can add </span><code class="inlineCode"><span class="koboSpan" id="kobo.631.1">THUMBNAIL_DEBUG = True</span></code><span class="koboSpan" id="kobo.632.1"> to your </span><code class="inlineCode"><span class="koboSpan" id="kobo.633.1">settings.py</span></code><span class="koboSpan" id="kobo.634.1"> file in order to obtain debug information in the shell.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.635.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.636.1">account/user/detail.html</span></code><span class="koboSpan" id="kobo.637.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.638.1">account</span></code><span class="koboSpan" id="kobo.639.1"> application and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.640.1">{% extends "base.html" %}
{% load thumbnail %}
{% block title %}{{ user.get_full_name }}{% endblock %}
{% block content %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.641.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.642.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.643.1">&gt;</span></span><span class="koboSpan" id="kobo.644.1">{{ user.get_full_name }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.645.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.646.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.647.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.648.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.649.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.650.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.651.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.652.1">"profile-info"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.653.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.654.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.655.1">img</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.656.1">src</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.657.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.658.1">"{% thumbnail user.profile.photo 180x180 %}"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.659.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.660.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.661.1">"user-detail"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.662.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.663.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.664.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.665.1">&gt;</span></span><span class="koboSpan" id="kobo.666.1">
  {% with total_followers=user.followers.count %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.667.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.668.1">span</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.669.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.670.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.671.1">"count"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.672.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.673.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.674.1">span</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.675.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.676.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.677.1">"total"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.678.1">&gt;</span></span><span class="koboSpan" id="kobo.679.1">{{ total_followers }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.680.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.681.1">span</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.682.1">&gt;</span></span><span class="koboSpan" id="kobo.683.1">
      follower{{ total_followers|pluralize }}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.684.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.685.1">span</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.686.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.687.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.688.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.689.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.690.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.691.1">"#"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.692.1">data-id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.693.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.694.1">"{{ user.id }}"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.695.1">data-action</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.696.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.697.1">"{% if request.user in user.followers.all %}un{% endif %}follow"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.698.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.699.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.700.1">"follow button"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.701.1">&gt;</span></span><span class="koboSpan" id="kobo.702.1">
      {% if request.user not in user.followers.all %}
        Follow
      {% else %}
        Unfollow
      {% endif %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.703.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.704.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.705.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.706.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.707.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.708.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.709.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.710.1">"image-list"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.711.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.712.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.713.1">"image-container"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.714.1">&gt;</span></span><span class="koboSpan" id="kobo.715.1">
      {% include "images/image/list_images.html" with images=user.images_created.all %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.716.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.717.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.718.1">&gt;</span></span><span class="koboSpan" id="kobo.719.1">
  {% endwith %}
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.720.1">Make sure that no template tag is </span><a id="_idIndexMarker648"/><span class="koboSpan" id="kobo.721.1">split into multiple lines; Django doesn’t support multiple-line tags.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.722.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.723.1">detail</span></code><span class="koboSpan" id="kobo.724.1"> template, the user profile is displayed, and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.725.1">{% thumbnail %}</span></code><span class="koboSpan" id="kobo.726.1"> template tag is used to show the profile</span><a id="_idIndexMarker649"/><span class="koboSpan" id="kobo.727.1"> image. </span><span class="koboSpan" id="kobo.727.2">The total number of followers is presented along with a link to follow or unfollow the user. </span><span class="koboSpan" id="kobo.727.3">This link will be used to follow/unfollow a particular user. </span><span class="koboSpan" id="kobo.727.4">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.728.1">data-id</span></code><span class="koboSpan" id="kobo.729.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.730.1">data-action</span></code><span class="koboSpan" id="kobo.731.1"> attributes of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.732.1">&lt;a&gt;</span></code><span class="koboSpan" id="kobo.733.1"> HTML element contain the user ID and the initial action to perform when the link element is clicked – </span><code class="inlineCode"><span class="koboSpan" id="kobo.734.1">follow</span></code><span class="koboSpan" id="kobo.735.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.736.1">unfollow</span></code><span class="koboSpan" id="kobo.737.1">. </span><span class="koboSpan" id="kobo.737.2">The initial action (</span><em class="italic"><span class="koboSpan" id="kobo.738.1">follow</span></em><span class="koboSpan" id="kobo.739.1"> or </span><em class="italic"><span class="koboSpan" id="kobo.740.1">unfollow</span></em><span class="koboSpan" id="kobo.741.1">) depends on whether the user requesting the page is already a follower of the user. </span><span class="koboSpan" id="kobo.741.2">The images bookmarked by the user are displayed by including the </span><code class="inlineCode"><span class="koboSpan" id="kobo.742.1">images/image/list_images.html</span></code><span class="koboSpan" id="kobo.743.1"> template.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.744.1">Open your browser again and click on a user who has bookmarked some images. </span><span class="koboSpan" id="kobo.744.2">The user page will look as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.745.1"><img alt="Graphical user interface, text, application, website  Description automatically generated" src="../Images/B21088_07_04.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.746.1">Figure 7.4: The user detail page</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.747.1">The preceding</span><a id="_idIndexMarker650"/><span class="koboSpan" id="kobo.748.1"> image is of </span><em class="italic"><span class="koboSpan" id="kobo.749.1">Chick Corea</span></em><span class="koboSpan" id="kobo.750.1"> by ataelw (Creative </span><a id="_idIndexMarker651"/><span class="koboSpan" id="kobo.751.1">Commons Attribution 2.0 Generic license: </span><a href="https://creativecommons.org/licenses/by/2.0/"><span class="url"><span class="koboSpan" id="kobo.752.1">https://creativecommons.org/licenses/by/2.0/</span></span></a><span class="koboSpan" id="kobo.753.1">).</span></p>
</div>
<h2 class="heading-2" id="_idParaDest-198"><span class="koboSpan" id="kobo.754.1">Adding user follow/unfollow actions with JavaScript</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.755.1">Let’s add functionality to follow/unfollow users. </span><span class="koboSpan" id="kobo.755.2">We will create a new view to follow/unfollow users</span><a id="_idIndexMarker652"/><span class="koboSpan" id="kobo.756.1"> and implement an asynchronous HTTP request with JavaScript for the follow/unfollow action.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.757.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.758.1">views.py</span></code><span class="koboSpan" id="kobo.759.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.760.1">account</span></code><span class="koboSpan" id="kobo.761.1"> application and add the following code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.762.1">from</span></span><span class="koboSpan" id="kobo.763.1"> django.http </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.764.1">import</span></span><span class="koboSpan" id="kobo.765.1"> HttpResponse</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.766.1">, JsonResponse</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.767.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.768.1"> django.views.decorators.http </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.769.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.770.1"> require_POST</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.771.1">from</span></span><span class="koboSpan" id="kobo.772.1"> .models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.773.1">import</span></span> <span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.774.1">Contact, </span></strong></span><span class="koboSpan" id="kobo.775.1">Profile
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.776.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-meta-slc"><span class="koboSpan" id="kobo.777.1">@require_POST</span></strong></span>
<span class="code-highlight"><strong class="hljs-meta-slc"><span class="koboSpan" id="kobo.778.1">@login_required</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.779.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.780.1">user_follow</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.781.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.782.1">request</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.783.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.784.1">    user_id = request.POST.get(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.785.1">'id'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.786.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.787.1">    action = request.POST.get(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.788.1">'action'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.789.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.790.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.791.1"> user_id </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.792.1">and</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.793.1"> action:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.794.1">try</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.795.1">:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.796.1">            user = User.objects.get(</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.797.1">id</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.798.1">=user_id)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.799.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.800.1"> action == </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.801.1">'follow'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.802.1">:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.803.1">                Contact.objects.get_or_create(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.804.1">                    user_from=request.user,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.805.1">                    user_to=user</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.806.1">                )</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.807.1">else</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.808.1">:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.809.1">                Contact.objects.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.810.1">filter</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.811.1">(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.812.1">                    user_from=request.user,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.813.1">                    user_to=user</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.814.1">                ).delete()</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.815.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.816.1"> JsonResponse({</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.817.1">'status'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.818.1">:</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.819.1">'ok'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.820.1">})</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.821.1">except</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.822.1"> User.DoesNotExist:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.823.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.824.1"> JsonResponse({</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.825.1">'status'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.826.1">:</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.827.1">'error'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.828.1">})</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.829.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.830.1"> JsonResponse({</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.831.1">'status'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.832.1">:</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.833.1">'error'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.834.1">})</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.835.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.836.1">user_follow</span></code><span class="koboSpan" id="kobo.837.1"> view is quite similar</span><a id="_idIndexMarker653"/><span class="koboSpan" id="kobo.838.1"> to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.839.1">image_like</span></code><span class="koboSpan" id="kobo.840.1"> view that you created in </span><em class="italic"><span class="koboSpan" id="kobo.841.1">Chapter 6</span></em><span class="koboSpan" id="kobo.842.1">, </span><em class="italic"><span class="koboSpan" id="kobo.843.1">Sharing Content on Your Website</span></em><span class="koboSpan" id="kobo.844.1">. </span><span class="koboSpan" id="kobo.844.2">Since you are using a custom intermediate model for the user’s many-to-many relationship, the default </span><code class="inlineCode"><span class="koboSpan" id="kobo.845.1">add()</span></code><span class="koboSpan" id="kobo.846.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.847.1">remove()</span></code><span class="koboSpan" id="kobo.848.1"> methods of the automatic manager of </span><code class="inlineCode"><span class="koboSpan" id="kobo.849.1">ManyToManyField</span></code><span class="koboSpan" id="kobo.850.1"> are not available. </span><span class="koboSpan" id="kobo.850.2">Instead, the intermediate </span><code class="inlineCode"><span class="koboSpan" id="kobo.851.1">Contact</span></code><span class="koboSpan" id="kobo.852.1"> model is used to create or delete user relationships.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.853.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.854.1">urls.py</span></code><span class="koboSpan" id="kobo.855.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.856.1">account</span></code><span class="koboSpan" id="kobo.857.1"> application and add the following URL pattern highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.858.1">urlpatterns = [
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.859.1">''</span></span><span class="koboSpan" id="kobo.860.1">, include(</span><span class="hljs-string"><span class="koboSpan" id="kobo.861.1">'django.contrib.auth.urls'</span></span><span class="koboSpan" id="kobo.862.1">)),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.863.1">''</span></span><span class="koboSpan" id="kobo.864.1">, views.dashboard, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.865.1">'dashboard'</span></span><span class="koboSpan" id="kobo.866.1">),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.867.1">'register/'</span></span><span class="koboSpan" id="kobo.868.1">, views.register, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.869.1">'register'</span></span><span class="koboSpan" id="kobo.870.1">),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.871.1">'edit/'</span></span><span class="koboSpan" id="kobo.872.1">, views.edit, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.873.1">'edit'</span></span><span class="koboSpan" id="kobo.874.1">),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.875.1">'users/'</span></span><span class="koboSpan" id="kobo.876.1">, views.user_list, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.877.1">'user_list'</span></span><span class="koboSpan" id="kobo.878.1">),
    </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.879.1">path(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.880.1">'</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.881.1">users/follow/'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.882.1">, views.user_follow, name=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.883.1">'user_follow'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.884.1">),</span></strong></span><span class="koboSpan" id="kobo.885.1">
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.886.1">'users/&lt;username&gt;/'</span></span><span class="koboSpan" id="kobo.887.1">, views.user_detail, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.888.1">'user_detail'</span></span><span class="koboSpan" id="kobo.889.1">),
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.890.1">Ensure that you place the preceding</span><a id="_idIndexMarker654"/><span class="koboSpan" id="kobo.891.1"> pattern before the </span><code class="inlineCode"><span class="koboSpan" id="kobo.892.1">user_detail</span></code><span class="koboSpan" id="kobo.893.1"> URL pattern. </span><span class="koboSpan" id="kobo.893.2">Otherwise, any requests to </span><code class="inlineCode"><span class="koboSpan" id="kobo.894.1">/users/follow/</span></code><span class="koboSpan" id="kobo.895.1"> will match the regular expression of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.896.1">user_detail</span></code><span class="koboSpan" id="kobo.897.1"> pattern and that view will be executed </span><a id="_idIndexMarker655"/><span class="koboSpan" id="kobo.898.1">instead. </span><span class="koboSpan" id="kobo.898.2">Remember that in every HTTP request, Django checks the requested URL against each pattern in order of appearance and stops at the first match.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.899.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.900.1">user/detail.html</span></code><span class="koboSpan" id="kobo.901.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.902.1">account</span></code><span class="koboSpan" id="kobo.903.1"> application and append the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.904.1">{% block domready %}
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.905.1">const</span></span><span class="koboSpan" id="kobo.906.1"> url = </span><span class="hljs-string"><span class="koboSpan" id="kobo.907.1">'{% url "user_follow" %}'</span></span><span class="koboSpan" id="kobo.908.1">;
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.909.1">var</span></span><span class="koboSpan" id="kobo.910.1"> options = {
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.911.1">method</span></span><span class="koboSpan" id="kobo.912.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.913.1">'POST'</span></span><span class="koboSpan" id="kobo.914.1">,
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.915.1">headers</span></span><span class="koboSpan" id="kobo.916.1">: {</span><span class="hljs-string"><span class="koboSpan" id="kobo.917.1">'X-CSRFToken'</span></span><span class="koboSpan" id="kobo.918.1">: csrftoken},
    </span><span class="hljs-attr"><span class="koboSpan" id="kobo.919.1">mode</span></span><span class="koboSpan" id="kobo.920.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.921.1">'same-origin'</span></span><span class="koboSpan" id="kobo.922.1">
  }
  </span><span class="hljs-variable"><span class="koboSpan" id="kobo.923.1">document</span></span><span class="koboSpan" id="kobo.924.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.925.1">querySelector</span></span><span class="koboSpan" id="kobo.926.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.927.1">'a.follow'</span></span><span class="koboSpan" id="kobo.928.1">)
          .</span><span class="hljs-title"><span class="koboSpan" id="kobo.929.1">addEventListener</span></span><span class="koboSpan" id="kobo.930.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.931.1">'click'</span></span><span class="koboSpan" id="kobo.932.1">, </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.933.1">function</span></span><span class="koboSpan" id="kobo.934.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.935.1">e</span></span><span class="koboSpan" id="kobo.936.1">){
    e.</span><span class="hljs-title"><span class="koboSpan" id="kobo.937.1">preventDefault</span></span><span class="koboSpan" id="kobo.938.1">();
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.939.1">var</span></span><span class="koboSpan" id="kobo.940.1"> followButton = </span><span class="hljs-variable"><span class="koboSpan" id="kobo.941.1">this</span></span><span class="koboSpan" id="kobo.942.1">;
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.943.1">// add request body</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.944.1">var</span></span><span class="koboSpan" id="kobo.945.1"> formData = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.946.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.947.1">FormData</span></span><span class="koboSpan" id="kobo.948.1">();
    formData.</span><span class="hljs-title"><span class="koboSpan" id="kobo.949.1">append</span></span><span class="koboSpan" id="kobo.950.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.951.1">'id'</span></span><span class="koboSpan" id="kobo.952.1">, followButton.</span><span class="hljs-property"><span class="koboSpan" id="kobo.953.1">dataset</span></span><span class="koboSpan" id="kobo.954.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.955.1">id</span></span><span class="koboSpan" id="kobo.956.1">);
    formData.</span><span class="hljs-title"><span class="koboSpan" id="kobo.957.1">append</span></span><span class="koboSpan" id="kobo.958.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.959.1">'action'</span></span><span class="koboSpan" id="kobo.960.1">, followButton.</span><span class="hljs-property"><span class="koboSpan" id="kobo.961.1">dataset</span></span><span class="koboSpan" id="kobo.962.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.963.1">action</span></span><span class="koboSpan" id="kobo.964.1">);
    options[</span><span class="hljs-string"><span class="koboSpan" id="kobo.965.1">'body'</span></span><span class="koboSpan" id="kobo.966.1">] = formData;
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.967.1">// send HTTP request</span></span>
<span class="hljs-title"><span class="koboSpan" id="kobo.968.1">fetch</span></span><span class="koboSpan" id="kobo.969.1">(url, options)
    .</span><span class="hljs-title"><span class="koboSpan" id="kobo.970.1">then</span></span><span class="koboSpan" id="kobo.971.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.972.1">response</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.973.1"> =&gt;</span></span><span class="koboSpan" id="kobo.974.1"> response.</span><span class="hljs-title"><span class="koboSpan" id="kobo.975.1">json</span></span><span class="koboSpan" id="kobo.976.1">())
    .</span><span class="hljs-title"><span class="koboSpan" id="kobo.977.1">then</span></span><span class="koboSpan" id="kobo.978.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.979.1">data</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.980.1"> =&gt;</span></span><span class="koboSpan" id="kobo.981.1"> {
      </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.982.1">if</span></span><span class="koboSpan" id="kobo.983.1"> (data[</span><span class="hljs-string"><span class="koboSpan" id="kobo.984.1">'status'</span></span><span class="koboSpan" id="kobo.985.1">] === </span><span class="hljs-string"><span class="koboSpan" id="kobo.986.1">'ok'</span></span><span class="koboSpan" id="kobo.987.1">)
      {
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.988.1">var</span></span><span class="koboSpan" id="kobo.989.1"> previousAction = followButton.</span><span class="hljs-property"><span class="koboSpan" id="kobo.990.1">dataset</span></span><span class="koboSpan" id="kobo.991.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.992.1">action</span></span><span class="koboSpan" id="kobo.993.1">;
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.994.1">// toggle button text and data-action</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.995.1">var</span></span><span class="koboSpan" id="kobo.996.1"> action = previousAction === </span><span class="hljs-string"><span class="koboSpan" id="kobo.997.1">'follow'</span></span><span class="koboSpan" id="kobo.998.1"> ? </span><span class="hljs-string"><span class="koboSpan" id="kobo.999.1">'unfollow'</span></span><span class="koboSpan" id="kobo.1000.1"> : </span><span class="hljs-string"><span class="koboSpan" id="kobo.1001.1">'follow'</span></span><span class="koboSpan" id="kobo.1002.1">;
        followButton.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1003.1">dataset</span></span><span class="koboSpan" id="kobo.1004.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1005.1">action</span></span><span class="koboSpan" id="kobo.1006.1"> = action;
        followButton.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1007.1">innerHTML</span></span><span class="koboSpan" id="kobo.1008.1"> = action;
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1009.1">// update follower count</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1010.1">var</span></span><span class="koboSpan" id="kobo.1011.1"> followerCount = </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1012.1">document</span></span><span class="koboSpan" id="kobo.1013.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1014.1">querySelector</span></span><span class="koboSpan" id="kobo.1015.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1016.1">'span.count .total'</span></span><span class="koboSpan" id="kobo.1017.1">);
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1018.1">var</span></span><span class="koboSpan" id="kobo.1019.1"> totalFollowers = </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1020.1">parseInt</span></span><span class="koboSpan" id="kobo.1021.1">(followerCount.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1022.1">innerHTML</span></span><span class="koboSpan" id="kobo.1023.1">);
        followerCount.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1024.1">innerHTML</span></span><span class="koboSpan" id="kobo.1025.1"> = previousAction === </span><span class="hljs-string"><span class="koboSpan" id="kobo.1026.1">'follow'</span></span><span class="koboSpan" id="kobo.1027.1"> ? </span><span class="koboSpan" id="kobo.1027.2">totalFollowers + </span><span class="hljs-number"><span class="koboSpan" id="kobo.1028.1">1</span></span><span class="koboSpan" id="kobo.1029.1"> : totalFollowers - </span><span class="hljs-number"><span class="koboSpan" id="kobo.1030.1">1</span></span><span class="koboSpan" id="kobo.1031.1">;
      }
    })
  });
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1032.1">The preceding template block </span><a id="_idIndexMarker656"/><span class="koboSpan" id="kobo.1033.1">contains the JavaScript code to perform the asynchronous HTTP request to follow or unfollow a particular user and also to toggle the follow/unfollow link. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.1034.1">The Fetch API is used to perform the AJAX request and set both the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1035.1">data-action</span></code><span class="koboSpan" id="kobo.1036.1"> attribute and the</span><a id="_idIndexMarker657"/><span class="koboSpan" id="kobo.1037.1"> text of the HTML </span><code class="inlineCode"><span class="koboSpan" id="kobo.1038.1">&lt;a&gt;</span></code><span class="koboSpan" id="kobo.1039.1"> element based on its previous value. </span><span class="koboSpan" id="kobo.1039.2">When the action is completed, the total number of followers displayed on the page is updated as well.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1040.1">Open the user detail page of an existing user and click on the </span><strong class="screenText"><span class="koboSpan" id="kobo.1041.1">FOLLOW</span></strong><span class="koboSpan" id="kobo.1042.1"> link to test the functionality you just built. </span><span class="koboSpan" id="kobo.1042.2">You will see, on the left-hand side of the following image, that the followers count has increased:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1043.1"><img alt="" role="presentation" src="../Images/B21088_07_05.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1044.1">Figure 7.5: The followers count and follow/unfollow button</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1045.1">The follow system is now </span><a id="_idIndexMarker658"/><span class="koboSpan" id="kobo.1046.1">complete and users can follow each other. </span><span class="koboSpan" id="kobo.1046.2">Next, we will build an activity stream creating relevant content for each user that is based on the people they follow.</span></p>
<h1 class="heading-1" id="_idParaDest-199"><span class="koboSpan" id="kobo.1047.1">Creating an activity stream application</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1048.1">Many social websites display an</span><a id="_idIndexMarker659"/><span class="koboSpan" id="kobo.1049.1"> activity stream to their users so that they can track what other users do on the platform. </span><span class="koboSpan" id="kobo.1049.2">An activity stream is a list of recent activities performed by a user or a group of users. </span><span class="koboSpan" id="kobo.1049.3">For example, Facebook’s News Feed is an activity stream. </span><span class="koboSpan" id="kobo.1049.4">Sample actions can be </span><em class="italic"><span class="koboSpan" id="kobo.1050.1">user X bookmarked image Y </span></em><span class="koboSpan" id="kobo.1051.1">or</span><em class="italic"><span class="koboSpan" id="kobo.1052.1"> user X is now following user Y</span></em><span class="koboSpan" id="kobo.1053.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1054.1">You are going to build an activity stream application so that every user can see the recent interactions of the users they follow. </span><span class="koboSpan" id="kobo.1054.2">To do so, you will need a model to save the actions performed by users on the website and a simple way to add actions to the feed.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1055.1">Create a new application named </span><code class="inlineCode"><span class="koboSpan" id="kobo.1056.1">actions</span></code><span class="koboSpan" id="kobo.1057.1"> inside your project with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1058.1">python manage.py startapp actions
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1059.1">Add the new application to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1060.1">INSTALLED_APPS</span></code><span class="koboSpan" id="kobo.1061.1"> in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1062.1">settings.py</span></code><span class="koboSpan" id="kobo.1063.1"> file of your project to activate the application in your project. </span><span class="koboSpan" id="kobo.1063.2">The new line is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1064.1">INSTALLED_APPS = [
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1065.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1066.1">'actions.apps.ActionsConfig'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1067.1">,</span></strong></span><span class="koboSpan" id="kobo.1068.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1069.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1070.1">models.py</span></code><span class="koboSpan" id="kobo.1071.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1072.1">actions</span></code><span class="koboSpan" id="kobo.1073.1"> application and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1074.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1075.1"> django.conf </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1076.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1077.1"> settings</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1078.1">from</span></span><span class="koboSpan" id="kobo.1079.1"> django.db </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1080.1">import</span></span><span class="koboSpan" id="kobo.1081.1"> models
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1082.1">class</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1083.1">Action</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1084.1">(models.Model):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1085.1">    user = models.ForeignKey(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1086.1">        settings.AUTH_USER_MODEL,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1087.1">        related_name=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1088.1">'actions'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1089.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1090.1">        on_delete=models.CASCADE</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1091.1">    )</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1092.1">    verb = models.CharField(max_length=</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.1093.1">255</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1094.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1095.1">    created = models.DateTimeField(auto_now_add=</span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.1096.1">True</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1097.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1098.1">class</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1099.1">Meta</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1100.1">:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1101.1">        indexes = [</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1102.1">            models.Index(fields=[</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1103.1">'-created'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1104.1">]),</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1105.1">        ]</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1106.1">        ordering = [</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1107.1">'-created'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1108.1">]</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1109.1">The preceding code shows the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1110.1">Action</span></code><span class="koboSpan" id="kobo.1111.1"> model that will be used to store user activities. </span><span class="koboSpan" id="kobo.1111.2">The fields of this model are as follows:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1112.1">user</span></code><span class="koboSpan" id="kobo.1113.1">: The user who performed the action; this is a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1114.1">ForeignKey</span></code><span class="koboSpan" id="kobo.1115.1"> to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1116.1">AUTH_USER_MODEL</span></code><span class="koboSpan" id="kobo.1117.1">, by default, the Django </span><code class="inlineCode"><span class="koboSpan" id="kobo.1118.1">User</span></code><span class="koboSpan" id="kobo.1119.1"> model.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1120.1">verb</span></code><span class="koboSpan" id="kobo.1121.1">: The verb describing the action that the user has performed.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1122.1">created</span></code><span class="koboSpan" id="kobo.1123.1">: The date and time when this action was created. </span><span class="koboSpan" id="kobo.1123.2">We use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1124.1">auto_now_add=True</span></code><span class="koboSpan" id="kobo.1125.1"> to automatically set this to the current datetime when the object is saved for the first time in the database.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1126.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1127.1">Meta</span></code><span class="koboSpan" id="kobo.1128.1"> class of the model, we have defined a database index in descending order for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1129.1">created</span></code><span class="koboSpan" id="kobo.1130.1"> field. </span><span class="koboSpan" id="kobo.1130.2">We have</span><a id="_idIndexMarker660"/><span class="koboSpan" id="kobo.1131.1"> also added the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1132.1">ordering</span></code><span class="koboSpan" id="kobo.1133.1"> attribute to tell Django that it should sort results by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1134.1">created</span></code><span class="koboSpan" id="kobo.1135.1"> field in descending order by default.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1136.1">With this basic model, you can only store actions such as </span><em class="italic"><span class="koboSpan" id="kobo.1137.1">user X did something</span></em><span class="koboSpan" id="kobo.1138.1">. </span><span class="koboSpan" id="kobo.1138.2">You need an extra </span><code class="inlineCode"><span class="koboSpan" id="kobo.1139.1">ForeignKey</span></code><span class="koboSpan" id="kobo.1140.1"> field to save actions that involve a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1141.1">target</span></code><span class="koboSpan" id="kobo.1142.1"> object, such as </span><em class="italic"><span class="koboSpan" id="kobo.1143.1">user X bookmarked image Y </span></em><span class="koboSpan" id="kobo.1144.1">or</span><em class="italic"><span class="koboSpan" id="kobo.1145.1"> user X is now following user Y</span></em><span class="koboSpan" id="kobo.1146.1">. </span><span class="koboSpan" id="kobo.1146.2">As you already know, a normal </span><code class="inlineCode"><span class="koboSpan" id="kobo.1147.1">ForeignKey</span></code><span class="koboSpan" id="kobo.1148.1"> can point to only one model. </span><span class="koboSpan" id="kobo.1148.2">Instead, you will need a way for the action’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.1149.1">target</span></code><span class="koboSpan" id="kobo.1150.1"> object to be an instance of an existing model. </span><span class="koboSpan" id="kobo.1150.2">This is what the Django </span><code class="inlineCode"><span class="koboSpan" id="kobo.1151.1">contenttypes</span></code><span class="koboSpan" id="kobo.1152.1"> framework will help you to do.</span></p>
<h2 class="heading-2" id="_idParaDest-200"><span class="koboSpan" id="kobo.1153.1">Using the contenttypes framework</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1154.1">Django includes a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1155.1">contenttypes</span></code><span class="koboSpan" id="kobo.1156.1"> framework located at </span><code class="inlineCode"><span class="koboSpan" id="kobo.1157.1">django.contrib.contenttypes</span></code><span class="koboSpan" id="kobo.1158.1">. </span><span class="koboSpan" id="kobo.1158.2">This application can track all models</span><a id="_idIndexMarker661"/><span class="koboSpan" id="kobo.1159.1"> installed in your project and provides a generic interface to interact with your models.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1160.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1161.1">django.contrib.contenttypes</span></code><span class="koboSpan" id="kobo.1162.1"> application is included in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1163.1">INSTALLED_APPS</span></code><span class="koboSpan" id="kobo.1164.1"> setting by default when you create a new project using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1165.1">startproject</span></code><span class="koboSpan" id="kobo.1166.1"> command. </span><span class="koboSpan" id="kobo.1166.2">It is used by other </span><code class="inlineCode"><span class="koboSpan" id="kobo.1167.1">contrib</span></code><span class="koboSpan" id="kobo.1168.1"> packages, such as the authentication framework and the administration application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1169.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1170.1">contenttypes</span></code><span class="koboSpan" id="kobo.1171.1"> application contains a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1172.1">ContentType</span></code><span class="koboSpan" id="kobo.1173.1"> model. </span><span class="koboSpan" id="kobo.1173.2">Instances of this model represent the actual models of your application, and new instances of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1174.1">ContentType</span></code><span class="koboSpan" id="kobo.1175.1"> are automatically created when new models are installed in your project. </span><span class="koboSpan" id="kobo.1175.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1176.1">ContentType</span></code><span class="koboSpan" id="kobo.1177.1"> model has the following fields:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1178.1">app_label</span></code><span class="koboSpan" id="kobo.1179.1">: This indicates the name of the application that the model belongs to. </span><span class="koboSpan" id="kobo.1179.2">This is automatically taken from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1180.1">app_label</span></code><span class="koboSpan" id="kobo.1181.1"> attribute of the model </span><code class="inlineCode"><span class="koboSpan" id="kobo.1182.1">Meta</span></code><span class="koboSpan" id="kobo.1183.1"> options. </span><span class="koboSpan" id="kobo.1183.2">For example, your </span><code class="inlineCode"><span class="koboSpan" id="kobo.1184.1">Image</span></code><span class="koboSpan" id="kobo.1185.1"> model belongs to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1186.1">images</span></code><span class="koboSpan" id="kobo.1187.1"> application.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1188.1">model</span></code><span class="koboSpan" id="kobo.1189.1">: The name of the model class.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1190.1">name</span></code><span class="koboSpan" id="kobo.1191.1">: This is a property that indicates the human-readable name of the model, automatically </span><a id="_idIndexMarker662"/><span class="koboSpan" id="kobo.1192.1">generated from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1193.1">verbose_name</span></code><span class="koboSpan" id="kobo.1194.1"> attribute of the model </span><code class="inlineCode"><span class="koboSpan" id="kobo.1195.1">Meta</span></code><span class="koboSpan" id="kobo.1196.1"> options.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1197.1">Let’s take a look at how you can interact with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1198.1">ContentType</span></code><span class="koboSpan" id="kobo.1199.1"> objects. </span><span class="koboSpan" id="kobo.1199.2">Open the shell using the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1200.1">python manage.py shell
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1201.1">You can obtain the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1202.1">ContentType</span></code><span class="koboSpan" id="kobo.1203.1"> object corresponding to a specific model by performing a query with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1204.1">app_label</span></code><span class="koboSpan" id="kobo.1205.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1206.1">model</span></code><span class="koboSpan" id="kobo.1207.1"> attributes, as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1208.1">&gt;&gt;&gt;</span></span> <span class="hljs-con-keyword"><span class="koboSpan" id="kobo.1209.1">from</span></span><span class="koboSpan" id="kobo.1210.1"> django.contrib.contenttypes.models </span><span class="hljs-con-keyword"><span class="koboSpan" id="kobo.1211.1">import</span></span><span class="koboSpan" id="kobo.1212.1"> ContentType
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1213.1">&gt;&gt;&gt;</span></span><span class="koboSpan" id="kobo.1214.1"> image_type = ContentType.objects.get(app_label=</span><span class="hljs-con-string"><span class="koboSpan" id="kobo.1215.1">'</span></span><span class="hljs-con-string"><span class="koboSpan" id="kobo.1216.1">images'</span></span><span class="koboSpan" id="kobo.1217.1">, model=</span><span class="hljs-con-string"><span class="koboSpan" id="kobo.1218.1">'image'</span></span><span class="koboSpan" id="kobo.1219.1">)
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1220.1">&gt;&gt;&gt;</span></span><span class="koboSpan" id="kobo.1221.1"> image_type
&lt;ContentType: images | image&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1222.1">You can also retrieve the model class from a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1223.1">ContentType</span></code><span class="koboSpan" id="kobo.1224.1"> object by calling its </span><code class="inlineCode"><span class="koboSpan" id="kobo.1225.1">model_class()</span></code><span class="koboSpan" id="kobo.1226.1"> method:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1227.1">&gt;&gt;&gt;</span></span><span class="koboSpan" id="kobo.1228.1"> image_type.model_class()
&lt;class 'images.models.Image'&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1229.1">It’s also common to obtain the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1230.1">ContentType</span></code><span class="koboSpan" id="kobo.1231.1"> object for a particular model class, as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1232.1">&gt;&gt;&gt;</span></span> <span class="hljs-con-keyword"><span class="koboSpan" id="kobo.1233.1">from</span></span><span class="koboSpan" id="kobo.1234.1"> images.models </span><span class="hljs-con-keyword"><span class="koboSpan" id="kobo.1235.1">import</span></span><span class="koboSpan" id="kobo.1236.1"> Image
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1237.1">&gt;&gt;&gt;</span></span><span class="koboSpan" id="kobo.1238.1"> ContentType.objects.get_for_model(Image)
&lt;ContentType: images | image&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1239.1">These are just some examples of using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1240.1">contenttypes</span></code><span class="koboSpan" id="kobo.1241.1">. </span><span class="koboSpan" id="kobo.1241.2">Django offers more ways to work with them. </span><span class="koboSpan" id="kobo.1241.3">You can find the official </span><a id="_idIndexMarker663"/><span class="koboSpan" id="kobo.1242.1">documentation for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1243.1">contenttypes</span></code><span class="koboSpan" id="kobo.1244.1"> framework at </span><a href="https://docs.djangoproject.com/en/5.0/ref/contrib/contenttypes/"><span class="url"><span class="koboSpan" id="kobo.1245.1">https://docs.djangoproject.com/en/5.0/ref/contrib/contenttypes/</span></span></a><span class="koboSpan" id="kobo.1246.1">.</span></p>
<h2 class="heading-2" id="_idParaDest-201"><span class="koboSpan" id="kobo.1247.1">Adding generic relations to your models</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1248.1">In generic relations, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1249.1">ContentType</span></code><span class="koboSpan" id="kobo.1250.1"> objects play the role of pointing to the model used for the relationship. </span><span class="koboSpan" id="kobo.1250.2">You will need</span><a id="_idIndexMarker664"/><span class="koboSpan" id="kobo.1251.1"> three fields to set up a generic relation in a model:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.1252.1">A </span><code class="inlineCode"><span class="koboSpan" id="kobo.1253.1">ForeignKey</span></code><span class="koboSpan" id="kobo.1254.1"> field to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1255.1">ContentType</span></code><span class="koboSpan" id="kobo.1256.1">: This will tell you what the model for the relationship is</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1257.1">A field to store the primary key of the related object: This will usually be a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1258.1">PositiveIntegerField</span></code><span class="koboSpan" id="kobo.1259.1"> to match Django’s automatic primary key fields</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1260.1">A field to define and manage the generic relation using the two previous fields: The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1261.1">contenttypes</span></code><span class="koboSpan" id="kobo.1262.1"> framework offers a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1263.1">GenericForeignKey</span></code><span class="koboSpan" id="kobo.1264.1"> field for this purpose</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1265.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1266.1">models.py</span></code><span class="koboSpan" id="kobo.1267.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1268.1">actions</span></code><span class="koboSpan" id="kobo.1269.1"> application and add the following code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1270.1">from</span></span><span class="koboSpan" id="kobo.1271.1"> django.conf </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1272.1">import</span></span><span class="koboSpan" id="kobo.1273.1"> settings
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1274.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1275.1"> django.contrib.contenttypes.fields </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1276.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1277.1"> GenericForeignKey</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1278.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1279.1"> django.contrib.contenttypes.models </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1280.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1281.1"> ContentType</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1282.1">from</span></span><span class="koboSpan" id="kobo.1283.1"> django.db </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1284.1">import</span></span><span class="koboSpan" id="kobo.1285.1"> models
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1286.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1287.1">Action</span></span><span class="koboSpan" id="kobo.1288.1">(models.Model):
    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        related_name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1289.1">'actions'</span></span><span class="koboSpan" id="kobo.1290.1">,
        on_delete=models.CASCADE
    )
    verb = models.CharField(max_length=</span><span class="hljs-number"><span class="koboSpan" id="kobo.1291.1">255</span></span><span class="koboSpan" id="kobo.1292.1">)
    created = models.DateTimeField(auto_now_add=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.1293.1">True</span></span><span class="koboSpan" id="kobo.1294.1">)
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1295.1">    target_ct = models.ForeignKey(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1296.1">        ContentType,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1297.1">        blank=</span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.1298.1">True</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1299.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1300.1">        null=</span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.1301.1">True</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1302.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1303.1">        related_name=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1304.1">'target_obj'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1305.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1306.1">        on_delete=models.CASCADE</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1307.1">    )</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1308.1">    target_id = models.PositiveIntegerField(null=</span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.1309.1">True</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1310.1">, blank=</span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.1311.1">True</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1312.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1313.1">    target = GenericForeignKey(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1314.1">'target_ct'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1315.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1316.1">'target_id'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1317.1">)</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1318.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1319.1">Meta</span></span><span class="koboSpan" id="kobo.1320.1">:
        indexes = [
            models.Index(fields=[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1321.1">'-created'</span></span><span class="koboSpan" id="kobo.1322.1">]),
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1323.1">            models.Index(fields=[</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1324.1">'target_ct'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1325.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1326.1">'target_id'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1327.1">]),</span></strong></span><span class="koboSpan" id="kobo.1328.1">
        ]
        ordering = [</span><span class="hljs-string"><span class="koboSpan" id="kobo.1329.1">'-created'</span></span><span class="koboSpan" id="kobo.1330.1">]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1331.1">We have added the following fields to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1332.1">Action</span></code><span class="koboSpan" id="kobo.1333.1"> model:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1334.1">target_ct</span></code><span class="koboSpan" id="kobo.1335.1">: A </span><code class="inlineCode"><span class="koboSpan" id="kobo.1336.1">ForeignKey</span></code><span class="koboSpan" id="kobo.1337.1"> field that points to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1338.1">ContentType</span></code><span class="koboSpan" id="kobo.1339.1"> model</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1340.1">target_id</span></code><span class="koboSpan" id="kobo.1341.1">: A </span><code class="inlineCode"><span class="koboSpan" id="kobo.1342.1">PositiveIntegerField</span></code><span class="koboSpan" id="kobo.1343.1"> for storing the primary key of the related object</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1344.1">target</span></code><span class="koboSpan" id="kobo.1345.1">: A </span><code class="inlineCode"><span class="koboSpan" id="kobo.1346.1">GenericForeignKey</span></code><span class="koboSpan" id="kobo.1347.1"> field to the related object based on the combination of the two</span><a id="_idIndexMarker665"/><span class="koboSpan" id="kobo.1348.1"> previous fields</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1349.1">We have also added a multiple-field index including the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1350.1">target_ct</span></code><span class="koboSpan" id="kobo.1351.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1352.1">target_id</span></code><span class="koboSpan" id="kobo.1353.1"> fields.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1354.1">Django does not create </span><code class="inlineCode"><span class="koboSpan" id="kobo.1355.1">GenericForeignKey</span></code><span class="koboSpan" id="kobo.1356.1"> fields in the database. </span><span class="koboSpan" id="kobo.1356.2">The only fields that are mapped to database fields are </span><code class="inlineCode"><span class="koboSpan" id="kobo.1357.1">target_ct</span></code><span class="koboSpan" id="kobo.1358.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1359.1">target_id</span></code><span class="koboSpan" id="kobo.1360.1">. </span><span class="koboSpan" id="kobo.1360.2">Both fields have </span><code class="inlineCode"><span class="koboSpan" id="kobo.1361.1">blank=True</span></code><span class="koboSpan" id="kobo.1362.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1363.1">null=True</span></code><span class="koboSpan" id="kobo.1364.1"> attributes so that a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1365.1">target</span></code><span class="koboSpan" id="kobo.1366.1"> object is not required when saving </span><code class="inlineCode"><span class="koboSpan" id="kobo.1367.1">Action</span></code><span class="koboSpan" id="kobo.1368.1"> objects.</span></p>
<div class="packt_tip">
<p class="normal"><span class="koboSpan" id="kobo.1369.1">You can make your applications more flexible by using generic relations instead of foreign keys. </span><span class="koboSpan" id="kobo.1369.2">Generic relations allow you to associate models in a non-exclusive manner, enabling a single model to relate to multiple other models.</span></p>
</div>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.1370.1">Figure 7.6</span></em><span class="koboSpan" id="kobo.1371.1"> shows the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1372.1">Action</span></code><span class="koboSpan" id="kobo.1373.1"> model, including the relationship with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1374.1">ContentType</span></code><span class="koboSpan" id="kobo.1375.1"> model of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1376.1">contenttypes</span></code><span class="koboSpan" id="kobo.1377.1"> Django contrib package:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1378.1"><img alt="" role="presentation" src="../Images/B21088_07_06.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1379.1">Figure 7.6: The Action model and the ContentType model</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1380.1">Run the following command to</span><a id="_idIndexMarker666"/><span class="koboSpan" id="kobo.1381.1"> create initial migrations for this application:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1382.1">python manage.py makemigrations actions
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1383.1">You should see the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1384.1">Migrations for 'actions':
  actions/migrations/0001_initial.py
    - Create model Action
    - Create index actions_act_created_64f10d_idx on field(s) -created of model action
    - Create index actions_act_target__f20513_idx on field(s) target_ct, target_id of model action
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1385.1">Then, run the next command to sync the application with the database:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1386.1">python manage.py migrate
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1387.1">The output of the command should indicate that the new migrations have been applied, as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1388.1">Applying actions.0001_initial... </span><span class="koboSpan" id="kobo.1388.2">OK
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1389.1">Let’s add the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1390.1">Action</span></code><span class="koboSpan" id="kobo.1391.1"> model to the administration site. </span><span class="koboSpan" id="kobo.1391.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1392.1">admin.py</span></code><span class="koboSpan" id="kobo.1393.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1394.1">actions</span></code><span class="koboSpan" id="kobo.1395.1"> application and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1396.1">from</span></span><span class="koboSpan" id="kobo.1397.1"> django.contrib </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1398.1">import</span></span><span class="koboSpan" id="kobo.1399.1"> admin
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1400.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1401.1"> .models </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1402.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1403.1"> Action</span></strong></span>
<span class="code-highlight"><strong class="hljs-meta-slc"><span class="koboSpan" id="kobo.1404.1">@admin.register(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1405.1">Action</span></strong><strong class="hljs-meta-slc"><span class="koboSpan" id="kobo.1406.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1407.1">class</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1408.1">ActionAdmin</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1409.1">(admin.ModelAdmin):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1410.1">    list_display = [</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1411.1">'user'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1412.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1413.1">'verb'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1414.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1415.1">'target'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1416.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1417.1">'created'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1418.1">]</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1419.1">    list_filter = [</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1420.1">'created'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1421.1">]</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1422.1">    search_fields = [</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1423.1">'verb'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1424.1">]</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1425.1">You just registered the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1426.1">Action</span></code><span class="koboSpan" id="kobo.1427.1"> model on the administration site.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1428.1">Start the development server with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1429.1">python manage.py runserver
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1430.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.1431.1">http://127.0.0.1:8000/admin/actions/action/add/</span></code><span class="koboSpan" id="kobo.1432.1"> in your browser. </span><span class="koboSpan" id="kobo.1432.2">You should see the page for creating</span><a id="_idIndexMarker667"/><span class="koboSpan" id="kobo.1433.1"> a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1434.1">Action</span></code><span class="koboSpan" id="kobo.1435.1"> object, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1436.1"><img alt="" role="presentation" src="../Images/B21088_07_07.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1437.1">Figure 7.7: The Add action page on the Django administration site</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1438.1">As you will notice in the preceding screenshot, only the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1439.1">target_ct</span></code><span class="koboSpan" id="kobo.1440.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1441.1">target_id</span></code><span class="koboSpan" id="kobo.1442.1"> fields that are mapped to actual database fields are shown. </span><span class="koboSpan" id="kobo.1442.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1443.1">GenericForeignKey</span></code><span class="koboSpan" id="kobo.1444.1"> field does not appear in the form. </span><span class="koboSpan" id="kobo.1444.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1445.1">target_ct</span></code><span class="koboSpan" id="kobo.1446.1"> field allows you to select any of the registered models of your Django project. </span><span class="koboSpan" id="kobo.1446.2">You can restrict the content types to choose from a limited set of models using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1447.1">limit_choices_to</span></code><span class="koboSpan" id="kobo.1448.1"> attribute in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1449.1">target_ct</span></code><span class="koboSpan" id="kobo.1450.1"> field; the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1451.1">limit_choices_to</span></code><span class="koboSpan" id="kobo.1452.1"> attribute allows you to restrict the content of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1453.1">ForeignKey</span></code><span class="koboSpan" id="kobo.1454.1"> fields to a specific set of values.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1455.1">Create a new file inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1456.1">actions</span></code><span class="koboSpan" id="kobo.1457.1"> application directory and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.1458.1">utils.py</span></code><span class="koboSpan" id="kobo.1459.1">. </span><span class="koboSpan" id="kobo.1459.2">You need to define a shortcut </span><a id="_idIndexMarker668"/><span class="koboSpan" id="kobo.1460.1">function that will allow you to create new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1461.1">Action</span></code><span class="koboSpan" id="kobo.1462.1"> objects in a simple way. </span><span class="koboSpan" id="kobo.1462.2">Edit the new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1463.1">utils.py</span></code><span class="koboSpan" id="kobo.1464.1"> file and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1465.1">from</span></span><span class="koboSpan" id="kobo.1466.1"> django.contrib.contenttypes.models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1467.1">import</span></span><span class="koboSpan" id="kobo.1468.1"> ContentType
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1469.1">from</span></span><span class="koboSpan" id="kobo.1470.1"> .models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1471.1">import</span></span><span class="koboSpan" id="kobo.1472.1"> Action
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1473.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1474.1">create_action</span></span><span class="koboSpan" id="kobo.1475.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1476.1">user, verb, target=</span></span><span class="hljs-literal"><span class="koboSpan" id="kobo.1477.1">None</span></span><span class="koboSpan" id="kobo.1478.1">):
    action = Action(user=user, verb=verb, target=target)
    action.save()
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1479.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1480.1">create_action()</span></code><span class="koboSpan" id="kobo.1481.1"> function allows you to create actions that optionally include a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1482.1">target</span></code><span class="koboSpan" id="kobo.1483.1"> object. </span><span class="koboSpan" id="kobo.1483.2">You can use this function anywhere in your code as a shortcut to add new actions to the activity stream.</span></p>
<h2 class="heading-2" id="_idParaDest-202"><span class="koboSpan" id="kobo.1484.1">Avoiding duplicate actions in the activity stream</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1485.1">Sometimes, your users might click several times on the </span><strong class="screenText"><span class="koboSpan" id="kobo.1486.1">Like</span></strong><span class="koboSpan" id="kobo.1487.1"> or </span><strong class="screenText"><span class="koboSpan" id="kobo.1488.1">Unlike</span></strong><span class="koboSpan" id="kobo.1489.1"> button or perform the same action multiple times in a </span><a id="_idIndexMarker669"/><span class="koboSpan" id="kobo.1490.1">short period of time. </span><span class="koboSpan" id="kobo.1490.2">This will easily lead to storing and displaying duplicate actions. </span><span class="koboSpan" id="kobo.1490.3">To avoid this, let’s improve the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1491.1">create_action()</span></code><span class="koboSpan" id="kobo.1492.1"> function to skip obvious duplicated actions.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1493.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1494.1">utils.py</span></code><span class="koboSpan" id="kobo.1495.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1496.1">actions</span></code><span class="koboSpan" id="kobo.1497.1"> application, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1498.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1499.1"> datetime</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1500.1">from</span></span><span class="koboSpan" id="kobo.1501.1"> django.contrib.contenttypes.models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1502.1">import</span></span><span class="koboSpan" id="kobo.1503.1"> ContentType
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1504.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1505.1"> django.utils </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1506.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1507.1"> timezone</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1508.1">from</span></span><span class="koboSpan" id="kobo.1509.1"> .models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1510.1">import</span></span><span class="koboSpan" id="kobo.1511.1"> Action
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1512.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1513.1">create_action</span></span><span class="koboSpan" id="kobo.1514.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1515.1">user, verb, target=</span></span><span class="hljs-literal"><span class="koboSpan" id="kobo.1516.1">None</span></span><span class="koboSpan" id="kobo.1517.1">):
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1518.1"># check for any similar action made in the last minute</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1519.1">    now = timezone.now()</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1520.1">    last_minute = now - datetime.timedelta(seconds=</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.1521.1">60</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1522.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1523.1">    similar_actions = Action.objects.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1524.1">filter</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1525.1">(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1526.1">        user_id=user.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1527.1">id</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1528.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1529.1">        verb= verb,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1530.1">        created__gte=last_minute</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1531.1">    )</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1532.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1533.1"> target:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1534.1">        target_ct = ContentType.objects.get_for_model(target)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1535.1">        similar_actions = similar_actions.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1536.1">filter</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1537.1">(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1538.1">            target_ct=target_ct,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1539.1">            target_id=target.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1540.1">id</span></strong></span>
<span class="code-highlight"><strong class="hljs-built_in-slc"> </strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1541.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1542.1">if</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1543.1">not</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1544.1"> similar_actions:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1545.1"># no existing actions found</span></strong></span><span class="koboSpan" id="kobo.1546.1">
        action = Action(user=user, verb=verb, target=target)
        action.save()
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1547.1">return</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.1548.1">True</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1549.1">return</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.1550.1">False</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1551.1">You have changed the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1552.1">create_action()</span></code><span class="koboSpan" id="kobo.1553.1"> function to avoid saving duplicate actions and return a Boolean to tell you whether the action was saved. </span><span class="koboSpan" id="kobo.1553.2">This is how you avoid duplicates:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1554.1">First, you get the current time using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1555.1">timezone.now()</span></code><span class="koboSpan" id="kobo.1556.1"> method provided by Django. </span><span class="koboSpan" id="kobo.1556.2">This </span><a id="_idIndexMarker670"/><span class="koboSpan" id="kobo.1557.1">method does the same as </span><code class="inlineCode"><span class="koboSpan" id="kobo.1558.1">datetime.datetime.now()</span></code><span class="koboSpan" id="kobo.1559.1"> but returns a timezone-aware object. </span><span class="koboSpan" id="kobo.1559.2">Django provides a setting called </span><code class="inlineCode"><span class="koboSpan" id="kobo.1560.1">USE_TZ</span></code><span class="koboSpan" id="kobo.1561.1"> to enable or disable timezone support. </span><span class="koboSpan" id="kobo.1561.2">The default </span><code class="inlineCode"><span class="koboSpan" id="kobo.1562.1">settings.py</span></code><span class="koboSpan" id="kobo.1563.1"> file created using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1564.1">startproject</span></code><span class="koboSpan" id="kobo.1565.1"> command includes </span><code class="inlineCode"><span class="koboSpan" id="kobo.1566.1">USE_TZ=True</span></code><span class="koboSpan" id="kobo.1567.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1568.1">You use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1569.1">last_minute</span></code><span class="koboSpan" id="kobo.1570.1"> variable to store the datetime from one minute ago and retrieve any identical actions performed by the user since then.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1571.1">You create an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1572.1">Action</span></code><span class="koboSpan" id="kobo.1573.1"> object if no identical action already exists in the last minute. </span><span class="koboSpan" id="kobo.1573.2">You return </span><code class="inlineCode"><span class="koboSpan" id="kobo.1574.1">True</span></code><span class="koboSpan" id="kobo.1575.1"> if an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1576.1">Action</span></code><span class="koboSpan" id="kobo.1577.1"> object was created or </span><code class="inlineCode"><span class="koboSpan" id="kobo.1578.1">False</span></code><span class="koboSpan" id="kobo.1579.1"> otherwise.</span></li>
</ol>
<h2 class="heading-2" id="_idParaDest-203"><span class="koboSpan" id="kobo.1580.1">Adding user actions to the activity stream</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1581.1">It’s time to add some actions to </span><a id="_idIndexMarker671"/><span class="koboSpan" id="kobo.1582.1">your views to build the activity stream for your users. </span><span class="koboSpan" id="kobo.1582.2">You will store an action for each of the following interactions:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.1583.1">A user bookmarks an image</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1584.1">A user likes an image</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1585.1">A user creates an account</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1586.1">A user starts following another user</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1587.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1588.1">views.py</span></code><span class="koboSpan" id="kobo.1589.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1590.1">images</span></code><span class="koboSpan" id="kobo.1591.1"> application and add the following import:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1592.1">from</span></span><span class="koboSpan" id="kobo.1593.1"> actions.utils </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1594.1">import</span></span><span class="koboSpan" id="kobo.1595.1"> create_action
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1596.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1597.1">image_create</span></code><span class="koboSpan" id="kobo.1598.1"> view, add </span><code class="inlineCode"><span class="koboSpan" id="kobo.1599.1">create_action()</span></code><span class="koboSpan" id="kobo.1600.1"> after saving the image, as follows. </span><span class="koboSpan" id="kobo.1600.2">The new line is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.1601.1">@login_required</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1602.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1603.1">image_create</span></span><span class="koboSpan" id="kobo.1604.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1605.1">request</span></span><span class="koboSpan" id="kobo.1606.1">):
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1607.1">if</span></span><span class="koboSpan" id="kobo.1608.1"> request.method == </span><span class="hljs-string"><span class="koboSpan" id="kobo.1609.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1610.1">POST'</span></span><span class="koboSpan" id="kobo.1611.1">:
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1612.1"># form is sent</span></span><span class="koboSpan" id="kobo.1613.1">
        form = ImageCreateForm(data=request.POST)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1614.1">if</span></span><span class="koboSpan" id="kobo.1615.1"> form.is_valid():
            </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1616.1"># form data is valid</span></span><span class="koboSpan" id="kobo.1617.1">
            cd = form.cleaned_data
            new_image = form.save(commit=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.1618.1">False</span></span><span class="koboSpan" id="kobo.1619.1">)
            </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1620.1"># assign current user to the item</span></span><span class="koboSpan" id="kobo.1621.1">
            new_image.user = request.user
            new_image.save()
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1622.1">            create_action(request.user, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1623.1">'bookmarked image'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1624.1">, new_image)</span></strong></span><span class="koboSpan" id="kobo.1625.1">
            messages.success(request, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1626.1">'Image added successfully'</span></span><span class="koboSpan" id="kobo.1627.1">)
            </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1628.1"># redirect to new created image detail view</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1629.1">return</span></span><span class="koboSpan" id="kobo.1630.1"> redirect(new_image.get_absolute_url())
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1631.1">else</span></span><span class="koboSpan" id="kobo.1632.1">:
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1633.1"># build form with data provided by the bookmarklet via GET</span></span><span class="koboSpan" id="kobo.1634.1">
        form = ImageCreateForm(data=request.GET)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1635.1">return</span></span><span class="koboSpan" id="kobo.1636.1"> render(
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.1637.1">request,
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.1638.1">'images/image/create.html'</span></span><span class="koboSpan" id="kobo.1639.1">,
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.1640.1">{</span><span class="hljs-string"><span class="koboSpan" id="kobo.1641.1">'section'</span></span><span class="koboSpan" id="kobo.1642.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1643.1">'images'</span></span><span class="koboSpan" id="kobo.1644.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1645.1">'form'</span></span><span class="koboSpan" id="kobo.1646.1">: form}
    )
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1647.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1648.1">image_like</span></code><span class="koboSpan" id="kobo.1649.1"> view, add </span><code class="inlineCode"><span class="koboSpan" id="kobo.1650.1">create_action()</span></code><span class="koboSpan" id="kobo.1651.1"> after adding the user to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1652.1">users_like</span></code><span class="koboSpan" id="kobo.1653.1"> relationship, as follows. </span><span class="koboSpan" id="kobo.1653.2">The new line is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.1654.1">@login_required</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.1655.1">@require_POST</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1656.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1657.1">image_like</span></span><span class="koboSpan" id="kobo.1658.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1659.1">request</span></span><span class="koboSpan" id="kobo.1660.1">):
    image_id = request.POST.get(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1661.1">'id'</span></span><span class="koboSpan" id="kobo.1662.1">)
    action = request.POST.get(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1663.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1664.1">action'</span></span><span class="koboSpan" id="kobo.1665.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1666.1">if</span></span><span class="koboSpan" id="kobo.1667.1"> image_id </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1668.1">and</span></span><span class="koboSpan" id="kobo.1669.1"> action:
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1670.1">try</span></span><span class="koboSpan" id="kobo.1671.1">:
            image = Image.objects.get(</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1672.1">id</span></span><span class="koboSpan" id="kobo.1673.1">=image_id)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1674.1">if</span></span><span class="koboSpan" id="kobo.1675.1"> action == </span><span class="hljs-string"><span class="koboSpan" id="kobo.1676.1">'like'</span></span><span class="koboSpan" id="kobo.1677.1">:
                image.users_like.add(request.user)
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1678.1">                create_action(request.user, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1679.1">'likes'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1680.1">, image)</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1681.1">else</span></span><span class="koboSpan" id="kobo.1682.1">:
                image.users_like.remove(request.user)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1683.1">return</span></span><span class="koboSpan" id="kobo.1684.1"> JsonResponse({</span><span class="hljs-string"><span class="koboSpan" id="kobo.1685.1">'status'</span></span><span class="koboSpan" id="kobo.1686.1">:</span><span class="hljs-string"><span class="koboSpan" id="kobo.1687.1">'ok'</span></span><span class="koboSpan" id="kobo.1688.1">})
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1689.1">except</span></span><span class="koboSpan" id="kobo.1690.1"> Image.DoesNotExist:
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1691.1">pass</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1692.1">return</span></span><span class="koboSpan" id="kobo.1693.1"> JsonResponse({</span><span class="hljs-string"><span class="koboSpan" id="kobo.1694.1">'status'</span></span><span class="koboSpan" id="kobo.1695.1">:</span><span class="hljs-string"><span class="koboSpan" id="kobo.1696.1">'error'</span></span><span class="koboSpan" id="kobo.1697.1">})
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1698.1">Now, edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1699.1">views.py</span></code><span class="koboSpan" id="kobo.1700.1"> file </span><a id="_idIndexMarker672"/><span class="koboSpan" id="kobo.1701.1">of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1702.1">account</span></code><span class="koboSpan" id="kobo.1703.1"> application and add the following import:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1704.1">from</span></span><span class="koboSpan" id="kobo.1705.1"> actions.utils </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1706.1">import</span></span><span class="koboSpan" id="kobo.1707.1"> create_action
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1708.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1709.1">register</span></code><span class="koboSpan" id="kobo.1710.1"> view, add </span><code class="inlineCode"><span class="koboSpan" id="kobo.1711.1">create_action()</span></code><span class="koboSpan" id="kobo.1712.1"> after creating the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1713.1">Profile</span></code><span class="koboSpan" id="kobo.1714.1"> object, as follows. </span><span class="koboSpan" id="kobo.1714.2">The new line is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1715.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1716.1">register</span></span><span class="koboSpan" id="kobo.1717.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1718.1">request</span></span><span class="koboSpan" id="kobo.1719.1">):
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1720.1">if</span></span><span class="koboSpan" id="kobo.1721.1"> request.method == </span><span class="hljs-string"><span class="koboSpan" id="kobo.1722.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1723.1">POST'</span></span><span class="koboSpan" id="kobo.1724.1">:
        user_form = UserRegistrationForm(request.POST)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1725.1">if</span></span><span class="koboSpan" id="kobo.1726.1"> user_form.is_valid():
            </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1727.1"># Create a new user object but avoid saving it yet</span></span><span class="koboSpan" id="kobo.1728.1">
            new_user = user_form.save(commit=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.1729.1">False</span></span><span class="koboSpan" id="kobo.1730.1">)
            </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1731.1"># Set the chosen password</span></span><span class="koboSpan" id="kobo.1732.1">
            new_user.set_password(
                user_form.cleaned_data[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1733.1">'password'</span></span><span class="koboSpan" id="kobo.1734.1">]
            )
            </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1735.1"># Save the User object</span></span><span class="koboSpan" id="kobo.1736.1">
            new_user.save()
            </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1737.1"># Create the user profile</span></span><span class="koboSpan" id="kobo.1738.1">
            Profile.objects.create(user=new_user)
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1739.1">            create_action(new_user, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1740.1">'has created an account'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1741.1">)</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1742.1">return</span></span><span class="koboSpan" id="kobo.1743.1"> render(
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.1744.1">request,
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.1745.1">'account/register_done.html'</span></span><span class="koboSpan" id="kobo.1746.1">,
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.1747.1">{</span><span class="hljs-string"><span class="koboSpan" id="kobo.1748.1">'new_user'</span></span><span class="koboSpan" id="kobo.1749.1">: new_user}
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.1750.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1751.1">else</span></span><span class="koboSpan" id="kobo.1752.1">:
        user_form = UserRegistrationForm()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1753.1">return</span></span><span class="koboSpan" id="kobo.1754.1"> render(
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.1755.1">request,
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.1756.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1757.1">account/register.html'</span></span><span class="koboSpan" id="kobo.1758.1">,
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.1759.1">{</span><span class="hljs-string"><span class="koboSpan" id="kobo.1760.1">'user_form'</span></span><span class="koboSpan" id="kobo.1761.1">: user_form}
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.1762.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1763.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1764.1">user_follow</span></code><span class="koboSpan" id="kobo.1765.1"> view, add </span><code class="inlineCode"><span class="koboSpan" id="kobo.1766.1">create_action()</span></code><span class="koboSpan" id="kobo.1767.1">, as follows. </span><span class="koboSpan" id="kobo.1767.2">The</span><a id="_idIndexMarker673"/><span class="koboSpan" id="kobo.1768.1"> new line is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.1769.1">@require_POST</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.1770.1">@login_required</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1771.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1772.1">user_follow</span></span><span class="koboSpan" id="kobo.1773.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1774.1">request</span></span><span class="koboSpan" id="kobo.1775.1">):
    user_id = request.POST.get(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1776.1">'id'</span></span><span class="koboSpan" id="kobo.1777.1">)
    action = request.POST.get(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1778.1">'action'</span></span><span class="koboSpan" id="kobo.1779.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1780.1">if</span></span><span class="koboSpan" id="kobo.1781.1"> user_id </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1782.1">and</span></span><span class="koboSpan" id="kobo.1783.1"> action:
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1784.1">try</span></span><span class="koboSpan" id="kobo.1785.1">:
            user = User.objects.get(</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1786.1">id</span></span><span class="koboSpan" id="kobo.1787.1">=user_id)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1788.1">if</span></span><span class="koboSpan" id="kobo.1789.1"> action == </span><span class="hljs-string"><span class="koboSpan" id="kobo.1790.1">'follow'</span></span><span class="koboSpan" id="kobo.1791.1">:
                Contact.objects.get_or_create(
                    user_from=request.user,
                    user_to=user
                )
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1792.1">                create_action(request.user, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1793.1">'</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1794.1">is following'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1795.1">, user)</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1796.1">else</span></span><span class="koboSpan" id="kobo.1797.1">:
                Contact.objects.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1798.1">filter</span></span><span class="koboSpan" id="kobo.1799.1">(
                    user_from=request.user,
                    user_to=user
                ).delete()
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1800.1">return</span></span><span class="koboSpan" id="kobo.1801.1"> JsonResponse({</span><span class="hljs-string"><span class="koboSpan" id="kobo.1802.1">'status'</span></span><span class="koboSpan" id="kobo.1803.1">:</span><span class="hljs-string"><span class="koboSpan" id="kobo.1804.1">'ok'</span></span><span class="koboSpan" id="kobo.1805.1">})
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1806.1">except</span></span><span class="koboSpan" id="kobo.1807.1"> User.DoesNotExist:
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1808.1">return</span></span><span class="koboSpan" id="kobo.1809.1"> JsonResponse({</span><span class="hljs-string"><span class="koboSpan" id="kobo.1810.1">'status'</span></span><span class="koboSpan" id="kobo.1811.1">:</span><span class="hljs-string"><span class="koboSpan" id="kobo.1812.1">'error'</span></span><span class="koboSpan" id="kobo.1813.1">})
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1814.1">return</span></span><span class="koboSpan" id="kobo.1815.1"> JsonResponse({</span><span class="hljs-string"><span class="koboSpan" id="kobo.1816.1">'status'</span></span><span class="koboSpan" id="kobo.1817.1">:</span><span class="hljs-string"><span class="koboSpan" id="kobo.1818.1">'error'</span></span><span class="koboSpan" id="kobo.1819.1">})
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1820.1">As you can see in the preceding code, thanks to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1821.1">Action</span></code><span class="koboSpan" id="kobo.1822.1"> model and the helper function, it’s very easy to save</span><a id="_idIndexMarker674"/><span class="koboSpan" id="kobo.1823.1"> new actions to the activity stream.</span></p>
<h2 class="heading-2" id="_idParaDest-204"><span class="koboSpan" id="kobo.1824.1">Displaying the activity stream</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1825.1">Finally, you need a way to display the</span><a id="_idIndexMarker675"/><span class="koboSpan" id="kobo.1826.1"> activity stream for each user. </span><span class="koboSpan" id="kobo.1826.2">You will include the activity stream on the user’s dashboard. </span><span class="koboSpan" id="kobo.1826.3">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1827.1">views.py</span></code><span class="koboSpan" id="kobo.1828.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1829.1">account</span></code><span class="koboSpan" id="kobo.1830.1"> application. </span><span class="koboSpan" id="kobo.1830.2">Import the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1831.1">Action</span></code><span class="koboSpan" id="kobo.1832.1"> model and modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1833.1">dashboard</span></code><span class="koboSpan" id="kobo.1834.1"> view, as follows. </span><span class="koboSpan" id="kobo.1834.2">The new code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1835.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1836.1"> actions.models </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1837.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1838.1"> Action</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1839.1"># ...</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.1840.1">@login_required</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1841.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1842.1">dashboard</span></span><span class="koboSpan" id="kobo.1843.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1844.1">request</span></span><span class="koboSpan" id="kobo.1845.1">):
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1846.1"># Display all actions by default</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1847.1">    actions = Action.objects.exclude(user=request.user)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1848.1">    following_ids = request.user.following.values_list(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1849.1">'id'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1850.1">, flat=</span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.1851.1">True</span></strong></span>
<span class="code-highlight"><strong class="hljs-literal-slc"> </strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1852.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1853.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1854.1"> following_ids:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1855.1"># If user is following others, retrieve only their actions</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1856.1">        actions = actions.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1857.1">filter</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1858.1">(user_id__in=following_ids)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1859.1">    actions = actions[:</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.1860.1">10</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1861.1">]</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1862.1">return</span></span><span class="koboSpan" id="kobo.1863.1"> render(
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.1864.1">request,
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.1865.1">'account/dashboard.html'</span></span><span class="koboSpan" id="kobo.1866.1">,
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.1867.1">{</span><span class="hljs-string"><span class="koboSpan" id="kobo.1868.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1869.1">section'</span></span><span class="koboSpan" id="kobo.1870.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1871.1">'dashboard'</span></span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1872.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1873.1">'actions'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1874.1">: actions}</span></strong></span><span class="koboSpan" id="kobo.1875.1">
    )
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1876.1">In the preceding view, you retrieve all actions from the database, excluding the ones performed by the current user. </span><span class="koboSpan" id="kobo.1876.2">By default, you retrieve the latest actions performed by all users on the platform. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.1877.1">If the user is following other users, you restrict the query to retrieve only the actions performed by the users they follow. </span><span class="koboSpan" id="kobo.1877.2">Finally, you limit the result to the first 10 actions returned. </span><span class="koboSpan" id="kobo.1877.3">You don’t use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1878.1">order_by()</span></code><span class="koboSpan" id="kobo.1879.1"> in the QuerySet because you rely on the default ordering that you provided in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1880.1">Meta</span></code><span class="koboSpan" id="kobo.1881.1"> options of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1882.1">Action</span></code><span class="koboSpan" id="kobo.1883.1"> model. </span><span class="koboSpan" id="kobo.1883.2">Recent actions will come first since you set </span><code class="inlineCode"><span class="koboSpan" id="kobo.1884.1">ordering = ['-created']</span></code><span class="koboSpan" id="kobo.1885.1"> in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1886.1">Action</span></code><span class="koboSpan" id="kobo.1887.1"> model.</span></p>
<h2 class="heading-2" id="_idParaDest-205"><span class="koboSpan" id="kobo.1888.1">Optimizing QuerySets that involve related objects</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1889.1">Every time you retrieve an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1890.1">Action</span></code><span class="koboSpan" id="kobo.1891.1"> object, you will usually access its related </span><code class="inlineCode"><span class="koboSpan" id="kobo.1892.1">User</span></code><span class="koboSpan" id="kobo.1893.1"> object and the user’s related </span><code class="inlineCode"><span class="koboSpan" id="kobo.1894.1">Profile</span></code><span class="koboSpan" id="kobo.1895.1"> object. </span><span class="koboSpan" id="kobo.1895.2">The</span><a id="_idIndexMarker676"/><span class="koboSpan" id="kobo.1896.1"> Django ORM offers a simple way to retrieve related objects at the same time, thereby avoiding additional queries to the database.</span></p>
<h3 class="heading-3" id="_idParaDest-206"><span class="koboSpan" id="kobo.1897.1">Using select_related()</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.1898.1">Django offers a QuerySet method called </span><code class="inlineCode"><span class="koboSpan" id="kobo.1899.1">select_related()</span></code><span class="koboSpan" id="kobo.1900.1"> that allows you to retrieve related objects for one-to-many relationships. </span><span class="koboSpan" id="kobo.1900.2">This translates to a single, more complex QuerySet, but you avoid additional queries</span><a id="_idIndexMarker677"/><span class="koboSpan" id="kobo.1901.1"> when accessing the related objects. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.1902.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1903.1">select_related</span></code><span class="koboSpan" id="kobo.1904.1"> method is for </span><code class="inlineCode"><span class="koboSpan" id="kobo.1905.1">ForeignKey</span></code><span class="koboSpan" id="kobo.1906.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1907.1">OneToOne</span></code><span class="koboSpan" id="kobo.1908.1"> fields. </span><span class="koboSpan" id="kobo.1908.2">It works by performing a SQL </span><code class="inlineCode"><span class="koboSpan" id="kobo.1909.1">JOIN</span></code><span class="koboSpan" id="kobo.1910.1"> and including the fields of the related object in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1911.1">SELECT</span></code><span class="koboSpan" id="kobo.1912.1"> statement.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1913.1">To take advantage of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1914.1">select_related()</span></code><span class="koboSpan" id="kobo.1915.1">, edit the following line of the preceding code in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1916.1">views.py</span></code><span class="koboSpan" id="kobo.1917.1"> file of the account application to add </span><code class="inlineCode"><span class="koboSpan" id="kobo.1918.1">select_related</span></code><span class="koboSpan" id="kobo.1919.1">, including the fields that you will use, as follows. </span><span class="koboSpan" id="kobo.1919.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1920.1">views.py</span></code><span class="koboSpan" id="kobo.1921.1"> file of the account application. </span><span class="koboSpan" id="kobo.1921.2">The new code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.1922.1">@login_required</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1923.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1924.1">dashboard</span></span><span class="koboSpan" id="kobo.1925.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1926.1">request</span></span><span class="koboSpan" id="kobo.1927.1">):
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1928.1"># Display all actions by default</span></span><span class="koboSpan" id="kobo.1929.1">
    actions = Action.objects.exclude(user=request.user)
    following_ids = request.user.following.values_list(
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1930.1">'id'</span></span><span class="koboSpan" id="kobo.1931.1">, flat=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.1932.1">True</span></span>
<span class="hljs-literal"> </span><span class="koboSpan" id="kobo.1933.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1934.1">if</span></span><span class="koboSpan" id="kobo.1935.1"> following_ids:
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1936.1"># If user is following others, retrieve only their actions</span></span><span class="koboSpan" id="kobo.1937.1">
        actions = actions.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1938.1">filter</span></span><span class="koboSpan" id="kobo.1939.1">(user_id__in=following_ids)
    actions = actions</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1940.1">.select_related(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1941.1">'user'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1942.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1943.1">'user__profile'</span></strong></span>
<span class="code-highlight"><strong class="hljs-string-slc"> </strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1944.1">)</span></strong></span><span class="koboSpan" id="kobo.1945.1">[:</span><span class="hljs-number"><span class="koboSpan" id="kobo.1946.1">10</span></span><span class="koboSpan" id="kobo.1947.1">]
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1948.1">return</span></span><span class="koboSpan" id="kobo.1949.1"> render(
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.1950.1">request,
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.1951.1">'account/dashboard.html'</span></span><span class="koboSpan" id="kobo.1952.1">,
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.1953.1">{</span><span class="hljs-string"><span class="koboSpan" id="kobo.1954.1">'section'</span></span><span class="koboSpan" id="kobo.1955.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1956.1">'dashboard'</span></span><span class="koboSpan" id="kobo.1957.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1958.1">'actions'</span></span><span class="koboSpan" id="kobo.1959.1">: actions}
    )
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1960.1">You use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1961.1">user__profile</span></code><span class="koboSpan" id="kobo.1962.1"> to join the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1963.1">Profile</span></code><span class="koboSpan" id="kobo.1964.1"> table in a single SQL query. </span><span class="koboSpan" id="kobo.1964.2">If you call </span><code class="inlineCode"><span class="koboSpan" id="kobo.1965.1">select_related()</span></code><span class="koboSpan" id="kobo.1966.1"> without passing </span><a id="_idIndexMarker678"/><span class="koboSpan" id="kobo.1967.1">any arguments to it, it will retrieve objects from all </span><code class="inlineCode"><span class="koboSpan" id="kobo.1968.1">ForeignKey</span></code><span class="koboSpan" id="kobo.1969.1"> relationships. </span><span class="koboSpan" id="kobo.1969.2">Always limit </span><code class="inlineCode"><span class="koboSpan" id="kobo.1970.1">select_related()</span></code><span class="koboSpan" id="kobo.1971.1"> to the relationships that will be accessed afterward.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.1972.1">Using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1973.1">select_related()</span></code><span class="koboSpan" id="kobo.1974.1"> carefully can vastly improve execution time.</span></p>
</div>
<h3 class="heading-3" id="_idParaDest-207"><span class="koboSpan" id="kobo.1975.1">Using prefetch_related()</span></h3>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.1976.1">select_related()</span></code><span class="koboSpan" id="kobo.1977.1"> will help you boost the performance for retrieving related objects in one-to-many relationships. </span><span class="koboSpan" id="kobo.1977.2">However, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1978.1">select_related()</span></code><span class="koboSpan" id="kobo.1979.1"> doesn’t work for many-to-many or many-to-one relationships (</span><code class="inlineCode"><span class="koboSpan" id="kobo.1980.1">ManyToMany</span></code><span class="koboSpan" id="kobo.1981.1"> or reverse </span><code class="inlineCode"><span class="koboSpan" id="kobo.1982.1">ForeignKey</span></code><span class="koboSpan" id="kobo.1983.1"> fields). </span><span class="koboSpan" id="kobo.1983.2">Django offers a different QuerySet </span><a id="_idIndexMarker679"/><span class="koboSpan" id="kobo.1984.1">method called </span><code class="inlineCode"><span class="koboSpan" id="kobo.1985.1">prefetch_related</span></code><span class="koboSpan" id="kobo.1986.1"> that works for many-to-many and many-to-one relationships in addition to the relationships supported by </span><code class="inlineCode"><span class="koboSpan" id="kobo.1987.1">select_related()</span></code><span class="koboSpan" id="kobo.1988.1">. </span><span class="koboSpan" id="kobo.1988.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1989.1">prefetch_related()</span></code><span class="koboSpan" id="kobo.1990.1"> method performs a separate lookup for each relationship and joins the results using Python. </span><span class="koboSpan" id="kobo.1990.2">This method also supports the prefetching of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1991.1">GenericRelation</span></code><span class="koboSpan" id="kobo.1992.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1993.1">GenericForeignKey</span></code><span class="koboSpan" id="kobo.1994.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1995.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1996.1">views.py</span></code><span class="koboSpan" id="kobo.1997.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1998.1">account</span></code><span class="koboSpan" id="kobo.1999.1"> application and complete your query by adding </span><code class="inlineCode"><span class="koboSpan" id="kobo.2000.1">prefetch_related()</span></code><span class="koboSpan" id="kobo.2001.1"> to it for the target </span><code class="inlineCode"><span class="koboSpan" id="kobo.2002.1">GenericForeignKey</span></code><span class="koboSpan" id="kobo.2003.1"> field, as follows. </span><span class="koboSpan" id="kobo.2003.2">The new code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.2004.1">@login_required</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2005.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2006.1">dashboard</span></span><span class="koboSpan" id="kobo.2007.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2008.1">request</span></span><span class="koboSpan" id="kobo.2009.1">):
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.2010.1"># Display all actions by default</span></span><span class="koboSpan" id="kobo.2011.1">
    actions = Action.objects.exclude(user=request.user)
    following_ids = request.user.following.values_list(
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2012.1">'id'</span></span><span class="koboSpan" id="kobo.2013.1">, flat=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.2014.1">True</span></span>
<span class="hljs-literal"> </span><span class="koboSpan" id="kobo.2015.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2016.1">if</span></span><span class="koboSpan" id="kobo.2017.1"> following_ids:
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.2018.1"># If user is following others, retrieve only their actions</span></span><span class="koboSpan" id="kobo.2019.1">
        actions = actions.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2020.1">filter</span></span><span class="koboSpan" id="kobo.2021.1">(user_id__in=following_ids)
    actions = actions.select_related(
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2022.1">'user'</span></span><span class="koboSpan" id="kobo.2023.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2024.1">'user__profile'</span></span>
<span class="hljs-string"> </span><span class="koboSpan" id="kobo.2025.1">)</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2026.1"> .prefetch_related(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2027.1">'target'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2028.1">)</span></strong></span><span class="koboSpan" id="kobo.2029.1">[:</span><span class="hljs-number"><span class="koboSpan" id="kobo.2030.1">10</span></span><span class="koboSpan" id="kobo.2031.1">]
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2032.1">return</span></span><span class="koboSpan" id="kobo.2033.1"> render(
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.2034.1">request,
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.2035.1">'account/dashboard.html'</span></span><span class="koboSpan" id="kobo.2036.1">,
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.2037.1">{</span><span class="hljs-string"><span class="koboSpan" id="kobo.2038.1">'section'</span></span><span class="koboSpan" id="kobo.2039.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.2040.1">'dashboard'</span></span><span class="koboSpan" id="kobo.2041.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2042.1">'actions'</span></span><span class="koboSpan" id="kobo.2043.1">: actions}
    )
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2044.1">This query is now optimized </span><a id="_idIndexMarker680"/><span class="koboSpan" id="kobo.2045.1">for retrieving the user actions, including related objects.</span></p>
<h2 class="heading-2" id="_idParaDest-208"><span class="koboSpan" id="kobo.2046.1">Creating templates for actions</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2047.1">Let’s now create the template</span><a id="_idIndexMarker681"/><span class="koboSpan" id="kobo.2048.1"> to display a particular </span><code class="inlineCode"><span class="koboSpan" id="kobo.2049.1">Action</span></code><span class="koboSpan" id="kobo.2050.1"> object. </span><span class="koboSpan" id="kobo.2050.2">Create a new directory inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2051.1">actions</span></code><span class="koboSpan" id="kobo.2052.1"> application directory and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.2053.1">templates</span></code><span class="koboSpan" id="kobo.2054.1">. </span><span class="koboSpan" id="kobo.2054.2">Add the following file structure to it:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2055.1">actions/
    action/
        detail.html
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2056.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2057.1">actions/action/detail.html</span></code><span class="koboSpan" id="kobo.2058.1"> template file and add the following lines to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2059.1">{% load thumbnail %}
{% with user=action.user profile=action.user.profile %}
</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2060.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2061.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2062.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2063.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2064.1">"action"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2065.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2066.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2067.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2068.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2069.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2070.1">"images"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2071.1">&gt;</span></span><span class="koboSpan" id="kobo.2072.1">
    {% if profile.photo %}
      {% thumbnail user.profile.photo "80x80" crop="100%" as im %}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2073.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2074.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2075.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2076.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2077.1">"{{ user.get_absolute_url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2078.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2079.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2080.1">img</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2081.1">src</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2082.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2083.1">"{{ im.url }}"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2084.1">alt</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2085.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2086.1">"{{ user.get_full_name }}"</span></span>
<span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2087.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2088.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2089.1">"item-img"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2090.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2091.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2092.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2093.1">&gt;</span></span><span class="koboSpan" id="kobo.2094.1">
    {% endif %}
    {% if action.target %}
      {% with target=action.target %}
        {% if target.image %}
          {% thumbnail target.image "80x80" crop="100%" as im %}
          </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2095.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2096.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2097.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2098.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2099.1">"{{ target.get_absolute_url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2100.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2101.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2102.1">img</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2103.1">src</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2104.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2105.1">"{{ im.url }}"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2106.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2107.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2108.1">"item-img"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2109.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2110.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2111.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2112.1">&gt;</span></span><span class="koboSpan" id="kobo.2113.1">
        {% endif %}
      {% endwith %}
    {% endif %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2114.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2115.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2116.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2117.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2118.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2119.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2120.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2121.1">"info"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2122.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2123.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2124.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2125.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2126.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2127.1">span</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2128.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2129.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2130.1">"date"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2131.1">&gt;</span></span><span class="koboSpan" id="kobo.2132.1">{{ action.created|timesince }} ago</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2133.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2134.1">span</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2135.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2136.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2137.1">br</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2138.1"> /&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2139.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2140.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2141.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2142.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2143.1">"{{ user.get_absolute_url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2144.1">&gt;</span></span><span class="koboSpan" id="kobo.2145.1">
        {{ user.first_name }}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2146.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2147.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2148.1">&gt;</span></span><span class="koboSpan" id="kobo.2149.1">
      {{ action.verb }}
      {% if action.target %}
        {% with target=action.target %}
          </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2150.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2151.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2152.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2153.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2154.1">"{{ target.get_absolute_url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2155.1">&gt;</span></span><span class="koboSpan" id="kobo.2156.1">{{ target }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2157.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2158.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2159.1">&gt;</span></span><span class="koboSpan" id="kobo.2160.1">
        {% endwith %}
      {% endif %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2161.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2162.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2163.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2164.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2165.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2166.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2167.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2168.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2169.1">&gt;</span></span><span class="koboSpan" id="kobo.2170.1">
{% endwith %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2171.1">This is the template used to</span><a id="_idIndexMarker682"/><span class="koboSpan" id="kobo.2172.1"> display an </span><code class="inlineCode"><span class="koboSpan" id="kobo.2173.1">Action</span></code><span class="koboSpan" id="kobo.2174.1"> object. </span><span class="koboSpan" id="kobo.2174.2">First, you use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2175.1">{% with %}</span></code><span class="koboSpan" id="kobo.2176.1"> template tag to retrieve the user performing the action and the related </span><code class="inlineCode"><span class="koboSpan" id="kobo.2177.1">Profile</span></code><span class="koboSpan" id="kobo.2178.1"> object. </span><span class="koboSpan" id="kobo.2178.2">Then, you display the image of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2179.1">target</span></code><span class="koboSpan" id="kobo.2180.1"> object if the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2181.1">Action</span></code><span class="koboSpan" id="kobo.2182.1"> object has a related </span><code class="inlineCode"><span class="koboSpan" id="kobo.2183.1">target</span></code><span class="koboSpan" id="kobo.2184.1"> object. </span><span class="koboSpan" id="kobo.2184.2">Finally, you display the link to the user who performed the action, the verb, and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2185.1">target</span></code><span class="koboSpan" id="kobo.2186.1"> object, if any.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2187.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2188.1">account/dashboard.html</span></code><span class="koboSpan" id="kobo.2189.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2190.1">account</span></code><span class="koboSpan" id="kobo.2191.1"> application and append the following code highlighted in bold to the bottom of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2192.1">content</span></code><span class="koboSpan" id="kobo.2193.1"> block:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2194.1">{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
  ...
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2195.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2196.1">h2</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2197.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2198.1">What's happening</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2199.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2200.1">h2</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2201.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2202.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2203.1">div</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.2204.1">id</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2205.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2206.1">"action-list"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2207.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2208.1">    {% for action in actions %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2209.1">      {% include "actions/action/detail.html" %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2210.1">    {% endfor %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2211.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2212.1">div</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2213.1">&gt;</span></strong></span><span class="koboSpan" id="kobo.2214.1">
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2215.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.2216.1">http://127.0.0.1:8000/account/</span></code><span class="koboSpan" id="kobo.2217.1"> in your browser. </span><span class="koboSpan" id="kobo.2217.2">Log in as an existing user and perform several actions so </span><a id="_idIndexMarker683"/><span class="koboSpan" id="kobo.2218.1">that they get stored in the database. </span><span class="koboSpan" id="kobo.2218.2">Then, log in using another user, follow the previous user, and take a look at the generated action stream on the dashboard page.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2219.1">It should look like the following:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2220.1"><img alt="Graphical user interface, text, application, chat or text message  Description automatically generated" src="../Images/B21088_07_08.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2221.1">Figure 7.8: The activity stream for the current user</span></p>
<div class="note">
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.2222.1">Figure 7.8</span></em><span class="koboSpan" id="kobo.2223.1"> image attributions</span><em class="italic"><span class="koboSpan" id="kobo.2224.1">:</span></em></p>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.2225.1">Tesla’s induction motor </span></em><span class="koboSpan" id="kobo.2226.1">by Ctac</span><em class="italic"> </em><span class="koboSpan" id="kobo.2227.1">(license – Creative Commons Attribution Share-Alike 3.0 Unported:</span><em class="italic"> </em><a href="https://creativecommons.org/licenses/by-sa/3.0/"><span class="url"><span class="koboSpan" id="kobo.2228.1">https://creativecommons.org/licenses/by-sa/3.0/</span></span></a><span class="koboSpan" id="kobo.2229.1">)</span></p>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.2230.1">Turing Machine Model Davey 2012 </span></em><span class="koboSpan" id="kobo.2231.1">by Rocky Acosta</span><em class="italic"> </em><span class="koboSpan" id="kobo.2232.1">(license – Creative Commons Attribution 3.0 Unported: </span><a href="https://creativecommons.org/licenses/by/3.0/"><span class="url"><span class="koboSpan" id="kobo.2233.1">https://creativecommons.org/licenses/by/3.0/</span></span></a><span class="koboSpan" id="kobo.2234.1">)</span></p>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.2235.1">Chick Corea</span></em><span class="koboSpan" id="kobo.2236.1"> by ataelw (license – Creative Commons Attribution 2.0 Generic: </span><a href="https://creativecommons.org/licenses/by/2.0/"><span class="url"><span class="koboSpan" id="kobo.2237.1">https://creativecommons.org/licenses/by/2.0/</span></span></a><span class="koboSpan" id="kobo.2238.1">)</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.2239.1">You just created a complete activity stream for your users, and you can easily add new user actions to it. </span><span class="koboSpan" id="kobo.2239.2">You can also add infinite scroll functionality to the activity stream by implementing the</span><a id="_idIndexMarker684"/><span class="koboSpan" id="kobo.2240.1"> same AJAX paginator that you used for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2241.1">image_list</span></code><span class="koboSpan" id="kobo.2242.1"> view. </span><span class="koboSpan" id="kobo.2242.2">Next, you will learn how to use Django signals to denormalize action counts.</span></p>
<h1 class="heading-1" id="_idParaDest-209"><span class="koboSpan" id="kobo.2243.1">Using signals for denormalizing counts</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2244.1">There are some cases when you may want to denormalize your data. </span><span class="koboSpan" id="kobo.2244.2">Denormalization is making data redundant in such a way that it optimizes read performance. </span><span class="koboSpan" id="kobo.2244.3">For example, you might be copying related</span><a id="_idIndexMarker685"/><span class="koboSpan" id="kobo.2245.1"> data to an object to avoid expensive read queries to the database when retrieving the related data. </span><span class="koboSpan" id="kobo.2245.2">You have to be careful about denormalization and only start using it when you really need it. </span><span class="koboSpan" id="kobo.2245.3">The biggest issue you will find with denormalization is that it’s difficult to keep your denormalized data updated.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2246.1">Let’s take a look at an example of how to improve your queries by denormalizing counts. </span><span class="koboSpan" id="kobo.2246.2">You will denormalize data from your </span><code class="inlineCode"><span class="koboSpan" id="kobo.2247.1">Image</span></code><span class="koboSpan" id="kobo.2248.1"> model and use Django signals to keep the data updated.</span></p>
<h2 class="heading-2" id="_idParaDest-210"><span class="koboSpan" id="kobo.2249.1">Working with signals</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2250.1">Django comes with a signal </span><a id="_idIndexMarker686"/><span class="koboSpan" id="kobo.2251.1">dispatcher that allows receiver functions to get notified when certain actions occur. </span><span class="koboSpan" id="kobo.2251.2">Signals are very useful when you need your code to do something every time something else happens. </span><span class="koboSpan" id="kobo.2251.3">Signals allow you to decouple logic: you can capture a certain action, regardless of the application or code that triggered that action, and implement logic that gets executed whenever that action occurs. </span><span class="koboSpan" id="kobo.2251.4">For example, you can build a signal receiver function that gets executed every time a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2252.1">User</span></code><span class="koboSpan" id="kobo.2253.1"> object is saved. </span><span class="koboSpan" id="kobo.2253.2">You can also create your own signals so that others can get notified when an event happens.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2254.1">Django provides several signals for models located at </span><code class="inlineCode"><span class="koboSpan" id="kobo.2255.1">django.db.models.signals</span></code><span class="koboSpan" id="kobo.2256.1">. </span><span class="koboSpan" id="kobo.2256.2">Some of these signals are as follows:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2257.1">pre_save</span></code><span class="koboSpan" id="kobo.2258.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2259.1">post_save</span></code><span class="koboSpan" id="kobo.2260.1"> are sent before or after calling the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2261.1">save()</span></code><span class="koboSpan" id="kobo.2262.1"> method of a model</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2263.1">pre_delete</span></code><span class="koboSpan" id="kobo.2264.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2265.1">post_delete</span></code><span class="koboSpan" id="kobo.2266.1"> are sent before or after calling the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2267.1">delete()</span></code><span class="koboSpan" id="kobo.2268.1"> method of a model or QuerySet</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2269.1">m2m_changed</span></code><span class="koboSpan" id="kobo.2270.1"> is sent </span><a id="_idIndexMarker687"/><span class="koboSpan" id="kobo.2271.1">when a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2272.1">ManyToManyField</span></code><span class="koboSpan" id="kobo.2273.1"> on a model is changed</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.2274.1">These are just a subset of the signals provided by Django. </span><span class="koboSpan" id="kobo.2274.2">You can find a list of all built-in signals at </span><a href="https://docs.djangoproject.com/en/5.0/ref/signals/"><span class="url"><span class="koboSpan" id="kobo.2275.1">https://docs.djangoproject.com/en/5.0/ref/signals/</span></span></a><span class="koboSpan" id="kobo.2276.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2277.1">Let’s say you want to retrieve images by popularity. </span><span class="koboSpan" id="kobo.2277.2">You can use the Django aggregation functions to retrieve images ordered by the number of users who like them. </span><span class="koboSpan" id="kobo.2277.3">Remember that you used Django aggregation functions in </span><em class="italic"><span class="koboSpan" id="kobo.2278.1">Chapter 3</span></em><span class="koboSpan" id="kobo.2279.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2280.1">Extending Your Blog Application</span></em><span class="koboSpan" id="kobo.2281.1">. </span><span class="koboSpan" id="kobo.2281.2">The following code example will retrieve images according to their number of likes:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2282.1">from</span></span><span class="koboSpan" id="kobo.2283.1"> django.db.models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2284.1">import</span></span><span class="koboSpan" id="kobo.2285.1"> Count
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2286.1">from</span></span><span class="koboSpan" id="kobo.2287.1"> images.models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2288.1">import</span></span><span class="koboSpan" id="kobo.2289.1"> Image
images_by_popularity = Image.objects.annotate(
    total_likes=Count(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2290.1">'users_like'</span></span><span class="koboSpan" id="kobo.2291.1">)
).order_by(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2292.1">'-total_likes'</span></span><span class="koboSpan" id="kobo.2293.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2294.1">However, ordering images by counting their total likes is more expensive in terms of performance than ordering them by a field that stores total counts. </span><span class="koboSpan" id="kobo.2294.2">You can add a field to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2295.1">Image</span></code><span class="koboSpan" id="kobo.2296.1"> model to denormalize the total number of likes to boost performance in queries that involve this field. </span><span class="koboSpan" id="kobo.2296.2">The issue is how to keep this field updated.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2297.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2298.1">models.py</span></code><span class="koboSpan" id="kobo.2299.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2300.1">images</span></code><span class="koboSpan" id="kobo.2301.1"> application and add the following </span><code class="inlineCode"><span class="koboSpan" id="kobo.2302.1">total_likes</span></code><span class="koboSpan" id="kobo.2303.1"> field to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2304.1">Image</span></code><span class="koboSpan" id="kobo.2305.1"> model. </span><span class="koboSpan" id="kobo.2305.2">The new code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2306.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2307.1">Image</span></span><span class="koboSpan" id="kobo.2308.1">(models.Model):
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.2309.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2310.1">    total_likes = models.PositiveIntegerField(default=</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.2311.1">0</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2312.1">)</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2313.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2314.1">Meta</span></span><span class="koboSpan" id="kobo.2315.1">:
        indexes = [
            models.Index(fields=[</span><span class="hljs-string"><span class="koboSpan" id="kobo.2316.1">'-created'</span></span><span class="koboSpan" id="kobo.2317.1">]),
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2318.1">            models.Index(fields=[</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2319.1">'-total_likes'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2320.1">]),</span></strong></span><span class="koboSpan" id="kobo.2321.1">
        ]
        ordering = [</span><span class="hljs-string"><span class="koboSpan" id="kobo.2322.1">'-created'</span></span><span class="koboSpan" id="kobo.2323.1">]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2324.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2325.1">total_likes</span></code><span class="koboSpan" id="kobo.2326.1"> field will allow you to store the total count of users who like each image. </span><span class="koboSpan" id="kobo.2326.2">Denormalizing counts is </span><a id="_idIndexMarker688"/><span class="koboSpan" id="kobo.2327.1">useful when you want to filter or order QuerySets by them. </span><span class="koboSpan" id="kobo.2327.2">We have added a database index for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2328.1">total_likes</span></code><span class="koboSpan" id="kobo.2329.1"> field in descending order because we plan to retrieve images ordered by their total likes in descending order.</span></p>
<div class="packt_tip">
<p class="normal"><span class="koboSpan" id="kobo.2330.1"> There are several ways to improve performance that you have to take into account before denormalizing fields. </span><span class="koboSpan" id="kobo.2330.2">Consider database indexes, query optimization, and caching before starting to denormalize your data.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.2331.1">Run the following command to create the migrations for adding the new field to the database table:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2332.1">python manage.py makemigrations images
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2333.1">You should see the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2334.1">Migrations for 'images':
  images/migrations/0002_image_total_likes_and_more.py
    - Add field total_likes to image
    - Create index images_imag_total_l_0bcd7e_idx on field(s) -total_likes of model image
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2335.1">Then, run the following command to apply the migration:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2336.1">python manage.py migrate images
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2337.1">The output should include the following line:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2338.1">Applying images.0002_image_total_likes_and_more... </span><span class="koboSpan" id="kobo.2338.2">OK
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2339.1">You need to attach a receiver function to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2340.1">m2m_changed</span></code><span class="koboSpan" id="kobo.2341.1"> signal.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2342.1">Create a new file inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2343.1">images</span></code><span class="koboSpan" id="kobo.2344.1"> application directory and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.2345.1">signals.py</span></code><span class="koboSpan" id="kobo.2346.1">. </span><span class="koboSpan" id="kobo.2346.2">Add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2347.1">from</span></span><span class="koboSpan" id="kobo.2348.1"> django.db.models.signals </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2349.1">import</span></span><span class="koboSpan" id="kobo.2350.1"> m2m_changed
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2351.1">from</span></span><span class="koboSpan" id="kobo.2352.1"> django.dispatch </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2353.1">import</span></span><span class="koboSpan" id="kobo.2354.1"> receiver
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2355.1">from</span></span><span class="koboSpan" id="kobo.2356.1"> .models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2357.1">import</span></span><span class="koboSpan" id="kobo.2358.1"> Image
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.2359.1">@receiver(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2360.1">m2m_changed, sender=Image.users_like.through</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.2361.1">)</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2362.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2363.1">users_like_changed</span></span><span class="koboSpan" id="kobo.2364.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2365.1">sender, instance, **kwargs</span></span><span class="koboSpan" id="kobo.2366.1">):
    instance.total_likes = instance.users_like.count()
    instance.save()
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2367.1">First, you register the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2368.1">users_like_changed</span></code><span class="koboSpan" id="kobo.2369.1"> function as a receiver function using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2370.1">receiver()</span></code><span class="koboSpan" id="kobo.2371.1"> decorator. </span><span class="koboSpan" id="kobo.2371.2">You attach</span><a id="_idIndexMarker689"/><span class="koboSpan" id="kobo.2372.1"> it to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2373.1">m2m_changed</span></code><span class="koboSpan" id="kobo.2374.1"> signal. </span><span class="koboSpan" id="kobo.2374.2">Then, you connect the function to </span><code class="inlineCode"><span class="koboSpan" id="kobo.2375.1">Image.users_like.through</span></code><span class="koboSpan" id="kobo.2376.1"> so that the function is only called if the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2377.1">m2m_changed</span></code><span class="koboSpan" id="kobo.2378.1"> signal has been launched by this sender. </span><span class="koboSpan" id="kobo.2378.2">There is an alternate method for registering a receiver function; it consists of using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2379.1">connect()</span></code><span class="koboSpan" id="kobo.2380.1"> method of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2381.1">Signal</span></code><span class="koboSpan" id="kobo.2382.1"> object.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.2383.1">Django signals are synchronous and blocking. </span><span class="koboSpan" id="kobo.2383.2">Don’t confuse signals with asynchronous tasks. </span><span class="koboSpan" id="kobo.2383.3">However, you can combine both to launch asynchronous tasks when your code gets notified by a signal. </span><span class="koboSpan" id="kobo.2383.4">You will learn how to create asynchronous tasks with Celery in </span><em class="italic"><span class="koboSpan" id="kobo.2384.1">Chapter 8</span></em><span class="koboSpan" id="kobo.2385.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2386.1">Building an Online Shop</span></em><span class="koboSpan" id="kobo.2387.1">.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.2388.1">You have to connect your receiver function to a signal so that it gets called every time the signal is sent. </span><span class="koboSpan" id="kobo.2388.2">The recommended method for registering your signals is by importing them into the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2389.1">ready()</span></code><span class="koboSpan" id="kobo.2390.1"> method of your application configuration class. </span><span class="koboSpan" id="kobo.2390.2">Django provides an application registry that allows you to configure and introspect your applications.</span></p>
<h2 class="heading-2" id="_idParaDest-211"><span class="koboSpan" id="kobo.2391.1">Application configuration classes</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2392.1">Django allows you to specify configuration</span><a id="_idIndexMarker690"/><span class="koboSpan" id="kobo.2393.1"> classes for your applications. </span><span class="koboSpan" id="kobo.2393.2">When you create an application using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2394.1">startapp</span></code><span class="koboSpan" id="kobo.2395.1"> command, Django adds an </span><code class="inlineCode"><span class="koboSpan" id="kobo.2396.1">apps.py</span></code><span class="koboSpan" id="kobo.2397.1"> file to the application directory, including a basic application configuration that inherits from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2398.1">AppConfig</span></code><span class="koboSpan" id="kobo.2399.1"> class.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2400.1">The application configuration class allows you to store metadata and the configuration for the application, and it provides introspection for the application. </span><span class="koboSpan" id="kobo.2400.2">You can find more information about application configurations at </span><a href="https://docs.djangoproject.com/en/5.0/ref/applications/"><span class="url"><span class="koboSpan" id="kobo.2401.1">https://docs.djangoproject.com/en/5.0/ref/applications/</span></span></a><span class="koboSpan" id="kobo.2402.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2403.1">In order to register your signal receiver functions, when you use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2404.1">receiver()</span></code><span class="koboSpan" id="kobo.2405.1"> decorator, you just need to import the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2406.1">signals</span></code><span class="koboSpan" id="kobo.2407.1"> module of your application inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2408.1">ready()</span></code><span class="koboSpan" id="kobo.2409.1"> method of the application configuration class. </span><span class="koboSpan" id="kobo.2409.2">This method is called as soon as the application registry is fully populated. </span><span class="koboSpan" id="kobo.2409.3">Any other initializations for your application should also be included in </span><a id="_idIndexMarker691"/><span class="koboSpan" id="kobo.2410.1">this method.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2411.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2412.1">apps.py</span></code><span class="koboSpan" id="kobo.2413.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2414.1">images</span></code><span class="koboSpan" id="kobo.2415.1"> application and add the following code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2416.1">from</span></span><span class="koboSpan" id="kobo.2417.1"> django.apps </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2418.1">import</span></span><span class="koboSpan" id="kobo.2419.1"> AppConfig
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2420.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2421.1">ImagesConfig</span></span><span class="koboSpan" id="kobo.2422.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.2423.1">AppConfig</span></span><span class="koboSpan" id="kobo.2424.1">):
    default_auto_field = </span><span class="hljs-string"><span class="koboSpan" id="kobo.2425.1">'django.db.models.BigAutoField'</span></span><span class="koboSpan" id="kobo.2426.1">
    name = </span><span class="hljs-string"><span class="koboSpan" id="kobo.2427.1">'images'</span></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2428.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2429.1">ready</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2430.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.2431.1">self</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2432.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.2433.1"># import signal handlers</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2434.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2435.1"> images.signals</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2436.1">You import the signals for this application in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2437.1">ready()</span></code><span class="koboSpan" id="kobo.2438.1"> method so that they are imported when the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2439.1">images</span></code><span class="koboSpan" id="kobo.2440.1"> application is loaded.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2441.1">Run the development server with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2442.1">python manage.py runserver
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2443.1">Open your browser to view an image detail page and click on the </span><strong class="screenText"><span class="koboSpan" id="kobo.2444.1">Like</span></strong><span class="koboSpan" id="kobo.2445.1"> button.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2446.1">Go to the administration site, navigate to the edit image URL, such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.2447.1">http://127.0.0.1:8000/admin/images/image/1/change/</span></code><span class="koboSpan" id="kobo.2448.1">, and take a look at the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2449.1">total_likes</span></code><span class="koboSpan" id="kobo.2450.1"> attribute. </span><span class="koboSpan" id="kobo.2450.2">You should see that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2451.1">total_likes</span></code><span class="koboSpan" id="kobo.2452.1"> attribute is updated with the total number of users who like the image, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2453.1"><img alt="Graphical user interface  Description automatically generated" src="../Images/B21088_07_09.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2454.1">Figure 7.9: The image edit page on the administration site, including denormalization for total likes</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2455.1">Now, you can use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2456.1">total_likes</span></code><span class="koboSpan" id="kobo.2457.1"> attribute to order images by popularity or display the value anywhere, avoiding using complex queries to calculate it.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2458.1">Consider the following </span><a id="_idIndexMarker692"/><span class="koboSpan" id="kobo.2459.1">query to get images ordered by their likes count in descending order:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2460.1">from</span></span><span class="koboSpan" id="kobo.2461.1"> django.db.models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2462.1">import</span></span><span class="koboSpan" id="kobo.2463.1"> Count
images_by_popularity = Image.objects.annotate(
    likes=Count(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2464.1">'users_like'</span></span><span class="koboSpan" id="kobo.2465.1">)
).order_by(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2466.1">'-likes'</span></span><span class="koboSpan" id="kobo.2467.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2468.1">The preceding query can now be written as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2469.1">images_by_popularity = Image.objects.order_by(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2470.1">'-total_likes'</span></span><span class="koboSpan" id="kobo.2471.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2472.1">This results in a less expensive SQL query thanks to denormalizing the total likes for images. </span><span class="koboSpan" id="kobo.2472.2">You have also learned how you can use Django signals.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.2473.1">Use signals with caution since they make it difficult to know the control flow. </span><span class="koboSpan" id="kobo.2473.2">In many cases, you can avoid using signals if you know which receivers need to be notified.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.2474.1">You will need to set initial counts for the rest of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2475.1">Image</span></code><span class="koboSpan" id="kobo.2476.1"> objects to match the current status of the database.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2477.1">Open the shell with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2478.1">python manage.py shell
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2479.1">Execute the following code in the shell:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2480.1">&gt;&gt;&gt;</span></span> <span class="hljs-con-keyword"><span class="koboSpan" id="kobo.2481.1">from</span></span><span class="koboSpan" id="kobo.2482.1"> images.models </span><span class="hljs-con-keyword"><span class="koboSpan" id="kobo.2483.1">import</span></span><span class="koboSpan" id="kobo.2484.1"> Image
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2485.1">&gt;&gt;&gt;</span></span> <span class="hljs-con-keyword"><span class="koboSpan" id="kobo.2486.1">for</span></span><span class="koboSpan" id="kobo.2487.1"> image </span><span class="hljs-con-keyword"><span class="koboSpan" id="kobo.2488.1">in</span></span><span class="koboSpan" id="kobo.2489.1"> Image.objects.</span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.2490.1">all</span></span><span class="koboSpan" id="kobo.2491.1">():
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2492.1">...</span></span><span class="koboSpan" id="kobo.2493.1">    image.total_likes = image.users_like.count()
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2494.1">...</span></span><span class="koboSpan" id="kobo.2495.1">    image.save()
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2496.1">You have manually updated the likes count for the existing images in the database. </span><span class="koboSpan" id="kobo.2496.2">From now on, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2497.1">users_like_changed</span></code><span class="koboSpan" id="kobo.2498.1"> signal receiver function will handle updating the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2499.1">total_likes</span></code><span class="koboSpan" id="kobo.2500.1"> field whenever the many-to-many related objects change.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2501.1">Next, you will learn how to use Django Debug Toolbar to obtain relevant debug information for requests, including</span><a id="_idIndexMarker693"/><span class="koboSpan" id="kobo.2502.1"> execution time, SQL queries executed, templates rendered, signals registered, and much more.</span></p>
<h1 class="heading-1" id="_idParaDest-212"><span class="koboSpan" id="kobo.2503.1">Using Django Debug Toolbar</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2504.1">By this point, you will already be </span><a id="_idIndexMarker694"/><span class="koboSpan" id="kobo.2505.1">familiar with Django’s debug page. </span><span class="koboSpan" id="kobo.2505.2">Throughout the previous chapters, you have seen the distinctive yellow and gray Django debug page several times. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.2506.1">For example, in </span><em class="italic"><span class="koboSpan" id="kobo.2507.1">Chapter 2</span></em><span class="koboSpan" id="kobo.2508.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2509.1">Enhancing Your Blog with Advanced Features</span></em><span class="koboSpan" id="kobo.2510.1">, in the </span><em class="italic"><span class="koboSpan" id="kobo.2511.1">Handling pagination errors</span></em><span class="koboSpan" id="kobo.2512.1"> section, the debug page showed information related to unhandled exceptions when implementing object pagination.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2513.1">The Django debug page provides useful debug information. </span><span class="koboSpan" id="kobo.2513.2">However, there is a Django application that includes more detailed debug information and can be really helpful when developing.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2514.1">Django Debug Toolbar is an external Django application that allows you to see relevant debug information about the current request/response cycle. </span><span class="koboSpan" id="kobo.2514.2">The information is divided into multiple panels that show different information, including request/response data, Python package versions used, execution time, settings, headers, SQL queries, templates used, cache, signals, and logging.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2515.1">You can find the documentation</span><a id="_idIndexMarker695"/><span class="koboSpan" id="kobo.2516.1"> for Django Debug Toolbar at </span><a href="https://django-debug-toolbar.readthedocs.io/"><span class="url"><span class="koboSpan" id="kobo.2517.1">https://django-debug-toolbar.readthedocs.io/</span></span></a><span class="koboSpan" id="kobo.2518.1">.</span></p>
<h2 class="heading-2" id="_idParaDest-213"><span class="koboSpan" id="kobo.2519.1">Installing Django Debug Toolbar</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2520.1">Install </span><code class="inlineCode"><span class="koboSpan" id="kobo.2521.1">django-debug-toolbar</span></code><span class="koboSpan" id="kobo.2522.1"> via </span><code class="inlineCode"><span class="koboSpan" id="kobo.2523.1">pip</span></code><span class="koboSpan" id="kobo.2524.1"> using</span><a id="_idIndexMarker696"/><span class="koboSpan" id="kobo.2525.1"> the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2526.1">python -m pip install django-debug-toolbar==4.3.0
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2527.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2528.1">settings.py</span></code><span class="koboSpan" id="kobo.2529.1"> file of your project and add </span><code class="inlineCode"><span class="koboSpan" id="kobo.2530.1">debug_toolbar</span></code><span class="koboSpan" id="kobo.2531.1"> to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2532.1">INSTALLED_APPS</span></code><span class="koboSpan" id="kobo.2533.1"> setting, as follows. </span><span class="koboSpan" id="kobo.2533.2">The new line is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2534.1">INSTALLED_APPS = [
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.2535.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2536.1">'debug_toolbar'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2537.1">,</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.2538.1"># ...</span></span><span class="koboSpan" id="kobo.2539.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2540.1">In the same file, add the following line highlighted in bold to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2541.1">MIDDLEWARE</span></code><span class="koboSpan" id="kobo.2542.1"> setting:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2543.1">MIDDLEWARE = [
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2544.1">'debug_toolbar.middleware.DebugToolbarMiddleware'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2545.1">,</span></strong></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.2546.1">'django.middleware.security.SecurityMiddleware'</span></span><span class="koboSpan" id="kobo.2547.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.2548.1">'django.contrib.sessions.middleware.SessionMiddleware'</span></span><span class="koboSpan" id="kobo.2549.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.2550.1">'django.middleware.common.CommonMiddleware'</span></span><span class="koboSpan" id="kobo.2551.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.2552.1">'django.middleware.csrf.CsrfViewMiddleware'</span></span><span class="koboSpan" id="kobo.2553.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.2554.1">'django.contrib.auth.middleware.AuthenticationMiddleware'</span></span><span class="koboSpan" id="kobo.2555.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.2556.1">'django.contrib.messages.middleware.MessageMiddleware'</span></span><span class="koboSpan" id="kobo.2557.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.2558.1">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span></span><span class="koboSpan" id="kobo.2559.1">,
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2560.1">Django Debug Toolbar is mostly implemented as middleware. </span><span class="koboSpan" id="kobo.2560.2">The order of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2561.1">MIDDLEWARE</span></code><span class="koboSpan" id="kobo.2562.1"> is important. </span><code class="inlineCode"><span class="koboSpan" id="kobo.2563.1">DebugToolbarMiddleware</span></code><span class="koboSpan" id="kobo.2564.1"> has to be placed before any other middleware, except for middleware that encodes the response’s content, such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.2565.1">GZipMiddleware</span></code><span class="koboSpan" id="kobo.2566.1">, which, if present, should come first.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2567.1">Add the following lines at the end of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2568.1">settings.py</span></code><span class="koboSpan" id="kobo.2569.1"> file:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2570.1">INTERNAL_IPS = [
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.2571.1">'127.0.0.1'</span></span><span class="koboSpan" id="kobo.2572.1">,
]  
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2573.1">Django Debug Toolbar will only display if your IP address matches an entry in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2574.1">INTERNAL_IPS</span></code><span class="koboSpan" id="kobo.2575.1"> setting. </span><span class="koboSpan" id="kobo.2575.2">To prevent showing debug information in production, Django Debug Toolbar checks that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2576.1">DEBUG</span></code><span class="koboSpan" id="kobo.2577.1"> setting is </span><code class="inlineCode"><span class="koboSpan" id="kobo.2578.1">True</span></code><span class="koboSpan" id="kobo.2579.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2580.1">Edit the main </span><code class="inlineCode"><span class="koboSpan" id="kobo.2581.1">urls.py</span></code><span class="koboSpan" id="kobo.2582.1"> file of your </span><a id="_idIndexMarker697"/><span class="koboSpan" id="kobo.2583.1">project and add the following URL pattern highlighted in bold to </span><code class="inlineCode"><span class="koboSpan" id="kobo.2584.1">urlpatterns</span></code><span class="koboSpan" id="kobo.2585.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2586.1">urlpatterns = [
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2587.1">'admin/'</span></span><span class="koboSpan" id="kobo.2588.1">, admin.site.urls),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2589.1">'account/'</span></span><span class="koboSpan" id="kobo.2590.1">, include(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2591.1">'account.urls'</span></span><span class="koboSpan" id="kobo.2592.1">)),
    path(
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2593.1">'social-auth/'</span></span><span class="koboSpan" id="kobo.2594.1">,
        include(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2595.1">'social_django.urls'</span></span><span class="koboSpan" id="kobo.2596.1">, namespace=</span><span class="hljs-string"><span class="koboSpan" id="kobo.2597.1">'social'</span></span><span class="koboSpan" id="kobo.2598.1">)
    ),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2599.1">'images/'</span></span><span class="koboSpan" id="kobo.2600.1">, include(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2601.1">'images.urls'</span></span><span class="koboSpan" id="kobo.2602.1">, namespace=</span><span class="hljs-string"><span class="koboSpan" id="kobo.2603.1">'images'</span></span><span class="koboSpan" id="kobo.2604.1">)),
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2605.1">    path(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2606.1">'__debug__/'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2607.1">, include(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2608.1">'debug_toolbar.urls'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2609.1">)),</span></strong></span><span class="koboSpan" id="kobo.2610.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2611.1">Django Debug Toolbar is now installed in your project. </span><span class="koboSpan" id="kobo.2611.2">Let’s try it out!</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2612.1">Run the development server with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2613.1">python manage.py runserver
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2614.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.2615.1">http://127.0.0.1:8000/images/</span></code><span class="koboSpan" id="kobo.2616.1"> with your browser. </span><span class="koboSpan" id="kobo.2616.2">You should now see a collapsible sidebar on the right. </span><span class="koboSpan" id="kobo.2616.3">It should look as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2617.1"><img alt="" role="presentation" src="../Images/B21088_07_10.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2618.1">Figure 7.10: The Django Debug Toolbar sidebar</span></p>
<div class="note">
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.2619.1">Figure 7.10</span></em><span class="koboSpan" id="kobo.2620.1"> image attributions:</span></p>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.2621.1">Chick Corea</span></em><span class="koboSpan" id="kobo.2622.1"> by ataelw (license – Creative Commons Attribution 2.0 Generic: </span><a href="https://creativecommons.org/licenses/by/2.0/"><span class="url"><span class="koboSpan" id="kobo.2623.1">https://creativecommons.org/licenses/by/2.0/</span></span></a><span class="koboSpan" id="kobo.2624.1">)</span></p>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.2625.1">Al Jarreau Düsseldorf 1981</span></em><span class="koboSpan" id="kobo.2626.1"> by Eddi</span><a id="_idIndexMarker698"/><span class="koboSpan" id="kobo.2627.1"> Laumanns aka RX-Guru (license – Creative Commons Attribution 3.0 Unported: </span><a href="https://creativecommons.org/licenses/by/3.0/"><span class="url"><span class="koboSpan" id="kobo.2628.1">https://creativecommons.org/licenses/by/3.0/</span></span></a><span class="koboSpan" id="kobo.2629.1">)</span></p>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.2630.1">Al Jarreau </span></em><span class="koboSpan" id="kobo.2631.1">by Kingkongphoto and www.celebrity-photos.com (license – Creative Commons Attribution-ShareAlike 2.0 Generic: </span><a href="https://creativecommons.org/licenses/by-sa/2.0/"><span class="url"><span class="koboSpan" id="kobo.2632.1">https://creativecommons.org/licenses/by-sa/2.0/</span></span></a><span class="koboSpan" id="kobo.2633.1">)</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.2634.1">If the Debug Toolbar doesn’t appear, check the RunServer shell console log. </span><span class="koboSpan" id="kobo.2634.2">If you see a MIME type error, it is most </span><a id="_idIndexMarker699"/><span class="koboSpan" id="kobo.2635.1">likely that your MIME map files are incorrect or need to be updated.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2636.1">You can apply the correct mapping for JavaScript and CSS files by adding the following lines to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2637.1">settings.py</span></code><span class="koboSpan" id="kobo.2638.1"> file:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2639.1">if</span></span><span class="koboSpan" id="kobo.2640.1"> DEBUG:
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2641.1">import</span></span><span class="koboSpan" id="kobo.2642.1"> mimetypes
    mimetypes.add_type(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2643.1">'application/javascript'</span></span><span class="koboSpan" id="kobo.2644.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2645.1">'.js'</span></span><span class="koboSpan" id="kobo.2646.1">, </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2647.1">True</span></span><span class="koboSpan" id="kobo.2648.1">)
    mimetypes.add_type(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2649.1">'text/css'</span></span><span class="koboSpan" id="kobo.2650.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2651.1">'.css'</span></span><span class="koboSpan" id="kobo.2652.1">, </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2653.1">True</span></span><span class="koboSpan" id="kobo.2654.1">)
</span></code></pre>
<h2 class="heading-2" id="_idParaDest-214"><span class="koboSpan" id="kobo.2655.1">Django Debug Toolbar panels</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2656.1">Django Debug Toolbar features multiple</span><a id="_idIndexMarker700"/><span class="koboSpan" id="kobo.2657.1"> panels that organize the debug information for the request/response cycle. </span><span class="koboSpan" id="kobo.2657.2">The sidebar contains links to each panel, and you can use the checkbox of any panel to activate or deactivate it. </span><span class="koboSpan" id="kobo.2657.3">The change will be applied to the next request. </span><span class="koboSpan" id="kobo.2657.4">This is useful when we are not interested in a specific panel, but the calculation adds too much overhead to the request.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2658.1">Click on </span><strong class="screenText"><span class="koboSpan" id="kobo.2659.1">Time</span></strong><span class="koboSpan" id="kobo.2660.1"> in the sidebar menu. </span><span class="koboSpan" id="kobo.2660.2">You will see the following panel:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2661.1"><img alt="" role="presentation" src="../Images/B21088_07_11.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2662.1"> Figure 7.11: Time panel – Django Debug Toolbar</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2663.1">The </span><strong class="screenText"><span class="koboSpan" id="kobo.2664.1">Time</span></strong><span class="koboSpan" id="kobo.2665.1"> panel includes a timer for the different phases of the request/response cycle. </span><span class="koboSpan" id="kobo.2665.2">It also shows CPU, elapsed</span><a id="_idIndexMarker701"/><span class="koboSpan" id="kobo.2666.1"> time, and the number of context switches. </span><span class="koboSpan" id="kobo.2666.2">If you are using Windows, you won’t be able to see the </span><strong class="screenText"><span class="koboSpan" id="kobo.2667.1">Time</span></strong><span class="koboSpan" id="kobo.2668.1"> panel. </span><span class="koboSpan" id="kobo.2668.2">In Windows, only the total time is available and displayed in the toolbar.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2669.1">Click on </span><strong class="screenText"><span class="koboSpan" id="kobo.2670.1">SQL</span></strong><span class="koboSpan" id="kobo.2671.1"> in the sidebar menu. </span><span class="koboSpan" id="kobo.2671.2">You will see the following panel:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2672.1"><img alt="" role="presentation" src="../Images/B21088_07_12.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2673.1">Figure 7.12: SQL panel – Django Debug Toolbar</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2674.1">Here, you can see the different SQL queries that have been executed. </span><span class="koboSpan" id="kobo.2674.2">This information can help you identify unnecessary queries, duplicated queries that can be reused, or long-running queries that can be optimized. </span><span class="koboSpan" id="kobo.2674.3">Based on your findings, you can improve QuerySets in your views, create</span><a id="_idIndexMarker702"/><span class="koboSpan" id="kobo.2675.1"> new indexes on model fields if necessary, or cache information when needed. </span><span class="koboSpan" id="kobo.2675.2">In this chapter, you learned how to optimize queries that involve relationships using </span><code class="inlineCode"><span class="koboSpan" id="kobo.2676.1">select_related()</span></code><span class="koboSpan" id="kobo.2677.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2678.1">prefetch_related()</span></code><span class="koboSpan" id="kobo.2679.1">. </span><span class="koboSpan" id="kobo.2679.2">You will learn how to cache data in </span><em class="italic"><span class="koboSpan" id="kobo.2680.1">Chapter 14</span></em><span class="koboSpan" id="kobo.2681.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2682.1">Rendering and Caching Content</span></em><span class="koboSpan" id="kobo.2683.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2684.1">Click on </span><strong class="screenText"><span class="koboSpan" id="kobo.2685.1">Templates</span></strong><span class="koboSpan" id="kobo.2686.1"> in the sidebar menu. </span><span class="koboSpan" id="kobo.2686.2">You will see the following panel:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2687.1"><img alt="" role="presentation" src="../Images/B21088_07_13.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2688.1">Figure 7.13: Templates panel – Django Debug Toolbar</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2689.1">This panel shows the </span><a id="_idIndexMarker703"/><span class="koboSpan" id="kobo.2690.1">different templates used when rendering the content, the template paths, and the context used. </span><span class="koboSpan" id="kobo.2690.2">You can also see the different context processors used. </span><span class="koboSpan" id="kobo.2690.3">You will learn about context processors in </span><em class="italic"><span class="koboSpan" id="kobo.2691.1">Chapter 8</span></em><span class="koboSpan" id="kobo.2692.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2693.1">Building an Online Shop</span></em><span class="koboSpan" id="kobo.2694.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2695.1">Click on </span><strong class="screenText"><span class="koboSpan" id="kobo.2696.1">Signals</span></strong><span class="koboSpan" id="kobo.2697.1"> in the sidebar menu. </span><span class="koboSpan" id="kobo.2697.2">You will see the following panel:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2698.1"><img alt="" role="presentation" src="../Images/B21088_07_14.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2699.1">Figure 7.14: Signals panel – Django Debug Toolbar</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2700.1">In this panel, you can see all the</span><a id="_idIndexMarker704"/><span class="koboSpan" id="kobo.2701.1"> signals that are registered in your project and the receiver functions attached to each signal. </span><span class="koboSpan" id="kobo.2701.2">For example, you can find the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2702.1">users_like_changed</span></code><span class="koboSpan" id="kobo.2703.1"> receiver function you created before, attached to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2704.1">m2m_changed</span></code><span class="koboSpan" id="kobo.2705.1"> signal. </span><span class="koboSpan" id="kobo.2705.2">The other signals and receivers are part of the different Django applications.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2706.1">We have reviewed some of the panels that ship with Django Debug Toolbar. </span><span class="koboSpan" id="kobo.2706.2">Besides the built-in panels, you can find additional third-party panels that you can download and use at </span><a href="https://django-debug-toolbar.readthedocs.io/en/latest/panels.html#third-party-panels"><span class="url"><span class="koboSpan" id="kobo.2707.1">https://django-debug-toolbar.readthedocs.io/en/latest/panels.html#third-party-panels</span></span></a><span class="koboSpan" id="kobo.2708.1">.</span></p>
<h2 class="heading-2" id="_idParaDest-215"><span class="koboSpan" id="kobo.2709.1">Django Debug Toolbar commands</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2710.1">Besides the request/response debug panels, Django Debug Toolbar provides a management command to debug SQL </span><a id="_idIndexMarker705"/><span class="koboSpan" id="kobo.2711.1">for ORM calls. </span><span class="koboSpan" id="kobo.2711.2">The management command </span><code class="inlineCode"><span class="koboSpan" id="kobo.2712.1">debugsqlshell</span></code><span class="koboSpan" id="kobo.2713.1"> replicates the Django </span><code class="inlineCode"><span class="koboSpan" id="kobo.2714.1">shell</span></code><span class="koboSpan" id="kobo.2715.1"> command but it outputs SQL statements for queries performed with the Django ORM.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2716.1">Open the shell with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2717.1">python manage.py debugsqlshell
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2718.1">Execute the following code:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2719.1">&gt;&gt;&gt;</span></span> <span class="hljs-con-keyword"><span class="koboSpan" id="kobo.2720.1">from</span></span><span class="koboSpan" id="kobo.2721.1"> images.models </span><span class="hljs-con-keyword"><span class="koboSpan" id="kobo.2722.1">import</span></span><span class="koboSpan" id="kobo.2723.1"> Image
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2724.1">&gt;&gt;&gt;</span></span><span class="koboSpan" id="kobo.2725.1"> Image.objects.get(</span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.2726.1">id</span></span><span class="koboSpan" id="kobo.2727.1">=</span><span class="hljs-con-number"><span class="koboSpan" id="kobo.2728.1">1</span></span><span class="koboSpan" id="kobo.2729.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2730.1">You will see the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2731.1">SELECT "images_image"."id",
       "images_image"."user_id",
       "images_image"."title",
       "images_image"."slug",
       "images_image"."url",
       "images_image"."image",
       "images_image"."description",
       "images_image"."created",
       "images_image"."total_likes"
FROM "images_image"
WHERE "images_image"."id" = 1
LIMIT 21 [0.44ms]
&lt;Image: Django and Duke&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2732.1">You can use this command to test ORM queries before adding them to your views. </span><span class="koboSpan" id="kobo.2732.2">You can check the resulting SQL statement and the execution time for each ORM call.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2733.1">In the next section, you will learn how to count image views using Redis, an in-memory database that provides low latency and high-throughput data access.</span></p>
<h1 class="heading-1" id="_idParaDest-216"><span class="koboSpan" id="kobo.2734.1">Counting image views with Redis</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2735.1">Redis is an advanced key/value</span><a id="_idIndexMarker706"/><span class="koboSpan" id="kobo.2736.1"> database that allows you to save different types of data. </span><span class="koboSpan" id="kobo.2736.2">It also has extremely fast I/O operations. </span><span class="koboSpan" id="kobo.2736.3">Redis stores everything in memory, but </span><a id="_idIndexMarker707"/><span class="koboSpan" id="kobo.2737.1">the data can be persisted by dumping the dataset to disk every once in a while, or by adding each command to a log. </span><span class="koboSpan" id="kobo.2737.2">Redis is very versatile compared to other key/value stores: it provides a set of powerful commands and supports diverse data structures, such as strings, hashes, lists, sets, ordered sets, and even </span><code class="inlineCode"><span class="koboSpan" id="kobo.2738.1">bitmap</span></code><span class="koboSpan" id="kobo.2739.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.2740.1">HyperLogLog</span></code><span class="koboSpan" id="kobo.2741.1"> methods.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2742.1">Although SQL is best suited to schema-defined persistent data storage, Redis offers numerous advantages when dealing with rapidly changing data, volatile storage, or when a quick cache is needed. </span><span class="koboSpan" id="kobo.2742.2">Let’s take a look at how Redis can be used to build new functionality in your project.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2743.1">You can find more information about Redis on its home page at </span><a href="https://redis.io/"><span class="url"><span class="koboSpan" id="kobo.2744.1">https://redis.io/</span></span></a><span class="koboSpan" id="kobo.2745.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2746.1">Redis provides a Docker image that makes it very easy to deploy a Redis server with a standard configuration.</span></p>
<h2 class="heading-2" id="_idParaDest-217"><span class="koboSpan" id="kobo.2747.1">Installing Redis</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2748.1">To install the Redis Docker image, make sure Docker is installed on your machine. </span><span class="koboSpan" id="kobo.2748.2">You learned how to install </span><a id="_idIndexMarker708"/><span class="koboSpan" id="kobo.2749.1">Docker in </span><em class="italic"><span class="koboSpan" id="kobo.2750.1">Chapter 3</span></em><span class="koboSpan" id="kobo.2751.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2752.1">Extending Your Blog Application</span></em><span class="koboSpan" id="kobo.2753.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2754.1">Run the following command from the shell:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2755.1">docker pull redis:7.2.4
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2756.1">This will download the Redis Docker image to your local machine. </span><span class="koboSpan" id="kobo.2756.2">You can find information about the official Redis Docker image at </span><a href="https://hub.docker.com/_/redis"><span class="url"><span class="koboSpan" id="kobo.2757.1">https://hub.docker.com/_/redis</span></span></a><span class="koboSpan" id="kobo.2758.1">. </span><span class="koboSpan" id="kobo.2758.2">You can find other alternative methods to install Redis at </span><a href="https://redis.io/download/"><span class="url"><span class="koboSpan" id="kobo.2759.1">https://redis.io/download/</span></span></a><span class="koboSpan" id="kobo.2760.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2761.1">Execute the following command in the shell to start the Redis Docker container:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2762.1">docker run -it --rm --name redis -p 6379:6379 redis:7.2.4
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2763.1">With this command, we run Redis in a Docker container. </span><span class="koboSpan" id="kobo.2763.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2764.1">-it</span></code><span class="koboSpan" id="kobo.2765.1"> option tells Docker to take you straight inside the container for interactive input. </span><span class="koboSpan" id="kobo.2765.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2766.1">--rm</span></code><span class="koboSpan" id="kobo.2767.1"> option tells Docker to automatically clean up the container and remove the file system when the container exits. </span><span class="koboSpan" id="kobo.2767.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2768.1">--name</span></code><span class="koboSpan" id="kobo.2769.1"> option is used to assign a name to the container. </span><span class="koboSpan" id="kobo.2769.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2770.1">-p</span></code><span class="koboSpan" id="kobo.2771.1"> option is used to publish the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2772.1">6379</span></code><span class="koboSpan" id="kobo.2773.1"> port on which Redis runs to the same host interface port. </span><code class="inlineCode"><span class="koboSpan" id="kobo.2774.1">6379</span></code><span class="koboSpan" id="kobo.2775.1"> is the default port for Redis.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2776.1">You should see an output</span><a id="_idIndexMarker709"/><span class="koboSpan" id="kobo.2777.1"> that ends with the following lines:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2778.1"># </span></span><span class="koboSpan" id="kobo.2779.1">Server initialized
* Ready to accept connections
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2780.1">Keep the Redis server running on port </span><code class="inlineCode"><span class="koboSpan" id="kobo.2781.1">6379</span></code><span class="koboSpan" id="kobo.2782.1"> and open another shell. </span><span class="koboSpan" id="kobo.2782.2">Start the Redis client with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2783.1">docker exec -it redis sh
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2784.1">You will see a line with the hash symbol:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2785.1">#</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2786.1">Start the Redis client with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2787.1"># </span></span><span class="koboSpan" id="kobo.2788.1">redis-cli
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2789.1">You will see the Redis client shell prompt, like this:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2790.1">127.0.0.1:6379&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2791.1">The Redis client allows you to execute Redis commands directly from the shell. </span><span class="koboSpan" id="kobo.2791.2">Let’s try some commands. </span><span class="koboSpan" id="kobo.2791.3">Enter the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2792.1">SET</span></code><span class="koboSpan" id="kobo.2793.1"> command in the Redis shell to store a value in a key:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2794.1">127.0.0.1:6379&gt; SET name "Peter"
OK
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2795.1">The preceding command creates a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2796.1">name</span></code><span class="koboSpan" id="kobo.2797.1"> key with the string value </span><code class="inlineCode"><span class="koboSpan" id="kobo.2798.1">"Peter"</span></code><span class="koboSpan" id="kobo.2799.1"> in the Redis database. </span><span class="koboSpan" id="kobo.2799.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2800.1">OK</span></code><span class="koboSpan" id="kobo.2801.1"> output indicates that the key has been saved successfully.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2802.1">Next, retrieve the value using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2803.1">GET</span></code><span class="koboSpan" id="kobo.2804.1"> command, as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2805.1">127.0.0.1:6379&gt; GET name
"Peter"
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2806.1">You can also check whether a key exists using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2807.1">EXISTS</span></code><span class="koboSpan" id="kobo.2808.1"> command. </span><span class="koboSpan" id="kobo.2808.2">This command returns </span><code class="inlineCode"><span class="koboSpan" id="kobo.2809.1">1</span></code><span class="koboSpan" id="kobo.2810.1"> if the given key exists and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2811.1">0</span></code><span class="koboSpan" id="kobo.2812.1"> otherwise:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2813.1">127.0.0.1:6379&gt; EXISTS name
(integer) 1
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2814.1">You can set the time for a key to expire using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2815.1">EXPIRE</span></code><span class="koboSpan" id="kobo.2816.1"> command, which allows you to set the time-to-live in seconds. </span><span class="koboSpan" id="kobo.2816.2">Another </span><a id="_idIndexMarker710"/><span class="koboSpan" id="kobo.2817.1">option is using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2818.1">EXPIREAT</span></code><span class="koboSpan" id="kobo.2819.1"> command, which expects a Unix timestamp. </span><span class="koboSpan" id="kobo.2819.2">Key expiration is useful for using Redis as a cache or to store volatile data:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2820.1">127.0.0.1:6379&gt; GET name
"Peter"
127.0.0.1:6379&gt; EXPIRE name 2
(integer) 1
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2821.1">Wait for more than two seconds and try to get the same key again:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2822.1">127.0.0.1:6379&gt; GET name
(nil)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2823.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2824.1">(nil)</span></code><span class="koboSpan" id="kobo.2825.1"> response is a null response and means that no key has been found. </span><span class="koboSpan" id="kobo.2825.2">You can also delete any key using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2826.1">DEL</span></code><span class="koboSpan" id="kobo.2827.1"> command, as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2828.1">127.0.0.1:6379&gt; SET total 1
OK
127.0.0.1:6379&gt; DEL total
(integer) 1
127.0.0.1:6379&gt; GET total
(nil)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2829.1">These are just basic commands for key operations. </span><span class="koboSpan" id="kobo.2829.2">You can find all Redis commands at </span><a href="https://redis.io/commands/"><span class="url"><span class="koboSpan" id="kobo.2830.1">https://redis.io/commands/</span></span></a><span class="koboSpan" id="kobo.2831.1"> and all Redis data types at </span><a href="https://redis.io/docs/manual/data-types/"><span class="url"><span class="koboSpan" id="kobo.2832.1">https://redis.io/docs/manual/data-types/</span></span></a><span class="koboSpan" id="kobo.2833.1">.</span></p>
<h2 class="heading-2" id="_idParaDest-218"><span class="koboSpan" id="kobo.2834.1">Using Redis with Python</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2835.1">You will need Python bindings for </span><a id="_idIndexMarker711"/><span class="koboSpan" id="kobo.2836.1">Redis. </span><span class="koboSpan" id="kobo.2836.2">Install </span><code class="inlineCode"><span class="koboSpan" id="kobo.2837.1">redis-py</span></code><span class="koboSpan" id="kobo.2838.1"> via </span><code class="inlineCode"><span class="koboSpan" id="kobo.2839.1">pip</span></code><span class="koboSpan" id="kobo.2840.1"> using the</span><a id="_idIndexMarker712"/><span class="koboSpan" id="kobo.2841.1"> following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2842.1">python -m pip install redis==5.0.4
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2843.1">You can find the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2844.1">redis-py</span></code><span class="koboSpan" id="kobo.2845.1"> documentation at </span><a href="https://redis-py.readthedocs.io/"><span class="url"><span class="koboSpan" id="kobo.2846.1">https://redis-py.readthedocs.io/</span></span></a><span class="koboSpan" id="kobo.2847.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2848.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2849.1">redis-py</span></code><span class="koboSpan" id="kobo.2850.1"> package interacts with Redis, providing a Python interface that follows the Redis command syntax. </span><span class="koboSpan" id="kobo.2850.2">Open</span><a id="_idIndexMarker713"/><span class="koboSpan" id="kobo.2851.1"> the Python shell with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2852.1">python manage.py shell
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2853.1">Execute the following code:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2854.1">&gt;&gt;&gt;</span></span> <span class="hljs-con-keyword"><span class="koboSpan" id="kobo.2855.1">import</span></span><span class="koboSpan" id="kobo.2856.1"> redis
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2857.1">&gt;&gt;&gt;</span></span><span class="koboSpan" id="kobo.2858.1"> r = redis.Redis(host=</span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2859.1">'localhost'</span></span><span class="koboSpan" id="kobo.2860.1">, port=</span><span class="hljs-con-number"><span class="koboSpan" id="kobo.2861.1">6379</span></span><span class="koboSpan" id="kobo.2862.1">, db=</span><span class="hljs-con-number"><span class="koboSpan" id="kobo.2863.1">0</span></span><span class="koboSpan" id="kobo.2864.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2865.1">The preceding code creates a connection with the Redis database. </span><span class="koboSpan" id="kobo.2865.2">In Redis, databases are identified by an integer index</span><a id="_idIndexMarker714"/><span class="koboSpan" id="kobo.2866.1"> instead of a database name. </span><span class="koboSpan" id="kobo.2866.2">By default, a client is connected to database </span><code class="inlineCode"><span class="koboSpan" id="kobo.2867.1">0</span></code><span class="koboSpan" id="kobo.2868.1">. </span><span class="koboSpan" id="kobo.2868.2">The number of available Redis databases is set to </span><code class="inlineCode"><span class="koboSpan" id="kobo.2869.1">16</span></code><span class="koboSpan" id="kobo.2870.1"> but you can change this in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2871.1">redis.conf</span></code><span class="koboSpan" id="kobo.2872.1"> configuration file.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2873.1">Next, set a key using the Python shell:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2874.1">&gt;&gt;&gt;</span></span><span class="koboSpan" id="kobo.2875.1"> r.</span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.2876.1">set</span></span><span class="koboSpan" id="kobo.2877.1">(</span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2878.1">'foo'</span></span><span class="koboSpan" id="kobo.2879.1">, </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2880.1">'bar'</span></span><span class="koboSpan" id="kobo.2881.1">)
True
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2882.1">The command returns </span><code class="inlineCode"><span class="koboSpan" id="kobo.2883.1">True</span></code><span class="koboSpan" id="kobo.2884.1">, indicating that the key has been successfully created. </span><span class="koboSpan" id="kobo.2884.2">Now you can retrieve the key using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2885.1">get()</span></code><span class="koboSpan" id="kobo.2886.1"> command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2887.1">&gt;&gt;&gt;</span></span><span class="koboSpan" id="kobo.2888.1"> r.get(</span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2889.1">'foo'</span></span><span class="koboSpan" id="kobo.2890.1">)
b'bar'
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2891.1">As you will note from the preceding code, the methods of Redis follow the Redis command syntax.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2892.1">Let’s integrate Redis into your project. </span><span class="koboSpan" id="kobo.2892.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2893.1">settings.py</span></code><span class="koboSpan" id="kobo.2894.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2895.1">bookmarks</span></code><span class="koboSpan" id="kobo.2896.1"> project and add the following settings to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2897.1">REDIS_HOST = </span><span class="hljs-string"><span class="koboSpan" id="kobo.2898.1">'localhost'</span></span><span class="koboSpan" id="kobo.2899.1">
REDIS_PORT = </span><span class="hljs-number"><span class="koboSpan" id="kobo.2900.1">6379</span></span><span class="koboSpan" id="kobo.2901.1">
REDIS_DB = </span><span class="hljs-number"><span class="koboSpan" id="kobo.2902.1">0</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2903.1">These are the settings for the Redis server and the database that you will use for your project.</span></p>
<h2 class="heading-2" id="_idParaDest-219"><span class="koboSpan" id="kobo.2904.1">Storing image views in Redis</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2905.1">Let’s find a way to </span><a id="_idIndexMarker715"/><span class="koboSpan" id="kobo.2906.1">store the total number of times an image has been viewed. </span><span class="koboSpan" id="kobo.2906.2">If you implement this using the Django ORM, it will involve a SQL </span><code class="inlineCode"><span class="koboSpan" id="kobo.2907.1">UPDATE</span></code><span class="koboSpan" id="kobo.2908.1"> query every time an image is displayed.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2909.1">If you use Redis instead, you just need to increment a counter stored in memory, resulting in much better performance and less overhead.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2910.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2911.1">views.py</span></code><span class="koboSpan" id="kobo.2912.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2913.1">images</span></code><span class="koboSpan" id="kobo.2914.1"> application and add the following code to it after the existing </span><code class="inlineCode"><span class="koboSpan" id="kobo.2915.1">import</span></code><span class="koboSpan" id="kobo.2916.1"> statements:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2917.1">import</span></span><span class="koboSpan" id="kobo.2918.1"> redis
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2919.1">from</span></span><span class="koboSpan" id="kobo.2920.1"> django.conf </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2921.1">import</span></span><span class="koboSpan" id="kobo.2922.1"> settings
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.2923.1"># connect to redis</span></span><span class="koboSpan" id="kobo.2924.1">
r = redis.Redis(
    host=settings.REDIS_HOST,
    port=settings.REDIS_PORT,
    db=settings.REDIS_DB
)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2925.1">With the preceding code, you establish the Redis connection in order to use it in your views. </span><span class="koboSpan" id="kobo.2925.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2926.1">views.py</span></code><span class="koboSpan" id="kobo.2927.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2928.1">images</span></code><span class="koboSpan" id="kobo.2929.1"> application and modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2930.1">image_detail</span></code><span class="koboSpan" id="kobo.2931.1"> view, like this. </span><span class="koboSpan" id="kobo.2931.2">The new code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2932.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2933.1">image_detail</span></span><span class="koboSpan" id="kobo.2934.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2935.1">request, </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2936.1">id</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2937.1">, slug</span></span><span class="koboSpan" id="kobo.2938.1">):
    image = get_object_or_404(Image, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2939.1">id</span></span><span class="koboSpan" id="kobo.2940.1">=</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2941.1">id</span></span><span class="koboSpan" id="kobo.2942.1">, slug=slug)
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.2943.1"># increment total image views by 1</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2944.1">    total_views = r.incr(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2945.1">f'image:</span></strong><strong class="hljs-subst-slc"><span class="koboSpan" id="kobo.2946.1">{image.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.2947.1">id</span></strong><strong class="hljs-subst-slc"><span class="koboSpan" id="kobo.2948.1">}</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2949.1">:views'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2950.1">)</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2951.1">return</span></span><span class="koboSpan" id="kobo.2952.1"> render(
        request,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2953.1">'images/image/detail.html'</span></span><span class="koboSpan" id="kobo.2954.1">,
        {
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.2955.1">'section'</span></span><span class="koboSpan" id="kobo.2956.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.2957.1">'images'</span></span><span class="koboSpan" id="kobo.2958.1">,
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.2959.1">'image'</span></span><span class="koboSpan" id="kobo.2960.1">: image</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2961.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2962.1">'total_views'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2963.1">: total_views</span></strong></span><span class="koboSpan" id="kobo.2964.1">
        }
    )
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2965.1">In this view, you use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2966.1">incr</span></code><span class="koboSpan" id="kobo.2967.1"> command, which increments the value of a given key by </span><code class="inlineCode"><span class="koboSpan" id="kobo.2968.1">1</span></code><span class="koboSpan" id="kobo.2969.1">. </span><span class="koboSpan" id="kobo.2969.2">If the key doesn’t exist, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2970.1">incr</span></code><span class="koboSpan" id="kobo.2971.1"> command creates it. </span><span class="koboSpan" id="kobo.2971.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2972.1">incr()</span></code><span class="koboSpan" id="kobo.2973.1"> method returns the final value of the key after performing the operation. </span><span class="koboSpan" id="kobo.2973.2">You store the value in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2974.1">total_views</span></code><span class="koboSpan" id="kobo.2975.1"> variable and </span><a id="_idIndexMarker716"/><span class="koboSpan" id="kobo.2976.1">pass it into the template context. </span><span class="koboSpan" id="kobo.2976.2">You build the Redis key using a notation such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.2977.1">object-type:id:field</span></code><span class="koboSpan" id="kobo.2978.1"> (for example, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2979.1">image:33:id</span></code><span class="koboSpan" id="kobo.2980.1">).</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.2981.1">The convention for naming Redis keys is to use a colon sign as a separator for creating namespaced keys. </span><span class="koboSpan" id="kobo.2981.2">By doing so, the key names are especially verbose, and related keys share part of the same schema in their names.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.2982.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2983.1">images/image/detail.html</span></code><span class="koboSpan" id="kobo.2984.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2985.1">images</span></code><span class="koboSpan" id="kobo.2986.1"> application and add the following code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2987.1">...
</span><span class="koboSpan" id="kobo.2987.2">&lt;div </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2988.1">class</span></span><span class="koboSpan" id="kobo.2989.1">=</span><span class="hljs-string"><span class="koboSpan" id="kobo.2990.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2991.1">image-info"</span></span><span class="koboSpan" id="kobo.2992.1">&gt;
  &lt;div&gt;
    &lt;span </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2993.1">class</span></span><span class="koboSpan" id="kobo.2994.1">=</span><span class="hljs-string"><span class="koboSpan" id="kobo.2995.1">"count"</span></span><span class="koboSpan" id="kobo.2996.1">&gt;
      &lt;span </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2997.1">class</span></span><span class="koboSpan" id="kobo.2998.1">=</span><span class="hljs-string"><span class="koboSpan" id="kobo.2999.1">"total"</span></span><span class="koboSpan" id="kobo.3000.1">&gt;{{ total_likes }}&lt;/span&gt;
      like{{ total_likes|pluralize }}
    &lt;/span&gt;
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3001.1">    &lt;span </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3002.1">class</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3003.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3004.1">"count"</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3005.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3006.1">      {{ total_views }} view{{ total_views|pluralize }}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3007.1">    &lt;/span&gt;</span></strong></span><span class="koboSpan" id="kobo.3008.1">
    &lt;a href=</span><span class="hljs-string"><span class="koboSpan" id="kobo.3009.1">"#"</span></span><span class="koboSpan" id="kobo.3010.1"> data-</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3011.1">id</span></span><span class="koboSpan" id="kobo.3012.1">=</span><span class="hljs-string"><span class="koboSpan" id="kobo.3013.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3014.1">{{ image.id }}"</span></span><span class="koboSpan" id="kobo.3015.1"> data-action=</span><span class="hljs-string"><span class="koboSpan" id="kobo.3016.1">"{% if request.user in users_like %}un{% endif %}like"</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.3017.1">class</span></span><span class="koboSpan" id="kobo.3018.1">=</span><span class="hljs-string"><span class="koboSpan" id="kobo.3019.1">"like button"</span></span><span class="koboSpan" id="kobo.3020.1">&gt;
      {% </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3021.1">if</span></span><span class="koboSpan" id="kobo.3022.1"> request.user </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3023.1">not</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3024.1">in</span></span><span class="koboSpan" id="kobo.3025.1"> users_like %}
        Like
      {% </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3026.1">else</span></span><span class="koboSpan" id="kobo.3027.1"> %}
        Unlike
      {% endif %}
    &lt;/a&gt;
  &lt;/div&gt;
  {{ image.description|linebreaks }}
&lt;/div&gt;
...
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3028.1">Run the development server with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.3029.1">python manage.py runserver
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3030.1">Open an image detail page in your browser and reload it several times. </span><span class="koboSpan" id="kobo.3030.2">You will see that each time the view is </span><a id="_idIndexMarker717"/><span class="koboSpan" id="kobo.3031.1">processed, the total views displayed is incremented by 1. </span><span class="koboSpan" id="kobo.3031.2">Take a look at the following example:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.3032.1"><img alt="Graphical user interface, text, application, chat or text message  Description automatically generated" src="../Images/B21088_07_15.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.3033.1">Figure 7.15: The image detail page, including the count of likes and views</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3034.1">Great! </span><span class="koboSpan" id="kobo.3034.2">You have successfully integrated Redis into your project to count image views. </span><span class="koboSpan" id="kobo.3034.3">In the next section, you will learn how to build a ranking of the most viewed images with Redis.</span></p>
<h2 class="heading-2" id="_idParaDest-220"><span class="koboSpan" id="kobo.3035.1">Storing a ranking in Redis</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.3036.1">We will now create something more complex with Redis. </span><span class="koboSpan" id="kobo.3036.2">We will use Redis to store a ranking of the most viewed</span><a id="_idIndexMarker718"/><span class="koboSpan" id="kobo.3037.1"> images on the platform. </span><span class="koboSpan" id="kobo.3037.2">We will use Redis sorted sets for this. </span><span class="koboSpan" id="kobo.3037.3">A sorted set is a non-repeating collection of strings in which every member is associated with a score. </span><span class="koboSpan" id="kobo.3037.4">Items are sorted by their score.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3038.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3039.1">views.py</span></code><span class="koboSpan" id="kobo.3040.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3041.1">images</span></code><span class="koboSpan" id="kobo.3042.1"> application and add the following code highlighted in bold to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3043.1">image_detail</span></code><span class="koboSpan" id="kobo.3044.1"> view:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3045.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3046.1">image_detail</span></span><span class="koboSpan" id="kobo.3047.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3048.1">request, </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3049.1">id</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.3050.1">, slug</span></span><span class="koboSpan" id="kobo.3051.1">):
    image = get_object_or_404(Image, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3052.1">id</span></span><span class="koboSpan" id="kobo.3053.1">=</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3054.1">id</span></span><span class="koboSpan" id="kobo.3055.1">, slug=slug)
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.3056.1"># increment total image views by 1</span></span><span class="koboSpan" id="kobo.3057.1">
    total_views = r.incr(</span><span class="hljs-string"><span class="koboSpan" id="kobo.3058.1">f'image:</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.3059.1">{image.</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3060.1">id</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.3061.1">}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3062.1">:views'</span></span><span class="koboSpan" id="kobo.3063.1">)
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.3064.1"># increment image ranking by 1</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3065.1">    r.zincrby(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3066.1">'image_ranking'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3067.1">, </span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.3068.1">1</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3069.1">, image.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.3070.1">id</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3071.1">)</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.3072.1">return</span></span><span class="koboSpan" id="kobo.3073.1"> render(
        request,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.3074.1">'images/image/detail.html'</span></span><span class="koboSpan" id="kobo.3075.1">,
        {
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.3076.1">'section'</span></span><span class="koboSpan" id="kobo.3077.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.3078.1">'images'</span></span><span class="koboSpan" id="kobo.3079.1">,
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.3080.1">'image'</span></span><span class="koboSpan" id="kobo.3081.1">: image,
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.3082.1">'total_views'</span></span><span class="koboSpan" id="kobo.3083.1">: total_views
        }
    )
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3084.1">You use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3085.1">zincrby()</span></code><span class="koboSpan" id="kobo.3086.1"> command to store image views in a sorted set with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3087.1">image:ranking</span></code><span class="koboSpan" id="kobo.3088.1"> key. </span><span class="koboSpan" id="kobo.3088.2">You will store the image </span><code class="inlineCode"><span class="koboSpan" id="kobo.3089.1">id</span></code><span class="koboSpan" id="kobo.3090.1"> and a related score of </span><code class="inlineCode"><span class="koboSpan" id="kobo.3091.1">1</span></code><span class="koboSpan" id="kobo.3092.1">, which will be added to the total score of this element in the sorted set. </span><span class="koboSpan" id="kobo.3092.2">This will allow you to keep track of all image views globally and have a sorted set ordered by the total number of views.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3093.1">Now, create a new </span><a id="_idIndexMarker719"/><span class="koboSpan" id="kobo.3094.1">view to display the ranking of the most viewed images. </span><span class="koboSpan" id="kobo.3094.2">Add the following code to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3095.1">views.py</span></code><span class="koboSpan" id="kobo.3096.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3097.1">images</span></code><span class="koboSpan" id="kobo.3098.1"> application:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.3099.1">@login_required</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.3100.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3101.1">image_ranking</span></span><span class="koboSpan" id="kobo.3102.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3103.1">request</span></span><span class="koboSpan" id="kobo.3104.1">):
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.3105.1"># get image ranking dictionary</span></span><span class="koboSpan" id="kobo.3106.1">
    image_ranking = r.zrange(
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.3107.1">'image_ranking'</span></span><span class="koboSpan" id="kobo.3108.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.3109.1">0</span></span><span class="koboSpan" id="kobo.3110.1">, -</span><span class="hljs-number"><span class="koboSpan" id="kobo.3111.1">1</span></span><span class="koboSpan" id="kobo.3112.1">,
        desc=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.3113.1">True</span></span>
<span class="hljs-literal"> </span><span class="koboSpan" id="kobo.3114.1">)[:</span><span class="hljs-number"><span class="koboSpan" id="kobo.3115.1">10</span></span><span class="koboSpan" id="kobo.3116.1">]
    image_ranking_ids = [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3117.1">int</span></span><span class="koboSpan" id="kobo.3118.1">(</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3119.1">id</span></span><span class="koboSpan" id="kobo.3120.1">) </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3121.1">for</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.3122.1">id</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3123.1">in</span></span><span class="koboSpan" id="kobo.3124.1"> image_ranking]
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.3125.1"># get most viewed images</span></span><span class="koboSpan" id="kobo.3126.1">
    most_viewed = </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3127.1">list</span></span><span class="koboSpan" id="kobo.3128.1">(
        Image.objects.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3129.1">filter</span></span><span class="koboSpan" id="kobo.3130.1">(
            id__in=image_ranking_ids
        )
    )
    most_viewed.sort(key=</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3131.1">lambda</span></span><span class="koboSpan" id="kobo.3132.1"> x: image_ranking_ids.index(x.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3133.1">id</span></span><span class="koboSpan" id="kobo.3134.1">))
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3135.1">return</span></span><span class="koboSpan" id="kobo.3136.1"> render(
        request,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.3137.1">'images/image/ranking.html'</span></span><span class="koboSpan" id="kobo.3138.1">,
        {</span><span class="hljs-string"><span class="koboSpan" id="kobo.3139.1">'section'</span></span><span class="koboSpan" id="kobo.3140.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.3141.1">'images'</span></span><span class="koboSpan" id="kobo.3142.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.3143.1">'most_viewed'</span></span><span class="koboSpan" id="kobo.3144.1">: most_viewed}
    )
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3145.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3146.1">image_ranking</span></code><span class="koboSpan" id="kobo.3147.1"> view works like this:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.3148.1">You use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3149.1">zrange()</span></code><span class="koboSpan" id="kobo.3150.1"> command to obtain the elements in the sorted set. </span><span class="koboSpan" id="kobo.3150.2">This command expects a custom range according to the lowest and highest scores. </span><span class="koboSpan" id="kobo.3150.3">By using </span><code class="inlineCode"><span class="koboSpan" id="kobo.3151.1">0</span></code><span class="koboSpan" id="kobo.3152.1"> as the lowest and </span><code class="inlineCode"><span class="koboSpan" id="kobo.3153.1">-1</span></code><span class="koboSpan" id="kobo.3154.1"> as the highest score, you are telling Redis to return all elements in the sorted set. </span><span class="koboSpan" id="kobo.3154.2">You also specify </span><code class="inlineCode"><span class="koboSpan" id="kobo.3155.1">desc=True</span></code><span class="koboSpan" id="kobo.3156.1"> to retrieve the elements ordered by descending score. </span><span class="koboSpan" id="kobo.3156.2">Finally, you slice the results using </span><code class="inlineCode"><span class="koboSpan" id="kobo.3157.1">[:10]</span></code><span class="koboSpan" id="kobo.3158.1"> to get the first 10 elements with the highest score.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.3159.1">You build a list of </span><a id="_idIndexMarker720"/><span class="koboSpan" id="kobo.3160.1">returned image IDs and store it in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3161.1">image_ranking_ids</span></code><span class="koboSpan" id="kobo.3162.1"> variable as a list of integers. </span><span class="koboSpan" id="kobo.3162.2">You retrieve the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3163.1">Image</span></code><span class="koboSpan" id="kobo.3164.1"> objects for those IDs and force the query to be executed using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3165.1">list()</span></code><span class="koboSpan" id="kobo.3166.1"> function. </span><span class="koboSpan" id="kobo.3166.2">It is important to force the QuerySet execution because you will use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3167.1">sort()</span></code><span class="koboSpan" id="kobo.3168.1"> method on it (at this point, you need a list of objects instead of a QuerySet).</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.3169.1">You sort the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3170.1">Image</span></code><span class="koboSpan" id="kobo.3171.1"> objects by their index of appearance in the image ranking. </span><span class="koboSpan" id="kobo.3171.2">Now you can use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3172.1">most_viewed</span></code><span class="koboSpan" id="kobo.3173.1"> list in your template to display the 10 most viewed images.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.3174.1">Create a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.3175.1">ranking.html</span></code><span class="koboSpan" id="kobo.3176.1"> template inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3177.1">images/image/</span></code><span class="koboSpan" id="kobo.3178.1"> template directory of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3179.1">images</span></code><span class="koboSpan" id="kobo.3180.1"> application and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3181.1">{% extends "base.html" %}
{% block title %}Images ranking{% endblock %}
{% block content %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.3182.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3183.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3184.1">&gt;</span></span><span class="koboSpan" id="kobo.3185.1">Images ranking</span><span class="hljs-tag"><span class="koboSpan" id="kobo.3186.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3187.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3188.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3189.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3190.1">ol</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3191.1">&gt;</span></span><span class="koboSpan" id="kobo.3192.1">
    {% for image in most_viewed %}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.3193.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3194.1">li</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3195.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3196.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3197.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3198.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3199.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3200.1">"{{ image.get_absolute_url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3201.1">&gt;</span></span><span class="koboSpan" id="kobo.3202.1">
          {{ image.title }}
        </span><span class="hljs-tag"><span class="koboSpan" id="kobo.3203.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3204.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3205.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3206.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3207.1">li</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3208.1">&gt;</span></span><span class="koboSpan" id="kobo.3209.1">
    {% endfor %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.3210.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3211.1">ol</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3212.1">&gt;</span></span><span class="koboSpan" id="kobo.3213.1">
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3214.1">The template is pretty straightforward. </span><span class="koboSpan" id="kobo.3214.2">You iterate over the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3215.1">Image</span></code><span class="koboSpan" id="kobo.3216.1"> objects contained in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3217.1">most_viewed</span></code><span class="koboSpan" id="kobo.3218.1"> list and display their names, including a link to the image detail page.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3219.1">Finally, you need to create a URL pattern for the new view. </span><span class="koboSpan" id="kobo.3219.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3220.1">urls.py</span></code><span class="koboSpan" id="kobo.3221.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3222.1">images</span></code><span class="koboSpan" id="kobo.3223.1"> application and add the </span><a id="_idIndexMarker721"/><span class="koboSpan" id="kobo.3224.1">following URL pattern highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3225.1">urlpatterns = [
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.3226.1">'create/'</span></span><span class="koboSpan" id="kobo.3227.1">, views.image_create, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.3228.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3229.1">create'</span></span><span class="koboSpan" id="kobo.3230.1">),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.3231.1">'detail/&lt;int:id&gt;/&lt;slug:slug&gt;/'</span></span><span class="koboSpan" id="kobo.3232.1">,
         views.image_detail, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.3233.1">'detail'</span></span><span class="koboSpan" id="kobo.3234.1">),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.3235.1">'like/'</span></span><span class="koboSpan" id="kobo.3236.1">, views.image_like, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.3237.1">'like'</span></span><span class="koboSpan" id="kobo.3238.1">),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.3239.1">''</span></span><span class="koboSpan" id="kobo.3240.1">, views.image_list, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.3241.1">'list'</span></span><span class="koboSpan" id="kobo.3242.1">),
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3243.1">    path(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3244.1">'ranking/'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3245.1">, views.image_ranking, name=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3246.1">'ranking'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3247.1">),</span></strong></span><span class="koboSpan" id="kobo.3248.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3249.1">Run the development server, access your site in your web browser, and load the image detail page multiple times for different images. </span><span class="koboSpan" id="kobo.3249.2">Then, access </span><code class="inlineCode"><span class="koboSpan" id="kobo.3250.1">http://127.0.0.1:8000/images/ranking/</span></code><span class="koboSpan" id="kobo.3251.1"> from your browser. </span><span class="koboSpan" id="kobo.3251.2">You should be able to see an image ranking, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.3252.1"><img alt="Graphical user interface, table  Description automatically generated" src="../Images/B21088_07_16.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.3253.1">Figure 7.16: The ranking page built with data retrieved from Redis</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3254.1">Great! </span><span class="koboSpan" id="kobo.3254.2">You just created a ranking with Redis.</span></p>
<h2 class="heading-2" id="_idParaDest-221"><span class="koboSpan" id="kobo.3255.1">Next steps with Redis</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.3256.1">Redis is not a replacement for your SQL database but it does offer fast in-memory storage that is more suitable for certain tasks. </span><span class="koboSpan" id="kobo.3256.2">Add it to your stack and use it when you really feel it’s needed. </span><span class="koboSpan" id="kobo.3256.3">The following are </span><a id="_idIndexMarker722"/><span class="koboSpan" id="kobo.3257.1">some scenarios in which Redis could be useful:</span></p>
<ul>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.3258.1">Counting</span></strong><span class="koboSpan" id="kobo.3259.1">: As you have seen, it is very easy to manage counters with Redis. </span><span class="koboSpan" id="kobo.3259.2">You can use </span><code class="inlineCode"><span class="koboSpan" id="kobo.3260.1">incr()</span></code><span class="koboSpan" id="kobo.3261.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.3262.1">incrby()</span></code><span class="koboSpan" id="kobo.3263.1"> for counting stuff.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.3264.1">Storing the latest items</span></strong><span class="koboSpan" id="kobo.3265.1">: You can add items to the start/end of a list using </span><code class="inlineCode"><span class="koboSpan" id="kobo.3266.1">lpush()</span></code><span class="koboSpan" id="kobo.3267.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.3268.1">rpush()</span></code><span class="koboSpan" id="kobo.3269.1">. </span><span class="koboSpan" id="kobo.3269.2">Remove and return the first/last element using </span><code class="inlineCode"><span class="koboSpan" id="kobo.3270.1">lpop()</span></code><span class="koboSpan" id="kobo.3271.1">/</span><code class="inlineCode"><span class="koboSpan" id="kobo.3272.1">rpop()</span></code><span class="koboSpan" id="kobo.3273.1">. </span><span class="koboSpan" id="kobo.3273.2">You can trim the list’s length using </span><code class="inlineCode"><span class="koboSpan" id="kobo.3274.1">ltrim()</span></code><span class="koboSpan" id="kobo.3275.1"> to maintain its length.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.3276.1">Queues</span></strong><span class="koboSpan" id="kobo.3277.1">: In addition to </span><code class="inlineCode"><span class="koboSpan" id="kobo.3278.1">push</span></code><span class="koboSpan" id="kobo.3279.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.3280.1">pop</span></code><span class="koboSpan" id="kobo.3281.1"> commands, Redis offers the blocking of queue commands.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.3282.1">Caching</span></strong><span class="koboSpan" id="kobo.3283.1">: Using </span><code class="inlineCode"><span class="koboSpan" id="kobo.3284.1">expire()</span></code><span class="koboSpan" id="kobo.3285.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.3286.1">expireat()</span></code><span class="koboSpan" id="kobo.3287.1"> allows you to use Redis as a cache. </span><span class="koboSpan" id="kobo.3287.2">You can also find third-party Redis cache backends for Django.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.3288.1">Pub/sub</span></strong><span class="koboSpan" id="kobo.3289.1">: Redis provides commands for subscribing/unsubscribing and sending messages to channels.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.3290.1">Rankings and leaderboards</span></strong><span class="koboSpan" id="kobo.3291.1">: Redis’s sorted sets with scores make it very easy to create leaderboards.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.3292.1">Real-time tracking</span></strong><span class="koboSpan" id="kobo.3293.1">: Redis’s fast I/O makes it perfect for real-time scenarios.</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-222"><span class="koboSpan" id="kobo.3294.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3295.1">In this chapter, you built a follow system using many-to-many relationships with an intermediate model. </span><span class="koboSpan" id="kobo.3295.2">You also created an activity stream using generic relations and you optimized QuerySets to retrieve related objects. </span><span class="koboSpan" id="kobo.3295.3">This chapter then introduced you to Django signals, and you created a signal receiver function to denormalize related object counts. </span><span class="koboSpan" id="kobo.3295.4">We covered application configuration classes, which you used to load your signal handlers. </span><span class="koboSpan" id="kobo.3295.5">You added Django Debug Toolbar to your project. </span><span class="koboSpan" id="kobo.3295.6">You also learned how to install and configure Redis in your Django project. </span><span class="koboSpan" id="kobo.3295.7">Finally, you used Redis in your project to store item views, and you built an image ranking with Redis.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3296.1">In the next chapter, you will learn how to build an online shop. </span><span class="koboSpan" id="kobo.3296.2">You will create a product catalog and build a shopping cart using sessions. </span><span class="koboSpan" id="kobo.3296.3">You will learn how to create custom context processors. </span><span class="koboSpan" id="kobo.3296.4">You will also manage customer orders and send asynchronous notifications using Celery and RabbitMQ.</span></p>
<h1 class="heading-1" id="_idParaDest-223"><span class="koboSpan" id="kobo.3297.1">Expanding your project using AI</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3298.1">In this section, you are presented with a task to extend your project, accompanied by a sample prompt for ChatGPT to assist you. </span><span class="koboSpan" id="kobo.3298.2">To engage with ChatGPT, visit </span><a href="https://chat.openai.com/"><span class="url"><span class="koboSpan" id="kobo.3299.1">https://chat.openai.com/</span></span></a><span class="koboSpan" id="kobo.3300.1">. </span><span class="koboSpan" id="kobo.3300.2">If this is your first interaction with ChatGPT, you can revisit the </span><em class="italic"><span class="koboSpan" id="kobo.3301.1">Expanding your project using AI</span></em><span class="koboSpan" id="kobo.3302.1"> section in </span><em class="italic"><span class="koboSpan" id="kobo.3303.1">Chapter 3</span></em><span class="koboSpan" id="kobo.3304.1">, </span><em class="italic"><span class="koboSpan" id="kobo.3305.1">Extending Your Blog Application</span></em><span class="koboSpan" id="kobo.3306.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3307.1">In this project example, you have learned how to use Django signals and successfully implemented a signal receiver to update the total number of image likes whenever there is a change in the like count. </span><span class="koboSpan" id="kobo.3307.2">Now, let’s leverage ChatGPT to explore the implementation of a signal receiver that automatically generates a related </span><code class="inlineCode"><span class="koboSpan" id="kobo.3308.1">Profile</span></code><span class="koboSpan" id="kobo.3309.1"> object whenever a </span><code class="inlineCode"><span class="koboSpan" id="kobo.3310.1">User</span></code><span class="koboSpan" id="kobo.3311.1"> object is created. </span><span class="koboSpan" id="kobo.3311.2">You can use the prompt provided at </span><a href="https://github.com/PacktPublishing/Django-5-by-example/blob/main/Chapter07/prompts/task.md"><span class="url"><span class="koboSpan" id="kobo.3312.1">https://github.com/PacktPublishing/Django-5-by-example/blob/main/Chapter07/prompts/task.md</span></span></a><span class="koboSpan" id="kobo.3313.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3314.1">After successfully implementing the signal receiver, you can remove the manual profile creation steps previously included in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3315.1">register</span></code><span class="koboSpan" id="kobo.3316.1"> view of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3317.1">account</span></code><span class="koboSpan" id="kobo.3318.1"> application and from the social authentication pipeline. </span><span class="koboSpan" id="kobo.3318.2">With the receiver function now attached to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3319.1">post_save</span></code><span class="koboSpan" id="kobo.3320.1"> signal of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3321.1">User</span></code><span class="koboSpan" id="kobo.3322.1"> model, profiles will be automatically created for new users.</span></p>
<div class="packt_tip">
<p class="normal"><span class="koboSpan" id="kobo.3323.1">If you’re having trouble understanding a particular concept or topic in the book, ask ChatGPT to provide additional examples or to explain the concept in a different way. </span><span class="koboSpan" id="kobo.3323.2">This personalized approach can reinforce your learning and ensure you grasp complex topics.</span></p>
</div>
<h1 class="heading-1" id="_idParaDest-224"><span class="koboSpan" id="kobo.3324.1">Additional resources</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3325.1">The following resources provide additional information related to the topics covered in this chapter:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.3326.1">Source code for this chapter: </span><a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter07"><span class="url"><span class="koboSpan" id="kobo.3327.1">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter07</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3328.1">Custom user models: </span><a href="https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#specifying-a-custom-user-model"><span class="url"><span class="koboSpan" id="kobo.3329.1">https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#specifying-a-custom-user-model</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3330.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3331.1">contenttypes</span></code><span class="koboSpan" id="kobo.3332.1"> framework: </span><a href="https://docs.djangoproject.com/en/5.0/ref/contrib/contenttypes/"><span class="url"><span class="koboSpan" id="kobo.3333.1">https://docs.djangoproject.com/en/5.0/ref/contrib/contenttypes/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3334.1">Built-in Django signals: </span><a href="https://docs.djangoproject.com/en/5.0/ref/signals/"><span class="url"><span class="koboSpan" id="kobo.3335.1">https://docs.djangoproject.com/en/5.0/ref/signals/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3336.1">Application configuration classes: </span><a href="https://docs.djangoproject.com/en/5.0/ref/applications/"><span class="url"><span class="koboSpan" id="kobo.3337.1">https://docs.djangoproject.com/en/5.0/ref/applications/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3338.1">Django Debug Toolbar documentation: </span><a href="https://django-debug-toolbar.readthedocs.io/"><span class="url"><span class="koboSpan" id="kobo.3339.1">https://django-debug-toolbar.readthedocs.io/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3340.1">Django Debug Toolbar third-party panels: </span><a href="https://django-debug-toolbar.readthedocs.io/en/latest/panels.html#third-party-panels"><span class="url"><span class="koboSpan" id="kobo.3341.1">https://django-debug-toolbar.readthedocs.io/en/latest/panels.html#third-party-panels</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3342.1">Redis in-memory data store: </span><a href="https://redis.io/"><span class="url"><span class="koboSpan" id="kobo.3343.1">https://redis.io/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3344.1">Official Redis Docker image: </span><a href="https://hub.docker.com/_/redis"><span class="url"><span class="koboSpan" id="kobo.3345.1">https://hub.docker.com/_/redis</span></span></a><span class="koboSpan" id="kobo.3346.1">.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3347.1">Redis download options: </span><a href="https://redis.io/download/"><span class="url"><span class="koboSpan" id="kobo.3348.1">https://redis.io/download/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3349.1">Redis commands: </span><a href="https://redis.io/commands/"><span class="url"><span class="koboSpan" id="kobo.3350.1">https://redis.io/commands/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3351.1">Redis data types: </span><a href="https://redis.io/docs/manual/data-types/"><span class="url"><span class="koboSpan" id="kobo.3352.1">https://redis.io/docs/manual/data-types/</span></span></a></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.3353.1">redis-py</span></code><span class="koboSpan" id="kobo.3354.1"> documentation: </span><a href="https://redis-py.readthedocs.io/"><span class="url"><span class="koboSpan" id="kobo.3355.1">https://redis-py.readthedocs.io/</span></span></a></li>
</ul>
</div>
</body></html>