<html><head></head><body>
<div><h1 class="chapterNumber">7</h1>
<h1 class="chapterTitle" id="_idParaDest-193">Tracking User Actions</h1>
<p class="normal">In the previous chapter, you built a JavaScript bookmarklet to share content from other websites on your platform. You also implemented asynchronous actions with JavaScript in your project and created an infinite scroll.</p>
<p class="normal">In this chapter, you will learn how to build a follow system and create a user activity stream. You will also discover how Django signals work and you will integrate Redis’s fast I/O storage into your project to store item views.</p>
<p class="normal">This chapter will cover the following points:</p>
<ul>
<li class="bulletList">Building a follow system</li>
<li class="bulletList">Creating many-to-many relationships with an intermediate model</li>
<li class="bulletList">Creating an activity stream application</li>
<li class="bulletList">Adding generic relations to models</li>
<li class="bulletList">Optimizing QuerySets for related objects</li>
<li class="bulletList">Using signals for denormalizing counts</li>
<li class="bulletList">Using Django Debug Toolbar to obtain relevant debug information</li>
<li class="bulletList">Counting image views with Redis</li>
<li class="bulletList">Creating a ranking of the most viewed images with Redis</li>
</ul>
<h1 class="heading-1" id="_idParaDest-194">Functional overview</h1>
<p class="normal"><em class="italic">Figure 7.1</em> shows a representation of the views, templates, and functionalities that will be built in this chapter:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_07_01.png"/></figure>
<p class="packt_figref">Figure 7.1: Diagram of functionalities built in Chapter 7</p>
<p class="normal">In this chapter, you will build the <code class="inlineCode">user_list</code> view to list all users and the <code class="inlineCode">user_detail</code> view to display a single user profile. You will implement a follow system with JavaScript, using the <code class="inlineCode">user_follow</code> view to store user follows. You will create a system to store user actions, and you will implement the actions for creating an account, following a user, creating an image, and liking an image. You will use this system to display an activity stream in the <code class="inlineCode">dashboard</code> view with the latest actions. You will also use Redis to store a <em class="italic">view</em> every time the <code class="inlineCode">image_detail</code> view is loaded and create the view <code class="inlineCode">image_ranking</code> to display a ranking of the most viewed images.</p>
<p class="normal">The source code for this chapter can be found at <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter07">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter07</a>.</p>
<p class="normal">All Python packages used in this chapter are included in the <code class="inlineCode">requirements.txt</code> file in the source code for the chapter. You can follow the instructions to install each Python package in the following sections, or you can install all requirements at once with the command <code class="inlineCode">python</code> <code class="inlineCode">-m</code> <code class="inlineCode">pip</code> <code class="inlineCode">install</code> <code class="inlineCode">-r</code> <code class="inlineCode">requirements.txt</code>.</p>
<h1 class="heading-1" id="_idParaDest-195">Building a follow system</h1>
<p class="normal">Let’s build a follow system in your <a id="_idIndexMarker624"/>project. This means that your users will be able to follow each other and track what other users share on the platform. The relationship between users is a <em class="italic">many-to-many</em> relationship; this means that a user can follow multiple users and they, in turn, can be followed by multiple users.</p>
<h2 class="heading-2" id="_idParaDest-196">Creating many-to-many relationships with an intermediate model</h2>
<p class="normal">In previous chapters, you created many-to-many relationships by adding the <code class="inlineCode">ManyToManyField</code> to one of the related<a id="_idIndexMarker625"/> models and letting Django create the database table for the relationship. This is suitable for most cases, but sometimes you may need to create an intermediate model for the<a id="_idIndexMarker626"/> relationship. Creating an intermediate model is necessary when you want to store additional information on the relationship, for example, the date when the relationship was created, or a field that describes the nature of the relationship.</p>
<p class="normal">Let’s create an intermediate model to build relationships between users. There are two reasons for using an intermediate model:</p>
<ul>
<li class="bulletList">You are using the <code class="inlineCode">User</code> model provided by Django and you want to avoid altering it</li>
<li class="bulletList">You want to store the time when the relationship was created</li>
</ul>
<p class="normal">Edit the <code class="inlineCode">models.py</code> file of the <code class="inlineCode">account</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">class Contact(models.Model):
    user_from = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        related_name='rel_from_set',
        on_delete=models.CASCADE
    )
    user_to = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        related_name='rel_to_set',
        on_delete=models.CASCADE
    )
    created = models.DateTimeField(auto_now_add=True)
    class Meta:
        indexes = [
            models.Index(fields=['-created']),
        ]
        ordering = ['-created']
    def __str__(self):
        return f'{self.user_from} follows {self.user_to}'
</code></pre>
<p class="normal">The preceding code shows the <code class="inlineCode">Contact</code> model that <a id="_idIndexMarker627"/>you will use for user relationships. It contains the following fields:</p>
<ul>
<li class="bulletList"><code class="inlineCode">user_from</code>: A <code class="inlineCode">ForeignKey</code> for<a id="_idIndexMarker628"/> the user who creates the relationship</li>
<li class="bulletList"><code class="inlineCode">user_to</code>: A <code class="inlineCode">ForeignKey</code> for the user being followed</li>
<li class="bulletList"><code class="inlineCode">created</code>: A <code class="inlineCode">DateTimeField</code> field with <code class="inlineCode">auto_now_add=True</code> to store the time when the relationship was created</li>
</ul>
<p class="normal">A database index is automatically created on the <code class="inlineCode">ForeignKey</code> fields. In the <code class="inlineCode">Meta</code> class of the model, we have defined a database index in descending order for the <code class="inlineCode">created</code> field. We have also added the <code class="inlineCode">ordering</code> attribute to tell Django that it should sort results by the <code class="inlineCode">created</code> field by default. We indicate descending order by using a hyphen before the field name, like <code class="inlineCode">-created</code>.</p>
<p class="normal"><em class="italic">Figure 7.2</em> shows the intermediate <code class="inlineCode">Contact</code> model and its corresponding database table:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_07_02.png"/></figure>
<p class="packt_figref">Figure 7.2: The intermediate Contact model and its database table</p>
<p class="normal">Using the ORM, you could <a id="_idIndexMarker629"/>create a <a id="_idIndexMarker630"/>relationship for a user, <code class="inlineCode">user1</code>, following another user, <code class="inlineCode">user2</code>, like this:</p>
<pre class="programlisting code"><code class="hljs-code">user1 = User.objects.get(id=1)
user2 = User.objects.get(id=2)
Contact.objects.create(user_from=user1, user_to=user2)
</code></pre>
<p class="normal">The related managers, <code class="inlineCode">rel_from_set</code> and <code class="inlineCode">rel_to_set</code>, will return a QuerySet for the <code class="inlineCode">Contact</code> model. In order to access the end side of the relationship from the <code class="inlineCode">User</code> model, it would be desirable for <code class="inlineCode">User</code> to contain a <code class="inlineCode">ManyToManyField</code>, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">following = models.ManyToManyField(
    'self',
    through=Contact,
    related_name='followers',
    symmetrical=False
)
</code></pre>
<p class="normal">In the preceding example, you tell Django to use your custom intermediate model for the relationship by adding <code class="inlineCode">through=Contact</code> to <code class="inlineCode">ManyToManyField</code>. This is a many-to-many relationship from the <code class="inlineCode">User</code> model to itself; you refer to <code class="inlineCode">'self'</code> in <code class="inlineCode">ManyToManyField</code> to create a relationship to the same model.</p>
<div><p class="normal">When you need additional fields in a many-to-many relationship, create a custom model with a <code class="inlineCode">ForeignKey</code> for each side of the relationship. You can manage the relationship using the intermediate model, or you can add a <code class="inlineCode">ManyToManyField</code> field in one of the related models and indicate to Django that your intermediate model should be used by including it in the <code class="inlineCode">through</code> parameter.</p>
</div>
<p class="normal">If the <code class="inlineCode">User</code> model was part<a id="_idIndexMarker631"/> of your application, you could add the previous field to the model. However, you can’t alter the <code class="inlineCode">User</code> class directly because it belongs to the <code class="inlineCode">django.contrib.auth</code> application. Let’s take<a id="_idIndexMarker632"/> a slightly different approach by adding this field dynamically to the <code class="inlineCode">User</code> model.</p>
<p class="normal">Edit the <code class="inlineCode">models.py</code> file of the <code class="inlineCode">account</code> application and add the following lines highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.contrib.auth </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> get_user_model</strong>
# ...
<strong class="hljs-comment-slc"># Add the following field to User dynamically</strong>
<strong class="hljs-slc">user_model = get_user_model()</strong>
<strong class="hljs-slc">user_model.add_to_class(</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'following'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">    models.ManyToManyField(</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'self'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        through=Contact,</strong>
<strong class="hljs-slc">        related_name=</strong><strong class="hljs-string-slc">'followers'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        symmetrical=</strong><strong class="hljs-literal-slc">False</strong>
<strong class="hljs-slc">    )</strong>
<strong class="hljs-slc">)</strong>
</code></pre>
<p class="normal">In the preceding code, you retrieve the user model with the generic function <code class="inlineCode">get_user_model()</code> provided by Django. You use the <code class="inlineCode">add_to_class()</code> method of Django models to monkey patch the <code class="inlineCode">User</code> model.</p>
<p class="normal">Be mindful that using <code class="inlineCode">add_to_class()</code> is not the recommended way of adding fields to models. However, you can take advantage of using it in this case to avoid creating a custom user model, keeping all the advantages of Django’s built-in <code class="inlineCode">User</code> model.</p>
<p class="normal">You also simplify the way that you retrieve related objects using the Django ORM with <code class="inlineCode">user.followers.all()</code> and <code class="inlineCode">user.following.all()</code>. You use the intermediate <code class="inlineCode">Contact</code> model and avoid complex queries that would involve additional database joins, as would have been the case had you defined the relationship in your custom <code class="inlineCode">Profile</code> model. The table for this many-to-many relationship will be created using the <code class="inlineCode">Contact</code> model. Thus, the <code class="inlineCode">ManyToManyField</code>, added dynamically, will not imply any database changes for the Django <code class="inlineCode">User</code> model.</p>
<p class="normal">Keep in mind that, in most <a id="_idIndexMarker633"/>cases, it is preferable to add fields to the <code class="inlineCode">Profile</code> model you created before, instead of monkey patching the <code class="inlineCode">User</code> model. Ideally, you shouldn’t alter the existing Django <code class="inlineCode">User</code> model. Django <a id="_idIndexMarker634"/>allows you to use custom user models. If you want to use a custom user model, take a look at the documentation at <a href="https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#specifying-a-custom-user-model">https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#specifying-a-custom-user-model</a>.</p>
<div><p class="normal">When you start a new project, it is highly recommended that you create a custom user model, even if the default <code class="inlineCode">User</code> model is sufficient for you. This is because you gain the option of customizing the model.</p>
</div>
<p class="normal">Note that the relationship includes <code class="inlineCode">symmetrical=False</code>. When you define a <code class="inlineCode">ManyToManyField</code> in the model creating a relationship with itself, Django forces the relationship to be symmetrical. In this case, you are setting <code class="inlineCode">symmetrical=False</code> to define a non-symmetrical relationship (if I follow you, it doesn’t mean that you automatically follow me).</p>
<div><p class="normal">When you use an intermediate model for many-to-many relationships, some of the related manager’s methods are disabled, such as <code class="inlineCode">add()</code>, <code class="inlineCode">create()</code>, or <code class="inlineCode">remove()</code>. You need to create or delete instances of the intermediate model instead.</p>
</div>
<p class="normal">Run the following command to generate the initial migrations for the <code class="inlineCode">account</code> application:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py makemigrations account
</code></pre>
<p class="normal">You will obtain an output like the following one:</p>
<pre class="programlisting con"><code class="hljs-con">Migrations for 'account':
  account/migrations/0002_contact.py
    - Create model Contact
</code></pre>
<p class="normal">Now, run the following command to sync the application with the database:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py migrate account
</code></pre>
<p class="normal">You should see an output that includes the following line:</p>
<pre class="programlisting con"><code class="hljs-con">Applying account.0002_contact... OK
</code></pre>
<p class="normal">The <code class="inlineCode">Contact</code> model is now <a id="_idIndexMarker635"/>synced to the database, and you are able to create relationships between users. However, your <a id="_idIndexMarker636"/>site doesn’t offer a way to browse users or see a particular user’s profile yet. Let’s build the list and detail views for the <code class="inlineCode">User</code> model.</p>
<h2 class="heading-2" id="_idParaDest-197">Creating list and detail views for user profiles</h2>
<p class="normal">Open the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">account</code> application<a id="_idIndexMarker637"/> and add the following <a id="_idIndexMarker638"/>code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django.contrib.auth import authenticate, <strong class="hljs-slc">get_user_model, </strong>login
from django.shortcuts import <strong class="hljs-slc">get_object_or_404, </strong>render
# ...
<strong class="hljs-slc">User = get_user_model()</strong>
<strong class="hljs-meta-slc">@login_required</strong>
<strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">user_list</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">request</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc">    users = User.objects.</strong><strong class="hljs-built_in-slc">filter</strong><strong class="hljs-slc">(is_active=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> render(</strong>
<strong class="hljs-keyword-slc"> </strong><strong class="hljs-slc">request,</strong>
<strong class="hljs-keyword-slc"> </strong><strong class="hljs-string-slc">'account/user/list.html'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-keyword-slc"> </strong><strong class="hljs-slc">{</strong><strong class="hljs-string-slc">'section'</strong><strong class="hljs-slc">: </strong><strong class="hljs-string-slc">'people'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'users'</strong><strong class="hljs-slc">: users}</strong>
<strong class="hljs-slc">    )</strong>
<strong class="hljs-meta-slc">@login_required</strong>
<strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">user_detail</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">request, username</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc">    user = get_object_or_404(User, username=username, is_active=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> render(</strong>
<strong class="hljs-slc">        request,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'account/user/detail.html'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        {</strong><strong class="hljs-string-slc">'section'</strong><strong class="hljs-slc">: </strong><strong class="hljs-string-slc">'people'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'user'</strong><strong class="hljs-slc">: user}</strong>
<strong class="hljs-slc">    )</strong>
</code></pre>
<p class="normal">These are simple list and detail views for <code class="inlineCode">User</code> objects. We retrieve the <code class="inlineCode">User</code> model dynamically using the <code class="inlineCode">get_user_model()</code> function. The <code class="inlineCode">user_list</code> view gets all active users. The Django <code class="inlineCode">User</code> model contains an <code class="inlineCode">is_active</code> flag to designate whether the user account is considered active. You filter the query by <code class="inlineCode">is_active=True</code> to return only active users. This view returns <a id="_idIndexMarker639"/>all results, but you can improve it by <a id="_idIndexMarker640"/>adding pagination in the same way as you did for the <code class="inlineCode">image_list</code> view.</p>
<p class="normal">The <code class="inlineCode">user_detail</code> view uses the <code class="inlineCode">get_object_or_404()</code> shortcut to retrieve the active user with the given username. The view returns an HTTP <code class="inlineCode">404</code> response if no active user with the given username is found.</p>
<p class="normal">Edit the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">account</code> application and add a URL pattern for each view, as follows. The new code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    # ...
    path('', include('django.contrib.auth.urls')),
    path('', views.dashboard, name='dashboard'),
    path('register/', views.register, name='register'),
    path('edit/', views.edit, name='edit'),
<strong class="hljs-slc">    path(</strong><strong class="hljs-string-slc">'users/'</strong><strong class="hljs-slc">, views.user_list, name=</strong><strong class="hljs-string-slc">'user_list'</strong><strong class="hljs-slc">),</strong>
<strong class="hljs-slc">    path(</strong><strong class="hljs-string-slc">'users/&lt;username&gt;/'</strong><strong class="hljs-slc">, views.user_detail, name=</strong><strong class="hljs-string-slc">'user_detail'</strong><strong class="hljs-slc">),</strong>
]
</code></pre>
<p class="normal">You will use the <code class="inlineCode">user_detail</code> URL pattern to generate the canonical URL for users. You have already defined a <code class="inlineCode">get_absolute_url()</code> method in a model to return the canonical URL for each object. Another way to specify the URL for a model is by adding the <code class="inlineCode">ABSOLUTE_URL_OVERRIDES</code> setting to your <a id="_idIndexMarker641"/>project.</p>
<div><p class="normal">By using the username instead of the user ID in the <code class="inlineCode">user_detail</code> URL pattern, you enhance both usability and security. Usernames, unlike sequential IDs, thwart enumeration attacks by obscuring your data structure. This makes it harder for attackers to predict URLs and formulate attack vectors.</p>
</div>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of your project and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.urls </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> reverse_lazy</strong>
# ...
<strong class="hljs-slc">ABSOLUTE_URL_OVERRIDES = {</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'auth.user'</strong><strong class="hljs-slc">: </strong><strong class="hljs-keyword-slc">lambda</strong><strong class="hljs-slc"> u: reverse_lazy(</strong><strong class="hljs-string-slc">'user_detail'</strong><strong class="hljs-slc">, args=[u.username])</strong>
<strong class="hljs-slc">}</strong>
</code></pre>
<p class="normal">Django adds a <code class="inlineCode">get_absolute_url()</code> method dynamically to any models that appear in the <code class="inlineCode">ABSOLUTE_URL_OVERRIDES</code> setting. This method returns the corresponding URL for the given model specified in the setting. In the <a id="_idIndexMarker642"/>previous code section, you generate the <code class="inlineCode">user_detail</code> URL for the given user for the <code class="inlineCode">auth.user</code> object. Now, you can use <code class="inlineCode">get_absolute_url()</code> on a <code class="inlineCode">User</code> instance to retrieve its corresponding URL.</p>
<p class="normal">Open the Python shell with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py shell
</code></pre>
<p class="normal">Then run the following code to test it:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; from django.contrib.auth.models import User
&gt;&gt;&gt; user = User.objects.latest('id')
&gt;&gt;&gt; str(user.get_absolute_url())
'/account/users/ellington/'
</code></pre>
<p class="normal">The returned URL follows the expected format, <code class="inlineCode">/account/users/&lt;username&gt;/</code>.</p>
<p class="normal">You will need to create templates <a id="_idIndexMarker643"/>for the views that you just built. Add the following directory and files to the <code class="inlineCode">templates/account/</code> directory of the <code class="inlineCode">account</code> application:</p>
<pre class="programlisting con"><code class="hljs-con">/user/
    detail.html
    list.html
</code></pre>
<p class="normal">Edit the <code class="inlineCode">account/user/list.html</code> template <a id="_idIndexMarker644"/>and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% load thumbnail %}
{% block title %}People{% endblock %}
{% block content %}
  &lt;h1&gt;People&lt;/h1&gt;
&lt;div id="people-list"&gt;
    {% for user in users %}
      &lt;div class="user"&gt;
&lt;a href="{{ user.get_absolute_url }}"&gt;
&lt;img src="img/{% thumbnail user.profile.photo 180x180 %}"&gt;
&lt;/a&gt;
&lt;div class="info"&gt;
&lt;a href="{{ user.get_absolute_url }}" class="title"&gt;
            {{ user.get_full_name }}
          &lt;/a&gt;
&lt;/div&gt;
&lt;/div&gt;
    {% endfor %}
  &lt;/div&gt;
{% endblock %}
</code></pre>
<p class="normal">The preceding template allows you to list all the active users on the site. You iterate over the given users and use the <code class="inlineCode">{% thumbnail %}</code> template tag from <code class="inlineCode">easy-thumbnails</code> to generate profile image thumbnails.</p>
<p class="normal">Note that the users need to have a profile image. To use a default image for users that don’t have a profile image, you can add an <code class="inlineCode">if</code>/<code class="inlineCode">else</code> statement to check whether the user has a profile photo, like <code class="inlineCode">{% if user.profile.photo %} {# photo thumbnail #} {% else %} {# default image #} {% endif %}</code>.</p>
<p class="normal">Open the <code class="inlineCode">base.html</code> template of your<a id="_idIndexMarker645"/> project and include the <code class="inlineCode">user_list</code> URL in the <code class="inlineCode">href</code> attribute of the following menu item. The new code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;ul class="menu"&gt;
  ...
  &lt;li {% if section == "people" %}class="selected"{% endif %}&gt;
&lt;a href="<strong class="hljs-string-slc">{% url "</strong><strong class="hljs-attr-slc">user_list</strong><strong class="hljs-string-slc">" %}"</strong>&gt;People&lt;/a&gt;
&lt;/li&gt;
&lt;/ul&gt;
</code></pre>
<p class="normal">Start the development server<a id="_idIndexMarker646"/> with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/account/users/</code> in your browser. You should see a list of users like the following one:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, website  Description automatically generated" src="img/B21088_07_03.png"/></figure>
<p class="packt_figref">Figure 7.3: The user list page with profile image thumbnails</p>
<p class="normal">Remember that if you have any<a id="_idIndexMarker647"/> difficulty generating thumbnails, you can add <code class="inlineCode">THUMBNAIL_DEBUG = True</code> to your <code class="inlineCode">settings.py</code> file in order to obtain debug information in the shell.</p>
<p class="normal">Edit the <code class="inlineCode">account/user/detail.html</code> template of the <code class="inlineCode">account</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% load thumbnail %}
{% block title %}{{ user.get_full_name }}{% endblock %}
{% block content %}
  &lt;h1&gt;{{ user.get_full_name }}&lt;/h1&gt;
&lt;div class="profile-info"&gt;
&lt;img src="img/{% thumbnail user.profile.photo 180x180 %}" class="user-detail"&gt;
&lt;/div&gt;
  {% with total_followers=user.followers.count %}
    &lt;span class="count"&gt;
&lt;span class="total"&gt;{{ total_followers }}&lt;/span&gt;
      follower{{ total_followers|pluralize }}
    &lt;/span&gt;
&lt;a href="#" data-id="{{ user.id }}" data-action="{% if request.user in user.followers.all %}un{% endif %}follow" class="follow button"&gt;
      {% if request.user not in user.followers.all %}
        Follow
      {% else %}
        Unfollow
      {% endif %}
    &lt;/a&gt;
&lt;div id="image-list" class="image-container"&gt;
      {% include "images/image/list_images.html" with images=user.images_created.all %}
    &lt;/div&gt;
  {% endwith %}
{% endblock %}
</code></pre>
<p class="normal">Make sure that no template tag is <a id="_idIndexMarker648"/>split into multiple lines; Django doesn’t support multiple-line tags.</p>
<p class="normal">In the <code class="inlineCode">detail</code> template, the user profile is displayed, and the <code class="inlineCode">{% thumbnail %}</code> template tag is used to show the profile<a id="_idIndexMarker649"/> image. The total number of followers is presented along with a link to follow or unfollow the user. This link will be used to follow/unfollow a particular user. The <code class="inlineCode">data-id</code> and <code class="inlineCode">data-action</code> attributes of the <code class="inlineCode">&lt;a&gt;</code> HTML element contain the user ID and the initial action to perform when the link element is clicked – <code class="inlineCode">follow</code> or <code class="inlineCode">unfollow</code>. The initial action (<em class="italic">follow</em> or <em class="italic">unfollow</em>) depends on whether the user requesting the page is already a follower of the user. The images bookmarked by the user are displayed by including the <code class="inlineCode">images/image/list_images.html</code> template.</p>
<p class="normal">Open your browser again and click on a user who has bookmarked some images. The user page will look as follows:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, website  Description automatically generated" src="img/B21088_07_04.png"/></figure>
<p class="packt_figref">Figure 7.4: The user detail page</p>
<div><p class="normal">The preceding<a id="_idIndexMarker650"/> image is of <em class="italic">Chick Corea</em> by ataelw (Creative <a id="_idIndexMarker651"/>Commons Attribution 2.0 Generic license: <a href="https://creativecommons.org/licenses/by/2.0/">https://creativecommons.org/licenses/by/2.0/</a>).</p>
</div>
<h2 class="heading-2" id="_idParaDest-198">Adding user follow/unfollow actions with JavaScript</h2>
<p class="normal">Let’s add functionality to follow/unfollow users. We will create a new view to follow/unfollow users<a id="_idIndexMarker652"/> and implement an asynchronous HTTP request with JavaScript for the follow/unfollow action.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">account</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django.http import HttpResponse<strong class="hljs-slc">, JsonResponse</strong>
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.views.decorators.http </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> require_POST</strong>
from .models import <strong class="hljs-slc">Contact, </strong>Profile
# ...
<strong class="hljs-meta-slc">@require_POST</strong>
<strong class="hljs-meta-slc">@login_required</strong>
<strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">user_follow</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">request</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc">    user_id = request.POST.get(</strong><strong class="hljs-string-slc">'id'</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    action = request.POST.get(</strong><strong class="hljs-string-slc">'action'</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> user_id </strong><strong class="hljs-keyword-slc">and</strong><strong class="hljs-slc"> action:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">try</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">            user = User.objects.get(</strong><strong class="hljs-built_in-slc">id</strong><strong class="hljs-slc">=user_id)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> action == </strong><strong class="hljs-string-slc">'follow'</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">                Contact.objects.get_or_create(</strong>
<strong class="hljs-slc">                    user_from=request.user,</strong>
<strong class="hljs-slc">                    user_to=user</strong>
<strong class="hljs-slc">                )</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">else</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">                Contact.objects.</strong><strong class="hljs-built_in-slc">filter</strong><strong class="hljs-slc">(</strong>
<strong class="hljs-slc">                    user_from=request.user,</strong>
<strong class="hljs-slc">                    user_to=user</strong>
<strong class="hljs-slc">                ).delete()</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> JsonResponse({</strong><strong class="hljs-string-slc">'status'</strong><strong class="hljs-slc">:</strong><strong class="hljs-string-slc">'ok'</strong><strong class="hljs-slc">})</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">except</strong><strong class="hljs-slc"> User.DoesNotExist:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> JsonResponse({</strong><strong class="hljs-string-slc">'status'</strong><strong class="hljs-slc">:</strong><strong class="hljs-string-slc">'error'</strong><strong class="hljs-slc">})</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> JsonResponse({</strong><strong class="hljs-string-slc">'status'</strong><strong class="hljs-slc">:</strong><strong class="hljs-string-slc">'error'</strong><strong class="hljs-slc">})</strong>
</code></pre>
<p class="normal">The <code class="inlineCode">user_follow</code> view is quite similar<a id="_idIndexMarker653"/> to the <code class="inlineCode">image_like</code> view that you created in <em class="italic">Chapter 6</em>, <em class="italic">Sharing Content on Your Website</em>. Since you are using a custom intermediate model for the user’s many-to-many relationship, the default <code class="inlineCode">add()</code> and <code class="inlineCode">remove()</code> methods of the automatic manager of <code class="inlineCode">ManyToManyField</code> are not available. Instead, the intermediate <code class="inlineCode">Contact</code> model is used to create or delete user relationships.</p>
<p class="normal">Edit the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">account</code> application and add the following URL pattern highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    path('', include('django.contrib.auth.urls')),
    path('', views.dashboard, name='dashboard'),
    path('register/', views.register, name='register'),
    path('edit/', views.edit, name='edit'),
    path('users/', views.user_list, name='user_list'),
    <strong class="hljs-slc">path(</strong><strong class="hljs-string-slc">'</strong><strong class="hljs-string-slc">users/follow/'</strong><strong class="hljs-slc">, views.user_follow, name=</strong><strong class="hljs-string-slc">'user_follow'</strong><strong class="hljs-slc">),</strong>
    path('users/&lt;username&gt;/', views.user_detail, name='user_detail'),
]
</code></pre>
<p class="normal">Ensure that you place the preceding<a id="_idIndexMarker654"/> pattern before the <code class="inlineCode">user_detail</code> URL pattern. Otherwise, any requests to <code class="inlineCode">/users/follow/</code> will match the regular expression of the <code class="inlineCode">user_detail</code> pattern and that view will be executed <a id="_idIndexMarker655"/>instead. Remember that in every HTTP request, Django checks the requested URL against each pattern in order of appearance and stops at the first match.</p>
<p class="normal">Edit the <code class="inlineCode">user/detail.html</code> template of the <code class="inlineCode">account</code> application and append the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% block domready %}
  const url = '{% url "user_follow" %}';
  var options = {
    method: 'POST',
    headers: {'X-CSRFToken': csrftoken},
    mode: 'same-origin'
  }
  document.querySelector('a.follow')
          .addEventListener('click', function(e){
    e.preventDefault();
    var followButton = this;
    // add request body
var formData = new FormData();
    formData.append('id', followButton.dataset.id);
    formData.append('action', followButton.dataset.action);
    options['body'] = formData;
    // send HTTP request
fetch(url, options)
    .then(response =&gt; response.json())
    .then(data =&gt; {
      if (data['status'] === 'ok')
      {
        var previousAction = followButton.dataset.action;
        // toggle button text and data-action
var action = previousAction === 'follow' ? 'unfollow' : 'follow';
        followButton.dataset.action = action;
        followButton.innerHTML = action;
        // update follower count
var followerCount = document.querySelector('span.count .total');
        var totalFollowers = parseInt(followerCount.innerHTML);
        followerCount.innerHTML = previousAction === 'follow' ? totalFollowers + 1 : totalFollowers - 1;
      }
    })
  });
{% endblock %}
</code></pre>
<p class="normal">The preceding template block <a id="_idIndexMarker656"/>contains the JavaScript code to perform the asynchronous HTTP request to follow or unfollow a particular user and also to toggle the follow/unfollow link. </p>
<p class="normal">The Fetch API is used to perform the AJAX request and set both the <code class="inlineCode">data-action</code> attribute and the<a id="_idIndexMarker657"/> text of the HTML <code class="inlineCode">&lt;a&gt;</code> element based on its previous value. When the action is completed, the total number of followers displayed on the page is updated as well.</p>
<p class="normal">Open the user detail page of an existing user and click on the <strong class="screenText">FOLLOW</strong> link to test the functionality you just built. You will see, on the left-hand side of the following image, that the followers count has increased:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_07_05.png"/></figure>
<p class="packt_figref">Figure 7.5: The followers count and follow/unfollow button</p>
<p class="normal">The follow system is now <a id="_idIndexMarker658"/>complete and users can follow each other. Next, we will build an activity stream creating relevant content for each user that is based on the people they follow.</p>
<h1 class="heading-1" id="_idParaDest-199">Creating an activity stream application</h1>
<p class="normal">Many social websites display an<a id="_idIndexMarker659"/> activity stream to their users so that they can track what other users do on the platform. An activity stream is a list of recent activities performed by a user or a group of users. For example, Facebook’s News Feed is an activity stream. Sample actions can be <em class="italic">user X bookmarked image Y </em>or<em class="italic"> user X is now following user Y</em>.</p>
<p class="normal">You are going to build an activity stream application so that every user can see the recent interactions of the users they follow. To do so, you will need a model to save the actions performed by users on the website and a simple way to add actions to the feed.</p>
<p class="normal">Create a new application named <code class="inlineCode">actions</code> inside your project with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py startapp actions
</code></pre>
<p class="normal">Add the new application to <code class="inlineCode">INSTALLED_APPS</code> in the <code class="inlineCode">settings.py</code> file of your project to activate the application in your project. The new line is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">INSTALLED_APPS = [
    # ...
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'actions.apps.ActionsConfig'</strong><strong class="hljs-slc">,</strong>
]
</code></pre>
<p class="normal">Edit the <code class="inlineCode">models.py</code> file of the <code class="inlineCode">actions</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.conf </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> settings</strong>
from django.db import models
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Action</strong><strong class="hljs-slc">(models.Model):</strong>
<strong class="hljs-slc">    user = models.ForeignKey(</strong>
<strong class="hljs-slc">        settings.AUTH_USER_MODEL,</strong>
<strong class="hljs-slc">        related_name=</strong><strong class="hljs-string-slc">'actions'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        on_delete=models.CASCADE</strong>
<strong class="hljs-slc">    )</strong>
<strong class="hljs-slc">    verb = models.CharField(max_length=</strong><strong class="hljs-number-slc">255</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    created = models.DateTimeField(auto_now_add=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Meta</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">        indexes = [</strong>
<strong class="hljs-slc">            models.Index(fields=[</strong><strong class="hljs-string-slc">'-created'</strong><strong class="hljs-slc">]),</strong>
<strong class="hljs-slc">        ]</strong>
<strong class="hljs-slc">        ordering = [</strong><strong class="hljs-string-slc">'-created'</strong><strong class="hljs-slc">]</strong>
</code></pre>
<p class="normal">The preceding code shows the <code class="inlineCode">Action</code> model that will be used to store user activities. The fields of this model are as follows:</p>
<ul>
<li class="bulletList"><code class="inlineCode">user</code>: The user who performed the action; this is a <code class="inlineCode">ForeignKey</code> to the <code class="inlineCode">AUTH_USER_MODEL</code>, by default, the Django <code class="inlineCode">User</code> model.</li>
<li class="bulletList"><code class="inlineCode">verb</code>: The verb describing the action that the user has performed.</li>
<li class="bulletList"><code class="inlineCode">created</code>: The date and time when this action was created. We use <code class="inlineCode">auto_now_add=True</code> to automatically set this to the current datetime when the object is saved for the first time in the database.</li>
</ul>
<p class="normal">In the <code class="inlineCode">Meta</code> class of the model, we have defined a database index in descending order for the <code class="inlineCode">created</code> field. We have<a id="_idIndexMarker660"/> also added the <code class="inlineCode">ordering</code> attribute to tell Django that it should sort results by the <code class="inlineCode">created</code> field in descending order by default.</p>
<p class="normal">With this basic model, you can only store actions such as <em class="italic">user X did something</em>. You need an extra <code class="inlineCode">ForeignKey</code> field to save actions that involve a <code class="inlineCode">target</code> object, such as <em class="italic">user X bookmarked image Y </em>or<em class="italic"> user X is now following user Y</em>. As you already know, a normal <code class="inlineCode">ForeignKey</code> can point to only one model. Instead, you will need a way for the action’s <code class="inlineCode">target</code> object to be an instance of an existing model. This is what the Django <code class="inlineCode">contenttypes</code> framework will help you to do.</p>
<h2 class="heading-2" id="_idParaDest-200">Using the contenttypes framework</h2>
<p class="normal">Django includes a <code class="inlineCode">contenttypes</code> framework located at <code class="inlineCode">django.contrib.contenttypes</code>. This application can track all models<a id="_idIndexMarker661"/> installed in your project and provides a generic interface to interact with your models.</p>
<p class="normal">The <code class="inlineCode">django.contrib.contenttypes</code> application is included in the <code class="inlineCode">INSTALLED_APPS</code> setting by default when you create a new project using the <code class="inlineCode">startproject</code> command. It is used by other <code class="inlineCode">contrib</code> packages, such as the authentication framework and the administration application.</p>
<p class="normal">The <code class="inlineCode">contenttypes</code> application contains a <code class="inlineCode">ContentType</code> model. Instances of this model represent the actual models of your application, and new instances of <code class="inlineCode">ContentType</code> are automatically created when new models are installed in your project. The <code class="inlineCode">ContentType</code> model has the following fields:</p>
<ul>
<li class="bulletList"><code class="inlineCode">app_label</code>: This indicates the name of the application that the model belongs to. This is automatically taken from the <code class="inlineCode">app_label</code> attribute of the model <code class="inlineCode">Meta</code> options. For example, your <code class="inlineCode">Image</code> model belongs to the <code class="inlineCode">images</code> application.</li>
<li class="bulletList"><code class="inlineCode">model</code>: The name of the model class.</li>
<li class="bulletList"><code class="inlineCode">name</code>: This is a property that indicates the human-readable name of the model, automatically <a id="_idIndexMarker662"/>generated from the <code class="inlineCode">verbose_name</code> attribute of the model <code class="inlineCode">Meta</code> options.</li>
</ul>
<p class="normal">Let’s take a look at how you can interact with <code class="inlineCode">ContentType</code> objects. Open the shell using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py shell
</code></pre>
<p class="normal">You can obtain the <code class="inlineCode">ContentType</code> object corresponding to a specific model by performing a query with the <code class="inlineCode">app_label</code> and <code class="inlineCode">model</code> attributes, as follows:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; from django.contrib.contenttypes.models import ContentType
&gt;&gt;&gt; image_type = ContentType.objects.get(app_label='images', model='image')
&gt;&gt;&gt; image_type
&lt;ContentType: images | image&gt;
</code></pre>
<p class="normal">You can also retrieve the model class from a <code class="inlineCode">ContentType</code> object by calling its <code class="inlineCode">model_class()</code> method:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; image_type.model_class()
&lt;class 'images.models.Image'&gt;
</code></pre>
<p class="normal">It’s also common to obtain the <code class="inlineCode">ContentType</code> object for a particular model class, as follows:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; from images.models import Image
&gt;&gt;&gt; ContentType.objects.get_for_model(Image)
&lt;ContentType: images | image&gt;
</code></pre>
<p class="normal">These are just some examples of using <code class="inlineCode">contenttypes</code>. Django offers more ways to work with them. You can find the official <a id="_idIndexMarker663"/>documentation for the <code class="inlineCode">contenttypes</code> framework at <a href="https://docs.djangoproject.com/en/5.0/ref/contrib/contenttypes/">https://docs.djangoproject.com/en/5.0/ref/contrib/contenttypes/</a>.</p>
<h2 class="heading-2" id="_idParaDest-201">Adding generic relations to your models</h2>
<p class="normal">In generic relations, <code class="inlineCode">ContentType</code> objects play the role of pointing to the model used for the relationship. You will need<a id="_idIndexMarker664"/> three fields to set up a generic relation in a model:</p>
<ul>
<li class="bulletList">A <code class="inlineCode">ForeignKey</code> field to <code class="inlineCode">ContentType</code>: This will tell you what the model for the relationship is</li>
<li class="bulletList">A field to store the primary key of the related object: This will usually be a <code class="inlineCode">PositiveIntegerField</code> to match Django’s automatic primary key fields</li>
<li class="bulletList">A field to define and manage the generic relation using the two previous fields: The <code class="inlineCode">contenttypes</code> framework offers a <code class="inlineCode">GenericForeignKey</code> field for this purpose</li>
</ul>
<p class="normal">Edit the <code class="inlineCode">models.py</code> file of the <code class="inlineCode">actions</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django.conf import settings
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.contrib.contenttypes.fields </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> GenericForeignKey</strong>
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.contrib.contenttypes.models </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> ContentType</strong>
from django.db import models
class Action(models.Model):
    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        related_name='actions',
        on_delete=models.CASCADE
    )
    verb = models.CharField(max_length=255)
    created = models.DateTimeField(auto_now_add=True)
<strong class="hljs-slc">    target_ct = models.ForeignKey(</strong>
<strong class="hljs-slc">        ContentType,</strong>
<strong class="hljs-slc">        blank=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        null=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        related_name=</strong><strong class="hljs-string-slc">'target_obj'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        on_delete=models.CASCADE</strong>
<strong class="hljs-slc">    )</strong>
<strong class="hljs-slc">    target_id = models.PositiveIntegerField(null=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">, blank=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    target = GenericForeignKey(</strong><strong class="hljs-string-slc">'target_ct'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'target_id'</strong><strong class="hljs-slc">)</strong>
class Meta:
        indexes = [
            models.Index(fields=['-created']),
<strong class="hljs-slc">            models.Index(fields=[</strong><strong class="hljs-string-slc">'target_ct'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'target_id'</strong><strong class="hljs-slc">]),</strong>
        ]
        ordering = ['-created']
</code></pre>
<p class="normal">We have added the following fields to the <code class="inlineCode">Action</code> model:</p>
<ul>
<li class="bulletList"><code class="inlineCode">target_ct</code>: A <code class="inlineCode">ForeignKey</code> field that points to the <code class="inlineCode">ContentType</code> model</li>
<li class="bulletList"><code class="inlineCode">target_id</code>: A <code class="inlineCode">PositiveIntegerField</code> for storing the primary key of the related object</li>
<li class="bulletList"><code class="inlineCode">target</code>: A <code class="inlineCode">GenericForeignKey</code> field to the related object based on the combination of the two<a id="_idIndexMarker665"/> previous fields</li>
</ul>
<p class="normal">We have also added a multiple-field index including the <code class="inlineCode">target_ct</code> and <code class="inlineCode">target_id</code> fields.</p>
<p class="normal">Django does not create <code class="inlineCode">GenericForeignKey</code> fields in the database. The only fields that are mapped to database fields are <code class="inlineCode">target_ct</code> and <code class="inlineCode">target_id</code>. Both fields have <code class="inlineCode">blank=True</code> and <code class="inlineCode">null=True</code> attributes so that a <code class="inlineCode">target</code> object is not required when saving <code class="inlineCode">Action</code> objects.</p>
<div><p class="normal">You can make your applications more flexible by using generic relations instead of foreign keys. Generic relations allow you to associate models in a non-exclusive manner, enabling a single model to relate to multiple other models.</p>
</div>
<p class="normal"><em class="italic">Figure 7.6</em> shows the <code class="inlineCode">Action</code> model, including the relationship with the <code class="inlineCode">ContentType</code> model of the <code class="inlineCode">contenttypes</code> Django contrib package:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_07_06.png"/></figure>
<p class="packt_figref">Figure 7.6: The Action model and the ContentType model</p>
<p class="normal">Run the following command to<a id="_idIndexMarker666"/> create initial migrations for this application:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py makemigrations actions
</code></pre>
<p class="normal">You should see the following output:</p>
<pre class="programlisting con"><code class="hljs-con">Migrations for 'actions':
  actions/migrations/0001_initial.py
    - Create model Action
    - Create index actions_act_created_64f10d_idx on field(s) -created of model action
    - Create index actions_act_target__f20513_idx on field(s) target_ct, target_id of model action
</code></pre>
<p class="normal">Then, run the next command to sync the application with the database:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py migrate
</code></pre>
<p class="normal">The output of the command should indicate that the new migrations have been applied, as follows:</p>
<pre class="programlisting con"><code class="hljs-con">Applying actions.0001_initial... OK
</code></pre>
<p class="normal">Let’s add the <code class="inlineCode">Action</code> model to the administration site. Edit the <code class="inlineCode">admin.py</code> file of the <code class="inlineCode">actions</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.contrib import admin
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> .models </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> Action</strong>
<strong class="hljs-meta-slc">@admin.register(</strong><strong class="hljs-params-slc">Action</strong><strong class="hljs-meta-slc">)</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">ActionAdmin</strong><strong class="hljs-slc">(admin.ModelAdmin):</strong>
<strong class="hljs-slc">    list_display = [</strong><strong class="hljs-string-slc">'user'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'verb'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'target'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'created'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">    list_filter = [</strong><strong class="hljs-string-slc">'created'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">    search_fields = [</strong><strong class="hljs-string-slc">'verb'</strong><strong class="hljs-slc">]</strong>
</code></pre>
<p class="normal">You just registered the <code class="inlineCode">Action</code> model on the administration site.</p>
<p class="normal">Start the development server with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/admin/actions/action/add/</code> in your browser. You should see the page for creating<a id="_idIndexMarker667"/> a new <code class="inlineCode">Action</code> object, as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_07_07.png"/></figure>
<p class="packt_figref">Figure 7.7: The Add action page on the Django administration site</p>
<p class="normal">As you will notice in the preceding screenshot, only the <code class="inlineCode">target_ct</code> and <code class="inlineCode">target_id</code> fields that are mapped to actual database fields are shown. The <code class="inlineCode">GenericForeignKey</code> field does not appear in the form. The <code class="inlineCode">target_ct</code> field allows you to select any of the registered models of your Django project. You can restrict the content types to choose from a limited set of models using the <code class="inlineCode">limit_choices_to</code> attribute in the <code class="inlineCode">target_ct</code> field; the <code class="inlineCode">limit_choices_to</code> attribute allows you to restrict the content of <code class="inlineCode">ForeignKey</code> fields to a specific set of values.</p>
<p class="normal">Create a new file inside the <code class="inlineCode">actions</code> application directory and name it <code class="inlineCode">utils.py</code>. You need to define a shortcut <a id="_idIndexMarker668"/>function that will allow you to create new <code class="inlineCode">Action</code> objects in a simple way. Edit the new <code class="inlineCode">utils.py</code> file and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.contrib.contenttypes.models import ContentType
from .models import Action
def create_action(user, verb, target=None):
    action = Action(user=user, verb=verb, target=target)
    action.save()
</code></pre>
<p class="normal">The <code class="inlineCode">create_action()</code> function allows you to create actions that optionally include a <code class="inlineCode">target</code> object. You can use this function anywhere in your code as a shortcut to add new actions to the activity stream.</p>
<h2 class="heading-2" id="_idParaDest-202">Avoiding duplicate actions in the activity stream</h2>
<p class="normal">Sometimes, your users might click several times on the <strong class="screenText">Like</strong> or <strong class="screenText">Unlike</strong> button or perform the same action multiple times in a <a id="_idIndexMarker669"/>short period of time. This will easily lead to storing and displaying duplicate actions. To avoid this, let’s improve the <code class="inlineCode">create_action()</code> function to skip obvious duplicated actions.</p>
<p class="normal">Edit the <code class="inlineCode">utils.py</code> file of the <code class="inlineCode">actions</code> application, as follows:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> datetime</strong>
from django.contrib.contenttypes.models import ContentType
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.utils </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> timezone</strong>
from .models import Action
def create_action(user, verb, target=None):
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># check for any similar action made in the last minute</strong>
<strong class="hljs-slc">    now = timezone.now()</strong>
<strong class="hljs-slc">    last_minute = now - datetime.timedelta(seconds=</strong><strong class="hljs-number-slc">60</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    similar_actions = Action.objects.</strong><strong class="hljs-built_in-slc">filter</strong><strong class="hljs-slc">(</strong>
<strong class="hljs-slc">        user_id=user.</strong><strong class="hljs-built_in-slc">id</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        verb= verb,</strong>
<strong class="hljs-slc">        created__gte=last_minute</strong>
<strong class="hljs-slc">    )</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> target:</strong>
<strong class="hljs-slc">        target_ct = ContentType.objects.get_for_model(target)</strong>
<strong class="hljs-slc">        similar_actions = similar_actions.</strong><strong class="hljs-built_in-slc">filter</strong><strong class="hljs-slc">(</strong>
<strong class="hljs-slc">            target_ct=target_ct,</strong>
<strong class="hljs-slc">            target_id=target.</strong><strong class="hljs-built_in-slc">id</strong>
<strong class="hljs-built_in-slc"> </strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">not</strong><strong class="hljs-slc"> similar_actions:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># no existing actions found</strong>
        action = Action(user=user, verb=verb, target=target)
        action.save()
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> </strong><strong class="hljs-literal-slc">True</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> </strong><strong class="hljs-literal-slc">False</strong>
</code></pre>
<p class="normal">You have changed the <code class="inlineCode">create_action()</code> function to avoid saving duplicate actions and return a Boolean to tell you whether the action was saved. This is how you avoid duplicates:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">First, you get the current time using the <code class="inlineCode">timezone.now()</code> method provided by Django. This <a id="_idIndexMarker670"/>method does the same as <code class="inlineCode">datetime.datetime.now()</code> but returns a timezone-aware object. Django provides a setting called <code class="inlineCode">USE_TZ</code> to enable or disable timezone support. The default <code class="inlineCode">settings.py</code> file created using the <code class="inlineCode">startproject</code> command includes <code class="inlineCode">USE_TZ=True</code>.</li>
<li class="numberedList">You use the <code class="inlineCode">last_minute</code> variable to store the datetime from one minute ago and retrieve any identical actions performed by the user since then.</li>
<li class="numberedList">You create an <code class="inlineCode">Action</code> object if no identical action already exists in the last minute. You return <code class="inlineCode">True</code> if an <code class="inlineCode">Action</code> object was created or <code class="inlineCode">False</code> otherwise.</li>
</ol>
<h2 class="heading-2" id="_idParaDest-203">Adding user actions to the activity stream</h2>
<p class="normal">It’s time to add some actions to <a id="_idIndexMarker671"/>your views to build the activity stream for your users. You will store an action for each of the following interactions:</p>
<ul>
<li class="bulletList">A user bookmarks an image</li>
<li class="bulletList">A user likes an image</li>
<li class="bulletList">A user creates an account</li>
<li class="bulletList">A user starts following another user</li>
</ul>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">images</code> application and add the following import:</p>
<pre class="programlisting code"><code class="hljs-code">from actions.utils import create_action
</code></pre>
<p class="normal">In the <code class="inlineCode">image_create</code> view, add <code class="inlineCode">create_action()</code> after saving the image, as follows. The new line is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">@login_required
def image_create(request):
    if request.method == 'POST':
        # form is sent
        form = ImageCreateForm(data=request.POST)
        if form.is_valid():
            # form data is valid
            cd = form.cleaned_data
            new_image = form.save(commit=False)
            # assign current user to the item
            new_image.user = request.user
            new_image.save()
<strong class="hljs-slc">            create_action(request.user, </strong><strong class="hljs-string-slc">'bookmarked image'</strong><strong class="hljs-slc">, new_image)</strong>
            messages.success(request, 'Image added successfully')
            # redirect to new created image detail view
return redirect(new_image.get_absolute_url())
    else:
        # build form with data provided by the bookmarklet via GET
        form = ImageCreateForm(data=request.GET)
    return render(
 request,
 'images/image/create.html',
 {'section': 'images', 'form': form}
    )
</code></pre>
<p class="normal">In the <code class="inlineCode">image_like</code> view, add <code class="inlineCode">create_action()</code> after adding the user to the <code class="inlineCode">users_like</code> relationship, as follows. The new line is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">@login_required
@require_POST
def image_like(request):
    image_id = request.POST.get('id')
    action = request.POST.get('action')
    if image_id and action:
        try:
            image = Image.objects.get(id=image_id)
            if action == 'like':
                image.users_like.add(request.user)
<strong class="hljs-slc">                create_action(request.user, </strong><strong class="hljs-string-slc">'likes'</strong><strong class="hljs-slc">, image)</strong>
else:
                image.users_like.remove(request.user)
            return JsonResponse({'status':'ok'})
        except Image.DoesNotExist:
            pass
return JsonResponse({'status':'error'})
</code></pre>
<p class="normal">Now, edit the <code class="inlineCode">views.py</code> file <a id="_idIndexMarker672"/>of the <code class="inlineCode">account</code> application and add the following import:</p>
<pre class="programlisting code"><code class="hljs-code">from actions.utils import create_action
</code></pre>
<p class="normal">In the <code class="inlineCode">register</code> view, add <code class="inlineCode">create_action()</code> after creating the <code class="inlineCode">Profile</code> object, as follows. The new line is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">def register(request):
    if request.method == 'POST':
        user_form = UserRegistrationForm(request.POST)
        if user_form.is_valid():
            # Create a new user object but avoid saving it yet
            new_user = user_form.save(commit=False)
            # Set the chosen password
            new_user.set_password(
                user_form.cleaned_data['password']
            )
            # Save the User object
            new_user.save()
            # Create the user profile
            Profile.objects.create(user=new_user)
<strong class="hljs-slc">            create_action(new_user, </strong><strong class="hljs-string-slc">'has created an account'</strong><strong class="hljs-slc">)</strong>
return render(
 request,
 'account/register_done.html',
 {'new_user': new_user}
 )
    else:
        user_form = UserRegistrationForm()
    return render(
 request,
 'account/register.html',
 {'user_form': user_form}
 )
</code></pre>
<p class="normal">In the <code class="inlineCode">user_follow</code> view, add <code class="inlineCode">create_action()</code>, as follows. The<a id="_idIndexMarker673"/> new line is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">@require_POST
@login_required
def user_follow(request):
    user_id = request.POST.get('id')
    action = request.POST.get('action')
    if user_id and action:
        try:
            user = User.objects.get(id=user_id)
            if action == 'follow':
                Contact.objects.get_or_create(
                    user_from=request.user,
                    user_to=user
                )
<strong class="hljs-slc">                create_action(request.user, </strong><strong class="hljs-string-slc">'</strong><strong class="hljs-string-slc">is following'</strong><strong class="hljs-slc">, user)</strong>
else:
                Contact.objects.filter(
                    user_from=request.user,
                    user_to=user
                ).delete()
            return JsonResponse({'status':'ok'})
        except User.DoesNotExist:
            return JsonResponse({'status':'error'})
    return JsonResponse({'status':'error'})
</code></pre>
<p class="normal">As you can see in the preceding code, thanks to the <code class="inlineCode">Action</code> model and the helper function, it’s very easy to save<a id="_idIndexMarker674"/> new actions to the activity stream.</p>
<h2 class="heading-2" id="_idParaDest-204">Displaying the activity stream</h2>
<p class="normal">Finally, you need a way to display the<a id="_idIndexMarker675"/> activity stream for each user. You will include the activity stream on the user’s dashboard. Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">account</code> application. Import the <code class="inlineCode">Action</code> model and modify the <code class="inlineCode">dashboard</code> view, as follows. The new code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> actions.models </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> Action</strong>
# ...
@login_required
def dashboard(request):
    # Display all actions by default
<strong class="hljs-slc">    actions = Action.objects.exclude(user=request.user)</strong>
<strong class="hljs-slc">    following_ids = request.user.following.values_list(</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'id'</strong><strong class="hljs-slc">, flat=</strong><strong class="hljs-literal-slc">True</strong>
<strong class="hljs-literal-slc"> </strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> following_ids:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># If user is following others, retrieve only their actions</strong>
<strong class="hljs-slc">        actions = actions.</strong><strong class="hljs-built_in-slc">filter</strong><strong class="hljs-slc">(user_id__in=following_ids)</strong>
<strong class="hljs-slc">    actions = actions[:</strong><strong class="hljs-number-slc">10</strong><strong class="hljs-slc">]</strong>
return render(
 request,
 'account/dashboard.html',
 {'section': 'dashboard'<strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'actions'</strong><strong class="hljs-slc">: actions}</strong>
    )
</code></pre>
<p class="normal">In the preceding view, you retrieve all actions from the database, excluding the ones performed by the current user. By default, you retrieve the latest actions performed by all users on the platform. </p>
<p class="normal">If the user is following other users, you restrict the query to retrieve only the actions performed by the users they follow. Finally, you limit the result to the first 10 actions returned. You don’t use <code class="inlineCode">order_by()</code> in the QuerySet because you rely on the default ordering that you provided in the <code class="inlineCode">Meta</code> options of the <code class="inlineCode">Action</code> model. Recent actions will come first since you set <code class="inlineCode">ordering = ['-created']</code> in the <code class="inlineCode">Action</code> model.</p>
<h2 class="heading-2" id="_idParaDest-205">Optimizing QuerySets that involve related objects</h2>
<p class="normal">Every time you retrieve an <code class="inlineCode">Action</code> object, you will usually access its related <code class="inlineCode">User</code> object and the user’s related <code class="inlineCode">Profile</code> object. The<a id="_idIndexMarker676"/> Django ORM offers a simple way to retrieve related objects at the same time, thereby avoiding additional queries to the database.</p>
<h3 class="heading-3" id="_idParaDest-206">Using select_related()</h3>
<p class="normal">Django offers a QuerySet method called <code class="inlineCode">select_related()</code> that allows you to retrieve related objects for one-to-many relationships. This translates to a single, more complex QuerySet, but you avoid additional queries<a id="_idIndexMarker677"/> when accessing the related objects. </p>
<p class="normal">The <code class="inlineCode">select_related</code> method is for <code class="inlineCode">ForeignKey</code> and <code class="inlineCode">OneToOne</code> fields. It works by performing a SQL <code class="inlineCode">JOIN</code> and including the fields of the related object in the <code class="inlineCode">SELECT</code> statement.</p>
<p class="normal">To take advantage of <code class="inlineCode">select_related()</code>, edit the following line of the preceding code in the <code class="inlineCode">views.py</code> file of the account application to add <code class="inlineCode">select_related</code>, including the fields that you will use, as follows. Edit the <code class="inlineCode">views.py</code> file of the account application. The new code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">@login_required
def dashboard(request):
    # Display all actions by default
    actions = Action.objects.exclude(user=request.user)
    following_ids = request.user.following.values_list(
        'id', flat=True
 )
    if following_ids:
        # If user is following others, retrieve only their actions
        actions = actions.filter(user_id__in=following_ids)
    actions = actions<strong class="hljs-slc">.select_related(</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'user'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'user__profile'</strong>
<strong class="hljs-string-slc"> </strong><strong class="hljs-slc">)</strong>[:10]
    return render(
 request,
 'account/dashboard.html',
 {'section': 'dashboard', 'actions': actions}
    )
</code></pre>
<p class="normal">You use <code class="inlineCode">user__profile</code> to join the <code class="inlineCode">Profile</code> table in a single SQL query. If you call <code class="inlineCode">select_related()</code> without passing <a id="_idIndexMarker678"/>any arguments to it, it will retrieve objects from all <code class="inlineCode">ForeignKey</code> relationships. Always limit <code class="inlineCode">select_related()</code> to the relationships that will be accessed afterward.</p>
<div><p class="normal">Using <code class="inlineCode">select_related()</code> carefully can vastly improve execution time.</p>
</div>
<h3 class="heading-3" id="_idParaDest-207">Using prefetch_related()</h3>
<p class="normal"><code class="inlineCode">select_related()</code> will help you boost the performance for retrieving related objects in one-to-many relationships. However, <code class="inlineCode">select_related()</code> doesn’t work for many-to-many or many-to-one relationships (<code class="inlineCode">ManyToMany</code> or reverse <code class="inlineCode">ForeignKey</code> fields). Django offers a different QuerySet <a id="_idIndexMarker679"/>method called <code class="inlineCode">prefetch_related</code> that works for many-to-many and many-to-one relationships in addition to the relationships supported by <code class="inlineCode">select_related()</code>. The <code class="inlineCode">prefetch_related()</code> method performs a separate lookup for each relationship and joins the results using Python. This method also supports the prefetching of <code class="inlineCode">GenericRelation</code> and <code class="inlineCode">GenericForeignKey</code>.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">account</code> application and complete your query by adding <code class="inlineCode">prefetch_related()</code> to it for the target <code class="inlineCode">GenericForeignKey</code> field, as follows. The new code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">@login_required
def dashboard(request):
    # Display all actions by default
    actions = Action.objects.exclude(user=request.user)
    following_ids = request.user.following.values_list(
        'id', flat=True
 )
    if following_ids:
        # If user is following others, retrieve only their actions
        actions = actions.filter(user_id__in=following_ids)
    actions = actions.select_related(
        'user', 'user__profile'
 )<strong class="hljs-slc"> .prefetch_related(</strong><strong class="hljs-string-slc">'target'</strong><strong class="hljs-slc">)</strong>[:10]
    return render(
 request,
 'account/dashboard.html',
 {'section': 'dashboard', 'actions': actions}
    )
</code></pre>
<p class="normal">This query is now optimized <a id="_idIndexMarker680"/>for retrieving the user actions, including related objects.</p>
<h2 class="heading-2" id="_idParaDest-208">Creating templates for actions</h2>
<p class="normal">Let’s now create the template<a id="_idIndexMarker681"/> to display a particular <code class="inlineCode">Action</code> object. Create a new directory inside the <code class="inlineCode">actions</code> application directory and name it <code class="inlineCode">templates</code>. Add the following file structure to it:</p>
<pre class="programlisting con"><code class="hljs-con">actions/
    action/
        detail.html
</code></pre>
<p class="normal">Edit the <code class="inlineCode">actions/action/detail.html</code> template file and add the following lines to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% load thumbnail %}
{% with user=action.user profile=action.user.profile %}
&lt;div class="action"&gt;
&lt;div class="images"&gt;
    {% if profile.photo %}
      {% thumbnail user.profile.photo "80x80" crop="100%" as im %}
      &lt;a href="{{ user.get_absolute_url }}"&gt;
&lt;img src="img/{{ im.url }}" alt="{{ user.get_full_name }}"
 class="item-img"&gt;
&lt;/a&gt;
    {% endif %}
    {% if action.target %}
      {% with target=action.target %}
        {% if target.image %}
          {% thumbnail target.image "80x80" crop="100%" as im %}
          &lt;a href="{{ target.get_absolute_url }}"&gt;
&lt;img src="img/{{ im.url }}" class="item-img"&gt;
&lt;/a&gt;
        {% endif %}
      {% endwith %}
    {% endif %}
  &lt;/div&gt;
&lt;div class="info"&gt;
&lt;p&gt;
&lt;span class="date"&gt;{{ action.created|timesince }} ago&lt;/span&gt;
&lt;br /&gt;
&lt;a href="{{ user.get_absolute_url }}"&gt;
        {{ user.first_name }}
      &lt;/a&gt;
      {{ action.verb }}
      {% if action.target %}
        {% with target=action.target %}
          &lt;a href="{{ target.get_absolute_url }}"&gt;{{ target }}&lt;/a&gt;
        {% endwith %}
      {% endif %}
    &lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
{% endwith %}
</code></pre>
<p class="normal">This is the template used to<a id="_idIndexMarker682"/> display an <code class="inlineCode">Action</code> object. First, you use the <code class="inlineCode">{% with %}</code> template tag to retrieve the user performing the action and the related <code class="inlineCode">Profile</code> object. Then, you display the image of the <code class="inlineCode">target</code> object if the <code class="inlineCode">Action</code> object has a related <code class="inlineCode">target</code> object. Finally, you display the link to the user who performed the action, the verb, and the <code class="inlineCode">target</code> object, if any.</p>
<p class="normal">Edit the <code class="inlineCode">account/dashboard.html</code> template of the <code class="inlineCode">account</code> application and append the following code highlighted in bold to the bottom of the <code class="inlineCode">content</code> block:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
  ...
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">h2</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">What's happening</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">h2</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">div</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">id</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"action-list"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">    {% for action in actions %}</strong>
<strong class="hljs-slc">      {% include "actions/action/detail.html" %}</strong>
<strong class="hljs-slc">    {% endfor %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">div</strong><strong class="hljs-tag-slc">&gt;</strong>
{% endblock %}
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/account/</code> in your browser. Log in as an existing user and perform several actions so <a id="_idIndexMarker683"/>that they get stored in the database. Then, log in using another user, follow the previous user, and take a look at the generated action stream on the dashboard page.</p>
<p class="normal">It should look like the following:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, chat or text message  Description automatically generated" src="img/B21088_07_08.png"/></figure>
<p class="packt_figref">Figure 7.8: The activity stream for the current user</p>
<div><p class="normal"><em class="italic">Figure 7.8</em> image attributions<em class="italic">:</em></p>
<p class="normal"><em class="italic">Tesla’s induction motor </em>by Ctac<em class="italic"> </em>(license – Creative Commons Attribution Share-Alike 3.0 Unported:<em class="italic"> </em><a href="https://creativecommons.org/licenses/by-sa/3.0/">https://creativecommons.org/licenses/by-sa/3.0/</a>)</p>
<p class="normal"><em class="italic">Turing Machine Model Davey 2012 </em>by Rocky Acosta<em class="italic"> </em>(license – Creative Commons Attribution 3.0 Unported: <a href="https://creativecommons.org/licenses/by/3.0/">https://creativecommons.org/licenses/by/3.0/</a>)</p>
<p class="normal"><em class="italic">Chick Corea</em> by ataelw (license – Creative Commons Attribution 2.0 Generic: <a href="https://creativecommons.org/licenses/by/2.0/">https://creativecommons.org/licenses/by/2.0/</a>)</p>
</div>
<p class="normal">You just created a complete activity stream for your users, and you can easily add new user actions to it. You can also add infinite scroll functionality to the activity stream by implementing the<a id="_idIndexMarker684"/> same AJAX paginator that you used for the <code class="inlineCode">image_list</code> view. Next, you will learn how to use Django signals to denormalize action counts.</p>
<h1 class="heading-1" id="_idParaDest-209">Using signals for denormalizing counts</h1>
<p class="normal">There are some cases when you may want to denormalize your data. Denormalization is making data redundant in such a way that it optimizes read performance. For example, you might be copying related<a id="_idIndexMarker685"/> data to an object to avoid expensive read queries to the database when retrieving the related data. You have to be careful about denormalization and only start using it when you really need it. The biggest issue you will find with denormalization is that it’s difficult to keep your denormalized data updated.</p>
<p class="normal">Let’s take a look at an example of how to improve your queries by denormalizing counts. You will denormalize data from your <code class="inlineCode">Image</code> model and use Django signals to keep the data updated.</p>
<h2 class="heading-2" id="_idParaDest-210">Working with signals</h2>
<p class="normal">Django comes with a signal <a id="_idIndexMarker686"/>dispatcher that allows receiver functions to get notified when certain actions occur. Signals are very useful when you need your code to do something every time something else happens. Signals allow you to decouple logic: you can capture a certain action, regardless of the application or code that triggered that action, and implement logic that gets executed whenever that action occurs. For example, you can build a signal receiver function that gets executed every time a <code class="inlineCode">User</code> object is saved. You can also create your own signals so that others can get notified when an event happens.</p>
<p class="normal">Django provides several signals for models located at <code class="inlineCode">django.db.models.signals</code>. Some of these signals are as follows:</p>
<ul>
<li class="bulletList"><code class="inlineCode">pre_save</code> and <code class="inlineCode">post_save</code> are sent before or after calling the <code class="inlineCode">save()</code> method of a model</li>
<li class="bulletList"><code class="inlineCode">pre_delete</code> and <code class="inlineCode">post_delete</code> are sent before or after calling the <code class="inlineCode">delete()</code> method of a model or QuerySet</li>
<li class="bulletList"><code class="inlineCode">m2m_changed</code> is sent <a id="_idIndexMarker687"/>when a <code class="inlineCode">ManyToManyField</code> on a model is changed</li>
</ul>
<p class="normal">These are just a subset of the signals provided by Django. You can find a list of all built-in signals at <a href="https://docs.djangoproject.com/en/5.0/ref/signals/">https://docs.djangoproject.com/en/5.0/ref/signals/</a>.</p>
<p class="normal">Let’s say you want to retrieve images by popularity. You can use the Django aggregation functions to retrieve images ordered by the number of users who like them. Remember that you used Django aggregation functions in <em class="italic">Chapter 3</em>, <em class="italic">Extending Your Blog Application</em>. The following code example will retrieve images according to their number of likes:</p>
<pre class="programlisting code"><code class="hljs-code">from django.db.models import Count
from images.models import Image
images_by_popularity = Image.objects.annotate(
    total_likes=Count('users_like')
).order_by('-total_likes')
</code></pre>
<p class="normal">However, ordering images by counting their total likes is more expensive in terms of performance than ordering them by a field that stores total counts. You can add a field to the <code class="inlineCode">Image</code> model to denormalize the total number of likes to boost performance in queries that involve this field. The issue is how to keep this field updated.</p>
<p class="normal">Edit the <code class="inlineCode">models.py</code> file of the <code class="inlineCode">images</code> application and add the following <code class="inlineCode">total_likes</code> field to the <code class="inlineCode">Image</code> model. The new code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">class Image(models.Model):
    # ...
<strong class="hljs-slc">    total_likes = models.PositiveIntegerField(default=</strong><strong class="hljs-number-slc">0</strong><strong class="hljs-slc">)</strong>
class Meta:
        indexes = [
            models.Index(fields=['-created']),
<strong class="hljs-slc">            models.Index(fields=[</strong><strong class="hljs-string-slc">'-total_likes'</strong><strong class="hljs-slc">]),</strong>
        ]
        ordering = ['-created']
</code></pre>
<p class="normal">The <code class="inlineCode">total_likes</code> field will allow you to store the total count of users who like each image. Denormalizing counts is <a id="_idIndexMarker688"/>useful when you want to filter or order QuerySets by them. We have added a database index for the <code class="inlineCode">total_likes</code> field in descending order because we plan to retrieve images ordered by their total likes in descending order.</p>
<div><p class="normal"> There are several ways to improve performance that you have to take into account before denormalizing fields. Consider database indexes, query optimization, and caching before starting to denormalize your data.</p>
</div>
<p class="normal">Run the following command to create the migrations for adding the new field to the database table:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py makemigrations images
</code></pre>
<p class="normal">You should see the following output:</p>
<pre class="programlisting con"><code class="hljs-con">Migrations for 'images':
  images/migrations/0002_image_total_likes_and_more.py
    - Add field total_likes to image
    - Create index images_imag_total_l_0bcd7e_idx on field(s) -total_likes of model image
</code></pre>
<p class="normal">Then, run the following command to apply the migration:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py migrate images
</code></pre>
<p class="normal">The output should include the following line:</p>
<pre class="programlisting con"><code class="hljs-con">Applying images.0002_image_total_likes_and_more... OK
</code></pre>
<p class="normal">You need to attach a receiver function to the <code class="inlineCode">m2m_changed</code> signal.</p>
<p class="normal">Create a new file inside the <code class="inlineCode">images</code> application directory and name it <code class="inlineCode">signals.py</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.db.models.signals import m2m_changed
from django.dispatch import receiver
from .models import Image
@receiver(m2m_changed, sender=Image.users_like.through)
def users_like_changed(sender, instance, **kwargs):
    instance.total_likes = instance.users_like.count()
    instance.save()
</code></pre>
<p class="normal">First, you register the <code class="inlineCode">users_like_changed</code> function as a receiver function using the <code class="inlineCode">receiver()</code> decorator. You attach<a id="_idIndexMarker689"/> it to the <code class="inlineCode">m2m_changed</code> signal. Then, you connect the function to <code class="inlineCode">Image.users_like.through</code> so that the function is only called if the <code class="inlineCode">m2m_changed</code> signal has been launched by this sender. There is an alternate method for registering a receiver function; it consists of using the <code class="inlineCode">connect()</code> method of the <code class="inlineCode">Signal</code> object.</p>
<div><p class="normal">Django signals are synchronous and blocking. Don’t confuse signals with asynchronous tasks. However, you can combine both to launch asynchronous tasks when your code gets notified by a signal. You will learn how to create asynchronous tasks with Celery in <em class="italic">Chapter 8</em>, <em class="italic">Building an Online Shop</em>.</p>
</div>
<p class="normal">You have to connect your receiver function to a signal so that it gets called every time the signal is sent. The recommended method for registering your signals is by importing them into the <code class="inlineCode">ready()</code> method of your application configuration class. Django provides an application registry that allows you to configure and introspect your applications.</p>
<h2 class="heading-2" id="_idParaDest-211">Application configuration classes</h2>
<p class="normal">Django allows you to specify configuration<a id="_idIndexMarker690"/> classes for your applications. When you create an application using the <code class="inlineCode">startapp</code> command, Django adds an <code class="inlineCode">apps.py</code> file to the application directory, including a basic application configuration that inherits from the <code class="inlineCode">AppConfig</code> class.</p>
<p class="normal">The application configuration class allows you to store metadata and the configuration for the application, and it provides introspection for the application. You can find more information about application configurations at <a href="https://docs.djangoproject.com/en/5.0/ref/applications/">https://docs.djangoproject.com/en/5.0/ref/applications/</a>.</p>
<p class="normal">In order to register your signal receiver functions, when you use the <code class="inlineCode">receiver()</code> decorator, you just need to import the <code class="inlineCode">signals</code> module of your application inside the <code class="inlineCode">ready()</code> method of the application configuration class. This method is called as soon as the application registry is fully populated. Any other initializations for your application should also be included in <a id="_idIndexMarker691"/>this method.</p>
<p class="normal">Edit the <code class="inlineCode">apps.py</code> file of the <code class="inlineCode">images</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django.apps import AppConfig
class ImagesConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'images'
<strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">ready</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># import signal handlers</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> images.signals</strong>
</code></pre>
<p class="normal">You import the signals for this application in the <code class="inlineCode">ready()</code> method so that they are imported when the <code class="inlineCode">images</code> application is loaded.</p>
<p class="normal">Run the development server with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open your browser to view an image detail page and click on the <strong class="screenText">Like</strong> button.</p>
<p class="normal">Go to the administration site, navigate to the edit image URL, such as <code class="inlineCode">http://127.0.0.1:8000/admin/images/image/1/change/</code>, and take a look at the <code class="inlineCode">total_likes</code> attribute. You should see that the <code class="inlineCode">total_likes</code> attribute is updated with the total number of users who like the image, as follows:</p>
<figure class="mediaobject"><img alt="Graphical user interface  Description automatically generated" src="img/B21088_07_09.png"/></figure>
<p class="packt_figref">Figure 7.9: The image edit page on the administration site, including denormalization for total likes</p>
<p class="normal">Now, you can use the <code class="inlineCode">total_likes</code> attribute to order images by popularity or display the value anywhere, avoiding using complex queries to calculate it.</p>
<p class="normal">Consider the following <a id="_idIndexMarker692"/>query to get images ordered by their likes count in descending order:</p>
<pre class="programlisting code"><code class="hljs-code">from django.db.models import Count
images_by_popularity = Image.objects.annotate(
    likes=Count('users_like')
).order_by('-likes')
</code></pre>
<p class="normal">The preceding query can now be written as follows:</p>
<pre class="programlisting code"><code class="hljs-code">images_by_popularity = Image.objects.order_by('-total_likes')
</code></pre>
<p class="normal">This results in a less expensive SQL query thanks to denormalizing the total likes for images. You have also learned how you can use Django signals.</p>
<div><p class="normal">Use signals with caution since they make it difficult to know the control flow. In many cases, you can avoid using signals if you know which receivers need to be notified.</p>
</div>
<p class="normal">You will need to set initial counts for the rest of the <code class="inlineCode">Image</code> objects to match the current status of the database.</p>
<p class="normal">Open the shell with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py shell
</code></pre>
<p class="normal">Execute the following code in the shell:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; from images.models import Image
&gt;&gt;&gt; for image in Image.objects.all():
...    image.total_likes = image.users_like.count()
...    image.save()
</code></pre>
<p class="normal">You have manually updated the likes count for the existing images in the database. From now on, the <code class="inlineCode">users_like_changed</code> signal receiver function will handle updating the <code class="inlineCode">total_likes</code> field whenever the many-to-many related objects change.</p>
<p class="normal">Next, you will learn how to use Django Debug Toolbar to obtain relevant debug information for requests, including<a id="_idIndexMarker693"/> execution time, SQL queries executed, templates rendered, signals registered, and much more.</p>
<h1 class="heading-1" id="_idParaDest-212">Using Django Debug Toolbar</h1>
<p class="normal">By this point, you will already be <a id="_idIndexMarker694"/>familiar with Django’s debug page. Throughout the previous chapters, you have seen the distinctive yellow and gray Django debug page several times. </p>
<p class="normal">For example, in <em class="italic">Chapter 2</em>, <em class="italic">Enhancing Your Blog with Advanced Features</em>, in the <em class="italic">Handling pagination errors</em> section, the debug page showed information related to unhandled exceptions when implementing object pagination.</p>
<p class="normal">The Django debug page provides useful debug information. However, there is a Django application that includes more detailed debug information and can be really helpful when developing.</p>
<p class="normal">Django Debug Toolbar is an external Django application that allows you to see relevant debug information about the current request/response cycle. The information is divided into multiple panels that show different information, including request/response data, Python package versions used, execution time, settings, headers, SQL queries, templates used, cache, signals, and logging.</p>
<p class="normal">You can find the documentation<a id="_idIndexMarker695"/> for Django Debug Toolbar at <a href="https://django-debug-toolbar.readthedocs.io/">https://django-debug-toolbar.readthedocs.io/</a>.</p>
<h2 class="heading-2" id="_idParaDest-213">Installing Django Debug Toolbar</h2>
<p class="normal">Install <code class="inlineCode">django-debug-toolbar</code> via <code class="inlineCode">pip</code> using<a id="_idIndexMarker696"/> the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install django-debug-toolbar==4.3.0
</code></pre>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of your project and add <code class="inlineCode">debug_toolbar</code> to the <code class="inlineCode">INSTALLED_APPS</code> setting, as follows. The new line is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">INSTALLED_APPS = [
    # ...
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'debug_toolbar'</strong><strong class="hljs-slc">,</strong>
# ...
]
</code></pre>
<p class="normal">In the same file, add the following line highlighted in bold to the <code class="inlineCode">MIDDLEWARE</code> setting:</p>
<pre class="programlisting code"><code class="hljs-code">MIDDLEWARE = [
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'debug_toolbar.middleware.DebugToolbarMiddleware'</strong><strong class="hljs-slc">,</strong>
'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]
</code></pre>
<p class="normal">Django Debug Toolbar is mostly implemented as middleware. The order of <code class="inlineCode">MIDDLEWARE</code> is important. <code class="inlineCode">DebugToolbarMiddleware</code> has to be placed before any other middleware, except for middleware that encodes the response’s content, such as <code class="inlineCode">GZipMiddleware</code>, which, if present, should come first.</p>
<p class="normal">Add the following lines at the end of the <code class="inlineCode">settings.py</code> file:</p>
<pre class="programlisting code"><code class="hljs-code">INTERNAL_IPS = [
    '127.0.0.1',
]  
</code></pre>
<p class="normal">Django Debug Toolbar will only display if your IP address matches an entry in the <code class="inlineCode">INTERNAL_IPS</code> setting. To prevent showing debug information in production, Django Debug Toolbar checks that the <code class="inlineCode">DEBUG</code> setting is <code class="inlineCode">True</code>.</p>
<p class="normal">Edit the main <code class="inlineCode">urls.py</code> file of your <a id="_idIndexMarker697"/>project and add the following URL pattern highlighted in bold to <code class="inlineCode">urlpatterns</code>:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    path('admin/', admin.site.urls),
    path('account/', include('account.urls')),
    path(
        'social-auth/',
        include('social_django.urls', namespace='social')
    ),
    path('images/', include('images.urls', namespace='images')),
<strong class="hljs-slc">    path(</strong><strong class="hljs-string-slc">'__debug__/'</strong><strong class="hljs-slc">, include(</strong><strong class="hljs-string-slc">'debug_toolbar.urls'</strong><strong class="hljs-slc">)),</strong>
]
</code></pre>
<p class="normal">Django Debug Toolbar is now installed in your project. Let’s try it out!</p>
<p class="normal">Run the development server with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/images/</code> with your browser. You should now see a collapsible sidebar on the right. It should look as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_07_10.png"/></figure>
<p class="packt_figref">Figure 7.10: The Django Debug Toolbar sidebar</p>
<div><p class="normal"><em class="italic">Figure 7.10</em> image attributions:</p>
<p class="normal"><em class="italic">Chick Corea</em> by ataelw (license – Creative Commons Attribution 2.0 Generic: <a href="https://creativecommons.org/licenses/by/2.0/">https://creativecommons.org/licenses/by/2.0/</a>)</p>
<p class="normal"><em class="italic">Al Jarreau Düsseldorf 1981</em> by Eddi<a id="_idIndexMarker698"/> Laumanns aka RX-Guru (license – Creative Commons Attribution 3.0 Unported: <a href="https://creativecommons.org/licenses/by/3.0/">https://creativecommons.org/licenses/by/3.0/</a>)</p>
<p class="normal"><em class="italic">Al Jarreau </em>by Kingkongphoto and www.celebrity-photos.com (license – Creative Commons Attribution-ShareAlike 2.0 Generic: <a href="https://creativecommons.org/licenses/by-sa/2.0/">https://creativecommons.org/licenses/by-sa/2.0/</a>)</p>
</div>
<p class="normal">If the Debug Toolbar doesn’t appear, check the RunServer shell console log. If you see a MIME type error, it is most <a id="_idIndexMarker699"/>likely that your MIME map files are incorrect or need to be updated.</p>
<p class="normal">You can apply the correct mapping for JavaScript and CSS files by adding the following lines to the <code class="inlineCode">settings.py</code> file:</p>
<pre class="programlisting code"><code class="hljs-code">if DEBUG:
    import mimetypes
    mimetypes.add_type('application/javascript', '.js', True)
    mimetypes.add_type('text/css', '.css', True)
</code></pre>
<h2 class="heading-2" id="_idParaDest-214">Django Debug Toolbar panels</h2>
<p class="normal">Django Debug Toolbar features multiple<a id="_idIndexMarker700"/> panels that organize the debug information for the request/response cycle. The sidebar contains links to each panel, and you can use the checkbox of any panel to activate or deactivate it. The change will be applied to the next request. This is useful when we are not interested in a specific panel, but the calculation adds too much overhead to the request.</p>
<p class="normal">Click on <strong class="screenText">Time</strong> in the sidebar menu. You will see the following panel:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_07_11.png"/></figure>
<p class="packt_figref"> Figure 7.11: Time panel – Django Debug Toolbar</p>
<p class="normal">The <strong class="screenText">Time</strong> panel includes a timer for the different phases of the request/response cycle. It also shows CPU, elapsed<a id="_idIndexMarker701"/> time, and the number of context switches. If you are using Windows, you won’t be able to see the <strong class="screenText">Time</strong> panel. In Windows, only the total time is available and displayed in the toolbar.</p>
<p class="normal">Click on <strong class="screenText">SQL</strong> in the sidebar menu. You will see the following panel:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_07_12.png"/></figure>
<p class="packt_figref">Figure 7.12: SQL panel – Django Debug Toolbar</p>
<p class="normal">Here, you can see the different SQL queries that have been executed. This information can help you identify unnecessary queries, duplicated queries that can be reused, or long-running queries that can be optimized. Based on your findings, you can improve QuerySets in your views, create<a id="_idIndexMarker702"/> new indexes on model fields if necessary, or cache information when needed. In this chapter, you learned how to optimize queries that involve relationships using <code class="inlineCode">select_related()</code> and <code class="inlineCode">prefetch_related()</code>. You will learn how to cache data in <em class="italic">Chapter 14</em>, <em class="italic">Rendering and Caching Content</em>.</p>
<p class="normal">Click on <strong class="screenText">Templates</strong> in the sidebar menu. You will see the following panel:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_07_13.png"/></figure>
<p class="packt_figref">Figure 7.13: Templates panel – Django Debug Toolbar</p>
<p class="normal">This panel shows the <a id="_idIndexMarker703"/>different templates used when rendering the content, the template paths, and the context used. You can also see the different context processors used. You will learn about context processors in <em class="italic">Chapter 8</em>, <em class="italic">Building an Online Shop</em>.</p>
<p class="normal">Click on <strong class="screenText">Signals</strong> in the sidebar menu. You will see the following panel:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_07_14.png"/></figure>
<p class="packt_figref">Figure 7.14: Signals panel – Django Debug Toolbar</p>
<p class="normal">In this panel, you can see all the<a id="_idIndexMarker704"/> signals that are registered in your project and the receiver functions attached to each signal. For example, you can find the <code class="inlineCode">users_like_changed</code> receiver function you created before, attached to the <code class="inlineCode">m2m_changed</code> signal. The other signals and receivers are part of the different Django applications.</p>
<p class="normal">We have reviewed some of the panels that ship with Django Debug Toolbar. Besides the built-in panels, you can find additional third-party panels that you can download and use at <a href="https://django-debug-toolbar.readthedocs.io/en/latest/panels.html#third-party-panels">https://django-debug-toolbar.readthedocs.io/en/latest/panels.html#third-party-panels</a>.</p>
<h2 class="heading-2" id="_idParaDest-215">Django Debug Toolbar commands</h2>
<p class="normal">Besides the request/response debug panels, Django Debug Toolbar provides a management command to debug SQL <a id="_idIndexMarker705"/>for ORM calls. The management command <code class="inlineCode">debugsqlshell</code> replicates the Django <code class="inlineCode">shell</code> command but it outputs SQL statements for queries performed with the Django ORM.</p>
<p class="normal">Open the shell with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py debugsqlshell
</code></pre>
<p class="normal">Execute the following code:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; from images.models import Image
&gt;&gt;&gt; Image.objects.get(id=1)
</code></pre>
<p class="normal">You will see the following output:</p>
<pre class="programlisting con"><code class="hljs-con">SELECT "images_image"."id",
       "images_image"."user_id",
       "images_image"."title",
       "images_image"."slug",
       "images_image"."url",
       "images_image"."image",
       "images_image"."description",
       "images_image"."created",
       "images_image"."total_likes"
FROM "images_image"
WHERE "images_image"."id" = 1
LIMIT 21 [0.44ms]
&lt;Image: Django and Duke&gt;
</code></pre>
<p class="normal">You can use this command to test ORM queries before adding them to your views. You can check the resulting SQL statement and the execution time for each ORM call.</p>
<p class="normal">In the next section, you will learn how to count image views using Redis, an in-memory database that provides low latency and high-throughput data access.</p>
<h1 class="heading-1" id="_idParaDest-216">Counting image views with Redis</h1>
<p class="normal">Redis is an advanced key/value<a id="_idIndexMarker706"/> database that allows you to save different types of data. It also has extremely fast I/O operations. Redis stores everything in memory, but <a id="_idIndexMarker707"/>the data can be persisted by dumping the dataset to disk every once in a while, or by adding each command to a log. Redis is very versatile compared to other key/value stores: it provides a set of powerful commands and supports diverse data structures, such as strings, hashes, lists, sets, ordered sets, and even <code class="inlineCode">bitmap</code> or <code class="inlineCode">HyperLogLog</code> methods.</p>
<p class="normal">Although SQL is best suited to schema-defined persistent data storage, Redis offers numerous advantages when dealing with rapidly changing data, volatile storage, or when a quick cache is needed. Let’s take a look at how Redis can be used to build new functionality in your project.</p>
<p class="normal">You can find more information about Redis on its home page at <a href="https://redis.io/">https://redis.io/</a>.</p>
<p class="normal">Redis provides a Docker image that makes it very easy to deploy a Redis server with a standard configuration.</p>
<h2 class="heading-2" id="_idParaDest-217">Installing Redis</h2>
<p class="normal">To install the Redis Docker image, make sure Docker is installed on your machine. You learned how to install <a id="_idIndexMarker708"/>Docker in <em class="italic">Chapter 3</em>, <em class="italic">Extending Your Blog Application</em>.</p>
<p class="normal">Run the following command from the shell:</p>
<pre class="programlisting con"><code class="hljs-con">docker pull redis:7.2.4
</code></pre>
<p class="normal">This will download the Redis Docker image to your local machine. You can find information about the official Redis Docker image at <a href="https://hub.docker.com/_/redis">https://hub.docker.com/_/redis</a>. You can find other alternative methods to install Redis at <a href="https://redis.io/download/">https://redis.io/download/</a>.</p>
<p class="normal">Execute the following command in the shell to start the Redis Docker container:</p>
<pre class="programlisting con"><code class="hljs-con">docker run -it --rm --name redis -p 6379:6379 redis:7.2.4
</code></pre>
<p class="normal">With this command, we run Redis in a Docker container. The <code class="inlineCode">-it</code> option tells Docker to take you straight inside the container for interactive input. The <code class="inlineCode">--rm</code> option tells Docker to automatically clean up the container and remove the file system when the container exits. The <code class="inlineCode">--name</code> option is used to assign a name to the container. The <code class="inlineCode">-p</code> option is used to publish the <code class="inlineCode">6379</code> port on which Redis runs to the same host interface port. <code class="inlineCode">6379</code> is the default port for Redis.</p>
<p class="normal">You should see an output<a id="_idIndexMarker709"/> that ends with the following lines:</p>
<pre class="programlisting con"><code class="hljs-con"># Server initialized
* Ready to accept connections
</code></pre>
<p class="normal">Keep the Redis server running on port <code class="inlineCode">6379</code> and open another shell. Start the Redis client with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">docker exec -it redis sh
</code></pre>
<p class="normal">You will see a line with the hash symbol:</p>
<pre class="programlisting con"><code class="hljs-con">#
</code></pre>
<p class="normal">Start the Redis client with the following command:</p>
<pre class="programlisting con"><code class="hljs-con"># redis-cli
</code></pre>
<p class="normal">You will see the Redis client shell prompt, like this:</p>
<pre class="programlisting con"><code class="hljs-con">127.0.0.1:6379&gt;
</code></pre>
<p class="normal">The Redis client allows you to execute Redis commands directly from the shell. Let’s try some commands. Enter the <code class="inlineCode">SET</code> command in the Redis shell to store a value in a key:</p>
<pre class="programlisting con"><code class="hljs-con">127.0.0.1:6379&gt; SET name "Peter"
OK
</code></pre>
<p class="normal">The preceding command creates a <code class="inlineCode">name</code> key with the string value <code class="inlineCode">"Peter"</code> in the Redis database. The <code class="inlineCode">OK</code> output indicates that the key has been saved successfully.</p>
<p class="normal">Next, retrieve the value using the <code class="inlineCode">GET</code> command, as follows:</p>
<pre class="programlisting con"><code class="hljs-con">127.0.0.1:6379&gt; GET name
"Peter"
</code></pre>
<p class="normal">You can also check whether a key exists using the <code class="inlineCode">EXISTS</code> command. This command returns <code class="inlineCode">1</code> if the given key exists and <code class="inlineCode">0</code> otherwise:</p>
<pre class="programlisting con"><code class="hljs-con">127.0.0.1:6379&gt; EXISTS name
(integer) 1
</code></pre>
<p class="normal">You can set the time for a key to expire using the <code class="inlineCode">EXPIRE</code> command, which allows you to set the time-to-live in seconds. Another <a id="_idIndexMarker710"/>option is using the <code class="inlineCode">EXPIREAT</code> command, which expects a Unix timestamp. Key expiration is useful for using Redis as a cache or to store volatile data:</p>
<pre class="programlisting con"><code class="hljs-con">127.0.0.1:6379&gt; GET name
"Peter"
127.0.0.1:6379&gt; EXPIRE name 2
(integer) 1
</code></pre>
<p class="normal">Wait for more than two seconds and try to get the same key again:</p>
<pre class="programlisting con"><code class="hljs-con">127.0.0.1:6379&gt; GET name
(nil)
</code></pre>
<p class="normal">The <code class="inlineCode">(nil)</code> response is a null response and means that no key has been found. You can also delete any key using the <code class="inlineCode">DEL</code> command, as follows:</p>
<pre class="programlisting con"><code class="hljs-con">127.0.0.1:6379&gt; SET total 1
OK
127.0.0.1:6379&gt; DEL total
(integer) 1
127.0.0.1:6379&gt; GET total
(nil)
</code></pre>
<p class="normal">These are just basic commands for key operations. You can find all Redis commands at <a href="https://redis.io/commands/">https://redis.io/commands/</a> and all Redis data types at <a href="https://redis.io/docs/manual/data-types/">https://redis.io/docs/manual/data-types/</a>.</p>
<h2 class="heading-2" id="_idParaDest-218">Using Redis with Python</h2>
<p class="normal">You will need Python bindings for <a id="_idIndexMarker711"/>Redis. Install <code class="inlineCode">redis-py</code> via <code class="inlineCode">pip</code> using the<a id="_idIndexMarker712"/> following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install redis==5.0.4
</code></pre>
<p class="normal">You can find the <code class="inlineCode">redis-py</code> documentation at <a href="https://redis-py.readthedocs.io/">https://redis-py.readthedocs.io/</a>.</p>
<p class="normal">The <code class="inlineCode">redis-py</code> package interacts with Redis, providing a Python interface that follows the Redis command syntax. Open<a id="_idIndexMarker713"/> the Python shell with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py shell
</code></pre>
<p class="normal">Execute the following code:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; import redis
&gt;&gt;&gt; r = redis.Redis(host='localhost', port=6379, db=0)
</code></pre>
<p class="normal">The preceding code creates a connection with the Redis database. In Redis, databases are identified by an integer index<a id="_idIndexMarker714"/> instead of a database name. By default, a client is connected to database <code class="inlineCode">0</code>. The number of available Redis databases is set to <code class="inlineCode">16</code> but you can change this in the <code class="inlineCode">redis.conf</code> configuration file.</p>
<p class="normal">Next, set a key using the Python shell:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; r.set('foo', 'bar')
True
</code></pre>
<p class="normal">The command returns <code class="inlineCode">True</code>, indicating that the key has been successfully created. Now you can retrieve the key using the <code class="inlineCode">get()</code> command:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; r.get('foo')
b'bar'
</code></pre>
<p class="normal">As you will note from the preceding code, the methods of Redis follow the Redis command syntax.</p>
<p class="normal">Let’s integrate Redis into your project. Edit the <code class="inlineCode">settings.py</code> file of the <code class="inlineCode">bookmarks</code> project and add the following settings to it:</p>
<pre class="programlisting code"><code class="hljs-code">REDIS_HOST = 'localhost'
REDIS_PORT = 6379
REDIS_DB = 0
</code></pre>
<p class="normal">These are the settings for the Redis server and the database that you will use for your project.</p>
<h2 class="heading-2" id="_idParaDest-219">Storing image views in Redis</h2>
<p class="normal">Let’s find a way to <a id="_idIndexMarker715"/>store the total number of times an image has been viewed. If you implement this using the Django ORM, it will involve a SQL <code class="inlineCode">UPDATE</code> query every time an image is displayed.</p>
<p class="normal">If you use Redis instead, you just need to increment a counter stored in memory, resulting in much better performance and less overhead.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">images</code> application and add the following code to it after the existing <code class="inlineCode">import</code> statements:</p>
<pre class="programlisting code"><code class="hljs-code">import redis
from django.conf import settings
# connect to redis
r = redis.Redis(
    host=settings.REDIS_HOST,
    port=settings.REDIS_PORT,
    db=settings.REDIS_DB
)
</code></pre>
<p class="normal">With the preceding code, you establish the Redis connection in order to use it in your views. Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">images</code> application and modify the <code class="inlineCode">image_detail</code> view, like this. The new code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">def image_detail(request, id, slug):
    image = get_object_or_404(Image, id=id, slug=slug)
    # increment total image views by 1
<strong class="hljs-slc">    total_views = r.incr(</strong><strong class="hljs-string-slc">f'image:</strong><strong class="hljs-subst-slc">{image.</strong><strong class="hljs-built_in-slc">id</strong><strong class="hljs-subst-slc">}</strong><strong class="hljs-string-slc">:views'</strong><strong class="hljs-slc">)</strong>
return render(
        request,
        'images/image/detail.html',
        {
            'section': 'images',
            'image': image<strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'total_views'</strong><strong class="hljs-slc">: total_views</strong>
        }
    )
</code></pre>
<p class="normal">In this view, you use the <code class="inlineCode">incr</code> command, which increments the value of a given key by <code class="inlineCode">1</code>. If the key doesn’t exist, the <code class="inlineCode">incr</code> command creates it. The <code class="inlineCode">incr()</code> method returns the final value of the key after performing the operation. You store the value in the <code class="inlineCode">total_views</code> variable and <a id="_idIndexMarker716"/>pass it into the template context. You build the Redis key using a notation such as <code class="inlineCode">object-type:id:field</code> (for example, <code class="inlineCode">image:33:id</code>).</p>
<div><p class="normal">The convention for naming Redis keys is to use a colon sign as a separator for creating namespaced keys. By doing so, the key names are especially verbose, and related keys share part of the same schema in their names.</p>
</div>
<p class="normal">Edit the <code class="inlineCode">images/image/detail.html</code> template of the <code class="inlineCode">images</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">...
&lt;div class="image-info"&gt;
  &lt;div&gt;
    &lt;span class="count"&gt;
      &lt;span class="total"&gt;{{ total_likes }}&lt;/span&gt;
      like{{ total_likes|pluralize }}
    &lt;/span&gt;
<strong class="hljs-slc">    &lt;span </strong><strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc">=</strong><strong class="hljs-string-slc">"count"</strong><strong class="hljs-slc">&gt;</strong>
<strong class="hljs-slc">      {{ total_views }} view{{ total_views|pluralize }}</strong>
<strong class="hljs-slc">    &lt;/span&gt;</strong>
    &lt;a href="#" data-id="{{ image.id }}" data-action="{% if request.user in users_like %}un{% endif %}like"
class="like button"&gt;
      {% if request.user not in users_like %}
        Like
      {% else %}
        Unlike
      {% endif %}
    &lt;/a&gt;
  &lt;/div&gt;
  {{ image.description|linebreaks }}
&lt;/div&gt;
...
</code></pre>
<p class="normal">Run the development server with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open an image detail page in your browser and reload it several times. You will see that each time the view is <a id="_idIndexMarker717"/>processed, the total views displayed is incremented by 1. Take a look at the following example:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, chat or text message  Description automatically generated" src="img/B21088_07_15.png"/></figure>
<p class="packt_figref">Figure 7.15: The image detail page, including the count of likes and views</p>
<p class="normal">Great! You have successfully integrated Redis into your project to count image views. In the next section, you will learn how to build a ranking of the most viewed images with Redis.</p>
<h2 class="heading-2" id="_idParaDest-220">Storing a ranking in Redis</h2>
<p class="normal">We will now create something more complex with Redis. We will use Redis to store a ranking of the most viewed<a id="_idIndexMarker718"/> images on the platform. We will use Redis sorted sets for this. A sorted set is a non-repeating collection of strings in which every member is associated with a score. Items are sorted by their score.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">images</code> application and add the following code highlighted in bold to the <code class="inlineCode">image_detail</code> view:</p>
<pre class="programlisting code"><code class="hljs-code">def image_detail(request, id, slug):
    image = get_object_or_404(Image, id=id, slug=slug)
    # increment total image views by 1
    total_views = r.incr(f'image:{image.id}:views')
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># increment image ranking by 1</strong>
<strong class="hljs-slc">    r.zincrby(</strong><strong class="hljs-string-slc">'image_ranking'</strong><strong class="hljs-slc">, </strong><strong class="hljs-number-slc">1</strong><strong class="hljs-slc">, image.</strong><strong class="hljs-built_in-slc">id</strong><strong class="hljs-slc">)</strong>
return render(
        request,
        'images/image/detail.html',
        {
            'section': 'images',
            'image': image,
            'total_views': total_views
        }
    )
</code></pre>
<p class="normal">You use the <code class="inlineCode">zincrby()</code> command to store image views in a sorted set with the <code class="inlineCode">image:ranking</code> key. You will store the image <code class="inlineCode">id</code> and a related score of <code class="inlineCode">1</code>, which will be added to the total score of this element in the sorted set. This will allow you to keep track of all image views globally and have a sorted set ordered by the total number of views.</p>
<p class="normal">Now, create a new <a id="_idIndexMarker719"/>view to display the ranking of the most viewed images. Add the following code to the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">images</code> application:</p>
<pre class="programlisting code"><code class="hljs-code">@login_required
def image_ranking(request):
    # get image ranking dictionary
    image_ranking = r.zrange(
        'image_ranking', 0, -1,
        desc=True
 )[:10]
    image_ranking_ids = [int(id) for id in image_ranking]
    # get most viewed images
    most_viewed = list(
        Image.objects.filter(
            id__in=image_ranking_ids
        )
    )
    most_viewed.sort(key=lambda x: image_ranking_ids.index(x.id))
    return render(
        request,
        'images/image/ranking.html',
        {'section': 'images', 'most_viewed': most_viewed}
    )
</code></pre>
<p class="normal">The <code class="inlineCode">image_ranking</code> view works like this:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">You use the <code class="inlineCode">zrange()</code> command to obtain the elements in the sorted set. This command expects a custom range according to the lowest and highest scores. By using <code class="inlineCode">0</code> as the lowest and <code class="inlineCode">-1</code> as the highest score, you are telling Redis to return all elements in the sorted set. You also specify <code class="inlineCode">desc=True</code> to retrieve the elements ordered by descending score. Finally, you slice the results using <code class="inlineCode">[:10]</code> to get the first 10 elements with the highest score.</li>
<li class="numberedList">You build a list of <a id="_idIndexMarker720"/>returned image IDs and store it in the <code class="inlineCode">image_ranking_ids</code> variable as a list of integers. You retrieve the <code class="inlineCode">Image</code> objects for those IDs and force the query to be executed using the <code class="inlineCode">list()</code> function. It is important to force the QuerySet execution because you will use the <code class="inlineCode">sort()</code> method on it (at this point, you need a list of objects instead of a QuerySet).</li>
<li class="numberedList">You sort the <code class="inlineCode">Image</code> objects by their index of appearance in the image ranking. Now you can use the <code class="inlineCode">most_viewed</code> list in your template to display the 10 most viewed images.</li>
</ol>
<p class="normal">Create a new <code class="inlineCode">ranking.html</code> template inside the <code class="inlineCode">images/image/</code> template directory of the <code class="inlineCode">images</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Images ranking{% endblock %}
{% block content %}
  &lt;h1&gt;Images ranking&lt;/h1&gt;
&lt;ol&gt;
    {% for image in most_viewed %}
      &lt;li&gt;
&lt;a href="{{ image.get_absolute_url }}"&gt;
          {{ image.title }}
        &lt;/a&gt;
&lt;/li&gt;
    {% endfor %}
  &lt;/ol&gt;
{% endblock %}
</code></pre>
<p class="normal">The template is pretty straightforward. You iterate over the <code class="inlineCode">Image</code> objects contained in the <code class="inlineCode">most_viewed</code> list and display their names, including a link to the image detail page.</p>
<p class="normal">Finally, you need to create a URL pattern for the new view. Edit the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">images</code> application and add the <a id="_idIndexMarker721"/>following URL pattern highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    path('create/', views.image_create, name='create'),
    path('detail/&lt;int:id&gt;/&lt;slug:slug&gt;/',
         views.image_detail, name='detail'),
    path('like/', views.image_like, name='like'),
    path('', views.image_list, name='list'),
<strong class="hljs-slc">    path(</strong><strong class="hljs-string-slc">'ranking/'</strong><strong class="hljs-slc">, views.image_ranking, name=</strong><strong class="hljs-string-slc">'ranking'</strong><strong class="hljs-slc">),</strong>
]
</code></pre>
<p class="normal">Run the development server, access your site in your web browser, and load the image detail page multiple times for different images. Then, access <code class="inlineCode">http://127.0.0.1:8000/images/ranking/</code> from your browser. You should be able to see an image ranking, as follows:</p>
<figure class="mediaobject"><img alt="Graphical user interface, table  Description automatically generated" src="img/B21088_07_16.png"/></figure>
<p class="packt_figref">Figure 7.16: The ranking page built with data retrieved from Redis</p>
<p class="normal">Great! You just created a ranking with Redis.</p>
<h2 class="heading-2" id="_idParaDest-221">Next steps with Redis</h2>
<p class="normal">Redis is not a replacement for your SQL database but it does offer fast in-memory storage that is more suitable for certain tasks. Add it to your stack and use it when you really feel it’s needed. The following are <a id="_idIndexMarker722"/>some scenarios in which Redis could be useful:</p>
<ul>
<li class="bulletList"><strong class="keyWord">Counting</strong>: As you have seen, it is very easy to manage counters with Redis. You can use <code class="inlineCode">incr()</code> and <code class="inlineCode">incrby()</code> for counting stuff.</li>
<li class="bulletList"><strong class="keyWord">Storing the latest items</strong>: You can add items to the start/end of a list using <code class="inlineCode">lpush()</code> and <code class="inlineCode">rpush()</code>. Remove and return the first/last element using <code class="inlineCode">lpop()</code>/<code class="inlineCode">rpop()</code>. You can trim the list’s length using <code class="inlineCode">ltrim()</code> to maintain its length.</li>
<li class="bulletList"><strong class="keyWord">Queues</strong>: In addition to <code class="inlineCode">push</code> and <code class="inlineCode">pop</code> commands, Redis offers the blocking of queue commands.</li>
<li class="bulletList"><strong class="keyWord">Caching</strong>: Using <code class="inlineCode">expire()</code> and <code class="inlineCode">expireat()</code> allows you to use Redis as a cache. You can also find third-party Redis cache backends for Django.</li>
<li class="bulletList"><strong class="keyWord">Pub/sub</strong>: Redis provides commands for subscribing/unsubscribing and sending messages to channels.</li>
<li class="bulletList"><strong class="keyWord">Rankings and leaderboards</strong>: Redis’s sorted sets with scores make it very easy to create leaderboards.</li>
<li class="bulletList"><strong class="keyWord">Real-time tracking</strong>: Redis’s fast I/O makes it perfect for real-time scenarios.</li>
</ul>
<h1 class="heading-1" id="_idParaDest-222">Summary</h1>
<p class="normal">In this chapter, you built a follow system using many-to-many relationships with an intermediate model. You also created an activity stream using generic relations and you optimized QuerySets to retrieve related objects. This chapter then introduced you to Django signals, and you created a signal receiver function to denormalize related object counts. We covered application configuration classes, which you used to load your signal handlers. You added Django Debug Toolbar to your project. You also learned how to install and configure Redis in your Django project. Finally, you used Redis in your project to store item views, and you built an image ranking with Redis.</p>
<p class="normal">In the next chapter, you will learn how to build an online shop. You will create a product catalog and build a shopping cart using sessions. You will learn how to create custom context processors. You will also manage customer orders and send asynchronous notifications using Celery and RabbitMQ.</p>
<h1 class="heading-1" id="_idParaDest-223">Expanding your project using AI</h1>
<p class="normal">In this section, you are presented with a task to extend your project, accompanied by a sample prompt for ChatGPT to assist you. To engage with ChatGPT, visit <a href="https://chat.openai.com/">https://chat.openai.com/</a>. If this is your first interaction with ChatGPT, you can revisit the <em class="italic">Expanding your project using AI</em> section in <em class="italic">Chapter 3</em>, <em class="italic">Extending Your Blog Application</em>.</p>
<p class="normal">In this project example, you have learned how to use Django signals and successfully implemented a signal receiver to update the total number of image likes whenever there is a change in the like count. Now, let’s leverage ChatGPT to explore the implementation of a signal receiver that automatically generates a related <code class="inlineCode">Profile</code> object whenever a <code class="inlineCode">User</code> object is created. You can use the prompt provided at <a href="https://github.com/PacktPublishing/Django-5-by-example/blob/main/Chapter07/prompts/task.md">https://github.com/PacktPublishing/Django-5-by-example/blob/main/Chapter07/prompts/task.md</a>.</p>
<p class="normal">After successfully implementing the signal receiver, you can remove the manual profile creation steps previously included in the <code class="inlineCode">register</code> view of the <code class="inlineCode">account</code> application and from the social authentication pipeline. With the receiver function now attached to the <code class="inlineCode">post_save</code> signal of the <code class="inlineCode">User</code> model, profiles will be automatically created for new users.</p>
<div><p class="normal">If you’re having trouble understanding a particular concept or topic in the book, ask ChatGPT to provide additional examples or to explain the concept in a different way. This personalized approach can reinforce your learning and ensure you grasp complex topics.</p>
</div>
<h1 class="heading-1" id="_idParaDest-224">Additional resources</h1>
<p class="normal">The following resources provide additional information related to the topics covered in this chapter:</p>
<ul>
<li class="bulletList">Source code for this chapter: <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter07">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter07</a></li>
<li class="bulletList">Custom user models: <a href="https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#specifying-a-custom-user-model">https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#specifying-a-custom-user-model</a></li>
<li class="bulletList">The <code class="inlineCode">contenttypes</code> framework: <a href="https://docs.djangoproject.com/en/5.0/ref/contrib/contenttypes/">https://docs.djangoproject.com/en/5.0/ref/contrib/contenttypes/</a></li>
<li class="bulletList">Built-in Django signals: <a href="https://docs.djangoproject.com/en/5.0/ref/signals/">https://docs.djangoproject.com/en/5.0/ref/signals/</a></li>
<li class="bulletList">Application configuration classes: <a href="https://docs.djangoproject.com/en/5.0/ref/applications/">https://docs.djangoproject.com/en/5.0/ref/applications/</a></li>
<li class="bulletList">Django Debug Toolbar documentation: <a href="https://django-debug-toolbar.readthedocs.io/">https://django-debug-toolbar.readthedocs.io/</a></li>
<li class="bulletList">Django Debug Toolbar third-party panels: <a href="https://django-debug-toolbar.readthedocs.io/en/latest/panels.html#third-party-panels">https://django-debug-toolbar.readthedocs.io/en/latest/panels.html#third-party-panels</a></li>
<li class="bulletList">Redis in-memory data store: <a href="https://redis.io/">https://redis.io/</a></li>
<li class="bulletList">Official Redis Docker image: <a href="https://hub.docker.com/_/redis">https://hub.docker.com/_/redis</a>.</li>
<li class="bulletList">Redis download options: <a href="https://redis.io/download/">https://redis.io/download/</a></li>
<li class="bulletList">Redis commands: <a href="https://redis.io/commands/">https://redis.io/commands/</a></li>
<li class="bulletList">Redis data types: <a href="https://redis.io/docs/manual/data-types/">https://redis.io/docs/manual/data-types/</a></li>
<li class="bulletList"><code class="inlineCode">redis-py</code> documentation: <a href="https://redis-py.readthedocs.io/">https://redis-py.readthedocs.io/</a></li>
</ul>
</div>
</body></html>