<html><head></head><body>
  <div class="Basic-Text-Frame" id="_idContainer185">
    <h1 class="chapterNumber">11</h1>
    <h1 class="chapterTitle" id="_idParaDest-240">AWS Cloud Networking</h1>
    <p class="normal">Cloud computing is one of the major trends in computing today and has been for many years. Public cloud providers have <a id="_idIndexMarker802"/>transformed the start-up industry and what it means to launch a service from scratch. We no longer need to build our own infrastructure; we can pay public cloud providers to rent a portion of their resources for our infrastructure needs. Nowadays, walking around any technology conferences or meetups, we will be hard-pressed to find someone who has not learned about, used, or built services based in the cloud. Cloud computing is here, and we had better get used to working with it.</p>
    <p class="normal">There are several <a id="_idIndexMarker803"/>cloud computing service models, roughly divided into <strong class="keyWord">Software-as-a-Service</strong> (<strong class="keyWord">SaaS — </strong><a href="https://en.wikipedia.org/wiki/Software_as_a_service"><span class="url">https://en.wikipedia.org/wiki/Software_as_a_service</span></a>), <strong class="keyWord">Platform-as-a-Service</strong> (<strong class="keyWord">PaaS — </strong><a href="https://en.wikipedia.org/wiki/Cloud_computing#Platform_as_a_service_(PaaS)"><span class="url">https://en.wikipedia.org/wiki/Cloud_computing#Platform_as_a_service_(PaaS)</span></a>), and <strong class="keyWord">Infrastructure-as-a-Service</strong> (<strong class="keyWord">IaaS — </strong><a href="https://en.wikipedia.org/wiki/Infrastructure_as_a_service"><span class="url">https://en.wikipedia.org/wiki/Infrastructure_as_a_service</span></a>). Each service model offers a different level <a id="_idIndexMarker804"/>of abstraction from the user’s perspective. For us, networking <a id="_idIndexMarker805"/>is part of the IaaS <a id="_idIndexMarker806"/>offering and the focus of this chapter.</p>
    <p class="normal"><strong class="keyWord">Amazon Web Services</strong> (<strong class="keyWord">AWS</strong> — <a href="https://aws.amazon.com/"><span class="url">https://aws.amazon.com/</span></a>) was the first company to offer IaaS public cloud services <a id="_idIndexMarker807"/>and was the clear leader in the space by market share in 2022 (<a href="https://www.statista.com/chart/18819/worldwide-market-share-of-leading-cloud-infrastructure-service-providers/"><span class="url">https://www.statista.com/chart/18819/worldwide-market-share-of-leading-cloud-infrastructure-service-providers/</span></a>). If we define the term <strong class="keyWord">Software-Defined Networking</strong> (<strong class="keyWord">SDN</strong>) as a group <a id="_idIndexMarker808"/>of software services working <a id="_idIndexMarker809"/>together to create network constructs – IP addresses, access lists, load balancers, and <strong class="keyWord">Network Address Translation</strong> (<strong class="keyWord">NAT</strong>) – we can make the argument that AWS is the world’s largest implementer of SDN. They utilize the massive scale of their global network, data centers, and servers to offer an amazing array of networking services.</p>
    <p class="normal">If you are interested in learning about Amazon’s scale and networking, I would highly recommend taking a look at James Hamilton’s AWS re:Invent 2014 talk: <a href="https://www.youtube.com/watch?v=JIQETrFC_SQ"><span class="url">https://www.youtube.com/watch?v=JIQETrFC_SQ</span></a>. It is a rare insider’s view of the scale and innovation at AWS.</p>
    <p class="normal">In this chapter, we will discuss the networking services offered by the AWS cloud services and how we can use Python to work with them:</p>
    <ul>
      <li class="bulletList">AWS setup and networking overview</li>
      <li class="bulletList">Virtual private cloud</li>
      <li class="bulletList">Direct Connect and VPN</li>
      <li class="bulletList">Networking scaling services</li>
      <li class="bulletList">Other AWS network services</li>
    </ul>
    <p class="normal">Let’s begin by looking at how to set up AWS.</p>
    <h1 class="heading-1" id="_idParaDest-241">AWS setup</h1>
    <p class="normal">If you do not already <a id="_idIndexMarker810"/>have an AWS account and wish to follow along with these examples, please log on to <a href="https://aws.amazon.com/"><span class="url">https://aws.amazon.com/</span></a> and sign up. The process is pretty straightforward; you will need a credit card and some way to verify your identity, such as a mobile phone that can accept text messages.</p>
    <p class="normal">A good thing about AWS when you are just getting started is that they offer many services in a free tier (<a href="https://aws.amazon.com/free/"><span class="url">https://aws.amazon.com/free/</span></a>), where you can use the services for free up to a certain level. For example, we will <a id="_idIndexMarker811"/>use the <strong class="keyWord">Elastic Compute Cloud</strong> (<strong class="keyWord">EC2</strong>) service in this chapter; the free tier for EC2 is the first 750 hours per month for its t2.micro or t3.micro instances for the first 12 months.</p>
    <p class="normal">I recommend always starting with the free tier and gradually increasing your tier when the need arises. Please check the AWS site for the latest offerings:</p>
    <figure class="mediaobject"><img alt="" src="../Images/B18403_11_01.png"/></figure>
    <p class="packt_figref">Figure 11.1: AWS free tier</p>
    <p class="normal">Once you have <a id="_idIndexMarker812"/>an account, you can sign in via the AWS console (<a href="https://console.aws.amazon.com/"><span class="url">https://console.aws.amazon.com/</span></a>) and take a look at the different services offered by AWS.</p>
    <div class="note">
      <p class="normal">The AWS console layout is constantly changing. By the time you read this chapter, your screen might <a id="_idIndexMarker813"/>look different than what is shown. However, the AWS networking concepts will not change. We should always pay attention to the concept, and we should be ok despite any layout changes. </p>
    </div>
    <p class="normal">The console is where we can configure all the services and look at our monthly bills:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B18403_11_02.png"/></figure>
    <p class="packt_figref">Figure 11.2: The AWS console</p>
    <p class="normal">Now that we have <a id="_idIndexMarker814"/>set up our account, let’s take a look at using the AWS CLI tool as well as the Python SDK to manage our AWS resources.</p>
    <h2 class="heading-2" id="_idParaDest-242">The AWS CLI and Python SDK</h2>
    <p class="normal">Besides the console, we can <a id="_idIndexMarker815"/>also manage AWS services via the <strong class="keyWord">command line interface</strong> (<strong class="keyWord">CLI</strong>) and <a id="_idIndexMarker816"/>various SDKs. <strong class="keyWord">The AWS CLI is a Python package </strong><strong class="keyWord"><a id="_idIndexMarker817"/></strong><strong class="keyWord">that can be installed via PIP </strong>(<a href="https://docs.aws.amazon.com/cli/latest/userguide/installing.html"><span class="url">https://docs.aws.amazon.com/cli/latest/userguide/installing.html</span></a>). Let’s install it on our Ubuntu host:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>curl <span class="hljs-con-string">"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"</span> -o <span class="hljs-con-string">"awscliv2.zip"</span>
<span class="hljs-con-meta">$ </span>unzip awscliv2.zip
<span class="hljs-con-meta">$ </span>sudo ./aws/install
<span class="hljs-con-meta">$ </span><span class="hljs-con-built_in">which</span> aws
/usr/local/bin/aws
<span class="hljs-con-meta">$ </span>aws --version
aws-cli/2.7.34 Python/3.9.11 Linux/5.15.0-47-generic exe/x86_64.ubuntu.22 prompt/off
</code></pre>
    <p class="normal">Once the AWS CLI is installed, for easier and more secure access, we will create a user and configure the AWS CLI with the <a id="_idIndexMarker818"/>user credentials. Let’s go back to the AWS console and select <strong class="screenText">Identity and Access Management (IAM)</strong> for user and access management:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" src="../Images/B18403_11_03.png"/></figure>
    <p class="packt_figref">Figure 11.3: AWS IAM</p>
    <p class="normal">We can choose <strong class="screenText">Users</strong> on the left panel to create a user:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="../Images/B18403_11_04.png"/></figure>
    <p class="packt_figref">Figure 11.4: AWS IAM users</p>
    <p class="normal">Select <strong class="screenText">Programmatic access</strong> and assign the user to the default administrator group:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B18403_11_05.png"/></figure>
    <p class="packt_figref">Figure 11.5: AWS IAM add user</p>
    <p class="normal">The next step will <a id="_idIndexMarker819"/>add the user to the group; we can add the user to the administrator group for now. We do not need to add any tag for this user. The last step will show an <strong class="screenText">Access key ID</strong> and a <strong class="screenText">Secret access key</strong>. Copy them into a text file and keep it in a safe place:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, application, Teams  Description automatically generated" src="../Images/B18403_11_06.png"/></figure>
    <p class="packt_figref">Figure 11.6: AWS IAM user security credentials</p>
    <p class="normal">We will complete the AWS CLI authentication credential setup via <code class="inlineCode">aws configure</code> in the terminal. We will go over AWS Regions in the upcoming section. We will use <code class="inlineCode">us-east-1</code> for now since that is the Region with the most services. We can always come back to the settings later to change the Region:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>aws configure
AWS Access Key ID [None]: &lt;key&gt;
AWS Secret Access Key [None]: &lt;secret&gt; 
Default region name [None]: us-east-1 
Default output format [None]: json
</code></pre>
    <p class="normal">We will also <a id="_idIndexMarker820"/>install the AWS Python SDK, Boto3 (<a href="https://boto3.readthedocs.io/en/latest/"><span class="url">https://boto3.readthedocs.io/en/latest/</span></a>):</p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ pip install boto3
(venv) $ python
Python 3.10.4 (main, Jun 29 2022, 12:14:53) [GCC 11.2.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
<span class="hljs-con-meta">&gt;&gt;&gt;</span> <span class="hljs-con-keyword">import</span> boto3
<span class="hljs-con-meta">&gt;&gt;&gt;</span> boto3.__version__
'1.24.78'
<span class="hljs-con-meta">&gt;&gt;&gt;</span> exit()
</code></pre>
    <p class="normal">We are now ready to move on to the subsequent sections, starting with an introduction to AWS cloud networking services.</p>
    <h1 class="heading-1" id="_idParaDest-243">AWS network overview</h1>
    <p class="normal">When we discuss <a id="_idIndexMarker821"/>AWS services, we need to start at the top, with Regions and <strong class="keyWord">Availability</strong> <strong class="keyWord">Zones</strong> (<strong class="keyWord">AZs</strong>). They have big <a id="_idIndexMarker822"/>implications for all of our services. At the time of writing this book, AWS has listed 27 geographic Regions and 87 <strong class="keyWord">AZs</strong> worldwide. In the words of AWS Global Cloud Infrastructure (<a href="https://aws.amazon.com/about-aws/global-infrastructure/"><span class="url">https://aws.amazon.com/about-aws/global-infrastructure/</span></a>):</p>
    <blockquote class="packt_quote">
      <p class="quote"> “The AWS Cloud infrastructure is built around Regions and Availability Zones (AZs). AWS Regions provide multiple, physically separated and isolated Availability Zones which are connected with low latency, high throughput, and highly redundant networking.”</p>
    </blockquote>
    <p class="normal">For a nice visualization of AWS Regions that can be filtered by AZ, Region, and so on, please check out <a href="https://aws.amazon.com/about-aws/global-infrastructure/regions_az/"><span class="url">https://aws.amazon.com/about-aws/global-infrastructure/regions_az/</span></a>.</p>
    <p class="normal">Some of the services AWS offers are global (such as the IAM user we created), but most of the services are Region-based. The Regions are geographic footprints, such as US-East, US-West, EU-London, Asia-Pacific-Tokyo, etc. What this means for us is that we should build our infrastructure in a region that is closest to our intended users. This will reduce the latency of the service for our customers. If our users are on the <strong class="keyWord">East</strong> <strong class="keyWord">Coast</strong> of the United States, we should pick <strong class="keyWord">US East (N. Virginia)</strong> or <strong class="keyWord">US East (Ohio)</strong> as our Region if the service is Regional-based:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="../Images/B18403_11_07.png"/></figure>
    <p class="packt_figref">Figure 11.7: AWS Regions</p>
    <p class="normal">Besides user latency, AWS Regions also have both service and cost implications. Users who are new to AWS might find it <a id="_idIndexMarker823"/>surprising that not all services are offered in all Regions. The services we will look at in this chapter are offered in most Regions, but some newer services might only be offered in selected Regions.</p>
    <p class="normal">In the example that follows, we can see that <strong class="screenText">Alexa for Business</strong> and <strong class="screenText">Amazon Chime</strong> are only offered in the Northern Virginia Region in the United States:</p>
    <figure class="mediaobject"><img alt="Text  Description automatically generated with medium confidence" src="../Images/B18403_11_08.png"/></figure>
    <p class="packt_figref">Figure 11.8: AWS services per Region</p>
    <p class="normal">Besides service availability, the cost of an offering might be slightly different between Regions. For example, for <a id="_idIndexMarker824"/>the EC2 service we will look at in this chapter, the cost for an <strong class="keyWord">a1.medium</strong> instance is <strong class="keyWord">USD 0.0255 per hour</strong> in <strong class="keyWord">US East (N. Virginia)</strong>; the same instance costs 14% more, at <strong class="keyWord">USD 0.0291 per hour</strong>, in <strong class="keyWord">EU (Frankfurt)</strong>:</p>
    <figure class="mediaobject"><img alt="Table  Description automatically generated" src="../Images/B18403_11_09.png"/></figure>
    <p class="packt_figref">Figure 11.9: AWS EC2 US East price</p>
    <figure class="mediaobject"><img alt="Table  Description automatically generated" src="../Images/B18403_11_10.png"/></figure>
    <p class="packt_figref">Figure 11.10: AWS EC2 EU price</p>
    <p class="normal">When in doubt, choose US East (N. Virginia); it is the oldest Region and most likely the cheapest, with the most service offerings.</p>
    <p class="normal">Not all Regions are <a id="_idIndexMarker825"/>available to all users. For example, <strong class="keyWord">GovCloud</strong> and the <strong class="keyWord">China</strong> Region are not available to users in the United States by default. You can list the Regions available to you via <code class="inlineCode">aws ec2 describe-regions</code>:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>aws ec2 describe-regions
{
    "Regions": [
        {
            "Endpoint": "ec2.eu-north-1.amazonaws.com",
            "RegionName": "eu-north-1",
            "OptInStatus": "opt-in-not-required"
        },
        {
            "Endpoint": "ec2.ap-south-1.amazonaws.com",
            "RegionName": "ap-south-1",
            "OptInStatus": "opt-in-not-required"
        },
&lt;skip&gt;
</code></pre>
    <p class="normal">As stated by Amazon, all Regions are completely independent of one another. Therefore, most resources are not replicated across Regions. This means that if we have multiple Regions offering the same service, say <strong class="keyWord">US-East</strong> and <strong class="keyWord">US-West</strong>, and need the services to back each other up, we will need to replicate the necessary resources ourselves.</p>
    <p class="normal">We can choose our desired Region in the AWS console, in the top-right corner, with the drop-down menu:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="../Images/B18403_11_11.png"/></figure>
    <p class="packt_figref">Figure 11.11: AWS Regions</p>
    <p class="normal">We can only view the services available within the Region on the portal. For example, if we have EC2 instances in the US East Region and select the US West Region, none of our EC2 instances will show up. I have made this mistake several times and wondered where all of my instances went!</p>
    <p class="normal">There are many AZs within each Region. AZs are labeled using a combination of the Region and an alphabetical letter, such as <code class="inlineCode">us-east-1a</code>, <code class="inlineCode">us-east-1b</code>, and so on. Each Region has multiple AZs – typically three or <a id="_idIndexMarker826"/>more. Each AZ has its isolated infrastructure with a redundant power supply, intra-data center networking, and facilities. All AZs in a Region are connected through low-latency fiber routes that are typically within 100 km of each other within the same Region:</p>
    <figure class="mediaobject"><img alt="Diagram  Description automatically generated" src="../Images/B18403_11_12.png"/></figure>
    <p class="packt_figref">Figure 11.12: AWS Regions and AZs</p>
    <p class="normal">Unlike Regions, many of the resources we build in AWS can be copied across AZs automatically. For example, we can configure our managed relational database (Amazon RDS) to be replicated across AZs. The concept of AZs is very important when it comes to service redundancy, and its constraints are important to us for the network services we will build.</p>
    <p class="normal">AWS independently maps AZs to identifiers for each account. For example, my AZ, <code class="inlineCode">us-east-1a</code>, might not be the same as <code class="inlineCode">us-east-1a</code> for another account, even though they are both labeled as <code class="inlineCode">us-east-1a</code>.</p>
    <p class="normal">We can check the AZs in a Region in the AWS CLI:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>aws ec2 describe-availability-zones --region us-east-1
{
    "AvailabilityZones": [
        {
            "State": "available",
            "Messages": [],
            "RegionName": "us-east-1",
            "ZoneName": "us-east-1a",
            "ZoneId": "use1-az2"
        },
        {
            "State": "available",
            "Messages": [],
            "RegionName": "us-east-1",
            "ZoneName": "us-east-1b",
            "ZoneId": "use1-az4"
        },
&lt;skip&gt;
</code></pre>
    <p class="normal">Why do we care about Regions and AZs so much? As we will see in the coming few sections, AWS networking <a id="_idIndexMarker827"/>services are usually bound by the Region and AZ. A<strong class="keyWord"> virtual private cloud</strong> (<strong class="keyWord">VPC</strong>), for example, must reside <a id="_idIndexMarker828"/>entirely in one Region, and each subnet needs to reside entirely in one AZ. On the other hand, NAT gateways are AZ-bound, so we will need to create one per AZ if we need redundancy.</p>
    <p class="normal">We will go over both services in more detail, but their use cases are offered here as examples of how Regions and AZs are the basis of the AWS network services offering:</p>
    <figure class="mediaobject"><img alt="Table  Description automatically generated" src="../Images/B18403_11_13.png"/></figure>
    <p class="packt_figref">Figure 11.13: VPCs and AZs per Region</p>
    <p class="normal"><strong class="keyWord">AWS edge locations</strong> are part of the <strong class="keyWord">AWS CloudFront</strong> content delivery network in 90+ cities across 48 countries <a id="_idIndexMarker829"/>as of May 2022 (<a href="https://aws.amazon.com/cloudfront/features/"><span class="url">https://aws.amazon.com/cloudfront/features/</span></a>). These edge locations are used to distribute content with low <a id="_idIndexMarker830"/>latency to customers. The edge nodes have a smaller footprint than the full data center Amazon builds for the Region and AZs. Sometimes, people mistake the edge locations’ point-of-presence for full AWS Regions. If the footprint is listed as an edge location, AWS services such as EC2 or S3 will not be offered. We will revisit edge locations in the <strong class="screenText">AWS CloudFront CDN services</strong> section.</p>
    <p class="normal"><strong class="keyWord">AWS transit centers</strong> are one <a id="_idIndexMarker831"/>of the least documented aspects of AWS networks. They were mentioned in James Hamilton’s 2014 AWS re:Invent keynote (<a href="http://www.youtube.com/watch?v=JIQETrFC_SQ"><span class="url">www.youtube.com/watch?v=JIQETrFC_SQ</span></a>) as the aggregation points for different AZs in the Region. To be fair, we do not know if the transit center still exists and functions the same way after all these years. However, it is fair to make an educated guess about the placement of the transit center and its correlation with the AWS Direct Connect service, which we will look at later in this chapter.</p>
    <div class="note">
      <p class="normal">James Hamilton, a VP and distinguished engineer from AWS, is one of the most influential technologists at AWS. If there is anybody whom I would consider authoritative when it comes to AWS networking, it would be him. You can read more about his ideas on his blog, Perspectives, at <a href="https://perspectives.mvdirona.com/"><span class="url">https://perspectives.mvdirona.com/</span></a>.</p>
    </div>
    <p class="normal">It is impossible to cover all of the services related to AWS in one chapter. There are some relevant services not directly related to networking that we do not have the space to cover, but we should be familiar with:</p>
    <ul>
      <li class="bulletList">The IAM service, <a href="https://aws.amazon.com/iam/"><span class="url">https://aws.amazon.com/iam/</span></a>, is the service that enables us to manage <a id="_idIndexMarker832"/>access to AWS services and resources securely.</li>
      <li class="bulletList"><strong class="keyWord">Amazon Resource Names</strong> (<strong class="keyWord">ARNs</strong>), <a href="https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html"><span class="url">https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html</span></a>, uniquely <a id="_idIndexMarker833"/>identify AWS resources across all of AWS. These resource names are important when we need to identify a service, such as DynamoDB and API Gateway, that needs access to our VPC resources.</li>
      <li class="bulletList">Amazon<strong class="keyWord"> Elastic Compute Cloud</strong> (<strong class="keyWord">EC2</strong>), <a href="https://aws.amazon.com/ec2/"><span class="url">https://aws.amazon.com/ec2/</span></a>, is the service that enables <a id="_idIndexMarker834"/>us to obtain and provision compute capacities, such as Linux and Windows instances, via AWS interfaces. We will use EC2 instances throughout this chapter in our examples.</li>
    </ul>
    <p class="normal">For the sake of learning, we <a id="_idIndexMarker835"/>will exclude the AWS GovCloud (US) and China Regions, neither of which uses the AWS global infrastructure, and each has its own unique features and limitations.</p>
    <p class="normal">This was a relatively long introduction to AWS network services, but an important one. These concepts and terms will be referred to in the rest of the chapters. In the upcoming section, we will look at the most important concept (in my opinion) in AWS networking: VPC.</p>
    <h1 class="heading-1" id="_idParaDest-244">Virtual Private Cloud</h1>
    <p class="normal"><strong class="keyWord">Amazon VPC</strong> (<a href="https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html"><span class="url">https://docs.aws.amazon.com/vpc/latest/userguide/what-is-amazon-vpc.html</span></a>) enables customers <a id="_idIndexMarker836"/>to launch AWS resources in a virtual network dedicated to the <a id="_idIndexMarker837"/>customer’s account. It is truly a customizable network that allows you to define your IP address range, add and delete subnets, create routes, add VPN gateways, associate security policies, connect EC2 instances to your own data center, and much more.</p>
    <p class="normal">In the early days, when VPC was unavailable, all EC2 instances in an AZ were on a single, flat network that was shared among all customers. How comfortable would the customer be with putting their information in the cloud? Not very, I’d imagine. Between the launch of EC2 in 2007 and the launch of VPC in 2009, VPC functions were some of the most requested features of AWS.</p>
    <p class="normal">The packets leaving your EC2 host in a VPC are intercepted by the Hypervisor. The Hypervisor will check the packets against a mapping service that understands your VPC construct. Then, the packets are encapsulated with the real AWS servers’ source and destination addresses. The encapsulation and mapping service enables the flexibility of VPC but also some of the limitations (multicast, sniffing) of VPC. This is, after all, a virtual network.</p>
    <p class="normal">Since December 2013, all EC2 instances are VPC-only; you can no longer create an EC2 instance that is non-VPC (EC2-Classic), nor would you want to. If we use a launch wizard to create our EC2 instance, it will automatically be put into a default VPC with a virtual internet gateway for public access. In my opinion, only the most basic use cases should use the default VPC. In most cases, we should define our own non-default, customized VPC.</p>
    <p class="normal">Let’s create the following VPC using the AWS console in <strong class="keyWord">us-east-1</strong>:</p>
    <figure class="mediaobject"><img alt="Diagram  Description automatically generated" src="../Images/B18403_11_14.png"/></figure>
    <p class="packt_figref">Figure 11.14: Our ﬁrst VPC in US-East-1</p>
    <p class="normal">If you recall, VPC is AWS Region-bound, and the subnets are AZ-based. Our first VPC will be based in <code class="inlineCode">us-east-1</code>; the three subnets <a id="_idIndexMarker838"/>will be allocated to two different AZs in <code class="inlineCode">us-east-1a</code> and <code class="inlineCode">us-east-1b</code>.</p>
    <p class="normal">Using the AWS console to create the VPC and subnets is pretty straightforward, and AWS provides several good tutorials online. I have listed the steps with the associated locations of each on the VPC dashboard:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="../Images/B18403_11_15.png"/></figure>
    <p class="packt_figref">Figure 11.15: Steps for creating the VPC, subnet, and other features</p>
    <p class="normal">The first two steps are point-and-click processes that most network engineers can work through, even without <a id="_idIndexMarker839"/>prior experience. By default, the VPC only contains the local route, <code class="inlineCode">10.0.0.0/16</code>. Now, we will create an internet gateway and associate it with the VPC:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" src="../Images/B18403_11_16.png"/></figure>
    <p class="packt_figref">Figure 11.16: AWS internet gateway-to-VPC assignment</p>
    <p class="normal">We can then create a custom route table with a default route pointing to the internet gateway, allowing internet access. We will associate this route table with our subnet in <code class="inlineCode">us-east-1a</code>, <code class="inlineCode">10.0.0.0/24</code>, thus allowing the VPC to have internet access:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="../Images/B18403_11_17.png"/></figure>
    <p class="packt_figref">Figure 11.17: Route table</p>
    <p class="normal">Let’s use the <a id="_idIndexMarker840"/>Boto3 Python SDK to see what we have created; I used <code class="inlineCode">mastering_python_networking_demo</code> as the tag for the VPC, which we can use as the filter:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-keyword">import</span> json, boto3
region = 'us-east-<span class="hljs-number">1</span>'
vpc_name = 'mastering_python_networking_demo'
ec2 = boto3.resource('ec2', region_name=region)
client = boto3.client('ec2')
filters = [{'Name':'tag:Name', 'Values':[vpc_name]}]
vpcs = <span class="hljs-built_in">list</span>(ec2.vpcs.<span class="hljs-built_in">filter</span>(Filters=filters))
<span class="hljs-keyword">for</span> vpc <span class="hljs-keyword">in</span> vpcs:
    response = client.describe_vpcs(
                 VpcIds=[vpc.<span class="hljs-built_in">id</span>,]
                )
    <span class="hljs-built_in">print</span>(json.dumps(response, sort_keys=<span class="hljs-literal">True</span>, indent=<span class="hljs-number">4</span>))
</code></pre>
    <p class="normal">This script will allow us to query the Region for the VPC we created programmatically:</p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ python Chapter11_1_query_vpc.py
{
    " ResponseMetadata " : {
        &lt;skip&gt;
        " HTTPStatusCode " : 200,
        " RequestId " : " 9416b03f-&lt;skip&gt; " ,
        " RetryAttempts " : 0
    },
    " Vpcs " : [
        {
            " CidrBlock " : " 10.0.0.0/16 ",
            " CidrBlockAssociationSet " : [
                {
                    " AssociationId " : " vpc-cidr-assoc-&lt;skip&gt; ",
                    "CidrBlock": "10.0.0.0/16",
                    "CidrBlockState": {
                        "State": "associated"
                    }
                }
            ],
            "DhcpOptionsId": "dopt-&lt;skip&gt;",
            "InstanceTenancy": "default",
            "IsDefault": false,
            "OwnerId": "&lt;skip&gt;",
            "State": "available",
            "Tags": [
                {
                    "Key": "Name",
                    "Value": "mastering_python_networking_demo"
                }
            ],
            "VpcId": "vpc-&lt;skip&gt;"
        }
    ]
}
</code></pre>
    <p class="normal">The <a id="_idIndexMarker841"/>Boto3 VPC API documentation can be found at <a href="https://boto3.readthedocs.io/en/latest/reference/services/ec2.html#vpc"><span class="url">https://boto3.readthedocs.io/en/latest/reference/services/ec2.html#vpc</span></a>.</p>
    <p class="normal">If we created EC2 instances and put them in different subnets as is, the hosts would be able to reach each other across subnets. You may be wondering how the subnets can reach one another within the VPC since we only created an internet gateway in subnet 1a. In a physical network, the network needs to connect to a router to reach beyond its own local network.</p>
    <p class="normal">It is not so different in VPC, except it is an <strong class="keyWord">implicit router</strong> with a default routing table of the local network, which in <a id="_idIndexMarker842"/>our example is <code class="inlineCode">10.0.0.0/16</code>. This implicit router was created when we created our VPC. Any subnet that is not associated with a custom routing table is associated with the main table.</p>
    <h2 class="heading-2" id="_idParaDest-245">Route tables and route targets</h2>
    <p class="normal">Routing is one of the most important topics in network engineering. It is worth looking at how it is done in AWS VPC more <a id="_idIndexMarker843"/>closely. We’ve already seen that we had an <a id="_idIndexMarker844"/>implicit router and the main routing table when we created the VPC. In the last example, we created an internet gateway, a custom routing table with a default route pointing to the internet gateway using the route target, and we associated the custom routing table with a subnet.</p>
    <p class="normal">So far, only the concept of the route target is where VPC is a bit different than traditional networking. We can roughly equate the route target with the next hop in traditional routing.</p>
    <p class="normal">In summary:</p>
    <ul>
      <li class="bulletList">Each VPC has an implicit router</li>
      <li class="bulletList">Each VPC has the main routing table with the local route populated</li>
      <li class="bulletList">You can create custom-routing tables</li>
      <li class="bulletList">Each subnet can follow a custom-routing table or the default main routing table</li>
      <li class="bulletList">The route table route target can be an internet gateway, NAT gateway, VPC peers, and so on</li>
    </ul>
    <p class="normal">We can use Boto3 to look at the custom route tables and associations with the subnets in <code class="inlineCode">Chapter11_2_query_route_tables.py</code>:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-keyword">import</span> json, boto3
region = 'us-east-<span class="hljs-number">1</span>'
vpc_name = 'mastering_python_networking_demo'
ec2 = boto3.resource('ec2', region_name=region)
client = boto3.client('ec2')
response = client.describe_route_tables()
<span class="hljs-built_in">print</span>(json.dumps(response['RouteTables'][<span class="hljs-number">0</span>], sort_keys=<span class="hljs-literal">True</span>, indent=<span class="hljs-number">4</span>))
</code></pre>
    <p class="normal">The main routing table is implicit and not returned by the API. Since we only have one custom route table, this is what we will see:</p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ python Chapter11_2_query_route_tables.py
{
    " Associations " : [
        &lt;skip&gt;
    ],
    " OwnerId " : " &lt;skip&gt; ",
    " PropagatingVgws " : [],
    " RouteTableId " : " rtb-&lt;skip&gt; ",
    " Routes " : [
        {
            "DestinationCidrBlock": "10.0.0.0/16",
            "GatewayId": "local",
            "Origin": "CreateRouteTable",
            "State": "active"
        },
        {
            "DestinationCidrBlock": "0.0.0.0/0",
            "GatewayId": "igw-041f287c",
            "Origin": "CreateRoute",
            "State": "active"
        }
    ],
    "Tags": [
        {
            "Key": "Name",
            "Value": "public_internet_gateway"
        }
    ],
    "VpcId": "vpc-&lt;skip&gt;"
}
</code></pre>
    <p class="normal">We already created the <a id="_idIndexMarker845"/>first public subnet. We will create two more private <a id="_idIndexMarker846"/>subnets, <code class="inlineCode">us-east-1b</code> and <code class="inlineCode">us-east-1c</code>, following the same steps. The result will be three subnets: a <code class="inlineCode">10.0.0.0/24</code> public subnet in <code class="inlineCode">us-east-1a</code>, and <code class="inlineCode">10.0.1.0/24</code> and <code class="inlineCode">10.0.2.0/24</code> private subnets in <code class="inlineCode">us-east-1b</code> and <code class="inlineCode">us-east-1c</code>, respectively.</p>
    <p class="normal">We now have a working VPC with three subnets: one public and two private. So far, we have used the AWS CLI and the Boto3 library to interact with AWS VPC. Let’s take a look at another automation tool from AWS, <strong class="keyWord">CloudFormation</strong>.</p>
    <h2 class="heading-2" id="_idParaDest-246">Automation with CloudFormation</h2>
    <p class="normal">AWS CloudFormation (<a href="https://aws.amazon.com/cloudformation/"><span class="url">https://aws.amazon.com/cloudformation/</span></a>) is one way in which we can use a text file to <a id="_idIndexMarker847"/>describe and launch the <a id="_idIndexMarker848"/>resource that we need. We can use CloudFormation to <a id="_idIndexMarker849"/>provision another VPC in the <strong class="keyWord">us-west-1</strong> Region:</p>
    <figure class="mediaobject"><img alt="Diagram  Description automatically generated" src="../Images/B18403_11_18.png"/></figure>
    <p class="packt_figref">Figure 11.18: VPC for us-west-1</p>
    <p class="normal">The CloudFormation template can be in YAML or JSON; we will use YAML for our first template for provisioning, <code class="inlineCode">Chapter10_3_cloud_formation.yml</code>:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr">AWSTemplateFormatVersion:</span> <span class="hljs-string">'2010-09-09'</span>
<span class="hljs-attr">Description:</span> <span class="hljs-string">Create</span> <span class="hljs-string">VPC</span> <span class="hljs-string">in</span> <span class="hljs-string">us-west-1</span>
<span class="hljs-attr">Resources:</span>
  <span class="hljs-attr">myVPC:</span>
    <span class="hljs-attr">Type:</span> <span class="hljs-string">AWS::EC2::VPC</span>
    <span class="hljs-attr">Properties:</span>
      <span class="hljs-attr">CidrBlock:</span> <span class="hljs-string">'10.1.0.0/16'</span>
      <span class="hljs-attr">EnableDnsSupport:</span> <span class="hljs-string">'false'</span>
      <span class="hljs-attr">EnableDnsHostnames:</span> <span class="hljs-string">'false'</span>
      <span class="hljs-attr">Tags:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">Key:</span> <span class="hljs-string">Name</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">Value:</span> <span class="hljs-string">'mastering_python_networking_demo_2'</span>
</code></pre>
    <p class="normal">We can execute the template via the AWS CLI. Notice that we specify the <code class="inlineCode">us-west-1</code> region in our execution:</p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ aws --region us-west-1 cloudformation create-stack --stack-name 'mpn-ch10-demo' --template-body file://Chapter11_3_cloud_formation.yml
{
"StackId": "arn:aws:cloudformation:us-west-1:&lt;skip&gt;:stack/mpn-ch10- demo/&lt;skip&gt;"
}
</code></pre>
    <p class="normal">We can verify the status via the AWS CLI:</p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ aws --region us-west-1 cloudformation describe-stacks --stack-name mpn-ch10-demo
{
    "Stacks": [
        {
            "StackId": "arn:aws:cloudformation:us-west-1:&lt;skip&gt;:stack/mpn-ch10-demo/bbf5abf0-8aba-11e8-911f-500cadc9fefe",
            "StackName": "mpn-ch10-demo",
            "Description": "Create VPC in us-west-1",
            "CreationTime": "2018-07-18T18:45:25.690Z",
            "LastUpdatedTime": "2018-07-18T19:09:59.779Z",
            "RollbackConfiguration": {},
            "StackStatus": "UPDATE_ROLLBACK_COMPLETE",
            "DisableRollback": false,
            "NotificationARNs": [],
            "Tags": [],
            "EnableTerminationProtection": false,
            "DriftInformation": {
                "StackDriftStatus": "NOT_CHECKED"
            }
        }
    ]
}
</code></pre>
    <p class="normal">The last CloudFormation template created a VPC without any subnet. Let’s delete that VPC and use the following <a id="_idIndexMarker850"/>template, <code class="inlineCode">Chapter11_4_cloud_formation_full.yml</code>, to create both the VPC and the subnet. Notice that we will not have the <a id="_idIndexMarker851"/>VPC-ID before VPC creation, so we will use a special variable to reference the VPC-ID in the subnet creation. This same technique can be used for other resources, such as the routing table and internet gateway:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-attr">AWSTemplateFormatVersion:</span> <span class="hljs-string">'2010-09-09'</span>
<span class="hljs-attr">Description:</span> <span class="hljs-string">Create</span> <span class="hljs-string">subnet</span> <span class="hljs-string">in</span> <span class="hljs-string">us-west-1</span>
<span class="hljs-attr">Resources:</span>
  <span class="hljs-attr">myVPC:</span>
    <span class="hljs-attr">Type:</span> <span class="hljs-string">AWS::EC2::VPC</span>
    <span class="hljs-attr">Properties:</span>
      <span class="hljs-attr">CidrBlock:</span> <span class="hljs-string">'10.1.0.0/16'</span>
      <span class="hljs-attr">EnableDnsSupport:</span> <span class="hljs-string">'false'</span>
      <span class="hljs-attr">EnableDnsHostnames:</span> <span class="hljs-string">'false'</span>
      <span class="hljs-attr">Tags:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">Key:</span> <span class="hljs-string">Name</span>
          <span class="hljs-attr">Value:</span> <span class="hljs-string">'mastering_python_networking_demo_2'</span>
  <span class="hljs-attr">mySubnet:</span>
    <span class="hljs-attr">Type:</span> <span class="hljs-string">AWS::EC2::Subnet</span>
    <span class="hljs-attr">Properties:</span>
      <span class="hljs-attr">VpcId:</span> <span class="hljs-type">!Ref</span> <span class="hljs-string">myVPC</span>
      <span class="hljs-attr">CidrBlock:</span> <span class="hljs-string">'</span><span class="hljs-string">10.1.0.0/24'</span>
      <span class="hljs-attr">AvailabilityZone:</span> <span class="hljs-string">'us-west-1a'</span>
      <span class="hljs-attr">Tags:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">Key:</span> <span class="hljs-string">Name</span>
          <span class="hljs-attr">Value:</span> <span class="hljs-string">'mpn_demo_subnet_1'</span>
</code></pre>
    <p class="normal">We can execute and verify the creation of the resources as follows:</p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ aws --region us-west-1 cloudformation create-stack --stack-name mpn-ch10-demo-2 --template-body file://Chapter11_4_cloud_formation_full.yml
{
"StackId": "arn:aws:cloudformation:us-west-1:&lt;skip&gt;:stack/mpn-ch10- demo-2/&lt;skip&gt;"
}
<span class="hljs-con-meta">$ </span>aws --region us-west-1 cloudformation describe-stacks --stack-name mpn- ch10-demo-2
{
"Stacks": [
{
"StackStatus": "CREATE_COMPLETE",
...
"StackName": "mpn-ch10-demo-2", "DisableRollback": false
}
]
}
</code></pre>
    <p class="normal">We can verify <a id="_idIndexMarker852"/>the VPC and subnet <a id="_idIndexMarker853"/>information from the AWS console. Remember to pick the right Region from the drop-down menu in the top right-hand corner:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="../Images/B18403_11_19.png"/></figure>
    <p class="packt_figref">Figure 11.19: VPC in us-west-1</p>
    <p class="normal">We can also take a look at the subnet:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="../Images/B18403_11_20.png"/></figure>
    <p class="packt_figref">Figure 11.20: Subnet in us-west-1</p>
    <p class="normal">We now have <a id="_idIndexMarker854"/>two VPCs on the two coasts of the <a id="_idIndexMarker855"/>United States. They are currently behaving like two islands, each by themselves. This may or may not be your desired state of operation. If we want the two VPCs to be <a id="_idIndexMarker856"/>connected, we can use VPC peering (<a href="https://docs.aws.amazon.com/AmazonVPC/latest/PeeringGuide/vpc-peering-basics.html"><span class="url">https://docs.aws.amazon.com/AmazonVPC/latest/PeeringGuide/vpc-peering-basics.html</span></a>) to allow direct communication.</p>
    <p class="normal">There are a few VPC peering limitations, such as no overlapping IPv4 or IPv6 CIDR blocks being allowed. There are also additional limitations for inter-region VPC peering. Make sure you look over the documentation.</p>
    <p class="normal">VPC peering is not limited <a id="_idIndexMarker857"/>to the same account. You can connect VPCs across different accounts, as long as the request was accepted and the other aspects (security, routing, and DNS name) are taken care of.</p>
    <p class="normal">In the upcoming section, we will take a look at VPC security groups and network <strong class="keyWord">access control lists</strong> (<strong class="keyWord">ACLs</strong>).</p>
    <h2 class="heading-2" id="_idParaDest-247">Security Groups and Network ACLs</h2>
    <p class="normal">AWS <strong class="keyWord">Security Groups</strong> and <strong class="keyWord">Network ACLs</strong> can <a id="_idIndexMarker858"/>be found <a id="_idIndexMarker859"/>under the <strong class="keyWord">Security</strong> section of your VPC:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="../Images/B18403_11_21.png"/></figure>
    <p class="packt_figref">Figure 11.21: VPC security</p>
    <p class="normal">A security group is a stateful virtual firewall that controls inbound and outbound access to resources. Most of the time, we use <a id="_idIndexMarker860"/>a security group to limit public access to our EC2 instance. The current limitation is 500 security groups in each VPC. Each security group can contain up to 50 inbound and 50 outbound rules.</p>
    <p class="normal">You can use <a id="_idIndexMarker861"/>the following sample script, <code class="inlineCode">Chapter11_5_security_group.py</code>, to <a id="_idIndexMarker862"/>create a security group and two simple ingress rules:</p>
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-keyword">import</span> boto3
ec2 = boto3.client(<span class="hljs-string">'ec2'</span>)
response = ec2.describe_vpcs()
vpc_id = response.get(<span class="hljs-string">'Vpcs'</span>, [{}])[<span class="hljs-number">0</span>].get(<span class="hljs-string">'VpcId'</span>, <span class="hljs-string">''</span>)
<span class="hljs-comment"># Query for security group id</span>
response = ec2.create_security_group(GroupName=<span class="hljs-string">'mpn_security_group'</span>,
                                     Description=<span class="hljs-string">'mpn_demo_sg'</span>,
                                     VpcId=vpc_id)
security_group_id = response[<span class="hljs-string">'GroupId'</span>]
data = ec2.authorize_security_group_ingress(
    GroupId=security_group_id,
    IpPermissions=[
        {<span class="hljs-string">'IpProtocol'</span>: <span class="hljs-string">'tcp'</span>,
         <span class="hljs-string">'FromPort'</span>: <span class="hljs-number">80</span>,
         <span class="hljs-string">'ToPort'</span>: <span class="hljs-number">80</span>,
         <span class="hljs-string">'IpRanges'</span>: [{<span class="hljs-string">'CidrIp'</span>: <span class="hljs-string">'0.0.0.0/0'</span>}]},
        {<span class="hljs-string">'IpProtocol'</span>: <span class="hljs-string">'tcp'</span>,
         <span class="hljs-string">'FromPort'</span>: <span class="hljs-number">22</span>,
         <span class="hljs-string">'ToPort'</span>: <span class="hljs-number">22</span>,
         <span class="hljs-string">'IpRanges'</span>: [{<span class="hljs-string">'CidrIp'</span>: <span class="hljs-string">'0.0.0.0/0'</span>}]}
    ])
<span class="hljs-built_in">print</span>(<span class="hljs-string">'Ingress Successfully Set %s'</span> % data)
<span class="hljs-comment"># Describe security group</span>
<span class="hljs-comment">#response = ec2.describe_security_groups(GroupIds=[security_group_id])</span>
<span class="hljs-built_in">print</span>(security_group_id)
</code></pre>
    <p class="normal">We can execute the script and receive confirmation of the creation of the security group, which can be associated with other AWS resources:</p>
    <pre class="programlisting con"><code class="hljs-con">(venv) $ python Chapter11_5_security_group.py
Ingress Successfully Set {'ResponseMetadata': {'RequestId': '&lt;skip&gt;', 'HTTPStatusCode': 200, 'HTTPHeaders': {'server': 'AmazonEC2', 'content- type': 'text/xml;charset=UTF-8', 'date': 'Wed, 18 Jul 2018 20:51:55 GMT',
'content-length': '259'}, 'RetryAttempts': 0}} sg-&lt;skip&gt;
</code></pre>
    <p class="normal">Network <strong class="keyWord">ACLs</strong> are an additional layer of security that is stateless. Each subnet in the VPC is associated <a id="_idIndexMarker863"/>with a network ACL. Since an ACL is stateless, you will need to specify both inbound and outbound rules.</p>
    <p class="normal">The important differences between security groups and ACLs are as follows:</p>
    <ul>
      <li class="bulletList">Security groups <a id="_idIndexMarker864"/>operate at <a id="_idIndexMarker865"/>the network interface level, whereas ACLs operate at the subnet level.</li>
      <li class="bulletList">For a security group, we can only specify <code class="inlineCode">allow</code> rules and not <code class="inlineCode">deny</code> rules, whereas ACLs support both <code class="inlineCode">allow</code> and <code class="inlineCode">deny</code> rules.</li>
      <li class="bulletList">A security group is stateful, so return traffic is automatically allowed; return traffic in ACLs must be specifically allowed.</li>
    </ul>
    <p class="normal">Let’s look at one <a id="_idIndexMarker866"/>of the coolest features of AWS networking: Elastic IP. When <a id="_idIndexMarker867"/>I initially learned about Elastic IPs, I was blown away by their ability to assign and reassign IP addresses dynamically.</p>
    <h2 class="heading-2" id="_idParaDest-248">Elastic IP</h2>
    <p class="normal">An <strong class="keyWord">Elastic IP</strong> (<strong class="keyWord">EIP</strong>) is a way to <a id="_idIndexMarker868"/>use a public IPv4 address <a id="_idIndexMarker869"/>that’s reachable from the internet.</p>
    <div class="note">
      <p class="normal">IPv6 is not currently supported in EIP as of late 2022.</p>
    </div>
    <p class="normal">An EIP can be dynamically assigned to an EC2 instance, network interface, or other resources. A few characteristics of an EIP are as follows:</p>
    <ul>
      <li class="bulletList">An EIP is associated <a id="_idIndexMarker870"/>with the account and is region-specific. For example, an EIP in <code class="inlineCode">us-east-1</code> can only be associated with resources in <code class="inlineCode">us-east-1</code>.</li>
      <li class="bulletList">You can disassociate an EIP from a resource and re-associate it with a different resource. This flexibility can sometimes be used to ensure high availability. For example, you can migrate from a smaller EC2 instance to a larger EC2 instance by reassigning the same IP address from the small EC2 instance to the larger one.</li>
      <li class="bulletList">There is a small hourly charge associated with EIPs.</li>
    </ul>
    <p class="normal">You can request an EIP from the portal. After the assignment, you can associate it with the desired resources:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" src="../Images/B18403_11_22.png"/></figure>
    <p class="packt_figref">Figure 11.22: Elastic IPs</p>
    <p class="normal">Unfortunately, EIPs are limited to five per Region to discourage waste (<a href="https://docs.aws.amazon.com/vpc/latest/userguide/amazon-vpc-limits.html"><span class="url">https://docs.aws.amazon.com/vpc/latest/userguide/amazon-vpc-limits.html</span></a>). However, this number can be increased via a ticket to AWS Support if needed.</p>
    <p class="normal">In the upcoming <a id="_idIndexMarker871"/>section, we will look at how we can use NAT gateways to <a id="_idIndexMarker872"/>allow communication for private subnets with the internet.</p>
    <h2 class="heading-2" id="_idParaDest-249">NAT gateways</h2>
    <p class="normal">To allow the hosts in our EC2 public subnet to be accessed from the internet, we can allocate an EIP and associate it <a id="_idIndexMarker873"/>with the network interface of the EC2 host. However, at the time of writing, there <a id="_idIndexMarker874"/>is a limit of five Elastic IPs per EC2-VPC (<a href="https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Appendix_Limits.html#vpc-limits-eips"><span class="url">https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Appendix_Limits.html#vpc-limits-eips</span></a>). Sometimes, it would be nice to allow the host in a private subnet outbound access when needed, without creating a permanent one-to-one mapping between the EIP and the EC2 host.</p>
    <p class="normal">A <strong class="keyWord">NAT gateway</strong> can help by allowing the hosts in the private subnet temporary outbound access by performing NAT. This operation is similar to <strong class="keyWord">port address translation</strong> (<strong class="keyWord">PAT</strong>), which we normally perform on the <a id="_idIndexMarker875"/>corporate firewall. To use a NAT gateway, we can perform the following steps:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Create a NAT gateway in a subnet with access to the internet gateway via the AWS CLI, Boto3 library, or AWS console. The NAT gateway will need to be assigned an EIP.</li>
      <li class="numberedList">Point the default route in the private subnet to the NAT gateway.</li>
      <li class="numberedList">The NAT gateway will follow the default route to the internet gateway for external access.</li>
    </ol>
    <p class="normal">This operation can be illustrated in the following diagram:</p>
    <figure class="mediaobject"><img alt="Diagram  Description automatically generated" src="../Images/B18403_11_23.png"/></figure>
    <p class="packt_figref">Figure 11.23: NAT gateway operations</p>
    <p class="normal">One of the most common questions about NAT gateways typically involves which subnet the NAT gateway should <a id="_idIndexMarker876"/>reside in. The rule of thumb is to remember that the NAT gateway needs <a id="_idIndexMarker877"/>public access. Therefore, it should be created in the subnet with public internet access with an available EIP assigned to it:</p>
    <figure class="mediaobject"><img alt="Graphical user interface  Description automatically generated" src="../Images/B18403_11_24.png"/></figure>
    <p class="packt_figref">Figure 11.24: NAT gateway creation</p>
    <div class="note">
      <p class="normal">Please remember to remove any of the AWS services you are not using to avoid charges. </p>
    </div>
    <p class="normal">In the upcoming section, we will look at how to connect our shiny virtual network in AWS to our physical network.</p>
    <h1 class="heading-1" id="_idParaDest-250">Direct Connect and VPN</h1>
    <p class="normal">Up to this point, our VPC has been a self-contained network that resides in the AWS network. It is flexible and functional, but to access the resources inside the VPC, we will need to access them with their internet-facing services, such as SSH and HTTPS.</p>
    <p class="normal">In this section, we will look at the ways AWS allows us to connect to the VPC from our private network: an IPSec VPN gateway and Direct Connect.</p>
    <h2 class="heading-2" id="_idParaDest-251">VPN gateways</h2>
    <p class="normal">The first way to <a id="_idIndexMarker878"/>connect our on-premises network to VPC is with traditional IPSec VPN connections. We will need a publicly accessible device to establish VPN connections to AWS’s VPN devices.</p>
    <p class="normal">The customer gateway needs to support route-based IPSec VPNs, where the VPN connection is treated as <a id="_idIndexMarker879"/>a connection that a routing protocol and normal user traffic can traverse. Currently, AWS recommends using <strong class="keyWord">Border Gateway Protocol</strong> (<strong class="keyWord">BGP</strong>) to exchange routes.</p>
    <p class="normal">On the VPC side, we <a id="_idIndexMarker880"/>can follow a similar routing table where we can route a particular subnet toward the <strong class="keyWord">virtual private gateway</strong> (<strong class="keyWord">VPG</strong>) target:</p>
    <figure class="mediaobject"><img alt="Diagram  Description automatically generated" src="../Images/B18403_11_25.png"/></figure>
    <p class="packt_figref">Figure 11.25: VPC VPN connection</p>
    <p class="normal">Besides an IPSec VPN, we can also use a dedicated circuit to connect, which is termed <strong class="keyWord">Direct Connect</strong>.</p>
    <h2 class="heading-2" id="_idParaDest-252">Direct Connect</h2>
    <p class="normal">The IPSec VPN connection we looked at is an easy way to provide connectivity for on-premises equipment to AWS <a id="_idIndexMarker881"/>cloud resources. However, it suffers the same faults that IPSec over the internet always does: it is unreliable, and we have very little control over its reliability. There is <a id="_idIndexMarker882"/>very little performance monitoring and no <strong class="keyWord">service-level agreement</strong> (<strong class="keyWord">SLA</strong>) until the connection reaches a part of the internet that we can control.</p>
    <p class="normal">For all of these reasons, any production-level, mission-critical traffic is more likely to traverse through the second option Amazon provides, that is, AWS Direct Connect. AWS Direct Connect lets customers connect their data center and colocation to their AWS VPC with a dedicated virtual circuit.</p>
    <p class="normal">The somewhat difficult part of this operation is usually bringing our network to where we can connect with AWS physically, typically in a carrier hotel.</p>
    <p class="normal">You can find a list of the AWS Direct Connect locations here: <a href="https://aws.amazon.com/directconnect/details/"><span class="url">https://aws.amazon.com/directconnect/details/</span></a>. The Direct Connect link is just a fiber patch connection that you can order from the particular carrier hotel to patch the network to a network port and configure the dot1q trunk’s connectivity.</p>
    <p class="normal">There are also <a id="_idIndexMarker883"/>increasingly more connectivity options for Direct Connect via a third-party carrier with <strong class="keyWord">Multi-Protocol Label Switching</strong> (<strong class="keyWord">MPLS</strong>) circuits and aggregated links. One of the most <a id="_idIndexMarker884"/>affordable options that I found and use is Equinix Cloud Exchange Fabric (<a href="https://www.equinix.com/services/interconnection-connectivity/cloud-exchange/"><span class="url">https://www.equinix.com/services/interconnection-connectivity/cloud-exchange/</span></a>). By using Equinix Cloud Exchange Fabric, we can leverage the same circuit and <a id="_idIndexMarker885"/>connect to different cloud providers at a fraction of the cost of dedicated circuits:</p>
    <figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="../Images/B18403_11_26.png"/></figure>
    <p class="packt_figref">Figure 11.26: Equinix Cloud Exchange Fabric</p>
    <p class="normal">In the upcoming section, we will look at some of the network scaling services AWS offers.</p>
    <h1 class="heading-1" id="_idParaDest-253">Network scaling services</h1>
    <p class="normal">Many <a id="_idIndexMarker886"/>of the network services AWS offers do not have direct network implications, such as DNS and content distribution networks. They are relevant in our discussion due to their close relationship with the network and the application’s performance.</p>
    <h2 class="heading-2" id="_idParaDest-254">Elastic Load Balancing</h2>
    <p class="normal"><strong class="keyWord">Elastic Load Balancing</strong> (<strong class="keyWord">ELB</strong>) allows incoming traffic from the internet to be automatically distributed across <a id="_idIndexMarker887"/>multiple EC2 instances. Like load balancers in the <a id="_idIndexMarker888"/>physical world, this allows us to have better redundancy and fault tolerance while reducing the per-server load. ELB comes in two flavors: application and network load balancing.</p>
    <p class="normal">The network load balancer handles web traffic via <strong class="keyWord">HTTP</strong> and <strong class="keyWord">HTTPS</strong>; the application load balancer operates on <a id="_idIndexMarker889"/>a TCP level. If your application runs on <strong class="keyWord">HTTP</strong> or <strong class="keyWord">HTTPS</strong>, it is generally a <a id="_idIndexMarker890"/>good idea to go with the Application Load Balancer. Otherwise, using the Network Load Balancer is a good bet.</p>
    <p class="normal">A detailed comparison <a id="_idIndexMarker891"/>of the application and Network Load Balances can be found at <a href="https://aws.amazon.com/elasticloadbalancing/details/"><span class="url">https://aws.amazon.com/elasticloadbalancing/details/</span></a>:</p>
    <figure class="mediaobject"><img alt="Table  Description automatically generated" src="../Images/B18403_11_27.png"/></figure>
    <p class="packt_figref">Figure 11.27: ELB comparison</p>
    <p class="normal">ELB offers a way to load balance traffic once it enters the resource in our Region. The AWS Route 53 DNS service <a id="_idIndexMarker892"/>allows geographic load balancing <a id="_idIndexMarker893"/>between Regions, sometimes <a id="_idIndexMarker894"/>called Global Server Load Balancing.</p>
    <h2 class="heading-2" id="_idParaDest-255">Route 53 DNS service</h2>
    <p class="normal">We all know what domain name services are – Route 53 is AWS’s DNS service. Route 53 is a full-service domain <a id="_idIndexMarker895"/>registrar where you can purchase and manage <a id="_idIndexMarker896"/>domains directly from AWS. Regarding network services, DNS allows a way to load balance between geographic regions using service domain names in a round-robin fashion between Regions.</p>
    <p class="normal">We need the following items before we can use DNS for load balancing:</p>
    <ul>
      <li class="bulletList">A load balancer in each of the intended load balance Regions</li>
      <li class="bulletList">A registered domain name. We do not need Route 53 to be the domain registrar</li>
      <li class="bulletList">Route 53 is the DNS service for the domain</li>
    </ul>
    <p class="normal">We can then use the Route 53 latency-based routing policy with a health check in an active-active environment <a id="_idIndexMarker897"/>between the two elastic load balancers. In the <a id="_idIndexMarker898"/>next section, we will focus on the content delivery network built by AWS, called CloudFront.</p>
    <h2 class="heading-2" id="_idParaDest-256">CloudFront CDN services</h2>
    <p class="normal">CloudFront is Amazon’s <strong class="keyWord">content delivery network</strong> (<strong class="keyWord">CDN</strong>), which <a id="_idIndexMarker899"/>reduces the latency of <a id="_idIndexMarker900"/>content delivery by physically serving the content closer to <a id="_idIndexMarker901"/>the customer. The content can be static web page <a id="_idIndexMarker902"/>content, videos, applications, APIs, or, most recently, Lambda functions. CloudFront edge locations include the existing AWS Regions and many other locations around the globe. The high-level operation of CloudFront is as follows:</p>
    <ol class="numberedList" style="list-style-type: decimal;">
      <li class="numberedList" value="1">Users access your website for one or more objects.</li>
      <li class="numberedList">DNS routes the request to the Amazon CloudFront edge location closest to the user’s request.</li>
      <li class="numberedList">The CloudFront edge location will either service the content via the cache or request the object from the origin.</li>
    </ol>
    <p class="normal">AWS CloudFront and CDN services, in general, are typically handled by application developers or DevOps engineers. However, it is always good to be aware of their operations.</p>
    <h1 class="heading-1" id="_idParaDest-257">Other AWS network services</h1>
    <p class="normal">There are lots of <a id="_idIndexMarker903"/>other AWS network services that we do not have the space to cover here. Some of the more popular services are listed in this section:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">AWS Transit VPC</strong> (<a href="https://aws.amazon.com/blogs/aws/aws-solution-transit-vpc/"><span class="url">https://aws.amazon.com/blogs/aws/aws-solution-transit-vpc/</span></a>): This is a way to <a id="_idIndexMarker904"/>connect multiple VPCs to a common VPC that serves as a transit center. This is a relatively new service, but it can minimize <a id="_idIndexMarker905"/>the number of connections that you need to set up and manage. This can also serve as a tool when you need to share resources between separate AWS accounts.</li>
      <li class="bulletList"><strong class="keyWord">Amazon GuardDuty</strong> (<a href="https://aws.amazon.com/guardduty/"><span class="url">https://aws.amazon.com/guardduty/</span></a>): This is a managed threat detection <a id="_idIndexMarker906"/>service that continuously monitors for malicious or <a id="_idIndexMarker907"/>unauthorized behavior to help protect our AWS workloads. It monitors API calls or potentially unauthorized deployments.</li>
      <li class="bulletList"><strong class="keyWord">AWS WAF</strong> (<a href="https://aws.amazon.com/waf/"><span class="url">https://aws.amazon.com/waf/</span></a>): This is a web application firewall that helps protect web <a id="_idIndexMarker908"/>applications from common exploits. We can define <a id="_idIndexMarker909"/>customized web security rules to allow or block web traffic.</li>
      <li class="bulletList"><strong class="keyWord">AWS Shield</strong> (<a href="https://aws.amazon.com/shield/"><span class="url">https://aws.amazon.com/shield/</span></a>): This is <a id="_idIndexMarker910"/>a managed <strong class="keyWord">Distributed Denial of Service</strong> (<strong class="keyWord">DDoS</strong>) protection <a id="_idIndexMarker911"/>service that safeguards applications <a id="_idIndexMarker912"/>running on AWS. The protection service is free for all customers at the basic level; the advanced version of AWS Shield is a fee-based service.</li>
    </ul>
    <p class="normal">There are lots of new and exciting AWS networking services constantly being announced, such as the ones we have looked at in this section. Not all of them are foundational services such as VPC or NAT gateways; however, they all serve useful purposes in their respective fields.</p>
    <h1 class="heading-1" id="_idParaDest-258">Summary</h1>
    <p class="normal">In this chapter, we looked at AWS cloud networking services. We reviewed the AWS network definitions of Region, Availability Zone, edge locations, and transit center. Understanding the overall AWS network gives us a good idea of some of the limitations and constraints of the other AWS network services. Throughout this chapter, we used the AWS CLI, the Python Boto3 library, and CloudFormation to automate some tasks.</p>
    <p class="normal">We covered AWS VPC in depth, with the configuration of the route table and route targets. The example on security groups and network ACLs took care of the security for our VPC. We also looked at EIPs and NAT gateways for allowing external access.</p>
    <p class="normal">There are two ways to connect AWS VPC to on-premise networks: Direct Connect and IPSec VPN. We briefly looked at each and the advantages of using them. Toward the end of this chapter, we looked at network scaling services offered by AWS, including ELB, Route 53 DNS, and CloudFront.</p>
    <p class="normal">In the next chapter, we will look at the networking services offered by another public cloud provider, Microsoft Azure.</p>
    <h1 class="heading-1">Join our book community</h1>
    <p class="normal">To join our community for this book – where you can share feedback, ask questions to the author, and learn about new releases – follow the QR code below:</p>
    <p class="normal"><a href="https://packt.link/networkautomationcommunity"><span class="url">https://packt.link/networkautomationcommunity</span></a></p>
    <p class="normal"><img alt="" src="../Images/QR_Code2903617220506617062.png"/></p>
  </div>
</body></html>