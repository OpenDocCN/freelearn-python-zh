<html><head></head><body><div><div><h1 id="_idParaDest-374"><em class="italic"><a id="_idTextAnchor379"/></em><a href="B16119_13_Final_PD_ePub.xhtml#_idTextAnchor379"><em class="italic">Chapter 13</em></a>: Creating Web and Portal Frontend Features</h1>
			<p>Odoo is a business application framework, providing all the tools necessary to quickly build apps. A uniform web client provides the business user interface. But organizations are not isolated from the world. Being able to also interact with external users is needed to support efficient processes. For this, Odoo supports a web interface.</p>
			<p>The internal user web<a id="_idIndexMarker1046"/> client is sometimes referred to as the <strong class="bold">backend</strong>, and the<a id="_idIndexMarker1047"/> external user interface as the <strong class="bold">frontend</strong>. The frontend provides <strong class="bold">portal features</strong>, accessible to portal user<a id="_idIndexMarker1048"/> logins. It also provides public features, accessible without<a id="_idIndexMarker1049"/> the need for a login, referred as <strong class="bold">website features</strong>.</p>
			<p>The portal complements backend apps, providing self-service features to external users, such as viewing and paying for their orders, or submitting a support ticket.</p>
			<p>The website features<a id="_idIndexMarker1050"/> are built on top of the Odoo <strong class="bold">Content Management System</strong> (<strong class="bold">CMS</strong>), which allows you to build web pages, including easy-to-use <em class="italic">drag and drop</em> web page design tools. Additional website features are provided as <strong class="bold">modules</strong>, such as blogs, online jobs, or e-commerce.</p>
			<p>In this chapter, you will learn how to develop frontend add-on modules, leveraging the website features provided by Odoo, while discussing the following topics:</p>
			<ul>
				<li>Introducing the library portal learning project</li>
				<li>Creating a frontend web page</li>
				<li>Learning about web controllers</li>
				<li>Adding portal features</li>
			</ul>
			<p>By the end of this chapter, you will have learned how to use web controllers and QWeb templates to create dynamic web pages, integrated into the Odoo frontend. Additionally, you will learn how to leverage the Odoo portal module, adding your features to it.</p>
			<h1 id="_idParaDest-375"><a id="_idTextAnchor380"/>Technical requirements</h1>
			<p>The work in this chapter requires the <code>library_checkout</code> add-on module, last edited in <a href="B16119_11_Final_PD_ePub.xhtml#_idTextAnchor324"><em class="italic">Chapter 11</em></a>, <em class="italic">Kanban Views and Client-Side QWeb</em>. The add-on module and its dependencies code can be found in the Git repository at https://github.com/PacktPublishing/Odoo-15-Development-Essentials. The code in this chapter can be found in the same repository.</p>
			<h1 id="_idParaDest-376"><a id="_idTextAnchor381"/>Introducing the library portal learning project</h1>
			<p>To learn about Odoo web page development, a new project will be used. The library app can use self-service features for library<a id="_idIndexMarker1051"/> members. Members can be assigned a user login to have access to their book checkout requests.</p>
			<p>The <code>library_portal</code> add-on module will be created for these portal self-service features.</p>
			<p>The first file to add is the manifest, <code>library_portal/__manifest__.py</code>, which you can create with the following code:</p>
			<pre>{
  "name": "Library Portal",
  "description": "Portal for library members",
  "author": "Daniel Reis",
  "license": "AGPL-3",
  "depends": [
      "library_checkout", "portal"
  ],
  "data": [
    "security/library_security.xml",
    "security/ir.model.access.csv",
    "views/checkout_portal_templates.xml",
  ],
}</pre>
			<p>The module depends on <code>library_checkout</code> to extend its features. It also depends on the <code>portal</code> module, providing the foundation for portal features. The <code>website</code> module provides CMS features, and can also be used for web page development. However, the <code>portal</code> modules can provide essential frontend features without the need to have the <em class="italic">Website</em> app installed.</p>
			<p>The <code>data</code> key lists three XML files to be used. The first two are security related, and give portal users the access needed to be able to view the checkout requests. The last XML file will have the QWeb templates for the portal user interface.</p>
			<p>An empty <code>library_portal/__init__.py</code> file is also needed for the module directory to be a valid Python module, as required by the Odoo framework.</p>
			<p>Now that the new module has the essential<a id="_idIndexMarker1052"/> files, the next step is to add the basic components needed to have a functioning web page.</p>
			<h1 id="_idParaDest-377"><a id="_idTextAnchor382"/>Creating a frontend web page</h1>
			<p>To get started with the basics of Odoo<a id="_idIndexMarker1053"/> web development, a simple web page will be created. To do<a id="_idIndexMarker1054"/> this, two components are needed: a <strong class="bold">web controller</strong>, triggered when a particular URL is accessed, and a <strong class="bold">QWeb template</strong>, to generate the HTML to be presented<a id="_idIndexMarker1055"/> by that URL.</p>
			<p>The web page used to showcase this is a book catalog, a simple list of the books in the library. The book catalog page will be accessible at <code>http://localhost:8069/library/catalog</code>.</p>
			<p>The following screenshot provides an example of what should be seen:</p>
			<div><div><img src="img/Figure_13.1_B16119.jpg" alt="Figure 13.1 – Book catalog frontend web page&#13;&#10;" width="972" height="380"/>
				</div>
			</div>
			<p class="figure-caption">Figure 13.1 – Book catalog frontend web page</p>
			<p>The first step is to add the web controller, which we will do in the next section.</p>
			<h2 id="_idParaDest-378"><a id="_idTextAnchor383"/>Adding a web controller</h2>
			<p>Web controllers<a id="_idIndexMarker1056"/> are Python objects, used to implement web features. They<a id="_idIndexMarker1057"/> can link URL paths to an object method, so that when that URL is accessed, the method is executed.</p>
			<p>For example, for the <code>http://localhost:8069/library/catalog</code> URL, the accessed path is <code>/library/catalog</code>.</p>
			<p>A URL path, sometimes<a id="_idIndexMarker1058"/> also called an <code>@http.route</code> method decorator in an <code>http.Controller</code> object.</p>
			<p>To create<a id="_idIndexMarker1060"/> the route for <code>/library/catalog</code>, perform the following steps:</p>
			<ol>
				<li>The controller Python code will be added in the <code>controllers</code> subdirectory. In the <code>library_portal</code> module directory, edit the <code>__init__.py</code> file to import that subdirectory:<pre>from . import controllers</pre></li>
				<li>Add the <code>controllers/__init__.py</code> file to import the Python file with the controller code, which will be in a <code>main.py</code> file:<pre>from . import main</pre></li>
				<li>Add the actual<a id="_idIndexMarker1061"/> controller file, <code>controllers/main.py</code>, with the following<a id="_idIndexMarker1062"/> code:<pre>from odoo import http
class Main(http.Controller): 
    @http.route("/library/catalog", 
      auth="public", website=True)
    def catalog(self, **kwargs):
        Book = http.request.env["library.book"]
        books = Book.sudo().search([])
        return http.request.render(
            "library_portal.book_catalog",
              {"books": books},
        )</pre></li>
			</ol>
			<p>Having done these steps, the controller component is done, and is able to process requests for the <code>/library/catalog</code> route.</p>
			<p>The <code>odoo.http</code> module provides the Odoo web-related features. The web controllers, responsible for page rendering, should be objects inheriting from the <code>odoo.http.Controller</code> class. The actual name used for the class is not important. In the previous code, the controller class name is <code>Main()</code>.</p>
			<p>The <code>catalog()</code> method, in the <code>Main()</code> class, is decorated with <code>@http.route</code>, binding it to one or more URL routes. Here, the <code>catalog()</code> method is triggered by the <code>/library/catalog route</code>. It also uses the <code>auth="public"</code> argument, meaning that this route is accessible without requiring authentication. And the <code>website=true</code> argument means that this page will use the web frontend layout, and ensures some needed additional variables are made available.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">Using <code>website=True</code> does not require the <em class="italic">Website</em> app to be installed. It also works with base Odoo frontend web pages.</p>
			<p>These <code>catalog()</code> route method is expected to do some processing and then return the HTML page to the user's web browser.</p>
			<p>The <code>http.request</code> object is automatically set with the web request, and has available the <code>.env</code> attribute, to access the Odoo environment. This can be used to instantiate Odoo models. The example code does this to access the <code>library.book</code> model and then build a record set with all books available.</p>
			<p>The route method runs as the user who is logged in, or as the Public special user if no user is logged in and the route allows public access. Since the Public user has very limited access, <code>sudo()</code> might be needed to ensure that the data to be presented can be retrieved.</p>
			<p>The final line returns the result of <code>http.request.render()</code>. This prepares a QWeb template to be rendered. The two arguments are the template XML ID, <code>library_portal.book_catalog</code> in this case, and a dictionary<a id="_idIndexMarker1063"/> with the variables to make available to the QWeb rendering<a id="_idIndexMarker1064"/> context. In this case, a <code>books</code> variable is made available, set with a books record set.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">The <code>http.request.render()</code> function returns a Odoo <code>http.response</code> object, containing the instructions on what to render. The actual processing of the QWeb template into HTML is delayed until all web controller code is run and the response is ready to be sent to the client. This allows for the route method to be extended and, for example, the <code>qcontext</code> attribute, holding the dictionary to be used for the QWeb rendering, to be modified.</p>
			<p>The controller is ready, but the QWeb template used needs to be created before it can work. The next section takes care of that.</p>
			<h2 id="_idParaDest-379"><a id="_idTextAnchor384"/>Adding a QWeb template</h2>
			<p>QWeb templates are XML snippets<a id="_idIndexMarker1065"/> containing HTML code and QWeb directives<a id="_idIndexMarker1066"/> that can dynamically modify the output depending on conditions. The book catalog web page needs a QWeb template to render the HTML to be presented.</p>
			<p>To add the <code>library_portal.book_catalog</code> QWeb template, perform<a id="_idIndexMarker1067"/> the following steps:</p>
			<ol>
				<li value="1">A new XML data file, <code>views/main_templates.xml</code>, will be used to declare the template. Add that to the <code>__manifest__.py</code> module file, in the <code>data</code> key:<pre>  "data": [
    "views/main_templates.xml",
  ]</pre></li>
				<li>Add the XML data file with the QWeb template, <code>views/main_templates.xml</code>:<pre>&lt;odoo&gt;
<strong class="bold">&lt;template id="book_catalog" name="Book List"&gt;</strong>
  <strong class="bold">&lt;t t-call="web.frontend_layout"&gt;</strong>
    <strong class="bold">&lt;t t-set="title"&gt;Book Catalog&lt;/t&gt;</strong>
      &lt;div class="oe_structure"&gt;
        &lt;div class="container"&gt;
          &lt;h1 class="h1-book-catalog"&gt;
            Book Catalog&lt;/h1&gt;
          &lt;table class="table"&gt;
            &lt;thead&gt;
              &lt;tr&gt;
                &lt;th scope="col"&gt;Title&lt;/th&gt;
                &lt;th scope="col"&gt;Published&lt;/th&gt;
                &lt;th scope="col"&gt;Publisher&lt;/th&gt;
              &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody&gt;
      &lt;t t-foreach="books" t-as="book"&gt;
        &lt;tr scope="row"&gt;
          &lt;td&gt;&lt;span t-field="book.name" /&gt;&lt;/td&gt;
          &lt;td&gt;&lt;span t-field="book.date_published" 
              /&gt;&lt;/td&gt;
          &lt;td&gt;&lt;span t-field="book.publisher_id" 
              /&gt;&lt;/td&gt;
        &lt;/tr&gt;
      &lt;/t&gt;
            &lt;/tbody&gt;
          &lt;/table&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/t&gt;
&lt;/template&gt;
&lt;/odoo&gt;</pre></li>
			</ol>
			<p>This completes the steps needed to get the QWeb template ready.</p>
			<p>The previous code declares the <code>book_catalog</code> template. It is a Bootstrap table, with three columns. The <code>&lt;thead&gt;</code> section declares<a id="_idIndexMarker1068"/> the columns headers, and the <code>&lt;t t-foreach&gt;</code> QWeb directive<a id="_idIndexMarker1069"/> renders a table row for each book in the <code>books</code> record set.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">QWeb templates are XML. The XML language has stricter rules than regular HTML, which, for example, tolerates opening tags that are not closed. This is not allowed in XML, and therefore in QWeb templates. To be precise, QWeb templates follow the XHTML requirements.</p>
			<p>Important in this template is the first directive, <code>&lt;t t-call="web.frontend_layout"&gt;</code>. This is what makes the template HTML be rendered as an Odoo frontend web page, including page headers and footers. For this layout to be used, the controller route must include the <code>website=True</code> argument.</p>
			<p class="callout-heading">Tip</p>
			<p class="callout">The website data passed into the QWeb evaluation context is set by the <code>_prepare_qcontext</code> method of the <code>ir.ui.view</code> model. For example, the <code>website</code> module adds variables to it, in the <code>models/ir_ui_view.py</code> file.</p>
			<p><code>&lt;t t-set="title"&gt;</code> is also noteworthy. It is used by the frontend layout to set the browser tab title.</p>
			<p>When we have both the controller and the QWeb template in place, once the <code>library_portal</code> module is installed or upgraded, opening <code>http://localhost:8069/library/catalog</code> with a web browser should display a table with the library's books.</p>
			<p>These are the key components used to implement<a id="_idIndexMarker1070"/> frontend web pages. Note that the <em class="italic">Website</em> app can be used to have more<a id="_idIndexMarker1071"/> frontend features available, but is not required.</p>
			<p>Being a web page, it may also need to use additional assets. The next section explains this.</p>
			<h2 id="_idParaDest-380"><a id="_idTextAnchor385"/>Adding CSS and JavaScript assets</h2>
			<p>When designing web pages, the HTML code<a id="_idIndexMarker1072"/> is often complemented with CSS or JavaScript, which are best<a id="_idIndexMarker1073"/> provided as additional assets.</p>
			<p>Assets to load are declared in the head section of the page. Odoo has specific QWeb templates in charge of loading assets. In particular, the <code>web.assets_backend</code> and <code>web.assets_frontend</code> provide the assets needed specifically for backend web client and frontend web pages. <code>web.assets_common</code> provides assets common to both.</p>
			<p>To have additional assets loaded, the appropriate template needs to be extended.</p>
			<p>For example, in the book catalog page, the title could be presented using a larger font size. This can be done by declaring a style in a CSS file, which is then used in the <code>&lt;h1&gt;</code> element. In fact, the book catalog QWeb template is already using <code>&lt;h1 class="h1-book-catalog"&gt;</code>, applying a custom style.</p>
			<p>To add this custom style, perform the following steps: </p>
			<ol>
				<li value="1">Create the <code>static/src/css/library.css</code> file with the following content:<pre>.h1-book-catalog {
    font-size: 62px;
}</pre></li>
				<li>This CSS must be loaded by frontend web pages. For this, the <code>web.assets_frontend</code> template should be extended. Add to the <code>__manifest__.py</code> file the following code:<pre>    "assets": {
        "web.assets_backend": {
            "library_portal/static/src/css/
              library.css",
        }
    }</pre></li>
			</ol>
			<p>This describes how a module can add web assets. These assets will usually be <code>.js</code>, <code>.css</code>, or <code>.scss</code> files.</p>
			<p class="callout-heading">Changes in Odoo 15</p>
			<p class="callout">Web assets were previously added using an XML file, extending an QWeb template, such as <code>web.assets_backend</code> or <code>web.assets_frontend</code>. An example for this is provided in <a href="B16119_11_Final_PD_ePub.xhtml#_idTextAnchor324"><em class="italic">Chapter 11</em></a>, <em class="italic">Kanban Views and Client-Side QWeb</em>, in the <em class="italic">Adding CSS and JavaScript assets</em> section.</p>
			<p>The basics for creating<a id="_idIndexMarker1074"/> a frontend web page have been described, and involve<a id="_idIndexMarker1075"/> three key components: web controllers, QWeb templates, and web assets.</p>
			<p>QWeb templates and their syntax have been thoroughly described in <a href="B16119_11_Final_PD_ePub.xhtml#_idTextAnchor324"><em class="italic">Chapter 11</em></a>, <em class="italic">Kanban Views and Client-Side QWeb</em>, and <a href="B16119_12_Final_PD_ePub.xhtml#_idTextAnchor358"><em class="italic">Chapter 12</em></a>, <em class="italic">Creating Printable PDF Reports with Server-Side QWeb</em>.</p>
			<p>But web controllers are worth more attention, and a deeper description of their features. The following section will provide this.</p>
			<h1 id="_idParaDest-381"><a id="_idTextAnchor386"/>Understanding web controllers</h1>
			<p>Web controllers are the server-side components<a id="_idIndexMarker1076"/> responsible for responding when an Odoo web path is accessed, usually triggering the rendering of a web page.</p>
			<p>A web path, such as <code>/library/catalog</code>, is assigned<a id="_idIndexMarker1077"/> to a route, triggering a <code>request</code> object, and the result is a <code>response</code> object, with the details to return to the client.</p>
			<h2 id="_idParaDest-382"><a id="_idTextAnchor387"/>Declaring routes</h2>
			<p>The <code>http.route</code> decorator<a id="_idIndexMarker1078"/> is used to assign a method to a web path. These are the arguments<a id="_idIndexMarker1079"/> available:</p>
			<ul>
				<li><code>route</code>, usually provided as a positional argument, is a string, or a list of strings, with the paths to map. Method arguments can be extracted from the path. The syntax to express these arguments is detailed in the next section.</li>
				<li><code>type</code>, to specify the type of request. By default, this is <code>http</code>, and can also be set to <code>json</code>.</li>
				<li><code>auth</code> is the authentication type required. It can be one of <code>user</code>, <code>public</code>, or <code>none</code>. The <code>user</code> option requires a login to allow access, <code>public</code> allows anonymous access, through the public user, and <code>none</code> is useful in special cases, where an Odoo database is not needed, such as authentication endpoints.</li>
			</ul>
			<p>These are the arguments that can be used on <code>route</code> decorators. The next section explains the syntax to extract values from the main argument, to be passed to the decorated method.</p>
			<h2 id="_idParaDest-383"><a id="_idTextAnchor388"/>Extracting argument values from the route string</h2>
			<p>The <code>&lt;type:name&gt;</code>. For example, <code>&lt;int:partner_id&gt;</code> extracts an integer value, and passes it to the<a id="_idIndexMarker1080"/> method as the <code>partner_id</code> keyword argument. Record instances are also supported, using the <code>model(&lt;model name&gt;)</code> syntax. For example, <code>&lt;model('res.partner'):partner&gt;</code> extracts a partner<a id="_idIndexMarker1081"/> record, passed to the method with the <code>partner</code> keyword argument.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">More information on route path formatting<a id="_idIndexMarker1082"/> can be found in the official Werkzeug documentation at <a href="https://werkzeug.palletsprojects.com/routing/">https://werkzeug.palletsprojects.com/routing/</a>.</p>
			<p>The URL parameters are passed<a id="_idIndexMarker1083"/> to the decorated method as keyword arguments. These parameters are after the <code>?</code> character<a id="_idIndexMarker1084"/> in a <code>GET</code> request, or submitted by a <code>POST</code> request. For example, the <code>http://localhost:8069/mypage</code><code>x</code> set to <code>1</code> and <code>y</code> set to <code>2</code>.</p>
			<p class="callout-heading">Tip</p>
			<p class="callout">Adding to routed methods the <code>**kw</code> generic keyword argument capture prevents it from erroring if an unexpected argument is added to the URL. For example, without it, accessing <code>http://localhost:8069/library/catalog</code><code>**kw</code> on the method arguments, it would be captured in the <code>kw</code> variable, and could be ignored by the method code.</p>
			<p>The routed method return value can be any of the following:</p>
			<ul>
				<li>A <strong class="bold">falsy</strong> value, resulting in a <em class="italic">204 No Content</em> HTTP code response.</li>
				<li>A text string, used to return a response with that text as the HTML content.</li>
				<li>A <code>response</code> object, usually created with the <code>render()</code> method.</li>
			</ul>
			<p>Next, let's learn how the <code>request</code> object can be used in a routed method.</p>
			<h2 id="_idParaDest-384"><a id="_idTextAnchor389"/>Using the request object</h2>
			<p>A <code>request</code> object is automatically instanced when a client web request is <a id="_idIndexMarker1085"/>made to the Odoo server. It is made available by importing <code>odoo.http.request</code>.</p>
			<p>The following are the most important<a id="_idIndexMarker1086"/> attributes provided by this object:</p>
			<ul>
				<li><code>env</code> is an Odoo <code>Environment</code> object, similar to what <code>self.env</code> provides in regular model methods.</li>
				<li><code>context</code> is a dictionary-like <code>Mapping</code> object with the execution context. It is similar to model method context.</li>
				<li><code>cr</code> is a PostgreSQL cursor object for the Odoo database.</li>
				<li><code>db</code> is the database name.</li>
				<li><code>session</code> is an object storing the session details, including authentication.</li>
				<li><code>params</code> stores the request<a id="_idIndexMarker1087"/> parameters. It is usually not useful, since the parameters are already provided as arguments to the method.</li>
				<li><code>csrf_token(time_limit=None)</code> is a method to generate a CSRF token for the current session. The <code>time_limit</code> is the token validity period in seconds. The default, <code>None</code>, makes it valid for the whole session duration. This attribute is used, for example, to set a CSRF token for HTML forms.</li>
			</ul>
			<p>For <code>http</code> type requests, the following methods are also available:</p>
			<ul>
				<li><code>make_response(data, headers=None, cookies=None)</code> can be used to craft non-HTML responses.</li>
				<li><code>not_found(description=None)</code> returns a <em class="italic">404 Not Found</em> HTTP code.</li>
				<li><code>render(template, qcontext=None, lazy=True, **kw)</code> returns a QWeb template to render. The actual template rendering is delayed until the final dispatch to the client, and so it can be modified by inheriting methods.</li>
			</ul>
			<p>Request objects provide<a id="_idIndexMarker1088"/> a way to access the Odoo environment and all the information about the request made by the client. The next relevant object to understand is the <code>response</code>, to be sent back to the client initiating the request.</p>
			<h2 id="_idParaDest-385"><a id="_idTextAnchor390"/>Using the response object</h2>
			<p>The <code>response</code> object is used to dispatch the final HTTP message to send to<a id="_idIndexMarker1089"/> the client. When extending routed methods, it might be the case that the <code>response</code> returned by the parent <code>super()</code> method needs modifications.</p>
			<p>The following is available on the <code>response</code> object:</p>
			<ul>
				<li><code>template</code> is the name of the template to render.</li>
				<li><code>qcontext</code> is a dictionary with the data to make available for the template rendering.</li>
				<li><code>uid</code> is an integer with the ID of the user rendering the template. If not set, the current user running the method code is used.</li>
				<li><code>render()</code> is the same rendering method also available in the <code>request</code> object.</li>
				<li><code>flatten()</code> forces the rendering of the template.</li>
			</ul>
			<p>The response object also supports the parameters provided by the parent library, <code>werkzeug.wrappers.Response</code>. The corresponding documentation can be found at <a href="https://werkzeug.palletsprojects.com/wrappers/#werkzeug.wrappers.Response">https://werkzeug.palletsprojects.com/wrappers/#werkzeug.wrappers.Response</a>.</p>
			<p>You now have a good idea about the web development components. Odoo also provides a portal useful to interact with external users and the next section explains how to add features to it.</p>
			<h1 id="_idParaDest-386"><a id="_idTextAnchor391"/>Adding portal features</h1>
			<p>The Odoo portal feature<a id="_idIndexMarker1090"/> make information available to interact with external users. Different apps can add features to the portal. For example, the <strong class="bold">Sales</strong> app adds the ability for customers to check their orders, and even pay for them.</p>
			<p>Portal users need to be created, providing access to the portal. This is done on the corresponding contact record in the <strong class="bold">Action</strong> context menu, with the <strong class="bold">Grant portal access</strong> option, as shown in <em class="italic">Figure 13.2</em>:</p>
			<div><div><img src="img/Figure_13.2_B16119.jpg" alt="Figure 13.2 – The Grant portal access option on a contact record&#13;&#10;" width="1090" height="610"/>
				</div>
			</div>
			<p class="figure-caption">Figure 13.2 – The Grant portal access option on a contact record</p>
			<p>Once the user goes through the sign-up process, they can log in to Odoo and see a <strong class="bold">My Account</strong> option when<a id="_idIndexMarker1091"/> clicking on the username in the top right corner. This option opens the portal home page, presenting a summary of all the documents available to the user.</p>
			<p>The documents available depend on the apps installed. <em class="italic">Figure 13.3</em> shows an example of what the portal home page looks like:</p>
			<div><div><img src="img/Figure_13.3_B16119.jpg" alt="Figure 13.3 – Portal page with book checkouts feature&#13;&#10;" width="979" height="448"/>
				</div>
			</div>
			<p class="figure-caption">Figure 13.3 – Portal page with book checkouts feature</p>
			<p>The <code>library_portal</code> module adds the <strong class="bold">Book Checkouts</strong> item to the portal <strong class="bold">Documents</strong>, as seen in <em class="italic">Figure 13.3</em>. This is the result<a id="_idIndexMarker1092"/> of what will be implemented in this section.</p>
			<p>The work for this will be split into three parts: access security, controllers, and QWeb templates. Each of the following sections will address one of these steps. You will start by setting the portal access security configuration.</p>
			<h2 id="_idParaDest-387"><a id="_idTextAnchor392"/>Configuring access security for the portal users</h2>
			<p>Before portal users can access<a id="_idIndexMarker1093"/> app data, the necessary access rights need to be given<a id="_idIndexMarker1094"/> to the portal user group, <code>base.group_portal group</code>.</p>
			<p>In the case of the library app, portal users should be given read-only access to the book, member, checkout, and stage models. Furthermore, each portal user should only be able to see their own member record and checkouts. For this, both access rights and record rules need to be added.</p>
			<p>To configure the access security for portal users, perform the following steps:</p>
			<ol>
				<li value="1">Create the <code>security/ir.model.access.csv</code> file, adding read access to the library models, with the following content:<pre>id,name,model_id:id,group_id:id,perm_read,perm_write,perm_create,perm_unlink
access_book_portal,Book Portal Access,<strong class="bold">library_app.model_library_book</strong>,base.group_portal,1,0,0,0
access_member_portal,Member Portal Access,<strong class="bold">library_member.model_library_member</strong>,base.group_portal,1,0,0,0
access_stage_portal,Checkout Stage Portal Access,<strong class="bold">library_checkout.model_library_checkout_stage</strong>,base.group_portal,1,0,0,0
access_checkout_portal,Checkout Portal Access,<strong class="bold">library_checkout.model_library_checkout</strong>,base.group_portal,1,0,0,0
access_checkout_portal_line,Checkout Portal Line Access,<strong class="bold">library_checkout.model_library_checkout_line</strong>,base.group_portal,1,0,0,0</pre></li>
				<li>Create the <code>security/library_security.xml</code> file with <strong class="bold">record rules</strong>, limiting the records<a id="_idIndexMarker1095"/> portal that users will be<a id="_idIndexMarker1096"/> able to access:<pre>&lt;odoo&gt;
  &lt;data noupdate="1"&gt;
    &lt;record id="member_portal_rule" model="ir.rule"&gt;
      &lt;field name="name"&gt;
        Library Member Portal Access&lt;/field&gt;
      &lt;field name="model_id" 
             ref=
               "library_member.model_library_member"/&gt;
      &lt;field name="domain_force"
        &gt;[('partner_id', '=', 
         user.partner_id.id)]&lt;/field&gt;
      &lt;field name="groups" 
        eval="[(4,ref('base.group_portal'))]"/&gt;
    &lt;/record&gt;
    &lt;record id="checkout_portal_rule" model="ir.rule"&gt;
      &lt;field name="name"&gt;
        Library Checkout Portal Access&lt;/field&gt;
      &lt;field name="model_id"
         ref=
           "library_checkout.model_library_checkout"/&gt;
      &lt;field name="domain_force"
        &gt;[('member_id.partner_id', '=', 
           user.partner_id.id)]&lt;/field&gt;
      &lt;field name="groups"
             eval="[(4,ref('base.group_portal'))]"/&gt;
    &lt;/record&gt;
  &lt;/data&gt;
&lt;/odoo&gt;</pre></li>
				<li>Finally, add these data files<a id="_idIndexMarker1097"/> to the <code>data</code> key in the<a id="_idIndexMarker1098"/> module <code>__manifest__.py</code> file:<pre>  "data": [
<strong class="bold">    "security/ir.model.access.csv",</strong>
<strong class="bold">    "security/library_security.xml",</strong>
    "views/assets.xml",
    "views/main_templates.xml",
  ],</pre></li>
			</ol>
			<p>The record rules created apply filters based on the current user partner record, <code>user.partner_id.id</code>. The members are filtered using the <code>partner_id</code> field, and the checkouts are filtered using the <code>member_id.partner_id</code> field.</p>
			<p>After this, and a module upgrade, portal users will have the access rights needed to use the library portal pages.</p>
			<p class="callout-heading">Tip</p>
			<p class="callout">It is often the case that web controllers avoid the need to have access rights added, by using <code>sudo()</code> to get elevated access, which is sure to have access to the data. While convenient, the usage of <code>sudo()</code> should be carefully considered, and avoided if possible. It is more secure to implement access security on the model layer, using ACLs and record rules, instead of relying on the controller logic for that.</p>
			<p>Having the necessary<a id="_idIndexMarker1099"/> access rights<a id="_idIndexMarker1100"/> configured, the next step is to add the checkouts item to the portal main list.</p>
			<h2 id="_idParaDest-388"><a id="_idTextAnchor393"/>Adding a portal document type to the main list</h2>
			<p>Accessing the portal <strong class="bold">My Account</strong> page shows several document types available, such as <strong class="bold">sales orders</strong> and <strong class="bold">invoices</strong>, and the number of <a id="_idIndexMarker1101"/>items for each.</p>
			<p>The <code>library_portal</code> module should add the <strong class="bold">Book Checkouts</strong> option to the <strong class="bold">My Account</strong> page. Perform the following steps for that:</p>
			<ol>
				<li value="1">Edit the <code>controllers/__init__.py</code> file to import the Python file with the controller code, which will be in the <code>portal.py</code> file:<pre>from . import main
<strong class="bold">from . import portal</strong></pre></li>
				<li>Add the controller file, <code>controllers/portal.py</code>, with the following code:<pre>from odoo.http import route, request
from odoo.addons.portal.controllers import portal
class CustomerPortal(portal.CustomerPortal):
    def _prepare_home_portal_values(self, counters):
        values = super()
          ._prepare_home_portal_values(counters)
        if "book_checkout_count" in counters:
            count = 
           request.env[
            "library.checkout"].search_count([])
            values["book_checkout_count"] = count
        return values</pre><p>This extends the <code>CustomerPortal</code> controller, provided by the <code>portal</code> Odoo module. The previous code extends the <code>_prepare_home_portal_values()</code> method, responsible for calculating the document counters. It adds the <code>book_checkout_count</code> key to the result values, set with the checkout count.</p></li>
				<li>Add the QWeb<a id="_idIndexMarker1102"/> template file, <code>views/portal_templates.py</code>, with the following code:<pre>&lt;odoo&gt;
    &lt;template id="portal_my_home" 
      inherit_id="portal.portal_my_home"
        name="Show Book Checkouts" priority="100"
        customize_show="True"&gt;
        &lt;xpath expr="//div[hasclass('o_portal_docs')]"
            position="inside"&gt;
            &lt;t t-call="portal.portal_docs_entry"&gt;
                &lt;t t-set="title"&gt;Book Checkouts&lt;/t&gt;
                &lt;t t-set="url" 
                  t-value="'/my/book-checkouts'"/&gt;
                &lt;t t-set="placeholder_count"
                   t-value="'book_checkout_count'"/&gt;
            &lt;/t&gt;
        &lt;/xpath&gt;
    &lt;/template&gt;
&lt;/odoo&gt;</pre><p>This extends the <code>portal.portal_my_home</code> template, responsible for rendering the <code>portal.portal_docs_entry</code> template should be used to render each document item. It uses three variables: the <code>title</code>, the <code>url</code> to navigate to when clicked, and the <code>placeholder_count</code>, with the counter identifier<a id="_idIndexMarker1103"/> provided by the <code>_prepare_home_portal_values</code> function.</p></li>
				<li>Finally, add the new data file to <code>__manifest__.py</code>:<pre>  "data": [
    "security/library_security.xml",
    "security/ir.model.access.csv",
    "views/assets.xml",
    "views/main_templates.xml",
<strong class="bold">    "views/portal_templates.xml",</strong>
  ],</pre></li>
			</ol>
			<p>The previous steps add the <code>/my/book-checkouts</code> page, but this hasn't been implemented<a id="_idIndexMarker1104"/> yet. The next section will do this in a portal-friendly way.</p>
			<h2 id="_idParaDest-389"><a id="_idTextAnchor394"/>Adding a portal document list page</h2>
			<p>The <strong class="bold">My Account</strong> home page lists the various <a id="_idIndexMarker1105"/>document types available. Clicking the document type link should open the list of documents available.</p>
			<p><em class="italic">Figure 13.4</em> shows what the document list page should look like:</p>
			<div><div><img src="img/Figure_13.4_B16119.jpg" alt="Figure 13.4 – Portal document list page for book checkouts&#13;&#10;" width="972" height="389"/>
				</div>
			</div>
			<p class="figure-caption">Figure 13.4 – Portal document list page for book checkouts</p>
			<p>The portal provides base features to be used for these document list pages, such as record paging, filters, and sort options.</p>
			<p>The previous example showed how to add a document type to the portal home page. Next, the document list needs to be implemented. Continuing with the code from the previous section, two steps are needed:</p>
			<ol>
				<li value="1">Edit the controller file, <code>controllers/portal.py</code>, to add the code for the <code>/my/book-checkouts</code> route, which will render the <code>my_book_checkouts</code> template.</li>
				<li>Edit the QWeb template file, <code>views/portal_templates.py</code>, to add the <code>my_book_checkouts</code> template for the book checkout <a id="_idIndexMarker1106"/>list page.</li>
			</ol>
			<p>The code to add to <code>controllers/portal.py</code> is the following:</p>
			<pre>    @route(
      ["/my/book-checkouts", "/my/book-checkouts/
          page/&lt;int:page&gt;"],
      auth="user",
      website=True,
    )
    def my_book_checkouts(self, page=1, **kw):
        Checkout = request.env["library.checkout"]
        domain = []
<strong class="bold">        # Prepare pager data</strong>
        checkout_count = Checkout.search_count(domain)
        pager_data = portal.pager(
            url="/my/book_checkouts",
            total=checkout_count,
            page=page,
            step=self._items_per_page,
        )
<strong class="bold">        # Recordset according to pager and domain filter</strong>
        checkouts = Checkout.search(
            domain,
            limit=self._items_per_page,
            offset=pager_data["offset"],
        )
<strong class="bold">        # Prepare template values and render</strong>
        values = self._prepare_portal_layout_values()
        values.update(
            {
                "checkouts": checkouts,
                "page_name": "book-checkouts",
                "default_url": "/my/book-checkouts",
                "pager": pager_data,
            }
        )
        return request.render(
            "library_portal.my_book_checkouts",
            values
        )</pre>
			<p>The previous code adds a route for the <code>/my/book-checkouts</code> and <code>/my/book-checkouts/page/</code> paths. The first is the one used by default, and the second allows navigating <a id="_idIndexMarker1107"/>through the record pages.</p>
			<p>The method code is organized into three sections:</p>
			<ul>
				<li>The first code section prepares the <code>pager_data</code> variable, used by the template to render the page navigation links. It uses a <code>pager()</code> function from the portal module, responsible for preparing this data.</li>
				<li>The second code section creates the record set to be used, <code>checkouts</code>. It does so using the domain filter and pager data set previously.</li>
				<li>The third and last code section prepares the <code>values</code> dictionary and renders the QWeb template. The values are initialized using the portal-provided <code>_prepare_portal_layout_values()</code> function, and then additional data keys are set, including the pager data. The record set to use is also set in the values, in this case in the <code>checkouts</code> data key.<p class="callout-heading">Tip</p><p class="callout">The portal pages can also have support for user-selected sort<a id="_idIndexMarker1108"/> order and filters. A good example of this is the portal <strong class="bold">Tasks</strong>, implemented by the <em class="italic">Project</em> app. Inspecting the corresponding controllers and QWeb templates can provide further guidance to add this to other portal pages.</p></li>
			</ul>
			<p>You have <a id="_idIndexMarker1109"/>added the controller code, now let's add the QWeb template with the following code:</p>
			<pre>    &lt;template id="my_book_checkouts" name=
      "My Book Checkouts"&gt;
<strong class="bold">      &lt;t t-call="portal.portal_layout"&gt;</strong>
<strong class="bold">        &lt;t t-if="checkouts" t-call="portal.portal_table"&gt;</strong>
          &lt;thead&gt;
            &lt;tr&gt;
              &lt;th&gt;Title&lt;/th&gt;
              &lt;th&gt;Request Date&lt;/th&gt;
              &lt;th&gt;Stage&lt;/th&gt;
            &lt;/tr&gt;
          &lt;/thead&gt;
          &lt;tbody&gt;
<strong class="bold">            &lt;tr t-foreach="checkouts" t-as="doc"&gt;</strong>
              &lt;td&gt;
                &lt;a t-attf-href=
                  "/my/book-checkout/{{slug(doc)}}"&gt;
                  &lt;span t-field="doc.name"/&gt;
                &lt;/a&gt;
              &lt;/td&gt;
              &lt;td&gt;
                &lt;span t-field="doc.request_date"/&gt;
              &lt;/td&gt;
              &lt;td&gt;
                &lt;span t-field="doc.stage_id.name"
                      class="badge badge-pill badge-info"/&gt;
              &lt;/td&gt;
            &lt;/tr&gt;
          &lt;/tbody&gt;
        &lt;/t&gt;
<strong class="bold">        &lt;t t-else=""&gt;</strong>
          &lt;div class="alert alert-warning" role="alert"&gt;
            There are no book checkouts.
          &lt;/div&gt;
        &lt;/t&gt;
      &lt;/t&gt;
    &lt;/template&gt;</pre>
			<p>The previous code declares the <code>my_book_checkouts</code> QWeb template. It starts by calling the portal<a id="_idIndexMarker1110"/> page template, <code>portal.portal_layout</code>.</p>
			<p>Then, if there are records to render, it prepares an HTML table from them, calling the <code>portal.portal_table</code> template.</p>
			<p>Next, the template adds the table header and body. The table body uses a for-loop on the <code>checkouts</code> record set to render each row.</p>
			<p>Noteworthy is the <code>&lt;a&gt;</code> link on each record name. When rendering the checkout title, the <code>t-attf</code> directive is used to generate the link to open the corresponding detail. The special <code>slug()</code> function is used to generate a human-readable identifier for each record.</p>
			<p>The link won't work for now, since the document detail page has not been implemented yet. The next section will do that.</p>
			<h2 id="_idParaDest-390"><a id="_idTextAnchor395"/>Adding a portal document detail page</h2>
			<p>The portal has a home page, from which the user can navigate to document lists, and then open specific documents. A specific book checkout<a id="_idIndexMarker1111"/> can be accessed with the <code>/my/book-checkout/&lt;id&gt;</code> path.</p>
			<p>The previous sections implemented the home page and document list features. To complete the portal, the document detail page should be implemented. Continuing with the code from the previous section, two steps are needed:</p>
			<ol>
				<li value="1">Edit the controller file, <code>controllers/portal.py</code>, to add the code for the <code>/my/book-checkout</code> route, rendering the <code>book_checkout</code> template.</li>
				<li>Edit the QWeb template file, <code>views/portal_templates.py</code>, to add the <code>book_checkout</code> template for the book checkout list page.</li>
			</ol>
			<p>The code for the book checkout page controller is straightforward and brings nothing new. It is the following:</p>
			<pre>    @route(
        ["/my/book-checkout/
           &lt;model('library.checkout'):doc&gt;"],
        auth="user",
        website=True,
    )
    def portal_my_project(self, doc=None, **kw):
        return request.render(
            "library_portal.book_checkout",
            {"doc": doc},
        )</pre>
			<p>The previous code adds a route for the <code>/my/book-checkout/&lt;id&gt;</code> path, which translates the <code>&lt;id&gt;</code> into a <code>library.checkout</code> record. This record is used as a method argument, captured by the <code>doc</code> variable name.</p>
			<p>Since the <code>doc</code> variable contains<a id="_idIndexMarker1112"/> the checkout record to use, the method only needs to render the QWeb template for it, <code>library_portal.book_checkout</code>.</p>
			<p>The code to use for the QWeb template is the following:</p>
			<pre>    &lt;template id="book_checkout" name="Checkout Form"&gt;
      <strong class="bold">&lt;t t-call="portal.portal_layout"&gt;</strong>
        <strong class="bold">&lt;t t-call="portal.portal_record_layout"&gt;</strong>
          <strong class="bold">&lt;t t-set="card_header"&gt;</strong>
            &lt;div class="row"&gt;
              &lt;div class="col"&gt;
                &lt;h5 class="text-truncate" 
                  t-field="doc.name" /&gt;
              &lt;/div&gt;
              &lt;div class="col text-right"&gt;
                &lt;span t-field="doc.stage_id.name"
                      class="badge badge-pill badge-info"
                      title="Current stage"/&gt;
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/t&gt;
          <strong class="bold">&lt;t t-set="card_body"&gt;</strong>
            <strong class="bold">&lt;!-- Member details --&gt;</strong>
            &lt;div class="row"&gt;
              &lt;strong&gt;Member&lt;/strong&gt;
            &lt;/div&gt;
            &lt;div class="row"&gt;
              &lt;div t-if="doc.member_id.image_1024"
                   class="col flex-grow-0"&gt;
&lt;img class="rounded-circle mt-1 o_portal_contact_img"
  t-att-src="img/image_data_uri(doc.member_id.image_1024)"
  alt="Contact"/&gt;
              &lt;/div&gt;
              &lt;div class="col pl-sm-0"&gt;
                &lt;address t-field="doc.member_id"
                         t-options='{
                           "widget": "contact",
                           "fields": ["name", "email", 
                             "phone"]
                         }' /&gt;
              &lt;/div&gt;
            &lt;/div&gt;
            <strong class="bold">&lt;!-- Checkout books --&gt;</strong>
            &lt;div class="row"&gt;
              &lt;strong&gt;Borrowed books&lt;/strong&gt;
            &lt;/div&gt;
            &lt;div class="row"&gt;
              &lt;div class="col"&gt;
                &lt;ul&gt;
                  &lt;li t-foreach="doc.line_ids" t-as="line"&gt;
                    &lt;span t-field=
                      "line.book_id.display_name" /&gt;
                  &lt;/li&gt;
                &lt;/ul&gt;
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/t&gt;
        &lt;/t&gt;
      &lt;/t&gt;
    &lt;/template&gt;</pre>
			<p>The previous code<a id="_idIndexMarker1113"/> created the <code>book_checkout</code> QWeb template. Again, it starts by calling the portal page template, <code>portal.portal_layout</code>.</p>
			<p>Then, the document details template, <code>portal.portal_record_layout</code>, is called to prepare the detail<a id="_idIndexMarker1114"/> content. It uses the following two QWeb variables, which should be set:</p>
			<ul>
				<li><code>card_header</code> sets the HTML to use for the header.</li>
				<li><code>card_body</code> sets the HTML to use for the document details.</li>
			</ul>
			<p>This HTML adds rows with the content. Two particular elements are noteworthy: </p>
			<ul>
				<li>The <code>&lt;img&gt;</code> element, adding an image from a data field</li>
				<li>The <code>&lt;address&gt;</code> element, rendering an address for a partner record</li>
			</ul>
			<p>The current implementation is missing a nice usability feature, the <strong class="bold">breadcrumb</strong> allowing users to navigate back through the links to the portal main page. The next section shows how to add this.</p>
			<h2 id="_idParaDest-391"><a id="_idTextAnchor396"/>Adding a portal breadcrumb</h2>
			<p>Portal pages support a breadcrumb, on the top region of the page. By default, a home icon is available, allowing users to quickly navigate back to the <a id="_idIndexMarker1115"/>main page. As the user navigates to the document list, and then to a particular document, these selections can be added to the breadcrumb.</p>
			<p>The Odoo portal breadcrumb is added by the <code>portal.portal_breadcrumbs </code>template. It should be extended to add the specific navigation steps for particular document types.</p>
			<p>To have the book checkout breadcrumb, edit the <code>views/portal_templates.py</code> file to add the following template:</p>
			<pre>    &lt;template id="portal_layout"
              name="Portal breadcrumb: book checkout"
              <strong class="bold">inherit_id="portal.portal_breadcrumbs"</strong>&gt;
      <strong class="bold">&lt;xpath expr="//ol[hasclass('o_portal_submenu')]"</strong>
             position="inside"&gt;
        <strong class="bold">&lt;li t-if="page_name == 'book-checkouts' or doc"</strong>
            class="col-lg-2"
            t-attf-class="breadcrumb-item
                         #{'active ' if not doc else ''}"&gt;
          &lt;a t-if="doc"
             t-attf-href="/my/book-checkouts?{{ 
               keep_query() }}"&gt;
             Checkouts
           &lt;/a&gt;
           &lt;t t-else=""&gt;Checkouts&lt;/t&gt;
        &lt;/li&gt;
        <strong class="bold">&lt;li t-if="doc" class="breadcrumb-item</strong> 
          active text-truncate
                              col-8 col-lg-10"&gt;
          &lt;t t-esc="doc.name"/&gt;
        &lt;/li&gt;
      &lt;/xpath&gt;
    &lt;/template&gt;</pre>
			<p>The template in the previous code extends the <code>portal.portal_breadcrumbs </code>template. It extends the <code>&lt;ol&gt;</code> element with the <code>o_portal_submenu</code> class, adding breadcrumb <code>&lt;li&gt;</code> elements to it.</p>
			<p>The extension adds two possible elements: one for the <strong class="bold">Checkouts</strong> document list, and another for a particular book checkout. The breadcrumb is included in all portal pages, and these added elements<a id="_idIndexMarker1116"/> should be conditionally rendered, only if they make sense for the current page.</p>
			<p>The previous sections guided you through the various steps needed to add new features to the Odoo portal, enabling external users to interact with Odoo.</p>
			<h1 id="_idParaDest-392"><a id="_idTextAnchor397"/>Summary</h1>
			<p>Frontend web pages allow Odoo to also provide features to external users. This can be used to display generic information to the public, or give personalized information to portal users. The frontend web features are the foundation of the Odoo CMS, provided by the <em class="italic">Website</em> app, and for frontend features such as e-commerce.</p>
			<p>In this chapter, you understood the technical components that are at the core of frontend web features, web controllers, and QWeb templates. Web controllers implement routes, triggered when accessing certain URL paths called routes, and running any specific business logic needed. QWeb templates receive data prepared by the web controller and render HTML output with the help of the QWeb templating engine.</p>
			<p>You now know how to use these components to implement a public web page integrated with the Odoo frontend, including the usage of your own web assets. You also know how to leverage the essentials of the Odoo portal to provide self-service features to your external users.</p>
			<p>This chapter completes your journey through the various components in the Odoo framework. The models are the central element around which other components are built up. The Odoo base module provides a few essential models developers should be familiar with. The next chapter takes on the task of providing an overview of these.</p>
			<h1 id="_idParaDest-393"><a id="_idTextAnchor398"/>Further reading</h1>
			<p>These are additional reference materials that complement the topics discussed in this chapter, found in the official Odoo documentation:</p>
			<ul>
				<li>Web controllers: <a href="https://www.odoo.com/documentation/15.0/developer/reference/backend/http.html">https://www.odoo.com/documentation/15.0/developer/reference/backend/http.html</a></li>
				<li>QWeb language: <a href="https://www.odoo.com/documentation/15.0/developer/reference/frontend/qweb.html">https://www.odoo.com/documentation/15.0/developer/reference/frontend/qweb.html</a></li>
				<li>JavaScript API reference: <a href="https://www.odoo.com/documentation/15.0/developer/reference/frontend/javascript_reference.html">https://www.odoo.com/documentation/15.0/developer/reference/frontend/javascript_reference.html</a></li>
				<li>Bootstrap documentation: <a href="https://getbootstrap.com/docs/4.1/getting-started/introduction">https://getbootstrap.com/docs/4.1/getting-started/introduction</a></li>
			</ul>
			<p>Additional Bootstrap learning resources can be found on the Packt Publishing technical page: <a href="https://www.packtpub.com/tech/Bootstrap">https://www.packtpub.com/tech/Bootstrap</a>.</p>
		</div>
	</div></body></html>