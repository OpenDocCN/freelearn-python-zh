<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer492">&#13;&#13;
    <h1 class="chapterNumber"><span class="python">11</span></h1>&#13;&#13;
    <h1 id="_idParaDest-218" class="chapterTitle"><span class="python">Package Management</span></h1>&#13;&#13;
    <p class="normal"><span class="python">When working in complex systems, especially in microservices or similar architectures, there is sometimes a need to share code so it's available at different, unconnected parts of the system. That's normally code that will help to abstract some functions, which can vary greatly, from security purposes (for example, calculating a signature in a way that's understood by other systems that will have to verify it), to connecting to databases or external APIs, or even helping to monitor the system consistently.</span></p>&#13;&#13;
    <p class="normal"><span class="python">Instead of reinventing the wheel each time, we can reuse the same code multiple times to be certain that it's properly tested and validated, and consistent throughout the entire system. Some modules may be interesting to share not only across the organization but even outside it, creating a standard module others can take advantage of.</span></p>&#13;&#13;
    <p class="normal"><span class="python">Others have done that before, and a lot of common use cases, such as connecting to existing databases, using network resources, accessing OS features, understanding files in all kinds of formats, calculating common algorithms and formulas, in all kinds of domains, creating and operating AI models, and a long list of other cases besides, are available.</span></p>&#13;&#13;
    <p class="normal"><span class="python">To enhance the sharing and utilization of all those abilities, modern programming languages have their own ways of creating and sharing packages, so the usefulness of the language multiplies greatly.</span></p>&#13;&#13;
    <p class="normal"><span class="python">In this chapter, we will discuss the use of packages, mostly from a Python perspective, covering when and how to decide to create a package. We will explore the different options available, from a simple structure to packages that include code compiled so that it can be optimized for specific tasks.</span></p>&#13;&#13;
    <p class="normal"><span class="python">In this chapter, we'll cover the following topics:</span></p>&#13;&#13;
    <ul>&#13;&#13;
      <li class="bullet"><span class="python">The creation of a new package</span></li>&#13;&#13;
      <li class="bullet"><span class="python">Trivial packaging in Python</span></li>&#13;&#13;
      <li class="bullet"><span class="python">The Python packaging ecosystem</span></li>&#13;&#13;
      <li class="bullet"><span class="python">Creating a package</span></li>&#13;&#13;
      <li class="bullet"><span class="python">Cython</span></li>&#13;&#13;
      <li class="bullet"><span class="python">Python package with binary code</span></li>&#13;&#13;
      <li class="bullet"><span class="python">Uploading your package to PyPI</span></li>&#13;&#13;
      <li class="bullet"><span class="python">Creating your own private index</span></li>&#13;&#13;
    </ul>&#13;&#13;
    <p class="normal"><span class="python">Let's start by defining what code could be a candidate to create a package.</span></p>&#13;&#13;
    <h1 id="_idParaDest-219" class="title"><span class="python">The creation of a new package</span></h1>&#13;&#13;
    <p class="normal"><span class="python">In any software, there will be snippets of code that could be shared across different parts of the code. When </span><span class="python"><a id="_idIndexMarker742"/></span><span class="python">working with small, monolithic applications, this can be as easy as creating some internal modules or functions that can share functionality by calling it directly.</span></p>&#13;&#13;
    <p class="normal"><span class="python">Over time, this common function or functions could be grouped together under a module to clarify that they are to be used across the application.</span></p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-"><span class="python">Avoid the temptation to use the name </span><code class="Code-In-Text--PACKT-">utils</code> for a module with code expected to be used in different positions. While this is very common, it is also not very descriptive and a bit lazy. How does someone know if a function is in the <code class="Code-In-Text--PACKT-">utils</code> module? Instead of that, try to use a descriptive name.</p>&#13;&#13;
      <p class="Tip--PACKT-">If it's not possible, divide it into submodules, so you can create something like <code class="Code-In-Text--PACKT-">utils.communication</code> or <code class="Code-In-Text--PACKT-">utils.math</code> to avoid this effect.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">This will work fine up to a certain size. Some of the problems that can arise as the code grows and becomes more complex are as follows:</p>&#13;&#13;
    <ul>&#13;&#13;
      <li class="bullet">Create a more generic API to interact with the module, aimed at greater flexibility in terms of module utilization. This can involve creating a more defensive style of programming, to be sure that the module is used as expected and return proper errors.</li>&#13;&#13;
      <li class="bullet">Specific documentation needs to be provided for the module so that developers who are not familiar with the module are able to use it.</li>&#13;&#13;
      <li class="bullet">Ownership of the module may need to be clarified and its own maintainers specified. This can take the form of a stricter code review before changing the code, with some developer or developers designated as the point of contact for the module.</li>&#13;&#13;
      <li class="bullet">The most critical one, the functionality of the module, is required to be present in two or more independent services or code bases. If this happens, instead of just copying/pasting the code across different code bases, it makes sense to create an independent module that can be imported. This could be a deliberate option upfront, to standardize certain operations (for example, produce and verify signed messages across multiple services) or it could be an afterthought following successful implementation of the functionality in one code base that it could be handy to have in other services of the system. For example, instrumenting the communication messages to you generates a log. This log can be useful in other services, so, from the original service, it gets migrated to others.</li>&#13;&#13;
    </ul>&#13;&#13;
    <p class="normal">In general, the module starts getting its own entity, and not only as a shared location for incorporating <a id="_idIndexMarker743"/>code that is going to be shared. At that time, it starts to make sense to treat it as an independent library more than a module attached to a particular code base.</p>&#13;&#13;
    <p class="normal">Once the decision to create some code as an independent package has been taken, several aspects should be considered:</p>&#13;&#13;
    <ul>&#13;&#13;
      <li class="bullet">As we've seen before, the most important is the ownership of the new package. Packages exist in the boundaries between different teams and groups, as they are used by different ones. Be sure to provide clear ownership regarding any package to be sure that the team responsible for it is reachable, both for any possible inquiries and for setting its own maintenance.</li>&#13;&#13;
      <li class="bullet">Any new package will require time to develop new features and adjustments, especially as the package is in use, probably stretching its limits as it's used in multiple services and in more ways. Be sure to take this into account and adjust the load of the team responsible accordingly. This will be very dependent on how mature the package is and how many new features are required.</li>&#13;&#13;
      <li class="bullet">In the same way, be sure to budget time to maintain the package. Even if there are no new features, bugs will be detected and other general maintenance, such as updating the dependencies on account of security fixes or compatibility with new OS versions, will need to be continued.</li>&#13;&#13;
    </ul>&#13;&#13;
    <p class="normal">All these elements should be taken into account. In general, it is advisable to create some sort of roadmap where the team responsible can define what the objectives are and a time frame to achieve them.</p>&#13;&#13;
    <div class="note">&#13;&#13;
      <p class="Information-Box--PACKT-">The bottom line is that a new package is a new project. You need to treat it as such.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">We will focus <a id="_idIndexMarker744"/>on creating a new package in Python, but the basics are similar when creating other packages in other languages.</p>&#13;&#13;
    <h1 id="_idParaDest-220" class="title">Trivial packaging in Python</h1>&#13;&#13;
    <p class="normal">In Python, it is easy to create a package to be imported by just adding a subdirectory to the code. While this <a id="_idIndexMarker745"/>is simple, it can be adequate initially, as the <a id="_idIndexMarker746"/>subdirectory can be copied. For example, the code can be added directly to the source control system, or it can even be installed by compressing the code and uncompressing it in place.</p>&#13;&#13;
    <div class="note">&#13;&#13;
      <p class="Information-Box--PACKT-">This is not a long-term solution, as it won't handle multiple versions, dependencies, and so on, but it can work in some cases as a first step. At least initially, all the code to be packetized needs to be stored in the same subdirectory.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">The structure of the code for a module in Python can be worked out as a subdirectory with a single entry point. For example, when creating a module called <code class="Code-In-Text--PACKT-">naive_package</code> with the following structure:</p>&#13;&#13;
    <pre class="programlisting code"><code class="hljs-code">└── naive_package&#13;&#13;
    ├── __init__.py&#13;&#13;
    ├── module.py&#13;&#13;
    └── submodule&#13;&#13;
        ├── __init__.py&#13;&#13;
        └── submodule.py&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">We can see that the module contains a submodule, so let's start there. The submodule directory contains two files, the <code class="Code-In-Text--PACKT-">submodule.py</code> file with the code, and an empty <code class="Code-In-Text--PACKT-">__init__.py</code> file to allow the other file to be imported, as we will see later.</p>&#13;&#13;
    <div class="note">&#13;&#13;
      <p class="Information-Box--PACKT-"><code class="Code-In-Text--PACKT-">__init__.py</code> is a special Python file that indicates that the directory contains Python code and can be imported externally. It symbolizes the directory itself, as we will see later.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">The content of <code class="Code-In-Text--PACKT-">submodule.py</code> is this example function:</p>&#13;&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">def</span> <span class="hljs-title">subfunction</span>():&#13;&#13;
    <span class="hljs-keyword">return</span> <span class="hljs-string">'calling subfunction'</span>&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">The top level is the module itself. We have the <code class="Code-In-Text--PACKT-">module.py</code> file, which defines the <code class="Code-In-Text--PACKT-">some_function</code> function that calls the submodule:</p>&#13;&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">from</span> .submodule.submodule <span class="hljs-keyword">import</span> subfunction&#13;&#13;
<span class="hljs-keyword">def</span> <span class="hljs-title">some_function</span>():&#13;&#13;
    result = subfunction()&#13;&#13;
    <span class="hljs-keyword">return</span> <span class="hljs-string">f'some function </span><span class="hljs-subst">{result}</span><span class="hljs-string">'</span>&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">The <code class="Code-In-Text--PACKT-">import</code> <a id="_idIndexMarker747"/>line has a detail, a dot in the form of the submodule <a id="_idIndexMarker748"/>located in the same directory. This is specific syntax in Python 3 for being more precise when importing. Without the dot, it will try to import from the library instead.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">You can <a id="_idIndexMarker749"/>learn more about relative imports in PEP-328, which describes it, here: <a href="https://www.python.org/dev/peps/pep-0328/"><span class="url">https://www.python.org/dev/peps/pep-0328/</span></a>. <strong class="keyword">PEPs</strong> (<strong class="keyword">Python Enhancement Proposals</strong>) are documents describing new features relating to the <a id="_idIndexMarker750"/>Python language or information related to the community. It is the official channel for proposing changes and advancing the language.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">The rest of the function calls <code class="Code-In-Text--PACKT-">subfunction</code> and combines the result to return a string of text.</p>&#13;&#13;
    <p class="normal">The <code class="Code-In-Text--PACKT-">__init__.py</code> file, in this case, is not empty, but instead, it imports the <code class="Code-In-Text--PACKT-">some_function</code> function:</p>&#13;&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">from</span> .module <span class="hljs-keyword">import</span> some_function&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">Note again the relative <code class="Code-In-Text--PACKT-">import</code> as indicated by the preceding dot. This allows having the <code class="Code-In-Text--PACKT-">some_function</code> function available as part of the top level of the <code class="Code-In-Text--PACKT-">naive_package</code> module.</p>&#13;&#13;
    <p class="normal">We can now create a file to call the module. We'll write the <code class="Code-In-Text--PACKT-">call_naive_package.py</code> file, which needs to be at the same level as the <code class="Code-In-Text--PACKT-">native_package</code> directory:</p>&#13;&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">from</span> naive_package <span class="hljs-keyword">import</span> some_function&#13;&#13;
<span class="hljs-built_in">print</span>(some_function())&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">This file just calls the module-defined function and prints the result:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="language-bash">python3 call_naive_package.py</span>&#13;&#13;
some function calling subfunction&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">This method of handling a module to be shared is not recommended, but this small module can <a id="_idIndexMarker751"/>help us understand how to create a package <a id="_idIndexMarker752"/>and what the structure of a module is. The first step to detaching a module and creating an independent package will be to create a single subdirectory that has a clear API, including clear entry points to use it.</p>&#13;&#13;
    <p class="normal">But to get a better solution, we will need to be able to create a full Python package from there. Let's take a look at what that means exactly.</p>&#13;&#13;
    <h1 id="_idParaDest-221" class="title">The Python packaging ecosystem</h1>&#13;&#13;
    <p class="normal">Python has a very active ecosystem of third-party open source packages that covers a wide variety <a id="_idIndexMarker753"/>of topics and enables the power of any Python program to be enhanced. You can take advantage of installing them by using <code class="Code-In-Text--PACKT-">pip</code>, which is installed automatically for any new Python install.</p>&#13;&#13;
    <p class="normal">For example, to install the package named <code class="Code-In-Text--PACKT-">requests</code>, a package allowing the compilation of easier and more powerful HTTP requests, the command is:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="language-bash">pip3 install requests</span>&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal"><code class="Code-In-Text--PACKT-">pip</code> searches in the Python Package Index automatically to see whether the package is available and if it is, it will download it and install it.</p>&#13;&#13;
    <div class="note">&#13;&#13;
      <p class="Information-Box--PACKT-">Note that the <code class="Code-In-Text--PACKT-">pip</code> command could take the form of <code class="Code-In-Text--PACKT-">pip3</code>. This depends on the installation of Python in your system. We will use them indistinctly.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">We will see more detailed usage on <code class="Code-In-Text--PACKT-">pip</code> later in the chapter, but first, we need to discuss the main source where the packages are downloaded.</p>&#13;&#13;
    <h2 id="_idParaDest-222" class="title">PyPI</h2>&#13;&#13;
    <p class="normal">The Python <a id="_idIndexMarker754"/>Package Index (PyPI, normally <a id="_idIndexMarker755"/>pronounced as <em class="italic">Pie-P-I</em>, as opposed to <em class="italic">Pie-Pie</em>) is the official source of packages in Python and can be checked at <a href="https://pypi.org"><span class="url">https://pypi.org</span></a>:</p>&#13;&#13;
    <figure class="mediaobject"><img src="Images/B17580_11_01.png" alt="Graphical user interface, text, website&#13;&#10;&#13;&#10;Description automatically generated" width="826" height="560"/></figure>&#13;&#13;
    <p class="packt_figref">Figure 11.1: pypi.org main page</p>&#13;&#13;
    <p class="normal">On the <a id="_idIndexMarker756"/>PyPI web page, the search enables specific packages <a id="_idIndexMarker757"/>to be found along with useful information, including available packages with partial matches. They can also be filtered.</p>&#13;&#13;
    <figure class="mediaobject"><img src="Images/B17580_11_02.png" alt="Graphical user interface, application&#13;&#10;&#13;&#10;Description automatically generated" width="826" height="561"/></figure>&#13;&#13;
    <p class="packt_figref">Figure 11.2: Searching for packages</p>&#13;&#13;
    <p class="normal">Once the <a id="_idIndexMarker758"/>individual package is specified, more information <a id="_idIndexMarker759"/>can be found regarding brief documentation, links to the source and home page of the project, and other similar kinds of licenses or maintainers.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">The home page and documentation page are very significant for big packages, as they will include much more information about how to use the package. Smaller packages will normally only include the documentation on this page, but it's always worth checking their page for the source as it may link to a GitHub page with details about bugs and the possibility of submitting patches or reports.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">The page for <code class="Code-In-Text--PACKT-">requests</code> looks like this at the time of writing this book:</p>&#13;&#13;
    <figure class="mediaobject"><img src="Images/B17580_11_03.png" alt="Graphical user interface, application&#13;&#10;&#13;&#10;Description automatically generated" width="826" height="563"/></figure>&#13;&#13;
    <p class="packt_figref">Figure 11.3: Detailed info about a module</p>&#13;&#13;
    <p class="normal">Searching directly in PyPI can help locate some interesting modules, and in some cases, will be <a id="_idIndexMarker760"/>quite straightforward, such as finding a module to <a id="_idIndexMarker761"/>connect to a database (for example, searching by the name of the database). This, though, normally involves a significant amount of trial and error, as the name may not be indicative of how good a module will be for your use case.</p>&#13;&#13;
    <p class="normal">Spending some time on the internet searching for the best module for a use case is a great idea and it will improve the chances of finding the right package for your use case.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">A great <a id="_idIndexMarker762"/>source of knowledge in this case is StackOverflow (<a href="https://stackoverflow.com/"><span class="url">https://stackoverflow.com/</span></a>), which contains a lot of questions and answers that can be used to ascertain interesting modules. A general Google search will also help.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">In any case, given the number of available packages for Python, of varying quality and maturity, it's always worthwhile setting aside some time to research alternatives. </p>&#13;&#13;
    <p class="normal">Packages are not curated in any way by <code class="Code-In-Text--PACKT-">pypi.org</code>, as it's publicly available to anyone to submit their packages, although malicious ones will be eliminated. How popular a package <a id="_idIndexMarker763"/>is will require more indirect methods, such as searching <a id="_idIndexMarker764"/>how many downloads or searching through a searcher online to see whether other projects are using it. Ultimately, it will require the performance of some Proof-of-Concept programs to analyze whether the candidate packages cover all the required functionalities.</p>&#13;&#13;
    <h2 id="_idParaDest-223" class="title">Virtual environments</h2>&#13;&#13;
    <p class="normal">The next element in the packaging chain is the creation of virtual environments to isolate <a id="_idIndexMarker765"/>the installation of modules.</p>&#13;&#13;
    <p class="normal">When dealing <a id="_idIndexMarker766"/>with installing packages, using the default environments in the system leads to the packages being installed there. This means that the general installation of the Python interpreter will be affected by this.</p>&#13;&#13;
    <p class="normal">This can lead to problems, as you may install packages that have side effects when using the Python interpreter for other purposes, as dependencies in the packages may interfere with each other.</p>&#13;&#13;
    <p class="normal">For example, if the same machine has a Python program that requires the <code class="Code-In-Text--PACKT-">package1</code> package and another Python program that requires <code class="Code-In-Text--PACKT-">package2</code>, and they are both incompatible, that will create a conflict. Installing both <code class="Code-In-Text--PACKT-">package1</code> and <code class="Code-In-Text--PACKT-">package2</code> won't be possible.</p>&#13;&#13;
    <div class="note">&#13;&#13;
      <p class="Information-Box--PACKT-">Note that this can also happen through version incompatibility, especially in the dependencies of the packages, or in the dependencies of dependencies. For example, <code class="Code-In-Text--PACKT-">package1</code> requires dependency version 5 to be installed, and <code class="Code-In-Text--PACKT-">package2</code> requires dependency version 6 or higher. They won't be able to run in conjunction with one another.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">The solution to this problem is to create two different environments, so each package and its dependencies are stored independently – independently from each other, but also independently from the system Python interpreter, so it won't affect any possible system activity that depends on the Python system interpreter.</p>&#13;&#13;
    <p class="normal">To create a new virtual environment, you can use the standard module <code style="font-weight: bold;" class="codeHighlighted">venv</code>, included in all installations of Python 3 after 3.3:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="language-bash">python3 -m venv venv</span>&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">This creates the <code class="Code-In-Text--PACKT-">venv</code> subdirectory, which contains the virtual environment. The environment can be activated using the following <code class="Code-In-Text--PACKT-">source</code> command:</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">Please note that we have used a name for the created virtual environment, <code class="Code-In-Text--PACKT-">venv</code>, which is the same as the name of the module. That's not necessary. Virtual environments can be created with any name. Be sure to use a name that's descriptive in your use case.</p>&#13;&#13;
    </div>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="hljs-con-built_in">source</span><span class="language-bash"> ./venv/bin/activate</span>&#13;&#13;
(venv) $ which python&#13;&#13;
./venv/bin/python&#13;&#13;
(venv) $ which pip&#13;&#13;
./venv/bin/python&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">You can <a id="_idIndexMarker767"/>see that the <code class="Code-In-Text--PACKT-">python</code> interpreter and <code class="Code-In-Text--PACKT-">pip</code> that get executed is <a id="_idIndexMarker768"/>the one located in the virtual environment, and not the system one, and also the indication in the prompt that the virtual environment, <code class="Code-In-Text--PACKT-">venv</code>, is active.</p>&#13;&#13;
    <p class="normal">The virtual environment also has its own library, so any installed packages will be stored here, and not in the system environment.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">The virtual environment can be deactivated by calling the <code class="Code-In-Text--PACKT-">deactivate</code> command. You can see that the <code class="Code-In-Text--PACKT-">(venv)</code> indication disappears.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">Once in the virtual environment, any call to <code class="Code-In-Text--PACKT-">pip</code> will install the packages in the virtual environment, so they are independent of any other environment. Each program can then be executed within its own virtual environment.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">In cases where the virtual environment cannot be activated directly through the command line and the command needs to be executed directly, for example, for cronjob cases, you can call the <code class="Code-In-Text--PACKT-">python</code> interpreter directly in the virtual environment by its full path, such as <code class="Code-In-Text--PACKT-">/path/to/venv/python/your_script.py</code>.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">With a proper environment, we can use pip to install the different dependencies. </p>&#13;&#13;
    <h2 id="_idParaDest-224" class="title">Preparing an environment</h2>&#13;&#13;
    <p class="normal">Creating a virtual environment is the first stage, but we need to install all dependencies for our software.</p>&#13;&#13;
    <p class="normal">To be able <a id="_idIndexMarker769"/>to replicate the <a id="_idIndexMarker770"/>environment in all situations, the best is to create a requirements file that defines all dependencies that should be installed. <code class="Code-In-Text--PACKT-">pip</code> allows working with a file, normally called <code class="Code-In-Text--PACKT-">requirements.txt</code>, to install dependencies.</p>&#13;&#13;
    <p class="normal">This is an excellent way of creating a replicable environment that can be started from scratch when necessary.</p>&#13;&#13;
    <p class="normal">For example, let's take a look at the following <code class="Code-In-Text--PACKT-">requirements.txt</code> file:</p>&#13;&#13;
    <pre class="programlisting code"><code class="hljs-code">requests==<span class="hljs-number">2.26.0</span>&#13;&#13;
pint==<span class="hljs-number">0.17</span>&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">The file can be downloaded from GitHub at <a href="https://github.com/PacktPublishing/Python-Architecture-Patterns/blob/main/chapter_11_package_management/requirements.txt"><span class="url">https://github.com/PacktPublishing/Python-Architecture-Patterns/blob/main/chapter_11_package_management/requirements.txt</span></a>.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">Note the format is <code class="Code-In-Text--PACKT-">package==version</code>. This specifies the exact version to use for the package, which is the recommended way of installing dependencies. That avoids the problem of using just <code class="Code-In-Text--PACKT-">package</code>, which will install the latest version, and which can lead to an upgrade that's not planned, which may break compatibility.</p>&#13;&#13;
      <p class="Tip--PACKT-">Other options, such as <code class="Code-In-Text--PACKT-">package&gt;=version</code>, to specify a minimum version are available. </p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">The file can be installed in the virtual environment (remember to activate it) using the following command:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con">(venv) $ pip install -r requirements.txt&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">After that, all the specified requirements will be installed in the environment.</p>&#13;&#13;
    <p class="normal">Note that the dependencies of your specified dependencies may not be totally pinned down to specific versions. This is because the dependencies have their own definition, which can produce unknown upgrades on second-level dependencies when a new package is delivered.</p>&#13;&#13;
    <p class="normal">To avoid having that problem, you can create an initial installation with your first-level dependencies, and then obtain all the dependencies that have been installed with the <code class="Code-In-Text--PACKT-">pip freeze</code> command:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con">(venv) $ pip freeze&#13;&#13;
certifi==2021.5.30&#13;&#13;
chardet==3.0.4&#13;&#13;
charset-normalizer==2.0.4&#13;&#13;
idna==2.10&#13;&#13;
packaging==21.0&#13;&#13;
Pint==0.17&#13;&#13;
pyparsing==2.4.7&#13;&#13;
requests==2.26.0&#13;&#13;
urllib3==1.26.6&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">You can <a id="_idIndexMarker771"/>use the output <a id="_idIndexMarker772"/>to update the <code class="Code-In-Text--PACKT-">requirements.txt</code> directly, so the next installation will have all the second-level dependencies also pinned down.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">Note that adding new requirements will require the same process to be generated, to install first, then run <code class="Code-In-Text--PACKT-">freeze</code>, and then update the <code class="Code-In-Text--PACKT-">requirements.txt</code> file with the ouput.</p>&#13;&#13;
    </div>&#13;&#13;
    <h3 id="_idParaDest-225" class="title">A note on containers</h3>&#13;&#13;
    <p class="normal">When working in a container manner, the distinction between the system interpreter and the program <a id="_idIndexMarker773"/>interpreter is more diluted, as the container has its own OS wrapped, thereby enforcing a strong separation.</p>&#13;&#13;
    <p class="normal">In the traditional way of deploying services, they are installed and run in the same server, making it necessary to keep a separation between the interpreter due to the restrictions that we talked about previously.</p>&#13;&#13;
    <p class="normal">By using containers, we have already created a wrap around each of the services into their own OS filesystem, which means that we can skip the creation of a virtual environment. The container acts as a virtual environment in this case, enforcing separation between different containers.</p>&#13;&#13;
    <p class="normal">As we've discussed previously in <em class="chapterRef">Chapter 8</em>, <em class="italic">Advanced Event-Driven Structures</em>, when talking about containers, each container should serve only a single service, coordinating different containers to generate different servers. That way, it eliminates the case of having to share the same interpreter.</p>&#13;&#13;
    <p class="normal">This means that we can ease some of the restrictions that we would normally impose in a traditional <a id="_idIndexMarker774"/>setting, and care just about one environment, being able to take less care about polluting the system environment. There's only one environment, so we can play with it more freely. If we need more services or environments, we can always create more containers.</p>&#13;&#13;
    <h2 id="_idParaDest-226" class="title">Python packages</h2>&#13;&#13;
    <p class="normal">A Python module ready to use is, in essence, a subdirectory with certain Python code. This subdirectory <a id="_idIndexMarker775"/>gets installed in the proper library's subdirectoy, and the <a id="_idIndexMarker776"/>interpreter searches in this subdirectory. The directory is called <code class="Code-In-Text--PACKT-">site-packages</code>.</p>&#13;&#13;
    <div class="note">&#13;&#13;
      <p class="Information-Box--PACKT-">This subdirectory is available in the virtual environment, if you are using one. You can check the following subdirectory: <code class="Code-In-Text--PACKT-">venv/lib/python3.9/site-packages/</code>.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">To distribute it, the subdirectory is packaged into two different files, either <code class="Code-In-Text--PACKT-">Egg</code> files or <code class="Code-In-Text--PACKT-">Wheel</code> files. Importantly, though, <code class="Code-In-Text--PACKT-">pip</code> can only install <code class="Code-In-Text--PACKT-">Wheel</code> files.</p>&#13;&#13;
    <div class="note">&#13;&#13;
      <p class="Information-Box--PACKT-">Source packages can also be created. In this case, the file is a tar file that contains all the code.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal"><code class="Code-In-Text--PACKT-">Egg</code> files are considered deprecated, as their format is older and it's basically a zipped file containing some metadata. <code class="Code-In-Text--PACKT-">Wheel</code> files have several advantages:</p>&#13;&#13;
    <ul>&#13;&#13;
      <li class="bullet">They are better defined and allow for more use cases. There's a specific PEP, PEP-427 (<a href="https://www.python.org/dev/peps/pep-0427/"><span class="url">https://www.python.org/dev/peps/pep-0427/</span></a>), that defines the format. <code class="Code-In-Text--PACKT-">Egg</code> files were never officially defined.</li>&#13;&#13;
      <li class="bullet">They can be defined to have better compatibility, allowing the creation of <code class="Code-In-Text--PACKT-">Wheel</code> files that are compatible between different versions of Python, including Python 2 and Python 3.</li>&#13;&#13;
      <li class="bullet"><code class="Code-In-Text--PACKT-">Wheel</code> files can include already compiled binary code. Python allows the inclusion of libraries that are written in C, but these libraries need to target the proper hardware architecture. In <code class="Code-In-Text--PACKT-">Egg</code> files, the source files were included and compiled at install time, but that required the proper compilation tools and environment in the installation machine, and this could easily result in compilation issues.</li>&#13;&#13;
      <li class="bullet">Instead of that, <code class="Code-In-Text--PACKT-">Wheel</code> files can be precompiled with binary files. The <code class="Code-In-Text--PACKT-">Wheel</code> file has better-defined compatibility based on hardware architecture and the OS, so the right <code class="Code-In-Text--PACKT-">Wheel</code> file will be downloaded and installed, if available. This makes the installation faster, as no compilation needs to be performed in the installation, and removes the need for compilation tools available in the target machine. A <code class="Code-In-Text--PACKT-">Wheel</code> file with a source file can also be created to allow its installation in machines not already precompiled, though in this case, it will require a compiler.</li>&#13;&#13;
      <li class="bullet"><code class="Code-In-Text--PACKT-">Wheel</code> files can be cryptographically signed, while <code class="Code-In-Text--PACKT-">Eggs</code> don't support this option. That adds an extra layer to avoid compromised and modified packages.</li>&#13;&#13;
    </ul>&#13;&#13;
    <p class="normal">Right now, the standard <a id="_idIndexMarker777"/>for packaging in Python is <code class="Code-In-Text--PACKT-">Wheel</code> files, and they should be preferred as a general rule. <code class="Code-In-Text--PACKT-">Egg</code> files should be limited to older packages that haven't been upgraded to the new format.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">Egg files can be installed with the older <code class="Code-In-Text--PACKT-">easy_install</code> script, although this is no longer included in the latest versions of Python. Check the documentation for setup tools on how to use <code class="Code-In-Text--PACKT-">easy_install</code>: <a href="https://setuptools.readthedocs.io/en/latest/deprecated/easy_install.html"><span class="url">https://setuptools.readthedocs.io/en/latest/deprecated/easy_install.html</span></a>.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">We will see now how to create your own package.</p>&#13;&#13;
    <h1 id="_idParaDest-227" class="title">Creating a package</h1>&#13;&#13;
    <p class="normal">Even if, in most cases, we will use third-party packages, at some point, it is possible that you'll need <a id="_idIndexMarker778"/>to create your own package.</p>&#13;&#13;
    <p class="normal">To do so, you need to create a <code class="Code-In-Text--PACKT-">setup.py</code> file, which is the base of the package, describing what is inside it. Base package code will look like this:</p>&#13;&#13;
    <pre class="programlisting code"><code class="hljs-code">package&#13;&#13;
├── LICENSE&#13;&#13;
├── README&#13;&#13;
├── setup.py&#13;&#13;
└── src&#13;&#13;
    └─── &lt;source code&gt;&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">The <code class="Code-In-Text--PACKT-">LICENSE</code> and <code class="Code-In-Text--PACKT-">README</code> files are not mandatory but are good to include for adding information about the package. The <code class="Code-In-Text--PACKT-">LICENSE</code> file will be included automatically in the package.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">Choosing your own open source license can be difficult. You can use the web (<a href="https://choosealicense.com/"><span class="url">https://choosealicense.com/</span></a>), which shows different options and explains them. We will use the MIT license as an example.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">The <code class="Code-In-Text--PACKT-">README</code> file is not included, but we will include its content in a full description of the package as part of the build process, as we will see later.</p>&#13;&#13;
    <p class="normal">The code <a id="_idIndexMarker779"/>of the process is the <code class="Code-In-Text--PACKT-">setup.py</code> file. Let's take a look at an example:</p>&#13;&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> setuptools&#13;&#13;
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">'README'</span>) <span class="hljs-keyword">as</span> readme:&#13;&#13;
    description = readme.read()&#13;&#13;
setuptools.setup(&#13;&#13;
    name=<span class="hljs-string">'wheel-package'</span>,&#13;&#13;
    version=<span class="hljs-string">'0.0.1'</span>,&#13;&#13;
    author=<span class="hljs-string">'you'</span>,&#13;&#13;
    author_email=<span class="hljs-string">'me@you.com'</span>,&#13;&#13;
    description=<span class="hljs-string">'an example of a package'</span>,&#13;&#13;
    url=<span class="hljs-string">'http://site.com'</span>,&#13;&#13;
    long_description=description,&#13;&#13;
    classifiers=[&#13;&#13;
        <span class="hljs-string">'Programming Language :: Python :: 3'</span>,&#13;&#13;
        <span class="hljs-string">'Operating System :: OS Independent'</span>,&#13;&#13;
        <span class="hljs-string">'License :: OSI Approved :: MIT License'</span>,&#13;&#13;
    ],&#13;&#13;
    package_dir={<span class="hljs-string">''</span>: <span class="hljs-string">'src'</span>},&#13;&#13;
    install_requires=[&#13;&#13;
        <span class="hljs-string">'requests'</span>,&#13;&#13;
    ],&#13;&#13;
    packages=setuptools.find_packages(where=<span class="hljs-string">'src'</span>),&#13;&#13;
    python_requires=<span class="hljs-string">'&gt;=3.9'</span>,&#13;&#13;
)&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">The <code class="Code-In-Text--PACKT-">setup.py</code> file essentially contains the <code class="Code-In-Text--PACKT-">setuptools.setup</code> function, which defines the package. It defines the following:</p>&#13;&#13;
    <ul>&#13;&#13;
      <li class="bullet"><code class="Code-In-Text--PACKT-">name</code>: The name of the package.</li>&#13;&#13;
      <li class="bullet"><code class="Code-In-Text--PACKT-">version</code>: The version of the package. It will be used when installing a particular version or when ascertaining which is the latest version.</li>&#13;&#13;
      <li class="bullet"><code class="Code-In-Text--PACKT-">author</code> and <code class="Code-In-Text--PACKT-">author_email</code>: It is good to include these to receive any possible bug reports or requests.</li>&#13;&#13;
      <li class="bullet"><code class="Code-In-Text--PACKT-">description</code>: A short description.</li>&#13;&#13;
      <li class="bullet"><code class="Code-In-Text--PACKT-">url</code>: The URL for the project.</li>&#13;&#13;
      <li class="bullet"><code class="Code-In-Text--PACKT-">long_description</code>: A longer description. Here, we are reading the <code class="Code-In-Text--PACKT-">README</code> file, storing the content in the <code class="Code-In-Text--PACKT-">description</code> variable:&#13;&#13;
        <pre class="programlisting gen"><code class="hljs">with open('README') as readme:&#13;&#13;
    description = readme.read()&#13;&#13;
</code></pre>&#13;&#13;
        <p class="bullet-para">An important detail of <code class="Code-In-Text--PACKT-">setup.py</code> is that it is dynamic, so we can use code to determine the values of any parameter.</p>&#13;&#13;
      </li>&#13;&#13;
      <li class="bullet"><code class="Code-In-Text--PACKT-">classifier</code>: Categories for allowing packages to be categorized in different areas, such as the kinds of licenses and languages, or if the package is supposed to work with a framework like Django. You can check the full list of classifiers at the following link: <a href="https://pypi.org/classifiers/"><span class="url">https://pypi.org/classifiers/</span></a>.</li>&#13;&#13;
      <li class="bullet"><code class="Code-In-Text--PACKT-">package_dir</code>: The subdirectory where the code of the package is located. Here, we specify <code class="Code-In-Text--PACKT-">src</code>. By default, it will use the same directory as <code class="Code-In-Text--PACKT-">setup.py</code>, but it's better to make the division so as to keep the code tidy.</li>&#13;&#13;
      <li class="bullet"><code class="Code-In-Text--PACKT-">install_requires</code>: Any dependency that needs to be installed with your package. Here, we are adding <code class="Code-In-Text--PACKT-">requests</code> as an example. Note that any second-order dependencies (dependencies of <code class="Code-In-Text--PACKT-">requests</code>) will be installed as well.</li>&#13;&#13;
      <li class="bullet"><code class="Code-In-Text--PACKT-">packages</code>: Using the <code class="Code-In-Text--PACKT-">setuptools.find_packages</code> function, include everything that's in the <code class="Code-In-Text--PACKT-">src</code> directory.</li>&#13;&#13;
      <li class="bullet"><code class="Code-In-Text--PACKT-">python_requires</code>: Define what Python interpreters are compatible with the package. In this case, we define it for Python 3.9 or higher.</li>&#13;&#13;
    </ul>&#13;&#13;
    <p class="normal">Once the file <a id="_idIndexMarker780"/>is ready, you can run the <code class="Code-In-Text--PACKT-">setup.py</code> script directly, for example, to check that the data is correct:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="language-bash">python setup.py check</span>&#13;&#13;
running check&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">This command will verify that the <code class="Code-In-Text--PACKT-">setup.py</code> definition is correct and that no mandatory elements are missing.</p>&#13;&#13;
    <h2 id="_idParaDest-228" class="title">Development mode</h2>&#13;&#13;
    <p class="normal">The <code class="Code-In-Text--PACKT-">setup.py</code> file can be used to install the package in <code class="Code-In-Text--PACKT-">develop</code> mode. This installs the package in <a id="_idIndexMarker781"/>the current environment in a linked way. This means <a id="_idIndexMarker782"/>that any changes to the code will be applied directly to the package after the interpreter is restarted, making it easy to change and work with tests. Remember to run it while inside the virtual environment:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con">(venv) $ python setup.py develop&#13;&#13;
running develop&#13;&#13;
running egg_info&#13;&#13;
writing src/wheel_package.egg-info/PKG-INFO&#13;&#13;
writing dependency_links to src/wheel_package.egg-info/dependency_links.txt&#13;&#13;
writing requirements to src/wheel_package.egg-info/requires.txt&#13;&#13;
writing top-level names to src/wheel_package.egg-info/top_level.txt&#13;&#13;
reading manifest file 'src/wheel_package.egg-info/SOURCES.txt'&#13;&#13;
adding license file 'LICENSE'&#13;&#13;
...&#13;&#13;
Using venv/lib/python3.9/site-packages&#13;&#13;
Finished processing dependencies for wheel-package==0.0.1&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">The developed version can be uninstalled easily to clean up the environment:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con">(venv) $ python setup.py develop --uninstall&#13;&#13;
running develop&#13;&#13;
Removing  /venv/lib/python3.9/site-packages/wheel-package.egg-link (link to src)&#13;&#13;
Removing wheel-package 0.0.1 from easy-install.pth file&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">You can read more <a id="_idIndexMarker783"/>about development mode in the official documentation here: <a href="https://setuptools.readthedocs.io/en/latest/userguide/development_mode.html"><span class="url">https://setuptools.readthedocs.io/en/latest/userguide/development_mode.html</span></a>.</p>&#13;&#13;
    <p class="normal">This step installs the package directly in the current environment and can be used to run tests and validate that the package is working as expected once installed. Once this is done, we can prepare the package itself.</p>&#13;&#13;
    <h2 id="_idParaDest-229" class="title">Pure Python package</h2>&#13;&#13;
    <p class="normal">To create a package, we first need to define what kind of package we want to create. As we described <a id="_idIndexMarker784"/>before, we have three options: a source distribution, an <code class="Code-In-Text--PACKT-">Egg</code>, or a <code class="Code-In-Text--PACKT-">Wheel</code>. Each one is defined by a different command in <code class="Code-In-Text--PACKT-">setup.py</code>.</p>&#13;&#13;
    <p class="normal">To create a source distribution, we will use <code class="Code-In-Text--PACKT-">sdist</code> (source distribution):</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="language-bash">python setup.py sdist</span>&#13;&#13;
running sdist&#13;&#13;
running egg_info&#13;&#13;
writing src/wheel_package.egg-info/PKG-INFO&#13;&#13;
writing dependency_links to src/wheel_package.egg-info/dependency_links.txt&#13;&#13;
writing requirements to src/wheel_package.egg-info/requires.txt&#13;&#13;
writing top-level names to src/wheel_package.egg-info/top_level.txt&#13;&#13;
reading manifest file 'src/wheel_package.egg-info/SOURCES.txt'&#13;&#13;
adding license file 'LICENSE'&#13;&#13;
writing manifest file 'src/wheel_package.egg-info/SOURCES.txt'&#13;&#13;
running check&#13;&#13;
creating wheel-package-0.0.1&#13;&#13;
creating wheel-package-0.0.1/src&#13;&#13;
creating wheel-package-0.0.1/src/submodule&#13;&#13;
creating wheel-package-0.0.1/src/wheel_package.egg-info&#13;&#13;
copying files to wheel-package-0.0.1...&#13;&#13;
copying LICENSE -&gt; wheel-package-0.0.1&#13;&#13;
copying README.md -&gt; wheel-package-0.0.1&#13;&#13;
copying setup.py -&gt; wheel-package-0.0.1&#13;&#13;
copying src/submodule/__init__.py -&gt; wheel-package-0.0.1/src/submodule&#13;&#13;
copying src/submodule/submodule.py -&gt; wheel-package-0.0.1/src/submodule&#13;&#13;
copying src/wheel_package.egg-info/PKG-INFO -&gt; wheel-package-0.0.1/src/wheel_package.egg-info&#13;&#13;
copying src/wheel_package.egg-info/SOURCES.txt -&gt; wheel-package-0.0.1/src/wheel_package.egg-info&#13;&#13;
copying src/wheel_package.egg-info/dependency_links.txt -&gt; wheel-package-0.0.1/src/wheel_package.egg-info&#13;&#13;
copying src/wheel_package.egg-info/requires.txt -&gt; wheel-package-0.0.1/src/wheel_package.egg-info&#13;&#13;
copying src/wheel_package.egg-info/top_level.txt -&gt; wheel-package-0.0.1/src/wheel_package.egg-info&#13;&#13;
Writing wheel-package-0.0.1/setup.cfg&#13;&#13;
creating dist&#13;&#13;
Creating tar archive&#13;&#13;
removing 'wheel-package-0.0.1' (and everything under it)&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">The <code class="Code-In-Text--PACKT-">dist</code> package is available in the newly created <code class="Code-In-Text--PACKT-">dist</code> subdirectory:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="hljs-con-built_in">ls</span><span class="language-bash"> dist</span>&#13;&#13;
wheel-package-0.0.1.tar.gz&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">To generate a proper <code class="Code-In-Text--PACKT-">Wheel</code> package, we need to install the <code class="Code-In-Text--PACKT-">wheel</code> module first:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="language-bash">pip install wheel</span>&#13;&#13;
Collecting wheel&#13;&#13;
  Using cached wheel-0.37.0-py2.py3-none-any.whl (35 kB)&#13;&#13;
Installing collected packages: wheel&#13;&#13;
Successfully installed wheel-0.37.0&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">This adds <a id="_idIndexMarker785"/>the <code class="Code-In-Text--PACKT-">bdist_wheel</code> command to the available commands in <code class="Code-In-Text--PACKT-">setup.py</code>, which generates a <code class="Code-In-Text--PACKT-">wheel</code>:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="language-bash">python setup.py bdist_wheel</span>&#13;&#13;
running bdist_wheel&#13;&#13;
running build&#13;&#13;
running build_py&#13;&#13;
installing to build/bdist.macosx-11-x86_64/wheel&#13;&#13;
...&#13;&#13;
adding 'wheel_package-0.0.1.dist-info/LICENSE'&#13;&#13;
adding 'wheel_package-0.0.1.dist-info/METADATA'&#13;&#13;
adding 'wheel_package-0.0.1.dist-info/WHEEL'&#13;&#13;
adding 'wheel_package-0.0.1.dist-info/top_level.txt'&#13;&#13;
adding 'wheel_package-0.0.1.dist-info/RECORD'&#13;&#13;
removing build/bdist.macosx-11-x86_64/wheel&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">And the <code class="Code-In-Text--PACKT-">wheel</code> file is available, once more, in the <code class="Code-In-Text--PACKT-">dist</code> subdirectory:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="hljs-con-built_in">ls</span><span class="language-bash"> dist</span>&#13;&#13;
wheel_package-0.0.1-py3-none-any.whl&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">Note that it also includes Python version 3.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">Wheel packages <a id="_idIndexMarker786"/>compatible with both Python 2 and Python 3 can be used. These wheels are called <em class="italic">Universal</em>. That was useful while doing the transition between both versions. Hopefully, by now, most of the new code in Python is using version 3 and we don't have to worry about that.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">All these <a id="_idIndexMarker787"/>created packages can be installed directly with pip:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="language-bash">pip install dist/wheel-package-0.0.1.tar.gz</span>&#13;&#13;
Processing ./dist/wheel-package-0.0.1.tar.gz&#13;&#13;
... &#13;&#13;
Successfully built wheel-package&#13;&#13;
Installing collected packages: wheel-package&#13;&#13;
Successfully installed wheel-package-0.0.&#13;&#13;
<span class="hljs-con-meta">$ </span><span class="language-bash">pip uninstall wheel-package</span>&#13;&#13;
Found existing installation: wheel-package 0.0.1&#13;&#13;
Uninstalling wheel-package-0.0.1:&#13;&#13;
  Would remove:&#13;&#13;
    venv/lib/python3.9/site-packages/submodule/*&#13;&#13;
    venv/lib/python3.9/site-packages/wheel_package-0.0.1.dist-info/*&#13;&#13;
Proceed (Y/n)? y&#13;&#13;
  Successfully uninstalled wheel-package-0.0.1&#13;&#13;
<span class="hljs-con-meta">$ </span><span class="language-bash">pip install dist/wheel_package-0.0.1-py3-none-any.whl</span>&#13;&#13;
Processing ./dist/wheel_package-0.0.1-py3-none-any.whl&#13;&#13;
Collecting requests&#13;&#13;
  Using cached requests-2.26.0-py2.py3-none-any.whl (62 kB)&#13;&#13;
...&#13;&#13;
Collecting urllib3&lt;1.27,&gt;=1.21.1&#13;&#13;
  Using cached urllib3-1.26.6-py2.py3-none-any.whl (138 kB)&#13;&#13;
...&#13;&#13;
Installing collected packages: wheel-package&#13;&#13;
Successfully installed wheel-package-0.0.&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">Note that the dependencies, in this case, <code class="Code-In-Text--PACKT-">requests</code>, are installed automatically as well as any second-level dependency, for example, <code class="Code-In-Text--PACKT-">urllib3</code>.</p>&#13;&#13;
    <p class="normal">The power of the packaging is not only applicable to packages that contain only Python code. One of the most interesting features of <code class="Code-In-Text--PACKT-">wheels</code> is the ability to generate pre-compiled <a id="_idIndexMarker788"/>packages, which includes compiled code for a target system.</p>&#13;&#13;
    <p class="normal">To be able to show that, we need to produce some Python module that contains code that will be compiled. To do so, we need to take a small detour.</p>&#13;&#13;
    <h1 id="_idParaDest-230" class="title">Cython</h1>&#13;&#13;
    <p class="normal">Python is capable of creating C and C++ language extensions that are compiled and interact with the Python code. Python itself is written in C, so this is a natural extension.</p>&#13;&#13;
    <p class="normal">While Python <a id="_idIndexMarker789"/>has a lot of great features, pure speed when performing certain operations, such as numerical operations, is not its forte. This is where the C extensions come into their own as they enable low-level code to be accessed, which can be optimized and run faster than Python. Don't underestimate the possibility of creating a small, localized C extension that speeds up critical parts of the code.</p>&#13;&#13;
    <p class="normal">Creating a C extension, however, can be difficult. The interface between Python and C is not straightforward, and the memory management required in C may be daunting unless you have significant experience of working with the C language.</p>&#13;&#13;
    <div class="note">&#13;&#13;
      <p class="Information-Box--PACKT-">If you want to dive deep into the topic and create your own C/C++ extensions, you can start by reading the official documentation at <a href="https://docs.python.org/3/extending/index.html"><span class="url">https://docs.python.org/3/extending/index.html</span></a>.</p>&#13;&#13;
      <p class="Information-Box--PACKT-">Other options are available, such as creating extensions in Rust. You can check how to do this in the following article: <a href="https://developers.redhat.com/blog/2017/11/16/speed-python-using-rust"><span class="url">https://developers.redhat.com/blog/2017/11/16/speed-python-using-rust</span></a>.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">Fortunately, there are some alternatives to make the task easier. A very good one is Cython.</p>&#13;&#13;
    <p class="normal">Cython is a tool that compiles Python code with some extensions in C, so writing a C extension is as simple as writing Python code. The code is annotated to describe the C types for variables, but other than that, it looks pretty similar. </p>&#13;&#13;
    <div class="note">&#13;&#13;
      <p class="Information-Box--PACKT-">A complete <a id="_idIndexMarker790"/>description of Cython and all its possibilities is beyond the scope of this book. We present just a brief introduction. Please check the complete documentation for more information: <a href="https://cython.org/"><span class="url">https://cython.org/</span></a>.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">Cython files are stored as <code class="Code-In-Text--PACKT-">.pyx</code> files. Let's see an example, which will determine whether a number is a prime number with the help of the <code class="Code-In-Text--PACKT-">wheel_package_compiled.pyx</code> file:</p>&#13;&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">def</span> <span class="hljs-title">check_if_prime</span>(<span class="hljs-params">unsigned </span><span class="hljs-built_in">int</span><span class="hljs-params"> number</span>):&#13;&#13;
    cdef <span class="hljs-built_in">int</span> counter = <span class="hljs-number">2</span>&#13;&#13;
    <span class="hljs-keyword">if</span> number == <span class="hljs-number">0</span>:&#13;&#13;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>&#13;&#13;
    <span class="hljs-keyword">while</span> counter &lt; number:&#13;&#13;
        <span class="hljs-keyword">if</span> number % counter ==  <span class="hljs-number">0</span>:&#13;&#13;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>&#13;&#13;
        counter += <span class="hljs-number">1</span>&#13;&#13;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">The code is checking whether a positive number is a prime number:</p>&#13;&#13;
    <ul>&#13;&#13;
      <li class="bullet">It returns <code class="Code-In-Text--PACKT-">False</code> if the input is zero.</li>&#13;&#13;
      <li class="bullet">It tries to divide the number by a number from 2 to the number. If any division is exact, it returns <code class="Code-In-Text--PACKT-">False</code> as the number is not a prime number.</li>&#13;&#13;
      <li class="bullet">If no division is exact, or the number is lower than 2, it returns <code class="Code-In-Text--PACKT-">True</code>.</li>&#13;&#13;
    </ul>&#13;&#13;
    <p class="normal">The code is <a id="_idIndexMarker791"/>not exactly Pythonic, as it will be translated into C. It's more efficient to avoid Python calls like <code class="Code-In-Text--PACKT-">range</code> or similar. Don't be afraid to test different approaches to see what's faster to execute.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">The code is not particularly good; it attempts too many divisions in general. It is just for the purpose of showing example code that may make sense to be compiled and is not too complicated.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">Once the <code class="Code-In-Text--PACKT-">pyx</code> file is ready, it can be compiled and imported into Python, using Cython. First, we need to install Cython:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="language-bash">pip install cython</span>&#13;&#13;
Collecting cython&#13;&#13;
  Using cached Cython-0.29.24-cp39-cp39-macosx_10_9_x86_64.whl (1.9 MB)&#13;&#13;
Installing collected packages: cython&#13;&#13;
Successfully installed cython-0.29.24&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">Now, using <code class="Code-In-Text--PACKT-">pyximport</code>, we can import the module directly like a <code class="Code-In-Text--PACKT-">py</code> file. Cython will automatically compile it if necessary:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">&gt;&gt;&gt;</span> <span class="hljs-con-keyword">import</span><span class="language-python"> pyximport</span>&#13;&#13;
<span class="hljs-con-meta">&gt;&gt;&gt;</span> <span class="language-python">pyximport.install()</span>&#13;&#13;
(None, &lt;pyximport.pyximport.PyxImporter object at 0x10684a190&gt;)&#13;&#13;
<span class="hljs-con-meta">&gt;&gt;&gt;</span> <span class="hljs-con-keyword">import</span><span class="language-python"> wheel_package_compiled</span>&#13;&#13;
venv/lib/python3.9/site-packages/Cython/Compiler/Main.py:369: FutureWarning: Cython directive 'language_level' not set, using 2 for now (Py2). This will change in a later release! File: wheel_package_compiled.pyx&#13;&#13;
  tree = Parsing.p_module(s, pxd, full_module_name)&#13;&#13;
.pyxbld/temp.macosx-11-x86_64-3.9/pyrex/wheel_package_compiled.c:1149:35: warning: comparison of integers of different signs: 'int' and 'unsigned int' [-Wsign-compare]&#13;&#13;
    __pyx_t_1 = ((__pyx_v_counter &lt; __pyx_v_number) != 0);&#13;&#13;
                  ~~~~~~~~~~~~~~~ ^ ~~~~~~~~~~~~~~&#13;&#13;
1 warning generated.&#13;&#13;
<span class="hljs-con-meta">&gt;&gt;&gt;</span> <span class="language-python">wheel_package_compiled.check_if_prime(</span><span class="hljs-con-number">5</span><span class="language-python">)</span>&#13;&#13;
   True&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">You can see that the compiler produces an error because there's a comparison between <code class="Code-In-Text--PACKT-">unsigned int</code> and <code class="Code-In-Text--PACKT-">int</code> (between <code class="Code-In-Text--PACKT-">counter</code> and <code class="Code-In-Text--PACKT-">number</code>). </p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">This has been deliberately left to clearly show when the compilation takes place and that any compilation feedback, such as warnings or errors, will be displayed.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">Once the <a id="_idIndexMarker792"/>code is compiled, Cython creates both a <code class="Code-In-Text--PACKT-">wheel_package_compiled.c</code> file, local to the directory, and the compiled <code class="Code-In-Text--PACKT-">.so</code> file, which, by default, is stored in <code class="Code-In-Text--PACKT-">$HOME/ .pyxbld</code>:</p>&#13;&#13;
    <div class="note">&#13;&#13;
      <p class="Information-Box--PACKT-">Note that this will be specific to your system. Here, we are showing a module compiled for macOS.</p>&#13;&#13;
    </div>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="hljs-con-built_in">ls</span><span class="language-bash"> ~/.pyxbld/lib.macosx-11-x86_64-3.9/</span>&#13;&#13;
wheel_package_compiled.cpython-39-darwin.so&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">Using <code class="Code-In-Text--PACKT-">pyximport</code> is good for local development, but we can create a package that compiles and packages it as part of the build process. </p>&#13;&#13;
    <h1 id="_idParaDest-231" class="title">Python package with binary code</h1>&#13;&#13;
    <p class="normal">We will use the code we created using Cython to show how to build a package that combines <a id="_idIndexMarker793"/>Python code with precompiled code. We will generate a <code class="Code-In-Text--PACKT-">Wheel</code> file.</p>&#13;&#13;
    <p class="normal">We create <a id="_idIndexMarker794"/>a package called <code class="Code-In-Text--PACKT-">wheel_package_compiled</code> that extends the previous example package, <code class="Code-In-Text--PACKT-">wheel_package</code>, with the code presented to be compiled in Cython.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">The code is available in GitHub at <a href="https://github.com/PacktPublishing/Python-Architecture-Patterns/tree/main/chapter_11_package_management/wheel_package_compiled"><span class="url">https://github.com/PacktPublishing/Python-Architecture-Patterns/tree/main/chapter_11_package_management/wheel_package_compiled</span></a>.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">The structure of the package will be like this:</p>&#13;&#13;
    <pre class="programlisting code"><code class="hljs-code">wheel_package_compiled&#13;&#13;
    ├── LICENSE&#13;&#13;
    ├── README&#13;&#13;
    ├── src&#13;&#13;
    │   ├── __init__.py&#13;&#13;
    │   ├── submodule&#13;&#13;
    │   │   ├── __init__.py&#13;&#13;
    │   │   └── submodule.py&#13;&#13;
    │   ├── wheel_package.py&#13;&#13;
    │   └── wheel_package_compiled.pyx&#13;&#13;
    └── setup.py&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">This is the same as the package introduced previously, but with the addition of the <code class="Code-In-Text--PACKT-">.pyx</code> file. The <code class="Code-In-Text--PACKT-">setup.py</code> file needs to add some changes:</p>&#13;&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">import</span> setuptools&#13;&#13;
<span class="hljs-keyword">from</span> Cython.Build <span class="hljs-keyword">import</span> cythonize&#13;&#13;
<span class="hljs-keyword">from</span> distutils.extension <span class="hljs-keyword">import</span> Exteldnsion&#13;&#13;
extensions = [&#13;&#13;
    Extension(<span class="hljs-string">"wheel_package_compiled"</span>, [<span class="hljs-string">"src/wheel_package_compiled.pyx"</span>]),&#13;&#13;
]&#13;&#13;
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">'README'</span>) <span class="hljs-keyword">as</span> readme:&#13;&#13;
    description = readme.read()&#13;&#13;
setuptools.setup(&#13;&#13;
    name=<span class="hljs-string">'wheel-package-compiled'</span>,&#13;&#13;
    version=<span class="hljs-string">'0.0.1'</span>,&#13;&#13;
    author=<span class="hljs-string">'you'</span>,&#13;&#13;
    author_email=<span class="hljs-string">'me@you.com'</span>,&#13;&#13;
    description=<span class="hljs-string">'an example of a package'</span>,&#13;&#13;
    url=<span class="hljs-string">'http://site.com'</span>,&#13;&#13;
    long_description=description,&#13;&#13;
    classifiers=[&#13;&#13;
        <span class="hljs-string">'Programming Language :: Python :: 3'</span>,&#13;&#13;
        <span class="hljs-string">'Operating System :: OS Independent'</span>,&#13;&#13;
        <span class="hljs-string">'License :: OSI Approved :: MIT License'</span>,&#13;&#13;
    ],&#13;&#13;
    package_dir={<span class="hljs-string">''</span>: <span class="hljs-string">'src'</span>},&#13;&#13;
    install_requires=[&#13;&#13;
        <span class="hljs-string">'requests'</span>,&#13;&#13;
    ],&#13;&#13;
    ext_modules=cythonize(extensions),&#13;&#13;
    packages=setuptools.find_packages(where=<span class="hljs-string">'src'</span>),&#13;&#13;
    python_requires=<span class="hljs-string">'&gt;=3.9'</span>,&#13;&#13;
)&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">The changes <a id="_idIndexMarker795"/>introduced, other than the <code class="Code-In-Text--PACKT-">name</code> change for the package, are all related to the new extension:</p>&#13;&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">from</span> Cython.Build <span class="hljs-keyword">import</span> cythonize&#13;&#13;
<span class="hljs-keyword">from</span> distutils.extension <span class="hljs-keyword">import</span> Extension&#13;&#13;
extensions = [&#13;&#13;
    Extension(<span class="hljs-string">"wheel_package_compiled"</span>, [<span class="hljs-string">"src/wheel_package_compiled.pyx"</span>]),&#13;&#13;
]&#13;&#13;
...&#13;&#13;
ext_modules=cythonize(extensions),&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">The extension definition targets the name of the module to add, and the location of the source. With the <code class="Code-In-Text--PACKT-">cythonize</code> function, we are indicating that we want to use Cython to compile it.</p>&#13;&#13;
    <div class="note">&#13;&#13;
      <p class="Information-Box--PACKT-">Extension modules are modules compiled in C/C++. In this case, Cython will run the intermediate steps to be sure that the proper <code class="Code-In-Text--PACKT-">.c</code> file is the one being compiled.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">Once this <a id="_idIndexMarker796"/>is configured, we can run the code to generate the wheel, calling <code class="Code-In-Text--PACKT-">setup.py</code>:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="language-bash">python setup.py bdist_wheel</span>&#13;&#13;
Compiling src/wheel_package_compiled.pyx because it changed.&#13;&#13;
[1/1] Cythonizing src/wheel_package_compiled.pyx&#13;&#13;
...&#13;&#13;
running bdist_wheel&#13;&#13;
running build&#13;&#13;
running build_py&#13;&#13;
...&#13;&#13;
creating 'dist/wheel_package_compiled-0.0.1-cp39-cp39-macosx_11_0_x86_64.whl' and adding 'build/bdist.macosx-11-x86_64/wheel' to it&#13;&#13;
adding 'wheel_package_compiled.cpython-39-darwin.so'&#13;&#13;
adding 'submodule/__init__.py'&#13;&#13;
adding 'submodule/submodule.py'&#13;&#13;
adding 'wheel_package_compiled-0.0.1.dist-info/LICENSE'&#13;&#13;
adding 'wheel_package_compiled-0.0.1.dist-info/METADATA'&#13;&#13;
adding 'wheel_package_compiled-0.0.1.dist-info/WHEEL'&#13;&#13;
adding 'wheel_package_compiled-0.0.1.dist-info/top_level.txt'&#13;&#13;
adding 'wheel_package_compiled-0.0.1.dist-info/RECORD'&#13;&#13;
removing build/bdist.macosx-11-x86_64/wheel&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">The compiled <code class="Code-In-Text--PACKT-">Wheel</code> is available, as before, in the <code class="Code-In-Text--PACKT-">dist</code> subdirectory.</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="hljs-con-built_in">ls</span><span class="language-bash"> dist</span>&#13;&#13;
wheel_package_compiled-0.0.1-cp39-cp39-macosx_11_0_x86_64.whl&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">Compared with the <code class="Code-In-Text--PACKT-">Wheel</code> created previously, we can see that it adds the platform and hardware architecture (macOS 11 and x86 64 bits, which is the computer used to compile it while writing the book). The <code class="Code-In-Text--PACKT-">cp39</code> part shows that it used the Python 3.9 ABI (Application Binary Interface).</p>&#13;&#13;
    <p class="normal">The created <code class="Code-In-Text--PACKT-">Wheel</code> is ready to use for the same architecture and system. The <code class="Code-In-Text--PACKT-">Wheel</code> package directly includes all the compiled code, so the package will install quickly, as only copying files is involved. Also, there will be no need to install compilation tools and dependencies.</p>&#13;&#13;
    <p class="normal">When working <a id="_idIndexMarker797"/>with packages that need to be installed in multiple architectures or systems, you'll need to create an individual <code class="Code-In-Text--PACKT-">Wheel</code> for each case and add the source distribution file to allow other systems to work with it. </p>&#13;&#13;
    <p class="normal">But, unless you are creating a general package to be submitted to PyPI, the package will be for self-consumption, and normally you only need to create a <code class="Code-In-Text--PACKT-">Wheel</code> file for your specific use case.</p>&#13;&#13;
    <p class="normal">Which leads to the same step. What if you want to share your module with the whole Python community?</p>&#13;&#13;
    <h1 id="_idParaDest-232" class="title">Uploading your package to PyPI</h1>&#13;&#13;
    <p class="normal">PyPI is open <a id="_idIndexMarker798"/>to accepting packages <a id="_idIndexMarker799"/>from any developer. We can create a new account and upload our packages to the official Python repo to allow any project to use it.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">One of the great characteristics of open source projects, like Python and its ecosystem, is the ability to use code that is gracefully shared by other developers. While not mandatory, it is always good to give back and to share code that could be of interest to other developers to increase the usefulness of the Python library. </p>&#13;&#13;
      <p class="Tip--PACKT-">Be a good participant in the Python ecosystem and share code that could be useful to others.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">To help with <a id="_idIndexMarker800"/>testing and to be sure that we can verify the process, there's a testing site called <strong class="keyword">TestPyPI</strong> at <a href="https://test.pypi.org/"><span class="url">https://test.pypi.org/</span></a> that can be used to perform tests and to upload your package first.</p>&#13;&#13;
    <figure class="mediaobject"><img src="Images/B17580_11_04.png" alt="Graphical user interface, website&#13;&#10;&#13;&#10;Description automatically generated" width="826" height="584"/></figure>&#13;&#13;
    <p class="packt_figref">Figure 11.4: TestPyPI main page</p>&#13;&#13;
    <p class="normal">The site <a id="_idIndexMarker801"/>is the same as the production <a id="_idIndexMarker802"/>one but indicates with a banner that it's the testing site.</p>&#13;&#13;
    <p class="normal">You can register a new user at <a href="https://test.pypi.org/account/register/"><span class="url">https://test.pypi.org/account/register/</span></a>. After that, you'll need to create a new API token to allow the package to be uploaded.</p>&#13;&#13;
    <div class="note">&#13;&#13;
      <p class="Information-Box--PACKT-">Remember to verify your email. Without a verified email, you won't be able to create an API token.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">If there's a problem with the API token or you lose it, you can always delete it and start again.</p>&#13;&#13;
    <figure class="mediaobject"><img src="Images/B17580_11_05.png" alt="Graphical user interface, text, application&#13;&#10;&#13;&#10;Description automatically generated" width="826" height="567"/></figure>&#13;&#13;
    <p class="packt_figref">Figure 11.5: You'll need to grant the full scope to upload a new package</p>&#13;&#13;
    <p class="normal">Create <a id="_idIndexMarker803"/>a new token and copy it to a <a id="_idIndexMarker804"/>safe place. The token (which starts with <code class="Code-In-Text--PACKT-">pypi-</code>) will only be displayed once for safety reasons, so be careful with it.</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-">The token replaces the login and password when uploading a package. We will see later how to use it.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">The next step is to install the <code class="Code-In-Text--PACKT-">twine</code> package, which simplifies the process of uploading. Be sure to install it in our virtual environment:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con">(venv) $ pip install twine&#13;&#13;
Collecting twine&#13;&#13;
  Downloading twine-3.4.2-py3-none-any.whl (34 kB)&#13;&#13;
...&#13;&#13;
Installing collected packages: zipp, webencodings, six, Pygments, importlib-metadata, docutils, bleach, tqdm, rfc3986, requests-toolbelt, readme-renderer, pkginfo, keyring, colorama, twine&#13;&#13;
Successfully installed Pygments-2.10.0 bleach-4.1.0 colorama-0.4.4 docutils-0.17.1 importlib-metadata-4.8.1 keyring-23.2.0 pkginfo-1.7.1 readme-renderer-29.0 requests-toolbelt-0.9.1 rfc3986-1.5.0 six-1.16.0 tqdm-4.62.2 twine-3.4.2 webencodings-0.5.1 zipp-3.5.0&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">Now we can upload the packages created in the <code class="Code-In-Text--PACKT-">dist</code> subdirectory. </p>&#13;&#13;
    <div class="note">&#13;&#13;
      <p class="Information-Box--PACKT-">For our example, we will use the same package created previously, but keep in mind that trying to reupload it may not work, as there may already be a package called that in TestPyPI. TestPyPI is not permanent, and regularly deletes packages, but the example uploaded as part of the writing process of the book could still be there. To do your tests, create your own package with a unique name.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">We have <a id="_idIndexMarker805"/>now built the compiled <code class="Code-In-Text--PACKT-">Wheel</code> and the source distribution:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con">(venv) $ ls dist&#13;&#13;
wheel-package-compiled-0.0.1.tar.gz&#13;&#13;
wheel_package_compiled-0.0.1-cp39-cp39-macosx_11_0_x86_64.whl&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">Let's upload <a id="_idIndexMarker806"/>the packages. We need to indicate that we want to upload to the <code class="Code-In-Text--PACKT-">testpy</code> repo. We will use <code class="Code-In-Text--PACKT-">__token__</code> as the username and the full token (including the <code class="Code-In-Text--PACKT-">pypi-</code> prefix) as the password:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con">(venv) $ python -m twine upload --repository testpypi dist/*&#13;&#13;
Uploading distributions to https://test.pypi.org/legacy/&#13;&#13;
Enter your username: __token__&#13;&#13;
Enter your password:&#13;&#13;
Uploading wheel_package_compiled-0.0.1-cp39-cp39-macosx_11_0_x86_64.whl&#13;&#13;
<span class="hljs-con-meta">100%</span><span class="language-bash">|███████████████████████████████████████████████████████████████████████| 12.6k/12.6k [00:01&lt;00:00, 7.41kB/s]</span>&#13;&#13;
Uploading wheel-package-compiled-0.0.1.tar.gz&#13;&#13;
<span class="hljs-con-meta">100%</span><span class="language-bash">|███████████████████████████████████████████████████████████████████████| 24.0k/24.0k [00:00&lt;00:00, 24.6kB/s]</span>&#13;&#13;
View at:&#13;&#13;
https://test.pypi.org/project/wheel-package-compiled/0.0.1/&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">The package <a id="_idIndexMarker807"/>is now uploaded! We <a id="_idIndexMarker808"/>can check the page on the TestPyPI website.</p>&#13;&#13;
    <figure class="mediaobject"><img src="Images/B17580_11_06.png" alt="Graphical user interface, website&#13;&#10;&#13;&#10;Description automatically generated" width="826" height="554"/></figure>&#13;&#13;
    <p class="packt_figref">Figure 11.6: Main page for the package</p>&#13;&#13;
    <p class="normal">You can verify the uploaded files by clicking <strong class="screenText">Download files</strong>:</p>&#13;&#13;
    <figure class="mediaobject"><img src="Images/B17580_11_07.png" alt="Graphical user interface, application, website&#13;&#10;&#13;&#10;Description automatically generated" width="826" height="568"/></figure>&#13;&#13;
    <p class="packt_figref">Figure 11.7: Verifying the uploaded files</p>&#13;&#13;
    <p class="normal">You can <a id="_idIndexMarker809"/>also access the files through <a id="_idIndexMarker810"/>the search function:</p>&#13;&#13;
    <figure class="mediaobject"><img src="Images/B17580_11_08.png" alt="Graphical user interface, website&#13;&#10;&#13;&#10;Description automatically generated" width="826" height="543"/></figure>&#13;&#13;
    <p class="packt_figref">Figure 11.8: The package available in search</p>&#13;&#13;
    <p class="normal">You can <a id="_idIndexMarker811"/>now download the package <a id="_idIndexMarker812"/>directly through <code class="Code-In-Text--PACKT-">pip</code>, but you need to indicate that the index to use is the TestPyPI one. To ensure a clean installation, create a new virtual environment as follows:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="language-bash">python3 -m venv venv2</span>&#13;&#13;
<span class="hljs-con-meta">$ </span><span class="hljs-con-built_in">source</span><span class="language-bash"> ./venv2/bin/activate</span>&#13;&#13;
(venv2) $ pip install --index-url https://test.pypi.org/simple/ wheel-package-compiled&#13;&#13;
Looking in indexes: https://test.pypi.org/simple/&#13;&#13;
Collecting wheel-package-compiled&#13;&#13;
  Downloading https://test-files.pythonhosted.org/packages/87/c3/881298cdc8eb6ad23456784c80d585b5872581d6ceda6da3dfe3bdcaa7ed/wheel_package_compiled-0.0.1-cp39-cp39-macosx_11_0_x86_64.whl (9.6 kB)&#13;&#13;
Collecting requests&#13;&#13;
  Downloading https://test-files.pythonhosted.org/packages/6d/00/8ed1b6ea43b10bfe28d08e6af29fd6aa5d8dab5e45ead9394a6268a2d2ec/requests-2.5.4.1-py2.py3-none-any.whl (468 kB)&#13;&#13;
     |████████████████████████████████| 468 kB 634 kB/s&#13;&#13;
Installing collected packages: requests, wheel-package-compiled&#13;&#13;
Successfully installed requests-2.5.4.1 wheel-package-compiled-0.0.1&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">Note that the version downloaded is the <code class="Code-In-Text--PACKT-">Wheel</code> one, as it is the right target for the compiled version. It also correctly downloads the specified <code class="Code-In-Text--PACKT-">requests</code> dependency.</p>&#13;&#13;
    <p class="normal">You can now test the package through the Python interpreter:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con">(venv2) $ python&#13;&#13;
Python 3.9.6 (default, Jun 29 2021, 05:25:02)&#13;&#13;
[Clang 12.0.5 (clang-1205.0.22.9)] on darwin&#13;&#13;
Type "help", "copyright", "credits" or "license" for more information.&#13;&#13;
<span class="hljs-con-meta">&gt;&gt;&gt;</span> <span class="hljs-con-keyword">import</span><span class="language-python"> wheel_package_compiled</span>&#13;&#13;
<span class="hljs-con-meta">&gt;&gt;&gt;</span> <span class="language-python">wheel_package_compiled.check_if_prime(</span><span class="hljs-con-number">5</span><span class="language-python">)</span>&#13;&#13;
True&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">The package is <a id="_idIndexMarker813"/>now installed and ready <a id="_idIndexMarker814"/>to use. The next step is to upload this package to production PyPI instead of TestPyPI. This is totally analogous to the process that we've seen here, creating an account in PyPI and proceeding from there. </p>&#13;&#13;
    <p class="normal">But, what if the objective of the package is not to create a publicly available package? It is possible that we need to create our own index with our packages.</p>&#13;&#13;
    <h1 id="_idParaDest-233" class="title">Creating your own private index</h1>&#13;&#13;
    <p class="normal">Sometimes, you'll need to have your own private index, so you can serve your own packages without <a id="_idIndexMarker815"/>opening them to the full internet, for internal packages that need to be used across the company, but where it doesn't make sense to upload them to the public PyPI.</p>&#13;&#13;
    <p class="normal">You can create your own private index that can be used to share those packages and install them by calling to that index.</p>&#13;&#13;
    <p class="normal">To serve the packages, we need to run a PyPI server locally. There are several options in terms of available servers that can be used, but an easy option is <code class="Code-In-Text--PACKT-">pypiserver</code> (<a href="https://github.com/pypiserver/pypiserver"><span class="url">https://github.com/pypiserver/pypiserver</span></a>).</p>&#13;&#13;
    <div class="packt_tip">&#13;&#13;
      <p class="Tip--PACKT-"><code class="Code-In-Text--PACKT-">pypiserver</code> can be installed <a id="_idIndexMarker816"/>in several ways; we will see how to run it locally, but to serve it correctly, you'll need to install it in a way that's available in your network. Check the documentation to see several options, but a good option is to use the official Docker image available.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">To run <code class="Code-In-Text--PACKT-">pypiserver</code>, first, install <a id="_idIndexMarker817"/>the package using <code class="Code-In-Text--PACKT-">pip</code> and create a directory for storing the packages:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="language-bash">pip install pypiserver</span>&#13;&#13;
Collecting pypiserver&#13;&#13;
  Downloading pypiserver-1.4.2-py2.py3-none-any.whl (77 kB)&#13;&#13;
     |████████████████████████████████| 77 kB 905 kB/s&#13;&#13;
Installing collected packages: pypiserver&#13;&#13;
Successfully installed pypiserver-1.4.2&#13;&#13;
<span class="hljs-con-meta">$ </span><span class="hljs-con-built_in">mkdir</span><span class="language-bash"> ./package-library</span>&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">Start the server. We use the parameter <code class="Code-In-Text--PACKT-">-p 8080</code> to serve it in that port, the directory to store the packages, and <code class="Code-In-Text--PACKT-">-P . -a .</code> to facilitate the uploading of packages without authentication:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="language-bash">pypi-server -P . -a . -p 8080 ./package-library</span>&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">Open a browser and check <code class="Code-In-Text--PACKT-">http://localhost:8080</code>.</p>&#13;&#13;
    <figure class="mediaobject"><img src="Images/B17580_11_09.png" alt="Graphical user interface, text, application, email&#13;&#10;&#13;&#10;Description automatically generated" width="829" height="576"/></figure>&#13;&#13;
    <p class="packt_figref">Figure 11.9: Local pypi server</p>&#13;&#13;
    <p class="normal">You can <a id="_idIndexMarker818"/>check the available packages in this index by going to <code class="Code-In-Text--PACKT-">http://localhost:8080/simple/</code>.</p>&#13;&#13;
    <figure class="mediaobject"><img src="Images/B17580_11_10.png" alt="Graphical user interface, text&#13;&#10;&#13;&#10;Description automatically generated" width="826" height="376"/></figure>&#13;&#13;
    <p class="packt_figref">Figure 11.10: Empty index so far</p>&#13;&#13;
    <p class="normal">We now <a id="_idIndexMarker819"/>need to upload the packages, using <code class="Code-In-Text--PACKT-">twine</code> again, but pointing to our private URL. As we are able to upload with no authentication, we can enter an empty username and password:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="language-bash">python -m twine upload --repository-url http://localhost:8080 dist/*</span>&#13;&#13;
Uploading distributions to http://localhost:8080&#13;&#13;
Enter your username:&#13;&#13;
Enter your password:&#13;&#13;
Uploading wheel_package_compiled-0.0.1-cp39-cp39-macosx_11_0_x86_64.whl&#13;&#13;
<span class="hljs-con-meta">100%</span><span class="language-bash">|████████████████████████████████| 12.6k/12.6k [00:00&lt;00:00, 843kB/s]</span>&#13;&#13;
Uploading wheel-package-compiled-0.0.1.tar.gz&#13;&#13;
<span class="hljs-con-meta">100%</span><span class="language-bash">|████████████████████████████████| 24.0k/24.0k [00:00&lt;00:00, 2.18MB/s]</span>&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">The index <a id="_idIndexMarker820"/>is now showing the package available.</p>&#13;&#13;
    <figure class="mediaobject"><img src="Images/B17580_11_11.png" alt="Graphical user interface, application&#13;&#10;&#13;&#10;Description automatically generated" width="826" height="376"/></figure>&#13;&#13;
    <p class="packt_figref">Figure 11.11: Showing the package uploaded</p>&#13;&#13;
    <figure class="mediaobject"><img src="Images/B17580_11_12.png" alt="Graphical user interface, text, application&#13;&#10;&#13;&#10;Description automatically generated" width="826" height="377"/></figure>&#13;&#13;
    <p class="packt_figref">Figure 11.12: All the uploaded files for the package</p>&#13;&#13;
    <p class="normal">The files <a id="_idIndexMarker821"/>are also uploaded to the <code class="Code-In-Text--PACKT-">package-library</code> directory:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="hljs-con-built_in">ls</span><span class="language-bash"> package-library</span>&#13;&#13;
wheel-package-compiled-0.0.1.tar.gz&#13;&#13;
wheel_package_compiled-0.0.1-cp39-cp39-macosx_11_0_x86_64.whl&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">Any file added to <code class="Code-In-Text--PACKT-">package-library</code> will also be served, allowing packages to be added by moving them to the directory, although that could be complicated once the server is deployed properly to the packages over the network.</p>&#13;&#13;
    <p class="normal">The package can now be downloaded and installed, pointing to your private index using the <code class="Code-In-Text--PACKT-">–index-url</code> parameter:</p>&#13;&#13;
    <pre class="programlisting con"><code class="hljs-con">$ pip install --index-url http://localhost:8080 wheel-package-compiled&#13;&#13;
Looking in indexes: http://localhost:8080&#13;&#13;
Collecting wheel-package-compiled&#13;&#13;
  Downloading http://localhost:8080/packages/wheel_package_compiled-0.0.1-cp39-cp39-macosx_11_0_x86_64.whl (9.6 kB)&#13;&#13;
…&#13;&#13;
Successfully installed certifi-2021.5.30 charset-normalizer-2.0.4 idna-3.2 requests-2.26.0 urllib3-1.26.6 wheel-package-compiled-0.0.1&#13;&#13;
$ python&#13;&#13;
Python 3.9.6 (default, Jun 29 2021, 05:25:02)&#13;&#13;
[Clang 12.0.5 (clang-1205.0.22.9)] on darwin&#13;&#13;
Type "help", "copyright", "credits" or "license" for more information.&#13;&#13;
<span class="hljs-con-meta">&gt;&gt;&gt;</span> <span class="hljs-con-keyword">import</span><span class="language-python"> wheel_package_compiled</span>&#13;&#13;
<span class="hljs-con-meta">&gt;&gt;&gt;</span> <span class="language-python">wheel_package_compiled.check_if_prime(</span><span class="hljs-con-number">5</span><span class="language-python">)</span>&#13;&#13;
True&#13;&#13;
</code></pre>&#13;&#13;
    <p class="normal">This tests <a id="_idIndexMarker822"/>that the module can be imported and executed after installation.</p>&#13;&#13;
    <h1 id="_idParaDest-234" class="title">Summary</h1>&#13;&#13;
    <p class="normal">In this chapter, we described when it's a good idea to create a standard package and the caveats and requirements that we should add to be sure that we are taking a good decision. In essence, creating a new package is creating a new project, and we should give the proper ownership, documentation, and so on, as expected of other projects in the organization.</p>&#13;&#13;
    <p class="normal">We described the simplest possible package in Python just by structuring code, but without creating a proper package. This acts as a baseline on how the code should be structured later.</p>&#13;&#13;
    <p class="normal">We continued describing what the current packaging environment is and what are the different elements that are part of it, like PyPI, which is the official source for publicly available packages, and how to create virtual environments to not cross-contaminate different environments when requiring different dependencies. We also described the <code class="Code-In-Text--PACKT-">Wheel</code> package, which will be the kind of package that we will create later.</p>&#13;&#13;
    <p class="normal">Next, we described how to create such a package, creating a <code class="Code-In-Text--PACKT-">setup.py</code> file. We described how to install it in development mode to be able to do tests and how to build and get the package ready.</p>&#13;&#13;
    <div class="note">&#13;&#13;
      <p class="Information-Box--PACKT-">There are some alternatives to creating packages instead of using the standard <code class="Code-In-Text--PACKT-">setup.py</code> file. You can take a look at the <code class="Code-In-Text--PACKT-">Poetry</code> package (<a href="https://python-poetry.org/"><span class="url">https://python-poetry.org/</span></a>) to see how to manage packages in a more integrated way, especially if the package has many dependencies.</p>&#13;&#13;
    </div>&#13;&#13;
    <p class="normal">We took a small detour to explain how to generate code to be compiled with Cython, an easy way to create Python extensions writing in Python code with some extensions, to generate C code automatically.</p>&#13;&#13;
    <p class="normal">We used Cython code to show how to generate a compiled <code class="Code-In-Text--PACKT-">Wheel</code>, allowing the distribution of already precompiled code without needing to be compiled on installation.</p>&#13;&#13;
    <p class="normal">We showed how to upload packages to PyPI to distribute publicly (showing how to upload to TestPyPI, allowing the upload of packages to be tested) and described how to create your own individual index so that you can distribute your own packages privately.</p>&#13;&#13;
  </div>&#13;&#13;
</div></body></html>