<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;Testing Web Application Frontends using Twill"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Testing Web Application Frontends using Twill</h1></div></div></div><p>
<span class="emphasis"><em>We haven't talked at all about testing user interfaces. Mostly because graphical user interfaces are not very amenable to being checked by automated testing tools (it can be difficult to feed input to the system and difficult to disentangle all of the units involved). However, web applications are an exception to that rule, and their importance keeps increasing.</em></span>
</p><p>In this chapter, we shall:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Learn to use Twill to script interactions with web sites</li><li class="listitem" style="list-style-type: disc">Learn how run Twill scripts from inside a testing framework</li><li class="listitem" style="list-style-type: disc">Learn how to integrate Twill operations directly into unittest tests</li></ul></div><p>So let's get on with it!</p><div class="section" title="Installing Twill"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec71"/>Installing Twill</h1></div></div></div><a class="indexterm" id="id401"/><p>You can find Twill in the Python Package Index at <a class="ulink" href="http://pypi.python.org/pypi/twill/">http://pypi.python.org/pypi/twill/</a>. At the time of writing, the latest version can be directly downloaded from <a class="ulink" href="http://darcs.idyll.org/~t/projects/twill-0.9.tar.gz">http://darcs.idyll.org/~t/projects/twill-0.9.tar.gz</a>. </p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note28"/>Note</h3><p>Windows users will need to use an archiving program which understands Tar and GZip formats, such as 7-Zip (<a class="ulink" href="http://www.7-zip.org/">http://www.7-zip.org/</a>) to extract the files.</p></div></div><p>Once you have the files unpacked, you can install them by opening a command prompt, changing to the <code class="literal">twill-0.9</code> directory, and running:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ python setup.py install</strong></span>
</pre></div><p>or, if you can't write to Python's <code class="literal">site-packages</code> directory,</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ python setup.py install --user</strong></span>
<a class="indexterm" id="id402"/>
</pre></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note29"/>Note</h3><p>If you're using a version of Python older than 2.6, you won't be able to do a <code class="literal">--user</code> installation, which means you'll need to have write access to the Python installation's <code class="literal">site-packages</code> directory.</p></div></div></div></div>
<div class="section" title="Exploring the Twill language"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec72"/>Exploring the Twill language</h1></div></div></div><a class="indexterm" id="id403"/><a class="indexterm" id="id404"/><p>Now that you've installed Twill, you can open a shell program that lets you interactively explore its language and capabilities. We'll go through some of the most useful ones here.</p></div>
<div class="section" title="Time for action &#x2013; browsing the web with Twill"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec73"/>Time for action – browsing the web with Twill</h1></div></div></div><a class="indexterm" id="id405"/><a class="indexterm" id="id406"/><p>We'll take Twill for a spin, using its interactive interpreter.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Start the interactive Twill interpreter:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ twill-sh</strong></span>
</pre></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note30"/>Note</h3><p>You may notice a couple of warnings about the deprecated <code class="literal">md5</code> module when you start Twill. You may safely ignore them.</p></div></div></li><li class="listitem">Get a list of Twill commands. You can get further information about a specific command by typing <code class="literal">help &lt;command&gt;</code> at the prompt.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt; help</strong></span>
</pre></div><div class="mediaobject"><img alt="Time for action – browsing the web with Twill" src="graphics/8846_08_01.jpg"/></div></li><li class="listitem">Tell Twill to go to a web site. Although <code class="literal">slashdot.org</code> is used in this example, the reader is encouraged to try out other sites as well.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt; go http://slashdot.org/</strong></span>
</pre></div><p>Twill will print out a couple of lines indicating that it is now browsing <a class="ulink" href="http://slashdot.org/">http://slashdot.org/</a>.</p></li><li class="listitem">Check that the web server returned a 'no error' code (which is to say, <code class="literal">code 200</code>). We could just as easily check for other codes—for example, making sure that our interface returned an error when asked to do something invalid.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt; code 200</strong></span>
</pre></div></li><li class="listitem">Follow a link, which is specified by providing a regular expression. If you're not comfortable with regular expressions—or even if you are—you're usually fine by just specifying enough of the link text to identify the one that you want to follow. After following the link, check the code again to make sure it worked.<div class="informalexample"><pre class="programlisting">
<a class="indexterm" id="id407"/>
<span class="strong"><strong>&gt;&gt; follow Science</strong></span>
<span class="strong"><strong>&gt;&gt; code 200</strong></span>
</pre></div></li><li class="listitem">F<a class="indexterm" id="id408"/>ill in a form field. This fills the first field of the second form with the word <span class="strong"><strong>monkey</strong></span>. At the time of this writing, the second form is a search form, and the first field is the search box. If the page layout were to change, this example wouldn't be correct any more.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt; formvalue 2 1 "monkey"</strong></span>
</pre></div></li><li class="listitem">We can also refer to forms and form fields by name (if they have names). The specific form used here doesn't have a name, but the field does. The following sets the value of the same field as the command in step 6, this time to the value <span class="strong"><strong>aardvark</strong></span>.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt; formvalue 2 fhfilter "aardvark"</strong></span>
</pre></div></li><li class="listitem">Now we can submit the form. This moves Twill to a new working URL, as well as sending information to the server.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt; submit</strong></span>
</pre></div></li><li class="listitem">Once again, we want to make sure that the server returned the expected code.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt; code 200</strong></span>
</pre></div></li><li class="listitem">Does the page contain what we expect? We can check with the <code class="literal">find</code> command. In this case, we'll be checking two things. The first is whether the word <span class="strong"><strong>aardvark</strong></span> appears within the code of the result page. With the system currently in place on <a class="ulink" href="http://slashdot.org">slashdot.org</a>, we can expect that it will. The second check, for the word <span class="strong"><strong>Elephant</strong></span> is probably going to fail.<div class="informalexample"><pre class="programlisting">
<a class="indexterm" id="id409"/>
<a class="indexterm" id="id410"/>
<span class="strong"><strong>&gt;&gt; find aardvark</strong></span>
<span class="strong"><strong>&gt;&gt; find Elephant</strong></span>
</pre></div><div class="mediaobject"><img alt="Time for action – browsing the web with Twill" src="graphics/8846_08_02.jpg"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec86"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>We used Twill to browse to <a class="ulink" href="http://slashdot.org">slashdot.org</a>, navigated into the <span class="strong"><strong>Science</strong></span> section, searched for <span class="strong"><strong>aardvark</strong></span>, and then checked to see if the resulting page contained the words <span class="strong"><strong>aardvark</strong></span> and <span class="strong"><strong>Elephant</strong></span>. Of what use it that?</p><p>We're not limited to goofing around on <a class="ulink" href="http://slashdot.org">slashdot.org</a>. We can use the Twill language to describe any interaction between a web browser and a web server. That means, we can use it to describe the expected behavior of our own web applications. If we can describe expected behavior, we can write tests.</p><p>It would be nice to be able to store the commands in a file though, so that we can automate the tests. Like any good interpreter, Twill will let us do that.</p></div></div>
<div class="section" title="Time for action &#x2013; Twill scripting"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec74"/>Time for action – Twill scripting</h1></div></div></div><p><a class="indexterm" id="id411"/>
<a class="indexterm" id="id412"/>We'll write a Twill script that checks whether a site obeys the same interface that we used for interacting with <a class="ulink" href="http://slashdot.org">slashdot.org</a>, and then applies it to a few different web sites to see what happens.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Create a file called <code class="literal">slashdot.twill</code> containing the following code:<div class="informalexample"><pre class="programlisting">code 200
follow Science
code 200
formvalue 2 fhfilter "aardvark"
submit
code 200
find aardvark</pre></div></li><li class="listitem">Now, we'll run that script on <a class="ulink" href="http://slashdot.org/">http://slashdot.org/</a> and see whether it works.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ twill-sh -u http://slashdot.org/ slashdot.twill</strong></span>
</pre></div><div class="mediaobject"><img alt="Time for action – Twill scripting" src="graphics/8846_08_03.jpg"/></div><a class="indexterm" id="id413"/></li><li class="listitem">All right, that worked nicely. So, let's see if <code class="literal">espn.com</code> works the same way as <code class="literal">slashdot.org</code> did.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ </strong></span>
<a class="indexterm" id="id414"/>
<span class="strong"><strong>twill-sh -u http://espn.com/ slashdot.twill</strong></span>
</pre></div><div class="mediaobject"><img alt="Time for action – Twill scripting" src="graphics/8846_08_04.jpg"/></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec87"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>By storing the Twill commands in a file, we were able to run them as an automated test. That's definitely a step forward for testing our web-based applications.</p><p>The <a class="indexterm" id="id415"/>
<a class="indexterm" id="id416"/>
<code class="literal">-u</code> command line option that we passed to <code class="literal">twill-sh</code> is very useful: it has the same effect as a <code class="literal">go</code> command at the start of the file, but of course we can change it every time we run the script. This is particularly helpful if you're not sure what the base URL for your web app will end up being.</p></div><div class="section" title="Twill commands"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec88"/>Twill commands</h2></div></div></div><p><a class="indexterm" id="id417"/>Twill has a number of commands, and so far we've only covered a few of them. In this section you'll find a brief discussion of each of Twill's commands.</p><div class="section" title="help"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec20"/>help</h3></div></div></div><p>The <a class="indexterm" id="id418"/>
<a class="indexterm" id="id419"/>
<code class="literal">help</code> command prints out a list of all of Twill's commands, or tells you the details of a specific command. For example, to get the details of the <code class="literal">add_auth</code> command, you should type:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt; help add_auth</strong></span>
</pre></div><div class="mediaobject"><img alt="help" src="graphics/8846_08_05.jpg"/></div><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="tip04"/>Tip</h3><p>If you want to know the detailed syntax of any of the other commands, use the <code class="literal">help</code> command to get that information.</p></div></div></div><div class="section" title="setglobal"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec21"/>setglobal</h3></div></div></div><p>The <a class="indexterm" id="id420"/>
<a class="indexterm" id="id421"/><code class="literal">setglobal</code> command assigns a value to a variable name. These variable names can then be used as parameters of later commands. Thus, if you tell Twill to:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt; setglobal target http://www.example.org/ </strong></span>
</pre></div><p>Twill will set the global variable target to the value <code class="literal">http://www.example.org/</code>. You would then be able to say:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt; go target</strong></span>
</pre></div><p>to tell Twill to go to <code class="literal">http://www.example.org/</code>.</p><p>Variable values can also be inserted into text strings by surrounding the variable name with <code class="literal">${ and }</code>, so that:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt; go "${target}/example.html"</strong></span>
</pre></div><p>tells<a class="indexterm" id="id422"/>
<a class="indexterm" id="id423"/> Twill to go to <code class="literal">http://www.example.org/example.html</code>.</p></div><div class="section" title="setlocal"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec22"/>setlocal</h3></div></div></div><p>The <a class="indexterm" id="id424"/>
<a class="indexterm" id="id425"/>
<code class="literal">setlocal</code> command behaves generally like the <code class="literal">setglobal</code> command, with one significant difference; variables bound with <code class="literal">setlocal</code> only exist while Twill is executing the same script file (or, technically, interactive session) in which they were bound. Once Twill switches to a new script, local variables are forgotten until execution returns to the original script.</p></div><div class="section" title="add_auth"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec23"/>add_auth</h3></div></div></div><p>The <a class="indexterm" id="id426"/>
<a class="indexterm" id="id427"/>
<code class="literal">add_auth</code> command lets you log in to a site protected by the Basic Authentication scheme of HTTP. The command takes four parameters, in this order: <code class="literal">realm</code>, <code class="literal">URI</code>, <code class="literal">username</code>, and <code class="literal">password</code>. The username and password are what a user would type in to gain access to the site. The URI is a prefix for all of the web addresses where you want the authentication to be applied: if you pass <code class="literal">http://example.com/</code> as the URI, the username and password might be used to login to any page on <code class="literal">example.com</code>. The realm is an arbitrary text string chosen by the server, which must be included in any authorization. If you're testing your own web app, you should already know what it is.</p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note31"/>Note</h3><p>You can find out all about HTTP Basic Authentication at <a class="ulink" href="http://tools.ietf.org/html/rfc2617#section-2">http://tools.ietf.org/html/rfc2617#section-2</a>.</p></div></div><p>So, <a class="indexterm" id="id428"/>
<a class="indexterm" id="id429"/>to log in to the example realm on example.com with the username of <code class="literal">testuser</code> and the password of <code class="literal">12345</code>, you would use the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt; add_auth example http://example.com/ testuser 12345</strong></span>
</pre></div></div><div class="section" title="add_extra_header"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec24"/>add_extra_header</h3></div></div></div><p>By <a class="indexterm" id="id430"/>
<a class="indexterm" id="id431"/>using <code class="literal">add_extra_header</code>, you can include any arbitrary HTTP header into all subsequent requests that Twill makes. The command takes two parameters: the name of the header field to be added, and the value to be assigned to the header field.</p><p>You need to keep in mind that HTTP allows the same header to exist multiple times in the same request, and to have different values each time. If you tell Twill</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt; add_extra_header moose 12</strong></span>
<span class="strong"><strong>&gt;&gt; add_extra_header moose 15</strong></span>
</pre></div><p>then there will be two 'moose' headers sent in each request, with different values.</p></div><div class="section" title="clear_extra_headers"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec25"/>clear_extra_headers</h3></div></div></div><p>The <a class="indexterm" id="id432"/>
<a class="indexterm" id="id433"/>
<code class="literal">clear_extra_headers</code> command removes all of the previously defined extra headers from future requests. Removed headers can be re-added later.</p></div><div class="section" title="show_extra_headers"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec26"/>show_extra_headers</h3></div></div></div><p>The <a class="indexterm" id="id434"/>
<a class="indexterm" id="id435"/><code class="literal">show_extra_headers</code> command prints out a list of all of the currently added extra headers, along with their values.</p></div><div class="section" title="agent"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec27"/>agent</h3></div></div></div><p>You <a class="indexterm" id="id436"/>
<a class="indexterm" id="id437"/>can make Twill masquerade as a different web browser, by using the <code class="literal">agent</code> command. You can use any user agent string as the parameter. At the time of this writing, <a class="ulink" href="http://user-agent-string.info/">http://user-agent-string.info/</a> was a useful resource for finding the user agent strings used by web browsers.</p></div><div class="section" title="back"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec28"/>back</h3></div></div></div><p>The <a class="indexterm" id="id438"/>
<a class="indexterm" id="id439"/>
<code class="literal">back</code> command works just as the back button on a web browser would, returning to the most recent URL in Twill's history.</p></div><div class="section" title="clear_cookies"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec29"/>clear_cookies</h3></div></div></div><p>The <a class="indexterm" id="id440"/>
<a class="indexterm" id="id441"/>
<code class="literal">clear_cookies</code> command causes Twill to forget all of its currently stored cookies.</p></div><div class="section" title="code"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec30"/>code</h3></div></div></div><p>The <a class="indexterm" id="id442"/>
<a class="indexterm" id="id443"/>
<code class="literal">code</code> command checks that the HTTP response code from the previous navigation command was the expected value. The value that means 'success' is <code class="literal">200</code>. <code class="literal">404</code> means that the page wasn't found, <code class="literal">401</code> means that a login is required before you can browse the page, <code class="literal">301</code> and <code class="literal">302</code> are redirects, and so on. </p><div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note32"/>Note</h3><p>You <a class="indexterm" id="id444"/>
<a class="indexterm" id="id445"/>can find a complete list of official HTTP response codes at <a class="ulink" href="http://tools.ietf.org/html/rfc2616#section-6.1.1.">http://tools.ietf.org/html/rfc2616#section-6.1.1.</a>
</p></div></div></div><div class="section" title="config"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec31"/>config</h3></div></div></div><p>The <a class="indexterm" id="id446"/>
<a class="indexterm" id="id447"/>
<code class="literal">config</code> command lets you modify the behavior of the Twill interpreter. It takes a configuration parameter name and an integer value as parameters, and Twill modifies its behavior according to the values given to the configuration variable.</p><p>For a complete list of current configuration variables, type:</p><div class="informalexample"><pre class="programlisting"><a class="indexterm" id="id448"/>
<a class="indexterm" id="id449"/>
<span class="strong"><strong>&gt;&gt; help config</strong></span>
</pre></div></div><div class="section" title="debug"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec32"/>debug</h3></div></div></div><p>The <a class="indexterm" id="id450"/>
<a class="indexterm" id="id451"/>
<code class="literal">debug</code> command causes Twill to output trace information as it operates. At the time of writing, there were three different kinds of debug trace available: HTTP, commands, and handling of the HTTP-EQUIV refresh tag.</p><p>If you tell Twill to:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt; debug http 1</strong></span>
</pre></div><p>then whenever Twill performs an HTTP operation, you'll see a printout of the request and response lines, along with the HTTP header fields that were returned with the response.</p><p>The <code class="literal">debug commands 1</code> command isn't useful when you're interacting directly with the Twill interpreter, but if you place it in a Twill script, it will cause Twill to print out each command as it executes, so that you can see what the script is doing.</p><p>If you tell Twill to</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt; debug equiv-refresh 1</strong></span>
</pre></div><p>then <a class="indexterm" id="id452"/>it will print out extra information whenever it runs across a page with a <code class="literal">&lt;META HTTP-EQUIV="refresh"...&gt;</code> tag in the header.</p></div><div class="section" title="echo"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec33"/>echo<a class="indexterm" id="id453"/>
<a class="indexterm" id="id454"/>
</h3></div></div></div><p>The <a class="indexterm" id="id455"/>
<a class="indexterm" id="id456"/>
<code class="literal">echo</code> command is useful if you want your Twill scripts to output information, but don't find that any of the <code class="literal">debug</code> subcommands really does what you want. Whatever parameters you pass to <code class="literal">echo</code>, are printed to the screen.</p></div><div class="section" title="exit"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec34"/>exit<a class="indexterm" id="id457"/>
</h3></div></div></div><p>The <a class="indexterm" id="id458"/>
<a class="indexterm" id="id459"/><code class="literal">exit</code> command causes the Twill interpreter to terminate. It takes an error code—which is just an integer, with 0 normally being interpreted as 'no error'—as an optional parameter. Even if you pass a non-zero value to <code class="literal">exit</code>, Twill will print out that the script succeeded, after all of the commands that it ran executed correctly, including <code class="literal">exit</code>. The error code is only meaningful if the program that executed Twill uses it, so in many cases it will be ignored completely.</p></div><div class="section" title="extend_with"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec35"/>extend_with</h3></div></div></div><p>The <a class="indexterm" id="id460"/>
<a class="indexterm" id="id461"/>
<code class="literal">extend_with</code> command is a mechanism for customizing the Twill interpreter. It imports a Python module, and adds any functions in it as new Twill commands.</p></div><div class="section" title="find"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec36"/>find</h3></div></div></div><p>The <a class="indexterm" id="id462"/>
<a class="indexterm" id="id463"/>
<code class="literal">find</code> command searches the current page for text that matches a regular expression. Python's regular expression syntax is described in the online docs at <a class="ulink" href="http://docs.python.org/library/re.html#regular­expression­syntax">http://docs.python.org/library/re.html#regular­expression­syntax</a>, but for our purposes it's enough to know that if you type a word, <code class="literal">find</code> will look for it.</p><p>The <code class="literal">find</code> command also accepts an optional second parameter. This parameter is a text string representing options controlling how the search is performed. If the string contains the letter <code class="literal">i</code> then the search is case-insensitive, meaning that capital and lowercase letters match with each other. The letters <code class="literal">m</code> and <code class="literal">s</code> mean to use 'MULTILINE' and 'DOTALL' modes, respectively. These modes are described in the above documentation.</p><p>The find command also binds the matched text to the local variable name <code class="literal">__match__</code>, so that you can refer to it in later commands, just as if it had been set by <code class="literal">setlocal</code>.</p></div><div class="section" title="notfind"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec37"/>notfind</h3></div></div></div><p>The <a class="indexterm" id="id464"/>
<a class="indexterm" id="id465"/>
<code class="literal">notfind</code> command works like the <code class="literal">find</code> command, except that if it finds a match for the regular expression, it fails. If it does not find a match, it succeeds.</p></div><div class="section" title="follow"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec38"/>follow</h3></div></div></div><p>The <a class="indexterm" id="id466"/>
<a class="indexterm" id="id467"/>
<code class="literal">follow</code> command searches the current page for a link that matches a regular expression, and goes to the linked address. Using <code class="literal">follow</code> is like clicking on a link in a normal web browser.</p><p>Unlike the <code class="literal">find</code> command, the follow command does not accept regular expression flags, and does not bind the <code class="literal">__match__</code> name. It just goes where the hyperlink points it.</p></div><div class="section" title="formaction"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec39"/>formaction</h3></div></div></div><p>The <a class="indexterm" id="id468"/>
<a class="indexterm" id="id469"/>
<code class="literal">formaction</code> command lets you change the address to which a form will be submitted. It takes two parameters: an identifier for the form you want to change, and the URL that you want the form submitted to.</p><p>For example, the following HTML would produce a form that would be submitted to the current URL, because that is the default when the <code class="literal">action</code> attribute is omitted from the <code class="literal">form</code> tag:</p><div class="informalexample"><pre class="programlisting">&lt;form name="form1" method="post"&gt;</pre></div><p>After executing this <code class="literal">formaction</code> command,</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt; formaction form1 http://example.com/viewer </strong></span>
</pre></div><p>it <a class="indexterm" id="id470"/>
<a class="indexterm" id="id471"/>would be as if the form had been written:</p><div class="informalexample"><pre class="programlisting">&lt;form name="form1" method="post" action="http://example.com/viewer"&gt;</pre></div></div><div class="section" title="formclear"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec40"/>formclear</h3></div></div></div><p>The <a class="indexterm" id="id472"/>
<a class="indexterm" id="id473"/>
<code class="literal">formclear</code> command resets a form to its initial state, meaning that data entered by other commands get forgotten.</p></div><div class="section" title="formfile"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec41"/>formfile</h3></div></div></div><p>The <a class="indexterm" id="id474"/>
<a class="indexterm" id="id475"/><code class="literal">formfile</code> command fills in a value for an <code class="literal">&lt;input type="file"&gt;</code> form field. It has three required parameters: the form's name or number, the field's name or number, and the filename of the file. Optionally, a fourth parameter can be added which specifies the mime content type of the file.</p></div><div class="section" title="form value"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec42"/>form<a class="indexterm" id="id476"/> value
</h3></div></div></div><p>The <a class="indexterm" id="id477"/>
<a class="indexterm" id="id478"/>
<code class="literal">formvalue</code> command fills in values for HTML form fields. It accepts three parameters: the form's name or number, the field's name or number, and the value to be assigned. We used <code class="literal">formvalue</code> in the example Twill script above.</p></div><div class="section" title="getinput"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec43"/>getinput</h3></div></div></div><p>The <a class="indexterm" id="id479"/>
<a class="indexterm" id="id480"/>
<code class="literal">getinput</code> command allows Twill scripts to be interactive. The command accepts one parameter, a prompt that will be displayed to the user. After printing the prompt, Twill waits for the user to type something and hit enter, after which whatever the user typed is stored in the local variable called <code class="literal">__input__</code>.</p></div><div class="section" title="getpassword"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec44"/>getpassword</h3></div></div></div><p>The <a class="indexterm" id="id481"/>
<a class="indexterm" id="id482"/>
<code class="literal">getpassword</code> command works mostly like <code class="literal">getinput</code>. The differences are that <code class="literal">getpassword</code> does not display the text that the user types, and that the text is bound to the local variable name <code class="literal">__password__</code> after being input.</p></div><div class="section" title="go"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec45"/>go</h3></div></div></div><p>The <a class="indexterm" id="id483"/>
<a class="indexterm" id="id484"/>
<code class="literal">go</code> command directs Twill to go to a new URL and load the page at that address. Unlike <code class="literal">follow</code>, go doesn't care what links exist on the current page. Using <code class="literal">go</code> is like typing an address into the address bar of a normal web browser.</p></div><div class="section" title="info"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec46"/>info</h3></div></div></div><p>The <a class="indexterm" id="id485"/>
<a class="indexterm" id="id486"/>
<code class="literal">info</code> command prints some general information about the page that Twill is currently browsing. This information includes the URL, the HTTP code, the MIME content-type of the page, the title, and the number of forms on the page.</p></div><div class="section" title="save_cookies"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec47"/>save_cookies</h3></div></div></div><p>The <a class="indexterm" id="id487"/>
<a class="indexterm" id="id488"/>
<code class="literal">save_cookies</code> command saves a copy of any cookies that Twill is currently aware of. These cookies can be re-loaded later. The command takes a single parameter: the file name in which to store the cookies.</p></div><div class="section" title="load_cookies"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec48"/>load_cookies</h3></div></div></div><p>The <a class="indexterm" id="id489"/>
<a class="indexterm" id="id490"/>
<code class="literal">load_cookies</code> command replaces any cookies that Twill currently knows about with the cookies stored in a file. It takes a single parameter: the filename of the cookie file to load.</p></div><div class="section" title="show_cookies"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec49"/>show_cookies</h3></div></div></div><p>The <a class="indexterm" id="id491"/>
<a class="indexterm" id="id492"/>
<code class="literal">show_cookies</code> command will print out any cookies currently aware of.</p></div><div class="section" title="redirect_error"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec50"/>redirect_error</h3></div></div></div><p>The <a class="indexterm" id="id493"/>
<a class="indexterm" id="id494"/>
<code class="literal">redirect_error</code> command causes all of Twill's error messages to be stored in a file instead of being printed to the screen. It takes a single parameter representing the file name in which to store the errors.</p></div><div class="section" title="redirect_output"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec51"/>redirect_output</h3></div></div></div><a class="indexterm" id="id495"/><a class="indexterm" id="id496"/><p>The <code class="literal">redirect_output</code> command causes Twill to save all of its normal output to a file, instead of printing it to the screen. It takes a single parameter representing the file name in which to store the output.</p><p>This is not a command that will be of much use in an interactive Twill shell. It can be useful in scripts and tests.</p></div><div class="section" title="reset_error"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec52"/>reset_error</h3></div></div></div><a class="indexterm" id="id497"/><p>The <code class="literal">reset_error</code> command undoes the effect of <code class="literal">redirect_error</code>.</p></div><div class="section" title="reset_output"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec53"/>reset_output</h3></div></div></div><a class="indexterm" id="id498"/><p>The <code class="literal">reset_output</code> command undoes the effect of <code class="literal">redirect_output</code>.</p></div><div class="section" title="reload"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec54"/>reload</h3></div></div></div><a class="indexterm" id="id499"/><p>The <code class="literal">reload</code> command reloads the current URL, just as the reload or refresh button on a normal web browser would.</p></div><div class="section" title="reset_browser"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec55"/>reset_browser</h3></div></div></div><a class="indexterm" id="id500"/><a class="indexterm" id="id501"/><p>The <code class="literal">reset_browser</code> command destroys all of the state information pertaining to the current Twill session. It has the same effect as stopping Twill and then starting it up again.</p></div><div class="section" title="run"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec56"/>run</h3></div></div></div><a class="indexterm" id="id502"/><a class="indexterm" id="id503"/><p>The <code class="literal">run</code> command executes an arbitrary Python statement.  The only parameter is the Python statement to execute. If the statement contains spaces, it must be placed within quotes, so Twill doesn't mistake it for multiple parameters.</p></div><div class="section" title="runfile"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec57"/>runfile</h3></div></div></div><a class="indexterm" id="id504"/><a class="indexterm" id="id505"/><p>The runfile command executes a Twill script that's stored in a separate file. The executed script will have its own local namespace (c.f. the <code class="literal">setlocal</code> command), and will share the global namespace (c.f. <code class="literal">setglobal</code>)</p></div><div class="section" title="save_html"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec58"/>save_html</h3></div></div></div><a class="indexterm" id="id506"/><a class="indexterm" id="id507"/><p>The <code class="literal">save_html</code> command saves the HTML content of the current page into a file. It accepts a filename to save into as an optional parameter. If no filename is specified, Twill will choose for itself based on the URL of the data being saved.</p></div><div class="section" title="show"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec59"/>show</h3></div></div></div><a class="indexterm" id="id508"/><a class="indexterm" id="id509"/><p>The <code class="literal">show</code> command prints out the HTML content of the current page. This can be useful in an interactive session for getting a handle on what Twill is seeing, and it can occasionally be useful in a test script if you want to make sure that a page has precisely specified content.</p></div><div class="section" title="showforms"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec60"/>showforms</h3></div></div></div><a class="indexterm" id="id510"/><a class="indexterm" id="id511"/><p>The <code class="literal">showforms</code> command prints out a list of all of the forms in the current page. Each form has a printout containing the form's number (and name, if it has a name), along with the numbers, names, types, ids, and current values for each field.</p></div><div class="section" title="showhistory"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec61"/>showhistory</h3></div></div></div><a class="indexterm" id="id512"/><a class="indexterm" id="id513"/><p>The <code class="literal">showhistory</code> command prints out a list of all of the URLs previously visited in the current Twill session, in order from oldest to most recent.</p></div><div class="section" title="showlinks"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec62"/>showlinks</h3></div></div></div><a class="indexterm" id="id514"/><a class="indexterm" id="id515"/><p>The <code class="literal">showlinks</code> command prints out a (potentially quite long) list of the links in the current page. This can be helpful for figuring out what you need to type into the <code class="literal">follow</code> command, or just for general debugging.</p></div><div class="section" title="sleep"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec63"/>sleep</h3></div></div></div><a class="indexterm" id="id516"/><a class="indexterm" id="id517"/><p>The <code class="literal">sleep</code> command can be used to inject pauses in the execution of a Twill script. It accepts one optional parameter specifying the number of seconds to pause before continuing to execute the script. If the time is not specified, it defaults to one second.</p></div><div class="section" title="submit"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec64"/>submit</h3></div></div></div><a class="indexterm" id="id518"/><a class="indexterm" id="id519"/><p>The <code class="literal">submit</code> command submits the form containing the field most recently changed by the <code class="literal">formvalue</code> command. It accepts one optional parameter specifying which <code class="literal">submit</code> button to use, specified in the same way a field would be specified for the <code class="literal">formvalue</code> command. If the <code class="literal">submit</code> button is not specified, the first one in the form is used.</p></div><div class="section" title="tidy_ok"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec65"/>tidy_ok</h3></div></div></div><a class="indexterm" id="id520"/><a class="indexterm" id="id521"/><p>If you have HTML Tidy (<a class="ulink" href="http://tidy.sourceforge.net/">http://tidy.sourceforge.net/</a>) installed, the <code class="literal">tidy_ok</code> command will use it to check whether the current page's code is correct. If you put <code class="literal">tidy_ok</code> in a script and the current page does not meet Tidy's standards of correctness, the script will be considered a failure.</p></div><div class="section" title="title"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec66"/>title</h3></div></div></div><a class="indexterm" id="id522"/><a class="indexterm" id="id523"/><p>The <code class="literal">title</code> command accepts a regular expression as its only parameter, and tries to match the current page's title against the regular expression. If they don't match, the <code class="literal">title</code> command fails. Used in a script file, this will cause the entire script to be considered a failure if the title does not match.</p></div><div class="section" title="url"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec67"/>url</h3></div></div></div><a class="indexterm" id="id524"/><a class="indexterm" id="id525"/><p>The <code class="literal">url</code> command accepts a regular expression as it's only parameter, and tries to match the current page's URL against the regular expression. If they don't match, the <code class="literal">url</code> command fails, and causes the script it's part of to fail. If the regular expression does match the URL, the local variable <code class="literal">__match__</code> is bound to the matching part of the URL.</p></div></div><div class="section" title="Pop quiz – the Twill language"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec89"/>Pop quiz – the Twill language</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Which form is submitted when you use the <code class="literal">submit</code> command?</li><li class="listitem">Which command would you use to check that an error message is not on the page?</li><li class="listitem">When you're executing a Twill script and a command fails, what happens?</li></ol></div></div><div class="section" title="Have a go hero – browsing the web with Twill"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec90"/>Have a go hero – browsing the web with Twill</h2></div></div></div><p>Open up a Twill interactive shell, use it to search Google, follow one of the links in the search result, and navigate around the linked site. While you're doing that, try to get some hands on experience with as many of the Twill commands as you can.</p></div></div>
<div class="section" title="Calling Twill scripts from tests"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec75"/>Calling Twill scripts from tests</h1></div></div></div><p>While it's nice to be able to use <code class="literal">twill-sh</code> to execute a bunch of Twill scripts as a form of automated testing, we'd really like to be able to run the Twill scripts as part of our normal test suite. Fortunately, it's fairly easy to do so. There are two nice ways to run Twill scripts from Python code, and you can choose whichever better suits your needs.</p></div>
<div class="section" title="Time for action &#x2013; running Twill script files"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec76"/>Time for action – running Twill script files</h1></div></div></div><a class="indexterm" id="id526"/><p>The first way is to store the Twill script in a separate file, and then use the <code class="literal">twill.parse.execute_file</code> function to run it.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Place the following code into a file called <code class="literal">fail.twill</code>:<div class="informalexample"><pre class="programlisting">go http://slashdot.org/
find this_does_not_exist</pre></div></li><li class="listitem">Naturally, this script will fail, but go ahead and run it with <code class="literal">twill-sh</code> to see for yourself.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ twill-sh fail.twill</strong></span>
</pre></div></li><li class="listitem">Now to run the script from Python. Pull up an interactive Python shell and do the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; from twill.parse import execute_file</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; execute_file('fail.twill')</strong></span>
</pre></div><div class="mediaobject"><img alt="Time for action – running Twill script files" src="graphics/8846_08_06.jpg"/></div></li><li class="listitem">Simple as that, we ran the script from inside Python code. That would work equally well in doctest, unittest, or in nose-specific test code.</li><li class="listitem">N<a class="indexterm" id="id527"/>otice that what the Twill shell would report as an error, execute_file reports as a <code class="literal">twill.errors.TwillAssertionError</code> exception. That integrates nicely with the automated testing tools we've discussed previously.</li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec91"/>
<span class="emphasis"><em>What just happened?</em></span>
</h2></div></div></div><p>With just a couple of lines of code, we executed a Twill script that was stored in a separate file, and received any errors that it encountered as Python exceptions. This is ideal for situations where you have a pre-existing Twill script, and just want a way to have it run alongside the rest of your test suite. It's also convenient if you want to automatically generate the Twill script, or if you simply want to keep different languages in different files.</p></div></div>
<div class="section" title="Time for action &#x2013; running Twill script strings"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec77"/>Time for action – running Twill script strings</h1></div></div></div><p>T<a class="indexterm" id="id528"/>he second way to run a Twill script from inside Python code is to store the script in a string.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open up an interactive Python interpreter and type the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; from twill.parse import execute_string</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; execute_string("""</strong></span>
<span class="strong"><strong>... go http://slashdot.org/</strong></span>
<span class="strong"><strong>... find this_does_not_exist</strong></span>
<span class="strong"><strong>... """, no_reset = False)</strong></span>
</pre></div></li><li class="listitem">The result will be just the same as when we executed a file containing those commands.<div class="note" style="" title="Note"><div class="inner"><h3 class="title"><a id="note33"/>Note</h3><p>Notice the <code class="literal">no_reset = False</code> parameter that we passed to <code class="literal">execute_string</code>. We need that because if we leave it out, Twill will assume that all of our calls to <code class="literal">execute_string</code> should be executed, as if they were all part of the same browser session. We don't want that because we want our tests to be separated from each other. <code class="literal">execute_file</code> will make the opposite assumption, so, we don't need to pass it a <code class="literal">no_reset</code> parameter (although we could).</p></div></div></li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec92"/>
<span class="emphasis"><em>
<a class="indexterm" id="id529"/>What just happened?
</em></span>
</h2></div></div></div><p>This time, the script was embedded directly into the Python code as a string constant. This is desirable when the Twill script is seen as simply being another way to write part of a test, rather than a separate thing in itself.</p></div><div class="section" title="A nifty trick"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec93"/>A nifty trick</h2></div></div></div><p>If you're using Python 2.4 or greater, you can define a function decorator that makes it simple to write Twill tests as Python functions.</p><div class="informalexample"><pre class="programlisting">from twill.parse import execute_string
from twill.errors import TwillAssertionError

def twill_test(func):
    def run_test(*args):
        try:
            execute_string(func.__doc__, no_reset = False)
        except TwillAssertionError, err:
            if args and hasattr(args[0], 'fail'):
                args[0].fail(str(err))
            else:
                raise
    return run_test</pre></div><p>If you put that code in a Python module (here called <code class="literal">twill_decorator</code>) and then import <code class="literal">twill_test</code> into your testing code, you can write Twill tests like so:</p><div class="informalexample"><pre class="programlisting">from unittest import TestCase
from twill_decorator import twill_test

class web_tests(TestCase):
    @twill_test
    def test_slashdot(self):
        """
        go http://slashdot.org/ 
        find this_does_not_exist
        """</pre></div><p>When you use Nose or unittest to run that test module, the <code class="literal">test_slashdot</code> function will automatically execute the Twill script in its document string, and report any errors as test failures. You don't have to remember to pass <code class="literal">no_reset = False</code>, or any of the other details of running Twill from a string.</p></div></div>
<div class="section" title="Integrating Twill operations into unittest tests"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec78"/>Integrating Twill operations into unittest tests</h1></div></div></div><p>S<a class="indexterm" id="id530"/>o far, our unit tests have treated each Twill script as a single operation that produces either a success or a failure. What if we want to, say, download an HTML page, perform some assertions about relationships between its content and a database, then follow a link to another page?</p><p>We can do this sort of thing by accessing Twill's browser object directly from our test code. The browser object has methods similar to the commands of the Twill language, so this should seem fairly familiar.</p></div>
<div class="section" title="Time for action &#x2013; using Twill's browser object"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec79"/>Time for action – using Twill's browser object</h1></div></div></div><p><a class="indexterm" id="id531"/>Here we see how to access the browser object directly, and use it to interact with the web.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Place the following code into a Python test module:<div class="informalexample"><pre class="programlisting">from unittest import TestCase
import twill

class test_twill_browser(TestCase):
    def test_slashdot(self):
        browser = twill.get_browser()
	
        browser.go('http://slashdot.org/')
        self.assertTrue(browser.get_code() in (200, 201))

        html = browser.get_html()
        self.assertTrue(html.count('slashdot') &gt; 150)

        link = browser.find_link('Science')
        browser.follow_link(link)

        form = browser.get_form(2)
        form.set_value('aardvark', name = 'fhfilter')
        browser.clicked(form, None)
        browser.submit()
        self.assertEqual(browser.get_code(), 200)</pre></div></li><li class="listitem">Run the test module using <code class="literal">nosetests</code>. If Slashdot hasn't changed their interface since this was written, then the test will pass. If they have, the test will probably fail.</li></ol></div><div class="section" title="What just happened?"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec94"/>
<span class="emphasis"><em>
<a class="indexterm" id="id532"/>What just happened?
</em></span>
</h2></div></div></div><p>Instead of using the Twill language to describe the interaction with a web site, we used Twill as a library that we could call from our test code. This allowed us to interleave Twill operations with unittest assertions. We could have included any other operations that we needed, as well. Using this technique, our tests can treat the web as just one more source of data that they can access.</p><p>It's important to notice the differences between the Twill language and the methods available on the browser object. For example, where the Twill language has a <code class="literal">show</code> command that prints out the HTML of the current page, the browser has a <code class="literal">get_html</code> method that returns the HTML of the current page.</p><p>P<a class="indexterm" id="id533"/>ay special attention to the interactions with the form, at the end of the test. These interactions use a form object, which can be retrieved by calling the browser object's <code class="literal">get_form</code> method.</p><p>T<a class="indexterm" id="id534"/>he <code class="literal">set_value</code> method of a form object accepts the new value for the control as the first parameter, and then has a number of keyword arguments that can be used to specify which control should take on that value. The most useful of these arguments are <code class="literal">name</code>, as used above, and <code class="literal">nr</code>, which selects the control by number.</p><p>In order for <code class="literal">submit</code> to work, it should be preceded by a call to the <code class="literal">clicked</code> method targeting one of the controls of the form (it doesn't matter which).</p></div><div class="section" title="Browser methods"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec95"/>Browser methods</h2></div></div></div><p>T<a class="indexterm" id="id535"/>
<a class="indexterm" id="id536"/>he <a class="indexterm" id="id537"/>browser object retrieved with <code class="literal">twill.get_browser()</code> has the following useful methods:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">go</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">reload</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">back</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">get_code</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">get_html</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">get_title</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">get_url</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">find_link</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">follow_link</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">set_agent_string</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">get_all_forms</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">get_form</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">get_form_field</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">clicked</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">submit</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">save_cookies</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">load_cookies</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">clear_cookies</code></li></ul></div><p>M<a class="indexterm" id="id538"/>any of those work just as the related Twill <a class="indexterm" id="id539"/>command, except that you pass the parameters as strings into a method call [e.g. <code class="literal">browser.save_cookies('cookies.txt')</code>]. A few of them behave differently, though, or don't have a Twill language equivalent, so we'll go into more detail about those now:</p><div class="section" title="get_code"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec68"/>get_code</h3></div></div></div><p>T<a class="indexterm" id="id540"/>
<a class="indexterm" id="id541"/>he <code class="literal">get_code</code> method returns the HTTP code for the current page. It doesn't do any comparisons between the code and an expected value. If you want to raise an exception if the code isn't <code class="literal">200</code>, you need to do it yourself.</p></div><div class="section" title="get_html"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec69"/>get_html</h3></div></div></div><p>T<a class="indexterm" id="id542"/>
<a class="indexterm" id="id543"/>he <code class="literal">get_html</code> method returns the HTML for the current page as a Python string.</p></div><div class="section" title="get_title"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec70"/>get_title</h3></div></div></div><p>T<a class="indexterm" id="id544"/>
<a class="indexterm" id="id545"/>he <code class="literal">get_title</code> method returns the title of the current page as a Python string.</p></div><div class="section" title="get_url"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec71"/>get_url</h3></div></div></div><p>T<a class="indexterm" id="id546"/>
<a class="indexterm" id="id547"/>he <code class="literal">get_url</code> method returns the URL of the current page as a Python string.</p></div><div class="section" title="find_link"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec72"/>find_link</h3></div></div></div><p>T<a class="indexterm" id="id548"/>
<a class="indexterm" id="id549"/>he <code class="literal">find_link</code> method searches for a link whose URL, text or name matches matches the regular expression that was passed in as a parameter. If it finds such a link, it returns an object representing that link. If no such link exists, <code class="literal">find_link</code> returns <code class="literal">None</code>.</p><p>A link object has a number of useful attributes. If you have a link object named <code class="literal">link</code>, then <code class="literal">link.attrs</code> is a list of <code class="literal">(name, value)</code> tuples, <code class="literal">link.text</code> is the text appearing between the <code class="literal">&lt;a&gt;</code> and <code class="literal">&lt;/a&gt;</code> tags, and <code class="literal">link.absolute_url</code> is the address to which the link points.</p></div><div class="section" title="follow_link"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec73"/>
<a class="indexterm" id="id550"/>
<a class="indexterm" id="id551"/>follow_link
</h3></div></div></div><p>T<a class="indexterm" id="id552"/>
<a class="indexterm" id="id553"/>he <code class="literal">follow_link</code> method takes a link object as a parameter, and goes to the address represented by the link. If you have a URL in the form of a string, rather than a link object, you should use the <code class="literal">go</code> method instead.</p></div><div class="section" title="get_all_forms"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec74"/>get_all_forms</h3></div></div></div><p>T<a class="indexterm" id="id554"/>
<a class="indexterm" id="id555"/>he <code class="literal">get_all_forms</code> method returns a list of form objects representing all forms appearing in the page. If there are any form controls on the page that aren't inside of <code class="literal">&lt;form&gt;</code> tags, a special form object will be created to contain them, and will be the first element of the list.</p></div><div class="section" title="get_form"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec75"/>get_form</h3></div></div></div><p>T<a class="indexterm" id="id556"/>
<a class="indexterm" id="id557"/>he <code class="literal">get_form</code> method takes a regular expression as a parameter, and searches for a form whose id, name or number matches. If it finds such a form, it returns a form object representing it.</p><p>A form object has several useful attributes. If you have a form object called <code class="literal">form</code>, then <code class="literal">form.name</code> is the name of the form if it has a name, <code class="literal">form.method</code> is the form's method (usually 'GET' or 'POST'), <code class="literal">form.action</code> is the URL to which the form should be submitted, <code class="literal">form.enctype</code> is the content type to use when encoding the form for transmission, and <code class="literal">form.attrs</code> is a dictionary of attributes applied to the form.</p><p>A form object also has methods that help you manipulate its contents. Notable among these are <code class="literal">form.get_value</code>, <code class="literal">form.set_value</code>, <code class="literal">form.clear</code>, <code class="literal">form.clear_all</code>, and <code class="literal">form.add_file</code>. All of these methods except for <code class="literal">clear_all</code> target a specific control within the form. You tell it which control to target by passing one or more of the following keyword arguments to the method: <code class="literal">name</code>, <code class="literal">type</code>, <code class="literal">kind</code>, <code class="literal">id</code>, <code class="literal">nr</code>, and <code class="literal">label</code>. The <code class="literal">nr</code> keyword is short for 'number'. If no control matches all of the specified parameters, an <code class="literal">_mechanize_dist.ClientForm.ControlNotFoundError</code> exception will be raised.</p><p>The <code class="literal">set_value</code> and <code class="literal">add_file</code> methods accept a value or a filename, respectively, as their first parameters. The <code class="literal">get_value</code> method returns the current value of the selected control. The <code class="literal">clear</code> method returns a control to its default value.</p></div><div class="section" title="get_form_field"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec76"/>
<a class="indexterm" id="id558"/>
<a class="indexterm" id="id559"/>get_form_field
</h3></div></div></div><p><a class="indexterm" id="id560"/>
<a class="indexterm" id="id561"/>The <code class="literal">get_form_field</code> method takes a form object as its first parameter and a regular expression as its second. If precisely one of the form's controls has an id, name or index that matches the regular expression, an object representing that control is returned.</p><p>For the most part this is not needed, because the form object's methods are more flexible ways to manipulate form controls. Its primary use is to provide input to the <code class="literal">clicked</code> method.</p></div><div class="section" title="clicked"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec77"/>clicked</h3></div></div></div><p>T<a class="indexterm" id="id562"/>
<a class="indexterm" id="id563"/>he <code class="literal">clicked</code> method exists to keep the browser object appraised about which part of the page is the current focus. In particular, this tells it which form to submit when the <code class="literal">submit</code> method is called.</p><p>The <code class="literal">clicked</code> method takes two parameters: the form object that will become the focus, and the specific control within the form where the click should be registered.</p><p>It is usually simplest to pass <code class="literal">None</code> as the specific control. You may, however, pass a control object (as returned by <code class="literal">get_form_field</code>). If this control object represents a submit control, that control becomes the new default to use when submitting the form. The initial default is the first submit control in the form.</p></div><div class="section" title="submit"><div class="titlepage"><div><div><h3 class="title"><a id="ch08lvl3sec78"/>submit</h3></div></div></div><p>T<a class="indexterm" id="id564"/>
<a class="indexterm" id="id565"/>he <code class="literal">submit</code> method submits the last-clicked form, as per its <code class="literal">action</code> and <code class="literal">method</code>. You may optionally pass a <code class="literal">fieldname</code> parameter representing which submit control to use for the submission. If it exists, this parameter will be passed to <code class="literal">get_form_field</code> to find the appropriate submit control. If you don't pass a <code class="literal">fieldname</code> to the method, the default submit control will be used.</p></div></div><div class="section" title="Pop quiz – browser methods"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec96"/>Pop quiz – browser methods</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">How do you indicate which form object you want to retrieve when you call <code class="literal">get_form</code>?</li><li class="listitem">What does the <code class="literal">clicked</code> method do?</li><li class="listitem">How does the <code class="literal">get_code</code> method differ from the <code class="literal">code</code> command?</li></ol></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec80"/>Summary</h1></div></div></div><p>We learned a lot in this chapter about Twill, and how to use it to write tests for web applications.</p><p>Specifically, we covered:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The Twill language</li><li class="listitem" style="list-style-type: disc">Invoking Twill scripts from Python tests</li><li class="listitem" style="list-style-type: disc">Integrating Twill's capabilities as a library into Python testing code</li></ul></div><p>Now that we've learned about testing web applications, we're ready to move on to talking about integration testing and system testing – which is the topic of the next chapter.</p></div></body></html>