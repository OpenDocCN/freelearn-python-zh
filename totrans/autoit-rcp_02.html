<html><head></head><body><div class="chapter" title="Chapter&#xA0;2.&#xA0;Working with CSV and Excel Worksheets"><div class="titlepage"><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Working with CSV and Excel Worksheets</h1></div></div></div><p>Imagine a world where your important documents were stored in files and managed on work desks. Thanks to the advent of computers and software such as Excel sheets we can manage our data in an organized way. In fact, you can even manage worksheets in an automated way, and that too with Python.</p><p>In this chapter, we will cover the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Reading CSV files with reader objects</li><li class="listitem" style="list-style-type: disc">Writing data into CSV files</li><li class="listitem" style="list-style-type: disc">Developing your own CSV dialects</li><li class="listitem" style="list-style-type: disc">Managing employee information in an automated way</li><li class="listitem" style="list-style-type: disc">Reading Excel sheets</li><li class="listitem" style="list-style-type: disc">Writing data into worksheets</li><li class="listitem" style="list-style-type: disc">Formatting Excel cells</li><li class="listitem" style="list-style-type: disc">Playing with Excel formulae</li><li class="listitem" style="list-style-type: disc">Building charts within Excel sheets</li><li class="listitem" style="list-style-type: disc">Automating the comparison of company financials</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec17"/>Introduction</h1></div></div></div><p>Until computers became a part of our daily lives, office records were created on paper and stored in cabinets. Today, thanks to the ever-growing computational field, we store these records using computer applications in a text file. Text (<code class="literal">.txt</code>) files were great at saving large amounts of data; it was also easy to search for information within a text file, but the data was never stored in an organized way. Over time as the information grew, the need for storing information also increased and resulted in the advent of CSV and Excel sheets, where data not only could be stored in a structured format but also read and processed easily.</p><p>CSV files contain data separated by commas; hence, they are referred to as <span class="strong"><strong>comma-separated values</strong></span> (<span class="strong"><strong>CSV</strong></span>) files. CSV allows for storing data in a tabular format. CSV files are easier to import on any storage system, independent of the software being used. Since CSV files are plain text files, they can be modified easily and are hence used for the quick exchange of data.</p><p>On the other hand, Excel sheets contain data separated by tabs or other delimiters. Excel sheets store and retrieve data in a grid format of columns and rows. They allow the formatting of data, working with formulas, and have the capability of hosting multiple sheets in a file. Excel is ideal for entering, calculating, and analyzing company data, such as sales figures or commissions.</p><p>While CSV files are text files used to store and retrieve data from programs, Excel files are binary files and are used for more advanced operations like charting, calculations and often for storing reports.</p><p>Python has a useful set of modules to work with both CSV and Excel files. You can read/write CSV and Excel files, format Excel cells, prepare charts, and perform calculations on data with formulae.</p><p>The recipes in this chapter will focus on the Python modules that help us performing the preceding operations on CSV and Excel sheets. Specifically, we will focus on the following Python modules in this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">csv</code> (<a class="ulink" href="https://docs.python.org/2/library/csv.html">https://docs.python.org/2/library/csv.html</a>)</li><li class="listitem" style="list-style-type: disc"><code class="literal">openpyxl</code> (<a class="ulink" href="https://pypi.python.org/pypi/openpyxl">https://pypi.python.org/pypi/openpyxl</a>)</li><li class="listitem" style="list-style-type: disc"><code class="literal">XlsxWriter</code> (<a class="ulink" href="https://pypi.python.org/pypi/XlsxWriter">https://pypi.python.org/pypi/XlsxWriter</a>)</li></ul></div></div></div>
<div class="section" title="Reading CSV files with reader objects"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec18"/>Reading CSV files with reader objects</h1></div></div></div><p>This recipe will show you how to read CSV files, specifically how to create and use the reader object.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec43"/>Getting ready</h2></div></div></div><p>To step through this recipe, you will need to install Python v2.7. To work with the CSV files, we have a nice module, <code class="literal">csv</code>, which is packaged with the default Python installation. So, let's get started!</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec44"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">On your Linux/Mac computer, go to Terminal and use Vim, or choose your favorite editor.</li><li class="listitem">We start by creating a CSV file. As we know, a CSV file has a structured format where data is separated by commas, so creating one should be trivial. The following screenshot is of a CSV file that contains details of contacts in different parts of the country. We name it as <code class="literal">mylist.csv</code>:<p>
</p><div class="mediaobject"><img alt="How to do it..." src="graphics/Chapter2-Image2.jpg"/></div><p>
</p></li><li class="listitem">Now, let's write the Python code to read this CSV file and print data from it:<pre class="programlisting">        import csv &#13;
        fh = open("mylist.csv", 'rt') &#13;
        try: &#13;
            reader = csv.reader(fh) &#13;
            print "Data from the CSV:", list(reader) &#13;
            except Exception as e: &#13;
            print "Exception is:", e &#13;
        finally: &#13;
            fh.close()</pre><p>The output of the preceding code snippet is as follows:</p><p>
</p><div class="mediaobject"><img alt="How to do it..." src="graphics/Chapter2-Image1.jpg"/></div><p>
</p></li><li class="listitem">Oh! What happened? We seem to have hit an error. The error suggests that the CSV reader could not find the new line character. This happens in CSV files written on a Mac platform. This is because Mac OS uses <span class="strong"><strong>carriage return</strong></span> (<span class="strong"><strong>CR</strong></span>) as the end of line character.</li><li class="listitem">Python has a simple solution for this issue; we open the file in <span class="strong"><strong>rU</strong></span> mode (which is <span class="strong"><strong>universal newline</strong></span> mode). The following program runs perfectly fine and we can read the file contents appropriately:<pre class="programlisting">        try: &#13;
            reader = csv.reader(open("mylist.csv", 'rU'), &#13;
                                dialect=csv.excel_tab) &#13;
            print "Data from the CSV:" &#13;
            d = list(reader) &#13;
            print "\n".join("%-20s %s"%(d[i],d[i+len(d)/2]) for i in &#13;
                            range(len(d)/2)) &#13;
 &#13;
            except Exception as e: &#13;
            print "Exception is:", e &#13;
        finally: &#13;
            fh.close()</pre><p>The output of the preceding program is as follows:</p><p>
</p><div class="mediaobject"><img alt="How to do it..." src="graphics/image_03_003.jpg"/></div><p>
</p></li><li class="listitem">That's great! There's another simple fix for the issue we observed in the preceding code snippet. What we could do is, simply change the file format from Mac CSV to Windows CSV. We can do this by performing the <span class="strong"><strong>Open</strong></span> and <span class="strong"><strong>Save As</strong></span> operations on the file. In the following example, I have saved <code class="literal">mylist.csv</code> as <code class="literal">mylist_wincsv.csv</code> (Windows CSV format), and reading the file contents is not an issue anymore:<pre class="programlisting">        fh = open("mylist_wincsv.csv", 'rt') &#13;
        reader = csv.reader(fh) &#13;
        data = list(reader) &#13;
        print "Data cells from CSV:" &#13;
        print data[0][1], data[1][1] &#13;
        print data[0][2], data[1][2] &#13;
        print data[0][3], data[1][3] &#13;
</pre><p>In the preceding code example, we print a part of the data from the CSV file. If you realize, a CSV file can also be read as a 2D list in Python with the first index as row and the second index as column. Here we print the second, third, and fourth columns from <code class="literal">row1</code> and <code class="literal">row2</code>:</p><p>
</p><div class="mediaobject"><img alt="How to do it..." src="graphics/image_03_004.jpg"/></div><p>
</p></li><li class="listitem">With Python, it's also very convenient to read the contents of a CSV file in a dictionary with a helpful <code class="literal">DictReader(f)</code> method:<pre class="programlisting">        import csv &#13;
        f = open("mylist_wincsv.csv", 'rt') &#13;
        print "File Contents" &#13;
        try: &#13;
            reader = csv.DictReader(f) &#13;
            for row in reader: &#13;
                print row['first_name'], row['last_name'], row['email'] &#13;
        finally:&#13;
            f.close()</pre><p>In the preceding code snippet, we open the file with the file handle, <code class="literal">f</code>. This file handle is then used as an argument to <code class="literal">DictReader()</code>, which will treat the first row values as column names. These column names act as a key in the dictionary where the data gets stored. So, in the preceding program, we can selectively print the data from three columns: <span class="strong"><strong>first_name</strong></span>, <span class="strong"><strong>last_name</strong></span>, and <span class="strong"><strong>e-mail</strong></span> and print them like in the following screenshot:</p><p>
</p><div class="mediaobject"><img alt="How to do it..." src="graphics/image_03_005.jpg"/></div><p>
</p></li><li class="listitem">The <code class="literal">csv</code> module's <code class="literal">DictReader()</code> has a few helper methods and attributes that make it easy to read CSV files. These are also known as <span class="strong"><strong>reader objects</strong></span>:<pre class="programlisting">        import csv &#13;
        f = open("mylist_wincsv.csv", 'rt') &#13;
        reader = csv.DictReader(f) &#13;
        print "Columns in CSV file:", reader.fieldnames &#13;
        print "Dialect used in CSV file:", reader.dialect &#13;
        print "Current line number in CSV file:", reader.line_num &#13;
        print "Moving the reader to next line with reader.next()" &#13;
        reader.next() &#13;
        print "Reading line number:", reader.line_num f.close()</pre></li></ol></div><p>In this code example, we used the following attributes and method:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">fieldnames</code>: Gives list of column names</li><li class="listitem" style="list-style-type: disc"><code class="literal">dialect</code>: CSV file format (we 'll read more about it)</li><li class="listitem" style="list-style-type: disc"><code class="literal">line_num</code>: Current line number being read</li><li class="listitem" style="list-style-type: disc"><code class="literal">next()</code>: Takes you to the next line</li></ul></div><p>In the following screenshot, the first line contains all the column names from our CSV file. In the second line, we print the dialect used to read the CSV file. The third line prints the line number we're currently reading, and the last line of the screenshot depicts the next line that the reader object will move to while reading:</p><p>
</p><div class="mediaobject"><img alt="How to do it..." src="graphics/image_03_006.jpg"/></div><p>
</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec45"/>There's more...</h2></div></div></div><p>The Python module, <code class="literal">csv</code>, is a helper and it is perfectly possible to process a CSV file by opening the file with the <code class="literal">open()</code> method and reading the file contents with the <code class="literal">readline()</code> method. You can then perform the <code class="literal">split()</code> operation on every line of the file to get the file contents.</p><p>Reading is great, but you'll read something only when something is written in a CSV file, isn't it? :) Let's look at the methods available for writing data into CSV files in the next recipe.</p></div></div>
<div class="section" title="Writing data into CSV files"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec19"/>Writing data into CSV files</h1></div></div></div><p>Again, for the recipes in this section, we don't need any new modules apart from the ones that are bundled with the Python installation, that is, the <code class="literal">csv</code> module.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec46"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First, lets open a file in write mode and in text format. We create two Python lists that contain the data to be written into the CSV file. The following code will perform these operations:<pre class="programlisting">        import csv &#13;
        names = ["John", "Eve", "Fate", "Jadon"] &#13;
        grades = ["C", "A+", "A", "B-"] &#13;
        f = open("newlist.csv", 'wt') &#13;
</pre></li><li class="listitem">Let's now add the data into the CSV file with the <code class="literal">write()</code> method, as follows:<pre class="programlisting">        try: &#13;
            writer = csv.writer(f) &#13;
            writer.writerow( ('Sr.', 'Names', 'Grades') ) &#13;
            for i in range(4): &#13;
                writer.writerow( (i+1, names[i], grades[i]) ) &#13;
        finally: &#13;
            f.close() &#13;
</pre><p>In the preceding code, we initialized the CSV file with a header; the column names used are: <span class="strong"><strong>Sr</strong></span>., <span class="strong"><strong>Names</strong></span>, and <span class="strong"><strong>Grades</strong></span>. Next, we start a Python <code class="literal">for</code> loop to run four times and write four rows of data into the CSV file. Remember, we have the data in the Python lists, <code class="literal">Names</code> and <code class="literal">Grades</code>. The <code class="literal">writerow()</code> method actually adds the content in the CSV file, adding a row one by one inside the <code class="literal">for</code> loop.</p><p>The output of the preceding code snippet can be seen in the following screenshot:</p><p>
</p><div class="mediaobject"><img alt="How to do it..." src="graphics/image_03_007.jpg"/></div><p>
</p></li><li class="listitem">Cool, that was simple and straightforward. It is interesting to note that, by default, when we write into a CSV file, the file contents in a row are separated by commas. But what if we want to change the behavior to make it separated by tabs (<code class="literal">\t</code>)? The <code class="literal">writer()</code> method has this facility of changing not only the delimiter but also the line terminator. (Note: Delimiter is the character that is used to separate the data within a row in a CSV file. The terminator character is used to mark the end of a row in a CSV file. You will relate to this in the following example):<pre class="programlisting">        import csv &#13;
        f=open("write.csv", 'wt') &#13;
        csvWriter = csv.writer(f, delimiter='\t', &#13;
                               lineterminator='\n\n') &#13;
        csvWriter.writerow(['abc', 'pqr', 'xyz']) &#13;
        csvWriter.writerow(['123', '456', '789']) &#13;
        f.close() &#13;
</pre><p>When the preceding code snippet is run, a new file, <code class="literal">write.csv</code>, gets created on the filesystem. File contents can be viewed in the following screenshot. If you look at the contents in a given row, you will see them separated by tabs and not by commas. The new line delimeter is the return key (pressed twice), which is also evident in the following screenshot. Note that there's an extra newline character between both the rows:</p><p>
</p><div class="mediaobject"><img alt="How to do it..." src="graphics/image_03_008.jpg"/></div><p>
</p></li></ol></div></div></div>
<div class="section" title="Developing your own CSV dialects"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec20"/>Developing your own CSV dialects</h1></div></div></div><p>To make it easier to read and write into CSV files, we can specify the formatting parameters that are a part of the <code class="literal">Dialect</code> class of the <code class="literal">csv</code> module. Here, we look at some of the dialects available and learn how to write our own.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec47"/>Getting ready</h2></div></div></div><p>For this recipe, we will use the same <code class="literal">csv</code> module that is present in the default installation of Python, so there is no need to install anything explicitly.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec48"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Let's first look at some of the attributes that are present in the <code class="literal">Dialect</code> class:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">Dialect.delimeter</code>: We used this in the previous recipe where we changed the way the contents are written in the row of a CSV file. It is used to separate two fields.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Dialect.lineterminator</code>: This is used to signify the termination of a line added in a CSV file. We also used this in our previous section.</li><li class="listitem" style="list-style-type: disc"><code class="literal">Dialect.skipinitialspace</code>: This will skip all the leading spaces after a delimiter. It helps avoid accidental human error.</li></ul></div><p>We can get a list of the available dialects with the following code:</p><pre class="programlisting">        print "Available Dialects:", csv.list_dialects() &#13;
</pre><p>The two main dialects available are <code class="literal">excel</code> and <code class="literal">excel-tab</code>. The <code class="literal">excel</code> dialect is for working with data in the default export format for Microsoft Excel, and also works with OpenOffice or NeoOffice.</p></li><li class="listitem">Let's now create a dialect of our choice. For instance, we choose the <code class="literal">-</code> symbol to demarcate columns in a CSV file:<pre class="programlisting">        import csv&#13;
        csv.register_dialect('pipes', delimiter='-')&#13;
        with open('pipes.csv', 'r') as f:&#13;
            reader = csv.reader(f, dialect='pipes')&#13;
            for row in reader:&#13;
                print row</pre><p>
</p></li><li class="listitem">We create a file, <code class="literal">pipes.csv</code>, which looks as follows:<p>
</p><div class="mediaobject"><img alt="How to do it..." src="graphics/image_03_009.jpg"/></div><p>
</p><p>If we run the preceding Python code on the <code class="literal">pipes.csv</code> file it returns every line as an array with all the elements split by the <code class="literal">-</code> character. The following screenshot shows the output of our program:</p><p>
</p><div class="mediaobject"><img alt="How to do it..." src="graphics/image_03_010.jpg"/></div><p>
</p></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec49"/>How it works...</h2></div></div></div><p>In the second code snippet, we register our own dialect with the <code class="literal">register_dialect()</code> method. We have named our dialect as <code class="literal">pipes</code> and the delimiter associated with <code class="literal">pipes</code> is the symbol <code class="literal">-</code>, as we intended to do.</p><p>We now read the <code class="literal">pipes.csv</code> file with our very own <code class="literal">read()</code> method, and use the reader object to get the contents of the CSV file. But wait, did you see the use of <code class="literal">dialect='pipes'</code>? This will make sure that the reader expects the columns to be separated by <code class="literal">-</code> and reads the data accordingly.</p><p>If you observe, the <code class="literal">reader</code> object has split rows based on <code class="literal">-</code>, which is defined by the dialect, <code class="literal">pipes</code>.</p><p>You learned about reading and writing your own data into CSV files. You also understood the usage of dialects. It's time to get a feel of how to use the preceding concepts with a real-world use case.</p></div></div>
<div class="section" title="Managing employee information in an automated way"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec21"/>Managing employee information in an automated way</h1></div></div></div><p>Mike is the HR Manager of his organization and is trying to gather the contact information of all the employees from the state of California. He wants to segregate this information so that he can conduct a survey on all employees from the CA State. He not only wants to collect this information but also persist it to another CSV file so that it is easy to work on it at a later point in time.</p><p>Can we help Mike here? How do you apply the concepts you learned so far? Will you learn something more while helping Mike? Let's look at the implementation.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec50"/>Getting ready</h2></div></div></div><p>We don't need any special modules for this example. All the modules that have been installed as part of the previous recipes are enough for us. For this example, we use the same <code class="literal">mylist.csv</code> file that contained the employee information.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec51"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Let's directly get to the code and open the two files. One file handle is used for reading the file contents (to read the employee data) and the other one is used for writing into the <code class="literal">CA_Employees.csv</code> file. Note the differences in the mode in which the files are opened (<code class="literal">'rt'</code> and <code class="literal">'wt'</code>). Of course, the employee CSV file is opened in the read mode and the <code class="literal">CA_Employees.csv</code> file is opened in the write mode.<pre class="programlisting">        import csv&#13;
        f = open("mylist.csv", 'rt')&#13;
        fw = open("CA_Employees.csv", 'wt')</pre><p>
</p></li><li class="listitem">Next, we read the employee information from the CSV file as a dictionary with the <code class="literal">DictReader()</code> method. We also create a <code class="literal">csvWriter</code> object, using which we will write the data into the <code class="literal">CA_Employees.csv</code> file.</li><li class="listitem">You would imagine when we start reading the rows of the CSV file, we'd also read the first row. We should skip this row as this just contains the column names, right? Yes, we skip the header using the <code class="literal">line_num</code> attribute of the <code class="literal">reader</code> object (Remember, we learned about attributes earlier in this chapter). Once the header is skipped, we iterate over all the rows and filter out employees who belong to the <code class="literal">CA</code>  State and get the e-mail and phone information for these employees. The filtered data is then written into the <code class="literal">CA_Employees.csv</code> file with the <code class="literal">csvWriter</code> object. Note that once the file operations are complete, it is important to close the file handles as this may result in memory leaks or data inconsistencies:<pre class="programlisting">        try:&#13;
            reader = csv.DictReader(f)&#13;
            csvWriter = csv.writer(fw)&#13;
            for row in reader:&#13;
                if reader.line_num == 1:&#13;
                   continue&#13;
                if row['state'] == 'CA':&#13;
                   csvWriter.writerow([row['email'], row['phone']]) &#13;
        finally:&#13;
            f.close()&#13;
            fw.close()</pre><p>
</p></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec52"/>How it works...</h2></div></div></div><p>When we run the preceding program in its entirety, we will get a <code class="literal">CA_Employees.csv</code> file that looks like the following screenshot:</p><p>
</p><div class="mediaobject"><img alt="How it works..." src="graphics/image_03_011.jpg"/></div><p>
</p><p>If you look at the code implementation, we use the <code class="literal">line_num</code> attribute to skip the header row, which is the first row of the <code class="literal">mylist.csv</code> file. We also write the filtered data into the newly created <code class="literal">CA_Employees.csv</code> file with the <code class="literal">writerow()</code> method. Nice work, I think Mike is already happy with you. His problems are solved. :)</p><p>We come to an end of this section on working with CSV files. CSV files essentially store data in pure text format. We can't achieve many things with these files, hence the advent of Excel sheets. In the next recipe, we start working with Excel sheets and appreciate what they can offer!</p></div></div>
<div class="section" title="Reading Excel sheets"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec22"/>Reading Excel sheets</h1></div></div></div><p>As you might be aware, Microsoft office has started providing a new extension to Microsoft Excel sheets, which is <code class="literal">.xlsx</code>, from Office 2007. With this change, Excel sheets moved to a XML based file format (Office Open XML) with ZIP compression. Microsoft made this change when the business community asked for an open file format that can help transferring data across applications that pushed them. Let's gets started and see how we can work with Excel sheets using Python!</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec53"/>Getting ready</h2></div></div></div><p>In this recipe, we use the <code class="literal">openpyxl</code> module to read Excel sheets. The <code class="literal">openpyxl</code> module is a comprehensive module that performs both read and write operations on Excel sheets. Another alternative to <code class="literal">openpyxl</code> is the <code class="literal">xlrd</code> module. While <code class="literal">xlrd</code> has been good at supporting Excel formats since way back in 1995, the module can only be used to read data from Excel sheets. The <code class="literal">openpyxl</code> module helps in performing more operations, such as modifying data, writing data into files, and copying, which are imperative to working with Excel files.</p><p>Let's install the <code class="literal">openpyxl</code> module with our favorite tool, <code class="literal">pip</code>:</p><pre class="programlisting">
<span class="strong"><strong>pip install openpyxl</strong></span>
</pre></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec54"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We start by creating our own Excel sheet with the content as shown in the following screenshot. As you must be aware, Excel files are called <span class="strong"><strong>workbooks</strong></span> and contain one or more worksheets, and hence Excel files are also known as <span class="strong"><strong>spreadsheets</strong></span>. We save the file as <code class="literal">myxlsx.xlsx</code> in two sheets, <span class="strong"><strong>People</strong></span> and  <span class="strong"><strong>Items</strong></span>:<p>Let's look at the data from the <span class="strong"><strong>People</strong></span> sheet:</p><p>
</p><div class="mediaobject"><img alt="How to do it..." src="graphics/image_03_012.jpg"/></div><p>
</p><p>Now, let's look at the data from the <span class="strong"><strong>Items</strong></span> sheet:</p><p>
</p><div class="mediaobject"><img alt="How to do it..." src="graphics/image_03_013.jpg"/></div><p>
</p></li><li class="listitem">Let's now go ahead and read the XLSX file. The following code will help us in getting the names of all the worksheets present in the Excel workbook:<pre class="programlisting">        import openpyxl&#13;
        workbook = openpyxl.load_workbook('myxls.xlsx')&#13;
        print "Workbook Object:", workbook.get_sheet_names()</pre><p>
</p></li><li class="listitem">Now, if you want to work with a given sheet, how do you get access to that object? The following code snippet, takes us to the <span class="strong"><strong>People</strong></span> worksheet:<pre class="programlisting">        people = workbook.get_sheet_by_name('People')&#13;
        print "People sheet object:", people</pre><p>Wow, that's cool!</p></li><li class="listitem">Let's now move ahead and read the cell objects. We can read the cells either by the name or based on the row/column location. The following code snippet demonstrates this:<pre class="programlisting">        import openpyxl&#13;
        workbook = openpyxl.load_workbook('myxls.xlsx')&#13;
        people = workbook.get_sheet_by_name('People')&#13;
        print "First cell Object:", people['A1']&#13;
        print "Other Cell Object:", people.cell(row=3, column=2)</pre><p>
</p></li><li class="listitem">But how do I get the values in the cell? Simple enough, object.value returns you the value present in the cell:<pre class="programlisting">        print "First Name:", people['B2'].value, &#13;
        people['C2'].value &#13;
</pre><p>If we run the Python code snippet, we will get the following output as seen in this screenshot:</p><p>
</p><div class="mediaobject"><img alt="How to do it..." src="graphics/image_03_014.jpg"/></div><p>
</p></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec55"/>How it works...</h2></div></div></div><p>In the preceding example, we import the <code class="literal">openpyxl</code> module. This module has a method with which you can access the worksheet objects and cells in it. The <code class="literal">load_workbook()</code> method loads the complete Excel sheet in the memory. The <code class="literal">get_sheet_names()</code> and <code class="literal">get_sheet_by_name()</code> methods help in selecting the worksheets of the given workbook. Thus, we have the workbook and worksheet objects ready with us.</p><p>The cell objects can be accessed with the <code class="literal">cell()</code> method, and <code class="literal">cell().value</code> returns the actual value present in the cell of worksheet. Nice, see how trivial it is to read data from Excel sheets with Python. But again, reading is only helpful if we know how to write data into Excel sheets. So, what are we waiting for? Let's go ahead and learn that as well in the next recipe.</p></div></div>
<div class="section" title="Writing data into worksheets"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec23"/>Writing data into worksheets</h1></div></div></div><p>Reading files is a breeze with the <code class="literal">openpyxl</code> module. Now, let's shift our focus to writing Excel files. We'll perform multiple operations with Excel files in this section.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec56"/>Getting ready</h2></div></div></div><p>For this recipe, we will use another fantastic Python module, which is <code class="literal">xlsxwriter</code>. As the name suggests, this module help us perform multiple operations on Excel sheets. Interestingly, <code class="literal">xlsxwriter</code> doesn't support read operations on an Excel sheet (at the time of writing this book). We install the <code class="literal">xlsxwrite</code> module using <code class="literal">pip</code>, as follows:</p><pre class="programlisting">
<span class="strong"><strong>pip install xlsxwriter</strong></span>
</pre></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec57"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We start with a very basic operation of creating an XLSX file and adding a new sheet to it. The following code performs this operation:<pre class="programlisting">        import xlsxwriter&#13;
        workbook = xlsxwriter.Workbook('add_sheet.xlsx')&#13;
        worksheet = workbook.add_worksheet(name='New Sheet 2') &#13;
        workbook.close()</pre><p>
</p></li><li class="listitem">Let's move ahead and perform the <code class="literal">write</code> operations on the worksheet and store some useful information:<pre class="programlisting">        import xlsxwriter&#13;
        workbook = xlsxwriter.Workbook('Expenses01.xlsx')&#13;
        worksheet = workbook.add_worksheet()&#13;
        expenses = (&#13;
            ['Rent', 1000],&#13;
            ['Gas',   100],&#13;
            ['Food',  300],&#13;
            ['Gym',    50],&#13;
        )&#13;
        row = 0&#13;
        col = 0&#13;
        for item, cost in (expenses):&#13;
            worksheet.write(row, col, item)&#13;
            worksheet.write(row, col + 1, cost)&#13;
            row += 1&#13;
 &#13;
        worksheet.write(row, 0, 'Total')&#13;
        worksheet.write(row, 1, '=SUM(B1:B4)')&#13;
        workbook.close()</pre><p>
</p></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec58"/>How it works...</h2></div></div></div><p>The first code snippet of this recipe creates a <code class="literal">workbook</code> object with the <code class="literal">Workbook()</code> method under a new Excel file, <code class="literal">add_sheet.xlsx</code>. It then goes ahead and creates a <code class="literal">worksheet</code> object with the <code class="literal">add_worksheet()</code> method. A new sheet named <code class="literal">New Sheet 2</code> is created.</p><p>In the second code example, we create an XLSX file named <code class="literal">Expenses01.xlsx</code>. We add the expenses data to it from the <code class="literal">expenses</code> dictionary. For doing this, we iterate through the dictionary and use the keys as one column and the values as another column in the Excel sheet. Finally, we add one last row that sums up all the expenses. The contents of <code class="literal">Expenses01.xlsx</code> are shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img alt="How it works..." src="graphics/image_03_015.jpg"/></div><p>
</p><p>
</p><p>In the preceding code snippets, we performed simple write operations on an Excel sheet with the <code class="literal">xlsxwrite</code> module. We first created a workbook with the <code class="literal">Workbook()</code> method and added a new <code class="literal">sheet</code> object to this workbook with the <code class="literal">add_worksheet()</code> method. Using the <code class="literal">write()</code> method on the <code class="literal">worksheet</code> object, we added data to the Excel sheet. We also did a small formula operation to get the total of all expenses with <code class="literal">=SUM(B1:B4)</code>.</p><p>
</p><p>What we saw was a very basic example of writing Excel files. We could perform many more operations programmatically as we are used to doing manually on Excel sheets. Let's now learn how to format Excel cells in the next set of recipes.</p><p>
</p></div></div>
<div class="section" title="Formatting Excel cells"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec24"/>Formatting Excel cells</h1></div></div></div><p>Cells are formatted for various reasons. In the business world, they are used to group data based on a theme, or in the case of a software development process, cells are colored to indicate whether a feature is done or a bug is fixed.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec59"/>Getting ready</h2></div></div></div><p>For this recipe, we will use the same <code class="literal">xlsxwriter</code> module and format the cells. We will learn how to add and apply formats to the cells.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec60"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">We continue with the expenses example to demonstrate the formatting of cells. But first let's understand how to create formats. Formats are added with the  <code class="literal">add_format()</code> method. This method returns a <code class="literal">format</code> object. The following code example shows how to create a format:<pre class="programlisting">        format = workbook.add_format()&#13;
        format.set_bold()&#13;
        format.set_font_color('green')</pre><p>In the preceding example, we created a cell format, wherein the data in the cell (to which the format is applied) is <code class="literal">bold</code> and color is set to <code class="literal">green</code>.</p></li><li class="listitem">Coming back to the example of expenses sheet, how about highlighting the cells where the expenses have gone above 150? Yes, we can do that programmatically by creating a format to highlight the cells in red. But let's go in order. First, we create a sheet and add data to it, as in the following code:<pre class="programlisting">        import xlsxwriter&#13;
        workbook = xlsxwriter.Workbook('cell_format.xlsx')&#13;
        worksheet = workbook.add_worksheet()&#13;
        expenses = (&#13;
            ['Rent', 1000],&#13;
            ['Gas',   100],&#13;
            ['Food',  300],&#13;
            ['Gym',    50],&#13;
        )&#13;
&#13;
        row = 0&#13;
        col = 0&#13;
        for item, cost in (expenses):&#13;
            worksheet.write(row, col, item)&#13;
            worksheet.write(row, col + 1, cost)&#13;
            row += 1</pre><p>The preceding code will create an Excel sheet named <code class="literal">cell_format.xlsx</code> and add expenses to it.</p></li><li class="listitem">Now, let's create a format where the cells are colored with blue and the cell values will be in red. We could set the format with the <code class="literal">set_font_color()</code> method, but in the following example, we set the format through options like <code class="literal">'bg_color'</code> and <code class="literal">'font_color'</code>:<pre class="programlisting">        format1 = workbook.add_format({'bg_color': 'blue',&#13;
                          'font_color': 'red'})</pre><p>
</p></li><li class="listitem">Now, the only remaining step is to apply this format on the expenses that are above 150. The following code applies the format and respects the condition:<pre class="programlisting">        worksheet.conditional_format('B1:KB5',  &#13;
              {'type': 'cell',&#13;
               'criteria': '&gt;=',&#13;
               'value': 150,&#13;
               'format': format1} &#13;
        ) &#13;
        workbook.close()&#13;
</pre><p>When we run this program, the contents of the <code class="literal">cell_format.xlsx</code> file looks as shown in the following screenshot:</p><p>
</p><div class="mediaobject"><img alt="How to do it..." src="graphics/image_03_016.jpg"/></div><p>
</p></li></ol></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec61"/>There's more...</h2></div></div></div><p>Cool, so now that we have the cell formatting done, how about moving on to working with formulas in Excel sheets?</p></div></div>
<div class="section" title="Playing with Excel formulae"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec25"/>Playing with Excel formulae</h1></div></div></div><p>We take a very simple example to demonstrate the use of formulae in Excel sheets.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec62"/>Getting ready</h2></div></div></div><p>For this recipe, we will use the same <code class="literal">xlsxwriter</code> module and add formulae to the cells. There are numerous operations that are supported by Excel sheets, such as getting standard deviation of data, logarithm, getting trends among others, so it's worth spending time to understand the majority of available operations.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec63"/>How to do it...</h2></div></div></div><p>You need to perform the following step:</p><p>We work with a simple example, wherein we add a list of numbers with the  <code class="literal">SUM()</code> formula and store the sum to the cell <span class="strong"><strong>A1</strong></span>:</p><pre class="programlisting">        import xlsxwriter&#13;
        workbook = xlsxwriter.Workbook('formula.xlsx')&#13;
        worksheet = workbook.add_worksheet()&#13;
        worksheet.write_formula('A1', '=SUM(1, 2, 3)')&#13;
        workbook.close()</pre></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec64"/>How it works...</h2></div></div></div><p>
</p><p>When we run the preceding code, a new Excel file, <code class="literal">formula.xlsx</code> gets created with cell <span class="strong"><strong>A1</strong></span> containing the number <span class="strong"><strong>6</strong></span> (addition of <code class="literal">1</code>, <code class="literal">2</code>, and <code class="literal">3</code>).</p><p>
</p><p>As in the preceding section, we can perform more complex mathematical operations using Excel formulae. For instance, you can plan the yearly IT budget for your team in an Excel sheet.</p><p>
</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec65"/>There's more...</h2></div></div></div><p>There's no fun if we don't discuss about charts and finish a chapter on Excel sheets. Yes, in the next section we will talk about working with Excel charts.</p></div></div>
<div class="section" title="Building charts within Excel sheets"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec26"/>Building charts within Excel sheets</h1></div></div></div><p>Excel sheets are capable of building a variety of charts, including line chart, bar chart, and pie charts among others that help us depict trends and visualize data.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec66"/>Getting ready</h2></div></div></div><p>For this recipe, we will use the same <code class="literal">xlsxwriter</code> module and use methods defined in the module to build charts.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec67"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In this example, we will write a column in an Excel file that is filled with numbers. We can take the values in all the cells and construct a line chart:<pre class="programlisting">        import xlsxwriter&#13;
&#13;
        workbook = xlsxwriter.Workbook('chart_line.xlsx')&#13;
        worksheet = workbook.add_worksheet()&#13;
&#13;
        data = [10, 40, 50, 20, 10, 50]&#13;
        worksheet.write_column('A1', data)&#13;
        chart = workbook.add_chart({'type': 'line'})&#13;
        chart.add_series({'values': '=Sheet1!$A$1:$A$6'})&#13;
        worksheet.insert_chart('C1', chart)&#13;
&#13;
        workbook.close()</pre><p>In the preceding code snippet, we have a list of data that has integer values ranging from <code class="literal">10</code> to <code class="literal">50</code>. As usual, we create a workbook with the <code class="literal">Workbook()</code> method and add a default <span class="strong"><strong>Sheet1</strong></span> worksheet. We then write a new column with all the numbers present in the list data.</p></li><li class="listitem">The <code class="literal">add_chart()</code> method then defines the type of chart. In this case, it's a line chart. The <code class="literal">add_chart()</code> method returns an object of type chart. But simply creating an object doesn't help. How will the chart know the data points to be plotted? This happens with the <code class="literal">add_series()</code> method that takes the cell values to plot the graph. In this case, the cell ranges from <span class="strong"><strong>A1</strong></span> to <span class="strong"><strong>A6</strong></span> (remember we have added all the numbers from the <code class="literal">data</code> list to column <span class="strong"><strong>A</strong></span> beginning at <span class="strong"><strong>A1</strong></span>).</li><li class="listitem">Once the chart is ready, it should also be added on to the Excel sheet. This is achieved with the <code class="literal">insert_chart()</code> method that takes the cell name and chart object as arguments. In this example, the chart is inserted at cell <span class="strong"><strong>C1</strong></span>.</li><li class="listitem">When we run this program, a new file <code class="literal">chart_line.xlsx</code> gets created with the line graph inserted in it. The following screenshot shows the line graph and plotted data:<p>
</p><div class="mediaobject"><img alt="How to do it..." src="graphics/image_03_017.jpg"/></div><p>
</p></li></ol></div></div></div>
<div class="section" title="Automating&#xA0;the comparison of company financials"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec27"/>Automating the comparison of company financials</h1></div></div></div><p>Our recipes on Excel sheets covered multiple aspects like reading/writing files, formatting cells, working with formulae, and charts. Let's solve a nice business case with the knowledge we gained in this chapter.</p><p>Monica is a Finance manager at Xtel Inc and is responsible for the company's earnings. Xtel Inc is looking for funding, and Monica is tasked with comparing the company financials based on the income statements of the last three years. This data will go to the investors so that they can make an appropriate decision about investing in Xtel Inc. Getting this data for three years will be easy, but the CFO of Xtel has asked Monica to get this data on a month-on-month basis for the last 5 years. Monica is worried about comparing the company financials for 60 months manually!
With the knowledge gained in this chapter, do you think you can help Monica?</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec68"/>Getting ready</h2></div></div></div><p>Lets solve Monica's problem with a Python recipe. For this recipe, we will compare the financials of the last three years for Xtel Inc and plot the comparison in an Excel sheet using Python. We will do that with the help of the factors influencing the company's income statement, that is, the revenue, costs, and gross profits.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec69"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the following code, we first add the information on the company financials, such as revenue, the cost of goods sold, and the gross profit. Assume that we have this data in a Python list <code class="literal">data</code>.</li><li class="listitem">We then plot these values in a column chart and also calculate the net gain in percentages using Excel formulae. The following code snippet does exactly what Monica needs:<pre class="programlisting">        import xlsxwriter&#13;
&#13;
        workbook = xlsxwriter.Workbook('chart_column.xlsx')&#13;
&#13;
        worksheet = workbook.add_worksheet()&#13;
        chart = workbook.add_chart({'type': 'column'})&#13;
&#13;
        data = [&#13;
               ['Year', '2013', '2014', '2015'],&#13;
               ['Revenue', 100, 120, 125],&#13;
               ['COGS', 80, 90, 70],&#13;
               ['Profit', 20, 30, 55], &#13;
        ]&#13;
&#13;
        worksheet.write_row('A1', data[0])&#13;
        worksheet.write_row('A2', data[1])&#13;
        worksheet.write_row('A3', data[2])&#13;
        worksheet.write_row('A4', data[3])&#13;
&#13;
        chart.add_series({'values': '=Sheet1!$B$2:$B$4', 'name':'2013'}) &#13;
        chart.add_series({'values': '=Sheet1!$C$2:$C$4', 'name':'2014'})&#13;
        chart.add_series({'values': '=Sheet1!$D$2:$D$4', 'name':'2015'}) &#13;
        worksheet.insert_chart('G1', chart)&#13;
&#13;
        worksheet.write(5, 0, '% Gain')&#13;
        worksheet.write(5, 1, '=(B4/B2)*100')&#13;
        worksheet.write(5, 2, '=(C4/C2)*100')&#13;
        worksheet.write(5, 3, '=(D4/D2)*100')&#13;
&#13;
        workbook.close()</pre><p>
</p></li><li class="listitem">When we run this Python program, a new Excel sheet is generated that compares the company's financial performance across three years, as shown in the following screenshot. Exactly what Monica wanted! :)<p>
</p><div class="mediaobject"><img alt="How to do it..." src="graphics/image_03_018.jpg"/></div><p>
</p></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec70"/>How it works...</h2></div></div></div><p>In the preceding code snippet, we collect the data of the company financials in a Python list, <code class="literal">data</code>.</p><p>Using the <code class="literal">xlsxwriter</code> module, we create a workbook object and then add a worksheet to it with the <code class="literal">add_worksheet()</code> method.</p><p>Once we have the worksheet and the data, we start writing the data into the worksheet with the <code class="literal">write_row()</code> method.</p><p>We also add a chart object to our worksheet. This will help us add bar charts for comparing the company financials of the last three years easily. We add the chart object using the <code class="literal">add_chart()</code> method.</p><p>Since we have the data already populated in our sheet, we use this data to create bar charts for all three years using the <code class="literal">add_series()</code> method. The <code class="literal">add_series()</code> method takes the excel cells as parameters and plots the bar chart for the data in these cells. Finally, we insert the chart object (and the bar charts) in the worksheet with the <code class="literal">insert_chart()</code> method.</p><p>At last, we add the gain figures for all the years with excel formula using the <code class="literal">write()</code> method.</p><p>Cool! That was easy, you did it for Monica! She can modify this Python code snippet to compare the company financials for all the data points she needs and that too in a very short time. Indeed, the CEO of Xtel Inc will be very happy with her work!</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec71"/>There's more...</h2></div></div></div><p>Well guys, that's it for this chapter. The fun with CSV and Excel files never ceases. There are many more operations that you can perform with these files, and they can be used in different ways in the business and software development world. So, I highly recommend you to try out the modules we discussed in this chapter and build on them for your own use case. See you in the next chapter!</p></div></div></body></html>