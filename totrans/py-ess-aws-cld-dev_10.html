<html><head></head><body>
<div><div><h1 class="chapter-number" id="_idParaDest-94"><a id="_idTextAnchor014"/>10</h1>
<h1 id="_idParaDest-95">Using Python with NoSQL (DynamoDB)</h1>
<p>In this chapter, we are going to learn how to create a NoSQL database with DynamoDB. After creating the database, we will carry out a database operation in DynamoDB using Python. <strong class="bold">NoSQL</strong> is a database type that is used to manage data more flexibly than a relational database. In relational databases, there are tables and predefined data types that can be used for database operations. In NoSQL, you can store JSON, raw, or key-value data, depending on the NoSQL database. Let’s deep-dive into NoSQL databases.</p>
<p>The chapter covers the following topics:</p>
<ul>
<li>What is a NoSQL database?</li>
<li>What is a DynamoDB database?</li>
<li>DynamoDB operations with Python</li>
</ul>
<h1 id="_idParaDest-96">What is a NoSQL database?</h1>
<p>A NoSQL database is used to store unstructured data. The idea comes from big data; most applications <a id="_idIndexMarker325"/>and devices create data, and this data is valuable if you store and process it afterward. The volume of data is increasing day by day, and we need to store this data. Think about new cars; they have different devices to store data. We can extend our example to white goods, social media, and so on. In general, relational databases are useful for structured data and a level of records that runs into the millions. Thus, when it comes to handling millions of records as well as unstructured data, NoSQL is useful.</p>
<p>The following figure shows how different data sources can be generated to be stored in a NoSQL database. We have social media resources and machines in cars and planes that generate different data formats:</p>
<div><div><img alt="" height="255" src="img/Figure_10.1_B19195.jpg" width="552"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.1 – NoSQL</p>
<p>There are different types of NoSQL databases.</p>
<h2 id="_idParaDest-97">Key-value database</h2>
<p>In this NoSQL <a id="_idIndexMarker326"/>database type, you can access data based <a id="_idIndexMarker327"/>on keys. For example, you have customer ID as a key, and address, age, and family information as values. When you need to access the value, you just provide the key as a query parameter:</p>
<div><div><img alt="" height="249" src="img/Figure_10.2_B19195.jpg" width="606"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.2 – A key-value database</p>
<p>A key-value database is useful and even works on billions of records. We will investigate DynamoDB, which is a key-value database, in an upcoming section.</p>
<h2 id="_idParaDest-98">Document database</h2>
<p>A document <a id="_idIndexMarker328"/>database is another type of NoSQL database that can <a id="_idIndexMarker329"/>store unstructured data such as JSON. It is useful if you need to store unstructured big data and retrieve data with different parameters:</p>
<div><div><img alt="" height="260" src="img/Figure_10.3_B19195.jpg" width="642"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.3 – Document database</p>
<p>You can see the sample JSON as follows:</p>
<pre class="source-code">
{
    "employee": {
        "name":"Jack",
        "age":25
    }
}</pre>
<p>There are other types of NoSQL databases, such as graph and column, but we won’t focus <a id="_idIndexMarker330"/>on them in this book. I would recommend reading more over here: <a href="https://en.wikipedia.org/wiki/NoSQL">https://en.wikipedia.org/wiki/NoSQL</a>.</p>
<p>We have learned the definition of a NoSQL database and taken a look at some types of NoSQL databases. For the next step, we will focus on DynamoDB, which is one type of key-value database.</p>
<h1 id="_idParaDest-99">What is a DynamoDB database?</h1>
<p>A <strong class="bold">DynamoDB database</strong> is a <a id="_idIndexMarker331"/>key-value NoSQL database that is managed by AWS. When you use DynamoDB, you don’t need to create a new database. You don’t need to provision a server either; it is fully managed by AWS. It is one of the most popular cloud-based NoSQL databases, and the performance is very good if you are using key-based access. The main advantage is that you can access data within a latency of milliseconds along with billions of records.</p>
<p>These are <a id="_idIndexMarker332"/>the features of DynamoDB:</p>
<ul>
<li>Fully managed by AWS</li>
<li>Autoscaling without any configuration</li>
<li>Built-in integration with other AWS services</li>
<li>Supports monitoring and logging</li>
<li>Supports database backup and restoration</li>
<li>Pay-as-you-go model – you pay for how much you use from this service</li>
</ul>
<h2 id="_idParaDest-100">Creating a DynamoDB database</h2>
<p>In this <a id="_idIndexMarker333"/>subtopic, we are going to create a DynamoDB database. Let’s follow the instructions step by step:</p>
<ol>
<li>Type <code>DynamoDB</code> into the search box and click the <strong class="bold">DynamoDB</strong> option that appears under the <strong class="bold">Services</strong> section:</li>
</ol>
<div><div><img alt="" height="314" src="img/Figure_10.4_B19195.jpg" width="951"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.4 – Console search</p>
<ol>
<li value="2">Click <strong class="bold">Tables</strong> on the left side, and then click the <strong class="bold">Create </strong><strong class="bold">table</strong> button:</li>
</ol>
<div><div><img alt="" height="293" src="img/Figure_10.5_B19195.jpg" width="1040"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.5 – Create table</p>
<ol>
<li value="3">Fill out <a id="_idIndexMarker334"/>the <strong class="bold">Table name</strong>, <strong class="bold">Partition key</strong>, and <strong class="bold">Sort key</strong> details in order to create the table:</li>
</ol>
<div><div><img alt="" height="793" src="img/Figure_10.6_B19195.jpg" width="1073"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.6 – Table details – part 1</p>
<p><strong class="bold">Table name</strong> represents the name of the table. We will create a sample customer table.</p>
<p><strong class="bold">Partition key</strong> is going to be used as a primary key. DynamoDB is a key-value database; hence, you can easily search for data based on the key. In this case, we will use <strong class="bold">customer_id</strong> as a primary key.</p>
<p>DynamoDB <a id="_idIndexMarker335"/>allows you to search with a sort key in addition to the partition key. We will use <strong class="bold">customer_mail</strong> in the <strong class="bold">Sort key</strong> field.</p>
<ol>
<li value="4">Scroll down and fill out <strong class="bold">Capacity mode</strong>, <strong class="bold">Read capacity</strong>, <strong class="bold">Write capacity</strong>, <strong class="bold">Auto scaling</strong>, <strong class="bold">Local secondary indexes</strong>, and <strong class="bold">Global secondary indexes</strong>. For the input, keep the following default values as is:</li>
</ol>
<div><div><img alt="" height="813" src="img/Figure_10.7_B19195.jpg" width="730"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.7 – Table details – part 2</p>
<p><strong class="bold">Capacity mode</strong> defines <a id="_idIndexMarker336"/>the reserved capacity for the table. If you select the provisioned mode, AWS reserves your predefined capacity to be used by the queries. Another option is to define on-demand for unplanned capacity reservations.</p>
<p><strong class="bold">Read capacity</strong> and <strong class="bold">write capacity</strong> define how many read and write requests are supported for this table.</p>
<p>Regarding <strong class="bold">Auto scaling</strong>, AWS manages the scaling feature.</p>
<p><strong class="bold">Local secondary indexes</strong> and <strong class="bold">Global secondary indexes</strong> are used if you need <a id="_idIndexMarker337"/>more index values in addition to the primary key <a id="_idIndexMarker338"/>and sort key. The local secondary index allows you to create an additional index that has the same partition ID with a different sort key from the base table. You need to define this during table creation. On the other hand, a global secondary index allows you to create an index that can have a different partition ID and sort key from the base primary key.</p>
<ol>
<li value="5">Click <strong class="bold">Create table</strong>, as you saw in the previous screenshot, and you will see the created table in the list:</li>
</ol>
<div><div><img alt="" height="178" src="img/Figure_10.8_B19195.jpg" width="1244"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.8 – The table list</p>
<ol>
<li value="6">Let’s insert <a id="_idIndexMarker339"/>one of the items via the AWS Management Console. Select <strong class="bold">customer</strong> under the <strong class="bold">Tables</strong> list:</li>
</ol>
<div><div><img alt="" height="371" src="img/Figure_10.9_B19195.jpg" width="880"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.9 – Customer table</p>
<p>You will see the details of the table:</p>
<div><div><img alt="" height="538" src="img/Figure_10.10_B19195.jpg" width="1100"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.10 – Table details</p>
<ol>
<li value="7">Click <a id="_idIndexMarker340"/>the <strong class="bold">Actions</strong> drop-down button and select <strong class="bold">Create item</strong>:</li>
</ol>
<div><div><img alt="" height="656" src="img/Figure_10.11_B19195.jpg" width="772"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.11 – Create item</p>
<ol>
<li value="8">After <a id="_idIndexMarker341"/>clicking this, you will see an item creation page, titled <strong class="bold">Create item</strong>. You can fill out a form or insert the JSON directly. In this example, we will insert the code via <strong class="bold">JSON view</strong>. DynamoDB creates a template for you:</li>
</ol>
<div><div><img alt="" height="307" src="img/Figure_10.12_B19195.jpg" width="943"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.12 – The JSON view</p>
<p>Paste <a id="_idIndexMarker342"/>the following JSON as an example:</p>
<pre class="console">
{
  "customer_id": {
    "S": "123"
  },
  "customer_mail": {
    "S": "serkansakinmaz@gmail.com"
  },
   "name": {
    "S": "Serkan"
  },
   "address": {
    "S": "Germany"
  }
}</pre>
<p>The JSON is simple and consists of <code>customer_id</code>, <code>customer_mail</code>, <code>name</code>, and <code>address</code> information.</p>
<ol>
<li value="9">Click <strong class="bold">Create item</strong>:</li>
</ol>
<div><div><img alt="" height="461" src="img/Figure_10.13_B19195.jpg" width="772"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.13 – Creating an item</p>
<p>After the <a id="_idIndexMarker343"/>creation, you will be forwarded to the <strong class="bold">Tables</strong> page:</p>
<div><div><img alt="" height="409" src="img/Figure_10.14_B19195.jpg" width="938"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.14 – The item list</p>
<p>Since you are using NoSQL, you can also insert the JSON, which is a different format from the previous JSON that we inserted. The following JSON is also valid for the customer table:</p>
<pre class="console">
{
  "customer_id": {
    "S": "1234"
  },
  "customer_mail": {
    "S": "jane@gmail.com"
  },
   "name": {
    "S": "Jane"
  },
   "profession": {
    "S": "Data Engineer"
  }
}</pre>
<p>As you see, we have <a id="_idIndexMarker344"/>removed the <code>address</code> field and added <code>profession</code> as a new field without any issue.</p>
<p>In this section, we have created a DynamoDB table and inserted data via the console. As you can see, DynamoDB is a key-value database and you can insert different JSON formats, which provides flexibility.</p>
<h1 id="_idParaDest-101">DynamoDB operations with Python</h1>
<p>In this section, we are <a id="_idIndexMarker345"/>going to read the DynamoDB <a id="_idIndexMarker346"/>table via Python. To execute a Python function, we will implement a Lambda function to read data from DynamoDB. Carry out the following steps:</p>
<ol>
<li>We will create the required permissions to allow Lambda to read from DynamoDB. Open IAM and click <strong class="bold">Policies</strong> on the left-hand side:</li>
</ol>
<div><div><img alt="" height="347" src="img/Figure_10.15_B19195.jpg" width="733"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.15 – IAM policies</p>
<ol>
<li value="2">Click <strong class="bold">Create policy</strong>:</li>
</ol>
<div><div><img alt="" height="184" src="img/Figure_10.16_B19195.jpg" width="894"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.16 – Creating a policy</p>
<ol>
<li value="3">Paste <a id="_idIndexMarker347"/>the <a id="_idIndexMarker348"/>following policy:<pre class="console">
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "dynamodb:BatchGetItem",
                "dynamodb:GetItem",
                "dynamodb:Query",
                "dynamodb:Scan",
                "dynamodb:BatchWriteItem",
                "dynamodb:PutItem",
                "dynamodb:UpdateItem"
            ],
            "Resource": "arn:aws:dynamodb:us-east-1:961487522622:table/customer"
        }
    ]
}</pre></li>
</ol>
<p>The policy <a id="_idIndexMarker349"/>allows you to read <a id="_idIndexMarker350"/>from the DynamoDB table. In general, the following access policy works for you as well; however, you need to change the account ID that you have, because every AWS account has a different account ID:</p>
<div><div><img alt="" height="649" src="img/Figure_10.17_B19195.jpg" width="1100"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.17 – A DynamoDB policy</p>
<ol>
<li value="4">You can <a id="_idIndexMarker351"/>add the policy name <a id="_idIndexMarker352"/>and finish creating the policy. In this example, I am using <strong class="bold">DynamoDBCustomerTableOperations</strong> as a policy name:</li>
</ol>
<div><div><img alt="" height="615" src="img/Figure_10.18_B19195.jpg" width="994"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.18 – Policy creation</p>
<ol>
<li value="5">We now <a id="_idIndexMarker353"/>need to create a role. This <a id="_idIndexMarker354"/>role will be attached to Lambda to access DynamoDB. Click <strong class="bold">Create role</strong> in the IAM service:</li>
</ol>
<div><div><img alt="" height="154" src="img/Figure_10.19_B19195.jpg" width="681"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.19 – The IAM role</p>
<ol>
<li value="6">Since we need a policy for Lambda, select <strong class="bold">Lambda</strong> in the <strong class="bold">Use </strong><strong class="bold">case</strong> section:</li>
</ol>
<div><div><img alt="" height="617" src="img/Figure_10.20_B19195.jpg" width="834"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.20 – The IAM role for Lambda</p>
<ol>
<li value="7">As depicted <a id="_idIndexMarker355"/>in the following <a id="_idIndexMarker356"/>screenshot, add the policy that we created to access Lambda:</li>
</ol>
<div><div><img alt="" height="468" src="img/Figure_10.21_B19195.jpg" width="1077"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.21 – Selecting the policy</p>
<ol>
<li value="8">Fill in <strong class="bold">Role name</strong> and <a id="_idIndexMarker357"/>create the <a id="_idIndexMarker358"/>role. As you see, the name we have given to the Lambda function is <strong class="bold">DynamoDBCustomerTableRole</strong>. Scroll down and click the <strong class="bold">Create </strong><strong class="bold">role</strong> button:</li>
</ol>
<div><div><img alt="" height="589" src="img/Figure_10.22_B19195.jpg" width="672"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.22 – Creating a role</p>
<ol>
<li value="9">The <code>readFromDynamoDB</code> to <strong class="bold">Function name</strong> and <strong class="bold">Python 3.9</strong> to <strong class="bold">Runtime</strong>:</li>
</ol>
<div><div><img alt="" height="380" src="img/Figure_10.23_B19195.jpg" width="1414"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.23 – Creating a function</p>
<ol>
<li value="10">At the <a id="_idIndexMarker359"/>bottom of the preceding page, there is <a id="_idIndexMarker360"/>a panel to define the execution policy. Select <strong class="bold">Use an existing role</strong> under the <strong class="bold">Execution role</strong> section and select the role that we created:</li>
</ol>
<div><div><img alt="" height="671" src="img/Figure_10.24_B19195.jpg" width="805"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.24 – Selecting the role</p>
<ol>
<li value="11">Lambda <a id="_idIndexMarker361"/>is ready to fill out a <a id="_idIndexMarker362"/>code block:</li>
</ol>
<div><div><img alt="" height="444" src="img/Figure_10.25_B19195.jpg" width="1101"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.25 – The Lambda function</p>
<p>Paste <a id="_idIndexMarker363"/>the following code into the <a id="_idIndexMarker364"/>Lambda function:</p>
<pre class="console">
import json
import boto3
def lambda_handler(event, context):
    dynamodb = boto3.resource('dynamodb', region_name="us-east-1")
    table = dynamodb.Table('customer')
    response = table.get_item(Key={'customer_id': "123", 'customer_mail': "serkansakinmaz@gmail.com"})
    item = response['Item']
    print(item)
    return {
        'statusCode': 200,
        'body': json.dumps('Hello from Lambda!')
    }</pre>
<p>The code imports the <code>boto3</code> library, which provides useful functions for DynamoDB operations. <code>boto3</code> is a library that includes AWS service-specific features to facilitate <a id="_idIndexMarker365"/>the implementation of cloud applications <a id="_idIndexMarker366"/>while working with Python on AWS. You can <a id="_idIndexMarker367"/>get more details from the following link:<a href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.xhtml"> https://boto3.amazonaws.com/v1/documentation/api/latest/index.xhtml</a>.</p>
<p>As a first step, we define the <code>dynamodb</code> resource by calling the <code>boto3.resource</code> function. After calling that, we define the table that we read; it is the <code>dynamodb.Table</code> table. Once you define the table, the <code>table.get_item</code> function takes the primary key and sort key as a parameter and returns the query results.</p>
<p>Once you run the Lambda function, you are able to see the result:</p>
<div><div><img alt="" height="428" src="img/Figure_10.26_B19195.jpg" width="1076"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 10.26 – Execution results</p>
<p>Congratulations! You are able to define the role and retrieve an item from Lambda. As you can see, AWS requires some configuration to access data in DynamoDB.</p>
<h1 id="_idParaDest-102">Summary</h1>
<p>In this chapter, we learned about the AWS DynamoDB service and how to create a DynamoDB database in AWS. After creating the database, we implemented a Lambda Python code snippet that read items from DynamoDB. You now also know how to extend the Lambda code to insert data into a DynamoDB table. DynamoDB is useful when you need to implement a key-value database that is managed by AWS. It comes with scalability, logging, and monitoring advantages. In the following chapter, we will take a look at the Glue service.</p>
</div>
</div></body></html>