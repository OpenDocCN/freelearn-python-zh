<html><head></head><body>
<div><div><div><h1 id="_idParaDest-316"><em class="italic"><a id="_idTextAnchor297"/>Chapter 18</em>: Other Creational Patterns</h1>
			<p>In the previous chapter, we covered a third creational pattern, builder, which offers a nice way of creating the various parts of a complex object. Apart from the factory method, the abstract factory, and the builder patterns covered so far, other creational patterns are interesting to discuss, such as the <strong class="bold">prototype</strong> pattern and the <strong class="bold">singleton</strong> pattern.</p>
			<p>In this chapter, we will discuss the following topics:</p>
			<ul>
				<li>Implementing the prototype pattern</li>
				<li>Implementing the singleton pattern</li>
			</ul>
			<p>These topics will complete our discussions on creational patterns and help cover the use cases where the design patterns we have seen so far are not appropriate. By the end of the chapter, we will have an overall understanding of creational patterns and the use cases of each one.</p>
			<h1 id="_idParaDest-317"><a id="_idTextAnchor298"/>Technical requirements</h1>
			<p>The code files for this chapter can be accessed through this link: <a href="https://github.com/PacktPublishing/Advanced-Python-Programming-Second-Edition/tree/main/Chapter18">https://github.com/PacktPublishing/Advanced-Python-Programming-Second-Edition/tree/main/Chapter18</a>.</p>
			<h1 id="_idParaDest-318"><a id="_idTextAnchor299"/>Implementing the prototype pattern</h1>
			<p>The prototype pattern <a id="_idIndexMarker1194"/>is useful when you need to create objects <a id="_idIndexMarker1195"/>based on an existing object using the <strong class="bold">cloning</strong> technique. As you may have guessed, the idea is to use a copy of that object's complete structure to produce the new object. We will see that this is almost natural in Python because we have a <strong class="bold">copy</strong> feature that helps greatly in using this technique. In the general case of creating a copy of an object, what happens is that you make a new reference to the <a id="_idIndexMarker1196"/>same object, a method called a <strong class="bold">shallow copy</strong>. But if you need <a id="_idIndexMarker1197"/>to duplicate the object, which is the case with a prototype, you make a <strong class="bold">deep copy</strong>.</p>
			<p>Sometimes, we need to create an exact copy of an object. For instance, assume that you want to create an application for storing, sharing, and editing presentation and marketing content for products promoted by a group of salespeople. Think of the popular distribution <a id="_idIndexMarker1198"/>model called <strong class="bold">direct selling</strong> or <strong class="bold">network marketing</strong>, the <a id="_idIndexMarker1199"/>home-based activity where individuals partner with a company to distribute products within their social network using promotional tools (brochures, PowerPoint presentations, videos, and so on).</p>
			<p>Let's say a user, <em class="italic">Bob</em>, leads a team of distributors within a network marketing organization. They use <a id="_idIndexMarker1200"/>a presentation video daily to introduce the product to their prospects. At some point, Bob gets his friend, Alice, to join him and she also uses the same video (one of the governing principles is to follow the system or, as they say, <em class="italic">Duplicate what already works</em>). But Alice soon finds prospects that could join her team and help her business grow, if only the video was in French, or at least subtitled. <em class="italic">What should they do?</em> The original presentation video cannot be used for the different custom needs that may arise.</p>
			<p>To help everyone, the system could allow distributors with certain rank or trust levels, such as <em class="italic">Bob</em>, to create independent copies of the original presentation video, as long as the new version is validated by the compliance team of the backing company before public use. Each copy is <a id="_idIndexMarker1201"/>called a <strong class="bold">clone</strong>; it is an exact copy of the original object at a specific point in time.</p>
			<p>So, Bob, with the validation of the compliance team, makes a copy of the presentation video to address the new need and hands it over to Alice. She could then adapt that version by adding French subtitles.</p>
			<p>With cloning, Bob and Alice can have their own copy of a video, and as such, changes by each one of them will not affect the other person's version of the material. In the alternative situation, which is what actually happens by default, each person would hold a reference to the same (reference) object; changes made by Bob would impact Alice, and vice versa.</p>
			<p>The prototype design pattern helps us with creating object clones. In its simplest version, this pattern is just a <code>clone()</code> function that accepts an object as an input parameter and returns a clone of it. In Python, this can be done using the <code>deepcopy()</code> function from the <code>copy</code> module.</p>
			<p>The structure of our discussions will be the same as in previous chapters. First, we will briefly discuss real-life applications and use cases, and then implement a hands-on example in Python.</p>
			<h2 id="_idParaDest-319"><a id="_idTextAnchor300"/>Real-world examples</h2>
			<p>A famous <a id="_idIndexMarker1202"/>non-technical example is the sheep named Dolly, which was created by researchers in Scotland by cloning a cell from a mammary gland.</p>
			<p>Many Python applications make use of the prototype pattern (<code>j.mp/pythonprot</code>), but it is seldom referred to as <em class="italic">prototype</em> since cloning objects is a built-in feature of the language.</p>
			<h2 id="_idParaDest-320"><a id="_idTextAnchor301"/>Use cases</h2>
			<p>The prototype <a id="_idIndexMarker1203"/>pattern is useful when we have an existing object that needs to stay untouched, and we want to create an exact copy of it, allowing changes in some parts of the copy.</p>
			<p>There is also the frequent need for duplicating an object that is populated from a database and has references to other database-based objects. It is costly (multiple queries to a database) to clone such a complex object, so a prototype is a convenient way to solve the problem.</p>
			<h2 id="_idParaDest-321"><a id="_idTextAnchor302"/>Implementation</h2>
			<p>Nowadays, some organizations, even of small size, deal with many websites and apps via their <a id="_idIndexMarker1204"/>infrastructure/DevOps teams, hosting providers, or cloud service providers.</p>
			<p>When you have to manage multiple websites, there is a point where it becomes difficult to manage everything. You need to access information quickly, such as IP addresses that are involved, domain names and their expiration dates, and maybe details about the DNS parameters. So, you need a kind of inventory tool.</p>
			<p>Let's imagine how these teams deal with this type of data for daily activities and touch on the implementation of a piece of software that helps consolidate and maintain the data (other than in Excel spreadsheets):</p>
			<ol>
				<li>First, we need to import Python's standard <code>copy</code> module, as follows:<pre>import copy</pre></li>
				<li>At the heart of this system, we will have a <code>Website</code> class for holding all the useful information such as the name, the domain name, the description, and the author of a website we are managing.</li>
			</ol>
			<p>In the <code>__init__()</code> method of the class, only some parameters are fixed, <code>name</code>, <code>domain</code>, <code>description</code>, and <code>author</code>, which correspond to the information we listed previously. But we also want flexibility, and client code can pass more parameters in the form of keywords (<code>name=value</code>) using the <code>kwargs</code> variable-length collection (a Python dictionary).</p>
			<p>Note that there is a Python idiom to set an arbitrary attribute named <code>attr</code> with a value, <code>val</code>, on an object, <code>obj</code>, using the <code>setattr()</code> built-in function: <code>setattr(obj, attr, val)</code>.</p>
			<p>So, we are <a id="_idIndexMarker1205"/>using this technique for the optional attributes of our class, at the end of the initialization method, as follows:</p>
			<pre>for key in kwargs:
    setattr(self, key, kwargs[key])</pre>
			<p>So, our <code>Website</code> class is defined as follows:</p>
			<pre>class Website: 
    def __init__(self, name, domain, description, \
      author, **kwargs): 
        '''Examples of optional attributes (kwargs): 
           category, creation_date, technologies, \
             keywords.
        ''' 
        self.name = name 
        self.domain = domain 
        self.description = description
        self.author = author
        
        for key in kwargs:
            setattr(self, key, kwargs[key])
 
    def __str__(self): 
        summary = [f'Website "{self.name}"\n',] 
        
        infos = vars(self).items()
        ordered_infos = sorted(infos)
        for attr, val in ordered_infos:
            if attr == 'name':
                continue
            summary.append(f'{attr}: {val}\n')
            
        return ''.join(summary)</pre>
			<ol>
				<li value="3">Next, the <code>Prototype</code> class implements the prototype design pattern.</li>
			</ol>
			<p>At the heart <a id="_idIndexMarker1206"/>of the <code>Prototype</code> class is the <code>clone()</code> method, which is in charge of cloning the object using the <code>copy.deepcopy()</code> function. Since cloning means we allow values to be set for optional attributes, notice how we use the <code>setattr()</code> technique here with the <code>attrs</code> dictionary.</p>
			<p>Also, for more convenience, the <code>Prototype</code> class contains the <code>register()</code> and <code>unregister()</code> methods, which <a id="_idIndexMarker1207"/>can be used to keep track of the cloned objects in a dictionary:</p>
			<pre>class Prototype: 
    def __init__(self): 
        self.objects = dict() 
 
    def register(self, identifier, obj): 
        self.objects[identifier] = obj 
 
    def unregister(self, identifier): 
        del self.objects[identifier] 
 
    def clone(self, identifier, **attrs): 
        found = self.objects.get(identifier) 
        if not found: 
            raise ValueError(f'Incorrect object \
              identifier:{identifier}') 
        obj = copy.deepcopy(found) 
        for key in attrs:
            setattr(obj, key, attrs[key])
        return obj</pre>
			<ol>
				<li value="4">In the <code>main()</code> function, as shown in the following code, we can clone a first <code>Website</code> instance, <code>site1</code>, to get a second object, <code>site2</code>. Basically, we instantiate the <code>Prototype</code> class <a id="_idIndexMarker1208"/>and we use its <code>.clone()</code> method. That is what the following code shows:<pre>def main(): 
    keywords = ('python', 'data', 'apis', \
      'automation')
    site1 = Website('ContentGardening', 
            domain='contentgardening.com', 
            description='Automation and data-driven \
              apps', 
            author='Kamon Ayeva',
            category='Blog',
            keywords=keywords)
 
    prototype = Prototype() 
    identifier = 'ka-cg-1' 
    prototype.register(identifier, site1)
    
    site2 = prototype.clone(identifier, 
            name='ContentGardeningPlayground',
            domain='play.contentgardening.com', 
            description='Experimentation for \
              techniques featured on the blog', 
            category='Membership site',
            creation_date='2018-08-01')    </pre></li>
				<li>To end that function, we can use the <code>id()</code> function, which returns the memory address of an object, for comparing both objects' addresses, as follows. When we clone an object using a deep copy, the memory addresses of the clone must be different from the memory addresses of the original object:<pre>    for site in (site1, site2): 
        print(site)
    print(f'ID site1 : {id(site1)} != ID site2 : \
      {id(site2)}')</pre></li>
			</ol>
			<p>You will <a id="_idIndexMarker1209"/>find the program's full code in the <code>prototype.py</code> file. Here is a summary of what we do in the code:</p>
			<ol>
				<li value="1">We start by importing the <code>copy</code> module.</li>
				<li>We define the <code>Website</code> class, with its initialization method, <code>(__init__())</code>, and its string representation method <code>(__str__()</code>), as shown earlier.</li>
				<li>We define our <code>Prototype</code> class as shown earlier.</li>
				<li>Then, we have the <code>main()</code> function, where we do the following:<ul><li>We define the <code>keywords</code> list we need.</li><li>We create the instance of the <code>Website</code> class, called <code>site1</code> (we use the <code>keywords</code> list here).</li><li>We create the <code>Prototype</code> object and we use its <code>register()</code> method to register <code>site1</code> with its identifier (this helps us keep track of the cloned objects in a dictionary).</li><li>We clone the <code>site1</code> object to get <code>site2</code>.</li><li>We display the result (both <code>Website</code> objects)</li></ul></li>
			</ol>
			<p>Following is the sample output when I execute the <code>python prototype.py</code> command on my machine:</p>
			<pre>Website "ContentGardening"
author: Kamon Ayeva
category: Blog
description: Automation and data-driven apps
domain: contentgardening.com
keywords: ('python', 'data', 'apis', 'automation')
Website "ContentGardeningPlayground"
author: Kamon Ayeva
category: Membership site
creation_date: 2018-08-01
description: Experimentation for techniques featured on the 
blog
domain: play.contentgardening.com
keywords: ('python', 'data', 'apis', 'automation')
ID site1 : 140263689073376 != ID site2 : 140263689058816</pre>
			<p>Indeed, <code>Prototype</code> works as expected. We can see the information about the original <code>Website</code> object and <a id="_idIndexMarker1210"/>its clone. Looking at the output of the <code>id()</code> function, we can see that the two addresses are different.</p>
			<p>With this program, we mark the end of our discussion on the prototype pattern. In the next section, we will cover the singleton pattern.</p>
			<h1 id="_idParaDest-322"><a id="_idTextAnchor303"/>Implementing the singleton pattern</h1>
			<p>The singleton <a id="_idIndexMarker1211"/>pattern offers a way to implement a class from which you can only create one object, hence the name singleton. As you will understand with our exploration of this pattern, or while doing your own research, there have always <a id="_idIndexMarker1212"/>been discussions about this pattern, and some even consider it an <strong class="bold">anti-pattern</strong>.</p>
			<p>Besides that, what is interesting is that it is useful when we need to create one and only one object, for example, to store and maintain a global state for our program. In Python, this pattern can be implemented using some special built-in features.</p>
			<p>The singleton <a id="_idIndexMarker1213"/>pattern restricts the instantiation of a class to <em class="italic">one</em> object, which is useful when you need one object to coordinate actions for the system.</p>
			<p>The basic idea is that only one instance of a particular class is created for the needs of the program. To ensure that this works, we need mechanisms that prevent the instantiation of the class more than once and also prevent cloning.</p>
			<p>First, let's discuss some real-life examples of the singleton pattern.</p>
			<h2 id="_idParaDest-323"><a id="_idTextAnchor304"/>Real-world examples</h2>
			<p>We can think of a captain of a ship or a boat as a real-life example of the singleton pattern. On the ship, he is the one in charge. He is responsible for important decisions, and several <a id="_idIndexMarker1214"/>requests are directed to him because of this responsibility.</p>
			<p>In software, the Plone CMS has, at its core, an implementation of the singleton. There are actually several singleton objects available at the root <a id="_idIndexMarker1215"/>of a Plone site, called <code>singleton</code> class, and you can't create another instance of that <code>singleton</code> class in the context of the site. </p>
			<h2 id="_idParaDest-324"><a id="_idTextAnchor305"/>Use cases</h2>
			<p>As stated <a id="_idIndexMarker1220"/>previously, one use case of the singleton pattern is to create a single object that maintains the global state of your program. Other possible use cases are as follows:</p>
			<ul>
				<li>Controlling concurrent access to a shared resource; for example, an object class that manages the connection to a database</li>
				<li>A service or resource that is transversal in the sense that it can be accessed from different parts of the application or by different users and does its work; for example, the class at the core of the logging system or utility</li>
			</ul>
			<h2 id="_idParaDest-325"><a id="_idTextAnchor306"/>Implementation</h2>
			<p>Let's implement <a id="_idIndexMarker1221"/>a program to fetch content from <a id="_idIndexMarker1222"/>web pages, inspired by the tutorial from Michael Ford (<a href="https://docs.python.org/3/howto/urllib2.html">https://docs.python.org/3/howto/urllib2.html</a>). We have only taken the simple part since the focus is to illustrate our pattern more than it is to build a special web-scraping tool.</p>
			<p>We will use the <code>urllib</code> module to connect to web pages using their URLs; the core of the program would be the <code>URLFetcher</code> class, which takes care of doing the work via a <code>fetch()</code> method.</p>
			<p>We want to be able to track the list of web pages that were tracked, hence the use of the singleton pattern. We need a single object to maintain that global state:</p>
			<ol>
				<li value="1">First, our naive version, inspired by the tutorial but modified to help us track the list of URLs that were fetched, would be as follows:<pre>import urllib.parse
import urllib.request
class URLFetcher:
    def __init__(self):
        self.urls = []
    
    def fetch(self, url):
        req = urllib.request.Request(url)
        with urllib.request.urlopen(req) as response:
            if response.code == 200:
                the_page = response.read()
                print(the_page)
        
                urls = self.urls
                urls.append(url)
                self.urls = urls</pre></li>
				<li>As an <a id="_idIndexMarker1223"/>exercise, add the usual <code>if __name__ == '__main__'</code> block with a few lines of code to call the <code>.fetch()</code> method on an instance of <code>URLFetcher</code>.</li>
			</ol>
			<p>But then, does our class implement a singleton? Here is a clue. To create a singleton, we need to make sure you can only create one instance of it. So, to see whether our class implements a singleton, we could use a trick that consists of comparing two instances using the <code>is</code> operator.</p>
			<p>You may have guessed the second exercise. Put the following code in your <code>if __name__ == '__main__'</code> block instead of what you had previously:</p>
			<pre>f1 = URLFetcher()
f2 = URLFetcher()
print(f1 is f2)</pre>
			<p>As an alternative, use this concise, but still elegant, form:</p>
			<pre>print(URLFetcher() is URLFetcher())</pre>
			<p>With this change, when executing the program, you should get <code>False</code> as the output.</p>
			<ol>
				<li value="3">Okay! This means that the first try does not yet give us a singleton. Remember, we want to manage a global state, using one, and only one, instance of the class for the program. The current version of the class does not yet implement a singleton.</li>
			</ol>
			<p>After checking <a id="_idIndexMarker1224"/>the literature and the forums on the web, you will find that there are several techniques, each with pros and cons, and some are probably outdated.</p>
			<p>Since many <a id="_idIndexMarker1225"/>people use Python 3 nowadays, the recommended technique we will choose is the <strong class="bold">metaclass</strong> technique. We first implement a metaclass for the singleton. This class implements the singleton pattern as follows:</p>
			<pre>class SingletonType(type):
    _instances = {}
    def __call__(cls, *args, **kwargs):
        if cls not in cls._instances:
            cls._instances[cls] = super \
              (SingletonType,cls).__call__(*args, \
                 **kwargs)
        return cls._instances[cls]</pre>
			<ol>
				<li value="4">Now, we will rewrite our <code>URLFetcher</code> class to use that metaclass. We also add a <code>dump_url_registry()</code> method, which is useful for getting the current list of URLs tracked:<pre>class URLFetcher(metaclass=SingletonType):
    def fetch(self, url):
        req = urllib.request.Request(url)
        with urllib.request.urlopen(req) as response:
            if response.code == 200:
                the_page = response.read()
                print(the_page)
        
                urls = self.urls
                urls.append(url)
                self.urls = urls
    def dump_url_registry(self):
        return ', '.join(self.urls)
if __name__ == '__main__':
    print(URLFetcher() is URLFetcher())</pre></li>
			</ol>
			<p>This time, you get <code>True</code> by executing the program.</p>
			<ol>
				<li value="5">Let's complete <a id="_idIndexMarker1226"/>the program to do what we wanted, using a <code>main()</code> function that we will call as follows:<pre>def main():
    MY_URLS = ['http://google.com', 
               'http://python.org',
               'https://www.python.org/error',
               ]
    print(URLFetcher() is URLFetcher())
    fetcher = URLFetcher()
    for url in MY_URLS:
        try:
            fetcher.fetch(url)
        except Exception as e:
            print(e)
            
    print('-------')
    done_urls = fetcher.dump_url_registry()
    print(f'Done URLs: {done_urls}')</pre></li>
			</ol>
			<p>You will <a id="_idIndexMarker1227"/>find the program's full code in the <code>singleton.py</code> file. Here is a summary of what we do:</p>
			<ol>
				<li value="1">We start with our required module imports (<code>urllib.parse</code> and <code>urllib.request</code>).</li>
				<li>As shown earlier, we define the <code>SingletonType</code> class, with its special <code>__call__()</code> method.</li>
				<li>As shown earlier, we define <code>URLFetcher</code>, the class implementing the fetcher for the web pages, initializing it with the <code>urls</code> attribute. As discussed, we add its <code>fetch()</code> and <code>dump_url_registry()</code> methods.</li>
				<li>Then, we add our <code>main()</code> function.</li>
				<li>Lastly, we add Python's conventional snippet used to call the <code>main</code> function.</li>
			</ol>
			<p>The following is the output when executing the <code>python singleton.py</code> command:</p>
			<pre>[output truncated]
&lt;/script&gt;\n    &lt;script&gt;window.jQuery || 
document.write(\'&lt;script src="/static/js/libs/jquery-
1.8.2.min.js"&gt;&lt;\\/script&gt;\')&lt;/script&gt;\n    &lt;script 
src="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery
-ui.min.js"&gt;&lt;/script&gt;\n    &lt;script&gt;window.jQuery || 
document.write(\'&lt;script src="/static/js/libs/jquery-ui-
1.12.1.min.js"&gt;&lt;\\/script&gt;\')&lt;/script&gt;\n\n    &lt;script 
src="img/masonry.pkgd.min.js"&gt;&lt;/script&gt;\n    
&lt;script src="/static/js/libs/html-
includes.js"&gt;&lt;/script&gt;\n\n    &lt;script 
type="text/javascript" src="/static/js/main-
min.dd72c1659644.js" charset="utf-8"&gt;&lt;/script&gt;\n    \n\n    
&lt;!--[if lte IE 7]&gt;\n    &lt;script type="text/javascript" 
src="img/IE8-min.8af6e26c7a3b.js" 
charset="utf-8"&gt;&lt;/script&gt;\n    \n    \n    &lt;![endif]--
&gt;\n\n    
&lt;!--[if lte IE 8]&gt;\n    &lt;script type="text/javascript" 
src="/static/js/plugins/getComputedStyle-
min.d41d8cd98f00.js" charset="utf-8"&gt;&lt;/script&gt;\n    \n    
\n    &lt;![endif]--&gt;\n\n    \n\n    \n    
\n\n&lt;/body&gt;\n&lt;/html&gt;\n'
HTTP Error 404: Not Found
-------
Done URLs: http://google.com, http://python.org</pre>
			<p>We can see that we get the expected result: both the content of the pages that the program was able to connect to and the list of URLs the operation was successful for.</p>
			<p>We see <a id="_idIndexMarker1228"/>that the URL, <code>https://www.python.org/error</code>, does not come in the list returned by <code>fetcher.dump_url_registry()</code>; indeed, it is an erroneous URL and the <code>urlllib</code> request to it gets a <code>404</code> response code. </p>
			<p class="callout-heading">Note</p>
			<p class="callout">The link to the preceding URL is not supposed to work; that's exactly the point.</p>
			<h1 id="_idParaDest-326"><a id="_idTextAnchor307"/>Summary</h1>
			<p>In this chapter, we have seen how to use two other creational design patterns: the prototype and the singleton.</p>
			<p>A prototype is used to create exact copies of objects. As seen in the implementation example we discussed, using a prototype in Python is natural and based on built-in features, so it is not something even mentioned. The singleton pattern can be implemented by making the <code>singleton</code> class use a metaclass, its type, having previously defined said metaclass. As required, the metaclass's <code>__call__()</code> method holds the code that ensures that only one instance of the class can be created.</p>
			<p>Overall, these two design patterns help us implement the use cases that other creational patterns do not support; in effect, we have grown our design pattern toolbox to cover more use cases.</p>
			<p>The next chapter is about the adapter pattern, a structural design pattern that can be used to make two incompatible software interfaces compatible.</p>
			<h1 id="_idParaDest-327"><a id="_idTextAnchor308"/>Questions</h1>
			<ol>
				<li value="1">What are the high-level benefits of using the prototype pattern?</li>
				<li>How is the prototype pattern useful in the specific case of database management?</li>
				<li>What are the high-level benefits of using the singleton pattern?</li>
				<li>In the context of concurrency, in which situation should the singleton pattern be used?</li>
			</ol>
			<h1 id="_idParaDest-328"><a id="_idTextAnchor309"/>Further reading</h1>
			<p><em class="italic">Design Patterns</em> by Gamma Enrich, Helm Richard, Johnson Ralph, and Vlissides John available at  <a href="https://www.amazon.com/Design-Patterns-Object-Oriented-Addison-Wesley-Professional-ebook/dp/B000SEIBB8">https://www.amazon.com/Design-Patterns-Object-Oriented-Addison-Wesley-Professional-ebook/dp/B000SEIBB8</a></p>
		</div>
	</div>
</div>
</body></html>