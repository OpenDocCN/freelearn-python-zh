<html><head></head><body>
<div><div><h1 class="chapter-number" id="_idParaDest-89"><a id="_idTextAnchor013"/>9</h1>
<h1 id="_idParaDest-90">Creating an API in AWS</h1>
<p>In this chapter, we are going to learn how to create an <strong class="bold">application programming interface</strong> (<strong class="bold">API</strong>) via <strong class="bold">API Gateway</strong>. API Gateway is an AWS service that allows you to create and maintain an API. With the API Gateway service, you don’t need to provision a server; AWS manages it in the backend. In addition to that, API Gateway helps you to monitor incoming and outgoing requests. Another advantage of API Gateway is to scale up your API services when there is a huge request from users.</p>
<p>The chapter covers the following topics:</p>
<ul>
<li>What is API Gateway?</li>
<li>Creating an API using API Gateway</li>
</ul>
<h1 id="_idParaDest-91">What is API Gateway?</h1>
<p><strong class="bold">API Gateway</strong> is an AWS service that is used to<a id="_idIndexMarker296"/> create, maintain, and publish<a id="_idIndexMarker297"/> an API. API Gateway<a id="_idIndexMarker298"/> supports<a id="_idIndexMarker299"/> multiple API protocols, such as <strong class="bold">RESTful</strong> (also known as the REST API) and <strong class="bold">WebSocket</strong>.</p>
<p>API Gateway is a single point of entry for the backend services. As you can see in the following<a id="_idIndexMarker300"/> architecture, API Gateway gets a request from a client and integrates the incoming request with microservices, databases, AWS Lambda, or another AWS service:</p>
<div><div><img alt="" height="316" src="img/Figure_9.01_B19195.jpg" width="452"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.1 – Architecture of API Gateway</p>
<p>Now that we have a good idea of what API Gateway is, let’s have a look at its features.</p>
<p>Features of API Gateway</p>
<p>The features of API Gateway<a id="_idIndexMarker301"/> are as follows:</p>
<ul>
<li>It supports different protocols, such as RESTful and WebSocket.</li>
<li>You can monitor incoming and outgoing API requests, which enhances the visibility of the service.</li>
<li>You can easily create and maintain the API. It can be created either in AWS Management Console or the AWS CLI.</li>
<li>Security is important for cloud services, as well as the API. You can create a key to enable secure access to the API. In addition to that, you can add an SSL certificate to verify the request.</li>
<li>It has built-in integration with AWS services. When you implement an API, you can easily integrate it with AWS services.</li>
<li>It is a scalable service that adds more resources when you have more requests. For example, on Black Friday, there is more load on e-commerce websites. In these cases, API Gateway automatically<a id="_idIndexMarker302"/> scales your API requests. In this case, you can also define a <strong class="bold">Cross-Origin Resource Sharing</strong> (<strong class="bold">CORS</strong>) policy as a security feature that controls<a id="_idIndexMarker303"/> the HTTP request.</li>
</ul>
<p>In this section, we have looked at the basic features of API Gateway, and now we will start to implement sample API applications.</p>
<h1 id="_idParaDest-92">Creating an API using API Gateway</h1>
<p>We are going to create a simple API<a id="_idIndexMarker304"/> that accepts a request from a client. The API accepts two numbers, sums up two numbers in a Lambda function, and returns the calculated values. AWS Lambda is going to be implemented via Python. You can see the high-level flow in the following architecture:</p>
<div><div><img alt="" height="114" src="img/Figure_9.02_B19195.jpg" width="463"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.2 – Data flow</p>
<p>We are going to start with the Lambda function creation. After the Lambda function creation, API Gateway is going to be set up with Lambda integration.</p>
<p>Let’s create the Lambda function step by step:</p>
<ol>
<li>Open the console and navigate to the <strong class="bold">AWS </strong><strong class="bold">Lambda</strong> page:</li>
</ol>
<div><div><img alt="" height="447" src="img/Figure_9.03_B19195.jpg" width="954"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.3 – Lambda function</p>
<ol>
<li value="2">Create a new<a id="_idIndexMarker305"/> Lambda function. Let’s name it <code>SumUpLambda</code>:</li>
</ol>
<div><div><img alt="" height="636" src="img/Figure_9.04_B19195.jpg" width="609"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.4 – Creating a new Lambda function</p>
<ol>
<li value="3">Click <strong class="bold">Create function</strong> and wait<a id="_idIndexMarker306"/> a few seconds while the function is created:</li>
</ol>
<div><div><img alt="" height="406" src="img/Figure_9.05_B19195.jpg" width="790"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.5 – Clicking Create function</p>
<p>A few seconds later, you will see the Lambda function<a id="_idIndexMarker307"/> has been created with the template code:</p>
<div><div><img alt="" height="608" src="img/Figure_9.06_B19195.jpg" width="724"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.6 – Lambda template</p>
<p>Let’s create a Lambda function<a id="_idIndexMarker308"/> that sums up two values:</p>
<pre class="source-code">
import json
def lambda_handler(event, context):
    number1 = event['Number1']
    number2 = event['Number2']
    sum = number1 + number2
    return {
        'statusCode': 200,
        'Sum': sum
    }</pre>
<p>This code snippet takes two numbers<a id="_idIndexMarker309"/> as parameters, such as <code>Number1</code> and <code>Number2</code>. The Lambda function calculates the sum of two values and returns a status code and the value of the sum. When we call this function from the API, it returns the sum value as well as <code>statusCode</code>.</p>
<p>Let’s paste this code block into the Lambda function:</p>
<div><div><img alt="" height="401" src="img/Figure_9.07_B19195.jpg" width="608"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.7 – Actual Lambda code</p>
<p>Now, let’s follow these steps:</p>
<ol>
<li>Click <strong class="bold">Test</strong>. A new panel opens in which Lambda asks for a test parameter:</li>
</ol>
<div><div><img alt="" height="665" src="img/Figure_9.08_B19195.jpg" width="818"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.8 – Test event</p>
<ol>
<li value="2">As can be seen in the preceding<a id="_idIndexMarker310"/> figure, you can paste the following JSON to see whether the Lambda function is running properly before integrating with the API:<pre class="console">
{
  "Number1": 10,
  "Number2": 15
}</pre></li>
<li>Click <strong class="bold">Save</strong>, which is under the <strong class="bold">Event </strong><strong class="bold">JSON</strong> panel:</li>
</ol>
<div><div><img alt="" height="206" src="img/Figure_9.09_B19195.jpg" width="424"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.9 – Clicking on the Save button</p>
<ol>
<li value="4">Deploy the changes<a id="_idIndexMarker311"/> by clicking <strong class="bold">Deploy</strong>:</li>
</ol>
<div><div><img alt="" height="301" src="img/Figure_9.10_B19195.jpg" width="754"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.10 – Deploying Lambda</p>
<p>After the Lambda deployment, we are going to integrate API Gateway with AWS Lambda. Lambda<a id="_idIndexMarker312"/> will be used as the backend for API Gateway.</p>
<p>Let’s create an API step by step:</p>
<ol>
<li>Open the console and search for <code>api gateway</code>:</li>
</ol>
<div><div><img alt="" height="222" src="img/Figure_9.11_B19195.jpg" width="883"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.11 – The console</p>
<ol>
<li value="2">On the main screen, select <strong class="bold">REST API</strong>, and click <strong class="bold">Build</strong>:</li>
</ol>
<div><div><img alt="" height="169" src="img/Figure_9.12_B19195.jpg" width="536"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.12 – REST API</p>
<ol>
<li value="3">You will now see a new screen to be filled out. We will select <strong class="bold">New API</strong> in the <strong class="bold">Create new API</strong> section. Other options in this section allow you to create an example API or import a predefined API. In the <strong class="bold">Settings</strong> section, we will add the <strong class="bold">API name</strong> and <strong class="bold">Description</strong> details. In the <strong class="bold">Endpoint Type</strong> drop-down list, we will select <strong class="bold">Regional</strong>, which is used to create an API that is accessible from the same region:</li>
</ol>
<div><div><img alt="" height="353" src="img/Figure_9.13_B19195.jpg" width="615"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.13 – Form for API creation</p>
<ol>
<li value="4">Once you click <strong class="bold">Create API</strong> (as depicted in the preceding figure), you will be taken to a new page<a id="_idIndexMarker313"/> that allows you to define the details for a custom SumUp API:</li>
</ol>
<div><div><img alt="" height="761" src="img/Figure_9.14_B19195.jpg" width="732"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.14 – API form</p>
<ol>
<li value="5">Now, we are going<a id="_idIndexMarker314"/> to define the API details. Click on the <strong class="bold">Actions</strong> dropdown and select <strong class="bold">Create Method</strong>:</li>
</ol>
<div><div><img alt="" height="329" src="img/Figure_9.15_B19195.jpg" width="381"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.15 – Create Method</p>
<ol>
<li value="6">When we create<a id="_idIndexMarker315"/> a method, we select <strong class="bold">POST</strong> as the API type:</li>
</ol>
<div><div><img alt="" height="293" src="img/Figure_9.16_B19195.jpg" width="417"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.16 – Selecting POST</p>
<p>While you implement<a id="_idIndexMarker316"/> an API, you can select API types. The following are the most used API types:</p>
<ul>
<li><strong class="bold">GET</strong> is used to retrieve data from a source.</li>
<li><code>SumUp</code> from Lambda.</li>
<li><strong class="bold">PUT</strong> is used to update the data in a source.</li>
<li><strong class="bold">DELETE</strong> is used to delete the data in a source.</li>
</ul>
<ol>
<li value="7">When you select <strong class="bold">POST</strong>, you need to choose the integration type. For this example, we are going to select the <strong class="bold">Lambda Function</strong> integration type:</li>
</ol>
<div><div><img alt="" height="444" src="img/Figure_9.17_B19195.jpg" width="653"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.17 – Setting up the integration type</p>
<ol>
<li value="8">Select the <strong class="bold">SumUpLambda</strong> function that is implemented, and click <strong class="bold">Save</strong>, which is not depicted<a id="_idIndexMarker317"/> in the following figure but is situated at the bottom of the page:</li>
</ol>
<div><div><img alt="" height="411" src="img/Figure_9.18_B19195.jpg" width="851"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.18 – Selecting Lambda</p>
<ol>
<li value="9">When you click <strong class="bold">Save</strong>, it asks for confirmation to allow the required permissions. Click <strong class="bold">OK</strong> and it will create the permissions:</li>
</ol>
<div><div><img alt="" height="445" src="img/Figure_9.19_B19195.jpg" width="1102"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.19 – Permissions</p>
<p>After setting<a id="_idIndexMarker318"/> the permissions, you can see the data flow for the API:</p>
<div><div><img alt="" height="358" src="img/Figure_9.20_B19195.jpg" width="846"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.20 – The API flow</p>
<p>Now, we need to add a CORS policy. CORS is a security policy that allows a particular origin (domain or port) to browse your resource. Let’s enable a CORS policy:</p>
<ol>
<li>Click the <strong class="bold">Actions</strong> drop-down button to list the available actions, and then click <strong class="bold">Enable CORS</strong>:</li>
</ol>
<div><div><img alt="" height="314" src="img/Figure_9.21_B19195.jpg" width="691"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.21 – List of actions</p>
<ol>
<li value="2">Fill out the form and click <strong class="bold">Enable CORS and replace existing CORS headers</strong>. You can retain<a id="_idIndexMarker319"/> the form details as is. The form defines the following:<ol><li>Which methods are allowed access to the API by selecting <strong class="bold">Methods</strong></li><li>Which request header is required via <strong class="bold">Access-Control-Allow-Headers</strong></li><li>Which origins are able to call the API via <strong class="bold">Access-Control-Allow-Origin</strong></li><li>Gateway response<a id="_idIndexMarker320"/> types by selecting the <strong class="bold">DEFAULT 4XX</strong> or <strong class="bold">DEFAULT 5XX</strong> port. You can see the list here: <a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/supported-gateway-response-types.xhtml">https://docs.aws.amazon.com/apigateway/latest/developerguide/supported-gateway-response-types.xhtml</a>.</li></ol></li>
</ol>
<div><div><img alt="" height="307" src="img/Figure_9.22_B19195.jpg" width="912"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.22 – Enable CORS</p>
<p>Congrats! You have successfully created the Lambda function<a id="_idIndexMarker321"/> and an API gateway. The next step is to test the API.</p>
<p>Let’s test the SumUp API:</p>
<ol>
<li>Click on the <strong class="bold">Test</strong> button in the flow:</li>
</ol>
<div><div><img alt="" height="753" src="img/Figure_9.23_B19195.jpg" width="647"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.23 – Testing the API</p>
<ol>
<li value="2">Enter the following code in the <strong class="bold">Request Body</strong> field to add a parameter for Lambda:<pre class="console">
{
  "Number1": 10,
  "Number2": 15
}</pre></li>
<li>Click <strong class="bold">Test</strong> and see<a id="_idIndexMarker322"/> the results:</li>
</ol>
<div><div><img alt="" height="471" src="img/Figure_9.24_B19195.jpg" width="593"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.24 – Adding a parameter</p>
<p>Here<a id="_idIndexMarker323"/> are the results:</p>
<div><div><img alt="" height="479" src="img/Figure_9.25_B19195.jpg" width="785"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 9.25 – The result of the API response</p>
<p>When you check the logs, you can see the results of the API response. As you can see, the sum of the values is <code>25</code>.</p>
<p>In this topic, we implemented<a id="_idIndexMarker324"/> an API that used Python in the Lambda code. As you saw, creating an API is an easy solution in AWS. This way, you can focus on the backend implementation instead of focusing on the infrastructure.</p>
<h1 id="_idParaDest-93">Summary</h1>
<p>In this chapter, we learned how to use the AWS API Gateway service and how to create an API gateway that has a backend service with Python Lambda. API Gateway is useful when you need to implement an API service with backend support via Python. It comes with scalability, logging, and monitoring advantages. In the next chapter, we will take a look at the basics of DynamoDB and NoSQL.</p>
</div>
</div></body></html>