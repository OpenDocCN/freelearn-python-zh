<html><head></head><body>
<section data-number="0.14" id="chapter-11-inputoutput-physical-format-and-logical-layout">
<h2 class="likechapterhead" data-number="0.14"><span><span class="kobospan" id="kobo.1.1">11</span></span><br class="tipbox1"/> <span id="x1-61500011"/><span class="kobospan" id="kobo.2.1">Input/Output, Physical Format, and Logical Layout</span></h2>
<p class="normal"><span class="kobospan" id="kobo.3.1">Computing often works with persistent data. </span><span class="kobospan" id="kobo.3.2">There may be source data to be analyzed, or output to be created using Python input and output operations. </span><span class="kobospan" id="kobo.3.3">The map of the dungeon that’s explored in a game is data that will be input to the game application. </span><span class="kobospan" id="kobo.3.4">Images, sounds, and movies are data output by some applications and input by other applications. </span><span class="kobospan" id="kobo.3.5">Even a request through a network will involve input and output operations. </span><span class="kobospan" id="kobo.3.6">The common aspect to all of these is the concept of a file of data. </span><span class="kobospan" id="kobo.3.7">The term </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.4.1">file </span></span><span class="kobospan" id="kobo.5.1">is overloaded</span><span id="dx1-615001"/><span class="kobospan" id="kobo.6.1"> with many meanings:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.7.1">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.8.1">operating system </span></span><span class="kobospan" id="kobo.9.1">(</span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.10.1">OS</span></span><span class="kobospan" id="kobo.11.1">) uses a file as a way</span><span id="dx1-615002"/><span class="kobospan" id="kobo.12.1"> to organize bytes of data on a device. </span><span class="kobospan" id="kobo.12.2">It’s the responsibility of application software to make sense of the bytes. </span><span class="kobospan" id="kobo.12.3">Two common kinds of devices offer variations in terms of the features of OS files:</span></p>
<ul class="calibre25">
<li class="calibre12"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.13.1">Block devices </span></span><span class="kobospan" id="kobo.14.1">such as disks or </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.15.1">solid-state drives </span></span><span class="kobospan" id="kobo.16.1">(</span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.17.1">SSDs</span></span><span class="kobospan" id="kobo.18.1">): A file on this kind</span><span id="dx1-615003"/><span class="kobospan" id="kobo.19.1"> of device can seek</span><span id="dx1-615004"/><span class="kobospan" id="kobo.20.1"> any specific byte, making them particularly good for databases, where any row can be processed at any time.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.21.1">Character devices </span></span><span class="kobospan" id="kobo.22.1">such as a network</span><span id="dx1-615005"/><span class="kobospan" id="kobo.23.1"> connection, a keyboard, or a GPS antenna. </span><span class="kobospan" id="kobo.23.2">A file on this kind of device is viewed as a stream of individual bytes in transit. </span><span class="kobospan" id="kobo.23.3">There’s no way to seek forward or backward; the bytes must be captured in a buffer and processed as they arrive.</span></p></li>
</ul></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.24.1">The word </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.25.1">file </span></span><span class="kobospan" id="kobo.26.1">also defines</span><span id="dx1-615006"/><span class="kobospan" id="kobo.27.1"> a data structure used by the Python runtime. </span><span class="kobospan" id="kobo.27.2">A uniform Python file abstraction wraps the various OS file implementations. </span><span class="kobospan" id="kobo.27.3">When we open a Python file, there is a binding between the Python abstraction, an OS implementation, and the underlying collection of bytes on a block device or stream of bytes of a character device.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.28.1">Python gives us two common modes for working with a file’s content:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.29.1">In ”b” (</span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.30.1">binary</span></span><span class="kobospan" id="kobo.31.1">) mode, our application sees the bytes, without</span><span id="dx1-615007"/><span class="kobospan" id="kobo.32.1"> further interpretation. </span><span class="kobospan" id="kobo.32.2">This can be helpful for processing media data like images, audio, and movies, which have complex encodings. </span><span class="kobospan" id="kobo.32.3">We’ll often import libraries like </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.33.1">pillow</span></span></span></span><span class="kobospan" id="kobo.34.1"> to handle the details of image file encoding into bytes and decoding from bytes.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.35.1">In ”t” (</span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.36.1">text</span></span><span class="kobospan" id="kobo.37.1">) mode, the bytes of the file are encodings</span><span id="dx1-615008"/><span class="kobospan" id="kobo.38.1"> of string values. </span><span class="kobospan" id="kobo.38.2">Python strings are made of Unicode characters, and there are a variety of schemes for decoding bytes into text and encoding text into bytes. </span><span class="kobospan" id="kobo.38.3">Generally, the OS has a preferred encoding and Python respects this. </span><span class="kobospan" id="kobo.38.4">The UTF-8 encoding is popular. </span><span class="kobospan" id="kobo.38.5">Pragmatically, a file can have any of the available Unicode encodings, and it may not be obvious which encoding was used to create a file.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.39.1">Additionally, Python modules like </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.40.1">shelve</span></span></span></span><span class="kobospan" id="kobo.41.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.42.1">pickle</span></span></span></span><span class="kobospan" id="kobo.43.1"> have unique ways of representing more complex Python objects than simple strings. </span><span class="kobospan" id="kobo.43.2">There are a number of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.44.1">pickle</span></span></span></span><span class="kobospan" id="kobo.45.1"> protocols available; all of them are based on binary mode file operations.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.46.1">Throughout this chapter, we’ll talk about how Python objects are </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.47.1">serialized</span></span><span class="kobospan" id="kobo.48.1">. </span><span class="kobospan" id="kobo.48.2">Serialization creates a representation</span><span id="dx1-615009"/><span class="kobospan" id="kobo.49.1"> of the Python object’s state as a series of bytes. </span><span class="kobospan" id="kobo.49.2">Deserialization</span><span id="dx1-615010"/><span class="kobospan" id="kobo.50.1"> is the reverse process: it recovers a Python object’s state from the bytes of a file. </span><span class="kobospan" id="kobo.50.2">Saving and transferring a representation of the object state is the foundational concept behind REST web services.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.51.1">When we process data from files, we have two common concerns:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.52.1">The physical format of the data</span></span><span class="kobospan" id="kobo.53.1">: We need to know how the bytes</span><span id="dx1-615011"/><span class="kobospan" id="kobo.54.1"> on the file are interpreted to reconstruct a Python object. </span><span class="kobospan" id="kobo.54.2">The bytes could represent a JPEG-encoded image or an MPEG-encoded movie. </span><span class="kobospan" id="kobo.54.3">One very common example is the bytes of the file representing Unicode text, organized into lines. </span><span class="kobospan" id="kobo.54.4">Generally, physical format concerns are handled by Python libraries like </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.55.1">csv</span></span></span></span><span class="kobospan" id="kobo.56.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.57.1">json</span></span></span></span><span class="kobospan" id="kobo.58.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.59.1">pickle</span></span></span></span><span class="kobospan" id="kobo.60.1">, among many others.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.61.1">The logical layout of the data</span></span><span class="kobospan" id="kobo.62.1">: A given data collection may have flexible positions for storing data items. </span><span class="kobospan" id="kobo.62.2">The arrangement of CSV columns or JSON fields can vary. </span><span class="kobospan" id="kobo.62.3">In cases where the data includes labels, the logical layout is clear. </span><span class="kobospan" id="kobo.62.4">Without labels, the layout is positional, and some additional schema information is required to identify which data items occupy the various positions.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.63.1">Both the physical format decoding and logical layout schema are essential to interpreting the data on a file. </span><span class="kobospan" id="kobo.63.2">We’ll look at a number of recipes for working with different physical formats. </span><span class="kobospan" id="kobo.63.3">We’ll also look at ways to divorce our program from some aspects of the logical layout.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.64.1">In this chapter, we’ll look at the following recipes:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><a href="ch015_split_000.xhtml#x1-6160001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.65.1">Using pathlib to work with filenames</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch015_split_000.xhtml#x1-6260002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.66.1">Replacing a file while preserving the previous version</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch015_split_000.xhtml#x1-6320003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.67.1">Reading delimited files with the CSV module</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch015_split_000.xhtml#x1-6380004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.68.1">Using dataclasses to simplify working with CSV files</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch015_split_001.xhtml#x1-6440005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.69.1">Reading complex formats using regular expressions</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch015_split_001.xhtml#x1-6520006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.70.1">Reading JSON and YAML documents</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch015_split_001.xhtml#x1-6600007" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.71.1">Reading XML documents</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch015_split_001.xhtml#x1-6660008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.72.1">Reading HTML documents</span></span></a></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.73.1">In order to work with files, we’ll start with objects that help control the OS filesystem. </span><span class="kobospan" id="kobo.73.2">The common features of the directory structure of files and devices are described by Python’s </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.74.1">pathlib</span></span></span></span><span class="kobospan" id="kobo.75.1"> module. </span><span class="kobospan" id="kobo.75.2">This module has consistent behavior across a number of operating systems, allowing a Python program to work similarly on Linux, macOS, and Windows. </span><span id="x1-615012r1305"/></p>
<section data-number="0.14.1" id="using-pathlib-to-work-with-filenames">
<h1 class="unnumbered" data-number="0.14.1"><span><span class="kobospan" id="kobo.76.1">11.1 </span></span> <span id="x1-6160001"/><span class="kobospan" id="kobo.77.1">Using pathlib to work with filenames</span></h1>
<p class="normal"><span class="kobospan" id="kobo.78.1">Most operating systems use a hierarchical</span><span id="dx1-616001"/><span class="kobospan" id="kobo.79.1"> tree of directories</span><span id="dx1-616002"/><span class="kobospan" id="kobo.80.1"> that contain files. </span><span class="kobospan" id="kobo.80.2">The path from the root directory to a specific file is often shown as a string. </span><span class="kobospan" id="kobo.80.3">Here’s an example path:</span></p>
<pre class="programlisting" id="listing-56"><code class="calibre13"><span class="kobospan" id="kobo.81.1">/Users/slott/Documents/Writing/Python Cookbook/src/ch11/recipe_01.py</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.82.1">This full path name lists seven named directories contained in the (unnamed) root directory. </span><span class="kobospan" id="kobo.82.2">The final name has a stem of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.83.1">recipe_01</span></span></span></span><span class="kobospan" id="kobo.84.1"> and a suffix of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.85.1">.py</span></span></span></span><span class="kobospan" id="kobo.86.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.87.1">We can represent this as a string, and parse the string to locate directory names, file stems, and suffix strings. </span><span class="kobospan" id="kobo.87.2">Doing this isn’t portable between the macOS and Linux operating systems, which use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.88.1">"/"</span></span></span></span><span class="kobospan" id="kobo.89.1"> for a separator, and Windows, which uses </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.90.1">"\"</span></span></span></span><span class="kobospan" id="kobo.91.1"> for a separator. </span><span class="kobospan" id="kobo.91.2">Further, Windows files may also have device names as a prefix to the path.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.92.1">Dealing with edge cases like </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.93.1">"/"</span></span></span></span><span class="kobospan" id="kobo.94.1"> in a filename or </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.95.1">"."</span></span></span></span><span class="kobospan" id="kobo.96.1"> in a directory name can make string processing needlessly difficult. </span><span class="kobospan" id="kobo.96.2">We can simplify parsing and many filesystem operations by using </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.97.1">pathlib.Path</span></span></span></span><span class="kobospan" id="kobo.98.1"> objects instead of strings. </span><span id="x1-616004r1303"/></p>
<section data-number="0.14.1.1" id="getting-ready-85">
<h2 class="likechapterhead" data-number="0.14.1.1"><span><span class="kobospan" id="kobo.99.1">11.1.1 </span></span> <span id="x1-6170001"/><span class="kobospan" id="kobo.100.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.101.1">It’s important to separate three concepts:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.102.1">A path that identifies a file, including the name</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.103.1">Metadata for a file – like creation timestamps and ownership – kept in the directory tree</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.104.1">The contents of the file</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.105.1">The contents of the files are independent of the directory information. </span><span class="kobospan" id="kobo.105.2">It’s common for multiple directory entries to be linked to the same content. </span><span class="kobospan" id="kobo.105.3">This can be done with </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.106.1">hard </span></span><span class="kobospan" id="kobo.107.1">links, where the directory information is shared among multiple paths, and </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.108.1">soft </span></span><span class="kobospan" id="kobo.109.1">links, where a special kind of file contains a reference to another file.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.110.1">Often, a filename has a suffix (or extension) used as a hint as to what the physical format is. </span><span class="kobospan" id="kobo.110.2">A filename ending in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.111.1">.csv</span></span></span></span><span class="kobospan" id="kobo.112.1"> is likely a text file that can be interpreted as rows and columns of data. </span><span class="kobospan" id="kobo.112.2">This binding between name and physical format is not absolute. </span><span class="kobospan" id="kobo.112.3">File suffixes are only a hint and can be wrong.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.113.1">In Python, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.114.1">pathlib</span></span></span></span><span class="kobospan" id="kobo.115.1"> module handles all path-related processing. </span><span class="kobospan" id="kobo.115.2">The module makes several distinctions among paths:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.116.1">Pure paths that may or may not refer</span><span id="dx1-617001"/><span class="kobospan" id="kobo.117.1"> to an actual file</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.118.1">Concrete paths that are</span><span id="dx1-617002"/><span class="kobospan" id="kobo.119.1"> resolved; these refer to an actual file</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.120.1">This distinction allows us to create</span><span id="dx1-617003"/><span class="kobospan" id="kobo.121.1"> pure paths for files</span><span id="dx1-617004"/><span class="kobospan" id="kobo.122.1"> that our application will possibly create or refer to. </span><span class="kobospan" id="kobo.122.2">We can also create concrete paths for those files that actually exist on the OS. </span><span class="kobospan" id="kobo.122.3">An application often resolves a pure path to a concrete path.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.123.1">While the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.124.1">pathlib</span></span></span></span><span class="kobospan" id="kobo.125.1"> module can make a distinction between Linux path objects and Windows path objects, this distinction is rarely needed. </span><span class="kobospan" id="kobo.125.2">An important reason for using </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.126.1">pathlib</span></span></span></span><span class="kobospan" id="kobo.127.1"> is because we want processing that is isolated from the details of the underlying OS.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.128.1">All of the mini recipes in this section will leverage the following:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.129.1">&gt;&gt;&gt; from pathlib import Path</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.130.1">We’ll also presume the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.131.1">argparse</span></span></span></span><span class="kobospan" id="kobo.132.1"> module is used to gather the file or directory names. </span><span class="kobospan" id="kobo.132.2">For more information on argparse, see the </span><a href="ch010.xhtml#x1-3490004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.133.1">Using argparse to get</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.134.1">command-line input</span></span></a><span class="kobospan" id="kobo.135.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.136.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.137.1"> </span></span><a href="ch010.xhtml#x1-3300006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.138.1">6</span></span></a><span class="kobospan" id="kobo.139.1">. </span><span class="kobospan" id="kobo.139.2">We’ll use an </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.140.1">options</span></span></span></span><span class="kobospan" id="kobo.141.1"> variable as a namespace that contains the input filename or directory name that the recipe works with. </span><span class="kobospan" id="kobo.141.2">As an example, we’ll use the following </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.142.1">Namespace</span></span></span></span><span class="kobospan" id="kobo.143.1"> object:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.144.1">&gt;&gt;&gt; from argparse import Namespace 
 
&gt;&gt;&gt; options = Namespace( 
 
... </span><span class="kobospan" id="kobo.144.2">    input=’/path/to/some/file.csv’, 
 
... </span><span class="kobospan" id="kobo.144.3">    file1=’data/ch11_file1.yaml’, 
 
... </span><span class="kobospan" id="kobo.144.4">    file2=’data/ch11_file2.yaml’, 
 
... </span><span class="kobospan" id="kobo.144.5">)
                                                                     

                                                                     </span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.145.1">Frequently, we’ll define </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.146.1">argparse</span></span></span></span><span class="kobospan" id="kobo.147.1"> options to use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.148.1">type=Path</span></span></span></span><span class="kobospan" id="kobo.149.1"> so that the argument parsing creates </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.150.1">Path</span></span></span></span><span class="kobospan" id="kobo.151.1"> objects for us. </span><span class="kobospan" id="kobo.151.2">For the purposes of showing how </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.152.1">Path</span></span></span></span><span class="kobospan" id="kobo.153.1"> objects work, the path information is provided as string values. </span><span id="x1-617014r1309"/></p>
</section>
<section data-number="0.14.1.2" id="how-to-do-it...-86">
<h2 class="likechapterhead" data-number="0.14.1.2"><span><span class="kobospan" id="kobo.154.1">11.1.2 </span></span> <span id="x1-6180002"/><span class="kobospan" id="kobo.155.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.156.1">We’ll show a number of common pathname</span><span id="dx1-618001"/><span class="kobospan" id="kobo.157.1"> manipulations in the following</span><span id="dx1-618002"/><span class="kobospan" id="kobo.158.1"> mini-recipes:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><a href="ch015_split_000.xhtml#x1-6190002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.159.1">Making the output filename by changing the input filename’s suffix</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch015_split_000.xhtml#x1-6200002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.160.1">Making a number of sibling output files with distinct names</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch015_split_000.xhtml#x1-6210002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.161.1">Comparing file dates to see which is newer</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch015_split_000.xhtml#x1-6220002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.162.1">Finding all files that match a given pattern</span></span></a></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.163.1">The first two reflect techniques for working with the path of directories to a file; using a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.164.1">Path</span></span></span></span><span class="kobospan" id="kobo.165.1"> object is much easier than doing sophisticated string manipulation. </span><span class="kobospan" id="kobo.165.2">The last two gather information about concrete paths and the related files on a computer.</span></p>
<section data-number="0.14.1.2.1" id="making-the-output-filename-by-changing-the-input-filenames-suffix">
<h3 class="likesubsubsectionhead" data-number="0.14.1.2.1"><span id="x1-6190002"/><span class="kobospan" id="kobo.166.1">Making the output filename by changing the input filename’s suffix</span></h3>
<p class="normal"><span class="kobospan" id="kobo.167.1">Perform the following steps</span><span id="dx1-619001"/><span class="kobospan" id="kobo.168.1"> to create the output</span><span id="dx1-619002"/><span class="kobospan" id="kobo.169.1"> filename from an input filename by changing the input name’s suffix:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-619004x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.170.1">Create a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.171.1">Path</span></span></span></span><span class="kobospan" id="kobo.172.1"> object from the input filename string:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.173.1">&gt;&gt;&gt; input_path = Path(options.input) 
 
&gt;&gt;&gt; input_path 
 
PosixPath(’/path/to/some/file.csv’)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.174.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.175.1">PosixPath</span></span></span></span><span class="kobospan" id="kobo.176.1"> class is displayed because the author is using macOS. </span><span class="kobospan" id="kobo.176.2">On a Windows machine, the class would be </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.177.1">WindowsPath</span></span></span></span><span class="kobospan" id="kobo.178.1">.</span></p>
</div></li>
<li class="calibre7"><div id="x1-619010x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.179.1">Create the output </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.180.1">Path</span></span></span></span><span class="kobospan" id="kobo.181.1"> object using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.182.1">with_suffix()</span></span></span></span><span class="kobospan" id="kobo.183.1"> method:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.184.1">&gt;&gt;&gt; output_path = input_path.with_suffix(’.out’) 
 
&gt;&gt;&gt; output_path 
 
PosixPath(’/path/to/some/file.out’)</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.185.1">All of the filename</span><span id="dx1-619015"/><span class="kobospan" id="kobo.186.1"> parsing is handled</span><span id="dx1-619016"/><span class="kobospan" id="kobo.187.1"> seamlessly by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.188.1">Path</span></span></span></span><span class="kobospan" id="kobo.189.1"> class. </span><span class="kobospan" id="kobo.189.2">This doesn’t create</span><span id="dx1-619017"/><span class="kobospan" id="kobo.190.1"> the concrete output</span><span id="dx1-619018"/><span class="kobospan" id="kobo.191.1"> file; it merely creates a new </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.192.1">Path</span></span></span></span><span class="kobospan" id="kobo.193.1"> for it.</span></p>
</section>
<section data-number="0.14.1.2.2" id="making-a-number-of-sibling-output-files-with-distinct-names">
<h3 class="likesubsubsectionhead" data-number="0.14.1.2.2"><span id="x1-6200002"/><span class="kobospan" id="kobo.194.1">Making a number of sibling output files with distinct names</span></h3>
<p class="normal"><span class="kobospan" id="kobo.195.1">Perform the following steps to make a number</span><span id="dx1-620001"/><span class="kobospan" id="kobo.196.1"> of sibling output files with distinct names:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-620003x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.197.1">Create a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.198.1">Path</span></span></span></span><span class="kobospan" id="kobo.199.1"> object from the input filename string:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.200.1">&gt;&gt;&gt; input_path = Path(options.input)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-620007x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.201.1">Extract the parent directory and the stem from the filename. </span><span class="kobospan" id="kobo.201.2">The stem is the name without the suffix:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.202.1">&gt;&gt;&gt; input_directory = input_path.parent 
 
&gt;&gt;&gt; input_stem = input_path.stem</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-620012x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.203.1">Build the desired output name. </span><span class="kobospan" id="kobo.203.2">For this example, we’ll append </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.204.1">_pass</span></span></span></span><span class="kobospan" id="kobo.205.1"> to the stem and build the complete </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.206.1">Path</span></span></span></span><span class="kobospan" id="kobo.207.1"> object:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.208.1">&gt;&gt;&gt; output_stem_pass = f"{input_stem}_pass" 
 
&gt;&gt;&gt; output_stem_pass 
 
’file_pass’</span></code></pre>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.209.1">&gt;&gt;&gt; output_path = ( 
 
... </span><span class="kobospan" id="kobo.209.2">    input_directory / output_stem_pass 
 
... </span><span class="kobospan" id="kobo.209.3">).with_suffix(’.csv’) 
 
&gt;&gt;&gt; output_path 
 
PosixPath(’/path/to/some/file_pass.csv’)</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.210.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.211.1">/</span></span></span></span><span class="kobospan" id="kobo.212.1"> operator assembles a new </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.213.1">Path</span></span></span></span><span class="kobospan" id="kobo.214.1"> from </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.215.1">Path</span></span></span></span><span class="kobospan" id="kobo.216.1"> components. </span><span class="kobospan" id="kobo.216.2">We need to put the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.217.1">/</span></span></span></span><span class="kobospan" id="kobo.218.1"> operation in parentheses to be sure that it’s performed first, to create a new </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.219.1">Path</span></span></span></span><span class="kobospan" id="kobo.220.1"> object before changing</span><span id="dx1-620023"/><span class="kobospan" id="kobo.221.1"> the suffix.</span></p>
</section>
<section data-number="0.14.1.2.3" id="comparing-file-dates-to-see-which-is-newer">
<h3 class="likesubsubsectionhead" data-number="0.14.1.2.3"><span id="x1-6210002"/><span class="kobospan" id="kobo.222.1">Comparing file dates to see which is newer</span></h3>
<p class="normal"><span class="kobospan" id="kobo.223.1">The following are the steps to see newer file</span><span id="dx1-621001"/><span class="kobospan" id="kobo.224.1"> dates by comparing them:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-621003x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.225.1">Create the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.226.1">Path</span></span></span></span><span class="kobospan" id="kobo.227.1"> objects from the input filename strings. </span><span class="kobospan" id="kobo.227.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.228.1">Path</span></span></span></span><span class="kobospan" id="kobo.229.1"> class will properly parse the string to determine the elements of the path:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.230.1">&gt;&gt;&gt; file1_path = Path(options.file1) 
 
&gt;&gt;&gt; file2_path = Path(options.file2)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.231.1">When exploring this example, be sure the names in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.232.1">options</span></span></span></span><span class="kobospan" id="kobo.233.1"> object are actual files.</span></p>
</div></li>
<li class="calibre7"><div id="x1-621008x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.234.1">Use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.235.1">stat()</span></span></span></span><span class="kobospan" id="kobo.236.1"> method of each </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.237.1">Path</span></span></span></span><span class="kobospan" id="kobo.238.1"> object to get timestamps for the file. </span><span class="kobospan" id="kobo.238.2">Within the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.239.1">stat</span></span></span></span><span class="kobospan" id="kobo.240.1"> object, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.241.1">st_mtime</span></span></span></span><span class="kobospan" id="kobo.242.1">— attribute provides the most recent modification time for the file:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.243.1">&gt;&gt;&gt; file1_path.stat().st_mtime 
 
1572806032.0 
 
&gt;&gt;&gt; file2_path.stat().st_mtime 
 
1572806131.0</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.244.1">The values are timestamps measured</span><span id="dx1-621014"/><span class="kobospan" id="kobo.245.1"> in seconds. </span><span class="kobospan" id="kobo.245.2">Your values</span><span id="dx1-621015"/><span class="kobospan" id="kobo.246.1"> will depend on the files on your system. </span><span class="kobospan" id="kobo.246.2">If we want a timestamp that seems sensible to most people, we can use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.247.1">datetime</span></span></span></span><span class="kobospan" id="kobo.248.1"> module to create a more useful object from this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.249.1">&gt;&gt;&gt; import datetime 
 
&gt;&gt;&gt; mtime_1 = file1_path.stat().st_mtime 
 
&gt;&gt;&gt; datetime.datetime.fromtimestamp(mtime_1) 
 
datetime.datetime(2019, 11, 3, 13, 33, 52)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.250.1">We can use any of a number of methods to format the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.251.1">datetime</span></span></span></span><span class="kobospan" id="kobo.252.1"> object.</span></p>
</section>
<section data-number="0.14.1.2.4" id="finding-all-files-that-match-a-given-pattern">
<h3 class="likesubsubsectionhead" data-number="0.14.1.2.4"><span id="x1-6220002"/><span class="kobospan" id="kobo.253.1">Finding all files that match a given pattern</span></h3>
<p class="normal"><span class="kobospan" id="kobo.254.1">The following are the steps</span><span id="dx1-622001"/><span class="kobospan" id="kobo.255.1"> to find all the files that match a given pattern:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-622003x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.256.1">Create the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.257.1">Path</span></span></span></span><span class="kobospan" id="kobo.258.1"> object from the input directory name:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.259.1">&gt;&gt;&gt; directory_path = Path(options.file1).parent 
 
&gt;&gt;&gt; directory_path 
 
PosixPath(’data’)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-622009x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.260.1">Use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.261.1">glob()</span></span></span></span><span class="kobospan" id="kobo.262.1"> method of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.263.1">Path</span></span></span></span><span class="kobospan" id="kobo.264.1"> object to locate all files in this directory that match a given pattern. </span><span class="kobospan" id="kobo.264.2">For non-existent directories, the iterator will be empty. </span><span class="kobospan" id="kobo.264.3">Using </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.265.1">**</span></span></span></span><span class="kobospan" id="kobo.266.1"> as part of the pattern will recursively walk the directory tree:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.267.1">&gt;&gt;&gt; from pprint import pprint 
 
&gt;&gt;&gt; pprint(sorted(directory_path.glob("*.csv"))) 
 
[PosixPath(’data/binned.csv’),</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.268.1">We’ve elided a number of the files in the results.</span></p>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.269.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.270.1">glob()</span></span></span></span><span class="kobospan" id="kobo.271.1"> method is an iterator, and we’ve used the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.272.1">sorted()</span></span></span></span><span class="kobospan" id="kobo.273.1"> function to consume the values from this iterator</span><span id="dx1-622018"/><span class="kobospan" id="kobo.274.1"> and create a single list object from them. </span><span id="x1-622019r1312"/></p>
</section>
</section>
<section data-number="0.14.1.3" id="how-it-works...-86">
<h2 class="likechapterhead" data-number="0.14.1.3"><span><span class="kobospan" id="kobo.275.1">11.1.3 </span></span> <span id="x1-6230003"/><span class="kobospan" id="kobo.276.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.277.1">Inside the OS, the sequence of directories</span><span id="dx1-623001"/><span class="kobospan" id="kobo.278.1"> to find a file is a path</span><span id="dx1-623002"/><span class="kobospan" id="kobo.279.1"> through the filesystem. </span><span class="kobospan" id="kobo.279.2">In some cases, a simple string representation can be used to summarize the path. </span><span class="kobospan" id="kobo.279.3">The string representation, however, makes many kinds of path operations into complex string parsing problems. </span><span class="kobospan" id="kobo.279.4">A string is an unhelpfully opaque abstraction for working with OS paths.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.280.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.281.1">Path</span></span></span></span><span class="kobospan" id="kobo.282.1"> class definition simplifies operations on paths. </span><span class="kobospan" id="kobo.282.2">These attributes, methods, and operators on a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.283.1">Path</span></span></span></span><span class="kobospan" id="kobo.284.1"> instance include the following examples:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.285.1">.parent</span></span></span></span><span class="kobospan" id="kobo.286.1"> extracts the parent directory.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.287.1">.parents</span></span></span></span><span class="kobospan" id="kobo.288.1"> enumerates all the enclosing directories.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.289.1">.name</span></span></span></span><span class="kobospan" id="kobo.290.1"> is the final name.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.291.1">.stem</span></span></span></span><span class="kobospan" id="kobo.292.1"> is the stem of the final name (without any suffix).</span></p></li>
<li class="calibre7"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.293.1">.suffix</span></span></span></span><span class="kobospan" id="kobo.294.1"> is the final suffix.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.295.1">.suffixes</span></span></span></span><span class="kobospan" id="kobo.296.1"> is the sequence of suffix values, used with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.297.1">file.tag.gz</span></span></span></span><span class="kobospan" id="kobo.298.1"> kinds of names.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.299.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.300.1">.with_suffix()</span></span></span></span><span class="kobospan" id="kobo.301.1"> method replaces the suffix of the file with a new suffix.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.302.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.303.1">.with_name()</span></span></span></span><span class="kobospan" id="kobo.304.1"> method replaces the name in the path with a new name.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.305.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.306.1">/</span></span></span></span><span class="kobospan" id="kobo.307.1"> operator builds </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.308.1">Path</span></span></span></span><span class="kobospan" id="kobo.309.1"> objects from </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.310.1">Path</span></span></span></span><span class="kobospan" id="kobo.311.1"> and string components.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.312.1">A concrete path represents an actual filesystem</span><span id="dx1-623003"/><span class="kobospan" id="kobo.313.1"> resource. </span><span class="kobospan" id="kobo.313.2">For concrete path objects, we can do a number of additional manipulations of the directory information:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.314.1">Determine what kind of directory entry this is; that is, an ordinary file, a directory, a link, a socket, a named pipe (or FIFO), a block device, or a character device.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.315.1">Get the directory details, including information such as timestamps, permissions, ownership, size, and so on.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.316.1">Unlink (that is, remove) the directory entry. </span><span class="kobospan" id="kobo.316.2">Note that unlinking ordinary files is distinct from removing an empty directory. </span><span class="kobospan" id="kobo.316.3">We’ll look at this in the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.317.1">There’s more... </span></span><span class="kobospan" id="kobo.318.1">section of this recipe.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.319.1">Rename the file to place it in a new path. </span><span class="kobospan" id="kobo.319.2">We’ll also look at this in the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.320.1">There’s more... </span></span><span class="kobospan" id="kobo.321.1">section of this recipe.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.322.1">Just about anything we might want to do with directory entries for files</span><span id="dx1-623004"/><span class="kobospan" id="kobo.323.1"> can be done with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.324.1">pathlib</span></span></span></span><span class="kobospan" id="kobo.325.1"> module. </span><span class="kobospan" id="kobo.325.2">The few exceptions</span><span id="dx1-623005"/><span class="kobospan" id="kobo.326.1"> are part of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.327.1">os</span></span></span></span><span class="kobospan" id="kobo.328.1"> module, because they are generally OS-specific. </span><span id="x1-623006r1329"/></p>
</section>
<section data-number="0.14.1.4" id="theres-more...-77">
<h2 class="likechapterhead" data-number="0.14.1.4"><span><span class="kobospan" id="kobo.329.1">11.1.4 </span></span> <span id="x1-6240004"/><span class="kobospan" id="kobo.330.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.331.1">In addition to manipulating the path and gathering information about a file, we can also make some changes to the filesystem. </span><span class="kobospan" id="kobo.331.2">Two common operations are renaming a file and unlinking (or removing) a file. </span><span class="kobospan" id="kobo.331.3">We can use a number of methods to make changes</span><span id="dx1-624001"/><span class="kobospan" id="kobo.332.1"> to the filesystem:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.333.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.334.1">.unlink()</span></span></span></span><span class="kobospan" id="kobo.335.1"> method removes ordinary files. </span><span class="kobospan" id="kobo.335.2">It doesn’t remove directories.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.336.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.337.1">.rmdir()</span></span></span></span><span class="kobospan" id="kobo.338.1"> method removes empty directories. </span><span class="kobospan" id="kobo.338.2">Removing a directory with files requires a two-step operation to first unlink all the files in the directory, then remove the directory.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.339.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.340.1">.rename()</span></span></span></span><span class="kobospan" id="kobo.341.1"> method renames a file to a new path.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.342.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.343.1">.replace()</span></span></span></span><span class="kobospan" id="kobo.344.1"> method replaces a file without raising an exception if the target already exists.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.345.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.346.1">.symlink_to()</span></span></span></span><span class="kobospan" id="kobo.347.1"> method creates a soft link file with a link to an existing file.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.348.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.349.1">.hardlink_to()</span></span></span></span><span class="kobospan" id="kobo.350.1"> method creates an OS hard link; two distinct directory</span><span id="dx1-624002"/><span class="kobospan" id="kobo.351.1"> entries will now own the underlying file content.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.352.1">We can open a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.353.1">Path</span></span></span></span><span class="kobospan" id="kobo.354.1"> either using the built-in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.355.1">open()</span></span></span></span><span class="kobospan" id="kobo.356.1"> function or the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.357.1">open()</span></span></span></span><span class="kobospan" id="kobo.358.1"> method. </span><span class="kobospan" id="kobo.358.2">Some people like to see </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.359.1">open(some_path)</span></span></span></span><span class="kobospan" id="kobo.360.1">, where others prefer </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.361.1">some_path.open()</span></span></span></span><span class="kobospan" id="kobo.362.1">. </span><span class="kobospan" id="kobo.362.2">Both do the same thing: create an open file object.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.363.1">We can create directories using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.364.1">mkdir()</span></span></span></span><span class="kobospan" id="kobo.365.1"> method. </span><span class="kobospan" id="kobo.365.2">There are two</span><span id="dx1-624003"/><span class="kobospan" id="kobo.366.1"> keyword parameters for this method:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.367.1">exist_ok=False</span></span></span></span><span class="kobospan" id="kobo.368.1"> is the default; if the directory already exists, an exception is raised. </span><span class="kobospan" id="kobo.368.2">Changing this to </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.369.1">True</span></span></span></span><span class="kobospan" id="kobo.370.1"> makes the code tolerant of an existing directory.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.371.1">parents=False</span></span></span></span><span class="kobospan" id="kobo.372.1"> is the default; the parents are not created, only the child-most directory in the path. </span><span class="kobospan" id="kobo.372.2">Changing this to </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.373.1">True</span></span></span></span><span class="kobospan" id="kobo.374.1"> will create the entire path, parents and children.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.375.1">We can also read and write files as large string or bytes objects:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.376.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.377.1">.read_text()</span></span></span></span><span class="kobospan" id="kobo.378.1"> method reads a file as a single string.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.379.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.380.1">.write_text()</span></span></span></span><span class="kobospan" id="kobo.381.1"> method creates or replaces a file with the given string.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.382.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.383.1">.read_bytes()</span></span></span></span><span class="kobospan" id="kobo.384.1"> method reads a file as a single </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.385.1">bytes</span></span></span></span><span class="kobospan" id="kobo.386.1"> instance.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.387.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.388.1">.write_bytes()</span></span></span></span><span class="kobospan" id="kobo.389.1"> method creates or replaces a file with the given bytes.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.390.1">There are yet more file system operations, like changing ownership or changing permissions. </span><span class="kobospan" id="kobo.390.2">These operations are available in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.391.1">os</span></span></span></span><span class="kobospan" id="kobo.392.1"> module. </span><span id="x1-624004r1330"/></p>
</section>
<section data-number="0.14.1.5" id="see-also-84">
<h2 class="likechapterhead" data-number="0.14.1.5"><span><span class="kobospan" id="kobo.393.1">11.1.5 </span></span> <span id="x1-6250005"/><span class="kobospan" id="kobo.394.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.395.1">In the </span><a href="ch015_split_000.xhtml#x1-6260002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.396.1">Replacing a file while preserving the previous version</span></span></a><span class="kobospan" id="kobo.397.1"> recipe, later in this chapter, we’ll look at how to leverage the features of a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.398.1">Path</span></span></span></span><span class="kobospan" id="kobo.399.1"> object to create a temporary file and then rename the temporary file to replace the original file.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.400.1">In the </span><a href="ch010.xhtml#x1-3490004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.401.1">Using argparse to get command-line input</span></span></a><span class="kobospan" id="kobo.402.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.403.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.404.1"> </span></span><a href="ch010.xhtml#x1-3300006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.405.1">6</span></span></a><span class="kobospan" id="kobo.406.1">, we looked at one very common way to use a string to create a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.407.1">Path</span></span></span></span><span class="kobospan" id="kobo.408.1"> object.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.409.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.410.1">os</span></span></span></span><span class="kobospan" id="kobo.411.1"> module offers a number of filesystem operations that are less commonly used than the ones provided by </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.412.1">pathlib</span></span></span></span><span class="kobospan" id="kobo.413.1">.</span></p></li>
</ul>
<p class="normal1"><span id="x1-625001r1308"/></p>
</section>
</section>
<section data-number="0.14.2" id="replacing-a-file-while-preserving-the-previous-version">
<h1 class="unnumbered" data-number="0.14.2"><span><span class="kobospan" id="kobo.414.1">11.2 </span></span> <span id="x1-6260002"/><span class="kobospan" id="kobo.415.1">Replacing a file while preserving the previous version</span></h1>
<p class="normal"><span class="kobospan" id="kobo.416.1">We can leverage the power</span><span id="dx1-626001"/><span class="kobospan" id="kobo.417.1"> of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.418.1">pathlib</span></span></span></span><span class="kobospan" id="kobo.419.1"> module to support a variety of filename manipulations. </span><span class="kobospan" id="kobo.419.2">In the </span><a href="ch015_split_000.xhtml#x1-6160001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.420.1">Using pathlib to work with filenames</span></span></a><span class="kobospan" id="kobo.421.1"> recipe in this chapter, we looked at a few of the most common techniques for managing directories, filenames, and file suffixes.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.422.1">One common file processing requirement is to create output files in a fail-safe manner; that is, the application should preserve any previous output file, no matter how or where the application fails.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.423.1">Consider the following scenario:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-626002x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.424.1">At time </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.425.1">T</span></span><sub class="calibre24"><span class="cmr1"><span class="kobospan" id="kobo.426.1">0</span></span></sub><span class="kobospan" id="kobo.427.1">, there’s a valid </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.428.1">output.csv</span></span></span></span><span class="kobospan" id="kobo.429.1"> file from a previous run of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.430.1">long_complex.py</span></span></span></span><span class="kobospan" id="kobo.431.1"> application.</span></p>
</div></li>
<li class="calibre7"><div id="x1-626003x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.432.1">At time </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.433.1">T</span></span><sub class="calibre24"><span class="cmr1"><span class="kobospan" id="kobo.434.1">1</span></span></sub><span class="kobospan" id="kobo.435.1">, we start running the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.436.1">long_complex.py</span></span></span></span><span class="kobospan" id="kobo.437.1"> application using new data. </span><span class="kobospan" id="kobo.437.2">It begins overwriting the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.438.1">output.csv</span></span></span></span><span class="kobospan" id="kobo.439.1"> file. </span><span class="kobospan" id="kobo.439.2">Until the program finishes, the bytes will be unusable.</span></p>
</div></li>
<li class="calibre7"><div id="x1-626004x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.440.1">At time </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.441.1">T</span></span><sub class="calibre24"><span class="cmr1"><span class="kobospan" id="kobo.442.1">2</span></span></sub><span class="kobospan" id="kobo.443.1">, the application crashes. </span><span class="kobospan" id="kobo.443.2">The partial contents of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.444.1">output.csv</span></span></span></span><span class="kobospan" id="kobo.445.1"> file are useless. </span><span class="kobospan" id="kobo.445.2">Worse, the valid file from time </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.446.1">T</span></span><sub class="calibre24"><span class="cmr1"><span class="kobospan" id="kobo.447.1">0</span></span></sub><span class="kobospan" id="kobo.448.1"> is no longer available either because it was overwritten.</span></p>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.449.1">In this recipe, we’ll look at an approach to creating output files that’s safe in the event of a failure. </span><span id="x1-626005r1331"/></p>
<section data-number="0.14.2.1" id="getting-ready-86">
<h2 class="likechapterhead" data-number="0.14.2.1"><span><span class="kobospan" id="kobo.450.1">11.2.1 </span></span> <span id="x1-6270001"/><span class="kobospan" id="kobo.451.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.452.1">For files that don’t span across physical</span><span id="dx1-627001"/><span class="kobospan" id="kobo.453.1"> devices, fail-safe file output</span><span id="dx1-627002"/><span class="kobospan" id="kobo.454.1"> generally means creating a new copy of the file using a temporary name. </span><span class="kobospan" id="kobo.454.2">If the new file can be created successfully, then the old file should be replaced using a single, atomic rename operation.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.455.1">We want to have the following features:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.456.1">The important output file must be preserved in a valid state at all times.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.457.1">A temporary version of the file is written by the application. </span><span class="kobospan" id="kobo.457.2">There are a variety of conventions for naming this file. </span><span class="kobospan" id="kobo.457.3">Sometimes, extra characters such as </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.458.1">~</span></span></span></span><span class="kobospan" id="kobo.459.1"> or </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.460.1">#</span></span></span></span><span class="kobospan" id="kobo.461.1"> are placed on the filename to indicate that it’s a temporary, working file; for example, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.462.1">output.csv~</span></span></span></span><span class="kobospan" id="kobo.463.1">. </span><span class="kobospan" id="kobo.463.2">We’ll use a longer suffix, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.464.1">.new</span></span></span></span><span class="kobospan" id="kobo.465.1">; for example, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.466.1">output.csv.new</span></span></span></span><span class="kobospan" id="kobo.467.1">.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.468.1">The previous version of the file is also preserved. </span><span class="kobospan" id="kobo.468.2">Sometimes, the previous version has a suffix of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.469.1">.bak</span></span></span></span><span class="kobospan" id="kobo.470.1">, meaning ”backup.” </span><span class="kobospan" id="kobo.470.2">We’ll use a longer suffix and call it </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.471.1">output.csv.old</span></span></span></span><span class="kobospan" id="kobo.472.1">. </span><span class="kobospan" id="kobo.472.2">This also means any previous </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.473.1">.old</span></span></span></span><span class="kobospan" id="kobo.474.1"> file must be removed as part of finalizing the output; only a single version is preserved.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.475.1">To create a concrete example, we’ll work with a file that has a very small but precious piece of data: a sequence of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.476.1">Quotient</span></span></span></span><span class="kobospan" id="kobo.477.1"> objects. </span><span class="kobospan" id="kobo.477.2">Here’s the definition for the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.478.1">Quotient</span></span></span></span><span class="kobospan" id="kobo.479.1"> class:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.480.1">from dataclasses import dataclass, asdict, fields 
 
 
 
@dataclass 
 
class Quotient: 
 
    numerator: int 
 
    denominator: int
                                                                     

                                                                     </span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.481.1">The following function will write an object to a file in CSV notation:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.482.1">import csv 
 
from collections.abc import Iterable 
 
from pathlib import Path 
 
 
 
def save_data( 
 
    output_path: Path, data: Iterable[Quotient] 
 
) -&gt; None: 
 
    with output_path.open("w", newline="") as output_file: 
 
        headers = [f.name for f in fields(Quotient)] 
 
        writer = csv.DictWriter(output_file, headers) 
 
        writer.writeheader() 
 
        for q in data: 
 
            writer.writerow(asdict(q))</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.483.1">If a problem arises when writing the data object to the file, we could be left with a corrupted, unusable file. </span><span class="kobospan" id="kobo.483.2">We’ll wrap this function with another to provide a reliable write. </span><span id="x1-627024r1333"/></p>
</section>
<section data-number="0.14.2.2" id="how-to-do-it...-87">
<h2 class="likechapterhead" data-number="0.14.2.2"><span><span class="kobospan" id="kobo.484.1">11.2.2 </span></span> <span id="x1-6280002"/><span class="kobospan" id="kobo.485.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.486.1">We start creating a wrapper</span><span id="dx1-628001"/><span class="kobospan" id="kobo.487.1"> function by importing the classes we need:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-628003x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.488.1">Define a function to encapsulate the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.489.1">save_data()</span></span></span></span><span class="kobospan" id="kobo.490.1"> function along with a few extra features. </span><span class="kobospan" id="kobo.490.2">The function signature is the same as the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.491.1">save_data()</span></span></span></span><span class="kobospan" id="kobo.492.1"> function:</span></p>
</div></li>
<li class="calibre7"><div id="x1-628005x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.493.1">Save the original suffix and create a new name with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.494.1">.new</span></span></span></span><span class="kobospan" id="kobo.495.1"> at the end of the suffix. </span><span class="kobospan" id="kobo.495.2">This is a temporary file. </span><span class="kobospan" id="kobo.495.3">If it is written properly, with no exceptions, then we can rename it so that it’s the target file:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.496.1">    ext = output_path.suffix 
 
    output_new_path = output_path.with_suffix(f’{ext}.new’) 
 
    save_data(output_new_path, data)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.497.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.498.1">save_data()</span></span></span></span><span class="kobospan" id="kobo.499.1"> function is the original process to create the new file being wrapped by this function.</span></p>
</div></li>
<li class="calibre7"><div id="x1-628011x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.500.1">Before replacing the previous file with the new, good file, remove any previous backup copy. </span><span class="kobospan" id="kobo.500.2">We’ll unlink an </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.501.1">.old</span></span></span></span><span class="kobospan" id="kobo.502.1"> file, if one exists:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.503.1">    output_old_path = output_path.with_suffix(f’{ext}.old’) 
 
    output_old_path.unlink(missing_ok=True)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-628016x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.504.1">Now, we can preserve any previous good file with the name of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.505.1">.old</span></span></span></span><span class="kobospan" id="kobo.506.1">:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.507.1">    try: 
 
        output_path.rename(output_old_path) 
 
    except FileNotFoundError as ex: 
 
        # No previous file. </span><span class="kobospan" id="kobo.507.2">That’s okay. 
 
        pass</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-628024x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.508.1">The final step is to make the temporary </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.509.1">.new</span></span></span></span><span class="kobospan" id="kobo.510.1"> file the official output:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.511.1">    try: 
 
        output_new_path.rename(output_path) 
 
    except IOError as ex: 
 
        # Possible recovery... 
 
        output_old_path.rename(output_path)</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.512.1">This multi-step process uses two rename operations:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.513.1">Rename the previous version to a backup version with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.514.1">.old</span></span></span></span><span class="kobospan" id="kobo.515.1"> appended to the suffix.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.516.1">Rename the new version, which had </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.517.1">.new</span></span></span></span><span class="kobospan" id="kobo.518.1"> appended to the suffix, to be the current version of the file.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.519.1">A </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.520.1">Path</span></span></span></span><span class="kobospan" id="kobo.521.1"> object has a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.522.1">replace()</span></span></span></span><span class="kobospan" id="kobo.523.1"> method. </span><span class="kobospan" id="kobo.523.2">This always</span><span id="dx1-628031"/><span class="kobospan" id="kobo.524.1"> overwrites the target file, with no warning if overwriting an existing file. </span><span class="kobospan" id="kobo.524.2">The choice between </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.525.1">rename()</span></span></span></span><span class="kobospan" id="kobo.526.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.527.1">replace()</span></span></span></span><span class="kobospan" id="kobo.528.1"> depends on how our application needs to handle cases where old versions of files may be left in the filesystem. </span><span class="kobospan" id="kobo.528.2">We’ve used </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.529.1">rename()</span></span></span></span><span class="kobospan" id="kobo.530.1"> in this recipe to try and avoid overwriting files in the case of multiple problems.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.531.1">Because these are applied serially, there’s a tiny span of time between preserving the old file and renaming the new file where an application failure would fail to put a new file in place. </span><span class="kobospan" id="kobo.531.2">We’ll look at this in the next section. </span><span id="x1-628032r1336"/></p>
</section>
<section data-number="0.14.2.3" id="how-it-works...-87">
<h2 class="likechapterhead" data-number="0.14.2.3"><span><span class="kobospan" id="kobo.532.1">11.2.3 </span></span> <span id="x1-6290003"/><span class="kobospan" id="kobo.533.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.534.1">This process involves three separate</span><span id="dx1-629001"/><span class="kobospan" id="kobo.535.1"> OS operations: an unlink and two renames. </span><span class="kobospan" id="kobo.535.2">This is designed to ensure that an </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.536.1">.old</span></span></span></span><span class="kobospan" id="kobo.537.1"> file is preserved and can be used to recover the previously good state.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.538.1">Here’s a timeline that shows the state of the various files. </span><span class="kobospan" id="kobo.538.2">We’ve labeled the content as version 0 (some previous data), version 1 (the current, valid data), and version 2 (the newly created data):</span></p>
<div class="center">
<div class="tabular">
<table class="tabular1" id="TBL-4">
<tbody class="calibre19">
<tr class="odd">
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
</tr>
<tr class="even" id="TBL-4-1-">
<td class="td1" id="TBL-4-1-1"><span class="kobospan2" id="kobo.539.1">
                    Time
                  </span></td>
<td class="td" id="TBL-4-1-2"><span class="kobospan2" id="kobo.540.1">
                    Operation
                  </span></td>
<td class="td1" id="TBL-4-1-3">
<span class="obeylines-h1"><span class="verb"><span class="cmtt-10x-x1"><span class="kobospan2" id="kobo.541.1">.csv.old</span></span></span></span>
</td>
<td class="td1" id="TBL-4-1-4"><span class="kobospan2" id="kobo.542.1">
                    .csv
                  </span></td>
<td class="td" id="TBL-4-1-5">
<span class="obeylines-h1"><span class="verb"><span class="cmtt-10x-x1"><span class="kobospan2" id="kobo.543.1">.csv.new</span></span></span></span>
</td>
</tr>
<tr class="odd">
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
</tr>
<tr class="even" id="TBL-4-2-">
<td class="td1" id="TBL-4-2-1">
<span class="cmti-10x-x1"><span class="kobospan2" id="kobo.544.1">T</span></span><sub class="calibre27"><span class="cmr2"><span class="kobospan2" id="kobo.545.1">0</span></span></sub>
</td>
<td class="td" id="TBL-4-2-2"/>
<td class="td1" id="TBL-4-2-3"><span class="kobospan2" id="kobo.546.1">
                    version 0
                  </span></td>
<td class="td1" id="TBL-4-2-4"><span class="kobospan2" id="kobo.547.1">
                    version 1
                  </span></td>
<td class="td" id="TBL-4-2-5"/>
</tr>
<tr class="odd">
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
</tr>
<tr class="even" id="TBL-4-3-">
<td class="td1" id="TBL-4-3-1">
<span class="cmti-10x-x1"><span class="kobospan2" id="kobo.548.1">T</span></span><sub class="calibre27"><span class="cmr2"><span class="kobospan2" id="kobo.549.1">1</span></span></sub>
</td>
<td class="td" id="TBL-4-3-2"><span class="kobospan2" id="kobo.550.1">
                    Mid-creation
                  </span></td>
<td class="td1" id="TBL-4-3-3"><span class="kobospan2" id="kobo.551.1">
                    version 0
                  </span></td>
<td class="td1" id="TBL-4-3-4"><span class="kobospan2" id="kobo.552.1">
                    version 1
                  </span></td>
<td class="td" id="TBL-4-3-5"><span class="kobospan2" id="kobo.553.1">
                    Will appear corrupt if used
                  </span></td>
</tr>
<tr class="odd">
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
</tr>
<tr class="even" id="TBL-4-4-">
<td class="td1" id="TBL-4-4-1">
<span class="cmti-10x-x1"><span class="kobospan2" id="kobo.554.1">T</span></span><sub class="calibre27"><span class="cmr2"><span class="kobospan2" id="kobo.555.1">2</span></span></sub>
</td>
<td class="td" id="TBL-4-4-2"><span class="kobospan2" id="kobo.556.1">
                    Post-creation, closed
                  </span></td>
<td class="td1" id="TBL-4-4-3"><span class="kobospan2" id="kobo.557.1">
                    version 0
                  </span></td>
<td class="td1" id="TBL-4-4-4"><span class="kobospan2" id="kobo.558.1">
                    version 1
                  </span></td>
<td class="td" id="TBL-4-4-5"><span class="kobospan2" id="kobo.559.1">
                    version 2
                  </span></td>
</tr>
<tr class="odd">
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
</tr>
<tr class="even" id="TBL-4-5-">
<td class="td1" id="TBL-4-5-1">
<span class="cmti-10x-x1"><span class="kobospan2" id="kobo.560.1">T</span></span><sub class="calibre27"><span class="cmr2"><span class="kobospan2" id="kobo.561.1">3</span></span></sub>
</td>
<td class="td" id="TBL-4-5-2"><span class="kobospan3" id="kobo.562.1">
                    After unlinking </span><span class="obeylines-h2"><span class="verb"><span class="cmtt-10x-x1"><span class="kobospan2" id="kobo.563.1">.csv.old</span></span></span></span>
</td>
<td class="td1" id="TBL-4-5-3"/>
<td class="td1" id="TBL-4-5-4"><span class="kobospan2" id="kobo.564.1">
                    version 1
                  </span></td>
<td class="td" id="TBL-4-5-5"><span class="kobospan2" id="kobo.565.1">
                    version 2
                  </span></td>
</tr>
<tr class="odd">
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
</tr>
<tr class="even" id="TBL-4-6-">
<td class="td1" id="TBL-4-6-1">
<span class="cmti-10x-x1"><span class="kobospan2" id="kobo.566.1">T</span></span><sub class="calibre27"><span class="cmr2"><span class="kobospan2" id="kobo.567.1">4</span></span></sub>
</td>
<td class="td" id="TBL-4-6-2"><span class="kobospan3" id="kobo.568.1">
                    After renaming </span><span class="obeylines-h"><span class="verb"><span class="cmtt-10x-x1"><span class="kobospan2" id="kobo.569.1">.csv</span></span></span></span><span class="kobospan" id="kobo.570.1"> to </span><span class="obeylines-h2"><span class="verb"><span class="cmtt-10x-x1"><span class="kobospan2" id="kobo.571.1">.csv.old</span></span></span></span>
</td>
<td class="td1" id="TBL-4-6-3"><span class="kobospan2" id="kobo.572.1">
                    version 1
                  </span></td>
<td class="td1" id="TBL-4-6-4"/>
<td class="td" id="TBL-4-6-5"><span class="kobospan2" id="kobo.573.1">
                    version 2
                  </span></td>
</tr>
<tr class="odd">
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
</tr>
<tr class="even" id="TBL-4-7-">
<td class="td1" id="TBL-4-7-1">
<span class="cmti-10x-x1"><span class="kobospan2" id="kobo.574.1">T</span></span><sub class="calibre27"><span class="cmr2"><span class="kobospan2" id="kobo.575.1">5</span></span></sub>
</td>
<td class="td" id="TBL-4-7-2"><span class="kobospan3" id="kobo.576.1">
                    After renaming </span><span class="obeylines-h"><span class="verb"><span class="cmtt-10x-x1"><span class="kobospan2" id="kobo.577.1">.csv.new</span></span></span></span><span class="kobospan" id="kobo.578.1"> to </span><span class="obeylines-h2"><span class="verb"><span class="cmtt-10x-x1"><span class="kobospan2" id="kobo.579.1">.csv</span></span></span></span>
</td>
<td class="td1" id="TBL-4-7-3"><span class="kobospan2" id="kobo.580.1">
                    version 1
                  </span></td>
<td class="td1" id="TBL-4-7-4"><span class="kobospan2" id="kobo.581.1">
                    version 2
                  </span></td>
<td class="td" id="TBL-4-7-5"/>
</tr>
<tr class="odd">
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
<td class="calibre20">
<hr class="calibre21"/>
</td>
</tr>
<tr class="even" id="TBL-4-8-">
<td class="td1" id="TBL-4-8-1"/>
<td class="calibre23"/>
<td class="calibre23"/>
<td class="calibre23"/>
<td class="calibre23"/>
</tr>
</tbody>
</table>
</div>
<span id="x1-629002r1"/> <span id="x1-629003"/> <span><span class="kobospan" id="kobo.582.1">Table 11.1: </span></span><span><span class="kobospan" id="kobo.583.1">Timeline of file operations </span></span>
</div>
<p class="normal1"><span class="kobospan" id="kobo.584.1">While there are several opportunities for failure, there’s no ambiguity about which file is valid:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.585.1">If there’s a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.586.1">.csv</span></span></span></span><span class="kobospan" id="kobo.587.1"> file, it’s the current, valid file.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.588.1">If there’s no </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.589.1">.csv</span></span></span></span><span class="kobospan" id="kobo.590.1"> file, then the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.591.1">.csv.old</span></span></span></span><span class="kobospan" id="kobo.592.1"> file is a valid backup copy, which should be used for recovery. </span><span class="kobospan" id="kobo.592.2">See the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.593.1">T</span></span><sub class="calibre24"><span class="cmr1"><span class="kobospan" id="kobo.594.1">4</span></span></sub><span class="kobospan" id="kobo.595.1"> moment in time, for this condition.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.596.1">Since none of these operations involve actually copying the files, the operations are all extremely fast and reliable. </span><span class="kobospan" id="kobo.596.2">They are, however, not guaranteed to work. </span><span class="kobospan" id="kobo.596.3">The state of the filesystem can be changed by any user with the right permissions, leading to the need for care when creating new files that replace old files.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.597.1">To ensure the output file is valid, some applications will take an additional step and write a final checksum row in the file to provide unambiguous evidence that the file is complete and consistent. </span><span id="x1-629004r1341"/></p>
</section>
<section data-number="0.14.2.4" id="theres-more...-78">
<h2 class="likechapterhead" data-number="0.14.2.4"><span><span class="kobospan" id="kobo.598.1">11.2.4 </span></span> <span id="x1-6300004"/><span class="kobospan" id="kobo.599.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.600.1">In some enterprise applications, output files are organized into directories with names based on timestamps. </span><span class="kobospan" id="kobo.600.2">These operations can be handled gracefully</span><span id="dx1-630001"/><span class="kobospan" id="kobo.601.1"> by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.602.1">pathlib</span></span></span></span><span class="kobospan" id="kobo.603.1"> module. </span><span class="kobospan" id="kobo.603.2">We might, for example, have an archive directory for old files. </span><span class="kobospan" id="kobo.603.3">This directory has date-stamped subdirectories for keeping temporary or working files.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.604.1">We can then do the following to define a working directory:</span></p>
<p class="normal1"><span class="kobospan" id="kobo.605.1">[firstline=58,lastline=58,gobble=4][python]src/ch11/recipe˙02.py [firstline=60,lastline=65,gobble=4][python]src/ch11/recipe˙02.py</span></p>
<p class="normal1"><span class="kobospan" id="kobo.606.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.607.1">mkdir()</span></span></span></span><span class="kobospan" id="kobo.608.1"> method will create the expected directory. </span><span class="kobospan" id="kobo.608.2">By including the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.609.1">parents=True</span></span></span></span><span class="kobospan" id="kobo.610.1"> argument, any needed parent directories will also be created. </span><span class="kobospan" id="kobo.610.2">This can be handy to create the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.611.1">archive_path</span></span></span></span><span class="kobospan" id="kobo.612.1"> the very first time an application is executed. </span><span class="kobospan" id="kobo.612.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.613.1">exists_ok=True</span></span></span></span><span class="kobospan" id="kobo.614.1"> will avoid raising an exception if the archive directory already exists.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.615.1">For some applications it can be appropriate to use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.616.1">tempfile</span></span></span></span><span class="kobospan" id="kobo.617.1"> module to create temporary files. </span><span class="kobospan" id="kobo.617.2">This module can create filenames that are guaranteed to be unique. </span><span class="kobospan" id="kobo.617.3">This allows a complex server process to create temporary files without regard to filename conflicts. </span><span id="x1-630002r1343"/></p>
</section>
<section data-number="0.14.2.5" id="see-also-85">
<h2 class="likechapterhead" data-number="0.14.2.5"><span><span class="kobospan" id="kobo.618.1">11.2.5 </span></span> <span id="x1-6310005"/><span class="kobospan" id="kobo.619.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.620.1">In the </span><a href="ch015_split_000.xhtml#x1-6160001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.621.1">Using pathlib to work with filenames</span></span></a><span class="kobospan" id="kobo.622.1"> recipe, earlier in this chapter, we looked at the fundamentals of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.623.1">Path</span></span></span></span><span class="kobospan" id="kobo.624.1"> class.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.625.1">In </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.626.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.627.1"> </span></span><a href="ch019_split_000.xhtml#x1-79400015" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.628.1">15</span></span></a><span class="kobospan" id="kobo.629.1">, we’ll look at some techniques for writing unit tests that can ensure that parts of this recipe’s example code will behave properly.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.630.1">In </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.631.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.632.1"> </span></span><a href="ch010.xhtml#x1-3300006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.633.1">6</span></span></a><span class="kobospan" id="kobo.634.1">, the </span><a href="ch011_split_001.xhtml#x1-43700011" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.635.1">Creating contexts and context managers</span></span></a><span class="kobospan" id="kobo.636.1"> recipe shows additional details regarding working with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.637.1">with</span></span></span></span><span class="kobospan" id="kobo.638.1"> statement to ensure file operations complete properly, and that all of the OS resources are released.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.639.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.640.1">shutil</span></span></span></span><span class="kobospan" id="kobo.641.1"> module provides a number of methods for copying files and directories full of files. </span><span class="kobospan" id="kobo.641.2">This package reflects features of Linux shell programs like </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.642.1">cp</span></span></span></span><span class="kobospan" id="kobo.643.1">, as well as Windows programs like </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.644.1">copy</span></span></span></span><span class="kobospan" id="kobo.645.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.646.1">xcopy</span></span></span></span><span class="kobospan" id="kobo.647.1">.</span></p></li>
</ul>
<p class="normal1"><span id="x1-631001r1332"/></p>
</section>
</section>
<section data-number="0.14.3" id="reading-delimited-files-with-the-csv-module">
<h1 class="unnumbered" data-number="0.14.3"><span><span class="kobospan" id="kobo.648.1">11.3 </span></span> <span id="x1-6320003"/><span class="kobospan" id="kobo.649.1">Reading delimited files with the CSV module</span></h1>
<p class="normal"><span class="kobospan" id="kobo.650.1">One commonly used data</span><span id="dx1-632001"/><span class="kobospan" id="kobo.651.1"> format is </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.652.1">comma-separated values </span></span><span class="kobospan" id="kobo.653.1">(</span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.654.1">CSV</span></span><span class="kobospan" id="kobo.655.1">). </span><span class="kobospan" id="kobo.655.2">We can generalize</span><span id="dx1-632002"/><span class="kobospan" id="kobo.656.1"> this to think of the comma</span><span id="dx1-632003"/><span class="kobospan" id="kobo.657.1"> character as simply one of many candidate separator characters. </span><span class="kobospan" id="kobo.657.2">For example, a CSV file can use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.658.1">|</span></span></span></span><span class="kobospan" id="kobo.659.1"> character as the separator between columns of data. </span><span class="kobospan" id="kobo.659.2">This generalization for separators other than the literal </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.660.1">,</span></span></span></span><span class="kobospan" id="kobo.661.1"> makes CSV files particularly powerful.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.662.1">How can we process data in one of the wide varieties of CSV formats? </span><span id="x1-632004r1344"/></p>
<section data-number="0.14.3.1" id="getting-ready-87">
<h2 class="likechapterhead" data-number="0.14.3.1"><span><span class="kobospan" id="kobo.663.1">11.3.1 </span></span> <span id="x1-6330001"/><span class="kobospan" id="kobo.664.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.665.1">A summary of a file’s content</span><span id="dx1-633001"/><span class="kobospan" id="kobo.666.1"> is called a schema. </span><span class="kobospan" id="kobo.666.2">It’s essential to distinguish between two aspects of a schema.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.667.1">The physical format of a CSV file’s bytes encode lines of text. </span><span class="kobospan" id="kobo.667.2">For CSV files, the text is organized into rows and columns using a row separator character (or characters) and a column separator character. </span><span class="kobospan" id="kobo.667.3">Many spreadsheet products will use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.668.1">,</span></span></span></span><span class="kobospan" id="kobo.669.1"> (comma) as the column separator and the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.670.1">\r\n</span></span></span></span><span class="kobospan" id="kobo.671.1"> sequence of characters as the row separator. </span><span class="kobospan" id="kobo.671.2">The specific combination of punctuation</span><span id="dx1-633002"/><span class="kobospan" id="kobo.672.1"> characters in use is called the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.673.1">CSV dialect</span></span><span class="kobospan" id="kobo.674.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.675.1">Additionally, column data can be quoted when it contains one of the separators. </span><span class="kobospan" id="kobo.675.2">The most common quoting rules are to surround the column value with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.676.1">"</span></span></span></span><span class="kobospan" id="kobo.677.1"> characters. </span><span class="kobospan" id="kobo.677.2">In order to include the quote character in column data, the quote character is doubled. </span><span class="kobospan" id="kobo.677.3">For example, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.678.1">"He</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.679.1"> said,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.680.1"> ""Thanks."""</span></span></span></span><span class="kobospan" id="kobo.681.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.682.1">The logical layout of the data in the file is a sequence of data columns that are present. </span><span class="kobospan" id="kobo.682.2">There are several common cases for handling the logical</span><span id="dx1-633003"/><span class="kobospan" id="kobo.683.1"> layout in CSV files:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.684.1">The file may have one line of headings. </span><span class="kobospan" id="kobo.684.2">This fits nicely with the way the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.685.1">csv</span></span></span></span><span class="kobospan" id="kobo.686.1"> module works. </span><span class="kobospan" id="kobo.686.2">It can be even more helpful when the headings are also proper Python variable names. </span><span class="kobospan" id="kobo.686.3">The schema is stated explicitly in the first line of the file.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.687.1">The file has no headings, but the column positions are fixed. </span><span class="kobospan" id="kobo.687.2">In this case, we can impose headings on the file when we open it. </span><span class="kobospan" id="kobo.687.3">Pragmatically, this involves some risk because it’s difficult to confirm that the data meets the imposed schema.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.688.1">If the file has no headings and the column positions aren’t fixed. </span><span class="kobospan" id="kobo.688.2">In this case, additional external schema information</span><span id="dx1-633004"/><span class="kobospan" id="kobo.689.1"> is required to interpret the columns of data.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.690.1">There are, of course, some common complications that can arise</span><span id="dx1-633005"/><span class="kobospan" id="kobo.691.1"> with any data. </span><span class="kobospan" id="kobo.691.2">Some files are not in </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.692.1">First Normal Form </span></span><span class="kobospan" id="kobo.693.1">(</span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.694.1">1NF</span></span><span class="kobospan" id="kobo.695.1">). </span><span class="kobospan" id="kobo.695.2">In 1NF, each row is independent of all other rows. </span><span class="kobospan" id="kobo.695.3">When a file is not in this normal form, we’ll need to add a generator function to rearrange the data into 1NF rows. </span><span class="kobospan" id="kobo.695.4">See the </span><a href="ch008_split_000.xhtml#x1-2400003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.696.1">Slicing</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.697.1">and dicing a list</span></span></a><span class="kobospan" id="kobo.698.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.699.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.700.1"> </span></span><a href="ch008_split_000.xhtml#x1-2240004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.701.1">4</span></span></a><span class="kobospan" id="kobo.702.1">, and the </span><a href="ch013_split_000.xhtml#x1-5180003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.703.1">Using stacked generator expressions</span></span></a><span class="kobospan" id="kobo.704.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.705.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.706.1"> </span></span><a href="ch013_split_000.xhtml#x1-5020009" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.707.1">9</span></span></a><span class="kobospan" id="kobo.708.1">, for other recipes that show how to normalize data structures.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.709.1">We’ll look at a CSV file</span><span id="dx1-633006"/><span class="kobospan" id="kobo.710.1"> that has some real-time data</span><span id="dx1-633007"/><span class="kobospan" id="kobo.711.1"> recorded from the log of a sailboat. </span><span class="kobospan" id="kobo.711.2">This is the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.712.1">waypoints.csv</span></span></span></span><span class="kobospan" id="kobo.713.1"> file. </span><span class="kobospan" id="kobo.713.2">The data looks as follows:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.714.1">lat,lon,date,time 
 
32.8321666666667,-79.9338333333333,2012-11-27,09:15:00 
 
31.6714833333333,-80.93325,2012-11-28,00:00:00 
 
30.7171666666667,-81.5525,2012-11-28,11:35:00</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.715.1">This data contains four columns named in the first line of the file: </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.716.1">lat</span></span></span></span><span class="kobospan" id="kobo.717.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.718.1">lon</span></span></span></span><span class="kobospan" id="kobo.719.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.720.1">date</span></span></span></span><span class="kobospan" id="kobo.721.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.722.1">time</span></span></span></span><span class="kobospan" id="kobo.723.1">. </span><span class="kobospan" id="kobo.723.2">These describe a waypoint and need to be reformatted to create more useful information. </span><span id="x1-633013r1346"/></p>
</section>
<section data-number="0.14.3.2" id="how-to-do-it...-88">
<h2 class="likechapterhead" data-number="0.14.3.2"><span><span class="kobospan" id="kobo.724.1">11.3.2 </span></span> <span id="x1-6340002"/><span class="kobospan" id="kobo.725.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.726.1">Before starting to write any code, examine the data file to confirm the following features:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.727.1">The column separator character is </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.728.1">’,’</span></span></span></span><span class="kobospan" id="kobo.729.1">, which is the default.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.730.1">The row separator characters are </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.731.1">’\r\n’</span></span></span></span><span class="kobospan" id="kobo.732.1">, also widely used in both Windows and Linux.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.733.1">There is a single-row heading. </span><span class="kobospan" id="kobo.733.2">If this isn’t present, the headings should be provided separately when the reader object is created.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.734.1">Once the format has been confirmed, we can start creating the needed functions as follows:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-634002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.735.1">Import the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.736.1">csv</span></span></span></span><span class="kobospan" id="kobo.737.1"> module and the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.738.1">Path</span></span></span></span><span class="kobospan" id="kobo.739.1"> class:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.740.1">import csv 
 
from pathlib import Path</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-634007x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.741.1">Define a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.742.1">raw()</span></span></span></span><span class="kobospan" id="kobo.743.1"> function to read raw data from a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.744.1">Path</span></span></span></span><span class="kobospan" id="kobo.745.1"> object that refers to the file:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.746.1">def raw(data_path: Path) -&gt; None:</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-634011x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.747.1">Use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.748.1">Path</span></span></span></span><span class="kobospan" id="kobo.749.1"> object to open the file</span><span id="dx1-634012"/><span class="kobospan" id="kobo.750.1"> in a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.751.1">with</span></span></span></span><span class="kobospan" id="kobo.752.1"> statement. </span><span class="kobospan" id="kobo.752.2">Build the reader</span><span id="dx1-634013"/><span class="kobospan" id="kobo.753.1"> from the open file:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.754.1">    with data_path.open() as data_file: 
 
        data_reader = csv.DictReader(data_file)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-634018x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.755.1">Consume (and process) the rows of data from the iterable reader. </span><span class="kobospan" id="kobo.755.2">This is properly indented inside the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.756.1">with</span></span></span></span><span class="kobospan" id="kobo.757.1"> statement:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.758.1">        for row in data_reader: 
 
            print(row)</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.759.1">The output from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.760.1">raw()</span></span></span></span><span class="kobospan" id="kobo.761.1"> function is a series of dictionaries that look as follows:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.762.1">{’lat’: ’32.8321666666667’, ’lon’: ’-79.9338333333333’, ’date’: ’2012-11-27’, ’time’: ’09:15:00’}</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.763.1">We can now process the data by referring to the columns as dictionary items, using syntax like, for example, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.764.1">row[’date’]</span></span></span></span><span class="kobospan" id="kobo.765.1">. </span><span class="kobospan" id="kobo.765.2">Using the column names is more descriptive than referring to the column by position; for example, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.766.1">row[0]</span></span></span></span><span class="kobospan" id="kobo.767.1"> is hard to understand.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.768.1">To be sure that we’re using the column names correctly, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.769.1">typing.TypedDict</span></span></span></span><span class="kobospan" id="kobo.770.1"> type hint can be used to provide the expected column names. </span><span id="x1-634024r1348"/></p>
</section>
<section data-number="0.14.3.3" id="how-it-works...-88">
<h2 class="likechapterhead" data-number="0.14.3.3"><span><span class="kobospan" id="kobo.771.1">11.3.3 </span></span> <span id="x1-6350003"/><span class="kobospan" id="kobo.772.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.773.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.774.1">csv</span></span></span></span><span class="kobospan" id="kobo.775.1"> module handles the work of parsing</span><span id="dx1-635001"/><span class="kobospan" id="kobo.776.1"> the physical</span><span id="dx1-635002"/><span class="kobospan" id="kobo.777.1"> format. </span><span class="kobospan" id="kobo.777.2">This separates the rows from each other, and also separates the columns within each row. </span><span class="kobospan" id="kobo.777.3">The default rules ensure that each input line is treated as a separate row and that the columns are separated by </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.778.1">’,’</span></span></span></span><span class="kobospan" id="kobo.779.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.780.1">What happens when we need to use the column separator character as part of data? </span><span class="kobospan" id="kobo.780.2">We might have data like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.781.1">lan,lon,date,time,notes 
 
32.832,-79.934,2012-11-27,09:15:00,"breezy, rainy" 
 
31.671,-80.933,2012-11-28,00:00:00,"blowing ""like stink"""</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.782.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.783.1">notes</span></span></span></span><span class="kobospan" id="kobo.784.1"> column has data in the first row, which includes the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.785.1">’,’</span></span></span></span><span class="kobospan" id="kobo.786.1"> column separator character. </span><span class="kobospan" id="kobo.786.2">The rules for CSV allow a column’s value to be surrounded by quotes. </span><span class="kobospan" id="kobo.786.3">By default, the quoting characters are </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.787.1">"</span></span></span></span><span class="kobospan" id="kobo.788.1">. </span><span class="kobospan" id="kobo.788.2">Within these quoting characters, the column and row separator characters are ignored.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.789.1">In order to embed the quote character within a quoted string, the character is doubled. </span><span class="kobospan" id="kobo.789.2">The second example row shows how the value blowing </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.790.1">"like</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.791.1"> stink"</span></span></span></span><span class="kobospan" id="kobo.792.1"> is encoded by doubling the quote characters when they are part of the value of a column.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.793.1">The values in a CSV file are always strings. </span><span class="kobospan" id="kobo.793.2">A string value like </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.794.1">7331</span></span></span></span><span class="kobospan" id="kobo.795.1"> may look like a number to us, but it’s always text when processed by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.796.1">csv</span></span></span></span><span class="kobospan" id="kobo.797.1"> module. </span><span class="kobospan" id="kobo.797.2">This makes the processing simple and uniform, but it can be awkward for our Python applications.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.798.1">When data is saved from a manually prepared spreadsheet, the data may reveal the quirks of the desktop software’s internal rules for data display. </span><span class="kobospan" id="kobo.798.2">Data that is displayed as a date on the desktop software is stored as a floating-point number in the CSV file.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.799.1">There are two solutions to the date-as-number problem. </span><span class="kobospan" id="kobo.799.2">One is to add a column in the source spreadsheet to properly format the date data as a string. </span><span class="kobospan" id="kobo.799.3">Ideally, this is done using ISO rules so that the date is represented in the YYYY-MM-DD format. </span><span class="kobospan" id="kobo.799.4">The other solution is to recognize the spreadsheet date as a number of seconds past some epochal date. </span><span class="kobospan" id="kobo.799.5">The epochal dates vary slightly with versions of various tools, but they’re generally Jan 1, 1900. </span><span class="kobospan" id="kobo.799.6">(A few spreadsheet applications used Jan 1, 1904.) </span><span id="x1-635007r1354"/></p>
</section>
<section data-number="0.14.3.4" id="theres-more...-79">
<h2 class="likechapterhead" data-number="0.14.3.4"><span><span class="kobospan" id="kobo.800.1">11.3.4 </span></span> <span id="x1-6360004"/><span class="kobospan" id="kobo.801.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.802.1">As we saw in the </span><a href="ch013_split_001.xhtml#x1-5440006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.803.1">Combining the map and reduce transformations</span></span></a><span class="kobospan" id="kobo.804.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.805.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.806.1"> </span></span><a href="ch013_split_000.xhtml#x1-5020009" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.807.1">9</span></span></a><span class="kobospan" id="kobo.808.1">, there’s often a pipeline of processing that includes cleaning and transforming the source data. </span><span class="kobospan" id="kobo.808.2">This idea of stacked generator functions lets a Python program process large volumes of data. </span><span class="kobospan" id="kobo.808.3">Reading one row at a time can avoid reading all the data into a vast, in-memory list. </span><span class="kobospan" id="kobo.808.4">In this specific example, there are no extra rows that need to be eliminated. </span><span class="kobospan" id="kobo.808.5">However, each column needs to be converted into something more useful.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.809.1">In </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.810.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.811.1"> </span></span><a href="ch014.xhtml#x1-57300010" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.812.1">10</span></span></a><span class="kobospan" id="kobo.813.1">, a number of recipes use </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.814.1">Pydantic </span></span><span class="kobospan" id="kobo.815.1">to perform these kinds of data conversions. </span><span class="kobospan" id="kobo.815.2">See the </span><a href="ch014.xhtml#x1-6000005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.816.1">Implementing more strict type checks with Pydantic</span></span></a><span class="kobospan" id="kobo.817.1"> recipe for an example of this alternative approach.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.818.1">To transform the data into a more useful form, we’ll define a row-level cleansing</span><span id="dx1-636001"/><span class="kobospan" id="kobo.819.1"> function. </span><span class="kobospan" id="kobo.819.2">A function can apply this cleansing function to each row of the source data.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.820.1">In this case, we’ll create a dictionary object and insert additional values that are derived from the input data. </span><span class="kobospan" id="kobo.820.2">The core type hints for this </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.821.1">Waypoint</span></span></span></span><span class="kobospan" id="kobo.822.1"> dictionary are these:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.823.1">import datetime 
 
from typing import TypeAlias, Any 
 
 
 
Raw: TypeAlias = dict[str, Any] 
 
 
 
Waypoint: TypeAlias = dict[str, Any]</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.824.1">Based on this definition of a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.825.1">Waypoint</span></span></span></span><span class="kobospan" id="kobo.826.1"> type, a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.827.1">clean_row()</span></span></span></span><span class="kobospan" id="kobo.828.1"> function can look like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.829.1">def clean_row( 
 
    source_row: Raw 
 
) -&gt; Waypoint: 
 
    ts_date = datetime.datetime.strptime( 
 
        source_row["date"], "%Y-%m-%d").date() 
 
    ts_time = datetime.datetime.strptime( 
 
        source_row["time"], "%H:%M:%S").time() 
 
    return dict( 
 
        date=source_row["date"], 
 
        time=source_row["time"], 
 
        lat=source_row["lat"], 
 
        lon=source_row["lon"], 
 
        lat_lon=( 
 
            float(source_row["lat"]), 
 
            float(source_row["lon"]) 
 
        ), 
 
        ts_date=ts_date, 
 
        ts_time=ts_time, 
 
        timestamp = datetime.datetime.combine( 
 
            ts_date, ts_time 
 
        ) 
 
    )</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.830.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.831.1">clean_row()</span></span></span></span><span class="kobospan" id="kobo.832.1"> function creates several new column values from the raw string data. </span><span class="kobospan" id="kobo.832.2">The column named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.833.1">lat_lon</span></span></span></span><span class="kobospan" id="kobo.834.1"> has a two-tuple with proper floating-point values instead of strings. </span><span class="kobospan" id="kobo.834.2">We’ve also parsed the date and time values to create </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.835.1">datetime.date</span></span></span></span><span class="kobospan" id="kobo.836.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.837.1">datetime.time</span></span></span></span><span class="kobospan" id="kobo.838.1"> objects, respectively. </span><span class="kobospan" id="kobo.838.2">We’ve combined the date and time into a single, useful value, which is the value of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.839.1">timestamp</span></span></span></span><span class="kobospan" id="kobo.840.1"> column.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.841.1">Once we have a row-level function</span><span id="dx1-636032"/><span class="kobospan" id="kobo.842.1"> for cleaning and enriching our data, we can map this function to each row in the source data. </span><span class="kobospan" id="kobo.842.2">We can use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.843.1">map(clean_row,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.844.1"> reader)</span></span></span></span><span class="kobospan" id="kobo.845.1"> or we can write a function that embodies this processing loop:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.846.1">def cleanse(reader: csv.DictReader[str]) -&gt; Iterator[Waypoint]: 
 
    for row in reader: 
 
        yield clean_row(row)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.847.1">This can be used to provide more useful data from each row:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.848.1">def display_clean(data_path: Path) -&gt; None: 
 
    with data_path.open() as data_file: 
 
        data_reader = csv.DictReader(data_file) 
 
        clean_data_reader = cleanse(data_reader) 
 
        for row in clean_data_reader: 
 
            pprint(row)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.849.1">These cleansed and enriched</span><span id="dx1-636044"/><span class="kobospan" id="kobo.850.1"> rows look as follows:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.851.1">&gt;&gt;&gt; data = Path("data") / "waypoints.csv" 
 
&gt;&gt;&gt; display_clean(data) 
 
{’date’: ’2012-11-27’, 
 
 ’lat’: ’32.8321666666667’, 
 
 ’lat_lon’: (32.8321666666667, -79.9338333333333), 
 
 ’lon’: ’-79.9338333333333’, 
 
 ’time’: ’09:15:00’, 
 
 ’timestamp’: datetime.datetime(2012, 11, 27, 9, 15), 
 
 ’ts_date’: datetime.date(2012, 11, 27), 
 
 ’ts_time’: datetime.time(9, 15)} 
 
...</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.852.1">The new columns such as </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.853.1">lat_lon</span></span></span></span><span class="kobospan" id="kobo.854.1"> have proper numeric values instead of strings. </span><span class="kobospan" id="kobo.854.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.855.1">timestamp</span></span></span></span><span class="kobospan" id="kobo.856.1"> value has a full date-time value that can be used for simple computations of elapsed time between waypoints. </span><span id="x1-636057r1356"/></p>
</section>
<section data-number="0.14.3.5" id="see-also-86">
<h2 class="likechapterhead" data-number="0.14.3.5"><span><span class="kobospan" id="kobo.857.1">11.3.5 </span></span> <span id="x1-6370005"/><span class="kobospan" id="kobo.858.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.859.1">See the </span><a href="ch013_split_001.xhtml#x1-5440006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.860.1">Combining the map and reduce transformations</span></span></a><span class="kobospan" id="kobo.861.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.862.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.863.1"> </span></span><a href="ch013_split_000.xhtml#x1-5020009" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.864.1">9</span></span></a><span class="kobospan" id="kobo.865.1"> for more information on the idea of a processing pipeline or stack.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.866.1">See the </span><a href="ch008_split_000.xhtml#x1-2400003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.867.1">Slicing and dicing a list</span></span></a><span class="kobospan" id="kobo.868.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.869.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.870.1"> </span></span><a href="ch008_split_000.xhtml#x1-2240004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.871.1">4</span></span></a><span class="kobospan" id="kobo.872.1">, and the </span><a href="ch013_split_000.xhtml#x1-5180003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.873.1">Using stacked generator expressions</span></span></a><span class="kobospan" id="kobo.874.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.875.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.876.1"> </span></span><a href="ch013_split_000.xhtml#x1-5020009" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.877.1">9</span></span></a><span class="kobospan" id="kobo.878.1">, for more information on processing a CSV file that isn’t in a proper </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.879.1">1NF</span></span><span class="kobospan" id="kobo.880.1">.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.881.1">For more information on the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.882.1">with</span></span></span></span><span class="kobospan" id="kobo.883.1"> statement, see the </span><a href="ch011_split_001.xhtml#x1-43700011" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.884.1">Creating contexts</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.885.1">and context managers</span></span></a><span class="kobospan" id="kobo.886.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.887.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.888.1"> </span></span><a href="ch011_split_000.xhtml#x1-3760007" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.889.1">7</span></span></a><span class="kobospan" id="kobo.890.1">.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.891.1">In </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.892.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.893.1"> </span></span><a href="ch014.xhtml#x1-57300010" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.894.1">10</span></span></a><span class="kobospan" id="kobo.895.1">, a number of recipes use </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.896.1">Pydantic </span></span><span class="kobospan" id="kobo.897.1">to perform these kinds of data conversions. </span><span class="kobospan" id="kobo.897.2">See the </span><a href="ch014.xhtml#x1-6000005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.898.1">Implementing more strict type checks</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.899.1">with Pydantic</span></span></a><span class="kobospan" id="kobo.900.1"> recipe for an example of this alternative approach.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.901.1">See </span><a class="url" href="https://www.packtpub.com/product/learning-pandas-second-edition/9781787123137"><span class="url1"><span class="kobospan" id="kobo.902.1">https://www.packtpub.com/product/learning-pandas-second-edition/9781787123137</span></span></a><span class="kobospan" id="kobo.903.1"> Learning pandas for an approach to CSV files using the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.904.1">pandas </span></span><span class="kobospan" id="kobo.905.1">framework.</span></p></li>
</ul>
<p class="normal1"><span id="x1-637001r1345"/></p>
</section>
</section>
<section data-number="0.14.4" id="using-dataclasses-to-simplify-working-with-csv-files">
<h1 class="unnumbered" data-number="0.14.4"><span><span class="kobospan" id="kobo.906.1">11.4 </span></span> <span id="x1-6380004"/><span class="kobospan" id="kobo.907.1">Using dataclasses to simplify working with CSV files</span></h1>
<p class="normal"><span class="kobospan" id="kobo.908.1">One commonly</span><span id="dx1-638001"/><span class="kobospan" id="kobo.909.1"> used data</span><span id="dx1-638002"/><span class="kobospan" id="kobo.910.1"> format is known</span><span id="dx1-638003"/><span class="kobospan" id="kobo.911.1"> as </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.912.1">Comma-Separated Values</span></span><span class="kobospan" id="kobo.913.1"> (</span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.914.1">CSV</span></span><span class="kobospan" id="kobo.915.1">). </span><span class="kobospan" id="kobo.915.2">Python’s </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.916.1">csv</span></span></span></span><span class="kobospan" id="kobo.917.1"> module has a very handy </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.918.1">DictReader</span></span></span></span><span class="kobospan" id="kobo.919.1"> class definition. </span><span class="kobospan" id="kobo.919.2">When a file contains a one-row header, the header row’s values become keys that are used for all the subsequent rows. </span><span class="kobospan" id="kobo.919.3">This allows a great deal of flexibility in the logical layout of the data. </span><span class="kobospan" id="kobo.919.4">For example, the column ordering doesn’t matter, since each column’s data is identified by a name taken from the header row.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.920.1">Using a dictionary forces us to write, for example, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.921.1">row[’lat’]</span></span></span></span><span class="kobospan" id="kobo.922.1"> or </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.923.1">row[’date’]</span></span></span></span><span class="kobospan" id="kobo.924.1"> to refer to data in specific columns. </span><span class="kobospan" id="kobo.924.2">The built-in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.925.1">dict</span></span></span></span><span class="kobospan" id="kobo.926.1"> class has no provision for derived data. </span><span class="kobospan" id="kobo.926.2">If we switch to a dataclass, we have a number of benefits:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.927.1">Nicer attribute syntax like </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.928.1">row.lat</span></span></span></span><span class="kobospan" id="kobo.929.1"> or </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.930.1">row.date</span></span></span></span><span class="kobospan" id="kobo.931.1">.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.932.1">Derived values can be lazy properties.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.933.1">A frozen dataclass is immutable, and the objects can be keys to dictionaries and members of sets.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.934.1">How can we improve data access and processing using dataclasses? </span><span id="x1-638004r1362"/></p>
<section data-number="0.14.4.1" id="getting-ready-88">
<h2 class="likechapterhead" data-number="0.14.4.1"><span><span class="kobospan" id="kobo.935.1">11.4.1 </span></span> <span id="x1-6390001"/><span class="kobospan" id="kobo.936.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.937.1">We’ll look at a CSV file that has some real-time data recorded from the log of a sailboat. </span><span class="kobospan" id="kobo.937.2">This file is the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.938.1">waypoints.csv</span></span></span></span><span class="kobospan" id="kobo.939.1"> file. </span><span class="kobospan" id="kobo.939.2">For more information, see the </span><a href="ch015_split_000.xhtml#x1-6320003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.940.1">Reading delimited files with the CSV module</span></span></a><span class="kobospan" id="kobo.941.1"> recipe in this chapter. </span><span class="kobospan" id="kobo.941.2">The data looks as follows:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.942.1">lat,lon,date,time 
 
32.8321666666667,-79.9338333333333,2012-11-27,09:15:00 
 
31.6714833333333,-80.93325,2012-11-28,00:00:00 
 
30.7171666666667,-81.5525,2012-11-28,11:35:00</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.943.1">The first line contains a header that names the four columns, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.944.1">lat</span></span></span></span><span class="kobospan" id="kobo.945.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.946.1">lon</span></span></span></span><span class="kobospan" id="kobo.947.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.948.1">date</span></span></span></span><span class="kobospan" id="kobo.949.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.950.1">time</span></span></span></span><span class="kobospan" id="kobo.951.1">. </span><span class="kobospan" id="kobo.951.2">The data can be read by a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.952.1">csv.DictReader</span></span></span></span><span class="kobospan" id="kobo.953.1"> object. </span><span class="kobospan" id="kobo.953.2">We’d like to do more sophisticated work, so we’ll create a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.954.1">@dataclass</span></span></span></span><span class="kobospan" id="kobo.955.1"> class definition encapsulating the data and the processing we need to do. </span><span id="x1-639006r1364"/></p>
</section>
<section data-number="0.14.4.2" id="how-to-do-it...-89">
<h2 class="likechapterhead" data-number="0.14.4.2"><span><span class="kobospan" id="kobo.956.1">11.4.2 </span></span> <span id="x1-6400002"/><span class="kobospan" id="kobo.957.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.958.1">We need to start with a dataclass</span><span id="dx1-640001"/><span class="kobospan" id="kobo.959.1"> that reflects</span><span id="dx1-640002"/><span class="kobospan" id="kobo.960.1"> the available data, and then we can use this dataclass with a dictionary reader:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-640004x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.961.1">Import the definitions from the various libraries that are needed:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.962.1">from dataclasses import dataclass, field 
 
import datetime 
 
from collections.abc import Iterator</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-640010x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.963.1">Define a dataclass narrowly focused on the input, precisely as it appears in the source file. </span><span class="kobospan" id="kobo.963.2">We’ve called the class </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.964.1">RawRow</span></span></span></span><span class="kobospan" id="kobo.965.1">. </span><span class="kobospan" id="kobo.965.2">In a complex application, a more descriptive name than </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.966.1">RawRow</span></span></span></span><span class="kobospan" id="kobo.967.1"> would be appropriate. </span><span class="kobospan" id="kobo.967.2">This definition of the attributes may change as the source file organization changes:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.968.1">@dataclass 
 
class RawRow: 
 
    date: str 
 
    time: str 
 
    lat: str 
 
    lon: str                                                                </span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.969.1">As a practical matter, enterprise file formats are likely to change whenever new software versions are introduced. </span><span class="kobospan" id="kobo.969.2">It’s often helpful to formalize file schema as class definitions to facilitate unit testing and problem resolution when changes occur.</span></p>
</div></li>
<li class="calibre7"><div id="x1-640019x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.970.1">Define a second dataclass where objects are built from the source dataclass attributes. </span><span class="kobospan" id="kobo.970.2">This second class is focused on the real work of the application. </span><span class="kobospan" id="kobo.970.3">The source data is in a single attribute, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.971.1">raw</span></span></span></span><span class="kobospan" id="kobo.972.1">, in this example. </span><span class="kobospan" id="kobo.972.2">Fields computed from this source data are all initialized with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.973.1">field(init=False)</span></span></span></span><span class="kobospan" id="kobo.974.1"> because they’ll be computed after initialization:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.975.1">@dataclass 
 
class Waypoint: 
 
    raw: RawRow 
 
    lat_lon: tuple[float, float] = field(init=False) 
 
    ts_date: datetime.date = field(init=False) 
 
    ts_time: datetime.time = field(init=False) 
 
    timestamp: datetime.datetime = field(init=False)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-640029x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.976.1">Add the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.977.1">__post_init__()</span></span></span></span><span class="kobospan" id="kobo.978.1"> method</span><span id="dx1-640030"/><span class="kobospan" id="kobo.979.1"> to eagerly initialize</span><span id="dx1-640031"/><span class="kobospan" id="kobo.980.1"> all the derived fields:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.981.1">
    def __post_init__(self) -&gt; None: 
 
        self.ts_date = datetime.datetime.strptime( 
 
            self.raw.date, "%Y-%m-%d" 
 
        ).date() 
 
        self.ts_time = datetime.datetime.strptime( 
 
            self.raw.time, "%H:%M:%S" 
 
        ).time() 
 
        self.lat_lon = ( 
 
            float(self.raw.lat), 
 
            float(self.raw.lon) 
 
        ) 
 
        self.timestamp = datetime.datetime.combine( 
 
            self.ts_date, self.ts_time 
 
        )</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-640048x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.982.1">Given these two dataclass definitions, we can create an iterator that will accept individual dictionaries from a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.983.1">csv.DictReader</span></span></span></span><span class="kobospan" id="kobo.984.1"> object and create the needed </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.985.1">Waypoint</span></span></span></span><span class="kobospan" id="kobo.986.1"> objects. </span><span class="kobospan" id="kobo.986.2">The intermediate representation, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.987.1">RawRow</span></span></span></span><span class="kobospan" id="kobo.988.1">, is a convenience so that we can assign attribute names to the source data columns:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.989.1">def waypoint_iter(reader: csv.DictReader[str]) -&gt; Iterator[Waypoint]: 
 
    for row in reader: 
 
        raw = RawRow(**row) 
 
        yield Waypoint(raw)</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.990.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.991.1">waypoint_iter()</span></span></span></span><span class="kobospan" id="kobo.992.1"> function creates </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.993.1">RawRow</span></span></span></span><span class="kobospan" id="kobo.994.1"> objects from the input dictionary, and then creates the final </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.995.1">Waypoint</span></span></span></span><span class="kobospan" id="kobo.996.1"> objects from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.997.1">RawRow</span></span></span></span><span class="kobospan" id="kobo.998.1"> instances. </span><span class="kobospan" id="kobo.998.2">This two-step process is helpful for isolating code changes to the source or the processing.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.999.1">We can use the following function to read and display the CSV data:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1000.1">def display(data_path: Path) -&gt; None: 
 
    with data_path.open() as data_file: 
 
        data_reader = csv.DictReader(data_file) 
 
        for waypoint in waypoint_iter(data_reader): 
 
            pprint(waypoint)</span></code></pre>
<p class="normal1"><span id="x1-640060r1366"/></p>
</section>
<section data-number="0.14.4.3" id="how-it-works...-89">
<h2 class="likechapterhead" data-number="0.14.4.3"><span><span class="kobospan" id="kobo.1001.1">11.4.3 </span></span> <span id="x1-6410003"/><span class="kobospan" id="kobo.1002.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1003.1">The source dataclass, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1004.1">RawRow</span></span></span></span><span class="kobospan" id="kobo.1005.1"> class</span><span id="dx1-641001"/><span class="kobospan" id="kobo.1006.1"> in this example, is designed</span><span id="dx1-641002"/><span class="kobospan" id="kobo.1007.1"> to match the input document. </span><span class="kobospan" id="kobo.1007.2">The field names and types match the CSV input types. </span><span class="kobospan" id="kobo.1007.3">Because the names match, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1008.1">RawRow(**row)</span></span></span></span><span class="kobospan" id="kobo.1009.1"> expression will create an instance of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1010.1">RawRow</span></span></span></span><span class="kobospan" id="kobo.1011.1"> class from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1012.1">DictReader</span></span></span></span><span class="kobospan" id="kobo.1013.1"> dictionary.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1014.1">From this initial, or raw, data, we can derive the more useful data, as shown in the Waypoint class definition. </span><span class="kobospan" id="kobo.1014.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1015.1">__post_init__()</span></span></span></span><span class="kobospan" id="kobo.1016.1"> method transforms the initial value in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1017.1">self.raw</span></span></span></span><span class="kobospan" id="kobo.1018.1"> attribute into a number of more useful attribute values.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1019.1">This separation lets us manage the following two kinds of common changes to application software:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-641004x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1020.1">The source data can change because the spreadsheet was adjusted manually. </span><span class="kobospan" id="kobo.1020.2">This is common: a person may change column names or change the order of the columns.</span></p>
</div></li>
<li class="calibre7"><div id="x1-641006x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1021.1">The required computations may change as the application’s focus expands or shifts. </span><span class="kobospan" id="kobo.1021.2">More derived columns may be added, or the algorithms may change.</span></p>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.1022.1">It’s helpful to disentangle the various aspects of a program so that we can let them evolve independently. </span><span class="kobospan" id="kobo.1022.2">Gathering, cleaning, and filtering source data is one aspect of this separation of concerns. </span><span class="kobospan" id="kobo.1022.3">The resulting computations are a separate aspect, unrelated to the format of the source data. </span><span id="x1-641007r1373"/></p>
</section>
<section data-number="0.14.4.4" id="theres-more...-80">
<h2 class="likechapterhead" data-number="0.14.4.4"><span><span class="kobospan" id="kobo.1023.1">11.4.4 </span></span> <span id="x1-6420004"/><span class="kobospan" id="kobo.1024.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1025.1">In many cases, the source CSV file will have headers that do not map directly to valid Python attribute names. </span><span class="kobospan" id="kobo.1025.2">In these cases, the keys present in the source dictionary must be mapped to the column names. </span><span class="kobospan" id="kobo.1025.3">This can be managed by expanding the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1026.1">RawRow</span></span></span></span><span class="kobospan" id="kobo.1027.1"> class definition to include a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1028.1">@classmethod</span></span></span></span><span class="kobospan" id="kobo.1029.1"> that builds the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1030.1">RawRow</span></span></span></span><span class="kobospan" id="kobo.1031.1"> dataclass object from the source dictionary.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1032.1">The following example defines a class called </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1033.1">RawRow_HeaderV2</span></span></span></span><span class="kobospan" id="kobo.1034.1">. </span><span class="kobospan" id="kobo.1034.2">This definition reflects a variant spreadsheet with different column names in the header:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1035.1">@dataclass 
 
class RawRow_HeaderV2: 
 
    date: str 
 
    time: str 
 
    lat: str 
 
    lon: str 
 
 
 
    @classmethod 
 
    def from_csv(cls, csv_row: dict[str, str]) -&gt; "RawRow_HeaderV2": 
 
        return RawRow_HeaderV2( 
 
            date = csv_row[’Date of Travel (YYYY-MM-DD)’], 
 
            time = csv_row[’Arrival Time (HH:MM:SS)’], 
 
            lat = csv_row[’Latitude (degrees N)’], 
 
            lon = csv_row[’Logitude (degrees W)’],</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1036.1">The instances of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1037.1">RawRow_HeaderV2</span></span></span></span><span class="kobospan" id="kobo.1038.1"> class are built using the expression </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1039.1">RawRow_HeaderV2.from_csv(row)</span></span></span></span><span class="kobospan" id="kobo.1040.1">. </span><span class="kobospan" id="kobo.1040.2">The objects are compatible with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1041.1">RawRow</span></span></span></span><span class="kobospan" id="kobo.1042.1"> class. </span><span class="kobospan" id="kobo.1042.2">Either of these classes of objects can also be transformed into </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1043.1">Waypoint</span></span></span></span><span class="kobospan" id="kobo.1044.1"> instances.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1045.1">For an application that works with a variety of data sources, these kinds of ”raw data transformation” dataclasses can be handy for mapping the minor variations in a logical layout to a consistent internal structure for further processing. </span><span class="kobospan" id="kobo.1045.2">As the number of input transformation classes grows, additional type hints are required. </span><span class="kobospan" id="kobo.1045.3">For example, the following type hint provides a common name for the variations in input format:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1046.1">Raw: TypeAlias = RawRow | RawRow_HeaderV2</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1047.1">This type hint helps to unify the original </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1048.1">RawRow</span></span></span></span><span class="kobospan" id="kobo.1049.1"> and the alternative </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1050.1">RawRow_HeaderV2</span></span></span></span><span class="kobospan" id="kobo.1051.1"> types, which are alternative definitions with compatible features. </span><span class="kobospan" id="kobo.1051.2">The most important feature is the use of generators to process rows individually and avoid creating large list objects with </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1052.1">all </span></span><span class="kobospan" id="kobo.1053.1">of the data. </span><span id="x1-642019r1374"/></p>
</section>
<section data-number="0.14.4.5" id="see-also-87">
<h2 class="likechapterhead" data-number="0.14.4.5"><span><span class="kobospan" id="kobo.1054.1">11.4.5 </span></span> <span id="x1-6430005"/><span class="kobospan" id="kobo.1055.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1056.1">The </span><a href="ch015_split_000.xhtml#x1-6320003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1057.1">Reading delimited files with the CSV module</span></span></a><span class="kobospan" id="kobo.1058.1"> recipe, earlier in this chapter, also covers CSV file reading.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1059.1">In </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1060.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1061.1"> </span></span><a href="ch010.xhtml#x1-3300006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1062.1">6</span></span></a><span class="kobospan" id="kobo.1063.1">, the </span><a href="ch011_split_000.xhtml#x1-4010005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1064.1">Using dataclasses for mutable objects</span></span></a><span class="kobospan" id="kobo.1065.1"> recipe also covers ways to use Python’s dataclasses.</span></p></li>
</ul>
<p class="normal1"><span id="x1-643001r1363"/></p>
</section>
</section>
</section>


<section data-number="0.14" id="chapter-11-inputoutput-physical-format-and-logical-layout">
<section data-number="0.14.5" id="reading-complex-formats-using-regular-expressions">
<h1 class="unnumbered" data-number="0.14.5"><span><span class="kobospan" id="kobo.1066.1">11.5 </span></span> <span id="x1-6440005"/><span class="kobospan" id="kobo.1067.1">Reading complex formats using regular expressions</span></h1>
<p class="normal"><span class="kobospan" id="kobo.1068.1">Many file formats lack the elegant</span><span id="dx1-644001"/><span class="kobospan" id="kobo.1069.1"> regularity of a CSV</span><span id="dx1-644002"/><span class="kobospan" id="kobo.1070.1"> file. </span><span class="kobospan" id="kobo.1070.2">One common file format that’s rather difficult to parse is a web server log file. </span><span class="kobospan" id="kobo.1070.3">These files tend to have complex data without a single, uniform separator character or consistent quoting rules.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1071.1">When we looked at a simplified log file in the </span><a href="ch013_split_000.xhtml#x1-5030001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1072.1">Writing generator functions with</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1073.1">the yield statement</span></span></a><span class="kobospan" id="kobo.1074.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1075.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1076.1"> </span></span><a href="ch013_split_000.xhtml#x1-5020009" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1077.1">9</span></span></a><span class="kobospan" id="kobo.1078.1">, we saw that the rows look as follows:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1079.1">[2016-05-08 11:08:18,651] INFO in ch09_r09: Sample Message One 
 
[2016-05-08 11:08:18,651] DEBUG in ch09_r09: Debugging 
 
[2016-05-08 11:08:18,652] WARNING in ch09_r09: Something might have gone wrong</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1080.1">There are a variety of punctuation marks being used in this file. </span><span class="kobospan" id="kobo.1080.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1081.1">csv</span></span></span></span><span class="kobospan" id="kobo.1082.1"> module can’t parse this complexity.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1083.1">We’d like to write programs with the elegant simplicity of CSV processing. </span><span class="kobospan" id="kobo.1083.2">This means we’ll need to encapsulate the complexities of log file parsing and keep this aspect separate from analysis and summary processing. </span><span id="x1-644007r1377"/></p>
<section data-number="0.14.5.1" id="getting-ready-89">
<h2 class="likechapterhead" data-number="0.14.5.1"><span><span class="kobospan" id="kobo.1084.1">11.5.1 </span></span> <span id="x1-6450001"/><span class="kobospan" id="kobo.1085.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1086.1">Parsing a file with a complex structure generally involves writing a function that behaves somewhat like the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1087.1">reader()</span></span></span></span><span class="kobospan" id="kobo.1088.1"> function in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1089.1">csv</span></span></span></span><span class="kobospan" id="kobo.1090.1"> module. </span><span class="kobospan" id="kobo.1090.2">In some cases, it can be easier to create a small class that behaves like the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1091.1">DictReader</span></span></span></span><span class="kobospan" id="kobo.1092.1"> class.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1093.1">The core feature of reading</span><span id="dx1-645001"/><span class="kobospan" id="kobo.1094.1"> a complex file is a function</span><span id="dx1-645002"/><span class="kobospan" id="kobo.1095.1"> that will transform one line of text into a dictionary or tuple of individual field values. </span><span class="kobospan" id="kobo.1095.2">Parts of this job can often be done by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1096.1">re</span></span></span></span><span class="kobospan" id="kobo.1097.1"> package.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1098.1">Before we can start, we’ll need to develop (and debug) the regular expression that properly parses each line of the input file. </span><span class="kobospan" id="kobo.1098.2">For more information on this, see the </span><a href="ch005_split_000.xhtml#x1-350003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1099.1">String parsing with regular expressions</span></span></a><span class="kobospan" id="kobo.1100.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1101.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1102.1"> </span></span><a href="ch005_split_000.xhtml#x1-170001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1103.1">1</span></span></a><span class="kobospan" id="kobo.1104.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1105.1">For this example, we’ll use the following code. </span><span class="kobospan" id="kobo.1105.2">We’ll define a pattern string with a series of regular expressions for the various elements of the line:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1106.1">import re 
 
 
 
pattern_text = ( 
 
    r"\[(?P&lt;date&gt;.*?)]\s+" 
 
    r"(?P&lt;level&gt;\w+)\s+" 
 
    r"in\s+(?P&lt;module&gt;\S+?)" 
 
    r":\s+(?P&lt;message&gt;.+)" 
 
    ) 
 
 
 
pattern = re.compile(pattern_text, re.X)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1107.1">We’ve used the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1108.1">re.X</span></span></span></span><span class="kobospan" id="kobo.1109.1"> option so that we can include extra whitespace in the regular expression. </span><span class="kobospan" id="kobo.1109.2">This can help to make it more readable by separating prefix and suffix characters.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1110.1">When we write a regular expression, we wrap the interesting sub-strings to capture in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1111.1">()</span></span></span></span><span class="kobospan" id="kobo.1112.1">. </span><span class="kobospan" id="kobo.1112.2">After performing a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1113.1">match()</span></span></span></span><span class="kobospan" id="kobo.1114.1"> or </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1115.1">search()</span></span></span></span><span class="kobospan" id="kobo.1116.1"> operation, the resulting </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1117.1">Match</span></span></span></span><span class="kobospan" id="kobo.1118.1"> object will have the captured text for the matched substrings. </span><span class="kobospan" id="kobo.1118.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1119.1">groups()</span></span></span></span><span class="kobospan" id="kobo.1120.1"> method of a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1121.1">Match</span></span></span></span><span class="kobospan" id="kobo.1122.1"> object and the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1123.1">groupdict()</span></span></span></span><span class="kobospan" id="kobo.1124.1"> method of a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1125.1">Match</span></span></span></span><span class="kobospan" id="kobo.1126.1"> object will provide the captured strings.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1127.1">Here’s how this pattern works:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1128.1">&gt;&gt;&gt; sample_data = ’[2016-05-08 11:08:18,651] INFO in ch10_r09: Sample Message One’ 
 
 
 
&gt;&gt;&gt; match = pattern.match(sample_data) 
 
&gt;&gt;&gt; match.groups() 
 
(’2016-05-08 11:08:18,651’, ’INFO’, ’ch10_r09’, ’Sample Message One’) 
 
 
 
&gt;&gt;&gt; match.groupdict() 
 
{’date’: ’2016-05-08 11:08:18,651’, ’level’: ’INFO’, ’module’: ’ch10_r09’, ’message’: ’Sample Message One’}</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1129.1">We’ve provided a line of sample data in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1130.1">sample_data</span></span></span></span><span class="kobospan" id="kobo.1131.1"> variable. </span><span class="kobospan" id="kobo.1131.2">The resulting </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1132.1">Match</span></span></span></span><span class="kobospan" id="kobo.1133.1"> object has a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1134.1">groups()</span></span></span></span><span class="kobospan" id="kobo.1135.1"> method that returns each of the interesting fields. </span><span class="kobospan" id="kobo.1135.2">The value of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1136.1">groupdict()</span></span></span></span><span class="kobospan" id="kobo.1137.1"> method of a match object is a dictionary, with the name provided in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1138.1">?P&lt;name&gt;</span></span></span></span><span class="kobospan" id="kobo.1139.1"> preface to the regular expression in brackets, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1140.1">()</span></span></span></span><span class="kobospan" id="kobo.1141.1">. </span><span id="x1-645023r1380"/></p>
</section>
<section data-number="0.14.5.2" id="how-to-do-it...-90">
<h2 class="likechapterhead" data-number="0.14.5.2"><span><span class="kobospan" id="kobo.1142.1">11.5.2 </span></span> <span id="x1-6460002"/><span class="kobospan" id="kobo.1143.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1144.1">This recipe is split</span><span id="dx1-646001"/><span class="kobospan" id="kobo.1145.1"> into two mini-recipes. </span><span class="kobospan" id="kobo.1145.2">The first part defines</span><span id="dx1-646002"/><span class="kobospan" id="kobo.1146.1"> a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1147.1">log_parser()</span></span></span></span><span class="kobospan" id="kobo.1148.1"> function to parse a single line, while the second part applies the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1149.1">log_parser()</span></span></span></span><span class="kobospan" id="kobo.1150.1"> function for each line of input.</span></p>
<section data-number="0.14.5.2.1" id="defining-the-parse-function">
<h3 class="likesubsubsectionhead" data-number="0.14.5.2.1"><span id="x1-6470002"/><span class="kobospan" id="kobo.1151.1">Defining the parse function</span></h3>
<p class="normal"><span class="kobospan" id="kobo.1152.1">Perform the following</span><span id="dx1-647001"/><span class="kobospan" id="kobo.1153.1"> steps to define the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1154.1">log_parser()</span></span></span></span><span class="kobospan" id="kobo.1155.1"> function:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-647003x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1156.1">Define the compiled regular expression object:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1157.1">import re 
 
 
 
pattern_text = ( 
 
    r"\[(?P&lt;date&gt;.*?)]\s+" 
 
    r"(?P&lt;level&gt;\w+)\s+" 
 
    r"in\s+(?P&lt;module&gt;\S+?)" 
 
    r":\s+(?P&lt;message&gt;.+)" 
 
    ) 
 
 
 
pattern = re.compile(pattern_text, re.X)                                                                

                                                                     
     </span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-647016x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1158.1">Define a class to model the resulting complex data object. </span><span class="kobospan" id="kobo.1158.2">This can have additional derived properties or other complex computations. </span><span class="kobospan" id="kobo.1158.3">Minimally, a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1159.1">NamedTuple</span></span></span></span><span class="kobospan" id="kobo.1160.1"> must define the fields that are extracted by the parser. </span><span class="kobospan" id="kobo.1160.2">The field names should match the regular expression capture name in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1161.1">(?P&lt;name&gt;...)</span></span></span></span><span class="kobospan" id="kobo.1162.1"> prefix:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1163.1">from typing import NamedTuple 
 
 
 
class LogLine(NamedTuple): 
 
    date: str 
 
    level: str 
 
    module: str 
 
    message: str</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-647026x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1164.1">Define a function that accepts a line</span><span id="dx1-647027"/><span class="kobospan" id="kobo.1165.1"> of text as an argument and produces a parsed </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1166.1">LogLine</span></span></span></span><span class="kobospan" id="kobo.1167.1"> instance:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1168.1">def log_parser(source_line: str) -&gt; LogLine:</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-647031x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1169.1">Apply the regular expression to create a match object. </span><span class="kobospan" id="kobo.1169.2">We’ve assigned it to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1170.1">match</span></span></span></span><span class="kobospan" id="kobo.1171.1"> variable and also checked to see it is not </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1172.1">None</span></span></span></span><span class="kobospan" id="kobo.1173.1">:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1174.1">    if match := pattern.match(source_line):</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-647035x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1175.1">When the value of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1176.1">match</span></span></span></span><span class="kobospan" id="kobo.1177.1"> is not </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1178.1">None</span></span></span></span><span class="kobospan" id="kobo.1179.1">, return a useful data structure with the various pieces of data from this input line:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1180.1">        data = match.groupdict() 
 
        return LogLine(**data)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-647040x6" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1181.1">When the match is </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1182.1">None</span></span></span></span><span class="kobospan" id="kobo.1183.1">, either log</span><span id="dx1-647041"/><span class="kobospan" id="kobo.1184.1"> the problem or raise an exception to stop processing:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1185.1">    raise ValueError(f"Unexpected input {source_line=}")</span></code></pre>
</div></li>
</ol>
</section>
<section data-number="0.14.5.2.2" id="using-the-log_parser-function">
<h3 class="likesubsubsectionhead" data-number="0.14.5.2.2"><span id="x1-6480002"/><span class="kobospan" id="kobo.1186.1">Using the log_parser() function</span></h3>
<p class="normal"><span class="kobospan" id="kobo.1187.1">This portion of the recipe</span><span id="dx1-648001"/><span class="kobospan" id="kobo.1188.1"> will apply the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1189.1">log_parser()</span></span></span></span><span class="kobospan" id="kobo.1190.1"> function to each line of the input file:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-648003x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1191.1">From the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1192.1">pathlib</span></span></span></span><span class="kobospan" id="kobo.1193.1"> module, import useful class and function definitions:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1194.1">&gt;&gt;&gt; from pathlib import Path 
 
&gt;&gt;&gt; from pprint import pprint</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-648008x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1195.1">Create the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1196.1">Path</span></span></span></span><span class="kobospan" id="kobo.1197.1"> object that identifies the file:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1198.1">&gt;&gt;&gt; data_path = Path("data") / "sample.log"</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-648012x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1199.1">Use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1200.1">Path</span></span></span></span><span class="kobospan" id="kobo.1201.1"> object to open the file</span><span id="dx1-648013"/><span class="kobospan" id="kobo.1202.1"> in a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1203.1">with</span></span></span></span><span class="kobospan" id="kobo.1204.1"> statement. </span><span class="kobospan" id="kobo.1204.2">Create the log file reader from the open file object, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1205.1">data_file</span></span></span></span><span class="kobospan" id="kobo.1206.1">. </span><span class="kobospan" id="kobo.1206.2">In this case, we’ll use the built-in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1207.1">map()</span></span></span></span><span class="kobospan" id="kobo.1208.1"> function to apply the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1209.1">log_parser()</span></span></span></span><span class="kobospan" id="kobo.1210.1"> function to each line from the source file:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1211.1">&gt;&gt;&gt; with data_path.open() as data_file: 
 
... </span><span class="kobospan" id="kobo.1211.2">    data_reader = map(log_parser, data_file)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-648018x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1212.1">Read (and process) the various rows of data. </span><span class="kobospan" id="kobo.1212.2">For this example, we’ll print each row:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1213.1">... </span><span class="kobospan" id="kobo.1213.2">    for row in data_reader: 
 
... </span><span class="kobospan" id="kobo.1213.3">        pprint(row)</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.1214.1">The output is a series of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1215.1">LogLine</span></span></span></span><span class="kobospan" id="kobo.1216.1"> tuples that looks as follows:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1217.1">LogLine(date=’2016-06-15 17:57:54,715’, level=’INFO’, module=’ch09_r10’, message=’Sample Message One’) 
 
LogLine(date=’2016-06-15 17:57:54,715’, level=’DEBUG’, module=’ch09_r10’, message=’Debugging’) 
 
LogLine(date=’2016-06-15 17:57:54,715’, level=’WARNING’, module=’ch09_r10’, message=’Something might have gone wrong’)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1218.1">We can do more meaningful processing on these tuple instances than we can on a line of raw text. </span><span class="kobospan" id="kobo.1218.2">These allow us to filter the data by severity level, or create a counter based on the module providing</span><span id="dx1-648026"/><span class="kobospan" id="kobo.1219.1"> the message. </span><span id="x1-648027r1383"/></p>
</section>
</section>
<section data-number="0.14.5.3" id="how-it-works...-90">
<h2 class="likechapterhead" data-number="0.14.5.3"><span><span class="kobospan" id="kobo.1220.1">11.5.3 </span></span> <span id="x1-6490003"/><span class="kobospan" id="kobo.1221.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1222.1">This log file is in </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1223.1">First Normal Form </span></span><span class="kobospan" id="kobo.1224.1">(</span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1225.1">1NF</span></span><span class="kobospan" id="kobo.1226.1">): the data is organized into lines</span><span id="dx1-649001"/><span class="kobospan" id="kobo.1227.1"> that represent independent entities</span><span id="dx1-649002"/><span class="kobospan" id="kobo.1228.1"> or events. </span><span class="kobospan" id="kobo.1228.2">Each row</span><span id="dx1-649003"/><span class="kobospan" id="kobo.1229.1"> has a consistent number of attributes or columns, and each column has data that is atomic or can’t be meaningfully decomposed further. </span><span class="kobospan" id="kobo.1229.2">Unlike CSV files, however, this particular format requires a complex regular expression to parse.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1230.1">In our log file example, the timestamp contains a number of individual elements – year, month, day, hour, minute, second, and millisecond – but there’s little value in further decomposing the timestamp. </span><span class="kobospan" id="kobo.1230.2">It’s more helpful to use it as a single </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1231.1">datetime</span></span></span></span><span class="kobospan" id="kobo.1232.1"> object and derive details (like the hour of the day) from this object, rather than assembling individual fields into a new piece of composite data.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1233.1">In a complex log processing application, there may be several varieties of message fields. </span><span class="kobospan" id="kobo.1233.2">It may be necessary to parse these message types using separate patterns. </span><span class="kobospan" id="kobo.1233.3">When we need to do this, it reveals that the various lines in the log aren’t consistent in terms of the format and number of attributes, breaking one of the 1NF assumptions.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1234.1">We’ve generally followed the design pattern from the </span><a href="ch015_split_000.xhtml#x1-6320003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1235.1">Reading delimited files with</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1236.1">the CSV module</span></span></a><span class="kobospan" id="kobo.1237.1"> recipe, so that reading a complex log is nearly identical to reading a simple CSV file. </span><span class="kobospan" id="kobo.1237.2">Indeed, we can see that the primary difference lies in one line of code:</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1238.1">[firstline=93,lastline=93,gobble=8][python]src/ch11/recipe˙05.py</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1239.1">Compare that to the following:</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1240.1">[firstline=95,lastline=95,gobble=8][python]src/ch11/recipe˙05.py</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1241.1">This parallel construct allows us to reuse analysis functions across many input file formats. </span><span class="kobospan" id="kobo.1241.2">This allows us to create a library of tools that can be used on a number of data sources. </span><span class="kobospan" id="kobo.1241.3">It can help to make analytic applications resilient when data sources change. </span><span id="x1-649004r1397"/></p>
</section>
<section data-number="0.14.5.4" id="theres-more...-81">
<h2 class="likechapterhead" data-number="0.14.5.4"><span><span class="kobospan" id="kobo.1242.1">11.5.4 </span></span> <span id="x1-6500004"/><span class="kobospan" id="kobo.1243.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1244.1">One of the most common operations when reading very complex</span><span id="dx1-650001"/><span class="kobospan" id="kobo.1245.1"> files is to rewrite them into an easier-to-process format. </span><span class="kobospan" id="kobo.1245.2">We’ll often want to save data in the CSV format for later processing.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1246.1">Some of this is similar to the </span><a href="ch011_split_001.xhtml#x1-44300012" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1247.1">Managing multiple contexts with multiple resources</span></span></a><span class="kobospan" id="kobo.1248.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1249.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1250.1"> </span></span><a href="ch011_split_000.xhtml#x1-3760007" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1251.1">7</span></span></a><span class="kobospan" id="kobo.1252.1">. </span><span class="kobospan" id="kobo.1252.2">This recipe shows multiple open file-processing contexts. </span><span class="kobospan" id="kobo.1252.3">We’ll read from one file and write to another file.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1253.1">The file writing process looks as follows:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1254.1">import csv 
 
 
 
def copy(data_path: Path) -&gt; None: 
 
    target_path = data_path.with_suffix(".csv") 
 
    with target_path.open("w", newline="") as target_file: 
 
        writer = csv.DictWriter(target_file, LogLine._fields) 
 
        writer.writeheader() 
 
        with data_path.open() as data_file: 
 
            reader = map(log_parser, data_file) 
 
            writer.writerows(row._asdict() for row in reader)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1255.1">The first portion of this script defines a CSV writer for the target file. </span><span class="kobospan" id="kobo.1255.2">The path for the output file, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1256.1">target_path</span></span></span></span><span class="kobospan" id="kobo.1257.1">, is based on the input name, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1258.1">data_path</span></span></span></span><span class="kobospan" id="kobo.1259.1">. </span><span class="kobospan" id="kobo.1259.2">The suffix is changed to </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1260.1">.csv</span></span></span></span><span class="kobospan" id="kobo.1261.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1262.1">The target file is opened with the newline character turned off by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1263.1">newline=’’</span></span></span></span><span class="kobospan" id="kobo.1264.1"> option. </span><span class="kobospan" id="kobo.1264.2">This allows the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1265.1">csv.DictWriter</span></span></span></span><span class="kobospan" id="kobo.1266.1"> class to insert newline characters appropriate for the desired CSV dialect.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1267.1">A </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1268.1">DictWriter</span></span></span></span><span class="kobospan" id="kobo.1269.1"> object is created to write to the given file. </span><span class="kobospan" id="kobo.1269.2">The sequence of column headings is provided by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1270.1">LogLines</span></span></span></span><span class="kobospan" id="kobo.1271.1"> class definition. </span><span class="kobospan" id="kobo.1271.2">This makes sure the output CSV file will contain correct, consistent column names.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1272.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1273.1">writeheader()</span></span></span></span><span class="kobospan" id="kobo.1274.1"> method writes the column names as the first line of output. </span><span class="kobospan" id="kobo.1274.2">This makes reading the file slightly easier because the column names are provided. </span><span class="kobospan" id="kobo.1274.3">The first row of a CSV file can contain an explicit schema definition that shows what data is present.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1275.1">The source file is opened, as shown in the preceding recipe. </span><span class="kobospan" id="kobo.1275.2">Because of the way the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1276.1">csv</span></span></span></span><span class="kobospan" id="kobo.1277.1"> module writers work, we can provide the reader generator expression to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1278.1">writerows()</span></span></span></span><span class="kobospan" id="kobo.1279.1"> method of the writer. </span><span class="kobospan" id="kobo.1279.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1280.1">writerows()</span></span></span></span><span class="kobospan" id="kobo.1281.1"> method will consume all of the data produced by the reader generator. </span><span class="kobospan" id="kobo.1281.2">This will, in turn, consume all the rows produced by the open file.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1282.1">We don’t need to write any explicit </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1283.1">for</span></span></span></span><span class="kobospan" id="kobo.1284.1"> statements to ensure that all of the input rows are processed. </span><span class="kobospan" id="kobo.1284.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1285.1">writerows()</span></span></span></span><span class="kobospan" id="kobo.1286.1"> function makes this guarantee for us.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1287.1">The output file looks as follows:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1288.1">date,level,module,message 
 
"2016-06-15 17:57:54,715",INFO,ch09_r10,Sample Message One 
 
"2016-06-15 17:57:54,715",DEBUG,ch09_r10,Debugging 
 
"2016-06-15 17:57:54,715",WARNING,ch09_r10,Something might have gone wrong</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1289.1">The file has been transformed</span><span id="dx1-650018"/><span class="kobospan" id="kobo.1290.1"> from the rather complex input format into a simpler CSV format, suitable for further analysis and processing. </span><span id="x1-650019r1398"/></p>
</section>
<section data-number="0.14.5.5" id="see-also-88">
<h2 class="likechapterhead" data-number="0.14.5.5"><span><span class="kobospan" id="kobo.1291.1">11.5.5 </span></span> <span id="x1-6510005"/><span class="kobospan" id="kobo.1292.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1293.1">For more information on the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1294.1">with</span></span></span></span><span class="kobospan" id="kobo.1295.1"> statement, see the </span><a href="ch011_split_001.xhtml#x1-43700011" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1296.1">Creating contexts</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1297.1">and context managers</span></span></a><span class="kobospan" id="kobo.1298.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1299.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1300.1"> </span></span><a href="ch011_split_000.xhtml#x1-3760007" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1301.1">7</span></span></a><span class="kobospan" id="kobo.1302.1">.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1303.1">The </span><a href="ch013_split_000.xhtml#x1-5030001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1304.1">Writing generator functions with the yield statement</span></span></a><span class="kobospan" id="kobo.1305.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1306.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1307.1"> </span></span><a href="ch013_split_000.xhtml#x1-5020009" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1308.1">9</span></span></a><span class="kobospan" id="kobo.1309.1"> shows other processing of this log format.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1310.1">In the </span><a href="ch015_split_000.xhtml#x1-6320003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1311.1">Reading delimited files with the CSV module</span></span></a><span class="kobospan" id="kobo.1312.1"> recipe, earlier in this chapter, we looked at other applications of this general design pattern.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1313.1">In the </span><a href="ch015_split_000.xhtml#x1-6380004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1314.1">Using dataclasses to simplify working with CSV files</span></span></a><span class="kobospan" id="kobo.1315.1"> recipe, earlier in this chapter, we looked at other sophisticated CSV processing techniques.</span></p></li>
</ul>
<p class="normal1"><span id="x1-651001r1378"/></p>
</section>
</section>
<section data-number="0.14.6" id="reading-json-and-yaml-documents">
<h1 class="unnumbered" data-number="0.14.6"><span><span class="kobospan" id="kobo.1316.1">11.6 </span></span> <span id="x1-6520006"/><span class="kobospan" id="kobo.1317.1">Reading JSON and YAML documents</span></h1>
<p class="normal"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1318.1">JavaScript Object Notation </span></span><span class="kobospan" id="kobo.1319.1">(</span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1320.1">JSON</span></span><span class="kobospan" id="kobo.1321.1">) is often used for serializing</span><span id="dx1-652001"/><span class="kobospan" id="kobo.1322.1"> data. </span><span class="kobospan" id="kobo.1322.2">For details</span><span id="dx1-652002"/><span class="kobospan" id="kobo.1323.1">, see </span><a class="url" href="http://json.org"><span class="url1"><span class="kobospan" id="kobo.1324.1">http://json.org</span></span></a><span class="kobospan" id="kobo.1325.1">. </span><span class="kobospan" id="kobo.1325.2">Python includes the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1326.1">json</span></span></span></span><span class="kobospan" id="kobo.1327.1"> module in order to serialize and deserialize data in this notation.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1328.1">JSON documents</span><span id="dx1-652003"/><span class="kobospan" id="kobo.1329.1"> are used widely by web applications. </span><span class="kobospan" id="kobo.1329.2">It’s common to exchange data between RESTful web clients and servers using documents in JSON notation. </span><span class="kobospan" id="kobo.1329.3">These two tiers of an application stack communicate via JSON documents sent via the HTTP protocol.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1330.1">The YAML format</span><span id="dx1-652004"/><span class="kobospan" id="kobo.1331.1"> is a more sophisticated and flexible extension to JSON notation. </span><span class="kobospan" id="kobo.1331.2">For</span><span id="dx1-652005"/><span class="kobospan" id="kobo.1332.1"> details, see </span><a class="url" href="https://yaml.org"><span class="url1"><span class="kobospan" id="kobo.1333.1">https://yaml.org</span></span></a><span class="kobospan" id="kobo.1334.1">. </span><span class="kobospan" id="kobo.1334.2">Any JSON document is also a valid YAML document. </span><span class="kobospan" id="kobo.1334.3">The reverse is not true: YAML syntax is more complex and includes constructs that are not valid JSON.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1335.1">To use YAML, an additional module has to be installed:</span></p>
<pre class="programlisting" id="listing-58"><code class="calibre13"><span class="kobospan" id="kobo.1336.1">(cookbook3) % python -m pip install pyyaml</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1337.1">The PyYAML project offers a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1338.1">yaml</span></span></span></span><span class="kobospan" id="kobo.1339.1"> module that is popular</span><span id="dx1-652007"/><span class="kobospan" id="kobo.1340.1"> and works well. </span><span class="kobospan" id="kobo.1340.2">See </span><a class="url" href="https://pypi.org/project/PyYAML/"><span class="url1"><span class="kobospan" id="kobo.1341.1">https://pypi.org/project/PyYAML/</span></span></a><span class="kobospan" id="kobo.1342.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1343.1">In this recipe, we’ll use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1344.1">json</span></span></span></span><span class="kobospan" id="kobo.1345.1"> module to parse JSON format data in Python. </span><span id="x1-652008r1401"/></p>
<section data-number="0.14.6.1" id="getting-ready-90">
<h2 class="likechapterhead" data-number="0.14.6.1"><span><span class="kobospan" id="kobo.1346.1">11.6.1 </span></span> <span id="x1-6530001"/><span class="kobospan" id="kobo.1347.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1348.1">We’ve gathered some sailboat racing results in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1349.1">race_result.json</span></span></span></span><span class="kobospan" id="kobo.1350.1">. </span><span class="kobospan" id="kobo.1350.2">This file contains information on the teams, the legs of the race, and the order in which the various teams finished each individual leg of the race. </span><span class="kobospan" id="kobo.1350.3">JSON handles this complex data elegantly.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1351.1">An overall score can be computed by summing the finish position in each leg: the lowest score is the overall winner. </span><span class="kobospan" id="kobo.1351.2">In some cases, there are null values when a boat did not start, did not finish, or was disqualified from the race.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1352.1">When computing the team’s overall score, the null values are assigned a score of one more than the number of boats in the competition. </span><span class="kobospan" id="kobo.1352.2">If there are seven boats, then the team is given eight points for their failure to finish, a hefty penalty.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1353.1">The data has the following schema. </span><span class="kobospan" id="kobo.1353.2">There are two fields within the overall document:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1354.1">legs</span></span><span class="kobospan" id="kobo.1355.1">: An array of strings that shows the starting port and ending port.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1356.1">teams</span></span><span class="kobospan" id="kobo.1357.1">: An array of objects with details about each team. </span><span class="kobospan" id="kobo.1357.2">Within each </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1358.1">teams</span></span></span></span><span class="kobospan" id="kobo.1359.1"> object, there are several fields of data:</span></p>
<ul class="calibre25">
<li class="calibre12"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1360.1">name</span></span><span class="kobospan" id="kobo.1361.1">: String team name.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1362.1">position</span></span><span class="kobospan" id="kobo.1363.1">: An array of integers</span><span id="dx1-653001"/><span class="kobospan" id="kobo.1364.1"> and nulls with</span><span id="dx1-653002"/><span class="kobospan" id="kobo.1365.1"> a position. </span><span class="kobospan" id="kobo.1365.2">The order of the items in this array matches the order of the items in the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1366.1">legs </span></span><span class="kobospan" id="kobo.1367.1">array.</span></p></li>
</ul></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1368.1">The data looks as follows:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1369.1">{ 
 
  "teams": [ 
 
    { 
 
      "name": "Abu Dhabi Ocean Racing", 
 
      "position": [ 
 
        1, 
 
        3, 
 
        2, 
 
        2, 
 
        1, 
 
        2, 
 
        5, 
 
        3, 
 
        5 
 
      ] 
 
    }, 
 
... 
 
  ], 
 
  "legs": [ 
 
    "ALICANTE - CAPE TOWN", 
 
    "CAPE TOWN - ABU DHABI", 
 
    "ABU DHABI - SANYA", 
 
    "SANYA - AUCKLAND", 
 
    "AUCKLAND - ITAJA\u00cd", 
 
    "ITAJA\u00cd - NEWPORT", 
 
    "NEWPORT - LISBON", 
 
    "LISBON - LORIENT", 
 
    "LORIENT - GOTHENBURG" 
 
  ] 
 
}</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1370.1">We’ve only shown the first team’s details. </span><span class="kobospan" id="kobo.1370.2">There were a total of seven teams in this particular race. </span><span class="kobospan" id="kobo.1370.3">Each team is represented by a Python dictionary, with the team’s name and their history of finish positions on each leg. </span><span class="kobospan" id="kobo.1370.4">For the team shown here, Abu Dhabi Ocean Racing, they finished in first place in the first leg, and then third place in the next leg. </span><span class="kobospan" id="kobo.1370.5">Their worst performance was fifth place in both the seventh and ninth legs of the race, which were the legs from Newport, Rhode Island, USA, to Lisbon, Portugal, and from Lorient, France, to Gothenburg, Sweden.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1371.1">The JSON-formatted data can look like a Python dictionary that contains lists within it. </span><span class="kobospan" id="kobo.1371.2">This overlap between Python syntax and JSON syntax can be thought of as a happy coincidence: it makes it easier to visualize the Python data structure that will be built from the JSON source document.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1372.1">JSON has a small</span><span id="dx1-653034"/><span class="kobospan" id="kobo.1373.1"> set of data</span><span id="dx1-653035"/><span class="kobospan" id="kobo.1374.1"> structures: null, Boolean, number, string, list, and object. </span><span class="kobospan" id="kobo.1374.2">These map to objects of Python types in a very direct way. </span><span class="kobospan" id="kobo.1374.3">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1375.1">json</span></span></span></span><span class="kobospan" id="kobo.1376.1"> module makes the conversions from source text into Python objects for us.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1377.1">One of the strings contains a Unicode escape sequence, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1378.1">\u00cd</span></span></span></span><span class="kobospan" id="kobo.1379.1">, instead of the actual Unicode character Í. </span><span class="kobospan" id="kobo.1379.2">This is a common technique used to encode characters beyond the 128 ASCII characters. </span><span class="kobospan" id="kobo.1379.3">The parser in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1380.1">json</span></span></span></span><span class="kobospan" id="kobo.1381.1"> module handles this for us.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1382.1">In this example, we’ll write a function to disentangle this document and show the team finishes for each leg. </span><span id="x1-653036r1403"/></p>
</section>
<section data-number="0.14.6.2" id="how-to-do-it...-91">
<h2 class="likechapterhead" data-number="0.14.6.2"><span><span class="kobospan" id="kobo.1383.1">11.6.2 </span></span> <span id="x1-6540002"/><span class="kobospan" id="kobo.1384.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1385.1">This recipe will start by importing the necessary modules. </span><span class="kobospan" id="kobo.1385.2">We’ll then use these modules to transform the contents of the file into a useful Python object:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-654002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1386.1">We’ll need the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1387.1">json</span></span></span></span><span class="kobospan" id="kobo.1388.1"> module to parse the text. </span><span class="kobospan" id="kobo.1388.2">We’ll also need a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1389.1">Path</span></span></span></span><span class="kobospan" id="kobo.1390.1"> object to refer to the file:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1391.1">import json 
 
from pathlib import Path</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-654007x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1392.1">Define a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1393.1">race\_summary()</span></span></span></span><span class="kobospan" id="kobo.1394.1"> function to read the JSON document from a given </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1395.1">Path</span></span></span></span><span class="kobospan" id="kobo.1396.1"> instance:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1397.1">def race_summary(source_path: Path) -&gt; None:                                                                

                                                                     
     </span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-654011x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1398.1">Create a Python object by parsing</span><span id="dx1-654012"/><span class="kobospan" id="kobo.1399.1"> the JSON</span><span id="dx1-654013"/><span class="kobospan" id="kobo.1400.1"> document. </span><span class="kobospan" id="kobo.1400.2">It’s often easiest to use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1401.1">source_path.read_text()</span></span></span></span><span class="kobospan" id="kobo.1402.1"> to read the file named by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1403.1">Path</span></span></span></span><span class="kobospan" id="kobo.1404.1"> object. </span><span class="kobospan" id="kobo.1404.2">We provided this string to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1405.1">json.loads()</span></span></span></span><span class="kobospan" id="kobo.1406.1"> function for parsing. </span><span class="kobospan" id="kobo.1406.2">For very large files, an open file can be passed to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1407.1">json.load()</span></span></span></span><span class="kobospan" id="kobo.1408.1"> function:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1409.1">    document = json.loads(source_path.read_text())</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-654017x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1410.1">Display the data: The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1411.1">document</span></span></span></span><span class="kobospan" id="kobo.1412.1"> object contains a dictionary with two keys, teams and legs. </span><span class="kobospan" id="kobo.1412.2">Here’s how we can iterate through each leg, showing the team’s position in the leg:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1413.1">    for n, leg in enumerate(document[’legs’]): 
 
        print(leg) 
 
        for team_finishes in document[’teams’]: 
 
            print( 
 
                team_finishes[’name’], 
 
                team_finishes[’position’][n])</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.1414.1">The data for each team will be a dictionary with two keys: name and position. </span><span class="kobospan" id="kobo.1414.2">We can navigate down into the team details to get the name of the first team:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1415.1">&gt;&gt;&gt; document[’teams’][6][’name’] 
 
’Team Vestas Wind’</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1416.1">We can look inside the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1417.1">legs</span></span></span></span><span class="kobospan" id="kobo.1418.1"> field to see the names of each leg of the race:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1419.1">&gt;&gt;&gt; document[’legs’][5] 
 
’ITAJA - NEWPORT’</span></code></pre>
<p class="normal1"><span id="x1-654031r1405"/></p>
</section>
<section data-number="0.14.6.3" id="how-it-works...-91">
<h2 class="likechapterhead" data-number="0.14.6.3"><span><span class="kobospan" id="kobo.1420.1">11.6.3 </span></span> <span id="x1-6550003"/><span class="kobospan" id="kobo.1421.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1422.1">A JSON document is a data structure</span><span id="dx1-655001"/><span class="kobospan" id="kobo.1423.1"> in JavaScript Object Notation. </span><span class="kobospan" id="kobo.1423.2">JavaScript programs</span><span id="dx1-655002"/><span class="kobospan" id="kobo.1424.1"> can parse the document trivially. </span><span class="kobospan" id="kobo.1424.2">Other languages must do a little more work to translate the JSON to a native data structure.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1425.1">A JSON document contains three kinds</span><span id="dx1-655003"/><span class="kobospan" id="kobo.1426.1"> of structures:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1427.1">Objects that map to Python dictionaries</span></span><span class="kobospan" id="kobo.1428.1">: JSON has a syntax similar to Python: </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1429.1">{"key":</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1430.1"> "value",</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1431.1"> ...}</span></span></span></span><span class="kobospan" id="kobo.1432.1">.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1433.1">Arrays that map to Python lists</span></span><span class="kobospan" id="kobo.1434.1">: JSON syntax uses </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1435.1">[item,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1436.1"> ...]</span></span></span></span><span class="kobospan" id="kobo.1437.1">, which is also similar to Python.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1438.1">Primitive values</span></span><span class="kobospan" id="kobo.1439.1">: There are five classes of values: </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1440.1">string</span></span></span></span><span class="kobospan" id="kobo.1441.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1442.1">number</span></span></span></span><span class="kobospan" id="kobo.1443.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1444.1">true</span></span></span></span><span class="kobospan" id="kobo.1445.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1446.1">false</span></span></span></span><span class="kobospan" id="kobo.1447.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1448.1">null</span></span></span></span><span class="kobospan" id="kobo.1449.1">. </span><span class="kobospan" id="kobo.1449.2">Strings are enclosed in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1450.1">"</span></span></span></span><span class="kobospan" id="kobo.1451.1"> and use a variety of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1452.1">\</span></span></span></span><span class="kobospan" id="kobo.1453.1"> escape sequences, which are similar to Python’s. </span><span class="kobospan" id="kobo.1453.2">Numbers follow the rules for floating-point values. </span><span class="kobospan" id="kobo.1453.3">The other three values are simple literals; these parallel Python’s </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1454.1">True</span></span></span></span><span class="kobospan" id="kobo.1455.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1456.1">False</span></span></span></span><span class="kobospan" id="kobo.1457.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1458.1">None</span></span></span></span><span class="kobospan" id="kobo.1459.1"> literals.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1460.1">As a special case, numbers with no decimal point become Python </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1461.1">int</span></span></span></span><span class="kobospan" id="kobo.1462.1"> objects. </span><span class="kobospan" id="kobo.1462.2">This is an extension of the JSON standard.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1463.1">There is no provision for any other kinds of data. </span><span class="kobospan" id="kobo.1463.2">This means that Python programs must convert complex Python objects into a simpler representation so that they can be serialized in JSON notation.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1464.1">Conversely, we often apply additional conversions to reconstruct complex Python objects from the simplified JSON representation. </span><span class="kobospan" id="kobo.1464.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1465.1">json</span></span></span></span><span class="kobospan" id="kobo.1466.1"> module has places where we can apply additional processing to the simple structures to create more sophisticated Python objects. </span><span id="x1-655004r1412"/></p>
</section>
<section data-number="0.14.6.4" id="theres-more...-82">
<h2 class="likechapterhead" data-number="0.14.6.4"><span><span class="kobospan" id="kobo.1467.1">11.6.4 </span></span> <span id="x1-6560004"/><span class="kobospan" id="kobo.1468.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1469.1">A file, generally, contains a single JSON document. </span><span class="kobospan" id="kobo.1469.2">The JSON standard doesn’t provide an easy way to encode multiple documents in a single file. </span><span class="kobospan" id="kobo.1469.3">If we want to analyze a web log, for example, the original JSON standard may not be the best notation for preserving a huge volume of information.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1470.1">There are common extensions, like Newline</span><span id="dx1-656001"/><span class="kobospan" id="kobo.1471.1"> Delimited JSON ( </span><a class="url" href="http://ndjson.org"><span class="url1"><span class="kobospan" id="kobo.1472.1">http://ndjson.org</span></span></a><span class="kobospan" id="kobo.1473.1">) and JSON Lines, </span><a class="url" href="http://jsonlines.org"><span class="url1"><span class="kobospan" id="kobo.1474.1">http://jsonlines.org</span></span></a><span class="kobospan" id="kobo.1475.1">, to define a way to encode multiple JSON documents into a single file.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1476.1">While these approaches handle collections of documents, there is an additional problem that we often have to tackle: serializaing (and deserializing) complex objects, for example, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1477.1">datetime</span></span></span></span><span class="kobospan" id="kobo.1478.1"> objects.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1479.1">When we represent a Python object’s state as a string of text characters, we’ve serialized the object’s state. </span><span class="kobospan" id="kobo.1479.2">Many Python objects need to be saved in a file or transmitted to another process. </span><span class="kobospan" id="kobo.1479.3">These kinds of transfers require a representation of the object state. </span><span class="kobospan" id="kobo.1479.4">We’ll look at serializing and deserializing separately.</span></p>
<section data-number="0.14.6.4.1" id="serializing-a-complex-data-structure">
<h3 class="likesubsubsectionhead" data-number="0.14.6.4.1"><span id="x1-6570004"/><span class="kobospan" id="kobo.1480.1">Serializing a complex data structure</span></h3>
<p class="normal"><span class="kobospan" id="kobo.1481.1">The serialization to JSON</span><span id="dx1-657001"/><span class="kobospan" id="kobo.1482.1"> works out the best if we create Python objects limited to values of the built-in types </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1483.1">dict</span></span></span></span><span class="kobospan" id="kobo.1484.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1485.1">list</span></span></span></span><span class="kobospan" id="kobo.1486.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1487.1">str</span></span></span></span><span class="kobospan" id="kobo.1488.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1489.1">int</span></span></span></span><span class="kobospan" id="kobo.1490.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1491.1">float</span></span></span></span><span class="kobospan" id="kobo.1492.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1493.1">bool</span></span></span></span><span class="kobospan" id="kobo.1494.1">, and the special type for </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1495.1">None</span></span></span></span><span class="kobospan" id="kobo.1496.1">. </span><span class="kobospan" id="kobo.1496.2">This subset of Python types can be used to build objects the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1497.1">json</span></span></span></span><span class="kobospan" id="kobo.1498.1"> module can serialize and can be used widely by a number of programs, written in different languages.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1499.1">One commonly used data structure that doesn’t serialize easily is the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1500.1">datetime.datetime</span></span></span></span><span class="kobospan" id="kobo.1501.1"> object.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1502.1">Avoiding the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1503.1">TypeError</span></span></span></span><span class="kobospan" id="kobo.1504.1"> exception exceptions when trying to serialize an unusual Python object can be done in one of two ways. </span><span class="kobospan" id="kobo.1504.2">We can either convert the data into a JSON-friendly structure before building the document, or we can add a default type handler to the JSON serialization process that gives us a way to provide a serializable version of the data.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1505.1">To convert a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1506.1">datetime</span></span></span></span><span class="kobospan" id="kobo.1507.1"> object into a string prior to serializing it as JSON, we need to make a change to the underlying data. </span><span class="kobospan" id="kobo.1507.2">It seems awkward to mangle the data or Python’s data types because of a serialization concern.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1508.1">The other technique for serializing complex data is to provide a function that’s used by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1509.1">json</span></span></span></span><span class="kobospan" id="kobo.1510.1"> module during serialization. </span><span class="kobospan" id="kobo.1510.2">This function must convert a complex object into something that can be safely serialized. </span><span class="kobospan" id="kobo.1510.3">In the following example, we’ll convert a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1511.1">datetime</span></span></span></span><span class="kobospan" id="kobo.1512.1"> object into a simple string value:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1513.1">def default_date(object: Any) -&gt; Any: 
 
    match object: 
 
        case datetime.datetime(): 
 
            return {"$date$": object.isoformat()} 
 
    return object</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1514.1">We’ve defined a function, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1515.1">default_date()</span></span></span></span><span class="kobospan" id="kobo.1516.1">, which will apply a special conversion rule to </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1517.1">datetime</span></span></span></span><span class="kobospan" id="kobo.1518.1"> objects. </span><span class="kobospan" id="kobo.1518.2">Any </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1519.1">datetime.datetime</span></span></span></span><span class="kobospan" id="kobo.1520.1"> instance will be replaced with a dictionary with an obvious key – </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1521.1">"$date$"</span></span></span></span><span class="kobospan" id="kobo.1522.1"> – and a string value. </span><span class="kobospan" id="kobo.1522.2">This dictionary can then be serialized by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1523.1">json</span></span></span></span><span class="kobospan" id="kobo.1524.1"> module.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1525.1">We provide this serialization helper function to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1526.1">json.dumps()</span></span></span></span><span class="kobospan" id="kobo.1527.1"> function. </span><span class="kobospan" id="kobo.1527.2">This is done by assigning the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1528.1">default_date()</span></span></span></span><span class="kobospan" id="kobo.1529.1"> function to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1530.1">default</span></span></span></span><span class="kobospan" id="kobo.1531.1"> parameter, as follows:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1532.1">&gt;&gt;&gt; example_date = datetime.datetime(2014, 6, 7, 8, 9, 10) 
 
 
 
&gt;&gt;&gt; document = {’date’: example_date} 
 
&gt;&gt;&gt; print( 
 
... </span><span class="kobospan" id="kobo.1532.2">    json.dumps(document, default=default_date, indent=2) 
 
... </span><span class="kobospan" id="kobo.1532.3">) 
 
{ 
 
  "date": { 
 
    "$date$": "2014-06-07T08:09:10" 
 
  } 
 
}</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1533.1">When the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1534.1">json</span></span></span></span><span class="kobospan" id="kobo.1535.1"> module can’t serialize</span><span id="dx1-657020"/><span class="kobospan" id="kobo.1536.1"> an object, it passes the object to the given default function, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1537.1">default_date()</span></span></span></span><span class="kobospan" id="kobo.1538.1">. </span><span class="kobospan" id="kobo.1538.2">In any given application, we’ll need to expand this function to handle a number of Python object types that we might want to serialize in JSON notation. </span><span class="kobospan" id="kobo.1538.3">If there is no default function provided, an exception</span><span id="dx1-657021"/><span class="kobospan" id="kobo.1539.1"> is raised when an object can’t be serialized.</span></p>
</section>
<section data-number="0.14.6.4.2" id="deserializing-a-complex-data-structure">
<h3 class="likesubsubsectionhead" data-number="0.14.6.4.2"><span id="x1-6580004"/><span class="kobospan" id="kobo.1540.1">Deserializing a complex data structure</span></h3>
<p class="normal"><span class="kobospan" id="kobo.1541.1">When deserializing JSON to create</span><span id="dx1-658001"/><span class="kobospan" id="kobo.1542.1"> Python objects, there’s a </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1543.1">hook </span></span><span class="kobospan" id="kobo.1544.1">that can be used to convert data from a JSON dictionary into a more complex Python object. </span><span class="kobospan" id="kobo.1544.2">This is called </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1545.1">object_hook</span></span></span></span><span class="kobospan" id="kobo.1546.1"> and it is used during processing by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1547.1">json.loads()</span></span></span></span><span class="kobospan" id="kobo.1548.1"> function. </span><span class="kobospan" id="kobo.1548.2">This hook is used to examine each JSON dictionary to see if something else should be created from the dictionary instance.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1549.1">The function we provide will either create a more complex Python object, or it will simply return the original dictionary object unmodified:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1550.1">def as_date(object: dict[str, Any]) -&gt; Any: 
 
    if {’$date$’} == set(object.keys()): 
 
        return datetime.datetime.fromisoformat(object[’$date$’]) 
 
    return object</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1551.1">This function will check each object that’s decoded to see if the object has a single field, and if that single field is named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1552.1">"$date$"</span></span></span></span><span class="kobospan" id="kobo.1553.1">. </span><span class="kobospan" id="kobo.1553.2">If that is the case, the value of the entire object is replaced with a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1554.1">datetime.datetime</span></span></span></span><span class="kobospan" id="kobo.1555.1"> object. </span><span class="kobospan" id="kobo.1555.2">The return type is a union of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1556.1">Any</span></span></span></span><span class="kobospan" id="kobo.1557.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1558.1">dict[str,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1559.1"> Any]</span></span></span></span><span class="kobospan" id="kobo.1560.1"> to reflect the two possible results: either some object or the original dictionary.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1561.1">We provide a function to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1562.1">json.loads()</span></span></span></span><span class="kobospan" id="kobo.1563.1"> function using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1564.1">object_hook</span></span></span></span><span class="kobospan" id="kobo.1565.1"> parameter, as follows:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1566.1">&gt;&gt;&gt; source = ’’’{"date": {"$date$": "2014-06-07T08:09:10"}}’’’ 
 
 
 
&gt;&gt;&gt; json.loads(source, object_hook=as_date) 
 
{’date’: datetime.datetime(2014, 6, 7, 8, 9, 10)}</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1567.1">This parses a very small JSON document. </span><span class="kobospan" id="kobo.1567.2">All objects are provided to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1568.1">as_date()</span></span></span></span><span class="kobospan" id="kobo.1569.1"> object hook. </span><span class="kobospan" id="kobo.1569.2">Of these objects, one dictionary meets the criteria for containing a date. </span><span class="kobospan" id="kobo.1569.3">A Python object is built from the string value</span><span id="dx1-658012"/><span class="kobospan" id="kobo.1570.1"> found in the JSON serialization.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1571.1">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1572.1">Pydantic </span></span><span class="kobospan" id="kobo.1573.1">package offers a number of serialization features. </span><span class="kobospan" id="kobo.1573.2">Recipes are shown in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1574.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1575.1"> </span></span><a href="ch014.xhtml#x1-57300010" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1576.1">10</span></span></a><span class="kobospan" id="kobo.1577.1"> for working with this package. </span><span id="x1-658013r1413"/></p>
</section>
</section>
<section data-number="0.14.6.5" id="see-also-89">
<h2 class="likechapterhead" data-number="0.14.6.5"><span><span class="kobospan" id="kobo.1578.1">11.6.5 </span></span> <span id="x1-6590005"/><span class="kobospan" id="kobo.1579.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1580.1">The </span><a href="ch015_split_001.xhtml#x1-6660008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1581.1">Reading HTML documents</span></span></a><span class="kobospan" id="kobo.1582.1"> recipe, later in this chapter, will show how we prepared this data from an HTML source.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1583.1">The </span><a href="ch014.xhtml#x1-6000005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1584.1">Implementing more strict type checks with Pydantic</span></span></a><span class="kobospan" id="kobo.1585.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1586.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1587.1"> </span></span><a href="ch014.xhtml#x1-57300010" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1588.1">10</span></span></a><span class="kobospan" id="kobo.1589.1"> covers some features of the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1590.1">Pydantic </span></span><span class="kobospan" id="kobo.1591.1">package.</span></p></li>
</ul>
<p class="normal1"><span id="x1-659001r1402"/></p>
</section>
</section>
<section data-number="0.14.7" id="reading-xml-documents">
<h1 class="unnumbered" data-number="0.14.7"><span><span class="kobospan" id="kobo.1592.1">11.7 </span></span> <span id="x1-6600007"/><span class="kobospan" id="kobo.1593.1">Reading XML documents</span></h1>
<p class="normal"><span class="kobospan" id="kobo.1594.1">The XML markup language</span><span id="dx1-660001"/><span class="kobospan" id="kobo.1595.1"> is widely used to represent the state of objects in a serialized form. </span><span class="kobospan" id="kobo.1595.2">For</span><span id="dx1-660002"/><span class="kobospan" id="kobo.1596.1"> details, see </span><a class="url" href="http://www.w3.org/TR/REC-xml/"><span class="url1"><span class="kobospan" id="kobo.1597.1">http://www.w3.org/TR/REC-xml/</span></span></a><span class="kobospan" id="kobo.1598.1">. </span><span class="kobospan" id="kobo.1598.2">Python includes a number of libraries for parsing XML documents.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1599.1">XML is called a markup language because the content of interest is marked with tags, written with a start </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1600.1">&lt;tag&gt;</span></span></span></span><span class="kobospan" id="kobo.1601.1"> and an end </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1602.1">&lt;/tag&gt;</span></span></span></span><span class="kobospan" id="kobo.1603.1">, used to define the structure of the data. </span><span class="kobospan" id="kobo.1603.2">The overall file text includes both the content and the XML markup.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1604.1">Because the markup is intermingled with the text, there are some additional syntax rules that must be used to distinguish markup from text. </span><span class="kobospan" id="kobo.1604.2">A document must use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1605.1">&amp;lt;</span></span></span></span><span class="kobospan" id="kobo.1606.1"> instead of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1607.1">&lt;</span></span></span></span><span class="kobospan" id="kobo.1608.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1609.1">&amp;gt;</span></span></span></span><span class="kobospan" id="kobo.1610.1"> instead of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1611.1">&gt;</span></span></span></span><span class="kobospan" id="kobo.1612.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1613.1">&amp;amp;</span></span></span></span><span class="kobospan" id="kobo.1614.1"> instead of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1615.1">&amp;</span></span></span></span><span class="kobospan" id="kobo.1616.1"> in text. </span><span class="kobospan" id="kobo.1616.2">Additionally, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1617.1">&amp;quot;</span></span></span></span><span class="kobospan" id="kobo.1618.1"> is also used to embed a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1619.1">"</span></span></span></span><span class="kobospan" id="kobo.1620.1"> character in an attribute value. </span><span class="kobospan" id="kobo.1620.2">For the most part, XML parsers will handle this transformation when consuming XML.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1621.1">The example document, then, will have items as follows:</span></p>
<pre class="programlisting" id="listing-59"><code class="calibre13"><span class="kobospan" id="kobo.1622.1">&lt;team&gt;&lt;name&gt;Team SCA&lt;/name&gt;&lt;position&gt;...&lt;/position&gt;&lt;/team&gt;</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1623.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1624.1">&lt;team&gt;</span></span></span></span><span class="kobospan" id="kobo.1625.1"> tag contains the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1626.1">&lt;name&gt;</span></span></span></span><span class="kobospan" id="kobo.1627.1"> tag, which contains the text of the team’s name. </span><span class="kobospan" id="kobo.1627.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1628.1">&lt;position&gt;</span></span></span></span><span class="kobospan" id="kobo.1629.1"> tag contains more data about the team’s finish position in each leg of a race.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1630.1">The overall document forms a large, nested collection of containers. </span><span class="kobospan" id="kobo.1630.2">We can think of a document as a tree with a root tag that contains all the other tags and their embedded content. </span><span class="kobospan" id="kobo.1630.3">Between tags, there can be additional content. </span><span class="kobospan" id="kobo.1630.4">In some applications, the additional content between the ends of tags is entirely whitespace.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1631.1">Here’s the beginning of the document</span><span id="dx1-660004"/><span class="kobospan" id="kobo.1632.1"> we’ll be looking at:</span></p>
<pre class="programlisting" id="listing-60"><code class="calibre13"><span class="kobospan" id="kobo.1633.1">&lt;?xml version="1.0"?&gt; 
 
&lt;results&gt; 
 
    &lt;teams&gt; 
 
        &lt;team&gt; 
 
            &lt;name&gt; 
 
                Abu Dhabi Ocean Racing 
 
            &lt;/name&gt; 
 
            &lt;position&gt; 
 
                &lt;leg n="1"&gt; 
 
                    1 
 
                &lt;/leg&gt; 
 
               ... 
 
            &lt;/position&gt; 
 
            ... 
 
        &lt;/team&gt; 
 
        ... 
 
   &lt;/teams&gt; 
 
    &lt;legs&gt; 
 
        &lt;leg n="1"&gt; 
 
            ALICANTE - CAPE TOWN 
 
        &lt;/leg&gt; 
 
        ... 
 
    &lt;/legs&gt; 
 
&lt;/results&gt;</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1634.1">The top-level container is the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1635.1">&lt;results&gt;</span></span></span></span><span class="kobospan" id="kobo.1636.1"> tag. </span><span class="kobospan" id="kobo.1636.2">Within this is a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1637.1">&lt;teams&gt;</span></span></span></span><span class="kobospan" id="kobo.1638.1"> tag. </span><span class="kobospan" id="kobo.1638.2">Within the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1639.1">&lt;teams&gt;</span></span></span></span><span class="kobospan" id="kobo.1640.1"> tag are many repetitions of data for each individual team, each enclosed in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1641.1">&lt;team&gt;</span></span></span></span><span class="kobospan" id="kobo.1642.1"> tag. </span><span class="kobospan" id="kobo.1642.2">We’ve used </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1643.1">...</span></span></span></span><span class="kobospan" id="kobo.1644.1"> to show where parts of the document were elided.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1645.1">It’s very, very difficult to parse XML with regular expressions. </span><span class="kobospan" id="kobo.1645.2">Regular expressions don’t cope well with the kinds of recursion and repetition present in XML. </span><span class="kobospan" id="kobo.1645.3">We need more sophisticated parsers to handle the syntax of nested tags.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1646.1">There are two binary libraries, part of the modules </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1647.1">xml.sax</span></span></span></span><span class="kobospan" id="kobo.1648.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1649.1">xml.parsers.expat</span></span></span></span><span class="kobospan" id="kobo.1650.1">, to parse XML. </span><span class="kobospan" id="kobo.1650.2">These have the advantage of being very fast.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1651.1">In addition to these, there’s a very sophisticated set of tools in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1652.1">xml.etree</span></span></span></span><span class="kobospan" id="kobo.1653.1"> package. </span><span class="kobospan" id="kobo.1653.2">We’ll focus on using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1654.1">ElementTree</span></span></span></span><span class="kobospan" id="kobo.1655.1"> class in this package to parse and analyze XML documents. </span><span class="kobospan" id="kobo.1655.2">This has the advantage of offering a large number of useful features like XPath searching to find tags in a complicated document. </span><span id="x1-660029r1420"/></p>
<section data-number="0.14.7.1" id="getting-ready-91">
<h2 class="likechapterhead" data-number="0.14.7.1"><span><span class="kobospan" id="kobo.1656.1">11.7.1 </span></span> <span id="x1-6610001"/><span class="kobospan" id="kobo.1657.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1658.1">We’ve gathered some sailboat</span><span id="dx1-661001"/><span class="kobospan" id="kobo.1659.1"> racing results in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1660.1">race_result.xml</span></span></span></span><span class="kobospan" id="kobo.1661.1">. </span><span class="kobospan" id="kobo.1661.2">This file contains information on teams, legs, and the order in which the various teams finished each leg. </span><span class="kobospan" id="kobo.1661.3">For more information on this data, see the </span><a href="ch015_split_001.xhtml#x1-6520006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1662.1">Reading JSON and</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1663.1">YAML documents</span></span></a><span class="kobospan" id="kobo.1664.1"> recipe in this chapter.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1665.1">The root tag for this data is a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1666.1">&lt;results&gt;</span></span></span></span><span class="kobospan" id="kobo.1667.1"> document. </span><span class="kobospan" id="kobo.1667.2">This has the following schema:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1668.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1669.1">&lt;legs&gt;</span></span></span></span><span class="kobospan" id="kobo.1670.1"> tag contains individual </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1671.1">&lt;leg&gt;</span></span></span></span><span class="kobospan" id="kobo.1672.1"> tags that name each leg of the race. </span><span class="kobospan" id="kobo.1672.2">Each </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1673.1">&lt;leg&gt;</span></span></span></span><span class="kobospan" id="kobo.1674.1"> tag will contain both a starting port and an ending port in the text.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1675.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1676.1">&lt;teams&gt;</span></span></span></span><span class="kobospan" id="kobo.1677.1"> tag contains a number of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1678.1">&lt;team&gt;</span></span></span></span><span class="kobospan" id="kobo.1679.1"> tags with details of each team. </span><span class="kobospan" id="kobo.1679.2">Each team has data structured with internal tags:</span></p>
<ul class="calibre25">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1680.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1681.1">&lt;name&gt;</span></span></span></span><span class="kobospan" id="kobo.1682.1"> tag contains the team name.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1683.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1684.1">&lt;position&gt;</span></span></span></span><span class="kobospan" id="kobo.1685.1"> tag contains a number of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1686.1">&lt;leg&gt;</span></span></span></span><span class="kobospan" id="kobo.1687.1"> tags with the finish position for the given leg. </span><span class="kobospan" id="kobo.1687.2">Each leg is numbered, and the numbering matches the leg definitions in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1688.1">&lt;legs&gt;</span></span></span></span><span class="kobospan" id="kobo.1689.1"> tag.</span></p></li>
</ul></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1690.1">In XML notation, the application data shows up in two kinds of places. </span><span class="kobospan" id="kobo.1690.2">The first is between the start and the end tags – for example, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1691.1">&lt;name&gt;Abu</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1692.1"> Dhabi</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1693.1"> Ocean</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1694.1"> Racing&lt;/name&gt;</span></span></span></span><span class="kobospan" id="kobo.1695.1">, has text, ”Abu Dhabi Ocean Racing”, as well as </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1696.1">&lt;name&gt;</span></span></span></span><span class="kobospan" id="kobo.1697.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1698.1">&lt;/name&gt;</span></span></span></span><span class="kobospan" id="kobo.1699.1"> tags.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1700.1">Also, data will also show up as an attribute of a tag; for example, in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1701.1">&lt;leg</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1702.1"> n="1"&gt;</span></span></span></span><span class="kobospan" id="kobo.1703.1">. </span><span class="kobospan" id="kobo.1703.2">The tag is </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1704.1">&lt;leg&gt;</span></span></span></span><span class="kobospan" id="kobo.1705.1">, with an attribute, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1706.1">n</span></span></span></span><span class="kobospan" id="kobo.1707.1">, with a value of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1708.1">"1"</span></span></span></span><span class="kobospan" id="kobo.1709.1">. </span><span class="kobospan" id="kobo.1709.2">A tag can have an indefinite number of attributes.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1710.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1711.1">&lt;leg&gt;</span></span></span></span><span class="kobospan" id="kobo.1712.1"> tags point out an interesting problem with XML. </span><span class="kobospan" id="kobo.1712.2">These tags include the leg number given as an attribute, while the position for the leg is given as the text inside the tag. </span><span class="kobospan" id="kobo.1712.3">There’s no real pattern or preference to where useful data is located. </span><span class="kobospan" id="kobo.1712.4">Ideally, it’s always between tags, but that’s not generally true.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1713.1">XML permits a </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1714.1">mixed content model</span></span><span class="kobospan" id="kobo.1715.1">. </span><span class="kobospan" id="kobo.1715.2">This reflects the case</span><span id="dx1-661002"/><span class="kobospan" id="kobo.1716.1"> where XML is mixed in with text and there is text inside and outside XML tags. </span><span class="kobospan" id="kobo.1716.2">Here’s an example of mixed content:</span></p>
<pre class="programlisting" id="listing-61"><code class="calibre13"><span class="kobospan" id="kobo.1717.1">&lt;p&gt; 
 
This has &lt;strong&gt;mixed&lt;/strong&gt; content. 
 
&lt;/p&gt;</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1718.1">The content of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1719.1">&lt;p&gt;</span></span></span></span><span class="kobospan" id="kobo.1720.1"> tag is a mixture of text and a tag. </span><span class="kobospan" id="kobo.1720.2">The data we’re working with in this recipe does not rely on this kind of mixed content model, meaning all the data is within a single tag or an attribute of a tag. </span><span class="kobospan" id="kobo.1720.3">The whitespace between tags can be ignored. </span><span id="x1-661006r1422"/></p>
</section>
<section data-number="0.14.7.2" id="how-to-do-it...-92">
<h2 class="likechapterhead" data-number="0.14.7.2"><span><span class="kobospan" id="kobo.1721.1">11.7.2 </span></span> <span id="x1-6620002"/><span class="kobospan" id="kobo.1722.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1723.1">We’ll define a function to convert</span><span id="dx1-662001"/><span class="kobospan" id="kobo.1724.1"> the XML document to a dictionary with leg descriptions and team results:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-662003x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1725.1">We’ll need the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1726.1">xml.etree</span></span></span></span><span class="kobospan" id="kobo.1727.1"> module to parse the XML text. </span><span class="kobospan" id="kobo.1727.2">We’ll also need a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1728.1">Path</span></span></span></span><span class="kobospan" id="kobo.1729.1"> object to refer to the file. </span><span class="kobospan" id="kobo.1729.2">We’ve assigned a shorter name of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1730.1">XML</span></span></span></span><span class="kobospan" id="kobo.1731.1"> to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1732.1">ElementTree</span></span></span></span><span class="kobospan" id="kobo.1733.1"> class:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1734.1">import xml.etree.ElementTree as XML 
 
from pathlib import Path 
 
from typing import cast</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1735.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1736.1">cast()</span></span></span></span><span class="kobospan" id="kobo.1737.1"> function is needed to force tools like </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1738.1">mypy </span></span><span class="kobospan" id="kobo.1739.1">to treat the result as if it were a given type. </span><span class="kobospan" id="kobo.1739.2">This lets us ignore the possibility of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1740.1">None</span></span></span></span><span class="kobospan" id="kobo.1741.1"> results.</span></p>
</div></li>
<li class="calibre7"><div id="x1-662009x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1742.1">Define a function to read the XML document from a given </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1743.1">Path</span></span></span></span><span class="kobospan" id="kobo.1744.1"> instance:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1745.1">def race_summary(source_path: Path) -&gt; None:</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-662013x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1746.1">Create a Python </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1747.1">ElementTree</span></span></span></span><span class="kobospan" id="kobo.1748.1"> object by parsing the XML text. </span><span class="kobospan" id="kobo.1748.2">It’s often easiest to use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1749.1">source_path.read_text()</span></span></span></span><span class="kobospan" id="kobo.1750.1"> to read the file named by path. </span><span class="kobospan" id="kobo.1750.2">We provided this string to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1751.1">XML.fromstring()</span></span></span></span><span class="kobospan" id="kobo.1752.1"> method for parsing. </span><span class="kobospan" id="kobo.1752.2">For very large files, an incremental parser is sometimes more helpful. </span><span class="kobospan" id="kobo.1752.3">Here’s the version for smaller files:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1753.1">    source_text = source_path.read_text(encoding=’UTF-8’) 
 
    document = XML.fromstring(source_text)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-662018x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1754.1">Display the data. </span><span class="kobospan" id="kobo.1754.2">The XML element</span><span id="dx1-662019"/><span class="kobospan" id="kobo.1755.1"> objects has two useful methods for navigating the XML structure, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1756.1">find()</span></span></span></span><span class="kobospan" id="kobo.1757.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1758.1">findall()</span></span></span></span><span class="kobospan" id="kobo.1759.1"> methods, to locate the first instance of a tag and locate all instances of a tag, respectively. </span><span class="kobospan" id="kobo.1759.2">Using these, we can create a dictionary with two keys, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1760.1">"teams"</span></span></span></span><span class="kobospan" id="kobo.1761.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1762.1">"legs"</span></span></span></span><span class="kobospan" id="kobo.1763.1">:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1764.1">    legs = cast(XML.Element, document.find(’legs’)) 
 
    teams = cast(XML.Element, document.find(’teams’)) 
 
    for leg in legs.findall(’leg’): 
 
        print(cast(str, leg.text).strip()) 
 
        n = leg.attrib[’n’] 
 
        for team in teams.findall(’team’): 
 
            position_leg = cast(XML.Element, 
 
                team.find(f"position/leg[@n=’{n}’]")) 
 
            name = cast(XML.Element, team.find(’name’)) 
 
            print( 
 
                cast(str, name.text).strip(), 
 
                cast(str, position_leg.text).strip() 
 
            )</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1765.1">Within the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1766.1">&lt;legs&gt;</span></span></span></span><span class="kobospan" id="kobo.1767.1"> tag, there are a number of individual </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1768.1">&lt;leg&gt;</span></span></span></span><span class="kobospan" id="kobo.1769.1"> tags. </span><span class="kobospan" id="kobo.1769.2">Each of those tags has the following structure:</span></p>
<pre class="programlisting" id="listing-62"><code class="calibre13"><span class="kobospan" id="kobo.1770.1">&lt;leg n="1"&gt;ALICANTE - CAPE TOWN&lt;/leg&gt;</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1771.1">The Python expression </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1772.1">leg.attrib[’n’]</span></span></span></span><span class="kobospan" id="kobo.1773.1"> extracts the value of the attribute named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1774.1">n</span></span></span></span><span class="kobospan" id="kobo.1775.1"> from the given element. </span><span class="kobospan" id="kobo.1775.2">The expression </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1776.1">leg.text.strip()</span></span></span></span><span class="kobospan" id="kobo.1777.1"> will find all the text within the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1778.1">&lt;leg&gt;</span></span></span></span><span class="kobospan" id="kobo.1779.1"> tag, stripped of extra whitespace.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1780.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1781.1">find()</span></span></span></span><span class="kobospan" id="kobo.1782.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1783.1">findall()</span></span></span></span><span class="kobospan" id="kobo.1784.1"> methods of an element use XPath notation to locate tags. </span><span class="kobospan" id="kobo.1784.2">We’ll examine the features in detail in the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1785.1">There’s more...</span></span><span class="kobospan" id="kobo.1786.1"> section of this recipe.</span></p>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.1787.1">It’s important to note that the results of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1788.1">find()</span></span></span></span><span class="kobospan" id="kobo.1789.1"> function have a type hint of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1790.1">XML.Element</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1791.1"> |</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1792.1"> None</span></span></span></span><span class="kobospan" id="kobo.1793.1">. </span><span class="kobospan" id="kobo.1793.2">We have two choices for handling the possibility of a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1794.1">None</span></span></span></span><span class="kobospan" id="kobo.1795.1"> result:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1796.1">Use an </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1797.1">if</span></span></span></span><span class="kobospan" id="kobo.1798.1"> statement to handle the cases where the result is </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1799.1">None</span></span></span></span><span class="kobospan" id="kobo.1800.1">.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1801.1">Use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1802.1">cast(XML.Element,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1803.1"> tag.find(...))</span></span></span></span><span class="kobospan" id="kobo.1804.1"> to claim that the result is never going to be </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1805.1">None</span></span></span></span><span class="kobospan" id="kobo.1806.1">. </span><span class="kobospan" id="kobo.1806.2">If the tag is missing, the exception raised will help diagnose the mismatch between the source document and processing expectations by our consumer application.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1807.1">For each leg of the race, we need to print the finish positions, which are contained within the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1808.1">&lt;teams&gt;</span></span></span></span><span class="kobospan" id="kobo.1809.1"> tag. </span><span class="kobospan" id="kobo.1809.2">Within this tag, we need to find the proper </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1810.1">&lt;leg&gt;</span></span></span></span><span class="kobospan" id="kobo.1811.1"> tag with the finish position for this team on the given leg. </span><span class="kobospan" id="kobo.1811.2">For this, we use a complex XPath search, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1812.1">f"position/leg[@n=’{n}’]"</span></span></span></span><span class="kobospan" id="kobo.1813.1">, to locate a specific instance of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1814.1">&lt;position&gt;</span></span></span></span><span class="kobospan" id="kobo.1815.1"> tag based on the presence of a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1816.1">&lt;leg&gt;</span></span></span></span><span class="kobospan" id="kobo.1817.1"> tag with a specific attribute value. </span><span class="kobospan" id="kobo.1817.2">The value of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1818.1">n</span></span></span></span><span class="kobospan" id="kobo.1819.1"> is the leg number. </span><span class="kobospan" id="kobo.1819.2">For the ninth leg, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1820.1">n=9</span></span></span></span><span class="kobospan" id="kobo.1821.1">, the f-string will be </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1822.1">"position/leg[@n=’9’]"</span></span></span></span><span class="kobospan" id="kobo.1823.1">. </span><span class="kobospan" id="kobo.1823.2">This will locate the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1824.1">&lt;position&gt;</span></span></span></span><span class="kobospan" id="kobo.1825.1"> tag containing a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1826.1">&lt;leg&gt;</span></span></span></span><span class="kobospan" id="kobo.1827.1"> tag that has an attribute </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1828.1">n</span></span></span></span><span class="kobospan" id="kobo.1829.1"> equal to 9.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1830.1">Because XML supports a mixed content</span><span id="dx1-662035"/><span class="kobospan" id="kobo.1831.1"> model, all the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1832.1">\n</span></span></span></span><span class="kobospan" id="kobo.1833.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1834.1">\t</span></span></span></span><span class="kobospan" id="kobo.1835.1">, and space characters in the content are perfectly preserved by the parsing operation. </span><span class="kobospan" id="kobo.1835.2">We rarely want any of this whitespace, and it makes sense to use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1836.1">strip()</span></span></span></span><span class="kobospan" id="kobo.1837.1"> method to remove any extraneous characters before and after the meaningful content. </span><span id="x1-662036r1423"/></p>
</section>
<section data-number="0.14.7.3" id="how-it-works...-92">
<h2 class="likechapterhead" data-number="0.14.7.3"><span><span class="kobospan" id="kobo.1838.1">11.7.3 </span></span> <span id="x1-6630003"/><span class="kobospan" id="kobo.1839.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1840.1">The XML parser modules transform XML documents into a fairly complex tree structure based on a standardized </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1841.1">Document Object Model </span></span><span class="kobospan" id="kobo.1842.1">(</span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1843.1">DOM</span></span><span class="kobospan" id="kobo.1844.1">). </span><span class="kobospan" id="kobo.1844.2">In the case of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1845.1">xml.etree</span></span></span></span><span class="kobospan" id="kobo.1846.1"> module, the document will be built from </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1847.1">Element</span></span></span></span><span class="kobospan" id="kobo.1848.1"> objects, which generally represent tags and text.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1849.1">XML can also include processing instructions and comments. </span><span class="kobospan" id="kobo.1849.2">We’ll ignore them and focus on the document structure and content here.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1850.1">Each </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1851.1">Element</span></span></span></span><span class="kobospan" id="kobo.1852.1"> instance has the text of the tag, the text within the tag, attributes that are part of the tag, and a tail. </span><span class="kobospan" id="kobo.1852.2">The tag is the name inside </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1853.1">&lt;tag&gt;</span></span></span></span><span class="kobospan" id="kobo.1854.1">. </span><span class="kobospan" id="kobo.1854.2">The attributes are the fields that follow the tag name, for example, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1855.1">&lt;leg</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1856.1"> n="1"&gt;</span></span></span></span><span class="kobospan" id="kobo.1857.1"> tag has a tag name of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1858.1">leg</span></span></span></span><span class="kobospan" id="kobo.1859.1"> and an attribute named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1860.1">n</span></span></span></span><span class="kobospan" id="kobo.1861.1">. </span><span class="kobospan" id="kobo.1861.2">Values are always strings in XML; any conversion to a different data type is the responsibility of the application using the data.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1862.1">The text is contained between the start and end of a tag. </span><span class="kobospan" id="kobo.1862.2">Therefore, a tag such as </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1863.1">&lt;name&gt;Team</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1864.1"> SCA&lt;/name&gt;</span></span></span></span><span class="kobospan" id="kobo.1865.1"> has </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1866.1">"Team</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1867.1"> SCA"</span></span></span></span><span class="kobospan" id="kobo.1868.1"> for the value of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1869.1">text</span></span></span></span><span class="kobospan" id="kobo.1870.1"> attribute of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1871.1">Element</span></span></span></span><span class="kobospan" id="kobo.1872.1"> that represents the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1873.1">&lt;name&gt;</span></span></span></span><span class="kobospan" id="kobo.1874.1"> tag.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1875.1">Note that a tag also has a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1876.1">tail</span></span></span></span><span class="kobospan" id="kobo.1877.1"> attribute. </span><span class="kobospan" id="kobo.1877.2">Consider this sequence of two tags:</span></p>
<pre class="programlisting" id="listing-63"><code class="calibre13"><span class="kobospan" id="kobo.1878.1">&lt;name&gt;Team SCA&lt;/name&gt; 
 
&lt;position&gt;...&lt;/position&gt;</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1879.1">There’s a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1880.1">\n</span></span></span></span><span class="kobospan" id="kobo.1881.1"> whitespace character after the closing </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1882.1">&lt;/name&gt;</span></span></span></span><span class="kobospan" id="kobo.1883.1"> tag and before the opening of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1884.1">&lt;position&gt;</span></span></span></span><span class="kobospan" id="kobo.1885.1"> tag. </span><span class="kobospan" id="kobo.1885.2">This extra text is collected into the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1886.1">tail</span></span></span></span><span class="kobospan" id="kobo.1887.1"> attribute of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1888.1">&lt;name&gt;</span></span></span></span><span class="kobospan" id="kobo.1889.1"> tag. </span><span class="kobospan" id="kobo.1889.2">These tail values can be important when working with a mixed content model. </span><span class="kobospan" id="kobo.1889.3">The tail values are generally whitespace</span><span id="dx1-663003"/><span class="kobospan" id="kobo.1890.1"> when working in an element content model. </span><span id="x1-663004r1428"/></p>
</section>
<section data-number="0.14.7.4" id="theres-more...-83">
<h2 class="likechapterhead" data-number="0.14.7.4"><span><span class="kobospan" id="kobo.1891.1">11.7.4 </span></span> <span id="x1-6640004"/><span class="kobospan" id="kobo.1892.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1893.1">Because we can’t trivially translate an XML document into a Python dictionary, we need a handy way to search through the document’s content. </span><span class="kobospan" id="kobo.1893.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1894.1">ElementTree</span></span></span></span><span class="kobospan" id="kobo.1895.1"> class provides a search technique</span><span id="dx1-664001"/><span class="kobospan" id="kobo.1896.1"> that’s a partial implementation of the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1897.1">XML Path Language </span></span><span class="kobospan" id="kobo.1898.1">(</span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1899.1">XPath</span></span><span class="kobospan" id="kobo.1900.1">) for specifying a location in an XML document. </span><span class="kobospan" id="kobo.1900.2">The XPath notation gives us considerable flexibility.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1901.1">The XPath queries are used with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1902.1">find()</span></span></span></span><span class="kobospan" id="kobo.1903.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1904.1">findall()</span></span></span></span><span class="kobospan" id="kobo.1905.1"> methods. </span><span class="kobospan" id="kobo.1905.2">Here’s how we can find all of the team names:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1906.1">&gt;&gt;&gt; for tag in document.findall(’teams/team/name’): 
 
... </span><span class="kobospan" id="kobo.1906.2">    print(tag.text.strip()) 
 
Abu Dhabi Ocean Racing 
 
Team Brunel 
 
Dongfeng Race Team 
 
MAPFRE 
 
Team Alvimedica 
 
Team SCA 
 
Team Vestas Wind</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1907.1">The XPath query looks for the top-level </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1908.1">&lt;teams&gt;</span></span></span></span><span class="kobospan" id="kobo.1909.1"> tag. </span><span class="kobospan" id="kobo.1909.2">Within that tag, we want </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1910.1">&lt;team&gt;</span></span></span></span><span class="kobospan" id="kobo.1911.1"> tags. </span><span class="kobospan" id="kobo.1911.2">Within those tags, we want the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1912.1">&lt;name&gt;</span></span></span></span><span class="kobospan" id="kobo.1913.1"> tags. </span><span class="kobospan" id="kobo.1913.2">This will search for all the instances of this nested tag structure. </span><span id="x1-664012r1429"/></p>
</section>
<section data-number="0.14.7.5" id="see-also-90">
<h2 class="likechapterhead" data-number="0.14.7.5"><span><span class="kobospan" id="kobo.1914.1">11.7.5 </span></span> <span id="x1-6650005"/><span class="kobospan" id="kobo.1915.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1916.1">There are a number of security issues related to XML documents. </span><span class="kobospan" id="kobo.1916.2">See the OWASP </span><a href="https://cheatsheetseries.owasp.org/cheatsheets/XML_Security_Cheat_Sheet.html" class="url"><span class="kobospan" id="kobo.1917.1">XML Security Cheat Sheet</span></a><span class="kobospan" id="kobo.1918.1"> for more information.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1919.1">The </span><a href="https://pypi.org/project/lxml/" class="url"><span class="kobospan" id="kobo.1920.1">lxml</span></a><span class="kobospan" id="kobo.1921.1"> library extends the core features of the element tree library, offering additional capabilities.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1922.1">The </span><a href="ch015_split_001.xhtml#x1-6660008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1923.1">Reading HTML documents</span></span></a><span class="kobospan" id="kobo.1924.1"> recipe, later in this chapter, shows how we prepared this data from an HTML source.</span></p></li>
</ul>
<p class="normal1"><span id="x1-665001r1421"/></p>
</section>
</section>
<section data-number="0.14.8" id="reading-html-documents">
<h1 class="unnumbered" data-number="0.14.8"><span><span class="kobospan" id="kobo.1925.1">11.8 </span></span> <span id="x1-6660008"/><span class="kobospan" id="kobo.1926.1">Reading HTML documents</span></h1>
<p class="normal"><span class="kobospan" id="kobo.1927.1">A great deal of content</span><span id="dx1-666001"/><span class="kobospan" id="kobo.1928.1"> on the web is presented using HTML. </span><span class="kobospan" id="kobo.1928.2">A browser renders the data very nicely. </span><span class="kobospan" id="kobo.1928.3">We can write applications to extract content from HTML pages.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1929.1">Parsing HTML involves two complications:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1930.1">Ancient HTML dialects that are distinct from modern XML</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1931.1">Browsers that tolerate HTML that’s incorrect and create a proper display</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1932.1">The first complication is the history of HTML and XML. </span><span class="kobospan" id="kobo.1932.2">Modern HTML is a specific document type of XML. </span><span class="kobospan" id="kobo.1932.3">Historically, HTML started with its own unique document type definitions, based on the older SGML. </span><span class="kobospan" id="kobo.1932.4">These original SGML/HTML concepts were revised and extended to create a new language, XML. </span><span class="kobospan" id="kobo.1932.5">During the transition from legacy HTML to XML-based HTML, web servers provided content using a variety of transitional document type definitions. </span><span class="kobospan" id="kobo.1932.6">Most modern web servers use a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1933.1">&lt;DOCTYPE</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1934.1"> html&gt;</span></span></span></span><span class="kobospan" id="kobo.1935.1"> preamble to state that the document is properly structured XML syntax, using the HTML document model. </span><span class="kobospan" id="kobo.1935.2">Some web servers will use other DOCTYPE references in the preamble and provide HTML that’s not proper XML.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1936.1">A further complication to parsing HTML is the design of browsers. </span><span class="kobospan" id="kobo.1936.2">Browsers are obligated to render a web page in spite of poorly structured or even outright invalid HTML. </span><span class="kobospan" id="kobo.1936.3">The design objective is to provide something to the user that reflects the content – not display an error message stating the content is invalid.</span></p>
<div class="tipbox" id="tcolobox-25">
<div class="note">
<p class="normal1"><span class="kobospan" id="kobo.1937.1">HTML pages may be filled with problems and still display a good-looking page in a browser.</span></p>
</div>
</div>
<p class="normal1"><span class="kobospan" id="kobo.1938.1">We can use the standard library </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1939.1">html.parser</span></span></span></span><span class="kobospan" id="kobo.1940.1"> module, but it’s not as helpful as we’d like. </span><span class="kobospan" id="kobo.1940.2">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1941.1">Beautiful Soup </span></span><span class="kobospan" id="kobo.1942.1">package provides more helpful ways to parse HTML pages into useful data structures. </span><span class="kobospan" id="kobo.1942.2">This is available from the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1943.1">Python Package</span></span> <span class="cmbx-10x-x"><span class="kobospan" id="kobo.1944.1">Index </span></span><span class="kobospan" id="kobo.1945.1">(</span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1946.1">PyPI</span></span><span class="kobospan" id="kobo.1947.1">). </span><span class="kobospan" id="kobo.1947.2">See </span><a class="url" href="https://pypi.python.org/pypi/beautifulsoup4"><span class="url1"><span class="kobospan" id="kobo.1948.1">https://pypi.python.org/pypi/beautifulsoup4</span></span></a><span class="kobospan" id="kobo.1949.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1950.1">This must be downloaded</span><span id="dx1-666002"/><span class="kobospan" id="kobo.1951.1"> and installed with the following terminal command:</span></p>
<pre class="programlisting" id="listing-64"><code class="calibre13"><span class="kobospan" id="kobo.1952.1">(cookbook3) % python -m pip install beautifulsoup4</span></code></pre>
<p class="normal1"><span id="x1-666004r1431"/></p>
<section data-number="0.14.8.1" id="getting-ready-92">
<h2 class="likechapterhead" data-number="0.14.8.1"><span><span class="kobospan" id="kobo.1953.1">11.8.1 </span></span> <span id="x1-6670001"/><span class="kobospan" id="kobo.1954.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1955.1">We’ve gathered some historical sailboat</span><span id="dx1-667001"/><span class="kobospan" id="kobo.1956.1"> racing results in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1957.1">Volvo</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1958.1"> Ocean</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1959.1"> Race.html</span></span></span></span><span class="kobospan" id="kobo.1960.1">. </span><span class="kobospan" id="kobo.1960.2">This file contains information on teams, legs, and the order in which the various teams finished each leg. </span><span class="kobospan" id="kobo.1960.3">It’s been scraped from the Volvo Ocean Race website, and it looks wonderful when opened in a browser. </span><span class="kobospan" id="kobo.1960.4">For more information on this data, see the </span><a href="ch015_split_001.xhtml#x1-6520006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1961.1">Reading JSON and YAML documents</span></span></a><span class="kobospan" id="kobo.1962.1"> recipe in this chapter.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1963.1">While Python’s standard library has the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1964.1">urllib</span></span></span></span><span class="kobospan" id="kobo.1965.1"> package to acquire documents, it’s common to use the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1966.1">Requests </span></span><span class="kobospan" id="kobo.1967.1">package to read web pages.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1968.1">Generally, an HTML page has the following overall structure:</span></p>
<pre class="programlisting" id="listing-65"><code class="calibre13"><span class="kobospan" id="kobo.1969.1">&lt;html&gt; 
 
&lt;head&gt;...&lt;/head&gt; 
 
&lt;body&gt;...&lt;/body&gt; 
 
&lt;/html&gt;</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1970.1">Within the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1971.1">&lt;head&gt;</span></span></span></span><span class="kobospan" id="kobo.1972.1"> tag, there will be metadata, links to JavaScript libraries, and links</span><span id="dx1-667006"/><span class="kobospan" id="kobo.1973.1"> to </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1974.1">Cascading Style Sheet </span></span><span class="kobospan" id="kobo.1975.1">(</span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1976.1">CSS</span></span><span class="kobospan" id="kobo.1977.1">) documents. </span><span class="kobospan" id="kobo.1977.2">The content is in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1978.1">&lt;body&gt;</span></span></span></span><span class="kobospan" id="kobo.1979.1"> tag.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1980.1">In this case, the race results</span><span id="dx1-667007"/><span class="kobospan" id="kobo.1981.1"> are in an HTML </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1982.1">&lt;table&gt;</span></span></span></span><span class="kobospan" id="kobo.1983.1"> tag inside the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1984.1">&lt;body&gt;</span></span></span></span><span class="kobospan" id="kobo.1985.1"> tag. </span><span class="kobospan" id="kobo.1985.2">The table has the following structure:</span></p>
<pre class="programlisting" id="listing-66"><code class="calibre13"><span class="kobospan" id="kobo.1986.1">&lt;table&gt; 
 
   &lt;thead&gt; 
 
      ... 
 
   &lt;/thead&gt; 
 
   &lt;tbody&gt; 
 
       ... 
 
   &lt;/tbody&gt; 
 
&lt;/table&gt;</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1987.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1988.1">&lt;thead&gt;</span></span></span></span><span class="kobospan" id="kobo.1989.1"> tag defines the column titles for a table. </span><span class="kobospan" id="kobo.1989.2">There’s a single row tag, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1990.1">&lt;tr&gt;</span></span></span></span><span class="kobospan" id="kobo.1991.1">, with table heading tags, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1992.1">&lt;th&gt;</span></span></span></span><span class="kobospan" id="kobo.1993.1">, that include the column titles. </span><span class="kobospan" id="kobo.1993.2">For the example data, each of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1994.1">&lt;th&gt;</span></span></span></span><span class="kobospan" id="kobo.1995.1"> tags look like this:</span></p>
<pre class="programlisting" id="listing-67"><code class="calibre13"><span class="kobospan" id="kobo.1996.1">&lt;th tooltipster data="&lt;strong&gt;ALICANTE - CAPE TOWN&lt;/strong&gt;" data-theme="tooltipster-shadow" data-htmlcontent="true" data-position="top"&gt; 
 
LEG 1&lt;/th&gt;</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1997.1">The essential display is an identifier for each leg of the race; </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1998.1">LEG</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1999.1"> 1</span></span></span></span><span class="kobospan" id="kobo.2000.1">, in this example. </span><span class="kobospan" id="kobo.2000.2">This is the text content of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2001.1">&lt;th&gt;</span></span></span></span><span class="kobospan" id="kobo.2002.1"> tag. </span><span class="kobospan" id="kobo.2002.2">There’s also an attribute value, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2003.1">data</span></span></span></span><span class="kobospan" id="kobo.2004.1">, that’s used by a JavaScript function. </span><span class="kobospan" id="kobo.2004.2">This attribute value has the name of the leg, and it is displayed when the cursor hovers over a column heading.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.2005.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2006.1">&lt;tbody&gt;</span></span></span></span><span class="kobospan" id="kobo.2007.1"> tag includes rows with the results for each team and race. </span><span class="kobospan" id="kobo.2007.2">Each </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2008.1">&lt;tr&gt;</span></span></span></span><span class="kobospan" id="kobo.2009.1"> table row tag contains </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2010.1">&lt;td&gt;</span></span></span></span><span class="kobospan" id="kobo.2011.1"> table data tags with the name of a team and its results. </span><span class="kobospan" id="kobo.2011.2">Here’s a typical </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2012.1">&lt;tr&gt;</span></span></span></span><span class="kobospan" id="kobo.2013.1"> row from the HTML:</span></p>
<pre class="programlisting" id="listing-68"><code class="calibre13"><span class="kobospan" id="kobo.2014.1">&lt;tr class="ranking-item"&gt; 
 
   &lt;td class="ranking-position"&gt;3&lt;/td&gt; 
 
   &lt;td class="ranking-avatar"&gt;&lt;img src="..."&gt;&lt;/td&gt; 
 
   &lt;td class="ranking-team"&gt; Dongfeng Race Team&lt;/td&gt; 
 
   &lt;td class="ranking-number"&gt;2&lt;/td&gt; 
 
   &lt;td class="ranking-number"&gt;2&lt;/td&gt; 
 
   &lt;td class="ranking-number"&gt;1&lt;/td&gt; 
 
   &lt;td class="ranking-number"&gt;3&lt;/td&gt; 
 
 
 
   &lt;td class="ranking-number" tooltipster 
 
   data="&lt;center&gt;&lt;strong&gt;RETIRED&lt;/strong&gt;&lt;br&gt; Click for more info&lt;/center&gt;" data-theme="tooltipster-3" 
 
   data-position="bottom" data-htmlcontent="true"&gt; 
 
   &lt;a href="/en/news/8674_Dongfeng-Race-Team-breaks-mast-crew-safe.html" 
 
   target="_blank"&gt;8&lt;/a&gt; 
 
   &lt;div class="status-dot dot-3"&gt;&lt;/div&gt;&lt;/td&gt; 
 
   ... </span><span class="kobospan" id="kobo.2014.2">more columns ... 
 
&lt;/tr&gt;</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.2015.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2016.1">&lt;tr&gt;</span></span></span></span><span class="kobospan" id="kobo.2017.1"> tag has a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2018.1">class</span></span></span></span><span class="kobospan" id="kobo.2019.1"> attribute</span><span id="dx1-667035"/><span class="kobospan" id="kobo.2020.1"> that defines the CSS style for this row. </span><span class="kobospan" id="kobo.2020.2">This </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2021.1">class</span></span></span></span><span class="kobospan" id="kobo.2022.1"> attribute can help our data-gathering application locate the relevant content.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.2023.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2024.1">&lt;td&gt;</span></span></span></span><span class="kobospan" id="kobo.2025.1"> tags also have </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2026.1">class</span></span></span></span><span class="kobospan" id="kobo.2027.1"> attributes. </span><span class="kobospan" id="kobo.2027.2">For this well-designed data, the class clarifies what the content of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2028.1">&lt;td&gt;</span></span></span></span><span class="kobospan" id="kobo.2029.1"> cell is. </span><span class="kobospan" id="kobo.2029.2">Not all CSS class names are as well defined as these.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.2030.1">One of the cells – with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2031.1">tooltipster</span></span></span></span><span class="kobospan" id="kobo.2032.1"> attribute – has no text content. </span><span class="kobospan" id="kobo.2032.2">Instead, this cell has an </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2033.1">&lt;a&gt;</span></span></span></span><span class="kobospan" id="kobo.2034.1"> tag and an empty </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2035.1">&lt;div&gt;</span></span></span></span><span class="kobospan" id="kobo.2036.1"> tag. </span><span class="kobospan" id="kobo.2036.2">That cell also contains several attributes, including </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2037.1">data</span></span></span></span><span class="kobospan" id="kobo.2038.1">, among others. </span><span class="kobospan" id="kobo.2038.2">These attributes are used by a JavaScript function to display additional information in the cell.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.2039.1">Another complexity here is that the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2040.1">data</span></span></span></span><span class="kobospan" id="kobo.2041.1"> attribute contains text that’s actually HTML content. </span><span class="kobospan" id="kobo.2041.2">Parsing this bit of text will require creating a separate </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2042.1">BeautifulSoup</span></span></span></span><span class="kobospan" id="kobo.2043.1"> parser. </span><span id="x1-667036r1433"/></p>
</section>
<section data-number="0.14.8.2" id="how-to-do-it...-93">
<h2 class="likechapterhead" data-number="0.14.8.2"><span><span class="kobospan" id="kobo.2044.1">11.8.2 </span></span> <span id="x1-6680002"/><span class="kobospan" id="kobo.2045.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.2046.1">We’ll define a function to convert the HTML </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2047.1">&lt;table&gt;</span></span></span></span><span class="kobospan" id="kobo.2048.1"> to a dictionary with leg descriptions and team results:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-668002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.2049.1">Import the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2050.1">BeautifulSoup</span></span></span></span><span class="kobospan" id="kobo.2051.1"> class from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2052.1">bs4</span></span></span></span><span class="kobospan" id="kobo.2053.1"> module to parse the text. </span><span class="kobospan" id="kobo.2053.2">We’ll also need a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2054.1">Path</span></span></span></span><span class="kobospan" id="kobo.2055.1"> object to refer to the file:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.2056.1">from bs4 import BeautifulSoup 
 
from pathlib import Path 
 
from typing import Any</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-668008x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.2057.1">Define a function to read the HTML document</span><span id="dx1-668009"/><span class="kobospan" id="kobo.2058.1"> from a given </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2059.1">Path</span></span></span></span><span class="kobospan" id="kobo.2060.1"> instance:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.2061.1">def race_extract(source_path: Path) -&gt; dict[str, Any]:</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-668013x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.2062.1">Create the soup structure from the HTML content. </span><span class="kobospan" id="kobo.2062.2">We’ll assign it to a variable, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2063.1">soup</span></span></span></span><span class="kobospan" id="kobo.2064.1">. </span><span class="kobospan" id="kobo.2064.2">As an alternative, we could also read the content using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2065.1">Path.read_text()</span></span></span></span><span class="kobospan" id="kobo.2066.1"> method:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.2067.1">    with source_path.open(encoding="utf8") as source_file: 
 
        soup = BeautifulSoup(source_file, "html.parser")</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-668018x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.2068.1">From the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2069.1">soup</span></span></span></span><span class="kobospan" id="kobo.2070.1"> object, we need to navigate to the first </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2071.1">&lt;table&gt;</span></span></span></span><span class="kobospan" id="kobo.2072.1"> tag. </span><span class="kobospan" id="kobo.2072.2">Within that, we need to find the first </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2073.1">&lt;thead&gt;</span></span></span></span><span class="kobospan" id="kobo.2074.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2075.1">&lt;tr&gt;</span></span></span></span><span class="kobospan" id="kobo.2076.1"> tags. </span><span class="kobospan" id="kobo.2076.2">Navigating to the first instance of a tag is done by using the tag name as an attribute:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.2077.1">    thead_row = soup.table.thead.tr  # type: ignore [union-attr]</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.2078.1">A special comment is used to silence a </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.2079.1">mypy </span></span><span class="kobospan" id="kobo.2080.1">warning. </span><span class="kobospan" id="kobo.2080.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2081.1">#</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2082.1"> type:</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2083.1"> ignore</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2084.1"> [union-attr]</span></span></span></span><span class="kobospan" id="kobo.2085.1"> is needed because each tag property has a type hint of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2086.1">Tag</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2087.1"> |</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2088.1"> None</span></span></span></span><span class="kobospan" id="kobo.2089.1">. </span><span class="kobospan" id="kobo.2089.2">For some applications, additional </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2090.1">if</span></span></span></span><span class="kobospan" id="kobo.2091.1"> statements can be used to confirm the expected combinations of tags that are present.</span></p>
</div></li>
<li class="calibre7"><div id="x1-668022x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.2092.1">We must accumulate heading data from each </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2093.1">&lt;th&gt;</span></span></span></span><span class="kobospan" id="kobo.2094.1"> cell within the row:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.2095.1">    legs: list[tuple[str, str | None]] = [] 
 
    for tag in thead_row.find_all("th"): # type: ignore [union-attr] 
 
        leg_description = ( 
 
            tag.string, tag.attrs.get("data") 
 
        ) 
 
        legs.append(leg_description)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-668031x6" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.2096.1">To find the table’s content, we navigate down into the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2097.1">&lt;table&gt;</span></span></span></span><span class="kobospan" id="kobo.2098.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2099.1">&lt;tbody&gt;</span></span></span></span><span class="kobospan" id="kobo.2100.1"> tags:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.2101.1">    tbody = soup.table.tbody # type: ignore [union-attr]</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-668035x7" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.2102.1">We need to visit all of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2103.1">&lt;tr&gt;</span></span></span></span><span class="kobospan" id="kobo.2104.1"> tags. </span><span class="kobospan" id="kobo.2104.2">Within each row, we want</span><span id="dx1-668036"/><span class="kobospan" id="kobo.2105.1"> to convert the content of all </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2106.1">&lt;td&gt;</span></span></span></span><span class="kobospan" id="kobo.2107.1"> tags into team names and a collection of team positions, depending on the attributes of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2108.1">td</span></span></span></span><span class="kobospan" id="kobo.2109.1"> tag:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.2110.1">    teams: list[dict[str, Any]] = [] 
 
    for row in tbody.find_all("tr"): # type: ignore [union-attr] 
 
        team: dict[str, Any] = { 
 
            "name": None, 
 
            "position": []} 
 
        for col in row.find_all("td"): 
 
            if "ranking-team" in col.attrs.get("class"): 
 
                team["name"] = col.string 
 
            elif ( 
 
                    "ranking-number" in col.attrs.get("class") 
 
                ): 
 
                team["position"].append(col.string) 
 
            elif "data" in col.attrs: 
 
                # Complicated explanation with nested HTML 
 
                # print(col.attrs, col.string) 
 
                pass 
 
        teams.append(team)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-668056x8" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.2111.1">Once the legs and teams have been extracted, we can create a useful dictionary that will contain the two collections:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.2112.1">    document = { 
 
        "legs": legs, 
 
        "teams": teams, 
 
    } 
 
    return document</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.2113.1">We’ve created a list of legs showing the order and names</span><span id="dx1-668063"/><span class="kobospan" id="kobo.2114.1"> for each leg, and we parsed the body of the table to create a dict-of-list structure with each leg’s results for a given team. </span><span class="kobospan" id="kobo.2114.2">The resulting object looks like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.2115.1">&gt;&gt;&gt; source_path = Path("data") / "Volvo Ocean Race.html" 
 
&gt;&gt;&gt; race_extract(source_path) 
 
{’legs’: [(None, None), 
 
          (’LEG 1’, ’&lt;strong&gt;ALICANTE - CAPE TOWN’), 
 
          (’LEG 2’, ’&lt;strong&gt;CAPE TOWN - ABU DHABI&lt;/strong&gt;’), 
 
          (’LEG 3’, ’&lt;strong&gt;ABU DHABI - SANYA&lt;/strong&gt;’), 
 
          (’LEG 4’, ’&lt;strong&gt;SANYA - AUCKLAND&lt;/strong&gt;’), 
 
          (’LEG 5’, ’&lt;strong&gt;AUCKLAND - ITAJA&lt;/strong&gt;’), 
 
          (’LEG 6’, ’&lt;strong&gt;ITAJA - NEWPORT&lt;/strong&gt;’), 
 
          (’LEG 7’, ’&lt;strong&gt;NEWPORT - LISBON&lt;/strong&gt;’), 
 
          (’LEG 8’, ’&lt;strong&gt;LISBON - LORIENT&lt;/strong&gt;’), 
 
          (’LEG 9’, ’&lt;strong&gt;LORIENT - GOTHENBURG&lt;/strong&gt;’), 
 
          (’TOTAL’, None)], 
 
 ’teams’: [ 
 
    {’name’: ’Abu Dhabi Ocean Racing’, 
 
     ’position’: [’1’, ’3’, 
 
              ’2’, ’2’, 
 
              ’1’, ’2’,</span></code></pre>
<div class="tipbox1" id="tcolobox-26">
<span id="x1-668084x2"/>
</div>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.2116.1">
 
 
    {’name’: ’Team Vestas Wind’, 
 
     ’position’: [’4’, 
 
                None, 
 
                None, 
 
                None, 
 
                None, 
 
                None, 
 
                None, 
 
                ’2’, 
 
                ’6’, 
 
                ’60’]}]}</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.2117.1">Within the body of the table, many cells have </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2118.1">None</span></span></span></span><span class="kobospan" id="kobo.2119.1"> for the final race position and a complex value in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2120.1">data</span></span></span></span><span class="kobospan" id="kobo.2121.1"> attribute for the specific </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2122.1">&lt;TD&gt;</span></span></span></span><span class="kobospan" id="kobo.2123.1"> tag. </span><span class="kobospan" id="kobo.2123.2">Parsing the HTML embedded in this text follows the pattern shown in the recipe, using another </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2124.1">BeautifulSoup</span></span></span></span><span class="kobospan" id="kobo.2125.1"> instance. </span><span id="x1-668097r1434"/></p>
</section>
<section data-number="0.14.8.3" id="how-it-works...-93">
<h2 class="likechapterhead" data-number="0.14.8.3"><span><span class="kobospan" id="kobo.2126.1">11.8.3 </span></span> <span id="x1-6690003"/><span class="kobospan" id="kobo.2127.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.2128.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2129.1">BeautifulSoup</span></span></span></span><span class="kobospan" id="kobo.2130.1"> class transforms HTML documents into fairly complex</span><span id="dx1-669001"/><span class="kobospan" id="kobo.2131.1"> objects based on a </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.2132.1">Document Object Model </span></span><span class="kobospan" id="kobo.2133.1">(</span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.2134.1">DOM</span></span><span class="kobospan" id="kobo.2135.1">). </span><span class="kobospan" id="kobo.2135.2">The resulting structure will be built from instances of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2136.1">Tag</span></span></span></span><span class="kobospan" id="kobo.2137.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2138.1">NavigableString</span></span></span></span><span class="kobospan" id="kobo.2139.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2140.1">Comment</span></span></span></span><span class="kobospan" id="kobo.2141.1"> classes.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.2142.1">Each </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2143.1">Tag</span></span></span></span><span class="kobospan" id="kobo.2144.1"> object has a name, string, and attributes. </span><span class="kobospan" id="kobo.2144.2">The name is the word inside </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2145.1">&lt;</span></span></span></span><span class="kobospan" id="kobo.2146.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2147.1">&gt;</span></span></span></span><span class="kobospan" id="kobo.2148.1"> characters. </span><span class="kobospan" id="kobo.2148.2">The attributes are the fields that follow the tag name. </span><span class="kobospan" id="kobo.2148.3">For example, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2149.1">&lt;td</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2150.1"> class="ranking-number"&gt;1&lt;/td&gt;</span></span></span></span><span class="kobospan" id="kobo.2151.1"> has a tag name of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2152.1">td</span></span></span></span><span class="kobospan" id="kobo.2153.1"> and an attribute named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2154.1">class</span></span></span></span><span class="kobospan" id="kobo.2155.1">. </span><span class="kobospan" id="kobo.2155.2">Values are often strings, but in a few cases, the value can be a list of strings. </span><span class="kobospan" id="kobo.2155.3">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2156.1">string</span></span></span></span><span class="kobospan" id="kobo.2157.1"> attribute of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2158.1">Tag</span></span></span></span><span class="kobospan" id="kobo.2159.1"> object is the content enclosed by the tag; in this case, it’s a very short string, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2160.1">1</span></span></span></span><span class="kobospan" id="kobo.2161.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.2162.1">HTML is a mixed content model. </span><span class="kobospan" id="kobo.2162.2">When looking at the children of a given tag, there will be a sequence of child </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2163.1">Tag</span></span></span></span><span class="kobospan" id="kobo.2164.1">s and child </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2165.1">NavigableText</span></span></span></span><span class="kobospan" id="kobo.2166.1"> objects freely intermixed.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.2167.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2168.1">BeautifulSoup</span></span></span></span><span class="kobospan" id="kobo.2169.1"> parser class depends on a lower-level library to do some of the parsing work. </span><span class="kobospan" id="kobo.2169.2">It’s easiest to use the built-in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2170.1">html.parser</span></span></span></span><span id="dx1-669002"/><span class="kobospan" id="kobo.2171.1"> module for this. </span><span class="kobospan" id="kobo.2171.2">The alternatives offer some advantages, like better performance or better handling of damaged HTML. </span><span id="x1-669003r1445"/></p>
</section>
<section data-number="0.14.8.4" id="theres-more...-84">
<h2 class="likechapterhead" data-number="0.14.8.4"><span><span class="kobospan" id="kobo.2172.1">11.8.4 </span></span> <span id="x1-6700004"/><span class="kobospan" id="kobo.2173.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.2174.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2175.1">Tag</span></span></span></span><span class="kobospan" id="kobo.2176.1"> objects of Beautiful Soup represent the hierarchy of the document’s structure. </span><span class="kobospan" id="kobo.2176.2">There are several kinds of navigation among tags. </span><span class="kobospan" id="kobo.2176.3">In this recipe, we relied on the way </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2177.1">soup.html</span></span></span></span><span class="kobospan" id="kobo.2178.1"> is the same as </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2179.1">soup.find("html")</span></span></span></span><span class="kobospan" id="kobo.2180.1">. </span><span class="kobospan" id="kobo.2180.2">We can also search by attribute values, including </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2181.1">class</span></span></span></span><span class="kobospan" id="kobo.2182.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2183.1">id</span></span></span></span><span class="kobospan" id="kobo.2184.1">. </span><span class="kobospan" id="kobo.2184.2">These often provide semantic information about the content.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.2185.1">In some cases, a document will have a well-designed organization, and a search by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2186.1">id</span></span></span></span><span class="kobospan" id="kobo.2187.1"> attribute or </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2188.1">class</span></span></span></span><span class="kobospan" id="kobo.2189.1"> attribute will find the relevant data. </span><span class="kobospan" id="kobo.2189.2">Here’s a typical search for a given structure using the HTML </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2190.1">class</span></span></span></span><span class="kobospan" id="kobo.2191.1"> attribute:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.2192.1">&gt;&gt;&gt; ranking_table = soup.find(’table’, class_="ranking-list")</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.2193.1">Note that we have to use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2194.1">class_</span></span></span></span><span class="kobospan" id="kobo.2195.1"> in our Python query to search for the attribute named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2196.1">class</span></span></span></span><span class="kobospan" id="kobo.2197.1">. </span><span class="kobospan" id="kobo.2197.2">The token </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2198.1">class</span></span></span></span><span class="kobospan" id="kobo.2199.1"> is a reserved word in Python and cannot be used as a parameter name. </span><span class="kobospan" id="kobo.2199.2">Given the overall document, we’re searching for any </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2200.1">&lt;table</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2201.1"> class="ranking-list"&gt;</span></span></span></span><span class="kobospan" id="kobo.2202.1"> tag. </span><span class="kobospan" id="kobo.2202.2">This will find the first such table in a web page. </span><span class="kobospan" id="kobo.2202.3">Since we know there will only be one of these, this attribute-based search helps distinguish between what we are trying to find and any other tabular data on a web page. </span><span id="x1-670003r1446"/></p>
</section>
<section data-number="0.14.8.5" id="see-also-91">
<h2 class="likechapterhead" data-number="0.14.8.5"><span><span class="kobospan" id="kobo.2203.1">11.8.5 </span></span> <span id="x1-6710005"/><span class="kobospan" id="kobo.2204.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.2205.1">The </span><a href="https://pypi.org/project/requests/" class="url"><span class="kobospan" id="kobo.2206.1">Requests</span></a><span class="kobospan" id="kobo.2207.1"> package can greatly simplify the code required to interact with complex websites.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.2208.1">Se the </span><a class="url" href="https://www.robotstxt.org"><span class="url1"><span class="kobospan" id="kobo.2209.1">https://www.robotstxt.org</span></span></a><span class="kobospan" id="kobo.2210.1"> website for information on the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.2211.1">robots.txt</span></span></span></span><span class="kobospan" id="kobo.2212.1"> file and the </span><a href="https://www.rfc-editor.org/rfc/rfc9309.html#name-informative-references" class="url"><span class="kobospan" id="kobo.2213.1">RFC 9309 Robots Exclusion Protocol</span></a><span class="kobospan" id="kobo.2214.1">.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.2215.1">The </span><a href="ch015_split_001.xhtml#x1-6520006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.2216.1">Reading JSON and YAML documents</span></span></a><span class="kobospan" id="kobo.2217.1"> and </span><a href="ch015_split_001.xhtml#x1-6600007" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.2218.1">Reading XML</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.2219.1">documents</span></span></a><span class="kobospan" id="kobo.2220.1"> recipes, shown earlier in this chapter, both use similar data. </span><span class="kobospan" id="kobo.2220.2">The example data was created for them by scraping the original HTML page using these techniques.</span></p></li>
</ul>
<p class="normal1"><span id="x1-671001r1432"/></p>
</section>
</section>
<section data-number="0.14.11" id="join-our-community-discord-space-11">
<h1 class="unnumbered" data-number="0.14.11"><span id="x1-67400010"/><span class="kobospan" id="kobo.2221.1">Join our community Discord space</span></h1>
<p class="normal"><span class="kobospan" id="kobo.2222.1">Join our Python Discord workspace to discuss and find out more about the book: </span><a class="url" href="https://packt.link/dHrHU"><span class="url1"><span class="kobospan" id="kobo.2223.1">https://packt.link/dHrHU</span></span></a></p>
<p class="normal1"><span class="kobospan" id="kobo.2224.1"><img alt="PIC" src="../media/file1.png" class="calibre9"/></span></p>
<p class="normal1"><span id="x1-674001r1307"/></p>
</section>
</section>
</body></html>