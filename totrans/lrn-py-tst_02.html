<html><head></head><body>
  <div id="sbo-rt-content"><div class="chapter" title="Chapter 2. Working with doctest"><div class="titlepage"><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Working with doctest</h1></div></div></div><p>The first testing tool we're going to look at is called <code class="literal">doctest</code>. The name is short for "document testing" or <a id="id20" class="indexterm"/>perhaps a "testable document". Either way, it's a literate tool designed to make it easy to write tests in such a way that computers and humans both benefit from them. Ideally, <code class="literal">doctest</code> tests both, informs human readers, and tells the computer what to expect.</p><p>Mixing tests and documentation helps us:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Keeps the documentation up-to-date with reality</li><li class="listitem" style="list-style-type: disc">Make sure that the tests express the intended behavior</li><li class="listitem" style="list-style-type: disc">Reuse some of the efforts involved in the documentation and test creation</li></ul></div><div class="section" title="Where doctest performs best"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec15"/>Where doctest performs best</h1></div></div></div><p>The design <a id="id21" class="indexterm"/>decisions that went into <code class="literal">doctest</code> make it particularly well suited to writing acceptance tests at the integration and system testing levels. This is because <code class="literal">doctest</code> mixes human-only text with examples that both humans and computers can read. This structure doesn't support or enforce any of the formalizations of testing, but it conveys information beautifully and it still provides the computer with the ability to say <span class="emphasis"><em>that works</em></span> or <span class="emphasis"><em>that doesn't work</em></span>. As an added bonus, it is about the easiest way to write tests you'll ever see.</p><p>In other words, a <code class="literal">doctest</code> file is a truly excellent program specification that you can have the computer check against your actual code any time you want. API documentation also benefits from being written as doctests and checked alongside your other tests. You can even include doctests in your docstrings.</p><p>The basic idea you should be getting from all this is that <code class="literal">doctest</code> is ideal for uses where humans and computers will both benefit from reading them.</p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="The doctest language"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec16"/>The doctest language</h1></div></div></div><p>Like program source code, <code class="literal">doctest</code> tests are written in plain text. The <code class="literal">doctest</code> module extracts the tests and ignores the <a id="id22" class="indexterm"/>rest of the text, which means that the tests can be embedded in human-readable explanations or discussions. This is the feature that makes <code class="literal">doctest</code> suitable for uses such as program specifications.</p><div class="section" title="Example – creating and running a simple doctest"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec10"/>Example – creating and running a simple doctest</h2></div></div></div><p>We are going to <a id="id23" class="indexterm"/>create a simple <code class="literal">doctest</code> file, to show the fundamentals of <a id="id24" class="indexterm"/>using the tool. Perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Open a new text file in your editor, and name it <code class="literal">test.txt</code>.</li><li class="listitem">Insert the following text into the file:<div class="informalexample"><pre class="programlisting">This is a simple doctest that checks some of Python's arithmetic
operations.

&gt;&gt;&gt; 2 + 2
4

&gt;&gt;&gt; 3 * 3
10</pre></div></li><li class="listitem">We can now run the <code class="literal">doctest</code>. At the command prompt, change to the directory where you saved <code class="literal">test.txt</code>. Type the following command:<div class="informalexample"><pre class="programlisting"><span class="strong"><strong>$ python3 ‑m doctest test.txt</strong></span></pre></div></li><li class="listitem">When the test is run, you should see output like this:<div class="mediaobject"><img src="images/3211OS_02_01.jpg" alt="Example – creating and running a simple doctest"/></div></li></ol></div></div><div class="section" title="Result – three times three does not equal ten"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec11"/>Result – three times three does not equal ten</h2></div></div></div><p>You just wrote a <code class="literal">doctest</code> file that describes a couple of arithmetic operations, and ran it to check whether Python <a id="id25" class="indexterm"/>behaved as the tests said it should. You ran the tests by telling Python to execute <code class="literal">doctest</code> on the file containing the tests.</p><p>In this case, Python's behavior differed from the tests because, according to the tests, three times three equals ten. However, Python disagrees on that. As <code class="literal">doctest</code> expected one thing and Python did something different, <code class="literal">doctest</code> presented you with a nice little error report showing where to find the failed test, and how the actual result differed from the expected result. At the bottom of the report is a summary showing how many tests failed in each file tested, which is helpful when you have more than one file containing tests.</p></div><div class="section" title="The syntax of doctests"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec12"/>The syntax of doctests</h2></div></div></div><p>You might have <a id="id26" class="indexterm"/>already figured it out from looking at the previous example: <code class="literal">doctest</code> recognizes tests by looking for sections of text that look like they've been copied and pasted from a Python interactive session. Anything that can be expressed in Python is valid within a <code class="literal">doctest</code>.</p><p>Lines that start with a <code class="literal">&gt;&gt;&gt;</code> prompt are sent to a Python interpreter. Lines that start with a <code class="literal">...</code> prompt are sent as continuations of the code from the previous line, allowing you to embed complex block statements into your doctests. Finally, any lines that don't start with <code class="literal">&gt;&gt;&gt;</code> or <code class="literal">...</code>, up to the next blank line or <code class="literal">&gt;&gt;&gt;</code> prompt, represent the output expected from the statement. The output appears as it would in an interactive Python session, including both the return value and anything printed to the console. If you don't have any output lines, <code class="literal">doctest</code> assumes it to mean that the statement is expected to have no visible result on the console, which usually means that it returns None.</p><p>The <code class="literal">doctest</code> module ignores anything in the file that isn't part of a test, which means that you can put explanatory text, HTML, line-art diagrams, or whatever else strikes your fancy in between your tests. We <a id="id27" class="indexterm"/>took advantage of this in the previous <code class="literal">doctest</code> to add an explanatory sentence before the test itself.</p></div><div class="section" title="Example – a more complex test"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec13"/>Example – a more complex test</h2></div></div></div><p>Add the following <a id="id28" class="indexterm"/>code to your <code class="literal">test.txt</code> file, separated from the existing code by at least one blank line:</p><div class="informalexample"><pre class="programlisting">Now we're going to take some more of doctest's syntax for a spin.

&gt;&gt;&gt; import sys
&gt;&gt;&gt; def test_write():
...     sys.stdout.write("Hello\n")
...     return True
&gt;&gt;&gt; test_write()
Hello
True</pre></div><p>Now take a moment to consider before running the test. Will it pass or fail? Should it pass or fail?</p></div><div class="section" title="Result – five tests run"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec14"/>Result – five tests run</h2></div></div></div><p>Just as we discussed <a id="id29" class="indexterm"/>before, run the test using the following command:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>python3 -m doctest test.txt</strong></span></pre></div><p>You should see a result like this:</p><div class="mediaobject"><img src="images/3211OS_02_02.jpg" alt="Result – five tests run"/></div><p>Because we added the new tests to the same file containing the tests from before, we still see the notification that three times three does not equal 10. Now, though, we also see that five tests were run, which means our new tests ran and were successful.</p><p>Why five tests? As far as <code class="literal">doctest</code> is concerned, we added the following three tests to the file:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The first one says that, when we <code class="literal">import sys</code>, nothing visible should happen</li><li class="listitem" style="list-style-type: disc">The second test says <a id="id30" class="indexterm"/>that, when we define the <code class="literal">test_write</code> function, nothing visible should happen</li><li class="listitem" style="list-style-type: disc">The third test says that, when we call the <code class="literal">test_write</code> function, <code class="literal">Hello</code> and <code class="literal">True</code> should appear on the console, in that order, on separate lines</li></ul></div><p>Since all three of these tests pass, <code class="literal">doctest</code> doesn't bother to say much about them. All it did was increase the number of tests reported at the bottom from two to five.</p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Expecting exceptions"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec17"/>Expecting exceptions</h1></div></div></div><p>That's all well <a id="id31" class="indexterm"/>and good for testing that things work as expected, but it is just as important to make sure that things fail when they're supposed to fail. Put another way: sometimes your code is supposed to raise an exception, and you need to be able to write tests that check that behavior as well.</p><p>Fortunately, <code class="literal">doctest</code> follows nearly the same principle in dealing with exceptions as it does with everything else; it looks for text that looks like a Python interactive session. This means it looks for text that looks like a Python exception report and traceback, and matches it against any exception that gets raised.</p><p>The <code class="literal">doctest</code> module does handle exceptions a little differently from the way it handles other things. It doesn't just match the text precisely and report a failure if it doesn't match. Exception tracebacks tend to contain many details that are not relevant to the test, but that can change unexpectedly. The <code class="literal">doctest</code> module deals with this by ignoring the traceback entirely: it's only concerned with the first line, <code class="literal">Traceback (most recent call last):</code>, which tells it that you expect an exception, and the part after the traceback, which tells it which exception you expect. The <code class="literal">doctest</code> module only reports a failure if one of these parts does not match.</p><p>This is helpful for a second reason as well: manually figuring out what the traceback will look like, when you're <a id="id32" class="indexterm"/>writing your tests, would require a significant amount of effort and would gain you nothing. It's better to simply omit them.</p><div class="section" title="Example – checking for an exception"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec15"/>Example – checking for an exception</h2></div></div></div><p>This is yet <a id="id33" class="indexterm"/>another test that you can add to <code class="literal">test.txt</code>, this time testing some code that ought to raise an exception.</p><p>Insert the following text into your <code class="literal">doctest</code> file, as always separated by at least one blank line:</p><div class="informalexample"><pre class="programlisting">Here we use doctest's exception syntax to check that Python is correctly enforcing its grammar. The error is a missing ) on the def line.

&gt;&gt;&gt; def faulty(:
...     yield from [1, 2, 3, 4, 5]
Traceback (most recent call last):
SyntaxError: invalid syntax</pre></div><p>The test is supposed to raise an exception, so it will fail if it doesn't raise the exception or if it raises the wrong exception. Make sure that you have your mind wrapped around this: if the test code executes successfully, the test fails, because it expected an exception.</p><p>Run the tests using the following doctest:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>python3 -m doctest test.txt</strong></span></pre></div></div><div class="section" title="Result – success at failing"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec16"/>Result – success at failing</h2></div></div></div><p>The code contains a <a id="id34" class="indexterm"/>syntax error, which means this raises a <code class="literal">SyntaxError</code> exception, which in turn means that the example behaves as expected; this signifies that the test passes.</p><div class="mediaobject"><img src="images/3211OS_02_03.jpg" alt="Result – success at failing"/></div><p>When dealing with exceptions, it is often desirable to be able to use a wildcard matching mechanism. The <code class="literal">doctest</code> <a id="id35" class="indexterm"/>provides this facility through its ellipsis directive that we'll discuss shortly.</p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Expecting blank lines"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec18"/>Expecting blank lines</h1></div></div></div><p>The <code class="literal">doctest</code> uses the <a id="id36" class="indexterm"/>first blank line after <code class="literal"> &gt;&gt;&gt;</code> to identify the end of the expected output, so what do you do when the expected output actually contains a blank line?</p><p>The <code class="literal">doctest</code> handles this situation by matching a line that contains only the text <code class="literal">&lt;BLANKLINE&gt;</code> in the expected output with a real blank line in the actual output.</p></div></div>


  <div id="sbo-rt-content"><div class="section" title="Controlling doctest behavior with directives"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec19"/>Controlling doctest behavior with directives</h1></div></div></div><p>Sometimes, the <a id="id37" class="indexterm"/>default behavior of <code class="literal">doctest</code> makes writing a <a id="id38" class="indexterm"/>particular test inconvenient. For example, <code class="literal">doctest</code> might look at a trivial difference between the expected and real outputs and wrongly conclude that the test has failed. This is where <code class="literal">doctest</code> directives come to the rescue. Directives are specially formatted comments that you can place after the source code of a test and that tell <code class="literal">doctest</code> to alter its default behavior in some way.</p><p>A directive comment begins with <code class="literal"># doctest:</code>, after which comes a comma-separated list of options that either enable or disable various behaviors. To enable a behavior, write a <code class="literal">+</code> (plus symbol) followed by the behavior name. To disable a behavior, white a <code class="literal">–</code> (minus symbol) <a id="id39" class="indexterm"/>followed by the behavior name. We'll take a <a id="id40" class="indexterm"/>look at the several directives in the following sections.</p></div></div>


  <div id="sbo-rt-content"><div class="section" title="Ignoring part of the result"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec20"/>Ignoring part of the result</h1></div></div></div><p>It's fairly common <a id="id41" class="indexterm"/>that only part of the output of a test is actually relevant to determining whether the test passes. By using the <code class="literal">+ELLIPSIS</code> directive, you can make <code class="literal">doctest</code> treat the text <code class="literal">...</code> (called an ellipsis) in the expected output as a wildcard that will match any text in the output.</p><p>When you use an ellipsis, <code class="literal">doctest</code> will scan until it finds text matching whatever comes after the ellipsis in the expected output, and continue matching from there. This can lead to surprising results such as an ellipsis matching against a 0-length section of the actual output, or against multiple lines. For this reason, it needs to be used thoughtfully.</p><div class="section" title="Example – ellipsis test drive"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec17"/>Example – ellipsis test drive</h2></div></div></div><p>We're going to <a id="id42" class="indexterm"/>use the ellipsis in a few different tests to better get a feel of how it works. As an added bonus, these tests also show the use of <code class="literal">doctest</code> directives.</p><p>Add the following code to your <code class="literal">test.txt</code> file:</p><div class="informalexample"><pre class="programlisting">Next up, we're exploring the ellipsis.

&gt;&gt;&gt; sys.modules # doctest: +ELLIPSIS
{...'sys': &lt;module 'sys' (built-in)&gt;...}

&gt;&gt;&gt; 'This is an expression that evaluates to a string'
... # doctest: +ELLIPSIS
'This is ... a string'

&gt;&gt;&gt; 'This is also a string' # doctest: +ELLIPSIS
'This is ... a string'

&gt;&gt;&gt; import datetime
&gt;&gt;&gt; datetime.datetime.now().isoformat() # doctest: +ELLIPSIS
'...-...-...T...:...:...'</pre></div></div><div class="section" title="Result – ellipsis elides"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec18"/>Result – ellipsis elides</h2></div></div></div><p>The tests all pass, where they would all fail without the ellipsis. The first and last tests, in which we checked <a id="id43" class="indexterm"/>for the presence of a specific module in <code class="literal">sys.modules</code> and confirmed a specific formatting while ignoring the contents of a string, demonstrate the kind of situation where ellipsis is really useful, because it lets you focus on the part of the output that is meaningful and ignore the rest of the test. The middle tests demonstrate how different outputs can match the same expected result when ellipsis is in play.</p><p>Look at the last test. Can you imagine any output that wasn't an ISO-formatted time stamp, but that would match the example anyway? Remember that the ellipsis can match any amount of text.</p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Ignoring white space"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec21"/>Ignoring white space</h1></div></div></div><p>Sometimes, white space (spaces, tabs, newlines, and their ilk) is more trouble than it's worth. Maybe you want to be able to break a single line of expected output across several lines in your <a id="id44" class="indexterm"/>test file, or maybe you're testing a system that uses lots of white space but doesn't convey any useful information with it.</p><p>The <code class="literal">doctest</code> gives you a way to "normalize" white space, turning any sequence of white space characters, in both the expected output and in the actual output, into a single space. It then checks whether these normalized versions match.</p><div class="section" title="Example – invoking normality"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec19"/>Example – invoking normality</h2></div></div></div><p>We're going to <a id="id45" class="indexterm"/>write a couple of tests that demonstrate how whitespace normalization works.</p><p>Insert the following code into your <code class="literal">doctest</code> file:</p><div class="informalexample"><pre class="programlisting">Next, a demonstration of whitespace normalization.

&gt;&gt;&gt; [1, 2, 3, 4, 5, 6, 7, 8, 9]
... # doctest: +NORMALIZE_WHITESPACE
[1, 2, 3,
 4, 5, 6,
 7, 8, 9]

&gt;&gt;&gt; sys.stdout.write("This text\n contains weird     spacing.\n")
... # doctest: +NORMALIZE_WHITESPACE
This text contains weird spacing.
39</pre></div></div><div class="section" title="Result – white space matches any other white space"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec20"/>Result – white space matches any other white space</h2></div></div></div><p>Both of these tests <a id="id46" class="indexterm"/>pass, in spite of the fact that the result of the first one has been wrapped across multiple lines to make it easy for humans to read, and the result of the second one has had its strange newlines and indentations left out, also for human convenience.</p><p>Notice how one of the tests inserts extra whitespace in the expected output, while the other one ignores extra whitespace in the actual output? When you use <code class="literal">+NORMALIZE_WHITESPACE</code>, you gain a lot of flexibility with regard to how things are formatted in the text file.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note03"/>Note</h3><p>You may have noted the value <code class="literal">39</code> on the last line of the last example. Why is that there? It's because the <code class="literal">write()</code> method returns the number of bytes that were written, which in this case happens to be <code class="literal">39</code>. If you're trying this example in an environment that maps ASCII characters to more than one byte, you will see a different number here; this will cause the test to fail until you change the expected number of bytes.</p></div></div></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Skipping an example"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec22"/>Skipping an example</h1></div></div></div><p>On some occasions, <code class="literal">doctest</code> will recognize some text as an example to be checked, when in truth you <a id="id47" class="indexterm"/>want it to be simply text. This situation is rarer than it might at first seem, because usually there's no harm in letting <code class="literal">doctest</code> check everything it can. In fact, usually it's very helpful to have <code class="literal">doctest</code> check everything it can. For those times when you want to limit what <code class="literal">doctest</code> checks, though, there's the <code class="literal">+SKIP</code> directive.</p><div class="section" title="Example – humans only"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec21"/>Example – humans only</h2></div></div></div><p>Append the <a id="id48" class="indexterm"/>following code to your doctest file:</p><div class="informalexample"><pre class="programlisting">Now we're telling doctest to skip a test

&gt;&gt;&gt; 'This test would fail.' # doctest: +SKIP
If it were allowed to run.</pre></div></div><div class="section" title="Result – it looks like a test, but it's not"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec22"/>Result – it looks like a test, but it's not</h2></div></div></div><p>Before we added this <a id="id49" class="indexterm"/>last example to the file, <code class="literal">doctest</code> reported thirteen tests when we ran the file through it. After adding this code, <code class="literal">doctest</code> still reports thirteen tests. Adding the skip directive to the code completely removed it from consideration by doctest. It's not a test that passes, nor a test that fails. It's not a test at all.</p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="The other directives"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec23"/>The other directives</h1></div></div></div><p>There are a <a id="id50" class="indexterm"/>number of other directives that can be issued to doctest, should you find the need. They're not as broadly useful as the ones already mentioned, but the time might come when you require one or more of them.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note04"/>Note</h3><p>The full <a id="id51" class="indexterm"/>documentation for all of the doctest directives can be found at <a class="ulink" href="http://docs.python.org/3/library/doctest.html#doctest-options">http://docs.python.org/3/library/doctest.html#doctest-options</a>.</p></div></div><p>The remaining directives of <code class="literal">doctest</code> in the Python 3.4 version are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">DONT_ACCEPT_TRUE_FOR_1</code>: This makes <code class="literal">doctest</code> differentiate between boolean <a id="id52" class="indexterm"/>values and numbers</li><li class="listitem" style="list-style-type: disc"><code class="literal">DONT_ACCEPT_BLANKLINE</code>: This <a id="id53" class="indexterm"/>removes support for the &lt;BLANKLINE&gt; feature</li><li class="listitem" style="list-style-type: disc"><code class="literal">IGNORE_EXCEPTION_DETAIL</code>: This makes <code class="literal">doctest</code> only care that an exception <a id="id54" class="indexterm"/>is of the expected type</li></ul></div><p>Strictly speaking, <code class="literal">doctest</code> supports several other options that can be set using the directive syntax, but they don't make any sense as directives, so we'll ignore them here.</p></div></div>


  <div id="sbo-rt-content"><div class="section" title="The execution scope of doctest tests"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec24"/>The execution scope of doctest tests</h1></div></div></div><p>When <a id="id55" class="indexterm"/>
<code class="literal">doctest</code> is running the tests from text files, all the tests <a id="id56" class="indexterm"/>from the same file are run in the same execution scope. This means that, if you import a module or bind a variable in one test, that module or variable is still available in later tests. We took advantage of this fact several times in the tests written so far in this chapter: the <code class="literal">sys</code> module was only imported once, for example, although it was used in several tests.</p><p>This behavior is not necessarily beneficial, because tests need to be isolated from each other. We don't want them to contaminate each other because, if a test depends on something that another test does, or if it fails because of something that another test does, these two tests are in some sense combined into one test that covers a larger section of your code. You don't want that to happen, because then knowing which test has failed doesn't give you as much information about what went wrong and where it happened.</p><p>So, how can we give each test its own execution scope? There are a few ways to do it. One would be to simply place each test in its own file, along with whatever explanatory text that is <a id="id57" class="indexterm"/>needed. This works well in terms of functionality, but running the tests can be a pain unless you have a tool to find and run all of them for you. We'll talk about one such tool (called Nose) in a later chapter. Another problem with this <a id="id58" class="indexterm"/>approach is that this breaks the idea that the tests contribute to a human-readable document.</p><p>Another way to give each test its own execution scope is to define each test within a function, as follows:</p><div class="informalexample"><pre class="programlisting">&gt;&gt;&gt; def test1():
...     import frob
...     return frob.hash('qux')
&gt;&gt;&gt; test1()
77</pre></div><p>By doing this, the only thing that ends up in the shared scope is the test function (named <code class="literal">test1</code> here). The <code class="literal">frob</code> module and any other names bound inside the function are isolated with the caveat that things that happen inside imported modules are not isolated. If the <code class="literal">frob.hash()</code> method changes a state inside the <code class="literal">frob</code> module, that state will still be changed if a different test imports the <code class="literal">frob</code> module again.</p><p>The third way is to exercise caution with the names you create, and be sure to set them to known values at the beginning of each test section. In many ways this is the easiest approach, but this is also the one that places the most burden on you, because you have to keep track of what's in the scope.</p><p>Why does <code class="literal">doctest</code> behave in this way, instead of isolating tests from each other? The <code class="literal">doctest</code> files are intended not just for computers to read, but also for humans. They often form a sort of narrative, flowing from one thing to the next. It would break the narrative to be constantly repeating what came before. In other words, this approach is a compromise between being a document and being a test framework, a middle ground that works for both humans and computers.</p><p>The other framework that we will study in depth in this book (called simply <code class="literal">unittest</code>) works at a more <a id="id59" class="indexterm"/>formal level, and enforces the separation <a id="id60" class="indexterm"/>between tests.</p></div></div>


  <div id="sbo-rt-content"><div class="section" title="Check your understanding"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec25"/>Check your understanding</h1></div></div></div><p>Once you've decided on your answers to these questions, check them by writing a test document and running <a id="id61" class="indexterm"/>it through <code class="literal">doctest</code>:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">How does <code class="literal">doctest</code> recognize the beginning of a test in a document?</li><li class="listitem" style="list-style-type: disc">How does <code class="literal">doctest</code> know when a test continues to further lines?</li><li class="listitem" style="list-style-type: disc">How does <code class="literal">doctest</code> recognize the beginning and end of the expected output of a test?</li><li class="listitem" style="list-style-type: disc">How would you tell <code class="literal">doctest</code> that you want to break the expected output across several lines, even though that's not how the test actually outputs it?</li><li class="listitem" style="list-style-type: disc">Which parts of an exception report are ignored by <code class="literal">doctest</code>?</li><li class="listitem" style="list-style-type: disc">When you assign a variable in a test file, which parts of the file can actually <span class="emphasis"><em>see</em></span> that variable?</li><li class="listitem" style="list-style-type: disc">Why do we care what code can <span class="emphasis"><em>see</em></span> the variables created by a test?</li><li class="listitem" style="list-style-type: disc">How can we make <code class="literal">doctest</code> not care what a section of output contains?</li></ul></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Exercise – English to doctest"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec26"/>Exercise – English to doctest</h1></div></div></div><p>Time to stretch <a id="id62" class="indexterm"/>your wings a bit. I'm going to give you a description of a single function in English. Your job is to copy the description into a new text file, and <a id="id63" class="indexterm"/>then add tests that describe all the requirements in a way that the computer can understand and check.</p><p>Try to make the doctests so that they're not just for the computer. Good doctests tend to clarify things for human readers as well. By and large, this means that you present them to human readers as examples interspersed with the text.</p><p>Without further ado, here is the English description:</p><div class="informalexample"><pre class="programlisting">The fib(N) function takes a single integer as its only parameter N. If N is 0 or 1, the function returns 1. If N is less than 0, the function raises a ValueError. Otherwise, the function returns the sum of fib(N – 1) and fib(N – 2). The returned value will never be less than 1. A naïve implementation of this function would get very slow as N increased.</pre></div><p>I'll give you a hint and point out that the last sentence about the function being slow, isn't really testable. As computers get faster, any test you write that depends on an arbitrary definition of "slow" will eventually fail. Also, there's no good way to test the difference between a slow function and a function stuck in an infinite loop, so there's not much point in trying. If you find yourself needing to do that, it's best to back off and try a different solution.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note05"/>Note</h3><p>Not being able to tell whether a function is stuck or just slow is called the halting problem by computer scientists. We know that it can't be solved unless we someday discover a fundamentally better kind of computer. Faster computers won't do the trick, and neither will quantum computers, so don't hold your breath.</p></div></div><p>The next-to-last sentence also provides some difficulty, since to test it completely would require running every positive integer through the <code class="literal">fib()</code> function, which would take forever (except that the computer will eventually run out of memory and force Python to raise an exception). How do we deal with this sort of thing, then?</p><p>The best solution is to <a id="id64" class="indexterm"/>check whether the condition holds true for a random sample of viable inputs. The <code class="literal">random.randrange()</code> and <code class="literal">random.choice()</code> functions <a id="id65" class="indexterm"/>in the Python standard library make that fairly easy to do.</p></div></div>


  <div id="sbo-rt-content"><div class="section" title="Embedding doctests into docstrings"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec27"/>Embedding doctests into docstrings</h1></div></div></div><p>It's just as <a id="id66" class="indexterm"/>easy to write doctests into docstrings as it is to write them into documentation files.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note06"/>Note</h3><p>For those <a id="id67" class="indexterm"/>who don't know, docstrings are a Python feature that allows programmers to embed documentation directly into their source code. The Python <code class="literal">help()</code> function is powered by docstrings. To learn more about docstrings, you can start with the Python tutorial section at <a class="ulink" href="https://docs.python.org/3/tutorial/controlflow.html#documentation-strings">https://docs.python.org/3/tutorial/controlflow.html#documentation-strings</a>.</p></div></div><p>When written in docstrings, doctests serve a slightly different purpose. They still let the computer check that things work as expected, but the humans who see them will most often be coders who use the Python interactive shell to work on an idea before committing it to code, or whose text editor pops up docstrings as they work. In that context, the most important thing a <code class="literal">doctest</code> can do is be informative, so docstrings aren't usually a good place for checking picky details. They're a great place for a <code class="literal">doctest</code> to demonstrate the proper behavior of a common case, though.</p><p>The doctests embedded in docstrings have a somewhat different execution scope than doctests in text files do. Instead of having a single scope for all of the tests in the file, <code class="literal">doctest</code> creates a single scope for each docstring. All of the tests that share a docstring also share an execution scope, but they're isolated from tests in the other docstrings.</p><p>The separation of each docstring into its own execution scope often means that we don't need to put much <a id="id68" class="indexterm"/>thought into isolating doctests when <a id="id69" class="indexterm"/>they're embedded in docstrings. This is fortunate, since docstrings are primarily intended for documentation, and the tricks required to isolate the tests might obscure the meaning.</p><div class="section" title="Example – a doctest in a docstring"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec23"/>Example – a doctest in a docstring</h2></div></div></div><p>We're going to <a id="id70" class="indexterm"/>embed a test right inside the Python source file that it tests, by placing it inside a docstring.</p><p>Create a file <a id="id71" class="indexterm"/>called <code class="literal">test.py</code> containing the following code:</p><div class="informalexample"><pre class="programlisting">def testable(x):
    r"""
    The `testable` function returns the square root of its
    parameter, or 3, whichever is larger.

    &gt;&gt;&gt; testable(7)
    3.0

    &gt;&gt;&gt; testable(16)
    4.0

    &gt;&gt;&gt; testable(9)
    3.0

    &gt;&gt;&gt; testable(10) == 10 ** 0.5
    True
    """
    if x &lt; 9:
        return 3.0
    return x ** 0.5</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note07"/>Note</h3><p>Notice the use of a raw string for the docstring (denoted by the <code class="literal">r</code> character before the first triple quote). Using raw strings for your docstrings is a good habit to get into, because you usually don't want escape sequences—for example, <code class="literal">\n</code> for newline— to be interpreted by the Python interpreter. You want them to be treated as text, so that they are correctly passed on to doctest.</p></div></div><p>Running these <a id="id72" class="indexterm"/>tests is just as easy as running the tests in a doctest document:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>python3 -m doctest test.py</strong></span></pre></div><p>Since all the tests pass, the output of this command is nothing at all. We can make it more interesting by adding the <a id="id73" class="indexterm"/>verbose flag to the command line:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>python3 -m doctest -v test.py</strong></span></pre></div></div><div class="section" title="Result – the code is now self-documenting and self-testable"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec24"/>Result – the code is now self-documenting and self-testable</h2></div></div></div><p>When we run the <a id="id74" class="indexterm"/>Python file through <code class="literal">doctest</code> with the verbose flag, we see the output, as shown in the the following screenshot:</p><div class="mediaobject"><img src="images/3211OS_02_04.jpg" alt="Result – the code is now self-documenting and self-testable"/></div><p>We put the <code class="literal">doctest</code> code right inside the docstring of the function it was testing. This is a good place for tests that also show a programmer how to do something. It's not a good place for detailed, low-level tests (the <code class="literal">doctest</code> in the docstring example code, which was quite detailed for illustrative purposes, is perhaps too detailed), because docstrings need to serve as API documentation—you can see the reason for this just by looking at the example, where the <a id="id75" class="indexterm"/>doctests take up most of the room in the docstring without telling the readers any more than they would have learned from a single test.</p><p>Any test that will serve as good API documentation is a good candidate for including in the docstrings of a Python file.</p><p>You might be wondering about the line that reads <code class="literal">1 items had no tests</code>, and the following line that just reads <code class="literal">test</code>. These lines are referring to the fact that there are no tests written in the module-level docstring. That's a little surprising, since we didn't include such a docstring <a id="id76" class="indexterm"/>in our source code at all, until you realize that, as far as Python (and thus <code class="literal">doctest</code>) is concerned, no docstring is the same as an empty docstring.</p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Putting it into practice – an AVL tree"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec28"/>Putting it into practice – an AVL tree</h1></div></div></div><p>We're going to <a id="id77" class="indexterm"/>walk step-by-step through the process of using <code class="literal">doctest</code> to create a testable specification for a data structure called an AVL tree. An AVL tree is a way to organize key-value pairs so that they can be quickly located by key. In other words, it's a lot like Python's built-in dictionary type. The name AVL references the initials of the people who invented this data structure.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note08"/>Note</h3><p>While AVL trees are similar to Python dictionaries, they have some significantly different properties. For one thing, the keys stored in an AVL tree can be iterated over in a sorted order with no overhead. Another difference is that, while inserting and removing objects in an AVL tree is slower than a Python <code class="literal">dict</code> in many cases, it's faster in the worst case.</p></div></div><p>As its name suggests, an AVL tree organizes the keys that are stored in it into a tree structure, with each key having up to two child keys —one child key that is less than the parent key by comparison, and one that is more. In the following figure, the <code class="literal">Elephant</code> key has two child keys, <code class="literal">Goose</code> has one, and <code class="literal">Aardvark</code> and <code class="literal">Frog</code> both have none.</p><p>The AVL tree is special because it keeps one side of the tree from getting much taller than the other, which means that users can expect it to perform reliably and efficiently no matter what. In the following figure, the AVL tree will reorganize to stay balanced if <code class="literal">Frog</code> gains a child:</p><div class="mediaobject"><img src="images/3211OS_02_05.jpg" alt="Putting it into practice – an AVL tree"/></div><p>We're going to write tests for an AVL tree implementation here, rather than writing the implementation itself, so we're going to gloss over the details of <span class="emphasis"><em>how</em></span> an AVL tree works, in favor of looking at <a id="id78" class="indexterm"/>what it should do when it works right.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note09"/>Note</h3><p>If you <a id="id79" class="indexterm"/>want to know more about AVL trees, you will find many good references on the Internet. Wikipedia's entry on this subject is a good place to start with: <a class="ulink" href="http://en.wikipedia.org/wiki/AVL_tree">http://en.wikipedia.org/wiki/AVL_tree</a>.</p></div></div><p>We're going to start with a plain-language specification, and then interject tests between the paragraphs. You don't have to actually type all of this into a text file; it is here for you to read and to think about.</p><div class="section" title="English specification"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec25"/>English specification</h2></div></div></div><p>The first step is to <a id="id80" class="indexterm"/>describe what the desired result should be, in normal language. This might be something that you do for yourself, or it might be something that somebody else does for you. If you're working for somebody, hopefully you and your employer can sit down together and work this part out.</p><p>In this case, there's not much to work out, because AVL trees have been fully described for decades. Even so, the description here isn't quite like the one you'd find elsewhere. This capacity for ambiguity is exactly the reason why a plain-language specification isn't good enough. We need an unambiguous specification, and that's exactly what the tests in a doctest file can give us.</p><p>The following text goes <a id="id81" class="indexterm"/>in a file called <code class="literal">AVL.txt</code>, (that you can find in its final form in the accompanying code archive; at this stage of the process, the file contains only the normal language specification):</p><div class="informalexample"><pre class="programlisting">An AVL Tree consists of a collection of nodes organized in a binary tree structure. Each node has left and right children, each of which may be either None or another tree node. Each node has a key, which must be comparable via the less-than operator. Each node has a value. Each node also has a height number, measuring how far the node is from being a leaf of the tree -- a node with height 0 is a leaf.

The binary tree structure is maintained in ordered form, meaning that of a node's two children, the left child has a key that compares less than the node's key and the right child has a key that compares greater than the node's key.

The binary tree structure is maintained in a balanced form, meaning that for any given node, the heights of its children are either the same or only differ by 1.

The node constructor takes either a pair of parameters representing a key and a value, or a dict object representing the key-value pairs with which to initialize a new tree.

The following methods target the node on which they are called, and can be considered part of the internal mechanism of the tree:

Each node has a recalculate_height method, which correctly sets the height number.

Each node has a make_deletable method, which exchanges the positions of the node and one of its leaf descendants, such that the tree ordering of the nodes remains correct.

Each node has rotate_clockwise and rotate_counterclockwise methods. Rotate_clockwise takes the node's right child and places it where the node was, making the node into the left child of its own former child. Other nodes in the vicinity are moved so as to maintain the tree ordering. The opposite operation is performed by rotate_counterclockwise.

Each node has a locate method, taking a key as a parameter, which searches the node and its descendants for a node with the specified key, and either returns that node or raises a KeyError.

The following methods target the whole tree rooted at the current node. The intent is that they will be called on the root node:

Each node has a get method taking a key as a parameter, which locates the value associated with the specified key and returns it, or raises KeyError if the key is not associated with any value in the tree.

Each node has a set method taking a key and a value as parameters, and associating the key and value within the tree.

Each node has a remove method taking a key as a parameter, and removing the key and its associated value from the tree. It raises KeyError if no value was associated with that key.</pre></div></div><div class="section" title="Node data"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec26"/>Node data</h2></div></div></div><p>The first three <a id="id82" class="indexterm"/>paragraphs of the specification describe the member variables of an AVL tree node, and tell us what the valid values for the variables are. They also tell <a id="id83" class="indexterm"/>us how the tree height should be measured and define what a balanced tree means. It's our job now to take these ideas, and encode them into tests that the computer can eventually use to check our code.</p><p>We can check these specifications by creating a node and then testing the values, but that would really just be a test of the constructor. It's important to test the constructor, but what we really want to do is to incorporate checks that the node variables are left in a valid state into our tests of each member function.</p><p>To that end, we'll define functions that our tests can call to check that the state of a node is valid. We'll define these functions just after the third paragraph, because they provide extra details related to the content of the first three paragraphs:</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note10"/>Note</h3><p>Notice that the node data test is written as if the AVL tree implementation already existed. It tries to import an <code class="literal">avl_tree</code> module containing an AVL class, and it tries to use the AVL class in specific ways. Of course, at the moment there is no <code class="literal">avl_tree</code> module, so the tests will fail. This is as it should be. All that the failure means is that, when the time comes to implement the tree, we should do so in a module called <code class="literal">avl_tree</code>, with contents that function as our tests assume. Part of the benefit of testing like this is being able to test-drive your code before you even write it.</p></div></div><div class="informalexample"><pre class="programlisting">&gt;&gt;&gt; from avl_tree import AVL

&gt;&gt;&gt; def valid_state(node):
...     if node is None:
...         return
...     if node.left is not None:
...         assert isinstance(node.left, AVL)
...         assert node.left.key &lt; node.key
...         left_height = node.left.height + 1
...     else:
...         left_height = 0
...
...     if node.right is not None:
...         assert isinstance(node.right, AVL)
...         assert node.right.key &gt; node.key
...         right_height = node.right.height + 1
...     else:
...         right_height = 0
...
...     assert abs(left_height - right_height) &lt; 2
...     node.key &lt; node.key
...     node.value

&gt;&gt;&gt; def valid_tree(node):
...     if node is None:
...         return
...     valid_state(node)
...     valid_tree(node.left)
...     valid_tree(node.right)</pre></div><p>Notice that we didn't actually call these functions yet. They aren't tests, as such, but tools that we'll use to simplify <a id="id84" class="indexterm"/>writing tests. We define them here, rather than in the Python <a id="id85" class="indexterm"/>module that we're going to test, because they aren't conceptually part of the tested code, and because anyone who reads the tests will need to be able to see what the helper functions do.</p></div><div class="section" title="Testing the constructor"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec27"/>Testing the constructor</h2></div></div></div><p>The fourth <a id="id86" class="indexterm"/>paragraph describes the constructor of the AVL class. According to this paragraph, the constructor has two modes of operation: it can create a single initialized <a id="id87" class="indexterm"/>node, or it can create and initialize a whole tree of nodes based on the contents of a dictionary.</p><p>The test for the single node mode is easy. We'll add it after the fourth paragraph:</p><div class="informalexample"><pre class="programlisting">&gt;&gt;&gt; valid_state(AVL(2, 'Testing is fun'))</pre></div><p>We don't even have to write an expected result, since we wrote the function to raise an <code class="literal">AssertionError</code> if there's a problem and to return None if everything is fine. <code class="literal">AssertionError</code> is triggered by the <code class="literal">assert</code> statement in our test code, if the expression in the <code class="literal">assert</code> statement produces a false value.</p><p>The test for the second mode looks just as easy, and we'll add it right after the other:</p><div class="informalexample"><pre class="programlisting">&gt;&gt;&gt; valid_tree(AVL({1: 'Hello', 2: 'World', -3: '!'}))</pre></div><p>There's a bit of buried complexity here, though. In all probability, this constructor will function by initializing a single node and then using that node's <code class="literal">set</code> method to add the rest of the keys and values to the tree. This means that our second constructor test isn't a unit test, it's an integration test that checks the interaction of multiple units.</p><p>Specification documents often contains integration-level and system-level tests, so this isn't really a problem. It's something to be aware of, though, because if this test fails it won't necessarily show you where the problem really lies. Your unit tests will do that.</p><p>Something else to notice is that we didn't check whether the constructor fails appropriately when given bad inputs. These tests are very important, but the English specification didn't mention these points at all, which means that they're not really among the acceptance criteria. We'll add these tests to the unit test suite instead.</p></div><div class="section" title="Recalculating height"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec28"/>Recalculating height</h2></div></div></div><p>The <a id="id88" class="indexterm"/>
<code class="literal">recalculate_height()</code> method is described in the fifth paragraph of the specification. To test it, we're going to need a tree for it to operate on, and we don't want to use the second mode of the constructor to create it —after all, we <a id="id89" class="indexterm"/>want this test to be independent of any errors that might exist there. We'd really prefer to make the test entirely independent of the constructor but, <a id="id90" class="indexterm"/>in this case, we need to make a small exception to the rule, since it's mighty difficult to create an object without calling its constructor in some way.</p><p>What we're going to do is define a function that builds a specific tree and returns it. This function will be useful in several of our later tests as well:</p><div class="informalexample"><pre class="programlisting">&gt;&gt;&gt; def make_test_tree():
...     root = AVL(7, 'seven')
...     root.height = 2
...     root.left = AVL(3, 'three')
...     root.left.height = 1
...     root.left.right = AVL(4, 'four')
...     root.right = AVL(10, 'ten')
...     return root</pre></div><p>Now that we <a id="id91" class="indexterm"/>have the <code class="literal">make_test_tree()</code> function, testing <code class="literal">recalculate_height()</code>
<a id="id92" class="indexterm"/>is easy:</p><div class="informalexample"><pre class="programlisting">&gt;&gt;&gt; tree = make_test_tree()
&gt;&gt;&gt; tree.height = 0
&gt;&gt;&gt; tree.recalculate_height()
&gt;&gt;&gt; tree.height
2</pre></div></div><div class="section" title="Making a node deletable"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec29"/>Making a node deletable</h2></div></div></div><p>The sixth <a id="id93" class="indexterm"/>paragraph of the specification described the <code class="literal">make_deletable()</code> method. You can't delete a node that has children, because that would leave the node's <a id="id94" class="indexterm"/>children disconnected from the rest of the tree. Consider the tree with animal names in it that we looked at earlier. If we delete the <code class="literal">Elephant</code> node from the bottom of the tree, what do we do about <code class="literal">Aardvark</code>, <code class="literal">Goose</code>, and <code class="literal">Frog</code>? If we delete <code class="literal">Goose</code>, how do we find <code class="literal">Frog</code> afterwards?</p><div class="mediaobject"><img src="images/3211OS_02_05.jpg" alt="Making a node deletable"/></div><p>The way around that is to have the node swap places with its largest leaf descendant on the left side (or its smallest leaf descendant on the right side, but we're not doing it that way).</p><p>We'll test <a id="id95" class="indexterm"/>this by using the same <code class="literal">make_test_tree()</code> function <a id="id96" class="indexterm"/>that we defined earlier to create a new tree to work on, and then check whether <code class="literal">make_deletable()</code> swaps correctly:</p><div class="informalexample"><pre class="programlisting">&gt;&gt;&gt; tree = make_test_tree()
&gt;&gt;&gt; target = tree.make_deletable()
&gt;&gt;&gt; (tree.value, tree.height)
('four', 2)
&gt;&gt;&gt; (target.value, target.height)
('seven', 0)</pre></div></div><div class="section" title="Rotation"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec30"/>Rotation</h2></div></div></div><p>The two rotate <a id="id97" class="indexterm"/>functions, described in paragraph seven of the specification, perform a somewhat tricky manipulation of the links in a tree. You probably <a id="id98" class="indexterm"/>found the plain language description of what they do a bit confusing. This is one of those times when a little bit of code makes a whole lot more sense than any number of sentences.</p><p>While tree rotation is usually defined in terms of rearranging the links between nodes in the tree, we'll check whether it worked by looking at the values rather than by looking directly at the left and right links. This allows the implementation to swap the contents of nodes, rather than the nodes themselves, when it wishes. After all, it's not important to the specification which <a id="id99" class="indexterm"/>operation happens, so we shouldn't rule out a <a id="id100" class="indexterm"/>perfectly reasonable implementation choice:</p><div class="informalexample"><pre class="programlisting">&gt;&gt;&gt; tree = make_test_tree()
&gt;&gt;&gt; tree.value
'seven'
&gt;&gt;&gt; tree.left.value
'three'
&gt;&gt;&gt; tree.rotate_counterclockwise()
&gt;&gt;&gt; tree.value
'three'
&gt;&gt;&gt; tree.left is None
True
&gt;&gt;&gt; tree.right.value
'seven'
&gt;&gt;&gt; tree.right.left.value
'four'
&gt;&gt;&gt; tree.right.right.value
'ten'
&gt;&gt;&gt; tree.right.left.value
'four'
&gt;&gt;&gt; tree.left is None
True

&gt;&gt;&gt; tree.rotate_clockwise()
&gt;&gt;&gt; tree.value
'seven'
&gt;&gt;&gt; tree.left.value
'three'
&gt;&gt;&gt; tree.left.right.value
'four'
&gt;&gt;&gt; tree.right.value
'ten'
&gt;&gt;&gt; tree.right.left is None
True
&gt;&gt;&gt; tree.left.left is None
True</pre></div></div><div class="section" title="Locating a node"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec31"/>Locating a node</h2></div></div></div><p>According to the <a id="id101" class="indexterm"/>eighth paragraph of the specification, the <code class="literal">locate()</code> method is <a id="id102" class="indexterm"/>expected to return a node, or raise a <code class="literal">KeyError</code> exception, depending on whether the key exists in the tree or not. We'll use our specially built testing tree again, so that we know exactly what the tree's structure looks like:</p><div class="informalexample"><pre class="programlisting">&gt;&gt;&gt; tree = make_test_tree()
&gt;&gt;&gt; tree.locate(4).value
'four'
&gt;&gt;&gt; tree.locate(17) # doctest: +ELLIPSIS
Traceback (most recent call last):
KeyError: ...</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip03"/>Tip</h3><p>
<span class="strong"><strong>Downloading the example code</strong></span></p><p>You can download the example code files for all Packt books you have purchased from your account at <a class="ulink" href="http://www.packtpub.com">http://www.packtpub.com</a>. If you purchased this book elsewhere, you can visit <a class="ulink" href="http://www.packtpub.com/support">http://www.packtpub.com/support</a> and register to have the files e-mailed directly to you.</p></div></div></div><div class="section" title="The rest of the specification"><div class="titlepage"><div><div><h2 class="title"><a id="ch02lvl2sec32"/>The rest of the specification</h2></div></div></div><p>The remaining <a id="id103" class="indexterm"/>paragraphs of the specification describe higher-level functions that operate by calling the already described functions. This means that, until we learn the tricks of mock objects in <a class="link" href="ch04.html" title="Chapter 4. Decoupling Units with unittest.mock">Chapter 4</a>, <span class="emphasis"><em>Decoupling Units with unittest.mock</em></span>, we're stuck with writing integration-level tests here. As I mentioned earlier, this is not a terrible thing to do in a specification document, so we'll go ahead and do it:</p><div class="informalexample"><pre class="programlisting">Each node has a get method taking a key as a parameter, which locates
the value associated with the specified key and returns it, or raises
KeyError if the key is not associated with any value in the tree.

&gt;&gt;&gt; tree = make_test_tree()
&gt;&gt;&gt; tree.get(10)
'ten'
&gt;&gt;&gt; tree.get(97) # doctest: +ELLIPSIS
Traceback (most recent call last):
KeyError: ...

Each node has a set method taking a key and a value as parameters, and
associating the key and value within the tree.

&gt;&gt;&gt; tree = make_test_tree()
&gt;&gt;&gt; tree.set(10, 'foo')
&gt;&gt;&gt; tree.locate(10).value
'foo'

Each node has a remove method taking a key as a parameter, and
removing the key and its associated value from the tree. It raises
KeyError if no values was associated with that key.

&gt;&gt;&gt; tree = make_test_tree()
&gt;&gt;&gt; tree.remove(3)
&gt;&gt;&gt; tree.remove(3) # doctest: +ELLIPSIS
Traceback (most recent call last):
KeyError: ...</pre></div></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch02lvl1sec29"/>Summary</h1></div></div></div><p>We learned the syntax of <code class="literal">doctest</code>, and went through several examples describing how to use it. After that, we took a real-world specification for the AVL tree, and examined how to formalize it as a set of doctests, so that we could use it to automatically check the correctness of an implementation.</p><p>Specifically, we covered doctest's default syntax and the directives that alter it, how to write doctests in text files, how to write doctests in Python docstrings, and what it feels like to use <code class="literal">doctest</code> to turn a specification into tests.</p><p>Now that we've learned about <code class="literal">doctest</code>, we're ready to talk about how to use <code class="literal">doctest</code> to do unit testing—the topic of the next chapter.</p></div></div>
</body></html>