<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Forms and Views</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Passing HttpRequest to the form</li><li class="listitem" style="list-style-type: disc">Utilizing the save method of the form</li><li class="listitem" style="list-style-type: disc">Uploading images</li><li class="listitem" style="list-style-type: disc">Creating form layout with django-crispy-forms</li><li class="listitem" style="list-style-type: disc">Downloading authorized files</li><li class="listitem" style="list-style-type: disc">Filtering object lists</li><li class="listitem" style="list-style-type: disc">Managing paginated lists</li><li class="listitem" style="list-style-type: disc">Composing class-based views</li><li class="listitem" style="list-style-type: disc">Generating PDF documents</li><li class="listitem" style="list-style-type: disc">Implementing a multilingual search with Haystack</li></ul></div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec36"/>Introduction</h1></div></div></div><p>When the database structure is defined in the models, we need some views to let the users enter data or show the data to the people. In this chapter, we will focus on the views managing forms, the list view, and views generating an alternative output than HTML. For the simplest examples, we will leave the creation of URL rules and templates up to you.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec37"/>Passing HttpRequest to the form</h1></div></div></div><p>The first <a class="indexterm" id="id132"/>argument of every Django view is the <code class="literal">HttpRequest</code> object<a class="indexterm" id="id133"/> that is usually named <code class="literal">request</code>. It contains metadata about the request. For example, current language code, current user, current cookies, and current session. By default, the forms that are used in the views accept the <code class="literal">GET</code> or <code class="literal">POST</code> parameters, files, initial data, and other parameters; however, not the <code class="literal">HttpRequest</code> object. In some cases, it is useful to additionally pass <code class="literal">HttpRequest</code> to the form, especially when you want to filter out the choices of form fields using the request data or handle saving something such as the current user or IP in the form.</p><p>In this recipe, we will see an example of a form where a person can choose a user and write a message to them. We will pass the <code class="literal">HttpRequest</code> object to the form in order to exclude the current user from the recipient choices; we don't want anybody to write a message to themselves.</p><div><div><div><div><h2 class="title"><a id="ch03lvl2sec111"/>Getting ready</h2></div></div></div><p>Let's<a class="indexterm" id="id134"/> create a new app called <code class="literal">email_messages</code> and put it in <code class="literal">INSTALLED_APPS</code> in<a class="indexterm" id="id135"/> the settings. This app will have no models, just forms and views.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec112"/>How to do it…</h2></div></div></div><p>To complete this recipe, execute the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Add a new <code class="literal">forms.py</code> file with the message form containing two fields: the recipient selection and message text. Also, this form will have an initialization method, which will accept the request object and then, modify <code class="literal">QuerySet</code> for the recipient's selection field:<div><pre class="programlisting">
<strong># email_messages/forms.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django import forms
from django.utils.translation import ugettext_lazy as _
from django.contrib.auth.models import User

class MessageForm(forms.Form):
    recipient = forms.ModelChoiceField(
        label=_("Recipient"),
        queryset=User.objects.all(),
        required=True,
    )
    message = forms.CharField(
        label=_("Message"),
        widget=forms.Textarea,
        required=True,
    )

    def __init__(self, <strong>request</strong>, *args, **kwargs):
        super(MessageForm, self).__init__(*args, **kwargs)
<strong>        self.request = request</strong>
        self.fields["recipient"].queryset = \
            self.fields["recipient"].queryset.\
            exclude(pk=request.user.pk)</pre></div></li><li class="listitem">Then, create <code class="literal">views.py</code> with the <code class="literal">message_to_user()</code> view in order to handle<a class="indexterm" id="id136"/> the form. As you can see, the request<a class="indexterm" id="id137"/> object is passed as the first parameter to the form, as follows:<div><pre class="programlisting">
<strong># email_messages/views.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.contrib.auth.decorators import login_required
from django.shortcuts import render, redirect

from .forms import MessageForm

@login_required
def message_to_user(request):
    if request.method == "POST":
        form = MessageForm(<strong>request</strong>, data=request.POST)
        if form.is_valid():
            # do something with the form
            return redirect("message_to_user_done")
    else:
        form = MessageForm(<strong>request</strong>)

    return render(request,
        "email_messages/message_to_user.html",
        {"form": form}
    )</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec113"/>How it works…</h2></div></div></div><p>In the initialization method, we have the <code class="literal">self</code> variable that represents the instance of the form itself, we also have the newly added <code class="literal">request</code> variable, and then we have the rest of the positional arguments (<code class="literal">*args</code>) and named arguments (<code class="literal">**kwargs</code>). We call the <code class="literal">super()</code> initialization method passing all the positional and named arguments to it so that the form is properly initiated. We will then assign the <code class="literal">request</code> variable to a new <code class="literal">request</code> attribute of the form for later access in other methods of the form. Then, we modify the <code class="literal">queryset</code> attribute of the recipient's selection field, excluding the current user from the request.</p><p>In the view, we will pass the <code class="literal">HttpRequest</code> object as the first argument in both situations: when the form is posted, as well as when it is loaded for the first time.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec114"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Utilizing the save method of the form</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec38"/>Utilizing the save method of the form</h1></div></div></div><p>To make<a class="indexterm" id="id138"/> your views clean and simple, it is good practice to <a class="indexterm" id="id139"/>move the handling of the form data to the form itself whenever possible and makes sense. The common practice is to have a <code class="literal">save()</code> method that will save the data, perform search, or do some other smart actions. We will extend the form that is defined in the previous recipe with the <code class="literal">save()</code> method, which will send an e-mail to the selected recipient.</p><div><div><div><div><h2 class="title"><a id="ch03lvl2sec115"/>Getting ready</h2></div></div></div><p>We will build upon the example that is defined in the <em>Passing HttpRequest to the form</em> recipe.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec116"/>How to do it…</h2></div></div></div><p>To complete this recipe, execute the following two steps:</p><div><ol class="orderedlist arabic"><li class="listitem">From Django, import the function in order to send an e-mail. Then, add the <code class="literal">save()</code> method to <code class="literal">MessageForm</code>. It will try to send an e-mail to the selected recipient and will fail silently if any errors occur:<div><pre class="programlisting">
<strong># email_messages/forms.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django import forms
from django.utils.translation import ugettext,\
    ugettext_lazy as _
<strong>from django.core.mail import send_mail</strong>
from django.contrib.auth.models import User

class MessageForm(forms.Form):
    recipient = forms.ModelChoiceField(
        label=_("Recipient"),
        queryset=User.objects.all(),
        required=True,
    )
    message = forms.CharField(
        label=_("Message"),
        widget=forms.Textarea,
        required=True,
    )

    def __init__(self, request, *args, **kwargs):
        super(MessageForm, self).__init__(*args, **kwargs)
        self.request = request
        self.fields["recipient"].queryset = \
            self.fields["recipient"].queryset.\
            exclude(pk=request.user.pk)

<strong>    def save(self):</strong>
<strong>        cleaned_data = self.cleaned_data</strong>
<strong>        send_mail(</strong>
<strong>            subject=ugettext("A message from %s") % \</strong>
<strong>                self.request.user,</strong>
<strong>            message=cleaned_data["message"],</strong>
<strong>            from_email=self.request.user.email,</strong>
<strong>            recipient_list=[</strong>
<strong>                cleaned_data["recipient"].email</strong>
<strong>            ],</strong>
<strong>            fail_silently=True,</strong>
<strong>        )</strong>
</pre></div></li><li class="listitem">Then, call<a class="indexterm" id="id140"/> the <code class="literal">save()</code> method from the form<a class="indexterm" id="id141"/> in the view if the posted data is valid:<div><pre class="programlisting">
<strong># email_messages/views.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.contrib.auth.decorators import login_required
from django.shortcuts import render, redirect

from .forms import MessageForm

@login_required
def message_to_user(request):
    if request.method == "POST":
        form = MessageForm(request, data=request.POST)
        if form.is_valid():
<strong>            form.save()</strong>
            return redirect("message_to_user_done")
    else:
        form = MessageForm(request)

    return render(request,
        "email_messages/message_to_user.html",
        {"form": form}
    )</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec117"/>How it works…</h2></div></div></div><p>Let's take a look at the form. The <code class="literal">save()</code> method uses the cleaned data from the form to read the recipient's e-mail address and the message. The sender of the e-mail is the current <a class="indexterm" id="id142"/>user from the request. If the e-mail cannot be sent due<a class="indexterm" id="id143"/> to an incorrect mail server configuration or another reason, it will fail silently; that is, no error will be raised.</p><p>Now, let's look at the view. When the posted form is valid, the <code class="literal">save()</code> method of the form will be called and the user will be redirected to the success page.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec118"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Passing HttpRequest to the form</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Downloading authorized files</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec39"/>Uploading images</h1></div></div></div><p>In this recipe, we will take a look at the easiest way to handle image uploads. You will see an example of an app, where the visitors can upload images with inspirational quotes.</p><div><div><div><div><h2 class="title"><a id="ch03lvl2sec119"/>Getting ready</h2></div></div></div><p>Make sure<a class="indexterm" id="id144"/> to have Pillow or PIL installed in your virtual environment or globally.</p><p>Then, let's create a <code class="literal">quotes</code> app and put it in <code class="literal">INSTALLED_APPS</code> in the settings. Then, we will add an <code class="literal">InspirationalQuote</code> model with three fields: the <code class="literal">author</code>, <code class="literal">quote</code> text, and <code class="literal">picture</code>, as follows:</p><div><pre class="programlisting">
<strong># quotes/models.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
import os
from django.db import models
from django.utils.timezone import now as timezone_now
from django.utils.translation import ugettext_lazy as _
from django.utils.encoding import python_2_unicode_compatible

<strong>def upload_to(instance, filename):</strong>
<strong>    now = timezone_now()</strong>
<strong>    filename_base, filename_ext = os.path.splitext(filename)</strong>
<strong>    return "quotes/%s%s" % (</strong>
<strong>        now.strftime("%Y/%m/%Y%m%d%H%M%S"),</strong>
<strong>        filename_ext.lower(),</strong>
<strong>    )</strong>
    
@python_2_unicode_compatible
class InspirationalQuote(models.Model):
    author = models.CharField(_("Author"), max_length=200)
    quote = models.TextField(_("Quote"))
    picture = models.ImageField(_("Picture"),
<strong>        upload_to=upload_to,</strong>
        blank=True,
        null=True,
    )
    
    class Meta:
        verbose_name = _("Inspirational Quote")
        verbose_name_plural = _("Inspirational Quotes")
        
    def __str__(self):
        return self.quote</pre></div><p>In addition, we <a class="indexterm" id="id145"/>created an <code class="literal">upload_to()</code> function, which sets the path of the uploaded picture to be something similar to <code class="literal">quotes/2015/04/20150424140000.png</code>. As you can see, we use the date timestamp as the filename to ensure its uniqueness. We pass this function to the <code class="literal">picture</code> image field.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec120"/>How to do it…</h2></div></div></div><p>Execute these steps to complete the recipe:</p><div><ol class="orderedlist arabic"><li class="listitem">Create the <code class="literal">forms.py</code> file and put a simple model form there:<div><pre class="programlisting">
<strong># quotes/forms.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django import forms
from .models import InspirationalQuote

class InspirationalQuoteForm(forms.ModelForm):
    class Meta:
        model = InspirationalQuote
        fields = ["author", "quote", "picture", "language"]</pre></div></li><li class="listitem">In the <code class="literal">views.py</code> file, put a view that handles the form. Don't forget to pass the <code class="literal">FILES</code> dictionary-like object to the form. When the form is valid, trigger the save method as follows:<div><pre class="programlisting">
<strong># quotes/views.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.shortcuts import redirect
from django.shortcuts import render
from .forms import InspirationalQuoteForm

def add_quote(request):
    if request.method == "POST":
        form = InspirationalQuoteForm(
            data=request.POST,
            files=request.FILES,
        )
        if form.is_valid():
            quote = <strong>form.save()</strong>
            return redirect("add_quote_done")
    else:
        form = InspirationalQuoteForm()
    return render(request,
        "quotes/change_quote.html",
        {"form": form}
    )</pre></div></li><li class="listitem">Lastly, create a template for the view in <code class="literal">templates/quotes/change_quote.html</code>. It is very important to set the <code class="literal">enctype</code> attribute to <code class="literal">multipart/form-data</code> for the HTML form, otherwise the file <a class="indexterm" id="id146"/>upload won't work:<div><pre class="programlisting">
<strong>{# templates/quotes/change_quote.html #}</strong>
{% extends "base.html" %}
{% load i18n %}

{% block content %}
    &lt;form method="post" action="" enctype="multipart/form-data"&gt;
        {% csrf_token %}
        {{ form.as_p }}
        &lt;button type="submit"&gt;{% trans "Save" %}&lt;/button&gt;
    &lt;/form&gt;
{% endblock %}</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec121"/>How it works…</h2></div></div></div><p>Django model forms are forms that are created from models. They provide all the fields from the model so you don't need to define them again. In the preceding example, we created a model form for the <code class="literal">InspirationalQuote</code> model. When we save the form, the form knows how to save each field in the database, as well as to upload the files and save them in the media directory.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec122"/>There's more</h2></div></div></div><p>As a bonus, we will see an example of how to generate a thumbnail out of the uploaded image. Using this technique, you could also generate several other specific versions of the image, such <a class="indexterm" id="id147"/>as the list version, mobile version, and desktop computer version.</p><p>We will add three methods to the <code class="literal">InspirationalQuote</code> model (<code class="literal">quotes/models.py</code>). They are <code class="literal">save()</code>, <code class="literal">create_thumbnail()</code>, and <code class="literal">get_thumbnail_picture_url()</code>. When the model is being saved, we will trigger the creation of the thumbnail. When we need to show the thumbnail in a template, we can get its URL using <code class="literal">{{ quote.get_thumbnail_picture_url }}</code>. The method definitions are as follows:</p><div><pre class="programlisting">
<strong># quotes/models.py</strong>
# …
from PIL import Image
from django.conf import settings
from django.core.files.storage import default_storage as storage
THUMBNAIL_SIZE = getattr(
    settings,
    "QUOTES_THUMBNAIL_SIZE",
    (50, 50)
)

class InspirationalQuote(models.Model):
    # …
    def save(self, *args, **kwargs):
        super(InspirationalQuote, self).save(*args, **kwargs)
        # generate thumbnail picture version
        self.create_thumbnail()

    def create_thumbnail(self):
        if not self.picture:
            return ""
        file_path = self.picture.name
        filename_base, filename_ext = os.path.splitext(file_path)
        thumbnail_file_path = "%s_thumbnail.jpg" % filename_base
        if storage.exists(thumbnail_file_path):
            # if thumbnail version exists, return its url path
            return "exists"
        try:
            # resize the original image and
            # return URL path of the thumbnail version
            f = storage.open(file_path, 'r')
            image = Image.open(f)
            width, height = image.size

            if width &gt; height:
                delta = width - height
                left = int(delta/2)
                upper = 0
                right = height + left
                lower = height
            else:
                delta = height - width
                left = 0
                upper = int(delta/2)
                right = width
                lower = width + upper

            image = image.crop((left, upper, right, lower))
            image = image.resize(THUMBNAIL_SIZE, Image.ANTIALIAS)

            f_mob = storage.open(thumbnail_file_path, "w")
            image.save(f_mob, "JPEG")
            f_mob.close()
            return "success"
        except:
            return "error"

    def get_thumbnail_picture_url(self):
        if not self.picture:
            return ""
        file_path = self.picture.name
        filename_base, filename_ext = os.path.splitext(file_path)
        thumbnail_file_path = "%s_thumbnail.jpg" % filename_base
        if storage.exists(thumbnail_file_path):
            # if thumbnail version exists, return its URL path
            return storage.url(thumbnail_file_path)
        # return original as a fallback
        return self.picture.url</pre></div><p>In the<a class="indexterm" id="id148"/> preceding methods, we are using the file storage API instead of directly juggling the filesystem, as we could then exchange the default storage with Amazon S3 buckets or other storage services and the methods will still work.</p><p>How does the creating the thumbnail work? If we had the original file saved as <code class="literal">quotes/2014/04/20140424140000.png</code>, we are checking whether the <code class="literal">quotes/2014/04/20140424140000_thumbnail.jpg</code> file doesn't exist and, in that case, we<a class="indexterm" id="id149"/> are opening the original image, cropping it from the center, resizing it to 50 x 50 pixels, and saving it to the storage.</p><p>The <code class="literal">get_thumbnail_picture_url()</code> method checks whether the thumbnail version exists in the storage and returns its URL. If the thumbnail version does not exist, the URL of the original image is returned as a fallback.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec123"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Creating a form layout with django-crispy-forms</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec40"/>Creating a form layout with django-crispy-forms</h1></div></div></div><p>The <code class="literal">django-crispy-forms</code> Django app allows you to build, customize, and reuse forms using one<a class="indexterm" id="id150"/> of the following CSS frameworks: Uni-Form, Bootstrap, or Foundation. The usage of <code class="literal">django-crispy-forms</code> is <a class="indexterm" id="id151"/>analogous to fieldsets in the Django contributed administration; however, it is more advanced and customizable. You define form layout in the Python code and you don't need to worry about how each field is presented in HTML. However, if you need to add specific HTML attributes or wrapping, you can easily do that too. Moreover, all the markup used by <code class="literal">django-crispy-forms</code> is located in the templates that can be overwritten for specific needs.</p><p>In this recipe, we will see an example of how to use <code class="literal">django-crispy-forms</code> with Bootstrap 3, which is the most popular frontend framework to develop responsive, mobile-first web projects.</p><div><div><div><div><h2 class="title"><a id="ch03lvl2sec124"/>Getting ready</h2></div></div></div><p>To start with, execute the following tasks one by one:</p><p>Download the Bootstrap frontend framework from <a class="ulink" href="http://getbootstrap.com/">http://getbootstrap.com/</a> and integrate CSS and JavaScript in the<a class="indexterm" id="id152"/> templates. Learn more about this in the <em>Arranging the base.html template</em> recipe in <a class="link" href="ch04.html" title="Chapter 4. Templates and JavaScript">Chapter 4</a>, <em>Templates and JavaScript</em>.</p><p>Install <code class="literal">django-crispy-forms</code> in your virtual environment using the following command:</p><div><pre class="programlisting">
<strong>(myproject_env)$ pip install django-crispy-forms</strong>
</pre></div><p>Make sure that <code class="literal">crispy_forms</code> is added to <code class="literal">INSTALLED_APPS</code> and then set <code class="literal">bootstrap3</code> as the template pack to be used in this project:</p><div><pre class="programlisting"># conf/base.py or settings.py
INSTALLED_APPS = (
    # …
    "crispy_forms",
)
# …
CRISPY_TEMPLATE_PACK = "bootstrap3"</pre></div><p>Let's<a class="indexterm" id="id153"/> create a <code class="literal">bulletin_board</code> app<a class="indexterm" id="id154"/> to illustrate the usage of <code class="literal">django-crispy-forms</code> and put it in <code class="literal">INSTALLED_APPS</code> in the settings. We will have a <code class="literal">Bulletin</code> model there with these fields: <code class="literal">bulletin_type</code>, <code class="literal">title</code>, <code class="literal">description</code>, <code class="literal">contact_person</code>, <code class="literal">phone</code>, <code class="literal">email</code>, and <code class="literal">image</code> as follows:</p><div><pre class="programlisting">
<strong># bulletin_board/models.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.db import models
from django.utils.translation import ugettext_lazy as _
from django.utils.encoding import python_2_unicode_compatible

TYPE_CHOICES = (
    ('searching', _("Searching")),
    ('offering', _("Offering")),
)

@python_2_unicode_compatible
class Bulletin(models.Model):
    bulletin_type = models.CharField(_("Type"), max_length=20, choices=TYPE_CHOICES)
    
    title = models.CharField(_("Title"), max_length=255)
    description = models.TextField(_("Description"),
        max_length=300)
    
    contact_person = models.CharField(_("Contact person"),
        max_length=255)
    phone = models.CharField(_("Phone"), max_length=200,
blank=True)
    email = models.EmailField(_("Email"), blank=True)
    
    image = models.ImageField(_("Image"), max_length=255,
        upload_to="bulletin_board/", blank=True)

    class Meta:
        verbose_name = _("Bulletin")
        verbose_name_plural = _("Bulletins")
        ordering = ("title",)

    def __str__(self):
        return self.title</pre></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec125"/>How to do it…</h2></div></div></div><p>Follow these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Let's<a class="indexterm" id="id155"/> add a model form<a class="indexterm" id="id156"/> for the bulletin in the newly created app. We will attach a form helper to the form in the initialization method itself. The form helper will have the layout property that will define the layout for the form, as follows:<div><pre class="programlisting">
<strong># bulletin_board/forms.py</strong>
# -*- coding: UTF-8 -*-
from django import forms
from django.utils.translation import ugettext_lazy as _,\
    ugettext
from crispy_forms.helper import FormHelper
from crispy_forms import layout, bootstrap
from .models import Bulletin

class BulletinForm(forms.ModelForm):
  class Meta:
    model = Bulletin
    fields = ["bulletin_type", "title", "description", 
    "contact_person", "phone", "email", "image"]

    def __init__(self, *args, **kwargs):
      super(BulletinForm, self).__init__(*args, **kwargs)

      self.helper = FormHelper()
      self.helper.form_action = ""
      self.helper.form_method = "POST"

      self.fields["bulletin_type"].widget = \
        forms.RadioSelect()
      # delete empty choice for the type
      del self.fields["bulletin_type"].choices[0]

      self.helper.layout = layout.Layout(
        layout.Fieldset(
          _("Main data"),
          layout.Field("bulletin_type"),
          layout.Field("title", 
            css_class="input-block-level"),
            layout.Field("description", 
            css_class="input-blocklevel",
            rows="3"),
          ),
          layout.Fieldset(
            _("Image"),
            layout.Field("image", 
              css_class="input-block-level"),
            layout.HTML(u"""{% load i18n %}
              &lt;p class="help-block"&gt;{% trans "Available formats are JPG, GIF, and PNG. Minimal size is 800 × 800 px." %}&lt;/p&gt;
            """),
            title=_("Image upload"),
            css_id="image_fieldset",
          ),
          layout.Fieldset(
            _("Contact"),
            layout.Field("contact_person",
              css_class="input-blocklevel"),
            layout.Div(
              bootstrap.PrependedText("phone",
              """&lt;span class="glyphicon glyphicon-earphone"&gt;
              &lt;/span&gt;""", 
                css_class="inputblock-level"),
              bootstrap.PrependedText("email", "@",
                css_class="input-block-level",
                placeholder="contact@example.com"),
              css_id="contact_info",
            ),
          ),
          bootstrap.FormActions(
            layout.Submit("submit", _("Save")),
          )
        )</pre></div></li><li class="listitem">To<a class="indexterm" id="id157"/> render the form<a class="indexterm" id="id158"/> in the template, we just need to load the <code class="literal">crispy_forms_tags</code> template tag library and use the <code class="literal">{% crispy %}</code> template tag as shown in the following:<div><pre class="programlisting">
<strong>{# templates/bulletin_board/change_form.html #}</strong>
{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
    {% crispy form %}
{% endblock %}</pre></div></li><li class="listitem">Create the <code class="literal">base.html</code> template. You can do this according to the example in the <em>Arranging the base.html template</em> recipe in <a class="link" href="ch04.html" title="Chapter 4. Templates and JavaScript">Chapter 4</a>, <em>Templates and JavaScript</em>.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec126"/>How it works…</h2></div></div></div><p>The <a class="indexterm" id="id159"/>page with the bulletin form <a class="indexterm" id="id160"/>will look similar to the following:</p><div><img alt="How it works…" src="img/B04912_03_01.jpg"/></div><p>As you<a class="indexterm" id="id161"/> can see, the fields are grouped<a class="indexterm" id="id162"/> by fieldsets. The first argument of the <code class="literal">Fieldset</code> object defines the legend, the other positional arguments define the fields. You can also pass named arguments to define the HTML attributes for the fieldset; for example, for the second fieldset, we are passing <code class="literal">title</code> and <code class="literal">css_id</code> to set the <code class="literal">title</code> and <code class="literal">id</code> HTML attributes.</p><p>Fields can also have additional attributes passed by named arguments; for example, for the <code class="literal">description</code> field, we are passing <code class="literal">css_class</code> and <code class="literal">rows</code> to set the <code class="literal">class</code> and <code class="literal">rows</code> HTML attributes.</p><p>Besides the normal fields, you can pass HTML snippets as this is done with the help block for the image field. You can also have prepended text fields in the layout. For example, we added a phone icon to the <strong>Phone</strong> field and an <code class="literal">@</code> sign for the <strong>Email</strong> field. As you can see from the example with the contact fields, we can easily wrap fields in the HTML <code class="literal">&lt;div&gt;</code> elements using the <code class="literal">Div</code> objects. This is useful when specific JavaScript needs to be applied to some form fields.</p><p>The <code class="literal">action</code> attribute for the HTML form is defined by the <code class="literal">form_action</code> property of the form helper. If you use the empty string as an action, the form will be submitted to the same view, where the form is included. The <code class="literal">method</code> attribute of the HTML form is defined by the <code class="literal">form_method</code> property of the form helper. As you know, the HTML forms allow the GET and POST methods. Finally, there is a <code class="literal">Submit</code> object in order to render <a class="indexterm" id="id163"/>the submit button, which<a class="indexterm" id="id164"/> takes the name of the button as the first positional argument and the value of the button as the second argument.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec127"/>There's more…</h2></div></div></div><p>For the basic usage, the given example is more than necessary. However, if you need a specific markup for the forms in your project, you can still overwrite and modify templates of the <code class="literal">django-crispy-forms</code> app as there is no markup hardcoded in the Python files, rather all the generated markup is rendered through the templates. Just copy the templates from the <code class="literal">django-crispy-forms</code> app to your project's template directory and change them as required.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec128"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Filtering object lists</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Managing paginated lists</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Downloading authorized files</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec41"/>Downloading authorized files</h1></div></div></div><p>Sometimes, you might need to allow only specific people to download intellectual property<a class="indexterm" id="id165"/> from your website. For example, music, videos, literature, or other artistic works should be accessible only to the paid members. In this recipe, you will learn how to restrict image downloads only to the authenticated users using the contributed Django auth app.</p><div><div><div><div><h2 class="title"><a id="ch03lvl2sec129"/>Getting ready</h2></div></div></div><p>To start, create the <code class="literal">quotes</code> app as in the <em>Uploading images</em> recipe.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec130"/>How to do it…</h2></div></div></div><p>Execute these steps one by one:</p><div><ol class="orderedlist arabic"><li class="listitem">Create the view that will require authentication to download a file, as follows:<div><pre class="programlisting">
<strong># quotes/views.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
import os
from django.shortcuts import get_object_or_404
from django.http import FileResponse
from django.utils.text import slugify
from django.contrib.auth.decorators import login_required
from .models import InspirationalQuote

@login_required(login_url="my_login_page")
def download_quote_picture(request, quote_id):
    quote = get_object_or_404(InspirationalQuote,
        pk=quote_id)
    file_name, file_extension = os.path.splitext(
        quote.picture.file.name)
    file_extension = file_extension[1:]  # remove the dot
    response = FileResponse(
        quote.picture.file,
        content_type="image/%s" % file_extension
    )
    response["Content-Disposition"] = "attachment;" \
        " filename=%s---%s.%s" % (
        slugify(quote.author)[:100],
        slugify(quote.quote)[:100],
        file_extension
    )
    return response</pre></div></li><li class="listitem">Add the<a class="indexterm" id="id166"/> view to the URL configuration:<div><pre class="programlisting">
<strong># quotes/urls.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.conf.urls import patterns, url

urlpatterns = patterns("",
    # …
    url(r'^(?P&lt;quote_id&gt;\d+)/download/$',
        "quotes.views.download_quote_picture",
        name="download_quote_picture"
    ),
)</pre></div></li><li class="listitem">Then, we need to set the login view in project URL configuration. Note how we are also<a class="indexterm" id="id167"/> adding <code class="literal">login_helper</code> for <code class="literal">django-crispy-forms</code>:<div><pre class="programlisting">
<strong># myproject/urls.py</strong>
# -*- coding: UTF-8 -*-
from django.conf.urls import patterns, include, url
from django.conf import settings
from django.contrib import admin
from django.core.urlresolvers import reverse_lazy
from django.utils.translation import string_concat
from django.utils.translation import ugettext_lazy as _
from django.conf.urls.i18n import i18n_patterns
from crispy_forms.helper import FormHelper
from crispy_forms import layout, bootstrap

<strong>login_helper = FormHelper()</strong>
<strong>login_helper.form_action = reverse_lazy("my_login_page")</strong>
<strong>login_helper.form_method = "POST"</strong>
<strong>login_helper.form_class = "form-signin"</strong>
<strong>login_helper.html5_required = True</strong>
<strong>login_helper.layout = layout.Layout(</strong>
<strong>    layout.HTML(string_concat("""&lt;h2 class="form-signin-heading"&gt;""", _("Please Sign In"), """&lt;/h2&gt;""")),</strong>
<strong>    layout.Field("username", placeholder=_("username")),</strong>
<strong>    layout.Field("password", placeholder=_("password")),</strong>
<strong>    layout.HTML("""&lt;input type="hidden" name="next" value="{{ next }}" /&gt;"""),</strong>
<strong>    layout.Submit("submit", _("Login"), css_class="btn-lg"),</strong>
<strong>)</strong>

urlpatterns = i18n_patterns("",
    # …
    url(r'login/$', "django.contrib.auth.views.login",
        {"extra_context": {<strong>"login_helper": login_helper</strong>}},
        name="my_login_page"
    ),
    url(r'^quotes/', include("quotes.urls")),
)</pre></div></li><li class="listitem">Let's create a template for the login form, as shown in the following:<div><pre class="programlisting">
<strong>{# templates/registration/login.html #}</strong>
{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block stylesheet %}
    {{ block.super }}&lt;link rel="stylesheet" href="{{ STATIC_URL }}site/css/login.css"&gt;
{% endblock %}

{% block content %}
    &lt;div class="container"&gt;
        {% crispy form <strong>login_helper</strong> %}
    &lt;/div&gt;
{% endblock %}</pre></div></li><li class="listitem">Create the <code class="literal">login.css</code> file to add some style to the login form. Lastly, you should restrict the users from bypassing Django and downloading restricted files directly. To do so on an Apache web server, you can put the <code class="literal">.htaccess</code> file in the <code class="literal">media/quotes</code> directory with the following content if you are using Apache 2.2:<div><pre class="programlisting">
<strong># media/quotes/.htaccess</strong>
Order deny,allow
Deny from all</pre></div><p>You can put the following content if you are using Apache 2.4:</p><div><pre class="programlisting">
<strong># media/quotes/.htaccess</strong>
Require all denied</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec131"/>How it works…</h2></div></div></div><p>The <code class="literal">download_quote_picture()</code> view streams the picture from a specific inspirational quote. The <code class="literal">Content-Disposition</code> header that is set to <code class="literal">attachment</code> makes the file downloadable<a class="indexterm" id="id168"/> instead of being immediately shown in the browser. The filename for the file will be something similar to <code class="literal">walt-disney---if-you-can-dream-it-you-can-do-it.png</code>. The <code class="literal">@login_required</code> decorator will redirect the visitor to the login page if he or she tries to access the downloadable file without being logged in.</p><p>As we want to have a nice Bootstrap-style login form, we are using <code class="literal">django-crispy-forms</code> again and define a helper for the <code class="literal">login_helper</code> form. The helper is passed to the authorization form as an extra context variable and then used as the second parameter in the <code class="literal">{% crispy %}</code> template tag.</p><p>Depending on the CSS applied, the login form might look similar to the following:</p><div><img alt="How it works…" src="img/B04912_03_02.jpg"/></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec132"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Uploading images</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Creating a form layout with django-crispy-forms</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec42"/>Filtering object lists</h1></div></div></div><p>In web development, besides views with forms, it is typical to have object-list views and detail views. List <a class="indexterm" id="id169"/>views can simply list objects that are ordered, for example, alphabetically or by creation date; however, that is not very user-friendly with huge amounts of data. For the best accessibility and convenience, you should be able to filter the content by all possible categories. In this recipe, we will see the pattern that is used to filter list views by any number of categories.</p><p>What we'll be creating is a list view of movies that can be filtered by genre, director, actor, or rating. It will look similar to the following with Bootstrap 3 applied to it:</p><div><img alt="Filtering object lists" src="img/B04912_03_03.jpg"/></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec133"/>Getting ready</h2></div></div></div><p>For the filtering<a class="indexterm" id="id170"/> example, we will use the <code class="literal">Movie</code> model with relations to genres, directors, and actors to filter by. It will also be possible to filter by ratings, which is <code class="literal">PositiveIntegerField</code> with choices. Let's create the <code class="literal">movies</code> app, put it in <code class="literal">INSTALLED_APPS</code> in the settings, and define the mentioned models in the new app, as follows:</p><div><pre class="programlisting">
<strong># movies/models.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.db import models
from django.utils.translation import ugettext_lazy as _
from django.utils.encoding import python_2_unicode_compatible

RATING_CHOICES = (
    (1, "<img alt="Getting ready" src="img/Star_01.jpg"/>"),
    (2, "<img alt="Getting ready" src="img/Star_02.jpg"/>"),
    (3, "<img alt="Getting ready" src="img/Star_03.jpg"/>"),
    (4, "<img alt="Getting ready" src="img/Star_04.jpg"/>"),
    (5, "<img alt="Getting ready" src="img/Star_05.jpg"/>"),
)

@python_2_unicode_compatible
class Genre(models.Model):
    title = models.CharField(_("Title"), max_length=100)

    def __str__(self):
        return self.title

@python_2_unicode_compatible
class Director(models.Model):
    first_name = models.CharField(_("First name"), max_length=40)
    last_name = models.CharField(_("Last name"), max_length=40)

    def __str__(self):
        return self.first_name + " " + self.last_name

@python_2_unicode_compatible
class Actor(models.Model):
    first_name = models.CharField(_("First name"), max_length=40)
    last_name = models.CharField(_("Last name"), max_length=40)

    def __str__(self):
        return self.first_name + " " + self.last_name

@python_2_unicode_compatible
class Movie(models.Model):
    title = models.CharField(_("Title"), max_length=255)
    genres = models.ManyToManyField(Genre, blank=True)
    directors = models.ManyToManyField(Director, blank=True)
    actors = models.ManyToManyField(Actor, blank=True)
    rating = models.PositiveIntegerField(choices=RATING_CHOICES)
    
    def __str__(self):
        return self.title</pre></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec134"/>How to do it…</h2></div></div></div><p>To<a class="indexterm" id="id171"/> complete the recipe, follow these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">First of all, we create <code class="literal">MovieFilterForm</code> with all the possible categories to filter by:<div><pre class="programlisting">
<strong># movies/forms.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django import forms
from django.utils.translation import ugettext_lazy as _


from .models import Genre, Director, Actor, RATING_CHOICES

class MovieFilterForm(forms.Form):
    genre = forms.ModelChoiceField(
        label=_("Genre"),
        required=False,
        queryset=Genre.objects.all(),
    )
    director = forms.ModelChoiceField(
        label=_("Director"),
        required=False,
        queryset=Director.objects.all(),
    )
    actor = forms.ModelChoiceField(
        label=_("Actor"),
        required=False,
        queryset=Actor.objects.all(),
    )
    rating = forms.ChoiceField(
        label=_("Rating"),
        required=False,
        choices=RATING_CHOICES,
    )</pre></div></li><li class="listitem">Then, we <a class="indexterm" id="id172"/>create a <code class="literal">movie_list</code> view that will use <code class="literal">MovieFilterForm</code> to validate the request query parameters and perform the filtering for chosen categories. Note the <code class="literal">facets</code> dictionary that is used here to list the categories and also the currently selected choices:<div><pre class="programlisting">
<strong># movies/views.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.shortcuts import render
from .models import Genre, Director, Actor
from .models import Movie, RATING_CHOICES
from .forms import MovieFilterForm

def movie_list(request):
    qs = Movie.objects.order_by("title")
    
    form = MovieFilterForm(data=request.GET)

<strong>    facets = {</strong>
<strong>        "selected": {},</strong>
<strong>        "categories": {</strong>
<strong>            "genres": Genre.objects.all(),</strong>
<strong>            "directors": Director.objects.all(),</strong>
<strong>            "actors": Actor.objects.all(),</strong>
<strong>            "ratings": RATING_CHOICES,</strong>
<strong>        },</strong>
<strong>    }</strong>

    if form.is_valid():
        genre = form.cleaned_data["genre"]
        if genre:
            facets["selected"]["genre"] = genre
            qs = qs.filter(genres=genre).distinct()

        director = form.cleaned_data["director"]
        if director:
            facets["selected"]["director"] = director
            qs = qs.filter(directors=director).distinct()

        actor = form.cleaned_data["actor"]
        if actor:
            facets["selected"]["actor"] = actor
            qs = qs.filter(actors=actor).distinct()

        rating = form.cleaned_data["rating"]
        if rating:
            rating = int(rating)
            facets["selected"]["rating"] = (rating, dict(RATING_CHOICES)[rating])
            qs = qs.filter(rating=rating).distinct()

    # Let's inspect the facets in the console
    if settings.DEBUG:
        from pprint import pprint
        pprint(facets)

    context = {
        "form": form,
        "facets": facets,
        "object_list": qs,
    }
    return render(request, "movies/movie_list.html",
        context)</pre></div></li><li class="listitem">Lastly, we<a class="indexterm" id="id173"/> create the template for the list view. We will use the <code class="literal">facets</code> dictionary here to list the categories and know which category is currently selected. To generate URLs for the filters, we will use the <code class="literal">{% modify_query %}</code> template tag, which will be described later in the <em>Creating a template tag to modify request query parameters</em> recipe in <a class="link" href="ch05.html" title="Chapter 5. Custom Template Filters and Tags">Chapter 5</a>, <em>Custom Template Filters and Tags</em>. Copy the following code in the <code class="literal">templates/movies/movie_list.html</code> directory:<div><pre class="programlisting">
<strong>{# templates/movies/movie_list.html #}</strong>
{% extends "base_two_columns.html" %}
{% load i18n utility_tags %}

{% block sidebar %}
&lt;div class="filters panel-group" id="accordion"&gt;
    &lt;div class="panel panel-default"&gt;
        &lt;div class="panel-heading"&gt;
            &lt;h6 class="panel-title"&gt;
                &lt;a data-toggle="collapse" data-parent="#accordion" href="#collapseGenres"&gt;
                    {% trans "Filter by Genre" %}
                &lt;/a&gt;
            &lt;/h6&gt;
        &lt;/div&gt;
        &lt;div id="collapseGenres" class="panel-collapse collapse in"&gt;
            &lt;div class="panel-body"&gt;
                &lt;div class="list-group"&gt;
                    &lt;a class="list-group-item{% if not facets.selected.genre %} active{% endif %}" href="{% modify_query "genre" "page" %}"&gt;{% trans "All" %}&lt;/a&gt;
                    {% for cat in facets.categories.genres %}
                        &lt;a class="list-group-item{% if facets.selected.genre == cat %} active{% endif %}" href="{% modify_query "page" genre=cat.pk %}"&gt;{{ cat }}&lt;/a&gt;
                    {% endfor %}
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class="panel panel-default"&gt;
        &lt;div class="panel-heading"&gt;
            &lt;h6 class="panel-title"&gt;
                &lt;a data-toggle="collapse" data-parent="#accordion" href="#collapseDirectors"&gt;
                    {% trans "Filter by Director" %}
                &lt;/a&gt;
            &lt;/h6&gt;
        &lt;/div&gt;
        &lt;div id="collapseDirectors" class="panel-collapse collapse"&gt;
            &lt;div class="panel-body"&gt;
                &lt;div class="list-group"&gt;
                    &lt;a class="list-group-item{% if not facets.selected.director %} active{% endif %}" href="{% modify_query "director" "page" %}"&gt;{% trans "All" %}&lt;/a&gt;
                    {% for cat in facets.categories.directors %}
                        &lt;a class="list-group-item{% if facets.selected.director == cat %} active{% endif %}" href="{% modify_query "page" director=cat.pk %}"&gt;{{ cat }}&lt;/a&gt;
                    {% endfor %}
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    {# Analogously by the examples of genres and directors above, add a filter for actors here… #}

    &lt;div class="panel panel-default"&gt;
        &lt;div class="panel-heading"&gt;
            &lt;h6 class="panel-title"&gt;
                &lt;a data-toggle="collapse" data-parent="#accordion" href="#collapseRatings"&gt;
                    {% trans "Filter by Rating" %}
                &lt;/a&gt;
            &lt;/h6&gt;
        &lt;/div&gt;
        &lt;div id="collapseRatings" class="panel-collapse collapse"&gt;
            &lt;div class="panel-body"&gt;
                &lt;div class="list-group"&gt;
                    &lt;a class="list-group-item{% if not facets.selected.rating %} active{% endif %}" href="{% modify_query "rating" "page" %}"&gt;{% trans "All" %}&lt;/a&gt;
                    {% for r_val, r_display in facets.categories.ratings %}
                        &lt;a class="list-group-item{% if facets.selected.rating.0 == r_val %} active{% endif %}" href="{% modify_query "page" rating=r_val %}"&gt;{{ r_display }}&lt;/a&gt;
                    {% endfor %}
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
{% endblock %}

{% block content %}
&lt;div class="movie_list"&gt;
    {% for movie in object_list %}
        &lt;div class="movie alert alert-info"&gt;
            &lt;p&gt;{{ movie.title }}&lt;/p&gt;
        &lt;/div&gt;
    {% endfor %}
&lt;/div&gt;
{% endblock %}</pre></div></li><li class="listitem">Add a<a class="indexterm" id="id174"/> simple base template with two-column layout, as follows:<div><pre class="programlisting">{# base_two_columns.html #}
{% extends "base.html" %}

{% block container %}
    &lt;div class="container"&gt;
        &lt;div class="row"&gt;
            &lt;div id="sidebar" class="col-md-4"&gt;
                {% block sidebar %}
                {% endblock %}
            &lt;/div&gt;
            &lt;div id="content" class="col-md-8"&gt;
                {% block content %}
                {% endblock %}
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
{% endblock %}</pre></div></li><li class="listitem">Create the <code class="literal">base.html</code> template. You can do that according to the example provided in the <em>Arranging the base.html template</em> recipe in <a class="link" href="ch04.html" title="Chapter 4. Templates and JavaScript">Chapter 4</a>, <em>Templates and JavaScript</em>.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec135"/>How it works…</h2></div></div></div><p>We are using<a class="indexterm" id="id175"/> the facets dictionary that is passed to the template context to know which filters we have and which filters are selected. To look deeper, the <code class="literal">facets</code> dictionary consists of two sections: the <code class="literal">categories</code> dictionary and the <code class="literal">selected</code> dictionary. The <code class="literal">categories</code> dictionary contains <code class="literal">QuerySets</code> or choices of all filterable categories. The <code class="literal">selected</code> dictionary contains the currently selected values for each category.</p><p>In the view, we check whether the query parameters are valid in the form and then drill down <code class="literal">QuerySet</code> of objects from the selected categories. Additionally, we set the selected values to the <code class="literal">facets</code> dictionary, which will be passed to the template.</p><p>In the template, for each categorization from the <code class="literal">facets</code> dictionary, we list all the categories and mark the currently selected category as active.</p><p>It is as simple as that.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec136"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Managing paginated lists</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Composing class-based views</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Creating a template tag to modify request query parameters</em> recipe in <a class="link" href="ch05.html" title="Chapter 5. Custom Template Filters and Tags">Chapter 5</a>, <em>Custom Template Filters and Tags</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec43"/>Managing paginated lists</h1></div></div></div><p>If you have dynamically changing lists of objects or the amount of them is greater than 30, you will <a class="indexterm" id="id176"/>surely need pagination for the list. With pagination, instead of the full <code class="literal">QuerySet</code>, you provide a fraction of the dataset that is limited to a specific amount per page and you will also show the links to get to the other pages of the list. Django has classes to manage the paginated data, and we will see how to do that in this recipe for the example provided in the previous recipe.</p><div><div><div><div><h2 class="title"><a id="ch03lvl2sec137"/>Getting ready</h2></div></div></div><p>Let's start with the forms and views of the <code class="literal">movies</code> app from the <em>Filtering object lists</em> recipe.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec138"/>How to do it…</h2></div></div></div><p>To add pagination to the list view of the movies, follow these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">First, import the necessary pagination classes from Django. We will add pagination<a class="indexterm" id="id177"/> management to the <code class="literal">movie_list</code> view just after filtering. Also, we will slightly modify the context dictionary by assigning <code class="literal">page</code> instead of the movie QuerySet to the object_list key:<div><pre class="programlisting">
<strong># movies/views.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.shortcuts import render
from django.core.paginator import Paginator, EmptyPage,\
    PageNotAnInteger

from .models import Movie
from .forms import MovieFilterForm

def movie_list(request):
<strong>    paginate_by = 15</strong>
    qs = Movie.objects.order_by("title")
    # … filtering goes here…

<strong>    paginator = Paginator(qs, paginate_by)</strong>

<strong>    page_number = request.GET.get("page")</strong>
<strong>    try:</strong>
<strong>        page = paginator.page(page_number)</strong>
<strong>    except PageNotAnInteger:</strong>
<strong>        # If page is not an integer, show first page.</strong>
<strong>        page = paginator.page(1)</strong>
<strong>    except EmptyPage:</strong>
<strong>        # If page is out of range, show last existing page.</strong>
<strong>        page = paginator.page(paginator.num_pages)</strong>

    context = {
        # …
        "object_list": <strong>page</strong>,
    }
    return render(request, "movies/movie_list.html", context)</pre></div></li><li class="listitem">In the template, we will add pagination controls after the list of movies, as follows:<div><pre class="programlisting">
<strong>{# templates/movies/movie_list.html #}</strong>
{% extends "base.html" %}
{% load i18n utility_tags %}

{% block sidebar %}
    {# … filters go here… #}
{% endblock %}

{% block content %}
&lt;div class="movie_list"&gt;
    {% for movie in object_list %}
        &lt;div class="movie alert alert-info"&gt;
            &lt;p&gt;{{ movie.title }}&lt;/p&gt;
        &lt;/div&gt;
    {% endfor %}
&lt;/div&gt;

{% if object_list.has_other_pages %}
    &lt;ul class="pagination"&gt;
        {% if object_list.has_previous %}
            &lt;li&gt;&lt;a href="{% modify_query page=object_list.previous_page_number %}"&gt;&amp;laquo;&lt;/a&gt;&lt;/li&gt;
        {% else %}
            &lt;li class="disabled"&gt;&lt;span&gt;&amp;laquo;&lt;/span&gt;&lt;/li&gt;
        {% endif %}
        {% for page_number in object_list.paginator.page_range %}
            {% if page_number == object_list.number %}
                &lt;li class="active"&gt;
                    &lt;span&gt;{{ page_number }} &lt;span class="sr-only"&gt;(current)&lt;/span&gt;&lt;/span&gt;
                &lt;/li&gt;
            {% else %}
                &lt;li&gt;
                    &lt;a href="{% modify_query page=page_number %}"&gt;{{ page_number }}&lt;/a&gt;
                &lt;/li&gt;
            {% endif %}
        {% endfor %}
        {% if object_list.has_next %}
            &lt;li&gt;&lt;a href="{% modify_query page=object_list.next_page_number %}"&gt;&amp;raquo;&lt;/a&gt;&lt;/li&gt;
        {% else %}
            &lt;li class="disabled"&gt;&lt;span&gt;&amp;raquo;&lt;/span&gt;&lt;/li&gt;
        {% endif %}
    &lt;/ul&gt;
{% endif %}
{% endblock %}</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec139"/>How it works…</h2></div></div></div><p>When you look at the results in the browser, you will see the pagination controls similar to the following, added after the list of movies:</p><div><img alt="How it works…" src="img/B04912_03_04.jpg"/></div><p>How do we <a class="indexterm" id="id178"/>achieve this? When the <code class="literal">QuerySet</code> is filtered out, we will create a <code class="literal">paginator</code> object passing <code class="literal">QuerySet</code> and the maximal amount of items that we want to show per page, which is 15 here. Then, we will read the current page number from the query parameter, <code class="literal">page</code>. The next step is to retrieve the current page object from <code class="literal">paginator</code>. If the page number is not an integer, we get the first page. If the number exceeds the amount of possible pages, the last page is retrieved. The page object has methods and attributes necessary for the pagination widget shown in the preceding screenshot. Also, the page object acts like <code class="literal">QuerySet</code> so that we can iterate through it and get the items from the fraction of the page.</p><p>The snippet marked in the template creates a pagination widget with the markup for the Bootstrap 3 frontend framework. We show the pagination controls only if there are more pages than the current one. We have the links to the previous and next pages, and the list of all page numbers in the widget. The current page number is marked as active. To generate URLs for the links, we use the <code class="literal">{% modify_query %}</code> template tag, which will be described later in the <em>Creating a template tag to modify request query parameters</em> recipe in <a class="link" href="ch05.html" title="Chapter 5. Custom Template Filters and Tags">Chapter 5</a>, <em>Custom Template Filters and Tags</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec140"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Filtering object lists</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Composing class-based views</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Creating a template tag to modify request query parameters</em> recipe in <a class="link" href="ch05.html" title="Chapter 5. Custom Template Filters and Tags">Chapter 5</a>, <em>Custom Template Filters and Tags</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec44"/>Composing class-based views</h1></div></div></div><p>Django views are callables that take requests and return responses. In addition to the function-based views, Django provides an alternative way to define views as classes. This approach is <a class="indexterm" id="id179"/>useful when you want to create reusable modular views or combine views of the generic mixins. In this recipe, we will convert the previously shown function-based <code class="literal">movie_list</code> view to a class-based <code class="literal">MovieListView</code> view.</p><div><div><div><div><h2 class="title"><a id="ch03lvl2sec141"/>Getting ready</h2></div></div></div><p>Create the models, form, and template similar to the previous recipes, <em>Filtering object lists</em> and <em>Managing paginated lists</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec142"/>How to do it…</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">We will need to create a URL rule in the URL configuration and add a class-based view. To include a class-based view in the URL rules, the <code class="literal">as_view()</code> method is used, as follows:<div><pre class="programlisting">
<strong># movies/urls.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.conf.urls import patterns, url
from .views import MovieListView
urlpatterns = patterns("",
    url(r'^$', <strong>MovieListView.as_view()</strong>, name="movie_list"),
)</pre></div></li><li class="listitem">Our class-based view, <code class="literal">MovieListView</code>, will inherit the Django <code class="literal">View</code> class and override the <code class="literal">get()</code> and <code class="literal">post()</code> methods, which are used to distinguish between the requests by GET and POST. We will also add the <code class="literal">get_queryset_and_facets()</code> and <code class="literal">get_page()</code> methods to make the class more modular:<div><pre class="programlisting">
<strong># movies/views.py</strong>
# -*- coding: UTF-8 -*-
from django.shortcuts import render
from django.core.paginator import Paginator, EmptyPage,\
    PageNotAnInteger
from django.views.generic import View

from .models import Genre
from .models import Director
from .models import Actor
from .models import Movie, RATING_CHOICES
from .forms import MovieFilterForm

class MovieListView(View):
    form_class = MovieFilterForm
    template_name = "movies/movie_list.html"
    paginate_by = 15

    def get(self, request, *args, **kwargs):
        form = self.form_class(data=request.GET)
        qs, facets = self.get_queryset_and_facets(form)
        page = self.get_page(request, qs)
        context = {
            "form": form,
            "facets": facets,
            "object_list": page,
        }
        return render(request, self.template_name, context)

    def post(self, request, *args, **kwargs):
        return self.get(request, *args, **kwargs)

    def get_queryset_and_facets(self, form):
        qs = Movie.objects.order_by("title")

        facets = {
            "selected": {},
            "categories": {
                "genres": Genre.objects.all(),
                "directors": Director.objects.all(),
                "actors": Actor.objects.all(),
                "ratings": RATING_CHOICES,
            },
        }
        if form.is_valid():
            genre = form.cleaned_data["genre"]
            if genre:
                facets["selected"]["genre"] = genre
                qs = qs.filter(genres=genre).distinct()

            director = form.cleaned_data["director"]
            if director:
                facets["selected"]["director"] = director
                qs = qs.filter(
                    directors=director,
                ).distinct()

            actor = form.cleaned_data["actor"]
            if actor:
                facets["selected"]["actor"] = actor
                qs = qs.filter(actors=actor).distinct()

            rating = form.cleaned_data["rating"]
            if rating:
                facets["selected"]["rating"] = (
                    int(rating),
                    dict(RATING_CHOICES)[int(rating)]
                )
                qs = qs.filter(rating=rating).distinct()
        return qs, facets

    def get_page(self, request, qs):
        paginator = Paginator(qs, self.paginate_by)

        page_number = request.GET.get("page")
        try:
            page = paginator.page(page_number)
        except PageNotAnInteger:
            # If page is not an integer, show first page.
            page = paginator.page(1)
        except EmptyPage:
            # If page is out of range,
            # show last existing page.
            page = paginator.page(paginator.num_pages)
        return page</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec143"/>How it works…</h2></div></div></div><p>The<a class="indexterm" id="id180"/> following are the things happening in the <code class="literal">get()</code> method:</p><p>First, we create the <code class="literal">form</code> object passing the <code class="literal">GET</code> dictionary-like object to it. The <code class="literal">GET</code> object contains all the query variables that are passed using the <code class="literal">GET</code> method.</p><p>Then, the <code class="literal">form</code> is passed to the <code class="literal">get_queryset_and_facets()</code> method, which returns a tuple of the following two elements: the <code class="literal">QuerySet</code> and the <code class="literal">facets</code> dictionary respectively.</p><p>Then, the current <code class="literal">request</code> object and <code class="literal">QuerySet</code> is passed to the <code class="literal">get_page()</code> method, which returns the current page object.</p><p>Lastly, we create a context dictionary and render the response.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec144"/>There's more…</h2></div></div></div><p>As you see, the <code class="literal">get()</code>, <code class="literal">post()</code>, and <code class="literal">get_page()</code> methods are generic so that we could create a generic <code class="literal">FilterableListView</code> class with these methods in the <code class="literal">utils</code> app. Then, in any<a class="indexterm" id="id181"/> app that requires a filterable list, we could create a class-based view that extends <code class="literal">FilterableListView</code> and defines only the <code class="literal">form_class</code> and <code class="literal">template_name</code> attributes and the <code class="literal">get_queryset_and_facets()</code> method. This is how class-based views work.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec145"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Filtering object lists</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Managing paginated lists</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec45"/>Generating PDF documents</h1></div></div></div><p>Django views allow you to create much more than just HTML pages. You can generate files <a class="indexterm" id="id182"/>of any type. For example, you can create PDF documents for invoices, tickets, booking confirmations, and so on. In this recipe, we will show you how to generate resumes (curriculum vitae) in the PDF format out of the data from the database. We will be using the Pisa xhtml2pdf library, which is very practical as it allows you to use HTML templates to make PDF documents.</p><div><div><div><div><h2 class="title"><a id="ch03lvl2sec146"/>Getting ready</h2></div></div></div><p>First of all, we need to install the xhtml2pdf Python library in your virtual environment:</p><div><pre class="programlisting">
<strong>(myproject_env)$ pip install xhtml2pdf</strong>
</pre></div><p>Then, let's create a <code class="literal">cv</code> app containing a simple <code class="literal">CV</code> model with the <code class="literal">Experience</code> model that is attached to it through a foreign key. The <code class="literal">CV</code> model will have these fields: first name, last name, and e-mail. The <code class="literal">Experience</code> model will have these fields: the start date of a job, the end date of a job, company, position at that company, and the skills gained:</p><div><pre class="programlisting">
<strong># cv/models.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.db import models
from django.utils.translation import ugettext_lazy as _
from django.utils.encoding import python_2_unicode_compatible

@python_2_unicode_compatible
class CV(models.Model):
    first_name = models.CharField(_("First name"), max_length=40)
    last_name = models.CharField(_("Last name"), max_length=40)
    email = models.EmailField(_("Email"))

    def __str__(self):
        return self.first_name + " " + self.last_name

@python_2_unicode_compatible
class Experience(models.Model):
    cv = models.ForeignKey(CV)
    from_date = models.DateField(_("From"))
    till_date = models.DateField(_("Till"), null=True, blank=True)
    company = models.CharField(_("Company"), max_length=100)
    position = models.CharField(_("Position"), max_length=100)
    skills = models.TextField(_("Skills gained"), blank=True)

    def __str__(self):
        till = _("present")
        if self.till_date:
            till = self.till_date.strftime("%m/%Y")
        return _("%(from)s-%(till)s %(pos)s at %(company)s") % {
            "from": self.from_date.strftime("%m/%Y"),
            "till": till,
            "pos": self.position,
            "company": self.company,
        }
    class Meta:
        ordering = ("-from_date",)</pre></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec147"/>How to do it…</h2></div></div></div><p>Execute<a class="indexterm" id="id183"/> the following steps to complete the recipe:</p><div><ol class="orderedlist arabic"><li class="listitem">In the URL rules, let's create a rule for the view that will download a PDF document of a resume by the ID of the <code class="literal">CV</code> model, as follows:<div><pre class="programlisting">
<strong># cv/urls.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.conf.urls import patterns, url

urlpatterns = patterns('cv.views',
    url(r'^(?P&lt;cv_id&gt;\d+)/pdf/$', "download_cv_pdf", name="download_cv_pdf"),
)</pre></div></li><li class="listitem">Now, let's create the <code class="literal">download_cv_pdf()</code> view. This view renders an HTML template and then passes the rendered string to the <code class="literal">pisaDocument</code> PDF creator:<div><pre class="programlisting">
<strong># cv/views.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
try:
    from cStringIO import StringIO
except ImportError:
    from StringIO import StringIO
from xhtml2pdf import pisa

from django.conf import settings
from django.shortcuts import get_object_or_404
from django.template.loader import render_to_string
from django.http import HttpResponse

from .models import CV

def download_cv_pdf(request, cv_id):
    cv = get_object_or_404(CV, pk=cv_id)

    response = HttpResponse(content_type="application/pdf")
    response["Content-Disposition"] = "attachment; "\
        "filename=%s_%s.pdf" % (
            cv.first_name,
            cv.last_name
        )

    html = render_to_string("cv/cv_pdf.html", {
        "cv": cv,
        "MEDIA_ROOT": settings.MEDIA_ROOT,
        "STATIC_ROOT": settings.STATIC_ROOT,
    })
    pdf = pisa.pisaDocument(
        StringIO(html.encode("UTF-8")),
        response,
        encoding="UTF-8",
    )
    return response</pre></div></li><li class="listitem">Lastly, we<a class="indexterm" id="id184"/> will create the template with which the document will be rendered, as follows:<div><pre class="programlisting">
<strong>{# templates/cv/cv_pdf.html #}</strong>
&lt;!DOCTYPE HTML&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta charset="utf-8" /&gt;
    &lt;title&gt;My Title&lt;/title&gt;
    &lt;style type="text/css"&gt;
      @page {
        size: "A4";
        margin: 2.5cm 1.5cm 2.5cm 1.5cm;
        @frame footer {
          -pdf-frame-content: footerContent;
          bottom: 0cm;
          margin-left: 0cm;
          margin-right: 0cm;
          height: 1cm;
        }
      }
      #footerContent {
        color: #666;
        font-size: 10pt;
        text-align: center;
      }
      /* … Other CSS Rules go here … */

    &lt;/style&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div&gt;
      &lt;h1&gt;Curriculum Vitae&lt;/h1&gt;
      &lt;table&gt;
        &lt;tr&gt;
          &lt;td&gt;&lt;p&gt;&lt;b&gt;{{ cv.first_name }} {{ cv.last_name }}&lt;/b&gt;&lt;br /&gt;
            Contact: {{ cv.email }}&lt;/p&gt;
          &lt;/td&gt;
          &lt;td align="right"&gt;
            &lt;img src="img/smiley.jpg" width="100" height="100" /&gt;
          &lt;/td&gt;
        &lt;/tr&gt;
      &lt;/table&gt;

      &lt;h2&gt;Experience&lt;/h2&gt;
        &lt;table&gt;
          {% for experience in cv.experience_set.all %}
            &lt;tr&gt;
              &lt;td valign="top"&gt;&lt;p&gt;{{ experience.from_date|date:"F Y" }} -
                {% if experience.till_date %}
                {{ experience.till_date|date:"F Y" }}
                {% else %}
                present
                {% endif %}&lt;br /&gt;
                {{ experience.position }} at {{ experience.company }}&lt;/p&gt;
              &lt;/td&gt;
              &lt;td valign="top"&gt;&lt;p&gt;&lt;b&gt;Skills gained&lt;/b&gt;&lt;br&gt;
                {{ experience.skills|linebreaksbr }}
                &lt;br&gt;
                &lt;br&gt;
              &lt;/p&gt;
              &lt;/td&gt;
            &lt;/tr&gt;
          {% endfor %}
        &lt;/table&gt;
    &lt;/div&gt;
    &lt;pdf:nextpage&gt;
      &lt;div&gt;
        This is an empty page to make a paper plane.
      &lt;/div&gt;
      &lt;div id="footerContent"&gt;
        Document generated at {% now "Y-m-d" %} |
        Page &lt;pdf:pagenumber&gt; of &lt;pdf:pagecount&gt;
      &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec148"/>How it works…</h2></div></div></div><p>Go to model<a class="indexterm" id="id185"/> administration and enter a CV document. Then, if you access the document's URL at <code class="literal">http://127.0.0.1:8000/en/cv/1/pdf/</code>, you will be asked to download a PDF document that looks something similar to the following:</p><div><img alt="How it works…" src="img/B04912_03_05.jpg"/></div><p>How does the view work? First, we load a curriculum vitae by its ID, if it exists, or raise the page not found error, if it doesn't. Then, we create the response object with the content type <a class="indexterm" id="id186"/>of the PDF document. We set the <code class="literal">Content-Disposition</code> header to <code class="literal">attachment</code> with the specified filename. This will force the browsers to open a dialog box prompting us to save the PDF document and suggesting the specified name for the file. Then, we render the HTML template as a string passing curriculum vitae object and the <code class="literal">MEDIA_ROOT</code> and <code class="literal">STATIC_ROOT</code> paths.</p><div><div><h3 class="title"><a id="note03"/>Note</h3><p>Note that the <code class="literal">src</code> attribute of the <code class="literal">&lt;img&gt;</code> tag that is used for the PDF creation needs to point to the file in the filesystem or the full URL of the online image. Pisa xhtml2pdf will download the image and include it in the PDF document.</p></div></div><p>Then, we create a <code class="literal">pisaDocument</code> file with the UTF-8-encoded HTML as source and response object as the destination. The response object is a file-like object and <code class="literal">pisaDocument</code> writes the content of the document to it. The response object is returned by the view as expected.</p><p>Let's take a look at the HTML template that is used to create this document. The template has some unusual markup tags and CSS rules. If we want to have some elements on each page of the document, we can create CSS frames for that. In the preceding example, the <code class="literal">&lt;div&gt;</code> tag with the <code class="literal">footerContent</code> ID is marked as a frame, which will be repeated at the bottom of each page. In a similar way, we can have a header or background image for each page.</p><p>The following are the specific markup tags used in this document:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">&lt;pdf:nextpage&gt;</code> tag sets a manual page break</li><li class="listitem" style="list-style-type: disc">The <code class="literal">&lt;pdf:pagenumber&gt;</code> tag returns the number of the current page</li><li class="listitem" style="list-style-type: disc">The <code class="literal">&lt;pdf:pagecount&gt;</code> tag returns the total number of pages</li></ul></div><p>The current version 0.0.6 of the Pisa xhtml2pdf library doesn't fully support all HTML tags and CSS rules. There are no publicly-accessible benchmarks to see what exactly is supported and at what level. Therefore, you would need to experiment in order to make a PDF document look like in the design requirements. However, this library is still mighty enough for customized layouts, which can be basically created just with the knowledge of HTML and CSS.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec149"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Managing paginated lists</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Downloading authorized files</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch03lvl1sec46"/>Implementing a multilingual search with Haystack</h1></div></div></div><p>One of the main functionalities of content-driven websites is a full-text search. Haystack is a <a class="indexterm" id="id187"/>modular search API that supports the<a class="indexterm" id="id188"/> Solr, Elasticsearch, Whoosh, and Xapian search engines. For each model in your project that has to be findable in the search, you need to define an index that will read out the textual information from the models and place it into the backend. In this recipe, you will learn how to set up a search with Haystack and the Python-based Whoosh search engine for a multilingual website.</p><div><div><div><div><h2 class="title"><a id="ch03lvl2sec150"/>Getting ready</h2></div></div></div><p>In the beginning, let's create a couple of apps with models that will be indexed in the search. Let's create an <code class="literal">ideas</code> app containing the <code class="literal">Category</code> and <code class="literal">Idea</code> models, as follows:</p><div><pre class="programlisting">
<strong># ideas/models.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.db import models
from django.utils.translation import ugettext_lazy as _
from django.core.urlresolvers import reverse
from django.core.urlresolvers import NoReverseMatch
from django.utils.encoding import python_2_unicode_compatible
from utils.models import UrlMixin
from utils.fields import MultilingualCharField, MultilingualTextField

@python_2_unicode_compatible
class Category(models.Model):
    title = MultilingualCharField(_("Title"), max_length=200)

    class Meta:
        verbose_name = _("Idea Category")
        verbose_name_plural = _("Idea Categories")

    def __str__(self):
        return self.title


@python_2_unicode_compatible
class Idea(UrlMixin):
    title = MultilingualCharField(_("Title"), max_length=200)
    subtitle = MultilingualCharField(_("Subtitle"), max_length=200, blank=True)
    description = MultilingualTextField(_("Description"),
        blank=True)
    is_original = models.BooleanField(_("Original"))
    categories = models.ManyToManyField(Category,
        verbose_name=_("Categories"), blank=True,
        related_name="ideas")

    class Meta:
        verbose_name = _("Idea")
        verbose_name_plural = _("Ideas")

    def __str__(self):
        return self.title

    def get_url_path(self):
        try:
            return reverse("idea_detail", kwargs={"id": self.pk})
        except NoReverseMatch:
            return ""</pre></div><p>The <code class="literal">Idea</code> model has multilingual fields, which means that there is supposed to be a translation of the content for each language.</p><p>Another <a class="indexterm" id="id189"/>app will be <code class="literal">quotes</code> from<a class="indexterm" id="id190"/> the <em>Uploading images</em> recipe with the <code class="literal">InspirationalQuote</code> model, where each quote can just be in any one language from the languages defined in <code class="literal">settings.LANGUAGES</code> and each quote doesn't necessarily have a translation:</p><div><pre class="programlisting">
<strong># quotes/models.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
import os
from django.db import models
from django.utils.timezone import now as timezone_now
from django.utils.translation import ugettext_lazy as _
from django.utils.encoding import python_2_unicode_compatible
from django.conf import settings
from django.core.urlresolvers import reverse
from django.core.urlresolvers import NoReverseMatch

from utils.models import UrlMixin

def upload_to(instance, filename):
    now = timezone_now()
    filename_base, filename_ext = os.path.splitext(filename)
    return 'quotes/%s%s' % (
        now.strftime("%Y/%m/%Y%m%d%H%M%S"),
        filename_ext.lower(),
    )
    
@python_2_unicode_compatible
class InspirationalQuote(UrlMixin):
    author = models.CharField(_("Author"), max_length=200)
    quote = models.TextField(_("Quote"))
    picture = models.ImageField(_("Picture"), upload_to=upload_to,
        blank=True, null=True)
    language = models.CharField(_("Language"), max_length=2,
        blank=True, choices=settings.LANGUAGES)
    
    class Meta:
        verbose_name = _("Inspirational Quote")
        verbose_name_plural = _("Inspirational Quotes")
        
    def __str__(self):
        return self.quote

    def get_url_path(self):
        try:
            return reverse("quote_detail", kwargs={"id": self.pk})
        except NoReverseMatch:
            return ""
    # …
    def title(self):
        return self.quote</pre></div><p>Put<a class="indexterm" id="id191"/> these two apps in <code class="literal">INSTALLED_APPS</code> in the settings, create and apply database migrations, and create the model<a class="indexterm" id="id192"/> administration for these models to add some data. Also, create list and detail views for these models and plug them in the URL rules. If you are having any difficulty with any of these tasks, familiarize yourself with the concepts in the official Django tutorial once again: <a class="ulink" href="https://docs.djangoproject.com/en/1.8/intro/tutorial01/">https://docs.djangoproject.com/en/1.8/intro/tutorial01/</a>.</p><p>Make sure you installed django-haystack, whoosh, and django-crispy-forms in your virtual environment:</p><div><pre class="programlisting">
<strong>(myproject_env)$ pip install django-crispy-forms</strong>
<strong>(myproject_env)$ pip install django-haystack</strong>
<strong>(myproject_env)$ pip install whoosh</strong>
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec151"/>How to do it…</h2></div></div></div><p>Let's set up the multilingual search with Haystack and Whoosh by executing the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Create a <a class="indexterm" id="id193"/><code class="literal">search</code> app that <a class="indexterm" id="id194"/>will contain the <code class="literal">MultilingualWhooshEngine</code> and search indexes for our ideas and quotes. The search engine will live in the <code class="literal">multilingual_whoosh_backend.py</code> file:<div><pre class="programlisting">
<strong># search/multilingual_whoosh_backend.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.conf import settings
from django.utils import translation
from haystack.backends.whoosh_backend import \
    WhooshSearchBackend, WhooshSearchQuery, WhooshEngine
from haystack import connections
from haystack.constants import DEFAULT_ALIAS

class MultilingualWhooshSearchBackend(WhooshSearchBackend):
    def update(self, index, iterable, commit=True,
        language_specific=False):
        if not language_specific and \
        self.connection_alias == "default":
            current_language = (translation.get_language()
                or settings.LANGUAGE_CODE)[:2]
            for lang_code, lang_name in settings.LANGUAGES:
                using = "default_%s" % lang_code
                translation.activate(lang_code)
                backend = connections[using].get_backend()
                backend.update(index, iterable, commit,
                    language_specific=True)
            translation.activate(current_language)
        elif language_specific:
            super(MultilingualWhooshSearchBackend, self).\
                update(index, iterable, commit)

class MultilingualWhooshSearchQuery(WhooshSearchQuery):
    def __init__(self, using=DEFAULT_ALIAS):
        lang_code = translation.get_language()[:2]
        using = "default_%s" % lang_code
        super(MultilingualWhooshSearchQuery, self).\
            __init__(using)

class MultilingualWhooshEngine(WhooshEngine):
    backend = MultilingualWhooshSearchBackend
    query = MultilingualWhooshSearchQuery</pre></div></li><li class="listitem">Then, let's <a class="indexterm" id="id195"/>create the<a class="indexterm" id="id196"/> search indexes, as follows:<div><pre class="programlisting">
<strong># search/search_indexes.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.conf import settings
from django.utils.translation import get_language
from haystack import indexes
from ideas.models import Idea
from quotes.models import InspirationalQuote

class IdeaIndex(indexes.SearchIndex, indexes.Indexable):
    text = indexes.CharField(document=True)

    def get_model(self):
        return Idea

    def index_queryset(self, using=None):
        """Used when the entire index for model
            is updated."""
        return self.get_model().objects.all()

    def prepare_text(self, obj):
        # this will be called for each language / backend
        return "\n".join((
            obj.title,
            obj.subtitle,
            obj.description,
            "\n".join([cat.title
                for cat in obj.categories.all()
            ]),
        ))

class InspirationalQuoteIndex(indexes.SearchIndex,
    indexes.Indexable):
    text = indexes.CharField(document=True)

    def get_model(self):
        return InspirationalQuote

    def index_queryset(self, using=None):
        """Used when the entire index for model
            is updated."""
        if using and using != "default":
            lang_code = using.replace("default_", "")
        else:
            lang_code = settings.LANGUAGE_CODE[:2]
        return self.get_model().objects.filter(language=lang_code)

    def prepare_text(self, obj):
        # this will be called for each language / backend
        return "\n".join((
            obj.author,
            obj.quote,
        ))</pre></div></li><li class="listitem">Later, configure<a class="indexterm" id="id197"/> the settings to<a class="indexterm" id="id198"/> use our <code class="literal">MultilingualWhooshEngine</code>:<div><pre class="programlisting">INSTALLED_APPS = (
    # …
    # third party
    "crispy_forms",
    "haystack",
    # project-specific
    "quotes",
    "utils",
    "ideas",
    "search",
)
LANGUAGE_CODE = "en"
LANGUAGES = (
    ("en", "English"),
    ("de", "Deutsch"),
    ("fr", "Français"),
    ("lt", "Lietuvių kalba"),
)
CRISPY_TEMPLATE_PACK = "bootstrap3"
HAYSTACK_CONNECTIONS = {
    "default": {
        "ENGINE": "search.multilingual_whoosh_backend."\
            "MultilingualWhooshEngine",
        "PATH": os.path.join(PROJECT_PATH, "myproject",
            "tmp", "whoosh_index_en"),
    },
    "default_en": {
        "ENGINE": "search.multilingual_whoosh_backend."\
            "MultilingualWhooshEngine",
        "PATH": os.path.join(PROJECT_PATH, "myproject",
            "tmp", "whoosh_index_en"),
    },
    "default_de": {
        "ENGINE": "search.multilingual_whoosh_backend."\
            "MultilingualWhooshEngine",
        "PATH": os.path.join(PROJECT_PATH, "myproject",
            "tmp", "whoosh_index_de"),
    },
    "default_fr": {
        "ENGINE": "search.multilingual_whoosh_backend."\
            "MultilingualWhooshEngine",
        "PATH": os.path.join(PROJECT_PATH, "myproject",
            "tmp", "whoosh_index_fr"),
    },
    "default_lt": {
        "ENGINE": "search.multilingual_whoosh_backend."\
            "MultilingualWhooshEngine",
        "PATH": os.path.join(PROJECT_PATH, "myproject",
            "tmp", "whoosh_index_lt"),
    },
}</pre></div></li><li class="listitem">Now, we<a class="indexterm" id="id199"/> need to define<a class="indexterm" id="id200"/> the URL rules for the search view:<div><pre class="programlisting">
<strong># myproject/urls.py</strong>
# -*- coding: UTF-8 -*-
from django.conf.urls import patterns, include, url
from django.core.urlresolvers import reverse_lazy
from django.utils.translation import string_concat
from django.utils.translation import ugettext_lazy as _
from django.conf.urls.i18n import i18n_patterns

from crispy_forms.helper import FormHelper
from crispy_forms import layout, bootstrap
from haystack.views import SearchView

class CrispySearchView(SearchView):
    def extra_context(self):
        helper = FormHelper()
        helper.form_tag = False
        helper.disable_csrf = True
        return {"search_helper": helper}

urlpatterns = i18n_patterns('',
    # …
    url(r'^search/$', CrispySearchView(),
        name='haystack_search'),
    # …
)</pre></div></li><li class="listitem">Then, here <a class="indexterm" id="id201"/>comes the <a class="indexterm" id="id202"/>template for the search form and search results, as shown in the following:<div><pre class="programlisting">
<strong>{# templates/search/search.html #}</strong>
{% extends "base.html" %}
{% load i18n crispy_forms_tags utility_tags %}

{% block content %}
    &lt;h2&gt;{% trans "Search" %}&lt;/h2&gt;
    &lt;form method="get" action="{{ request.path }}"&gt;
        &lt;div class="well clearfix"&gt;
            {% crispy form search_helper %}
            &lt;p class="pull-right"&gt;
                &lt;input class="btn btn-primary" type="submit" value="Search"&gt;
            &lt;/p&gt;
        &lt;/div&gt;
    &lt;/form&gt;

    {% if query %}
        &lt;h3&gt;{% trans "Results" %}&lt;/h3&gt;

        {% for result in page.object_list %}
            &lt;p&gt;
                &lt;a href="{{ result.object.get_url_path }}"&gt;
                    {{ result.object.title }}
                &lt;/a&gt;
            &lt;/p&gt;
        {% empty %}
            &lt;p&gt;{% trans "No results found." %}&lt;/p&gt;
        {% endfor %}

        {% if page.has_previous or page.has_next %}
            &lt;nav&gt;
                &lt;ul class="pager"&gt;
                    &lt;li class="previous"&gt;
                        {% if page.has_previous %}&lt;a href="{% modify_query page=page.previous_page_number %}"&gt;{% endif %}
                            &lt;span aria-hidden="true"&gt;&amp;laquo;&lt;/span&gt;
                        {% if page.has_previous %}&lt;/a&gt;{% endif %}
                    &lt;/li&gt;
                    &lt;li class="next"&gt;
                        {% if page.has_next %}&lt;a href="{% modify_query page=page.next_page_number %}"&gt;{% endif %}
                            &lt;span aria-hidden="true"&gt;&amp;raquo;&lt;/span&gt;
                        {% if page.has_next %}&lt;/a&gt;{% endif %}
                    &lt;/li&gt;
                &lt;/ul&gt;
            &lt;/nav&gt;
        {% endif %}
    {% endif %}
{% endblock %}</pre></div></li><li class="listitem">Call the <code class="literal">rebuild_index</code> management command in order to index the database data and prepare the full-text search to be used:<div><pre class="programlisting">
<strong>(myproject_env)$ python manage.py rebuild_index --noinput</strong>
</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec152"/>How it works…</h2></div></div></div><p>The <code class="literal">MultilingualWhooshEngine</code> specifies two custom properties: backend and query. The custom <code class="literal">MultilingualWhooshSearchBackend</code> backend ensures that, for each language, the<a class="indexterm" id="id203"/> items will be indexed just <a class="indexterm" id="id204"/>in that language and put under the specific <code class="literal">Haystack</code> index location that is defined in the <code class="literal">HAYSTACK_CONNECTIONS</code> setting. The <code class="literal">MultilingualWhooshSearchQuery</code> custom query ensures that when searching for keywords, the specific Haystack connection of the current language will be used.</p><p>Each index has a field <code class="literal">text</code>, where full-text from a specific language of a model will be stored. The model for the index is defined by the <code class="literal">get_model()</code> method, <code class="literal">QuerySet</code> to index is defined by the <code class="literal">index_queryset()</code> method, and text to search in gets collected in the <code class="literal">prepare_text()</code> method.</p><p>As we want to have a nice Bootstrap 3 form, we will be passing <code class="literal">FormHelper</code> from <code class="literal">django-crispy-forms</code> to the search view. We can do that by overriding the <code class="literal">extra_context()</code> method of <code class="literal">SearchView</code>. The final search form will look similar to the following:</p><div><img alt="How it works…" src="img/B04912_03_06.jpg"/></div><p>The<a class="indexterm" id="id205"/> easiest way to regularly update<a class="indexterm" id="id206"/> the search index is to call the <code class="literal">rebuild_index</code> management command by a cron job every night. To learn about it, check the <em>Setting up cron jobs for regular tasks</em> recipe in <a class="link" href="ch11.html" title="Chapter 11. Testing and Deployment">Chapter 11</a>, <em>Testing and Deployment</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec153"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Creating form layout with django-crispy-forms</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Downloading authorized file</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Setting up cron jobs for regular tasks</em> recipe in <a class="link" href="ch11.html" title="Chapter 11. Testing and Deployment">Chapter 11</a>, <em>Testing and Deployment</em></li></ul></div></div></div></body></html>