<html xml:lang="en-US" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<meta charset="utf-8"/>
<meta content="pandoc" name="generator"/>
<title>ch008.xhtml</title>
<link href="../styles/stylesheet1.css" rel="stylesheet" type="text/css"/>
<!-- kobo-style -->
<style id="koboSpanStyle" type="text/css" xmlns="http://www.w3.org/1999/xhtml">.koboSpan { -webkit-text-combine: inherit; }</style>
</head>
<body epub:type="bodymatter">
<section class="level1" data-number="8" id="chapter-4-data-acquisition-features-web-apis-and-scraping">
<h1 data-number="8"><span class="titlemark"><span class="koboSpan" id="kobo.1.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 4</span></span><br/>
<span id="x1-780004"/><span class="koboSpan" id="kobo.2.1" xmlns="http://www.w3.org/1999/xhtml">Data Acquisition Features: Web APIs and Scraping</span></h1>
<p><span class="koboSpan" id="kobo.3.1" xmlns="http://www.w3.org/1999/xhtml">Data analysis often works with data from numerous sources, including databases, web services, and files prepared by other applications. </span><span class="koboSpan" id="kobo.3.2" xmlns="http://www.w3.org/1999/xhtml">In this chapter, you will be guided through two projects to add additional data sources to the baseline application from the previous chapter. </span><span class="koboSpan" id="kobo.3.3" xmlns="http://www.w3.org/1999/xhtml">These new sources include a web service query, and scraping data from a web page.</span></p>
<p><span class="koboSpan" id="kobo.4.1" xmlns="http://www.w3.org/1999/xhtml">This chapter’s projects cover the following essential skills:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.5.1" xmlns="http://www.w3.org/1999/xhtml">Using the </span><strong><span class="koboSpan" id="kobo.6.1" xmlns="http://www.w3.org/1999/xhtml">requests </span></strong><span class="koboSpan" id="kobo.7.1" xmlns="http://www.w3.org/1999/xhtml">package for </span><span id="dx1-78001"/><span class="koboSpan" id="kobo.8.1" xmlns="http://www.w3.org/1999/xhtml">Web API integration. </span><span class="koboSpan" id="kobo.8.2" xmlns="http://www.w3.org/1999/xhtml">We’ll look at the Kaggle API, which requires signing up to create an API token.</span></p></li>
<li><p><span class="koboSpan" id="kobo.9.1" xmlns="http://www.w3.org/1999/xhtml">Using the </span><strong><span class="koboSpan" id="kobo.10.1" xmlns="http://www.w3.org/1999/xhtml">Beautiful Soup </span></strong><span class="koboSpan" id="kobo.11.1" xmlns="http://www.w3.org/1999/xhtml">package to </span><span id="dx1-78002"/><span class="koboSpan" id="kobo.12.1" xmlns="http://www.w3.org/1999/xhtml">parse an HTML web page.</span></p></li>
<li><p><span class="koboSpan" id="kobo.13.1" xmlns="http://www.w3.org/1999/xhtml">Adding features to an existing application and extending the test suite to cover these new alternative data sources.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.14.1" xmlns="http://www.w3.org/1999/xhtml">It’s important to recognize this application has a narrow focus on data acquisition. </span><span class="koboSpan" id="kobo.14.2" xmlns="http://www.w3.org/1999/xhtml">In later chapters, we’ll validate the data and convert it to a more useful form. </span><span class="koboSpan" id="kobo.14.3" xmlns="http://www.w3.org/1999/xhtml">This reflects a separation of the following distinct concerns:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.15.1" xmlns="http://www.w3.org/1999/xhtml">Downloading and extracting data from the source are the foci of this chapter and the next.</span></p></li>
<li><p><span class="koboSpan" id="kobo.16.1" xmlns="http://www.w3.org/1999/xhtml">Inspection begins in </span><a href="ch010.xhtml#x1-1460006"><em><span class="koboSpan" id="kobo.17.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.18.1" xmlns="http://www.w3.org/1999/xhtml"> 6</span></em></a><span class="koboSpan" id="kobo.19.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch010.xhtml#x1-1460006"><em><span class="koboSpan" id="kobo.20.1" xmlns="http://www.w3.org/1999/xhtml">Project 2.1: Data Inspection Notebook</span></em></a><span class="koboSpan" id="kobo.21.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p></li>
<li><p><span class="koboSpan" id="kobo.22.1" xmlns="http://www.w3.org/1999/xhtml">Validating and cleaning the data starts in </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.23.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.24.1" xmlns="http://www.w3.org/1999/xhtml"> 9</span></em></a><span class="koboSpan" id="kobo.25.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.26.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.1: Data</span></em> <em><span class="koboSpan" id="kobo.27.1" xmlns="http://www.w3.org/1999/xhtml">Cleaning Base Application</span></em></a><span class="koboSpan" id="kobo.28.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.29.1" xmlns="http://www.w3.org/1999/xhtml">Each stage in the processing pipeline is allocated to separate projects. </span><span class="koboSpan" id="kobo.29.2" xmlns="http://www.w3.org/1999/xhtml">For more background, see </span><a href="ch006.xhtml#x1-470002"><em><span class="koboSpan" id="kobo.30.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.31.1" xmlns="http://www.w3.org/1999/xhtml"> 2</span></em></a><span class="koboSpan" id="kobo.32.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch006.xhtml#x1-470002"><em><span class="koboSpan" id="kobo.33.1" xmlns="http://www.w3.org/1999/xhtml">Overview of the Projects</span></em></a><span class="koboSpan" id="kobo.34.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.35.1" xmlns="http://www.w3.org/1999/xhtml">We’ll start by looking at getting data using an API and a RESTful web service. </span><span class="koboSpan" id="kobo.35.2" xmlns="http://www.w3.org/1999/xhtml">This will focus on the Kaggle site, which means you will need to sign up with Kaggle to get your own, unique API key. </span><span class="koboSpan" id="kobo.35.3" xmlns="http://www.w3.org/1999/xhtml">The second project will scrape HTML content from a website that doesn’t offer a useful API. </span><span id="x1-78003r78"/></p>
<section class="level2" data-number="8.1" id="project-1.2-acquire-data-from-a-web-service">
<h2 data-number="8.1"><span class="titlemark"><span class="koboSpan" id="kobo.36.1" xmlns="http://www.w3.org/1999/xhtml">4.1 </span></span> <span id="x1-790001"/><span class="koboSpan" id="kobo.37.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.2: Acquire data from a web service</span></h2>
<p><span class="koboSpan" id="kobo.38.1" xmlns="http://www.w3.org/1999/xhtml">It’s common to need data provided by a Web API. </span><span class="koboSpan" id="kobo.38.2" xmlns="http://www.w3.org/1999/xhtml">One common design approach for web services is </span><span id="dx1-79001"/><span class="koboSpan" id="kobo.39.1" xmlns="http://www.w3.org/1999/xhtml">called RESTful; it’s based on a </span><span id="dx1-79002"/><span class="koboSpan" id="kobo.40.1" xmlns="http://www.w3.org/1999/xhtml">number of concepts related to using the HTTP protocol to transfer a representation of an object’s state.</span></p>
<p><span class="koboSpan" id="kobo.41.1" xmlns="http://www.w3.org/1999/xhtml">For more information on RESTful services, see </span><em><span class="koboSpan" id="kobo.42.1" xmlns="http://www.w3.org/1999/xhtml">Building RESTful Python Web Services</span></em><span class="koboSpan" id="kobo.43.1" xmlns="http://www.w3.org/1999/xhtml"> (</span><a class="url" href="https://www.packtpub.com/product/building-restful-python-web-services/9781786462251"><span class="koboSpan" id="kobo.44.1" xmlns="http://www.w3.org/1999/xhtml">https://www.packtpub.com/product/building-restful-python-web-services/9781786462251</span></a><span class="koboSpan" id="kobo.45.1" xmlns="http://www.w3.org/1999/xhtml">).</span></p>
<p><span class="koboSpan" id="kobo.46.1" xmlns="http://www.w3.org/1999/xhtml">A RESTful service generally involves </span><span id="dx1-79003"/><span class="koboSpan" id="kobo.47.1" xmlns="http://www.w3.org/1999/xhtml">using the HTTP protocol to respond to requests from client applications. </span><span class="koboSpan" id="kobo.47.2" xmlns="http://www.w3.org/1999/xhtml">The spectrum of request types includes a number of verbs like get, post, put, patch, and delete. </span><span class="koboSpan" id="kobo.47.3" xmlns="http://www.w3.org/1999/xhtml">In many cases, the service responds with a JSON document. </span><span class="koboSpan" id="kobo.47.4" xmlns="http://www.w3.org/1999/xhtml">It’s also possible to receive a file that’s a stream of NDJSON documents, or even a file that’s a ZIP archive of data.</span></p>
<p><span class="koboSpan" id="kobo.48.1" xmlns="http://www.w3.org/1999/xhtml">We’ll start with a description of the application, and then move on to talk about the architectural approach. </span><span class="koboSpan" id="kobo.48.2" xmlns="http://www.w3.org/1999/xhtml">This will be followed with a detailed list of deliverables. </span><span id="x1-79004r82"/></p>
<section class="level3" data-number="8.1.1" id="description-2">
<h3 data-number="8.1.1"><span class="titlemark"><span class="koboSpan" id="kobo.49.1" xmlns="http://www.w3.org/1999/xhtml">4.1.1 </span></span> <span id="x1-800001"/><span class="koboSpan" id="kobo.50.1" xmlns="http://www.w3.org/1999/xhtml">Description</span></h3>
<p><span class="koboSpan" id="kobo.51.1" xmlns="http://www.w3.org/1999/xhtml">Analysts and decision-makers </span><span id="dx1-80001"/><span class="koboSpan" id="kobo.52.1" xmlns="http://www.w3.org/1999/xhtml">need to acquire data for further analysis. </span><span class="koboSpan" id="kobo.52.2" xmlns="http://www.w3.org/1999/xhtml">In this case, the data is available from a RESTful web service. </span><span class="koboSpan" id="kobo.52.3" xmlns="http://www.w3.org/1999/xhtml">One of the most fun small data sets to work with </span><span id="dx1-80002"/><span class="koboSpan" id="kobo.53.1" xmlns="http://www.w3.org/1999/xhtml">is Anscombe’s Quartet – </span><a class="url" href="https://www.kaggle.com/datasets/carlmcbrideellis/data-anscombes-quartet"><span class="koboSpan" id="kobo.54.1" xmlns="http://www.w3.org/1999/xhtml">https://www.kaggle.com/datasets/carlmcbrideellis/data-anscombes-quartet</span></a></p>
<p><span class="koboSpan" id="kobo.55.1" xmlns="http://www.w3.org/1999/xhtml">Parts of this application are an extension to the project in </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.56.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.57.1" xmlns="http://www.w3.org/1999/xhtml"> 9</span></em></a><span class="koboSpan" id="kobo.58.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.59.1" xmlns="http://www.w3.org/1999/xhtml">Project</span></em> <em><span class="koboSpan" id="kobo.60.1" xmlns="http://www.w3.org/1999/xhtml">3.1: Data Cleaning Base Application</span></em></a><span class="koboSpan" id="kobo.61.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.61.2" xmlns="http://www.w3.org/1999/xhtml">The essential behavior of this application will be similar to the previous project. </span><span class="koboSpan" id="kobo.61.3" xmlns="http://www.w3.org/1999/xhtml">This project will use a CLI application to grab data from a source.</span></p>
<p><span class="koboSpan" id="kobo.62.1" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.63.1" xmlns="http://www.w3.org/1999/xhtml">User Experience </span></strong><span class="koboSpan" id="kobo.64.1" xmlns="http://www.w3.org/1999/xhtml">(</span><strong><span class="koboSpan" id="kobo.65.1" xmlns="http://www.w3.org/1999/xhtml">UX</span></strong><span class="koboSpan" id="kobo.66.1" xmlns="http://www.w3.org/1999/xhtml">) will also be a command-line application with options to fine-tune the data being gathered. </span><span class="koboSpan" id="kobo.66.2" xmlns="http://www.w3.org/1999/xhtml">Our expected command line should like something like the following:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-41">
<div class="tcolorbox-content">
<pre class="console"><span class="koboSpan" id="kobo.67.1" xmlns="http://www.w3.org/1999/xhtml">% python src/acquire.py -o quartet -k ~/Downloads/kaggle.json \
  --zip carlmcbrideellis/data-anscombes-quartet</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.68.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.69.1" xmlns="http://www.w3.org/1999/xhtml">-o</span></code><code><span class="koboSpan" id="kobo.70.1" xmlns="http://www.w3.org/1999/xhtml"> quartet</span></code><span class="koboSpan" id="kobo.71.1" xmlns="http://www.w3.org/1999/xhtml"> argument specifies a </span><span id="dx1-80005"/><span class="koboSpan" id="kobo.72.1" xmlns="http://www.w3.org/1999/xhtml">directory into which four results are written. </span><span class="koboSpan" id="kobo.72.2" xmlns="http://www.w3.org/1999/xhtml">These will have names like </span><code><span class="koboSpan" id="kobo.73.1" xmlns="http://www.w3.org/1999/xhtml">quartet/series_1.json</span></code><span class="koboSpan" id="kobo.74.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.75.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.76.1" xmlns="http://www.w3.org/1999/xhtml">-k</span></code><code><span class="koboSpan" id="kobo.77.1" xmlns="http://www.w3.org/1999/xhtml"> kaggle.json</span></code><span class="koboSpan" id="kobo.78.1" xmlns="http://www.w3.org/1999/xhtml"> argument is the name of a </span><span id="dx1-80006"/><span class="koboSpan" id="kobo.79.1" xmlns="http://www.w3.org/1999/xhtml">file with the username and Kaggle API token. </span><span class="koboSpan" id="kobo.79.2" xmlns="http://www.w3.org/1999/xhtml">This file is kept separate from the application software. </span><span class="koboSpan" id="kobo.79.3" xmlns="http://www.w3.org/1999/xhtml">In the example, the file was in the author’s </span><code><span class="koboSpan" id="kobo.80.1" xmlns="http://www.w3.org/1999/xhtml">Downloads</span></code><span class="koboSpan" id="kobo.81.1" xmlns="http://www.w3.org/1999/xhtml"> folder.</span></p>
<p><span class="koboSpan" id="kobo.82.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.83.1" xmlns="http://www.w3.org/1999/xhtml">--zip</span></code><span class="koboSpan" id="kobo.84.1" xmlns="http://www.w3.org/1999/xhtml"> argument provides the ”reference” — the </span><span id="dx1-80007"/><span class="koboSpan" id="kobo.85.1" xmlns="http://www.w3.org/1999/xhtml">owner and data set name — to open and extract. </span><span class="koboSpan" id="kobo.85.2" xmlns="http://www.w3.org/1999/xhtml">This information is found by examining the details of the Kaggle interface.</span></p>
<p><span class="koboSpan" id="kobo.86.1" xmlns="http://www.w3.org/1999/xhtml">An additional feature is to get a filtered list of Kaggle data sets. </span><span class="koboSpan" id="kobo.86.2" xmlns="http://www.w3.org/1999/xhtml">This should be a separate </span><code><span class="koboSpan" id="kobo.87.1" xmlns="http://www.w3.org/1999/xhtml">--search</span></code><span class="koboSpan" id="kobo.88.1" xmlns="http://www.w3.org/1999/xhtml"> operation that can be bundled into a single application program.</span></p>
<pre class="console"><span class="koboSpan" id="kobo.89.1" xmlns="http://www.w3.org/1999/xhtml">% python src/acquire.py --search -k ~/Downloads/kaggle.json</span></pre>
<p><span class="koboSpan" id="kobo.90.1" xmlns="http://www.w3.org/1999/xhtml">This will apply some search criteria to emit a list of data sets that match the requirements. </span><span class="koboSpan" id="kobo.90.2" xmlns="http://www.w3.org/1999/xhtml">The lists tend to be quite large, so this needs to be used with care.</span></p>
<p><span class="koboSpan" id="kobo.91.1" xmlns="http://www.w3.org/1999/xhtml">The credentials in the file are </span><span id="dx1-80009"/><span class="koboSpan" id="kobo.92.1" xmlns="http://www.w3.org/1999/xhtml">used to make the Kaggle API request. </span><span class="koboSpan" id="kobo.92.2" xmlns="http://www.w3.org/1999/xhtml">In the next sections, we’ll look at the Kaggle API in general. </span><span class="koboSpan" id="kobo.92.3" xmlns="http://www.w3.org/1999/xhtml">After that, we’ll look at the specific requests required to locate the reference to the target data set.</span></p>
<section class="level4 likesubsubsectionHead" data-number="8.1.1.1" id="the-kaggle-api">
<h4 class="likesubsubsectionHead" data-number="8.1.1.1"><span id="x1-810001"/><span class="koboSpan" id="kobo.93.1" xmlns="http://www.w3.org/1999/xhtml">The Kaggle API</span></h4>
<p><span class="koboSpan" id="kobo.94.1" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://www.kaggle.com/docs/api"><span class="koboSpan" id="kobo.95.1" xmlns="http://www.w3.org/1999/xhtml">https://www.kaggle.com/docs/api</span></a><span class="koboSpan" id="kobo.96.1" xmlns="http://www.w3.org/1999/xhtml"> for information </span><span id="dx1-81001"/><span class="koboSpan" id="kobo.97.1" xmlns="http://www.w3.org/1999/xhtml">on the Kaggle API. </span><span class="koboSpan" id="kobo.97.2" xmlns="http://www.w3.org/1999/xhtml">This document describes </span><span id="dx1-81002"/><span class="koboSpan" id="kobo.98.1" xmlns="http://www.w3.org/1999/xhtml">some command-line code (in Python) that uses the API.</span></p>
<p><span class="koboSpan" id="kobo.99.1" xmlns="http://www.w3.org/1999/xhtml">The technical details of the RESTful API requests are at </span><a class="url" href="https://github.com/Kaggle/kaggle-api/blob/master/KaggleSwagger.yaml"><span class="koboSpan" id="kobo.100.1" xmlns="http://www.w3.org/1999/xhtml">https://github.com/Kaggle/kaggle-api/blob/master/KaggleSwagger.yaml</span></a><span class="koboSpan" id="kobo.101.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.101.2" xmlns="http://www.w3.org/1999/xhtml">This document describes the requests and responses from the Kaggle API server.</span></p>
<p><span class="koboSpan" id="kobo.102.1" xmlns="http://www.w3.org/1999/xhtml">To make use of the RESTful API or the command-line applications, you should register with Kaggle. </span><span class="koboSpan" id="kobo.102.2" xmlns="http://www.w3.org/1999/xhtml">First, sign up with </span><code><span class="koboSpan" id="kobo.103.1" xmlns="http://www.w3.org/1999/xhtml">Kaggle.com</span></code><span class="koboSpan" id="kobo.104.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.104.2" xmlns="http://www.w3.org/1999/xhtml">Next, navigate to the public profile page. </span><span class="koboSpan" id="kobo.104.3" xmlns="http://www.w3.org/1999/xhtml">On this page, there’s an API section. </span><span class="koboSpan" id="kobo.104.4" xmlns="http://www.w3.org/1999/xhtml">This section has the buttons you will use to generate a unique API token for your registered username.</span></p>
<p><span class="koboSpan" id="kobo.105.1" xmlns="http://www.w3.org/1999/xhtml">The third step is to click the </span><strong><span class="koboSpan" id="kobo.106.1" xmlns="http://www.w3.org/1999/xhtml">Create New Token </span></strong><span class="koboSpan" id="kobo.107.1" xmlns="http://www.w3.org/1999/xhtml">button to create the token file. </span><span class="koboSpan" id="kobo.107.2" xmlns="http://www.w3.org/1999/xhtml">This will download a small JSON file with your registered username and unique key. </span><span class="koboSpan" id="kobo.107.3" xmlns="http://www.w3.org/1999/xhtml">These credentials are required by the Kaggle REST API.</span></p>
<p><span class="koboSpan" id="kobo.108.1" xmlns="http://www.w3.org/1999/xhtml">The ownership of this file can be changed to read-only by the owner. </span><span class="koboSpan" id="kobo.108.2" xmlns="http://www.w3.org/1999/xhtml">In Linux and macOS, this is done with the following command:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-42">
<div class="tcolorbox-content">
<pre class="console"><span class="koboSpan" id="kobo.109.1" xmlns="http://www.w3.org/1999/xhtml">% chmod 400 ~/Downloads/kaggle.json</span></pre>
</div>
</div>
<div class="tcolorbox tipbox" id="tcolobox-43">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.110.1" xmlns="http://www.w3.org/1999/xhtml">Do not move the Kaggle credentials file named </span><code><span class="koboSpan" id="kobo.111.1" xmlns="http://www.w3.org/1999/xhtml">kaggle.json</span></code><span class="koboSpan" id="kobo.112.1" xmlns="http://www.w3.org/1999/xhtml"> into a directory where your code is also located. </span><span class="koboSpan" id="kobo.112.2" xmlns="http://www.w3.org/1999/xhtml">It’s tempting, but it’s a terrible security mistake because the file could get saved to a code repository and become visible to anyone browsing your code. </span><span class="koboSpan" id="kobo.112.3" xmlns="http://www.w3.org/1999/xhtml">In some enterprises, posting keys in code repositories — even internal repositories — is a security lapse and a good reason for an employee to be terminated.</span></p>
<p><span class="koboSpan" id="kobo.113.1" xmlns="http://www.w3.org/1999/xhtml">Because Git keeps a very complete history, it’s challenging to remove a commit that contains keys.</span></p>
<p><strong><span class="koboSpan" id="kobo.114.1" xmlns="http://www.w3.org/1999/xhtml">Keep the credentials file separate from your code.</span></strong></p>
<p><span class="koboSpan" id="kobo.115.1" xmlns="http://www.w3.org/1999/xhtml">It’s also a good idea to add </span><code><span class="koboSpan" id="kobo.116.1" xmlns="http://www.w3.org/1999/xhtml">kaggle.json</span></code><span class="koboSpan" id="kobo.117.1" xmlns="http://www.w3.org/1999/xhtml"> to a </span><code><span class="koboSpan" id="kobo.118.1" xmlns="http://www.w3.org/1999/xhtml">.gitignore</span></code><span class="koboSpan" id="kobo.119.1" xmlns="http://www.w3.org/1999/xhtml"> file to make extra sure that it won’t be uploaded as part of a commit and push.</span></p>
</div>
</div>
</section>
<section class="level4 likesubsubsectionHead" data-number="8.1.1.2" id="about-the-source-data-1">
<h4 class="likesubsubsectionHead" data-number="8.1.1.2"><span id="x1-820001"/><span class="koboSpan" id="kobo.120.1" xmlns="http://www.w3.org/1999/xhtml">About the source data</span></h4>
<p><span class="koboSpan" id="kobo.121.1" xmlns="http://www.w3.org/1999/xhtml">This project will explore two </span><span id="dx1-82001"/><span class="koboSpan" id="kobo.122.1" xmlns="http://www.w3.org/1999/xhtml">separate kinds of source data. </span><span class="koboSpan" id="kobo.122.2" xmlns="http://www.w3.org/1999/xhtml">Both sources have the same base path of </span><a class="url" href="https://www.kaggle.com/api/v1/"><span class="koboSpan" id="kobo.123.1" xmlns="http://www.w3.org/1999/xhtml">https://www.kaggle.com/api/v1/</span></a><span class="koboSpan" id="kobo.124.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.124.2" xmlns="http://www.w3.org/1999/xhtml">Trying to query this base path won’t provide a useful response; it’s only the starting point for the paths that are built to locate specific resources.</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.125.1" xmlns="http://www.w3.org/1999/xhtml">JSON documents with summaries of data sets or metadata about data sets. </span><span class="koboSpan" id="kobo.125.2" xmlns="http://www.w3.org/1999/xhtml">These come from appending </span><code><span class="koboSpan" id="kobo.126.1" xmlns="http://www.w3.org/1999/xhtml">datasets/list</span></code><span class="koboSpan" id="kobo.127.1" xmlns="http://www.w3.org/1999/xhtml"> to the base path.</span></p></li>
<li><p><span class="koboSpan" id="kobo.128.1" xmlns="http://www.w3.org/1999/xhtml">A ZIP archive that contains the data we’ll use as an example. </span><span class="koboSpan" id="kobo.128.2" xmlns="http://www.w3.org/1999/xhtml">This comes from appending </span><code><span class="koboSpan" id="kobo.129.1" xmlns="http://www.w3.org/1999/xhtml">datasets/download/{ownerSlug}/{datasetSlug}</span></code><span class="koboSpan" id="kobo.130.1" xmlns="http://www.w3.org/1999/xhtml"> to the base path. </span><span class="koboSpan" id="kobo.130.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.131.1" xmlns="http://www.w3.org/1999/xhtml">ownerSlug</span></code><span class="koboSpan" id="kobo.132.1" xmlns="http://www.w3.org/1999/xhtml"> value is ”carlmcbrideellis”. </span><span class="koboSpan" id="kobo.132.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.133.1" xmlns="http://www.w3.org/1999/xhtml">datasetSlug</span></code><span class="koboSpan" id="kobo.134.1" xmlns="http://www.w3.org/1999/xhtml"> value is ”data-anscombes-quartet”. </span><span class="koboSpan" id="kobo.134.2" xmlns="http://www.w3.org/1999/xhtml">A given data set has a </span><code><span class="koboSpan" id="kobo.135.1" xmlns="http://www.w3.org/1999/xhtml">ref</span></code><span class="koboSpan" id="kobo.136.1" xmlns="http://www.w3.org/1999/xhtml"> value as a reference string with the required ”ownerSlug/datasetSlug” format.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.137.1" xmlns="http://www.w3.org/1999/xhtml">The JSON documents require a function to extract a few relevant fields like </span><code><span class="koboSpan" id="kobo.138.1" xmlns="http://www.w3.org/1999/xhtml">title</span></code><span class="koboSpan" id="kobo.139.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.140.1" xmlns="http://www.w3.org/1999/xhtml">ref</span></code><span class="koboSpan" id="kobo.141.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.142.1" xmlns="http://www.w3.org/1999/xhtml">url</span></code><span class="koboSpan" id="kobo.143.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><code><span class="koboSpan" id="kobo.144.1" xmlns="http://www.w3.org/1999/xhtml">totalBytes</span></code><span class="koboSpan" id="kobo.145.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.145.2" xmlns="http://www.w3.org/1999/xhtml">This subset of the available metadata can make it easier to locate useful, interesting data sets. </span><span class="koboSpan" id="kobo.145.3" xmlns="http://www.w3.org/1999/xhtml">There are numerous other properties available for search, like </span><code><span class="koboSpan" id="kobo.146.1" xmlns="http://www.w3.org/1999/xhtml">usabilityRating</span></code><span class="koboSpan" id="kobo.147.1" xmlns="http://www.w3.org/1999/xhtml">; these attributes can distinguish good data sets from experiments or classroom work.</span></p>
<p><span class="koboSpan" id="kobo.148.1" xmlns="http://www.w3.org/1999/xhtml">The suggested data set — the Anscombe Quartet — is available as a ZIP-compressed archive with a single item inside it. </span><span class="koboSpan" id="kobo.148.2" xmlns="http://www.w3.org/1999/xhtml">This means the application must handle ZIP archives and expand a file contained within the archive. </span><span class="koboSpan" id="kobo.148.3" xmlns="http://www.w3.org/1999/xhtml">Python offers the </span><code><span class="koboSpan" id="kobo.149.1" xmlns="http://www.w3.org/1999/xhtml">zipfile</span></code><span class="koboSpan" id="kobo.150.1" xmlns="http://www.w3.org/1999/xhtml"> package to handle locating </span><span id="dx1-82002"/><span class="koboSpan" id="kobo.151.1" xmlns="http://www.w3.org/1999/xhtml">the CSV file within </span><span id="dx1-82003"/><span class="koboSpan" id="kobo.152.1" xmlns="http://www.w3.org/1999/xhtml">the archive. </span><span class="koboSpan" id="kobo.152.2" xmlns="http://www.w3.org/1999/xhtml">Once this file is found, the existing programming from the previous chapter (</span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.153.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.154.1" xmlns="http://www.w3.org/1999/xhtml"> 3</span></em></a><span class="koboSpan" id="kobo.155.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.156.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.1: Data Acquisition Base Application</span></em></a><span class="koboSpan" id="kobo.157.1" xmlns="http://www.w3.org/1999/xhtml">) can be used.</span></p>
<p><span class="koboSpan" id="kobo.158.1" xmlns="http://www.w3.org/1999/xhtml">There are thousands of Kaggle data sets. </span><span class="koboSpan" id="kobo.158.2" xmlns="http://www.w3.org/1999/xhtml">We’ll suggest some alternatives to the Anscombe Quartet in the </span><a href="#x1-1080004"><em><span class="koboSpan" id="kobo.159.1" xmlns="http://www.w3.org/1999/xhtml">Extras</span></em></a><span class="koboSpan" id="kobo.160.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.161.1" xmlns="http://www.w3.org/1999/xhtml">This section has looked at the input, processing, and output of this application. </span><span class="koboSpan" id="kobo.161.2" xmlns="http://www.w3.org/1999/xhtml">In the next section, we’ll look at the overall architecture of the software. </span><span id="x1-82004r85"/></p>
</section>
</section>
<section class="level3" data-number="8.1.2" id="approach-1">
<h3 data-number="8.1.2"><span class="titlemark"><span class="koboSpan" id="kobo.162.1" xmlns="http://www.w3.org/1999/xhtml">4.1.2 </span></span> <span id="x1-830002"/><span class="koboSpan" id="kobo.163.1" xmlns="http://www.w3.org/1999/xhtml">Approach</span></h3>
<p><span class="koboSpan" id="kobo.164.1" xmlns="http://www.w3.org/1999/xhtml">We’ll take some guidance </span><span id="dx1-83001"/><span class="koboSpan" id="kobo.165.1" xmlns="http://www.w3.org/1999/xhtml">from the C4 model ( </span><a class="url" href="https://c4model.com"><span class="koboSpan" id="kobo.166.1" xmlns="http://www.w3.org/1999/xhtml">https://c4model.com</span></a><span class="koboSpan" id="kobo.167.1" xmlns="http://www.w3.org/1999/xhtml">) when looking at our approach:</span></p>
<ul>
<li><p><strong><span class="koboSpan" id="kobo.168.1" xmlns="http://www.w3.org/1999/xhtml">Context</span></strong><span class="koboSpan" id="kobo.169.1" xmlns="http://www.w3.org/1999/xhtml">: For this project, a context diagram </span><span id="dx1-83002"/><span class="koboSpan" id="kobo.170.1" xmlns="http://www.w3.org/1999/xhtml">would show a user extracting data from a source. </span><span class="koboSpan" id="kobo.170.2" xmlns="http://www.w3.org/1999/xhtml">You may find it helpful to draw this diagram.</span></p></li>
<li><p><strong><span class="koboSpan" id="kobo.171.1" xmlns="http://www.w3.org/1999/xhtml">Containers</span></strong><span class="koboSpan" id="kobo.172.1" xmlns="http://www.w3.org/1999/xhtml">: One container is the user’s personal computer. </span><span class="koboSpan" id="kobo.172.2" xmlns="http://www.w3.org/1999/xhtml">The other container is the Kaggle website, which provides the data.</span></p></li>
<li><p><strong><span class="koboSpan" id="kobo.173.1" xmlns="http://www.w3.org/1999/xhtml">Components</span></strong><span class="koboSpan" id="kobo.174.1" xmlns="http://www.w3.org/1999/xhtml">: We’ll address the components below.</span></p></li>
<li><p><strong><span class="koboSpan" id="kobo.175.1" xmlns="http://www.w3.org/1999/xhtml">Code</span></strong><span class="koboSpan" id="kobo.176.1" xmlns="http://www.w3.org/1999/xhtml">: We’ll touch on this to provide some suggested directions.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.177.1" xmlns="http://www.w3.org/1999/xhtml">It’s important to consider this application as an extension to the project in </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.178.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.179.1" xmlns="http://www.w3.org/1999/xhtml"> 3</span></em></a><span class="koboSpan" id="kobo.180.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.181.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.1: Data Acquisition Base Application</span></em></a><span class="koboSpan" id="kobo.182.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.182.2" xmlns="http://www.w3.org/1999/xhtml">The base level of architectural design is provided in that chapter.</span></p>
<p><span class="koboSpan" id="kobo.183.1" xmlns="http://www.w3.org/1999/xhtml">In this project, we’ll be adding a new </span><code><span class="koboSpan" id="kobo.184.1" xmlns="http://www.w3.org/1999/xhtml">kaggle_client</span></code><span class="koboSpan" id="kobo.185.1" xmlns="http://www.w3.org/1999/xhtml"> module to download the data. </span><span class="koboSpan" id="kobo.185.2" xmlns="http://www.w3.org/1999/xhtml">The overall application in the </span><code><span class="koboSpan" id="kobo.186.1" xmlns="http://www.w3.org/1999/xhtml">acquire</span></code><span class="koboSpan" id="kobo.187.1" xmlns="http://www.w3.org/1999/xhtml"> module will change to make use of this new module. </span><span class="koboSpan" id="kobo.187.2" xmlns="http://www.w3.org/1999/xhtml">The other modules should remain unchanged.</span></p>
<p><span class="koboSpan" id="kobo.188.1" xmlns="http://www.w3.org/1999/xhtml">The legacy component diagram is shown in </span><a href="#4.1"><em><span class="koboSpan" id="kobo.189.1" xmlns="http://www.w3.org/1999/xhtml">Figure 4.1</span></em></a><span class="koboSpan" id="kobo.190.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<figure class="IMG---Figure">
<span class="koboSpan" id="kobo.191.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 4.1: Legacy Components " src="../media/file14.jpg"/></span>
<figcaption class="IMG---Caption"><span class="id" id="4.1"><span class="koboSpan" id="kobo.192.1" xmlns="http://www.w3.org/1999/xhtml">Figure 4.1: </span></span><span class="content"><span class="koboSpan" id="kobo.193.1" xmlns="http://www.w3.org/1999/xhtml">Legacy Components </span></span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.194.1" xmlns="http://www.w3.org/1999/xhtml">A new architecture can handle both the examination of the JSON data set listing, as well as the download of a single ZIP file. </span><span class="koboSpan" id="kobo.194.2" xmlns="http://www.w3.org/1999/xhtml">This is shown in </span><a href="#4.2"><em><span class="koboSpan" id="kobo.195.1" xmlns="http://www.w3.org/1999/xhtml">Figure 4.2</span></em></a><span class="koboSpan" id="kobo.196.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<figure class="IMG---Figure">
<span class="koboSpan" id="kobo.197.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 4.2: Revised Component Design " src="../media/file15.jpg"/></span>
<figcaption class="IMG---Caption"><span class="id" id="4.2"><span class="koboSpan" id="kobo.198.1" xmlns="http://www.w3.org/1999/xhtml">Figure 4.2: </span></span><span class="content"><span class="koboSpan" id="kobo.199.1" xmlns="http://www.w3.org/1999/xhtml">Revised Component Design </span></span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.200.1" xmlns="http://www.w3.org/1999/xhtml">The new module here is the </span><code><span class="koboSpan" id="kobo.201.1" xmlns="http://www.w3.org/1999/xhtml">kaggle_client</span></code><span class="koboSpan" id="kobo.202.1" xmlns="http://www.w3.org/1999/xhtml"> module. </span><span class="koboSpan" id="kobo.202.2" xmlns="http://www.w3.org/1999/xhtml">This has a class, </span><code><span class="koboSpan" id="kobo.203.1" xmlns="http://www.w3.org/1999/xhtml">RestAccess</span></code><span class="koboSpan" id="kobo.204.1" xmlns="http://www.w3.org/1999/xhtml">, that provides methods to access Kaggle data. </span><span class="koboSpan" id="kobo.204.2" xmlns="http://www.w3.org/1999/xhtml">It can reach into the Kaggle data set collection and retrieve a desired ZIP file. </span><span class="koboSpan" id="kobo.204.3" xmlns="http://www.w3.org/1999/xhtml">Additional </span><span id="dx1-83007"/><span class="koboSpan" id="kobo.205.1" xmlns="http://www.w3.org/1999/xhtml">methods can be added to examine the list of data sets or get data set metadata.</span></p>
<p><span class="koboSpan" id="kobo.206.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.207.1" xmlns="http://www.w3.org/1999/xhtml">RestAccess</span></code><span class="koboSpan" id="kobo.208.1" xmlns="http://www.w3.org/1999/xhtml"> class is initialized with the contents of the </span><code><span class="koboSpan" id="kobo.209.1" xmlns="http://www.w3.org/1999/xhtml">kaggle.json</span></code><span class="koboSpan" id="kobo.210.1" xmlns="http://www.w3.org/1999/xhtml"> file. </span><span class="koboSpan" id="kobo.210.2" xmlns="http://www.w3.org/1999/xhtml">As part of initialization, it can create the required authentication object for use in all subsequent calls.</span></p>
<p><span class="koboSpan" id="kobo.211.1" xmlns="http://www.w3.org/1999/xhtml">In the following sections, we’ll look at </span><span id="dx1-83008"/><span class="koboSpan" id="kobo.212.1" xmlns="http://www.w3.org/1999/xhtml">these features of the </span><code><span class="koboSpan" id="kobo.213.1" xmlns="http://www.w3.org/1999/xhtml">RestAccess</span></code><span class="koboSpan" id="kobo.214.1" xmlns="http://www.w3.org/1999/xhtml"> class:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.215.1" xmlns="http://www.w3.org/1999/xhtml">Making API requests in general.</span></p></li>
<li><p><span class="koboSpan" id="kobo.216.1" xmlns="http://www.w3.org/1999/xhtml">Getting the ZIP archive.</span></p></li>
<li><p><span class="koboSpan" id="kobo.217.1" xmlns="http://www.w3.org/1999/xhtml">Getting the list of data sets.</span></p></li>
<li><p><span class="koboSpan" id="kobo.218.1" xmlns="http://www.w3.org/1999/xhtml">Handling the rate-limiting response.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.219.1" xmlns="http://www.w3.org/1999/xhtml">We’ll start with the </span><span id="dx1-83009"/><span class="koboSpan" id="kobo.220.1" xmlns="http://www.w3.org/1999/xhtml">most important feature, making API requests in a general way.</span></p>
<section class="level4 likesubsubsectionHead" data-number="8.1.2.1" id="making-api-requests">
<h4 class="likesubsubsectionHead" data-number="8.1.2.1"><span id="x1-840002"/><span class="koboSpan" id="kobo.221.1" xmlns="http://www.w3.org/1999/xhtml">Making API requests</span></h4>
<p><span class="koboSpan" id="kobo.222.1" xmlns="http://www.w3.org/1999/xhtml">The component diagram shows the </span><code><span class="koboSpan" id="kobo.223.1" xmlns="http://www.w3.org/1999/xhtml">requests</span></code><span class="koboSpan" id="kobo.224.1" xmlns="http://www.w3.org/1999/xhtml"> package as the preferred way to access RESTful APIs. </span><span class="koboSpan" id="kobo.224.2" xmlns="http://www.w3.org/1999/xhtml">This package </span><span id="dx1-84001"/><span class="koboSpan" id="kobo.225.1" xmlns="http://www.w3.org/1999/xhtml">should be added to the project’s </span><code><span class="koboSpan" id="kobo.226.1" xmlns="http://www.w3.org/1999/xhtml">pyproject.toml</span></code><span class="koboSpan" id="kobo.227.1" xmlns="http://www.w3.org/1999/xhtml"> and installed as part of the project’s virtual environment.</span></p>
<p><span class="koboSpan" id="kobo.228.1" xmlns="http://www.w3.org/1999/xhtml">It’s also sensible to make RESTful API requests with the </span><code><span class="koboSpan" id="kobo.229.1" xmlns="http://www.w3.org/1999/xhtml">urllib</span></code><span class="koboSpan" id="kobo.230.1" xmlns="http://www.w3.org/1999/xhtml"> package. </span><span class="koboSpan" id="kobo.230.2" xmlns="http://www.w3.org/1999/xhtml">This is part of the standard library. </span><span class="koboSpan" id="kobo.230.3" xmlns="http://www.w3.org/1999/xhtml">It works nicely </span><span id="dx1-84002"/><span class="koboSpan" id="kobo.231.1" xmlns="http://www.w3.org/1999/xhtml">and requires no additional installation. </span><span class="koboSpan" id="kobo.231.2" xmlns="http://www.w3.org/1999/xhtml">The code can become rather complicated-looking, however, so it’s not as highly recommended as the </span><code><span class="koboSpan" id="kobo.232.1" xmlns="http://www.w3.org/1999/xhtml">requests</span></code><span class="koboSpan" id="kobo.233.1" xmlns="http://www.w3.org/1999/xhtml"> package.</span></p>
<p><span class="koboSpan" id="kobo.234.1" xmlns="http://www.w3.org/1999/xhtml">The essential benefit of using </span><code><span class="koboSpan" id="kobo.235.1" xmlns="http://www.w3.org/1999/xhtml">requests</span></code><span class="koboSpan" id="kobo.236.1" xmlns="http://www.w3.org/1999/xhtml"> is creating an authentication object and providing it in each request. </span><span class="koboSpan" id="kobo.236.2" xmlns="http://www.w3.org/1999/xhtml">We often use code like the following example:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-44">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.237.1" xmlns="http://www.w3.org/1999/xhtml">import json
from pathlib import Path
import requests.auth

keypath = Path.home() / "Downloads" / "kaggle.json"
with keypath.open() as keyfile:
    credentials = json.load(keyfile)
auth = requests.auth.HTTPBasicAuth(
    credentials[’username’], credentials[’key’]
)</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.238.1" xmlns="http://www.w3.org/1999/xhtml">This can be part of the </span><code><span class="koboSpan" id="kobo.239.1" xmlns="http://www.w3.org/1999/xhtml">__init__()</span></code><span class="koboSpan" id="kobo.240.1" xmlns="http://www.w3.org/1999/xhtml"> method of the </span><code><span class="koboSpan" id="kobo.241.1" xmlns="http://www.w3.org/1999/xhtml">RestAccess</span></code><span class="koboSpan" id="kobo.242.1" xmlns="http://www.w3.org/1999/xhtml"> class.</span></p>
<p><span class="koboSpan" id="kobo.243.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.244.1" xmlns="http://www.w3.org/1999/xhtml">auth</span></code><span class="koboSpan" id="kobo.245.1" xmlns="http://www.w3.org/1999/xhtml"> object created here can be used to make all subsequent requests. </span><span class="koboSpan" id="kobo.245.2" xmlns="http://www.w3.org/1999/xhtml">This will provide the necessary username and API </span><span id="dx1-84013"/><span class="koboSpan" id="kobo.246.1" xmlns="http://www.w3.org/1999/xhtml">token to validate the user. </span><span class="koboSpan" id="kobo.246.2" xmlns="http://www.w3.org/1999/xhtml">This means other methods can, for example, use </span><code><span class="koboSpan" id="kobo.247.1" xmlns="http://www.w3.org/1999/xhtml">requests.get()</span></code><span class="koboSpan" id="kobo.248.1" xmlns="http://www.w3.org/1999/xhtml"> with a keyword parameter value of </span><code><span class="koboSpan" id="kobo.249.1" xmlns="http://www.w3.org/1999/xhtml">auth=self.auth</span></code><span class="koboSpan" id="kobo.250.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.250.2" xmlns="http://www.w3.org/1999/xhtml">This will correctly </span><span id="dx1-84014"/><span class="koboSpan" id="kobo.251.1" xmlns="http://www.w3.org/1999/xhtml">build the needed </span><code><span class="koboSpan" id="kobo.252.1" xmlns="http://www.w3.org/1999/xhtml">Authorization</span></code><span class="koboSpan" id="kobo.253.1" xmlns="http://www.w3.org/1999/xhtml"> headers in each request.</span></p>
<p><span class="koboSpan" id="kobo.254.1" xmlns="http://www.w3.org/1999/xhtml">Once the class is initialized properly, we can look at the method for downloading a ZIP archive</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="8.1.2.2" id="downloading-a-zip-archive">
<h4 class="likesubsubsectionHead" data-number="8.1.2.2"><span id="x1-850002"/><span class="koboSpan" id="kobo.255.1" xmlns="http://www.w3.org/1999/xhtml">Downloading a ZIP archive</span></h4>
<p><span class="koboSpan" id="kobo.256.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.257.1" xmlns="http://www.w3.org/1999/xhtml">RestAccess</span></code><span class="koboSpan" id="kobo.258.1" xmlns="http://www.w3.org/1999/xhtml"> class needs a </span><code><span class="koboSpan" id="kobo.259.1" xmlns="http://www.w3.org/1999/xhtml">get_zip()</span></code><span class="koboSpan" id="kobo.260.1" xmlns="http://www.w3.org/1999/xhtml"> method to download the ZIP file. </span><span class="koboSpan" id="kobo.260.2" xmlns="http://www.w3.org/1999/xhtml">The parameter is the URL for downloading the </span><span id="dx1-85001"/><span class="koboSpan" id="kobo.261.1" xmlns="http://www.w3.org/1999/xhtml">requested data set.</span></p>
<p><span class="koboSpan" id="kobo.262.1" xmlns="http://www.w3.org/1999/xhtml">The best </span><span id="dx1-85002"/><span class="koboSpan" id="kobo.263.1" xmlns="http://www.w3.org/1999/xhtml">approach to building this URL for this data set is to combine three strings:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.264.1" xmlns="http://www.w3.org/1999/xhtml">The base address for the APIs, </span><code><span class="koboSpan" id="kobo.265.1" xmlns="http://www.w3.org/1999/xhtml">https://www.kaggle.com/api/v1</span></code><span class="koboSpan" id="kobo.266.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p></li>
<li><p><span class="koboSpan" id="kobo.267.1" xmlns="http://www.w3.org/1999/xhtml">The path for downloads, </span><code><span class="koboSpan" id="kobo.268.1" xmlns="http://www.w3.org/1999/xhtml">/datasets/download/</span></code><span class="koboSpan" id="kobo.269.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p></li>
<li><p><span class="koboSpan" id="kobo.270.1" xmlns="http://www.w3.org/1999/xhtml">The reference is a string with the form: </span><code><span class="koboSpan" id="kobo.271.1" xmlns="http://www.w3.org/1999/xhtml">{ownerSlug}/{datasetSlug}</span></code><span class="koboSpan" id="kobo.272.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.273.1" xmlns="http://www.w3.org/1999/xhtml">This is an ideal place for a Python f-string to replace the reference in the URL pattern.</span></p>
<p><span class="koboSpan" id="kobo.274.1" xmlns="http://www.w3.org/1999/xhtml">The output from the </span><code><span class="koboSpan" id="kobo.275.1" xmlns="http://www.w3.org/1999/xhtml">get_zip()</span></code><span class="koboSpan" id="kobo.276.1" xmlns="http://www.w3.org/1999/xhtml"> method should be a </span><code><span class="koboSpan" id="kobo.277.1" xmlns="http://www.w3.org/1999/xhtml">Path</span></code><span class="koboSpan" id="kobo.278.1" xmlns="http://www.w3.org/1999/xhtml"> object. </span><span class="koboSpan" id="kobo.278.2" xmlns="http://www.w3.org/1999/xhtml">In some cases, the ZIP archives are gigantic and can’t be processed entirely in memory. </span><span class="koboSpan" id="kobo.278.3" xmlns="http://www.w3.org/1999/xhtml">In these extreme cases, a more complicated, chunked download is required. </span><span class="koboSpan" id="kobo.278.4" xmlns="http://www.w3.org/1999/xhtml">For these smaller files used by this project, the download can be handled entirely in memory. </span><span class="koboSpan" id="kobo.278.5" xmlns="http://www.w3.org/1999/xhtml">Once the ZIP file has been written, the client of this </span><code><span class="koboSpan" id="kobo.279.1" xmlns="http://www.w3.org/1999/xhtml">RestAccess</span></code><span class="koboSpan" id="kobo.280.1" xmlns="http://www.w3.org/1999/xhtml"> class can then open it and extract the useful member.</span></p>
<p><span class="koboSpan" id="kobo.281.1" xmlns="http://www.w3.org/1999/xhtml">A separate client function or class will process the content of the ZIP archive file. </span><span class="koboSpan" id="kobo.281.2" xmlns="http://www.w3.org/1999/xhtml">The following is </span><strong><span class="koboSpan" id="kobo.282.1" xmlns="http://www.w3.org/1999/xhtml">not </span></strong><span class="koboSpan" id="kobo.283.1" xmlns="http://www.w3.org/1999/xhtml">part of the </span><code><span class="koboSpan" id="kobo.284.1" xmlns="http://www.w3.org/1999/xhtml">RestAccess</span></code><span class="koboSpan" id="kobo.285.1" xmlns="http://www.w3.org/1999/xhtml"> class but is part of some client class or function that uses the </span><code><span class="koboSpan" id="kobo.286.1" xmlns="http://www.w3.org/1999/xhtml">RestAccess</span></code><span class="koboSpan" id="kobo.287.1" xmlns="http://www.w3.org/1999/xhtml"> class.</span></p>
<p><span class="koboSpan" id="kobo.288.1" xmlns="http://www.w3.org/1999/xhtml">Processing an element of an </span><span id="dx1-85003"/><span class="koboSpan" id="kobo.289.1" xmlns="http://www.w3.org/1999/xhtml">archive can be done </span><span id="dx1-85004"/><span class="koboSpan" id="kobo.290.1" xmlns="http://www.w3.org/1999/xhtml">with two nested </span><code><span class="koboSpan" id="kobo.291.1" xmlns="http://www.w3.org/1999/xhtml">with</span></code><span class="koboSpan" id="kobo.292.1" xmlns="http://www.w3.org/1999/xhtml"> contexts. </span><span class="koboSpan" id="kobo.292.2" xmlns="http://www.w3.org/1999/xhtml">They would work like this:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.293.1" xmlns="http://www.w3.org/1999/xhtml">An outer </span><code><span class="koboSpan" id="kobo.294.1" xmlns="http://www.w3.org/1999/xhtml">with</span></code><span class="koboSpan" id="kobo.295.1" xmlns="http://www.w3.org/1999/xhtml"> statement uses the </span><code><span class="koboSpan" id="kobo.296.1" xmlns="http://www.w3.org/1999/xhtml">zipfile</span></code><span class="koboSpan" id="kobo.297.1" xmlns="http://www.w3.org/1999/xhtml"> module to open the archive, creating a </span><code><span class="koboSpan" id="kobo.298.1" xmlns="http://www.w3.org/1999/xhtml">ZipFile</span></code><span class="koboSpan" id="kobo.299.1" xmlns="http://www.w3.org/1999/xhtml"> instance.</span></p></li>
<li><p><span class="koboSpan" id="kobo.300.1" xmlns="http://www.w3.org/1999/xhtml">An inner </span><code><span class="koboSpan" id="kobo.301.1" xmlns="http://www.w3.org/1999/xhtml">with</span></code><span class="koboSpan" id="kobo.302.1" xmlns="http://www.w3.org/1999/xhtml"> statement can open the specific member with the Anscombe quartet CSV file. </span><span class="koboSpan" id="kobo.302.2" xmlns="http://www.w3.org/1999/xhtml">Inside this context, the application can create a </span><code><span class="koboSpan" id="kobo.303.1" xmlns="http://www.w3.org/1999/xhtml">csv.DictReader</span></code><span class="koboSpan" id="kobo.304.1" xmlns="http://www.w3.org/1999/xhtml"> and use the existing </span><code><span class="koboSpan" id="kobo.305.1" xmlns="http://www.w3.org/1999/xhtml">Extract</span></code><span class="koboSpan" id="kobo.306.1" xmlns="http://www.w3.org/1999/xhtml"> class to read and process the data.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.307.1" xmlns="http://www.w3.org/1999/xhtml">What’s important here is we don’t need to unpack the ZIP archive and litter our storage with unzipped files. </span><span class="koboSpan" id="kobo.307.2" xmlns="http://www.w3.org/1999/xhtml">An application can open and process the elements using the </span><code><span class="koboSpan" id="kobo.308.1" xmlns="http://www.w3.org/1999/xhtml">ZipFile.open()</span></code><span class="koboSpan" id="kobo.309.1" xmlns="http://www.w3.org/1999/xhtml"> method.</span></p>
<p><span class="koboSpan" id="kobo.310.1" xmlns="http://www.w3.org/1999/xhtml">In addition to downloading the ZIP archive, we may also want to survey the available data sets. </span><span class="koboSpan" id="kobo.310.2" xmlns="http://www.w3.org/1999/xhtml">For this, a special iterator method is helpful. </span><span class="koboSpan" id="kobo.310.3" xmlns="http://www.w3.org/1999/xhtml">We’ll look at that next.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="8.1.2.3" id="getting-the-data-set-list">
<h4 class="likesubsubsectionHead" data-number="8.1.2.3"><span id="x1-860002"/><span class="koboSpan" id="kobo.311.1" xmlns="http://www.w3.org/1999/xhtml">Getting the data set list</span></h4>
<p><span class="koboSpan" id="kobo.312.1" xmlns="http://www.w3.org/1999/xhtml">The catalog of data </span><span id="dx1-86001"/><span class="koboSpan" id="kobo.313.1" xmlns="http://www.w3.org/1999/xhtml">sets is found by using the following path:</span></p>
<p><a class="url" href="https://www.kaggle.com/api/v1/datasets/list"><span class="koboSpan" id="kobo.314.1" xmlns="http://www.w3.org/1999/xhtml">https://www.kaggle.com/api/v1/datasets/list</span></a></p>
<p><span class="koboSpan" id="kobo.315.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.316.1" xmlns="http://www.w3.org/1999/xhtml">RestAccess</span></code><span class="koboSpan" id="kobo.317.1" xmlns="http://www.w3.org/1999/xhtml"> class can have a </span><code><span class="koboSpan" id="kobo.318.1" xmlns="http://www.w3.org/1999/xhtml">dataset_iter()</span></code><span class="koboSpan" id="kobo.319.1" xmlns="http://www.w3.org/1999/xhtml"> method to iterate through the collection of data sets. </span><span class="koboSpan" id="kobo.319.2" xmlns="http://www.w3.org/1999/xhtml">This is helpful </span><span id="dx1-86002"/><span class="koboSpan" id="kobo.320.1" xmlns="http://www.w3.org/1999/xhtml">for locating other data sets. </span><span class="koboSpan" id="kobo.320.2" xmlns="http://www.w3.org/1999/xhtml">It’s not required for finding the Anscombe’s Quartet, since the </span><code><span class="koboSpan" id="kobo.321.1" xmlns="http://www.w3.org/1999/xhtml">ownerSlug</span></code><span class="koboSpan" id="kobo.322.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.323.1" xmlns="http://www.w3.org/1999/xhtml">datasetSlug</span></code><span class="koboSpan" id="kobo.324.1" xmlns="http://www.w3.org/1999/xhtml"> reference information is already known.</span></p>
<p><span class="koboSpan" id="kobo.325.1" xmlns="http://www.w3.org/1999/xhtml">This method can make a </span><code><span class="koboSpan" id="kobo.326.1" xmlns="http://www.w3.org/1999/xhtml">GET</span></code><span class="koboSpan" id="kobo.327.1" xmlns="http://www.w3.org/1999/xhtml"> request via the </span><code><span class="koboSpan" id="kobo.328.1" xmlns="http://www.w3.org/1999/xhtml">requests.get()</span></code><span class="koboSpan" id="kobo.329.1" xmlns="http://www.w3.org/1999/xhtml"> function to this URL. </span><span class="koboSpan" id="kobo.329.2" xmlns="http://www.w3.org/1999/xhtml">The response will be on the first page of available Kaggle data sets. </span><span class="koboSpan" id="kobo.329.3" xmlns="http://www.w3.org/1999/xhtml">The results are provided in pages, and each request needs to provide a page number as a parameter to get subsequent pages.</span></p>
<p><span class="koboSpan" id="kobo.330.1" xmlns="http://www.w3.org/1999/xhtml">Each page of results will be a JSON document that contains a sequence of dictionary objects. </span><span class="koboSpan" id="kobo.330.2" xmlns="http://www.w3.org/1999/xhtml">It has the following kind of structure:</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.331.1" xmlns="http://www.w3.org/1999/xhtml">[
    {"id": some_number, "ref": "username/dataset", "title": ...},
    {"id": another_number, "ref": "username/dataset", "title": ...},
    etc.
</span><span class="koboSpan" id="kobo.331.2" xmlns="http://www.w3.org/1999/xhtml">]</span></pre>
<p><span class="koboSpan" id="kobo.332.1" xmlns="http://www.w3.org/1999/xhtml">This kind of two-tiered structure — with pages and items within each page — is the ideal place to use a generator </span><span id="dx1-86003"/><span class="koboSpan" id="kobo.333.1" xmlns="http://www.w3.org/1999/xhtml">function to iterate through the pages. </span><span class="koboSpan" id="kobo.333.2" xmlns="http://www.w3.org/1999/xhtml">Within an outer cycle, an inner iteration can yield the individual data </span><span id="dx1-86004"/><span class="koboSpan" id="kobo.334.1" xmlns="http://www.w3.org/1999/xhtml">set rows from each page.</span></p>
<p><span class="koboSpan" id="kobo.335.1" xmlns="http://www.w3.org/1999/xhtml">This nested iteration can look something like the following code snippet:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-45">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.336.1" xmlns="http://www.w3.org/1999/xhtml">def dataset_iter(url: str, query: dict[str, str]) -&gt;
  Iterator[dict[str, str]]:
    page = 1
    while True:
        response = requests.get(url, params=quert | {"page": str(page)})
        if response.status_code == 200:
            details = response.json()
            if details:
                yield from iter(details)
                page += 1
            else:
                break
        elif response.status_code == 429:
            # Too Many Requests
            # Pause and try again processing goes here...
            </span><span class="koboSpan" id="kobo.336.2" xmlns="http://www.w3.org/1999/xhtml">pass
        else:
            # Unexpected response
            # Error processing goes here...
            </span><span class="koboSpan" id="kobo.336.3" xmlns="http://www.w3.org/1999/xhtml">break</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.337.1" xmlns="http://www.w3.org/1999/xhtml">This shows the nested processing of the </span><code><span class="koboSpan" id="kobo.338.1" xmlns="http://www.w3.org/1999/xhtml">while</span></code><span class="koboSpan" id="kobo.339.1" xmlns="http://www.w3.org/1999/xhtml"> statement ends when a response contains a page of results with zero entries in it. </span><span class="koboSpan" id="kobo.339.2" xmlns="http://www.w3.org/1999/xhtml">The processing to handle too many requests is omitted. </span><span class="koboSpan" id="kobo.339.3" xmlns="http://www.w3.org/1999/xhtml">Similarly, the logging of unexpected responses is also omitted.</span></p>
<p><span class="koboSpan" id="kobo.340.1" xmlns="http://www.w3.org/1999/xhtml">A client function would use the </span><code><span class="koboSpan" id="kobo.341.1" xmlns="http://www.w3.org/1999/xhtml">RestAccess</span></code><span class="koboSpan" id="kobo.342.1" xmlns="http://www.w3.org/1999/xhtml"> class to scan data sets and would look like the following example:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-46">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.343.1" xmlns="http://www.w3.org/1999/xhtml">keypath = Path.home()/"Downloads"/"kaggle.json"
with keypath.open() as keyfile:
    credentials = json.load(keyfile)

reader = Access(credentials)
for row in reader.dataset_iter(list_url):
    print(row[’title’], row[’ref’], row[’url’], row[’totalBytes’])</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.344.1" xmlns="http://www.w3.org/1999/xhtml">This will process all of the </span><span id="dx1-86032"/><span class="koboSpan" id="kobo.345.1" xmlns="http://www.w3.org/1999/xhtml">data set descriptions returned by the </span><code><span class="koboSpan" id="kobo.346.1" xmlns="http://www.w3.org/1999/xhtml">RestReader</span></code><span class="koboSpan" id="kobo.347.1" xmlns="http://www.w3.org/1999/xhtml"> object, </span><code><span class="koboSpan" id="kobo.348.1" xmlns="http://www.w3.org/1999/xhtml">reader</span></code><span class="koboSpan" id="kobo.349.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.349.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.350.1" xmlns="http://www.w3.org/1999/xhtml">dataset_iter()</span></code><span class="koboSpan" id="kobo.351.1" xmlns="http://www.w3.org/1999/xhtml"> method needs to </span><span id="dx1-86033"/><span class="koboSpan" id="kobo.352.1" xmlns="http://www.w3.org/1999/xhtml">accept a </span><code><span class="koboSpan" id="kobo.353.1" xmlns="http://www.w3.org/1999/xhtml">query</span></code><span class="koboSpan" id="kobo.354.1" xmlns="http://www.w3.org/1999/xhtml"> parameter that can limit the scope of the search. </span><span class="koboSpan" id="kobo.354.2" xmlns="http://www.w3.org/1999/xhtml">We encourage you to read the OpenAPI specification to see what options are possible for the </span><code><span class="koboSpan" id="kobo.355.1" xmlns="http://www.w3.org/1999/xhtml">query</span></code><span class="koboSpan" id="kobo.356.1" xmlns="http://www.w3.org/1999/xhtml"> parameter. </span><span class="koboSpan" id="kobo.356.2" xmlns="http://www.w3.org/1999/xhtml">These values will become part of the query string in the HTTP </span><code><span class="koboSpan" id="kobo.357.1" xmlns="http://www.w3.org/1999/xhtml">GET</span></code><span class="koboSpan" id="kobo.358.1" xmlns="http://www.w3.org/1999/xhtml"> request.</span></p>
<p><span class="koboSpan" id="kobo.359.1" xmlns="http://www.w3.org/1999/xhtml">Here’s the formal definition of the interface:</span></p>
<p><a class="url" href="https://github.com/Kaggle/kaggle-api/blob/master/KaggleSwagger.yaml"><span class="koboSpan" id="kobo.360.1" xmlns="http://www.w3.org/1999/xhtml">https://github.com/Kaggle/kaggle-api/blob/master/KaggleSwagger.yaml</span></a></p>
<p><span class="koboSpan" id="kobo.361.1" xmlns="http://www.w3.org/1999/xhtml">Some of the </span><span id="dx1-86034"/><span class="koboSpan" id="kobo.362.1" xmlns="http://www.w3.org/1999/xhtml">query parameters include the following:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.363.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.364.1" xmlns="http://www.w3.org/1999/xhtml">filetype</span></code><span class="koboSpan" id="kobo.365.1" xmlns="http://www.w3.org/1999/xhtml"> query is helpful in locating data in JSON or CSV formats.</span></p></li>
<li><p><span class="koboSpan" id="kobo.366.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.367.1" xmlns="http://www.w3.org/1999/xhtml">maxSize</span></code><span class="koboSpan" id="kobo.368.1" xmlns="http://www.w3.org/1999/xhtml"> query can constrain the data sets to a reasonable size. </span><span class="koboSpan" id="kobo.368.2" xmlns="http://www.w3.org/1999/xhtml">For initial exploration, 1MB is a good upper limit.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.369.1" xmlns="http://www.w3.org/1999/xhtml">Initial spike solutions — without regard to the rate limiting — will turn up at least 80 pages of possible data sets. </span><span class="koboSpan" id="kobo.369.2" xmlns="http://www.w3.org/1999/xhtml">Handling the rate-limiting response will produce more extensive results, at the cost of some time spent waiting. </span><span class="koboSpan" id="kobo.369.3" xmlns="http://www.w3.org/1999/xhtml">In the next section, we’ll expand this method to handle the error response.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="8.1.2.4" id="rate-limiting">
<h4 class="likesubsubsectionHead" data-number="8.1.2.4"><span id="x1-870002"/><span class="koboSpan" id="kobo.370.1" xmlns="http://www.w3.org/1999/xhtml">Rate limiting</span></h4>
<p><span class="koboSpan" id="kobo.371.1" xmlns="http://www.w3.org/1999/xhtml">As with many APIs, the Kaggle API </span><span id="dx1-87001"/><span class="koboSpan" id="kobo.372.1" xmlns="http://www.w3.org/1999/xhtml">imposes rate-limiting to avoid a </span><strong><span class="koboSpan" id="kobo.373.1" xmlns="http://www.w3.org/1999/xhtml">Denial-of-Service </span></strong><span class="koboSpan" id="kobo.374.1" xmlns="http://www.w3.org/1999/xhtml">(</span><strong><span class="koboSpan" id="kobo.375.1" xmlns="http://www.w3.org/1999/xhtml">DoS</span></strong><span class="koboSpan" id="kobo.376.1" xmlns="http://www.w3.org/1999/xhtml">) attack. </span><span class="koboSpan" id="kobo.376.2" xmlns="http://www.w3.org/1999/xhtml">For more information see </span><a class="url" href="https://cheatsheetseries.owasp.org/cheatsheets/Denial_of_Service_Cheat_Sheet.html"><span class="koboSpan" id="kobo.377.1" xmlns="http://www.w3.org/1999/xhtml">https://cheatsheetseries.owasp.org/cheatsheets/Denial_of_Service_Cheat_Sheet.html</span></a><span class="koboSpan" id="kobo.378.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.379.1" xmlns="http://www.w3.org/1999/xhtml">Each user has a limited </span><span id="dx1-87002"/><span class="koboSpan" id="kobo.380.1" xmlns="http://www.w3.org/1999/xhtml">number of requests per second. </span><span class="koboSpan" id="kobo.380.2" xmlns="http://www.w3.org/1999/xhtml">While the limit is generous for most purposes, it will tend to prevent a simple scan of </span><strong><span class="koboSpan" id="kobo.381.1" xmlns="http://www.w3.org/1999/xhtml">all </span></strong><span class="koboSpan" id="kobo.382.1" xmlns="http://www.w3.org/1999/xhtml">data sets.</span></p>
<p><span class="koboSpan" id="kobo.383.1" xmlns="http://www.w3.org/1999/xhtml">A status code of 429 in a Kaggle response </span><span id="dx1-87003"/><span class="koboSpan" id="kobo.384.1" xmlns="http://www.w3.org/1999/xhtml">tells the client application that too many requests were made. </span><span class="koboSpan" id="kobo.384.2" xmlns="http://www.w3.org/1999/xhtml">This ”too many requests” error response will have a header with the key </span><code><span class="koboSpan" id="kobo.385.1" xmlns="http://www.w3.org/1999/xhtml">Retry-After</span></code><span class="koboSpan" id="kobo.386.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.386.2" xmlns="http://www.w3.org/1999/xhtml">This header’s value is the timeout interval (in seconds) before the next request can be made.</span></p>
<p><span class="koboSpan" id="kobo.387.1" xmlns="http://www.w3.org/1999/xhtml">A reliable application will have a structure that handles the 429 vs. 200 responses gracefully. </span><span class="koboSpan" id="kobo.387.2" xmlns="http://www.w3.org/1999/xhtml">The example in the previous section has a simple </span><code><span class="koboSpan" id="kobo.388.1" xmlns="http://www.w3.org/1999/xhtml">if</span></code><span class="koboSpan" id="kobo.389.1" xmlns="http://www.w3.org/1999/xhtml"> statement to check the condition </span><code><span class="koboSpan" id="kobo.390.1" xmlns="http://www.w3.org/1999/xhtml">if</span></code><code><span class="koboSpan" id="kobo.391.1" xmlns="http://www.w3.org/1999/xhtml"> response.status_code</span></code><code><span class="koboSpan" id="kobo.392.1" xmlns="http://www.w3.org/1999/xhtml"> ==</span></code><code><span class="koboSpan" id="kobo.393.1" xmlns="http://www.w3.org/1999/xhtml"> 200</span></code><span class="koboSpan" id="kobo.394.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.394.2" xmlns="http://www.w3.org/1999/xhtml">This needs to be expanded to handle these three alternatives:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.395.1" xmlns="http://www.w3.org/1999/xhtml">A status code of 200 is a good response. </span><span class="koboSpan" id="kobo.395.2" xmlns="http://www.w3.org/1999/xhtml">If the page has any details, these can be processed; the value of </span><code><span class="koboSpan" id="kobo.396.1" xmlns="http://www.w3.org/1999/xhtml">page</span></code><span class="koboSpan" id="kobo.397.1" xmlns="http://www.w3.org/1999/xhtml"> can be incremented. </span><span class="koboSpan" id="kobo.397.2" xmlns="http://www.w3.org/1999/xhtml">Otherwise, there’s no more data making it appropriate to break from the containing </span><code><span class="koboSpan" id="kobo.398.1" xmlns="http://www.w3.org/1999/xhtml">while</span></code><span class="koboSpan" id="kobo.399.1" xmlns="http://www.w3.org/1999/xhtml"> statement.</span></p></li>
<li><p><span class="koboSpan" id="kobo.400.1" xmlns="http://www.w3.org/1999/xhtml">A status code of 429 means too many requests were made. </span><span class="koboSpan" id="kobo.400.2" xmlns="http://www.w3.org/1999/xhtml">Get the value of the </span><code><span class="koboSpan" id="kobo.401.1" xmlns="http://www.w3.org/1999/xhtml">Retry-After</span></code><span class="koboSpan" id="kobo.402.1" xmlns="http://www.w3.org/1999/xhtml"> and sleep for this period of time.</span></p></li>
<li><p><span class="koboSpan" id="kobo.403.1" xmlns="http://www.w3.org/1999/xhtml">Any other status code indicates a problem and should be logged or raised as an exception.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.404.1" xmlns="http://www.w3.org/1999/xhtml">One possible algorithm for return rows and handling rate limiting delays is shown in </span><a href="#4.3"><em><span class="koboSpan" id="kobo.405.1" xmlns="http://www.w3.org/1999/xhtml">Figure 4.3</span></em></a><span class="koboSpan" id="kobo.406.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<figure class="IMG---Figure">
<span class="koboSpan" id="kobo.407.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 4.3: Kaggle rate-limited paging " src="../media/file16.jpg"/></span>
<figcaption class="IMG---Caption"><span class="id" id="4.3"><span class="koboSpan" id="kobo.408.1" xmlns="http://www.w3.org/1999/xhtml">Figure 4.3: </span></span><span class="content"><span class="koboSpan" id="kobo.409.1" xmlns="http://www.w3.org/1999/xhtml">Kaggle rate-limited paging </span></span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.410.1" xmlns="http://www.w3.org/1999/xhtml">Handling rate limiting will make the application much easier to use. </span><span class="koboSpan" id="kobo.410.2" xmlns="http://www.w3.org/1999/xhtml">It will also produce more complete results. </span><span class="koboSpan" id="kobo.410.3" xmlns="http://www.w3.org/1999/xhtml">Using an </span><span id="dx1-87006"/><span class="koboSpan" id="kobo.411.1" xmlns="http://www.w3.org/1999/xhtml">effective search filter to </span><span id="dx1-87007"/><span class="koboSpan" id="kobo.412.1" xmlns="http://www.w3.org/1999/xhtml">reduce the number of rows to a sensible level will save a lot of waiting for the retry-after delays.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="8.1.2.5" id="the-main-function">
<h4 class="likesubsubsectionHead" data-number="8.1.2.5"><span id="x1-880002"/><span class="koboSpan" id="kobo.413.1" xmlns="http://www.w3.org/1999/xhtml">The main() function</span></h4>
<p><span class="koboSpan" id="kobo.414.1" xmlns="http://www.w3.org/1999/xhtml">The current application design has these </span><span id="dx1-88001"/><span class="koboSpan" id="kobo.415.1" xmlns="http://www.w3.org/1999/xhtml">distinct features:</span></p>
<ol>
<li><div id="x1-88003x1">
<p><span class="koboSpan" id="kobo.416.1" xmlns="http://www.w3.org/1999/xhtml">Extract data from a local CSV file.</span></p>
</div></li>
<li><div id="x1-88005x2">
<p><span class="koboSpan" id="kobo.417.1" xmlns="http://www.w3.org/1999/xhtml">Download a ZIP archive and extract data from a CSV member of the archive.</span></p>
</div></li>
<li><div id="x1-88007x3">
<p><span class="koboSpan" id="kobo.418.1" xmlns="http://www.w3.org/1999/xhtml">(Optionally) Survey the data set list to find other interesting data sets to process.</span></p>
</div></li>
</ol>
<p><span class="koboSpan" id="kobo.419.1" xmlns="http://www.w3.org/1999/xhtml">This suggests that our </span><code><span class="koboSpan" id="kobo.420.1" xmlns="http://www.w3.org/1999/xhtml">main()</span></code><span class="koboSpan" id="kobo.421.1" xmlns="http://www.w3.org/1999/xhtml"> function should be a container for three distinct functions that implement each separate feature. </span><span class="koboSpan" id="kobo.421.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.422.1" xmlns="http://www.w3.org/1999/xhtml">main()</span></code><span class="koboSpan" id="kobo.423.1" xmlns="http://www.w3.org/1999/xhtml"> function can parse the command-line arguments, and then </span><span id="dx1-88008"/><span class="koboSpan" id="kobo.424.1" xmlns="http://www.w3.org/1999/xhtml">make a number of decisions:</span></p>
<ul>
<li><p><strong><span class="koboSpan" id="kobo.425.1" xmlns="http://www.w3.org/1999/xhtml">Local Extract</span></strong><span class="koboSpan" id="kobo.426.1" xmlns="http://www.w3.org/1999/xhtml">: If the </span><code><span class="koboSpan" id="kobo.427.1" xmlns="http://www.w3.org/1999/xhtml">-o</span></code><span class="koboSpan" id="kobo.428.1" xmlns="http://www.w3.org/1999/xhtml"> option is present (without the </span><code><span class="koboSpan" id="kobo.429.1" xmlns="http://www.w3.org/1999/xhtml">-k</span></code><span class="koboSpan" id="kobo.430.1" xmlns="http://www.w3.org/1999/xhtml"> option), then this is a local file extract. </span><span class="koboSpan" id="kobo.430.2" xmlns="http://www.w3.org/1999/xhtml">This was the solution from an earlier chapter.</span></p></li>
<li><p><strong><span class="koboSpan" id="kobo.431.1" xmlns="http://www.w3.org/1999/xhtml">Download and Extract</span></strong><span class="koboSpan" id="kobo.432.1" xmlns="http://www.w3.org/1999/xhtml">: If the </span><code><span class="koboSpan" id="kobo.433.1" xmlns="http://www.w3.org/1999/xhtml">-k</span></code><span class="koboSpan" id="kobo.434.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.435.1" xmlns="http://www.w3.org/1999/xhtml">-o</span></code><span class="koboSpan" id="kobo.436.1" xmlns="http://www.w3.org/1999/xhtml"> options are present, then this will be a download and extract. </span><span class="koboSpan" id="kobo.436.2" xmlns="http://www.w3.org/1999/xhtml">It will use the </span><code><span class="koboSpan" id="kobo.437.1" xmlns="http://www.w3.org/1999/xhtml">RestAccess</span></code><span class="koboSpan" id="kobo.438.1" xmlns="http://www.w3.org/1999/xhtml"> object to get the ZIP archive. </span><span class="koboSpan" id="kobo.438.2" xmlns="http://www.w3.org/1999/xhtml">Once the archive is opened, the member processing is the solution from an earlier chapter.</span></p></li>
<li><p><strong><span class="koboSpan" id="kobo.439.1" xmlns="http://www.w3.org/1999/xhtml">Survey</span></strong><span class="koboSpan" id="kobo.440.1" xmlns="http://www.w3.org/1999/xhtml">: If the </span><code><span class="koboSpan" id="kobo.441.1" xmlns="http://www.w3.org/1999/xhtml">-k</span></code><span class="koboSpan" id="kobo.442.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.443.1" xmlns="http://www.w3.org/1999/xhtml">-s</span></code><span class="koboSpan" id="kobo.444.1" xmlns="http://www.w3.org/1999/xhtml"> (or </span><code><span class="koboSpan" id="kobo.445.1" xmlns="http://www.w3.org/1999/xhtml">--search</span></code><span class="koboSpan" id="kobo.446.1" xmlns="http://www.w3.org/1999/xhtml">) options are present, then this is a search for interesting data sets. </span><span class="koboSpan" id="kobo.446.2" xmlns="http://www.w3.org/1999/xhtml">You are encouraged to work out the argument design to provide the needed query parameters to the application.</span></p></li>
<li><p><strong><span class="koboSpan" id="kobo.447.1" xmlns="http://www.w3.org/1999/xhtml">Otherwise</span></strong><span class="koboSpan" id="kobo.448.1" xmlns="http://www.w3.org/1999/xhtml">: If none of the above patterns match the options, this is incoherent, and an exception should be raised.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.449.1" xmlns="http://www.w3.org/1999/xhtml">Each of these features requires a distinct function. </span><span class="koboSpan" id="kobo.449.2" xmlns="http://www.w3.org/1999/xhtml">A common alternative design is to use the </span><strong><span class="koboSpan" id="kobo.450.1" xmlns="http://www.w3.org/1999/xhtml">Command </span></strong><span class="koboSpan" id="kobo.451.1" xmlns="http://www.w3.org/1999/xhtml">pattern and create a class hierarchy with each of the features as a distinct subclass of some parent class.</span></p>
<p><span class="koboSpan" id="kobo.452.1" xmlns="http://www.w3.org/1999/xhtml">One central idea is to keep the </span><code><span class="koboSpan" id="kobo.453.1" xmlns="http://www.w3.org/1999/xhtml">main()</span></code><span class="koboSpan" id="kobo.454.1" xmlns="http://www.w3.org/1999/xhtml"> function small, and dispatch the detailed work to other functions or objects.</span></p>
<p><span class="koboSpan" id="kobo.455.1" xmlns="http://www.w3.org/1999/xhtml">The other central idea is </span><strong><span class="koboSpan" id="kobo.456.1" xmlns="http://www.w3.org/1999/xhtml">Don’t Repeat Yourself </span></strong><span class="koboSpan" id="kobo.457.1" xmlns="http://www.w3.org/1999/xhtml">(</span><strong><span class="koboSpan" id="kobo.458.1" xmlns="http://www.w3.org/1999/xhtml">DRY</span></strong><span class="koboSpan" id="kobo.459.1" xmlns="http://www.w3.org/1999/xhtml">). </span><span class="koboSpan" id="kobo.459.2" xmlns="http://www.w3.org/1999/xhtml">This principle makes it imperative to </span><strong><span class="koboSpan" id="kobo.460.1" xmlns="http://www.w3.org/1999/xhtml">never </span></strong><span class="koboSpan" id="kobo.461.1" xmlns="http://www.w3.org/1999/xhtml">copy and paste code between the ”Download-and-Extract” feature and the ”Local-Extract” feature. </span><span class="koboSpan" id="kobo.461.2" xmlns="http://www.w3.org/1999/xhtml">The ”Download-and-Extract” processing must reuse the ”Local-Extract” processing either through subclass inheritance or calling one function from another.</span></p>
<p><span class="koboSpan" id="kobo.462.1" xmlns="http://www.w3.org/1999/xhtml">Now that we have a technical approach, it’s time to look at the deliverables for this project. </span><span id="x1-88009r88"/></p>
</section>
</section>
<section class="level3" data-number="8.1.3" id="deliverables-2">
<h3 data-number="8.1.3"><span class="titlemark"><span class="koboSpan" id="kobo.463.1" xmlns="http://www.w3.org/1999/xhtml">4.1.3 </span></span> <span id="x1-890003"/><span class="koboSpan" id="kobo.464.1" xmlns="http://www.w3.org/1999/xhtml">Deliverables</span></h3>
<p><span class="koboSpan" id="kobo.465.1" xmlns="http://www.w3.org/1999/xhtml">This project </span><span id="dx1-89001"/><span class="koboSpan" id="kobo.466.1" xmlns="http://www.w3.org/1999/xhtml">has the following deliverables:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.467.1" xmlns="http://www.w3.org/1999/xhtml">Documentation in the </span><code><span class="koboSpan" id="kobo.468.1" xmlns="http://www.w3.org/1999/xhtml">docs</span></code><span class="koboSpan" id="kobo.469.1" xmlns="http://www.w3.org/1999/xhtml"> folder.</span></p></li>
<li><p><span class="koboSpan" id="kobo.470.1" xmlns="http://www.w3.org/1999/xhtml">Acceptance tests in the </span><code><span class="koboSpan" id="kobo.471.1" xmlns="http://www.w3.org/1999/xhtml">tests/features</span></code><span class="koboSpan" id="kobo.472.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.473.1" xmlns="http://www.w3.org/1999/xhtml">tests/steps</span></code><span class="koboSpan" id="kobo.474.1" xmlns="http://www.w3.org/1999/xhtml"> folders.</span></p></li>
<li><p><span class="koboSpan" id="kobo.475.1" xmlns="http://www.w3.org/1999/xhtml">A miniature RESTful web service that provides test responses will be part of the acceptance test.</span></p></li>
<li><p><span class="koboSpan" id="kobo.476.1" xmlns="http://www.w3.org/1999/xhtml">Unit tests for the application modules in the </span><code><span class="koboSpan" id="kobo.477.1" xmlns="http://www.w3.org/1999/xhtml">tests</span></code><span class="koboSpan" id="kobo.478.1" xmlns="http://www.w3.org/1999/xhtml"> folder.</span></p></li>
<li><p><span class="koboSpan" id="kobo.479.1" xmlns="http://www.w3.org/1999/xhtml">Mock objects for the </span><code><span class="koboSpan" id="kobo.480.1" xmlns="http://www.w3.org/1999/xhtml">requests</span></code><span class="koboSpan" id="kobo.481.1" xmlns="http://www.w3.org/1999/xhtml"> module will be part of the unit tests.</span></p></li>
<li><p><span class="koboSpan" id="kobo.482.1" xmlns="http://www.w3.org/1999/xhtml">Application to download and acquire data from a RESTful web service.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.483.1" xmlns="http://www.w3.org/1999/xhtml">Be sure to include additional </span><span id="dx1-89002"/><span class="koboSpan" id="kobo.484.1" xmlns="http://www.w3.org/1999/xhtml">packages like </span><code><span class="koboSpan" id="kobo.485.1" xmlns="http://www.w3.org/1999/xhtml">requests</span></code><span class="koboSpan" id="kobo.486.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.487.1" xmlns="http://www.w3.org/1999/xhtml">beautifulsoup4</span></code><span class="koboSpan" id="kobo.488.1" xmlns="http://www.w3.org/1999/xhtml"> in the </span><code><span class="koboSpan" id="kobo.489.1" xmlns="http://www.w3.org/1999/xhtml">pyproject.toml</span></code><span class="koboSpan" id="kobo.490.1" xmlns="http://www.w3.org/1999/xhtml"> file. </span><span class="koboSpan" id="kobo.490.2" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.491.1" xmlns="http://www.w3.org/1999/xhtml">pip-compile </span></strong><span class="koboSpan" id="kobo.492.1" xmlns="http://www.w3.org/1999/xhtml">command can be </span><span id="dx1-89003"/><span class="koboSpan" id="kobo.493.1" xmlns="http://www.w3.org/1999/xhtml">used to create a </span><code><span class="koboSpan" id="kobo.494.1" xmlns="http://www.w3.org/1999/xhtml">requirements.txt</span></code><span class="koboSpan" id="kobo.495.1" xmlns="http://www.w3.org/1999/xhtml"> usable by the </span><strong><span class="koboSpan" id="kobo.496.1" xmlns="http://www.w3.org/1999/xhtml">tox </span></strong><span class="koboSpan" id="kobo.497.1" xmlns="http://www.w3.org/1999/xhtml">tool for testing.</span></p>
<p><span class="koboSpan" id="kobo.498.1" xmlns="http://www.w3.org/1999/xhtml">We’ll look at a few of these deliverables in a little more detail.</span></p>
<section class="level4 likesubsubsectionHead" data-number="8.1.3.1" id="unit-tests-for-the-restaccess-class">
<h4 class="likesubsubsectionHead" data-number="8.1.3.1"><span id="x1-900003"/><span class="koboSpan" id="kobo.499.1" xmlns="http://www.w3.org/1999/xhtml">Unit tests for the RestAccess class</span></h4>
<p><span class="koboSpan" id="kobo.500.1" xmlns="http://www.w3.org/1999/xhtml">For unit testing, we don’t </span><span id="dx1-90001"/><span class="koboSpan" id="kobo.501.1" xmlns="http://www.w3.org/1999/xhtml">want to involve the </span><code><span class="koboSpan" id="kobo.502.1" xmlns="http://www.w3.org/1999/xhtml">requests</span></code><span class="koboSpan" id="kobo.503.1" xmlns="http://www.w3.org/1999/xhtml"> module. </span><span class="koboSpan" id="kobo.503.2" xmlns="http://www.w3.org/1999/xhtml">Instead, we need to make a mock </span><span id="dx1-90002"/><span class="koboSpan" id="kobo.504.1" xmlns="http://www.w3.org/1999/xhtml">interface for the </span><code><span class="koboSpan" id="kobo.505.1" xmlns="http://www.w3.org/1999/xhtml">requests</span></code><span class="koboSpan" id="kobo.506.1" xmlns="http://www.w3.org/1999/xhtml"> module to </span><span id="dx1-90003"/><span class="koboSpan" id="kobo.507.1" xmlns="http://www.w3.org/1999/xhtml">confirm the application </span><code><span class="koboSpan" id="kobo.508.1" xmlns="http://www.w3.org/1999/xhtml">RestAccess</span></code><span class="koboSpan" id="kobo.509.1" xmlns="http://www.w3.org/1999/xhtml"> module uses the </span><code><span class="koboSpan" id="kobo.510.1" xmlns="http://www.w3.org/1999/xhtml">requests</span></code><span class="koboSpan" id="kobo.511.1" xmlns="http://www.w3.org/1999/xhtml"> classes properly.</span></p>
<p><span class="koboSpan" id="kobo.512.1" xmlns="http://www.w3.org/1999/xhtml">There are two strategies for plugging in mock objects:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.513.1" xmlns="http://www.w3.org/1999/xhtml">Implement a dependency injection technique, where the target class is named at run time.</span></p></li>
<li><p><span class="koboSpan" id="kobo.514.1" xmlns="http://www.w3.org/1999/xhtml">Use </span><em><span class="koboSpan" id="kobo.515.1" xmlns="http://www.w3.org/1999/xhtml">Monkey Patching </span></em><span class="koboSpan" id="kobo.516.1" xmlns="http://www.w3.org/1999/xhtml">to inject a mock class at test time.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.517.1" xmlns="http://www.w3.org/1999/xhtml">When working with external modules — modules where we don’t control the design — monkey patching is often easier than trying to work out a dependency injection technique. </span><span class="koboSpan" id="kobo.517.2" xmlns="http://www.w3.org/1999/xhtml">When we’re building the classes in a module, we often have a need to extend the definitions via subclasses. </span><span class="koboSpan" id="kobo.517.3" xmlns="http://www.w3.org/1999/xhtml">One of the reasons for creating unique, customized software is to implement change in the unique features of an application rapidly. </span><span class="koboSpan" id="kobo.517.4" xmlns="http://www.w3.org/1999/xhtml">The non-unique features (RESTful API requests, in this case) change very slowly and don’t benefit from flexibility.</span></p>
<p><span class="koboSpan" id="kobo.518.1" xmlns="http://www.w3.org/1999/xhtml">We want to create two mock classes, one to replace the </span><code><span class="koboSpan" id="kobo.519.1" xmlns="http://www.w3.org/1999/xhtml">requests.auth.HTTPBasicAuth</span></code><span class="koboSpan" id="kobo.520.1" xmlns="http://www.w3.org/1999/xhtml"> class, and one to replace the </span><code><span class="koboSpan" id="kobo.521.1" xmlns="http://www.w3.org/1999/xhtml">requests.get()</span></code><span class="koboSpan" id="kobo.522.1" xmlns="http://www.w3.org/1999/xhtml"> function. </span><span class="koboSpan" id="kobo.522.2" xmlns="http://www.w3.org/1999/xhtml">The mock for the </span><code><span class="koboSpan" id="kobo.523.1" xmlns="http://www.w3.org/1999/xhtml">HTTPBasicAuth</span></code><span class="koboSpan" id="kobo.524.1" xmlns="http://www.w3.org/1999/xhtml"> class doesn’t do anything; we want to examine the mock object to be sure it was called once with the proper parameters. </span><span class="koboSpan" id="kobo.524.2" xmlns="http://www.w3.org/1999/xhtml">The mock for the </span><code><span class="koboSpan" id="kobo.525.1" xmlns="http://www.w3.org/1999/xhtml">requests.get()</span></code><span class="koboSpan" id="kobo.526.1" xmlns="http://www.w3.org/1999/xhtml"> function needs to create mock </span><code><span class="koboSpan" id="kobo.527.1" xmlns="http://www.w3.org/1999/xhtml">Response</span></code><span class="koboSpan" id="kobo.528.1" xmlns="http://www.w3.org/1999/xhtml"> objects for various test scenarios.</span></p>
<p><span class="koboSpan" id="kobo.529.1" xmlns="http://www.w3.org/1999/xhtml">We’ll need to use the </span><code><span class="koboSpan" id="kobo.530.1" xmlns="http://www.w3.org/1999/xhtml">monkeypatch</span></code><span class="koboSpan" id="kobo.531.1" xmlns="http://www.w3.org/1999/xhtml"> fixture of the </span><code><span class="koboSpan" id="kobo.532.1" xmlns="http://www.w3.org/1999/xhtml">pytest</span></code><span class="koboSpan" id="kobo.533.1" xmlns="http://www.w3.org/1999/xhtml"> module to </span><span id="dx1-90004"/><span class="koboSpan" id="kobo.534.1" xmlns="http://www.w3.org/1999/xhtml">replace the real objects with the mock objects for unit testing.</span></p>
<p><span class="koboSpan" id="kobo.535.1" xmlns="http://www.w3.org/1999/xhtml">The idea is to create </span><span id="dx1-90005"/><span class="koboSpan" id="kobo.536.1" xmlns="http://www.w3.org/1999/xhtml">unit tests that have a structure </span><span id="dx1-90006"/><span class="koboSpan" id="kobo.537.1" xmlns="http://www.w3.org/1999/xhtml">similar to the following example:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-47">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.538.1" xmlns="http://www.w3.org/1999/xhtml">from unittest.mock import Mock, sentinel, call

def test_rest_access(monkeypatch):
    mock_auth_class = Mock(
        name="Mocked HTTPBasicAuth class",
        return_value=sentinel.AUTH
    )
    monkeypatch.setattr(’requests.auth.HTTPBasicAuth’, mock_auth_class)
    mock_kaggle_json = {"username": sentinel.USERNAME, "key": sentinel.KEY}
    access = RestAccess(mock_kaggle_json)
    assert access.credentials == sentinel.AUTH
    assert mock_auth_class.mock_calls == [
        call(sentinel.USERNAME, sentinel.KEY)
    ]</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.539.1" xmlns="http://www.w3.org/1999/xhtml">This test case creates a mock for the </span><code><span class="koboSpan" id="kobo.540.1" xmlns="http://www.w3.org/1999/xhtml">HTTPBasicAuth</span></code><span class="koboSpan" id="kobo.541.1" xmlns="http://www.w3.org/1999/xhtml"> class. </span><span class="koboSpan" id="kobo.541.2" xmlns="http://www.w3.org/1999/xhtml">When the class is called to create an instance, it returns a </span><code><span class="koboSpan" id="kobo.542.1" xmlns="http://www.w3.org/1999/xhtml">sentinel</span></code><span class="koboSpan" id="kobo.543.1" xmlns="http://www.w3.org/1999/xhtml"> object that can be verified by a test case.</span></p>
<p><span class="koboSpan" id="kobo.544.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.545.1" xmlns="http://www.w3.org/1999/xhtml">monkeypatch</span></code><span class="koboSpan" id="kobo.546.1" xmlns="http://www.w3.org/1999/xhtml"> fixture replaces the </span><code><span class="koboSpan" id="kobo.547.1" xmlns="http://www.w3.org/1999/xhtml">requests.auth.HTTPBasicAuth</span></code><span class="koboSpan" id="kobo.548.1" xmlns="http://www.w3.org/1999/xhtml"> class with the mock object. </span><span class="koboSpan" id="kobo.548.2" xmlns="http://www.w3.org/1999/xhtml">After this patch is applied, when the </span><code><span class="koboSpan" id="kobo.549.1" xmlns="http://www.w3.org/1999/xhtml">RestAccess</span></code><span class="koboSpan" id="kobo.550.1" xmlns="http://www.w3.org/1999/xhtml"> class initialization attempts to create an instance of the </span><code><span class="koboSpan" id="kobo.551.1" xmlns="http://www.w3.org/1999/xhtml">HTTPBasicAuth</span></code><span class="koboSpan" id="kobo.552.1" xmlns="http://www.w3.org/1999/xhtml"> class, it will invoke the mock, and will get a </span><code><span class="koboSpan" id="kobo.553.1" xmlns="http://www.w3.org/1999/xhtml">sentinel</span></code><span class="koboSpan" id="kobo.554.1" xmlns="http://www.w3.org/1999/xhtml"> object instead.</span></p>
<p><span class="koboSpan" id="kobo.555.1" xmlns="http://www.w3.org/1999/xhtml">The case confirms the </span><code><span class="koboSpan" id="kobo.556.1" xmlns="http://www.w3.org/1999/xhtml">sentinel</span></code><span class="koboSpan" id="kobo.557.1" xmlns="http://www.w3.org/1999/xhtml"> object is used by the </span><code><span class="koboSpan" id="kobo.558.1" xmlns="http://www.w3.org/1999/xhtml">RestAccess</span></code><span class="koboSpan" id="kobo.559.1" xmlns="http://www.w3.org/1999/xhtml"> instance. </span><span class="koboSpan" id="kobo.559.2" xmlns="http://www.w3.org/1999/xhtml">The test case also confirms the mock class was called exactly once with the expected values taken from the mocked value loaded from the </span><code><span class="koboSpan" id="kobo.560.1" xmlns="http://www.w3.org/1999/xhtml">kaggle.json</span></code><span class="koboSpan" id="kobo.561.1" xmlns="http://www.w3.org/1999/xhtml"> file.</span></p>
<p><span class="koboSpan" id="kobo.562.1" xmlns="http://www.w3.org/1999/xhtml">This test case relies on looking inside the </span><code><span class="koboSpan" id="kobo.563.1" xmlns="http://www.w3.org/1999/xhtml">RestAccess</span></code><span class="koboSpan" id="kobo.564.1" xmlns="http://www.w3.org/1999/xhtml"> instance. </span><span class="koboSpan" id="kobo.564.2" xmlns="http://www.w3.org/1999/xhtml">This isn’t the best strategy for writing unit tests. </span><span class="koboSpan" id="kobo.564.3" xmlns="http://www.w3.org/1999/xhtml">A better approach is to </span><span id="dx1-90021"/><span class="koboSpan" id="kobo.565.1" xmlns="http://www.w3.org/1999/xhtml">provide a mock object for </span><code><span class="koboSpan" id="kobo.566.1" xmlns="http://www.w3.org/1999/xhtml">requests.get()</span></code><span class="koboSpan" id="kobo.567.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.567.2" xmlns="http://www.w3.org/1999/xhtml">The test case should </span><span id="dx1-90022"/><span class="koboSpan" id="kobo.568.1" xmlns="http://www.w3.org/1999/xhtml">confirm the </span><code><span class="koboSpan" id="kobo.569.1" xmlns="http://www.w3.org/1999/xhtml">requests.get()</span></code><span class="koboSpan" id="kobo.570.1" xmlns="http://www.w3.org/1999/xhtml"> is called with a keyword parameter, </span><code><span class="koboSpan" id="kobo.571.1" xmlns="http://www.w3.org/1999/xhtml">auth</span></code><span class="koboSpan" id="kobo.572.1" xmlns="http://www.w3.org/1999/xhtml">, with an argument value of the </span><code><span class="koboSpan" id="kobo.573.1" xmlns="http://www.w3.org/1999/xhtml">sentinel.AUTH</span></code><span class="koboSpan" id="kobo.574.1" xmlns="http://www.w3.org/1999/xhtml"> object. </span><span class="koboSpan" id="kobo.574.2" xmlns="http://www.w3.org/1999/xhtml">The idea of this test strategy is to examine the </span><span id="dx1-90023"/><span class="koboSpan" id="kobo.575.1" xmlns="http://www.w3.org/1999/xhtml">external interfaces of the </span><code><span class="koboSpan" id="kobo.576.1" xmlns="http://www.w3.org/1999/xhtml">RestAccess</span></code><span class="koboSpan" id="kobo.577.1" xmlns="http://www.w3.org/1999/xhtml"> class instead of looking at internal state changes.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="8.1.3.2" id="acceptance-tests-1">
<h4 class="likesubsubsectionHead" data-number="8.1.3.2"><span id="x1-910003"/><span class="koboSpan" id="kobo.578.1" xmlns="http://www.w3.org/1999/xhtml">Acceptance tests</span></h4>
<p><span class="koboSpan" id="kobo.579.1" xmlns="http://www.w3.org/1999/xhtml">The acceptance tests need to rely on a </span><em><span class="koboSpan" id="kobo.580.1" xmlns="http://www.w3.org/1999/xhtml">fixture </span></em><span class="koboSpan" id="kobo.581.1" xmlns="http://www.w3.org/1999/xhtml">that mocks the Kaggle web service. </span><span class="koboSpan" id="kobo.581.2" xmlns="http://www.w3.org/1999/xhtml">The mock will be a process on </span><span id="dx1-91001"/><span class="koboSpan" id="kobo.582.1" xmlns="http://www.w3.org/1999/xhtml">your local computer, making it </span><span id="dx1-91002"/><span class="koboSpan" id="kobo.583.1" xmlns="http://www.w3.org/1999/xhtml">easy to stop and start the mock service to test the application. </span><span class="koboSpan" id="kobo.583.2" xmlns="http://www.w3.org/1999/xhtml">Using an address of </span><code><span class="koboSpan" id="kobo.584.1" xmlns="http://www.w3.org/1999/xhtml">127.0.0.1:8080</span></code><span class="koboSpan" id="kobo.585.1" xmlns="http://www.w3.org/1999/xhtml"> instead of </span><code><span class="koboSpan" id="kobo.586.1" xmlns="http://www.w3.org/1999/xhtml">www.kaggle.com</span></code><span class="koboSpan" id="kobo.587.1" xmlns="http://www.w3.org/1999/xhtml"> will direct RESTful API requests back to your own computer. </span><span class="koboSpan" id="kobo.587.2" xmlns="http://www.w3.org/1999/xhtml">The name </span><code><span class="koboSpan" id="kobo.588.1" xmlns="http://www.w3.org/1999/xhtml">localhost:8080</span></code><span class="koboSpan" id="kobo.589.1" xmlns="http://www.w3.org/1999/xhtml"> can be used instead of the numeric address </span><code><span class="koboSpan" id="kobo.590.1" xmlns="http://www.w3.org/1999/xhtml">127.0.0.1:8080</span></code><span class="koboSpan" id="kobo.591.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.591.2" xmlns="http://www.w3.org/1999/xhtml">(This address is called the </span><em><span class="koboSpan" id="kobo.592.1" xmlns="http://www.w3.org/1999/xhtml">Loopback Address </span></em><span class="koboSpan" id="kobo.593.1" xmlns="http://www.w3.org/1999/xhtml">because the requests loop back to the same host that created them, allowing testing to proceed without any external network traffic.)</span></p>
<p><span class="koboSpan" id="kobo.594.1" xmlns="http://www.w3.org/1999/xhtml">Note that the URL scheme will change to </span><code><span class="koboSpan" id="kobo.595.1" xmlns="http://www.w3.org/1999/xhtml">http:</span></code><span class="koboSpan" id="kobo.596.1" xmlns="http://www.w3.org/1999/xhtml"> from </span><code><span class="koboSpan" id="kobo.597.1" xmlns="http://www.w3.org/1999/xhtml">https:</span></code><span class="koboSpan" id="kobo.598.1" xmlns="http://www.w3.org/1999/xhtml">, also. </span><span class="koboSpan" id="kobo.598.2" xmlns="http://www.w3.org/1999/xhtml">We don’t want to implement the full Socket Security Layer (SSL) for acceptance testing. </span><span class="koboSpan" id="kobo.598.3" xmlns="http://www.w3.org/1999/xhtml">For our purposes, we can trust those components work.</span></p>
<p><span class="koboSpan" id="kobo.599.1" xmlns="http://www.w3.org/1999/xhtml">This change to the URLs suggests the application should be designed in such a way to have the </span><code><span class="koboSpan" id="kobo.600.1" xmlns="http://www.w3.org/1999/xhtml">https://www.kaggle.com</span></code><span class="koboSpan" id="kobo.601.1" xmlns="http://www.w3.org/1999/xhtml"> portion of each URL provided by a configuration parameter. </span><span class="koboSpan" id="kobo.601.2" xmlns="http://www.w3.org/1999/xhtml">Then acceptance tests can use </span><code><span class="koboSpan" id="kobo.602.1" xmlns="http://www.w3.org/1999/xhtml">http://127.0.0.1:8080</span></code><span class="koboSpan" id="kobo.603.1" xmlns="http://www.w3.org/1999/xhtml"> without having to make any changes to the code.</span></p>
<p><span class="koboSpan" id="kobo.604.1" xmlns="http://www.w3.org/1999/xhtml">The mock service must offer a few features of the Kaggle service. </span><span class="koboSpan" id="kobo.604.2" xmlns="http://www.w3.org/1999/xhtml">The local service needs to respond to </span><code><span class="koboSpan" id="kobo.605.1" xmlns="http://www.w3.org/1999/xhtml">dataset/download</span></code><span class="koboSpan" id="kobo.606.1" xmlns="http://www.w3.org/1999/xhtml"> requests properly, providing a reply with the expected status code and the content with bytes that are a proper ZIP archive.</span></p>
<p><span class="koboSpan" id="kobo.607.1" xmlns="http://www.w3.org/1999/xhtml">This mock service will run as a separate application. </span><span class="koboSpan" id="kobo.607.2" xmlns="http://www.w3.org/1999/xhtml">It will be started (and stopped) by </span><strong><span class="koboSpan" id="kobo.608.1" xmlns="http://www.w3.org/1999/xhtml">behave </span></strong><span class="koboSpan" id="kobo.609.1" xmlns="http://www.w3.org/1999/xhtml">for a scenario that needs the fixture.</span></p>
<p><span class="koboSpan" id="kobo.610.1" xmlns="http://www.w3.org/1999/xhtml">We’ll start by looking at the way this </span><span id="dx1-91003"/><span class="koboSpan" id="kobo.611.1" xmlns="http://www.w3.org/1999/xhtml">service is described in a feature file. </span><span class="koboSpan" id="kobo.611.2" xmlns="http://www.w3.org/1999/xhtml">This will lead us to look at how to </span><span id="dx1-91004"/><span class="koboSpan" id="kobo.612.1" xmlns="http://www.w3.org/1999/xhtml">build the mock service. </span><span class="koboSpan" id="kobo.612.2" xmlns="http://www.w3.org/1999/xhtml">After that, we can look at how this is implemented using </span><strong><span class="koboSpan" id="kobo.613.1" xmlns="http://www.w3.org/1999/xhtml">behave </span></strong><span class="koboSpan" id="kobo.614.1" xmlns="http://www.w3.org/1999/xhtml">step definitions.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="8.1.3.3" id="the-feature-file">
<h4 class="likesubsubsectionHead" data-number="8.1.3.3"><span id="x1-920003"/><span class="koboSpan" id="kobo.615.1" xmlns="http://www.w3.org/1999/xhtml">The feature file</span></h4>
<p><span class="koboSpan" id="kobo.616.1" xmlns="http://www.w3.org/1999/xhtml">The downloading feature is clearly separate from the </span><span id="dx1-92001"/><span class="koboSpan" id="kobo.617.1" xmlns="http://www.w3.org/1999/xhtml">data acquisition feature. </span><span class="koboSpan" id="kobo.617.2" xmlns="http://www.w3.org/1999/xhtml">This suggests a new </span><code><span class="koboSpan" id="kobo.618.1" xmlns="http://www.w3.org/1999/xhtml">.feature</span></code><span class="koboSpan" id="kobo.619.1" xmlns="http://www.w3.org/1999/xhtml"> file to provide </span><span id="dx1-92002"/><span class="koboSpan" id="kobo.620.1" xmlns="http://www.w3.org/1999/xhtml">scenarios to describe this feature.</span></p>
<p><span class="koboSpan" id="kobo.621.1" xmlns="http://www.w3.org/1999/xhtml">Within this new feature file, we can have scenarios that specifically name the required fixture. </span><span class="koboSpan" id="kobo.621.2" xmlns="http://www.w3.org/1999/xhtml">A scenario might look like the following example:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-48">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.622.1" xmlns="http://www.w3.org/1999/xhtml">@fixture.kaggle_server
Scenario: Request for carlmcbrideellis/data-anscombes-quartet
    extracts file from ZIP archive.
    </span><span class="koboSpan" id="kobo.622.2" xmlns="http://www.w3.org/1999/xhtml">A typical download command might be
    "python src/acquire.py -k kaggle.json -o quartet \
      --zip carlmcbrideellis/data-anscombes-quartet"

  Given proper keys are in "kaggle.json"
  When we run the kaggle download command
  Then log has INFO line with "header: [’mock’, ’data’]"
  And log has INFO line with "count: 1"</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.623.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.624.1" xmlns="http://www.w3.org/1999/xhtml">@fixture.</span></code><span class="koboSpan" id="kobo.625.1" xmlns="http://www.w3.org/1999/xhtml"> tag follows the common tagging convention for associating specific fixtures with scenarios. </span><span class="koboSpan" id="kobo.625.2" xmlns="http://www.w3.org/1999/xhtml">There are many other purposes for tagging scenarios in addition to specifying the fixture to use.</span></p>
<p><span class="koboSpan" id="kobo.626.1" xmlns="http://www.w3.org/1999/xhtml">In previous projects, a command to run the application was provided in the </span><code><span class="koboSpan" id="kobo.627.1" xmlns="http://www.w3.org/1999/xhtml">When</span></code><span class="koboSpan" id="kobo.628.1" xmlns="http://www.w3.org/1999/xhtml"> step. </span><span class="koboSpan" id="kobo.628.2" xmlns="http://www.w3.org/1999/xhtml">For this scenario (and many others), the command text became too long to be usefully presented in the Gherkin text. </span><span class="koboSpan" id="kobo.628.3" xmlns="http://www.w3.org/1999/xhtml">This means the actual command needs to be provided by the function that implements this step.</span></p>
<p><span class="koboSpan" id="kobo.629.1" xmlns="http://www.w3.org/1999/xhtml">This scenario’s </span><code><span class="koboSpan" id="kobo.630.1" xmlns="http://www.w3.org/1999/xhtml">Then</span></code><span class="koboSpan" id="kobo.631.1" xmlns="http://www.w3.org/1999/xhtml"> steps look at the log created by the application to confirm the contents of the file.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-49">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.632.1" xmlns="http://www.w3.org/1999/xhtml">A test scenario is part of the overall application’s requirements and design.</span></p>
<p><span class="koboSpan" id="kobo.633.1" xmlns="http://www.w3.org/1999/xhtml">In the description provided in </span><a href="#x1-800001"><em><span class="koboSpan" id="kobo.634.1" xmlns="http://www.w3.org/1999/xhtml">Description</span></em></a><span class="koboSpan" id="kobo.635.1" xmlns="http://www.w3.org/1999/xhtml"> there isn’t any mention of a log. </span><span class="koboSpan" id="kobo.635.2" xmlns="http://www.w3.org/1999/xhtml">This kind of gap is common. </span><span class="koboSpan" id="kobo.635.3" xmlns="http://www.w3.org/1999/xhtml">The test scenario provided additional definitions of the feature omitted from the plain test description.</span></p>
<p><span class="koboSpan" id="kobo.636.1" xmlns="http://www.w3.org/1999/xhtml">Some people like to update the documentation to be complete and fully consistent. </span><span class="koboSpan" id="kobo.636.2" xmlns="http://www.w3.org/1999/xhtml">We encourage flexibility when working on enterprise applications where there are numerous stakeholders. </span><span class="koboSpan" id="kobo.636.3" xmlns="http://www.w3.org/1999/xhtml">It can be difficult to get everyone’s input into the initial presentation or document. </span><span class="koboSpan" id="kobo.636.4" xmlns="http://www.w3.org/1999/xhtml">Sometimes, requirements appear later in the process when more concrete issues, like expected operating scenarios, are discussed in detail.</span></p>
</div>
</div>
<p><span class="koboSpan" id="kobo.637.1" xmlns="http://www.w3.org/1999/xhtml">The tag information will be used by the </span><strong><span class="koboSpan" id="kobo.638.1" xmlns="http://www.w3.org/1999/xhtml">behave </span></strong><span class="koboSpan" id="kobo.639.1" xmlns="http://www.w3.org/1999/xhtml">tool. </span><span class="koboSpan" id="kobo.639.2" xmlns="http://www.w3.org/1999/xhtml">We’ll look at how to write a </span><code><span class="koboSpan" id="kobo.640.1" xmlns="http://www.w3.org/1999/xhtml">before_tag()</span></code><span class="koboSpan" id="kobo.641.1" xmlns="http://www.w3.org/1999/xhtml"> function to start (and stop) the special mock server for any scenario that needs it.</span></p>
<p><span class="koboSpan" id="kobo.642.1" xmlns="http://www.w3.org/1999/xhtml">Before we look at the </span><strong><span class="koboSpan" id="kobo.643.1" xmlns="http://www.w3.org/1999/xhtml">behave </span></strong><span class="koboSpan" id="kobo.644.1" xmlns="http://www.w3.org/1999/xhtml">integration via a step definition, we’ll look at two approaches to testing the client application. </span><span class="koboSpan" id="kobo.644.2" xmlns="http://www.w3.org/1999/xhtml">The core </span><span id="dx1-92014"/><span class="koboSpan" id="kobo.645.1" xmlns="http://www.w3.org/1999/xhtml">concept is to create a mock-up of the few elements of the Kaggle API used by the </span><span id="dx1-92015"/><span class="koboSpan" id="kobo.646.1" xmlns="http://www.w3.org/1999/xhtml">data acquisition application. </span><span class="koboSpan" id="kobo.646.2" xmlns="http://www.w3.org/1999/xhtml">This mock-up must return responses used by test scenarios. </span><span class="koboSpan" id="kobo.646.3" xmlns="http://www.w3.org/1999/xhtml">There are two approaches:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.647.1" xmlns="http://www.w3.org/1999/xhtml">Create a web service application. </span><span class="koboSpan" id="kobo.647.2" xmlns="http://www.w3.org/1999/xhtml">For acceptance tests, this service must be started and stopped. </span><span class="koboSpan" id="kobo.647.3" xmlns="http://www.w3.org/1999/xhtml">The acquire application can be configured with a </span><code><span class="koboSpan" id="kobo.648.1" xmlns="http://www.w3.org/1999/xhtml">http://localhost:8080</span></code><span class="koboSpan" id="kobo.649.1" xmlns="http://www.w3.org/1999/xhtml"> URL to connect to the test server instead of the Kaggle server. </span><span class="koboSpan" id="kobo.649.2" xmlns="http://www.w3.org/1999/xhtml">(There are a few common variations on the “localhost” address including </span><code><span class="koboSpan" id="kobo.650.1" xmlns="http://www.w3.org/1999/xhtml">127.0.0.1</span></code><span class="koboSpan" id="kobo.651.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.652.1" xmlns="http://www.w3.org/1999/xhtml">0.0.0.0</span></code><span class="koboSpan" id="kobo.653.1" xmlns="http://www.w3.org/1999/xhtml">.)</span></p></li>
<li><p><span class="koboSpan" id="kobo.654.1" xmlns="http://www.w3.org/1999/xhtml">The other approach is to provide a way to replace the </span><code><span class="koboSpan" id="kobo.655.1" xmlns="http://www.w3.org/1999/xhtml">requests</span></code><span class="koboSpan" id="kobo.656.1" xmlns="http://www.w3.org/1999/xhtml"> module with a mocked version of the module. </span><span class="koboSpan" id="kobo.656.2" xmlns="http://www.w3.org/1999/xhtml">This mocked module returns responses appropriate to the test scenario. </span><span class="koboSpan" id="kobo.656.3" xmlns="http://www.w3.org/1999/xhtml">This can be done by manipulating the </span><code><span class="koboSpan" id="kobo.657.1" xmlns="http://www.w3.org/1999/xhtml">sys.path</span></code><span class="koboSpan" id="kobo.658.1" xmlns="http://www.w3.org/1999/xhtml"> variable to include the directory containing the mocked version of </span><code><span class="koboSpan" id="kobo.659.1" xmlns="http://www.w3.org/1999/xhtml">requests</span></code><span class="koboSpan" id="kobo.660.1" xmlns="http://www.w3.org/1999/xhtml"> in front of the </span><code><span class="koboSpan" id="kobo.661.1" xmlns="http://www.w3.org/1999/xhtml">site-packages</span></code><span class="koboSpan" id="kobo.662.1" xmlns="http://www.w3.org/1999/xhtml"> directory, which has the real version. </span><span class="koboSpan" id="kobo.662.2" xmlns="http://www.w3.org/1999/xhtml">It can also be done by providing some application configuration settings that can be </span><span id="dx1-92016"/><span class="koboSpan" id="kobo.663.1" xmlns="http://www.w3.org/1999/xhtml">replaced with the mocked package.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.664.1" xmlns="http://www.w3.org/1999/xhtml">One approach to creating a complete service that will implement the fixture.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="8.1.3.4" id="injecting-a-mock-for-the-requests-package">
<h4 class="likesubsubsectionHead" data-number="8.1.3.4"><span id="x1-930003"/><span class="koboSpan" id="kobo.665.1" xmlns="http://www.w3.org/1999/xhtml">Injecting a mock for the requests package</span></h4>
<p><span class="koboSpan" id="kobo.666.1" xmlns="http://www.w3.org/1999/xhtml">Replacing the </span><code><span class="koboSpan" id="kobo.667.1" xmlns="http://www.w3.org/1999/xhtml">requests</span></code><span class="koboSpan" id="kobo.668.1" xmlns="http://www.w3.org/1999/xhtml"> package requires </span><span id="dx1-93001"/><span class="koboSpan" id="kobo.669.1" xmlns="http://www.w3.org/1999/xhtml">using dependency injection techniques in the acquire application. </span><span class="koboSpan" id="kobo.669.2" xmlns="http://www.w3.org/1999/xhtml">A static </span><span id="dx1-93002"/><span class="koboSpan" id="kobo.670.1" xmlns="http://www.w3.org/1999/xhtml">dependency arises from code like the following:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-50">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.671.1" xmlns="http://www.w3.org/1999/xhtml">import requests
import requests.auth</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.672.1" xmlns="http://www.w3.org/1999/xhtml">Later in the module, there may be code like </span><code><span class="koboSpan" id="kobo.673.1" xmlns="http://www.w3.org/1999/xhtml">requests.get(...)</span></code><span class="koboSpan" id="kobo.674.1" xmlns="http://www.w3.org/1999/xhtml"> or </span><code><span class="koboSpan" id="kobo.675.1" xmlns="http://www.w3.org/1999/xhtml">requests.auth.HTTPBasicAuth(...)</span></code><span class="koboSpan" id="kobo.676.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.676.2" xmlns="http://www.w3.org/1999/xhtml">The binding to the </span><code><span class="koboSpan" id="kobo.677.1" xmlns="http://www.w3.org/1999/xhtml">requests</span></code><span class="koboSpan" id="kobo.678.1" xmlns="http://www.w3.org/1999/xhtml"> module is fixed by </span><span id="dx1-93005"/><span class="koboSpan" id="kobo.679.1" xmlns="http://www.w3.org/1999/xhtml">both the </span><code><span class="koboSpan" id="kobo.680.1" xmlns="http://www.w3.org/1999/xhtml">import</span></code><span class="koboSpan" id="kobo.681.1" xmlns="http://www.w3.org/1999/xhtml"> statement and the references to </span><code><span class="koboSpan" id="kobo.682.1" xmlns="http://www.w3.org/1999/xhtml">requests</span></code><span class="koboSpan" id="kobo.683.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.684.1" xmlns="http://www.w3.org/1999/xhtml">requests.auth</span></code><span class="koboSpan" id="kobo.685.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.686.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.687.1" xmlns="http://www.w3.org/1999/xhtml">importlib</span></code><span class="koboSpan" id="kobo.688.1" xmlns="http://www.w3.org/1999/xhtml"> module permits more dynamic binding of modules names, allowing some run-time flexibility. </span><span class="koboSpan" id="kobo.688.2" xmlns="http://www.w3.org/1999/xhtml">The following, for example, can be used to tailor imports.</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-51">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.689.1" xmlns="http://www.w3.org/1999/xhtml">if __name__ == "__main__":
    # Read from a configuration file
    requests_name = "requests"
    requests = importlib.import_module(requests_name)
    main(sys.argv[1:])</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.690.1" xmlns="http://www.w3.org/1999/xhtml">The global variable, </span><code><span class="koboSpan" id="kobo.691.1" xmlns="http://www.w3.org/1999/xhtml">requests</span></code><span class="koboSpan" id="kobo.692.1" xmlns="http://www.w3.org/1999/xhtml">, has the imported module assigned to it. </span><span class="koboSpan" id="kobo.692.2" xmlns="http://www.w3.org/1999/xhtml">This module variable </span><strong><span class="koboSpan" id="kobo.693.1" xmlns="http://www.w3.org/1999/xhtml">must </span></strong><span class="koboSpan" id="kobo.694.1" xmlns="http://www.w3.org/1999/xhtml">be global; it’s an easy requirement to overlook when trying to configure the application for acceptance testing.</span></p>
<p><span class="koboSpan" id="kobo.695.1" xmlns="http://www.w3.org/1999/xhtml">Note that the import of the </span><code><span class="koboSpan" id="kobo.696.1" xmlns="http://www.w3.org/1999/xhtml">requests</span></code><span class="koboSpan" id="kobo.697.1" xmlns="http://www.w3.org/1999/xhtml"> module (or the mock version) is separated from the remaining </span><code><span class="koboSpan" id="kobo.698.1" xmlns="http://www.w3.org/1999/xhtml">import</span></code><span class="koboSpan" id="kobo.699.1" xmlns="http://www.w3.org/1999/xhtml"> statements. </span><span class="koboSpan" id="kobo.699.2" xmlns="http://www.w3.org/1999/xhtml">This can be the source of some confusion for folks reading this code later, and suitable comments are important for clarifying the way this dependency injection works.</span></p>
<p><span class="koboSpan" id="kobo.700.1" xmlns="http://www.w3.org/1999/xhtml">When we looked at unit testing in </span><a href="#x1-900003"><em><span class="koboSpan" id="kobo.701.1" xmlns="http://www.w3.org/1999/xhtml">Unit tests for the RestAccess class</span></em></a><span class="koboSpan" id="kobo.702.1" xmlns="http://www.w3.org/1999/xhtml">, we used the </span><strong><span class="koboSpan" id="kobo.703.1" xmlns="http://www.w3.org/1999/xhtml">pytest </span></strong><span class="koboSpan" id="kobo.704.1" xmlns="http://www.w3.org/1999/xhtml">fixture named </span><code><span class="koboSpan" id="kobo.705.1" xmlns="http://www.w3.org/1999/xhtml">monkeypatch</span></code><span class="koboSpan" id="kobo.706.1" xmlns="http://www.w3.org/1999/xhtml"> to properly isolate modules for testing.</span></p>
<p><span class="koboSpan" id="kobo.707.1" xmlns="http://www.w3.org/1999/xhtml">Monkey patching isn’t a great technique for acceptance testing because the code being tested is not </span><strong><span class="koboSpan" id="kobo.708.1" xmlns="http://www.w3.org/1999/xhtml">exactly </span></strong><span class="koboSpan" id="kobo.709.1" xmlns="http://www.w3.org/1999/xhtml">the code that will be used. </span><span class="koboSpan" id="kobo.709.2" xmlns="http://www.w3.org/1999/xhtml">While monkey patching and dependency injection are popular, there are </span><span id="dx1-93011"/><span class="koboSpan" id="kobo.710.1" xmlns="http://www.w3.org/1999/xhtml">always questions about testing patched software instead of the actual software. </span><span class="koboSpan" id="kobo.710.2" xmlns="http://www.w3.org/1999/xhtml">In some industries — particularly those </span><span id="dx1-93012"/><span class="koboSpan" id="kobo.711.1" xmlns="http://www.w3.org/1999/xhtml">where human lives might be at risk from computer-controlled machinery — the presence of a patch for testing may not be allowed. </span><span class="koboSpan" id="kobo.711.2" xmlns="http://www.w3.org/1999/xhtml">In the next section, we’ll look at </span><span id="dx1-93013"/><span class="koboSpan" id="kobo.712.1" xmlns="http://www.w3.org/1999/xhtml">building a mock service to create and test the acquire application without any patching or changes.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="8.1.3.5" id="creating-a-mock-service">
<h4 class="likesubsubsectionHead" data-number="8.1.3.5"><span id="x1-940003"/><span class="koboSpan" id="kobo.713.1" xmlns="http://www.w3.org/1999/xhtml">Creating a mock service</span></h4>
<p><span class="koboSpan" id="kobo.714.1" xmlns="http://www.w3.org/1999/xhtml">A mock service can be built with </span><span id="dx1-94001"/><span class="koboSpan" id="kobo.715.1" xmlns="http://www.w3.org/1999/xhtml">any web services framework. </span><span class="koboSpan" id="kobo.715.2" xmlns="http://www.w3.org/1999/xhtml">There are two that are part of the standard library: the </span><code><span class="koboSpan" id="kobo.716.1" xmlns="http://www.w3.org/1999/xhtml">http.server</span></code><span class="koboSpan" id="kobo.717.1" xmlns="http://www.w3.org/1999/xhtml"> package and the </span><code><span class="koboSpan" id="kobo.718.1" xmlns="http://www.w3.org/1999/xhtml">wsgiref</span></code><span class="koboSpan" id="kobo.719.1" xmlns="http://www.w3.org/1999/xhtml"> package. </span><span class="koboSpan" id="kobo.719.2" xmlns="http://www.w3.org/1999/xhtml">Either of these can respond to HTTP requests, and can be </span><span id="dx1-94002"/><span class="koboSpan" id="kobo.720.1" xmlns="http://www.w3.org/1999/xhtml">used to create local services that can mock the Kaggle web service to permit testing our client.</span></p>
<p><span class="koboSpan" id="kobo.721.1" xmlns="http://www.w3.org/1999/xhtml">Additionally, any of the well-known web service frameworks can be used to create the mock service. </span><span class="koboSpan" id="kobo.721.2" xmlns="http://www.w3.org/1999/xhtml">Using a </span><span id="dx1-94003"/><span class="koboSpan" id="kobo.722.1" xmlns="http://www.w3.org/1999/xhtml">tool like </span><strong><span class="koboSpan" id="kobo.723.1" xmlns="http://www.w3.org/1999/xhtml">flask </span></strong><span class="koboSpan" id="kobo.724.1" xmlns="http://www.w3.org/1999/xhtml">or </span><strong><span class="koboSpan" id="kobo.725.1" xmlns="http://www.w3.org/1999/xhtml">bottle </span></strong><span class="koboSpan" id="kobo.726.1" xmlns="http://www.w3.org/1999/xhtml">can make it </span><span id="dx1-94004"/><span class="koboSpan" id="kobo.727.1" xmlns="http://www.w3.org/1999/xhtml">slightly easier to build a suitable mock service.</span></p>
<p><span class="koboSpan" id="kobo.728.1" xmlns="http://www.w3.org/1999/xhtml">To keep the server as simple as possible, we’ll </span><span id="dx1-94005"/><span class="koboSpan" id="kobo.729.1" xmlns="http://www.w3.org/1999/xhtml">use the </span><strong><span class="koboSpan" id="kobo.730.1" xmlns="http://www.w3.org/1999/xhtml">bottle </span></strong><span class="koboSpan" id="kobo.731.1" xmlns="http://www.w3.org/1999/xhtml">framework. </span><span class="koboSpan" id="kobo.731.2" xmlns="http://www.w3.org/1999/xhtml">This means adding </span><code><span class="koboSpan" id="kobo.732.1" xmlns="http://www.w3.org/1999/xhtml">bottle==0.12.23</span></code><span class="koboSpan" id="kobo.733.1" xmlns="http://www.w3.org/1999/xhtml"> to the </span><code><span class="koboSpan" id="kobo.734.1" xmlns="http://www.w3.org/1999/xhtml">pyproject.toml</span></code><span class="koboSpan" id="kobo.735.1" xmlns="http://www.w3.org/1999/xhtml"> file in the </span><code><span class="koboSpan" id="kobo.736.1" xmlns="http://www.w3.org/1999/xhtml">[project.optional-dependencies]</span></code><span class="koboSpan" id="kobo.737.1" xmlns="http://www.w3.org/1999/xhtml"> section. </span><span class="koboSpan" id="kobo.737.2" xmlns="http://www.w3.org/1999/xhtml">This tool is only needed by developers.</span></p>
<p><span class="koboSpan" id="kobo.738.1" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.739.1" xmlns="http://www.w3.org/1999/xhtml">Bottle </span></strong><span class="koboSpan" id="kobo.740.1" xmlns="http://www.w3.org/1999/xhtml">implementation of a RESTful API might look like this:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-52">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.741.1" xmlns="http://www.w3.org/1999/xhtml">import csv
import io
import json
import zipfile
from bottle import route, run, request, HTTPResponse

@route(’/api/v1/datasets/list’)
def datasets_list(name):
    # Provide mock JSON documents and Rate throttling

@route(’/api/v1/datasets/download/&lt;ownerSlug&gt;/&lt;datasetSlug&gt;’)
def datasets_download(ownerSlug, datasetSlug):
    # Provide mock ZIP archive

if __name__ == "__main__":
    run(host=’127.0.0.1’, port=8080)</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.742.1" xmlns="http://www.w3.org/1999/xhtml">While the Kaggle service has numerous paths and methods, this data acquisition project application doesn’t use all of them. </span><span class="koboSpan" id="kobo.742.2" xmlns="http://www.w3.org/1999/xhtml">The mock </span><span id="dx1-94022"/><span class="koboSpan" id="kobo.743.1" xmlns="http://www.w3.org/1999/xhtml">server only needs to provide routes for the paths the application will actually use.</span></p>
<p><span class="koboSpan" id="kobo.744.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.745.1" xmlns="http://www.w3.org/1999/xhtml">datasets_list</span></code><span class="koboSpan" id="kobo.746.1" xmlns="http://www.w3.org/1999/xhtml"> function might include </span><span id="dx1-94023"/><span class="koboSpan" id="kobo.747.1" xmlns="http://www.w3.org/1999/xhtml">the following example response:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-53">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.748.1" xmlns="http://www.w3.org/1999/xhtml">@route(’/api/v1/datasets/list’)
def datasets_list(name):
    page = request.query.page or ’1’
    if page == ’1’:
        mock_body = [
            # Provide attributes as needed by the application under test
            {’title’: ’example1’},
            {’title’: ’example2’},
        ]
        response = HTTPResponse(
            body=json.dumps(mock_body),
            status=200,
            headers={’Content-Type’: ’application/json’}
        )
    else:
        # For error-recovery scenarios, this response may change.
        </span><span class="koboSpan" id="kobo.748.2" xmlns="http://www.w3.org/1999/xhtml">response = HTTPResponse(
            body=json.dumps([]),
            status=200,
            headers={’Content-Type’: ’application/json’}
        )
    return response</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.749.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.750.1" xmlns="http://www.w3.org/1999/xhtml">HTTPResponse</span></code><span class="koboSpan" id="kobo.751.1" xmlns="http://www.w3.org/1999/xhtml"> object contains the essential features of the responses as seen by the acquisition application’s download requests. </span><span class="koboSpan" id="kobo.751.2" xmlns="http://www.w3.org/1999/xhtml">Each response has content, a status code, and a header that is used to confirm the type of response.</span></p>
<p><span class="koboSpan" id="kobo.752.1" xmlns="http://www.w3.org/1999/xhtml">For more comprehensive testing, it makes </span><span id="dx1-94046"/><span class="koboSpan" id="kobo.753.1" xmlns="http://www.w3.org/1999/xhtml">sense to add another kind of response with the status code of 429 and a header dictionary with </span><code><span class="koboSpan" id="kobo.754.1" xmlns="http://www.w3.org/1999/xhtml">{’Retry-After’:</span></code><code><span class="koboSpan" id="kobo.755.1" xmlns="http://www.w3.org/1999/xhtml"> ’30’}</span></code><span class="koboSpan" id="kobo.756.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.756.2" xmlns="http://www.w3.org/1999/xhtml">For this case, the two values of </span><code><span class="koboSpan" id="kobo.757.1" xmlns="http://www.w3.org/1999/xhtml">response</span></code><span class="koboSpan" id="kobo.758.1" xmlns="http://www.w3.org/1999/xhtml"> will be </span><span id="dx1-94047"/><span class="koboSpan" id="kobo.759.1" xmlns="http://www.w3.org/1999/xhtml">more dramatically distinct.</span></p>
<p><span class="koboSpan" id="kobo.760.1" xmlns="http://www.w3.org/1999/xhtml">The download needs to provide a mocked ZIP archive. </span><span class="koboSpan" id="kobo.760.2" xmlns="http://www.w3.org/1999/xhtml">This can be done as shown in the following example:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-54">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.761.1" xmlns="http://www.w3.org/1999/xhtml">@route(’/api/v1/datasets/download/&lt;ownerSlug&gt;/&lt;datasetSlug&gt;’)
def datasets_download(ownerSlug, datasetSlug):
    if ownerSlug == "carlmcbrideellis" and datasetSlug ==
      "data-anscombes-quartet":
        zip_content = io.BytesIO()
        with zipfile.ZipFile(zip_content, ’w’) as archive:
            target_path = zipfile.Path(archive, ’Anscombe_quartet_data.csv’)
            with target_path.open(’w’) as member_file:
                writer = csv.writer(member_file)
                writer.writerow([’mock’, ’data’])
                writer.writerow([’line’, ’two’])
        response = HTTPResponse(
            body=zip_content.getvalue(),
            status=200,
            headers={"Content-Type": "application/zip"}
        )
        return response
    # All other requests...
    </span><span class="koboSpan" id="kobo.761.2" xmlns="http://www.w3.org/1999/xhtml">response = HTTPResponse(
        status=404
    )
    return response</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.762.1" xmlns="http://www.w3.org/1999/xhtml">This function will only respond to one specifically requested combination of </span><code><span class="koboSpan" id="kobo.763.1" xmlns="http://www.w3.org/1999/xhtml">ownerSlug</span></code><span class="koboSpan" id="kobo.764.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.765.1" xmlns="http://www.w3.org/1999/xhtml">datasetSlug</span></code><span class="koboSpan" id="kobo.766.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.766.2" xmlns="http://www.w3.org/1999/xhtml">Other combinations will get a 404 response, the status code for a resource that can’t be found.</span></p>
<p><span class="koboSpan" id="kobo.767.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.768.1" xmlns="http://www.w3.org/1999/xhtml">io.BytesIO</span></code><span class="koboSpan" id="kobo.769.1" xmlns="http://www.w3.org/1999/xhtml"> object is an in-memory buffer that can be processed like a file. </span><span class="koboSpan" id="kobo.769.2" xmlns="http://www.w3.org/1999/xhtml">It is used by the </span><code><span class="koboSpan" id="kobo.770.1" xmlns="http://www.w3.org/1999/xhtml">zipfile.ZipFile</span></code><span class="koboSpan" id="kobo.771.1" xmlns="http://www.w3.org/1999/xhtml"> class to create a ZIP archive. </span><span class="koboSpan" id="kobo.771.2" xmlns="http://www.w3.org/1999/xhtml">A single member is written to this archive. </span><span class="koboSpan" id="kobo.771.3" xmlns="http://www.w3.org/1999/xhtml">The member has a header row and a single row of data, making it easy to describe in a Gherkin scenario. </span><span class="koboSpan" id="kobo.771.4" xmlns="http://www.w3.org/1999/xhtml">The response is </span><span id="dx1-94070"/><span class="koboSpan" id="kobo.772.1" xmlns="http://www.w3.org/1999/xhtml">built from the bytes in this file, a status code of 200, and a header telling the client the content is a ZIP archive.</span></p>
<p><span class="koboSpan" id="kobo.773.1" xmlns="http://www.w3.org/1999/xhtml">This service can be run on the desktop. </span><span class="koboSpan" id="kobo.773.2" xmlns="http://www.w3.org/1999/xhtml">You can </span><span id="dx1-94071"/><span class="koboSpan" id="kobo.774.1" xmlns="http://www.w3.org/1999/xhtml">use a browser to interact with this server and confirm it works well enough to test our application.</span></p>
<p><span class="koboSpan" id="kobo.775.1" xmlns="http://www.w3.org/1999/xhtml">Now that we’ve seen the mock service that stands in for Kaggle.com, we can look at how to make the </span><strong><span class="koboSpan" id="kobo.776.1" xmlns="http://www.w3.org/1999/xhtml">behave </span></strong><span class="koboSpan" id="kobo.777.1" xmlns="http://www.w3.org/1999/xhtml">tool run this service when testing a specific scenario.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="8.1.3.6" id="behave-fixture">
<h4 class="likesubsubsectionHead" data-number="8.1.3.6"><span id="x1-950003"/><span class="koboSpan" id="kobo.778.1" xmlns="http://www.w3.org/1999/xhtml">Behave fixture</span></h4>
<p><span class="koboSpan" id="kobo.779.1" xmlns="http://www.w3.org/1999/xhtml">We’ve added a </span><code><span class="koboSpan" id="kobo.780.1" xmlns="http://www.w3.org/1999/xhtml">fixture.kaggle_server</span></code><span class="koboSpan" id="kobo.781.1" xmlns="http://www.w3.org/1999/xhtml"> to the scenario. </span><span class="koboSpan" id="kobo.781.2" xmlns="http://www.w3.org/1999/xhtml">There are two steps to make this tag start the server </span><span id="dx1-95001"/><span class="koboSpan" id="kobo.782.1" xmlns="http://www.w3.org/1999/xhtml">process running for a </span><span id="dx1-95002"/><span class="koboSpan" id="kobo.783.1" xmlns="http://www.w3.org/1999/xhtml">given scenario. </span><span class="koboSpan" id="kobo.783.2" xmlns="http://www.w3.org/1999/xhtml">These steps are:</span></p>
<ol>
<li><div id="x1-95004x1">
<p><span class="koboSpan" id="kobo.784.1" xmlns="http://www.w3.org/1999/xhtml">Define a generator function. </span><span class="koboSpan" id="kobo.784.2" xmlns="http://www.w3.org/1999/xhtml">This will start a subprocess, yield something, and then kill the subprocess.</span></p>
</div></li>
<li><div id="x1-95006x2">
<p><span class="koboSpan" id="kobo.785.1" xmlns="http://www.w3.org/1999/xhtml">Define a </span><code><span class="koboSpan" id="kobo.786.1" xmlns="http://www.w3.org/1999/xhtml">before_tag()</span></code><span class="koboSpan" id="kobo.787.1" xmlns="http://www.w3.org/1999/xhtml"> function to inject the generator function into the step processing.</span></p>
</div></li>
</ol>
<p><span class="koboSpan" id="kobo.788.1" xmlns="http://www.w3.org/1999/xhtml">Here’s a generator function that will update the context, and start the mock Kaggle service.</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-55">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.789.1" xmlns="http://www.w3.org/1999/xhtml">from collections.abc import Iterator
from typing import Any
import subprocess
import time
import os
import sys
from behave import fixture, use_fixture
from behave.runner import Context

@fixture
def kaggle_server(context: Context) -&gt; Iterator[Any]:
    if "environment" not in context:
        context.environment = os.environ
    context.environment["ACQUIRE_BASE_URL"] = "http://127.0.0.1:8080"
    # Save server-side log for debugging
    server = subprocess.Popen(
        [sys.executable, "tests/mock_kaggle_bottle.py"],
    )
    time.sleep(0.5)  # 500 ms delay to allow the service to open a socket
    yield server
    server.kill()</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.790.1" xmlns="http://www.w3.org/1999/xhtml">The portion of the function before the </span><code><span class="koboSpan" id="kobo.791.1" xmlns="http://www.w3.org/1999/xhtml">yield</span></code><span class="koboSpan" id="kobo.792.1" xmlns="http://www.w3.org/1999/xhtml"> statement is used during the scenario setup. </span><span class="koboSpan" id="kobo.792.2" xmlns="http://www.w3.org/1999/xhtml">This will add value to the </span><span id="dx1-95028"/><span class="koboSpan" id="kobo.793.1" xmlns="http://www.w3.org/1999/xhtml">context that will be used to </span><span id="dx1-95029"/><span class="koboSpan" id="kobo.794.1" xmlns="http://www.w3.org/1999/xhtml">start the application under test. </span><span class="koboSpan" id="kobo.794.2" xmlns="http://www.w3.org/1999/xhtml">After the yielded value has been consumed by the </span><strong><span class="koboSpan" id="kobo.795.1" xmlns="http://www.w3.org/1999/xhtml">Behave </span></strong><span class="koboSpan" id="kobo.796.1" xmlns="http://www.w3.org/1999/xhtml">runner, the scenario executes. </span><span class="koboSpan" id="kobo.796.2" xmlns="http://www.w3.org/1999/xhtml">When the scenario is finished, one more value is requested from this generator; this request will execute the statements after the </span><code><span class="koboSpan" id="kobo.797.1" xmlns="http://www.w3.org/1999/xhtml">yield</span></code><span class="koboSpan" id="kobo.798.1" xmlns="http://www.w3.org/1999/xhtml"> statement. </span><span class="koboSpan" id="kobo.798.2" xmlns="http://www.w3.org/1999/xhtml">There’s no subsequent </span><code><span class="koboSpan" id="kobo.799.1" xmlns="http://www.w3.org/1999/xhtml">yield</span></code><span class="koboSpan" id="kobo.800.1" xmlns="http://www.w3.org/1999/xhtml"> statement; the </span><code><span class="koboSpan" id="kobo.801.1" xmlns="http://www.w3.org/1999/xhtml">StopIteration</span></code><span class="koboSpan" id="kobo.802.1" xmlns="http://www.w3.org/1999/xhtml"> is the expected behavior of this function.</span></p>
<p><span class="koboSpan" id="kobo.803.1" xmlns="http://www.w3.org/1999/xhtml">This </span><code><span class="koboSpan" id="kobo.804.1" xmlns="http://www.w3.org/1999/xhtml">kaggle_server()</span></code><span class="koboSpan" id="kobo.805.1" xmlns="http://www.w3.org/1999/xhtml"> function must be used in a scenario when the </span><code><span class="koboSpan" id="kobo.806.1" xmlns="http://www.w3.org/1999/xhtml">@fixture</span></code><span class="koboSpan" id="kobo.807.1" xmlns="http://www.w3.org/1999/xhtml"> tag is present. </span><span class="koboSpan" id="kobo.807.2" xmlns="http://www.w3.org/1999/xhtml">The following function will do this:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-56">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.808.1" xmlns="http://www.w3.org/1999/xhtml">from behave import use_fixture
from behave.runner import Context

def before_tag(context: Context, tag: str) -&gt; None:
    if tag == "fixture.kaggle_server":
        # This will invoke the definition generator.
        </span><span class="koboSpan" id="kobo.808.2" xmlns="http://www.w3.org/1999/xhtml"># It consumes a value before and after the tagged scenario.
        </span><span class="koboSpan" id="kobo.808.3" xmlns="http://www.w3.org/1999/xhtml">use_fixture(kaggle_server, context)</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.809.1" xmlns="http://www.w3.org/1999/xhtml">When the </span><code><span class="koboSpan" id="kobo.810.1" xmlns="http://www.w3.org/1999/xhtml">@fixture.kaggle_server</span></code><span class="koboSpan" id="kobo.811.1" xmlns="http://www.w3.org/1999/xhtml"> tag is present, this function will inject the </span><code><span class="koboSpan" id="kobo.812.1" xmlns="http://www.w3.org/1999/xhtml">kaggle_server()</span></code><span class="koboSpan" id="kobo.813.1" xmlns="http://www.w3.org/1999/xhtml"> generator function into the </span><span id="dx1-95038"/><span class="koboSpan" id="kobo.814.1" xmlns="http://www.w3.org/1999/xhtml">overall flow of processing by the runner. </span><span class="koboSpan" id="kobo.814.2" xmlns="http://www.w3.org/1999/xhtml">The runner will make appropriate requests of the </span><code><span class="koboSpan" id="kobo.815.1" xmlns="http://www.w3.org/1999/xhtml">kaggle_server()</span></code><span class="koboSpan" id="kobo.816.1" xmlns="http://www.w3.org/1999/xhtml"> generator function to start and stop the service.</span></p>
<p><span class="koboSpan" id="kobo.817.1" xmlns="http://www.w3.org/1999/xhtml">These two functions are </span><span id="dx1-95039"/><span class="koboSpan" id="kobo.818.1" xmlns="http://www.w3.org/1999/xhtml">placed into the </span><code><span class="koboSpan" id="kobo.819.1" xmlns="http://www.w3.org/1999/xhtml">environment.py</span></code><span class="koboSpan" id="kobo.820.1" xmlns="http://www.w3.org/1999/xhtml"> module where the </span><strong><span class="koboSpan" id="kobo.821.1" xmlns="http://www.w3.org/1999/xhtml">behave </span></strong><span class="koboSpan" id="kobo.822.1" xmlns="http://www.w3.org/1999/xhtml">tool can find and use them.</span></p>
<p><span class="koboSpan" id="kobo.823.1" xmlns="http://www.w3.org/1999/xhtml">Now that we have an acceptance test suite, we can turn to implement the required features of the </span><code><span class="koboSpan" id="kobo.824.1" xmlns="http://www.w3.org/1999/xhtml">acquire</span></code><span class="koboSpan" id="kobo.825.1" xmlns="http://www.w3.org/1999/xhtml"> application.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="8.1.3.7" id="kaggle-access-module-and-refactored-main-application">
<h4 class="likesubsubsectionHead" data-number="8.1.3.7"><span id="x1-960003"/><span class="koboSpan" id="kobo.826.1" xmlns="http://www.w3.org/1999/xhtml">Kaggle access module and refactored main application</span></h4>
<p><span class="koboSpan" id="kobo.827.1" xmlns="http://www.w3.org/1999/xhtml">The goal, of course, is two-fold:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.828.1" xmlns="http://www.w3.org/1999/xhtml">Add a </span><code><span class="koboSpan" id="kobo.829.1" xmlns="http://www.w3.org/1999/xhtml">kaggle_client.py</span></code><span class="koboSpan" id="kobo.830.1" xmlns="http://www.w3.org/1999/xhtml"> module. </span><span class="koboSpan" id="kobo.830.2" xmlns="http://www.w3.org/1999/xhtml">The unit tests will confirm this works.</span></p></li>
<li><p><span class="koboSpan" id="kobo.831.1" xmlns="http://www.w3.org/1999/xhtml">Rewrite the </span><code><span class="koboSpan" id="kobo.832.1" xmlns="http://www.w3.org/1999/xhtml">acquire.py</span></code><span class="koboSpan" id="kobo.833.1" xmlns="http://www.w3.org/1999/xhtml"> module from </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.834.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.835.1" xmlns="http://www.w3.org/1999/xhtml"> 3</span></em></a><span class="koboSpan" id="kobo.836.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.837.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.1: Data</span></em> <em><span class="koboSpan" id="kobo.838.1" xmlns="http://www.w3.org/1999/xhtml">Acquisition Base Application</span></em></a><span class="koboSpan" id="kobo.839.1" xmlns="http://www.w3.org/1999/xhtml"> to add the download feature.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.840.1" xmlns="http://www.w3.org/1999/xhtml">The </span><a href="#x1-830002"><em><span class="koboSpan" id="kobo.841.1" xmlns="http://www.w3.org/1999/xhtml">Approach</span></em></a><span class="koboSpan" id="kobo.842.1" xmlns="http://www.w3.org/1999/xhtml"> section provides some </span><span id="dx1-96001"/><span class="koboSpan" id="kobo.843.1" xmlns="http://www.w3.org/1999/xhtml">design guidance for building </span><span id="dx1-96002"/><span class="koboSpan" id="kobo.844.1" xmlns="http://www.w3.org/1999/xhtml">the application. </span><span class="koboSpan" id="kobo.844.2" xmlns="http://www.w3.org/1999/xhtml">Additionally, the previous chapter, </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.845.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.846.1" xmlns="http://www.w3.org/1999/xhtml"> 3</span></em></a><span class="koboSpan" id="kobo.847.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.848.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.1: Data Acquisition Base</span></em> <em><span class="koboSpan" id="kobo.849.1" xmlns="http://www.w3.org/1999/xhtml">Application</span></em></a><span class="koboSpan" id="kobo.850.1" xmlns="http://www.w3.org/1999/xhtml"> provides the baseline application into which the new acquisition </span><span id="dx1-96003"/><span class="koboSpan" id="kobo.851.1" xmlns="http://www.w3.org/1999/xhtml">features should be added.</span></p>
<p><span class="koboSpan" id="kobo.852.1" xmlns="http://www.w3.org/1999/xhtml">The acceptance tests will confirm the application works correctly.</span></p>
<p><span class="koboSpan" id="kobo.853.1" xmlns="http://www.w3.org/1999/xhtml">Given this extended capability, you are encouraged to hunt for additional, interesting data sets. </span><span class="koboSpan" id="kobo.853.2" xmlns="http://www.w3.org/1999/xhtml">The new application can be revised and extended to acquire new, interesting data in other formats.</span></p>
<p><span class="koboSpan" id="kobo.854.1" xmlns="http://www.w3.org/1999/xhtml">Now that we have data acquired from the web in a tidy, easy-to-use format, we can look at acquiring data that isn’t quite so tidy. </span><span class="koboSpan" id="kobo.854.2" xmlns="http://www.w3.org/1999/xhtml">In the next section, we’ll look at how to scrape data out of an HTML page. </span><span id="x1-96004r84"/></p>
</section>
</section>
</section>
<section class="level2" data-number="8.2" id="project-1.3-scrape-data-from-a-web-page">
<h2 data-number="8.2"><span class="titlemark"><span class="koboSpan" id="kobo.855.1" xmlns="http://www.w3.org/1999/xhtml">4.2 </span></span> <span id="x1-970002"/><span class="koboSpan" id="kobo.856.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.3: Scrape data from a web page</span></h2>
<p><span class="koboSpan" id="kobo.857.1" xmlns="http://www.w3.org/1999/xhtml">In some cases, we want data that’s provided by a website that doesn’t have a tidy API. </span><span class="koboSpan" id="kobo.857.2" xmlns="http://www.w3.org/1999/xhtml">The data is available via an HTML page. </span><span class="koboSpan" id="kobo.857.3" xmlns="http://www.w3.org/1999/xhtml">This means the data is surrounded by HTML </span><em><span class="koboSpan" id="kobo.858.1" xmlns="http://www.w3.org/1999/xhtml">markup</span></em><span class="koboSpan" id="kobo.859.1" xmlns="http://www.w3.org/1999/xhtml">, text that describes </span><span id="dx1-97001"/><span class="koboSpan" id="kobo.860.1" xmlns="http://www.w3.org/1999/xhtml">the semantics or structure of the data.</span></p>
<p><span class="koboSpan" id="kobo.861.1" xmlns="http://www.w3.org/1999/xhtml">We’ll start with a description of the application, and then move on to talk about the architectural approach. </span><span class="koboSpan" id="kobo.861.2" xmlns="http://www.w3.org/1999/xhtml">This will be followed with a detailed list of deliverables. </span><span id="x1-97002r97"/></p>
<section class="level3" data-number="8.2.1" id="description-3">
<h3 data-number="8.2.1"><span class="titlemark"><span class="koboSpan" id="kobo.862.1" xmlns="http://www.w3.org/1999/xhtml">4.2.1 </span></span> <span id="x1-980001"/><span class="koboSpan" id="kobo.863.1" xmlns="http://www.w3.org/1999/xhtml">Description</span></h3>
<p><span class="koboSpan" id="kobo.864.1" xmlns="http://www.w3.org/1999/xhtml">We’ll continue to describe projects designed to acquire some data for further analysis. </span><span class="koboSpan" id="kobo.864.2" xmlns="http://www.w3.org/1999/xhtml">In this case, we’ll look at data </span><span id="dx1-98001"/><span class="koboSpan" id="kobo.865.1" xmlns="http://www.w3.org/1999/xhtml">that is available from a website, but is embedded into the surrounding HTML markup. </span><span class="koboSpan" id="kobo.865.2" xmlns="http://www.w3.org/1999/xhtml">We’ll continue to focus on Anscombe’s Quartet data set because it’s small and diagnosing problems is relatively simple. </span><span class="koboSpan" id="kobo.865.3" xmlns="http://www.w3.org/1999/xhtml">A larger data set introduces additional problems with time and storage.</span></p>
<p><span class="koboSpan" id="kobo.866.1" xmlns="http://www.w3.org/1999/xhtml">Parts of this application are an extension to the project in </span><a href="#x1-790001"><em><span class="koboSpan" id="kobo.867.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.2: Acquire</span></em> <em><span class="koboSpan" id="kobo.868.1" xmlns="http://www.w3.org/1999/xhtml">data from a web service</span></em></a><span class="koboSpan" id="kobo.869.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.869.2" xmlns="http://www.w3.org/1999/xhtml">The essential behavior of this application will be similar to the previous project. </span><span class="koboSpan" id="kobo.869.3" xmlns="http://www.w3.org/1999/xhtml">This project will use a CLI application to grab data from a source.</span></p>
<p><span class="koboSpan" id="kobo.870.1" xmlns="http://www.w3.org/1999/xhtml">The User Experience (UX) will also be a command-line application with options to fine-tune the data being gathered. </span><span class="koboSpan" id="kobo.870.2" xmlns="http://www.w3.org/1999/xhtml">Our expected command line should like something like the following:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-57">
<div class="tcolorbox-content">
<pre class="console"><span class="koboSpan" id="kobo.871.1" xmlns="http://www.w3.org/1999/xhtml">% python src/acquire.py -o quartet --page "https://en.wikipedia.org/wiki/Anscombe’s_quartet" --caption "Anscombe’s quartet"</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.872.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.873.1" xmlns="http://www.w3.org/1999/xhtml">-o</span></code><code><span class="koboSpan" id="kobo.874.1" xmlns="http://www.w3.org/1999/xhtml"> quartet</span></code><span class="koboSpan" id="kobo.875.1" xmlns="http://www.w3.org/1999/xhtml"> argument specifies a directory into which four results are written. </span><span class="koboSpan" id="kobo.875.2" xmlns="http://www.w3.org/1999/xhtml">These will have names like </span><code><span class="koboSpan" id="kobo.876.1" xmlns="http://www.w3.org/1999/xhtml">quartet/series_1.json</span></code><span class="koboSpan" id="kobo.877.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.878.1" xmlns="http://www.w3.org/1999/xhtml">The table is buried in the HTML of the URL given by the </span><code><span class="koboSpan" id="kobo.879.1" xmlns="http://www.w3.org/1999/xhtml">--page</span></code><span class="koboSpan" id="kobo.880.1" xmlns="http://www.w3.org/1999/xhtml"> argument. </span><span class="koboSpan" id="kobo.880.2" xmlns="http://www.w3.org/1999/xhtml">Within this HTML, the target table has a unique </span><code><span class="koboSpan" id="kobo.881.1" xmlns="http://www.w3.org/1999/xhtml">&lt;caption&gt;</span></code><span class="koboSpan" id="kobo.882.1" xmlns="http://www.w3.org/1999/xhtml"> tag: </span><code><span class="koboSpan" id="kobo.883.1" xmlns="http://www.w3.org/1999/xhtml">&lt;caption&gt;Anscombe’s</span></code><code><span class="koboSpan" id="kobo.884.1" xmlns="http://www.w3.org/1999/xhtml"> quartet&lt;/caption&gt;</span></code><span class="koboSpan" id="kobo.885.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span id="x1-98003r106"/></p>
</section>
<section class="level3" data-number="8.2.2" id="about-the-source-data-2">
<h3 data-number="8.2.2"><span class="titlemark"><span class="koboSpan" id="kobo.886.1" xmlns="http://www.w3.org/1999/xhtml">4.2.2 </span></span> <span id="x1-990002"/><span class="koboSpan" id="kobo.887.1" xmlns="http://www.w3.org/1999/xhtml">About the source data</span></h3>
<p><span class="koboSpan" id="kobo.888.1" xmlns="http://www.w3.org/1999/xhtml">This data embedded in HTML </span><span id="dx1-99001"/><span class="koboSpan" id="kobo.889.1" xmlns="http://www.w3.org/1999/xhtml">markup is generally marked up with the </span><code><span class="koboSpan" id="kobo.890.1" xmlns="http://www.w3.org/1999/xhtml">&lt;table&gt;</span></code><span class="koboSpan" id="kobo.891.1" xmlns="http://www.w3.org/1999/xhtml"> tag. </span><span class="koboSpan" id="kobo.891.2" xmlns="http://www.w3.org/1999/xhtml">A table will often have the following markup:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-58">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.892.1" xmlns="http://www.w3.org/1999/xhtml">&lt;table class="wikitable" style="text-align: center; margin-left:auto;
  margin-right:auto;" border="1"&gt;
    &lt;caption&gt;Anscombe’s quartet&lt;/caption&gt;
    &lt;tbody&gt;
      &lt;tr&gt;
        &lt;th colspan="2"&gt;I&lt;/th&gt;
        etc.
      </span><span class="koboSpan" id="kobo.892.2" xmlns="http://www.w3.org/1999/xhtml">&lt;/tr&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;i&gt;x&lt;/i&gt;&lt;/td&gt;
        &lt;td&gt;&lt;i&gt;y&lt;/i&gt;&lt;/td&gt;
        etc.
      </span><span class="koboSpan" id="kobo.892.3" xmlns="http://www.w3.org/1999/xhtml">&lt;/tr&gt;
      &lt;tr&gt;
        &lt;td&gt;10.0&lt;/td&gt;
        &lt;td&gt;8.04&lt;/td&gt;
        etc.
      </span><span class="koboSpan" id="kobo.892.4" xmlns="http://www.w3.org/1999/xhtml">&lt;/tr&gt;
    &lt;/tbody&gt;
&lt;/table&gt;</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.893.1" xmlns="http://www.w3.org/1999/xhtml">In this example, the overall </span><code><span class="koboSpan" id="kobo.894.1" xmlns="http://www.w3.org/1999/xhtml">&lt;table&gt;</span></code><span class="koboSpan" id="kobo.895.1" xmlns="http://www.w3.org/1999/xhtml"> tag will have two child tags, a </span><code><span class="koboSpan" id="kobo.896.1" xmlns="http://www.w3.org/1999/xhtml">&lt;caption&gt;</span></code><span class="koboSpan" id="kobo.897.1" xmlns="http://www.w3.org/1999/xhtml"> and a </span><code><span class="koboSpan" id="kobo.898.1" xmlns="http://www.w3.org/1999/xhtml">&lt;tbody&gt;</span></code><span class="koboSpan" id="kobo.899.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.900.1" xmlns="http://www.w3.org/1999/xhtml">The table’s body, within </span><code><span class="koboSpan" id="kobo.901.1" xmlns="http://www.w3.org/1999/xhtml">&lt;tbody&gt;</span></code><span class="koboSpan" id="kobo.902.1" xmlns="http://www.w3.org/1999/xhtml">, has a number of rows wrapped in </span><code><span class="koboSpan" id="kobo.903.1" xmlns="http://www.w3.org/1999/xhtml">&lt;tr&gt;</span></code><span class="koboSpan" id="kobo.904.1" xmlns="http://www.w3.org/1999/xhtml"> tags. </span><span class="koboSpan" id="kobo.904.2" xmlns="http://www.w3.org/1999/xhtml">The first row has headings in </span><code><span class="koboSpan" id="kobo.905.1" xmlns="http://www.w3.org/1999/xhtml">&lt;th&gt;</span></code><span class="koboSpan" id="kobo.906.1" xmlns="http://www.w3.org/1999/xhtml"> tags. </span><span class="koboSpan" id="kobo.906.2" xmlns="http://www.w3.org/1999/xhtml">The second row also has headings, but they use the </span><code><span class="koboSpan" id="kobo.907.1" xmlns="http://www.w3.org/1999/xhtml">&lt;td&gt;</span></code><span class="koboSpan" id="kobo.908.1" xmlns="http://www.w3.org/1999/xhtml"> tags. </span><span class="koboSpan" id="kobo.908.2" xmlns="http://www.w3.org/1999/xhtml">The remaining rows have data, also in </span><code><span class="koboSpan" id="kobo.909.1" xmlns="http://www.w3.org/1999/xhtml">&lt;td&gt;</span></code><span class="koboSpan" id="kobo.910.1" xmlns="http://www.w3.org/1999/xhtml"> tags.</span></p>
<p><span class="koboSpan" id="kobo.911.1" xmlns="http://www.w3.org/1999/xhtml">This structure has a great deal of regularity, making it possible to use a parser like </span><strong><span class="koboSpan" id="kobo.912.1" xmlns="http://www.w3.org/1999/xhtml">Beautiful Soup </span></strong><span class="koboSpan" id="kobo.913.1" xmlns="http://www.w3.org/1999/xhtml">to locate the content.</span></p>
<p><span class="koboSpan" id="kobo.914.1" xmlns="http://www.w3.org/1999/xhtml">The output will match the extraction </span><span id="dx1-99022"/><span class="koboSpan" id="kobo.915.1" xmlns="http://www.w3.org/1999/xhtml">processing done for the previous projects. </span><span class="koboSpan" id="kobo.915.2" xmlns="http://www.w3.org/1999/xhtml">See </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.916.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.917.1" xmlns="http://www.w3.org/1999/xhtml"> 3</span></em></a><span class="koboSpan" id="kobo.918.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.919.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.1: Data Acquisition Base Application</span></em></a><span class="koboSpan" id="kobo.920.1" xmlns="http://www.w3.org/1999/xhtml">, for the essence of the data acquisition application.</span></p>
<p><span class="koboSpan" id="kobo.921.1" xmlns="http://www.w3.org/1999/xhtml">This section has looked at the input and processing for this application. </span><span class="koboSpan" id="kobo.921.2" xmlns="http://www.w3.org/1999/xhtml">The output will match earlier projects. </span><span class="koboSpan" id="kobo.921.3" xmlns="http://www.w3.org/1999/xhtml">In the next section, we’ll look at the overall architecture of the software. </span><span id="x1-99023r107"/></p>
</section>
<section class="level3" data-number="8.2.3" id="approach-2">
<h3 data-number="8.2.3"><span class="titlemark"><span class="koboSpan" id="kobo.922.1" xmlns="http://www.w3.org/1999/xhtml">4.2.3 </span></span> <span id="x1-1000003"/><span class="koboSpan" id="kobo.923.1" xmlns="http://www.w3.org/1999/xhtml">Approach</span></h3>
<p><span class="koboSpan" id="kobo.924.1" xmlns="http://www.w3.org/1999/xhtml">We’ll take some </span><span id="dx1-100001"/><span class="koboSpan" id="kobo.925.1" xmlns="http://www.w3.org/1999/xhtml">guidance from the C4 model ( </span><a class="url" href="https://c4model.com"><span class="koboSpan" id="kobo.926.1" xmlns="http://www.w3.org/1999/xhtml">https://c4model.com</span></a><span class="koboSpan" id="kobo.927.1" xmlns="http://www.w3.org/1999/xhtml">) when looking at our approach:</span></p>
<ul>
<li><p><strong><span class="koboSpan" id="kobo.928.1" xmlns="http://www.w3.org/1999/xhtml">Context</span></strong><span class="koboSpan" id="kobo.929.1" xmlns="http://www.w3.org/1999/xhtml">: For this project, a context diagram would show a user extracting data from a source. </span><span class="koboSpan" id="kobo.929.2" xmlns="http://www.w3.org/1999/xhtml">You may find it helpful to draw this diagram.</span></p></li>
<li><p><strong><span class="koboSpan" id="kobo.930.1" xmlns="http://www.w3.org/1999/xhtml">Containers</span></strong><span class="koboSpan" id="kobo.931.1" xmlns="http://www.w3.org/1999/xhtml">: One container is the user’s personal computer. </span><span class="koboSpan" id="kobo.931.2" xmlns="http://www.w3.org/1999/xhtml">The other container is the Wikipedia website, which provides the data.</span></p></li>
<li><p><strong><span class="koboSpan" id="kobo.932.1" xmlns="http://www.w3.org/1999/xhtml">Components</span></strong><span class="koboSpan" id="kobo.933.1" xmlns="http://www.w3.org/1999/xhtml">: We’ll address the components below.</span></p></li>
<li><p><strong><span class="koboSpan" id="kobo.934.1" xmlns="http://www.w3.org/1999/xhtml">Code</span></strong><span class="koboSpan" id="kobo.935.1" xmlns="http://www.w3.org/1999/xhtml">: We’ll touch on this to provide some suggested directions.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.936.1" xmlns="http://www.w3.org/1999/xhtml">It’s important to consider this application as an extension to the project in </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.937.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.938.1" xmlns="http://www.w3.org/1999/xhtml"> 3</span></em></a><span class="koboSpan" id="kobo.939.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.940.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.1: Data Acquisition Base Application</span></em></a><span class="koboSpan" id="kobo.941.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.941.2" xmlns="http://www.w3.org/1999/xhtml">The base level of architectural design is provided in that chapter.</span></p>
<p><span class="koboSpan" id="kobo.942.1" xmlns="http://www.w3.org/1999/xhtml">In this project, we’ll be adding a new </span><code><span class="koboSpan" id="kobo.943.1" xmlns="http://www.w3.org/1999/xhtml">html_extract</span></code><span class="koboSpan" id="kobo.944.1" xmlns="http://www.w3.org/1999/xhtml"> module to capture and parse the data. </span><span class="koboSpan" id="kobo.944.2" xmlns="http://www.w3.org/1999/xhtml">The overall application in the </span><code><span class="koboSpan" id="kobo.945.1" xmlns="http://www.w3.org/1999/xhtml">acquire</span></code><span class="koboSpan" id="kobo.946.1" xmlns="http://www.w3.org/1999/xhtml"> module will change to use the new features. </span><span class="koboSpan" id="kobo.946.2" xmlns="http://www.w3.org/1999/xhtml">The other modules should remain unchanged.</span></p>
<p><span class="koboSpan" id="kobo.947.1" xmlns="http://www.w3.org/1999/xhtml">A new architecture that handles the download of HTML data and the extraction of a table from the source data is shown in </span><a href="#4.4"><em><span class="koboSpan" id="kobo.948.1" xmlns="http://www.w3.org/1999/xhtml">Figure 4.4</span></em></a><span class="koboSpan" id="kobo.949.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<figure class="IMG---Figure">
<span class="koboSpan" id="kobo.950.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 4.4: Revised Component Design " src="../media/file17.jpg"/></span>
<figcaption class="IMG---Caption"><span class="id" id="4.4"><span class="koboSpan" id="kobo.951.1" xmlns="http://www.w3.org/1999/xhtml">Figure 4.4: </span></span><span class="content"><span class="koboSpan" id="kobo.952.1" xmlns="http://www.w3.org/1999/xhtml">Revised Component Design </span></span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.953.1" xmlns="http://www.w3.org/1999/xhtml">This diagram suggested classes for the new </span><code><span class="koboSpan" id="kobo.954.1" xmlns="http://www.w3.org/1999/xhtml">html_extract</span></code><span class="koboSpan" id="kobo.955.1" xmlns="http://www.w3.org/1999/xhtml"> module. </span><span class="koboSpan" id="kobo.955.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.956.1" xmlns="http://www.w3.org/1999/xhtml">Download</span></code><span class="koboSpan" id="kobo.957.1" xmlns="http://www.w3.org/1999/xhtml"> class uses </span><code><span class="koboSpan" id="kobo.958.1" xmlns="http://www.w3.org/1999/xhtml">urllib.request</span></code><span class="koboSpan" id="kobo.959.1" xmlns="http://www.w3.org/1999/xhtml"> to open the given URL and read the contents. </span><span class="koboSpan" id="kobo.959.2" xmlns="http://www.w3.org/1999/xhtml">It also uses the </span><code><span class="koboSpan" id="kobo.960.1" xmlns="http://www.w3.org/1999/xhtml">bs4</span></code><span class="koboSpan" id="kobo.961.1" xmlns="http://www.w3.org/1999/xhtml"> module (</span><strong><span class="koboSpan" id="kobo.962.1" xmlns="http://www.w3.org/1999/xhtml">Beautiful Soup</span></strong><span class="koboSpan" id="kobo.963.1" xmlns="http://www.w3.org/1999/xhtml">) to parse the HTML, locate the table with the desired caption, and extract the body of the table.</span></p>
<p><span class="koboSpan" id="kobo.964.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.965.1" xmlns="http://www.w3.org/1999/xhtml">PairBuilder</span></code><span class="koboSpan" id="kobo.966.1" xmlns="http://www.w3.org/1999/xhtml"> class hierarchy has </span><span id="dx1-100004"/><span class="koboSpan" id="kobo.967.1" xmlns="http://www.w3.org/1999/xhtml">four implementations, each appropriate for one of the four data series. </span><span class="koboSpan" id="kobo.967.2" xmlns="http://www.w3.org/1999/xhtml">Looking back at </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.968.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.969.1" xmlns="http://www.w3.org/1999/xhtml"> 3</span></em></a><span class="koboSpan" id="kobo.970.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.971.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.1: Data</span></em> <em><span class="koboSpan" id="kobo.972.1" xmlns="http://www.w3.org/1999/xhtml">Acquisition Base Application</span></em></a><span class="koboSpan" id="kobo.973.1" xmlns="http://www.w3.org/1999/xhtml">, there’s a profound difference between the table of data shown on the Wikipedia page, and the CSV source file shown in that earlier project. </span><span class="koboSpan" id="kobo.973.2" xmlns="http://www.w3.org/1999/xhtml">This difference in data organization requires slightly different pair-building functions.</span></p>
<section class="level4 likesubsubsectionHead" data-number="8.2.3.1" id="making-an-html-request-with-urllib.request">
<h4 class="likesubsubsectionHead" data-number="8.2.3.1"><span id="x1-1010003"/><span class="koboSpan" id="kobo.974.1" xmlns="http://www.w3.org/1999/xhtml">Making an HTML request with urllib.request</span></h4>
<p><span class="koboSpan" id="kobo.975.1" xmlns="http://www.w3.org/1999/xhtml">The process of reading a web page is directly </span><span id="dx1-101001"/><span class="koboSpan" id="kobo.976.1" xmlns="http://www.w3.org/1999/xhtml">supported by the </span><code><span class="koboSpan" id="kobo.977.1" xmlns="http://www.w3.org/1999/xhtml">urllib.request</span></code><span class="koboSpan" id="kobo.978.1" xmlns="http://www.w3.org/1999/xhtml"> module. </span><span class="koboSpan" id="kobo.978.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.979.1" xmlns="http://www.w3.org/1999/xhtml">url_open()</span></code><span class="koboSpan" id="kobo.980.1" xmlns="http://www.w3.org/1999/xhtml"> function will </span><span id="dx1-101002"/><span class="koboSpan" id="kobo.981.1" xmlns="http://www.w3.org/1999/xhtml">perform a GET request for a given URL. </span><span class="koboSpan" id="kobo.981.2" xmlns="http://www.w3.org/1999/xhtml">The return value is a file-like object — with a </span><code><span class="koboSpan" id="kobo.982.1" xmlns="http://www.w3.org/1999/xhtml">read()</span></code><span class="koboSpan" id="kobo.983.1" xmlns="http://www.w3.org/1999/xhtml"> method — that can be </span><span id="dx1-101003"/><span class="koboSpan" id="kobo.984.1" xmlns="http://www.w3.org/1999/xhtml">used to acquire the content.</span></p>
<p><span class="koboSpan" id="kobo.985.1" xmlns="http://www.w3.org/1999/xhtml">This is considerably simpler than making a general RESTful API request where there are a variety of pieces of information to be uploaded and a variety of kinds of results that might be downloaded. </span><span class="koboSpan" id="kobo.985.2" xmlns="http://www.w3.org/1999/xhtml">When working with common GET requests, this standard library module handles the ordinary processing elegantly.</span></p>
<p><span class="koboSpan" id="kobo.986.1" xmlns="http://www.w3.org/1999/xhtml">A suggested design for the first step in the operation is the following function:</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.987.1" xmlns="http://www.w3.org/1999/xhtml">from urllib.request import urlopen
from bs4 import BeautifulSoup, Tag

def get_page(url: str) -&gt; BeautifulSoup:
    return BeautifulSoup(
        urlopen(url), "html.parser"
    )</span></pre>
<p><span class="koboSpan" id="kobo.988.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.989.1" xmlns="http://www.w3.org/1999/xhtml">urlopen()</span></code><span class="koboSpan" id="kobo.990.1" xmlns="http://www.w3.org/1999/xhtml"> function will open the URL as a file-like object, and provide that file to the </span><code><span class="koboSpan" id="kobo.991.1" xmlns="http://www.w3.org/1999/xhtml">BeautifulSoup</span></code><span class="koboSpan" id="kobo.992.1" xmlns="http://www.w3.org/1999/xhtml"> class to </span><span id="dx1-101011"/><span class="koboSpan" id="kobo.993.1" xmlns="http://www.w3.org/1999/xhtml">parse the resulting HTML.</span></p>
<p><span class="koboSpan" id="kobo.994.1" xmlns="http://www.w3.org/1999/xhtml">A </span><code><span class="koboSpan" id="kobo.995.1" xmlns="http://www.w3.org/1999/xhtml">try:</span></code><span class="koboSpan" id="kobo.996.1" xmlns="http://www.w3.org/1999/xhtml"> statement to handle potential </span><span id="dx1-101012"/><span class="koboSpan" id="kobo.997.1" xmlns="http://www.w3.org/1999/xhtml">problems is not shown. </span><span class="koboSpan" id="kobo.997.2" xmlns="http://www.w3.org/1999/xhtml">There are innumerable potential issues when </span><span id="dx1-101013"/><span class="koboSpan" id="kobo.998.1" xmlns="http://www.w3.org/1999/xhtml">reaching out to a web service, and trying to parse the resulting content. </span><span class="koboSpan" id="kobo.998.2" xmlns="http://www.w3.org/1999/xhtml">You are encouraged to add some simple error reporting.</span></p>
<p><span class="koboSpan" id="kobo.999.1" xmlns="http://www.w3.org/1999/xhtml">In the next section, we’ll look at extracting the relevant table from the parsed HTML.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="8.2.3.2" id="html-scraping-and-beautiful-soup">
<h4 class="likesubsubsectionHead" data-number="8.2.3.2"><span id="x1-1020003"/><span class="koboSpan" id="kobo.1000.1" xmlns="http://www.w3.org/1999/xhtml">HTML scraping and Beautiful Soup</span></h4>
<p><span class="koboSpan" id="kobo.1001.1" xmlns="http://www.w3.org/1999/xhtml">The Beautiful Soup data structure has a </span><code><span class="koboSpan" id="kobo.1002.1" xmlns="http://www.w3.org/1999/xhtml">find_all()</span></code><span class="koboSpan" id="kobo.1003.1" xmlns="http://www.w3.org/1999/xhtml"> method to traverse the structure. </span><span class="koboSpan" id="kobo.1003.2" xmlns="http://www.w3.org/1999/xhtml">This will look for tags </span><span id="dx1-102001"/><span class="koboSpan" id="kobo.1004.1" xmlns="http://www.w3.org/1999/xhtml">with specific kinds of properties. </span><span class="koboSpan" id="kobo.1004.2" xmlns="http://www.w3.org/1999/xhtml">This </span><span id="dx1-102002"/><span class="koboSpan" id="kobo.1005.1" xmlns="http://www.w3.org/1999/xhtml">can examine the tag, the attributes, and even </span><span id="dx1-102003"/><span class="koboSpan" id="kobo.1006.1" xmlns="http://www.w3.org/1999/xhtml">the text content of the tag.</span></p>
<p><span class="koboSpan" id="kobo.1007.1" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/#find-all"><span class="koboSpan" id="kobo.1008.1" xmlns="http://www.w3.org/1999/xhtml">https://www.crummy.com/software/BeautifulSoup/bs4/doc/#find-all</span></a><span class="koboSpan" id="kobo.1009.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.1010.1" xmlns="http://www.w3.org/1999/xhtml">In this case, we </span><span id="dx1-102004"/><span class="koboSpan" id="kobo.1011.1" xmlns="http://www.w3.org/1999/xhtml">need to find a </span><code><span class="koboSpan" id="kobo.1012.1" xmlns="http://www.w3.org/1999/xhtml">&lt;table&gt;</span></code><span class="koboSpan" id="kobo.1013.1" xmlns="http://www.w3.org/1999/xhtml"> tag with a </span><code><span class="koboSpan" id="kobo.1014.1" xmlns="http://www.w3.org/1999/xhtml">caption</span></code><span class="koboSpan" id="kobo.1015.1" xmlns="http://www.w3.org/1999/xhtml"> tag embedded within it. </span><span class="koboSpan" id="kobo.1015.2" xmlns="http://www.w3.org/1999/xhtml">That </span><code><span class="koboSpan" id="kobo.1016.1" xmlns="http://www.w3.org/1999/xhtml">caption</span></code><span class="koboSpan" id="kobo.1017.1" xmlns="http://www.w3.org/1999/xhtml"> tag must have the desired text. </span><span class="koboSpan" id="kobo.1017.2" xmlns="http://www.w3.org/1999/xhtml">This search leads to a bit more complex investigation of the structure. </span><span class="koboSpan" id="kobo.1017.3" xmlns="http://www.w3.org/1999/xhtml">The following function can locate the desired table.</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-59">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.1018.1" xmlns="http://www.w3.org/1999/xhtml">def find_table_caption(
        soup: BeautifulSoup,
        caption_text: str = "Anscombe’s quartet"
    ) -&gt; Tag:
    for table in soup.find_all(’table’):
        if table.caption:
            if table.caption.text.strip() == caption_text.strip():
                return table
    raise RuntimeError(f"&lt;table&gt; with caption {caption_text!r} not found")</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.1019.1" xmlns="http://www.w3.org/1999/xhtml">Some of the tables lack captions. </span><span class="koboSpan" id="kobo.1019.2" xmlns="http://www.w3.org/1999/xhtml">This means the expression </span><code><span class="koboSpan" id="kobo.1020.1" xmlns="http://www.w3.org/1999/xhtml">table.caption.text</span></code><span class="koboSpan" id="kobo.1021.1" xmlns="http://www.w3.org/1999/xhtml"> won’t work for string comparison because it may have a </span><code><span class="koboSpan" id="kobo.1022.1" xmlns="http://www.w3.org/1999/xhtml">None</span></code><span class="koboSpan" id="kobo.1023.1" xmlns="http://www.w3.org/1999/xhtml"> value for </span><code><span class="koboSpan" id="kobo.1024.1" xmlns="http://www.w3.org/1999/xhtml">table.caption</span></code><span class="koboSpan" id="kobo.1025.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.1025.2" xmlns="http://www.w3.org/1999/xhtml">This leads to a nested cascade of </span><code><span class="koboSpan" id="kobo.1026.1" xmlns="http://www.w3.org/1999/xhtml">if</span></code><span class="koboSpan" id="kobo.1027.1" xmlns="http://www.w3.org/1999/xhtml"> statements to be sure there’s a </span><code><span class="koboSpan" id="kobo.1028.1" xmlns="http://www.w3.org/1999/xhtml">&lt;caption&gt;</span></code><span class="koboSpan" id="kobo.1029.1" xmlns="http://www.w3.org/1999/xhtml"> tag before checking the text value of the tag.</span></p>
<p><span class="koboSpan" id="kobo.1030.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.1031.1" xmlns="http://www.w3.org/1999/xhtml">strip()</span></code><span class="koboSpan" id="kobo.1032.1" xmlns="http://www.w3.org/1999/xhtml"> functions are used to remove </span><span id="dx1-102014"/><span class="koboSpan" id="kobo.1033.1" xmlns="http://www.w3.org/1999/xhtml">leading and trailing whitespace from the text because blocks of text in HTML can be surrounded by whitespace that’s not displayed, making it surprising </span><span id="dx1-102015"/><span class="koboSpan" id="kobo.1034.1" xmlns="http://www.w3.org/1999/xhtml">when it surfaces as part of the content. </span><span class="koboSpan" id="kobo.1034.2" xmlns="http://www.w3.org/1999/xhtml">Stripping the leading and trailing whitespace makes it easier to match.</span></p>
<p><span class="koboSpan" id="kobo.1035.1" xmlns="http://www.w3.org/1999/xhtml">The rest of the processing is left for </span><span id="dx1-102016"/><span class="koboSpan" id="kobo.1036.1" xmlns="http://www.w3.org/1999/xhtml">you to design. </span><span class="koboSpan" id="kobo.1036.2" xmlns="http://www.w3.org/1999/xhtml">This processing involves finding all of the </span><code><span class="koboSpan" id="kobo.1037.1" xmlns="http://www.w3.org/1999/xhtml">&lt;tr&gt;</span></code><span class="koboSpan" id="kobo.1038.1" xmlns="http://www.w3.org/1999/xhtml"> tags, representing rows of the table. </span><span class="koboSpan" id="kobo.1038.2" xmlns="http://www.w3.org/1999/xhtml">Within each row (except the first) there will be a sequence of </span><code><span class="koboSpan" id="kobo.1039.1" xmlns="http://www.w3.org/1999/xhtml">&lt;td&gt;</span></code><span class="koboSpan" id="kobo.1040.1" xmlns="http://www.w3.org/1999/xhtml"> tags representing the cell values within the row.</span></p>
<p><span class="koboSpan" id="kobo.1041.1" xmlns="http://www.w3.org/1999/xhtml">Once the text has been extracted, it’s very similar to the results from a </span><code><span class="koboSpan" id="kobo.1042.1" xmlns="http://www.w3.org/1999/xhtml">csv.reader</span></code><span class="koboSpan" id="kobo.1043.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.1044.1" xmlns="http://www.w3.org/1999/xhtml">After considering the technical approach, it’s time to look at the deliverables for this project. </span><span id="x1-102017r108"/></p>
</section>
</section>
<section class="level3" data-number="8.2.4" id="deliverables-3">
<h3 data-number="8.2.4"><span class="titlemark"><span class="koboSpan" id="kobo.1045.1" xmlns="http://www.w3.org/1999/xhtml">4.2.4 </span></span> <span id="x1-1030004"/><span class="koboSpan" id="kobo.1046.1" xmlns="http://www.w3.org/1999/xhtml">Deliverables</span></h3>
<p><span class="koboSpan" id="kobo.1047.1" xmlns="http://www.w3.org/1999/xhtml">This project has </span><span id="dx1-103001"/><span class="koboSpan" id="kobo.1048.1" xmlns="http://www.w3.org/1999/xhtml">the following deliverables:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.1049.1" xmlns="http://www.w3.org/1999/xhtml">Documentation in the </span><code><span class="koboSpan" id="kobo.1050.1" xmlns="http://www.w3.org/1999/xhtml">docs</span></code><span class="koboSpan" id="kobo.1051.1" xmlns="http://www.w3.org/1999/xhtml"> folder.</span></p></li>
<li><p><span class="koboSpan" id="kobo.1052.1" xmlns="http://www.w3.org/1999/xhtml">Acceptance tests in the </span><code><span class="koboSpan" id="kobo.1053.1" xmlns="http://www.w3.org/1999/xhtml">tests/features</span></code><span class="koboSpan" id="kobo.1054.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.1055.1" xmlns="http://www.w3.org/1999/xhtml">tests/steps</span></code><span class="koboSpan" id="kobo.1056.1" xmlns="http://www.w3.org/1999/xhtml"> folders.</span></p></li>
<li><p><span class="koboSpan" id="kobo.1057.1" xmlns="http://www.w3.org/1999/xhtml">Unit tests for the application modules in the </span><code><span class="koboSpan" id="kobo.1058.1" xmlns="http://www.w3.org/1999/xhtml">tests</span></code><span class="koboSpan" id="kobo.1059.1" xmlns="http://www.w3.org/1999/xhtml"> folder.</span></p></li>
<li><p><span class="koboSpan" id="kobo.1060.1" xmlns="http://www.w3.org/1999/xhtml">Mock HTML pages for unit testing will be part of the unit tests.</span></p></li>
<li><p><span class="koboSpan" id="kobo.1061.1" xmlns="http://www.w3.org/1999/xhtml">Application to acquire data from an HTML page.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.1062.1" xmlns="http://www.w3.org/1999/xhtml">We’ll look at a few of these deliverables in a little more detail.</span></p>
<section class="level4 likesubsubsectionHead" data-number="8.2.4.1" id="unit-test-for-the-html_extract-module">
<h4 class="likesubsubsectionHead" data-number="8.2.4.1"><span id="x1-1040004"/><span class="koboSpan" id="kobo.1063.1" xmlns="http://www.w3.org/1999/xhtml">Unit test for the html_extract module</span></h4>
<p><span class="koboSpan" id="kobo.1064.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.1065.1" xmlns="http://www.w3.org/1999/xhtml">urlopen()</span></code><span class="koboSpan" id="kobo.1066.1" xmlns="http://www.w3.org/1999/xhtml"> function supports the </span><code><span class="koboSpan" id="kobo.1067.1" xmlns="http://www.w3.org/1999/xhtml">http:</span></code><span class="koboSpan" id="kobo.1068.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.1069.1" xmlns="http://www.w3.org/1999/xhtml">https:</span></code><span class="koboSpan" id="kobo.1070.1" xmlns="http://www.w3.org/1999/xhtml"> schemes. </span><span class="koboSpan" id="kobo.1070.2" xmlns="http://www.w3.org/1999/xhtml">It also supports the </span><code><span class="koboSpan" id="kobo.1071.1" xmlns="http://www.w3.org/1999/xhtml">file:</span></code><span class="koboSpan" id="kobo.1072.1" xmlns="http://www.w3.org/1999/xhtml"> protocol. </span><span class="koboSpan" id="kobo.1072.2" xmlns="http://www.w3.org/1999/xhtml">This allows a test </span><span id="dx1-104001"/><span class="koboSpan" id="kobo.1073.1" xmlns="http://www.w3.org/1999/xhtml">case to use a URL of the form </span><code><span class="koboSpan" id="kobo.1074.1" xmlns="http://www.w3.org/1999/xhtml">file:///path/to/a/file.html</span></code><span class="koboSpan" id="kobo.1075.1" xmlns="http://www.w3.org/1999/xhtml"> to read a local HTML file. </span><span class="koboSpan" id="kobo.1075.2" xmlns="http://www.w3.org/1999/xhtml">This facilitates testing by avoiding the complications of accessing data over the internet.</span></p>
<p><span class="koboSpan" id="kobo.1076.1" xmlns="http://www.w3.org/1999/xhtml">For testing, it makes sense to prepare files with the expected HTML structure, as well as invalid structures. </span><span class="koboSpan" id="kobo.1076.2" xmlns="http://www.w3.org/1999/xhtml">With some local files as examples, a developer can run test cases quickly.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-60">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.1077.1" xmlns="http://www.w3.org/1999/xhtml">Generally, it’s considered a best practice to mock the </span><code><span class="koboSpan" id="kobo.1078.1" xmlns="http://www.w3.org/1999/xhtml">BeautifulSoup</span></code><span class="koboSpan" id="kobo.1079.1" xmlns="http://www.w3.org/1999/xhtml"> class. </span><span class="koboSpan" id="kobo.1079.2" xmlns="http://www.w3.org/1999/xhtml">A fixture would respond to the various </span><code><span class="koboSpan" id="kobo.1080.1" xmlns="http://www.w3.org/1999/xhtml">find_all()</span></code><span class="koboSpan" id="kobo.1081.1" xmlns="http://www.w3.org/1999/xhtml"> requests with mock tag objects.</span></p>
<p><span class="koboSpan" id="kobo.1082.1" xmlns="http://www.w3.org/1999/xhtml">When working with HTML, however, it seems better to provide mock HTML. </span><span class="koboSpan" id="kobo.1082.2" xmlns="http://www.w3.org/1999/xhtml">The wide variety of HTML seen in the wild suggests that time spent with real HTML is immensely valuable for debugging.</span></p>
<p><span class="koboSpan" id="kobo.1083.1" xmlns="http://www.w3.org/1999/xhtml">Creating </span><code><span class="koboSpan" id="kobo.1084.1" xmlns="http://www.w3.org/1999/xhtml">BeautifulSoup</span></code><span class="koboSpan" id="kobo.1085.1" xmlns="http://www.w3.org/1999/xhtml"> objects means the unit testing is more like integration testing. </span><span class="koboSpan" id="kobo.1085.2" xmlns="http://www.w3.org/1999/xhtml">The benefits of being able to test a wide variety of odd and unusual HTML seems to be more valuable than the cost of breaking the ideal context for a unit test.</span></p>
</div>
</div>
<p><span class="koboSpan" id="kobo.1086.1" xmlns="http://www.w3.org/1999/xhtml">Having example HTML files plays well with the way </span><strong><span class="koboSpan" id="kobo.1087.1" xmlns="http://www.w3.org/1999/xhtml">pytest </span></strong><span class="koboSpan" id="kobo.1088.1" xmlns="http://www.w3.org/1999/xhtml">fixtures work. </span><span class="koboSpan" id="kobo.1088.2" xmlns="http://www.w3.org/1999/xhtml">A fixture can create a file and return the path to the file in the form of a URL. </span><span class="koboSpan" id="kobo.1088.3" xmlns="http://www.w3.org/1999/xhtml">After the test, the fixture can remove the file.</span></p>
<p><span class="koboSpan" id="kobo.1089.1" xmlns="http://www.w3.org/1999/xhtml">A fixture with a test HTML page might look like this:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-61">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.1090.1" xmlns="http://www.w3.org/1999/xhtml">from pytest import fixture
from textwrap import dedent

@fixture
def example_1(tmp_path):
    html_page = tmp_path / "works.html"
    html_page.write_text(
        dedent("""\
        &lt;!DOCTYPE html&gt;
        &lt;html&gt;
        etc.
        </span><span class="koboSpan" id="kobo.1090.2" xmlns="http://www.w3.org/1999/xhtml">&lt;/html&gt;
        """
        )
    )
    yield f"file://{str(html_page)}"
    html_page.unlink()</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.1091.1" xmlns="http://www.w3.org/1999/xhtml">This fixture uses the </span><code><span class="koboSpan" id="kobo.1092.1" xmlns="http://www.w3.org/1999/xhtml">tmp_path</span></code><span class="koboSpan" id="kobo.1093.1" xmlns="http://www.w3.org/1999/xhtml"> fixture to provide access to a temporary directory used only for this test. </span><span class="koboSpan" id="kobo.1093.2" xmlns="http://www.w3.org/1999/xhtml">The file, </span><code><span class="koboSpan" id="kobo.1094.1" xmlns="http://www.w3.org/1999/xhtml">works.html</span></code><span class="koboSpan" id="kobo.1095.1" xmlns="http://www.w3.org/1999/xhtml">, is created, and filled with an HTML page. </span><span class="koboSpan" id="kobo.1095.2" xmlns="http://www.w3.org/1999/xhtml">The test case should include multiple </span><code><span class="koboSpan" id="kobo.1096.1" xmlns="http://www.w3.org/1999/xhtml">&lt;table&gt;</span></code><span class="koboSpan" id="kobo.1097.1" xmlns="http://www.w3.org/1999/xhtml"> tags, only one of which was the expected </span><code><span class="koboSpan" id="kobo.1098.1" xmlns="http://www.w3.org/1999/xhtml">&lt;caption&gt;</span></code><span class="koboSpan" id="kobo.1099.1" xmlns="http://www.w3.org/1999/xhtml"> tag.</span></p>
<p><span class="koboSpan" id="kobo.1100.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.1101.1" xmlns="http://www.w3.org/1999/xhtml">dedent()</span></code><span class="koboSpan" id="kobo.1102.1" xmlns="http://www.w3.org/1999/xhtml"> function is a handy way to </span><span id="dx1-104019"/><span class="koboSpan" id="kobo.1103.1" xmlns="http://www.w3.org/1999/xhtml">provide a long string that matches the prevailing Python indent. </span><span class="koboSpan" id="kobo.1103.2" xmlns="http://www.w3.org/1999/xhtml">The function removes the indenting whitespace from each line; the resulting text object is not indented.</span></p>
<p><span class="koboSpan" id="kobo.1104.1" xmlns="http://www.w3.org/1999/xhtml">The return value from this fixture is a URL that can be used by the </span><code><span class="koboSpan" id="kobo.1105.1" xmlns="http://www.w3.org/1999/xhtml">urlopen()</span></code><span class="koboSpan" id="kobo.1106.1" xmlns="http://www.w3.org/1999/xhtml"> function to open and read this file. </span><span class="koboSpan" id="kobo.1106.2" xmlns="http://www.w3.org/1999/xhtml">After the test is completed, the final step (after the </span><code><span class="koboSpan" id="kobo.1107.1" xmlns="http://www.w3.org/1999/xhtml">yield</span></code><span class="koboSpan" id="kobo.1108.1" xmlns="http://www.w3.org/1999/xhtml"> statement) will remove the file.</span></p>
<p><span class="koboSpan" id="kobo.1109.1" xmlns="http://www.w3.org/1999/xhtml">A test case might look something like the following:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-62">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.1110.1" xmlns="http://www.w3.org/1999/xhtml">def test_steps(example_1):
    soup = html_extract.get_page(example_1)
    table_tag = html_extract.find_table_caption(soup, "Anscombe’s quartet")
    rows = list(html_extract.table_row_data_iter(table_tag))
    assert rows == [
        [],
        [’Keep this’, ’Data’],
        [’And this’, ’Data’],
    ]</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.1111.1" xmlns="http://www.w3.org/1999/xhtml">The test case uses the </span><code><span class="koboSpan" id="kobo.1112.1" xmlns="http://www.w3.org/1999/xhtml">example_1</span></code><span class="koboSpan" id="kobo.1113.1" xmlns="http://www.w3.org/1999/xhtml"> fixture to create a file and return a URL referring to the file. </span><span class="koboSpan" id="kobo.1113.2" xmlns="http://www.w3.org/1999/xhtml">The URL is provided to a function </span><span id="dx1-104029"/><span class="koboSpan" id="kobo.1114.1" xmlns="http://www.w3.org/1999/xhtml">being tested. </span><span class="koboSpan" id="kobo.1114.2" xmlns="http://www.w3.org/1999/xhtml">The functions within the </span><code><span class="koboSpan" id="kobo.1115.1" xmlns="http://www.w3.org/1999/xhtml">html_extract</span></code><span class="koboSpan" id="kobo.1116.1" xmlns="http://www.w3.org/1999/xhtml"> module are used to parse the HTML, locate the target table, and extract the individual rows.</span></p>
<p><span class="koboSpan" id="kobo.1117.1" xmlns="http://www.w3.org/1999/xhtml">The return value tells us the functions work properly together to locate and extract data. </span><span class="koboSpan" id="kobo.1117.2" xmlns="http://www.w3.org/1999/xhtml">You are encouraged to work out the necessary HTML for good — and bad — examples.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="8.2.4.2" id="acceptance-tests-2">
<h4 class="likesubsubsectionHead" data-number="8.2.4.2"><span id="x1-1050004"/><span class="koboSpan" id="kobo.1118.1" xmlns="http://www.w3.org/1999/xhtml">Acceptance tests</span></h4>
<p><span class="koboSpan" id="kobo.1119.1" xmlns="http://www.w3.org/1999/xhtml">As noted above in </span><a href="#x1-1040004"><em><span class="koboSpan" id="kobo.1120.1" xmlns="http://www.w3.org/1999/xhtml">Unit test for the html</span></em><em><span class="koboSpan" id="kobo.1121.1" xmlns="http://www.w3.org/1999/xhtml">_extract module</span></em></a><span class="koboSpan" id="kobo.1122.1" xmlns="http://www.w3.org/1999/xhtml">, the acceptance test case HTML pages can be local files. </span><span class="koboSpan" id="kobo.1122.2" xmlns="http://www.w3.org/1999/xhtml">A scenario can provide a local </span><code><span class="koboSpan" id="kobo.1123.1" xmlns="http://www.w3.org/1999/xhtml">file://</span></code><span class="koboSpan" id="kobo.1124.1" xmlns="http://www.w3.org/1999/xhtml"> URL to the application </span><span id="dx1-105001"/><span class="koboSpan" id="kobo.1125.1" xmlns="http://www.w3.org/1999/xhtml">and confirm the output includes properly parsed data.</span></p>
<p><span class="koboSpan" id="kobo.1126.1" xmlns="http://www.w3.org/1999/xhtml">The Gherkin language </span><span id="dx1-105002"/><span class="koboSpan" id="kobo.1127.1" xmlns="http://www.w3.org/1999/xhtml">permits including large blocks of text as part of a scenario.</span></p>
<p><span class="koboSpan" id="kobo.1128.1" xmlns="http://www.w3.org/1999/xhtml">We can imagine writing the following kinds of scenarios in a feature file:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-63">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.1129.1" xmlns="http://www.w3.org/1999/xhtml">Scenario: Finds captioned table and extracts data
  Given an HTML page "example_1.html"
    """
      &lt;!DOCTYPE html&gt;
      &lt;html&gt;
        etc. </span><span class="koboSpan" id="kobo.1129.2" xmlns="http://www.w3.org/1999/xhtml">with multiple tables.
      </span><span class="koboSpan" id="kobo.1129.3" xmlns="http://www.w3.org/1999/xhtml">&lt;/html&gt;
    """
  When we run the html extract command
  Then log has INFO line with "header: [’Keep this’, ’Data’]"
  And log has INFO line with "count: 1"</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.1130.1" xmlns="http://www.w3.org/1999/xhtml">The HTML extract command is quite long. </span><span class="koboSpan" id="kobo.1130.2" xmlns="http://www.w3.org/1999/xhtml">The content is available as the </span><code><span class="koboSpan" id="kobo.1131.1" xmlns="http://www.w3.org/1999/xhtml">context.text</span></code><span class="koboSpan" id="kobo.1132.1" xmlns="http://www.w3.org/1999/xhtml"> parameter of the step definition function. </span><span class="koboSpan" id="kobo.1132.2" xmlns="http://www.w3.org/1999/xhtml">Here’s what the step definition for this given step looks like:</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1133.1" xmlns="http://www.w3.org/1999/xhtml">from textwrap import dedent

@given(u'an HTML page "{filename}"')
def step_impl(context, filename):
    context.path = Path(filename)
    context.path.write_text(dedent(context.text))
    context.add_cleanup(context.path.unlink)</span></pre>
<p><span class="koboSpan" id="kobo.1134.1" xmlns="http://www.w3.org/1999/xhtml">The step definition puts the path into the context and then writes the HTML page to the given path. </span><span class="koboSpan" id="kobo.1134.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.1135.1" xmlns="http://www.w3.org/1999/xhtml">dedent()</span></code><span class="koboSpan" id="kobo.1136.1" xmlns="http://www.w3.org/1999/xhtml"> function removes </span><span id="dx1-105021"/><span class="koboSpan" id="kobo.1137.1" xmlns="http://www.w3.org/1999/xhtml">any leading spaces that may have been left in place by the </span><strong><span class="koboSpan" id="kobo.1138.1" xmlns="http://www.w3.org/1999/xhtml">behave </span></strong><span class="koboSpan" id="kobo.1139.1" xmlns="http://www.w3.org/1999/xhtml">tool. </span><span class="koboSpan" id="kobo.1139.2" xmlns="http://www.w3.org/1999/xhtml">Since the path information is available in the context, it can be used by the </span><strong><span class="koboSpan" id="kobo.1140.1" xmlns="http://www.w3.org/1999/xhtml">When </span></strong><span class="koboSpan" id="kobo.1141.1" xmlns="http://www.w3.org/1999/xhtml">step. </span><span class="koboSpan" id="kobo.1141.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.1142.1" xmlns="http://www.w3.org/1999/xhtml">context.add_cleanup()</span></code><span class="koboSpan" id="kobo.1143.1" xmlns="http://www.w3.org/1999/xhtml"> function will add a function that can be used to clean up the file </span><span id="dx1-105022"/><span class="koboSpan" id="kobo.1144.1" xmlns="http://www.w3.org/1999/xhtml">when the scenario is finished. </span><span class="koboSpan" id="kobo.1144.2" xmlns="http://www.w3.org/1999/xhtml">An alternative is to use the environment module’s </span><code><span class="koboSpan" id="kobo.1145.1" xmlns="http://www.w3.org/1999/xhtml">after_scenario()</span></code><span class="koboSpan" id="kobo.1146.1" xmlns="http://www.w3.org/1999/xhtml"> function to clean up.</span></p>
<p><span class="koboSpan" id="kobo.1147.1" xmlns="http://www.w3.org/1999/xhtml">This scenario requires an actual path name for the supplied HTML page to be injected into the text. </span><span class="koboSpan" id="kobo.1147.2" xmlns="http://www.w3.org/1999/xhtml">For this to work out well, the step definition needs to build a command from pieces. </span><span class="koboSpan" id="kobo.1147.3" xmlns="http://www.w3.org/1999/xhtml">Here’s one approach:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-64">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.1148.1" xmlns="http://www.w3.org/1999/xhtml">@when(u’we run the html extract command’)
def step_impl(context):
    command = [
        ’python’, ’src/acquire.py’,
        ’-o’, ’quartet’,
        ’--page’, ’$URL’,
        ’--caption’, "Anscombe’s quartet"
    ]
    url = f"file://{str(context.path.absolute())}"
    command[command.index(’$URL’)] = url
    print(shlex.join(command))
    # etc. </span><span class="koboSpan" id="kobo.1148.2" xmlns="http://www.w3.org/1999/xhtml">with subprocess.run() to execute the command</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.1149.1" xmlns="http://www.w3.org/1999/xhtml">In this example, the command is broken down into individual parameter strings. </span><span class="koboSpan" id="kobo.1149.2" xmlns="http://www.w3.org/1999/xhtml">One of the strings must be replaced with the actual file name. </span><span class="koboSpan" id="kobo.1149.3" xmlns="http://www.w3.org/1999/xhtml">This works out nicely because the </span><code><span class="koboSpan" id="kobo.1150.1" xmlns="http://www.w3.org/1999/xhtml">subprocess.run()</span></code><span class="koboSpan" id="kobo.1151.1" xmlns="http://www.w3.org/1999/xhtml"> function works </span><span id="dx1-105035"/><span class="koboSpan" id="kobo.1152.1" xmlns="http://www.w3.org/1999/xhtml">well with a parsed shell command. </span><span class="koboSpan" id="kobo.1152.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.1153.1" xmlns="http://www.w3.org/1999/xhtml">shlex.split()</span></code><span class="koboSpan" id="kobo.1154.1" xmlns="http://www.w3.org/1999/xhtml"> function can be used to decompose a line, honoring the complex quoting rules of the shell, into individual parameter strings.</span></p>
<p><span class="koboSpan" id="kobo.1155.1" xmlns="http://www.w3.org/1999/xhtml">Now that we have an </span><span id="dx1-105036"/><span class="koboSpan" id="kobo.1156.1" xmlns="http://www.w3.org/1999/xhtml">acceptance test suite, we may find the </span><code><span class="koboSpan" id="kobo.1157.1" xmlns="http://www.w3.org/1999/xhtml">acquire</span></code><span class="koboSpan" id="kobo.1158.1" xmlns="http://www.w3.org/1999/xhtml"> application doesn’t pass all of the tests. </span><span class="koboSpan" id="kobo.1158.2" xmlns="http://www.w3.org/1999/xhtml">It’s helpful to define done via an acceptance test and then develop the required HTML extract module and refactor the main application. </span><span class="koboSpan" id="kobo.1158.3" xmlns="http://www.w3.org/1999/xhtml">We’ll look at these two components next.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="8.2.4.3" id="html-extract-module-and-refactored-main-application">
<h4 class="likesubsubsectionHead" data-number="8.2.4.3"><span id="x1-1060004"/><span class="koboSpan" id="kobo.1159.1" xmlns="http://www.w3.org/1999/xhtml">HTML extract module and refactored main application</span></h4>
<p><span class="koboSpan" id="kobo.1160.1" xmlns="http://www.w3.org/1999/xhtml">The goal for this </span><span id="dx1-106001"/><span class="koboSpan" id="kobo.1161.1" xmlns="http://www.w3.org/1999/xhtml">project is two-fold:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.1162.1" xmlns="http://www.w3.org/1999/xhtml">Add an </span><code><span class="koboSpan" id="kobo.1163.1" xmlns="http://www.w3.org/1999/xhtml">html_extract.py</span></code><span class="koboSpan" id="kobo.1164.1" xmlns="http://www.w3.org/1999/xhtml"> module. </span><span class="koboSpan" id="kobo.1164.2" xmlns="http://www.w3.org/1999/xhtml">The unit tests will confirm this module works.</span></p></li>
<li><p><span class="koboSpan" id="kobo.1165.1" xmlns="http://www.w3.org/1999/xhtml">Rewrite the </span><code><span class="koboSpan" id="kobo.1166.1" xmlns="http://www.w3.org/1999/xhtml">acquire.py</span></code><span class="koboSpan" id="kobo.1167.1" xmlns="http://www.w3.org/1999/xhtml"> module from </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.1168.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.1169.1" xmlns="http://www.w3.org/1999/xhtml"> 3</span></em></a><span class="koboSpan" id="kobo.1170.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.1171.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.1: Data</span></em> <em><span class="koboSpan" id="kobo.1172.1" xmlns="http://www.w3.org/1999/xhtml">Acquisition Base Application</span></em></a><span class="koboSpan" id="kobo.1173.1" xmlns="http://www.w3.org/1999/xhtml"> to add the HTML download and extract the feature.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.1174.1" xmlns="http://www.w3.org/1999/xhtml">The </span><a href="#x1-1000003"><em><span class="koboSpan" id="kobo.1175.1" xmlns="http://www.w3.org/1999/xhtml">Approach</span></em></a><span class="koboSpan" id="kobo.1176.1" xmlns="http://www.w3.org/1999/xhtml"> section provides some design guidance for building the application. </span><span class="koboSpan" id="kobo.1176.2" xmlns="http://www.w3.org/1999/xhtml">Additionally, the previous chapter, </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.1177.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.1178.1" xmlns="http://www.w3.org/1999/xhtml"> 3</span></em></a><span class="koboSpan" id="kobo.1179.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.1180.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.1: Data Acquisition Base</span></em> <em><span class="koboSpan" id="kobo.1181.1" xmlns="http://www.w3.org/1999/xhtml">Application</span></em></a><span class="koboSpan" id="kobo.1182.1" xmlns="http://www.w3.org/1999/xhtml">, provides the baseline application into which the new acquisition features should be added.</span></p>
<p><span class="koboSpan" id="kobo.1183.1" xmlns="http://www.w3.org/1999/xhtml">The acceptance tests will confirm the application works correctly to gather data from the Kaggle API.</span></p>
<p><span class="koboSpan" id="kobo.1184.1" xmlns="http://www.w3.org/1999/xhtml">Given this extended capability, you can hunt for data sets that are presented in web pages. </span><span class="koboSpan" id="kobo.1184.2" xmlns="http://www.w3.org/1999/xhtml">Because of the consistency of Wikipedia, it is a good source of data. </span><span class="koboSpan" id="kobo.1184.3" xmlns="http://www.w3.org/1999/xhtml">Many other sites provide relatively consistent HTML tables with interesting data.</span></p>
<p><span class="koboSpan" id="kobo.1185.1" xmlns="http://www.w3.org/1999/xhtml">In these two projects, we’ve extended our ability to acquire data from a wide variety of sources. </span><span id="x1-106002r105"/></p>
</section>
</section>
</section>
<section class="level2" data-number="8.3" id="summary-3">
<h2 data-number="8.3"><span class="titlemark"><span class="koboSpan" id="kobo.1186.1" xmlns="http://www.w3.org/1999/xhtml">4.3 </span></span> <span id="x1-1070003"/><span class="koboSpan" id="kobo.1187.1" xmlns="http://www.w3.org/1999/xhtml">Summary</span></h2>
<p><span class="koboSpan" id="kobo.1188.1" xmlns="http://www.w3.org/1999/xhtml">This chapter’s projects have shown examples of the following features of a data acquisition application:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.1189.1" xmlns="http://www.w3.org/1999/xhtml">Web API integration via the </span><strong><span class="koboSpan" id="kobo.1190.1" xmlns="http://www.w3.org/1999/xhtml">requests </span></strong><span class="koboSpan" id="kobo.1191.1" xmlns="http://www.w3.org/1999/xhtml">package. </span><span class="koboSpan" id="kobo.1191.2" xmlns="http://www.w3.org/1999/xhtml">We’ve used the Kaggle API as an example of a RESTful API that provides data for download and analysis.</span></p></li>
<li><p><span class="koboSpan" id="kobo.1192.1" xmlns="http://www.w3.org/1999/xhtml">Parsing an HTML web page using the </span><strong><span class="koboSpan" id="kobo.1193.1" xmlns="http://www.w3.org/1999/xhtml">Beautiful Soup </span></strong><span class="koboSpan" id="kobo.1194.1" xmlns="http://www.w3.org/1999/xhtml">package.</span></p></li>
<li><p><span class="koboSpan" id="kobo.1195.1" xmlns="http://www.w3.org/1999/xhtml">Adding features to an existing application and extending the test suite to cover these new alternative data sources.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.1196.1" xmlns="http://www.w3.org/1999/xhtml">A challenging part of both of these projects is creating a suite of acceptance tests to describe the proper behavior. </span><span class="koboSpan" id="kobo.1196.2" xmlns="http://www.w3.org/1999/xhtml">Pragmatically, a program without automated tests cannot be trusted. </span><span class="koboSpan" id="kobo.1196.3" xmlns="http://www.w3.org/1999/xhtml">The tests are every bit as important as the code they’re exercising.</span></p>
<p><span class="koboSpan" id="kobo.1197.1" xmlns="http://www.w3.org/1999/xhtml">In some enterprises, the definition of done is breezy and informal. </span><span class="koboSpan" id="kobo.1197.2" xmlns="http://www.w3.org/1999/xhtml">There may be a presentation or an internal memo or a whitepaper that describes the desired software. </span><span class="koboSpan" id="kobo.1197.3" xmlns="http://www.w3.org/1999/xhtml">Formalizing these concepts into tangible test cases is often a significant effort. </span><span class="koboSpan" id="kobo.1197.4" xmlns="http://www.w3.org/1999/xhtml">Achieving agreements can become a source of turmoil as stakeholders slowly refine their understanding of how the software will behave.</span></p>
<p><span class="koboSpan" id="kobo.1198.1" xmlns="http://www.w3.org/1999/xhtml">Creating mock web services is fraught with difficulty. </span><span class="koboSpan" id="kobo.1198.2" xmlns="http://www.w3.org/1999/xhtml">Some API’s permit downloading an </span><code><span class="koboSpan" id="kobo.1199.1" xmlns="http://www.w3.org/1999/xhtml">openapi.json</span></code><span class="koboSpan" id="kobo.1200.1" xmlns="http://www.w3.org/1999/xhtml"> file with the definition of the API complete with examples. </span><span class="koboSpan" id="kobo.1200.2" xmlns="http://www.w3.org/1999/xhtml">Having concrete examples, provided by the host of the API, makes it much easier to create a mock service. </span><span class="koboSpan" id="kobo.1200.3" xmlns="http://www.w3.org/1999/xhtml">A mock server can load the JSON specification, navigate to the example, and provide the official response.</span></p>
<p><span class="koboSpan" id="kobo.1201.1" xmlns="http://www.w3.org/1999/xhtml">Lacking an OpenAPI specification with examples, developers need to write spike solutions that download detailed responses. </span><span class="koboSpan" id="kobo.1201.2" xmlns="http://www.w3.org/1999/xhtml">These responses can then be used to build mock objects. </span><span class="koboSpan" id="kobo.1201.3" xmlns="http://www.w3.org/1999/xhtml">You are strongly encouraged to write side-bar applications to explore the Kaggle API to see how it works.</span></p>
<p><span class="koboSpan" id="kobo.1202.1" xmlns="http://www.w3.org/1999/xhtml">In the next chapter, we’ll continue this data extraction journey to include extracting data from SQL databases. </span><span class="koboSpan" id="kobo.1202.2" xmlns="http://www.w3.org/1999/xhtml">Once we’ve acquired data, we’ll want to inspect it. </span><a href="ch010.xhtml#x1-1460006"><em><span class="koboSpan" id="kobo.1203.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.1204.1" xmlns="http://www.w3.org/1999/xhtml"> 6</span></em></a><span class="koboSpan" id="kobo.1205.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch010.xhtml#x1-1460006"><em><span class="koboSpan" id="kobo.1206.1" xmlns="http://www.w3.org/1999/xhtml">Project 2.1: Data Inspection Notebook</span></em></a><span class="koboSpan" id="kobo.1207.1" xmlns="http://www.w3.org/1999/xhtml">, will introduce an inspection step. </span><span id="x1-107001r116"/></p>
</section>
<section class="level2" data-number="8.4" id="extras-2">
<h2 data-number="8.4"><span class="titlemark"><span class="koboSpan" id="kobo.1208.1" xmlns="http://www.w3.org/1999/xhtml">4.4 </span></span> <span id="x1-1080004"/><span class="koboSpan" id="kobo.1209.1" xmlns="http://www.w3.org/1999/xhtml">Extras</span></h2>
<p><span class="koboSpan" id="kobo.1210.1" xmlns="http://www.w3.org/1999/xhtml">Here are some ideas for you to add to these projects. </span><span id="x1-108001r112"/></p>
<section class="level3" data-number="8.4.1" id="locate-more-json-format-data">
<h3 data-number="8.4.1"><span class="titlemark"><span class="koboSpan" id="kobo.1211.1" xmlns="http://www.w3.org/1999/xhtml">4.4.1 </span></span> <span id="x1-1090001"/><span class="koboSpan" id="kobo.1212.1" xmlns="http://www.w3.org/1999/xhtml">Locate more JSON-format data</span></h3>
<p><span class="koboSpan" id="kobo.1213.1" xmlns="http://www.w3.org/1999/xhtml">A search of Kaggle will turn up some other interesting data sets in JSON format.</span></p>
<ul>
<li><p><a class="url" href="https://www.kaggle.com/datasets/rtatman/iris-dataset-json-version"><span class="koboSpan" id="kobo.1214.1" xmlns="http://www.w3.org/1999/xhtml">https://www.kaggle.com/datasets/rtatman/iris-dataset-json-version</span></a><span class="koboSpan" id="kobo.1215.1" xmlns="http://www.w3.org/1999/xhtml">: This data set is famous and available in a number of distinct formats.</span></p></li>
<li><p><a class="url" href="https://www.kaggle.com/datasets/conoor/stack-overflow-tags-usage"><span class="koboSpan" id="kobo.1216.1" xmlns="http://www.w3.org/1999/xhtml">https://www.kaggle.com/datasets/conoor/stack-overflow-tags-usage</span></a></p></li>
<li><p><a class="url" href="https://www.kaggle.com/datasets/queyrusi/the-warship-dataset"><span class="koboSpan" id="kobo.1217.1" xmlns="http://www.w3.org/1999/xhtml">https://www.kaggle.com/datasets/queyrusi/the-warship-dataset</span></a></p></li>
</ul>
<p><span class="koboSpan" id="kobo.1218.1" xmlns="http://www.w3.org/1999/xhtml">One of these is a JSON download. </span><span class="koboSpan" id="kobo.1218.2" xmlns="http://www.w3.org/1999/xhtml">The other two are ZIP archives that contain JSON-format content.</span></p>
<p><span class="koboSpan" id="kobo.1219.1" xmlns="http://www.w3.org/1999/xhtml">This will require revising the application’s architecture to extract the JSON format data instead of CSV format data.</span></p>
<p><span class="koboSpan" id="kobo.1220.1" xmlns="http://www.w3.org/1999/xhtml">An interesting complication here is the distinction between CSV data and JSON data:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.1221.1" xmlns="http://www.w3.org/1999/xhtml">CSV data is pure text, and later conversions are required to make useful Python objects.</span></p></li>
<li><p><span class="koboSpan" id="kobo.1222.1" xmlns="http://www.w3.org/1999/xhtml">Some JSON data is converted to Python objects by the parser. </span><span class="koboSpan" id="kobo.1222.2" xmlns="http://www.w3.org/1999/xhtml">Some data (like datestamps) will be left as text.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.1223.1" xmlns="http://www.w3.org/1999/xhtml">At acquisition time, this doesn’t have a significant impact. </span><span class="koboSpan" id="kobo.1223.2" xmlns="http://www.w3.org/1999/xhtml">However, when we get to </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.1224.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.1225.1" xmlns="http://www.w3.org/1999/xhtml"> 9</span></em></a><span class="koboSpan" id="kobo.1226.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch013.xhtml#x1-2080009"><em><span class="koboSpan" id="kobo.1227.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.1: Data Cleaning Base Application</span></em></a><span class="koboSpan" id="kobo.1228.1" xmlns="http://www.w3.org/1999/xhtml">, we’ll have to account for data in a text-only form distinct from data with some conversions applied.</span></p>
<p><span class="koboSpan" id="kobo.1229.1" xmlns="http://www.w3.org/1999/xhtml">The Iris data set is quite famous. </span><span class="koboSpan" id="kobo.1229.2" xmlns="http://www.w3.org/1999/xhtml">You can expand on the designs in this chapter to acquire Iris data from a variety of sources. </span><span class="koboSpan" id="kobo.1229.3" xmlns="http://www.w3.org/1999/xhtml">The following steps could be followed:</span></p>
<ol>
<li><div id="x1-109002x1">
<p><span class="koboSpan" id="kobo.1230.1" xmlns="http://www.w3.org/1999/xhtml">Start with the Kaggle data set in JSON format. </span><span class="koboSpan" id="kobo.1230.2" xmlns="http://www.w3.org/1999/xhtml">Build the needed model, and extract modules to work with this format.</span></p>
</div></li>
<li><div id="x1-109004x2">
<p><span class="koboSpan" id="kobo.1231.1" xmlns="http://www.w3.org/1999/xhtml">Locate other versions of this data set in other formats. </span><span class="koboSpan" id="kobo.1231.2" xmlns="http://www.w3.org/1999/xhtml">Build the needed extract modules to work with these alternative formats.</span></p>
</div></li>
</ol>
<p><span class="koboSpan" id="kobo.1232.1" xmlns="http://www.w3.org/1999/xhtml">Once a core acquisition project is complete, you can leverage this other famous data set as an implementation choice for later projects. </span><span id="x1-109005r118"/></p>
</section>
<section class="level3" data-number="8.4.2" id="other-data-sets-to-extract">
<h3 data-number="8.4.2"><span class="titlemark"><span class="koboSpan" id="kobo.1233.1" xmlns="http://www.w3.org/1999/xhtml">4.4.2 </span></span> <span id="x1-1100002"/><span class="koboSpan" id="kobo.1234.1" xmlns="http://www.w3.org/1999/xhtml">Other data sets to extract</span></h3>
<p><span class="koboSpan" id="kobo.1235.1" xmlns="http://www.w3.org/1999/xhtml">See the </span><strong><span class="koboSpan" id="kobo.1236.1" xmlns="http://www.w3.org/1999/xhtml">CO</span></strong><strong><span class="koboSpan" id="kobo.1237.1" xmlns="http://www.w3.org/1999/xhtml">2</span></strong> <strong><span class="koboSpan" id="kobo.1238.1" xmlns="http://www.w3.org/1999/xhtml">PPM — Trends in Atmospheric Carbon Dioxide </span></strong><span class="koboSpan" id="kobo.1239.1" xmlns="http://www.w3.org/1999/xhtml">data set, available at </span><a class="url" href="https://datahub.io/core/co2-ppm"><span class="koboSpan" id="kobo.1240.1" xmlns="http://www.w3.org/1999/xhtml">https://datahub.io/core/co2-ppm</span></a><span class="koboSpan" id="kobo.1241.1" xmlns="http://www.w3.org/1999/xhtml">, for some data that is somewhat larger. </span><span class="koboSpan" id="kobo.1241.2" xmlns="http://www.w3.org/1999/xhtml">This page has a link to an HTML table with the data.</span></p>
<p><span class="koboSpan" id="kobo.1242.1" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://datahub.io/core/co2-ppm/r/0.html"><span class="koboSpan" id="kobo.1243.1" xmlns="http://www.w3.org/1999/xhtml">https://datahub.io/core/co2-ppm/r/0.html</span></a><span class="koboSpan" id="kobo.1244.1" xmlns="http://www.w3.org/1999/xhtml"> for a page with the complete data set as an HTML table. </span><span class="koboSpan" id="kobo.1244.2" xmlns="http://www.w3.org/1999/xhtml">This data set is larger and more complicated than Anscombe’s Quartet. </span><span class="koboSpan" id="kobo.1244.3" xmlns="http://www.w3.org/1999/xhtml">In </span><a href="ch010.xhtml#x1-1460006"><em><span class="koboSpan" id="kobo.1245.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.1246.1" xmlns="http://www.w3.org/1999/xhtml"> 6</span></em></a><span class="koboSpan" id="kobo.1247.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch010.xhtml#x1-1460006"><em><span class="koboSpan" id="kobo.1248.1" xmlns="http://www.w3.org/1999/xhtml">Project 2.1: Data</span></em> <em><span class="koboSpan" id="kobo.1249.1" xmlns="http://www.w3.org/1999/xhtml">Inspection Notebook</span></em></a><span class="koboSpan" id="kobo.1250.1" xmlns="http://www.w3.org/1999/xhtml">, we’ll address some of the special cases in this data set. </span><span id="x1-110001r119"/></p>
</section>
<section class="level3" data-number="8.4.3" id="handling-schema-variations">
<h3 data-number="8.4.3"><span class="titlemark"><span class="koboSpan" id="kobo.1251.1" xmlns="http://www.w3.org/1999/xhtml">4.4.3 </span></span> <span id="x1-1110003"/><span class="koboSpan" id="kobo.1252.1" xmlns="http://www.w3.org/1999/xhtml">Handling schema variations</span></h3>
<p><span class="koboSpan" id="kobo.1253.1" xmlns="http://www.w3.org/1999/xhtml">The two projects in this chapter each reflect a distinct schema for the source data.</span></p>
<p><span class="koboSpan" id="kobo.1254.1" xmlns="http://www.w3.org/1999/xhtml">One CSV format can be depicted via an </span><strong><span class="koboSpan" id="kobo.1255.1" xmlns="http://www.w3.org/1999/xhtml">Entity-Relationship Diagram</span></strong><span class="koboSpan" id="kobo.1256.1" xmlns="http://www.w3.org/1999/xhtml"> (</span><strong><span class="koboSpan" id="kobo.1257.1" xmlns="http://www.w3.org/1999/xhtml">ERD</span></strong><span class="koboSpan" id="kobo.1258.1" xmlns="http://www.w3.org/1999/xhtml">), shown in </span><a href="#4.5"><em><span class="koboSpan" id="kobo.1259.1" xmlns="http://www.w3.org/1999/xhtml">Figure 4.5</span></em></a><em><span class="koboSpan" id="kobo.1260.1" xmlns="http://www.w3.org/1999/xhtml">.</span></em></p>
<figure class="IMG---Figure">
<span class="koboSpan" id="kobo.1261.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 4.5: Source entity-relationship diagram " src="../media/file22.jpg"/></span>
<figcaption class="IMG---Caption"><span class="id" id="4.5"><span class="koboSpan" id="kobo.1262.1" xmlns="http://www.w3.org/1999/xhtml">Figure 4.5: </span></span><span class="content"><span class="koboSpan" id="kobo.1263.1" xmlns="http://www.w3.org/1999/xhtml">Source entity-relationship diagram </span></span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.1264.1" xmlns="http://www.w3.org/1999/xhtml">One column, </span><code><span class="koboSpan" id="kobo.1265.1" xmlns="http://www.w3.org/1999/xhtml">x_123</span></code><span class="koboSpan" id="kobo.1266.1" xmlns="http://www.w3.org/1999/xhtml">, is the x-value of three distinct series. </span><span class="koboSpan" id="kobo.1266.2" xmlns="http://www.w3.org/1999/xhtml">Another column, </span><code><span class="koboSpan" id="kobo.1267.1" xmlns="http://www.w3.org/1999/xhtml">x_4</span></code><span class="koboSpan" id="kobo.1268.1" xmlns="http://www.w3.org/1999/xhtml">, is the x-value for one series.</span></p>
<p><span class="koboSpan" id="kobo.1269.1" xmlns="http://www.w3.org/1999/xhtml">A depiction of the HTML format as an ERD is shown in </span><a href="#4.6"><em><span class="koboSpan" id="kobo.1270.1" xmlns="http://www.w3.org/1999/xhtml">Figure 4.6</span></em></a><em><span class="koboSpan" id="kobo.1271.1" xmlns="http://www.w3.org/1999/xhtml">.</span></em></p>
<figure class="IMG---Figure">
<span class="koboSpan" id="kobo.1272.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 4.6: Notional entity-relationship diagram " src="../media/file23.jpg"/></span>
<figcaption class="IMG---Caption"><span class="id" id="4.6"><span class="koboSpan" id="kobo.1273.1" xmlns="http://www.w3.org/1999/xhtml">Figure 4.6: </span></span><span class="content"><span class="koboSpan" id="kobo.1274.1" xmlns="http://www.w3.org/1999/xhtml">Notional entity-relationship diagram </span></span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.1275.1" xmlns="http://www.w3.org/1999/xhtml">The x-values are repeated as needed.</span></p>
<p><span class="koboSpan" id="kobo.1276.1" xmlns="http://www.w3.org/1999/xhtml">This difference requires several distinct approaches to extracting the source data.</span></p>
<p><span class="koboSpan" id="kobo.1277.1" xmlns="http://www.w3.org/1999/xhtml">In these projects, we’ve implemented this distinction as distinct subclasses of a </span><code><span class="koboSpan" id="kobo.1278.1" xmlns="http://www.w3.org/1999/xhtml">PairBuilder</span></code><span class="koboSpan" id="kobo.1279.1" xmlns="http://www.w3.org/1999/xhtml"> superclass.</span></p>
<p><span class="koboSpan" id="kobo.1280.1" xmlns="http://www.w3.org/1999/xhtml">An alternative design is to create distinct functions with a common type signature:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-65">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.1281.1" xmlns="http://www.w3.org/1999/xhtml">    PairBuilder: TypeVar = Callable[[list[str]], XYPair]</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.1282.1" xmlns="http://www.w3.org/1999/xhtml">Making each conversion a function eliminates the overhead of the class definition.</span></p>
<p><span class="koboSpan" id="kobo.1283.1" xmlns="http://www.w3.org/1999/xhtml">This rewrite can be a large simplification. </span><span class="koboSpan" id="kobo.1283.2" xmlns="http://www.w3.org/1999/xhtml">It will not change any acceptance tests. </span><span class="koboSpan" id="kobo.1283.3" xmlns="http://www.w3.org/1999/xhtml">It will, however, require numerous changes to unit tests.</span></p>
<p><span class="koboSpan" id="kobo.1284.1" xmlns="http://www.w3.org/1999/xhtml">The functional design offers some simplification over class-based design. </span><span class="koboSpan" id="kobo.1284.2" xmlns="http://www.w3.org/1999/xhtml">You are encouraged to perform the functional redesign of the suggestions in this book. </span><span id="x1-111006r120"/></p>
</section>
<section class="level3" data-number="8.4.4" id="cli-enhancements">
<h3 data-number="8.4.4"><span class="titlemark"><span class="koboSpan" id="kobo.1285.1" xmlns="http://www.w3.org/1999/xhtml">4.4.4 </span></span> <span id="x1-1120004"/><span class="koboSpan" id="kobo.1286.1" xmlns="http://www.w3.org/1999/xhtml">CLI enhancements</span></h3>
<p><span class="koboSpan" id="kobo.1287.1" xmlns="http://www.w3.org/1999/xhtml">The CLI for these two projects is left wide open, permitting a great deal of design flexibility and alternatives. </span><span class="koboSpan" id="kobo.1287.2" xmlns="http://www.w3.org/1999/xhtml">Because the CLI is part of externally visible behavior, it becomes necessary to write acceptance tests for the various CLI options and arguments.</span></p>
<p><span class="koboSpan" id="kobo.1288.1" xmlns="http://www.w3.org/1999/xhtml">As noted in </span><a href="ch007.xhtml#x1-670002"><em><span class="koboSpan" id="kobo.1289.1" xmlns="http://www.w3.org/1999/xhtml">Additional acceptance scenarios</span></em></a><span class="koboSpan" id="kobo.1290.1" xmlns="http://www.w3.org/1999/xhtml">, there are a number of acceptance test scenarios that are not on the ”happy path” where the application works. </span><span class="koboSpan" id="kobo.1290.2" xmlns="http://www.w3.org/1999/xhtml">These additional scenarios serve to catalog a number of erroneous uses of the application.</span></p>
<p><span class="koboSpan" id="kobo.1291.1" xmlns="http://www.w3.org/1999/xhtml">This becomes more important as more features are added and the CLI becomes more complicated. </span><span class="koboSpan" id="kobo.1291.2" xmlns="http://www.w3.org/1999/xhtml">You are encouraged to write acceptance tests for invalid CLI use. </span><span id="x1-112001r123"/></p>
</section>
<section class="level3" data-number="8.4.5" id="logging-1">
<h3 data-number="8.4.5"><span class="titlemark"><span class="koboSpan" id="kobo.1292.1" xmlns="http://www.w3.org/1999/xhtml">4.4.5 </span></span> <span id="x1-1130005"/><span class="koboSpan" id="kobo.1293.1" xmlns="http://www.w3.org/1999/xhtml">Logging</span></h3>
<p><span class="koboSpan" id="kobo.1294.1" xmlns="http://www.w3.org/1999/xhtml">Logging is an important part of data acquisition. </span><span class="koboSpan" id="kobo.1294.2" xmlns="http://www.w3.org/1999/xhtml">There are a number of potential problems exposed by these two projects. </span><span class="koboSpan" id="kobo.1294.3" xmlns="http://www.w3.org/1999/xhtml">A website might be unresponsive, or the API may have changed. </span><span class="koboSpan" id="kobo.1294.4" xmlns="http://www.w3.org/1999/xhtml">The HTML may have been reformatted in some subtle way.</span></p>
<p><span class="koboSpan" id="kobo.1295.1" xmlns="http://www.w3.org/1999/xhtml">A </span><em><span class="koboSpan" id="kobo.1296.1" xmlns="http://www.w3.org/1999/xhtml">debug </span></em><span class="koboSpan" id="kobo.1297.1" xmlns="http://www.w3.org/1999/xhtml">or </span><em><span class="koboSpan" id="kobo.1298.1" xmlns="http://www.w3.org/1999/xhtml">verbose </span></em><span class="koboSpan" id="kobo.1299.1" xmlns="http://www.w3.org/1999/xhtml">mode should be available to expose the interactions with external services to be sure of the HTTP status codes and headers.</span></p>
<p><span class="koboSpan" id="kobo.1300.1" xmlns="http://www.w3.org/1999/xhtml">Additionally, count values should be displayed to summarize the bytes downloaded, the lines of text examined, and the number of </span><code><span class="koboSpan" id="kobo.1301.1" xmlns="http://www.w3.org/1999/xhtml">XYPair</span></code><span class="koboSpan" id="kobo.1302.1" xmlns="http://www.w3.org/1999/xhtml"> objects created. </span><span class="koboSpan" id="kobo.1302.2" xmlns="http://www.w3.org/1999/xhtml">The idea is to characterize the inputs, the various processing steps, and the outputs.</span></p>
<p><span class="koboSpan" id="kobo.1303.1" xmlns="http://www.w3.org/1999/xhtml">These counts are essential for confirming that data is processed and filtered correctly. </span><span class="koboSpan" id="kobo.1303.2" xmlns="http://www.w3.org/1999/xhtml">They’re an important tool for making parts of the processing more observable. </span><span class="koboSpan" id="kobo.1303.3" xmlns="http://www.w3.org/1999/xhtml">A user wants to confirm that all of the downloaded data is either part of the results or filtered and discarded for a good reason.</span></p>
<p><span class="koboSpan" id="kobo.1304.1" xmlns="http://www.w3.org/1999/xhtml">You are encouraged to include counts for input, processing, and output in the log. </span><span id="x1-113001r83"/></p>
</section>
</section>
</section>
</body>
</html>
