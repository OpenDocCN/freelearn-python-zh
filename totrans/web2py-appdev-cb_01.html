<html><head></head><body>
  <div><div><div><div><div><h1 class="title"><a id="ch01"/>Chapter 1. Deploying web2py</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div><ul class="itemizedlist"><li class="listitem"><p>Installing web2py on Windows (from source code)</p></li><li class="listitem"><p>Installing web2py on Ubuntu</p></li><li class="listitem"><p>Setting up a production deployment on Ubuntu</p></li><li class="listitem"><p>Running web2py with Apache,<code class="literal"> mod_proxy</code>, and<code class="literal"> mod_rewrite</code>
</p></li><li class="listitem"><p>Running web2py with<code class="literal"> Lighttpd</code>
</p></li><li class="listitem"><p>Running web2py with Cherokee</p></li><li class="listitem"><p>Running web2py with Nginx and uWSGI</p></li><li class="listitem"><p>Running web2py on shared hosts using CGI</p></li><li class="listitem"><p>Running web2py on shared hosts with<code class="literal"> mod_proxy</code>
</p></li><li class="listitem"><p>Running web2py from a user-defined folder</p></li><li class="listitem"><p>Installing web2py as a service in Ubuntu</p></li><li class="listitem"><p>Running web2py with IIS as proxy</p></li><li class="listitem"><p>Running web2py with ISAPI</p></li></ul></div><div><div><div><div><h1 class="title"><a id="ch01lvl1sec01"/>Introduction</h1></div></div></div><p>In this chapter, we discuss how to download, set up, and install web2py in different systems and with different web servers.</p><div><h3 class="title"><a id="note02"/>Note</h3><p>All of them require that you download the latest web2py source from the website:<a class="ulink" href="http://web2py.com"> http://web2py.com</a>, unzip it under<code class="literal"> /home/www-data/web2py</code> on Unix and Linux systems, and on<code class="literal"> c:/web2py</code> on Windows systems. In various places, we will assume that the public IP address of the host machine is<code class="literal"> 192.168.1.1</code>; replace this with your own IP address or host name. We will also assume web2py starts on port<code class="literal"> 8000</code>, but there is nothing special about this number; change it if you need to.</p></div></div><div><div><div><div><h1 class="title"><a id="ch01lvl1sec02"/>Installing web2py on Windows (from source code)</h1></div></div></div><p>Although there is a binary distribution for Windows environments (packaging executables and standard libraries), web2py is open source, and can be used with a normal Python installation.<a id="id0" class="indexterm"/>
</p><p>This method allows working with the latest releases of web2py, and customizing the python modules to be used.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec01"/>Getting ready</h2></div></div></div><p>First of all, you must install<strong> Python</strong>. Download your preferred 2.x version (not 3.x) from:<a class="ulink" href="http://www.python.org/download/releases/"> http://www.python.org/download/releases/</a>.<a id="id1" class="indexterm"/>
</p><p>Although newer versions include more enhancements and bug fixes, previous versions have more stability and third-party library coverage. Python 2.5.4 has a good balance within features and proven stability history, with good binary libraries support. Python 2.7.2 is the latest production release for this platform at the time of this writing, so we will use it for the examples.</p><p>After downloading your preferred Windows Python installer (that is<strong> python-2.7.2.msi)</strong>, double-click to install it. The default values are fine for most cases, so press<strong> Next</strong> until it finishes the installation.</p><p>You will need<strong> Python Win32 extensions</strong> to use the web2py taskbar or Windows service. You can install<strong> pywin32</strong> from:<a class="ulink" href="http://starship.python.net/~skippy/win32/Downloads.html"> http://starship.python.net/~skippy/win32/Downloads.html</a>.<a id="id2" class="indexterm"/>
</p><p>Prior to using web2py, you may also need some dependencies to connect to databases. SQLite and MySQL drivers are included in web2py. If you plan to use another RDBMS, you will need to install its driver.</p><p>For<strong> PostgreSQL</strong>, you can install the<strong> psycopg2</strong> binary package (for Python 2.7, you should use<code class="literal"> psycopg2-2.3.1.win32-py2.7-pg9.0.1-release.exe):</code>
<a class="ulink" href="http://www.stickpeople.com/projects/python/win-psycopg/">http://www.stickpeople.com/projects/python/win-psycopg/</a> (notice that web2py requires<strong> psycopg2</strong> and not<strong> psycopg)</strong>.<a id="id3" class="indexterm"/>
</p><p>For MS SQLServer or DB2, you need<strong> pyodbc:</strong>
<a class="ulink" href="http://code.google.com/p/pyodbc/downloads/list%20">http://code.google.com/p/pyodbc/downloads/list </a>.
<a id="id4" class="indexterm"/>
</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec02"/>How to do it...</h2></div></div></div><p>At this point, you can use web2py with your preferred database.</p><div><ol class="orderedlist"><li class="listitem"><p>Download the source package from web2py official website:<a class="ulink" href="http://www.web2py.com/examples/static/web2py_src.zip"> http://www.web2py.com/examples/static/web2py_src.zip</a>, and unzip it.<a id="id5" class="indexterm"/>
</p><p>As web2py doesn't requires installation, you can unzip it in any folder. Using <code class="literal">c:\web2py</code> is convenient, to keep pathnames short.
</p></li><li class="listitem"><p>To start it, double-click<code class="literal"> web2py.py</code>. You can also start it from the console:</p><div><pre class="programlisting"><strong>cd c:\web2py
c:\python27\python.exe web2py.py</strong>
</pre></div></li><li class="listitem"><p>Here you can add command-line parameters (<code class="literal">-a</code> to set an admin password,<code class="literal"> -p</code> to specify an alternate port, and so on). You can see all the startup options with:</p></li></ol></div><div><pre class="programlisting"><strong>C:\web2py&gt;c:\python27\python.exe web2py.py --help</strong>
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec03"/>How it works...</h2></div></div></div><p>web2py is written in Python, a portable, interpreted and dynamic language that doesn't require compilation or complicated installation to run. It uses a virtual machine (such as Java and .Net), and it can transparently byte-compile your source code on the fly when you run your scripts.</p><p>For novice users' convenience, there is web2py Windows binary distribution available at the official site, which is precompiled to a bytecode, packaged in a zip file with all the required libraries (dll/pyd), and is present with an executable entry-point file (web2py.exe), but there is no noticeable difference running web2py from source.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec04"/>There's more...</h2></div></div></div><p>Running web2py from the source package in Windows has many advantages, a few of which are listed as follows:</p><div><ul class="itemizedlist"><li class="listitem"><p>You can more easily use third-party libraries, such as Python Imaging (look at Python package index, where you can install more than ten thousand modules!).</p></li><li class="listitem"><p>You can import web2py functionality (for example, the<strong> Database Abstraction Layer (DAL))</strong>  from other Python programs.</p></li><li class="listitem"><p>You can keep web2py updated with the latest changes, help to test it, and submit patches.</p></li><li class="listitem"><p>You can browse the web2py source code, tweak it for your custom need, and so on.</p></li></ul></div></div></div><div><div><div><div><h1 class="title"><a id="ch01lvl1sec03"/>Installing web2py in Ubuntu</h1></div></div></div><p>This recipe covers how to install web2py in a development environment using the Ubuntu desktop. Installation in a production system will be covered in the next recipe.<a id="id6" class="indexterm"/>
</p><p>We assume that you know how to use a console and install applications using the console. We will use the latest Ubuntu desktop, at this writing: Ubuntu Desktop 10.10.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec05"/>Getting ready</h2></div></div></div><p>We are going to install web2py in your home directory, so fire up the console.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec06"/>How to do it...</h2></div></div></div><div><ol class="orderedlist"><li class="listitem"><p>Download web2py.<a id="id7" class="indexterm"/>
</p><div><pre class="programlisting"><strong>cd /home
mkdir www-dev
cd www-dev
wget http://www.web2py.com/examples/static/web2py_src.zip
(get web2py)</strong>
</pre></div></li><li class="listitem"><p>When the download is complete, unzip it:</p><div><pre class="programlisting"><strong>unzip -x web2py_src.zip</strong>
</pre></div></li><li class="listitem"><p>Optionally install the<code class="literal"> tk</code> library for Python, if you want the GUI.<a id="id8" class="indexterm"/>
</p><div><pre class="programlisting"><strong>sudo apt-get install python-tk</strong>
</pre></div><div><h3 class="title"><a id="tip02"/>Note</h3><p><strong>Downloading the example code</strong></p><p>You can download the example code files for all Packt books you have purchased from your account at<a class="ulink" href="http://www.PacktPub.com"> http://www.PacktPub.com</a>. If you purchased this book elsewhere, you can visit<a class="ulink" href="http://www.PacktPub.com/support"> http://www.PacktPub.com/support</a>, and register to have the files e-mailed directly to you. The code files are also uploaded at the following repository:<a class="ulink" href="http://https://github.com/mdipierro/web2py-recipes-source"> https://github.com/mdipierro/web2py-recipes-source</a>.</p><p>All the code is released under the BSD license (<a class="ulink" href="http://www.opensource.org/licenses/bsd-license.php">http://www.opensource.org/licenses/bsd-license.php</a>) unless otherwise stated in the source file.</p></div></li><li class="listitem"><p>To start web2py, access the web2py directory and run web2py.</p><div><pre class="programlisting"><strong>cd web2py
python web2py.py</strong>
</pre><div><img src="img/5467OS_01_00.jpg" alt="How to do it..."/></div></div><div><ul class="itemizedlist"><li class="listitem"><p>After installation, each time you run it, web2py will ask you to choose a password. This password is your administrative password. If the password is left blank, the administrative interface will be disabled.
</p></li></ul></div></li><li class="listitem"><p>Enter<code class="literal"> 127.0.0.1:8000/</code> in your browser to check if everything is working OK.</p></li></ol></div><div><h3 class="title"><a id="note03"/>Note</h3><p>The administrative interface:<code class="literal"> http://127.0.0.1:8000/admin/default/index</code> is only accessible through<code class="literal"> localhost</code>, and always requires a password. It can also be accessed through an SSH tunnel.</p></div></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec07"/>There's more...</h2></div></div></div><p>You can use some other options. For example, you can specify the port with the option<code class="literal"> -p port</code> and IP address with the option<code class="literal"> -i 127.0.0.1</code>. It's useful to specify the password, so you don't have to enter it every time you start web2py; use option<code class="literal"> -a</code> password. If you want help on other options, run web2py with the<code class="literal"> -h</code> or<code class="literal"> help</code> option.</p><p>For example:</p><div><pre class="programlisting"><strong>python web2py.py -i 127.0.0.1 -p 8000 -a mypassword --nogui</strong>
</pre></div></div></div><div><div><div><div><h1 class="title"><a id="ch01lvl1sec04"/>Setting up a production deployment on Ubuntu</h1></div></div></div><p>This recipe describes how to install web2py in a production environment using the Ubuntu server. This is the recommended method to deploy web2py in production.<a id="id9" class="indexterm"/>
</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec08"/>Getting ready</h2></div></div></div><p>We assume that you know how to use a console and install applications using a repository and commands. We will use the latest Ubuntu server at the time of writing: Ubuntu Server 10.04 LTS.</p><p>In this recipe we will learn how to:</p><div><ul class="itemizedlist"><li class="listitem"><p>Install all modules needed to run web2py on Ubuntu</p></li><li class="listitem"><p>Install web2py in<code class="literal"> /home/www-data/</code>
</p></li><li class="listitem"><p>Create a self-signed SSL certificate</p></li><li class="listitem"><p>Set up web2py with<code class="literal"> mod_wsgi</code>
</p></li><li class="listitem"><p>Overwrite<code class="literal"> /etc/apache2/sites-available/default</code>
</p></li><li class="listitem"><p>Restart Apache</p></li></ul></div><div><img src="img/5467OS_01_01.jpg" alt="Getting ready"/></div><p>First, we need to be sure that the system is up-to-date. Upgrade the system with these commands:<a id="id10" class="indexterm"/>
</p><div><pre class="programlisting"><strong>sudo apt-get update
sudo apt-get upgrade</strong>
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec09"/>How to do it...</h2></div></div></div><div><ol class="orderedlist"><li class="listitem"><p>Let's start by installing<code class="literal"> postgreSQL:</code>
</p><div><pre class="programlisting"><strong>sudo apt-get install postgresql</strong>
</pre></div></li><li class="listitem"><p>We need to unzip and open<code class="literal"> ssh-server</code>, if it's not installed already.</p><div><pre class="programlisting"><strong>
sudo apt-get install unzip
sudo apt-get install openssh-server</strong>
</pre></div></li><li class="listitem"><p>Install Apache 2 and<code class="literal"> mod-wsgi:</code>
</p><div><pre class="programlisting"><strong>sudo apt-get install apache2
sudo apt-get install libapache2-mod-wsgi</strong>
</pre></div></li><li class="listitem"><p>Optionally, if you plan to manipulate images, we can install the<strong> Python Imaging Library (PIL)</strong> :</p><div><pre class="programlisting">sudo apt-get install python-imaging
</pre></div></li><li class="listitem"><p>Now we need to install web2py. We'll create<code class="literal"> www-data</code> in <code class="literal">/home</code>, and extract the web2py source there.</p><div><pre class="programlisting"><strong>cd /home
sudo mkdir www-data
cd www-data</strong>
</pre></div></li><li class="listitem"><p>Get the web2py source from the web2py site:</p><div><pre class="programlisting"><strong>sudo wget http://web2py.com/examples/static/web2py_src.zip
sudo unzip web2py_src.zip
sudo chown -R www-data:www-data web2py</strong>
</pre></div></li><li class="listitem"><p>Enable the Apache SSL and EXPIRES modules:</p><div><pre class="programlisting"><strong>sudo a2enmod expires
sudo a2enmod ssl</strong>
</pre></div></li><li class="listitem"><p>Create a self-signed certificate:</p><p>You should obtain your SSL certificates from a trusted <strong>Certificate Authority</strong>, such as <code class="literal">verisign.com</code>, but for testing purposes you can generate your own self-signed certificates. You can read more about it at: <a class="ulink" href="https://help.ubuntu.com/10.04/serverguide/C/certificates-and-security.html.%20">https://help.ubuntu.com/10.04/serverguide/C/certificates-and-security.html.
</a>
</p></li><li class="listitem"><p>Create the<code class="literal"> SSL</code> folder, and put the SSL certificates inside it:<a id="id11" class="indexterm"/>
</p><div><pre class="programlisting"><strong>sudo openssl req -new -x509 -nodes -sha1 -days 365 -key \
/etc/apache2/ssl/self_signed.key &gt; \
/etc/apache2/ssl/self_signed.cert
sudo openssl x509 -noout -fingerprint -text &lt; \
/etc/apache2/ssl/self_signed.cert &gt; \
/etc/apache2/ssl/self_signed.info</strong>
</pre></div></li><li class="listitem"><p>If you have problem with permissions, use<code class="literal"> sudo -i</code>.</p></li><li class="listitem"><p>Edit the default Apache configuration with your editor.</p><div><pre class="programlisting"><strong>sudo nano /etc/apache2/sites-available/default</strong>
</pre></div></li><li class="listitem"><p>Add the following code to the configuration:</p><div><pre class="programlisting"><strong>NameVirtualHost *:80
NameVirtualHost *:443

&lt;VirtualHost *:80&gt;
	WSGIDaemonProcess web2py user=www-data group=www-data
	WSGIProcessGroup web2py
	WSGIScriptAlias / /home/www-data/web2py/wsgihandler.py
	
	&lt;Directory /home/www-data/web2py&gt;
		AllowOverride None
		Order Allow,Deny
		Deny from all
		&lt;Files wsgihandler.py&gt;
			Allow from all
		&lt;/Files&gt;
	&lt;/Directory&gt;

	AliasMatch ^/([^/]+)/static/(.*) \
		/home/www-data/web2py/applications/$1/static/$2
	
	&lt;Directory /home/www-data/web2py/applications/*/static/&gt;
		Options -Indexes
		Order Allow,Deny
		Allow from all
	&lt;/Directory&gt;

	&lt;Location /admin&gt;
		Deny from all
	&lt;/Location&gt;

	&lt;LocationMatch ^/([^/]+)/appadmin&gt;
		Deny from all
	&lt;/LocationMatch&gt;

	CustomLog /var/log/apache2/access.log common
	ErrorLog /var/log/apache2/error.log
&lt;/VirtualHost&gt;

&lt;VirtualHost *:443&gt;
	SSLEngine on
	SSLCertificateFile /etc/apache2/ssl/self_signed.cert
	SSLCertificateKeyFile /etc/apache2/ssl/self_signed.key
	
	WSGIProcessGroup web2py
	
	WSGIScriptAlias / /home/www-data/web2py/wsgihandler.py
	
	&lt;Directory /home/www-data/web2py&gt;
		AllowOverride None
		Order Allow,Deny
		Deny from all
		&lt;Files wsgihandler.py&gt;
			Allow from all
		&lt;/Files&gt;
	&lt;/Directory&gt;
	
	AliasMatch ^/([^/]+)/static/(.*) \
		/home/www-data/web2py/applications/$1/static/$2
	&lt;Directory /home/www-data/web2py/applications/*/static/&gt;
		Options -Indexes
		ExpiresActive On
		ExpiresDefault "access plus 1 hour"
		Order Allow,Deny
		Allow from all
	&lt;/Directory&gt;
	
	CustomLog /var/log/apache2/access.log common
	ErrorLog /var/log/apache2/error.log
&lt;/VirtualHost&gt;</strong>
</pre></div></li><li class="listitem"><p>Restart the Apache server:</p><div><pre class="programlisting"><strong>
sudo /etc/init.d/apache2 restart
	cd /home/www-data/web2py
	sudo -u www-data python -c "from gluon.widget import console; \
console();"
	sudo -u www-data python -c "from gluon.main \
import save_password; \
save_password(raw_input('admin password: '),443)"</strong>
</pre></div></li><li class="listitem"><p>Enter<code class="literal"> http://192.168.1.1/</code> in your browser to check if everything is working OK, replacing<code class="literal"> 192.168.1.1</code> with your public IP address.</p></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec10"/>There's more...</h2></div></div></div><p>Everything that we did can be done automatically using a script provided by web2py:</p><div><pre class="programlisting"><strong>
wget http://web2py.googlecode.com/hg/scripts/setup-web2py-\
	ubuntu.sh
chmod +x setup-web2py-ubuntu.sh
sudo ./setup-web2py-ubuntu.sh</strong>
</pre></div></div></div><div><div><div><div><h1 class="title"><a id="ch01lvl1sec05"/>Running web2py with Apache, mod_proxy, and mod_rewrite</h1></div></div></div><p>
<strong>Apache httpd</strong> is the most popular HTTP server, and having Apache httpd on a large installation is a must, just like panettone on Christmas day in Italy. Like the panettone, Apache comes in many flavors and with different fillings. You have to find the one you like.<a id="id12" class="indexterm"/>
</p><p>In this recipe, we configure Apache with<code class="literal"> mod_proxy</code>, and refine it through<code class="literal"> mod_rewrite</code> rules. This is a simple, but robust solution. It can be used to increase web2py scalability, throughput, security, and flexibility. These rules should satisfy both the connoisseur and the beginner.<a id="id13" class="indexterm"/>
</p><p>This recipe will show you how to make a web2py installation on a host appear as part of a website, even when hosted somewhere else. We will also show how Apache can be used to improve the performance of your web2py application, without touching web2py.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec11"/>Getting ready</h2></div></div></div><p>You should have the following:</p><div><ul class="itemizedlist"><li class="listitem"><p>web2py installed and running on<code class="literal"> localhost</code> with the built-in Rocket webserver (port 8000)</p></li><li class="listitem"><p>Apache HTTP server (<code class="literal">httpd</code>) version 2.2.x or later</p></li><li class="listitem"><p>
<code class="literal">mod_proxy</code> and<code class="literal"> mod_rewrite</code> (included in the standard Apache distribution)</p></li></ul></div><p>On Ubuntu or other Debian-based servers, you can install Apache with:</p><div><pre class="programlisting"><strong>apt-get install apache</strong>
</pre></div><p>On CentOS or other Fedora-based Linux distributions, you can install Apache with:</p><div><pre class="programlisting"><strong>yum install httpd</strong>
</pre></div><p>For most other systems you can download Apache from the website<a class="ulink" href="http://httpd.apache.org/"> http://httpd.apache.org/</a>, and install it yourself with the provided instructions.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec12"/>How to do it...</h2></div></div></div><p>Now that we have Apache HTTP server (from now on we will refer to it simply as Apache) and web2py both running locally, we must configure it.</p><p>Apache is configured by placing directives in plain text configuration files. The main configuration file is usually called<code class="literal"> httpd.conf</code>. The default location of this file is set at compile time, but may be overridden with the<code class="literal"> -f</code> command line flag.<code class="literal"> httpd.conf</code> may include other configuration files. Additional directives may be placed in any of these configuration files.</p><p>The configuration files may be located in<code class="literal"> /etc/apache2</code>, in<code class="literal"> /etc/apache</code>, or in<code class="literal"> /etc/httpd</code>, depending on the details of the OS and the Apache version.</p><div><ol class="orderedlist"><li class="listitem"><p>Before editing any of the files, make sure that the required modules are enabled from the command-line shell (<code class="literal">bash</code>), type:</p><div><pre class="programlisting"><strong>a2enmod proxy
a2enmod rewrite</strong>
</pre></div><div><ul class="itemizedlist"><li class="listitem"><p>With <code class="literal">mod_proxy</code> and <code class="literal">mod_rewrite</code> enabled, we are now ready to set up a simple rewrite rule to proxy forward HTTP requests received by Apache to any other HTTP server we wish. Apache supports multiple <code class="literal">VirtualHosts</code>, that is, it has the ability to handle different virtual host names and ports within a single Apache instance. The default <code class="literal">VirtualHost</code> configuration is in a file called <code class="literal">/etc/&lt;apache&gt;/ sites-available/default</code>, where <code class="literal">&lt;apache&gt; is apache, apache2, or httpd.
</code>
</p></li></ul></div></li><li class="listitem"><p>In this file each<code class="literal"> VirtualHost</code> is defined by creating an entry as follows:<a id="id14" class="indexterm"/>
</p><div><pre class="programlisting"><strong>
&lt;VirtualHost *:80&gt;
	...
&lt;/VirtualHost&gt;</strong>
</pre></div><div><ul class="itemizedlist"><li class="listitem"><p>You can read the in-depth <code class="literal">VirtualHost</code> documentation at <code class="literal">http://httpd.apache.org/docs/2.2/vhosts/.
</code>
</p></li></ul></div></li><li class="listitem"><p>To use<code class="literal"> RewriteRules</code>, we need to activate the<strong> Rewrite Engine</strong> inside the<code class="literal"> VirtualHost:</code>
</p><div><pre class="programlisting"><strong>
&lt;VirtualHost *:80&gt;
	RewriteEngine on
	...
&lt;/VirtualHost&gt;</strong>
</pre></div></li><li class="listitem"><p>Then we can configure the rewrite rule:</p><div><pre class="programlisting"><strong>
&lt;VirtualHost *:80&gt;
	RewriteEngine on
	# make sure we handle the case with no / at the end of URL
	RewriteRule ^/web2py$ /web2py/ [R,L]
	
	# when matching a path starting with /web2py/ do use a reverse
	# proxy
	RewriteRule ^/web2py/(.*) http://localhost:8000/$1 [P,L]
	...
&lt;/VirtualHost&gt;</strong>
</pre></div><div><ul class="itemizedlist"><li class="listitem"><p>The second rule tells Apache to do a reverse proxy connection to <code class="literal">http://localhost:8000</code>, passing all the path components of the URL called by the user, except for the first, web2py. The syntax used for rules is based on regular expressions (<code class="literal">regex</code>), where the first expression is compared to the incoming URL (the one requested by the user).
</p><p>If there is a match, the second expression is used to build a new URL. The flags inside [<code class="literal">and</code>] determine how the resulting URL is to be handled. The previous example matches any incoming request on the default <code class="literal">VirtualHost</code> with a path that begins with <code class="literal">/web2py</code>, and generates a new URL prepending <code class="literal">http://localhost:8000/</code> to the remainder of the matched path; the part of the incoming URL that matches the expression .* replaces <code class="literal">$1</code> in the second expression.
</p><p>The flag <code class="literal">P</code> tells Apache to use its proxy to retrieve the content pointed by the URL, before passing it back to the requesting browser.
</p><p>Suppose that the Apache Server responds at the domain <a class="ulink" href="http://www.example.com">www.example.com</a>; then if the user's browser requests <a class="ulink" href="http://www.example.com/web2py/welcome">http://www.example.com/web2py/welcome</a>, it will receive a response with the contents from the scaffolding application of web2py. Thats is, it would be as if the browser had requested <code class="literal">http://localhost:8000/welcome.
</code>
</p></li></ul></div></li><li class="listitem"><p>There is a catch: web2py could send an HTTP redirect, for instance to point the user's browser to the default page. The problem is that the redirect is relative to web2py's application layout, the one that the Apache proxy is trying to hide, so the redirect is probably going to point the browser to the wrong location. To avoid this, we must configure Apache to intercept redirects and correct them.<a id="id15" class="indexterm"/>
</p><div><pre class="programlisting"><strong>
&lt;VirtualHost *:80&gt;
	...
	#make sure that HTTP redirects generated by web2py are reverted
		/ -&gt; /web2py/
	ProxyPassReverse /web2py/ http://localhost:8000/
	ProxyPassReverse /web2py/ /
	
	# transform cookies also
	ProxyPassReverseCookieDomain localhost localhost
	ProxyPassReverseCookiePath / /web2py/
	...
&lt;/VirtualHost&gt;</strong>
</pre></div></li><li class="listitem"><p>There is yet another issue. Many URLs generated by web2py are also relative to the web2py context. These include the URLs of images or CSS style sheets. We have to instruct web2py how to write the correct URL, and of course, since it is web2py, it is simple and we do not have to modify any code in our application code. We need to define a file<code class="literal"> routes.py</code> in the root of web2py's installation, as follows:</p><div><pre class="programlisting"><strong>routes_out=((r'^/(?P&lt;any&gt;.*)', r'/web2py/\g&lt;any&gt;'),)</strong>
</pre></div></li><li class="listitem"><p>Apache can, at this point, transform the received content before sending it back to the client. We have the opportunity to improve website speed in several ways. For example, we can compress all content before sending it back to the browser, if the browser accepts compressed content.<a id="id16" class="indexterm"/>
</p></li></ol></div><div><pre class="programlisting"><strong>
# Enable content compression on the fly,
# speeding up the net transfer on the reverse proxy.
&lt;Location /web2py/&gt;
	# Insert filter
	SetOutputFilter DEFLATE
	# Netscape 4.x has some problems...
	BrowserMatch ^Mozilla/4 gzip-only-text/html
	# Netscape 4.06-4.08 have some more problems
	BrowserMatch ^Mozilla/4\.0[678] no-gzip
	# MSIE masquerades as Netscape, but it is fine
	BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
	# Don't compress images
	SetEnvIfNoCase Request_URI \
		\.(?:gif|jpe?g|png)$ no-gzip dont-vary
	# Make sure proxies don't deliver the wrong content
	Header append Vary User-Agent env=!dont-vary
&lt;/Location&gt;</strong>
</pre></div><div><ul class="itemizedlist"><li class="listitem"><p>It is possible in the same way, just by configuring Apache, to do other interesting tasks, such as SSL encryption, load balancing, acceleration by content caching, and many other things. You can find information for those and many other setups at <a class="ulink" href="http://httpd.apache.org.%20">http://httpd.apache.org.
</a>
</p></li></ul></div><p>Here is the complete configuration for the default VirtualHost as used in the following recipe:</p><div><pre class="programlisting"><strong>
&lt;VirtualHost *:80&gt;
	ServerName localhost
	# ServerAdmin: Your address, where problems with the server
	# should
	# be e-mailed. This address appears on some server-generated
	# pages,
	# such as error documents. e.g. admin@your-domain.com
	ServerAdmin root@localhost
	
	# DocumentRoot: The directory out of which you will serve your
	# documents. By default, all requests are taken from this
	# directory,
	# but symbolic links and aliases may be used to point to other
	# locations.
	# If you change this to something that isn't under /var/www then
	# suexec will no longer work.
	DocumentRoot "/var/www/localhost/htdocs"
	
	# This should be changed to whatever you set DocumentRoot to.
	&lt;Directory "/var/www/localhost/htdocs"&gt;
		# Possible values for the Options directive are "None", "All",
		# or any combination of:
		# 	Indexes Includes FollowSymLinks
		# 	SymLinksifOwnerMatch ExecCGI MultiViews
		#
		# Note that "MultiViews" must be named *explicitly* ---
		# "Options All"
		# doesn't give it to you.
		#
		# The Options directive is both complicated and important.
		# Please
		# see http://httpd.apache.org/docs/2.2/mod/core.html#options
		# for more information.
		Options Indexes FollowSymLinks
		# AllowOverride controls what directives may be placed in
		# .htaccess
		# It can be "All", "None", or any combination of the keywords:
		# 	Options FileInfo AuthConfig Limit
		AllowOverride All
		
		# Controls who can get stuff from this server.
			Order allow,deny
			Allow from all
		&lt;/Directory&gt;
		
		### WEB2PY EXAMPLE PROXY REWRITE RULES
		RewriteEngine on
		# make sure we handle when there is no / at the end of URL
		RewriteRule ^/web2py$ /web2py/ [R,L]
		
		# when matching a path starting with /web2py/ do a reverse proxy
		RewriteRule ^/web2py/(.*) http://localhost:8000/$1 [P,L]
		
		# make sure that HTTP redirects generated by web2py are reverted
		# / -&gt; /web2py/
		ProxyPassReverse /web2py/ http://localhost:8000/
		ProxyPassReverse /web2py/ /
		
		# transform cookies also
		ProxyPassReverseCookieDomain localhost localhost
		ProxyPassReverseCookiePath / /web2py/
		
		# Enable content compression on the fly speeding up the net
		# transfer on the reverse proxy.
		&lt;Location /web2py/&gt;
			# Insert filter
			SetOutputFilter DEFLATE
			# Netscape 4.x has some problems...
			BrowserMatch ^Mozilla/4 gzip-only-text/html
			# Netscape 4.06-4.08 have some more problems
			BrowserMatch ^Mozilla/4\.0[678] no-gzip
			# MSIE masquerades as Netscape, but it is fine
			BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
			# Don't compress images
			SetEnvIfNoCase Request_URI \
				\.(?:gif|jpe?g|png)$ no-gzip dont-vary
			# Make sure proxies don't deliver the wrong content
			Header append Vary User-Agent env=!dont-vary
		&lt;/Location&gt;
&lt;/VirtualHost&gt;</strong>
</pre></div><p>You must restart Apache for any change to take effect. You can use the following command for the same:<a id="id17" class="indexterm"/>
</p><div><pre class="programlisting"><strong>apachectl restart</strong>
</pre></div></div></div><div><div><div><div><h1 class="title"><a id="ch01lvl1sec06"/>Running web2py with Lighttpd</h1></div></div></div><p>
<strong>Lighttpd</strong> is a secure, fast, compliant, and a very flexible web-server that has been optimized for high-performance environments. It has a very low memory footprint as compared to other web servers, and takes care of the cpu-load. Its advanced feature-set (FastCGI, CGI, Auth, Output-Compression, URL-Rewriting, and many more) make Lighttpd the perfect web server software for every server that suffers load problems.<a id="id18" class="indexterm"/>
</p><p>This recipe was derived from official web2py book, but while the book uses FastCGI<code class="literal"> mod_fcgi</code> to expose web2py functionality behind a Ligthttpd web server, here, we use SCGI instead. The SCGI protocol that we use here is similar in intent to FastCGI, but simpler and faster. It is described at the following website:</p><p>
<a class="ulink" href="http://python.ca/scgi">http://python.ca/scgi</a>
</p><p>
<strong>SCGI</strong> is a binary protocol for inter-process communication over IP. SCGI is tailored for the specific task of web server to CGI application communication. The CGI standard defines how a web server can delegate to an external application the dynamic generation of an HTTP response.<a id="id19" class="indexterm"/>
</p><p>The problem with CGI is that, for every incoming request a new process has to be created. Process creation can take longer than response generation in some contexts. This is true in most interpreted language environments, where the time to load a new instance of the interpreter can be longer than the execution of the program itself.</p><p>
<strong>FastCGI</strong> addresses this problem by using long-running processes to answer to more than one request without exiting. This is beneficial, in particular, for interpreted programs, because the interpreter does not need to be restarted each time. SCGI was developed after FastCGI experience to reduce the complexity required to convert a CGI to a FastCGI application, allowing better performance. SCGI is a standard module of Lighttpd, and is available for Apache as well.<a id="id20" class="indexterm"/>
</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec13"/>Getting ready</h2></div></div></div><p>You should have:<a id="id21" class="indexterm"/>
</p><div><ul class="itemizedlist"><li class="listitem"><p>web2py installed and running on localhost (port<code class="literal"> 8000)</code>
</p></li><li class="listitem"><p>Lighttpd (download and install from<a class="ulink" href="http://www.lighttpd.net)"> http://www.lighttpd.net)</a>
<a id="id22" class="indexterm"/>
</p></li><li class="listitem"><p>SCGI (download and install from<a class="ulink" href="http://python.ca/scgi)"> http://python.ca/scgi)</a>
<a id="id23" class="indexterm"/>
</p></li><li class="listitem"><p>Python Paste (download and install from<a class="ulink" href="http://pythonpaste.org/)"> http://pythonpaste.org/)</a>, or WSGITools (http://subdivi.de/helmut/wsgitools)<a id="id24" class="indexterm"/>
</p></li></ul></div><p>If you have<code class="literal"> setuptools</code>, you can install SCGI, paste, and wsgitools, as follows:</p><div><pre class="programlisting"><strong>easy_install scgi
easy_install paste
easy_install wsgitools</strong>
</pre></div><p>You will also need a script to start an SCGI server, configured for web2py that may or may not come with web2py, depending on the version, so we have supplied one to this recipe.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec14"/>How to do it...</h2></div></div></div><p>Now, you have to write the script to start the SCGI server that will be listening to Lighttpd requests. Don't worry, even if it is very short and easy, we provide one ready to copy here:</p><div><pre class="programlisting"><strong>#!/usr/bin/env python
# -*- coding: utf-8 -*-

LOGGING = False
SOFTCRON = False

import sys
import os

path = os.path.dirname(os.path.abspath(__file__))
os.chdir(path)
sys.path = [path]+[p for p in sys.path if not p==path]

import gluon.main

if LOGGING:
application = gluon.main.appfactory(
	wsgiapp=gluon.main.wsgibase,
	logfilename='httpserver.log',
profilerfilename=None)
else:
	application = gluon.main.wsgibase
	
if SOFTCRON:
	from gluon.settings import global_settings
	global_settings.web2py_crontype = 'soft'
	
try:
	import paste.util.scgiserver as scgi
	scgi.serve_application(application, '', 4000).run()
except ImportError:
from wsgitools.scgi.forkpool import SCGIServer
SCGIServer(application, port=4000).run()</strong>
</pre></div><div><ol class="orderedlist"><li class="listitem"><p>Copy the previous script, and put it in the root of your web2py installation with the name<code class="literal"> scgihandler.py</code>. Start the SCGI server, and leave it running in the background:</p><div><pre class="programlisting"><strong>$ nohup python ./scgihandler.py &amp;</strong>
</pre></div><div><ul class="itemizedlist"><li class="listitem"><p>Now we are ready to configure <code class="literal">lighttpd.
</code>
<a id="id25" class="indexterm"/>
</p><p>We provide a simple <code class="literal">lighttpd.conf</code> configuration file here, as an example. Of course, real-world configurations can be much more complex, but the important parts will not differ much.
</p></li></ul></div></li><li class="listitem"><p>Append the following lines to your<code class="literal"> lighttpd.conf:</code>
</p><div><pre class="programlisting"><strong>server.modules += ( "mod_scgi" )
server.document-root="/var/www/web2py/"
# for &gt;= linux-2.6
server.event-handler = "linux-sysepoll"

url.rewrite-once = (
	"^(/.+?/static/.+)$" =&gt; "/applications$1",
	"(^|/.*)$" =&gt; "/handler_web2py.scgi$1",
)
scgi.server = ( "/handler_web2py.scgi" =&gt;
	("handler_web2py" =&gt;
		( "host" =&gt; "127.0.0.1",
		"port" =&gt; "4000",
		"check-local" =&gt; "disable", # important!
		)
	)
)</strong>
</pre></div></li><li class="listitem"><p>This configuration does the following:</p><div><ul class="itemizedlist"><li class="listitem"><p>Loads the SCGI module into Lighttpd</p></li><li class="listitem"><p>Configures the server document root to the root of web2py installation</p></li><li class="listitem"><p>Rewrites the URL, using<code class="literal"> mod_rewrite</code>, so that incoming requests to static files are served directly by Lighttpd, while all the rest are rewritten to a<strong> fake</strong> URL beginning with<code class="literal"> /handler_web2py.scgi</code>
</p></li><li class="listitem"><p>
<strong>Creates an SCGI server stanza:</strong> For every request beginning with<code class="literal"> /handler_web2py.scgi</code> the request is routed to the SCGI server running on<code class="literal"> 127.0.0.1</code> at port<code class="literal"> 4000</code>, skipping the check for the existence of a corresponding local file on the filesystem</p></li></ul></div></li><li class="listitem"><p>Now, check that your configuration is ok:</p><div><pre class="programlisting"><strong>$ lighttpd -t -f lighttpd.conf</strong>
</pre></div></li><li class="listitem"><p>Then start the server for testing:<a id="id26" class="indexterm"/>
</p><div><pre class="programlisting"><strong>$ lighttpd -D -f lighttpd.conf</strong>
</pre></div></li><li class="listitem"><p>You can start/stop/restart the server with the following command:</p></li></ol></div><div><pre class="programlisting"><strong>$ /etc/init.d/lighttpd start|stop|restart</strong>
</pre></div><p>You will see your web2py application go to the speed of Light(ttpd).</p></div></div><div><div><div><div><h1 class="title"><a id="ch01lvl1sec07"/>Running web2py with Cherokee</h1></div></div></div><p>This recipe explains how to run web2py behind a Cherokee web server using<strong> uWSGI</strong>.<a id="id27" class="indexterm"/>
</p><p>
<strong>Cherokee</strong> is a webserver written in C, similar in intent to Lighttpd: fast, compact, and modular. Cherokee comes with an administrative interface that allows one to manage its configuration, which is difficult to read and modify otherwise. uWSGI is described in its website as a fast (pure C), self-healing, developer/sysadmin-friendly application container server. Cherokee has an included module to talk to uWSGI servers.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec15"/>How to do it...</h2></div></div></div><div><ol class="orderedlist"><li class="listitem"><p>Install the package or download, compile, and install the required components. Create the following file in the installation root of web2py, and call it<code class="literal"> uwsgi.xml:</code>
</p><div><pre class="programlisting"><strong>
&lt;uwsgi&gt;
	&lt;pythonpath&gt;/home/web2py&lt;/pythonpath&gt;
	&lt;module&gt;wsgihandler&lt;/module&gt;
	&lt;socket&gt;127.0.0.1:37719&lt;/socket&gt;
	&lt;master/&gt;
	&lt;processes&gt;8&lt;/processes&gt;
	&lt;memory-report/&gt;
&lt;/uwsgi&gt;</strong>
</pre></div><div><ul class="itemizedlist"><li class="listitem"><p>This configuration spawns eight processes to manage multiple requests from the HTTP server. Change it as needed, and configure <code class="literal">&lt;pythonpath&gt;</code> to the installation root of web2py.
</p></li></ul></div></li><li class="listitem"><p>As the user that owns the web2py installation, start the uWSGI server:</p><div><pre class="programlisting"><strong>$ uWSGI -d uwsgi.xml</strong>
</pre></div></li><li class="listitem"><p>Now launch the Cherokee administrative interface to create a new configuration:<a id="id28" class="indexterm"/>
</p><div><pre class="programlisting"><strong>$ cherokee-admin</strong>
</pre></div></li><li class="listitem"><p>Connect to the admin interface with the browser at the following link:<code class="literal"> http://localhost:9090/</code>.</p><div><img src="img/5467OS_01_02.jpg" alt="How to do it..."/></div></li><li class="listitem"><p>Go to the<strong> Sources</strong> section -<strong> (A)</strong>, then click on the<strong> +</strong> button -<strong> (B)</strong>.</p></li><li class="listitem"><p>Select<strong> Remote Host</strong> on<strong> (C)</strong>, then fill the text field at<strong> (D)</strong> with the IP address, and port to match the configuration in the previous<code class="literal"> uswgi.xml</code> file.</p><p>Having configured the uWGI source, it is now possible to configure a Virtual Host, and redirect requests through it. In this recipe, we choose the <strong>default</strong> Virtual Host that is used when no other Virtual Host has a better match for the incoming request.
<a id="id29" class="indexterm"/>
</p></li><li class="listitem"><p>Click on button<code class="literal"> (C)</code> to go to<strong> Rule Management</strong>.</p><div><img src="img/5467OS_01_03.jpg" alt="How to do it..."/></div></li><li class="listitem"><p>Delete all rules listed on the left. Only the<strong> default</strong> rule will remain.</p><div><img src="img/5467OS_01_04.jpg" alt="How to do it..."/></div></li><li class="listitem"><p>Configure the<strong> default</strong> rule with a uWSGI<strong> Handler</strong>. Leave the other values unchanged.<a id="id30" class="indexterm"/>
</p><div><img src="img/5467OS_01_05.jpg" alt="How to do it..."/></div></li><li class="listitem"><p>If you want Cherokee to serve static files directly from web2py folders, you can add a<strong> Regular Expression</strong> rule. Click button<strong> (A)</strong>, and select<strong> Regular Expression</strong> from the drop-down menu at<strong> (B)</strong>. Be aware that this configuration works only if the web2py directory is on the same file system, and is accessible to Cherokee.</p><div><img src="img/5467OS_01_06.jpg" alt="How to do it..."/></div></li><li class="listitem"><p>Configure the<strong> Regular Expressions:</strong>
<a id="id31" class="indexterm"/>
</p><div><img src="img/5467OS_01_07.jpg" alt="How to do it..."/></div></li><li class="listitem"><p>Now you can configure the Static Handler pointing to the applications subdirectory of your web2py installation:</p><div><img src="img/5467OS_01_08.jpg" alt="How to do it..."/></div><div><ul class="itemizedlist"><li class="listitem"><p>Remember to save the configuration, and reload or restart Cherokee from the administrative interface; then you are ready to start the uWSGI server.
</p></li></ul></div></li><li class="listitem"><p>Change to the correct user ID that was used to install web2py; be aware that using root is not recommended.<a id="id32" class="indexterm"/>
</p></li><li class="listitem"><p>Go into the root directory of web2py installation, where you saved the configuration file<code class="literal"> uwsgi.xml</code>.</p></li><li class="listitem"><p>Run uWSGI with the<code class="literal"> -d &lt;logfile&gt;</code> option, so that it runs in the background:</p></li></ol></div><div><pre class="programlisting"><strong>$ su - &lt;web2py user&gt;
$ cd &lt;web2py root&gt;
$ uwsgi -x uwsgi.xml -d /tmp/uwsgi.log</strong>
</pre></div><p>Enjoy the speed!</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec16"/>Getting ready</h2></div></div></div><p>You should have the following:</p><div><ul class="itemizedlist"><li class="listitem"><p>web2py (installed but not running)</p></li><li class="listitem"><p>uWSGI (download and install from<a class="ulink" href="http://projects.unbit.it/uwsgi/wiki)"> http://projects.unbit.it/uwsgi/wiki)</a>
</p></li><li class="listitem"><p>Cherokee (download and install from<a class="ulink" href="http://www.cherokee-project.com/)"> http://www.cherokee-project.com/)</a>
<a id="id33" class="indexterm"/>
</p></li></ul></div></div></div><div><div><div><div><h1 class="title"><a id="ch01lvl1sec08"/>Running web2py with Nginx and uWSGI</h1></div></div></div><p>This recipe explains how to run web2py with the Nginx web server using uWSGI.<a id="id34" class="indexterm"/>
</p><p>
<strong>Nginx</strong> is a free, open-source, high-performance HTTP server, and reverse proxy, written by<strong> Igor Sysoev</strong>.</p><p>Nginx, unlike traditional servers, does not rely on threads to handle requests, rather, it implements an asynchronous architecture. This implies that Nginx uses a predictable amount of memory, even under heavy load, resulting in higher stability and low resource consumption. Nginx now hosts more than seven percent of all domains worldwide.</p><p>It should be stressed that even if Nginx is asynchronous, web2py is not. Therefore, web2py will use more resources, the more concurrent requests it handles concurrently. uWSGI is described on its website as a fast (pure C), self-healing, developer/sysadmin-friendly application container server. We will configure Nginx to serve dynamic web2py pages through uWSGI, and serve static pages directly, taking advantage of its low footprint capabilities.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec17"/>Getting ready</h2></div></div></div><p>You should have the following:</p><div><ul class="itemizedlist"><li class="listitem"><p>web2py (installed but not running)</p></li><li class="listitem"><p>uWSGI (download and install from<a class="ulink" href="http://projects.unbit.it/uwsgi/wiki)"> http://projects.unbit.it/uwsgi/wiki)</a>
</p></li><li class="listitem"><p>Nginx (download and install from<a class="ulink" href="http://nginx.net/)"> http://nginx.net/)</a>
</p></li></ul></div><p>On Ubuntu 10.04 LTS, you can install uWSGI and Nginx using<code class="literal"> apt-get</code>, as follows:</p><div><pre class="programlisting"><strong>apt-get update
apt-get -y upgrade
apt-get install python-software-properties
add-apt-repository ppa:nginx/stable
add-apt-repository ppa:uwsgi/release
apt-get update
apt-get -y install nginx-full
apt-get -y install uwsgi-python</strong>
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec18"/>How to do it...</h2></div></div></div><div><ol class="orderedlist"><li class="listitem"><p>First we need to configure Nginx. Create or edit a file called<code class="literal"> /etc/nginx/ sites-available/web2py</code>.<a id="id35" class="indexterm"/>
</p></li><li class="listitem"><p>In the file, write the following:</p><div><pre class="programlisting"><strong>
server {
	listen 			80;
	server_name 	$hostname;
	location ~* /(\w+)/static/ {
		root /home/www-data/web2py/applications/;
	}
	location / {
		uwsgi_pass 	127.0.0.1:9001;
		include 	uwsgi_params;
	}
}

server {
	listen 			443;
	server_name 	$hostname;
	ssl 					on;
	ssl_certificate 		/etc/nginx/ssl/web2py.crt;
	ssl_certificate_key 	/etc/nginx/ssl/web2py.key;
	location / {
		uwsgi_pass 	127.0.0.1:9001;
		include 	uwsgi_params;
		uwsgi_param UWSGI_SCHEME $scheme;
	}
}</strong>
</pre></div><div><ul class="itemizedlist"><li class="listitem"><p>As you can see, it passes all dynamical requests to <code class="literal">127.0.0.1:9001</code>. We need to get uWSGI running there.
</p></li></ul></div></li><li class="listitem"><p>Create the following file in the installation root of web2py, and call it<code class="literal"> web2py.xml:</code>
</p><div><pre class="programlisting"><strong>
&lt;uwsgi&gt;
	&lt;socket&gt;127.0.0.1:9001&lt;/socket&gt;
	&lt;pythonpath&gt;/home/www-data/web2py/&lt;/pythonpath&gt;
	&lt;app mountpoint="/"&gt;
		&lt;script&gt;wsgihandler&lt;/script&gt;
	&lt;/app&gt;
&lt;/uwsgi&gt;</strong>
</pre></div><div><ul class="itemizedlist"><li class="listitem"><p>This script assumes that web2py is installed as usual at <code class="literal">/home/www-data/web2py/.
</code>
</p></li></ul></div></li><li class="listitem"><p>Now disable the default configuration, and enable the new one:</p><div><pre class="programlisting"><strong>rm /etc/nginx/sites-enabled/default
rm /etc/nginx/sites-available/default
ln -s /etc/nginx/sites-available/web2py /etc/nginx/sites-enabled/\
web2py
ln -s /etc/uwsgi-python/apps-available/web2py.xml /etc/uwsgi-\
python/apps-enabled/web2py.xml</strong>
</pre></div></li><li class="listitem"><p>In order to use HTTPS, you may need to create a self-signed certificate:</p><div><pre class="programlisting"><strong>mkdir /etc/nginx/ssl
cd /etc/nginx/ssl
openssl genrsa -out web2py.key 1024
openssl req -batch -new -key web2py.key -out web2py.csr
openssl x509 -req -days 1780 -in web2py.csr -signkey web2py.key \
-out web2py.crt</strong>
</pre></div></li><li class="listitem"><p>You will also need to enable web2py admin:<a id="id36" class="indexterm"/>
</p><div><pre class="programlisting"><strong>cd /var/web2py
sudo -u www-data python -c "from gluon.main import save_password;\
save_password('$PW', 443)"</strong>
</pre></div></li><li class="listitem"><p>Once you are done, restart both uWSGI and Nginx:</p></li></ol></div><div><pre class="programlisting"><strong>/etc/init.d/uwsgi-python restart
/etc/init.d/nginx restart</strong>
</pre></div><p>web2py comes with a script that will perform this setup for you automatically:</p><p>
<code class="literal">scrips/setup-web2py-nginx-uwsgi-ubuntu.sh</code>
</p></div></div><div><div><div><div><h1 class="title"><a id="ch01lvl1sec09"/>Running web2py on shared hosts using CGI</h1></div></div></div><p>This recipe explains how to configure web2py to run on a shared host with login (but not root) access.<a id="id37" class="indexterm"/>
</p><p>With login or FTP access to a shared host, the user isn't able to configure the web server, and must live within the host's configured constraints. This recipe assumes a typical Unix-based or Linux-based shared host running Apache.</p><p>Two deployment methods are possible, depending on how the system is configured. If Apache's<code class="literal"> mod_proxy</code> is available, and the host permits long-running processes, running web2py's built-in server as an Apache proxy is straightforward and efficient. If<code class="literal"> mod_proxy</code> is not available, or the host prohibits long-running processes, we're limited to the CGI interface, which is simple to configure and almost universally available, but is also slow, since the Python interpreter must run and load web2py for each request.</p><p>We'll start with CGI deployment, the simpler case.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec19"/>Getting ready</h2></div></div></div><p>We'll assume that the root of your website is<code class="literal"> /usr/www/users/username</code>, and that<code class="literal"> /usr/www/users/username/cgi-bin</code> is your CGI binaries directory. If your details differ, obtain the actual values from your provider, and modify these instructions accordingly.<a id="id38" class="indexterm"/>
</p><p>For security reasons, here, we also assume your host supports running CGI scripts as the local user (cgiwrap). This procedure may vary from host to host, if it's available at all; check with your provider.</p><p>Download the web2py source to your<code class="literal"> cgi-bin</code> directory. For example:</p><div><pre class="programlisting"><strong>cd cgi-bin
wget http://www.web2py.com/examples/static/web2py_src.zip
unzip web2py_src.zip
rm web2py_src.zip</strong>
</pre></div><p>Alternatively, unzip the web2py source locally, and upload it to the host through FTP.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec20"/>How to do it...</h2></div></div></div><div><ol class="orderedlist"><li class="listitem"><p>In your web root directory, create the file<code class="literal"> .htaccess</code>, if necessary, and add the following lines (changing paths as required):</p><div><pre class="programlisting"><strong>
SuexecUserGroup &lt;yourusername&gt; &lt;yourgroup&gt;
RewriteEngine on
RewriteBase /usr/www/users/username
RewriteRule ^(welcome|examples|admin)(/.*)?$ \
			/cgi-bin/cgiwrap/username/web2py/cgihandler.py</strong>
</pre></div></li><li class="listitem"><p>Change its permissions with the following:</p><div><pre class="programlisting"><strong>chown 644 .htaccess</strong>
</pre></div></li><li class="listitem"><p>Now access<a class="ulink" href="http://yourdomain.com/welcome">http://yourdomain.com/welcome</a>, or (depending on your provider)<a class="ulink" href="http://hostingdomain.com/username/welcome">http://hostingdomain.com/username/welcome</a>.</p></li><li class="listitem"><p>If you get access errors at this point, examine the most recent file in<code class="literal"> web2py/applications/welcome/errors/</code>, using the<code class="literal"> tail</code> command. This format isn't especially friendly, but it can provide useful clues. If the<code class="literal"> errors</code> directory is empty, you may need to double-check that the<code class="literal"> errors</code> directory is writable by the web server.</p></li></ol></div></div></div><div><div><div><div><h1 class="title"><a id="ch01lvl1sec10"/>Running web2py on shared hosts with mod_proxy</h1></div></div></div><p>Using<code class="literal"> mod_proxy</code> has two major advantages over CGI deployment discussed in the previous recipe: web2py runs continuously, so performance is considerably better, and it runs as your local user, which improves security. Because from web2py's perspective it appears to be running on localhost, the admin application can run, but if you don't have SSL operation available, you may want to disable admin for security reasons. SSL setup is discussed in the<em> Setting up a production deployment on Ubuntu</em> recipe.<a id="id39" class="indexterm"/>
</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec21"/>Getting ready</h2></div></div></div><p>Here we assume that you have already downloaded and unzipped web2py somewhere in your home folder. We also assume that your web hosting provider has mod_proxy enabled, supports long running processes, allows you to open a port (8000 in the example but you can change if this port is occupied by another user).</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec22"/>How to do it...</h2></div></div></div><div><ol class="orderedlist"><li class="listitem"><p>In your base web directory, create a file<code class="literal"> .htaccess</code>, if necessary, and add these lines:</p><div><pre class="programlisting"><strong>
RewriteEngine on
RewriteBase /usr/www/users/username
RewriteRule ^((welcome|examples|admin)(/.*)?)$ \
			http://127.0.0.1:8000/$1 [P]</strong>
</pre></div></li><li class="listitem"><p>Download and unzip web2py as described previously for CGI operation, except that web2py need not be installed in your<code class="literal"> cgi-bin</code> directory, or even in your web documents tree. For this recipe, we'll assume that you install it in your login home directory<code class="literal"> $HOME</code>.</p></li><li class="listitem"><p>Start web2py running on localhost and port<code class="literal"> 8000</code> with the following command:</p></li></ol></div><div><pre class="programlisting"><strong>nohup python web2py.py -a password -p 8000 -N</strong>
</pre></div><div><ul class="itemizedlist"><li class="listitem"><p>The <code class="literal">password</code> is the one time admin password that you choose. The -N is optional and it disables <code class="literal">web2py</code> cron to save memory. (Notice that this last step cannot be accomplished trhough FTP, so login access is required.)
</p></li></ul></div></div></div><div><div><div><div><h1 class="title"><a id="ch01lvl1sec11"/>Running web2py from a user-defined folder</h1></div></div></div><p>This recipe explains how to relocate the web2py<code class="literal"> applications</code> folder.<a id="id40" class="indexterm"/>
</p><p>With web2py, each application lives in a folder under the<code class="literal"> applications/</code> folder, which in turn is located in the web2py<code class="literal"> base</code> or<code class="literal"> root</code> folder (the folder that also contains<code class="literal"> gluon/</code>, the web2py core code).</p><p>When web2py is deployed using its built-in web server, the<code class="literal"> applications/</code> folder can be relocated to some other location in your file system. When<code class="literal"> applications/</code> is relocated, certain other files are relocated as well, including<code class="literal"> logging.conf, routes.py</code>, and<code class="literal"> parameters_port.py</code>. Additionally, a<code class="literal"> site-packages</code> in the same folder as the relocated<code class="literal"> applications/</code>, is inserted into<code class="literal"> sys.path</code> (this<code class="literal"> site-packages</code> directory need not exist).</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec23"/>How to do it...</h2></div></div></div><p>When web2py is run from the command line, the folder relocation is specified with the<code class="literal"> -f</code> option, which should specify the parent folder of the relocated<code class="literal"> applications/</code> folder, for example:</p><div><pre class="programlisting"><strong>python web2py.py -i 127.0.0.1 -p 8000 -f /path/to/apps</strong>
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec24"/>There's more...</h2></div></div></div><p>When web2py is run as a Windows service <code class="literal">(web2py.exe -W)</code>, the relocation can be specified in a file<code class="literal"> options.py</code> in the web2py main folder. Change the default folder:<code class="literal"> os.getcwd()</code> to specify the parent folder of the relocated<code class="literal"> applications/</code> folder. Here is an example of the<code class="literal"> options.py</code> file:</p><div><pre class="programlisting"><strong>
import socket
import os
ip = '0.0.0.0'
port = 80
interfaces=[('0.0.0.0',80),
	('0.0.0.0',443,'ssl_key.pem','ssl_certificate.pem')]
password = '&lt;recycle&gt;' # &lt;recycle&gt; means use the previous password
pid_filename = 'httpserver.pid'
log_filename = 'httpserver.log'
profiler_filename = None
#ssl_certificate = 'ssl_cert.pem' # certificate file
#ssl_private_key = 'ssl_key.pem' # private key file
#numthreads = 50 # ## deprecated; remove
minthreads = None
maxthreads = None
server_name = socket.gethostname()
request_queue_size = 5
timeout = 30
shutdown_timeout = 5
folder = "/path/to/apps" # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; edit this line
extcron = None
nocron = None</strong>
</pre></div><p>Applications relocation is not available when web2py is deployed with an external web server.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec25"/>How to do it...</h2></div></div></div><div><ol class="orderedlist"><li class="listitem"><p>First, create a web2py unprivileged user:<a id="id41" class="indexterm"/>
</p><div><pre class="programlisting"><strong>sudo adduser web2py</strong>
</pre></div></li><li class="listitem"><p>For security, disable the web2py user password to prevent remote logins:</p><div><pre class="programlisting"><strong>sudo passwd -l web2py</strong>
</pre></div></li><li class="listitem"><p>Download the source package from web2py's official website, uncompress it in a suitable directory (for example<code class="literal"> /opt/web2py)</code>, and set the access permissions appropriately:</p><div><pre class="programlisting"><strong>wget http://www.web2py.com/examples/static/web2py_src.zip
sudo unzip -x web2py_src.zip -d /opt
sudo chown -Rv web2py. /opt/web2py</strong>
</pre></div></li><li class="listitem"><p>Create an<code class="literal"> init</code> script in<code class="literal"> /etc/inid.d/web2py</code> (you can use the one in<code class="literal"> web2py/scripts/</code> as a starting point):</p><div><pre class="programlisting"><strong>sudo cp /opt/web2py/scripts/web2py.ubuntu.sh /etc/init.d/web2py</strong>
</pre></div></li><li class="listitem"><p>Edit the<code class="literal"> init</code> script:</p><div><pre class="programlisting"><strong>sudo nano /etc/init.d/web2py</strong>
</pre></div></li><li class="listitem"><p>Set the basic configuration parameters:</p><div><pre class="programlisting"><strong>PIDDIR=/opt/$NAME
DAEMON_DIR=/opt/$NAME
APPLOG_FILE=$DAEMON_DIR/web2py.log
DAEMON_ARGS="web2py.py -p 8001 -i 127.0.0.1 -c server.crt -k
server.key -a&lt;recycle&gt; --nogui --pid_filename=$PIDFILE -l \
$APPLOG_FILE"</strong>
</pre></div></li><li class="listitem"><p>Change<code class="literal"> 127.0.0.1</code> and<code class="literal"> 8001</code> to your desired IP and port. You can use<code class="literal"> 0.0.0.0</code> as a wildcard IP that match all the interfaces.</p></li><li class="listitem"><p>Create a self-signed certificate, if you plan on using admin remotely:</p><div><pre class="programlisting"><strong>sudo openssl genrsa -out /opt/web2py/server.key 1024
sudo openssl req -new -key /opt/web2py/server.key -out /opt/\
web2py/server.csr
sudo openssl x509 -req -days 365 -in /opt/web2py/server.csr \
-signkey /opt/web2py/server.key -out /opt/web2py/server.crt</strong>
</pre></div></li><li class="listitem"><p>If you use<code class="literal"> print</code> statements for debugging purposes, or want to record web2py output messages, you can redirect standard output, by adding the following line after the<code class="literal"> imports</code> in<code class="literal"> web2py.py:</code>
</p><div><pre class="programlisting"><strong>sys.stdout = sys.stderr = open("/opt/web2py/web2py.err","wa", 0)</strong>
</pre></div></li><li class="listitem"><p>Finally, start your web2py service:</p><div><pre class="programlisting"><strong>sudo /etc/init.d/web2py start</strong>
</pre></div></li><li class="listitem"><p>To install it permanently (so it starts and stop automatically with the rest of the operating system services), issue the following command:<a id="id42" class="indexterm"/>
</p></li></ol></div><div><pre class="programlisting"><strong>sudo update-rc.d web2py defaults</strong>
</pre></div><p>If all works correctly, you'll be able to open your web2py admin:</p><div><pre class="programlisting"><strong>https://127.0.0.1:8001/welcome/default/index</strong>
</pre></div></div></div><div><div><div><div><h1 class="title"><a id="ch01lvl1sec12"/>Installing web2py as a service in Ubuntu</h1></div></div></div><p>For simple sites and intranets, you may need a simple installation method that keeps web2py running. This recipe shows how to start web2py in a simple way without further dependencies (no Apache webserver!).<a id="id43" class="indexterm"/>
</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec26"/>There's more...</h2></div></div></div><p>You can see what is happening using<code class="literal"> bash</code> to debug the<code class="literal"> init</code> script:</p><div><pre class="programlisting"><strong>sudo bash -x /etc/init.d/web2py start</strong>
</pre></div><p>Also, you can change<code class="literal"> start-stop-daemon</code> options to be more verbose, and use the web2py user to prevent interference with other Python daemons:</p><div><pre class="programlisting"><strong>
start-stop-daemon --start \
	${DAEMON_USER:+--chuid $DAEMON_USER} --chdir $DAEMON_DIR \
	--background --user $DAEMON_USER --verbose --exec $DAEMON \
	--$DAEMON_ARGS || return 2</strong>
</pre></div><p>Remember to set up a password to be able to use the administrative interface. This can be done by executing the following command (change<code class="literal"> mypass</code> to your desired password):</p><div><pre class="programlisting"><strong>sudo -u web2py python /opt/web2py/web2py.py -p 8001 -a mypasswd</strong>
</pre></div></div></div><div><div><div><div><h1 class="title"><a id="ch01lvl1sec13"/>Running web2py with IIS as a proxy</h1></div></div></div><p>IIS is the primary web server for the Windows OS. It can run multiple concurrent domains and several application pools. When you deploy web2py on IIS, you want to set up a new site, and have a separate application pool for its root application. In this way, you have separate logs and ability to start/stop the application pool, independently on the others. Here we explain how.<a id="id44" class="indexterm"/>
</p><p>This is the first of three recipes in which we repeat the process using different configurations. In this first recipe, we set up IIS to act as a proxy for the web2py<strong> Rocket</strong> web server.</p><p>This configuration is desirable when IIS default site is already in production with enabled ASP.NET, ASP, or PHP applications, and at the same time, your web2py sites may be under-development and may require frequent restarting (for example, due to changes in<code class="literal"> routes.py)</code>.</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec27"/>Getting ready</h2></div></div></div><p>In this recipe, we assume that you have IIS version 7 or later, already installed. We do not discuss the steps to install IIS7, since it is a commercial product and they are well documented somewhere else.</p><p>You also need to have web2py unzipped in a local folder. Start web2py on port<code class="literal"> 8081</code>.</p><div><pre class="programlisting"><strong>python web2py -p 8081 -i 127.0.0.1 -a 'password'</strong>
</pre></div><p>Note that when running web2py as a proxy, you should be careful about unintentionally exposing admin without encryption.</p><p>Finally, you need to be able to use a IIS Proxy. For this, you will need<strong> Application Request Routing (ARR)</strong> <strong> 2.5</strong>. ARR can be downloaded and installed from Microsoft Web Platform Installer available here:</p><div><pre class="programlisting"><strong>http://www.microsoft.com/web/downloads/platform.aspx</strong>
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec28"/>How to do it...</h2></div></div></div><div><ol class="orderedlist"><li class="listitem"><p>After you download the web platform installer for ARR, open the application and browse to<strong> Products</strong> on the left-hand side of the screen, as shown in the following screenshot:</p><div><img src="img/5467OS_01_09.jpg" alt="How to do it..."/></div></li><li class="listitem"><p>Next, click on<strong> Add</strong> -<strong> Application Request Routing 2.5</strong>, and then click on<strong> Install</strong>. This will take you to a new screen, as shown in the following screenshot; click on<strong> I Accept:</strong>
<a id="id45" class="indexterm"/>
</p><div><img src="img/5467OS_01_10.jpg" alt="How to do it..."/></div></li><li class="listitem"><p>Web Platform installer will automatically select and install all the dependencies required for<strong> Application Request Routing 2.5</strong> to work. Click on<strong> Finish</strong>, and this will bring you to the<strong> Download and Installation</strong> screen.<a id="id46" class="indexterm"/>
</p><div><img src="img/5467OS_01_11.jpg" alt="How to do it..."/></div></li><li class="listitem"><p>Once you receive the successful message, you can close Microsoft web platform application.</p></li><li class="listitem"><p>Now open the IIS Manager, and create a new website as directed.</p></li><li class="listitem"><p>First, right-click on<strong> Sites</strong> on the top-left in the<strong> IIS Manager</strong>, and select<strong> New Website</strong>. This will take you to the following screen. Fill in the details as shown here:<a id="id47" class="indexterm"/>
</p><div><img src="img/5467OS_01_12.jpg" alt="How to do it..."/></div><div><ul class="itemizedlist"><li class="listitem"><p>Make sure you select the right IP on which your site will run.
</p></li></ul></div></li><li class="listitem"><p>Once the site is created, double-click the<strong> URL Rewrite</strong> as shown in the following screenshot:<a id="id48" class="indexterm"/>
</p><div><img src="img/5467OS_01_13.jpg" alt="How to do it..."/></div></li><li class="listitem"><p>Once in<strong> URL Rewrite</strong> module, click on<strong> Add Rule</strong> on the top-right-hand side, as shown in the next screenshot.</p></li><li class="listitem"><p>Select the<strong> Reverse Proxy</strong> template under<strong> Inbound and Outbound Rules</strong>.</p></li><li class="listitem"><p>Fill out the details as shown here:<a id="id49" class="indexterm"/>
</p><div><img src="img/5467OS_01_14.jpg" alt="How to do it..."/></div></li><li class="listitem"><p>Since the<strong> Server IP</strong> field is the most important, it must contain the IP and port where web2py is running:<code class="literal"> 127.0.0.1:8081</code>. Also, make sure that<strong> SSL Offloading</strong> is checked. In the outbound rules for the<strong> TO</strong> field, write the domain name assigned to the website. When done, click<strong> OK</strong>.</p><p>At this point, everything on your web2py installation should be working, except for the admin interface. Web2py requires that we use HTTPS when a request for the admin interface is coming for a non-localhost server. In our example, localhost for web2py is <code class="literal">127.0.0.1:8081</code>, while IIS is currently operational on <code class="literal">127.0.0.1:80.
</code>
</p></li><li class="listitem"><p>To enable the admin, you will need a certificate. Create a certificate and add it to your server certificates in IIS 7, then repeat the previous steps to bind<code class="literal"> 443</code> to the web2py website we created previously.</p></li><li class="listitem"><p>Now, visit:<code class="literal"> https://yourdomain.com/admin/</code>, and you will be able to browse the web2py admin web interface. Enter the password for your web2py admin interface, and proceed normally.<a id="id50" class="indexterm"/>
</p></li></ol></div></div></div><div><div><div><div><h1 class="title"><a id="ch01lvl1sec14"/>Running web2py with ISAPI</h1></div></div></div><p>Here, we present a production quality configuration, which uses a dedicated application pool run natively in IIS using the ISAPI handler. It is similar to a typical Linux/Apache configuration, but is a Windows native.<a id="id51" class="indexterm"/>
</p><div><div><div><div><h2 class="title"><a id="ch01lvl2sec29"/>Getting ready</h2></div></div></div><p>As before you will need IIS installed.</p><p>You should have web2py already downloaded and unzipped. If you have it already running on port<strong> 8081</strong> (or other port) on localhost, you can leave it there, since it should not interfere with this installation. We will assume web2py is installed into<code class="literal"> C:\path\to\web2py</code>.</p><p>You can place it anywhere else you like.</p><p>Then you need to download and install<code class="literal"> isapi-wsgi</code>. This is explained below.</p></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec30"/>How to do it...</h2></div></div></div><div><ol class="orderedlist"><li class="listitem"><p>First of all, you need to download<code class="literal"> isapi-wsgi</code> from:<a class="ulink" href="http://code.google.com/p/isapi-wsgi/"> http://code.google.com/p/isapi-wsgi/</a>.</p><p>It is a mature WSGI adapter for IIS, based on pywin32. Most of this recipe is based on the documentation and the examples about <code class="literal">isapi-wsgi.
</code>
</p><p>You can install isapi-wsgi using the win32 installer: <code class="literal">http://code.google.com/p/isapi-wsgi/downloads/detail?name=isapi_wsgi-0.4.2. win32.exe.
</code>
</p><p>You can also install it simply downloading the Python file somewhere into <code class="literal">"c:\Python\Lib\site-packages"
</code>
</p><p><a class="ulink" href="http://isapi-wsgi.googlecode.com/svn/tags/isapi_wsgi-0.4.2/isapi_wsgi.py">http://isapi-wsgi.googlecode.com/svn/tags/isapi_wsgi-0.4.2/isapi_wsgi.py.
</a>
</p><p><code class="literal">isapi_wsgi</code> runs on IIS 5.1, 6.0, and 7.0. But IIS 7.x must have <strong>IIS 6.0 Management Compatability</strong> installed.
</p><p>You may want to try running the following test to see that it was installed properly:
</p><div><pre class="programlisting"><strong>cd C:\Python\Lib\site-packages
C:\Python\Lib\site-packages&gt; python isapi_wsgi.py install
Configured Virtual Directory: isapi-wsgi-test
Extension installed
Installation complete.</strong>
</pre></div></li><li class="listitem"><p>Now go to<code class="literal"> http://localhost/isapi-wsgi-test/</code>.</p></li><li class="listitem"><p>If you get a<code class="literal"> 500 error</code> that says<code class="literal"> this is not a valid Win32 application</code>, then something is wrong and this is discussed here:<a class="ulink" href="http://support.microsoft.com/kb/895976/en-us"> http://support.microsoft.com/kb/895976/en-us</a>.</p></li><li class="listitem"><p>If you see a normal<code class="literal"> Hello</code> response, then the installation was successful, and you can remove the test:</p><div><pre class="programlisting"><strong>C:\Python\Lib\site-packages&gt; python isapi_wsgi.py remove</strong>
</pre></div><div><ul class="itemizedlist"><li class="listitem"><p>We are not yet ready to configure the web2py handler. You need to enable the 32-bits mode.
</p></li></ul></div></li><li class="listitem"><p>We are now ready to configure the web2py handler. Add your web2py installation to the<code class="literal"> PYTHONPATH:</code>
</p><div><pre class="programlisting"><strong>set PYTHONPATH=%PYTHONPATH%;C:\path\to\web2py</strong>
</pre></div></li><li class="listitem"><p>If it does not exist already, create the file<code class="literal"> isapiwsgihandler.py</code> in the<code class="literal"> C:\path\to\web2py</code> folder, which contains the following:<a id="id52" class="indexterm"/>
</p><div><pre class="programlisting"><strong>
import os
import sys
import isapi_wsgi

# The entry point for the ISAPI extension.
def __ExtensionFactory__():
	path = os.path.dirname(os.path.abspath(__file__))
	os.chdir(path)
	sys.path = [path]+[p for p in sys.path if not p==path]
	import gluon.main
	application = gluon.main.wsgibase
	return isapi_wsgi.ISAPISimpleHandler(application)
		
# ISAPI installation:
if __name__=='__main__':
	from isapi.install import ISAPIParameters
	from isapi.install import ScriptMapParams
	from isapi.install import VirtualDirParameters
	from isapi.install import HandleCommandLine
	params = ISAPIParameters()
	sm = [ScriptMapParams(Extension="*", Flags=0)]
vd = VirtualDirParameters(Name="appname",
	Description = "Web2py in Python", ScriptMaps = sm,
	ScriptMapUpdate = "replace")
params.VirtualDirs = [vd]
HandleCommandLine(params)</strong>
</pre></div><div><ul class="itemizedlist"><li class="listitem"><p>Recent versions of web2py may already contain this file, or even a better version.
</p></li></ul></div></li><li class="listitem"><p>The first part is the handler, and the second part will allow an automatic installation from the command line:</p></li></ol></div><div><pre class="programlisting"><strong>
cd c:\path\to\web2py
python isapiwsgihandler.py install --server=sitename</strong>
</pre></div><div><ul class="itemizedlist"><li class="listitem"><p>By default, this installs the extension for virtual directory <code class="literal">appname</code> under <code class="literal">Default Web Site.
</code>
<a id="id53" class="indexterm"/>
</p></li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch01lvl2sec31"/>There's more...</h2></div></div></div><p>Check the current mode for Web Applications (32 bits or 64 bits):</p><div><pre class="programlisting"><strong>cd C:\Inetpub\AdminScripts
cscript.exe adsutil.vbs get W3SVC/AppPools/Enable32BitAppOnWin64
cscript %systemdrive%\inetpub\AdminScripts\adsutil.vbs get w3svc/\
AppPools/Enable32bitAppOnWin64</strong>
</pre></div><p>If answer is<code class="literal"> The parameter "Enable32BitAppOnWin64" is not set at this node</code> or<code class="literal"> Enable32BitAppOnWin64 : (BOOLEAN) False</code>, then you must switch from 64 bits to 32 bits mode for the Web Server. ISAPI does not wok on IIS in 64 bits mode. You can switch with the command:</p><div><pre class="programlisting"><strong>cscript %systemdrive%\inetpub\AdminScripts\adsutil.vbs set w3svc/\
AppPools/Enable32bitAppOnWin64 1</strong>
</pre></div><p>Then restart application pool, as follows:</p><div><pre class="programlisting"><strong>IIsExt /AddFile %systemroot%\syswow64\inetsrv\httpext.dll 1 ^
WEBDAV32 1 "WebDAV (32-bit)"</strong>
</pre></div><p>Or set up a separate pool, as follows:</p><div><pre class="programlisting"><strong>system.webServer/applicationPool/add@enable32BitAppOnWin64.</strong>
</pre></div></div></div></div></div>
</body></html>