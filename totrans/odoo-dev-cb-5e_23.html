<html><head></head><body>
		<div id="_idContainer225">
			<h1 id="_idParaDest-964" class="chapter-number"><a id="_idTextAnchor1210"/>23</h1>
			<h1 id="_idParaDest-965"><a id="_idTextAnchor1211"/>Managing Emails in Odoo</h1>
			<p>Email integration is the most prominent feature of Odoo. You can send and receive emails directly from the Odoo user interface. You can even manage email threads on business documents, such as leads, sales orders, and projects. In this chapter, we will explore a few important ways to deal with emails <span class="No-Break">in Odoo.</span></p>
			<p>Here, we’ll cover the <span class="No-Break">following recipes:</span></p>
			<ul>
				<li>Configuring incoming and outgoing <span class="No-Break">email servers</span></li>
				<li>Managing chatter <span class="No-Break">on documents</span></li>
				<li>Managing activities <span class="No-Break">on documents</span></li>
				<li>Sending emails using the <span class="No-Break">Jinja template</span></li>
				<li>Sending emails using the <span class="No-Break">QWeb template</span></li>
				<li>Managing the <span class="No-Break">email alias</span></li>
				<li>Logging user changes in <span class="No-Break">a chatter</span></li>
				<li>Sending periodic <span class="No-Break">digest emails</span></li>
			</ul>
			<h1 id="_idParaDest-966"><a id="_idTextAnchor1212"/>Technical requirements</h1>
			<p>All the code used in this chapter can be downloaded <span class="No-Break">from </span><a href="https://github.com/PacktPublishing/Odoo-17-Development-Cookbook-Fifth-Edition/tree/main/Chapter23"><span class="No-Break">https://github.com/PacktPublishing/Odoo-17-Development-Cookbook-Fifth-Edition/tree/main/Chapter23</span></a><span class="No-Break">.</span></p>
			<h1 id="_idParaDest-967"><a id="_idTextAnchor1213"/>Configuring incoming and outgoing email servers</h1>
			<p>Before <a id="_idIndexMarker1614"/>you start sending and receiving emails in Odoo, you <a id="_idIndexMarker1615"/>will need to configure the incoming and outgoing email servers. In this recipe, you will learn how to configure email servers <span class="No-Break">in Odoo.</span></p>
			<h2 id="_idParaDest-968"><a id="_idTextAnchor1214"/>Getting ready</h2>
			<p>There is no development needed for this recipe, but you will require email server information, such as the server URL, port, server type, username, and password. We will use this information to configure the <span class="No-Break">email servers.</span></p>
			<p class="callout-heading">Note</p>
			<p class="callout">If you are using <strong class="bold">Odoo Online</strong> or <strong class="bold">Odoo.sh</strong>, you do not need to configure the email servers. You can send and receive emails without any complex configurations on those platforms. This recipe is for on-premises <span class="No-Break">Odoo instances.</span></p>
			<h2 id="_idParaDest-969"><a id="_idTextAnchor1215"/>How to do it...</h2>
			<p>Configuring incoming and outgoing email servers involves a few steps that are common to the <a id="_idIndexMarker1616"/>processes for incoming and outgoing servers and <a id="_idIndexMarker1617"/>a few steps that are unique to each kind of server. So, first, we will see the common configuration steps, and then we will configure the incoming and outgoing email servers individually. The following are the steps required for both incoming and outgoing <span class="No-Break">email servers:</span></p>
			<ol>
				<li>Open the <strong class="bold">General Settings</strong> form menu, at <strong class="bold">Settings</strong> | <span class="No-Break"><strong class="bold">General Settings</strong></span><span class="No-Break">.</span></li>
				<li>Go to the <strong class="bold">Discuss</strong> section and inside <strong class="bold">Alias Domain</strong>. This will display the <span class="No-Break">following options:</span></li>
			</ol>
			<p class="IMG---Figure">               </p>
			<div>
				<div id="_idContainer212" class="IMG---Figure">
					<img src="image/B20997_23_01.jpg" alt="Figure 23.1 – Setting an alias domain"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 23.1 – Setting an alias domain</p>
			<ol>
				<li value="3">In the <strong class="bold">Alias Domain</strong> field, enter the domain name on which your email server is running. Then, save <span class="No-Break">the configuration.</span></li>
			</ol>
			<h3>Configuring the incoming email server</h3>
			<p>Perform <a id="_idIndexMarker1618"/>the following steps to configure the incoming <span class="No-Break">email server:</span></p>
			<ol>
				<li>Open <strong class="bold">General Settings</strong> and click on the <strong class="bold">Incoming Email Servers</strong> link under Technical | Email. This will redirect you to a list view of incoming <span class="No-Break">email servers.</span></li>
				<li>Click on the <strong class="bold">Create</strong> button, which will open the following form view. Enter the details of your incoming email server (see the <em class="italic">How it works…</em> section for an explanation of <span class="No-Break">each field):</span></li>
			</ol>
			<div>
				<div id="_idContainer213" class="IMG---Figure">
					<img src="image/B20997_23_02.jpg" alt="Figure 23.2 – Configuring the incoming email server"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 23.2 – Configuring the incoming email server</p>
			<ol>
				<li value="3">Click on <a id="_idIndexMarker1619"/>the <strong class="bold">Test &amp; Confirm</strong> button to verify your configuration. It will show an error message if you have wrongly configured the incoming <span class="No-Break">email server.</span></li>
			</ol>
			<h3>Configuring the outgoing email server</h3>
			<p>Follow these <a id="_idIndexMarker1620"/>steps to configure the outgoing <span class="No-Break">email server:</span></p>
			<ol>
				<li>Open <strong class="bold">General Settings</strong> and enable the <strong class="bold">Custom Email Servers</strong> option, then click on the <strong class="bold">Outgoing Email Servers</strong> link. This will redirect you to the list view of outgoing <span class="No-Break">email servers.</span></li>
				<li>Click on <strong class="bold">Create</strong>, which will open the following form view. Enter the details of your outgoing email server (see the <em class="italic">How it works…</em> section for an explanation of <span class="No-Break">each field):</span></li>
			</ol>
			<div>
				<div id="_idContainer214" class="IMG---Figure">
					<img src="image/B20997_23_03.jpg" alt="Figure 23.3 – Configuring the outgoing email server"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 23.3 – Configuring the outgoing email server</p>
			<ol>
				<li value="3">Click on <strong class="bold">Test Connection</strong> at the bottom of the screen to verify your configuration. It will show an error message if you have wrongly configured the outgoing <span class="No-Break">email server.</span></li>
			</ol>
			<p>The outgoing email server will display the error dialog even if you have configured it properly. Look for a <strong class="bold">Connection Test Successful!</strong> message in the error dialog body. It means your outgoing server is <span class="No-Break">configured correctly.</span></p>
			<h2 id="_idParaDest-970"><a id="_idTextAnchor1216"/>How it works...</h2>
			<p>The steps given in this recipe are self-explanatory and do not require further explanation. But the outgoing email and incoming email records have several fields, so let’s see <span class="No-Break">their purpose.</span></p>
			<p>Here is a <a id="_idIndexMarker1621"/>list of fields used to configure the incoming <span class="No-Break">email server:</span></p>
			<ul>
				<li><strong class="bold">Name</strong>: The name of the server, which helps you identify a specific incoming email server when you have configured multiple incoming <span class="No-Break">email servers.</span></li>
				<li><strong class="bold">Server Type</strong>: Here, you need to choose from three options: <strong class="bold">POP Server</strong>, <strong class="bold">IMAP Server</strong>, and <strong class="bold">Local Server</strong>. The value of this field will be based on your email <span class="No-Break">service provider.</span></li>
				<li><strong class="bold">Server Name</strong>: The domain of the server on which the service <span class="No-Break">is running.</span></li>
				<li><strong class="bold">Port</strong>: The number of the port on which the server <span class="No-Break">is running.</span></li>
				<li><strong class="bold">SSL/TLS</strong>: Check this field if you are using <span class="No-Break">SSL/TLS encryption.</span></li>
				<li><strong class="bold">Username</strong>: The email address for which you are <span class="No-Break">fetching emails.</span></li>
				<li><strong class="bold">Password</strong>: The password for the email <span class="No-Break">address provided.</span></li>
				<li><strong class="bold">Active</strong>: This field is used to enable or disable the incoming <span class="No-Break">email server.</span></li>
				<li><strong class="bold">Keep Attachment</strong>: Turn off this option if you do not want to manage attachments from <span class="No-Break">incoming emails.</span></li>
				<li><strong class="bold">Keep Original</strong>: Turn on this option if you want to keep the original email along with the <span class="No-Break">preceding one.</span></li>
			</ul>
			<p>The following is a <a id="_idIndexMarker1622"/>list of fields used for configuring the outgoing <span class="No-Break">email server:</span></p>
			<ul>
				<li><strong class="bold">Name</strong>: The name of the server, which helps you identify a specific incoming email server when you have configured multiple incoming <span class="No-Break">email servers.</span></li>
				<li><strong class="bold">Priority</strong>: This field is used to define the priority of the outgoing email server. Lower numbers get higher priority, so email servers with a lower priority number will be <span class="No-Break">used most.</span></li>
				<li><strong class="bold">SMTP Server</strong>: The domain of the server on which the service <span class="No-Break">is running.</span></li>
				<li><strong class="bold">SMTP Port</strong>: The number <a id="_idIndexMarker1623"/>of the port on which the server <span class="No-Break">is running.</span></li>
				<li><strong class="bold">Connection Encryption</strong>: The type of security used to <span class="No-Break">send emails.</span></li>
				<li><strong class="bold">Username</strong>: The email account used for <span class="No-Break">sending emails.</span></li>
				<li><strong class="bold">Password</strong>: The password for the email <span class="No-Break">account provided.</span></li>
				<li><strong class="bold">Active</strong>: This field is used to enable or disable the outgoing <span class="No-Break">email server.</span></li>
			</ul>
			<h2 id="_idParaDest-971"><a id="_idTextAnchor1217"/>There’s more...</h2>
			<p>By default, incoming emails are fetched every 5 minutes. If you want to change this interval, follow <span class="No-Break">these steps:</span></p>
			<ol>
				<li>Activate <span class="No-Break">developer mode.</span></li>
				<li>Open <strong class="bold">Scheduled Actions</strong> at <strong class="bold">Settings</strong> | <strong class="bold">Technical</strong> | <strong class="bold">Automation</strong> |<strong class="bold"> </strong><span class="No-Break"><strong class="bold">Scheduled Actions</strong></span><span class="No-Break">.</span></li>
				<li>Search for and open the scheduled action named <strong class="bold">Mail: </strong><span class="No-Break"><strong class="bold">Fetchmail Service</strong></span><span class="No-Break">.</span></li>
				<li>Change the interval using the field labeled <span class="No-Break"><strong class="bold">Execute Every</strong></span><span class="No-Break">.</span></li>
			</ol>
			<h1 id="_idParaDest-972"><a id="_idTextAnchor1218"/>Managing chatter on documents</h1>
			<p>In this recipe, you <a id="_idIndexMarker1624"/>will learn how to manage chatter on your documents and add a communication thread to <span class="No-Break">a record.</span></p>
			<h2 id="_idParaDest-973"><a id="_idTextAnchor1219"/>Getting ready</h2>
			<p>For this recipe, we will reuse the <strong class="source-inline">my_hostel</strong> module from <a href="B20997_08.xhtml#_idTextAnchor388"><span class="No-Break"><em class="italic">Chapter 8</em></span></a>, <em class="italic">Advanced Server-Side Development Techniques</em>. You can grab an initial copy of the module from the <strong class="source-inline">Chapter23/ 00_initial_module</strong> directory of the GitHub repository for this hostel room. In this recipe, we will add chatter to the <span class="No-Break"><strong class="source-inline">hostel.student</strong></span><span class="No-Break"> model.</span></p>
			<h2 id="_idParaDest-974"><a id="_idTextAnchor1220"/>How to do it...</h2>
			<p>Follow these <a id="_idIndexMarker1625"/>steps to add chatter on the records of the <span class="No-Break"><strong class="source-inline">hostel.student</strong></span><span class="No-Break"> model:</span></p>
			<ol>
				<li>Add the <strong class="source-inline">mail</strong> module dependency in the <span class="No-Break"><strong class="source-inline">__manifest__.py</strong></span><span class="No-Break"> file:</span><pre class="source-code">
...
'depends': ['mail'],
...</pre></li>				<li>Inherit <strong class="source-inline">mail.thread</strong> in the Python definition of the <span class="No-Break"><strong class="source-inline">hostel.student</strong></span><span class="No-Break"> model:</span><pre class="source-code">
class HostelStudent(models.Model):
   _name = "hostel.student"
   _description = "Hostel Student Information"
   _inherit = ['mail.thread']
...</pre></li>				<li>Add chatter widgets on the form view of the <span class="No-Break"><strong class="source-inline">hostel.student</strong></span><span class="No-Break"> model:</span><pre class="source-code">
...
&lt;/sheet&gt;
                   &lt;div class="oe_chatter"&gt;
                       &lt;field name="message_follower_ids" widget="mail_followers"/&gt;
                       &lt;field name="message_ids" widget="mail_thread"/&gt;
                   &lt;/div&gt;
               &lt;/form&gt;
...</pre></li>				<li>Install the <strong class="source-inline">my_hostel</strong> module to see the changes <span class="No-Break">in action:</span></li>
			</ol>
			<div>
				<div id="_idContainer215" class="IMG---Figure">
					<img src="image/B20997_23_04.jpg" alt="Figure 23.4 – Chatter on the hostel student form view"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 23.4 – Chatter on the hostel student form view</p>
			<p>As shown <a id="_idIndexMarker1626"/>in the preceding screenshot, after installing the module, you will be able to see chatter in the <span class="No-Break">form view.</span></p>
			<h2 id="_idParaDest-975"><a id="_idTextAnchor1221"/>How it works...</h2>
			<p>In order to enable chatter on any model, you will need to install the <strong class="source-inline">mail</strong> module first. This is because all the code required to enable chatter or mailing capabilities is part of the <strong class="source-inline">mail</strong> module. That’s why, in <em class="italic">step 1</em>, we added the <strong class="source-inline">mail</strong> module dependency in the manifest file of the <strong class="source-inline">my_hostel</strong> module. This will automatically install the <strong class="source-inline">mail</strong> module whenever you install the <span class="No-Break"><strong class="source-inline">my_hostel</strong></span><span class="No-Break"> module.</span></p>
			<p>The fields and methods required to operate chatter are part of the <strong class="source-inline">mail.thread</strong> model. The <strong class="source-inline">mail.thread</strong> model is an abstract model and is just used for inheritance purposes. In <em class="italic">step 2</em>, we inherited the <strong class="source-inline">mail.thread</strong> model in the <strong class="source-inline">hostel.student</strong> model. This will add all the necessary fields and methods required for chatter in the <strong class="source-inline">hostel.student</strong> model. If you don’t know how model inheritance works, refer to the <em class="italic">Using abstract models for reusable model features</em> recipe in <a href="B20997_04.xhtml#_idTextAnchor118"><span class="No-Break"><em class="italic">Chapter 4</em></span></a>, <span class="No-Break"><em class="italic">Application Models</em></span><span class="No-Break">.</span></p>
			<p>In <em class="italic">steps 1</em> and <em class="italic">2</em>, we added all the fields and methods required for chatter. The only remaining thing for chatter is adding a user interface in the form view. In <em class="italic">step 3</em>, we added a message thread and follower widget. You might be wondering about the <strong class="source-inline">message_follower_ids</strong> and <strong class="source-inline">message_ids</strong> fields. These fields are not added in the <strong class="source-inline">hostel.student</strong> model definition but they are added from the <strong class="source-inline">mail.thread</strong> model <span class="No-Break">through inheritance.</span></p>
			<h2 id="_idParaDest-976"><a id="_idTextAnchor1222"/>There’s more...</h2>
			<p>When you post messages in a chatter, emails will be sent to the followers. If you noticed in the example <a id="_idIndexMarker1627"/>of this recipe, the room of the student is not the follower of the records, so they will not receive the messages. If you want to send an email notification to the student, you will need to add them to the student list. You can add the follower manually from the user interface, but if you want to add them automatically, you can use the <strong class="source-inline">message_subscribe()</strong> method. Take a look at the following code—when we assign a hostel room, the given code will automatically add the student to the list <span class="No-Break">of followers:</span></p>
			<pre class="source-code">
   @api.model
   def create(self, values):
       result = super().create(values)
       partner_id = self.env['res.partner'].create({
           'name': result.name,
           'email': result.email
       })
       result.message_subscribe(partner_ids=[partner_id.id])
       return result</pre>			<p>Similarly, if you want to remove followers from the list, you can use the <span class="No-Break"><strong class="source-inline">message_unsubscribe()</strong></span><span class="No-Break"> method.</span></p>
			<h1 id="_idParaDest-977"><a id="_idTextAnchor1223"/>Managing activities on documents</h1>
			<p>When using chatter, you can also add activities. These are used to plan your actions on the record. It is <a id="_idIndexMarker1628"/>kind of a to-do list for each record. In this recipe, you will learn how to enable activities on <span class="No-Break">any model.</span></p>
			<h2 id="_idParaDest-978"><a id="_idTextAnchor1224"/>Getting ready</h2>
			<p>For this recipe, we will be using the <strong class="source-inline">my_hostel</strong> module from the previous recipe, <em class="italic">Managing chatter on documents</em>. We will add activities to the <span class="No-Break"><strong class="source-inline">hostel.student</strong></span><span class="No-Break"> model.</span></p>
			<h2 id="_idParaDest-979"><a id="_idTextAnchor1225"/>How to do it...</h2>
			<p>Follow these steps to add activities to the <span class="No-Break"><strong class="source-inline">hostel.student</strong></span><span class="No-Break"> model:</span></p>
			<ol>
				<li>Inherit <strong class="source-inline">mail.activity.mixin</strong> in the Python definition of the <span class="No-Break"><strong class="source-inline">hostel.student</strong></span><span class="No-Break"> model:</span><pre class="source-code">
class HostelStudent(models.Model):
   _name = "hostel.student"
   _description = "Hostel Student Information"
   _inherit = ['mail.thread', 'mail.activity.mixin']
...</pre></li>				<li>Add the <strong class="source-inline">mail_activity</strong> widget in the chatter of the <span class="No-Break"><strong class="source-inline">hostel.student</strong></span><span class="No-Break"> model:</span><pre class="source-code">
...
&lt;div class="oe_chatter"&gt;
                       &lt;field name="message_follower_ids" 
                       widget="mail_followers"/&gt;
                       &lt;field name="activity_ids" widget="mail_
                       activity"/&gt;
                       &lt;field name="message_ids" widget="mail_
                       thread"/&gt;
                   &lt;/div&gt;
...</pre></li>				<li>Update the <strong class="source-inline">my_hostel</strong> module to apply the changes. This will display <span class="No-Break">chatter activities:</span></li>
			</ol>
			<div>
				<div id="_idContainer216" class="IMG---Figure">
					<img src="image/Image96422.jpg" alt="Figure 23.5 – Activity manager on the hostel student form view"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 23.5 – Activity manager on the hostel student form view</p>
			<p>This is how the user <a id="_idIndexMarker1629"/>will be able to manage different chatter activities. Note that an activity scheduled by one user is visible to all other <span class="No-Break">users too.</span></p>
			<h2 id="_idParaDest-980"><a id="_idTextAnchor1226"/>How it works...</h2>
			<p>Activities are part of the <strong class="source-inline">mail</strong> module, and you can optionally enable them in chatter. In order to enable activities on records, you need to inherit <strong class="source-inline">mail.activity.mixin</strong>. Similar to the <strong class="source-inline">mail.thread</strong> model, <strong class="source-inline">mail.activity.mixin</strong> is also an abstract model. Inheriting <strong class="source-inline">mail.activity.mixin</strong> will add all the necessary fields and methods in the module. These methods and fields are used to manage activities on records. In <em class="italic">step 1</em>, we added <strong class="source-inline">mail.activity.mixin</strong> into the <strong class="source-inline">hostel.student</strong> model. Because of this, the inheritance of <strong class="source-inline">hostel.student</strong> will get all the methods and fields required to <span class="No-Break">manage activities.</span></p>
			<p>In <em class="italic">step 2</em>, we added the <strong class="source-inline">mail_activity</strong> widget in the form view. This will display the UI for managing activities. The <strong class="source-inline">activity_ids</strong> field is added in the <strong class="source-inline">hostel.student</strong> model <span class="No-Break">through inheritance.</span></p>
			<p>Activities can be <a id="_idIndexMarker1630"/>of different types. By default, you can create activities with types such as <strong class="source-inline">Email</strong>, <strong class="source-inline">Call</strong>, <strong class="source-inline">Meeting</strong>, and <strong class="source-inline">To-Do</strong>. If you want to add your own activity type, you can do it by going to <strong class="bold">Settings</strong> | <strong class="bold">Technical</strong> | <strong class="bold">Discuss</strong> | <strong class="bold">Activity Types</strong> in <span class="No-Break">developer mode.</span></p>
			<h2 id="_idParaDest-981"><a id="_idTextAnchor1227"/>There’s more...</h2>
			<p>If you want to schedule an activity automatically, you can use the <strong class="source-inline">activity_schedule()</strong> method of the <strong class="source-inline">mail.activity.mixin</strong> model. This will create an activity on a given discharge date. You can schedule the activity manually with the <strong class="source-inline">activity_schedule()</strong> method, <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
@api.model
   def create(self, values):
       result = super(HostelStudent, self).create(values)
       if result.discharge_date:
           result.activity_schedule('mail.mail_activity_data_call',
                               date_deadline=result.discharge_date)
       return result
    return res</pre>			<p>This example will schedule a call activity for the student whenever someone discharges a hostel. The deadline for the activity will be set as the discharge date of the hostel so that the rector can make a call to the student on <span class="No-Break">that date.</span></p>
			<h1 id="_idParaDest-982"><a id="_idTextAnchor1228"/>Sending emails using the Jinja template</h1>
			<p>Odoo <a id="_idIndexMarker1631"/>supports creating dynamic emails through Jinja <a id="_idIndexMarker1632"/>templates. Jinja is a text-based templating engine used to generate dynamic HTML content. In this recipe, we will create a Jinja email template and then send emails with <span class="No-Break">its help.</span></p>
			<h2 id="_idParaDest-983"><a id="_idTextAnchor1229"/>Getting ready</h2>
			<p>For this recipe, we will be using the <strong class="source-inline">my_hostel</strong> module from the previous recipe, <em class="italic">Managing activities on documents</em>. We will add the Jinja template to send an email to the student to tell them about the admission to <span class="No-Break">the hostel.</span></p>
			<h2 id="_idParaDest-984"><a id="_idTextAnchor1230"/>How to do it...</h2>
			<p>Follow these <a id="_idIndexMarker1633"/>steps to send a reminder email to <span class="No-Break">the student:</span></p>
			<ol>
				<li>Create <a id="_idIndexMarker1634"/>a new file called <strong class="source-inline">my_hostel/data/mail_template.xml</strong> and add the <span class="No-Break">email template:</span><pre class="source-code">
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;odoo noupdate="1"&gt;
   &lt;record id="assign_room_to_student" model="mail.template"&gt;
       &lt;field name="name"&gt;Assign Room To Student&lt;/field&gt;
       &lt;field name="model_id" ref="my_hostel.model_hostel_student"/&gt;
       &lt;field name="email_from"&gt;{{ (object.room_id.create_uid.email) }}&lt;/field&gt;
       &lt;field name="email_to"&gt;{{ (object.email) }}&lt;/field&gt;
       &lt;field name="subject"&gt;Assign Room&lt;/field&gt;
       &lt;field name="body_html" type="html"&gt;
           &lt;div style="margin: 0px; padding: 0px;"&gt;
               &lt;p style="margin: 0px; padding: 0px; font-size: 13px;"&gt;
                   Dear &lt;t t-out="object.name"&gt;&lt;/t&gt;,
                   &lt;br/&gt;&lt;br/&gt;
                   &lt;p&gt;You have been assigned hostel
                       &lt;b&gt;&lt;t t-out="object.hostel_id.name"&gt;&lt;/t&gt;&lt;/b&gt; and room no &lt;t t-out="object.room_id.room_no"&gt;&lt;/t&gt;.
                   &lt;br/&gt;
                   Your admission date in a hostel is &lt;b style="color:red;"&gt;&lt;t t-out="format_date(object.admission_date)"&gt;&lt;/t&gt;.&lt;/b&gt;
                   &lt;/p&gt;
                   &lt;br/&gt;
                   &lt;p&gt;Best regards,
                   &lt;br/&gt;&lt;t t-out="object.hostel_id.name"&gt;&lt;/t&gt;&lt;/p&gt;
               &lt;/p&gt;
           &lt;/div&gt;
       &lt;/field&gt;
   &lt;/record&gt;
&lt;/odoo&gt;</pre></li>				<li>Register <a id="_idIndexMarker1635"/>the <a id="_idIndexMarker1636"/>template file in the <span class="No-Break">manifest file:</span><pre class="source-code">
...
"data": [
       "security/hostel_security.xml",
       "security/ir.model.access.csv",
       "data/categ_data.xml",
       "<strong class="bold">data/mail_template.xml",</strong>
       "views/hostel.xml",
       "views/hostel_room.xml",
       "views/hostel_amenities.xml",
       "views/hostel_student.xml",
       "views/hostel_categ.xml",
       "views/hostel_room_category_view.xml",
   ],
...</pre></li>				<li>Add <a id="_idIndexMarker1637"/>a <strong class="bold">Send Email For Assign Room</strong> button in <a id="_idIndexMarker1638"/>the form view of the <strong class="source-inline">hostel.student</strong> model to send <span class="No-Break">the email:</span><pre class="source-code">
...
&lt;header&gt;
    &lt;button name="send_mail_assign_room"
            string="Send Email For Assign Room"
            type="object"/&gt;
    &lt;button name="action_assign_room"
            string="Assign Room"
            type="object"
            class="btn-primary"/&gt;
    &lt;field name="status" widget="statusbar" options="{'clickable':           '1'}"/&gt;
&lt;/header&gt;
...</pre></li>				<li>Add the <strong class="source-inline">send_mail_assign_room()</strong> method to the <span class="No-Break"><strong class="source-inline">hostel.student</strong></span><span class="No-Break"> model:</span><pre class="source-code">
...
def send_mail_assign_room(self):
      self.message_post_with_source('my_hostel.assign_room_to_student')</pre></li>			</ol>
			<p>Update <a id="_idIndexMarker1639"/>the <strong class="source-inline">my_hostel</strong> module to apply the <a id="_idIndexMarker1640"/>changes. This will add a <strong class="bold">Send Email</strong><strong class="source-inline"> </strong><strong class="bold">For Assign Room</strong> button in the form view of the <strong class="source-inline">hostel.student</strong> model. When they click on the button, followers will get <span class="No-Break">this message:</span></p>
			<div>
				<div id="_idContainer217" class="IMG---Figure">
					<img src="image/B20997_23_06.jpg" alt="Figure 23.6 – Email sent via a Jinja template"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 23.6 – Email sent via a Jinja template</p>
			<p>The procedure shown in this recipe is useful when you want to send updates to your customers through emails. Because of the Jinja template, you can send emails dynamically based on <span class="No-Break">individual records.</span></p>
			<h2 id="_idParaDest-985"><a id="_idTextAnchor1231"/>How it works...</h2>
			<p>In <em class="italic">step 1</em>, we created an email template using Jinja. Jinja templates help us generate a dynamic email based on record data. The email template is stored in the <strong class="source-inline">mail.template</strong> model. Let’s see a list of fields you will need to pass in order to create a <a id="_idIndexMarker1641"/>Jinja <span class="No-Break">email template:</span></p>
			<ul>
				<li><strong class="source-inline">name</strong>: The name of the template that is used to identify a <span class="No-Break">specific template.</span></li>
				<li><strong class="source-inline">email_from</strong>: The value of this field will be the email address from which this email <span class="No-Break">is sent.</span></li>
				<li><strong class="source-inline">email_to</strong>: The value of this field will be the email address of <span class="No-Break">the recipient.</span></li>
				<li><strong class="source-inline">email_cc</strong>: The value of this field will be used for the email address to send a copy of <span class="No-Break">the email.</span></li>
				<li><strong class="source-inline">subject</strong>: This field contains the subject of <span class="No-Break">the email.</span></li>
				<li><strong class="source-inline">model_id</strong>: This field contains the reference of the model. The email template will be rendered with the data of <span class="No-Break">this model.</span></li>
				<li><strong class="source-inline">body_html</strong>: This field will contain the body of the email template. It is a Jinja template, so you can use variables, loops, conditions, and so on. If you want to learn more about Jinja templates, go to <a href="http://jinja.pocoo.org/docs/2.10/">http://jinja.pocoo.org/docs/2.10/</a>. Usually, we wrap the content in the <strong class="source-inline">CDATA</strong> tag so that the content in the body is considered as character data and not <span class="No-Break">as markup.</span></li>
				<li><strong class="source-inline">auto_delete</strong>: This is a Boolean field that deletes an email once the email is sent. The default value of this field <span class="No-Break">is </span><span class="No-Break"><strong class="source-inline">False</strong></span><span class="No-Break">.</span></li>
				<li><strong class="source-inline">lang</strong>: This field is used to translate the email template into <span class="No-Break">another language.</span></li>
				<li><strong class="source-inline">scheduled_date</strong>: This field is used to schedule emails in <span class="No-Break">the future.</span></li>
			</ul>
			<p class="callout-heading">Information</p>
			<p class="callout">You can use <strong class="source-inline">${}</strong> in the <strong class="source-inline">email_form</strong>, <strong class="source-inline">email_to</strong>, <strong class="source-inline">email_cc</strong>, <strong class="source-inline">subject</strong>, <strong class="source-inline">scheduled_date</strong>, and <strong class="source-inline">lang</strong> fields. This helps you to set values dynamically. Take a look at <em class="italic">step 1</em> in our recipe—we used <strong class="source-inline">{{ (object.email) }}</strong> to set the <strong class="source-inline">email_to</strong> <span class="No-Break">field dynamically.</span></p>
			<p>If you look closely at the content of the <strong class="source-inline">body_html</strong> field, you will notice we used <strong class="source-inline">&lt;t t-out="object.name"&gt;</strong>. Here, the object is the recordset of the <strong class="source-inline">hostel.student</strong> model. During the rendering,<strong class="source-inline">&lt;t t-out="object.hostel_id.name"&gt;&lt;/t&gt;</strong> will be replaced with the hostel name. As well as <strong class="source-inline">object</strong>, some other helper functions and variables are passed in the rendering <a id="_idIndexMarker1642"/>context. Here is a list of helpers passed <a id="_idIndexMarker1643"/>to the <span class="No-Break">renderer context:</span></p>
			<ul>
				<li><strong class="source-inline">object</strong>: This variable will contain the recordset of the model, which is set in the template by the <span class="No-Break"><strong class="source-inline">model_id</strong></span><span class="No-Break"> field</span></li>
				<li><strong class="source-inline">format_date</strong>: This is a reference to the method used to format <span class="No-Break">date-time objects</span></li>
				<li><strong class="source-inline">format_datetime</strong>: This is a reference to the method used to convert the UTC date and time into the date and time for another <span class="No-Break">time zone</span></li>
				<li><strong class="source-inline">format_amount</strong>: This is a reference to the method used to convert <strong class="source-inline">float</strong> into <strong class="source-inline">string</strong> with the <span class="No-Break">currency symbol</span></li>
				<li><strong class="source-inline">format_duration</strong>: This method is used to convert <strong class="source-inline">float</strong> into <strong class="source-inline">time</strong>—for instance, to convert 1.5 <span class="No-Break">to 01:30</span></li>
				<li><strong class="source-inline">user</strong>: This will be the recordset of the <span class="No-Break">current user</span></li>
				<li><strong class="source-inline">ctx</strong>: This will contain the dictionary of the <span class="No-Break">environment context</span></li>
			</ul>
			<p class="callout-heading">Note</p>
			<p class="callout">If you want to see the list of templates, activate developer mode, and open the <strong class="bold">Settings</strong> | <strong class="bold">Technical</strong> | <strong class="bold">Email</strong> | <strong class="bold">Templates</strong> menu. The form view of the template also provides a button to preview the <span class="No-Break">rendered template.</span></p>
			<p>In <em class="italic">step 2</em>, we registered the template file in the <span class="No-Break">manifest file.</span></p>
			<p>In <em class="italic">step 3</em>, we added a button in the form view to invoke the <strong class="source-inline">send_mail_assign_room()</strong> method, which will send the email to <span class="No-Break">the followers.</span></p>
			<p>In <em class="italic">step 4</em>, we added the <strong class="source-inline">send_mail_assign_room()</strong> method, which will be invoked by clicking the button. The<strong class="source-inline"> message_post_with_source()</strong> method is used to send the email. The <strong class="source-inline">message_post_with_source()</strong> method is inherited in the model through <strong class="source-inline">mail.thread</strong> inheritance. To send the email, you just need to pass the template ID as <span class="No-Break">the parameter.</span></p>
			<h2 id="_idParaDest-986"><a id="_idTextAnchor1232"/>There’s more...</h2>
			<p>The <strong class="source-inline">message_post_with_source()</strong> method is used to send emails with the Jinja template. If you just want to send an email with plain text, you can use the <span class="No-Break"><strong class="source-inline">message_post()</strong></span><span class="No-Break"> method:</span></p>
			<pre class="source-code">
self.message_post(body="Your hostel admission process is completed.")</pre>			<p>The preceding <a id="_idIndexMarker1644"/>code will add a <strong class="bold">Your hostel admission process is completed</strong> message in the chatter. All followers will be notified <a id="_idIndexMarker1645"/>with this message. If you just want to log the message, call the method with the <span class="No-Break"><strong class="source-inline">subtype_id</strong></span><span class="No-Break"> parameter.</span></p>
			<h1 id="_idParaDest-987"><a id="_idTextAnchor1233"/>Sending emails using the QWeb template</h1>
			<p>In the previous recipe, we learned how to send emails using the Jinja template. In this recipe, we will <a id="_idIndexMarker1646"/>see another way to send dynamic <a id="_idIndexMarker1647"/>emails. We will send emails with the help of the <span class="No-Break">QWeb template.</span></p>
			<h2 id="_idParaDest-988"><a id="_idTextAnchor1234"/>Getting ready</h2>
			<p>For this recipe, we will use the <strong class="source-inline">my_hostel</strong> module from the previous recipe, <em class="italic">Sending emails using the Jinja template</em>. We will use the QWeb template to send an email to the student informing them that their admission was completed in <span class="No-Break">the hostel.</span></p>
			<h2 id="_idParaDest-989"><a id="_idTextAnchor1235"/>How to do it...</h2>
			<p>Follow these steps to send a reminder email to <span class="No-Break">the student:</span></p>
			<ol>
				<li>Add <a id="_idIndexMarker1648"/>the QWeb <a id="_idIndexMarker1649"/>template into the <span class="No-Break"><strong class="source-inline">my_hostel/data/mail_template.xml</strong></span><span class="No-Break"> file:</span><pre class="source-code">
   &lt;template id="assign_room_to_student_qweb"&gt;
       &lt;p&gt;Dear &lt;span t-field="object.name"/&gt;,&lt;/p&gt;
       &lt;br/&gt;
       &lt;p&gt;You have been assigned hostel
           &lt;b&gt;
               &lt;span t-field="object.hostel_id.name"/&gt;
           &lt;/b&gt; and room no &lt;span t-field="object.room_id.room_no"/&gt;.
           &lt;br/&gt;
           Your admission date in a hostel is
           &lt;b style="color:red;"&gt;
               &lt;span t-field="object.admission_date"/&gt;.
           &lt;/b&gt;
       &lt;/p&gt;
       &lt;br/&gt;
       &lt;p&gt;Best regards,
           &lt;br/&gt;
           &lt;span t-field="object.hostel_id.name"/&gt;
       &lt;/p&gt;
   &lt;/template&gt;</pre></li>				<li>Add <a id="_idIndexMarker1650"/>a <strong class="bold">Send Email For Assign Room (QWeb)</strong> button <a id="_idIndexMarker1651"/>in the form view of the <strong class="source-inline">hostel.student</strong> model to send <span class="No-Break">the email:</span><pre class="source-code">
...
&lt;header&gt;
     &lt;button name="send_mail_assign_room"
             string="Send Email For Assign Room"
             type="object"/&gt;
     &lt;button name="send_mail_assign_room_qweb"
             string="Send Email For Assign Room (QWeb)"
             type="object"/&gt;
     &lt;button name="action_assign_room"
             string="Assign Room"
             type="object"
             class="btn-primary"/&gt;
     &lt;field name="status" widget="statusbar" 
     options="{'clickable': '1'}"/&gt;
&lt;/header&gt;
...</pre></li>				<li>Add the <strong class="source-inline">send_mail_assign_room_qweb()</strong> method in the <span class="No-Break"><strong class="source-inline">hostel.student</strong></span><span class="No-Break"> model:</span><pre class="source-code">
...
def send_mail_assign_room_qweb(self):
  self.message_post_with_source('my_hostel.assign_room_to_student_qweb')</pre></li>				<li>Update the <strong class="source-inline">my_hostel</strong> module to apply the changes. This will add a <strong class="bold">Send Email For Assign Room (QWeb)</strong> button in the form view of the <strong class="source-inline">hostel.student</strong> model. When the button is clicked, followers will get a message <span class="No-Break">like this:</span></li>
			</ol>
			<div>
				<div id="_idContainer218" class="IMG---Figure">
					<img src="image/B20997_23_07.jpg" alt="Figure 23.7 – Email sent via the QWeb template"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 23.7 – Email sent via the QWeb template</p>
			<p>The procedure shown in this recipe works exactly like the previous recipe, <em class="italic">Sending emails using the Jinja template</em>. The only difference is the template type, as this recipe uses <span class="No-Break">QWeb templates.</span></p>
			<h2 id="_idParaDest-990"><a id="_idTextAnchor1236"/>How it works...</h2>
			<p>In <em class="italic">step 1</em>, we created a QWeb template with the <strong class="source-inline">send_mail_assign_room_qweb</strong> ID. If you look in the template, you’ll see we are not using the <strong class="source-inline">format_date()</strong> data field method anymore. This is because the QWeb <a id="_idIndexMarker1652"/>rendering engine handles this automatically <a id="_idIndexMarker1653"/>and displays the date based on the user’s language. For the same reason, you are not required to use the <strong class="source-inline">format_amount()</strong> method to display currency symbols. The QWeb rendering engine will manage this automatically. If you want to learn more about QWeb templates, refer to the <em class="italic">Creating or modifying templates</em> recipe in <a href="B20997_14.xhtml#_idTextAnchor734"><span class="No-Break"><em class="italic">Chapter 14</em></span></a>, <em class="italic">CMS </em><span class="No-Break"><em class="italic">Website Development</em></span><span class="No-Break">.</span></p>
			<p>In <em class="italic">step 2</em>, we added a button in the form view to invoke the <strong class="source-inline">send_mail_assign_room_qweb()</strong> method, which sends the email to <span class="No-Break">the followers.</span></p>
			<p>In <em class="italic">step 3</em>, we added the <strong class="source-inline">send_mail_assign_room_qweb()</strong> method, which will be invoked by a button click. The <strong class="source-inline">message_post_with_source()</strong> method is used to send the email. The <strong class="source-inline">message_post_with_source()</strong> method is inherited in the model through <strong class="source-inline">mail.thread</strong> inheritance. To send the email, you just need to pass the web template’s XML ID as <span class="No-Break">the parameter.</span></p>
			<p>Sending <a id="_idIndexMarker1654"/>emails with the QWeb template works <a id="_idIndexMarker1655"/>exactly the same as in the previous recipe, but there are some subtle differences between the QWeb email template and the Jinja email template. Here is a quick comparison between <span class="No-Break">both templates:</span></p>
			<ul>
				<li>There is no simple way to send extra parameters in the email templates. You have to use a recordset in the <strong class="source-inline">object</strong> variable to fetch dynamic data. On the other hand, with QWeb email templates, you can pass extra values in the renderer context through the <span class="No-Break"><strong class="source-inline">values</strong></span><span class="No-Break"> parameter:</span><pre class="source-code">
self.message_post_with_source('my_hostel.assign_room_to_student_qweb',
                                   values={'extra_data': 'test'})</pre></li>				<li>To manage the date format, time zone, and amount with currency symbols, in the Jinja template, you have to use the <strong class="source-inline">format_date</strong>, <strong class="source-inline">format_tz</strong>, and <strong class="source-inline">format_amount</strong> functions, while in QWeb templates, it is <span class="No-Break">managed automatically.</span></li>
				<li>It is not possible to modify an existing template for other modules in Jinja, whereas in QWeb templates, you can modify the email template through inheritance. If you want to learn more about QWeb inheritance, refer to the <em class="italic">Creating or modifying templates</em> recipe in <a href="B20997_14.xhtml#_idTextAnchor734"><span class="No-Break"><em class="italic">Chapter 14</em></span></a>, <em class="italic">CMS </em><span class="No-Break"><em class="italic">Website Development</em></span><span class="No-Break">.</span></li>
				<li>You can select and use a Jinja template directly from the message composer. In the following screenshot, the drop-down menu in the bottom-right corner is used to select a <span class="No-Break">Jinja template:</span></li>
			</ul>
			<div>
				<div id="_idContainer219" class="IMG---Figure">
					<img src="image/B20997_23_08.jpg" alt="Figure 23.8 – Template selection option"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 23.8 – Template selection option</p>
			<ul>
				<li>Using QWeb, selecting a template directly from the message composer is not <span class="No-Break">an option.</span></li>
			</ul>
			<h2 id="_idParaDest-991"><a id="_idTextAnchor1237"/>There’s more...</h2>
			<p>All methods (<strong class="source-inline">message_post</strong> and <strong class="source-inline">message_post_with_source</strong>) respect the user’s preference. If <a id="_idIndexMarker1656"/>the user changes the notification-management option from the user preferences, the user will not receive emails; instead, they <a id="_idIndexMarker1657"/>will receive notifications in Odoo’s UI. This is the same for customers; if a customer opts out of emails, they will not receive any updates <span class="No-Break">through email.</span></p>
			<p>Additionally, the Odoo message <a id="_idIndexMarker1658"/>thread follows a concept called <strong class="bold">subtypes</strong>. Subtypes are used to receive emails only for information you are interested in. You can pass an extra parameter, <strong class="source-inline">subtype_id</strong>, in <strong class="source-inline">message_post_*</strong> methods to send emails based on the subtype. Usually, the user will manage their subtypes from the dropdown of the <strong class="bold">Follow</strong> button. Let’s suppose the user has set their subtypes <span class="No-Break">as follows:</span></p>
			<p class="IMG---Figure">            </p>
			<div>
				<div id="_idContainer220" class="IMG---Figure">
					<img src="image/B20997_23_09.jpg" alt="Figure 23.9 – Option to edit subtype"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 23.9 – Option to edit subtype</p>
			<p>Based on the user’s preference, the user will only get emails for <span class="No-Break"><strong class="bold">Discussions</strong></span><span class="No-Break"> messages.</span></p>
			<h1 id="_idParaDest-992"><a id="_idTextAnchor1238"/>Managing the email alias</h1>
			<p>Email aliasing is a feature in Odoo that is used to create a record through incoming emails. The <a id="_idIndexMarker1659"/>simplest example of an email alias is sales teams. You just need to send an email to <strong class="source-inline">sale@yourdomain.com</strong>, and Odoo will create a new record for <strong class="source-inline">crm.lead</strong> in the sales team. In this recipe, we will create one email alias to create a hostel <span class="No-Break">student record.</span></p>
			<h2 id="_idParaDest-993"><a id="_idTextAnchor1239"/>Getting ready</h2>
			<p>For this recipe, we will be using the <strong class="source-inline">my_hostel</strong> module from the previous recipe, <em class="italic">Sending emails using the QWeb template</em>. We will create our email alias with the <strong class="source-inline">hostelstudent@yourdomain.com</strong> email address. If you send an email to this email address with the book’s name in the subject, a record is created in the <span class="No-Break"><strong class="source-inline">hostel.student</strong></span><span class="No-Break"> model.</span></p>
			<h2 id="_idParaDest-994"><a id="_idTextAnchor1240"/>How to do it...</h2>
			<p>Follow these steps to add an email alias for the <span class="No-Break"><strong class="source-inline">hostel.student</strong></span><span class="No-Break"> model:</span></p>
			<ol>
				<li>Add the email alias data in the <span class="No-Break"><strong class="source-inline">my_hostel/data/mail_template.xml</strong></span><span class="No-Break"> file:</span><pre class="source-code">
&lt;record id="mail_alias_room_assign" model="mail.alias"&gt;
       &lt;field name="alias_name"&gt;room&lt;/field&gt;
       &lt;field name="alias_model_id" ref="model_hostel_student"/&gt;
       &lt;field name="alias_contact"&gt;partners&lt;/field&gt;
   &lt;/record&gt;</pre></li>				<li>Add the following imports in the <span class="No-Break"><strong class="source-inline">my_hostel/models/hostel_student.py</strong></span><span class="No-Break"> file:</span><pre class="source-code">
import re
from odoo.tools import email_split, email_escape_char</pre></li>				<li>Override <a id="_idIndexMarker1660"/>the <strong class="source-inline">message_new()</strong> method in the <span class="No-Break"><strong class="source-inline">hostel.student</strong></span><span class="No-Break"> model:</span><pre class="source-code">
   @api.model
   def message_new(self, msg_dict, custom_values=None):
       self = self.with_context(default_user_id=False)
       if custom_values is None:
           custom_values = {}
       custom_values['name'] = re.match(r"(.+?)\s*&lt;(.+?)&gt;", msg_dict.get('from')).group(1)
       custom_values['email'] = email_escape_char(email_split(msg_dict.get('from'))[0])
       return super(HostelStudent, self).message_new(msg_dict, custom_values)</pre></li>			</ol>
			<p>Update the <strong class="source-inline">my_hostel</strong> module to apply the changes. Then, send an email to <strong class="source-inline">hostelstudent@yourdomain.com</strong>. This will create a new <strong class="source-inline">hostel.student</strong> record, and it will be displayed <span class="No-Break">as follows:</span></p>
			<div>
				<div id="_idContainer221" class="IMG---Figure">
					<img src="image/B20997_23_010.jpg" alt="Figure 23.10 – Record generated via email"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 23.10 – Record generated via email</p>
			<p>Whenever <a id="_idIndexMarker1661"/>you send an email to <strong class="source-inline">hostelstudent@yourdomain.com</strong>, Odoo will generate a new <span class="No-Break">student record.</span></p>
			<h2 id="_idParaDest-995"><a id="_idTextAnchor1241"/>How it works...</h2>
			<p>In <em class="italic">step 1</em>, we created a <strong class="source-inline">mail.alias</strong> record. This alias will handle the <strong class="source-inline">hostelstudent@yourdomain.com</strong> email address. When you send an email to this address, Odoo will create a new record in the <strong class="source-inline">hostel.student</strong> model. If you want to see the list of active aliases in the system, open <strong class="bold">Settings</strong> | <strong class="bold">Technical</strong> | <strong class="bold">Email</strong> | <strong class="bold">Aliases</strong>. Here is a list of fields available to configure <span class="No-Break">the alias:</span></p>
			<ul>
				<li><strong class="source-inline">alias_name</strong>: This field holds the local part of the email address; for example, the <strong class="source-inline">hostelstudent</strong> part in <strong class="source-inline">hostelstudent@yourdomain.com</strong> is the local part of the <span class="No-Break">email address.</span></li>
				<li><strong class="source-inline">alias_model_id</strong>: The model reference on which a record should be created for the <span class="No-Break">incoming email.</span></li>
				<li><strong class="source-inline">alias_contact</strong>: This field holds the security preferences for the alias. Possible options are <strong class="source-inline">everyone</strong>, <strong class="source-inline">partners</strong>, <strong class="source-inline">followers</strong>, <span class="No-Break">and </span><span class="No-Break"><strong class="source-inline">employees</strong></span><span class="No-Break">.</span></li>
				<li><strong class="source-inline">alias_defaults</strong>: When an incoming email is received, its record is created in the model specified on the alias. If you want to set default values in the record, give the values in the form of a dictionary in <span class="No-Break">this field.</span></li>
			</ul>
			<p>In <em class="italic">step 2</em>, we added the necessary imports. In <em class="italic">step 3</em>, we overrode the <strong class="source-inline">message_new()</strong> method. This method is invoked automatically when a new email is received on the alias email address. This method will take <span class="No-Break">two parameters:</span></p>
			<ul>
				<li><strong class="source-inline">msg_dict</strong>: This parameter will be the dictionary that contains information about the received email. It contains email information such as the sender’s email address, the receiver’s email address, the email subject, and the <span class="No-Break">email body.</span></li>
				<li><strong class="source-inline">custom_values</strong>: This is a custom value used to create a new record. This is the same value you set on the alias record using the <span class="No-Break"><strong class="source-inline">alias_defaults</strong></span><span class="No-Break"> field.</span></li>
			</ul>
			<p>In our recipe, we overrode the <strong class="source-inline">message_new()</strong> method and fetched the name from the email <a id="_idIndexMarker1662"/>through a regular expression. Then, we fetched the email address of the sender with the help of the tools we imported in <em class="italic">step 2</em>. We used the sender’s email address to create a student record. Then, we updated <strong class="source-inline">custom_values</strong> with these two values: <strong class="source-inline">name</strong> and <strong class="source-inline">email</strong>. We passed this updated <strong class="source-inline">custom_values</strong> data to the <strong class="source-inline">super()</strong> method, which created a new <strong class="source-inline">hostel.student</strong> record with the given <strong class="source-inline">name</strong> and <strong class="source-inline">email</strong> values. This is how a record is created when you send an email to <span class="No-Break">the alias.</span></p>
			<h2 id="_idParaDest-996"><a id="_idTextAnchor1242"/>There’s more...</h2>
			<p>Some business models have a requirement that means you need a separate alias per record. For example, the sales team model has separate aliases for each team, such as <strong class="source-inline">sale-in@example.com</strong> for Team India and <strong class="source-inline">sale-be@example.com</strong> for Team Belgium. If you want to manage such aliases in your model, you can use <strong class="source-inline">mail.alias.mixin</strong>. In order to use it in your model, you will need to inherit <span class="No-Break">the mixin:</span></p>
			<pre class="source-code">
class Team(models.Model):
    _name = 'crm.team'
    _inherit = ['mail.alias.mixin', 'mail.thread']</pre>			<p>After inheriting the mixin, you will need to add the <strong class="source-inline">alias_name</strong> field into the form view so that end users can add aliases <span class="No-Break">by themselves.</span></p>
			<h1 id="_idParaDest-997"><a id="_idTextAnchor1243"/>Logging user changes in a chatter</h1>
			<p>The Odoo framework provides a built-in facility to log field changes in a chatter. In this recipe, we will <a id="_idIndexMarker1663"/>enable logging on some of the fields so that when changes are made in them, Odoo will add logs in <span class="No-Break">the chatter.</span></p>
			<h2 id="_idParaDest-998"><a id="_idTextAnchor1244"/>Getting ready</h2>
			<p>For this recipe, we will be using the <strong class="source-inline">my_hostel</strong> module from the previous recipe, <em class="italic">Managing the email alias</em>. In this recipe, we will log changes from a few fields in the <span class="No-Break"><strong class="source-inline">hostel.student</strong></span><span class="No-Break"> model.</span></p>
			<h2 id="_idParaDest-999"><a id="_idTextAnchor1245"/>How to do it...</h2>
			<p>Modify the definitions of the fields, to enable logs for the fields when you change them. This is shown in the following <span class="No-Break">code snippet:</span></p>
			<pre class="source-code">
class HostelStudent(models.Model):
   _name = "hostel.student"
   _description = "Hostel Student Information"
   _inherit = ['mail.thread', 'mail.activity.mixin']
   name = fields.Char("Student Name")
   email = fields.Char("Student Email")
   gender = fields.Selection([("male", "Male"),
       ("female", "Female"), ("other", "Other")],
       string="Gender", help="Student gender")
   active = fields.Boolean("Active", default=True,
       help="Activate/Deactivate hostel record")
   hostel_id = fields.Many2one("hostel.hostel", "hostel", help="Name of hostel")
   room_id = fields.Many2one("hostel.room", "Room",
       help="Select hostel room")
   status = fields.Selection([("draft", "Draft"),
       ("reservation", "Reservation"), ("pending", "Pending"),
       ("paid", "Done"),("discharge", "Discharge"), ("cancel", "Cancel")],
       string="Status", copy=False, default="draft",
       help="State of the student hostel")
   admission_date = fields.Date("Admission Date",
       help="Date of admission in hostel",
       default=fields.Datetime.today,
       tracking=True)
   discharge_date = fields.Date("Discharge Date",
       help="Date on which student discharge",
       tracking=True)
   duration = fields.Integer("Duration", compute="_compute_check_duration", inverse="_inverse_duration",
                              help="Enter duration of living")</pre>			<p>Update <a id="_idIndexMarker1664"/>the <strong class="source-inline">my_hostel</strong> module to apply the changes. Create a new record in the <strong class="source-inline">hostel.student</strong> model, make some changes in the fields, and then admission and discharge the hostel. If you check the chatter, you will see the <span class="No-Break">following logs:</span></p>
			<div>
				<div id="_idContainer222" class="IMG---Figure">
					<img src="image/B20997_23_011.jpg" alt="Figure 23.11 – Changelogs in the chatter"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 23.11 – Changelogs in the chatter</p>
			<p>Whenever you make changes to <strong class="source-inline">state</strong>, <strong class="source-inline">admission_date</strong>, or <strong class="source-inline">discharge_date</strong>, you will see a new log in the chatter. This will help you to see the full history of <span class="No-Break">the record.</span></p>
			<h2 id="_idParaDest-1000"><a id="_idTextAnchor1246"/>How it works...</h2>
			<p>By adding the <strong class="source-inline">tracking=True</strong> attribute on the field, you can enable logging for that field. When you set the <strong class="source-inline">tracking=True</strong> attribute, Odoo will add a log that changes in the chatter whenever you update the field value. If you enable tracking on multiple records and <a id="_idIndexMarker1665"/>you want to provide a sequence in the tracking values, you can also pass a number in the tracking parameter like this: <strong class="source-inline">tracking=20</strong>. When you pass <strong class="source-inline">tracking=True</strong>, then the default sequence is used, which <span class="No-Break">is </span><span class="No-Break"><strong class="source-inline">100</strong></span><span class="No-Break">.</span></p>
			<p>In our recipe, we added <strong class="source-inline">tracking=True</strong> on the <strong class="source-inline">state</strong>, <strong class="source-inline">admission_date</strong>, and <strong class="source-inline">discharge_date</strong> fields. This means Odoo will log changes when you update the values of the  <strong class="source-inline">admission_date</strong>, <strong class="source-inline">discharge_date</strong>, or <strong class="source-inline">state</strong> fields. Take a look at the screenshot in the <em class="italic">How to do it…</em> section; we have only changed the <strong class="source-inline">admission_date</strong> and <span class="No-Break"><strong class="source-inline">discharge_date</strong></span><span class="No-Break"> fields.</span></p>
			<p>Note that the <strong class="source-inline">track_visibility</strong> feature only works if your model inherits the <strong class="source-inline">mail.thread</strong> model because the code-related chatter and logs are part of the <span class="No-Break"><strong class="source-inline">mail.thread</strong></span><span class="No-Break"> model.</span></p>
			<h1 id="_idParaDest-1001"><a id="_idTextAnchor1247"/>Sending periodic digest emails</h1>
			<p>The Odoo <a id="_idIndexMarker1666"/>framework has built-in support for sending out periodic digest emails. With digest emails, you can send an email with information about business KPIs. In this recipe, we will send data about the hostel room to the rector (or any other <span class="No-Break">authorized person).</span></p>
			<h2 id="_idParaDest-1002"><a id="_idTextAnchor1248"/>Getting ready</h2>
			<p>For this recipe, we will be using the <strong class="source-inline">my_hostel</strong> module from the previous recipe, <em class="italic">Logging user changes in </em><span class="No-Break"><em class="italic">a chatter</em></span><span class="No-Break">.</span></p>
			<h2 id="_idParaDest-1003"><a id="_idTextAnchor1249"/>How to do it...</h2>
			<p>Follow these steps to generate digest emails for room <span class="No-Break">rent records:</span></p>
			<ol>
				<li>Inherit the <strong class="source-inline">digest.digest</strong> model and add fields for <span class="No-Break">the KPIs:</span><pre class="source-code">
class Digest(models.Model):
   _inherit = 'digest.digest'
   kpi_room_rent = fields.Boolean('Room Rent')
   kpi_room_rent_value = fields.Integer(compute='_compute_kpi_room_rent_value')
   def _compute_kpi_room_rent_value(self):
       for record in self:
           start, end, company = record._get_kpi_compute_parameters()
           record.kpi_room_rent_value = self.env['hostel.room'].search_count([
               ('create_date', '&gt;=', start),
               ('create_date', '&lt;', end)
           ])</pre></li>				<li>Inherit the <strong class="source-inline">digest.digest</strong> model’s <a id="_idIndexMarker1667"/>form view and add the <span class="No-Break">KPI fields:</span><pre class="source-code">
&lt;?xml version='1.0' encoding='utf-8'?&gt;
&lt;odoo&gt;
   &lt;record id="digest_digest_view_form" model="ir.ui.view"&gt;
       &lt;field name="name"&gt;digest.digest.view.form.inherit.hostel&lt;/field&gt;
       &lt;field name="model"&gt;digest.digest&lt;/field&gt;
       &lt;field name="inherit_id" ref="digest.digest_digest_view_form"/&gt;
       &lt;field name="arch" type="xml"&gt;
           &lt;xpath expr="//group[@name='kpi_general']" position="after"&gt;
               &lt;group name="kpi_hostel" string="Hostel"&gt;
                   &lt;field name="kpi_room_rent"/&gt;
               &lt;/group&gt;
           &lt;/xpath&gt;
       &lt;/field&gt;
   &lt;/record&gt;
&lt;/odoo&gt;</pre></li>			</ol>
			<p>Update the module to apply the changes. Once you update the module, enable developer mode and open <strong class="bold">Settings</strong> | <strong class="bold">Technical</strong> | <strong class="bold">Emails</strong> | <strong class="bold">Digest Emails</strong>, as seen in the <span class="No-Break">following screenshot:</span></p>
			<div>
				<div id="_idContainer223" class="IMG---Figure">
					<img src="image/B20997_23_012.jpg" alt="Figure 23.12 – Enabling the digest email for room rent data"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 23.12 – Enabling the digest email for room rent data</p>
			<p>Once you enable this and if you have subscribed to digest emails, you will start receiving <span class="No-Break">digest emails.</span></p>
			<h2 id="_idParaDest-1004"><a id="_idTextAnchor1250"/>How it works...</h2>
			<p>In order to <a id="_idIndexMarker1668"/>build a customized digest email, you need two fields. The first field will be a <strong class="source-inline">Boolean</strong> field, used to enable and disable the KPI, while the second field will be a <strong class="source-inline">compute</strong> field and will be called to acquire the KPI value. We created both of the fields in <em class="italic">step 1</em>. If you check the definition of the <strong class="source-inline">compute</strong> field, it uses the <strong class="source-inline">_get_kpi_compute_parameters</strong> method. This method returns three parameters: a start date, an end date, and the company record. You can use these parameters to generate a value for your KPI. We have returned the number of rooms rented during a particular period of time. If your KPI is multi-website compatible, then you can use a <span class="No-Break"><strong class="source-inline">company</strong></span><span class="No-Break"> parameter.</span></p>
			<p>In <em class="italic">step 2</em>, we added a field to the digest form view. This field is used to enable/disable digest emails. When you enable it, you will start receiving <span class="No-Break">digest emails:</span></p>
			<div>
				<div id="_idContainer224" class="IMG---Figure">
					<img src="image/B20997_23_013.jpg" alt="Figure 23.13 – Digest email for room rent records"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 23.13 – Digest email for room rent records</p>
			<p>Enable developer <a id="_idIndexMarker1669"/>mode, then open <strong class="bold">Settings</strong> | <strong class="bold">Technical</strong> | <strong class="bold">Emails</strong> | <strong class="bold">Digest Emails</strong>. Here, you can configure the recipients of digest emails and set the periodicity for digest emails. You can also enable/disable digest emails <span class="No-Break">from here.</span></p>
		</div>
	</body></html>