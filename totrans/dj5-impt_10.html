<html><head></head><body>
		<div id="_idContainer093">
			<h1 id="_idParaDest-183" class="chapter-number"><a id="_idTextAnchor189"/><st c="0">10</st></h1>
			<h1 id="_idParaDest-184"><a id="_idTextAnchor190"/><st c="3">Implementing a Shopping  Cart System</st></h1>
			<p><st c="39">In this chapter, we’ll learn all about how to make a shopping cart for websites. </st><st c="121">To implement this feature, we will need to learn</st><a id="_idIndexMarker332"/><st c="169"> how </st><strong class="bold"><st c="174">web sessions</st></strong><st c="186"> work and how to use </st><strong class="bold"><st c="207">Django sessions</st></strong><st c="222">. Django sessions</st><a id="_idIndexMarker333"/><st c="239"> will be used to store user-specific information as they navigate through </st><span class="No-Break"><st c="313">the site.</st></span></p>
			<p><st c="322">In this chapter, we will be covering the </st><span class="No-Break"><st c="364">following topics:</st></span></p>
			<ul>
				<li><st c="381">Introducing </st><span class="No-Break"><st c="394">web sessions</st></span></li>
				<li><st c="406">Creating a </st><span class="No-Break"><st c="418">cart app</st></span></li>
				<li><st c="426">Adding movies to </st><span class="No-Break"><st c="444">the cart</st></span></li>
				<li><st c="452">Listing movies added to </st><span class="No-Break"><st c="477">the cart</st></span></li>
				<li><st c="485">Removing movies from </st><span class="No-Break"><st c="507">the cart</st></span></li>
			</ul>
			<p><st c="515">By the end of the chapter, you will have the knowledge to work with web sessions, implement shopping cart systems, and track and maintain user information between requests from the </st><span class="No-Break"><st c="697">same user.</st></span></p>
			<h1 id="_idParaDest-185"><a id="_idTextAnchor191"/><st c="707">Technical requirements</st></h1>
			<p><st c="730">In this chapter, we will be using </st><strong class="bold"><st c="765">Python 3.10+</st></strong><st c="777">. Additionally, we will be using the </st><strong class="bold"><st c="814">VS Code</st></strong><st c="821"> editor in this book, which you can download </st><span class="No-Break"><st c="866">from </st></span><a href="https://code.visualstudio.com/"><span class="No-Break"><st c="871">https://code.visualstudio.com/</st></span></a><span class="No-Break"><st c="901">.</st></span></p>
			<p><st c="902">The code for this chapter is located </st><span class="No-Break"><st c="940">at </st></span><a href="https://github.com/PacktPublishing/Django-5-for-the-Impatient-Second-Edition/tree/main/Chapter10/moviesstore"><span class="No-Break"><st c="943">https://github.com/PacktPublishing/Django-5-for-the-Impatient-Second-Edition/tree/main/Chapter10/moviesstore</st></span></a><span class="No-Break"><st c="1051">.</st></span></p>
			<p><st c="1052">The CiA video for this chapter can be found </st><span class="No-Break"><st c="1097">at </st></span><a href="https://packt.link/mEcH8"><span class="No-Break"><st c="1100">https://packt.link/mEcH8</st></span></a></p>
			<h1 id="_idParaDest-186"><a id="_idTextAnchor192"/><st c="1124">Introducing web sessions</st></h1>
			<p><st c="1149">Do you understand how the login system functions? </st><st c="1200">How does the application recognize my connection status? </st><st c="1257">How does it distinguish between displaying a logout button for a logged-in user and a login button for a friend who is not connected? </st><st c="1391">How long does the application retain my </st><span class="No-Break"><st c="1431">connection status?</st></span></p>
			<p><st c="1449">In this chapter, we’ll address these questions and explore the significance of web sessions in the development of web applications. </st><st c="1582">We will explore these elements in the </st><span class="No-Break"><st c="1620">following order:</st></span></p>
			<ol>
				<li><st c="1636">HTTP </st><span class="No-Break"><st c="1642">protocol limitations</st></span></li>
				<li> <span class="No-Break"><st c="1662">Web sessions</st></span></li>
				<li><st c="1675">Django </st><span class="No-Break"><st c="1683">login scenario</st></span></li>
				<li><span class="No-Break"><st c="1697">Django sessions</st></span></li>
			</ol>
			<h2 id="_idParaDest-187"><a id="_idTextAnchor193"/><st c="1713">HTTP protocol limitations</st></h2>
			<p><st c="1739">Currently, our</st><a id="_idIndexMarker334"/><st c="1754"> interaction with the Movies Store website relies on the HTTP protocol. </st><st c="1826">For instance, to access movie information, we utilize </st><strong class="source-inline"><st c="1880">http://localhost:8000/movies</st></strong><st c="1908">, and for logging in, we use </st><strong class="source-inline"><st c="1937">http://localhost:8000/login</st></strong><st c="1964">. Each request we make utilizes the HTTP protocol as its </st><span class="No-Break"><st c="2021">communication medium.</st></span></p>
			<p><st c="2042">Nevertheless, the HTTP protocol has its limitations. </st><st c="2096">It operates in a </st><strong class="bold"><st c="2113">stateless</st></strong><st c="2122"> manner, implying that the server doesn’t retain any information (state) between successive requests. </st><st c="2224">With each new request, a fresh connection is established, removing any knowledge about previous interactions. </st><st c="2334">Essentially, it lacks memory of </st><span class="No-Break"><st c="2366">past actions.</st></span></p>
			<p><st c="2379">However, when logged into the application, subsequent requests display a logout button, indicating the application’s ability to identify users and maintain state data. </st><st c="2548">This functionality is achieved through Django sessions, which augment the capabilities of the </st><span class="No-Break"><st c="2642">HTTP protocol.</st></span></p>
			<h2 id="_idParaDest-188"><a id="_idTextAnchor194"/><st c="2656">Web sessions</st></h2>
			<p><st c="2669">A </st><strong class="bold"><st c="2672">web session</st></strong><st c="2683"> comprises</st><a id="_idIndexMarker335"/><st c="2693"> a sequence of continuous actions performed by a visitor on a website within a specified period. </st><st c="2790">Each framework offers its own method for implementing sessions to monitor visitors’ activities. </st><span class="No-Break"><em class="italic"><st c="2886">Figure 10</st></em></span><em class="italic"><st c="2895">.1</st></em><st c="2897"> illustrates the functioning of </st><span class="No-Break"><st c="2929">Django sessions.</st></span></p>
			<div>
				<div id="_idContainer086" class="IMG---Figure">
					<img src="image/B22457_10_1.jpg" alt="Figure 10.1 – An example of a Django session operation"/><st c="2945"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><st c="3299">Figure 10.1 – An example of a Django session operation</st></p>
			<p><st c="3353">Let’s analyze the </st><span class="No-Break"><st c="3372">previous scenario:</st></span></p>
			<ol>
				<li><st c="3390">The user navigates to the login page </st><span class="No-Break"><st c="3428">at </st></span><span class="No-Break"><strong class="source-inline"><st c="3431">http://localhost:8000/login</st></strong></span><span class="No-Break"><st c="3458">.</st></span></li>
				<li><st c="3459">Django then sends an HTTP response to the user, containing the </st><span class="No-Break"><st c="3523">login form.</st></span></li>
				<li><st c="3534">The user fills out the login form and presses the </st><strong class="bold"><st c="3585">Login</st></strong><st c="3590"> button. </st><st c="3599">Django validates the user data, and if it’s accurate, creates session data for the user, and assigns them an ID or</st><a id="_idIndexMarker336"/><st c="3713"> a </st><strong class="bold"><st c="3716">session key</st></strong><st c="3727">. By default, the session data is stored in the database (we will see it in action in the </st><span class="No-Break"><st c="3817">next section).</st></span></li>
				<li><st c="3831">Django sends a cookie to the user’s browser. </st><st c="3877">This cookie contains a session ID, which is used to retrieve the user’s session data on subsequent requests. </st><st c="3986">After successful login, Django redirects the user to the </st><span class="No-Break"><st c="4043">home page.</st></span></li>
				<li><st c="4053">Each subsequent request will render the navigation menu with the </st><strong class="bold"><st c="4119">Logout</st></strong><st c="4125"> button, as the session ID is included in the user’s requests. </st><st c="4188">This process continues until the user clicks on the </st><strong class="bold"><st c="4240">Logout</st></strong><st c="4246"> button (which removes the session data</st><a id="_idIndexMarker337"/><st c="4285"> and the cookie), or until the session expires, which defaults to </st><span class="No-Break"><st c="4351">two weeks.</st></span></li>
			</ol>
			<p><st c="4361">Now that we have learned how Django sessions work, let’s replicate it with our Movies </st><span class="No-Break"><st c="4448">Store project.</st></span></p>
			<h2 id="_idParaDest-189"><a id="_idTextAnchor195"/><st c="4462">Django login scenario</st></h2>
			<p><st c="4484">Let’s follow the next steps </st><a id="_idIndexMarker338"/><st c="4513">to see Django sessions </st><span class="No-Break"><st c="4536">in action:</st></span></p>
			<ol>
				<li><st c="4546">Run the application in incognito mode, go to </st><strong class="source-inline"><st c="4592">http://localhost:8000/login</st></strong><st c="4619">, and use the credentials of an already registered user to </st><span class="No-Break"><st c="4678">log in.</st></span></li>
				<li><st c="4685">Go to </st><a href="https://inloop.github.io/sqlite-viewer/"><st c="4692">https://inloop.github.io/sqlite-viewer/</st></a><st c="4731">, drag and drop your </st><strong class="source-inline"><st c="4752">db.sqlite3</st></strong><st c="4762"> file onto the page, and then select the </st><strong class="source-inline"><st c="4803">django_session</st></strong><st c="4817"> table. </st><st c="4825">You will see a new </st><strong class="source-inline"><st c="4844">session_key</st></strong><st c="4855">, </st><strong class="source-inline"><st c="4857">session_data</st></strong><st c="4869">, and </st><strong class="source-inline"><st c="4875">expire_date</st></strong><st c="4886"> corresponding to the user who just logged in (</st><span class="No-Break"><em class="italic"><st c="4933">Figure 10</st></em></span><span class="No-Break"><em class="italic"><st c="4943">.2</st></em></span><span class="No-Break"><st c="4945">).</st></span></li>
			</ol>
			<div>
				<div id="_idContainer087" class="IMG---Figure">
					<img src="image/B22457_10_2.jpg" alt="Figure 10.2 – The django_session table"/><st c="4948"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><st c="5833">Figure 10.2 – The django_session table</st></p>
			<ol>
				<li value="3"><st c="5871">The previous </st><a id="_idIndexMarker339"/><st c="5885">Django session data comes with a cookie. </st><st c="5926">Go to your browser, verify that you’re located on the </st><strong class="bold"><st c="5980">Movies Store</st></strong><st c="5992"> home page, and open the developer console. </st><st c="6036">For Google Chrome, you can open the developer console with </st><em class="italic"><st c="6095">Shift</st></em><st c="6100"> + </st><em class="italic"><st c="6103">Ctrl</st></em><st c="6107"> + </st><em class="italic"><st c="6110">J</st></em><st c="6111"> (on Windows/Linux), or </st><em class="italic"><st c="6135">option</st></em><st c="6141"> + </st><em class="italic"><st c="6144">⌘</st></em><st c="6145"> + </st><em class="italic"><st c="6148">J</st></em><st c="6149"> (</st><span class="No-Break"><st c="6151">on macOS).</st></span></li>
				<li><st c="6161">Then, navigate to the </st><strong class="bold"><st c="6184">Application</st></strong><st c="6195"> tab, click the </st><strong class="bold"><st c="6211">Cookies</st></strong><st c="6218"> | </st><strong class="source-inline"><st c="6221">http://127.0.0.1:8000</st></strong><st c="6242"> option, and you will see the stored cookie data, which includes a </st><strong class="source-inline"><st c="6309">sessionid</st></strong><st c="6318"> that matches with the </st><strong class="source-inline"><st c="6341">session_key</st></strong><st c="6352"> stored in the database (</st><span class="No-Break"><em class="italic"><st c="6377">Figure 10</st></em></span><span class="No-Break"><em class="italic"><st c="6387">.3</st></em></span><span class="No-Break"><st c="6389">).</st></span></li>
			</ol>
			<div>
				<div id="_idContainer088" class="IMG---Figure">
					<img src="image/B22457_10_3.jpg" alt="Figure 10.3 – The Movies Store cookie data"/><st c="6392"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><st c="6786">Figure 10.3 – The Movies Store cookie data</st></p>
			<p><st c="6828">That’s how Django tracks our website interactions; if you click the </st><strong class="bold"><st c="6897">Logout</st></strong><st c="6903"> button, all this data </st><span class="No-Break"><st c="6926">will disappear.</st></span></p>
			<p class="callout-heading"><st c="6941">Note</st></p>
			<p class="callout"><st c="6946">Session </st><a id="_idIndexMarker340"/><st c="6955">data is not only created during the login scenario or exclusively for logged-in users. </st><st c="7042">If your application utilizes Django’s session functionalities at any point, it will also generate the corresponding session and cookie data. </st><st c="7183">We will see this in action later when we implement the shopping cart system. </st><st c="7260">You can find more information about </st><a id="_idIndexMarker341"/><st c="7296">Django sessions </st><span class="No-Break"><st c="7312">here: </st></span><a href="https://docs.djangoproject.com/en/5.0/topics/http/sessions/"><span class="No-Break"><st c="7318">https://docs.djangoproject.com/en/5.0/topics/http/sessions/</st></span></a><span class="No-Break"><st c="7377">.</st></span></p>
			<h2 id="_idParaDest-190"><a id="_idTextAnchor196"/><st c="7378">Django sessions</st></h2>
			<p><strong class="bold"><st c="7394">Django sessions</st></strong><st c="7410"> are a </st><a id="_idIndexMarker342"/><st c="7417">mechanism for persisting data across HTTP requests in a web application. </st><st c="7490">They allow Django to store and retrieve arbitrary data for a specific user across multiple requests. </st><st c="7591">Here are some key points about </st><span class="No-Break"><st c="7622">Django sessions:</st></span></p>
			<ul>
				<li><strong class="bold"><st c="7638">Client-side cookies</st></strong><st c="7658">: By default, Django sessions are implemented using client-side cookies. </st><st c="7732">Django </st><a id="_idIndexMarker343"/><st c="7739">commonly sets a unique session ID in the user’s browser as </st><span class="No-Break"><st c="7798">a cookie.</st></span></li>
				<li><strong class="bold"><st c="7807">Server-side storage</st></strong><st c="7827">: While the </st><a id="_idIndexMarker344"/><st c="7840">session ID is stored in the client’s browser, the actual session data is stored server-side. </st><st c="7933">By default, the session data is stored in </st><span class="No-Break"><st c="7975">the database.</st></span></li>
				<li><strong class="bold"><st c="7988">Configuration options</st></strong><st c="8010">: Django offers various configuration options for sessions, including </st><a id="_idIndexMarker345"/><st c="8081">the session engine (e.g., database-backed, cached, file-based), session expiry time, and encryption of </st><span class="No-Break"><st c="8184">session data.</st></span></li>
				<li><strong class="bold"><st c="8197">Integration with authentication</st></strong><st c="8229">: Django sessions often work with Django’s authentication </st><a id="_idIndexMarker346"/><st c="8288">system. </st><st c="8296">For example, when a user logs in, their authentication status is typically stored in the session, allowing Django to keep the user logged in across multiple requests until they explicitly log out or the </st><span class="No-Break"><st c="8499">session expires.</st></span></li>
				<li><strong class="bold"><st c="8515">Accessing session data</st></strong><st c="8538">: Developers </st><a id="_idIndexMarker347"/><st c="8552">can access session data in Django views using the </st><strong class="source-inline"><st c="8602">request.session</st></strong><st c="8617"> attribute. </st><st c="8629">This allows them to read, modify, and delete session data as needed during </st><span class="No-Break"><st c="8704">request processing.</st></span></li>
			</ul>
			<p><st c="8723">Now that we´ve learned the fundamentals of web sessions and Django sessions, let´s start creating the </st><span class="No-Break"><st c="8826">cart app.</st></span></p>
			<h1 id="_idParaDest-191"><a id="_idTextAnchor197"/><st c="8835">Creating a cart app</st></h1>
			<p><st c="8855">All the shopping cart </st><a id="_idIndexMarker348"/><st c="8878">functionalities will be managed in their own application. </st><st c="8936">So, let’s create a cart app. </st><st c="8965">Navigate to the top </st><strong class="source-inline"><st c="8985">moviesstore</st></strong><st c="8996"> folder (the one which contains the </st><strong class="source-inline"><st c="9032">manage.py</st></strong><st c="9041"> file) and run the following in </st><span class="No-Break"><st c="9073">the Terminal:</st></span></p>
			<ul>
				<li><st c="9086">For macOS, run the </st><span class="No-Break"><st c="9106">following command:</st></span><pre class="source-code">
<strong class="bold"><st c="9124">python3 manage.py startapp cart</st></strong></pre></li>				<li><st c="9156">For Windows, run the </st><span class="No-Break"><st c="9178">following command:</st></span><pre class="source-code">
<strong class="bold"><st c="9196">python manage.py startapp cart</st></strong></pre></li>			</ul>
			<p><span class="No-Break"><em class="italic"><st c="9227">Figure 10</st></em></span><em class="italic"><st c="9237">.4</st></em><st c="9239"> shows the </st><a id="_idIndexMarker349"/><st c="9250">new project structure. </st><st c="9273">Verify it matches your current </st><span class="No-Break"><st c="9304">folder structure.</st></span></p>
			<div>
				<div id="_idContainer089" class="IMG---Figure">
					<img src="image/B22457_10_4.jpg" alt="Figure 10.4 – The MOVIESSTORE project structure containing the cart app"/><st c="9321"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><st c="9492">Figure 10.4 – The MOVIESSTORE project structure containing the cart app</st></p>
			<h2 id="_idParaDest-192"><a id="_idTextAnchor198"/><st c="9563">Adding cart app in settings</st></h2>
			<p><st c="9591">Remember</st><a id="_idIndexMarker350"/><st c="9600"> that for each newly created app, we must register it in the </st><strong class="source-inline"><st c="9661">settings.py</st></strong><st c="9672"> file. </st><st c="9679">In </st><strong class="source-inline"><st c="9682">/moviesstore/settings.py</st></strong><st c="9706">, under </st><strong class="source-inline"><st c="9714">INSTALLED_APPS</st></strong><st c="9728">, add the following lines </st><span class="No-Break"><st c="9754">in bold:</st></span></p>
			<pre class="source-code"><st c="9762">
…
INSTALLED_APPS = [
    …
    'movies',
    'accounts',
</st><strong class="bold"><st c="9807">    'cart',</st></strong><st c="9814">
]
…</st></pre>			<h2 id="_idParaDest-193"><a id="_idTextAnchor199"/><st c="9818">Including the cart URL file in the project-level URL file</st></h2>
			<p><st c="9876">In </st><strong class="source-inline"><st c="9880">/moviesstore/urls.py</st></strong><st c="9900">, add</st><a id="_idIndexMarker351"/><st c="9905"> the following lines </st><span class="No-Break"><st c="9926">in</st></span><span class="No-Break"><a id="_idIndexMarker352"/></span><span class="No-Break"><st c="9928"> bold:</st></span></p>
			<pre class="source-code"><st c="9934">
…
urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('home.urls')),
    path('movies/', include('movies.urls')),
    path('accounts/', include('accounts.urls')),
    </st><strong class="bold"><st c="10103">path('cart/', include('cart.urls')),</st></strong><st c="10139">
]
…</st></pre>			<p><st c="10143">All the URLs that are defined in the </st><strong class="source-inline"><st c="10181">cart.urls</st></strong><st c="10190"> file will contain a </st><strong class="source-inline"><st c="10211">cart/</st></strong><st c="10216"> prefix (as defined in the previous path). </st><st c="10259">We will create the </st><strong class="source-inline"><st c="10278">cart.urls</st></strong> <span class="No-Break"><st c="10287">file later.</st></span></p>
			<p><st c="10299">Now that we have created the cart app, let’s allow the addition of movies to </st><span class="No-Break"><st c="10377">the cart.</st></span></p>
			<h1 id="_idParaDest-194"><a id="_idTextAnchor200"/><st c="10386">Adding movies to the cart</st></h1>
			<p><st c="10412">To allow the addition </st><a id="_idIndexMarker353"/><st c="10435">of movies to the cart, we will follow the </st><span class="No-Break"><st c="10477">next steps:</st></span></p>
			<ol>
				<li><st c="10488">Configure the </st><span class="No-Break"><strong class="source-inline"><st c="10503">add_to_cart</st></strong></span><span class="No-Break"><st c="10514"> URL.</st></span></li>
				<li><st c="10519">Define the </st><span class="No-Break"><strong class="source-inline"><st c="10531">add_to_cart</st></strong></span><span class="No-Break"><st c="10542"> function.</st></span></li>
				<li><st c="10552">Update</st><a id="_idIndexMarker354"/><st c="10559"> the </st><span class="No-Break"><strong class="source-inline"><st c="10564">movies.show</st></strong></span><span class="No-Break"><st c="10575"> template.</st></span></li>
			</ol>
			<h2 id="_idParaDest-195"><a id="_idTextAnchor201"/><st c="10585">Configuring the add_to_cart URL</st></h2>
			<p><st c="10617">In </st><strong class="source-inline"><st c="10621">/cart/</st></strong><st c="10627">, create a new</st><a id="_idIndexMarker355"/><st c="10641"> file called </st><strong class="source-inline"><st c="10654">urls.py</st></strong><st c="10661">. This file will contain the path regarding the URLs of the cart app. </st><st c="10731">For now, fill it in with </st><span class="No-Break"><st c="10756">the following:</st></span></p>
			<pre class="source-code"><st c="10770">
from django.urls import path
from . </st><st c="10807">import views
urlpatterns = [
    path('&lt;int:id&gt;/add/', views.add, name='cart.add'),
]</st></pre>			<p><st c="10888">We added a new path called </st><strong class="source-inline"><st c="10916">cart/&lt;int:id&gt;/add</st></strong><st c="10933"> (remember that the project-level URLs file defined a </st><strong class="source-inline"><st c="10987">/cart</st></strong><st c="10992"> prefix for this file). </st><st c="11016">The </st><strong class="source-inline"><st c="11020">&lt;int:id&gt;</st></strong><st c="11028"> part indicates that this path expects an integer value to be passed from the URL and that the integer value will be associated with a variable named </st><strong class="source-inline"><st c="11178">id</st></strong><st c="11180">. The </st><strong class="source-inline"><st c="11186">id</st></strong><st c="11188"> variable will be used to identify which movie we want to add to the cart. </st><st c="11263">For example, the </st><strong class="source-inline"><st c="11280">cart/1/add</st></strong><st c="11290"> path indicates that we want to add the movie with </st><strong class="source-inline"><st c="11341">id=1</st></strong><st c="11345"> to </st><span class="No-Break"><st c="11349">the cart.</st></span></p>
			<h2 id="_idParaDest-196"><a id="_idTextAnchor202"/><st c="11358">Defining add_to_cart function</st></h2>
			<p><st c="11388">In </st><strong class="source-inline"><st c="11392">/cart/views.py</st></strong><st c="11406">, add the following</st><a id="_idIndexMarker356"/><st c="11425"> lines </st><span class="No-Break"><st c="11432">in bold:</st></span></p>
			<pre class="source-code"><st c="11440">
from django.shortcuts import render
</st><strong class="bold"><st c="11477">from django.shortcuts import get_object_or_404, redirect</st></strong>
<strong class="bold"><st c="11533">from movies.models import Movie</st></strong>
<strong class="bold"><st c="11565">def add(request, id):</st></strong>
<strong class="bold"><st c="11587">    get_object_or_404(Movie, id=id)</st></strong>
<strong class="bold"><st c="11619">    cart = request.session.get('cart', {})</st></strong>
<strong class="bold"><st c="11658">    cart[id] = request.POST['quantity']</st></strong>
<strong class="bold"><st c="11694">    request.session['cart'] = cart</st></strong>
<strong class="bold"><st c="11725">    return redirect('home.index')</st></strong></pre>			<p><st c="11755">Let’s explain the</st><a id="_idIndexMarker357"/> <span class="No-Break"><st c="11773">previous code:</st></span></p>
			<ul>
				<li><st c="11788">We import the </st><strong class="source-inline"><st c="11803">redirect</st></strong><st c="11811"> and </st><strong class="source-inline"><st c="11816">get_object_or_404</st></strong><st c="11833"> functions. </st><st c="11845">We also import the </st><strong class="source-inline"><st c="11864">Movie</st></strong><st c="11869"> model from the “</st><span class="No-Break"><st c="11886">movies” app.</st></span></li>
				<li><st c="11899">We define the </st><strong class="source-inline"><st c="11914">add</st></strong><st c="11917"> function, which takes two parameters: the request and the </st><span class="No-Break"><st c="11976">movie ID.</st></span></li>
				<li><st c="11985">We fetch the </st><strong class="source-inline"><st c="11999">Movie</st></strong><st c="12004"> object with the given </st><strong class="source-inline"><st c="12027">id</st></strong><st c="12029"> from the database (by using the </st><strong class="source-inline"><st c="12062">get_object_or_404</st></strong><st c="12079"> function). </st><st c="12091">If no such object is found, a 404 (Not Found) error </st><span class="No-Break"><st c="12143">is raised.</st></span></li>
				<li><st c="12153">We check the session storage for a key called </st><strong class="source-inline"><st c="12200">'cart'</st></strong><st c="12206">. If the key does not exist, a </st><strong class="source-inline"><st c="12237">{}</st></strong><st c="12239"> empty dictionary is assigned to the </st><span class="No-Break"><strong class="source-inline"><st c="12276">cart</st></strong></span><span class="No-Break"><st c="12280"> variable.</st></span></li>
				<li><st c="12290">We modify the </st><strong class="source-inline"><st c="12305">cart</st></strong><st c="12309"> variable. </st><st c="12320">We add a new key to the </st><strong class="source-inline"><st c="12344">cart</st></strong><st c="12348"> dictionary based on the movie ID, and the corresponding value based on the movie quantity the user wants to add to the cart (we will collect </st><strong class="source-inline"><st c="12490">quantity</st></strong><st c="12498"> through an HTML form later). </st><st c="12528">For example, if the user wants to add </st><strong class="source-inline"><st c="12566">2</st></strong><st c="12567"> movies with </st><strong class="source-inline"><st c="12580">id=1</st></strong><st c="12584">, a new key/value such as this </st><strong class="source-inline"><st c="12615">cart["1"] = "2"</st></strong><st c="12630"> will be added to </st><span class="No-Break"><st c="12648">the dictionary.</st></span></li>
				<li><st c="12663">The updated </st><strong class="source-inline"><st c="12676">cart</st></strong><st c="12680"> dictionary is then saved back to the session using </st><strong class="source-inline"><st c="12732">request.session['cart'] = </st></strong><span class="No-Break"><strong class="source-inline"><st c="12758">cart</st></strong></span><span class="No-Break"><st c="12762">.</st></span></li>
				<li><st c="12763">After </st><a id="_idIndexMarker358"/><st c="12770">updating the cart, we redirect the user to the home </st><span class="No-Break"><st c="12822">page (</st></span><span class="No-Break"><strong class="source-inline"><st c="12828">home.index</st></strong></span><span class="No-Break"><st c="12839">).</st></span></li>
			</ul>
			<p><st c="12842">Now, let’s update the </st><strong class="source-inline"><st c="12865">movies.show</st></strong><st c="12876"> template to include a form to add movies to </st><span class="No-Break"><st c="12921">the cart.</st></span></p>
			<h2 id="_idParaDest-197"><a id="_idTextAnchor203"/><st c="12930">Updating the movies.show template</st></h2>
			<p><st c="12964">In the </st><strong class="source-inline"><st c="12972">/movies/templates/movies/show.html</st></strong><st c="13006"> file, add </st><a id="_idIndexMarker359"/><st c="13017">the following lines </st><span class="No-Break"><st c="13037">in bold:</st></span></p>
			<pre class="source-code"><st c="13045">
        …
        &lt;p&gt;&lt;b&gt;Description:&lt;/b&gt; {{
          template_data.movie.description }}&lt;/p&gt;
        &lt;p&gt;
          &lt;b&gt;Price:&lt;/b&gt; ${{ template_data.movie.price }}
        &lt;/p&gt;
        </st><strong class="bold"><st c="13168">&lt;p class="card-text"&gt;</st></strong>
<strong class="bold"><st c="13189">          &lt;form method="post"</st></strong>
<strong class="bold"><st c="13209">            action="{% url 'cart.add'</st></strong>
<strong class="bold"><st c="13235">            id=template_data.movie.id %}"&gt;</st></strong>
<strong class="bold"><st c="13266">            &lt;div class="row"&gt;</st></strong>
<strong class="bold"><st c="13284">              {% csrf_token %}</st></strong>
<strong class="bold"><st c="13301">              &lt;div class="col-auto"&gt;</st></strong>
<strong class="bold"><st c="13324">                &lt;div class="input-group col-auto"&gt;</st></strong>
<strong class="bold"><st c="13359">                  &lt;div class="input-group-text"&gt;Quantity</st></strong>
<strong class="bold"><st c="13398">                    &lt;/div&gt;</st></strong>
<strong class="bold"/><strong class="bold"><st c="13405">&lt;input type="number" min="1" max="10"</st></strong>
<strong class="bold"><st c="13443">                    class="form-control quantity-input"</st></strong>
<strong class="bold"><st c="13479">                    name="quantity" value="1"&gt;</st></strong>
<strong class="bold"><st c="13506">                &lt;/div&gt;</st></strong>
<strong class="bold"><st c="13513">              &lt;/div&gt;</st></strong>
<strong class="bold"><st c="13520">              &lt;div class="col-auto"&gt;</st></strong>
<strong class="bold"><st c="13543">                &lt;button class="btn bg-dark text-white"</st></strong>
<strong class="bold"><st c="13582">                  type="submit"&gt;Add to cart&lt;/button&gt;</st></strong>
<strong class="bold"><st c="13617">              &lt;/div&gt;</st></strong>
<strong class="bold"><st c="13624">            &lt;/div&gt;</st></strong>
<strong class="bold"/><strong class="bold"><st c="13631">&lt;/form&gt;</st></strong>
<strong class="bold"><st c="13639">        &lt;/p&gt;</st></strong><st c="13644">
        …</st></pre>			<p><st c="13645">We </st><a id="_idIndexMarker360"/><st c="13648">added a new form to allow users to add movies to the cart. </st><st c="13707">This form also includes an input field to specify the quantity of the movie the user wishes to add to the cart. </st><st c="13819">The form is linked to the </st><strong class="source-inline"><st c="13845">'cart.add'</st></strong><st c="13855"> path and passes the movie </st><strong class="source-inline"><st c="13882">id</st></strong><st c="13884"> as part of the </st><span class="No-Break"><st c="13900">form action.</st></span></p>
			<p><st c="13912">Now, save those files, run the server, go to </st><strong class="source-inline"><st c="13958">http://localhost:8000/movies</st></strong><st c="13986">, click on a specific movie, and you will see the </st><strong class="bold"><st c="14036">Add to cart</st></strong><st c="14047"> functionality available (</st><span class="No-Break"><em class="italic"><st c="14073">Figure 10</st></em></span><span class="No-Break"><em class="italic"><st c="14083">.5</st></em></span><span class="No-Break"><st c="14085">).</st></span></p>
			<div>
				<div id="_idContainer090" class="IMG---Figure">
					<img src="image/B22457_10_5.jpg" alt="Figure 10.5 – Movie page with the Add to cart functionality"/><st c="14088"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><st c="14265">Figure 10.5 – Movie page with the Add to cart functionality</st></p>
			<p><st c="14324">We successfully added a button to add movies to the cart. </st><st c="14383">Now, let’s move on to listing the movies added to </st><span class="No-Break"><st c="14433">the cart.</st></span></p>
			<h1 id="_idParaDest-198"><a id="_idTextAnchor204"/><st c="14442">Listing movies added to the cart</st></h1>
			<p><st c="14475">To</st><a id="_idIndexMarker361"/><st c="14478"> allow us to list movies added to the cart, we will follow the </st><span class="No-Break"><st c="14541">next steps:</st></span></p>
			<ol>
				<li><st c="14552">Configure the cart </st><span class="No-Break"><st c="14572">index URL.</st></span></li>
				<li><st c="14582">Define a </st><span class="No-Break"><strong class="source-inline"><st c="14592">utils</st></strong></span><span class="No-Break"><st c="14597"> file.</st></span></li>
				<li><st c="14603">Define </st><span class="No-Break"><st c="14611">a filter.</st></span></li>
				<li><st c="14620">Define an </st><span class="No-Break"><strong class="source-inline"><st c="14631">index</st></strong></span><span class="No-Break"><st c="14636"> function.</st></span></li>
				<li><st c="14646">Creating the </st><span class="No-Break"><strong class="source-inline"><st c="14660">cart.index</st></strong></span><span class="No-Break"><st c="14670"> template.</st></span></li>
				<li><st c="14680">Updating the </st><span class="No-Break"><strong class="source-inline"><st c="14694">add_to_cart</st></strong></span><span class="No-Break"><st c="14705"> function.</st></span></li>
				<li><st c="14715">Adding a link in the </st><span class="No-Break"><st c="14737">base template.</st></span></li>
			</ol>
			<h2 id="_idParaDest-199"><a id="_idTextAnchor205"/><st c="14751">Configuring cart index URL</st></h2>
			<p><st c="14778">In </st><strong class="source-inline"><st c="14782">/cart/urls.py</st></strong><st c="14795">, add the </st><a id="_idIndexMarker362"/><st c="14805">next path by adding the lines </st><span class="No-Break"><st c="14835">in bold:</st></span></p>
			<pre class="source-code"><st c="14843">
from django.urls import path
from . </st><st c="14880">import views
urlpatterns = [
    </st><strong class="bold"><st c="14909">path('', views.index, name='cart.index'),</st></strong><st c="14950">
    path('&lt;int:id&gt;/add/', views.add, name='cart.add'),
]</st></pre>			<p><st c="15003">We defined a </st><strong class="source-inline"><st c="15017">''</st></strong><st c="15019"> path but remember that the project-level URL file defined a </st><strong class="source-inline"><st c="15080">/cart</st></strong><st c="15085"> prefix for this file. </st><st c="15108">So, if a URL matches the </st><strong class="source-inline"><st c="15133">/cart</st></strong><st c="15138"> path, it will execute the </st><strong class="source-inline"><st c="15165">index</st></strong><st c="15170"> function defined in</st><a id="_idIndexMarker363"/><st c="15190"> the </st><strong class="source-inline"><st c="15195">views</st></strong><st c="15200"> file. </st><st c="15207">We will implement the </st><strong class="source-inline"><st c="15229">index</st></strong> <span class="No-Break"><st c="15234">function later.</st></span></p>
			<h2 id="_idParaDest-200"><a id="_idTextAnchor206"/><st c="15250">Defining a utils file</st></h2>
			<p><st c="15272">Commonly, cart pages display the</st><a id="_idIndexMarker364"/><st c="15305"> total amount to be paid. </st><st c="15331">This is calculated by summing the prices of the movies based on their corresponding quantities. </st><st c="15427">We will define a </st><strong class="source-inline"><st c="15444">calculate_cart_total</st></strong><st c="15464"> function to perform this process. </st><st c="15499">However, it is not recommended to place this kind of function in either the </st><strong class="source-inline"><st c="15575">views</st></strong><st c="15580"> file or the </st><strong class="source-inline"><st c="15593">models</st></strong><st c="15599"> file. </st><st c="15606">Therefore, we will create a utilities (</st><strong class="source-inline"><st c="15645">utils</st></strong><st c="15651">) file in which we will place this function to be </st><span class="No-Break"><st c="15702">easily reused.</st></span></p>
			<p><st c="15716">In </st><strong class="source-inline"><st c="15720">/cart/</st></strong><st c="15726">, create a new file called </st><strong class="source-inline"><st c="15753">utils.py</st></strong><st c="15761">. For now, fill it in with </st><span class="No-Break"><st c="15788">the following:</st></span></p>
			<pre class="source-code"><st c="15802">
def calculate_cart_total(cart, movies_in_cart):
    total = 0
    for movie in movies_in_cart:
        quantity = cart[str(movie.id)]
        total += movie.price * int(quantity)
    return total</st></pre>			<p><st c="15970">Let’s explain the </st><span class="No-Break"><st c="15989">previous code:</st></span></p>
			<ul>
				<li><st c="16003">We define the </st><strong class="source-inline"><st c="16018">calculate_cart_total</st></strong><st c="16038"> function, which takes two parameters: </st><strong class="source-inline"><st c="16077">cart</st></strong><st c="16081"> and </st><strong class="source-inline"><st c="16086">movies_in_cart</st></strong><st c="16100">. The </st><strong class="source-inline"><st c="16106">cart</st></strong><st c="16110"> parameter is a dictionary that represents the user’s shopping cart. </st><st c="16179">Remember that the keys are strings representing movie IDs, and the values are strings representing the quantities of each movie in the cart. </st><st c="16320">The </st><strong class="source-inline"><st c="16324">movies_in_cart</st></strong><st c="16338"> parameter is a list of </st><strong class="source-inline"><st c="16362">Movie</st></strong><st c="16367"> objects representing the movies in </st><span class="No-Break"><st c="16403">the cart.</st></span></li>
				<li><st c="16412">We initialize a </st><strong class="source-inline"><st c="16429">total</st></strong><st c="16434"> variable </st><span class="No-Break"><st c="16444">by </st></span><span class="No-Break"><strong class="source-inline"><st c="16447">0</st></strong></span><span class="No-Break"><st c="16448">.</st></span></li>
				<li><st c="16449">We iterate through the list of movies in the cart. </st><st c="16501">For each movie, we extract the corresponding quantity added to the cart and multiply it by the movie’s price. </st><st c="16611">Then, we add the total cost for the movie to the </st><span class="No-Break"><strong class="source-inline"><st c="16660">total</st></strong></span><span class="No-Break"><st c="16665"> variable.</st></span></li>
				<li><st c="16675">Finally, we return the </st><span class="No-Break"><st c="16699">total variable.</st></span></li>
			</ul>
			<p><st c="16714">In summary, </st><strong class="source-inline"><st c="16727">calculate_cart_total</st></strong><st c="16747"> calculates the total cost of the movies in the user’s cart by iterating over each movie in the cart, multiplying the movie’s price by its quantity, and </st><a id="_idIndexMarker365"/><st c="16900">summing up the total costs. </st><st c="16928">This function will be used later in the </st><span class="No-Break"><strong class="source-inline"><st c="16968">views</st></strong></span><span class="No-Break"><st c="16973"> file.</st></span></p>
			<h2 id="_idParaDest-201"><a id="_idTextAnchor207"/><st c="16979">Defining a filter</st></h2>
			<p><strong class="bold"><st c="16997">Django filters</st></strong><st c="17012"> are a </st><a id="_idIndexMarker366"/><st c="17019">feature of the </st><a id="_idIndexMarker367"/><st c="17034">template engine that allows you to modify or format data in a template. </st><st c="17106">Filters are applied to variables using a pipe (</st><strong class="source-inline"><st c="17153">|</st></strong><st c="17155">) character and are a powerful tool for customizing the presentation of data in </st><span class="No-Break"><st c="17235">a template.</st></span></p>
			<p><st c="17246">We want to list the movies added to the cart and display the quantity of each movie. </st><st c="17332">This requires accessing the cart session data and using each movie’s ID as a key to get the </st><strong class="source-inline"><st c="17424">quantity</st></strong><st c="17432"> value. </st><st c="17440">While this may not sound very complicated, Django templates are designed to be simple and primarily focused on rendering data provided by views. </st><st c="17585">Sometimes, Django templates don’t allow access to data that depends on other variables or complex data structures. </st><st c="17700">In such cases, you will need to create a custom filter or tag. </st><st c="17763">We will create a custom filter to access the </st><strong class="source-inline"><st c="17808">quantity</st></strong><st c="17816"> data for the movies in </st><span class="No-Break"><st c="17840">the cart.</st></span></p>
			<p><st c="17849">In </st><strong class="source-inline"><st c="17853">/cart/</st></strong><st c="17859">, create a </st><strong class="source-inline"><st c="17870">templatetags</st></strong><st c="17882"> folder. </st><st c="17891">Then, in </st><strong class="source-inline"><st c="17900">/cart/templatetags/</st></strong><st c="17919"> create a new file called </st><strong class="source-inline"><st c="17945">cart_filters.py</st></strong><st c="17960">. For now, fill it in with </st><span class="No-Break"><st c="17987">the following:</st></span></p>
			<pre class="source-code"><st c="18001">
from django import template
register = template.Library()
@register.filter(name='get_quantity')
def get_cart_quantity(cart, movie_id):
    return cart[str(movie_id)]</st></pre>			<p><st c="18163">Let’s explain the </st><span class="No-Break"><st c="18182">previous code:</st></span></p>
			<ul>
				<li><st c="18196">We import the </st><strong class="source-inline"><st c="18211">template</st></strong><st c="18219"> module, which provides utilities for working with </st><span class="No-Break"><st c="18270">Django templates.</st></span></li>
				<li><st c="18287">We use the </st><strong class="source-inline"><st c="18299">register = template.Library()</st></strong><st c="18328"> code to create an instance of </st><strong class="source-inline"><st c="18359">template.Library</st></strong><st c="18375">, which is used to register custom template tags </st><span class="No-Break"><st c="18424">and filters.</st></span></li>
				<li><st c="18436">We use the </st><strong class="source-inline"><st c="18448">@register.filter(name='get_quantity')</st></strong><st c="18485"> decorator to register the </st><strong class="source-inline"><st c="18512">get_cart_quantity</st></strong><st c="18529"> function as a custom template filter named </st><strong class="source-inline"><st c="18573">get_quantity</st></strong><st c="18585">. The </st><strong class="source-inline"><st c="18591">name='get_quantity'</st></strong><st c="18610"> argument specifies the name of the filter as it will be used </st><span class="No-Break"><st c="18672">in templates.</st></span></li>
				<li><st c="18685">We define the </st><strong class="source-inline"><st c="18700">get_cart_quantity</st></strong><st c="18717"> function, which takes two arguments: the </st><strong class="source-inline"><st c="18759">cart</st></strong><st c="18763"> session dictionary, and the ID of the movie for which the quantity </st><span class="No-Break"><st c="18831">is needed.</st></span></li>
				<li><st c="18841">We access the </st><strong class="source-inline"><st c="18856">quantity</st></strong><st c="18864"> value by using the </st><strong class="source-inline"><st c="18884">cart</st></strong><st c="18888"> dictionary and </st><strong class="source-inline"><st c="18904">movie_id</st></strong><st c="18912"> as the key. </st><st c="18925">We convert </st><strong class="source-inline"><st c="18936">movie_id</st></strong><st c="18944"> to a string to ensure compatibility with the </st><span class="No-Break"><st c="18990">cart keys.</st></span></li>
				<li><st c="19000">Finally, we </st><a id="_idIndexMarker368"/><st c="19013">return the corresponding </st><span class="No-Break"><strong class="source-inline"><st c="19038">quantity</st></strong></span><span class="No-Break"><st c="19046"> value.</st></span></li>
			</ul>
			<p class="callout-heading"><st c="19053">Note</st></p>
			<p class="callout"><st c="19058">Once the custom filter is defined and registered, you can use it in a Django template such as this: </st><strong class="source-inline"><st c="19159">{{ </st></strong><span class="No-Break"><strong class="source-inline"><st c="19162">request.session.cart|get_quantity:movie.id }}</st></strong></span></p>
			<p class="callout"><st c="19207">In the preceding example, the </st><strong class="source-inline"><st c="19238">get_quantity</st></strong><st c="19250"> filter is applied to </st><strong class="source-inline"><st c="19272">request.session.cart</st></strong><st c="19292"> with the </st><strong class="source-inline"><st c="19302">movie.id</st></strong><st c="19310"> argument to obtain the quantity of the specific movie in </st><span class="No-Break"><st c="19368">the cart.</st></span></p>
			<p class="callout"><st c="19377">You can find more information about custom filters and tags</st><a id="_idIndexMarker369"/> <span class="No-Break"><st c="19437">here: </st></span><a href="https://docs.djangoproject.com/en/5.0/howto/custom-template-tags/"><span class="No-Break"><st c="19444">https://docs.djangoproject.com/en/5.0/howto/custom-template-tags/</st></span></a><span class="No-Break"><st c="19509">.</st></span></p>
			<p><st c="19510">We have designed all the elements we need to implement the cart </st><span class="No-Break"><st c="19575">index function.</st></span></p>
			<h2 id="_idParaDest-202"><a id="_idTextAnchor208"/><st c="19590">Defining an index function</st></h2>
			<p><st c="19617">In </st><strong class="source-inline"><st c="19621">/cart/views.py</st></strong><st c="19635">, add the following</st><a id="_idIndexMarker370"/> <span class="No-Break"><st c="19654">in bold:</st></span></p>
			<pre class="source-code"><st c="19663">
from django.shortcuts import render
from django.shortcuts import get_object_or_404, redirect
from movies.models import Movie
</st><strong class="bold"><st c="19789">from .utils import calculate_cart_total</st></strong>
<strong class="bold"><st c="19828">def index(request):</st></strong>
<strong class="bold"><st c="19848">    cart_total = 0</st></strong>
<strong class="bold"><st c="19863">    movies_in_cart = []</st></strong>
<strong class="bold"><st c="19883">    cart = request.session.get('cart', {})</st></strong>
<strong class="bold"><st c="19922">    movie_ids = list(cart.keys())</st></strong>
<strong class="bold"><st c="19952">    if (movie_ids != []):</st></strong>
<strong class="bold"><st c="19974">        movies_in_cart =</st></strong>
<strong class="bold"><st c="19991">         Movie.objects.filter(id__in=movie_ids)</st></strong>
<strong class="bold"><st c="20030">        cart_total = calculate_cart_total(cart,</st></strong>
<strong class="bold"><st c="20070">            movies_in_cart)</st></strong>
<strong class="bold"><st c="20086">    template_data = {}</st></strong>
<strong class="bold"><st c="20105">    template_data['title'] = 'Cart'</st></strong>
<strong class="bold"><st c="20137">    template_data['movies_in_cart'] = movies_in_cart</st></strong>
<strong class="bold"><st c="20186">    template_data['cart_total'] = cart_total</st></strong>
<strong class="bold"><st c="20227">    return render(request, 'cart/index.html',</st></strong>
<strong class="bold"><st c="20269">        {'template_data': template_data})</st></strong><st c="20303">
def add(request, id):
    …</st></pre>			<p><st c="20327">Let’s explain the</st><a id="_idIndexMarker371"/> <span class="No-Break"><st c="20345">previous code:</st></span></p>
			<ul>
				<li><st c="20360">We import the </st><strong class="source-inline"><st c="20375">calculate_cart_total</st></strong><st c="20395"> function from the </st><span class="No-Break"><strong class="source-inline"><st c="20414">utils</st></strong></span><span class="No-Break"><st c="20419"> file.</st></span></li>
				<li><st c="20425">We define the </st><span class="No-Break"><strong class="source-inline"><st c="20440">index</st></strong></span><span class="No-Break"><st c="20445"> function.</st></span></li>
				<li><st c="20455">We initialize the </st><strong class="source-inline"><st c="20474">cart_total</st></strong><st c="20484"> to </st><strong class="source-inline"><st c="20488">0</st></strong><st c="20489">, and </st><strong class="source-inline"><st c="20495">movies_in_cart</st></strong><st c="20509"> as an </st><span class="No-Break"><st c="20516">empty list.</st></span></li>
				<li><st c="20527">We retrieve the cart information from the session using </st><span class="No-Break"><strong class="source-inline"><st c="20584">request.session.get('cart', {})</st></strong></span><span class="No-Break"><st c="20615">.</st></span></li>
				<li><st c="20616">We extract the movie IDs that were added to the cart based on the </st><span class="No-Break"><st c="20683">cart keys.</st></span></li>
				<li><st c="20693">If there are any movie IDs in the cart, the function queries the database for movies with those IDs using </st><strong class="source-inline"><st c="20800">Movie.objects.filter(id__in=movie_ids)</st></strong><st c="20838">. Additionally, we calculate the total cost of the movies in the cart using the </st><strong class="source-inline"><st c="20918">calculate_cart_total</st></strong><st c="20938"> function, which updates the </st><span class="No-Break"><strong class="source-inline"><st c="20967">cart_total</st></strong></span><span class="No-Break"><st c="20977"> variable.</st></span></li>
				<li><st c="20987">Finally, we prepare the </st><strong class="source-inline"><st c="21012">template_data</st></strong><st c="21025"> dictionary and render the </st><span class="No-Break"><strong class="source-inline"><st c="21052">cart/index.html</st></strong></span><span class="No-Break"><st c="21067"> template.</st></span></li>
			</ul>
			<p><st c="21077">In summary, the </st><strong class="source-inline"><st c="21094">index</st></strong><st c="21099"> function</st><a id="_idIndexMarker372"/><st c="21108"> is designed to render the cart page, showing the movies in the cart and the total cost of </st><span class="No-Break"><st c="21199">those movies.</st></span></p>
			<h2 id="_idParaDest-203"><a id="_idTextAnchor209"/><st c="21212">Creating the cart.index template</st></h2>
			<p><st c="21245">In </st><strong class="source-inline"><st c="21249">/cart/</st></strong><st c="21255">, create </st><a id="_idIndexMarker373"/><st c="21264">a </st><strong class="source-inline"><st c="21266">templates</st></strong><st c="21275"> folder. </st><st c="21284">Then, in </st><strong class="source-inline"><st c="21293">/cart/templates/</st></strong><st c="21309">, create a </st><span class="No-Break"><strong class="source-inline"><st c="21320">cart</st></strong></span><span class="No-Break"><st c="21324"> folder.</st></span></p>
			<p><st c="21332">Now, in </st><strong class="source-inline"><st c="21341">/cart/templates/cart/</st></strong><st c="21362">, create a </st><a id="_idIndexMarker374"/><st c="21373">new file, </st><strong class="source-inline"><st c="21383">index.html</st></strong><st c="21393">. For now, fill it in with </st><span class="No-Break"><st c="21420">the following:</st></span></p>
			<pre class="source-code"><st c="21434">
{% extends 'base.html' %}
{% block content %}
{% load static %}
{% load cart_filters %}
&lt;div class="p-3"&gt;
  &lt;div class="container"&gt;
    &lt;div class="row mt-3"&gt;
      &lt;div class="col mx-auto mb-3"&gt;
        &lt;h2&gt;Shopping Cart&lt;/h2&gt;
        &lt;hr /&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="row m-1"&gt;
      &lt;table class="table table-bordered table-striped
        text-center"&gt;
        &lt;thead&gt;
          &lt;tr&gt;
            &lt;th scope="col"&gt;ID&lt;/th&gt;
            &lt;th scope="col"&gt;Name&lt;/th&gt;
            &lt;th scope="col"&gt;Price&lt;/th&gt;
            &lt;th scope="col"&gt;Quantity&lt;/th&gt;
          &lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody&gt;
          {% for movie in template_data.movies_in_cart %}
          &lt;tr&gt;
            &lt;td&gt;{{ movie.id }}&lt;/td&gt;
            &lt;td&gt;{{ movie.name }}&lt;/td&gt;
            &lt;td&gt;${{ movie.price }}&lt;/td&gt;
            &lt;td&gt;{{
              request.session.cart|get_quantity:movie.id }}
            &lt;/td&gt;
          &lt;/tr&gt;
          {% endfor %}
        &lt;/tbody&gt;
      &lt;/table&gt;
    &lt;/div&gt;
    &lt;div class="row"&gt;
      &lt;div class="text-end"&gt;
        &lt;a class="btn btn-outline-secondary mb-2"&gt;&lt;b&gt;Total
          to pay:&lt;/b&gt; ${{ template_data.cart_total }}&lt;/a&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
{% endblock content %}</st></pre>			<p><st c="22315">Let’s explain the</st><a id="_idIndexMarker375"/> <span class="No-Break"><st c="22333">previous code:</st></span></p>
			<ul>
				<li><st c="22348">We use the </st><strong class="source-inline"><st c="22360">{% load cart_filters %}</st></strong><st c="22383"> tag, which loads custom template filters defined in the </st><strong class="source-inline"><st c="22440">cart_filters</st></strong><st c="22452"> file. </st><st c="22459">In our case, it includes the filter </st><span class="No-Break"><st c="22495">named </st></span><span class="No-Break"><strong class="source-inline"><st c="22501">get_quantity</st></strong></span><span class="No-Break"><st c="22513">.</st></span></li>
				<li><st c="22514">We create an </st><span class="No-Break"><st c="22528">HTML table.</st></span></li>
				<li><st c="22539">We iterate through the movies in the cart. </st><st c="22583">For each movie, we display its </st><strong class="source-inline"><st c="22614">id</st></strong><st c="22616">, </st><strong class="source-inline"><st c="22618">name</st></strong><st c="22622">, </st><strong class="source-inline"><st c="22624">price</st></strong><st c="22629">, and </st><strong class="source-inline"><st c="22635">quantity</st></strong><st c="22643"> value in the cart. </st><st c="22663">To display the quantity in the cart, we use the </st><span class="No-Break"><strong class="source-inline"><st c="22711">get_quantity</st></strong></span><span class="No-Break"><st c="22723"> filter.</st></span></li>
				<li><st c="22731">Finally, we </st><a id="_idIndexMarker376"/><st c="22744">display the </st><span class="No-Break"><strong class="source-inline"><st c="22756">cart_total</st></strong></span><span class="No-Break"><st c="22766"> value.</st></span></li>
			</ul>
			<h2 id="_idParaDest-204"><a id="_idTextAnchor210"/><st c="22773">Updating the add_to_cart function</st></h2>
			<p><st c="22807">In </st><strong class="source-inline"><st c="22811">/cart/views.py</st></strong><st c="22825">, add the </st><a id="_idIndexMarker377"/><st c="22835">following lines </st><span class="No-Break"><st c="22851">in bold:</st></span></p>
			<pre class="source-code"><st c="22859">
…
def add_to_cart(request, id):
    get_object_or_404(Movie, id=id)
    cart = request.session.get('cart', {})
    cart[id] = request.POST['quantity']
    request.session['cart'] = cart
    return redirect('</st><strong class="bold"><st c="23046">cart</st></strong><st c="23051">.index')</st></pre>			<p><st c="23059">If a user adds a movie to the cart, they will now be redirected to the </st><span class="No-Break"><st c="23131">cart page.</st></span></p>
			<h2 id="_idParaDest-205"><a id="_idTextAnchor211"/><st c="23141">Adding a link in the base template</st></h2>
			<p><st c="23176">Finally, let’s </st><a id="_idIndexMarker378"/><st c="23192">add the cart link in the base template. </st><st c="23232">In </st><strong class="source-inline"><st c="23235">/moviesstore/templates/base.html</st></strong><st c="23267">, in the header section, add the following lines </st><span class="No-Break"><st c="23316">in bold:</st></span></p>
			<pre class="source-code"><st c="23324">
            …
            &lt;a class="nav-link"
              href="{% url 'home.about' %}"&gt;About&lt;/a&gt;
            &lt;a class="nav-link"
              href="{% url 'movies.index' %}"&gt;Movies&lt;/a&gt;
            </st><strong class="bold"><st c="23449">&lt;a class="nav-link"</st></strong>
<strong class="bold"><st c="23468">              href="{% url 'cart.index' %}"&gt;Cart&lt;/a&gt;</st></strong><st c="23507">
            …</st></pre>			<p><st c="23508">Now, save those </st><a id="_idIndexMarker379"/><st c="23524">files, run the server, go to </st><strong class="source-inline"><st c="23553">http://localhost:8000/movies</st></strong><st c="23581">, click on a couple of movies, and add them to the cart. </st><st c="23638">Then, go to the </st><strong class="bold"><st c="23654">Cart</st></strong><st c="23658"> section and you will see a </st><strong class="bold"><st c="23686">Cart</st></strong><st c="23690"> page with its corresponding information (</st><span class="No-Break"><em class="italic"><st c="23732">Figure 10</st></em></span><span class="No-Break"><em class="italic"><st c="23742">.6</st></em></span><span class="No-Break"><st c="23744">).</st></span></p>
			<div>
				<div id="_idContainer091" class="IMG---Figure">
					<img src="image/B22457_10_6.jpg" alt="Figure 10.6 – The Cart page"/><st c="23747"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><st c="23934">Figure 10.6 – The Cart page</st></p>
			<p><st c="23961">Now that we have learned how to implement a cart system, let’s finish this chapter by including the functionality to remove movies from </st><span class="No-Break"><st c="24098">the cart.</st></span></p>
			<h1 id="_idParaDest-206"><a id="_idTextAnchor212"/><st c="24107">Removing movies from the cart</st></h1>
			<p><st c="24137">To</st><a id="_idIndexMarker380"/><st c="24140"> remove movies from the cart, we will follow the </st><span class="No-Break"><st c="24189">next steps:</st></span></p>
			<ol>
				<li><st c="24200">Configure a </st><span class="No-Break"><strong class="source-inline"><st c="24213">clear</st></strong></span><span class="No-Break"><st c="24218"> URL.</st></span></li>
				<li><st c="24223">Defining a </st><span class="No-Break"><strong class="source-inline"><st c="24235">clear</st></strong></span><span class="No-Break"><st c="24240"> function.</st></span></li>
				<li><st c="24250">Updating the </st><span class="No-Break"><strong class="source-inline"><st c="24264">cart.index</st></strong></span><span class="No-Break"><st c="24274"> template.</st></span></li>
			</ol>
			<h2 id="_idParaDest-207"><a id="_idTextAnchor213"/><st c="24284">Configuring clear URL</st></h2>
			<p><st c="24306">In </st><strong class="source-inline"><st c="24310">/cart/urls.py</st></strong><st c="24323">, add the </st><a id="_idIndexMarker381"/><st c="24333">next path by adding the following lines </st><span class="No-Break"><st c="24373">in bold:</st></span></p>
			<pre class="source-code"><st c="24381">
from django.urls import path
from . </st><st c="24418">import views
urlpatterns = [
    path('', views.index, name='cart.index'),
    path('&lt;int:id&gt;/add/', views.add, name='cart.add'),
    </st><strong class="bold"><st c="24540">path('clear/', views.clear, name='cart.clear'),</st></strong><st c="24587">
]</st></pre>			<p><st c="24589">We define a </st><strong class="source-inline"><st c="24601">cart/clear/</st></strong><st c="24612"> path that will execute the </st><strong class="source-inline"><st c="24640">clear</st></strong><st c="24645"> function defined in the </st><strong class="source-inline"><st c="24670">views</st></strong><st c="24675"> file. </st><st c="24682">We will implement the </st><strong class="source-inline"><st c="24704">clear</st></strong> <span class="No-Break"><st c="24709">function later.</st></span></p>
			<h2 id="_idParaDest-208"><a id="_idTextAnchor214"/><st c="24725">Defining clear function</st></h2>
			<p><st c="24749">In </st><strong class="source-inline"><st c="24753">/cart/views.py</st></strong><st c="24767">, add the</st><a id="_idIndexMarker382"/><st c="24776"> following lines in bold at the end of </st><span class="No-Break"><st c="24815">the file:</st></span></p>
			<pre class="source-code"><st c="24824">
…
</st><strong class="bold"><st c="24826">def clear(request):</st></strong>
<strong class="bold"><st c="24845">    request.session['cart'] = {}</st></strong>
<strong class="bold"><st c="24874">    return redirect('cart.index')</st></strong></pre>			<p><st c="24904">We just update the user’s cart session to an empty dictionary. </st><st c="24968">This removes all previous movies added to the cart, and we redirect the user to the </st><span class="No-Break"><st c="25052">cart page.</st></span></p>
			<h2 id="_idParaDest-209"><a id="_idTextAnchor215"/><st c="25062">Updating the cart.index template</st></h2>
			<p><st c="25095">In the </st><strong class="source-inline"><st c="25103">/cart/templates/cart/index.html</st></strong><st c="25134"> file, add</st><a id="_idIndexMarker383"/><st c="25144"> the following lines </st><span class="No-Break"><st c="25165">in bold:</st></span></p>
			<pre class="source-code"><st c="25173">
    …
    &lt;div class="row"&gt;
      &lt;div class="text-end"&gt;
        &lt;a class="btn btn-outline-secondary mb-2"&gt;&lt;b&gt;Total
          to pay:&lt;/b&gt; ${{ template_data.cart_total }}&lt;/a&gt;
        </st><strong class="bold"><st c="25315">{% if template_data.movies_in_cart|length &gt; 0 %}</st></strong>
<strong class="bold"><st c="25363">        &lt;a href="{% url 'cart.clear' %}"&gt;</st></strong>
<strong class="bold"><st c="25397">          &lt;button class="btn btn-danger mb-2"&gt;</st></strong>
<strong class="bold"><st c="25434">            Remove all movies from Cart</st></strong>
<strong class="bold"><st c="25462">          &lt;/button&gt;</st></strong>
<strong class="bold"><st c="25472">        &lt;/a&gt;</st></strong>
<strong class="bold"><st c="25477">        {% endif %}</st></strong><st c="25489">
      &lt;/div&gt;
    &lt;/div&gt;
    …</st></pre>			<p><st c="25504">We added an </st><strong class="source-inline"><st c="25517">if</st></strong><st c="25519"> section to check whether there are any movies in the cart. </st><st c="25579">If there are, we display a button that allows the user to clear </st><span class="No-Break"><st c="25643">the cart.</st></span></p>
			<p><st c="25652">Now, save those files, run the server, go to </st><strong class="source-inline"><st c="25698">http://localhost:8000/movies</st></strong><st c="25726">, click on a couple of movies, and add them to the cart. </st><st c="25783">Then, go to the </st><strong class="bold"><st c="25799">Cart</st></strong><st c="25803"> section and click </st><strong class="bold"><st c="25822">Remove all movies from Cart</st></strong><st c="25849"> (</st><span class="No-Break"><em class="italic"><st c="25851">Figure 10</st></em></span><em class="italic"><st c="25860">.7</st></em><st c="25862">). </st><st c="25866">You will see an </st><span class="No-Break"><st c="25882">empty cart.</st></span></p>
			<div>
				<div id="_idContainer092" class="IMG---Figure">
					<img src="image/B22457_10_7.jpg" alt="Figure 10.7 – The Cart page"/><st c="25893"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><st c="25984">Figure 10.7 – The Cart page</st></p>
			<h1 id="_idParaDest-210"><a id="_idTextAnchor216"/><st c="26011">Summary</st></h1>
			<p><st c="26019">In this chapter, we learned how web sessions and Django sessions work. </st><st c="26091">We created a cart app that allows us to add movies to the cart, list the movies added to the cart, and remove the movies from the cart. </st><st c="26227">We also learned that the </st><strong class="source-inline"><st c="26252">utils</st></strong><st c="26257"> file is useful for storing functions that can be reused across our app. </st><st c="26330">Additionally, we learned that filters allow us to modify or format the data displayed in the templates, and we learned how to utilize some Django session functionalities. </st><st c="26501">In the next chapter, we will create the order and item models to enable users to </st><span class="No-Break"><st c="26582">purchase movies.</st></span></p>
		</div>
	<div id="charCountTotal" value="26598"/></body></html>