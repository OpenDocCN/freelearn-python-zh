<html><head></head><body>
  <div><div><div><div><div><h1 class="title"><a id="ch05"/>Chapter 5. E-mail Protocols, FTP, and CGI Programming</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Listing the files in a remote FTP server</li><li class="listitem" style="list-style-type: disc">Uploading a local file to a remote FTP server</li><li class="listitem" style="list-style-type: disc">E-mailing your current working directory as a compressed ZIP file</li><li class="listitem" style="list-style-type: disc">Downloading your Google e-mail with POP3</li><li class="listitem" style="list-style-type: disc">Checking your remote e-mail with IMAP</li><li class="listitem" style="list-style-type: disc">Sending an e-mail with an attachment via the Gmail SMTP server</li><li class="listitem" style="list-style-type: disc">Writing a guestbook for your (Python-based) web server with CGI</li></ul></div><div><div><div><div><h1 class="title"><a id="ch05lvl1sec52"/>Introduction</h1></div></div></div><p>This chapter explores the FTP, e-mail, and CGI communications protocol with a Python recipe. Python is a very efficient and friendly language. Using Python, you can easily code simple FTP actions such as a file download and upload.</p><p>There are some interesting recipes in this chapter, such as manipulating your Google e-mail, also known as the Gmail account, from your Python script. You can use these recipes to check, download, and send e-mails with IMAP, POP3, and SMTP protocols. In another recipe, a web server with CGI also demonstrates the basic CGI action, such as writing a guest comment form in your web application.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch05lvl1sec53"/>Listing the files in a remote FTP server</h1></div></div></div><p>You would like to list the <a id="id300" class="indexterm"/>files available on the official <a id="id301" class="indexterm"/>Linux kernel's FTP site, <a class="ulink" href="http://ftp.kernel.org">ftp.kernel.org</a>. You can select any other FTP site to try this recipe.</p><div><div><div><div><h2 class="title"><a id="ch05lvl2sec102"/>Getting ready</h2></div></div></div><p>If you work on a real FTP site with a user account, you need a username and password. However, in this instance, you don't need a username (and password) with Linux kernel's FTP site as you can log in anonymously.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec103"/>How to do it...</h2></div></div></div><p>We can use the <code class="literal">ftplib</code> library to fetch files from our selected FTP site. A detailed documentation of this library can be found at <a class="ulink" href="http://docs.python.org/2/library/ftplib.html">http://docs.python.org/2/library/ftplib.html</a>.</p><p>Let us see how we can fetch some files with <code class="literal">ftplib</code>.</p><p>Listing 5.1 gives a simple FTP connection test as follows:</p><div><pre class="programlisting">#!/usr/bin/env python
# Python Network Programming Cookbook -- Chapter - 5
# This program is optimized for Python 2.7.
# It may run on any other version with/without modifications.

FTP_SERVER_URL = 'ftp.kernel.org'

import ftplib
def test_ftp_connection(path, username, email):
    #Open ftp connection
    ftp = ftplib.FTP(path, username, email)
    
   #List the files in the /pub directory
    ftp.cwd("/pub")
    print "File list at %s:" %path
    files = ftp.dir()
    print files

    ftp.quit()
if __name__ == '__main__':
    test_ftp_connection(path=FTP_SERVER_URL, username='anonymous',
                        email='nobody@nourl.com', 
                        )</pre></div><p>This recipe will list the files and folders present in the FTP path, <code class="literal">ftp.kernel.org/pub</code>. If you run this script, you can see the following output:</p><div><pre class="programlisting">
<strong>$ python 5_1_list_files_on_ftp_server.py</strong>
<strong>File list at ftp.kernel.org:</strong>
<strong>drwxrwxr-x    6 ftp      ftp          4096 Dec 01  2011 dist</strong>
<strong>drwxr-xr-x   13 ftp      ftp          4096 Nov 16  2011 linux</strong>
<strong>drwxrwxr-x    3 ftp      ftp          4096 Sep 23  2008 media</strong>
<strong>drwxr-xr-x   17 ftp      ftp          4096 Jun 06  2012 scm</strong>
<strong>drwxrwxr-x    2 ftp      ftp          4096 Dec 01  2011 site</strong>
<strong>drwxr-xr-x   13 ftp      ftp          4096 Nov 27  2011 software</strong>
<strong>drwxr-xr-x    3 ftp      ftp          4096 Apr 30  2008 tools</strong>
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec104"/>How it works...</h2></div></div></div><p>This recipe uses <code class="literal">ftplib</code> to create an FTP client session with <a class="ulink" href="http://ftp.kernel.org">ftp.kernel.org</a>. The <code class="literal">test_ftp_connection()</code> function<a id="id302" class="indexterm"/> takes the FTP path, username, and e-mail address for connecting to the FTP server.</p><p>An FTP client session can be<a id="id303" class="indexterm"/> created by calling the <code class="literal">FTP()</code>function<a id="id304" class="indexterm"/> of <code class="literal">ftplib</code> with the preceding connection's credentials.<a id="id305" class="indexterm"/> This returns a client handle which then can be used to run the usual ftp commands, such as the command to change the working directory or <code class="literal">cwd()</code>. The <code class="literal">dir()</code>method returns the directory listing.</p><p>It is good idea to quit the FTP session by calling <code class="literal">ftp.quit()</code>.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch05lvl1sec54"/>Uploading a local file to a remote FTP server</h1></div></div></div><p>You would like to<a id="id306" class="indexterm"/> upload a file to an FTP server.</p><div><div><div><div><h2 class="title"><a id="ch05lvl2sec105"/>Getting ready</h2></div></div></div><p>Let us set up a<a id="id307" class="indexterm"/> local FTP server. In Unix/Linux, you can install the <strong>wu-ftpd</strong> package<a id="id308" class="indexterm"/> using the following command:</p><div><pre class="programlisting">
<strong>$ sudo apt-get install wu-ftpd</strong>
</pre></div><p>On a Windows machine, you can install the FileZilla FTP server, which can be downloaded from <a class="ulink" href="https://filezilla-project.org/download.php?type=server">https://filezilla-project.org/download.php?type=server</a>.</p><p>You should create an FTP user account following the FTP server package's user manual.</p><p>You would also like to upload a file to an ftp server. You can specify the server address, login credentials, and filename as the input argument of your script. You should create a local file called <code class="literal">readme.txt</code> with any text in it.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec106"/>How to do it...</h2></div></div></div><p>Using the following script, let's set up a local FTP server. In Unix/Linux, you can install the wu-ftpd package. Then, <a id="id309" class="indexterm"/>you can upload a file to the <a id="id310" class="indexterm"/>logged-in user's home directory. You can specify the server address, login credentials, and filename as the input argument of your script.</p><p>Listing 5.2 gives the FTP Upload Example as follows:</p><div><pre class="programlisting">#!/usr/bin/env python
# Python Network Programming Cookbook -- Chapter - 5
# This program is optimized for Python 2.7.
# It may run on any other version with/without modifications.

import os
import argparse
import ftplib

import getpass 
LOCAL_FTP_SERVER = 'localhost'
LOCAL_FILE = 'readme.txt'
def ftp_upload(ftp_server, username, password, file_name):
    print "Connecting to FTP server: %s" %ftp_server
    ftp = ftplib.FTP(ftp_server)
    print "Login to FTP server: user=%s" %username
    ftp.login(username, password)
    ext = os.path.splitext(file_name)[1]
    if ext in (".txt", ".htm", ".html"):
        ftp.storlines("STOR " + file_name, open(file_name))
    else:
        ftp.storbinary("STOR " + file_name, open(file_name, "rb"), 1024)
    print "Uploaded file: %s" %file_name

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='FTP Server Upload Example')
    parser.add_argument('--ftp-server', action="store", dest="ftp_server", default=LOCAL_FTP_SERVER)
    parser.add_argument('--file-name', action="store", dest="file_name", default=LOCAL_FILE)
    parser.add_argument('--username', action="store", dest="username", default=getpass.getuser())
    given_args = parser.parse_args() 
    ftp_server, file_name, username = given_args.ftp_server, given_args.file_name, given_args.username
    password = getpass.getpass(prompt="Enter you FTP password: ")
    ftp_upload(ftp_server, username, password, file_name)</pre></div><p>If you set up a local FTP server and run the following script, this script will log in to the FTP server and then will upload a file. If a filename argument is not supplied from command line by default, it will upload the <code class="literal">readme.txt</code> file.</p><div><pre class="programlisting">
<strong>$ python 5_2_upload_file_to_ftp_server.py </strong>
<strong>Enter your FTP password: </strong>
<strong>Connecting to FTP server: localhost</strong>
<strong>Login to FTP server: user=faruq</strong>
<strong>Uploaded file: readme.txt</strong>

<strong>$ cat /home/faruq/readme.txt </strong>
<strong>This file describes what to do with the .bz2 files you see elsewhere</strong>
<strong>on this site (ftp.kernel.org).</strong>
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec107"/>How it works...</h2></div></div></div><p>In this recipe, we<a id="id311" class="indexterm"/> assume that a local FTP server is running. <a id="id312" class="indexterm"/>Alternatively, you can connect to a remote FTP server. The <code class="literal">ftp_upload()</code> method<a id="id313" class="indexterm"/> uses the <code class="literal">FTP()</code>function of Python's <code class="literal">ftplib</code> to create an FTP connection object. With the <code class="literal">login()</code> method, it logs in to the server.</p><p>After a successful login, the <code class="literal">ftp</code> object sends the STOR command with either the<a id="id314" class="indexterm"/> <code class="literal">storlines()</code> or <code class="literal">storbinary()</code> method<a id="id315" class="indexterm"/>. The first method is used for sending ASCII text files such as HTML or text files. The latter method is used for binary data such as zipped archive.</p><p>It's a good idea to wrap these FTP methods with <code class="literal">try-catch</code> error-handling blocks, which is not shown here for the sake of brevity.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch05lvl1sec55"/>E-mailing your current working directory as a compressed ZIP file</h1></div></div></div><p>It might be interesting to send the<a id="id316" class="indexterm"/> current working directory contents<a id="id317" class="indexterm"/> as a compressed ZIP archive. You can use this recipe to quickly share your files with your friends.</p><div><div><div><div><h2 class="title"><a id="ch05lvl2sec108"/>Getting ready</h2></div></div></div><p>If you don't have any mail server installed on your machine, you need to install a local mail server such as <code class="literal">postfix</code>. On a Debian/Ubuntu system, this can be installed with default settings using <code class="literal">apt-get</code>, as shown in the following command:</p><div><pre class="programlisting">
<strong>$ sudo apt-get install postfix</strong>
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec109"/>How to do it...</h2></div></div></div><p>Let us first compress the current directory and then create an e-mail message. We can send the e-mail message via an external SMTP host, or we can use a local e-mail server to do this. Like other recipes, let us get the sender and recipient information from parsing the command-line inputs.</p><p>Listing 5.3 shows how to convert an e-mail folder into a compressed ZIP file as follows:</p><div><pre class="programlisting">#!/usr/bin/env python
# Python Network Programming Cookbook -- Chapter - 5
# This program is optimized for Python 2.7.
# It may run on any other version with/without modifications.

import os
import argparse
import smtplib
import zipfile
import tempfile
from email import encoders
from email.mime.base import MIMEBase
from email.mime.multipart import MIMEMultipart    
def email_dir_zipped(sender, recipient):
    zf = tempfile.TemporaryFile(prefix='mail', suffix='.zip')
    zip = zipfile.ZipFile(zf, 'w')
    print "Zipping current dir: %s" %os.getcwd()
    for file_name in os.listdir(os.getcwd()):
        zip.write(file_name)
    zip.close()
    zf.seek(0)
    # Create the message
    print "Creating email message..."
    email_msg = MIMEMultipart()
    email_msg['Subject'] = 'File from path %s' %os.getcwd()
    email_msg['To'] = ', '.join(recipient)
    email_msg['From'] = sender
    email_msg.preamble = 'Testing email from Python.\n'
    msg = MIMEBase('application', 'zip')
    msg.set_payload(zf.read())
    encoders.encode_base64(msg)
    msg.add_header('Content-Disposition', 'attachment', 
                   filename=os.getcwd()[-1] + '.zip')
    email_msg.attach(msg)
    email_msg = email_msg.as_string()

    # send the message
    print "Sending email message..."
    smtp = None
    try:
        smtp = smtplib.SMTP('localhost')
        smtp.set_debuglevel(1)
        smtp.sendmail(sender, recipient, email_msg)
    except Exception, e:
        print "Error: %s" %str(e)
    finally:
        if smtp:
           smtp.close()

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Email Example')
    parser.add_argument('--sender', action="store", dest="sender", default='you@you.com')
    parser.add_argument('--recipient', action="store", dest="recipient")
    given_args = parser.parse_args()
    email_dir_zipped(given_args.sender, given_args.recipient)</pre></div><p>Running this recipe shows<a id="id318" class="indexterm"/> the following output.<a id="id319" class="indexterm"/> The extra output is shown because we enabled the e-mail debug level.</p><div><pre class="programlisting">
<strong>$ python 5_3_email_current_dir_zipped.py --recipient=faruq@localhost</strong>
<strong>Zipping current dir: /home/faruq/Dropbox/PacktPub/pynet-cookbook/pynetcookbook_code/chapter5</strong>
<strong>Creating email message...</strong>
<strong>Sending email message...</strong>
<strong>send: 'ehlo [127.0.0.1]\r\n'</strong>
<strong>reply: '250-debian6.debian2013.com\r\n'</strong>
<strong>reply: '250-PIPELINING\r\n'</strong>
<strong>reply: '250-SIZE 10240000\r\n'</strong>
<strong>reply: '250-VRFY\r\n'</strong>
<strong>reply: '250-ETRN\r\n'</strong>
<strong>reply: '250-STARTTLS\r\n'</strong>
<strong>reply: '250-ENHANCEDSTATUSCODES\r\n'</strong>
<strong>reply: '250-8BITMIME\r\n'</strong>
<strong>reply: '250 DSN\r\n'</strong>
<strong>reply: retcode (250); Msg: debian6.debian2013.com</strong>
<strong>PIPELINING</strong>
<strong>SIZE 10240000</strong>
<strong>VRFY</strong>
<strong>ETRN</strong>
<strong>STARTTLS</strong>
<strong>ENHANCEDSTATUSCODES</strong>
<strong>8BITMIME</strong>
<strong>DSN</strong>
<strong>send: 'mail FROM:&lt;you@you.com&gt; size=9141\r\n'</strong>
<strong>reply: '250 2.1.0 Ok\r\n'</strong>
<strong>reply: retcode (250); Msg: 2.1.0 Ok</strong>
<strong>send: 'rcpt TO:&lt;faruq@localhost&gt;\r\n'</strong>
<strong>reply: '250 2.1.5 Ok\r\n'</strong>
<strong>reply: retcode (250); Msg: 2.1.5 Ok</strong>
<strong>send: 'data\r\n'</strong>
<strong>reply: '354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;\r\n'</strong>
<strong>reply: retcode (354); Msg: End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;</strong>
<strong>data: (354, 'End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;')</strong>
<strong>send: 'Content-Type: multipart/mixed; boundary="===============0388489101==...[TRUNCATED]</strong>
<strong>reply: '250 2.0.0 Ok: queued as 42D2F34A996\r\n'</strong>
<strong>reply: retcode (250); Msg: 2.0.0 Ok: queued as 42D2F34A996</strong>
<strong>data: (250, '2.0.0 Ok: queued as 42D2F34A996')</strong>
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec110"/>How it works...</h2></div></div></div><p>We have used<a id="id320" class="indexterm"/> Python's <code class="literal">zipfile</code>, <code class="literal">smtplib</code> and<a id="id321" class="indexterm"/> an <code class="literal">email</code> module to achieve our objective of e-mailing a folder as a zipped archive. This is done using the <code class="literal">email_dir_zipped()</code> method<a id="id322" class="indexterm"/>. This method takes two arguments: the sender and recipient's e-mail addresses to create the e-mail message.</p><p>In order to create a ZIP archive, we create a temporary file with the <code class="literal">tempfile</code> module's <code class="literal">TemporaryFile()</code> class<a id="id323" class="indexterm"/>. We supply a filename prefix, <code class="literal">mail</code>, and suffix, <code class="literal">.zip</code>. Then, we initialize the ZIP archive object with the <code class="literal">ZipFile()</code> class<a id="id324" class="indexterm"/> by passing the temporary file as its argument. Later, we add files of the current directory with the ZIP object's <code class="literal">write()</code> method call.</p><p>To send an e-mail, we create a multipart MIME message with the <code class="literal">MIMEmultipart()</code> class<a id="id325" class="indexterm"/> from the <code class="literal">email.mime.multipart</code> module. Like our usual e-mail message, the subject, recipient, and sender information is added in the e-mail header.</p><p>We create the e-mail attachment with the <code class="literal">MIMEBase()</code> method<a id="id326" class="indexterm"/>. Here, we first specify the application/ZIP header and call <code class="literal">set_payload()</code> on this message object. Then, in order to encode the message correctly, the <code class="literal">encode_base64()</code> method<a id="id327" class="indexterm"/> from encoder's module is used. It is also helpful to use the <code class="literal">add_header()</code> method<a id="id328" class="indexterm"/> to construct the attachment header. Now, our attachment is<a id="id329" class="indexterm"/> ready to be included in the main e-mail message with an <code class="literal">attach()</code> method call.</p><p>Sending an e-mail requires you<a id="id330" class="indexterm"/> to call the <code class="literal">SMTP()</code> class instance of <code class="literal">smtplib</code>. There is a <code class="literal">sendmail()</code> method<a id="id331" class="indexterm"/> that will utilize the routine provided by the OS to actually send the e-mail message correctly. Its details are hidden under the hood. However, you can see a detailed interaction by enabling the debug option as shown in this recipe.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec111"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Further information about the Python libraries can be found at the URL <a class="ulink" href="http://docs.python.org/2/library/smtplib.html">http://docs.python.org/2/library/smtplib.html</a></li></ul></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch05lvl1sec56"/>Downloading your Google e-mail with POP3</h1></div></div></div><p>You would like<a id="id332" class="indexterm"/> to download <a id="id333" class="indexterm"/>your Google (or virtually any other e-mail provider's) e-mail via the POP3 protocol.</p><div><div><div><div><h2 class="title"><a id="ch05lvl2sec112"/>Getting ready</h2></div></div></div><p>To run this recipe, you should have an e-mail account with Google or any other service provider.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec113"/>How to do it...</h2></div></div></div><p>Here, we attempt to download the first e-mail message from a user's Google e-mail account. The username is supplied from a command line, but the password is kept secret and not passed from the command line.<a id="id334" class="indexterm"/> This is rather entered while <a id="id335" class="indexterm"/>the script is running and kept hidden from display.</p><p>Listing 5.4 shows how to download our Google e-mail via <code class="literal">POP3</code> as follows:</p><div><pre class="programlisting">#!/usr/bin/env python
# Python Network Programming Cookbook -- Chapter - 5
# This program is optimized for Python 2.7.
# It may run on any other version with/without modifications.

import argparse
import getpass
import poplib
GOOGLE_POP3_SERVER = 'pop.googlemail.com'

def download_email(username): 
    mailbox = poplib.POP3_SSL(GOOGLE_POP3_SERVER, '995') 
    mailbox.user(username)
    password = getpass.getpass(prompt="Enter you Google password: ") 
    mailbox.pass_(password) 
    num_messages = len(mailbox.list()[1])
    print "Total emails: %s" %num_messages
    print "Getting last message" 
    for msg in mailbox.retr(num_messages)[1]:
        print msg
    mailbox.quit()

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Email Download Example')
    parser.add_argument('--username', action="store", dest="username", default=getpass.getuser())
    given_args = parser.parse_args() 
    username = given_args.username
    download_email(username)</pre></div><p>If you run this script, you will see an output similar to the following one. The message is truncated for the sake of privacy.</p><div><pre class="programlisting">
<strong>$ python 5_4_download_google_email_via_pop3.py --username=&lt;USERNAME&gt;</strong>
<strong>Enter your Google password: </strong>
<strong>Total emails: 333</strong>
<strong>Getting last message</strong>
<strong>...[TRUNCATED]</strong>
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec114"/>How it works...</h2></div></div></div><p>This recipe downloads a user's first Google message via POP3. The <code class="literal">download_email()</code> method<a id="id336" class="indexterm"/> creates a <code class="literal">mailbox</code> object with Python, the <code class="literal">POP3_SSL()</code> class<a id="id337" class="indexterm"/> of <code class="literal">poplib</code>. We passed the Google POP3 server and port address to the class constructor. The <code class="literal">mailbox</code> object<a id="id338" class="indexterm"/> then sets up a<a id="id339" class="indexterm"/> user account with the <code class="literal">user()</code> method call.<a id="id340" class="indexterm"/> The password is collected from the user securely using the <code class="literal">getpass</code> module's <code class="literal">getpass()</code> method<a id="id341" class="indexterm"/> and then passed to the <code class="literal">mailbox</code> object. The mailbox's <code class="literal">list()</code> method gives us the e-mail messages as a Python list.</p><p>This script first displays the number of e-mail messages stored in the mailbox and retrieves the first message with the <code class="literal">retr()</code> method call. Finally, it's safe to call the <code class="literal">quit()</code> method on the mailbox to clean up the connection.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch05lvl1sec57"/>Checking your remote e-mail with IMAP</h1></div></div></div><p>Instead of using POP3, you<a id="id342" class="indexterm"/> can also use IMAP to retrieve the e-mail message <a id="id343" class="indexterm"/>from your Google account. In this case, the message won't be deleted after retrieval.</p><div><div><div><div><h2 class="title"><a id="ch05lvl2sec115"/>Getting ready</h2></div></div></div><p>To run this recipe, you should have an e-mail account with Google or any other service provider.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec116"/>How to do it...</h2></div></div></div><p>Let us connect to your Google e-mail account and read the first e-mail message. If you don't delete it, the first e-mail message would be the welcome message from Google.</p><p>Listing 5.5 shows us how to check Google e-mail with IMAP as follows:</p><div><pre class="programlisting">#!/usr/bin/env python
# Python Network Programming Cookbook -- Chapter – 5
# This program is optimized for Python 2.7.
# It may run on any other version with/without modifications.

import argparse
import getpass
import imaplib
GOOGLE_IMAP_SERVER = 'imap.googlemail.com'
def check_email(username): 
    mailbox = imaplib.IMAP4_SSL(GOOGLE_IMAP_SERVER, '993') 
    password = getpass.getpass(prompt="Enter you Google password: ") 
    mailbox.login(username, password)
    mailbox.select('Inbox')
    typ, data = mailbox.search(None, 'ALL')
    for num in data[0].split():
        typ, data = mailbox.fetch(num, '(RFC822)')

        print 'Message %s\n%s\n' % (num, data[0][1])
        break
    mailbox.close()
    mailbox.logout()
if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Email Download Example')
    parser.add_argument('--username', action="store", dest="username", default=getpass.getuser())
    given_args = parser.parse_args() 
    username = given_args.username
    check_email(username)</pre></div><p>If you run this script, this will <a id="id344" class="indexterm"/>show the following output. In order to<a id="id345" class="indexterm"/> remove the private part of the data, we truncated some user data.</p><div><pre class="programlisting">
<strong>$$ python 5_5_check_remote_email_via_imap.py --username=&lt;USER_NAME&gt;</strong>
<strong>Enter your Google password: </strong>
<strong>Message 1</strong>
<strong>Received: by 10.140.142.16; Sat, 17 Nov 2007 09:26:31 -0800 (PST)</strong>
<strong>Message-ID: &lt;...&gt;@mail.gmail.com&gt;</strong>
<strong>Date: Sat, 17 Nov 2007 09:26:31 -0800</strong>
<strong>From: "Gmail Team" &lt;mail-noreply@google.com&gt;</strong>
<strong>To: "&lt;User Full Name&gt;" &lt;USER_NAME&gt;@gmail.com&gt;</strong>
<strong>Subject: Gmail is different. Here's what you need to know.</strong>
<strong>MIME-Version: 1.0</strong>
<strong>Content-Type: multipart/alternative; </strong>
<strong>    boundary="----=_Part_7453_30339499.1195320391988"</strong>

<strong>------=_Part_7453_30339499.1195320391988</strong>
<strong>Content-Type: text/plain; charset=ISO-8859-1</strong>
<strong>Content-Transfer-Encoding: 7bit</strong>
<strong>Content-Disposition: inline</strong>

<strong>Messages that are easy to find, an inbox that organizes itself, great</strong>
<strong>spam-fighting tools and built-in chat. Sound cool? Welcome to Gmail.</strong>

<strong>To get started, you may want to:</strong>
<strong>[TRUNCATED]</strong>
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec117"/>How it works...</h2></div></div></div><p>The preceding script takes a Google username from the command line and calls the <code class="literal">check_email()</code> function<a id="id346" class="indexterm"/>. This function creates an IMAP mailbox with the <code class="literal">IMAP4_SSL()</code> class<a id="id347" class="indexterm"/> of <code class="literal">imaplib</code>, which is initialized with Google's IMAP server and default port.</p><p>Then, this function logs in to<a id="id348" class="indexterm"/> the mailbox with a password, which is <a id="id349" class="indexterm"/>captured by the <code class="literal">getpass()</code> method<a id="id350" class="indexterm"/> of the <code class="literal">getpass</code> module. The inbox folder is selected by calling the <code class="literal">select()</code> method on the <code class="literal">mailbox</code> object.</p><p>The <code class="literal">mailbox</code> object has many useful methods. Two of them are <code class="literal">search()</code> and <code class="literal">fetch()</code> that are used to get the first e-mail message. Finally, it's safer to call the <code class="literal">close()</code> and <code class="literal">logout()</code> method<a id="id351" class="indexterm"/> on the <code class="literal">mailbox</code> object to end the IMAP connection.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch05lvl1sec58"/>Sending an e-mail with an attachment via Gmail SMTP server</h1></div></div></div><p>You would like to send an<a id="id352" class="indexterm"/> e-mail message from<a id="id353" class="indexterm"/> your Google e-mail account to another account. You also need to attach a file with this message.</p><div><div><div><div><h2 class="title"><a id="ch05lvl2sec118"/>Getting ready</h2></div></div></div><p>To run this recipe, you should have an e-mail account with Google or any other service provider.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec119"/>How to do it...</h2></div></div></div><p>We can create an e-mail message and attach Python's <code class="literal">python-logo.gif</code> file with the e-mail message. Then, this message is sent from a Google account to a different account.</p><p>Listing 4.6 shows us how<a id="id354" class="indexterm"/> to send an e-mail <a id="id355" class="indexterm"/>from your Google account:</p><div><pre class="programlisting">#!/usr/bin/env python
# Python Network Programming Cookbook -- Chapter - 5
# This program is optimized for Python 2.7.
# It may run on any other version with/without modifications.

import argparse
import os
import getpass
import re
import sys
import smtplib
 
from email.mime.image import MIMEImage
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
 
SMTP_SERVER = 'smtp.gmail.com'
SMTP_PORT = 587
 
def send_email(sender, recipient):
    """ Send email message """
    msg = MIMEMultipart()
    msg['Subject'] = 'Python Email Test'
    msg['To'] = recipient
    msg['From'] = sender
    subject = 'Python email Test'
    message = 'Images attached.'
    # attach image files
    files = os.listdir(os.getcwd())
    gifsearch = re.compile(".gif", re.IGNORECASE)
    files = filter(gifsearch.search, files)
    for filename in files:
        path = os.path.join(os.getcwd(), filename)
        if not os.path.isfile(path):
            continue
        img = MIMEImage(open(path, 'rb').read(), _subtype="gif")

        img.add_header('Content-Disposition', 'attachment', filename=filename)
        msg.attach(img)
 
    part = MIMEText('text', "plain")
    part.set_payload(message)
    msg.attach(part)
    
    # create smtp session
    session = smtplib.SMTP(SMTP_SERVER, SMTP_PORT)
    session.ehlo()
    session.starttls()
    session.ehlo
    password = getpass.getpass(prompt="Enter you Google password: ") 
    session.login(sender, password)
    session.sendmail(sender, recipient, msg.as_string())
    print "Email sent."
    session.quit()
 
if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Email Sending Example')
    parser.add_argument('--sender', action="store", dest="sender")
    parser.add_argument('--recipient', action="store", dest="recipient")
    given_args = parser.parse_args()
    send_email(given_args.sender, given_args.recipient)</pre></div><p>Running the following script outputs the success of sending an e-mail to any e-mail address if you provide your Google account details correctly. After running this script, you can check your <a id="id356" class="indexterm"/>recipient e-mail account to <a id="id357" class="indexterm"/>verify that the e-mail is actually sent.</p><div><pre class="programlisting">
<strong>$ python 5_6_send_email_from_gmail.py --sender=&lt;USERNAME&gt;@gmail.com –recipient=&lt;USER&gt;@&lt;ANOTHER_COMPANY.com&gt;</strong>
<strong>Enter you Google password: </strong>
<strong>Email sent.</strong>
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec120"/>How it works...</h2></div></div></div><p>In this recipe, an e-mail message is created in the <code class="literal">send_email()</code> function<a id="id358" class="indexterm"/>. This function is supplied with a Google account from where the e-mail message will be sent. The message header object, <code class="literal">msg</code>, is created by calling the <code class="literal">MIMEMultipart()</code> class<a id="id359" class="indexterm"/> and then subject, recipient, and sender information is added on it.</p><p>Python's regular expression-handling module is used to filter the <code class="literal">.gif</code> image on the current path. The image attachment object, <code class="literal">img</code>, is then created with the <code class="literal">MIMEImage()</code> method<a id="id360" class="indexterm"/> from the <code class="literal">email.mime.image</code> module. A correct image header is added to this object and finally, the image is attached with the <code class="literal">msg</code> object created earlier. We can attach<a id="id361" class="indexterm"/> multiple image files within a <code class="literal">for</code> loop as shown in this recipe. We can also attach a plain text attachment in a similar way.</p><p>To send the e-mail message, we create an SMTP session. We call some testing method on this session object, such as <code class="literal">ehlo()</code> or <code class="literal">starttls()</code>. Then, log in to the Google SMTP server with a<a id="id362" class="indexterm"/> username and password and a <code class="literal">sendmail()</code> method is called to send the e-mail.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch05lvl1sec59"/>Writing a guestbook for your (Python-based) web server with CGI</h1></div></div></div><p><strong>Common Gateway Interface</strong> (<strong>CGI</strong>) is a standard in web programming by which custom scripts can be used to produce web server output. You would like <a id="id363" class="indexterm"/>to catch the HTML form input from a user's browser, <a id="id364" class="indexterm"/>redirect it to another page, and acknowledge a user action.</p><div><div><div><div><h2 class="title"><a id="ch05lvl2sec121"/>How to do it...</h2></div></div></div><p>We first need to run a web server that supports CGI scripts. We placed our Python CGI script inside a <code class="literal">cgi-bin/</code> subdirectory and then visited the HTML page that contains the feedback form. Upon submitting this form, our web server will send the form data to the CGI script, and we'll see the output produced by this script.</p><p>Listing 5.7 shows us how the Python web server supports CGI:</p><div><pre class="programlisting">#!/usr/bin/env python
# Python Network Programming Cookbook -- Chapter - 5
# This program is optimized for Python 2.7.
# It may run on any other version with/without modifications.

import os
import cgi
import argparse
import BaseHTTPServer
import CGIHTTPServer
import cgitb 
cgitb.enable()  ## enable CGI error reporting
def web_server(port):
    server = BaseHTTPServer.HTTPServer
    handler = CGIHTTPServer.CGIHTTPRequestHandler #RequestsHandler
    server_address = ("", port)
    handler.cgi_directories = ["/cgi-bin", ]
    httpd = server(server_address, handler)
    print "Starting web server with CGI support on port: %s ..." %port
    httpd.serve_forever()
if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='CGI Server Example')
    parser.add_argument('--port', action="store", dest="port", type=int, required=True)
    given_args = parser.parse_args()
    web_server(given_args.port)</pre></div><p>The following screenshot<a id="id365" class="indexterm"/> shows CGI enabled web server is serving<a id="id366" class="indexterm"/> contents:</p><div><img src="img/3463OS_05_01.jpg" alt="How to do it..."/></div><p>If you run this recipe,<a id="id367" class="indexterm"/> you will see the following <a id="id368" class="indexterm"/>output:</p><div><pre class="programlisting">
<strong>$ python 5_7_cgi_server.py --port=8800</strong>
<strong>Starting web server with CGI support on port: 8800 ...</strong>
<strong>localhost - - [19/May/2013 18:40:22] "GET / HTTP/1.1" 200 -</strong>
</pre></div><p>Now, you need to visit <code class="literal">http://localhost:8800/5_7_send_feedback.html</code> from your browser.</p><p>You will see an input form. We assume that you provide the following input to this form:</p><div><pre class="programlisting">
<strong>Name:  User1</strong>
<strong>Comment: Comment1</strong>
</pre></div><p>The following screenshot shows the entering user comment in a web form:</p><div><img src="img/3463OS_05_02.jpg" alt="How to do it..."/></div><p>Then, your browser <a id="id369" class="indexterm"/>will be redirected to <code class="literal">http://localhost:8800/cgi-bin/5_7_get_feedback.py</code> where<a id="id370" class="indexterm"/> you can see the following output:</p><div><pre class="programlisting">
<strong>User1 sends a comment: Comment1</strong>
</pre></div><p>The user comment is shown in the browser:</p><div><img src="img/3463OS_05_03.jpg" alt="How to do it..."/></div></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec122"/>How it works...</h2></div></div></div><p>We have used a basic HTTP server setup that can handle CGI requests. Python provides these interfaces in the <code class="literal">BaseHTTPServer</code> and <code class="literal">CGIHTTPserver</code> modules.</p><p>The handler is configured to use the <code class="literal">/cgi-bin</code> path to launch the CGI scripts. No other path can be used to run the CGI scripts.</p><p>The HTML <a id="id371" class="indexterm"/>feedback form located on <code class="literal">5_7_send_feedback.html</code> shows a very <a id="id372" class="indexterm"/>basic HTML form containing the following code:</p><div><pre class="programlisting">&lt;html&gt;
   &lt;body&gt;
         &lt;form action="/cgi-bin/5_7_get_feedback.py" method="post"&gt;
                Name: &lt;input type="text" name="Name"&gt;  &lt;br /&gt;
                Comment: &lt;input type="text" name="Comment" /&gt;
                &lt;input type="submit" value="Submit" /&gt;
         &lt;/form&gt;
   &lt;/body&gt;
&lt;/html&gt;</pre></div><p>Note that the form method is <code class="literal">POST</code> and action is set to the <code class="literal">/cgi-bin/5_7_get_feedback.py</code> file. The contents of this file are as follows:</p><div><pre class="programlisting">
<strong>#!/usr/bin/env python</strong>
<strong># Python Network Programming Cookbook -- Chapter - 5</strong>
<strong># This program requires Python 2.7 or any later version</strong>
<strong>import cgi</strong>
<strong>import cgitb </strong>
<strong># Create instance of FieldStorage </strong>
<strong>form = cgi.FieldStorage() </strong>
<strong># Get data from fields</strong>
<strong>name = form.getvalue('Name')</strong>
<strong>comment  = form.getvalue('Comment')</strong>
<strong>print "Content-type:text/html\r\n\r\n"</strong>
<strong>print "&lt;html&gt;"</strong>
<strong>print "&lt;head&gt;"</strong>
<strong>print "&lt;title&gt;CGI Program Example &lt;/title&gt;"</strong>
<strong>print "&lt;/head&gt;"</strong>
<strong>print "&lt;body&gt;"</strong>
<strong>print "&lt;h2&gt; %s sends a comment: %s&lt;/h2&gt;" % (name, comment)</strong>
<strong>print "&lt;/body&gt;"</strong>
<strong>print "&lt;/html&gt;"</strong>
</pre></div><p>In this CGI script, the <code class="literal">FieldStorage()</code> method<a id="id373" class="indexterm"/> is called from <code class="literal">cgilib</code>. This returns a form object to process the HTML form inputs.<a id="id374" class="indexterm"/> Two inputs are parsed here (<code class="literal">name</code> and <code class="literal">comment</code>) using the <code class="literal">getvalue()</code> method<a id="id375" class="indexterm"/>. Finally, the script acknowledges <a id="id376" class="indexterm"/>the user input by echoing a line back saying that the user <em>x</em> has sent a comment.</p></div></div></div>
</body></html>