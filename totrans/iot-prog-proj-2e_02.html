<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer051">
<h1 class="chapter-number" id="_idParaDest-31"><a id="_idTextAnchor031"/>2</h1>
<h1 id="_idParaDest-32"><a id="_idTextAnchor032"/>Harnessing Web Services with the Raspberry Pi</h1>
<p>In this chapter, we will begin to write code for web services to turn our Raspberry Pi into an <strong class="bold">Internet of Things</strong> (<strong class="bold">IoT</strong>) device. Using Python, we will design programs that pull data from <a id="_idIndexMarker098"/>online resources and use the data to create visuals on Sense HAT’s dot-matrix display. The practical examples we will cover in this chapter will serve as a building block for more advanced IoT web <span class="No-Break">services development.</span></p>
<p>We begin by exploring the world of web services – understanding their role and how we can exploit them to our advantage. We may think of web services as the lifeblood of the internet, circulating vital data across the digital world. Understanding web services isn’t just about adding another tool to our toolkit; it’s about unlocking a world filled with <span class="No-Break">limitless potential.</span></p>
<p>As we advance, we’ll transform theoretical knowledge into practical application through a series of programming projects. These projects are specifically designed to utilize the advanced web services offered by providers such as Alpha Vantage and OpenWeather. Using the versatile Raspberry Pi Sense HAT, or its emulator, we’ll construct applications including a scrolling stock ticker, a weather information display, and even a GO-NO-GO decision-maker for youth baseball games. These projects don’t just teach us how to use technology; they immerse us in the fundamental principles <span class="No-Break">of IoT.</span></p>
<p>Consider the vast array of opportunities that lie ahead with web services and the Raspberry Pi. Today, we’re starting with a simple stock ticker. Tomorrow, we might be developing a device that notifies us whenever our favorite team scores or even assists us in navigating through traffic. This chapter is our first step toward exploring a broader and more thrilling universe of <span class="No-Break">IoT innovation.</span></p>
<p>In this chapter, we will cover the <span class="No-Break">following topics:</span></p>
<ul>
<li>Exploring <span class="No-Break">web services</span></li>
<li>Creating a scrolling stock <span class="No-Break">ticker application</span></li>
<li>Developing weather <span class="No-Break">display applications</span></li>
</ul>
<p><span class="No-Break">Let’s begin!</span></p>
<h1 id="_idParaDest-33"><a id="_idTextAnchor033"/>Technical requirements</h1>
<p>The following is required to complete <span class="No-Break">this chapter:</span></p>
<ul>
<li>A Raspberry Pi 5 with either 4 GB or 8 GB of RAM (preferred); however, a late-model Raspberry Pi such as the Raspberry Pi 4 may <span class="No-Break">be used.</span></li>
<li>Raspberry Pi Sense HAT (Raspberry OS emulator may be <span class="No-Break">used instead).</span></li>
<li>Keyboard, mouse, <span class="No-Break">and monitor.</span></li>
<li>Access to a 3D printer or 3D printing service for the <span class="No-Break">custom stand.</span></li>
<li>The GitHub repository for the chapter, located <span class="No-Break">at </span><a href="https://github.com/PacktPublishing/-Internet-of-Things-Programming-Projects-2nd-Edition/tree/main/Chapter2"><span class="No-Break">https://github.com/PacktPublishing/-Internet-of-Things-Programming-Projects-2nd-Edition/tree/main/Chapter2</span></a><span class="No-Break">.</span></li>
<li>A general knowledge of programming. We will be using the Python programming language in <span class="No-Break">this book.</span></li>
</ul>
<h1 id="_idParaDest-34"><a id="_idTextAnchor034"/>Exploring web services</h1>
<p>Imagine remotely controlling our home’s devices from our smartphone – this amazing convenience is <a id="_idIndexMarker099"/>powered by web services, invisible messengers seamlessly connecting our <span class="No-Break">digital world.</span></p>
<p>Web services form an integral part of today’s internet infrastructure. They allow for the seamless exchange of data between different software applications over the internet. As a result, they are an essential tool for IoT applications, including our Raspberry Pi IoT projects. With <a id="_idIndexMarker100"/>web services, we can draw on the wealth of data available online and bring it into the physical world using our <span class="No-Break">Raspberry Pi.</span></p>
<p>At their core, web services are software interfaces that enable one software system to interact with another over a network. This interaction is typically done via specific protocols, such as <strong class="bold">Representational State Transfer</strong> (<strong class="bold">REST</strong>) or <strong class="bold">Simple Object Access Protocol</strong> (<strong class="bold">SOAP</strong>). To get a sense of the power of web services, consider the example <a id="_idIndexMarker101"/>shown in <span class="No-Break"><em class="italic">Figure 2</em></span><em class="italic">.1</em> of a service that provides critical sensory data on a patient in a <span class="No-Break">hospital room:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer031">
<img alt="Figure 2.1 – Client application receiving data from the FHIR web service" height="307" src="image/B21282_02_1.jpg" width="1222"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.1 – Client application receiving data from the FHIR web service</p>
<p>Here, we see a <a id="_idIndexMarker102"/>diagram representing the <strong class="bold">Fast Healthcare Interoperability Resources</strong> web service. <strong class="bold">FHIR</strong> (pronounced “fire”) is a standard <a id="_idIndexMarker103"/>developed by <strong class="bold">Health Level Seven International</strong> (<strong class="bold">HL7</strong>) for the electronic exchange of healthcare information. Web <a id="_idIndexMarker104"/>services such as FHIR offer universal accessibility, enabling healthcare professionals to access and share patient data from anywhere at any time. They provide superior interoperability, making them more <a id="_idIndexMarker105"/>efficient and practical than local network <strong class="bold">Application Programming Interface</strong> (<strong class="bold">API</strong>) calls, especially in the healthcare sector where data needs to be shared across different systems <span class="No-Break">and devices.</span></p>
<p>In this section, we will look at the protocols used by web services. We will also explore some of the more popular web services available before we write code to call a simple web service using our <span class="No-Break">Raspberry Pi.</span></p>
<h2 id="_idParaDest-35"><a id="_idTextAnchor035"/>Understanding approaches for web services</h2>
<p>In the field of <a id="_idIndexMarker106"/>web services, two prominent approaches are the REST and SOAP protocols. RESTful web services use HTTP methods explicitly and are more straightforward and efficient, making them a popular choice for many developers. SOAP, on the other hand, is a protocol that permits programs running on siloed systems to communicate by using HTTP and its XML-based messaging system. SOAP is highly extensible and has strong support for security and reliability, making it suitable for <span class="No-Break">complex applications.</span></p>
<p>In our upcoming projects, we will primarily utilize REST for interacting with web services. However, understanding <a id="_idIndexMarker107"/>SOAP provides a broader view of the landscape of web service interactions. We will start by exploring SOAP, its functionality, and its applicable scenarios before diving into REST-based or RESTful <span class="No-Break">web services.</span></p>
<h3>Using SOAP web services</h3>
<p>To understand SOAP, we turn our attention to the custom ordering system illustrated in <span class="No-Break"><em class="italic">Figure 2</em></span><em class="italic">.2</em>. As this <a id="_idIndexMarker108"/>system was built in-house for a particular company’s business operations, it is a complex, enterprise-level application <a id="_idIndexMarker109"/>with significant requirements in terms of security and reliability. This ordering system represents an ideal use case for SOAP-based <span class="No-Break">web services:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer032">
<img alt="Figure 2.2 – Custom ordering application connecting to the server using SOAP" height="385" src="image/B21282_02_2.jpg" width="1194"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.2 – Custom ordering application connecting to the server using SOAP</p>
<p>With SOAP’s stateful nature, the application can manage complex transaction management that involves multiple steps, from inventory checks and payment processing to order confirmation. The SOAP protocol, with its built-in security features and error handling, enables the application to manage orders efficiently <span class="No-Break">and securely.</span></p>
<p>As we can see in <span class="No-Break"><em class="italic">Figure 2</em></span><em class="italic">.2</em>, an XML file is passed through HTTPS in a SOAP transaction. This XML file, nestled within the SOAP message, plays a crucial role in communication. It carries detailed instructions that guide the server’s actions. The structured format of XML enables complex data exchanges, allowing the custom ordering system to seamlessly interact with various other systems despite their possible diverse <span class="No-Break">data formats.</span></p>
<p>If SOAP is the <a id="_idIndexMarker110"/>desired approach for enterprise-level applications, REST is preferred for public web services. REST’s simplicity, lightweight nature, scalability, and <a id="_idIndexMarker111"/>resource-oriented approach make it ideal for creating user-friendly and scalable web services that interact with resources through standard <span class="No-Break">HTTP protocols.</span></p>
<h3>Investigating RESTful web services</h3>
<p>RESTful web services are a key aspect of modern web applications, allowing for efficient communication between clients and servers using the REST architecture. RESTful web services <a id="_idIndexMarker112"/>employ HTTP methods such as <strong class="source-inline">GET</strong>, <strong class="source-inline">POST</strong>, <strong class="source-inline">PUT</strong>, and <strong class="source-inline">DELETE</strong> to interact with resources and are stateless. Unlike SOAP, which <a id="_idIndexMarker113"/>typically uses XML, RESTful services can support multiple data formats, including JSON and XML. This flexibility often leads to RESTful services being perceived as simpler to use and more adaptable <span class="No-Break">than SOAP.</span></p>
<p>Several widely recognized public RESTful web services have gained popularity due to their functionality and ease of use. Among them is the <strong class="source-inline">Twitter</strong> API, which allows developers to access and interact with core Twitter data, including timelines, status updates, and other information. Another notable example is the Google Maps API, which provides developers with the ability to embed Google Maps on web pages <span class="No-Break">using JavaScript.</span></p>
<p>In <span class="No-Break"><em class="italic">Figure 2</em></span><em class="italic">.3</em>, we see a simplified diagram of a RESTful web service communicating with a web page using the <strong class="source-inline">GET</strong>, <strong class="source-inline">POST</strong>, <strong class="source-inline">PUT</strong>, and <strong class="source-inline">DELETE</strong> HTTP methods. Each of these HTTP methods corresponds to a specific type of interaction with <span class="No-Break">the server:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer033">
<img alt="Figure 2.3 – Simplified diagram of a RESTful web service" height="460" src="image/B21282_02_3.jpg" width="1097"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.3 – Simplified diagram of a RESTful web service</p>
<p>The <strong class="source-inline">GET</strong> method retrieves existing data, <strong class="source-inline">POST</strong> is typically used to send new data for the creation of a resource, <strong class="source-inline">PUT</strong> is used to update existing resources, and <strong class="source-inline">DELETE</strong> <span class="No-Break">removes data.</span></p>
<p class="callout-heading">Difference between an API and a web service</p>
<p class="callout">We may find ourselves using the terms <em class="italic">API</em> and <em class="italic">web service</em> interchangeably; however, there is a difference. An <strong class="bold">API</strong> is a <a id="_idIndexMarker114"/>broad term defining rules and conventions for building and interacting with software applications. APIs can operate over various channels and not just the web. A <strong class="bold">web service</strong>, however, is <a id="_idIndexMarker115"/>a specific type of API <a id="_idIndexMarker116"/>that operates over the internet, typically using protocols such as HTTP. In essence, all web services are APIs, but not all APIs are <span class="No-Break">web services.</span></p>
<p>Considering <a id="_idIndexMarker117"/>the Twitter API as an example <a id="_idIndexMarker118"/>of a web service that we could develop a client for, the application of these HTTP methods would be <span class="No-Break">as follows:</span></p>
<ul>
<li><strong class="source-inline">GET</strong>: We would <a id="_idIndexMarker119"/>use this method to retrieve data from <a id="_idIndexMarker120"/>Twitter. For example, we would use a <strong class="source-inline">GET</strong> request to fetch a specific user’s tweets or search for tweets that contain a <span class="No-Break">specific hashtag.</span></li>
<li><strong class="source-inline">POST</strong>: We would <a id="_idIndexMarker121"/>use this method when we want to <a id="_idIndexMarker122"/>create new data on Twitter, such as a <span class="No-Break">new tweet.</span></li>
<li><strong class="source-inline">PUT</strong>: We wouldn’t <a id="_idIndexMarker123"/>use this method as the Twitter API <a id="_idIndexMarker124"/>doesn’t natively support the <strong class="source-inline">PUT</strong> <span class="No-Break">HTTP method.</span></li>
<li><strong class="source-inline">DELETE</strong>: We would <a id="_idIndexMarker125"/>use the <strong class="source-inline">DELETE</strong> method to <a id="_idIndexMarker126"/>remove existing data on Twitter. However, this method is not widely used in the Twitter API as deletion capabilities are limited due to <span class="No-Break">Twitter’s policies.</span></li>
</ul>
<p>We can see REST methods outlined in the <span class="No-Break">following table:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer034">
<img alt="Figure 2.4 – REST methods summarized" height="844" src="image/B21282_02_4.jpg" width="1650"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.4 – REST methods summarized</p>
<p>To summarize, REST is <a id="_idIndexMarker127"/>a straightforward approach <a id="_idIndexMarker128"/>that leverages standard HTTP or HTTPS methods such as <strong class="source-inline">PUT</strong>, <strong class="source-inline">POST</strong>, <strong class="source-inline">GET</strong>, and <strong class="source-inline">DELETE</strong> while also offering <a id="_idIndexMarker129"/>flexibility in data formats such as <strong class="bold">JavaScript Object Notation</strong> (<strong class="bold">JSON</strong>) or XML, whereas SOAP is a protocol that typically uses XML to transmit structured messages and can operate over various <strong class="bold">Internet Protocol</strong> (<strong class="bold">IP</strong>) suite <a id="_idIndexMarker130"/>networks such as HTTP <span class="No-Break">or HTTPS.</span></p>
<p>Now that we have a basic understanding of web services and the way we can implement them, let’s create a real-world example using our Raspberry Pi and <span class="No-Break">Sense HAT.</span></p>
<h2 id="_idParaDest-36"><a id="_idTextAnchor036"/>Connecting to a web service with our Raspberry Pi and Sense HAT</h2>
<p>In this section, we will connect our Raspberry Pi to a web service and display the result on the <a id="_idIndexMarker131"/>dot-matrix screen of our Sense HAT (or emulator). The <a id="_idIndexMarker132"/>service we will <a id="_idIndexMarker133"/>connect to will be a dummy web <a id="_idIndexMarker134"/>service, designed to evaluate RESTful web <span class="No-Break">service calls.</span></p>
<p>In <span class="No-Break"><em class="italic">Figure 2</em></span><em class="italic">.5</em>, we see an example of a Raspberry Pi pulling weather information from a web service and using the dot-matrix display of the Sense HAT to display <span class="No-Break">a cloud:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer035">
<img alt="Figure 2.5 – Sense HAT displaying a cloud indicating current weather conditions" height="557" src="image/B21282_02_5.jpg" width="720"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.5 – Sense HAT displaying a cloud indicating current weather conditions</p>
<p>The cloud <a id="_idIndexMarker135"/>represents current weather <a id="_idIndexMarker136"/>conditions (not to be confused <a id="_idIndexMarker137"/>with the cloud representing the web service). Such an application could show an animation on the dot-matrix screen. We <a id="_idIndexMarker138"/>could even swap the weather web service for another web service and create an entirely new application, leveraging the existing <span class="No-Break">code easily.</span></p>
<p>Before creating a web service client, we need to set up our development environment and install the necessary packages for our code to work. We will incorporate a Python virtual environment to <span class="No-Break">do so.</span></p>
<h3>Setting up our development environment</h3>
<p>We will <a id="_idIndexMarker139"/>use a Python virtual environment for our development. As there are libraries that only work with the root installation of Python, we will use system packages in our Python virtual environment. To do so, we do <span class="No-Break">the following:</span></p>
<ol>
<li>On our Raspberry Pi 5, we open a <span class="No-Break">Terminal application.</span></li>
<li>To store our project files, we create a new directory with the <span class="No-Break">following command:</span><pre class="source-code">
<strong class="bold">mkdir Chapter2</strong></pre></li> <li>We then navigate to the new directory with the <span class="No-Break">following command:</span><pre class="source-code">
<strong class="bold">cd Chapter2</strong></pre></li> <li>We create a new Python virtual environment for our project with the <span class="No-Break">following command:</span><pre class="source-code">
<strong class="bold">python -m venv ch2-env --system-site-packages</strong></pre></li> <li>With this <a id="_idIndexMarker140"/>command, we create a new Python virtual environment called <strong class="source-inline">ch2-env</strong> and enable access to the system site packages. This allows the virtual environment to inherit packages from the global Python environment, which can be useful when certain libraries are installed system wide. Once the environment is set up, we can activate it and begin installing project-specific packages without affecting the global <span class="No-Break">Python environment.</span></li>
<li>With our new Python virtual environment created, we source into it (set the Python virtual environment) with the <span class="No-Break">following command:</span><pre class="source-code">
<strong class="bold">source ch2-env/bin/activate</strong></pre></li> <li>Our Terminal application should now show that we are using the <strong class="source-inline">ch2-env</strong> Python <span class="No-Break">virtual environment:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer036">
<img alt="Figure 2.6 – Terminal using ch2-env environment" height="127" src="image/B21282_02_6.jpg" width="919"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.6 – Terminal using ch2-env environment</p>
<ol>
<li value="8">We install the extra packages required for our code with the <span class="No-Break">following command:</span><pre class="source-code">
<strong class="bold">pip install requests sense-emu</strong></pre></li> <li>The <strong class="source-inline">requests</strong> library in Python simplifies making HTTP requests to web servers, and the <strong class="source-inline">sense-emu</strong> library will give us the Sense HAT emulator to work with for our code. With the libraries installed, we may close the Terminal with the <span class="No-Break">following command:</span><pre class="source-code">
<strong class="bold">exit</strong></pre></li> <li>We are <a id="_idIndexMarker141"/>now ready to load up Thonny. We do so by clicking on the <strong class="bold">Menu</strong> icon in the Raspberry Pi taskbar, navigating to the <strong class="bold">Programming</strong> category, and <span class="No-Break">selecting </span><span class="No-Break"><strong class="bold">Thonny</strong></span><span class="No-Break">.</span></li>
<li>By default, Thonny uses the Raspberry Pi’s built-in version of Python. For our project, we will use the Python virtual environment we just created. To start, we need to view the project files by clicking on <strong class="bold">View</strong> and selecting <strong class="bold">Files</strong> if it is not <span class="No-Break">already selected.</span></li>
<li>In the <strong class="source-inline">Files</strong> section, we locate the <span class="No-Break"><strong class="source-inline">ch2-env</strong></span><span class="No-Break"> directory.</span></li>
<li>We then right-click on the folder and select the <strong class="bold">Activate virtual </strong><span class="No-Break"><strong class="bold">environment</strong></span><span class="No-Break"> option:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer037">
<img alt="Figure 2.7 – Activating a Python virtual environment in Thonny" height="546" src="image/B21282_02_7.jpg" width="381"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.7 – Activating a Python virtual environment in Thonny</p>
<p>With our <a id="_idIndexMarker142"/>project folder created, our Python virtual environment set up and activated, and the <strong class="source-inline">requests</strong> package installed, we may now start <span class="No-Break">writing code.</span></p>
<h3>Writing our first web service code</h3>
<p>We are now ready to write our first web service code. This code will make a call to a dummy <a id="_idIndexMarker143"/>web service used for testing. Upon successful transmission, a success message will scroll across the dot-matrix screen of our <span class="No-Break">Sense HAT:</span></p>
<ol>
<li>To create our web service application, inside Thonny we create a new tab. Inside the tab, we write the <span class="No-Break">following code:</span><pre class="source-code">
import requests
from sense_hat import SenseHat
response = requests.get(
    'https://jsonplaceholder.typicode.com/posts'
    )
sense = SenseHat()
sense.set_rotation(270)
if response.status_code == 200:
    data = response.json()
    print(data[0]['title'])
    success_msg = 'Success with code: '
    success_msg += str(response.status_code)
    sense.show_message(success_msg)
else:
    error_msg = 'Failed with code: '
    error_msg += str(response.status_code)
    print(error_msg)
    sense.show_message(error_msg)</pre></li> <li>Before we <a id="_idIndexMarker144"/>run our code, let’s break <span class="No-Break">it down:</span><ol><li class="upper-roman">We start by importing the <strong class="source-inline">requests</strong> library, a popular library in Python for making <span class="No-Break">HTTP requests.</span></li><li class="upper-roman">We then import the <strong class="source-inline">SenseHat</strong> class from the <strong class="source-inline">sense_hat</strong> library, allowing us to interact with the Sense HAT board. For those of us using the Sense HAT emulator, we would use the <strong class="source-inline">sense_emu</strong> <span class="No-Break">library instead.</span></li><li class="upper-roman">We send a <strong class="source-inline">GET</strong> request to the specified URL (<strong class="source-inline">'https://jsonplaceholder.typicode.com/posts'</strong>), which is an endpoint of a dummy API that provides placeholder data in the JSON format. The response from the server is stored in the <span class="No-Break"><strong class="source-inline">response</strong></span><span class="No-Break"> variable.</span></li><li class="upper-roman">We create an instance of the <strong class="source-inline">SenseHat</strong> class. We use this object to control the Sense HAT’s <span class="No-Break">dot-matrix display.</span></li><li class="upper-roman">The <strong class="source-inline">sense.set_rotation(270)</strong> line adjusts the orientation of the Sense HAT’s LED matrix so that it matches the orientation of the Raspberry Pi in our custom case (refer to <a href="B21282_01.xhtml#_idTextAnchor014"><span class="No-Break"><em class="italic">Chapter 1</em></span></a> for information on the custom Raspberry <span class="No-Break">Pi case).</span></li></ol><p class="list-inset">Our code <a id="_idIndexMarker145"/>then checks the HTTP response’s <span class="No-Break">status code:</span></p><ul><li>If the status code is <strong class="source-inline">200</strong>, which indicates a successful HTTP request, the following <span class="No-Break">then occurs:</span><ul><li><strong class="source-inline">data = response.json()</strong>: Our code converts the JSON response body into a Python <span class="No-Break">data structure.</span></li><li><strong class="source-inline">print(data[0]['title'])</strong>: Our code prints the title of the first post from the response data to the shell <span class="No-Break">in Thonny.</span></li><li>Our code displays a success message on the Sense HAT’s LED matrix, indicating the successful <span class="No-Break">status code.</span></li></ul></li><li>If the status code is not <strong class="source-inline">200</strong>, which indicates an unsuccessful HTTP request, the <span class="No-Break">following happens:</span><ul><li>Our code prints an error message to the Shell, indicating the unsuccessful <span class="No-Break">status code.</span></li><li>Our code displays a failure message on the Sense HAT’s LED matrix, indicating the unsuccessful <span class="No-Break">status code.</span></li></ul></li></ul></li>
<li>We save the code as <strong class="source-inline">webservice-test.py</strong> and then run it by clicking on the green run button at the top, hitting <em class="italic">F5</em> on the keyboard, or clicking on the <strong class="bold">Run</strong> menu option at the top and then <strong class="bold">Run </strong><span class="No-Break"><strong class="bold">current script</strong></span><span class="No-Break">.</span></li>
<li>Upon a successful web service call (which is to be expected with this dummy service), we should see a title print to the Shell looking like <span class="No-Break">the following:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer038">
<img alt="Figure 2.8 – Testing a web service call using Thonny" height="695" src="image/B21282_02_8.jpg" width="880"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.8 – Testing a web service call using Thonny</p>
<ol>
<li value="5">We shouldn’t <a id="_idIndexMarker146"/>be too concerned about the contents of the title as it is just dummy data. Subsequently, upon successful completion of the web service call, we should observe a scrolling message on the Sense HAT display (or the emulator). This message signifies the successful status of our call, which should be denoted by the <strong class="source-inline">200</strong> HTTP <span class="No-Break">status code.</span></li>
</ol>
<p>Although our code lacks error checking, we have successfully constructed our first IoT device powered by the Raspberry Pi. It’s important to note that considerations such as internet connectivity are not incorporated into our <span class="No-Break">simple code.</span></p>
<p>In the remaining sections of this chapter, we will elevate our IoT device from being a simple web service testing tool to something more engaging. We will take on two exciting projects: the construction of a stock ticker application and a weather-dependent GO-NO-GO <span class="No-Break">decision-making application.</span></p>
<h1 id="_idParaDest-37"><a id="_idTextAnchor037"/>Creating a scrolling stock ticker application</h1>
<p>It’s now time to build our first practical IoT device. For this project, we will create a stock ticker application with our Raspberry Pi and Sense HAT. A stock ticker is a device, physical <a id="_idIndexMarker147"/>or digital, that presents stock prices in real time. Our application will fetch real-time stock prices from Alpha Vantage, an online service providing free APIs for data on stocks. In our application, we will be retrieving the current stock price for Apple, listed on the Nasdaq stock exchange <span class="No-Break">as </span><span class="No-Break"><em class="italic">AAPL</em></span><span class="No-Break">.</span></p>
<p>We can see our stock ticker application illustrated in <span class="No-Break"><em class="italic">Figure 2</em></span><em class="italic">.9</em>. We will use the HTTP<strong class="source-inline"> GET</strong> method to retrieve information with the response in JSON format, a lightweight data-interchange format that is easy for humans to read and write and easy for machines to parse <span class="No-Break">and generate:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer039">
<img alt="Figure 2.9 – Diagram of our stock ticker application; the double arrows symbolize the call and subsequent response from the Alpha Vantage web service" height="346" src="image/B21282_02_9.jpg" width="1118"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.9 – Diagram of our stock ticker application; the double arrows symbolize the call and subsequent response from the Alpha Vantage web service</p>
<p>In our case, when <a id="_idIndexMarker148"/>we request data for the <strong class="source-inline">AAPL</strong> stock symbol, the <strong class="bold">Alpha Vantage API</strong> sends back a JSON object response, as illustrated in <span class="No-Break"><em class="italic">Figure 2</em></span><span class="No-Break"><em class="italic">.10</em></span><span class="No-Break">:</span></p>
<p class="IMG---Figure"> </p>
<div>
<div class="IMG---Figure" id="_idContainer040">
<img alt="Figure 2.10 – JSON object response from Alpha Vantage web service call" height="628" src="image/B21282_02_10.jpg" width="970"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.10 – JSON object response from Alpha Vantage web service call</p>
<p>The response <a id="_idIndexMarker149"/>encompasses 10 parameters for every successful API request. Out of these parameters, our stock ticker application will focus on <strong class="source-inline">symbol</strong>, <strong class="source-inline">volume</strong>, <strong class="source-inline">price</strong>, and <strong class="source-inline">change</strong>. These specific data points will be used to create a message that we will scroll across the dot-matrix screen of the <span class="No-Break">Sense HAT.</span></p>
<p>However, before we can write our web service code, we must first acquire an API key from Alpha Vantage. This key grants us permission to make the necessary web <span class="No-Break">service calls.</span></p>
<h2 id="_idParaDest-38"><a id="_idTextAnchor038"/>Getting an API key</h2>
<p>Securing an API key from Alpha Vantage is a straightforward process that can be accomplished <a id="_idIndexMarker150"/>in just a few steps. We start by navigating to <a id="_idIndexMarker151"/>the Alpha Vantage website <span class="No-Break">at </span><a href="https://www.alphavantage.co"><span class="No-Break">https://www.alphavantage.co</span></a><span class="No-Break">.</span></p>
<p>From there, we click on the <strong class="bold">GET FREE API KEY</strong> button – this should be easy to locate on the home page. Clicking this button will lead us to a sign-up form. We fill out the required details on this form, making sure to provide a valid email address. We should be given an API key once the form has been filled out, and we click on the <strong class="bold">GET FREE API </strong><span class="No-Break"><strong class="bold">KEY</strong></span><span class="No-Break"> button.</span></p>
<p class="callout-heading">Important note</p>
<p class="callout">The preceding instructions are valid as of the time of this writing. Please follow any changes to the process to get the <span class="No-Break">API key.</span></p>
<p>Once the API key has been issued, we must copy and paste it into a text editor as we require this <a id="_idIndexMarker152"/>key every time we make a call to the Alpha Vantage web service. As a free user, we are limited to 5 API requests per minute and a total of 500 API requests <span class="No-Break">per day.</span></p>
<p>Armed with our API key, we can now start to write code for <span class="No-Break">our application.</span></p>
<h2 id="_idParaDest-39"><a id="_idTextAnchor039"/>Writing web services client code</h2>
<p>In this section, we will start developing web service code to fetch current stock information <a id="_idIndexMarker153"/>for the company Apple (AAPL). Our objective is to retrieve the JSON object response from the Alpha Vantage web service, which will contain the relevant stock data we need for our scrolling stock <span class="No-Break">ticker application.</span></p>
<p>To create our web service code, we do <span class="No-Break">the following:</span></p>
<ol>
<li>We launch Thonny on our Raspberry Pi and activate the <strong class="source-inline">ch2-env</strong> Python virtual environment using the steps in the <span class="No-Break">previous section.</span></li>
<li>We then open a new tab in Thonny and enter the <span class="No-Break">following code:</span><pre class="source-code">
import requests
import json
api_key = 'xxxxxxxxxxxxxxxx'
symbol = 'AAPL'
base_url = 'https://www.alphavantage.co/query?'
function = 'GLOBAL_QUOTE'
complete_url = f'{base_url}function={function}&amp;symbol={symbol}&amp;apikey={api_key}'
response = requests.get(complete_url)
data = response.json()
print(json.dumps(data, indent=4))</pre></li> <li>Before <a id="_idIndexMarker154"/>we run our code, let’s break <span class="No-Break">it down:</span><ol><li class="upper-roman">We start by importing the <strong class="source-inline">requests</strong> module, which is a widely used Python library for making HTTP requests. It provides convenient methods to send HTTP requests such as <strong class="source-inline">GET</strong>, <strong class="source-inline">POST</strong>, and so on and handles underlying <span class="No-Break">network communication.</span></li><li class="upper-roman">We then import the built-in <strong class="source-inline">json</strong> module in Python. The <strong class="source-inline">json</strong> module provides methods to work with JSON data. It allows encoding Python objects into JSON strings (<strong class="source-inline">json.dumps()</strong>) and decoding JSON strings into Python <span class="No-Break">objects (</span><span class="No-Break"><strong class="source-inline">json.loads()</strong></span><span class="No-Break">).</span></li><li class="upper-roman">We store our personal API key from Alpha Vantage in a variable <span class="No-Break">called </span><span class="No-Break"><strong class="source-inline">api_key</strong></span><span class="No-Break">.</span></li><li class="upper-roman">We set the <strong class="source-inline">symbol</strong> variable to <strong class="source-inline">'AAPL'</strong>, representing the stock symbol <span class="No-Break">for Apple.</span></li><li class="upper-roman">The <strong class="source-inline">base_url</strong> variable stores the base URL for the Alpha <span class="No-Break">Vantage API.</span></li><li class="upper-roman">We set the <strong class="source-inline">function</strong> variable to <strong class="source-inline">'GLOBAL_QUOTE'</strong>, indicating the specific function to retrieve global <span class="No-Break">stock quotes.</span></li><li class="upper-roman">We construct the <strong class="source-inline">complete_url</strong> variable by combining the base URL, function, symbol, and API key to form a complete URL for the <span class="No-Break">API request.</span></li><li class="upper-roman">Our code then sends a <strong class="source-inline">GET</strong> request to the Alpha Vantage API using <strong class="source-inline">requests.get()</strong> and stores the response in the <span class="No-Break"><strong class="source-inline">response</strong></span><span class="No-Break"> variable.</span></li><li class="upper-roman">We extract the JSON response from the <strong class="source-inline">response</strong> object using <strong class="source-inline">.json()</strong>, and the resulting data is stored in the <span class="No-Break"><strong class="source-inline">data</strong></span><span class="No-Break"> variable.</span></li><li class="upper-roman">Finally, the code prints <strong class="source-inline">data</strong> in a formatted JSON representation using <strong class="source-inline">json.dumps()</strong> with the <strong class="source-inline">indent</strong> parameter set <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">4</strong></span><span class="No-Break">.</span></li></ol></li>
<li>We save <a id="_idIndexMarker155"/>the code as <strong class="source-inline">alphavantage-test.py</strong> and then run it by clicking on the green run button, hitting <em class="italic">F5</em> on the keyboard, or clicking on the <strong class="bold">Run</strong> menu option at the top and then <strong class="bold">Run </strong><span class="No-Break"><strong class="bold">current script</strong></span><span class="No-Break">.</span></li>
<li>We should see a JSON object like what we see in <span class="No-Break"><em class="italic">Figure 2</em></span><em class="italic">.11</em> displayed in <span class="No-Break">the console:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer041">
<img alt="Figure 2.11 – JSON response displayed in Thonny’s Shell" height="348" src="image/B21282_02_11.jpg" width="657"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.11 – JSON response displayed in Thonny’s Shell</p>
<p class="callout-heading">Important note – code not for production</p>
<p class="callout">Please note that in the provided code, error checking has been omitted for the sake of simplicity. If this application were to be deployed to a production environment (for use by customers, for example), we would be sure to include appropriate error-handling and error-checking mechanisms to ensure the reliability and stability of <span class="No-Break">the application.</span></p>
<p>With our <a id="_idIndexMarker156"/>code to pull stock information from the internet done, it is now time to utilize the dot-matrix screen of the Sense HAT to create a scrolling <span class="No-Break">stock ticker.</span></p>
<h2 id="_idParaDest-40"><a id="_idTextAnchor040"/>Enhancing our application</h2>
<p>With our understanding of how to use the Alpha Vantage web service, we are now able to create <a id="_idIndexMarker157"/>an application that fetches stock data and transforms it into a real-life scrolling stock ticker. Our application takes advantage of the Sense HAT’s dot-matrix display, turning it into a dynamic canvas for the stock ticker. Instead of printing the JSON response to the console, the stock information will elegantly scroll across the Sense HAT display, providing a visually captivating representation of <span class="No-Break">the data.</span></p>
<p>To create our web service code, we launch Thonny on our Raspberry Pi and create a <span class="No-Break">new tab:</span></p>
<ol>
<li>We launch Thonny on our Raspberry Pi and activate the <strong class="source-inline">ch2-env</strong> Python virtual environment using the steps in the <span class="No-Break">previous section.</span></li>
<li>In a new tab in Thonny, we start our code by importing the <span class="No-Break">necessary libraries:</span><pre class="source-code">
import requests
from sense_hat import SenseHat
import time</pre><p class="list-inset">In our code, we import the <strong class="source-inline">requests</strong> module, as well as the <strong class="source-inline">SenseHat</strong> class from the <strong class="source-inline">sense_hat</strong> module. For those of us using the Sense HAT emulator, we would change this to <strong class="source-inline">from sense_emu import SenseHat</strong>. We then import the <span class="No-Break"><strong class="source-inline">time</strong></span><span class="No-Break"> module.</span></p></li> <li>With our libraries in place, we create and set the variables we use in <span class="No-Break">our code:</span><pre class="source-code">
api_key = 'xxxxxxxxxxxxxxxx'
symbol = 'AAPL'
base_url = 'https://www.alphavantage.co/query?'
function = 'GLOBAL_QUOTE'
sense = SenseHat()
sense.set_rotation(270)
last_call_time = time.time() - 180
last_ticker_info = ""</pre><p class="list-inset">In these code lines, we use the <strong class="source-inline">api_key</strong> variable to store our unique Alpha Vantage API key for accessing a web service. We use the <strong class="source-inline">symbol</strong> variable to store the <a id="_idIndexMarker158"/>stock symbol (for example, <strong class="source-inline">'AAPL'</strong>) for which data will be fetched. The <strong class="source-inline">base_url</strong> variable is used to store the base URL of the web service API. The <strong class="source-inline">function</strong> variable is used to define the specific function to be called from the web service API (for example, <strong class="source-inline">'GLOBAL_QUOTE'</strong>). We then create an instance of the <strong class="source-inline">SenseHat</strong> class and assign it to the <strong class="source-inline">sense</strong> variable to interact with the Sense HAT (or emulator). We set the rotation of the Sense HAT display to <strong class="source-inline">270</strong> degrees using <strong class="source-inline">sense.set_rotation(270)</strong>. This is so that it matches the orientation of the Raspberry Pi in our custom case. We could comment this line out for the emulator. We then initialize the <strong class="source-inline">last_call_time</strong> variable with the current time minus 180 seconds, which allows an immediate first call to the web service. We initialize the <strong class="source-inline">last_ticker_info</strong> variable as an empty string to store the previous <span class="No-Break">ticker information.</span></p></li> <li>Below our variable declarations, we implement an infinite loop to continuously display the ticker information; however, to comply with API rate limits of 5 requests per minute and 500 requests per day, we introduce a time delay of 3 minutes between each web service call. We type the following code below our <span class="No-Break">variable declarations:</span><pre class="source-code">
while True:
    current_time = time.time()
    if current_time - last_call_time &gt;= 180:
        complete_url = f'{base_url}function={
                       function}&amp;symbol={
                       symbol}&amp;apikey={api_key}'
        response = requests.get(complete_url)
        data = response.json()
        quote = data['Global Quote']
        ticker_info = (
                    f"{quote['01. symbol']} "
                    f"Price: {quote['05. price']} "
        )
        ticker_info += (
                    f"Volume: {quote['06. volume']} "
                    f"Change: {quote['09. change']}"
        )
        last_ticker_info = ticker_info
        sense.show_message(ticker_info,
                           scroll_speed=0.05,
                           text_colour=[255,
                           255,
                           255])
        last_call_time = current_time
    else:
        sense.show_message(last_ticker_info,
                           scroll_speed=0.05,
                           text_colour=[255,
                           255,
                           255])
    time.sleep(1)</pre><p class="list-inset">Our code <a id="_idIndexMarker159"/>is wrapped in a <strong class="source-inline">while True</strong> loop, which ensures continuous execution of the following <span class="No-Break">code block:</span></p><ol><li class="upper-roman">We set the <strong class="source-inline">current_time</strong> variable to the current time <span class="No-Break">using </span><span class="No-Break"><strong class="source-inline">time.time()</strong></span><span class="No-Break">.</span></li><li class="upper-roman">Our code then checks whether the difference between <strong class="source-inline">current_time</strong> and <strong class="source-inline">last_call_time</strong> is greater than or equal to <span class="No-Break">180 seconds.</span></li><li class="upper-roman">If <strong class="source-inline">True</strong>, the <span class="No-Break">following happens:</span><ol><li class="lower-roman">A <strong class="source-inline">complete_url</strong> variable is created using an f-string to form the URL for the <span class="No-Break">API call.</span></li><li class="lower-roman">An HTTP <strong class="source-inline">GET</strong> request is sent to the API using <strong class="source-inline">requests.get(complete_url)</strong>, and the response is stored in the <span class="No-Break"><strong class="source-inline">response</strong></span><span class="No-Break"> variable.</span></li><li class="lower-roman">The response is parsed as JSON using <strong class="source-inline">response.json()</strong> and assigned to the <span class="No-Break"><strong class="source-inline">data</strong></span><span class="No-Break"> variable.</span></li><li class="lower-roman">The relevant stock information is extracted from the <strong class="source-inline">data</strong> dictionary and formatted into a <span class="No-Break"><strong class="source-inline">ticker_info</strong></span><span class="No-Break"> string.</span></li><li class="lower-roman">The <strong class="source-inline">last_ticker_info</strong> variable is updated to store the current <span class="No-Break"><strong class="source-inline">ticker_info</strong></span><span class="No-Break"> value.</span></li><li class="lower-roman">The <strong class="source-inline">ticker_info</strong> string is displayed on the Sense HAT’s dot-matrix display using <strong class="source-inline">sense.show_message()</strong>, with a scrolling speed of 0.05 seconds and white text <span class="No-Break">color (</span><span class="No-Break"><strong class="source-inline">255,255,255</strong></span><span class="No-Break">).</span></li><li class="lower-roman">The <strong class="source-inline">last_call_time</strong> variable is updated to the current time (<strong class="source-inline">current_time</strong>) to mark the timestamp of the last <span class="No-Break">API call.</span></li></ol></li><li class="upper-roman">If <strong class="source-inline">False</strong>, the previous <strong class="source-inline">last_ticker_info</strong> variable is displayed on the Sense HAT display with a scrolling speed of 0.05 seconds and white text <span class="No-Break">color (</span><span class="No-Break"><strong class="source-inline">255,255,255</strong></span><span class="No-Break">).</span></li><li class="upper-roman">Our program <a id="_idIndexMarker160"/>then sleeps for 1 second using <strong class="source-inline">time.sleep(1)</strong> before the next iteration of the loop. This is done to regulate resource consumption and control the update frequency of the Sense HAT’s <span class="No-Break">dot-matrix display.</span></li></ol></li> <li>We save our code as <strong class="source-inline">aapl-stock-ticker.py</strong> and then run it by clicking on the green run button, hitting <em class="italic">F5</em> on the keyboard, or clicking on the <strong class="bold">Run</strong> menu option at the top and then <strong class="bold">Run </strong><span class="No-Break"><strong class="bold">current script</strong></span><span class="No-Break">.</span></li>
<li>After we execute the code, we should observe a stock message scrolling across the dot-matrix screen of the Sense HAT. If we are utilizing the emulator, the message will scroll across the simulated dot-matrix display, considering the 270-degree orientation set for the emulator. <span class="No-Break"><em class="italic">Figure 2</em></span><em class="italic">.12</em> provides a visual representation of how this appears when using <span class="No-Break">the emulator:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer042">
<img alt="Figure 2.12 – Stock ticker information on Sense HAT emulator" height="464" src="image/B21282_02_12.jpg" width="766"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.12 – Stock ticker information on Sense HAT emulator</p>
<p>Congratulations <a id="_idIndexMarker161"/>are in order as we have successfully built our first real-world IoT device, a stock ticker using Raspberry Pi and Sense HAT! This device opens a world of possibilities beyond just displaying stock information. In the next section, we will start developing applications to display <span class="No-Break">weather conditions.</span></p>
<h1 id="_idParaDest-41"><a id="_idTextAnchor041"/>Developing weather display applications</h1>
<p>Now that we are experienced IoT application developers, we are ready to take our skills to the next <a id="_idIndexMarker162"/>level and create more intricate projects. In this section, we will leverage the capabilities of Raspberry Pi and Sense HAT to create a weather display application and a weather-dependent GO-NO-GO <span class="No-Break">decision-making application.</span></p>
<p>In <span class="No-Break"><em class="italic">Figure 2</em></span><em class="italic">.13</em>, we see a diagram depicting a call to the OpenWeather API from our Raspberry Pi and Sense HAT, enclosed within its custom case. For our weather display application, we will follow a similar approach to the scrolling <span class="No-Break">stock ticker:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer043">
<img alt="Figure 2.13 – Using the OpenWeather API to get the current weather conditions" height="343" src="image/B21282_02_13.jpg" width="1102"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.13 – Using the OpenWeather API to get the current weather conditions</p>
<p>We will first <a id="_idIndexMarker163"/>acquire an API key from OpenWeather and verify the API call by printing the response to the Shell for testing purposes. We will then utilize the Sense HAT to create a ticker-style display that displays the current <span class="No-Break">weather conditions.</span></p>
<p>Finally, we will replace the scrolling display with visuals as we build a weather-dependent GO-NO-GO <span class="No-Break">decision-making application.</span></p>
<p>We will start by obtaining an <span class="No-Break">API key.</span></p>
<h2 id="_idParaDest-42"><a id="_idTextAnchor042"/>Getting an API key</h2>
<p>To utilize the OpenWeather web service, it is necessary to obtain an API key. This API key serves <a id="_idIndexMarker164"/>as a unique identifier that grants access to the OpenWeather web service. The key is acquired by creating an account on the OpenWeather website and generating an API key by subscribing to the appropriate service. The API key acts as a credential to authenticate and authorize our requests to the OpenWeather web service, enabling us to retrieve weather data for various locations around the world. It’s important to keep the API key confidential and securely store it as it grants access to the OpenWeather API on <span class="No-Break">our behalf.</span></p>
<p>To obtain a free API key from OpenWeather, we start by navigating to the OpenWeather price page located at <a href="https://openweathermap.org/price">https://openweathermap.org/price</a>. We then scroll down to the <strong class="bold">Current weather and forecasts collection</strong> section and click on the <strong class="bold">Get API </strong><span class="No-Break"><strong class="bold">key</strong></span><span class="No-Break"> button:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer044">
<img alt="Figure 2.14 – Obtaining an API key from OpenWeather" height="821" src="image/B21282_02_14.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.14 – Obtaining an API key from OpenWeather</p>
<p>We follow <a id="_idIndexMarker165"/>the instructions for creating a new account. After successfully creating the account, we gain access to our personal dashboard. Inside the personal dashboard, we navigate to the <strong class="bold">API keys</strong> tab and locate the API key in the <span class="No-Break"><strong class="bold">Key</strong></span><span class="No-Break"> box.</span></p>
<p>We copy and paste our key into a text editor as we require this key every time we make a call to the OpenWeather web service. As a free user, we are limited to 60 API requests per minute and a total of 1,000,000 API requests per month. This should be more than enough for <span class="No-Break">our application.</span></p>
<p>With our OpenWeather API key, we can now start to write code to test out the <span class="No-Break">web service.</span></p>
<h2 id="_idParaDest-43"><a id="_idTextAnchor043"/>Creating a scrolling weather information ticker</h2>
<p>With our OpenWeather API key, Raspberry Pi, and Sense HAT, we will now create a scrolling <a id="_idIndexMarker166"/>weather information device that mimics the functionality of our scrolling stock ticker. We will start by acquiring weather data and display the results in the Shell <span class="No-Break">of Thonny.</span></p>
<p>After we <a id="_idIndexMarker167"/>are satisfied that our API key and web service work, we will integrate the web service data with the Sense HAT, displaying scrolling text that displays the temperature and <span class="No-Break">weather conditions.</span></p>
<h3>Testing the web service</h3>
<p>Before integrating the OpenWeather API into our Raspberry Pi and Sense HAT, we will ensure its <a id="_idIndexMarker168"/>functionality with a simple program. To create the test code, we do <span class="No-Break">the following:</span></p>
<ol>
<li>We launch Thonny on our Raspberry Pi, activate the <strong class="source-inline">ch2-env</strong> Python virtual environment, and create a new tab. Inside the tab, we write the <span class="No-Break">following code:</span><pre class="source-code">
import requests
url = "https://api.openweathermap.org/data/2.5/weather"
api_key = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
location = "Toronto"
params = {
    "q": location,
    "appid": api_key,
    "units": "metric"
}
response = requests.get(url, params=params)
if response.status_code == 200:
    data = response.json()
    temperature = data["main"]["temp"]
    description = data["weather"][0]["description"]
    print(f"The current temperature in {location} is {temperature}°C.")
    print(f"The weather is {description}.")
else:
    print("Error: Failed to retrieve weather information.")</pre><p class="list-inset">Before <a id="_idIndexMarker169"/>we run our code, let’s break <span class="No-Break">it down:</span></p><ol><li class="upper-roman">We start by importing the <strong class="source-inline">requests</strong> module to make <span class="No-Break">HTTP requests.</span></li><li class="upper-roman">We then set the <strong class="source-inline">url</strong> variable to the OpenWeather <span class="No-Break">API endpoint.</span></li><li class="upper-roman">We set the <strong class="source-inline">api_key</strong> variable with our OpenWeather <span class="No-Break">API key.</span></li><li class="upper-roman">We set the <strong class="source-inline">location</strong> variable to the desired location for which we want to retrieve weather information. For our example, this <span class="No-Break">is </span><span class="No-Break"><strong class="source-inline">"Toronto"</strong></span><span class="No-Break">.</span></li><li class="upper-roman">We then create a dictionary called <strong class="source-inline">params</strong> with the parameters for the API request, including the location, API key, and <span class="No-Break">desired units.</span></li><li class="upper-roman">A <strong class="source-inline">GET</strong> request is sent to the OpenWeather API using <strong class="source-inline">requests.get()</strong>, with <strong class="source-inline">url</strong> and <strong class="source-inline">params</strong> <span class="No-Break">as arguments.</span></li><li class="upper-roman">We then check whether the response status code is <strong class="source-inline">200</strong> (indicating a <span class="No-Break">successful request).</span></li><li class="upper-roman">If the response is successful, we parse the JSON data from the response using <strong class="source-inline">response.json()</strong> and then do <span class="No-Break">the following:</span><ol><li class="lower-roman">We extract the temperature and weather description from the <span class="No-Break">parsed data.</span></li><li class="lower-roman">We then print the current temperature and weather information for the <span class="No-Break">specified location.</span></li></ol></li><li class="upper-roman">If there is an error (response status code other than <strong class="source-inline">200</strong>), we print an error message indicating the failure to retrieve <span class="No-Break">weather information.</span></li></ol></li> <li>We save <a id="_idIndexMarker170"/>our code as <strong class="source-inline">weather-api-test.py</strong> and then run it by clicking on the green run button, hitting <em class="italic">F5</em> on the keyboard, or clicking on the <strong class="bold">Run</strong> menu option at the top and then <strong class="bold">Run </strong><span class="No-Break"><strong class="bold">current script</strong></span><span class="No-Break">.</span></li>
</ol>
<p>After we execute the code, we should observe a message in <span class="No-Break">the Shell:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer045">
<img alt="Figure 2.15 – OpenWeather API information on the weather in Toronto" height="193" src="image/B21282_02_15.jpg" width="624"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.15 – OpenWeather API information on the weather in Toronto</p>
<p>As we can see, it is <strong class="source-inline">29.15 °C</strong> and clear in Toronto at the time of this writing. If the web service call did not work, we would’ve seen an <strong class="source-inline">Error: Failed to retrieve weather information</strong> error in <span class="No-Break">the console.</span></p>
<p>With our understanding of how to use the OpenWeather API, we are now ready to use the Sense HAT to create our scrolling weather information ticker. For this, we may reuse much of the code we wrote for our scrolling stock <span class="No-Break">ticker application.</span></p>
<h2 id="_idParaDest-44"><a id="_idTextAnchor044"/>Scrolling weather information on Sense HAT</h2>
<p>As <a id="_idIndexMarker171"/>we highlighted <a id="_idIndexMarker172"/>in our previous project, the versatility of our scrolling stock ticker application allows us to adapt it to display various types of information beyond stocks. In this section, we will leverage this adaptability by integrating the OpenWeather API and our API key to transform our ticker into a dynamic weather display, scrolling real-time weather data such as temperature and current conditions. We will be able to reuse a lot of the code from the scrolling stock ticker. To create the <a id="_idIndexMarker173"/>scrolling ticker code, we do <span class="No-Break">the following:</span></p>
<ol>
<li>We launch <a id="_idIndexMarker174"/>Thonny on our Raspberry Pi, activate the <strong class="source-inline">ch2-env</strong> Python virtual environment, and create a new tab. We will start with <span class="No-Break">our imports:</span><pre class="source-code">
import requests
from sense_hat import SenseHat
import time</pre></li> </ol>
<p class="callout-heading">Important note</p>
<p class="callout">As we have already covered these imports with our scrolling stock ticker application, we do not need to cover <span class="No-Break">them again.</span></p>
<ol>
<li value="2">After our imports, we set <span class="No-Break">our variables:</span><pre class="source-code">
api_key = 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'
location = 'Toronto'
base_url = 'https://api.openweathermap.org/data/2.5/weather'
params = {
    'q': location,
    'appid': api_key,
    'units': 'metric'
}
sense = SenseHat()
sense.set_rotation(270)
last_call_time = time.time() - 30
last_weather_info = ""</pre><p class="list-inset">In <a id="_idIndexMarker175"/>this code block, we do <span class="No-Break">the following:</span></p><ol><li class="upper-roman">We start <a id="_idIndexMarker176"/>by assigning the <strong class="source-inline">api_key</strong> variable to our OpenWeather <span class="No-Break">API key.</span></li><li class="upper-roman">We set the <strong class="source-inline">location</strong> variable to the desired location for which we want to retrieve weather information. For our example, this <span class="No-Break">is </span><span class="No-Break"><strong class="source-inline">'Toronto'</strong></span><span class="No-Break">.</span></li><li class="upper-roman">We then set the <strong class="source-inline">base_url</strong> variable to the OpenWeather <span class="No-Break">API endpoint.</span></li><li class="upper-roman">We create a dictionary called <strong class="source-inline">params</strong> with the parameters for the API request, including the location, API key, and <span class="No-Break">desired units.</span></li><li class="upper-roman">A <strong class="source-inline">GET</strong> request is sent to the OpenWeather API using <strong class="source-inline">requests.get()</strong>, with <strong class="source-inline">url</strong> and <strong class="source-inline">params</strong> <span class="No-Break">as arguments.</span></li><li class="upper-roman">We then create an instance of the <strong class="source-inline">SenseHat</strong> class and assign it to the <strong class="source-inline">sense</strong> variable to interact with the Sense HAT (<span class="No-Break">or emulator).</span></li><li class="upper-roman">We set the rotation of the Sense HAT display to 270 degrees using <strong class="source-inline">sense.set_rotation(270)</strong>. This is so that it matches the orientation of the Raspberry Pi in our custom case. We could comment this line out for <span class="No-Break">the emulator.</span></li><li class="upper-roman">We set <strong class="source-inline">last_call_time</strong> to the current time minus <span class="No-Break">30 seconds.</span></li><li class="upper-roman">We then add <strong class="source-inline">last_weather_info</strong>, which is a variable that stores the previous <span class="No-Break">weather information.</span></li></ol></li> <li>Below our variable declarations, we implement an infinite loop to continuously display the weather ticker information; however, to comply with API rate limits of 60 requests per minute and 1,000,000 requests per month, we introduce a time delay of 30 seconds between each web service call. We type the following code <a id="_idIndexMarker177"/>below <a id="_idIndexMarker178"/>our <span class="No-Break">variable declarations:</span><pre class="source-code">
while True:
    current_time = time.time()
    if current_time - last_call_time &gt;= 30:
        response = requests.get(base_url,
                   params=params)
        data = response.json()
        temperature = data['main']['temp']
        description = data['weather'][0]['description']
        weather_info = f"{location}: {temperature}°C, {description}"
        last_weather_info = weather_info
        sense.show_message(weather_info, scroll_speed=0.05, text_colour=[255, 255, 255])
        last_call_time = current_time
    else:
        sense.show_message(last_weather_info, scroll_speed=0.05, text_colour=[255, 255, 255])
    time.sleep(1)</pre></li> <li>As in <a id="_idIndexMarker179"/>our scrolling stock ticker application, the heart of our code is wrapped in a <strong class="source-inline">while True</strong> loop, which ensures continuous execution of the <span class="No-Break">main code:</span><ol><li class="upper-roman">We set the <strong class="source-inline">current_time</strong> variable to the current time <span class="No-Break">using </span><span class="No-Break"><strong class="source-inline">time.time()</strong></span><span class="No-Break">.</span></li><li class="upper-roman">Our code <a id="_idIndexMarker180"/>then checks whether the difference between <strong class="source-inline">current_time</strong> and <strong class="source-inline">last_call_time</strong> is greater than or equal to <span class="No-Break">30 seconds.</span></li><li class="upper-roman">If <strong class="source-inline">True</strong>, the <span class="No-Break">following happens:</span><ol><li class="lower-roman">A <strong class="source-inline">GET</strong> request is sent to the OpenWeather API using <strong class="source-inline">requests.get()</strong>, with <strong class="source-inline">base_url</strong> and <strong class="source-inline">params</strong> <span class="No-Break">as arguments.</span></li><li class="lower-roman">The response is parsed as JSON using <strong class="source-inline">response.json()</strong> and assigned to the <span class="No-Break"><strong class="source-inline">data</strong></span><span class="No-Break"> variable.</span></li><li class="lower-roman">We extract the temperature and weather description from the parsed data and store it <span class="No-Break">as </span><span class="No-Break"><strong class="source-inline">weather_info.</strong></span></li><li class="lower-roman">The <strong class="source-inline">last_weather_info</strong> variable is updated to store the current <span class="No-Break"><strong class="source-inline">weather_info</strong></span><span class="No-Break"> value.</span></li><li class="lower-roman"><strong class="source-inline">weather_info</strong> is displayed on the Sense HAT’s dot-matrix display using <strong class="source-inline">sense.show_message()</strong>, with a scrolling speed of 0.05 seconds and white text <span class="No-Break">color (</span><span class="No-Break"><strong class="source-inline">255,255,255</strong></span><span class="No-Break">).</span></li><li class="lower-roman">The <strong class="source-inline">last_call_time</strong> variable is updated to the current time (<strong class="source-inline">current_time</strong>) to mark the timestamp of the last <span class="No-Break">API call.</span></li></ol></li><li class="upper-roman">If <strong class="source-inline">False</strong>, the previous <strong class="source-inline">last_weather_info</strong> variable is displayed on the Sense HAT display with a scrolling speed of 0.05 seconds and white text <span class="No-Break">color (</span><span class="No-Break"><strong class="source-inline">255,255,255</strong></span><span class="No-Break">).</span></li><li class="upper-roman">Our program then sleeps for 1 second using <strong class="source-inline">time.sleep(1)</strong> before the next iteration of the loop. This is done to regulate resource consumption and control the update frequency of the Sense HAT’s <span class="No-Break">dot-matrix display.</span></li></ol></li>
<li>We save our code as <strong class="source-inline">weather-scroll.py</strong> and then run it by clicking on the green run button, hitting <em class="italic">F5</em> on the keyboard, or clicking on the <strong class="bold">Run</strong> menu option at the top and then <strong class="bold">Run </strong><span class="No-Break"><strong class="bold">current script</strong></span><span class="No-Break">.</span></li>
</ol>
<p>After we <a id="_idIndexMarker181"/>execute the code, we should observe <a id="_idIndexMarker182"/>weather information scrolling across the dot-matrix screen of the Sense HAT. If we are utilizing the emulator, a message will scroll across the simulated dot-matrix display. <span class="No-Break"><em class="italic">Figure 2</em></span><em class="italic">.16</em> provides a visual representation of how this appears when using <span class="No-Break">the emulator:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer046">
<img alt="Figure 2.16 – Weather information scrolling across the simulated dot-matrix display" height="464" src="image/B21282_02_16.jpg" width="766"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.16 – Weather information scrolling across the simulated dot-matrix display</p>
<p>One key takeaway is the power of leveraging existing code to create new applications. Despite inherent differences between stock information and weather data, the process of obtaining information for both fields remain remarkably similar. With this realization, we unlock the potential to create a wide range of dynamic and engaging displays using the same underlying <span class="No-Break">code structure.</span></p>
<p>Here <a id="_idIndexMarker183"/>are a few examples of other applications <a id="_idIndexMarker184"/>we <span class="No-Break">could build:</span></p>
<ul>
<li><strong class="bold">News updates</strong>: By modifying the code, we can integrate our device with news APIs to display real-time headlines or updates from popular <span class="No-Break">news sources.</span></li>
<li><strong class="bold">Social media notifications</strong>: By connecting our application to social media APIs, we can configure it to display notifications from popular platforms such as Twitter <span class="No-Break">or Facebook.</span></li>
<li><strong class="bold">Sports scores</strong>: With the integration of sports data APIs, our stock ticker application can be transformed into a real-time sports scoreboard. It can display live scores, game updates, or upcoming <span class="No-Break">game schedules.</span></li>
<li><strong class="bold">Personalized reminders</strong>: By extending the functionality of the code, we can program the stock ticker application to display personalized reminders or <span class="No-Break">to-do lists.</span></li>
</ul>
<p>In our next and final project for the chapter, we will replace our scrolling text displays with dot-matrix images and animations. This shift from scrolling text elevates the user experience and will make our projects more <span class="No-Break">visually appealing.</span></p>
<h2 id="_idParaDest-45"><a id="_idTextAnchor045"/>Developing a GO-NO-GO application for decision-making</h2>
<p>Consider <a id="_idIndexMarker185"/>the role <a id="_idIndexMarker186"/>of a youth baseball league convener, responsible for ensuring the safety of playing fields. Critical to this responsibility is making weather-based decisions. If the field is excessively wet, it can impact gameplay, potentially leading to game postponements <span class="No-Break">or cancellations:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer047">
<img alt="Figure 2.17 – Should the game go on?" height="646" src="image/B21282_02_17.jpg" width="887"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.17 – Should the game go on?</p>
<p>Another <a id="_idIndexMarker187"/>factor to consider is the age of <a id="_idIndexMarker188"/>the players. For younger players, playing in the rain raises concerns, as parents are often present and may express dissatisfaction with unfavorable weather conditions. On the other hand, older players, who typically travel to games independently, may be less affected by <span class="No-Break">wet conditions.</span></p>
<p>These decision-making scenarios represent an opportunity to develop an IoT application that displays a visual indicator, such as a <strong class="bold">GO</strong> or <strong class="bold">NO-GO</strong> graphic, based on weather conditions and player age (<span class="No-Break"><em class="italic">Figure 2</em></span><em class="italic">.17</em>). Imagine a setup with Raspberry Pi and Sense HATs for each baseball diamond, where the Sense HAT display provides real-time guidance on whether the game should proceed as scheduled, be postponed, or be canceled altogether. This IoT application enables efficient decision-making and enhances the overall experience and safety of the youth <span class="No-Break">baseball league.</span></p>
<p>In our simplified example, we will focus on incorporating basic decision-making into our IoT application. Based on the age of the players and the presence of rain, the Sense HAT will show either a green checkmark or an animated red X sign. While we could introduce additional complexity, the primary objective of this exercise is to demonstrate how decision-making can be integrated into an IoT application. By incorporating these visual indicators, we empower real-time decision-making. Instead of relying solely on the convener, our IoT application takes charge by providing immediate guidance on whether games should proceed or <span class="No-Break">be postponed.</span></p>
<p>We <a id="_idIndexMarker189"/>will start by <a id="_idIndexMarker190"/>writing Sense HAT code for indication. For GO, we will show a simple green checkmark against a black background. For NO-GO, we will display a flashing red X. We will run our application using the Sense HAT emulator as it is easier to display screenshots for this book; however, it is strongly encouraged to use the Sense HAT as this makes our application a true <span class="No-Break">IoT device.</span></p>
<p>We will start by writing code to display a <span class="No-Break">green checkmark.</span></p>
<h3>Creating a checkmark on our Sense HAT</h3>
<p>In this section, we will create code that displays a green checkmark against a black background <a id="_idIndexMarker191"/>on the Sense HAT emulator. To enhance code implementation and organization, we will encapsulate the functionality within a Python class. This approach simplifies <a id="_idIndexMarker192"/>the integration process and promotes <a id="_idIndexMarker193"/>code reusability, allowing us to easily incorporate the green checkmark display into our IoT <span class="No-Break">application project.</span></p>
<p>Prior to writing the code for the GO-NO-GO application, we will create a project directory named <strong class="source-inline">GO-NO-GO</strong> on our Raspberry Pi. This dedicated folder will serve as a centralized location for organizing and managing files and resources associated with our project. To create the checkmark code, we do <span class="No-Break">the following:</span></p>
<ol>
<li>We launch Thonny on our Raspberry Pi, activate the <strong class="source-inline">ch2-env</strong> virtual environment, and create a new tab. Inside the tab, we write the <span class="No-Break">following code:</span><pre class="source-code">
from sense_emu import SenseHat
class GreenCheck:
    black = (0, 0, 0)
    green = (0, 255, 0)
    check_mark_pixels = [
        black, black, black, black,
        black, black, black, green,
        black, black, black, black,
        black, black, green, green,
        black, black, black, black,
        black, black, green, green,
        black, black, black, black,
        black, green, green, black,
        green, black, black, black,
        green, green, black, black,
        black, green, black, black,
        green, green, black, black,
        black, green, green, green,
        green, black, black, black,
        black, black, black, green,
        black, black, black, black
    ]
    def __init__(self, rotation=0):
        self.sense = SenseHat()
        self.sense.set_rotation(rotation)
    def display(self):
        self.sense.set_pixels(self.check_mark_pixels)
if __name__ == "__main__":
    greenCheck = GreenCheck(rotation = 270)
    greenCheck.display()</pre><p class="list-inset">In our <a id="_idIndexMarker194"/>code, we do <span class="No-Break">the following:</span></p><ol><li class="upper-roman">We start <a id="_idIndexMarker195"/>by importing the <strong class="source-inline">SenseHat</strong> class from the <strong class="source-inline">sense_hat</strong> module (use <strong class="source-inline">sense_emu</strong> for <span class="No-Break">the emulator)</span></li><li class="upper-roman">We then define a <strong class="source-inline">GreenCheck</strong> class for displaying a green checkmark on the <span class="No-Break">Sense HAT</span></li><li class="upper-roman">We set color values for black and green as <span class="No-Break">RGB tuples.</span></li><li class="upper-roman">We then define a list of pixel values representing the <span class="No-Break">checkmark shape.</span></li><li class="upper-roman">The <strong class="source-inline">GreenCheck</strong> class is initialized with an optional rotation parameter, which defaults <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">0</strong></span><span class="No-Break">.</span></li><li class="upper-roman">Inside the <strong class="source-inline">__init__</strong> method, we create a Sense HAT instance and set the rotation to the value <span class="No-Break">of </span><span class="No-Break"><strong class="source-inline">rotation</strong></span><span class="No-Break">.</span></li><li class="upper-roman">We define a <strong class="source-inline">display</strong> method that sets the Sense HAT’s pixels to the checkmark <span class="No-Break">pixel values.</span></li><li class="upper-roman">We use <strong class="source-inline">if __name__ == "__main__"</strong> to check whether the code is being run directly (<span class="No-Break">not imported).</span></li><li class="upper-roman">If <strong class="source-inline">True</strong>, we do <span class="No-Break">the following:</span><ol><li class="lower-roman">We create an instance of the <strong class="source-inline">GreenCheck</strong> class named <strong class="source-inline">greenCheck</strong> with a rotation value <span class="No-Break">of </span><span class="No-Break"><strong class="source-inline">270</strong></span><span class="No-Break">.</span></li><li class="lower-roman">We call the <strong class="source-inline">display()</strong> method to show a green checkmark on the <span class="No-Break">Sense HAT.</span></li></ol></li></ol></li> <li>We save our code as <strong class="source-inline">green_checkmark.py</strong> in the <strong class="source-inline">GO-NO-GO</strong> folder and then run it by clicking on the green run button, hitting <em class="italic">F5</em> on the keyboard, or clicking on the <strong class="bold">Run</strong> menu option at the top and then <strong class="bold">Run </strong><span class="No-Break"><strong class="bold">current script</strong></span><span class="No-Break">.</span></li>
<li>After we <a id="_idIndexMarker196"/>execute the code, we should <a id="_idIndexMarker197"/>see a green checkmark against a black background on our Sense <span class="No-Break">HAT emulator:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer048">
<img alt="Figure 2.18 – Green checkmark against black background on Sense HAT’s dot-matrix display" height="641" src="image/B21282_02_18.jpg" width="977"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.18 – Green checkmark against black background on Sense HAT’s dot-matrix display</p>
<p>With the completion of the green checkmark code, we will now shift our focus toward creating a NO-GO animation (flashing red X) for <span class="No-Break">our application.</span></p>
<h3>Creating a NO-GO animation on our Sense HAT</h3>
<p>The <a id="_idIndexMarker198"/>NO-GO <a id="_idIndexMarker199"/>animation we have <a id="_idIndexMarker200"/>designed consists of a flashing effect on the Sense HAT emulator display, alternating between a red X sign on a black background and a full red display. To create code for the flashing X sign, we do <span class="No-Break">the following:</span></p>
<ol>
<li>We <a id="_idIndexMarker201"/>launch Thonny on our Raspberry Pi, activate the <strong class="source-inline">ch2-env</strong> Python <a id="_idIndexMarker202"/>virtual environment, and create <a id="_idIndexMarker203"/>a new tab. Inside the tab, we start by importing the packages <span class="No-Break">we need:</span><pre class="source-code">
from sense_emu import SenseHat
import time</pre></li> <li>Once we have our packages defined, we then start to wrap our code up in a <span class="No-Break">Python class:</span><pre class="source-code">
class RedXAnimation:
    black = (0, 0, 0)
    red = (255, 0, 0)
    frame1 = [
        red, black, black, black,
        black, black, black, red,
        black, red, black, black,
        black, black, red, black,
        black, black, red, black,
        black, red, black, black,
        black, black, black, red,
        red, black, black, black,
        black, black, black, red,
        red, black, black, black,
        black, black, red, black,
        black, red, black, black,
        black, red, black, black,
        black, black, red, black,
        red, black, black, black,
        black, black, black, red
    ]
    frame2 = [
        red, red, red, red, red, red, red, red,
        red, red, red, red, red, red, red, red,
        red, red, red, red, red, red, red, red,
        red, red, red, red, red, red, red, red,
        red, red, red, red, red, red, red, red,
        red, red, red, red, red, red, red, red,
        red, red, red, red, red, red, red, red,
        red, red, red, red, red, red, red, red
    ]</pre><p class="list-inset">In <a id="_idIndexMarker204"/>our code, we do <span class="No-Break">the following:</span></p><ol><li class="upper-roman">We <a id="_idIndexMarker205"/>start by defining a <span class="No-Break"><strong class="source-inline">RedXAnimation</strong></span><span class="No-Break"> class.</span></li><li class="upper-roman">We then set color values for black and red as <span class="No-Break">RGB tuples.</span></li><li class="upper-roman">We define <strong class="source-inline">frame1</strong> as a list of pixel values representing a red X sign on a <span class="No-Break">black background.</span></li><li class="upper-roman">We define <strong class="source-inline">frame2</strong> as a list of pixel values representing a full <span class="No-Break">red display.</span></li></ol></li> <li>From here, we write code for the initialize method in <span class="No-Break">the class:</span><pre class="source-code">
    def __init__(self, rotation=0):
        self.sense = SenseHat()
        self.sense.set_rotation(rotation)</pre><p class="list-inset">In <a id="_idIndexMarker206"/>our code, we do <span class="No-Break">the following:</span></p><ol><li class="upper-roman">We use <a id="_idIndexMarker207"/>the <strong class="source-inline">__init__</strong> method to initialize the <strong class="source-inline">RedXAnimation</strong> object with an optional <strong class="source-inline">rotation</strong> parameter (defaulted <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">0</strong></span><span class="No-Break">).</span></li><li class="upper-roman">Inside <strong class="source-inline">__init__</strong>, a <strong class="source-inline">SenseHat</strong> instance is created, and the rotation is set based on the provided <span class="No-Break"><strong class="source-inline">rotation</strong></span><span class="No-Break"> value.</span></li></ol></li> <li>The <strong class="source-inline">display_animation()</strong> method will cycle through the 2 frames for 59 seconds. We do this to align with future <span class="No-Break">client code:</span><pre class="source-code">
    def display_animation(self, duration):
        num_frames = 2
        frame_duration = duration / num_frames
        start_time = time.time()
        end_time = start_time + 59
        while time.time() &lt; end_time:
            for frame in [self.frame1, self.frame2]:
                self.sense.set_pixels(frame)
                time.sleep(frame_duration)</pre><p class="list-inset">In our code, the <span class="No-Break">following happens:</span></p><ol><li class="upper-roman">Our <strong class="source-inline">display_animation()</strong> method takes a <span class="No-Break">duration parameter.</span></li><li class="upper-roman">We set the number of frames <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">2.</strong></span></li><li class="upper-roman">We calculate the duration for each frame by dividing the total duration by the number <span class="No-Break">of frames.</span></li><li class="upper-roman">We set the <strong class="source-inline">start_time</strong> variable to the current time <span class="No-Break">using </span><span class="No-Break"><strong class="source-inline">time.time()</strong></span><span class="No-Break">.</span></li><li class="upper-roman">We calculate the <strong class="source-inline">end_time</strong> value by adding 59 seconds to the <span class="No-Break"><strong class="source-inline">start_time</strong></span><span class="No-Break"> variable.</span></li><li class="upper-roman">We create <a id="_idIndexMarker208"/>a loop that runs until the current time exceeds <a id="_idIndexMarker209"/>the <span class="No-Break"><strong class="source-inline">end_time</strong></span><span class="No-Break"> value:</span><ol><li class="lower-roman">Our code iterates over each frame in the list <strong class="source-inline">[</strong><span class="No-Break"><strong class="source-inline">self.frame1, self.frame2]</strong></span><span class="No-Break">.</span></li><li class="lower-roman">We set the Sense HAT display pixels to the current frame <span class="No-Break">using </span><span class="No-Break"><strong class="source-inline">self.sense.set_pixels(frame)</strong></span><span class="No-Break">.</span></li><li class="lower-roman">We then pause the execution for the frame duration <span class="No-Break">using </span><span class="No-Break"><strong class="source-inline">time.sleep(frame_duration)</strong></span><span class="No-Break">.</span></li></ol></li></ol></li> <li>We use the <strong class="source-inline">if __name__ == "__main__":</strong> block to ensure that the test code is executed only when the script is run directly (not imported as <span class="No-Break">a module):</span><pre class="source-code">
if __name__ == "__main__":
    animation = RedXAnimation(rotation=270)
    animation.display_animation(duration=1)</pre><p class="list-inset">In our code, the <span class="No-Break">following happens:</span></p><ol><li class="upper-roman">An instance of the <strong class="source-inline">RedXAnimation</strong> class is created with a rotation value of 270 degrees, assigned to the <span class="No-Break"><strong class="source-inline">animation</strong></span><span class="No-Break"> variable.</span></li><li class="upper-roman">The <strong class="source-inline">display_animation()</strong> method of the <strong class="source-inline">animation</strong> object is called, specifying a duration of <span class="No-Break">1 second.</span></li></ol></li> <li>We save our code as <strong class="source-inline">flashing_x.py</strong> in the <strong class="source-inline">GO-NO-GO</strong> folder and then run it by clicking on the green run button, hitting <em class="italic">F5</em> on the keyboard, or clicking on the <strong class="bold">Run</strong> menu option at the top and then <strong class="bold">Run </strong><span class="No-Break"><strong class="bold">current script</strong></span><span class="No-Break">.</span></li>
</ol>
<p>After <a id="_idIndexMarker210"/>executing the code, we should observe an animation of a red X sign against a black <a id="_idIndexMarker211"/>background turn into a full screen of red and back again. In <span class="No-Break"><em class="italic">Figure 2</em></span><em class="italic">.19</em>, we can see what this would look like on <span class="No-Break">the emulator:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer049">
<img alt="Figure 2.19 – NO-GO animation in red screen mode" height="464" src="image/B21282_02_19.jpg" width="766"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.19 – NO-GO animation in red screen mode</p>
<p>The NO-GO animation we have created in this section provides a highly effective visual indicator on the Sense HAT display. By alternating between a red X sign on a black background and a full red display, this animation conveys unfavorable conditions that would necessitate the cancellation of <span class="No-Break">a game.</span></p>
<p class="callout-heading">Setting the geolocation for other cities</p>
<p class="callout">For finding a city’s geolocation information such as latitude and longitude, websites such as <em class="italic">GPS Coordinates</em> (<a href="https://gps-coordinates.org/">https://gps-coordinates.org/</a>) and <em class="italic">Latitude and Longitude Finder</em> (<a href="https://www.latlong.net/">https://www.latlong.net/</a>) are useful. They allow us to input an address or place and receive its <span class="No-Break">precise coordinates.</span></p>
<p>To finish <a id="_idIndexMarker212"/>off our application, we will now write the web service and logic layer, and we will <a id="_idIndexMarker213"/>incorporate our green checkmark and red X <span class="No-Break">sign animation.</span></p>
<h3>Writing GO-NO-GO client code</h3>
<p>Now, it’s time to dive into the exciting phase (subjective, of course) of writing code to determine <a id="_idIndexMarker214"/>whether a game should be a GO or NO-GO based on weather conditions and the age of the players. Our approach will be straightforward: if it’s raining and the players are under 16 years of age, it’s a NO-GO; otherwise, it’s a GO. While we can certainly <a id="_idIndexMarker215"/>implement more complex logic, including <strong class="bold">Machine Learning</strong> (<strong class="bold">ML</strong>) if there are multiple parameters to consider, for simplicity, we’ll focus on this basic decision-making process. We do so with <span class="No-Break">the following:</span></p>
<ol>
<li>To create the client code, we launch Thonny on our Raspberry Pi, activate our <strong class="source-inline">ch2-env</strong> Python virtual environment, and create a new tab. Inside the tab, we start by importing the packages <span class="No-Break">we need:</span><pre class="source-code">
import requests
import time
from green_checkmark import GreenCheck
from flashing_x import RedXAnimation</pre><p class="list-inset">We’ve covered the first three packages already. For the two modules, we do <span class="No-Break">the following:</span></p><ul><li>We import the <strong class="source-inline">GreenCheck</strong> class from the <strong class="source-inline">green_checkmark</strong> module to display a green checkmark for the <span class="No-Break"><strong class="bold">GO</strong></span><span class="No-Break"> decision.</span></li><li>We import the <strong class="source-inline">RedXAnimation</strong> class from the <strong class="source-inline">flashing_x</strong> module to display a flashing red X sign animation when the decision <span class="No-Break">is </span><span class="No-Break"><strong class="bold">NO-GO</strong></span><span class="No-Break">.</span></li></ul></li> <li>With our <a id="_idIndexMarker216"/>packages and modules in place, we now set <span class="No-Break">our variables:</span><pre class="source-code">
latitude = '42.346268'
longitude = '-71.095764'
go = GreenCheck(rotation=270)
no_go = RedXAnimation(rotation=270)
timer = 1
age = 12
base_url = "https://api.openweathermap.org/data/2.5/weather"
api_key = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
params = {
    'lat': latitude,
    'lon': longitude,
    'appid': api_key,
    'units': 'metric'
}</pre><p class="list-inset">In our code, we do <span class="No-Break">the following:</span></p><ol><li class="upper-roman">We set <strong class="source-inline">latitude</strong> to <strong class="source-inline">'42.346268'</strong> and <strong class="source-inline">longitude</strong> to <strong class="source-inline">'-71.095764'</strong> for our baseball diamond. For example, this is the GPS coordinates for Fenway Park in Boston, <span class="No-Break">Massachusetts, US.</span></li><li class="upper-roman">We create a <strong class="source-inline">GreenCheck</strong> object named <strong class="source-inline">go</strong> with a rotation value of <span class="No-Break">270 degrees.</span></li><li class="upper-roman">We create a <strong class="source-inline">RedXAnimation</strong> object named <strong class="source-inline">no_go</strong> with a rotation value of <span class="No-Break">270 degrees.</span></li><li class="upper-roman">We set our <strong class="source-inline">timer</strong> value to <span class="No-Break">1 second.</span></li><li class="upper-roman">We set <a id="_idIndexMarker217"/>the age of our players <span class="No-Break">to 12.</span></li><li class="upper-roman">Our code sets the <strong class="source-inline">base_url</strong> value <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">"https://api.openweathermap.org/data/2.5/weather"</strong></span><span class="No-Break">.</span></li><li class="upper-roman">Next, we add our OpenWeather <span class="No-Break"><strong class="source-inline">api_key</strong></span><span class="No-Break"> value.</span></li><li class="upper-roman">We then define a <strong class="source-inline">params</strong> dictionary we will use with our web service call (<strong class="source-inline">latitude</strong>, <strong class="source-inline">longitude</strong>, <strong class="source-inline">api_key</strong>, <span class="No-Break">and </span><span class="No-Break"><strong class="source-inline">units</strong></span><span class="No-Break">).</span></li></ol></li> <li>We use an infinite loop to check the weather conditions every 60 seconds and update the display on our Sense <span class="No-Break">HAT accordingly:</span><pre class="source-code">
while True:
    response = requests.get(base_url, params=params)
    if response.status_code == 200:
        data = response.json()
        temperature = data['main']['temp']
        description = data['weather'][0]['main']
        print(f"The current temperature is {temperature}°C.")
        print(f"The weather is {description}.")
        if description == 'Thunderstorm' or description == 'Rain' and age &lt; 16:
            print("NO-GO!")
            no_go.display_animation(duration=1)
            timer = 1
        else:
            print("GO!")
            go.display()
            timer = 60
    else:
        print("Error: Failed to retrieve weather information.")
    time.sleep(timer)</pre><p class="list-inset">In our <a id="_idIndexMarker218"/>code, we set up an infinite loop using <span class="No-Break"><strong class="source-inline">while True</strong></span><span class="No-Break">:</span></p><ol><li class="upper-roman">We make a <strong class="source-inline">GET</strong> request to the OpenWeather API using <strong class="source-inline">requests.get()</strong> and store the response <span class="No-Break">in </span><span class="No-Break"><strong class="source-inline">response</strong></span><span class="No-Break">.</span></li><li class="upper-roman">If the response status code is <strong class="source-inline">200</strong>, we do <span class="No-Break">the following:</span><ol><li class="lower-roman">We parse the JSON response into a Python dictionary using <strong class="source-inline">response.json()</strong> and assign it <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">data</strong></span><span class="No-Break">.</span></li><li class="lower-roman"> We then retrieve the current temperature from <strong class="source-inline">data['main']['temp']</strong> and store it <span class="No-Break">in </span><span class="No-Break"><strong class="source-inline">temperature</strong></span><span class="No-Break">.</span></li><li class="lower-roman">We retrieve a weather description from <strong class="source-inline">data['weather'][0]['main']</strong> and store it <span class="No-Break">in </span><span class="No-Break"><strong class="source-inline">description</strong></span><span class="No-Break">.</span></li><li class="lower-roman">We then print the current temperature and weather description. If the weather description is <strong class="source-inline">'Thunderstorm'</strong> or (<strong class="source-inline">'Rain'</strong> and <strong class="source-inline">age &lt; 16</strong>), we print <strong class="source-inline">"NO-GO!"</strong> to the Shell, display the NO-GO animation using <strong class="source-inline">no_go.display_animation(duration=1)</strong>, and set the <strong class="source-inline">timer</strong> variable to 1 second. This is to make the total time before calling the web service 60 seconds, as the animation will go on for 59 seconds. Otherwise, we print <strong class="source-inline">"GO!"</strong> to the Shell and display the green checkmark animation using <strong class="source-inline">go.display()</strong> and then set the <strong class="source-inline">timer</strong> variable to <span class="No-Break">60 seconds.</span></li></ol></li><li class="upper-roman">If the <a id="_idIndexMarker219"/>response status code is not <strong class="source-inline">200</strong>, we print an <span class="No-Break">error message.</span></li><li class="upper-roman">We pause the execution for the value of <strong class="source-inline">timer</strong> seconds using <strong class="source-inline">time.sleep(timer)</strong>. This will result in a 60-second delay between calls to the OpenWeather <span class="No-Break">web service.</span></li></ol></li> <li>We save our code as <strong class="source-inline">go-no-go.py</strong> in the <strong class="source-inline">GO-NO-GO</strong> folder and then run it by clicking on the green run button, hitting <em class="italic">F5</em> on the keyboard, or clicking on the <strong class="bold">Run</strong> menu option at the top and then <strong class="bold">Run </strong><span class="No-Break"><strong class="bold">current script</strong></span><span class="No-Break">.</span><p class="list-inset">Upon running the code, we will observe the dot-matrix screen of our Sense HAT (or emulator) displaying either a green checkmark or a flashing red X sign, indicating a GO or NO-GO condition for a game at Fenway Park in Boston. As illustrated in <span class="No-Break"><em class="italic">Figure 2</em></span><em class="italic">.20</em>, the current status is a NO-GO for the game involving our players (under 16 years of age) due to the presence <span class="No-Break">of thunderstorms:</span></p></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer050">
<img alt="Figure 2.20 – Screenshot of the GO-NO-GO application using the Sense HAT emulator" height="769" src="image/B21282_02_20.jpg" width="1211"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 2.20 – Screenshot of the GO-NO-GO application using the Sense HAT emulator</p>
<p>As mentioned earlier, the flexibility of our code allows for easy expansion of the decision-making logic. In addition to weather data, we can extend our application to consider <a id="_idIndexMarker220"/>other factors such as wind speed, humidity, or any on-site sensor readings. By integrating sensors placed directly at the baseball diamond, we can gather real-time data on soil moisture levels or other measurements of interest. This sensor information can then be broadcasted to the internet, enabling us to seamlessly integrate it into <span class="No-Break">our application.</span></p>
<p>To make our application more dynamic, we can incorporate scheduling information to determine the age of players scheduled to play at a specific baseball diamond at any given time. By extracting this information from a spreadsheet or an online repository, we can automate the process of obtaining player age data and other game-related information such as whether the game is a playoff game. This allows our application to dynamically adjust its decision-making process, ensuring a more accurate GO or <span class="No-Break">NO-GO decision.</span></p>
<h2 id="_idParaDest-46"><a id="_idTextAnchor046"/>Building other GO-NO-GO applications</h2>
<p>The GO-NO-GO application marks the last project in the book we will build using the Sense HAT. As we have demonstrated, the combination of the Raspberry Pi and Sense HAT makes <a id="_idIndexMarker221"/>for a powerful IoT device. It’s not hard to imagine how we could easily change our baseball GO-NO-GO application for other scenarios. The following are a few examples of other GO-NO-GO applications we <span class="No-Break">could build:</span></p>
<ul>
<li><strong class="bold">Flight status checker</strong>: By integrating with a flight tracking API, we could build an application that can display a GO or NO-GO status for a <span class="No-Break">specific flight.</span></li>
<li><strong class="bold">Traffic condition monitor</strong>: Utilizing a traffic data API, we could build an application that can assess current traffic conditions on a specific route or at a <span class="No-Break">particular location.</span></li>
<li><strong class="bold">Event availability indicator</strong>: Integrating with an event ticketing API, we could build an application that can determine the availability of tickets for a <span class="No-Break">desired event.</span></li>
<li><strong class="bold">Public transportation tracker</strong>: By connecting to a public transportation API, we could build an application that can provide real-time updates on the status of buses, trains, or other forms of <span class="No-Break">public transportation.</span></li>
</ul>
<p>The GO-NO-GO IoT application is but a glimpse into our vast potential in utilizing web services with IoT. With the Raspberry Pi and Sense HAT, our potential expands to diverse IoT applications, monitoring various data and fostering innovation beyond <span class="No-Break">weather-related scenarios.</span></p>
<h1 id="_idParaDest-47"><a id="_idTextAnchor047"/>Summary</h1>
<p>In this chapter, we explored the world of web services development using Raspberry Pi and Sense HAT. We began by learning about web services and wrote web services code. With our newfound knowledge, we created our first IoT application: a scrolling stock ticker. By connecting to the Alpha Vantage web service, we retrieved real-time stock information and displayed it in a continuous scrolling format on the Sense HAT’s dot-matrix display. This project demonstrated the ease of connecting to web services to obtain <span class="No-Break">useful information.</span></p>
<p>Integrating web services with devices such as the Raspberry Pi is a skill crucial in today’s tech industry. By handling data from sources such as Alpha Vantage and OpenWeather and displaying it on the Sense HAT, we’ve bridged theory with practical application. This knowledge enhances our project capabilities and professional skills, positioning us well in the IoT and <span class="No-Break">data-driven domains.</span></p>
<p>We then ventured into building a weather display application. By leveraging the OpenWeather API, we obtained live weather information and transformed it into a scrolling message on the Sense HAT. We then took our development to the next step and used it to create a decision-making GO-NO-GO IoT application. In the GO-NO-GO application, we used weather conditions and player age as criteria to determine whether a baseball game should proceed (GO) or be canceled (NO-GO). We did so by displaying visual indicators such as a green checkmark or a flashing red X sign on the <span class="No-Break">Sense HAT.</span></p>
<p>In the next chapter, we will explore IoT applications that involve physical interactions – specifically, the integration of motors. By incorporating motor control into our projects, we can create dynamic and interactive experiences that bridge the gap between the digital and <span class="No-Break">physical worlds.</span></p>
</div>
</div></body></html>