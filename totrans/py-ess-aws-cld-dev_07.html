<html><head></head><body>
<div><div><h1 class="chapter-number" id="_idParaDest-73"><a id="_idTextAnchor011"/>7</h1>
<h1 id="_idParaDest-74">Monitoring Applications via CloudWatch</h1>
<p>In this chapter, we are going to learn about one of the important AWS services, CloudWatch. CloudWatch<a id="_idIndexMarker218"/> is a serverless service that allows you to collect and monitor application logs within AWS. It has extensive integrations with most AWS services. When you start using any AWS service, it helps to observe an application via CloudWatch tools.</p>
<p>In this chapter, we are going to cover the following topics:</p>
<ul>
<li>What is CloudWatch?</li>
<li>Collecting Lambda Logs via CloudWatch</li>
<li>CloudWatch logs Insights</li>
<li>CloudWatch alarms</li>
</ul>
<h1 id="_idParaDest-75">What is CloudWatch?</h1>
<p>When you <a id="_idIndexMarker219"/>deploy any application, it is important to track that it meets the set expectations regarding availability, performance, and stability. It is possible an issue may have occurred in the application. It’s important to note that some of the AWS services could be down or run incorrectly. This is a very bad experience from a customer’s point of view, and it would be better to observe these issues before the customer finds out. If you service an application via AWS, you need to use CloudWatch to monitor your applications to observe how they behave.</p>
<p>CloudWatch is a monitoring service in AWS; it provides different features to observe an application. The features<a id="_idIndexMarker220"/> of CloudWatch are as follows:</p>
<ul>
<li>Collecting and storing logs from AWS services such as Lambda and EC2.</li>
<li>Providing a dashboard to monitor metrics and logs.</li>
<li>The ability to create an alarm. For example, if an application has consumed significant memory on a server, you can create an alarm in order to be notified.</li>
<li>The ability to correlate different metrics. For example, you can aggregate EC2 memory logs and CPU logs to have a better overall view of a situation.</li>
<li>The detection of anomalous behavior with the machine learning-based CloudWatch <a id="_idIndexMarker221"/>anomaly detection feature.</li>
</ul>
<h1 id="_idParaDest-76">Collecting Lambda logs via CloudWatch</h1>
<p>In this topic, we are <a id="_idIndexMarker222"/>going to deploy a simple Python function in <a id="_idIndexMarker223"/>order to investigate logs via the CloudWatch service. Let’s do so step by step:</p>
<ol>
<li>Create a Lambda function in AWS. In <a href="B19195_03.xhtml#_idTextAnchor002"><em class="italic">Chapter 3</em></a>, where we covered Lambda, the basic steps of the Lambda deployment were explained. Hence, here, we will provide a summary of the Lambda steps. The name of the Lambda function is <code>TestLogs</code>:</li>
</ol>
<div><div><img alt="" height="380" src="img/Figure_7.01_B19195.jpg" width="810"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.1 – Creating a Lambda function</p>
<ol>
<li value="2">The<a id="_idIndexMarker224"/> Lambda function creates a basic template, like <a id="_idIndexMarker225"/>the following:</li>
</ol>
<div><div><img alt="" height="583" src="img/Figure_7.02_B19195.jpg" width="1038"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.2 – The Lambda template</p>
<ol>
<li value="3">Copy the following code block to the handler:<pre class="console">
import json
import os
def lambda_handler(event, context):
    print('ENVIRONMENT VARIABLES')
    print(os.environ)
    return {
        'statusCode': 200,
        'body': json.dumps('Hello from Lambda!')
    }</pre></li>
</ol>
<p><code>os</code> will import the operating system module; hence, you can see the environment variables via the logging print (<code>os.environ</code>) variable. Once we add the code block, Lambda code should be seen as follows:</p>
<div><div><img alt="" height="500" src="img/Figure_7.03_B19195.jpg" width="1098"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.3 – Lambda with logs</p>
<ol>
<li value="4">Next, click<a id="_idIndexMarker226"/> the <strong class="bold">Deploy</strong> button to deploy the<a id="_idIndexMarker227"/> latest changes to Lambda and click the <strong class="bold">Test</strong> button. After testing the Lambda function, you are able to see the execution results:</li>
</ol>
<div><div><img alt="" height="769" src="img/Figure_7.04_B19195.jpg" width="978"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.4 – The execution results</p>
<p>Let’s use the <a id="_idIndexMarker228"/>CloudWatch service to investigate the<a id="_idIndexMarker229"/> logs:</p>
<ol>
<li>Open the CloudWatch service from AWS Management Console:</li>
</ol>
<div><div><img alt="" height="452" src="img/Figure_7.05_B19195.jpg" width="1416"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.5 – The CloudWatch service</p>
<ol>
<li value="2">Click <strong class="bold">Log groups</strong> under the <strong class="bold">Logs</strong> dropdown in the left pane:</li>
</ol>
<div><div><img alt="" height="541" src="img/Figure_7.06_B19195.jpg" width="474"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.6 – The CloudWatch log group</p>
<ol>
<li value="3">Once you click <strong class="bold">Log groups</strong>, you will see a list. This list represents the running AWS services that create a log. In this list, find the Lambda function that you run:</li>
</ol>
<div><div><img alt="" height="926" src="img/Figure_7.07_B19195.jpg" width="1112"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.7 – Log list</p>
<ol>
<li value="4">Click <strong class="bold">/aws/lambda/TestLogs</strong>. The new page consists of the logs that Lambda creates. You can <a id="_idIndexMarker230"/>see a log stream. When the <a id="_idIndexMarker231"/>Lambda function runs, the logs are created in this list. At the beginning of the list, you can see the most up-to-date logs:</li>
</ol>
<div><div><img alt="" height="584" src="img/Figure_7.08_B19195.jpg" width="1101"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.8 – The log page for Lambda</p>
<p>Let’s click the latest link under <strong class="bold">Log stream</strong>:</p>
<div><div><img alt="" height="278" src="img/Figure_7.09_B19195.jpg" width="1100"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.9 – Log stream</p>
<p>After clicking the link, you can see the detailed logs that Lambda creates:</p>
<div><div><img alt="" height="481" src="img/Figure_7.10_B19195.jpg" width="1100"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.10 – Lambda logs</p>
<p>This list shows a<a id="_idIndexMarker232"/> summary view of the log. When you click<a id="_idIndexMarker233"/> the down arrow to the left, the panel will open and you can investigate the detailed logs. In Lambda, we have logged the operating system variables for Lambda. Hence, you will see some details for that, such as region, memory size, and language:</p>
<div><div><img alt="" height="394" src="img/Figure_7.11_B19195.jpg" width="1100"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.11 – Log details</p>
<p>Congratulations! You are able to investigate Lambda logs via the CloudWatch service. It is simple to use CloudWatch to investigate a log for any AWS service. In the next topic, we will learn some tricks regarding filtering logs.</p>
<h1 id="_idParaDest-77">CloudWatch Log Insights</h1>
<p>In this <a id="_idIndexMarker234"/>topic, we will take a look at <strong class="bold">Log Insights</strong>. If you have massive lines of logs, it is not easy to search and find the respective log that you are searching for. For this use case, Log Insights comes into play. CloudWatch Log Insights allows you to search logs with the<a id="_idIndexMarker235"/> filtering feature. Let’s see how Log Insights helps us to search logs:</p>
<ol>
<li>Click <strong class="bold">Log Insights</strong> under the <strong class="bold">Logs</strong> dropdown in the left pane:</li>
</ol>
<div><div><img alt="" height="432" src="img/Figure_7.12_B19195.jpg" width="1019"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.12 – Log Insights</p>
<ol>
<li value="2">Select the log that you want to investigate. In the previous example, we ran the TestLogs Lambda function, and I am also selecting that one here:</li>
</ol>
<div><div><img alt="" height="453" src="img/Figure_7.13_B19195.jpg" width="894"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.13 – The Log Insights window</p>
<ol>
<li value="3">Once you select it, you can see the default query:</li>
</ol>
<div><div><img alt="" height="628" src="img/Figure_7.14_B19195.jpg" width="822"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.14 – The Log Insights filter</p>
<ol>
<li value="4">Click <a id="_idIndexMarker236"/>the <code>fields</code> represents the columns that will be listed, whereas the <code>sort</code> keyword indicates the sorting method, and you can see only 20 records with the <code>limit</code> keyword:</li>
</ol>
<div><div><img alt="" height="880" src="img/Figure_7.15_B19195.jpg" width="1101"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.15 – Logs</p>
<p>Let’s add one more filter to search for a keyword within the message. You can use the following query format:</p>
<pre class="console">
fields @timestamp, @message
| filter @message like /AWS_DEFAULT_REGION/
| sort @timestamp desc
| limit 20</pre>
<p>With this query, we search for logs that contain <code>AWS_DEFAULT_REGION</code>. Paste that and click <strong class="bold">Run query</strong> again. After running the query, you will see that the message lines are reduced:</p>
<div><div><img alt="" height="724" src="img/Figure_7.16_B19195.jpg" width="1101"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.16 – Filtered logs</p>
<p>When you expand the message, you will find what you searched for – in this case, <code>AWS_DEFAULT_REGION</code>:</p>
<div><div><img alt="" height="739" src="img/Figure_7.17_B19195.jpg" width="1148"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.17 – Detailed logs</p>
<p>As you can see, Log <a id="_idIndexMarker237"/>Insights is very helpful to search and filter logs within a massive log block. In the next topic, we will take a look at how to create an alarm.</p>
<h1 id="_idParaDest-78">CloudWatch alarms</h1>
<p>AWS has more than 100 services, and it is not easy to control the behavior of all the services. You need to be informed if some AWS services achieve a specific metric. In <a href="B19195_04.xhtml#_idTextAnchor006"><em class="italic">Chapter 4</em></a>, we covered how to create a server with an EC2 service. For example, you define a server for an EC2 service, and sometimes, its CPU usage is more than 90%, causing some performance problems. Another example would be to add a notification if you exceed a specific cost in AWS. For these kinds of scenarios, you can define a metric, and if the metric is reached, you will be notified via email.</p>
<p>In this topic, we are<a id="_idIndexMarker238"/> going to create an alarm to notify us if AWS cost exceeds $10 in a month. Let’s implement the application:</p>
<ol>
<li>Click <strong class="bold">In alarm</strong> under the <strong class="bold">Alarms</strong> dropdown in the <strong class="bold">CloudWatch</strong> pane:</li>
</ol>
<div><div><img alt="" height="385" src="img/Figure_7.18_B19195.jpg" width="1080"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.18 – In alarm</p>
<ol>
<li value="2">Click <strong class="bold">Create Alarm</strong>. You can click either the button to the right or the one at the bottom:</li>
</ol>
<div><div><img alt="" height="251" src="img/Figure_7.19_B19195.jpg" width="1044"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.19 – Creating an alarm</p>
<ol>
<li value="3">Click<a id="_idIndexMarker239"/> the <strong class="bold">Select </strong><strong class="bold">metric</strong> button:</li>
</ol>
<div><div><img alt="" height="304" src="img/Figure_7.20_B19195.jpg" width="784"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.20 – Select metric</p>
<ol>
<li value="4">Once you <a id="_idIndexMarker240"/>click the <strong class="bold">Select metric</strong> button, you will be able to see a list of categories with which to narrow down your metric:</li>
</ol>
<div><div><img alt="" height="340" src="img/Figure_7.21_B19195.jpg" width="1210"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.21 – Metric types</p>
<p>In this list, you can see different types of metrics. <strong class="bold">Billing</strong> allows you to define cost-related metrics, while <strong class="bold">Lambda</strong> allows you to define Lambda-related metrics. In this example, we are going to define a monthly budget for our AWS account. The aim is to receive an alarm if our monthly cost exceeds a specific threshold:</p>
<ol>
<li>Click <strong class="bold">Billing</strong> from the categories:</li>
</ol>
<div><div><img alt="" height="338" src="img/Figure_7.22_B19195.jpg" width="604"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.22 – The Billing category</p>
<ol>
<li value="2">Click <strong class="bold">Total Estimated Charge</strong>. The <a id="_idIndexMarker241"/>intention is to define a metric if your total monthly AWS cost exceeds a target budget:</li>
</ol>
<div><div><img alt="" height="172" src="img/Figure_7.23_B19195.jpg" width="603"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.23 – Total Estimated Change</p>
<ol>
<li value="3">From the list, select <strong class="bold">USD</strong> and click <strong class="bold">Select metric</strong>. The currency type may vary, depending on your AWS account:</li>
</ol>
<div><div><img alt="" height="152" src="img/Figure_7.24_B19195.jpg" width="742"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.24 – The currency type</p>
<p>On the next <a id="_idIndexMarker242"/>screen, go to the <strong class="bold">Define the threshold value</strong> field. For this example, I added <strong class="bold">10</strong>, which means that if the total cost is greater than $10 for a month, an alarm will be activated. In this panel, you can also change the currency type, calculation type, and so on. In this case, the most important value is defining the target budget to receive an alarm. After you have done that, click the <strong class="bold">Next</strong> button:</p>
<div><div><img alt="" height="653" src="img/Figure_7.25_B19195.jpg" width="787"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.25 – Threshold value</p>
<ol>
<li value="4">In the next<a id="_idIndexMarker243"/> panel, we are going to define the alarm endpoint. In this case, we have selected the <strong class="bold">Create new topic</strong> radio button. <strong class="bold">Simple Notification Service</strong> (<strong class="bold">SNS</strong>) is<a id="_idIndexMarker244"/> used to communicate between services and end users. This is a choice under <strong class="bold">Send a notification to the following SNS</strong>. Once we select <strong class="bold">Create new topic</strong>, we can define an email address in the <strong class="bold">Email endpoints that will receive the notification…</strong> section. SNS is an access point to filter messages in order to send them to different subscribers such as Lambda or email. You can keep the topic name as is; it is the same as the SNS topic name. When completed, click <strong class="bold">Create topic</strong>:</li>
</ol>
<div><div><img alt="" height="534" src="img/Figure_7.26_B19195.jpg" width="595"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.26 – Receiver</p>
<ol>
<li value="5">After <strong class="bold">Create topic</strong> is <a id="_idIndexMarker245"/>clicked, AWS will create an endpoint in order to send an email:</li>
</ol>
<div><div><img alt="" height="443" src="img/Figure_7.27_B19195.jpg" width="602"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.27 – Creating an endpoint</p>
<p>Now, you have an endpoint, and you can proceed by clicking the <strong class="bold">Next</strong> button.</p>
<ol>
<li value="6">The next step is to<a id="_idIndexMarker246"/> define the alarm name. In this case, I named it <code>BillingAlarmGreaterThan10</code>, since it sends an alarm if the billing cost goes above than $10:</li>
</ol>
<div><div><img alt="" height="322" src="img/Figure_7.28_B19195.jpg" width="602"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.28 – Naming the alarm</p>
<ol>
<li value="7">The next step is to review the input and click <strong class="bold">Create alarm</strong>:</li>
</ol>
<div><div><img alt="" height="737" src="img/Figure_7.29_B19195.jpg" width="409"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.29 – Creating the alarm</p>
<ol>
<li value="8">If you successfully<a id="_idIndexMarker247"/> create the alarm, you will be redirected to the <strong class="bold">Alarm</strong> list to see the alarm that you created. We can see the alarm as follows:</li>
</ol>
<div><div><img alt="" height="148" src="img/Figure_7.30_B19195.jpg" width="490"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 7.30 – The billing alarm type</p>
<p>In this topic, we have created an alarm. An alarm is useful if we need to create a notification for the AWS service behaviors. This example will send a notification if, for example, we reach the defined cost limit.</p>
<h1 id="_idParaDest-79">Summary</h1>
<p>In this chapter, we learned about the AWS CloudWatch service and how to investigate service logs in AWS. CloudWatch is very useful for logging; it also allows you to define some metrics and alarms to monitor services. In the following chapter, we will take a look at database operations within AWS.</p>
</div>
</div></body></html>