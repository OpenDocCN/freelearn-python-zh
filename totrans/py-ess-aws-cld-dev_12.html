<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer330">
<h1 class="chapter-number" id="_idParaDest-111"><a id="_idTextAnchor016"/>12</h1>
<h1 id="_idParaDest-112">Reference Project on AWS</h1>
<p>In this chapter, we are going to create a sample application with Python on AWS. This is the final chapter of the book. We have learned about different AWS services and implemented sample Python applications with these services. In this chapter, we will use multiple services to create an end-to-end <span class="No-Break">Python application.</span></p>
<p>The chapter covers the <span class="No-Break">following topics:</span></p>
<ul>
<li>What have <span class="No-Break">we learned?</span></li>
<li>Introducing the end-to-end <span class="No-Break">Python application</span></li>
<li>The coding of the <span class="No-Break">Python application</span></li>
</ul>
<h1 id="_idParaDest-113">What have we learned?</h1>
<p>AWS has more than a hundred services, and we have learned about the important Python-related services. Let’s walk through <span class="No-Break">those services:</span></p>
<ul>
<li><strong class="bold">Lambda</strong>: Lambda <a id="_idIndexMarker397"/>is a cloud computing service that allows you to run Python applications. You don’t need to<a id="_idTextAnchor017"/> provision any server; Lambda manages <span class="No-Break">the infrastructure.</span></li>
<li><strong class="bold">EC2</strong>: EC2<a id="_idIndexMarker398"/> provides a server machine in the cloud. You can create a server and install the required applications, or whatever <span class="No-Break">you want.</span></li>
<li><strong class="bold">Elastic Beanstalk</strong>: Elastic Beanstalk is <a id="_idIndexMarker399"/>used to deploy Python-based <span class="No-Break">web applications.</span></li>
<li><strong class="bold">CloudWatch</strong>: CloudWatch<a id="_idIndexMarker400"/> is a logging and monitoring service on AWS. You can easily track <span class="No-Break">your services.</span></li>
<li><strong class="bold">RDS</strong>: RDS is<a id="_idIndexMarker401"/> a relational database service on AWS. If you need a database, you can easily create it without managing <span class="No-Break">the server.</span></li>
<li><strong class="bold">API Gateway</strong>: API Gateway <a id="_idIndexMarker402"/>is used to create, maintain, and publish an application <span class="No-Break">programming interface.</span></li>
<li><strong class="bold">DynamoDB</strong>: DynamoDB is a<a id="_idIndexMarker403"/> key-value database that is used to query and store billions of records on AWS. It is<a id="_idIndexMarker404"/> also a <span class="No-Break"><strong class="bold">NoSQL database</strong></span><span class="No-Break">.</span></li>
<li><strong class="bold">AWS Glue</strong>: AWS Glue<a id="_idIndexMarker405"/> is a data integration service that is used <span class="No-Break">for ETL.</span></li>
</ul>
<h1 id="_idParaDest-114">Introducing the Python application</h1>
<p>Let us<a id="_idIndexMarker406"/> understand the high-level architecture of the <span class="No-Break">Python application:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer301">
<img alt="" height="259" src="image/Figure_12.01_B19195.jpg" width="1050"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.1 – Project architecture</p>
<p>The application collects images to be stored in S3 buckets. The API gateway is used for integration between clients and the Lambda service. Lambda retrieves the information and puts data <span class="No-Break">into S3.</span></p>
<h1 id="_idParaDest-115">The coding of the Python application</h1>
<p>Let’s<a id="_idIndexMarker407"/> implement the application step <span class="No-Break">by step.</span></p>
<h2 id="_idParaDest-116">Creating S3 buckets to store images</h2>
<p>In this subsection, we<a id="_idIndexMarker408"/> are going to create an S3 bucket to hold images, which is uploaded via API Gateway. S3 will store the image and provide it <span class="No-Break">whenever requested:</span></p>
<ol>
<li>Create a bucket and click the <strong class="bold">Create bucket</strong> button at the bottom of <span class="No-Break">the page:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer302">
<img alt="" height="474" src="image/Figure_12.02_B19195.jpg" width="1047"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.2 – An S3 bucket</p>
<ol>
<li value="2">We filled in the <strong class="bold">Bucket name</strong> field as <strong class="source-inline">python-book-image</strong>; you can use whatever you want. After adding the <strong class="bold">bucket name</strong>, click <strong class="bold">Create bucket</strong> to create a <span class="No-Break">new bucket:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer303">
<img alt="" height="549" src="image/Figure_12.03_B19195.jpg" width="1101"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.3 – Bucket configuration</p>
<p>We have<a id="_idIndexMarker409"/> created an <span class="No-Break">S3 bucket.</span></p>
<h2 id="_idParaDest-117">Creating Lambda code</h2>
<p>In this<a id="_idIndexMarker410"/> subsection, we are going to implement a Lambda code that accepts the image upload request from API Gateway and stores the image in the <span class="No-Break">S3 bucket:</span></p>
<ol>
<li>Create a Lambda function via the AWS Management Console. You can see the <strong class="bold">Function name</strong> field of the Lambda function and <strong class="bold">Runtime</strong> in the following screenshot within the Lambda <span class="No-Break">creation step:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer304">
<img alt="" height="524" src="image/Figure_12.04_B19195.jpg" width="610"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.4 – The Lambda function</p>
<ol>
<li value="2">Paste <a id="_idIndexMarker411"/>the following code to the Lambda <span class="No-Break">code source:</span><pre class="console">
import boto3
import base64
import json
def lambda_handler(event, context):
    try:
        s3 = boto3.resource('s3')
        s1 = json.dumps(event)
        data = json.loads(s1)
        image = data['image_base64']
        file_content = base64.b64decode(image)
        bucket = data['bucket']
        s3_file_name = data['s3_file_name']
        obj = s3.Object(bucket,s3_file_name)
        obj.put(Body=file_content)
        return 'Image is uploaded to ' + bucket
    except BaseException as exc:
        return exc</pre></li>
<li>Once <a id="_idIndexMarker412"/>pasted, deploy the Lambda function by clicking the <span class="No-Break"><strong class="bold">Deploy</strong></span><span class="No-Break"> button:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer305">
<img alt="" height="293" src="image/Figure_12.05_B19195.jpg" width="980"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.5 – Lambda deployment</p>
<p>Let’s take a look at the code details. First, we import the <strong class="source-inline">json</strong>, <strong class="source-inline">base64</strong>, and <strong class="source-inline">boto3</strong> libraries. The <strong class="source-inline">json</strong> library is used to parse data, which comes in JSON format, and <strong class="source-inline">boto3</strong> is used to upload files to S3 as well as generate a URL for retrieving the file. In addition to that, <strong class="source-inline">base64</strong> is used to decode and encode the image.</p>
<p>The following lines of code are parsing the parameters and decoding the contents of the image to store S3. Hence, we can use the bucket name and S3 filename. The<a id="_idIndexMarker413"/> bucket name is represented as <strong class="source-inline">bucket</strong> in the code and the S3 filename is represented as <strong class="source-inline">s3_file_name</strong>:</p>
<pre class="console">
        s1 = json.dumps(event)
        data = json.loads(s1)
        image = data['image_base64']
        file_content = base64.b64decode(image)
        bucket = data['bucket']
        s3_file_name = data['s3_file_name']</pre>
<p>Once we have parameters, we can use the <strong class="source-inline">boto3</strong> library to upload the file from local to S3:</p>
<pre class="console">
        obj = s3.Object(bucket,s3_file_name)
        obj.put(Body=file_content)</pre>
<p>We have implemented the code for the application. In order to run this code, we have to create permissions, the steps for which are explained in the <span class="No-Break">next subsection.</span></p>
<h2 id="_idParaDest-118">Creating permissions for the services</h2>
<p>We are<a id="_idIndexMarker414"/> now going to create permissions to upload a file to S3 and call a Lambda function from <span class="No-Break">API Gateway:</span></p>
<ol>
<li>Open the IAM role and create a new role <span class="No-Break">for </span><span class="No-Break"><strong class="bold">Lambda</strong></span><span class="No-Break">:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer306">
<img alt="" height="372" src="image/Figure_12.06_B19195.jpg" width="968"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.6 – Creating a role</p>
<ol>
<li value="2">Select <strong class="bold">AmazonS3FullAccess</strong> and <strong class="bold">CloudWatchFullAccess</strong> from<a id="_idIndexMarker415"/> <span class="No-Break">the list:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer307">
<img alt="" height="526" src="image/Figure_12.07_B19195.jpg" width="652"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.7 – Adding policies</p>
<ol>
<li value="3">Click the <span class="No-Break"><strong class="bold">Next</strong></span><span class="No-Break"> button:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer308">
<img alt="" height="250" src="image/Figure_12.08_B19195.jpg" width="698"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.8 – Adding policies</p>
<ol>
<li value="4">Add<a id="_idIndexMarker416"/> the <span class="No-Break">role name:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer309">
<img alt="" height="521" src="image/Figure_12.09_B19195.jpg" width="826"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.9 – Naming the role</p>
<ol>
<li value="5">Complete creating the role by clicking the <strong class="bold">Create </strong><span class="No-Break"><strong class="bold">role</strong></span><span class="No-Break"> button:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer310">
<img alt="" height="79" src="image/Figure_12.10_B19195.jpg" width="648"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.10 – Create role</p>
<ol>
<li value="6">After <a id="_idIndexMarker417"/>creating the role, you will see the role on <span class="No-Break">the list:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer311">
<img alt="" height="538" src="image/Figure_12.11_B19195.jpg" width="678"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.11 – The role on the list</p>
<p>In this subsection, we have created a role to be used in the Lambda function to execute the code. Let’s attach the role to the <span class="No-Break">Lambda function.</span></p>
<h2 id="_idParaDest-119">Attaching the role to the Lambda function</h2>
<p>We are now <a id="_idIndexMarker418"/>going to add permissions to the <span class="No-Break">Lambda function:</span></p>
<ol>
<li>Open the Lambda function and click <strong class="bold">Permissions</strong> under the <span class="No-Break"><strong class="bold">Configuration</strong></span><span class="No-Break"> tab:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer312">
<img alt="" height="408" src="image/Figure_12.12_B19195.jpg" width="832"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.12 – Lambda permissions</p>
<ol>
<li value="2">Edit the permissions and select <strong class="bold">LambdaPolicy</strong> from the existing role. This role was created in the <span class="No-Break">previous subsection:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer313">
<img alt="" height="399" src="image/Figure_12.13_B19195.jpg" width="639"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.13 – Attaching the permission</p>
<p>With this <a id="_idIndexMarker419"/>configuration, Lambda is able to execute the code. It is time to start implementing API Gateway, which will use a Lambda function as a <span class="No-Break">backed function.</span></p>
<h2 id="_idParaDest-120">Creating an API gateway to upload the image</h2>
<p>In this step, we are <a id="_idIndexMarker420"/>going to create an API gateway to upload <span class="No-Break">the image:</span></p>
<ol>
<li>Open the API Gateway service and create a <span class="No-Break">REST API:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer314">
<img alt="" height="232" src="image/Figure_12.14_B19195.jpg" width="1086"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.14 – Creating a REST API</p>
<ol>
<li value="2">Provide a name for the REST API. We will use the name <strong class="source-inline">UploadImageToS3</strong> in <span class="No-Break">this </span><span class="No-Break"><a id="_idIndexMarker421"/></span><span class="No-Break">subsection:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer315">
<img alt="" height="236" src="image/Figure_12.15_B19195.jpg" width="833"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.15 – Naming the REST API</p>
<ol>
<li value="3">In the <strong class="bold">Actions</strong> drop-down list, click <span class="No-Break"><strong class="bold">Create Method</strong></span><span class="No-Break">:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer316">
<img alt="" height="356" src="image/Figure_12.16_B19195.jpg" width="692"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.16 – Creating a method</p>
<ol>
<li value="4">Select <strong class="bold">POST</strong> from the <span class="No-Break">available options:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer317">
<img alt="" height="566" src="image/Figure_12.17_B19195.jpg" width="406"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.17 – The POST method</p>
<ol>
<li value="5">We <a id="_idIndexMarker422"/>will use <strong class="bold">Lambda Function</strong> as the integration type and scroll down to <span class="No-Break">click </span><span class="No-Break"><strong class="bold">Save</strong></span><span class="No-Break">:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer318">
<img alt="" height="450" src="image/Figure_12.18_B19195.jpg" width="1099"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.18 – Lambda integration</p>
<ol>
<li value="6">The <a id="_idIndexMarker423"/>API is ready to use. Enable the CORS policy as we explained in <a href="B19195_09.xhtml#_idTextAnchor013"><span class="No-Break"><em class="italic">Chapter 9</em></span></a>, then click <strong class="bold">Deploy API</strong> in the <strong class="bold">Actions</strong> <span class="No-Break">drop-down list:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer319">
<img alt="" height="651" src="image/Figure_12.19_B19195.jpg" width="534"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.19 – Deploying the API</p>
<ol>
<li value="7">We are ready to deploy the API. Add a stage name and <span class="No-Break">click </span><span class="No-Break"><strong class="bold">Deploy</strong></span><span class="No-Break">:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer320">
<img alt="" height="472" src="image/Figure_12.20_B19195.jpg" width="1002"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.20 – Naming the stage</p>
<ol>
<li value="8">In <a id="_idIndexMarker424"/>the <strong class="bold">Export</strong> tab, there are multiple alternatives to call the API. We will use Postman to call the API. <strong class="bold">Postman</strong> is a<a id="_idIndexMarker425"/> platform that allows you to build and test the API. For this application, you can also test another platform such as <strong class="bold">Swagger</strong>. Postman<a id="_idIndexMarker426"/> is an easy way to use and test an API. In the following subsection, we will explain how to download and use it. Since it is simpler in terms of installation and use, I will proceed <span class="No-Break">with Postman.</span></li>
</ol>
<p>Select the <strong class="bold">Export as Swagger + Postman Extensions</strong> icon; you can export and download either the JSON or YAML format:</p>
<div>
<div class="IMG---Figure" id="_idContainer321">
<img alt="" height="399" src="image/Figure_12.21_B19195.jpg" width="1101"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.21 – Exporting the API</p>
<p>This <a id="_idIndexMarker427"/>file will be used in Postman to test <span class="No-Break">the API.</span></p>
<h2 id="_idParaDest-121">Using Postman to test the API</h2>
<p>We have <a id="_idIndexMarker428"/>completed the implementation. In <a id="_idIndexMarker429"/>this step, we are going to test the API <span class="No-Break">via Postman:</span></p>
<ol>
<li>Download and install Postman from<a id="_idIndexMarker430"/> the following <span class="No-Break">website: </span><a href="https://www.postman.com/"><span class="No-Break">https://www.postman.com/</span></a><span class="No-Break">.</span></li>
<li>In the Postman application, click the <span class="No-Break"><strong class="bold">Import</strong></span><span class="No-Break"> button:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer322">
<img alt="" height="190" src="image/Figure_12.22_B19195.jpg" width="736"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.22 – Importing the API</p>
<ol>
<li value="3">Select the JSON file that we downloaded within API Gateway and <span class="No-Break">click </span><span class="No-Break"><strong class="bold">Open</strong></span><span class="No-Break">:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer323">
<img alt="" height="676" src="image/Figure_12.23_B19195.jpg" width="1013"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.23 – Importing the JSON</p>
<ol>
<li value="4">You <a id="_idIndexMarker431"/>will see confirmation of the <a id="_idIndexMarker432"/>API. Click <strong class="bold">Import</strong> as a <span class="No-Break">final step:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer324">
<img alt="" height="674" src="image/Figure_12.24_B19195.jpg" width="1037"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.24 – Import the JSON</p>
<ol>
<li value="5">Once you <a id="_idIndexMarker433"/>have imported the API, you <a id="_idIndexMarker434"/>are ready to call the API. In the <strong class="bold">POST</strong> section, select the <strong class="bold">raw</strong> request type with <strong class="bold">JSON</strong> <span class="No-Break">as follows:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer325">
<img alt="" height="378" src="image/Figure_12.25_B19195.jpg" width="1102"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.25 – The raw parameter</p>
<ol>
<li value="6">Paste the following JSON to call <span class="No-Break">the API:</span><pre class="console">
{
     "image_base64":"iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1H      AwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII=",
     "bucket":"python-book-image",
     "s3_file_name":"image.jpeg"
}</pre></li>
</ol>
<p>Let’s break <a id="_idIndexMarker435"/>down the JSON file:</p>
<ul>
<li><strong class="source-inline">image_base64</strong> represents the <strong class="source-inline">base64</strong> code of a sample image that is going to be saved to the S3 bucket. You can also convert a sample image to <strong class="source-inline">base64</strong> code with libraries and <span class="No-Break">online converters.</span></li>
<li>The <strong class="source-inline">bucket</strong> parameter represents the location of the <span class="No-Break">S3 bucket.</span></li>
<li><strong class="source-inline">s3_file_name</strong> represents the name and extension of <span class="No-Break">the content.</span></li>
</ul>
<p>This can be<a id="_idIndexMarker436"/> seen in the following screenshot:</p>
<div>
<div class="IMG---Figure" id="_idContainer326">
<img alt="" height="334" src="image/Figure_12.26_B19195.jpg" width="1101"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.26 – Request JSON</p>
<ol>
<li value="7">Click the <strong class="bold">Send</strong> button in order to call the API. Once you click it, you can see the response of <span class="No-Break">the API:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer327">
<img alt="" height="230" src="image/Figure_12.27_B19195.jpg" width="724"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.27 – JSON response</p>
<p>We <a id="_idIndexMarker437"/>have successfully called the API. Let’s <a id="_idIndexMarker438"/>check with the S3 bucket whether the image is uploaded.</p>
<ol>
<li value="8">Open the <strong class="source-inline">python-book-image</strong> S3 bucket and see the uploaded <span class="No-Break"><strong class="source-inline">jpeg</strong></span><span class="No-Break"> file:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer328">
<img alt="" height="575" src="image/Figure_12.28_B19195.jpg" width="734"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.28 – S3 content</p>
<ol>
<li value="9">Download<a id="_idIndexMarker439"/> the file and check <a id="_idIndexMarker440"/>the sample image. When you download it, you will see a very small point. You can make it bigger by clicking the <strong class="bold">+</strong> magnifying glass icon on your image viewer to see <span class="No-Break">it clearly:</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer329">
<img alt="" height="434" src="image/Figure_12.29_B19195.jpg" width="918"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.29 – The image</p>
<p>Congratulations! You <a id="_idIndexMarker441"/>have successfully <a id="_idIndexMarker442"/>uploaded the image using API Gateway, Lambda, and <span class="No-Break">S3 services.</span></p>
<h1 id="_idParaDest-122">Summary</h1>
<p>In this chapter, we have created an application to upload an image using API Gateway, Lambda, and S3. The image is converted to <strong class="source-inline">base64</strong> to be stored in S3. One of the best aspects of using Lambda, S3, and API Gateway is that we haven’t provisioned any server. Lambda, S3, and API Gateway are serverless and we don’t need to manage the infrastructure. AWS manages and handles it <span class="No-Break">for you.</span></p>
<p>We have finished all the chapters and learned how to use the most common AWS services with Python. I hope all the chapters have provided you with good knowledge about AWS. Following this, you can implement more complex Python projects with these services as well as use more services <span class="No-Break">within AWS.</span></p>
</div>
</div></body></html>