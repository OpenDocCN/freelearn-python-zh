<html><head></head><body>
<div><div><h1 class="chapter-number" id="_idParaDest-111"><a id="_idTextAnchor016"/>12</h1>
<h1 id="_idParaDest-112">Reference Project on AWS</h1>
<p>In this chapter, we are going to create a sample application with Python on AWS. This is the final chapter of the book. We have learned about different AWS services and implemented sample Python applications with these services. In this chapter, we will use multiple services to create an end-to-end Python application.</p>
<p>The chapter covers the following topics:</p>
<ul>
<li>What have we learned?</li>
<li>Introducing the end-to-end Python application</li>
<li>The coding of the Python application</li>
</ul>
<h1 id="_idParaDest-113">What have we learned?</h1>
<p>AWS has more than a hundred services, and we have learned about the important Python-related services. Let’s walk through those services:</p>
<ul>
<li><strong class="bold">Lambda</strong>: Lambda <a id="_idIndexMarker397"/>is a cloud computing service that allows you to run Python applications. You don’t need to<a id="_idTextAnchor017"/> provision any server; Lambda manages the infrastructure.</li>
<li><strong class="bold">EC2</strong>: EC2<a id="_idIndexMarker398"/> provides a server machine in the cloud. You can create a server and install the required applications, or whatever you want.</li>
<li><strong class="bold">Elastic Beanstalk</strong>: Elastic Beanstalk is <a id="_idIndexMarker399"/>used to deploy Python-based web applications.</li>
<li><strong class="bold">CloudWatch</strong>: CloudWatch<a id="_idIndexMarker400"/> is a logging and monitoring service on AWS. You can easily track your services.</li>
<li><strong class="bold">RDS</strong>: RDS is<a id="_idIndexMarker401"/> a relational database service on AWS. If you need a database, you can easily create it without managing the server.</li>
<li><strong class="bold">API Gateway</strong>: API Gateway <a id="_idIndexMarker402"/>is used to create, maintain, and publish an application programming interface.</li>
<li><strong class="bold">DynamoDB</strong>: DynamoDB is a<a id="_idIndexMarker403"/> key-value database that is used to query and store billions of records on AWS. It is<a id="_idIndexMarker404"/> also a <strong class="bold">NoSQL database</strong>.</li>
<li><strong class="bold">AWS Glue</strong>: AWS Glue<a id="_idIndexMarker405"/> is a data integration service that is used for ETL.</li>
</ul>
<h1 id="_idParaDest-114">Introducing the Python application</h1>
<p>Let us<a id="_idIndexMarker406"/> understand the high-level architecture of the Python application:</p>
<div><div><img alt="" height="259" src="img/Figure_12.01_B19195.jpg" width="1050"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.1 – Project architecture</p>
<p>The application collects images to be stored in S3 buckets. The API gateway is used for integration between clients and the Lambda service. Lambda retrieves the information and puts data into S3.</p>
<h1 id="_idParaDest-115">The coding of the Python application</h1>
<p>Let’s<a id="_idIndexMarker407"/> implement the application step by step.</p>
<h2 id="_idParaDest-116">Creating S3 buckets to store images</h2>
<p>In this subsection, we<a id="_idIndexMarker408"/> are going to create an S3 bucket to hold images, which is uploaded via API Gateway. S3 will store the image and provide it whenever requested:</p>
<ol>
<li>Create a bucket and click the <strong class="bold">Create bucket</strong> button at the bottom of the page:</li>
</ol>
<div><div><img alt="" height="474" src="img/Figure_12.02_B19195.jpg" width="1047"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.2 – An S3 bucket</p>
<ol>
<li value="2">We filled in the <code>python-book-image</code>; you can use whatever you want. After adding the <strong class="bold">bucket name</strong>, click <strong class="bold">Create bucket</strong> to create a new bucket:</li>
</ol>
<div><div><img alt="" height="549" src="img/Figure_12.03_B19195.jpg" width="1101"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.3 – Bucket configuration</p>
<p>We have<a id="_idIndexMarker409"/> created an S3 bucket.</p>
<h2 id="_idParaDest-117">Creating Lambda code</h2>
<p>In this<a id="_idIndexMarker410"/> subsection, we are going to implement a Lambda code that accepts the image upload request from API Gateway and stores the image in the S3 bucket:</p>
<ol>
<li>Create a Lambda function via the AWS Management Console. You can see the <strong class="bold">Function name</strong> field of the Lambda function and <strong class="bold">Runtime</strong> in the following screenshot within the Lambda creation step:</li>
</ol>
<div><div><img alt="" height="524" src="img/Figure_12.04_B19195.jpg" width="610"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.4 – The Lambda function</p>
<ol>
<li value="2">Paste <a id="_idIndexMarker411"/>the following code to the Lambda code source:<pre class="console">
import boto3
import base64
import json
def lambda_handler(event, context):
    try:
        s3 = boto3.resource('s3')
        s1 = json.dumps(event)
        data = json.loads(s1)
        image = data['image_base64']
        file_content = base64.b64decode(image)
        bucket = data['bucket']
        s3_file_name = data['s3_file_name']
        obj = s3.Object(bucket,s3_file_name)
        obj.put(Body=file_content)
        return 'Image is uploaded to ' + bucket
    except BaseException as exc:
        return exc</pre></li>
<li>Once <a id="_idIndexMarker412"/>pasted, deploy the Lambda function by clicking the <strong class="bold">Deploy</strong> button:</li>
</ol>
<div><div><img alt="" height="293" src="img/Figure_12.05_B19195.jpg" width="980"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.5 – Lambda deployment</p>
<p>Let’s take a look at the code details. First, we import the <code>json</code>, <code>base64</code>, and <code>boto3</code> libraries. The <code>json</code> library is used to parse data, which comes in JSON format, and <code>boto3</code> is used to upload files to S3 as well as generate a URL for retrieving the file. In addition to that, <code>base64</code> is used to decode and encode the image.</p>
<p>The following lines of code are parsing the parameters and decoding the contents of the image to store S3. Hence, we can use the bucket name and S3 filename. The<a id="_idIndexMarker413"/> bucket name is represented as <code>bucket</code> in the code and the S3 filename is represented as <code>s3_file_name</code>:</p>
<pre class="console">
        s1 = json.dumps(event)
        data = json.loads(s1)
        image = data['image_base64']
        file_content = base64.b64decode(image)
        bucket = data['bucket']
        s3_file_name = data['s3_file_name']</pre>
<p>Once we have parameters, we can use the <code>boto3</code> library to upload the file from local to S3:</p>
<pre class="console">
        obj = s3.Object(bucket,s3_file_name)
        obj.put(Body=file_content)</pre>
<p>We have implemented the code for the application. In order to run this code, we have to create permissions, the steps for which are explained in the next subsection.</p>
<h2 id="_idParaDest-118">Creating permissions for the services</h2>
<p>We are<a id="_idIndexMarker414"/> now going to create permissions to upload a file to S3 and call a Lambda function from API Gateway:</p>
<ol>
<li>Open the IAM role and create a new role for <strong class="bold">Lambda</strong>:</li>
</ol>
<div><div><img alt="" height="372" src="img/Figure_12.06_B19195.jpg" width="968"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.6 – Creating a role</p>
<ol>
<li value="2">Select <strong class="bold">AmazonS3FullAccess</strong> and <strong class="bold">CloudWatchFullAccess</strong> from<a id="_idIndexMarker415"/> the list:</li>
</ol>
<div><div><img alt="" height="526" src="img/Figure_12.07_B19195.jpg" width="652"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.7 – Adding policies</p>
<ol>
<li value="3">Click the <strong class="bold">Next</strong> button:</li>
</ol>
<div><div><img alt="" height="250" src="img/Figure_12.08_B19195.jpg" width="698"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.8 – Adding policies</p>
<ol>
<li value="4">Add<a id="_idIndexMarker416"/> the role name:</li>
</ol>
<div><div><img alt="" height="521" src="img/Figure_12.09_B19195.jpg" width="826"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.9 – Naming the role</p>
<ol>
<li value="5">Complete creating the role by clicking the <strong class="bold">Create </strong><strong class="bold">role</strong> button:</li>
</ol>
<div><div><img alt="" height="79" src="img/Figure_12.10_B19195.jpg" width="648"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.10 – Create role</p>
<ol>
<li value="6">After <a id="_idIndexMarker417"/>creating the role, you will see the role on the list:</li>
</ol>
<div><div><img alt="" height="538" src="img/Figure_12.11_B19195.jpg" width="678"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.11 – The role on the list</p>
<p>In this subsection, we have created a role to be used in the Lambda function to execute the code. Let’s attach the role to the Lambda function.</p>
<h2 id="_idParaDest-119">Attaching the role to the Lambda function</h2>
<p>We are now <a id="_idIndexMarker418"/>going to add permissions to the Lambda function:</p>
<ol>
<li>Open the Lambda function and click <strong class="bold">Permissions</strong> under the <strong class="bold">Configuration</strong> tab:</li>
</ol>
<div><div><img alt="" height="408" src="img/Figure_12.12_B19195.jpg" width="832"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.12 – Lambda permissions</p>
<ol>
<li value="2">Edit the permissions and select <strong class="bold">LambdaPolicy</strong> from the existing role. This role was created in the previous subsection:</li>
</ol>
<div><div><img alt="" height="399" src="img/Figure_12.13_B19195.jpg" width="639"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.13 – Attaching the permission</p>
<p>With this <a id="_idIndexMarker419"/>configuration, Lambda is able to execute the code. It is time to start implementing API Gateway, which will use a Lambda function as a backed function.</p>
<h2 id="_idParaDest-120">Creating an API gateway to upload the image</h2>
<p>In this step, we are <a id="_idIndexMarker420"/>going to create an API gateway to upload the image:</p>
<ol>
<li>Open the API Gateway service and create a REST API:</li>
</ol>
<div><div><img alt="" height="232" src="img/Figure_12.14_B19195.jpg" width="1086"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.14 – Creating a REST API</p>
<ol>
<li value="2">Provide a name for the REST API. We will use the name <code>UploadImageToS3</code> in this <a id="_idIndexMarker421"/>subsection:</li>
</ol>
<div><div><img alt="" height="236" src="img/Figure_12.15_B19195.jpg" width="833"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.15 – Naming the REST API</p>
<ol>
<li value="3">In the <strong class="bold">Actions</strong> drop-down list, click <strong class="bold">Create Method</strong>:</li>
</ol>
<div><div><img alt="" height="356" src="img/Figure_12.16_B19195.jpg" width="692"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.16 – Creating a method</p>
<ol>
<li value="4">Select <strong class="bold">POST</strong> from the available options:</li>
</ol>
<div><div><img alt="" height="566" src="img/Figure_12.17_B19195.jpg" width="406"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.17 – The POST method</p>
<ol>
<li value="5">We <a id="_idIndexMarker422"/>will use <strong class="bold">Lambda Function</strong> as the integration type and scroll down to click <strong class="bold">Save</strong>:</li>
</ol>
<div><div><img alt="" height="450" src="img/Figure_12.18_B19195.jpg" width="1099"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.18 – Lambda integration</p>
<ol>
<li value="6">The <a id="_idIndexMarker423"/>API is ready to use. Enable the CORS policy as we explained in <a href="B19195_09.xhtml#_idTextAnchor013"><em class="italic">Chapter 9</em></a>, then click <strong class="bold">Deploy API</strong> in the <strong class="bold">Actions</strong> drop-down list:</li>
</ol>
<div><div><img alt="" height="651" src="img/Figure_12.19_B19195.jpg" width="534"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.19 – Deploying the API</p>
<ol>
<li value="7">We are ready to deploy the API. Add a stage name and click <strong class="bold">Deploy</strong>:</li>
</ol>
<div><div><img alt="" height="472" src="img/Figure_12.20_B19195.jpg" width="1002"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.20 – Naming the stage</p>
<ol>
<li value="8">In <a id="_idIndexMarker424"/>the <strong class="bold">Export</strong> tab, there are multiple alternatives to call the API. We will use Postman to call the API. <strong class="bold">Postman</strong> is a<a id="_idIndexMarker425"/> platform that allows you to build and test the API. For this application, you can also test another platform such as <strong class="bold">Swagger</strong>. Postman<a id="_idIndexMarker426"/> is an easy way to use and test an API. In the following subsection, we will explain how to download and use it. Since it is simpler in terms of installation and use, I will proceed with Postman.</li>
</ol>
<p>Select the <strong class="bold">Export as Swagger + Postman Extensions</strong> icon; you can export and download either the JSON or YAML format:</p>
<div><div><img alt="" height="399" src="img/Figure_12.21_B19195.jpg" width="1101"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.21 – Exporting the API</p>
<p>This <a id="_idIndexMarker427"/>file will be used in Postman to test the API.</p>
<h2 id="_idParaDest-121">Using Postman to test the API</h2>
<p>We have <a id="_idIndexMarker428"/>completed the implementation. In <a id="_idIndexMarker429"/>this step, we are going to test the API via Postman:</p>
<ol>
<li>Download and install Postman from<a id="_idIndexMarker430"/> the following website: <a href="https://www.postman.com/">https://www.postman.com/</a>.</li>
<li>In the Postman application, click the <strong class="bold">Import</strong> button:</li>
</ol>
<div><div><img alt="" height="190" src="img/Figure_12.22_B19195.jpg" width="736"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.22 – Importing the API</p>
<ol>
<li value="3">Select the JSON file that we downloaded within API Gateway and click <strong class="bold">Open</strong>:</li>
</ol>
<div><div><img alt="" height="676" src="img/Figure_12.23_B19195.jpg" width="1013"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.23 – Importing the JSON</p>
<ol>
<li value="4">You <a id="_idIndexMarker431"/>will see confirmation of the <a id="_idIndexMarker432"/>API. Click <strong class="bold">Import</strong> as a final step:</li>
</ol>
<div><div><img alt="" height="674" src="img/Figure_12.24_B19195.jpg" width="1037"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.24 – Import the JSON</p>
<ol>
<li value="5">Once you <a id="_idIndexMarker433"/>have imported the API, you <a id="_idIndexMarker434"/>are ready to call the API. In the <strong class="bold">POST</strong> section, select the <strong class="bold">raw</strong> request type with <strong class="bold">JSON</strong> as follows:</li>
</ol>
<div><div><img alt="" height="378" src="img/Figure_12.25_B19195.jpg" width="1102"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.25 – The raw parameter</p>
<ol>
<li value="6">Paste the following JSON to call the API:<pre class="console">
{
     "image_base64":"iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1H      AwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII=",
     "bucket":"python-book-image",
     "s3_file_name":"image.jpeg"
}</pre></li>
</ol>
<p>Let’s break <a id="_idIndexMarker435"/>down the JSON file:</p>
<ul>
<li><code>image_base64</code> represents the <code>base64</code> code of a sample image that is going to be saved to the S3 bucket. You can also convert a sample image to <code>base64</code> code with libraries and online converters.</li>
<li>The <code>bucket</code> parameter represents the location of the S3 bucket.</li>
<li><code>s3_file_name</code> represents the name and extension of the content.</li>
</ul>
<p>This can be<a id="_idIndexMarker436"/> seen in the following screenshot:</p>
<div><div><img alt="" height="334" src="img/Figure_12.26_B19195.jpg" width="1101"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.26 – Request JSON</p>
<ol>
<li value="7">Click the <strong class="bold">Send</strong> button in order to call the API. Once you click it, you can see the response of the API:</li>
</ol>
<div><div><img alt="" height="230" src="img/Figure_12.27_B19195.jpg" width="724"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.27 – JSON response</p>
<p>We <a id="_idIndexMarker437"/>have successfully called the API. Let’s <a id="_idIndexMarker438"/>check with the S3 bucket whether the image is uploaded.</p>
<ol>
<li value="8">Open the <code>python-book-image</code> S3 bucket and see the uploaded <code>jpeg</code> file:</li>
</ol>
<div><div><img alt="" height="575" src="img/Figure_12.28_B19195.jpg" width="734"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.28 – S3 content</p>
<ol>
<li value="9">Download<a id="_idIndexMarker439"/> the file and check <a id="_idIndexMarker440"/>the sample image. When you download it, you will see a very small point. You can make it bigger by clicking the <strong class="bold">+</strong> magnifying glass icon on your image viewer to see it clearly:</li>
</ol>
<div><div><img alt="" height="434" src="img/Figure_12.29_B19195.jpg" width="918"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 12.29 – The image</p>
<p>Congratulations! You <a id="_idIndexMarker441"/>have successfully <a id="_idIndexMarker442"/>uploaded the image using API Gateway, Lambda, and S3 services.</p>
<h1 id="_idParaDest-122">Summary</h1>
<p>In this chapter, we have created an application to upload an image using API Gateway, Lambda, and S3. The image is converted to <code>base64</code> to be stored in S3. One of the best aspects of using Lambda, S3, and API Gateway is that we haven’t provisioned any server. Lambda, S3, and API Gateway are serverless and we don’t need to manage the infrastructure. AWS manages and handles it for you.</p>
<p>We have finished all the chapters and learned how to use the most common AWS services with Python. I hope all the chapters have provided you with good knowledge about AWS. Following this, you can implement more complex Python projects with these services as well as use more services within AWS.</p>
</div>
</div></body></html>