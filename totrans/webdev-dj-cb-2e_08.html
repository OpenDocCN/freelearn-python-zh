<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Hierarchical Structures</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating hierarchical categories</li><li class="listitem" style="list-style-type: disc">Creating a category administration interface with django-mptt-admin</li><li class="listitem" style="list-style-type: disc">Creating a category administration interface with django-mptt-tree-editor</li><li class="listitem" style="list-style-type: disc">Rendering categories in a template</li><li class="listitem" style="list-style-type: disc">Using a single selection field to choose a category in forms</li><li class="listitem" style="list-style-type: disc">Using a checkbox list to choose multiple categories in forms</li></ul></div><div><div><div><div><h1 class="title"><a id="ch08lvl1sec77"/>Introduction</h1></div></div></div><p>Whether you build your own forum, threaded comments, or categorization system, there will be a moment when you need to save hierarchical structures in the database. Although the tables of relational databases (such as MySQL and PostgreSQL) are of a flat manner, there is a<a class="indexterm" id="id385"/> fast and effective way to store hierarchical structures. It is called <strong>Modified Preorder Tree Traversal</strong> (<strong>MPTT</strong>). MPTT allows you to read the tree structures without recursive calls to the database.</p><p>At first, let's get familiar with the terminology of the tree structures. A tree data structure is a recursive<a class="indexterm" id="id386"/> collection of nodes, starting at the root node and having references to child nodes. There is a restriction that no node references back to create a loop and no reference is duplicated. The following are some other terms to learn:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Parent</strong> is<a class="indexterm" id="id387"/> any node that is referencing to the child nodes.</li><li class="listitem" style="list-style-type: disc"><strong>Descendants</strong> are <a class="indexterm" id="id388"/>the nodes that can be reached by recursively traversing from a parent to its children. Therefore, the node's descendants will be its child, the child's children, and so on.</li><li class="listitem" style="list-style-type: disc"><strong>Ancestors</strong> are<a class="indexterm" id="id389"/> the nodes that can be reached by recursively traversing from a child to its parent. Therefore, the node's ancestors will be its parent, the parent's parent, and so on up to the root.</li><li class="listitem" style="list-style-type: disc"><strong>Siblings</strong> are<a class="indexterm" id="id390"/> the nodes with the same parent.</li><li class="listitem" style="list-style-type: disc"><strong>Leaf</strong> is <a class="indexterm" id="id391"/>a node without children.</li></ul></div><p>Now, I'll <a class="indexterm" id="id392"/>explain how MPTT works. Imagine that you lay out your tree horizontally with the root node at the top. Each node in the tree has left and right values. Imagine them as small left and right handles on the left and right-hand side of the node. Then, you walk (traverse) around the tree counter-clockwise, starting from the root node and mark each left or right value that you find with a number: 1, 2, 3, and so on. It will look similar to the following diagram:</p><div><img alt="Introduction" src="img/B04912_08_01.jpg"/></div><p>In the database table of this hierarchical structure, you will have a title, left value, and right value for each node.</p><p>Now, if you want to get the subtree of the <strong>B</strong> node with <strong>2</strong> as the left value and <strong>11</strong> as the right value, you will have to select all the nodes that have a left value between <strong>2</strong> and <strong>11</strong>. They are <strong>C</strong>, <strong>D</strong>, <strong>E</strong>, and <strong>F</strong>.</p><p>To get all the ancestors of the <strong>D</strong> node with <strong>5</strong> as the left value and <strong>10</strong> as the right value, you have to select all the nodes that have a left value that is less than <strong>5</strong> and a right value that is more than <strong>10</strong>. These would be <strong>B</strong> and <strong>A</strong>.</p><p>To get the number of the descendants for a node, you can use the following formula: <em>descendants = (right - left - 1) / 2</em></p><p>Therefore, the number of descendants for the <strong>B</strong> node can be calculated as shown in the following: <em>(11 - 2 - 1) / 2 = 4</em></p><p>If we want to attach the <strong>E</strong> node to the <strong>C</strong> node, we will have to update the left and right values only for the nodes of their first common ancestor, the <strong>B</strong> node. Then, the <strong>C</strong> node will still have <strong>3</strong> as the left value; the <strong>E</strong> node will get <strong>4</strong> as the left value and <strong>5</strong> as the right value; the right value of the <strong>C</strong> node will become <strong>6</strong>; the left value of the <strong>D</strong> node will become <strong>7</strong>; the left<a class="indexterm" id="id393"/> value of the <strong>F</strong> node will stay <strong>8</strong>; and the others will also remain the same.</p><p>Similarly, there are other tree-related operations with nodes in MPTT. It might be too complicated to manage all this by yourself for every hierarchical structure in your project. Luckily, there is a Django app called <strong>django-mptt</strong> that handles these algorithms and provides an easy API to<a class="indexterm" id="id394"/> handle the tree structures. In this chapter, you will learn how to use this helper app.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec78"/>Creating hierarchical categories</h1></div></div></div><p>To illustrate <a class="indexterm" id="id395"/>how to deal with MPTT, we will create a <code class="literal">movies</code> app that will have a hierarchical <code class="literal">Category</code> model and a <code class="literal">Movie</code> model with a many-to-many relationship with the categories.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec260"/>Getting ready</h2></div></div></div><p>To get started, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Install <code class="literal">django-mptt</code> in your virtual environment using the following command:<div><pre class="programlisting">
<strong>(myproject_env)$ pip install django-mptt</strong>
</pre></div></li><li class="listitem">Then, create a <code class="literal">movies</code> app. Add the <code class="literal">movies</code> app as well as <code class="literal">mptt</code> to <code class="literal">INSTALLED_APPS</code> in the settings, as follows:<div><pre class="programlisting">
<strong># conf/base.py or settings.py</strong>
INSTALLED_APPS = (
    # ...
    "mptt",
    "movies",
)</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec261"/>How to do it...</h2></div></div></div><p>We will create <a class="indexterm" id="id396"/>a hierarchical <code class="literal">Category</code> model and a <code class="literal">Movie</code> model, which will have a many-to-many relationship with the categories, as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">Open the <code class="literal">models.py</code> file and add a <code class="literal">Category</code> model that extends <code class="literal">mptt.models.MPTTModel</code> and <code class="literal">CreationModificationDateMixin</code>, which we defined in <a class="link" href="ch02.html" title="Chapter 2. Database Structure">Chapter 2</a>, <em>Database Structure</em>. In addition to the fields coming from the mixins, the <code class="literal">Category</code> model will need to have a <code class="literal">parent</code> field of the <code class="literal">TreeForeignKey</code> type and a <code class="literal">title</code> field:<div><pre class="programlisting">
<strong># movies/models.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.db import models
from django.utils.translation import ugettext_lazy as _
from django.utils.encoding import \
    python_2_unicode_compatible
from utils.models import CreationModificationDateMixin
<strong>from mptt.models import MPTTModel</strong>
<strong>from mptt.fields import TreeForeignKey, TreeManyToManyField</strong>


@python_2_unicode_compatible
class Category(<strong>MPTTModel</strong>, CreationModificationDateMixin):
<strong>    parent = TreeForeignKey("self", blank=True, null=True)</strong>
    title = models.CharField(_("Title"), max_length=200)

    def __str__(self):
        return self.title

    class Meta:
<strong>        ordering = ["tree_id", "lft"]</strong>
        verbose_name = _("Category")
        verbose_name_plural = _("Categories")</pre></div></li><li class="listitem">Then, create the <code class="literal">Movie</code> model that extends <code class="literal">CreationModificationDateMixin</code>. Also, include a <code class="literal">title</code> field and a categories field of the <code class="literal">TreeManyToManyField</code> type:<div><pre class="programlisting">@python_2_unicode_compatible
class Movie(CreationModificationDateMixin):
    title = models.CharField(_("Title"), max_length=255)
<strong>    categories = TreeManyToManyField(Category,</strong>
<strong>        verbose_name=_("Categories"))</strong>

    def __str__(self):
        return self.title

    class Meta:
        verbose_name = _("Movie")
        verbose_name_plural = _("Movies")</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec262"/>How it works...</h2></div></div></div><p>The <code class="literal">MPTTModel</code> mixin will add the <code class="literal">tree_id</code>, <code class="literal">lft</code>, <code class="literal">rght</code>, and <code class="literal">level</code> fields to the <code class="literal">Category</code> model. The <code class="literal">tree_id</code> field is used as you can have multiple trees in the database table. In fact, each root category is saved in a separate tree. The <code class="literal">lft</code> and <code class="literal">rght</code> fields store the left and right values used in the MPTT algorithms. The <code class="literal">level</code> field stores the node's<a class="indexterm" id="id397"/> depth in the tree. The root node will be level <code class="literal">0</code>.</p><p>Besides new fields, the <code class="literal">MPTTModel</code> mixin adds methods to navigate through the tree structure similar to how you would navigate through DOM elements using JavaScript. These methods are listed as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">If you want to get the ancestors of a category, use the following code:<div><pre class="programlisting">ancestor_categories = category.get_ancestors(
    ascending=False,
    include_self=False,
)</pre></div><p>The ascending parameter defines from which direction to read the nodes (the default is <code class="literal">False</code>). The <code class="literal">include_self</code> parameter defines whether to include the category itself in <code class="literal">QuerySet</code> (the default is <code class="literal">False</code>).</p></li><li class="listitem" style="list-style-type: disc">To just get the root category, use the following code:<div><pre class="programlisting">root = category.get_root()</pre></div></li><li class="listitem" style="list-style-type: disc">If you want to get the direct children of a category, use the following code:<div><pre class="programlisting">children = category.get_children()</pre></div></li><li class="listitem" style="list-style-type: disc">To get all the descendants of a category, use the following code:<div><pre class="programlisting">descendants = category.get_descendants(include_self=False)</pre></div><p>Here, the <code class="literal">include_self</code> parameter again defines whether or not to include the category itself in <code class="literal">QuerySet</code>.</p></li><li class="listitem" style="list-style-type: disc">If you want to get the descendant count without querying the database, use the following code:<div><pre class="programlisting">descendants_count = category.get_descendant_count()</pre></div></li><li class="listitem" style="list-style-type: disc">To get all the siblings, call the following method:<div><pre class="programlisting">siblings = category.get_siblings(include_self=False)</pre></div><p>Root categories are considered to be siblings of other root categories.</p></li><li class="listitem" style="list-style-type: disc">To just get the previous and next siblings, call the following methods:<div><pre class="programlisting">previous_sibling = category.get_previous_sibling()
next_sibling = category.get_next_sibling()</pre></div></li><li class="listitem" style="list-style-type: disc">Also, there are methods to check whether the category is a root, child, or leaf, as follows:<div><pre class="programlisting">category.is_root_node()
category.is_child_node()
category.is_leaf_node()</pre></div></li></ul></div><p>All these methods<a class="indexterm" id="id398"/> can be used either in the views, templates, or management commands. If you want to manipulate the tree structure, you can also use the <code class="literal">insert_at()</code> and <code class="literal">move_to()</code> methods. In this case, you can read about them<a class="indexterm" id="id399"/> and the tree manager methods at <a class="ulink" href="http://django-mptt.github.io/django-mptt/models.html">http://django-mptt.github.io/django-mptt/models.html</a>.</p><p>In the preceding models, we used <code class="literal">TreeForeignKey</code> and <code class="literal">TreeManyToManyField</code>. These are similar to <code class="literal">ForeignKey</code> and <code class="literal">ManyToManyField</code>, except that they show the choices indented in hierarchies in the administration interface.</p><p>Also, note that in the <code class="literal">Meta</code> class of the <code class="literal">Category</code> model, we order the categories by <code class="literal">tree_id</code> and then by the <code class="literal">lft</code> value in order to show the categories naturally in the tree structure.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec263"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Creating a model mixin to handle creation and modification dates</em> recipe in <a class="link" href="ch02.html" title="Chapter 2. Database Structure">Chapter 2</a>, <em>Database Structure</em></li><li class="listitem" style="list-style-type: disc">The <em>Structuring the page menu</em> recipe in <a class="link" href="ch07.html" title="Chapter 7. Django CMS">Chapter 7</a>, <em>Django CMS</em></li><li class="listitem" style="list-style-type: disc">The <em>Creating a category administration interface with django-mptt-admin</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec79"/>Creating a category administration interface with django-mptt-admin</h1></div></div></div><p>The <code class="literal">django-mptt</code> app<a class="indexterm" id="id400"/> comes<a class="indexterm" id="id401"/> with a simple model administration mixin that allows you to create the tree structure and list it with indentation. To reorder trees, you need to either create this functionality yourself or use a third-party solution. Currently, there are two apps that can help you to create a draggable administration interface for hierarchical models. One of them is <code class="literal">django-mptt-admin</code>. Let's take a look at it in this recipe.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec264"/>Getting ready</h2></div></div></div><p>First, we<a class="indexterm" id="id402"/> need to<a class="indexterm" id="id403"/> have the <code class="literal">django-mptt-admin</code> app installed by performing the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">To start, install the app in your virtual environment using the following command:<div><pre class="programlisting">
<strong>(myproject_env)$ pip install django-mptt-admin</strong>
</pre></div></li><li class="listitem">Then, put it in <code class="literal">INSTALLED_APPS</code> in the settings, as follows:<div><pre class="programlisting">
<strong># conf/base.py or settings.py</strong>
INSTALLED_APPS = (
    # ...
    "django_mptt_admin"
)</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec265"/>How to do it...</h2></div></div></div><p>Create an administration interface for the <code class="literal">Category</code> model that extends <code class="literal">DjangoMpttAdmin</code> instead of <code class="literal">admin.ModelAdmin</code>, as follows:</p><div><pre class="programlisting">
<strong># movies/admin.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.contrib import admin
<strong>from django_mptt_admin.admin import DjangoMpttAdmin</strong>
from .models import Category

class CategoryAdmin(<strong>DjangoMpttAdmin</strong>):
    list_display = ["title", "created", "modified"]
    list_filter = ["created"]

admin.site.register(Category, CategoryAdmin)</pre></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec266"/>How it works...</h2></div></div></div><p>The administration interface for the categories will have two modes: Tree view and Grid view. The Tree view looks similar to the following screenshot:</p><div><img alt="How it works..." src="img/B04912_08_02.jpg"/></div><p>The <a class="indexterm" id="id404"/>Tree view <a class="indexterm" id="id405"/>uses the jqTree jQuery library for node manipulation. You can expand and collapse categories for a better overview. To reorder them or change the dependencies, you can drag and drop the titles in this list view. During reordering, the user interface looks similar to the following screenshot:</p><div><img alt="How it works..." src="img/B04912_08_03.jpg"/></div><div><div><h3 class="title"><a id="note04"/>Note</h3><p>Note that any usual list-related settings such as <code class="literal">list_display</code> or <code class="literal">list_filter</code> will be ignored.</p></div></div><p>If you <a class="indexterm" id="id406"/>want to filter <a class="indexterm" id="id407"/>categories, sort or filter them by a specific field, or apply admin actions, you can switch to the Grid view, which shows the default category change list.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec267"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Creating hierarchical categories</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Creating a category administration interface with django-mptt-tree-editor</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec80"/>Creating a category administration interface with django-mptt-tree-editor</h1></div></div></div><p>If you <a class="indexterm" id="id408"/>want to <a class="indexterm" id="id409"/>use the common functionality of the change list, such as columns, admin actions, editable fields, or filters, in your administration interface as well as manipulate the tree structure in the same view, you need to use another third-party app called <code class="literal">django-mptt-tree-editor</code>. Let's see how to do that.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec268"/>Getting ready</h2></div></div></div><p>First, we need to have the <code class="literal">django-mptt-tree-editor</code> app installed. Perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">To start, install the app in your virtual environment using the following command:<div><pre class="programlisting">
<strong>(myproject_env)$ pip install django-mptt-tree-editor</strong>
</pre></div></li><li class="listitem">Then, put it in <code class="literal">INSTALLED_APPS</code> in the settings, as follows:<div><pre class="programlisting">
<strong># conf/base.py or settings.py</strong>
INSTALLED_APPS = (
    # ...
    "mptt_tree_editor"
)</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec269"/>How to do it...</h2></div></div></div><p>Create an administration interface for the <code class="literal">Category</code> model that extends <code class="literal">TreeEditor</code> instead of <code class="literal">admin.ModelAdmin</code>. Make sure that you add <code class="literal">indented_short_title</code> and <code class="literal">actions_column</code> at the beginning of the <code class="literal">list_display</code> setting, as follows:</p><div><pre class="programlisting">
<strong># movies/admin.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.contrib import admin
<strong>from mptt_tree_editor.admin import TreeEditor</strong>
from .models import Category

class CategoryAdmin(<strong>TreeEditor</strong>):
    list_display = [<strong>"indented_short_title", "actions_column</strong>", "created", "modified"]
    list_filter = ["created"]

admin.site.register(Category, CategoryAdmin)</pre></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec270"/>How it works...</h2></div></div></div><p>The<a class="indexterm" id="id410"/> administration<a class="indexterm" id="id411"/> interface for your categories now looks similar to the following screenshot:</p><div><img alt="How it works..." src="img/B04912_08_04.jpg"/></div><p>The category administration interface allows you to expand or collapse the categories. The <code class="literal">indented_short_title</code> column will either return the indented short title from the <code class="literal">short_title()</code> method of the category (if there is one) or the indented Unicode representation of the category. The column defined as <code class="literal">actions_column</code> will be rendered as a handle to reorder or restructure the categories by dragging and dropping them. As the dragging handle is in a different column than the category title, it might feel weird to work with it. During reordering, the user interface looks similar to the following screenshot:</p><div><img alt="How it works..." src="img/B04912_08_05.jpg"/></div><p>As <a class="indexterm" id="id412"/>you can<a class="indexterm" id="id413"/> see, it is possible to use all the list-related features of the default Django administration interface in the same view.</p><p>In <code class="literal">django-mptt-tree-editor</code>, the tree-editing functionality is ported from FeinCMS, another content management system made with Django.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec271"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Creating hierarchical categories</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Creating a category administration interface with django-mptt-admin</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec81"/>Rendering categories in a template</h1></div></div></div><p>Once you<a class="indexterm" id="id414"/> have created categories in your<a class="indexterm" id="id415"/> app, you need to display them hierarchically in a template. The easiest way to do this is to use the <code class="literal">{% recursetree %}</code> template tag from the <code class="literal">django-mptt</code> app. I will show you how to do that in this recipe.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec272"/>Getting ready</h2></div></div></div><p>Make sure that you have the <code class="literal">Category</code> model created and some categories entered in the database.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec273"/>How to do it...</h2></div></div></div><p>Pass <code class="literal">QuerySet</code> of your hierarchical categories to the template and then use the <code class="literal">{% recursetree %}</code> template tag as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">Create a view that loads all the categories and passes them to a template:<div><pre class="programlisting">
<strong># movies/views.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django.shortcuts import render
from .models import Category

def movie_category_list(request):
    context = {
        "categories": Category.objects.all(),
    }
    return render(
        request,
        "movies/movie_category_list.html",
        context
    )</pre></div></li><li class="listitem">Create a template with the following content:<div><pre class="programlisting">
<strong>{# templates/movies/movie_category_list.html #}</strong>
{% extends "base_single_column.html" %}
{% load i18n utility_tags <strong>mptt_tags</strong> %}

{% block sidebar %}
{% endblock %}

{% block content %}
&lt;ul class="root"&gt;
<strong>    {% recursetree categories %}</strong>
        &lt;li&gt;
            {{ <strong>node</strong>.title }}
            {% if not node.is_leaf_node %}
                &lt;ul class="children"&gt;
                    {{ <strong>children</strong> }}
                &lt;/ul&gt;
            {% endif %}
        &lt;/li&gt;
<strong>    {% endrecursetree %}</strong>
&lt;/ul&gt;
{% endblock %}</pre></div></li><li class="listitem">Create a URL rule to show the view.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec274"/>How it works...</h2></div></div></div><p>The<a class="indexterm" id="id416"/> template will be rendered as nested<a class="indexterm" id="id417"/> lists, as shown in the following screenshot:</p><div><img alt="How it works..." src="img/B04912_08_06.jpg"/></div><p>The <code class="literal">{% recursetree %}</code> block template tag takes <code class="literal">QuerySet</code> of the categories and renders the list using the template content in the tag. There are two special variables used here: <code class="literal">node</code> and <code class="literal">children</code>. The <code class="literal">node</code> variable is an instance of the <code class="literal">Category</code> model. You can use its fields or methods such as <code class="literal">{{ node.get_descendant_count }}</code>, <code class="literal">{{ node.level }}</code>, or <code class="literal">{{ node.is_root }}</code> to add specific CSS classes or HTML5 <code class="literal">data-*</code> attributes<a class="indexterm" id="id418"/> for JavaScript. The second<a class="indexterm" id="id419"/> variable, <code class="literal">children</code>, defines where to place the children of the current category.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec275"/>There's more...</h2></div></div></div><p>If your hierarchical structure is very complex, with more than 20 depth levels, it is recommended to use the non-recursive template filter, <code class="literal">tree_info</code>. For more information on how to <a class="indexterm" id="id420"/>do this, refer to the official documentation at <a class="ulink" href="http://django-mptt.github.io/django-mptt/templates.html#tree-info-filter">http://django-mptt.github.io/django-mptt/templates.html#tree-info-filter</a>.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec276"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Using HTML5 data attributes</em> recipe in <a class="link" href="ch04.html" title="Chapter 4. Templates and JavaScript">Chapter 4</a>, <em>Templates and JavaScript</em></li><li class="listitem" style="list-style-type: disc">The <em>Creating hierarchical categories</em> recipe</li><li class="listitem" style="list-style-type: disc">The <em>Using a single selection field to choose a category in forms</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec82"/>Using a single selection field to choose a category in forms</h1></div></div></div><p>What<a class="indexterm" id="id421"/> happens if you want to <a class="indexterm" id="id422"/>show category selection in<a class="indexterm" id="id423"/> a form? How will the hierarchy be presented? In <code class="literal">django-mptt</code>, there is a special <code class="literal">TreeNodeChoiceField</code> form field that you can use to show the hierarchical structures in a selected field. Let's take a look at how to do this.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec277"/>Getting ready</h2></div></div></div><p>We will start with the <code class="literal">movies</code> app that we defined in the previous recipes.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec278"/>How to do it...</h2></div></div></div><p>Let's create a form with the category field and then show it in a view:</p><div><ol class="orderedlist arabic"><li class="listitem">In the <code class="literal">forms.py</code> file<a class="indexterm" id="id424"/> of the<a class="indexterm" id="id425"/> app, create<a class="indexterm" id="id426"/> a form with a category field as follows:<div><pre class="programlisting">
<strong># movies/forms.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django import forms
from django.utils.translation import ugettext_lazy as _
from django.utils.html import mark_safe
<strong>from mptt.forms import TreeNodeChoiceField</strong>
from .models import Category

class MovieFilterForm(forms.Form):
<strong>    category = TreeNodeChoiceField(</strong>
<strong>        label=_("Category"),</strong>
<strong>        queryset=Category.objects.all(),</strong>
<strong>        required=False,</strong>
<strong>        level_indicator=mark_safe(</strong>
<strong>            "&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;"</strong>
<strong>        ),</strong>
    )</pre></div></li><li class="listitem">Then, create a URL rule, view, and template to show this form.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec279"/>How it works...</h2></div></div></div><p>The category selection will look similar to the following:</p><div><img alt="How it works..." src="img/B04912_08_07.jpg"/></div><p>The <code class="literal">TreeNodeChoiceField</code> acts like <code class="literal">ModelChoiceField</code>; however, it shows hierarchical <a class="indexterm" id="id427"/>choices as indented. By <a class="indexterm" id="id428"/>default, <code class="literal">TreeNodeChoiceField</code> represents each deeper level prefixed by three dashes, <code class="literal">---</code>. In our<a class="indexterm" id="id429"/> example, we will change the level indicator to be four nonbreakable spaces (the <code class="literal">&amp;nbsp;</code> HTML entities) by passing the <code class="literal">level_indicator</code> parameter to the field. To ensure that the nonbreakable spaces aren't escaped, we use the <code class="literal">mark_safe()</code> function.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec280"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Using a checkbox list to choose multiple categories in forms</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec83"/>Using a checkbox list to choose multiple categories in forms</h1></div></div></div><p>When more than one category needs to be selected in a form, you can use the <code class="literal">TreeNodeMultipleChoiceField</code> multiple selection field that is provided by <code class="literal">django-mptt</code>. However, multiple selection fields are not very user-friendly from GUI point of view as the <a class="indexterm" id="id430"/>user needs to<a class="indexterm" id="id431"/> scroll and hold the control keys while clicking in order to make multiple choices. That's really awful. A much better way will be to provide a checkbox list to choose the categories. In this recipe, we will create a field that allows you to show the indented checkboxes in the form.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec281"/>Getting ready</h2></div></div></div><p>We will start with the <code class="literal">movies</code> app that we defined in the previous recipes and also the <code class="literal">utils</code> app that you should have in your project.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec282"/>How to do it...</h2></div></div></div><p>To render an indented list of categories with checkboxes, create and use a new <code class="literal">MultipleChoiceTreeField</code> form field and also create an HTML template for this field. The specific template will be passed to the crispy forms layout in the form. To do this, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">In the <code class="literal">utils</code> app, add a <code class="literal">fields.py</code> file and create a <code class="literal">MultipleChoiceTreeField</code> form field that extends <code class="literal">ModelMultipleChoiceField</code>, as follows:<div><pre class="programlisting">
<strong># utils/fields.py</strong>
# -*- coding: utf-8 -*-
from __future__ import unicode_literals
from django import forms

class MultipleChoiceTreeField(
    forms.ModelMultipleChoiceField
):
    widget = forms.CheckboxSelectMultiple

    def label_from_instance(self, obj):
        return obj</pre></div></li><li class="listitem">Use the new field with the categories to choose from in the form for movie creation. Also, in the form layout, pass a custom template to the categories field, as shown in the following:<div><pre class="programlisting">
<strong># movies/forms.py</strong>
# -*- coding: UTF-8 -*-
from __future__ import unicode_literals
from django import forms
from django.utils.translation import ugettext_lazy as _
from crispy_forms.helper import FormHelper
from crispy_forms import layout, bootstrap
from utils.fields import MultipleChoiceTreeField
from .models import Movie, Category

class MovieForm(forms.ModelForm):
<strong>    categories = MultipleChoiceTreeField(</strong>
<strong>        label=_("Categories"),</strong>
<strong>        required=False,</strong>
<strong>        queryset=Category.objects.all(),</strong>
<strong>    )</strong>
    class Meta:
        model = Movie

    def __init__(self, *args, **kwargs):
        super(MovieForm, self).__init__(*args, **kwargs)
        self.helper = FormHelper()
        self.helper.form_action = ""
        self.helper.form_method = "POST"
        self.helper.layout = layout.Layout(
            layout.Field("title"),
<strong>            layout.Field(</strong>
<strong>                 "categories",</strong>
<strong>                 template="utils/"\</strong>
<strong>                     "checkbox_select_multiple_tree.html"</strong>
<strong>            ),</strong>
            bootstrap.FormActions(
                layout.Submit("submit", _("Save")),
            )
        )</pre></div></li><li class="listitem">Create<a class="indexterm" id="id432"/> a template<a class="indexterm" id="id433"/> for a Bootstrap-style checkbox list, as shown in the following:<div><pre class="programlisting">
<strong>{# templates/utils/checkbox_select_multiple_tree.html #}</strong>
{% load crispy_forms_filters %}
{% load l10n %}

&lt;div id="div_{{ field.auto_id }}" class="form-group{% if wrapper_class %} {{ wrapper_class }}{% endif %}{% if form_show_errors%}{% if field.errors %} has-error{% endif %}{% endif %}{% if field.css_classes %} {{ field.css_classes }}{% endif %}"&gt;
    {% if field.label and form_show_labels %}
        &lt;label for="{{ field.id_for_label }}" class="control-label {{ label_class }}{% if field.field.required %} requiredField{% endif %}"&gt;
            {{ field.label|safe }}{% if field.field.required %}&lt;span class="asteriskField"&gt;*&lt;/span&gt;{% endif %}
        &lt;/label&gt;
    {% endif %}
    &lt;div class="controls {{ field_class }}"{% if flat_attrs %} {{ flat_attrs|safe }}{% endif %}&gt;
        {% include 'bootstrap3/layout/field_errors_block.html' %}

<strong>        {% for choice_value, choice_instance in field.field.choices %}</strong>
            &lt;label class="checkbox{% if inline_class %}-{{ inline_class }}{% endif %} <strong>level-{{ choice_instance.level }}</strong>"&gt;
                &lt;input type="checkbox"{% if choice_value in field.value or choice_value|stringformat:"s" in field.value or choice_value|stringformat:"s" == field.value|stringformat:"s" %} checked="checked"{% endif %}

name="{{ field.html_name }}"id="id_{{ field.html_name }}_{{ forloop.counter }}"value="{{ choice_value|unlocalize }}"{{ field.field.widget.attrs|flatatt }}&gt;
                {{ choice_instance }}
            &lt;/label&gt;
<strong>        {% endfor %}</strong>
        {% include "bootstrap3/layout/help_text.html" %}
    &lt;/div&gt;
&lt;/div&gt;</pre></div></li><li class="listitem">Create<a class="indexterm" id="id434"/> a URL<a class="indexterm" id="id435"/> rule, view, and template to show the form with the <code class="literal">{% crispy %}</code> template tag. To see how to use this template tag, refer to the <em>Creating a form layout with django-crispy-forms</em> recipe in <a class="link" href="ch03.html" title="Chapter 3. Forms and Views">Chapter 3</a>, <em>Forms and Views</em>.</li><li class="listitem">Lastly, add a rule to your CSS file to indent the labels with classes, such as <code class="literal">.level-0</code>, <code class="literal">.level-1</code>, <code class="literal">.level-2</code>, and so on, by setting the margin-left parameter. Make sure that you have a reasonable amount of these CSS classes for a possible maximal depth of the tree in your context, as follows:<div><pre class="programlisting">
<strong>/* style.css */</strong>
.level-0 {
    margin-left: 0;
}
.level-1 {
    margin-left: 20px;
}
.level-2 {
    margin-left: 40px;
}</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec283"/>How it works...</h2></div></div></div><p>As <a class="indexterm" id="id436"/>a result, we get the<a class="indexterm" id="id437"/> following form:</p><div><img alt="How it works..." src="img/B04912_08_08.jpg"/></div><p>Contrary to the default behavior of Django, which hardcodes field generation in the Python code, the <code class="literal">django-crispy-forms</code> app uses templates to render the fields. You can browse them under <code class="literal">crispy_forms/templates/bootstrap3</code> and copy some of them to an analogous path in your project's template directory and overwrite them when necessary.</p><p>In our movie creation form, we pass a custom template for the categories field that will add the <code class="literal">.level-*</code> CSS classes to the <code class="literal">&lt;label&gt;</code> tag, wrapping the checkboxes. One problem <a class="indexterm" id="id438"/>with the normal <code class="literal">CheckboxSelectMultiple</code> widget is that when rendered, it only uses choice values <a class="indexterm" id="id439"/>and choice texts, and in our case, we need other properties of the category such as the depth level. To solve this, we will created a custom <code class="literal">MultipleChoiceTreeField</code> form field, which extends <code class="literal">ModelMultipleChoiceField</code> and overrides the <code class="literal">label_from_instance</code> method to return the category itself instead of its Unicode representation. The template for the field looks complicated; however, it is just a combination of a common field template (<code class="literal">crispy_forms/templates/bootstrap3/field.html</code>) and multiple checkbox field template (<code class="literal">crispy_forms/templates/bootstrap3/layout/checkboxselectmultiple.html</code>), with all the necessary Bootstrap 3 markup. We just made a slight modification to add the <code class="literal">.level-*</code> CSS classes.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec284"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Creating a form layout with django-crispy-forms</em> recipe in <a class="link" href="ch03.html" title="Chapter 3. Forms and Views">Chapter 3</a>, <em>Forms and Views</em></li><li class="listitem" style="list-style-type: disc">The <em>Using a single selection field to choose a category in forms</em> recipe</li></ul></div></div></div></body></html>