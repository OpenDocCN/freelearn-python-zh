<html><head></head><body>
<div class="Basic-Text-Frame" id="_idContainer198">
<h1 class="chapterNumber"><span class="koboSpan" id="kobo.1.1">6</span></h1>
<h1 class="chapterTitle" id="_idParaDest-173"><span class="koboSpan" id="kobo.2.1">Sharing Content on Your Website</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">In the previous chapter, you added success and error messages to your site using the Django messages framework. </span><span class="koboSpan" id="kobo.3.2">You also created an email authentication backend and added social authentication to your site using Google. </span><span class="koboSpan" id="kobo.3.3">You learned how to run your development server with HTTPS on your local machine using Django Extensions. </span><span class="koboSpan" id="kobo.3.4">You customized the social authentication pipeline to create a user profile for new users automatically.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4.1">In this chapter, you will learn how to create a JavaScript bookmarklet to share content from other sites on your website, and you will implement asynchronous browser requests in your project using JavaScript and Django.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.5.1">This chapter will cover the following topics:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.6.1">Creating many-to-many relationships</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.7.1">Customizing behavior for forms</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.8.1">Using JavaScript with Django</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.9.1">Building a JavaScript bookmarklet</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.10.1">Generating image thumbnails using </span><code class="inlineCode"><span class="koboSpan" id="kobo.11.1">easy-thumbnails</span></code></li>
<li class="bulletList"><span class="koboSpan" id="kobo.12.1">Implementing asynchronous HTTP requests with JavaScript and Django</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.13.1">Building infinite scroll pagination</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.14.1">In this chapter, you will create an image bookmarking system. </span><span class="koboSpan" id="kobo.14.2">You will create models with many-to-many relationships and customize the behavior of forms. </span><span class="koboSpan" id="kobo.14.3">You will learn how to generate image thumbnails and how to build asynchronous browser functionalities using JavaScript and Django.</span></p>
<h1 class="heading-1" id="_idParaDest-174"><span class="koboSpan" id="kobo.15.1">Functional overview</span></h1>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.16.1">Figure 6.1</span></em><span class="koboSpan" id="kobo.17.1"> shows a </span><a id="_idIndexMarker498"/><span class="koboSpan" id="kobo.18.1">representation of the views, templates, and functionalities that will be built in this chapter:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.19.1"><img alt="" role="presentation" src="../Images/B21088_06_01.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.20.1">Figure 6.1: Diagram of functionalities built in Chapter 6</span></p>
<p class="normal"><span class="koboSpan" id="kobo.21.1">In the chapter, you will implement a </span><strong class="screenText"><span class="koboSpan" id="kobo.22.1">Bookmark it</span></strong><span class="koboSpan" id="kobo.23.1"> button that will allow users to bookmark images from any website. </span><span class="koboSpan" id="kobo.23.2">You will use JavaScript to display an image selector on top of any website for users to select an image to bookmark. </span><span class="koboSpan" id="kobo.23.3">You will implement the </span><code class="inlineCode"><span class="koboSpan" id="kobo.24.1">image_create</span></code><span class="koboSpan" id="kobo.25.1"> view and a form to retrieve the image from its original source and store it on your website. </span><span class="koboSpan" id="kobo.25.2">You will build the </span><code class="inlineCode"><span class="koboSpan" id="kobo.26.1">image_detail</span></code><span class="koboSpan" id="kobo.27.1"> view to display single images and you will generate image thumbnails automatically using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.28.1">easy-thumbnails</span></code><span class="koboSpan" id="kobo.29.1"> package. </span><span class="koboSpan" id="kobo.29.2">You will also implement the </span><code class="inlineCode"><span class="koboSpan" id="kobo.30.1">image_like</span></code><span class="koboSpan" id="kobo.31.1"> view to allow users to </span><em class="italic"><span class="koboSpan" id="kobo.32.1">like/unlike</span></em><span class="koboSpan" id="kobo.33.1"> images. </span><span class="koboSpan" id="kobo.33.2">This view will handle asynchronous HTTP requests performed with JavaScript and return a response in JSON format. </span><span class="koboSpan" id="kobo.33.3">You will finally create the </span><code class="inlineCode"><span class="koboSpan" id="kobo.34.1">image_list</span></code><span class="koboSpan" id="kobo.35.1"> view to display all bookmarked images and you will implement an infinite scroll using JavaScript and Django pagination.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.36.1">The source code for this chapter can be found at </span><a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter06"><span class="url"><span class="koboSpan" id="kobo.37.1">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter06</span></span></a><span class="koboSpan" id="kobo.38.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.39.1">All Python packages used in this chapter are included in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.40.1">requirements.txt</span></code><span class="koboSpan" id="kobo.41.1"> file in the source code for the chapter. </span><span class="koboSpan" id="kobo.41.2">You can follow the instructions to install each Python package in the following sections, or you can install all requirements at once with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.42.1">python -m pip install -r requirements.txt</span></code><span class="koboSpan" id="kobo.43.1"> command.</span></p>
<h1 class="heading-1" id="_idParaDest-175"><span class="koboSpan" id="kobo.44.1">Creating an image bookmarking website</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.45.1">We will now learn how to allow users to bookmark images that they find on other websites and </span><a id="_idIndexMarker499"/><span class="koboSpan" id="kobo.46.1">share them on our site. </span><span class="koboSpan" id="kobo.46.2">To build this functionality, we will need the following elements:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.47.1">A data model to store images and related information.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.48.1">A form and a view to handle image uploads.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.49.1">JavaScript bookmarklet code that can be executed on any website. </span><span class="koboSpan" id="kobo.49.2">This code will find images across the page and allow users to select the image they want to bookmark.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.50.1">First, create a new application inside your </span><code class="inlineCode"><span class="koboSpan" id="kobo.51.1">bookmarks</span></code><span class="koboSpan" id="kobo.52.1"> project directory by running the following command in the shell prompt:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.53.1">django-admin startapp images
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.54.1">Add the new application to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.55.1">INSTALLED_APPS</span></code><span class="koboSpan" id="kobo.56.1"> setting in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.57.1">settings.py</span></code><span class="koboSpan" id="kobo.58.1"> file of the project, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.59.1">INSTALLED_APPS = [
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.60.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.61.1">'images.apps.ImagesConfig'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.62.1">,</span></strong></span><span class="koboSpan" id="kobo.63.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.64.1">We have activated the </span><code class="inlineCode"><span class="koboSpan" id="kobo.65.1">images</span></code><span class="koboSpan" id="kobo.66.1"> application in the project.</span></p>
<h2 class="heading-2" id="_idParaDest-176"><span class="koboSpan" id="kobo.67.1">Building the image model</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.68.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.69.1">models.py</span></code><span class="koboSpan" id="kobo.70.1"> file</span><a id="_idIndexMarker500"/><span class="koboSpan" id="kobo.71.1"> of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.72.1">images</span></code><span class="koboSpan" id="kobo.73.1"> application and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.74.1">from</span></span><span class="koboSpan" id="kobo.75.1"> django.conf </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.76.1">import</span></span><span class="koboSpan" id="kobo.77.1"> settings
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.78.1">from</span></span><span class="koboSpan" id="kobo.79.1"> django.db </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.80.1">import</span></span><span class="koboSpan" id="kobo.81.1"> models
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.82.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.83.1">Image</span></span><span class="koboSpan" id="kobo.84.1">(models.Model):
    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        related_name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.85.1">'images_created'</span></span><span class="koboSpan" id="kobo.86.1">,
        on_delete=models.CASCADE
    )
    title = models.CharField(max_length=</span><span class="hljs-number"><span class="koboSpan" id="kobo.87.1">200</span></span><span class="koboSpan" id="kobo.88.1">)
    slug = models.SlugField(max_length=</span><span class="hljs-number"><span class="koboSpan" id="kobo.89.1">200</span></span><span class="koboSpan" id="kobo.90.1">, blank=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.91.1">True</span></span><span class="koboSpan" id="kobo.92.1">)
    url = models.URLField(max_length=</span><span class="hljs-number"><span class="koboSpan" id="kobo.93.1">2000</span></span><span class="koboSpan" id="kobo.94.1">)
    image = models.ImageField(upload_to=</span><span class="hljs-string"><span class="koboSpan" id="kobo.95.1">'images/%Y/%m/%d/'</span></span><span class="koboSpan" id="kobo.96.1">)
    description = models.TextField(blank=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.97.1">True</span></span><span class="koboSpan" id="kobo.98.1">)
    created = models.DateTimeField(auto_now_add=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.99.1">True</span></span><span class="koboSpan" id="kobo.100.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.101.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.102.1">Meta</span></span><span class="koboSpan" id="kobo.103.1">:
        indexes = [
            models.Index(fields=[</span><span class="hljs-string"><span class="koboSpan" id="kobo.104.1">'-created'</span></span><span class="koboSpan" id="kobo.105.1">]),
        ]
        ordering = [</span><span class="hljs-string"><span class="koboSpan" id="kobo.106.1">'-created'</span></span><span class="koboSpan" id="kobo.107.1">]
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.108.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.109.1">__str__</span></span><span class="koboSpan" id="kobo.110.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.111.1">self</span></span><span class="koboSpan" id="kobo.112.1">):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.113.1">return</span></span><span class="koboSpan" id="kobo.114.1"> self.title
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.115.1">This is the model that we will use to store images in the platform. </span><span class="koboSpan" id="kobo.115.2">Let’s take a look at the fields of this model:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.116.1">user</span></code><span class="koboSpan" id="kobo.117.1">: This indicates the </span><code class="inlineCode"><span class="koboSpan" id="kobo.118.1">User</span></code><span class="koboSpan" id="kobo.119.1"> object that bookmarked this image. </span><span class="koboSpan" id="kobo.119.2">This is a foreign key field because it specifies a many-to-one relationship: a user can post multiple images, but each image is posted by a single user. </span><span class="koboSpan" id="kobo.119.3">We have used </span><code class="inlineCode"><span class="koboSpan" id="kobo.120.1">CASCADE</span></code><span class="koboSpan" id="kobo.121.1"> for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.122.1">on_delete</span></code><span class="koboSpan" id="kobo.123.1"> parameter so that related images are deleted when a user is deleted.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.124.1">title</span></code><span class="koboSpan" id="kobo.125.1">: A title for the image.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.126.1">slug</span></code><span class="koboSpan" id="kobo.127.1">: A short label that contains only letters, numbers, underscores, or hyphens to be used for building beautiful SEO-friendly URLs.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.128.1">url</span></code><span class="koboSpan" id="kobo.129.1">: The original URL for this image. </span><span class="koboSpan" id="kobo.129.2">We use </span><code class="inlineCode"><span class="koboSpan" id="kobo.130.1">max_length</span></code><span class="koboSpan" id="kobo.131.1"> to define a maximum length of </span><code class="inlineCode"><span class="koboSpan" id="kobo.132.1">2000</span></code><span class="koboSpan" id="kobo.133.1"> characters.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.134.1">image</span></code><span class="koboSpan" id="kobo.135.1">: The image file.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.136.1">description</span></code><span class="koboSpan" id="kobo.137.1">: An optional description for the image.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.138.1">created</span></code><span class="koboSpan" id="kobo.139.1">: The date and time that indicate when the object was created in the database. </span><span class="koboSpan" id="kobo.139.2">We have added </span><code class="inlineCode"><span class="koboSpan" id="kobo.140.1">auto_now_add</span></code><span class="koboSpan" id="kobo.141.1"> to automatically set the current datetime when the object is created.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.142.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.143.1">Meta</span></code><span class="koboSpan" id="kobo.144.1"> class of the model, we have defined a database index in descending order for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.145.1">created</span></code><span class="koboSpan" id="kobo.146.1"> field. </span><span class="koboSpan" id="kobo.146.2">We</span><a id="_idIndexMarker501"/><span class="koboSpan" id="kobo.147.1"> have also added the </span><code class="inlineCode"><span class="koboSpan" id="kobo.148.1">ordering</span></code><span class="koboSpan" id="kobo.149.1"> attribute to tell Django that it should sort results by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.150.1">created</span></code><span class="koboSpan" id="kobo.151.1"> field by default. </span><span class="koboSpan" id="kobo.151.2">We indicate descending order by using a hyphen before the field name, such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.152.1">-created</span></code><span class="koboSpan" id="kobo.153.1">, so that new images will be displayed first.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.154.1">Database indexes improve query performance. </span><span class="koboSpan" id="kobo.154.2">Consider creating indexes for fields that you frequently query using </span><code class="inlineCode"><span class="koboSpan" id="kobo.155.1">filter()</span></code><span class="koboSpan" id="kobo.156.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.157.1">exclude()</span></code><span class="koboSpan" id="kobo.158.1">, or </span><code class="inlineCode"><span class="koboSpan" id="kobo.159.1">order_by()</span></code><span class="koboSpan" id="kobo.160.1">. </span><code class="inlineCode"><span class="koboSpan" id="kobo.161.1">ForeignKey</span></code><span class="koboSpan" id="kobo.162.1"> fields or fields with </span><code class="inlineCode"><span class="koboSpan" id="kobo.163.1">unique=True</span></code><span class="koboSpan" id="kobo.164.1"> imply the creation of an index. </span><span class="koboSpan" id="kobo.164.2">You can learn more about database indexes at </span><a href="https://docs.djangoproject.com/en/5.0/ref/models/options/#django.db.models.Options.indexes"><span class="url"><span class="koboSpan" id="kobo.165.1">https://docs.djangoproject.com/en/5.0/ref/models/options/#django.db.models.Options.indexes</span></span></a><span class="koboSpan" id="kobo.166.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.167.1">We will override the </span><code class="inlineCode"><span class="koboSpan" id="kobo.168.1">save()</span></code><span class="koboSpan" id="kobo.169.1"> method of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.170.1">Image</span></code><span class="koboSpan" id="kobo.171.1"> model to automatically generate the </span><code class="inlineCode"><span class="koboSpan" id="kobo.172.1">slug</span></code><span class="koboSpan" id="kobo.173.1"> field based on the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.174.1">title</span></code><span class="koboSpan" id="kobo.175.1"> field. </span><span class="koboSpan" id="kobo.175.2">Import the </span><code class="inlineCode"><span class="koboSpan" id="kobo.176.1">slugify()</span></code><span class="koboSpan" id="kobo.177.1"> function and add a </span><code class="inlineCode"><span class="koboSpan" id="kobo.178.1">save()</span></code><span class="koboSpan" id="kobo.179.1"> method to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.180.1">Image</span></code><span class="koboSpan" id="kobo.181.1"> model, as follows. </span><span class="koboSpan" id="kobo.181.2">New lines are highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.182.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.183.1"> django.utils.text </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.184.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.185.1"> slugify</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.186.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.187.1">Image</span></span><span class="koboSpan" id="kobo.188.1">(models.Model):
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.189.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.190.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.191.1">save</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.192.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.193.1">self, *args, **kwargs</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.194.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.195.1">if</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.196.1">not</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.197.1"> self.slug:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.198.1">            self.slug = slugify(self.title)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.199.1">super</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.200.1">().save(*args, **kwargs)</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.201.1">When an </span><code class="inlineCode"><span class="koboSpan" id="kobo.202.1">Image</span></code><span class="koboSpan" id="kobo.203.1"> object is saved, if the </span><code class="inlineCode"><span class="koboSpan" id="kobo.204.1">slug</span></code><span class="koboSpan" id="kobo.205.1"> field doesn’t have a value, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.206.1">slugify()</span></code><span class="koboSpan" id="kobo.207.1"> function is used to automatically generate a slug from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.208.1">title</span></code><span class="koboSpan" id="kobo.209.1"> field of the image. </span><span class="koboSpan" id="kobo.209.2">The object is then saved. </span><span class="koboSpan" id="kobo.209.3">By generating slugs automatically from the title, users won’t have to provide a slug when </span><a id="_idIndexMarker502"/><span class="koboSpan" id="kobo.210.1">they share images on our website.</span></p>
<h2 class="heading-2" id="_idParaDest-177"><span class="koboSpan" id="kobo.211.1">Creating many-to-many relationships</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.212.1">Next, we will add another</span><a id="_idIndexMarker503"/><span class="koboSpan" id="kobo.213.1"> field to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.214.1">Image</span></code><span class="koboSpan" id="kobo.215.1"> model to store the users who like an image. </span><span class="koboSpan" id="kobo.215.2">We will need a many-to-many relationship in this case because a user might like multiple images and each image can be liked by multiple users.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.216.1">Add the following field to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.217.1">Image</span></code><span class="koboSpan" id="kobo.218.1"> model:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.219.1">users_like = models.ManyToManyField(
    settings.AUTH_USER_MODEL,
    related_name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.220.1">'images_liked'</span></span><span class="koboSpan" id="kobo.221.1">,
    blank=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.222.1">True</span></span><span class="koboSpan" id="kobo.223.1">
)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.224.1">When we define a </span><code class="inlineCode"><span class="koboSpan" id="kobo.225.1">ManyToManyField</span></code><span class="koboSpan" id="kobo.226.1"> field, Django creates an intermediary join table using the primary keys of both models. </span><em class="italic"><span class="koboSpan" id="kobo.227.1">Figure 6.2</span></em><span class="koboSpan" id="kobo.228.1"> shows the database table that will be created for this relationship:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.229.1"><img alt="" role="presentation" src="../Images/B21088_06_02.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.230.1">Figure 6.2: Intermediary database table for the many-to-many relationship</span></p>
<p class="normal"><span class="koboSpan" id="kobo.231.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.232.1">images_image_users_like</span></code><span class="koboSpan" id="kobo.233.1"> table is created by Django as an intermediary table that has references to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.234.1">images_image</span></code><span class="koboSpan" id="kobo.235.1"> table (</span><code class="inlineCode"><span class="koboSpan" id="kobo.236.1">Image</span></code><span class="koboSpan" id="kobo.237.1"> model) and </span><code class="inlineCode"><span class="koboSpan" id="kobo.238.1">auth_user</span></code><span class="koboSpan" id="kobo.239.1"> table (</span><code class="inlineCode"><span class="koboSpan" id="kobo.240.1">User</span></code><span class="koboSpan" id="kobo.241.1"> model). </span><span class="koboSpan" id="kobo.241.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.242.1">ManyToManyField</span></code><span class="koboSpan" id="kobo.243.1"> field can be defined in either of the two related models.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.244.1">As with </span><code class="inlineCode"><span class="koboSpan" id="kobo.245.1">ForeignKey</span></code><span class="koboSpan" id="kobo.246.1"> fields, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.247.1">related_name</span></code><span class="koboSpan" id="kobo.248.1"> attribute of </span><code class="inlineCode"><span class="koboSpan" id="kobo.249.1">ManyToManyField</span></code><span class="koboSpan" id="kobo.250.1"> allows you to name the relationship from the related object back to this one. </span><code class="inlineCode"><span class="koboSpan" id="kobo.251.1">ManyToManyField</span></code><span class="koboSpan" id="kobo.252.1"> fields provide a many-to-many manager that allows you to retrieve related objects, such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.253.1">image.users_like.all()</span></code><span class="koboSpan" id="kobo.254.1">, or get them from a </span><code class="inlineCode"><span class="koboSpan" id="kobo.255.1">user</span></code><span class="koboSpan" id="kobo.256.1"> object, such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.257.1">user.images_liked.all()</span></code><span class="koboSpan" id="kobo.258.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.259.1">You can learn more about many-to-many relationships at </span><a href="https://docs.djangoproject.com/en/5.0/topics/db/examples/many_to_many/"><span class="url"><span class="koboSpan" id="kobo.260.1">https://docs.djangoproject.com/en/5.0/topics/db/examples/many_to_many/</span></span></a><span class="koboSpan" id="kobo.261.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.262.1">Open the shell prompt </span><a id="_idIndexMarker504"/><span class="koboSpan" id="kobo.263.1">and run the following command to create an initial migration:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.264.1">python manage.py makemigrations images
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.265.1">The output should be similar to the following one:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.266.1">Migrations for 'images':
  images/migrations/0001_initial.py
    - Create model Image
    - Create index images_imag_created_d57897_idx on field(s) -created of model image
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.267.1">Now run the following command to apply your migration:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.268.1">python manage.py migrate images
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.269.1">You will get an output that includes the following line:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.270.1">Applying images.0001_initial... </span><span class="koboSpan" id="kobo.270.2">OK
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.271.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.272.1">Image</span></code><span class="koboSpan" id="kobo.273.1"> model is now synced to the database.</span></p>
<h2 class="heading-2" id="_idParaDest-178"><span class="koboSpan" id="kobo.274.1">Registering the image model in the administration site</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.275.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.276.1">admin.py</span></code><span class="koboSpan" id="kobo.277.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.278.1">images</span></code><span class="koboSpan" id="kobo.279.1"> application</span><a id="_idIndexMarker505"/><span class="koboSpan" id="kobo.280.1"> and register the </span><code class="inlineCode"><span class="koboSpan" id="kobo.281.1">Image</span></code><span class="koboSpan" id="kobo.282.1"> model into the administration site, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.283.1">from</span></span><span class="koboSpan" id="kobo.284.1"> django.contrib </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.285.1">import</span></span><span class="koboSpan" id="kobo.286.1"> admin
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.287.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.288.1"> .models </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.289.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.290.1"> Image</span></strong></span>
<span class="code-highlight"><strong class="hljs-meta-slc"><span class="koboSpan" id="kobo.291.1">@admin.register(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.292.1">Image</span></strong><strong class="hljs-meta-slc"><span class="koboSpan" id="kobo.293.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.294.1">class</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.295.1">ImageAdmin</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.296.1">(admin.ModelAdmin):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.297.1">    list_display = [</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.298.1">'title'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.299.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.300.1">'slug'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.301.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.302.1">'image'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.303.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.304.1">'created'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.305.1">]</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.306.1">    list_filter = [</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.307.1">'created'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.308.1">]</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.309.1">Start the development server with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.310.1">python manage.py runserver_plus --cert-file cert.crt
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.311.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.312.1">https://127.0.0.1:8000/admin/</span></code><span class="koboSpan" id="kobo.313.1"> in your browser, and you will see the </span><code class="inlineCode"><span class="koboSpan" id="kobo.314.1">Image</span></code><span class="koboSpan" id="kobo.315.1"> model in the administration site, like this:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.316.1"><img alt="" role="presentation" src="../Images/B21088_06_03.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.317.1">Figure 6.3: The Images block on the Django administration site index page</span></p>
<p class="normal"><span class="koboSpan" id="kobo.318.1">You have completed the </span><a id="_idIndexMarker506"/><span class="koboSpan" id="kobo.319.1">model to store images. </span><span class="koboSpan" id="kobo.319.2">Now you will learn how to implement a form to retrieve images by their URL and store them using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.320.1">Image</span></code><span class="koboSpan" id="kobo.321.1"> model.</span></p>
<h1 class="heading-1" id="_idParaDest-179"><span class="koboSpan" id="kobo.322.1">Posting content from other websites</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.323.1">We will allow users to bookmark images</span><a id="_idIndexMarker507"/><span class="koboSpan" id="kobo.324.1"> from external websites and share them on our site. </span><span class="koboSpan" id="kobo.324.2">Users will provide the URL of the image, a title, and an optional </span><a id="_idIndexMarker508"/><span class="koboSpan" id="kobo.325.1">description. </span><span class="koboSpan" id="kobo.325.2">We will create a form and a view to download the image and create a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.326.1">Image</span></code><span class="koboSpan" id="kobo.327.1"> object in the database.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.328.1">Let’s start by building a form to submit new images.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.329.1">Create a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.330.1">forms.py</span></code><span class="koboSpan" id="kobo.331.1"> file inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.332.1">images</span></code><span class="koboSpan" id="kobo.333.1"> application directory and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.334.1">from</span></span><span class="koboSpan" id="kobo.335.1"> django </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.336.1">import</span></span><span class="koboSpan" id="kobo.337.1"> forms
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.338.1">from</span></span><span class="koboSpan" id="kobo.339.1"> .models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.340.1">import</span></span><span class="koboSpan" id="kobo.341.1"> Image
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.342.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.343.1">ImageCreateForm</span></span><span class="koboSpan" id="kobo.344.1">(forms.ModelForm):
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.345.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.346.1">Meta</span></span><span class="koboSpan" id="kobo.347.1">:
        model = Image
        fields = [</span><span class="hljs-string"><span class="koboSpan" id="kobo.348.1">'title'</span></span><span class="koboSpan" id="kobo.349.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.350.1">'url'</span></span><span class="koboSpan" id="kobo.351.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.352.1">'description'</span></span><span class="koboSpan" id="kobo.353.1">]
        widgets = {
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.354.1">'url'</span></span><span class="koboSpan" id="kobo.355.1">: forms.HiddenInput,
        }
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.356.1">We have defined a </span><code class="inlineCode"><span class="koboSpan" id="kobo.357.1">ModelForm</span></code><span class="koboSpan" id="kobo.358.1"> form from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.359.1">Image</span></code><span class="koboSpan" id="kobo.360.1"> model, including only the </span><code class="inlineCode"><span class="koboSpan" id="kobo.361.1">title</span></code><span class="koboSpan" id="kobo.362.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.363.1">url</span></code><span class="koboSpan" id="kobo.364.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.365.1">description</span></code><span class="koboSpan" id="kobo.366.1"> fields. </span><span class="koboSpan" id="kobo.366.2">Users will not enter the image URL directly in the form. </span><span class="koboSpan" id="kobo.366.3">Instead, we will provide them with a JavaScript tool to choose an image from an external site, and the form will receive the image’s URL as a parameter. </span><span class="koboSpan" id="kobo.366.4">We have overridden the default widget of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.367.1">url</span></code><span class="koboSpan" id="kobo.368.1"> field </span><a id="_idIndexMarker509"/><span class="koboSpan" id="kobo.369.1">to use a </span><code class="inlineCode"><span class="koboSpan" id="kobo.370.1">HiddenInput</span></code><span class="koboSpan" id="kobo.371.1"> widget. </span><span class="koboSpan" id="kobo.371.2">This widget is rendered as an HTML </span><code class="inlineCode"><span class="koboSpan" id="kobo.372.1">input</span></code><span class="koboSpan" id="kobo.373.1"> element with a </span><code class="inlineCode"><span class="koboSpan" id="kobo.374.1">type="hidden"</span></code><span class="koboSpan" id="kobo.375.1"> attribute. </span><span class="koboSpan" id="kobo.375.2">We use this widget because we don’t want this field to</span><a id="_idIndexMarker510"/><span class="koboSpan" id="kobo.376.1"> be visible to users.</span></p>
<h2 class="heading-2" id="_idParaDest-180"><span class="koboSpan" id="kobo.377.1">Cleaning form fields</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.378.1">In order to verify that the provided</span><a id="_idIndexMarker511"/><span class="koboSpan" id="kobo.379.1"> image URL is valid, we will check that the filename ends with a </span><code class="inlineCode"><span class="koboSpan" id="kobo.380.1">.jpg</span></code><span class="koboSpan" id="kobo.381.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.382.1">.jpeg</span></code><span class="koboSpan" id="kobo.383.1">, or </span><code class="inlineCode"><span class="koboSpan" id="kobo.384.1">.png</span></code><span class="koboSpan" id="kobo.385.1"> extension to allow sharing JPEG and PNG files only. </span><span class="koboSpan" id="kobo.385.2">In the previous chapter, we used the </span><code class="inlineCode"><span class="koboSpan" id="kobo.386.1">clean_&lt;fieldname&gt;()</span></code><span class="koboSpan" id="kobo.387.1"> convention to implement field validation. </span><span class="koboSpan" id="kobo.387.2">This method is executed for each field, if the field is present, when we call </span><code class="inlineCode"><span class="koboSpan" id="kobo.388.1">is_valid()</span></code><span class="koboSpan" id="kobo.389.1"> on a form instance. </span><span class="koboSpan" id="kobo.389.2">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.390.1">clean</span></code><span class="koboSpan" id="kobo.391.1"> method, you can alter the field’s value or raise any validation errors for the field.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.392.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.393.1">forms.py</span></code><span class="koboSpan" id="kobo.394.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.395.1">images</span></code><span class="koboSpan" id="kobo.396.1"> application, add the following method to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.397.1">ImageCreateForm</span></code><span class="koboSpan" id="kobo.398.1"> class:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.399.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.400.1">clean_url</span></span><span class="koboSpan" id="kobo.401.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.402.1">self</span></span><span class="koboSpan" id="kobo.403.1">):
    url = self.cleaned_data[</span><span class="hljs-string"><span class="koboSpan" id="kobo.404.1">'url'</span></span><span class="koboSpan" id="kobo.405.1">]
    valid_extensions = [</span><span class="hljs-string"><span class="koboSpan" id="kobo.406.1">'jpg'</span></span><span class="koboSpan" id="kobo.407.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.408.1">'jpeg'</span></span><span class="koboSpan" id="kobo.409.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.410.1">'png'</span></span><span class="koboSpan" id="kobo.411.1">]
    extension = url.rsplit(</span><span class="hljs-string"><span class="koboSpan" id="kobo.412.1">'.'</span></span><span class="koboSpan" id="kobo.413.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.414.1">1</span></span><span class="koboSpan" id="kobo.415.1">)[</span><span class="hljs-number"><span class="koboSpan" id="kobo.416.1">1</span></span><span class="koboSpan" id="kobo.417.1">].lower()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.418.1">if</span></span><span class="koboSpan" id="kobo.419.1"> extension </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.420.1">not</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.421.1">in</span></span><span class="koboSpan" id="kobo.422.1"> valid_extensions:
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.423.1">raise</span></span><span class="koboSpan" id="kobo.424.1"> forms.ValidationError(
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.425.1">'The given URL does not match valid image extensions.'</span></span>
<span class="hljs-string"> </span><span class="koboSpan" id="kobo.426.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.427.1">return</span></span><span class="koboSpan" id="kobo.428.1"> url
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.429.1">In the preceding code, we have defined a </span><code class="inlineCode"><span class="koboSpan" id="kobo.430.1">clean_url()</span></code><span class="koboSpan" id="kobo.431.1"> method to clean the </span><code class="inlineCode"><span class="koboSpan" id="kobo.432.1">url</span></code><span class="koboSpan" id="kobo.433.1"> field. </span><span class="koboSpan" id="kobo.433.2">The code works as follows:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.434.1">The value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.435.1">url</span></code><span class="koboSpan" id="kobo.436.1"> field is retrieved by accessing the </span><code class="inlineCode"><span class="koboSpan" id="kobo.437.1">cleaned_data</span></code><span class="koboSpan" id="kobo.438.1"> dictionary of the form instance.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.439.1">The URL is split to check whether the file has a valid extension. </span><span class="koboSpan" id="kobo.439.2">If the extension is invalid, a </span><code class="inlineCode"><span class="koboSpan" id="kobo.440.1">ValidationError</span></code><span class="koboSpan" id="kobo.441.1"> is raised and the form instance is not validated.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.442.1">In addition to validating the given URL, we also need to download the image file and save it. </span><span class="koboSpan" id="kobo.442.2">We could, for example, use the view that handles the form to download the image file. </span><span class="koboSpan" id="kobo.442.3">Instead, let’s take a more general approach by overriding the </span><code class="inlineCode"><span class="koboSpan" id="kobo.443.1">save()</span></code><span class="koboSpan" id="kobo.444.1"> method of the model form to perform this task when the form is saved.</span></p>
<h2 class="heading-2" id="_idParaDest-181"><span class="koboSpan" id="kobo.445.1">Installing the Requests library</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.446.1">When a user bookmarks an image, we will need to download the image file by its URL. </span><span class="koboSpan" id="kobo.446.2">We will use the Requests Python library for this purpose. </span><span class="koboSpan" id="kobo.446.3">Requests is the most popular HTTP library for Python. </span><span class="koboSpan" id="kobo.446.4">It abstracts</span><a id="_idIndexMarker512"/><span class="koboSpan" id="kobo.447.1"> the complexity of </span><a id="_idIndexMarker513"/><span class="koboSpan" id="kobo.448.1">dealing with HTTP requests and provides a very simple interface to consume HTTP services. </span><span class="koboSpan" id="kobo.448.2">You can find the documentation for the Requests library at </span><a href="https://requests.readthedocs.io/en/master/"><span class="url"><span class="koboSpan" id="kobo.449.1">https://requests.readthedocs.io/en/master/</span></span></a><span class="koboSpan" id="kobo.450.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.451.1">Open the shell and install the Requests library with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.452.1">python -m pip install requests==2.31.0
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.453.1">We will now override the </span><code class="inlineCode"><span class="koboSpan" id="kobo.454.1">save()</span></code><span class="koboSpan" id="kobo.455.1"> method of </span><code class="inlineCode"><span class="koboSpan" id="kobo.456.1">ImageCreateForm</span></code><span class="koboSpan" id="kobo.457.1"> and use the Requests library to retrieve the image by its URL.</span></p>
<h2 class="heading-2" id="_idParaDest-182"><span class="koboSpan" id="kobo.458.1">Overriding the save() method of a ModelForm</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.459.1">As you know, </span><code class="inlineCode"><span class="koboSpan" id="kobo.460.1">ModelForm</span></code><span class="koboSpan" id="kobo.461.1"> provides a </span><code class="inlineCode"><span class="koboSpan" id="kobo.462.1">save()</span></code><span class="koboSpan" id="kobo.463.1"> method to save the current model instance to the database and return the object. </span><span class="koboSpan" id="kobo.463.2">This </span><a id="_idIndexMarker514"/><span class="koboSpan" id="kobo.464.1">method receives a Boolean </span><code class="inlineCode"><span class="koboSpan" id="kobo.465.1">commit</span></code><span class="koboSpan" id="kobo.466.1"> parameter, which allows you to</span><a id="_idIndexMarker515"/><span class="koboSpan" id="kobo.467.1"> specify whether the object has to be persisted to the database. </span><span class="koboSpan" id="kobo.467.2">If </span><code class="inlineCode"><span class="koboSpan" id="kobo.468.1">commit</span></code><span class="koboSpan" id="kobo.469.1"> is </span><code class="inlineCode"><span class="koboSpan" id="kobo.470.1">False</span></code><span class="koboSpan" id="kobo.471.1">, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.472.1">save()</span></code><span class="koboSpan" id="kobo.473.1"> method will return a model instance but will not save it to the database. </span><span class="koboSpan" id="kobo.473.2">We will override the form’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.474.1">save()</span></code><span class="koboSpan" id="kobo.475.1"> method in order to retrieve the image file by the given URL and save it to the file system.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.476.1">Add the following imports at the top of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.477.1">forms.py</span></code><span class="koboSpan" id="kobo.478.1"> file:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.479.1">import</span></span><span class="koboSpan" id="kobo.480.1"> requests
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.481.1">from</span></span><span class="koboSpan" id="kobo.482.1"> django.core.files.base </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.483.1">import</span></span><span class="koboSpan" id="kobo.484.1"> ContentFile
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.485.1">from</span></span><span class="koboSpan" id="kobo.486.1"> django.utils.text </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.487.1">import</span></span><span class="koboSpan" id="kobo.488.1"> slugify
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.489.1">Then, add the following </span><code class="inlineCode"><span class="koboSpan" id="kobo.490.1">save()</span></code><span class="koboSpan" id="kobo.491.1"> method to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.492.1">ImageCreateForm</span></code><span class="koboSpan" id="kobo.493.1"> form:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.494.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.495.1">save</span></span><span class="koboSpan" id="kobo.496.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.497.1">self, force_insert=</span></span><span class="hljs-literal"><span class="koboSpan" id="kobo.498.1">False</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.499.1">, force_update=</span></span><span class="hljs-literal"><span class="koboSpan" id="kobo.500.1">False</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.501.1">, commit=</span></span><span class="hljs-literal"><span class="koboSpan" id="kobo.502.1">True</span></span><span class="koboSpan" id="kobo.503.1">):
    image = </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.504.1">super</span></span><span class="koboSpan" id="kobo.505.1">().save(commit=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.506.1">False</span></span><span class="koboSpan" id="kobo.507.1">)
    image_url = self.cleaned_data[</span><span class="hljs-string"><span class="koboSpan" id="kobo.508.1">'url'</span></span><span class="koboSpan" id="kobo.509.1">]
    name = slugify(image.title)
    extension = image_url.rsplit(</span><span class="hljs-string"><span class="koboSpan" id="kobo.510.1">'.'</span></span><span class="koboSpan" id="kobo.511.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.512.1">1</span></span><span class="koboSpan" id="kobo.513.1">)[</span><span class="hljs-number"><span class="koboSpan" id="kobo.514.1">1</span></span><span class="koboSpan" id="kobo.515.1">].lower()
    image_name = </span><span class="hljs-string"><span class="koboSpan" id="kobo.516.1">f'</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.517.1">{name}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.518.1">.</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.519.1">{extension}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.520.1">'</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.521.1"># download image from the given URL</span></span><span class="koboSpan" id="kobo.522.1">
    response = requests.get(image_url)
    image.image.save(
        image_name,
        ContentFile(response.content),
        save=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.523.1">False</span></span>
<span class="hljs-literal"> </span><span class="koboSpan" id="kobo.524.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.525.1">if</span></span><span class="koboSpan" id="kobo.526.1"> commit:
        image.save()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.527.1">return</span></span><span class="koboSpan" id="kobo.528.1"> image
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.529.1">We have overridden the </span><code class="inlineCode"><span class="koboSpan" id="kobo.530.1">save()</span></code><span class="koboSpan" id="kobo.531.1"> method, keeping the parameters required by </span><code class="inlineCode"><span class="koboSpan" id="kobo.532.1">ModelForm</span></code><span class="koboSpan" id="kobo.533.1">. </span><span class="koboSpan" id="kobo.533.2">The preceding code </span><a id="_idIndexMarker516"/><span class="koboSpan" id="kobo.534.1">can be explained as follows:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.535.1">A new </span><code class="inlineCode"><span class="koboSpan" id="kobo.536.1">image</span></code><span class="koboSpan" id="kobo.537.1"> instance is created by calling the </span><code class="inlineCode"><span class="koboSpan" id="kobo.538.1">save()</span></code><span class="koboSpan" id="kobo.539.1"> method of the form with </span><code class="inlineCode"><span class="koboSpan" id="kobo.540.1">commit=False</span></code><span class="koboSpan" id="kobo.541.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.542.1">The URL of the image is retrieved from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.543.1">cleaned_data</span></code><span class="koboSpan" id="kobo.544.1"> dictionary of the form.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.545.1">An image name is</span><a id="_idIndexMarker517"/><span class="koboSpan" id="kobo.546.1"> generated by combining the </span><code class="inlineCode"><span class="koboSpan" id="kobo.547.1">image</span></code><span class="koboSpan" id="kobo.548.1"> title slug with the original file extension of the image.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.549.1">The Requests Python library is used to download the image by sending an HTTP </span><code class="inlineCode"><span class="koboSpan" id="kobo.550.1">GET</span></code><span class="koboSpan" id="kobo.551.1"> request using the image URL. </span><span class="koboSpan" id="kobo.551.2">The response is stored in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.552.1">response</span></code><span class="koboSpan" id="kobo.553.1"> object.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.554.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.555.1">save()</span></code><span class="koboSpan" id="kobo.556.1"> method of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.557.1">image</span></code><span class="koboSpan" id="kobo.558.1"> field is called, passing it a </span><code class="inlineCode"><span class="koboSpan" id="kobo.559.1">ContentFile</span></code><span class="koboSpan" id="kobo.560.1"> object that is instantiated with the downloaded file content. </span><span class="koboSpan" id="kobo.560.2">In this way, the file is saved to the media directory of the project. </span><span class="koboSpan" id="kobo.560.3">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.561.1">save=False</span></code><span class="koboSpan" id="kobo.562.1"> parameter is passed to prevent the object from being saved to the database.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.563.1">To maintain the same behavior as the original </span><code class="inlineCode"><span class="koboSpan" id="kobo.564.1">save()</span></code><span class="koboSpan" id="kobo.565.1"> method of the model form, the form is only saved to the database if the </span><code class="inlineCode"><span class="koboSpan" id="kobo.566.1">commit</span></code><span class="koboSpan" id="kobo.567.1"> parameter is </span><code class="inlineCode"><span class="koboSpan" id="kobo.568.1">True</span></code><span class="koboSpan" id="kobo.569.1">.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.570.1">We will need a view to create an instance of the form and handle its submission.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.571.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.572.1">views.py</span></code><span class="koboSpan" id="kobo.573.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.574.1">images</span></code><span class="koboSpan" id="kobo.575.1"> application </span><a id="_idIndexMarker518"/><span class="koboSpan" id="kobo.576.1">and add the following code to it. </span><span class="koboSpan" id="kobo.576.2">New code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.577.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.578.1"> django.contrib </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.579.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.580.1"> messages</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.581.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.582.1"> django.contrib.auth.decorators </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.583.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.584.1"> login_required</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.585.1">from</span></span><span class="koboSpan" id="kobo.586.1"> django.shortcuts </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.587.1">import</span></span> <span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.588.1">redirect, </span></strong></span><span class="koboSpan" id="kobo.589.1">render
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.590.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.591.1"> .forms </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.592.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.593.1"> ImageCreateForm</span></strong></span>
<span class="code-highlight"><strong class="hljs-meta-slc"><span class="koboSpan" id="kobo.594.1">@login_required</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.595.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.596.1">image_create</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.597.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.598.1">request</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.599.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.600.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.601.1"> request.method == </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.602.1">'POST'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.603.1">:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.604.1"># form is sent</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.605.1">        form = ImageCreateForm(data=request.POST)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.606.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.607.1"> form.is_valid():</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.608.1"># form data is valid</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.609.1">            cd = form.cleaned_data</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.610.1">            new_image = form.save(commit=</span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.611.1">False</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.612.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.613.1"># assign current user to the item</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.614.1">            new_image.user = request.user</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.615.1">            new_image.save()</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.616.1">            messages.success(request, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.617.1">'Image added successfully'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.618.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.619.1"># redirect to new created item detail view</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.620.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.621.1"> redirect(new_image.get_absolute_url())</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.622.1">else</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.623.1">:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.624.1"># build form with data provided by the bookmarklet via GET</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.625.1">        form = ImageCreateForm(data=request.GET)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.626.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.627.1"> render(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.628.1">        request,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.629.1">'images/image/create.html'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.630.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.631.1">        {</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.632.1">'section'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.633.1">: </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.634.1">'images'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.635.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.636.1">'form'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.637.1">: form}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.638.1">    )</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.639.1">In the preceding code, we have created a view to store images on the site. </span><span class="koboSpan" id="kobo.639.2">We have added the </span><code class="inlineCode"><span class="koboSpan" id="kobo.640.1">login_required</span></code><span class="koboSpan" id="kobo.641.1"> decorator to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.642.1">image_create</span></code><span class="koboSpan" id="kobo.643.1"> view to prevent access to unauthenticated users. </span><span class="koboSpan" id="kobo.643.2">This is how</span><a id="_idIndexMarker519"/><span class="koboSpan" id="kobo.644.1"> this view works:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.645.1">Initial data has to be provided through a </span><code class="inlineCode"><span class="koboSpan" id="kobo.646.1">GET</span></code><span class="koboSpan" id="kobo.647.1"> HTTP request in order to create an instance of the form. </span><span class="koboSpan" id="kobo.647.2">This data will consist of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.648.1">url</span></code><span class="koboSpan" id="kobo.649.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.650.1">title</span></code><span class="koboSpan" id="kobo.651.1"> attributes of an image from an external website. </span><span class="koboSpan" id="kobo.651.2">Both parameters will be set in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.652.1">GET</span></code><span class="koboSpan" id="kobo.653.1"> request by the JavaScript bookmarklet that we will create later. </span><span class="koboSpan" id="kobo.653.2">For now, we can assume that this data will be available in the request.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.654.1">When the form is submitted with a </span><code class="inlineCode"><span class="koboSpan" id="kobo.655.1">POST</span></code><span class="koboSpan" id="kobo.656.1"> HTTP request, it is validated with </span><code class="inlineCode"><span class="koboSpan" id="kobo.657.1">form.is_valid()</span></code><span class="koboSpan" id="kobo.658.1">. </span><span class="koboSpan" id="kobo.658.2">If the form data is valid, a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.659.1">image</span></code><span class="koboSpan" id="kobo.660.1"> instance is created by saving the form with </span><code class="inlineCode"><span class="koboSpan" id="kobo.661.1">form.save(commit=False)</span></code><span class="koboSpan" id="kobo.662.1">. </span><span class="koboSpan" id="kobo.662.2">The new instance is not saved to the database because of </span><code class="inlineCode"><span class="koboSpan" id="kobo.663.1">commit=False</span></code><span class="koboSpan" id="kobo.664.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.665.1">A relationship to the</span><a id="_idIndexMarker520"/><span class="koboSpan" id="kobo.666.1"> current user performing the request is added to the new </span><code class="inlineCode"><span class="koboSpan" id="kobo.667.1">image</span></code><span class="koboSpan" id="kobo.668.1"> instance with </span><code class="inlineCode"><span class="koboSpan" id="kobo.669.1">new_image.user = request.user</span></code><span class="koboSpan" id="kobo.670.1">. </span><span class="koboSpan" id="kobo.670.2">This is how we will know who uploaded each image.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.671.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.672.1">Image</span></code><span class="koboSpan" id="kobo.673.1"> object is saved to the database.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.674.1">Finally, a success message is created using the Django messages framework and the user is redirected to</span><a id="_idIndexMarker521"/><span class="koboSpan" id="kobo.675.1"> the canonical URL of the new image. </span><span class="koboSpan" id="kobo.675.2">We haven’t yet implemented the </span><code class="inlineCode"><span class="koboSpan" id="kobo.676.1">get_absolute_url()</span></code><span class="koboSpan" id="kobo.677.1"> method of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.678.1">Image</span></code><span class="koboSpan" id="kobo.679.1"> model; we will do that later.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.680.1">Create a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.681.1">urls.py</span></code><span class="koboSpan" id="kobo.682.1"> file inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.683.1">images</span></code><span class="koboSpan" id="kobo.684.1"> application and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.685.1">from</span></span><span class="koboSpan" id="kobo.686.1"> django.urls </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.687.1">import</span></span><span class="koboSpan" id="kobo.688.1"> path
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.689.1">from</span></span><span class="koboSpan" id="kobo.690.1"> . </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.691.1">import</span></span><span class="koboSpan" id="kobo.692.1"> views
app_name = </span><span class="hljs-string"><span class="koboSpan" id="kobo.693.1">'images'</span></span><span class="koboSpan" id="kobo.694.1">
urlpatterns = [
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.695.1">'create/'</span></span><span class="koboSpan" id="kobo.696.1">, views.image_create, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.697.1">'create'</span></span><span class="koboSpan" id="kobo.698.1">),
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.699.1">Edit the main </span><code class="inlineCode"><span class="koboSpan" id="kobo.700.1">urls.py</span></code><span class="koboSpan" id="kobo.701.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.702.1">bookmarks</span></code><span class="koboSpan" id="kobo.703.1"> project to include the patterns for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.704.1">images</span></code><span class="koboSpan" id="kobo.705.1"> application, as follows. </span><span class="koboSpan" id="kobo.705.2">The new code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.706.1">urlpatterns = [
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.707.1">'admin/'</span></span><span class="koboSpan" id="kobo.708.1">, admin.site.urls),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.709.1">'account/'</span></span><span class="koboSpan" id="kobo.710.1">, include(</span><span class="hljs-string"><span class="koboSpan" id="kobo.711.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.712.1">account.urls'</span></span><span class="koboSpan" id="kobo.713.1">)),
    path(
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.714.1">'social-auth/'</span></span><span class="koboSpan" id="kobo.715.1">,
        include(</span><span class="hljs-string"><span class="koboSpan" id="kobo.716.1">'social_django.urls'</span></span><span class="koboSpan" id="kobo.717.1">, namespace=</span><span class="hljs-string"><span class="koboSpan" id="kobo.718.1">'social'</span></span><span class="koboSpan" id="kobo.719.1">)
    ),
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.720.1">    path(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.721.1">'images/'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.722.1">, include(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.723.1">'images.urls'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.724.1">, namespace=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.725.1">'images'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.726.1">)),</span></strong></span><span class="koboSpan" id="kobo.727.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.728.1">Finally, we need to create a template to render the form. </span><span class="koboSpan" id="kobo.728.2">Create the following directory structure inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.729.1">images</span></code><span class="koboSpan" id="kobo.730.1"> application directory:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.731.1">templates/
  images/
    image/
      create.html
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.732.1">Edit the new </span><code class="inlineCode"><span class="koboSpan" id="kobo.733.1">create.html</span></code><span class="koboSpan" id="kobo.734.1"> template</span><a id="_idIndexMarker522"/><span class="koboSpan" id="kobo.735.1"> and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.736.1">{% extends "base.html" %}
{% block title %}Bookmark an image{% endblock %}
{% block content %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.737.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.738.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.739.1">&gt;</span></span><span class="koboSpan" id="kobo.740.1">Bookmark an image</span><span class="hljs-tag"><span class="koboSpan" id="kobo.741.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.742.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.743.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.744.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.745.1">img</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.746.1">src</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.747.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.748.1">"{{ request.GET.url }}"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.749.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.750.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.751.1">"image-preview"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.752.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.753.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.754.1">form</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.755.1">method</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.756.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.757.1">"post"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.758.1">&gt;</span></span><span class="koboSpan" id="kobo.759.1">
    {{ form.as_p }}
    {% csrf_token %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.760.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.761.1">input</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.762.1">type</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.763.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.764.1">"submit"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.765.1">value</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.766.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.767.1">"Bookmark it!"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.768.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.769.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.770.1">form</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.771.1">&gt;</span></span><span class="koboSpan" id="kobo.772.1">
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.773.1">Run the development server </span><a id="_idIndexMarker523"/><span class="koboSpan" id="kobo.774.1">with the following command in the shell prompt:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.775.1">python manage.py runserver_plus --cert-file cert.crt
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.776.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.777.1">https://127.0.0.1:8000/images/create/?title=...&amp;url=...</span></code><span class="koboSpan" id="kobo.778.1"> in your browser, including the </span><code class="inlineCode"><span class="koboSpan" id="kobo.779.1">title</span></code><span class="koboSpan" id="kobo.780.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.781.1">url</span></code><span class="koboSpan" id="kobo.782.1"> GET parameters, providing an existing JPEG image URL in the latter. </span><span class="koboSpan" id="kobo.782.2">For example, you can use the following URL: </span><code class="inlineCode"><span class="koboSpan" id="kobo.783.1">https://127.0.0.1:8000/images/create/?title=%20Django%20and%20Duke&amp;url=https://upload.wikimedia.org/wikipedia/commons/8/85/Django_Reinhardt_and_Duke_Ellington_%28Gottlieb%29.jpg</span></code><span class="koboSpan" id="kobo.784.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.785.1">You will see the form with an image preview, like the following:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.786.1"><img alt="" role="presentation" src="../Images/B21088_06_04.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.787.1">Figure 6.4: The Bookmark an image bookmark page</span></p>
<p class="normal"><span class="koboSpan" id="kobo.788.1">Add a description and click on</span><a id="_idIndexMarker524"/><span class="koboSpan" id="kobo.789.1"> the </span><strong class="keyWord"><span class="koboSpan" id="kobo.790.1">BOOKMARK IT!</span></strong><span class="koboSpan" id="kobo.791.1"> button. </span><span class="koboSpan" id="kobo.791.2">A new </span><code class="inlineCode"><span class="koboSpan" id="kobo.792.1">Image</span></code><span class="koboSpan" id="kobo.793.1"> object will be saved in your database. </span><span class="koboSpan" id="kobo.793.2">However, you will </span><a id="_idIndexMarker525"/><span class="koboSpan" id="kobo.794.1">get an error that indicates that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.795.1">Image</span></code><span class="koboSpan" id="kobo.796.1"> model has no </span><code class="inlineCode"><span class="koboSpan" id="kobo.797.1">get_absolute_url()</span></code><span class="koboSpan" id="kobo.798.1"> method, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.799.1"><img alt="" role="presentation" src="../Images/B21088_06_05.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.800.1">Figure 6.5: An error showing that the Image object has no get_absolute_url attribute</span></p>
<p class="normal"><span class="koboSpan" id="kobo.801.1">Don’t worry about this error for now; we are going to implement the </span><code class="inlineCode"><span class="koboSpan" id="kobo.802.1">get_absolute_url</span></code><span class="koboSpan" id="kobo.803.1"> method in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.804.1">Image</span></code><span class="koboSpan" id="kobo.805.1"> model later.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.806.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.807.1">https://127.0.0.1:8000/admin/images/image/</span></code><span class="koboSpan" id="kobo.808.1"> in your browser and verify that the new </span><code class="inlineCode"><span class="koboSpan" id="kobo.809.1">Image</span></code><span class="koboSpan" id="kobo.810.1"> object</span><a id="_idIndexMarker526"/><span class="koboSpan" id="kobo.811.1"> has been </span><a id="_idIndexMarker527"/><span class="koboSpan" id="kobo.812.1">saved, like this:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.813.1"><img alt="" role="presentation" src="../Images/B21088_06_06.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.814.1">Figure 6.6: The administration site image list page showing the created Image object</span></p>
<h2 class="heading-2" id="_idParaDest-183"><span class="koboSpan" id="kobo.815.1">Building a bookmarklet with JavaScript</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.816.1">A bookmarklet is a bookmark stored in a</span><a id="_idIndexMarker528"/><span class="koboSpan" id="kobo.817.1"> web browser that contains JavaScript code to extend the browser’s functionality. </span><span class="koboSpan" id="kobo.817.2">When you click on the bookmark in the bookmarks or favorites bar of </span><a id="_idIndexMarker529"/><span class="koboSpan" id="kobo.818.1">your browser, the JavaScript code is executed on the website being displayed in the browser. </span><span class="koboSpan" id="kobo.818.2">This is very useful for building tools that interact with other websites.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.819.1">Some online services, such as Pinterest, implement their own bookmarklet to let users share content from other sites on their platforms. </span><span class="koboSpan" id="kobo.819.2">The Pinterest bookmarklet is implemented as a browser extension and is available at </span><a href="https://help.pinterest.com/en/article/save-pins-with-the-pinterest-browser-button"><span class="url"><span class="koboSpan" id="kobo.820.1">https://help.pinterest.com/en/article/save-pins-with-the-pinterest-browser-button</span></span></a><span class="koboSpan" id="kobo.821.1">. </span><span class="koboSpan" id="kobo.821.2">The </span><strong class="screenText"><span class="koboSpan" id="kobo.822.1">Pinterest Save</span></strong><span class="koboSpan" id="kobo.823.1"> extension allows users to save images or websites to their Pinterest account with just one click on the browser.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.824.1"><img alt="" role="presentation" src="../Images/B21088_06_07.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.825.1">Figure 6.7: The Pinterest Save extension</span></p>
<p class="normal"><span class="koboSpan" id="kobo.826.1">Let’s create a bookmarklet in a similar way for your website. </span><span class="koboSpan" id="kobo.826.2">For that, we will be using JavaScript.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.827.1">This is how your users will </span><a id="_idIndexMarker530"/><span class="koboSpan" id="kobo.828.1">add the bookmarklet to their browser and use it:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.829.1">The user drags a link from</span><a id="_idIndexMarker531"/><span class="koboSpan" id="kobo.830.1"> your site to their browser’s bookmarks bar. </span><span class="koboSpan" id="kobo.830.2">The link contains JavaScript code in its </span><code class="inlineCode"><span class="koboSpan" id="kobo.831.1">href</span></code><span class="koboSpan" id="kobo.832.1"> attribute. </span><span class="koboSpan" id="kobo.832.2">This code will be stored in the bookmark.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.833.1">The user navigates to any website and clicks on the bookmark in the bookmarks or favorites bar. </span><span class="koboSpan" id="kobo.833.2">The JavaScript code of the bookmark is executed.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.834.1">Since the JavaScript code will be stored as a bookmark, we will not be able to update it after the user has added it to their bookmarks bar. </span><span class="koboSpan" id="kobo.834.2">This is an important drawback that you can solve by implementing a launcher script. </span><span class="koboSpan" id="kobo.834.3">Users will save the launcher script as a bookmark, and the launcher script will load the actual JavaScript bookmarklet from a URL. </span><span class="koboSpan" id="kobo.834.4">By doing this, you will be able to update the code of the bookmarklet at any time. </span><span class="koboSpan" id="kobo.834.5">This is the approach that we will take to build the bookmarklet. </span><span class="koboSpan" id="kobo.834.6">Let’s start!</span></p>
<p class="normal"><span class="koboSpan" id="kobo.835.1">Create a new template under </span><code class="inlineCode"><span class="koboSpan" id="kobo.836.1">images/templates/</span></code><span class="koboSpan" id="kobo.837.1"> and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.838.1">bookmarklet_launcher.js</span></code><span class="koboSpan" id="kobo.839.1">. </span><span class="koboSpan" id="kobo.839.2">This will be the launcher script. </span><span class="koboSpan" id="kobo.839.3">Add the following JavaScript code to the new file:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.840.1">(function(){
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.841.1">if</span></span><span class="koboSpan" id="kobo.842.1">(!window.bookmarklet) {
    bookmarklet_js = document.body.appendChild(document.createElement(</span><span class="hljs-string"><span class="koboSpan" id="kobo.843.1">'script'</span></span><span class="koboSpan" id="kobo.844.1">));
    bookmarklet_js.src = </span><span class="hljs-string"><span class="koboSpan" id="kobo.845.1">'//127.0.0.1:8000/static/js/bookmarklet.js?r='</span></span><span class="koboSpan" id="kobo.846.1">+Math.floor(Math.random()*</span><span class="hljs-number"><span class="koboSpan" id="kobo.847.1">9999999999999999</span></span><span class="koboSpan" id="kobo.848.1">);
    window.bookmarklet = true;
  }
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.849.1">else</span></span><span class="koboSpan" id="kobo.850.1"> {
    bookmarkletLaunch();
  }
})();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.851.1">The preceding script checks whether the bookmarklet has already been loaded by checking the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.852.1">bookmarklet</span></code><span class="koboSpan" id="kobo.853.1"> window variable with </span><code class="inlineCode"><span class="koboSpan" id="kobo.854.1">if(!window.bookmarklet)</span></code><span class="koboSpan" id="kobo.855.1">:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.856.1">If </span><code class="inlineCode"><span class="koboSpan" id="kobo.857.1">window.bookmarklet</span></code><span class="koboSpan" id="kobo.858.1"> is not</span><a id="_idIndexMarker532"/><span class="koboSpan" id="kobo.859.1"> defined or doesn’t have a truthy value (considered </span><code class="inlineCode"><span class="koboSpan" id="kobo.860.1">true</span></code><span class="koboSpan" id="kobo.861.1"> in a Boolean context), a JavaScript file is loaded by appending a </span><code class="inlineCode"><span class="koboSpan" id="kobo.862.1">&lt;script&gt;</span></code><span class="koboSpan" id="kobo.863.1"> element </span><a id="_idIndexMarker533"/><span class="koboSpan" id="kobo.864.1">to the body of the HTML document loaded in the browser. </span><span class="koboSpan" id="kobo.864.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.865.1">src</span></code><span class="koboSpan" id="kobo.866.1"> attribute is used to load the URL of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.867.1">bookmarklet.js</span></code><span class="koboSpan" id="kobo.868.1"> script with a random 16-digit integer parameter generated with </span><code class="inlineCode"><span class="koboSpan" id="kobo.869.1">Math.random()*9999999999999999</span></code><span class="koboSpan" id="kobo.870.1">. </span><span class="koboSpan" id="kobo.870.2">Using a random number, we prevent the browser from loading the file from the browser’s cache. </span><span class="koboSpan" id="kobo.870.3">If the bookmarklet JavaScript has been previously loaded, the different parameter value will force the browser to load the script from the source URL again. </span><span class="koboSpan" id="kobo.870.4">This way, we make sure the bookmarklet always runs the most up-to-date JavaScript code.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.871.1">If </span><code class="inlineCode"><span class="koboSpan" id="kobo.872.1">window.bookmarklet</span></code><span class="koboSpan" id="kobo.873.1"> is defined and has a truthy value, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.874.1">bookmarkletLaunch()</span></code><span class="koboSpan" id="kobo.875.1"> function is executed. </span><span class="koboSpan" id="kobo.875.2">We will define </span><code class="inlineCode"><span class="koboSpan" id="kobo.876.1">bookmarkletLaunch()</span></code><span class="koboSpan" id="kobo.877.1"> as a global function in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.878.1">bookmarklet.js</span></code><span class="koboSpan" id="kobo.879.1"> script.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.880.1">By checking the </span><code class="inlineCode"><span class="koboSpan" id="kobo.881.1">bookmarklet</span></code><span class="koboSpan" id="kobo.882.1"> window variable, we prevent the bookmarklet JavaScript code from being loaded more than once if users click on the bookmarklet repeatedly.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.883.1">You created the bookmarklet launcher code. </span><span class="koboSpan" id="kobo.883.2">The actual bookmarklet code will reside in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.884.1">bookmarklet.js</span></code><span class="koboSpan" id="kobo.885.1"> static file. </span><span class="koboSpan" id="kobo.885.2">Using launcher code allows you to update the bookmarklet code at any time without requiring users to change the bookmark they previously added to their browser.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.886.1">Let’s add the bookmarklet launcher</span><a id="_idIndexMarker534"/><span class="koboSpan" id="kobo.887.1"> to the dashboard pages so that users can add it to the bookmarks bar of their browser.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.888.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.889.1">account/dashboard.html</span></code><span class="koboSpan" id="kobo.890.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.891.1">account</span></code><span class="koboSpan" id="kobo.892.1"> application and make it look like the following. </span><span class="koboSpan" id="kobo.892.2">New lines</span><a id="_idIndexMarker535"/><span class="koboSpan" id="kobo.893.1"> are highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.894.1">{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.895.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.896.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.897.1">&gt;</span></span><span class="koboSpan" id="kobo.898.1">Dashboard</span><span class="hljs-tag"><span class="koboSpan" id="kobo.899.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.900.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.901.1">&gt;</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.902.1">  {% with total_images_created=request.user.images_created.count %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.903.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.904.1">p</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.905.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.906.1">Welcome to your dashboard. </span><span class="koboSpan" id="kobo.906.2">You have bookmarked {{ total_images_created }} image{{ total_images_created|pluralize }}.</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.907.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.908.1">p</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.909.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.910.1">  {% endwith %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.911.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.912.1">p</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.913.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.914.1">Drag the following button to your bookmarks toolbar to bookmark images from other websites → </span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.915.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.916.1">a</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.917.1">href</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.918.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.919.1">"</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.920.1">javascript:{% include "</span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.921.1">bookmarklet_launcher.js</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.922.1">" %}" </span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.923.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.924.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.925.1">"button"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.926.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.927.1">Bookmark it</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.928.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.929.1">a</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.930.1">&gt;&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.931.1">p</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.932.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.933.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.934.1">p</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.935.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.936.1">You can also </span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.937.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.938.1">a</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.939.1">href</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.940.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.941.1">"{% url "</span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.942.1">edit</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.943.1">" %}"&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.944.1">edit your profile</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.945.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.946.1">a</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.947.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.948.1"> or </span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.949.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.950.1">a</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.951.1">href</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.952.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.953.1">"{% url "</span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.954.1">password_change</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.955.1">" %}"&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.956.1">change your password</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.957.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.958.1">a</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.959.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.960.1">.</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.961.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.962.1">p</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.963.1">&gt;</span></strong></span><span class="koboSpan" id="kobo.964.1">
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.965.1">Make sure that no template tag is split over multiple lines; Django doesn’t support multiple-line tags.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.966.1">The dashboard now displays the total number of images bookmarked by the user. </span><span class="koboSpan" id="kobo.966.2">We have added a </span><code class="inlineCode"><span class="koboSpan" id="kobo.967.1">{% with %}</span></code><span class="koboSpan" id="kobo.968.1"> template tag to create a variable with the total number of images bookmarked by the current user. </span><span class="koboSpan" id="kobo.968.2">We have included a link with an </span><code class="inlineCode"><span class="koboSpan" id="kobo.969.1">href</span></code><span class="koboSpan" id="kobo.970.1"> attribute that contains the bookmarklet launcher script. </span><span class="koboSpan" id="kobo.970.2">This JavaScript code is loaded from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.971.1">bookmarklet_launcher.js</span></code><span class="koboSpan" id="kobo.972.1"> template.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.973.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.974.1">https://127.0.0.1:8000/account/</span></code><span class="koboSpan" id="kobo.975.1"> in your browser. </span><span class="koboSpan" id="kobo.975.2">You should see the following page:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.976.1"><img alt="" role="presentation" src="../Images/B21088_06_08.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.977.1">Figure 6.8: The dashboard page, including the total images bookmarked and the button for the bookmarklet</span></p>
<p class="normal"><span class="koboSpan" id="kobo.978.1">Now create the following directories and files inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.979.1">images</span></code><span class="koboSpan" id="kobo.980.1"> application directory:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.981.1">static/
  js/
    bookmarklet.js
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.982.1">You will find a </span><code class="inlineCode"><span class="koboSpan" id="kobo.983.1">static/css/</span></code><span class="koboSpan" id="kobo.984.1"> directory</span><a id="_idIndexMarker536"/><span class="koboSpan" id="kobo.985.1"> in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.986.1">images</span></code><span class="koboSpan" id="kobo.987.1"> application directory</span><a id="_idIndexMarker537"/><span class="koboSpan" id="kobo.988.1"> in the code that comes along with this chapter. </span><span class="koboSpan" id="kobo.988.2">Copy the </span><code class="inlineCode"><span class="koboSpan" id="kobo.989.1">css/</span></code><span class="koboSpan" id="kobo.990.1"> directory into the </span><code class="inlineCode"><span class="koboSpan" id="kobo.991.1">static/</span></code><span class="koboSpan" id="kobo.992.1"> directory of your code. </span><span class="koboSpan" id="kobo.992.2">You can find the contents of the directory at </span><a href="https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter06/bookmarks/images/static"><span class="url"><span class="koboSpan" id="kobo.993.1">https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter06/bookmarks/images/static</span></span></a><span class="koboSpan" id="kobo.994.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.995.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.996.1">css/bookmarklet.css</span></code><span class="koboSpan" id="kobo.997.1"> file provides the styles for the JavaScript bookmarklet. </span><span class="koboSpan" id="kobo.997.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.998.1">static/</span></code><span class="koboSpan" id="kobo.999.1"> directory should contain the following file structure now:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1000.1">  css/
    bookmarklet.css
  js/
    bookmarklet.js
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1001.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1002.1">bookmarklet.js</span></code><span class="koboSpan" id="kobo.1003.1"> static file and add the following JavaScript code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1004.1">const siteUrl = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1005.1">'//127.0.0.1:8000/'</span></span><span class="koboSpan" id="kobo.1006.1">;
const styleUrl = siteUrl + </span><span class="hljs-string"><span class="koboSpan" id="kobo.1007.1">'static/css/bookmarklet.css'</span></span><span class="koboSpan" id="kobo.1008.1">;
const minWidth = </span><span class="hljs-number"><span class="koboSpan" id="kobo.1009.1">250</span></span><span class="koboSpan" id="kobo.1010.1">;
const minHeight = </span><span class="hljs-number"><span class="koboSpan" id="kobo.1011.1">250</span></span><span class="koboSpan" id="kobo.1012.1">;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1013.1">You have declared four different constants that will be used by the bookmarklet. </span><span class="koboSpan" id="kobo.1013.2">These constants are:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1014.1">siteUrl</span></code><span class="koboSpan" id="kobo.1015.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1016.1">staticUrl</span></code><span class="koboSpan" id="kobo.1017.1">: The base URL for the website and the base URL for static files.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1018.1">minWidth</span></code><span class="koboSpan" id="kobo.1019.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1020.1">minHeight</span></code><span class="koboSpan" id="kobo.1021.1">: The minimum width and height in pixels for the images that the bookmarklet will collect from the site. </span><span class="koboSpan" id="kobo.1021.2">The bookmarklet will identify images that have at least </span><code class="inlineCode"><span class="koboSpan" id="kobo.1022.1">250px</span></code><span class="koboSpan" id="kobo.1023.1"> width and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1024.1">250px</span></code><span class="koboSpan" id="kobo.1025.1"> height.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1026.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1027.1">bookmarklet.js</span></code><span class="koboSpan" id="kobo.1028.1"> static file </span><a id="_idIndexMarker538"/><span class="koboSpan" id="kobo.1029.1">and add the following code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1030.1">const siteUrl = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1031.1">'//127.0.0.1:8000/'</span></span><span class="koboSpan" id="kobo.1032.1">;
const styleUrl = siteUrl + </span><span class="hljs-string"><span class="koboSpan" id="kobo.1033.1">'static/css/bookmarklet.css'</span></span><span class="koboSpan" id="kobo.1034.1">;
const minWidth = </span><span class="hljs-number"><span class="koboSpan" id="kobo.1035.1">250</span></span><span class="koboSpan" id="kobo.1036.1">;
const minHeight = </span><span class="hljs-number"><span class="koboSpan" id="kobo.1037.1">250</span></span><span class="koboSpan" id="kobo.1038.1">;
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1039.1">// load CSS</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1040.1">var head = document.getElementsByTagName(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1041.1">'</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1042.1">head'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1043.1">)[</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.1044.1">0</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1045.1">];</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1046.1">var link = document.createElement(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1047.1">'link'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1048.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1049.1">link.rel = </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1050.1">'stylesheet'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1051.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1052.1">link.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1053.1">type</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1054.1"> = </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1055.1">'text/css'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1056.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1057.1">link.href = styleUrl + </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1058.1">'?r='</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1059.1"> + Math.floor(Math.random()*</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.1060.1">9999999999999999</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1061.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1062.1">head.appendChild(link);</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1063.1">This section loads the CSS stylesheet for the bookmarklet. </span><span class="koboSpan" id="kobo.1063.2">We use JavaScript to manipulate the </span><strong class="keyWord"><span class="koboSpan" id="kobo.1064.1">Document Object Model</span></strong><span class="koboSpan" id="kobo.1065.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.1066.1">DOM</span></strong><span class="koboSpan" id="kobo.1067.1">). </span><span class="koboSpan" id="kobo.1067.2">The DOM represents an HTML document in memory and it is</span><a id="_idIndexMarker539"/><span class="koboSpan" id="kobo.1068.1"> created by the browser when a web page is</span><a id="_idIndexMarker540"/><span class="koboSpan" id="kobo.1069.1"> loaded. </span><span class="koboSpan" id="kobo.1069.2">The DOM is constructed as a tree of objects that comprise the structure and content of the HTML document.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1070.1">The previous code generates an object equivalent to the following JavaScript code and appends it to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1071.1">&lt;head&gt;</span></code><span class="koboSpan" id="kobo.1072.1"> element of the HTML page:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.1073.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1074.1">link</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1075.1">rel</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1076.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1077.1">"stylesheet"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1078.1">type</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1079.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1080.1">"text/css"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1081.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1082.1">= </span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1083.1">"//127.0.0.1:8000/static/css/bookmarklet.css?r=1234567890123456"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1084.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1085.1">Let’s review how this is done:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1086.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1087.1">&lt;head&gt;</span></code><span class="koboSpan" id="kobo.1088.1"> element of the site is retrieved with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1089.1">document.getElementsByTagName()</span></code><span class="koboSpan" id="kobo.1090.1">. </span><span class="koboSpan" id="kobo.1090.2">This function retrieves all HTML elements of the page with the given tag. </span><span class="koboSpan" id="kobo.1090.3">By using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1091.1">[0]</span></code><span class="koboSpan" id="kobo.1092.1">, we access the first instance found. </span><span class="koboSpan" id="kobo.1092.2">We access the first element because all HTML documents should have a single </span><code class="inlineCode"><span class="koboSpan" id="kobo.1093.1">&lt;head&gt;</span></code><span class="koboSpan" id="kobo.1094.1"> element.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1095.1">A </span><code class="inlineCode"><span class="koboSpan" id="kobo.1096.1">&lt;link&gt;</span></code><span class="koboSpan" id="kobo.1097.1"> element is created with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1098.1">document.createElement('link')</span></code><span class="koboSpan" id="kobo.1099.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1100.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1101.1">rel</span></code><span class="koboSpan" id="kobo.1102.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1103.1">type</span></code><span class="koboSpan" id="kobo.1104.1"> attributes of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1105.1">&lt;link&gt;</span></code><span class="koboSpan" id="kobo.1106.1"> element are set. </span><span class="koboSpan" id="kobo.1106.2">This is equivalent to the HTML </span><code class="inlineCode"><span class="koboSpan" id="kobo.1107.1">&lt;link rel="stylesheet" type="text/css"&gt;</span></code><span class="koboSpan" id="kobo.1108.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1109.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1110.1">href</span></code><span class="koboSpan" id="kobo.1111.1"> attribute of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1112.1">&lt;link&gt;</span></code><span class="koboSpan" id="kobo.1113.1"> element is set with the URL of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1114.1">bookmarklet.css</span></code><span class="koboSpan" id="kobo.1115.1"> stylesheet. </span><span class="koboSpan" id="kobo.1115.2">A 16-digit random number is used as a URL parameter to prevent the browser from loading the file from the cache.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1116.1">The new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1117.1">&lt;link&gt;</span></code><span class="koboSpan" id="kobo.1118.1"> element is added to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1119.1">&lt;head&gt;</span></code><span class="koboSpan" id="kobo.1120.1"> element of the HTML page using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1121.1">head.appendChild(link)</span></code><span class="koboSpan" id="kobo.1122.1">.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1123.1">Now we will create the HTML element to display a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1124.1">&lt;div&gt;</span></code><span class="koboSpan" id="kobo.1125.1"> container on the website where the bookmarklet is</span><a id="_idIndexMarker541"/><span class="koboSpan" id="kobo.1126.1"> executed. </span><span class="koboSpan" id="kobo.1126.2">The</span><a id="_idIndexMarker542"/><span class="koboSpan" id="kobo.1127.1"> HTML container will be used to display all images found on the site and let users choose the image they want to share. </span><span class="koboSpan" id="kobo.1127.2">It will use the CSS styles defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1128.1">bookmarklet.css</span></code><span class="koboSpan" id="kobo.1129.1"> stylesheet.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1130.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1131.1">bookmarklet.js</span></code><span class="koboSpan" id="kobo.1132.1"> static file and add the following code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1133.1">const siteUrl = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1134.1">'//127.0.0.1:8000/'</span></span><span class="koboSpan" id="kobo.1135.1">;
const styleUrl = siteUrl + </span><span class="hljs-string"><span class="koboSpan" id="kobo.1136.1">'static/css/bookmarklet.css'</span></span><span class="koboSpan" id="kobo.1137.1">;
const minWidth = </span><span class="hljs-number"><span class="koboSpan" id="kobo.1138.1">250</span></span><span class="koboSpan" id="kobo.1139.1">;
const minHeight = </span><span class="hljs-number"><span class="koboSpan" id="kobo.1140.1">250</span></span><span class="koboSpan" id="kobo.1141.1">;
// load CSS
var head = document.getElementsByTagName(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1142.1">'head'</span></span><span class="koboSpan" id="kobo.1143.1">)[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1144.1">0</span></span><span class="koboSpan" id="kobo.1145.1">];
var link = document.createElement(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1146.1">'link'</span></span><span class="koboSpan" id="kobo.1147.1">);
link.rel = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1148.1">'stylesheet'</span></span><span class="koboSpan" id="kobo.1149.1">;
link.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1150.1">type</span></span><span class="koboSpan" id="kobo.1151.1"> = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1152.1">'text/css'</span></span><span class="koboSpan" id="kobo.1153.1">;
link.href = styleUrl + </span><span class="hljs-string"><span class="koboSpan" id="kobo.1154.1">'?r='</span></span><span class="koboSpan" id="kobo.1155.1"> + Math.floor(Math.random()*</span><span class="hljs-number"><span class="koboSpan" id="kobo.1156.1">9999999999999999</span></span><span class="koboSpan" id="kobo.1157.1">);
head.appendChild(link);
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1158.1">// load HTML</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1159.1">var body = document.getElementsByTagName(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1160.1">'body'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1161.1">)[</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.1162.1">0</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1163.1">];</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1164.1">boxHtml = `</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1165.1">  &lt;div </span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1166.1">id</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1167.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1168.1">"bookmarklet"</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1169.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1170.1">    &lt;a href=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1171.1">"#"</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1172.1">id</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1173.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1174.1">"close"</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1175.1">&gt;&amp;times;&lt;/a&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1176.1">    &lt;h1&gt;Select an image to bookmark:&lt;/h1&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1177.1">    &lt;div </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1178.1">class</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1179.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1180.1">"images"</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1181.1">&gt;&lt;/div&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1182.1">   &lt;/div&gt;`;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1183.1">body.innerHTML += boxHtml;</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1184.1">With this code, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1185.1">&lt;body&gt;</span></code><span class="koboSpan" id="kobo.1186.1"> element of the DOM is retrieved and new HTML is added to it by modifying its property </span><code class="inlineCode"><span class="koboSpan" id="kobo.1187.1">innerHTML</span></code><span class="koboSpan" id="kobo.1188.1">. </span><span class="koboSpan" id="kobo.1188.2">A new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1189.1">&lt;div&gt;</span></code><span class="koboSpan" id="kobo.1190.1"> element is added to the body of the page. </span><span class="koboSpan" id="kobo.1190.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1191.1">&lt;div&gt;</span></code><span class="koboSpan" id="kobo.1192.1"> container consists of the following elements:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.1193.1">A link to close the container defined with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1194.1">&lt;a href="#" id="close"&gt;&amp;times;&lt;/a&gt;</span></code><span class="koboSpan" id="kobo.1195.1">.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1196.1">A title defined with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1197.1">&lt;h1&gt;Select an image to bookmark:&lt;/h1&gt;</span></code><span class="koboSpan" id="kobo.1198.1">.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.1199.1">A </span><code class="inlineCode"><span class="koboSpan" id="kobo.1200.1">&lt;div&gt;</span></code><span class="koboSpan" id="kobo.1201.1"> element to list the images found on the site defined with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1202.1">&lt;div class="images"&gt;&lt;/div&gt;</span></code><span class="koboSpan" id="kobo.1203.1">. </span><span class="koboSpan" id="kobo.1203.2">This container is initially empty and will be filled with the images found on the site.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1204.1">The HTML container, including the</span><a id="_idIndexMarker543"/><span class="koboSpan" id="kobo.1205.1"> previously loaded CSS </span><a id="_idIndexMarker544"/><span class="koboSpan" id="kobo.1206.1">styles, will look like </span><em class="italic"><span class="koboSpan" id="kobo.1207.1">Figure 6.9</span></em><span class="koboSpan" id="kobo.1208.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1209.1"><img alt="" role="presentation" src="../Images/B21088_06_09.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1210.1">Figure 6.9: The image selection container</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1211.1">Now let’s implement a function to launch the bookmarklet. </span><span class="koboSpan" id="kobo.1211.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1212.1">bookmarklet.js</span></code><span class="koboSpan" id="kobo.1213.1"> static file and add the following code at the bottom:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1214.1">function</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1215.1">bookmarkletLaunch</span></span><span class="koboSpan" id="kobo.1216.1">() {
  bookmarklet = </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1217.1">document</span></span><span class="koboSpan" id="kobo.1218.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1219.1">getElementById</span></span><span class="koboSpan" id="kobo.1220.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1221.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1222.1">bookmarklet'</span></span><span class="koboSpan" id="kobo.1223.1">);
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1224.1">var</span></span><span class="koboSpan" id="kobo.1225.1"> imagesFound = bookmarklet.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1226.1">querySelector</span></span><span class="koboSpan" id="kobo.1227.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1228.1">'.images'</span></span><span class="koboSpan" id="kobo.1229.1">);
  </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1230.1">// clear images found</span></span><span class="koboSpan" id="kobo.1231.1">
  imagesFound.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1232.1">innerHTML</span></span><span class="koboSpan" id="kobo.1233.1"> = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1234.1">''</span></span><span class="koboSpan" id="kobo.1235.1">;
  </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1236.1">// display bookmarklet</span></span><span class="koboSpan" id="kobo.1237.1">
  bookmarklet.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1238.1">style</span></span><span class="koboSpan" id="kobo.1239.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1240.1">display</span></span><span class="koboSpan" id="kobo.1241.1"> = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1242.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1243.1">block'</span></span><span class="koboSpan" id="kobo.1244.1">;
  </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1245.1">// close event</span></span><span class="koboSpan" id="kobo.1246.1">
  bookmarklet.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1247.1">querySelector</span></span><span class="koboSpan" id="kobo.1248.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1249.1">'#close'</span></span><span class="koboSpan" id="kobo.1250.1">)
             .</span><span class="hljs-title"><span class="koboSpan" id="kobo.1251.1">addEventListener</span></span><span class="koboSpan" id="kobo.1252.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1253.1">'click'</span></span><span class="koboSpan" id="kobo.1254.1">, </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1255.1">function</span></span><span class="koboSpan" id="kobo.1256.1">(){
               bookmarklet.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1257.1">style</span></span><span class="koboSpan" id="kobo.1258.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1259.1">display</span></span><span class="koboSpan" id="kobo.1260.1"> = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1261.1">'none'</span></span><span class="koboSpan" id="kobo.1262.1">
             });
}
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.1263.1">// launch the bookmkarklet</span></span>
<span class="hljs-title"><span class="koboSpan" id="kobo.1264.1">bookmarkletLaunch</span></span><span class="koboSpan" id="kobo.1265.1">();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1266.1">This is the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1267.1">bookmarkletLaunch()</span></code><span class="koboSpan" id="kobo.1268.1"> function. </span><span class="koboSpan" id="kobo.1268.2">Before the definition of this function, the CSS for the bookmarklet is loaded and the </span><a id="_idIndexMarker545"/><span class="koboSpan" id="kobo.1269.1">HTML container is added to the DOM of the page. </span><span class="koboSpan" id="kobo.1269.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1270.1">bookmarkletLaunch()</span></code><span class="koboSpan" id="kobo.1271.1"> function</span><a id="_idIndexMarker546"/><span class="koboSpan" id="kobo.1272.1"> works as follows:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1273.1">The bookmarklet’s main container is retrieved by getting the DOM element with the ID </span><code class="inlineCode"><span class="koboSpan" id="kobo.1274.1">bookmarklet</span></code><span class="koboSpan" id="kobo.1275.1"> with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1276.1">document.getElementById()</span></code><span class="koboSpan" id="kobo.1277.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1278.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1279.1">bookmarklet</span></code><span class="koboSpan" id="kobo.1280.1"> element is used to retrieve the child element with the class </span><code class="inlineCode"><span class="koboSpan" id="kobo.1281.1">images</span></code><span class="koboSpan" id="kobo.1282.1">. </span><span class="koboSpan" id="kobo.1282.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1283.1">querySelector()</span></code><span class="koboSpan" id="kobo.1284.1"> method allows you to retrieve DOM elements using CSS selectors. </span><span class="koboSpan" id="kobo.1284.2">Selectors allow you to find DOM elements to which a set of CSS rules applies. </span><span class="koboSpan" id="kobo.1284.3">You can find a list of CSS selectors at </span><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Selectors"><span class="url"><span class="koboSpan" id="kobo.1285.1">https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Selectors</span></span></a><span class="koboSpan" id="kobo.1286.1"> and you can read more information about how to locate DOM elements using selectors at </span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Document_object_model/Locating_DOM_elements_using_selectors"><span class="url"><span class="koboSpan" id="kobo.1287.1">https://developer.mozilla.org/en-US/docs/Web/API/Document_object_model/Locating_DOM_elements_using_selectors</span></span></a><span class="koboSpan" id="kobo.1288.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1289.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1290.1">images</span></code><span class="koboSpan" id="kobo.1291.1"> container is cleared by setting its </span><code class="inlineCode"><span class="koboSpan" id="kobo.1292.1">innerHTML</span></code><span class="koboSpan" id="kobo.1293.1"> attribute to an empty string and the bookmarklet is displayed by setting the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1294.1">display</span></code><span class="koboSpan" id="kobo.1295.1"> CSS property to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1296.1">block</span></code><span class="koboSpan" id="kobo.1297.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1298.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1299.1">#close</span></code><span class="koboSpan" id="kobo.1300.1"> selector is used to find the DOM element with the ID </span><code class="inlineCode"><span class="koboSpan" id="kobo.1301.1">close</span></code><span class="koboSpan" id="kobo.1302.1">. </span><span class="koboSpan" id="kobo.1302.2">A </span><code class="inlineCode"><span class="koboSpan" id="kobo.1303.1">click</span></code><span class="koboSpan" id="kobo.1304.1"> event is attached to the element with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1305.1">addEventListener()</span></code><span class="koboSpan" id="kobo.1306.1"> method. </span><span class="koboSpan" id="kobo.1306.2">When users click the element, the bookmarklet’s main container is hidden by setting its </span><code class="inlineCode"><span class="koboSpan" id="kobo.1307.1">display</span></code><span class="koboSpan" id="kobo.1308.1"> property to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1309.1">none</span></code><span class="koboSpan" id="kobo.1310.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1311.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1312.1">bookmarkletLaunch()</span></code><span class="koboSpan" id="kobo.1313.1"> function is executed after its definition.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1314.1">After loading the CSS styles and the HTML container of the bookmarklet, you have to find image elements in the DOM of the current website. </span><span class="koboSpan" id="kobo.1314.2">Images that have the minimum required dimension have to be added to the HTML container of the bookmarklet. </span><span class="koboSpan" id="kobo.1314.3">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1315.1">bookmarklet.js</span></code><span class="koboSpan" id="kobo.1316.1"> static</span><a id="_idIndexMarker547"/><span class="koboSpan" id="kobo.1317.1"> file and add the following code highlighted in bold to the bottom of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1318.1">bookmarklet()</span></code><span class="koboSpan" id="kobo.1319.1"> function:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1320.1">function</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1321.1">bookmarkletLaunch</span></span><span class="koboSpan" id="kobo.1322.1">() {
  bookmarklet = </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1323.1">document</span></span><span class="koboSpan" id="kobo.1324.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1325.1">getElementById</span></span><span class="koboSpan" id="kobo.1326.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1327.1">'bookmarklet'</span></span><span class="koboSpan" id="kobo.1328.1">);
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1329.1">var</span></span><span class="koboSpan" id="kobo.1330.1"> imagesFound = bookmarklet.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1331.1">querySelector</span></span><span class="koboSpan" id="kobo.1332.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1333.1">'.images'</span></span><span class="koboSpan" id="kobo.1334.1">);
  </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1335.1">// clear images found</span></span><span class="koboSpan" id="kobo.1336.1">
  imagesFound.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1337.1">innerHTML</span></span><span class="koboSpan" id="kobo.1338.1"> = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1339.1">''</span></span><span class="koboSpan" id="kobo.1340.1">;
  </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1341.1">// display bookmarklet</span></span><span class="koboSpan" id="kobo.1342.1">
  bookmarklet.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1343.1">style</span></span><span class="koboSpan" id="kobo.1344.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1345.1">display</span></span><span class="koboSpan" id="kobo.1346.1"> = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1347.1">'block'</span></span><span class="koboSpan" id="kobo.1348.1">;
  </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1349.1">// close event</span></span><span class="koboSpan" id="kobo.1350.1">
  bookmarklet.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1351.1">querySelector</span></span><span class="koboSpan" id="kobo.1352.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1353.1">'#close'</span></span><span class="koboSpan" id="kobo.1354.1">)
             .</span><span class="hljs-title"><span class="koboSpan" id="kobo.1355.1">addEventListener</span></span><span class="koboSpan" id="kobo.1356.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1357.1">'click'</span></span><span class="koboSpan" id="kobo.1358.1">, </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1359.1">function</span></span><span class="koboSpan" id="kobo.1360.1">(){
               bookmarklet.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1361.1">style</span></span><span class="koboSpan" id="kobo.1362.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1363.1">display</span></span><span class="koboSpan" id="kobo.1364.1"> = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1365.1">'none'</span></span><span class="koboSpan" id="kobo.1366.1">
             });
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1367.1">// find images in the DOM with the minimum dimensions</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1368.1">  images = </span></strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1369.1">document</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1370.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1371.1">querySelectorAll</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1372.1">(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1373.1">'img[src$=".jpg"], img[src$=".jpeg"], img[src$=".png"]'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1374.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1375.1">  images.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1376.1">forEach</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1377.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1378.1">image</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.1379.1"> =&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1380.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1381.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1382.1">(image.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1383.1">naturalWidth</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1384.1"> &gt;= minWidth</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1385.1">       &amp;&amp; image.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1386.1">naturalHeight</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1387.1"> &gt;= minHeight)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1388.1">    {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1389.1">var</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1390.1"> imageFound = </span></strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1391.1">document</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1392.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1393.1">createElement</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1394.1">(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1395.1">'img'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1396.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1397.1">      imageFound.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1398.1">src</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1399.1"> = image.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1400.1">src</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1401.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1402.1">      imagesFound.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1403.1">append</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1404.1">(imageFound);</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1405.1">    }</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1406.1">  })</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1407.1">}</span></strong></span>
<span class="code-highlight"><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1408.1">// launch the bookmkarklet</span></strong></span>
<span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1409.1">bookmarkletLaunch</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1410.1">();</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1411.1">The preceding code uses the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1412.1">img[src$=".jpg"]</span></code><span class="koboSpan" id="kobo.1413.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1414.1">img[src$=".jpeg"]</span></code><span class="koboSpan" id="kobo.1415.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1416.1">img[src$=".png"]</span></code><span class="koboSpan" id="kobo.1417.1"> selectors to find all </span><code class="inlineCode"><span class="koboSpan" id="kobo.1418.1">&lt;img&gt;</span></code><span class="koboSpan" id="kobo.1419.1"> DOM elements whose </span><code class="inlineCode"><span class="koboSpan" id="kobo.1420.1">src</span></code><span class="koboSpan" id="kobo.1421.1"> attribute finishes with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1422.1">.jpg</span></code><span class="koboSpan" id="kobo.1423.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1424.1">.jpeg</span></code><span class="koboSpan" id="kobo.1425.1">, or, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1426.1">.png</span></code><span class="koboSpan" id="kobo.1427.1">, respectively. </span><span class="koboSpan" id="kobo.1427.2">Using these selectors with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1428.1">document.querySelectorAll()</span></code><span class="koboSpan" id="kobo.1429.1"> allows you to find all images in JPEG and PNG format displayed on the website. </span><span class="koboSpan" id="kobo.1429.2">Iteration over </span><a id="_idIndexMarker548"/><span class="koboSpan" id="kobo.1430.1">the results is performed with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1431.1">forEach()</span></code><span class="koboSpan" id="kobo.1432.1"> method. </span><span class="koboSpan" id="kobo.1432.2">Small images are filtered out because we don’t consider them to be relevant. </span><span class="koboSpan" id="kobo.1432.3">Only images with a size larger than the one specified with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1433.1">minWidth</span></code><span class="koboSpan" id="kobo.1434.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1435.1">minHeight</span></code><span class="koboSpan" id="kobo.1436.1"> variables are used for the results. </span><span class="koboSpan" id="kobo.1436.2">A new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1437.1">&lt;img&gt;</span></code><span class="koboSpan" id="kobo.1438.1"> element is created for each image found, where the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1439.1">src</span></code><span class="koboSpan" id="kobo.1440.1"> source URL attribute is copied from the original image and added to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1441.1">imagesFound</span></code><span class="koboSpan" id="kobo.1442.1"> container.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1443.1">For security reasons, your browser will prevent you from running the bookmarklet over HTTP on a site served through HTTPS. </span><span class="koboSpan" id="kobo.1443.2">That’s the reason we keep using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1444.1">RunServerPlus</span></code><span class="koboSpan" id="kobo.1445.1"> to run the development </span><a id="_idIndexMarker549"/><span class="koboSpan" id="kobo.1446.1">server using an auto-generated TLS/SSL certificate. </span><span class="koboSpan" id="kobo.1446.2">Remember that you learned how to run the development server through HTTPS in </span><em class="italic"><span class="koboSpan" id="kobo.1447.1">Chapter 5, Implementing Social Authentication</span></em><span class="koboSpan" id="kobo.1448.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1449.1">In a production environment, a valid TLS/SSL certificate will be required. </span><span class="koboSpan" id="kobo.1449.2">When you own a domain name, you can apply for a trusted </span><strong class="keyWord"><span class="koboSpan" id="kobo.1450.1">Certification Authority</span></strong><span class="koboSpan" id="kobo.1451.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.1452.1">CA</span></strong><span class="koboSpan" id="kobo.1453.1">) to issue a TLS/SSL certificate for it so that browsers can verify its identity. </span><span class="koboSpan" id="kobo.1453.2">If you want to obtain a trusted certificate for a real domain, you can use the </span><em class="italic"><span class="koboSpan" id="kobo.1454.1">Let’s Encrypt</span></em><span class="koboSpan" id="kobo.1455.1"> service. </span><em class="italic"><span class="koboSpan" id="kobo.1456.1">Let’s Encrypt</span></em><span class="koboSpan" id="kobo.1457.1"> is a non-profit CA that simplifies obtaining and renewing trusted TLS/SSL certificates for free. </span><span class="koboSpan" id="kobo.1457.2">You can find more</span><a id="_idIndexMarker550"/><span class="koboSpan" id="kobo.1458.1"> information at </span><a href="https://letsencrypt.org"><span class="url"><span class="koboSpan" id="kobo.1459.1">https://letsencrypt.org</span></span></a><span class="koboSpan" id="kobo.1460.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1461.1">Run the development server with the following command from the shell prompt:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1462.1">python manage.py runserver_plus --cert-file cert.crt
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1463.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.1464.1">https://127.0.0.1:8000/account/</span></code><span class="koboSpan" id="kobo.1465.1"> in your browser. </span><span class="koboSpan" id="kobo.1465.2">Log in with an existing user, then click and drag the </span><strong class="screenText"><span class="koboSpan" id="kobo.1466.1">BOOKMARK IT</span></strong><span class="koboSpan" id="kobo.1467.1"> button to the bookmarks bar of your browser, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1468.1"><img alt="" role="presentation" src="../Images/B21088_06_10.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1469.1">Figure 6.10: Adding the BOOKMARK IT button to the bookmarks bar</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1470.1">Open a website of your choice in your browser and click on the </span><strong class="screenText"><span class="koboSpan" id="kobo.1471.1">Bookmark it</span></strong><span class="koboSpan" id="kobo.1472.1"> bookmarklet in the bookmarks bar. </span><span class="koboSpan" id="kobo.1472.2">You will see that a new white overlay appears on the website, displaying all JPEG and PNG images found with dimensions higher than 250×250 pixels. </span></p>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.1473.1">Figure 6.11</span></em><span class="koboSpan" id="kobo.1474.1"> shows the bookmarklet running on </span><a href="https://amazon.com/"><span class="url"><span class="koboSpan" id="kobo.1475.1">https://amazon.com/</span></span></a><span class="koboSpan" id="kobo.1476.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1477.1"><img alt="" role="presentation" src="../Images/B21088_06_11.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1478.1">Figure 6.11: The bookmarklet loaded on amazon.com</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1479.1">If the HTML container doesn’t</span><a id="_idIndexMarker551"/><span class="koboSpan" id="kobo.1480.1"> appear, check the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1481.1">RunServer</span></code><span class="koboSpan" id="kobo.1482.1"> shell console log. </span><span class="koboSpan" id="kobo.1482.2">If you see a MIME type error, it is most likely that your </span><a id="_idIndexMarker552"/><span class="koboSpan" id="kobo.1483.1">MIME map files are incorrect or need to be updated. </span><span class="koboSpan" id="kobo.1483.2">You can apply the correct mapping for JavaScript and CSS files by adding the following lines to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1484.1">settings.py</span></code><span class="koboSpan" id="kobo.1485.1"> file:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1486.1">if</span></span><span class="koboSpan" id="kobo.1487.1"> DEBUG:
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1488.1">import</span></span><span class="koboSpan" id="kobo.1489.1"> mimetypes
    mimetypes.add_type(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1490.1">'application/javascript'</span></span><span class="koboSpan" id="kobo.1491.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1492.1">'.js'</span></span><span class="koboSpan" id="kobo.1493.1">, </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1494.1">True</span></span><span class="koboSpan" id="kobo.1495.1">)
    mimetypes.add_type(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1496.1">'text/css'</span></span><span class="koboSpan" id="kobo.1497.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1498.1">'.css'</span></span><span class="koboSpan" id="kobo.1499.1">, </span><span class="hljs-literal"><span class="koboSpan" id="kobo.1500.1">True</span></span><span class="koboSpan" id="kobo.1501.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1502.1">The HTML container includes the images that can be bookmarked. </span><span class="koboSpan" id="kobo.1502.2">We will now implement the functionality</span><a id="_idIndexMarker553"/><span class="koboSpan" id="kobo.1503.1"> for users to click on the desired image to bookmark it.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1504.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1505.1">js/bookmarklet.js</span></code><span class="koboSpan" id="kobo.1506.1"> static file and add the following code at the bottom of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1507.1">bookmarklet()</span></code><span class="koboSpan" id="kobo.1508.1"> function:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1509.1">function</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1510.1">bookmarkletLaunch</span></span><span class="koboSpan" id="kobo.1511.1">() {
  bookmarklet = </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1512.1">document</span></span><span class="koboSpan" id="kobo.1513.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1514.1">getElementById</span></span><span class="koboSpan" id="kobo.1515.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1516.1">'bookmarklet'</span></span><span class="koboSpan" id="kobo.1517.1">);
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1518.1">var</span></span><span class="koboSpan" id="kobo.1519.1"> imagesFound = bookmarklet.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1520.1">querySelector</span></span><span class="koboSpan" id="kobo.1521.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1522.1">'.images'</span></span><span class="koboSpan" id="kobo.1523.1">);
  </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1524.1">// clear images found</span></span><span class="koboSpan" id="kobo.1525.1">
  imagesFound.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1526.1">innerHTML</span></span><span class="koboSpan" id="kobo.1527.1"> = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1528.1">''</span></span><span class="koboSpan" id="kobo.1529.1">;
  </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1530.1">// display bookmarklet</span></span><span class="koboSpan" id="kobo.1531.1">
  bookmarklet.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1532.1">style</span></span><span class="koboSpan" id="kobo.1533.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1534.1">display</span></span><span class="koboSpan" id="kobo.1535.1"> = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1536.1">'block'</span></span><span class="koboSpan" id="kobo.1537.1">;
  </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1538.1">// close event</span></span><span class="koboSpan" id="kobo.1539.1">
  bookmarklet.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1540.1">querySelector</span></span><span class="koboSpan" id="kobo.1541.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1542.1">'#close'</span></span><span class="koboSpan" id="kobo.1543.1">)
             .</span><span class="hljs-title"><span class="koboSpan" id="kobo.1544.1">addEventListener</span></span><span class="koboSpan" id="kobo.1545.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1546.1">'click'</span></span><span class="koboSpan" id="kobo.1547.1">, </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1548.1">function</span></span><span class="koboSpan" id="kobo.1549.1">(){
               bookmarklet.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1550.1">style</span></span><span class="koboSpan" id="kobo.1551.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1552.1">display</span></span><span class="koboSpan" id="kobo.1553.1"> = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1554.1">'none'</span></span><span class="koboSpan" id="kobo.1555.1">
             });
  </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1556.1">// find images in the DOM with the minimum dimensions</span></span><span class="koboSpan" id="kobo.1557.1">
  images = </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1558.1">document</span></span><span class="koboSpan" id="kobo.1559.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1560.1">querySelectorAll</span></span><span class="koboSpan" id="kobo.1561.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1562.1">'img[src$=".jpg"], img[src$=".jpeg"], img[src$=".png"]'</span></span><span class="koboSpan" id="kobo.1563.1">);
  images.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1564.1">forEach</span></span><span class="koboSpan" id="kobo.1565.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1566.1">image</span></span><span class="hljs-function"><span class="koboSpan" id="kobo.1567.1"> =&gt;</span></span><span class="koboSpan" id="kobo.1568.1"> {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1569.1">if</span></span><span class="koboSpan" id="kobo.1570.1">(image.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1571.1">naturalWidth</span></span><span class="koboSpan" id="kobo.1572.1"> &gt;= minWidth
       &amp;&amp; image.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1573.1">naturalHeight</span></span><span class="koboSpan" id="kobo.1574.1"> &gt;= minHeight)
    {
      </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1575.1">var</span></span><span class="koboSpan" id="kobo.1576.1"> imageFound = </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1577.1">document</span></span><span class="koboSpan" id="kobo.1578.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1579.1">createElement</span></span><span class="koboSpan" id="kobo.1580.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1581.1">'img'</span></span><span class="koboSpan" id="kobo.1582.1">);
      imageFound.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1583.1">src</span></span><span class="koboSpan" id="kobo.1584.1"> = image.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1585.1">src</span></span><span class="koboSpan" id="kobo.1586.1">;
      imagesFound.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1587.1">append</span></span><span class="koboSpan" id="kobo.1588.1">(imageFound);
    }
  })
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1589.1">// select image event</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1590.1">  imagesFound.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1591.1">querySelectorAll</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1592.1">(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1593.1">'img'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1594.1">).</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1595.1">forEach</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1596.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1597.1">image</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.1598.1"> =&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1599.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1600.1">    image.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1601.1">addEventListener</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1602.1">(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1603.1">'click'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1604.1">, </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1605.1">function</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1606.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1607.1">event</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1608.1">){</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1609.1">      imageSelected = event.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1610.1">target</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1611.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1612.1">      bookmarklet.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1613.1">style</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1614.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1615.1">display</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1616.1"> = </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1617.1">'none'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1618.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1619.1">window</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1620.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1621.1">open</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1622.1">(siteUrl + </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1623.1">'images/create/?url='</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1624.1">                  + </span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1625.1">encodeURIComponent</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1626.1">(imageSelected.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1627.1">src</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1628.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1629.1">                  + </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1630.1">'&amp;title='</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1631.1">                  + </span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1632.1">encodeURIComponent</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1633.1">(</span></strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1634.1">document</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1635.1">.</span></strong><strong class="hljs-property-slc"><span class="koboSpan" id="kobo.1636.1">title</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1637.1">),</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1638.1">'_blank'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1639.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1640.1">    })</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1641.1">  })</span></strong></span><span class="koboSpan" id="kobo.1642.1">
}
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.1643.1">// launch the bookmkarklet</span></span>
<span class="hljs-title"><span class="koboSpan" id="kobo.1644.1">bookmarkletLaunch</span></span><span class="koboSpan" id="kobo.1645.1">();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1646.1">The preceding code</span><a id="_idIndexMarker554"/><span class="koboSpan" id="kobo.1647.1"> works as follows:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1648.1">A </span><code class="inlineCode"><span class="koboSpan" id="kobo.1649.1">click()</span></code><span class="koboSpan" id="kobo.1650.1"> event is attached to each image element within the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1651.1">imagesFound</span></code><span class="koboSpan" id="kobo.1652.1"> container.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1653.1">When the user clicks on any of the images, the image element clicked is stored in the variable </span><code class="inlineCode"><span class="koboSpan" id="kobo.1654.1">imageSelected</span></code><span class="koboSpan" id="kobo.1655.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1656.1">The bookmarklet is then hidden by setting its </span><code class="inlineCode"><span class="koboSpan" id="kobo.1657.1">display</span></code><span class="koboSpan" id="kobo.1658.1"> property to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1659.1">none</span></code><span class="koboSpan" id="kobo.1660.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1661.1">A new browser window is </span><a id="_idIndexMarker555"/><span class="koboSpan" id="kobo.1662.1">opened with the URL to bookmark a new image on the site. </span><span class="koboSpan" id="kobo.1662.2">The content of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1663.1">&lt;title&gt;</span></code><span class="koboSpan" id="kobo.1664.1"> element of the website is passed to the URL in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1665.1">title</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.1666.1">GET</span></code><span class="koboSpan" id="kobo.1667.1"> parameter and the selected image URL is passed in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1668.1">url</span></code><span class="koboSpan" id="kobo.1669.1"> parameter.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1670.1">Open a new URL with your </span><a id="_idIndexMarker556"/><span class="koboSpan" id="kobo.1671.1">browser, for example, </span><a href="https://commons.wikimedia.org/"><span class="url"><span class="koboSpan" id="kobo.1672.1">https://commons.wikimedia.org/</span></span></a><span class="koboSpan" id="kobo.1673.1">, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1674.1"><img alt="" role="presentation" src="../Images/B21088_06_12.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1675.1">Figure 6.12: The Wikimedia Commons website</span></p>
<div class="note">
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.1676.1">Figures 6.12</span></em><span class="koboSpan" id="kobo.1677.1"> to </span><em class="italic"><span class="koboSpan" id="kobo.1678.1">6.15</span></em><span class="koboSpan" id="kobo.1679.1"> image: </span><em class="italic"><span class="koboSpan" id="kobo.1680.1">A flock of cranes (Grus grus) in Hula Valley, Northern Israel</span></em><span class="koboSpan" id="kobo.1681.1"> by Tomere (Licence: Creative Commons Attribution-Share Alike 4.0 International: </span><span class="url"><span class="koboSpan" id="kobo.1682.1">https://creativecommons.org/licenses/by-sa/4.0/deed.en</span></span><span class="koboSpan" id="kobo.1683.1">)</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.1684.1">Click on the </span><strong class="screenText"><span class="koboSpan" id="kobo.1685.1">Bookmark it</span></strong><span class="koboSpan" id="kobo.1686.1"> bookmarklet to display the image selection overlay. </span><span class="koboSpan" id="kobo.1686.2">You will see the image selection overlay like this:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1687.1"><img alt="" role="presentation" src="../Images/B21088_06_13.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1688.1">Figure 6.13: The bookmarklet loaded on an external website</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1689.1">If you click on an image, you will </span><a id="_idIndexMarker557"/><span class="koboSpan" id="kobo.1690.1">be redirected to</span><a id="_idIndexMarker558"/><span class="koboSpan" id="kobo.1691.1"> the image creation page, passing the title of the website and the URL of the selected image as </span><code class="inlineCode"><span class="koboSpan" id="kobo.1692.1">GET</span></code><span class="koboSpan" id="kobo.1693.1"> parameters. </span><span class="koboSpan" id="kobo.1693.2">The page will look as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1694.1"><img alt="" role="presentation" src="../Images/B21088_06_14.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1695.1">Figure 6.14: The form to bookmark an image</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1696.1">Congratulations! </span><span class="koboSpan" id="kobo.1696.2">This is your</span><a id="_idIndexMarker559"/><span class="koboSpan" id="kobo.1697.1"> first JavaScript </span><a id="_idIndexMarker560"/><span class="koboSpan" id="kobo.1698.1">bookmarklet, and it is fully integrated into your Django project. </span><span class="koboSpan" id="kobo.1698.2">Next, we will create the detail view for images and implement the canonical URL for images.</span></p>
<h1 class="heading-1" id="_idParaDest-184"><span class="koboSpan" id="kobo.1699.1">Creating a detail view for images</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1700.1">Let’s now create a simple detail view to</span><a id="_idIndexMarker561"/><span class="koboSpan" id="kobo.1701.1"> display images that have been bookmarked on the site. </span><span class="koboSpan" id="kobo.1701.2">Open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1702.1">views.py</span></code><span class="koboSpan" id="kobo.1703.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1704.1">images</span></code><span class="koboSpan" id="kobo.1705.1"> application and </span><a id="_idIndexMarker562"/><span class="koboSpan" id="kobo.1706.1">add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1707.1">from</span></span><span class="koboSpan" id="kobo.1708.1"> django.shortcuts </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1709.1">import</span></span><span class="koboSpan" id="kobo.1710.1"> get_object_or_404
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1711.1">from</span></span><span class="koboSpan" id="kobo.1712.1"> .models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1713.1">import</span></span><span class="koboSpan" id="kobo.1714.1"> Image
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1715.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1716.1">image_detail</span></span><span class="koboSpan" id="kobo.1717.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1718.1">request, </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1719.1">id</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1720.1">, slug</span></span><span class="koboSpan" id="kobo.1721.1">):
    image = get_object_or_404(Image, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1722.1">id</span></span><span class="koboSpan" id="kobo.1723.1">=</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1724.1">id</span></span><span class="koboSpan" id="kobo.1725.1">, slug=slug)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1726.1">return</span></span><span class="koboSpan" id="kobo.1727.1"> render(
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.1728.1">request,
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.1729.1">'images/image/detail.html'</span></span><span class="koboSpan" id="kobo.1730.1">,
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.1731.1">{</span><span class="hljs-string"><span class="koboSpan" id="kobo.1732.1">'section'</span></span><span class="koboSpan" id="kobo.1733.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1734.1">'images'</span></span><span class="koboSpan" id="kobo.1735.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1736.1">'image'</span></span><span class="koboSpan" id="kobo.1737.1">: image}
    )
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1738.1">This is a simple view to display an image. </span><span class="koboSpan" id="kobo.1738.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1739.1">urls.py</span></code><span class="koboSpan" id="kobo.1740.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1741.1">images</span></code><span class="koboSpan" id="kobo.1742.1"> application and add the following URL </span><a id="_idIndexMarker563"/><span class="koboSpan" id="kobo.1743.1">pattern highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1744.1">urlpatterns = [
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1745.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1746.1">create/'</span></span><span class="koboSpan" id="kobo.1747.1">, views.image_create, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1748.1">'create'</span></span><span class="koboSpan" id="kobo.1749.1">),
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1750.1">    path(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1751.1">'detail/&lt;int:id&gt;/&lt;slug:slug&gt;/'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1752.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1753.1">        views.image_detail,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1754.1">        name=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1755.1">'detail'</span></strong></span>
<span class="code-highlight"><strong class="hljs-string-slc"> </strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1756.1">),</span></strong></span><span class="koboSpan" id="kobo.1757.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1758.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1759.1">models.py</span></code><span class="koboSpan" id="kobo.1760.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1761.1">images</span></code><span class="koboSpan" id="kobo.1762.1"> application and add the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1763.1">get_absolute_url()</span></code><span class="koboSpan" id="kobo.1764.1"> method to</span><a id="_idIndexMarker564"/><span class="koboSpan" id="kobo.1765.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1766.1">Image</span></code><span class="koboSpan" id="kobo.1767.1"> model, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1768.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1769.1"> django.urls </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1770.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1771.1"> reverse</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1772.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1773.1">Image</span></span><span class="koboSpan" id="kobo.1774.1">(models.Model):
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1775.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1776.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1777.1">get_absolute_url</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1778.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1779.1">self</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1780.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1781.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1782.1"> reverse(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1783.1">'images:detail'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1784.1">, args=[self.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1785.1">id</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1786.1">, self.slug])</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1787.1">Remember that the common pattern for providing canonical URLs for objects is to define a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1788.1">get_absolute_url()</span></code><span class="koboSpan" id="kobo.1789.1"> method in the model.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1790.1">Finally, create a template inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1791.1">/templates/images/image/</span></code><span class="koboSpan" id="kobo.1792.1"> template directory for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1793.1">images</span></code><span class="koboSpan" id="kobo.1794.1"> application and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.1795.1">detail.html</span></code><span class="koboSpan" id="kobo.1796.1">. </span><span class="koboSpan" id="kobo.1796.2">Add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1797.1">{% extends "base.html" %}
{% block title %}{{ image.title }}{% endblock %}
{% block content %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1798.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1799.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1800.1">&gt;</span></span><span class="koboSpan" id="kobo.1801.1">{{ image.title }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1802.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1803.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1804.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1805.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1806.1">img</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1807.1">src</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1808.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1809.1">"{{ image.image.url }}"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1810.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1811.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1812.1">"image-detail"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1813.1">&gt;</span></span><span class="koboSpan" id="kobo.1814.1">
  {% with total_likes=image.users_like.count %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1815.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1816.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1817.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1818.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1819.1">"image-info"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1820.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1821.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1822.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1823.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1824.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1825.1">span</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1826.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1827.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1828.1">"count"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1829.1">&gt;</span></span><span class="koboSpan" id="kobo.1830.1">
          {{ total_likes }} like{{ total_likes|pluralize }}
        </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1831.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1832.1">span</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1833.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1834.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1835.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1836.1">&gt;</span></span><span class="koboSpan" id="kobo.1837.1">
      {{ image.description|linebreaks }}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1838.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1839.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1840.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1841.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1842.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1843.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1844.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1845.1">"image-likes"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1846.1">&gt;</span></span><span class="koboSpan" id="kobo.1847.1">
      {% for user in image.users_like.all %}
        </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1848.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1849.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1850.1">&gt;</span></span><span class="koboSpan" id="kobo.1851.1">
          {% if user.profile.photo %}
            </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1852.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1853.1">img</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1854.1">src</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1855.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1856.1">"{{ user.profile.photo.url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1857.1">&gt;</span></span><span class="koboSpan" id="kobo.1858.1">
          {% endif %}
          </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1859.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1860.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1861.1">&gt;</span></span><span class="koboSpan" id="kobo.1862.1">{{ user.first_name }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1863.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1864.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1865.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1866.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1867.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1868.1">&gt;</span></span><span class="koboSpan" id="kobo.1869.1">
      {% empty %}
        Nobody likes this image yet.
      </span><span class="koboSpan" id="kobo.1869.2">{% endfor %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1870.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1871.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1872.1">&gt;</span></span><span class="koboSpan" id="kobo.1873.1">
  {% endwith %}
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1874.1">This is the template for displaying the</span><a id="_idIndexMarker565"/><span class="koboSpan" id="kobo.1875.1"> detail view of a bookmarked image. </span><span class="koboSpan" id="kobo.1875.2">We have used the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1876.1">{% with %}</span></code><span class="koboSpan" id="kobo.1877.1"> tag to create the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1878.1">total_likes</span></code><span class="koboSpan" id="kobo.1879.1"> variable with the result of a QuerySet that counts all user likes. </span><span class="koboSpan" id="kobo.1879.2">By doing so, we avoid evaluating the same QuerySet twice (first to display the total number of likes, then to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1880.1">pluralize</span></code><span class="koboSpan" id="kobo.1881.1"> template filter). </span><span class="koboSpan" id="kobo.1881.2">We have also included the image</span><a id="_idIndexMarker566"/><span class="koboSpan" id="kobo.1882.1"> description and we have added a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1883.1">{% for %}</span></code><span class="koboSpan" id="kobo.1884.1"> loop to iterate over </span><code class="inlineCode"><span class="koboSpan" id="kobo.1885.1">image.users_like.all</span></code><span class="koboSpan" id="kobo.1886.1"> to display all the users who like this image.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1887.1">Whenever you need to repeat a query in your template, use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1888.1">{% with %}</span></code><span class="koboSpan" id="kobo.1889.1"> template tag to prevent additional database queries.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1890.1">Now, open an external URL in your browser and use the bookmarklet to bookmark a new image. </span><span class="koboSpan" id="kobo.1890.2">You will be redirected to the image detail page after you post the image. </span><span class="koboSpan" id="kobo.1890.3">The page will include a success message, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1891.1"><img alt="" role="presentation" src="../Images/B21088_06_15.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1892.1">Figure 6.15: The image detail page for the image bookmark</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1893.1">Great! </span><span class="koboSpan" id="kobo.1893.2">You completed the</span><a id="_idIndexMarker567"/><span class="koboSpan" id="kobo.1894.1"> bookmarklet functionality. </span><span class="koboSpan" id="kobo.1894.2">Next, you</span><a id="_idIndexMarker568"/><span class="koboSpan" id="kobo.1895.1"> will learn how to create thumbnails for images.</span></p>
<h1 class="heading-1" id="_idParaDest-185"><span class="koboSpan" id="kobo.1896.1">Creating image thumbnails using easy-thumbnails</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1897.1">We are displaying the original image on the detail page, but the dimensions of different images may vary considerably. </span><span class="koboSpan" id="kobo.1897.2">The file size </span><a id="_idIndexMarker569"/><span class="koboSpan" id="kobo.1898.1">of some images may be </span><a id="_idIndexMarker570"/><span class="koboSpan" id="kobo.1899.1">very large, and loading them might take too long. </span><span class="koboSpan" id="kobo.1899.2">The best way to display optimized images in a uniform manner is to generate thumbnails. </span><span class="koboSpan" id="kobo.1899.3">A thumbnail is a small image</span><a id="_idIndexMarker571"/><span class="koboSpan" id="kobo.1900.1"> representation of a larger image. </span><span class="koboSpan" id="kobo.1900.2">Thumbnails will load faster in the browser and are a great way to homogenize images of very different sizes. </span><span class="koboSpan" id="kobo.1900.3">We will use a Django application called </span><code class="inlineCode"><span class="koboSpan" id="kobo.1901.1">easy-thumbnails</span></code><span class="koboSpan" id="kobo.1902.1"> to generate thumbnails for the images bookmarked by users.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1903.1">Open the terminal and install </span><code class="inlineCode"><span class="koboSpan" id="kobo.1904.1">easy-thumbnails</span></code><span class="koboSpan" id="kobo.1905.1"> using the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1906.1">python -m pip install easy-thumbnails==2.8.5
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1907.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1908.1">settings.py</span></code><span class="koboSpan" id="kobo.1909.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1910.1">bookmarks</span></code><span class="koboSpan" id="kobo.1911.1"> project and add </span><code class="inlineCode"><span class="koboSpan" id="kobo.1912.1">easy_thumbnails</span></code><span class="koboSpan" id="kobo.1913.1"> to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1914.1">INSTALLED_APPS</span></code><span class="koboSpan" id="kobo.1915.1"> setting, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1916.1">INSTALLED_APPS = [
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1917.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1918.1">'</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1919.1">easy_thumbnails'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1920.1">,</span></strong></span><span class="koboSpan" id="kobo.1921.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1922.1">Then, run the following </span><a id="_idIndexMarker572"/><span class="koboSpan" id="kobo.1923.1">command to sync the application</span><a id="_idIndexMarker573"/><span class="koboSpan" id="kobo.1924.1"> with your database:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1925.1">python manage.py migrate
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1926.1">You will see an output that includes the following lines:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1927.1">Applying easy_thumbnails.0001_initial... </span><span class="koboSpan" id="kobo.1927.2">OK
Applying easy_thumbnails.0002_thumbnaildimensions... </span><span class="koboSpan" id="kobo.1927.3">OK
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1928.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1929.1">easy-thumbnails</span></code><span class="koboSpan" id="kobo.1930.1"> application offers you </span><a id="_idIndexMarker574"/><span class="koboSpan" id="kobo.1931.1">different ways to define image thumbnails. </span><span class="koboSpan" id="kobo.1931.2">The application provides a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1932.1">{% thumbnail %}</span></code><span class="koboSpan" id="kobo.1933.1"> template tag to generate thumbnails in templates and a custom </span><code class="inlineCode"><span class="koboSpan" id="kobo.1934.1">ImageField</span></code><span class="koboSpan" id="kobo.1935.1"> if you want to define thumbnails in your models. </span><span class="koboSpan" id="kobo.1935.2">Let’s use the template tag approach.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1936.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1937.1">images/image/detail.html</span></code><span class="koboSpan" id="kobo.1938.1"> template and consider the following line:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1939.1">&lt;img src=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1940.1">"{{ image.image.url }}"</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1941.1">class</span></span><span class="koboSpan" id="kobo.1942.1">=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1943.1">"image-detail"</span></span><span class="koboSpan" id="kobo.1944.1">&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1945.1">The following lines should replace the preceding one:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-template-tag-slc"><span class="koboSpan" id="kobo.1946.1">{% </span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1947.1">load</span></strong><strong class="hljs-template-tag-slc"><span class="koboSpan" id="kobo.1948.1"> thumbnail %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1949.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1950.1">a</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1951.1">href</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1952.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1953.1">"</span></strong><strong class="hljs-template-variable-slc"><span class="koboSpan" id="kobo.1954.1">{{ image.image.url }}</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1955.1">"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1956.1">&gt;</span></strong></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1957.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1958.1">img</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1959.1">src</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1960.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1961.1">"</span></span><span class="code-highlight"><strong class="hljs-template-tag-slc"><span class="koboSpan" id="kobo.1962.1">{% </span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1963.1">thumbnail</span></strong><strong class="hljs-template-tag-slc"><span class="koboSpan" id="kobo.1964.1"> image.image 300x0 %}</span></strong></span><span class="hljs-string"><span class="koboSpan" id="kobo.1965.1">"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1966.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1967.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1968.1">"image-detail"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1969.1">&gt;</span></span>
<span class="code-highlight"><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1970.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1971.1">a</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1972.1">&gt;</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1973.1">We have defined a thumbnail with a fixed width of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1974.1">300</span></code><span class="koboSpan" id="kobo.1975.1"> pixels and a flexible height to maintain the aspect ratio by using the value </span><code class="inlineCode"><span class="koboSpan" id="kobo.1976.1">0</span></code><span class="koboSpan" id="kobo.1977.1">. </span><span class="koboSpan" id="kobo.1977.2">The first time a user loads this page, a thumbnail image will be created. </span><span class="koboSpan" id="kobo.1977.3">The thumbnail is stored in the same directory as the original file. </span><span class="koboSpan" id="kobo.1977.4">The location is defined by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1978.1">MEDIA_ROOT</span></code><span class="koboSpan" id="kobo.1979.1"> setting and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1980.1">upload_to</span></code><span class="koboSpan" id="kobo.1981.1"> attribute of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1982.1">image</span></code><span class="koboSpan" id="kobo.1983.1"> field of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1984.1">Image</span></code><span class="koboSpan" id="kobo.1985.1"> model. </span><span class="koboSpan" id="kobo.1985.2">The generated thumbnail will then be served in the following requests.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1986.1">Run the development server with the following command from the shell prompt:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1987.1">python manage.py runserver_plus --cert-file cert.crt
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1988.1">Access the image detail page </span><a id="_idIndexMarker575"/><span class="koboSpan" id="kobo.1989.1">for an existing image. </span><span class="koboSpan" id="kobo.1989.2">The thumbnail will </span><a id="_idIndexMarker576"/><span class="koboSpan" id="kobo.1990.1">be generated </span><a id="_idIndexMarker577"/><span class="koboSpan" id="kobo.1991.1">and displayed on the site. </span><span class="koboSpan" id="kobo.1991.2">Right-click on the image and open it in a new browser tab, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1992.1"><img alt="" role="presentation" src="../Images/B21088_06_16.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1993.1">Figure 6.16: Opening the image in a new browser tab</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1994.1">Check the URL of the</span><a id="_idIndexMarker578"/><span class="koboSpan" id="kobo.1995.1"> generated image in your browser. </span><span class="koboSpan" id="kobo.1995.2">It should look as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1996.1"><img alt="" role="presentation" src="../Images/B21088_06_17.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1997.1">Figure 6.17: The URL of the generated image</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1998.1">The original filename </span><a id="_idIndexMarker579"/><span class="koboSpan" id="kobo.1999.1"> is followed by additional details of the settings used to create the thumbnail. </span><span class="koboSpan" id="kobo.1999.2">For a JPEG image, you will see a filename like </span><code class="inlineCode"><span class="koboSpan" id="kobo.2000.1">filename.jpg.300x0_q85.jpg</span></code><span class="koboSpan" id="kobo.2001.1">, where </span><code class="inlineCode"><span class="koboSpan" id="kobo.2002.1">300x0</span></code><span class="koboSpan" id="kobo.2003.1"> indicates the size parameters used to generate the thumbnail, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2004.1">85</span></code><span class="koboSpan" id="kobo.2005.1"> is the value for the default JPEG quality used by the library to generate the thumbnail.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2006.1">You can use a different quality value using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2007.1">quality</span></code><span class="koboSpan" id="kobo.2008.1"> parameter. </span><span class="koboSpan" id="kobo.2008.2">To set the highest JPEG quality, you can use the value </span><code class="inlineCode"><span class="koboSpan" id="kobo.2009.1">100</span></code><span class="koboSpan" id="kobo.2010.1">, like this: </span><code class="inlineCode"><span class="koboSpan" id="kobo.2011.1">{% thumbnail image.image 300x0 quality=100 %}</span></code><span class="koboSpan" id="kobo.2012.1">. </span><span class="koboSpan" id="kobo.2012.2">A higher quality will imply a larger file size.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2013.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2014.1">easy-thumbnails</span></code><span class="koboSpan" id="kobo.2015.1"> application </span><a id="_idIndexMarker580"/><span class="koboSpan" id="kobo.2016.1">offers several options to customize your thumbnails, including cropping algorithms and different effects that can be applied. </span><span class="koboSpan" id="kobo.2016.2">If you run into any issues generating thumbnails, you can</span><a id="_idIndexMarker581"/><span class="koboSpan" id="kobo.2017.1"> add </span><code class="inlineCode"><span class="koboSpan" id="kobo.2018.1">THUMBNAIL_DEBUG = True</span></code><span class="koboSpan" id="kobo.2019.1"> to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2020.1">settings.py</span></code><span class="koboSpan" id="kobo.2021.1"> file to obtain the debug information. </span><span class="koboSpan" id="kobo.2021.2">You can read the full documentation of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2022.1">easy-thumbnails</span></code><span class="koboSpan" id="kobo.2023.1"> at </span><a href="https://easy-thumbnails.readthedocs.io/"><span class="url"><span class="koboSpan" id="kobo.2024.1">https://easy-thumbnails.readthedocs.io/</span></span></a><span class="koboSpan" id="kobo.2025.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-186"><span class="koboSpan" id="kobo.2026.1">Adding asynchronous actions with JavaScript</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2027.1">We are going to add a </span><strong class="screenText"><span class="koboSpan" id="kobo.2028.1">like</span></strong><span class="koboSpan" id="kobo.2029.1"> button to the image detail page to let users click on it to like an image. </span><span class="koboSpan" id="kobo.2029.2">When users click the </span><em class="italic"><span class="koboSpan" id="kobo.2030.1">like</span></em><span class="koboSpan" id="kobo.2031.1"> button, we will send an HTTP request to the web server using JavaScript. </span><span class="koboSpan" id="kobo.2031.2">This</span><a id="_idIndexMarker582"/><span class="koboSpan" id="kobo.2032.1"> will perform the </span><em class="italic"><span class="koboSpan" id="kobo.2033.1">like</span></em><span class="koboSpan" id="kobo.2034.1"> action without reloading the whole page. </span><span class="koboSpan" id="kobo.2034.2">For this functionality, we will implement a view that allows </span><a id="_idIndexMarker583"/><span class="koboSpan" id="kobo.2035.1">users to like/unlike images.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2036.1">The JavaScript </span><strong class="keyWord"><span class="koboSpan" id="kobo.2037.1">Fetch API</span></strong><span class="koboSpan" id="kobo.2038.1"> is the built-in way to make asynchronous HTTP requests to web servers from web browsers. </span><span class="koboSpan" id="kobo.2038.2">By using the Fetch API, you can send and retrieve data from the web server without the need for a whole page refresh. </span><span class="koboSpan" id="kobo.2038.3">The Fetch API was launched as a modern successor to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2039.1">XMLHttpRequest</span></code><span class="koboSpan" id="kobo.2040.1"> (XHR) object that is built into the browser, used to make HTTP requests without reloading the page. </span><span class="koboSpan" id="kobo.2040.2">The set of web development techniques to send and retrieve data from a web server asynchronously without reloading the page is also known as </span><strong class="keyWord"><span class="koboSpan" id="kobo.2041.1">AJAX</span></strong><span class="koboSpan" id="kobo.2042.1">, which stands for </span><strong class="keyWord"><span class="koboSpan" id="kobo.2043.1">Asynchronous JavaScript and XML</span></strong><span class="koboSpan" id="kobo.2044.1">. </span><span class="koboSpan" id="kobo.2044.2">AJAX is a misleading</span><a id="_idIndexMarker584"/><span class="koboSpan" id="kobo.2045.1"> name because AJAX requests can exchange data not only in XML format but also in formats such as JSON, HTML, and plain text. </span><span class="koboSpan" id="kobo.2045.2">You might find references to the Fetch </span><a id="_idIndexMarker585"/><span class="koboSpan" id="kobo.2046.1">API and AJAX indistinctively on the internet.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2047.1">You can find information about the Fetch API at </span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch"><span class="url"><span class="koboSpan" id="kobo.2048.1">https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch</span></span></a><span class="koboSpan" id="kobo.2049.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2050.1">We will start by implementing the view to perform the </span><em class="italic"><span class="koboSpan" id="kobo.2051.1">like</span></em><span class="koboSpan" id="kobo.2052.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.2053.1">unlike</span></em><span class="koboSpan" id="kobo.2054.1"> actions, and then we will add the JavaScript code</span><a id="_idIndexMarker586"/><span class="koboSpan" id="kobo.2055.1"> to the related template to perform asynchronous HTTP requests.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2056.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2057.1">views.py</span></code><span class="koboSpan" id="kobo.2058.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2059.1">images</span></code><span class="koboSpan" id="kobo.2060.1"> application and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2061.1">from</span></span><span class="koboSpan" id="kobo.2062.1"> django.http </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2063.1">import</span></span><span class="koboSpan" id="kobo.2064.1"> JsonResponse
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2065.1">from</span></span><span class="koboSpan" id="kobo.2066.1"> django.views.decorators.http </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2067.1">import</span></span><span class="koboSpan" id="kobo.2068.1"> require_POST
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.2069.1">@login_required</span></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.2070.1">@require_POST</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2071.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2072.1">image_like</span></span><span class="koboSpan" id="kobo.2073.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2074.1">request</span></span><span class="koboSpan" id="kobo.2075.1">):
    image_id = request.POST.get(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2076.1">'id'</span></span><span class="koboSpan" id="kobo.2077.1">)
    action = request.POST.get(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2078.1">'action'</span></span><span class="koboSpan" id="kobo.2079.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2080.1">if</span></span><span class="koboSpan" id="kobo.2081.1"> image_id </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2082.1">and</span></span><span class="koboSpan" id="kobo.2083.1"> action:
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2084.1">try</span></span><span class="koboSpan" id="kobo.2085.1">:
            image = Image.objects.get(</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2086.1">id</span></span><span class="koboSpan" id="kobo.2087.1">=image_id)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2088.1">if</span></span><span class="koboSpan" id="kobo.2089.1"> action == </span><span class="hljs-string"><span class="koboSpan" id="kobo.2090.1">'like'</span></span><span class="koboSpan" id="kobo.2091.1">:
                image.users_like.add(request.user)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2092.1">else</span></span><span class="koboSpan" id="kobo.2093.1">:
                image.users_like.remove(request.user)
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2094.1">return</span></span><span class="koboSpan" id="kobo.2095.1"> JsonResponse({</span><span class="hljs-string"><span class="koboSpan" id="kobo.2096.1">'status'</span></span><span class="koboSpan" id="kobo.2097.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.2098.1">'ok'</span></span><span class="koboSpan" id="kobo.2099.1">})
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2100.1">except</span></span><span class="koboSpan" id="kobo.2101.1"> Image.DoesNotExist:
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2102.1">pass</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2103.1">return</span></span><span class="koboSpan" id="kobo.2104.1"> JsonResponse({</span><span class="hljs-string"><span class="koboSpan" id="kobo.2105.1">'status'</span></span><span class="koboSpan" id="kobo.2106.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.2107.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2108.1">error'</span></span><span class="koboSpan" id="kobo.2109.1">})
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2110.1">We have used two decorators for the new view. </span><span class="koboSpan" id="kobo.2110.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2111.1">login_required</span></code><span class="koboSpan" id="kobo.2112.1"> decorator prevents users who are not logged in from accessing this view. </span><span class="koboSpan" id="kobo.2112.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2113.1">require_POST</span></code><span class="koboSpan" id="kobo.2114.1"> decorator returns an </span><code class="inlineCode"><span class="koboSpan" id="kobo.2115.1">HttpResponseNotAllowed</span></code><span class="koboSpan" id="kobo.2116.1"> object (status code </span><code class="inlineCode"><span class="koboSpan" id="kobo.2117.1">405</span></code><span class="koboSpan" id="kobo.2118.1">) if the HTTP request is not done via </span><code class="inlineCode"><span class="koboSpan" id="kobo.2119.1">POST</span></code><span class="koboSpan" id="kobo.2120.1">. </span><span class="koboSpan" id="kobo.2120.2">This way, you only allow </span><code class="inlineCode"><span class="koboSpan" id="kobo.2121.1">POST</span></code><span class="koboSpan" id="kobo.2122.1"> requests for this view.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2123.1">Django also provides a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2124.1">require_GET</span></code><span class="koboSpan" id="kobo.2125.1"> decorator to only allow </span><code class="inlineCode"><span class="koboSpan" id="kobo.2126.1">GET</span></code><span class="koboSpan" id="kobo.2127.1"> requests and a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2128.1">require_http_methods</span></code><span class="koboSpan" id="kobo.2129.1"> decorator to which you can pass a list of allowed methods as an argument.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2130.1">This view expects the following </span><code class="inlineCode"><span class="koboSpan" id="kobo.2131.1">POST</span></code><span class="koboSpan" id="kobo.2132.1"> parameters:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2133.1">image_id</span></code><span class="koboSpan" id="kobo.2134.1">: The ID of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2135.1">Image</span></code><span class="koboSpan" id="kobo.2136.1"> object on which the user is performing the action</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2137.1">action</span></code><span class="koboSpan" id="kobo.2138.1">: The action that the user wants to perform, which should be a string with the value </span><code class="inlineCode"><span class="koboSpan" id="kobo.2139.1">like</span></code><span class="koboSpan" id="kobo.2140.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.2141.1">unlike</span></code></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.2142.1">We have used the manager</span><a id="_idIndexMarker587"/><span class="koboSpan" id="kobo.2143.1"> provided by Django for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2144.1">users_like</span></code><span class="koboSpan" id="kobo.2145.1"> many-to-many field of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2146.1">Image</span></code><span class="koboSpan" id="kobo.2147.1"> model in order to add or remove objects from the relationship using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2148.1">add()</span></code><span class="koboSpan" id="kobo.2149.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.2150.1">remove()</span></code><span class="koboSpan" id="kobo.2151.1"> methods. </span><span class="koboSpan" id="kobo.2151.2">If the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2152.1">add()</span></code><span class="koboSpan" id="kobo.2153.1"> method is called passing an object that is already present in the related object set, it will not be duplicated. </span><span class="koboSpan" id="kobo.2153.2">If the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2154.1">remove()</span></code><span class="koboSpan" id="kobo.2155.1"> method is called with an object that is not in the related object set, nothing will happen. </span><span class="koboSpan" id="kobo.2155.2">Another useful method of many-to-many managers is </span><code class="inlineCode"><span class="koboSpan" id="kobo.2156.1">clear()</span></code><span class="koboSpan" id="kobo.2157.1">, which removes all objects from the related object set.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2158.1">To generate the view </span><a id="_idIndexMarker588"/><span class="koboSpan" id="kobo.2159.1">response, we have used the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2160.1">JsonResponse</span></code><span class="koboSpan" id="kobo.2161.1"> class provided by Django, which returns an HTTP response with an </span><code class="inlineCode"><span class="koboSpan" id="kobo.2162.1">application/json</span></code><span class="koboSpan" id="kobo.2163.1"> content type, converting the given object into a JSON output.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2164.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2165.1">urls.py</span></code><span class="koboSpan" id="kobo.2166.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2167.1">images</span></code><span class="koboSpan" id="kobo.2168.1"> application and add the following URL pattern highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2169.1">urlpatterns = [
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2170.1">'create/'</span></span><span class="koboSpan" id="kobo.2171.1">, views.image_create, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.2172.1">'create'</span></span><span class="koboSpan" id="kobo.2173.1">),
    path(
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2174.1">'detail/&lt;int:id&gt;/&lt;slug:slug&gt;/'</span></span><span class="koboSpan" id="kobo.2175.1">,
        views.image_detail,
        name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.2176.1">'detail'</span></span>
<span class="hljs-string"> </span><span class="koboSpan" id="kobo.2177.1">),
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2178.1">    path(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2179.1">'like/'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2180.1">, views.image_like, name=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2181.1">'like'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2182.1">),</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2183.1">]</span></strong></span>
</code></pre>
<h2 class="heading-2" id="_idParaDest-187"><span class="koboSpan" id="kobo.2184.1">Loading JavaScript on the DOM</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2185.1">We need to add JavaScript code to the image detail template. </span><span class="koboSpan" id="kobo.2185.2">To use JavaScript in our templates, we will add a base </span><a id="_idIndexMarker589"/><span class="koboSpan" id="kobo.2186.1">wrapper in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2187.1">base.html</span></code><span class="koboSpan" id="kobo.2188.1"> template of the </span><a id="_idIndexMarker590"/><span class="koboSpan" id="kobo.2189.1">project first.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2190.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2191.1">base.html</span></code><span class="koboSpan" id="kobo.2192.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2193.1">account</span></code><span class="koboSpan" id="kobo.2194.1"> application and include the following code highlighted in bold before the closing </span><code class="inlineCode"><span class="koboSpan" id="kobo.2195.1">&lt;/body&gt;</span></code><span class="koboSpan" id="kobo.2196.1"> HTML tag:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.2197.1">&lt;!DOCTYPE </span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2198.1">html</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.2199.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2200.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2201.1">html</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2202.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2203.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2204.1">head</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2205.1">&gt;</span></span><span class="koboSpan" id="kobo.2206.1">
 ...
</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2207.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2208.1">head</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2209.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2210.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2211.1">body</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2212.1">&gt;</span></span><span class="koboSpan" id="kobo.2213.1">
  ...
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2214.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2215.1">script</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2216.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.2217.1">document</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2218.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2219.1">addEventListener</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2220.1">(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2221.1">'DOMContentLoaded'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2222.1">, </span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.2223.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.2224.1">event</span></strong><strong class="hljs-function-slc"><span class="koboSpan" id="kobo.2225.1">) =&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2226.1"> {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.2227.1">// DOM loaded</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2228.1">      {% block domready %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2229.1">      {% endblock %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2230.1">    })</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2231.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2232.1">script</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2233.1">&gt;</span></strong></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2234.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2235.1">body</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2236.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2237.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2238.1">html</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2239.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2240.1">We have added a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2241.1">&lt;script&gt;</span></code><span class="koboSpan" id="kobo.2242.1"> tag to include JavaScript code. </span><span class="koboSpan" id="kobo.2242.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2243.1">document.addEventListener()</span></code><span class="koboSpan" id="kobo.2244.1"> method is used to define a function that will be called when the given event is triggered. </span><span class="koboSpan" id="kobo.2244.2">We pass the event name </span><code class="inlineCode"><span class="koboSpan" id="kobo.2245.1">DOMContentLoaded</span></code><span class="koboSpan" id="kobo.2246.1">, which fires when the initial HTML document </span><a id="_idIndexMarker591"/><span class="koboSpan" id="kobo.2247.1">has been completely loaded </span><a id="_idIndexMarker592"/><span class="koboSpan" id="kobo.2248.1">and the DOM hierarchy </span><a id="_idIndexMarker593"/><span class="koboSpan" id="kobo.2249.1">has been fully constructed. </span><span class="koboSpan" id="kobo.2249.2">By using this event, we make sure the DOM is fully constructed before we interact with any HTML elements and we manipulate the DOM. </span><span class="koboSpan" id="kobo.2249.3">The code within the function will only be executed once the DOM is ready.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2250.1">Inside the document-ready handler, we have included a Django template block called </span><code class="inlineCode"><span class="koboSpan" id="kobo.2251.1">domready</span></code><span class="koboSpan" id="kobo.2252.1">. </span><span class="koboSpan" id="kobo.2252.2">Any template that extends the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2253.1">base.html</span></code><span class="koboSpan" id="kobo.2254.1"> template can use this block to include specific JavaScript code to execute when the DOM is ready.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2255.1">Don’t get confused by the JavaScript code and Django template tags. </span><span class="koboSpan" id="kobo.2255.2">The Django template language is rendered on the server side to generate the HTML document, and JavaScript is executed in the browser on the client side. </span><span class="koboSpan" id="kobo.2255.3">In some cases, it is useful to generate JavaScript code dynamically using Django in order to use the results of QuerySets or server-side calculations to define variables in JavaScript.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2256.1">The examples in this chapter include JavaScript code in Django templates. </span><span class="koboSpan" id="kobo.2256.2">The preferred method to add JavaScript code to your templates is by loading </span><code class="inlineCode"><span class="koboSpan" id="kobo.2257.1">.js</span></code><span class="koboSpan" id="kobo.2258.1"> files, which are served as static files, especially if you are using large scripts.</span></p>
<h2 class="heading-2" id="_idParaDest-188"><span class="koboSpan" id="kobo.2259.1">Cross-site request forgery for HTTP requests in JavaScript</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2260.1">You learned about </span><strong class="keyWord"><span class="koboSpan" id="kobo.2261.1">cross-site request forgery</span></strong><span class="koboSpan" id="kobo.2262.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.2263.1">CSRF</span></strong><span class="koboSpan" id="kobo.2264.1">) in </span><em class="italic"><span class="koboSpan" id="kobo.2265.1">Chapter 2</span></em><span class="koboSpan" id="kobo.2266.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2267.1">Enhancing Your Blog with Advanced Features</span></em><span class="koboSpan" id="kobo.2268.1">. </span><span class="koboSpan" id="kobo.2268.2">With CSRF protection active, Django looks for a CSRF token in all </span><code class="inlineCode"><span class="koboSpan" id="kobo.2269.1">POST</span></code><span class="koboSpan" id="kobo.2270.1"> requests. </span><span class="koboSpan" id="kobo.2270.2">When you submit forms, you can use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2271.1">{% csrf_token %}</span></code><span class="koboSpan" id="kobo.2272.1"> template tag to send the token along with </span><a id="_idIndexMarker594"/><span class="koboSpan" id="kobo.2273.1">the form. </span><span class="koboSpan" id="kobo.2273.2">HTTP requests made</span><a id="_idIndexMarker595"/><span class="koboSpan" id="kobo.2274.1"> in JavaScript have to pass the CSRF token as well in every </span><code class="inlineCode"><span class="koboSpan" id="kobo.2275.1">POST</span></code><span class="koboSpan" id="kobo.2276.1"> request.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2277.1">Django allows you to set a custom </span><code class="inlineCode"><span class="koboSpan" id="kobo.2278.1">X-CSRFToken</span></code><span class="koboSpan" id="kobo.2279.1"> header in your HTTP requests with the value of the CSRF token.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2280.1">To include the token in HTTP requests that originate from JavaScript, we will need to retrieve the CSRF token from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2281.1">csrftoken</span></code><span class="koboSpan" id="kobo.2282.1"> cookie, which is set by Django if the CSRF protection is active. </span><span class="koboSpan" id="kobo.2282.2">To handle cookies, we will use JavaScript Cookie. </span><span class="koboSpan" id="kobo.2282.3">JavaScript Cookie is a lightweight JavaScript API for handling cookies. </span><span class="koboSpan" id="kobo.2282.4">You can learn more about it at </span><a href="https://github.com/js-cookie/js-cookie"><span class="url"><span class="koboSpan" id="kobo.2283.1">https://github.com/js-cookie/js-cookie</span></span></a><span class="koboSpan" id="kobo.2284.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2285.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2286.1">base.html</span></code><span class="koboSpan" id="kobo.2287.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2288.1">account</span></code><span class="koboSpan" id="kobo.2289.1"> application and add the following code highlighted in bold at the bottom of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2290.1">&lt;body&gt;</span></code><span class="koboSpan" id="kobo.2291.1"> element like this:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2292.1">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
 ...
</span><span class="koboSpan" id="kobo.2292.2">&lt;/head&gt;
&lt;body&gt;
  ...
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2293.1">  &lt;script src=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2294.1">"//cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2295.1">&gt;&lt;/script&gt;</span></strong></span><span class="koboSpan" id="kobo.2296.1">
  &lt;script&gt;
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2297.1">    const csrftoken = Cookies.get(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2298.1">'csrftoken'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2299.1">);</span></strong></span><span class="koboSpan" id="kobo.2300.1">
    document.addEventListener(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2301.1">'DOMContentLoaded'</span></span><span class="koboSpan" id="kobo.2302.1">, (event) =&gt; {
      // DOM loaded
      {% block domready %}
      {% endblock %}
    })
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2303.1">We have implemented the following functionality:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2304.1">The JavaScript Cookie plugin is loaded from </span><a id="_idIndexMarker596"/><span class="koboSpan" id="kobo.2305.1">a public </span><strong class="keyWord"><span class="koboSpan" id="kobo.2306.1">Content Delivery Network </span></strong><span class="koboSpan" id="kobo.2307.1">(</span><strong class="keyWord"><span class="koboSpan" id="kobo.2308.1">CDN</span></strong><span class="koboSpan" id="kobo.2309.1">).</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2310.1">The value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2311.1">csrftoken</span></code><span class="koboSpan" id="kobo.2312.1"> cookie is retrieved with </span><code class="inlineCode"><span class="koboSpan" id="kobo.2313.1">Cookies.get()</span></code><span class="koboSpan" id="kobo.2314.1"> and stored in the JavaScript constant </span><code class="inlineCode"><span class="koboSpan" id="kobo.2315.1">csrftoken</span></code><span class="koboSpan" id="kobo.2316.1">.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.2317.1">We have to include the CSRF</span><a id="_idIndexMarker597"/><span class="koboSpan" id="kobo.2318.1"> token in all JavaScript fetch requests that use unsafe HTTP methods, such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.2319.1">POST</span></code><span class="koboSpan" id="kobo.2320.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.2321.1">PUT</span></code><span class="koboSpan" id="kobo.2322.1">. </span><span class="koboSpan" id="kobo.2322.2">We will later include</span><a id="_idIndexMarker598"/><span class="koboSpan" id="kobo.2323.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2324.1">csrftoken</span></code><span class="koboSpan" id="kobo.2325.1"> constant in a custom HTTP header named </span><code class="inlineCode"><span class="koboSpan" id="kobo.2326.1">X-CSRFToken</span></code><span class="koboSpan" id="kobo.2327.1"> when sending HTTP </span><code class="inlineCode"><span class="koboSpan" id="kobo.2328.1">POST</span></code><span class="koboSpan" id="kobo.2329.1"> requests.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2330.1">You can find more information about Django’s CSRF protection and AJAX at </span><a href="https://docs.djangoproject.com/en/5.0/ref/csrf/#ajax"><span class="url"><span class="koboSpan" id="kobo.2331.1">https://docs.djangoproject.com/en/5.0/ref/csrf/#ajax</span></span></a><span class="koboSpan" id="kobo.2332.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2333.1">Next, we will implement the HTML and JavaScript code for users to like/unlike images.</span></p>
<h2 class="heading-2" id="_idParaDest-189"><span class="koboSpan" id="kobo.2334.1">Performing HTTP requests with JavaScript</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2335.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2336.1">images/image/detail.html</span></code><span class="koboSpan" id="kobo.2337.1"> template </span><a id="_idIndexMarker599"/><span class="koboSpan" id="kobo.2338.1">and add the following </span><a id="_idIndexMarker600"/><span class="koboSpan" id="kobo.2339.1">code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2340.1">{% extends "base.html" %}
{% block title %}{{ image.title }}{% endblock %}
{% block content %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2341.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2342.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2343.1">&gt;</span></span><span class="koboSpan" id="kobo.2344.1">{{ image.title }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2345.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2346.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2347.1">&gt;</span></span><span class="koboSpan" id="kobo.2348.1">
  {% load thumbnail %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2349.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2350.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2351.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2352.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2353.1">"{{ image.image.url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2354.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2355.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2356.1">img</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2357.1">src</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2358.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2359.1">"{% thumbnail image.image 300x0 %}"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2360.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2361.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2362.1">"image-detail"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2363.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2364.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2365.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2366.1">&gt;</span></span><span class="koboSpan" id="kobo.2367.1">
  {% with total_likes=image.users_like.count </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2368.1">users_like=image.users_like.all</span></strong></span><span class="koboSpan" id="kobo.2369.1"> %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2370.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2371.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2372.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2373.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2374.1">"image-info"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2375.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2376.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2377.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2378.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2379.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2380.1">span</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2381.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2382.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2383.1">"count"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2384.1">&gt;</span></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2385.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2386.1">span</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.2387.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2388.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2389.1">"total"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2390.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2391.1">{{ total_likes }}</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2392.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2393.1">span</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2394.1">&gt;</span></strong></span><span class="koboSpan" id="kobo.2395.1">
        like{{ total_likes|pluralize }}
        </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2396.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2397.1">span</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2398.1">&gt;</span></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2399.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2400.1">a</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.2401.1">href</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2402.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2403.1">"</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2404.1">#"</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.2405.1">data-id</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2406.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2407.1">"{{ image.id }}"</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.2408.1">data-action</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2409.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2410.1">"{% if request.user in users_like %}un{% endif %}like"</span></strong></span>
<span class="code-highlight"><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.2411.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2412.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2413.1">"like button"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2414.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2415.1">          {% if request.user not in users_like %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2416.1">            Like</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2417.1">          {% else %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2418.1">            Unlike</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2419.1">          {% endif %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2420.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2421.1">a</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2422.1">&gt;</span></strong></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2423.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2424.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2425.1">&gt;</span></span><span class="koboSpan" id="kobo.2426.1">
      {{ image.description|linebreaks }}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2427.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2428.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2429.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2430.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2431.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2432.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2433.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2434.1">"image-likes"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2435.1">&gt;</span></span><span class="koboSpan" id="kobo.2436.1">
      {% for user in users_like %}
        </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2437.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2438.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2439.1">&gt;</span></span><span class="koboSpan" id="kobo.2440.1">
          {% if user.profile.photo %}
            </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2441.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2442.1">img</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2443.1">src</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2444.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2445.1">"{{ user.profile.photo.url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2446.1">&gt;</span></span><span class="koboSpan" id="kobo.2447.1">
          {% endif %}
          </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2448.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2449.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2450.1">&gt;</span></span><span class="koboSpan" id="kobo.2451.1">{{ user.first_name }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2452.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2453.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2454.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2455.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2456.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2457.1">&gt;</span></span><span class="koboSpan" id="kobo.2458.1">
      {% empty %}
        Nobody likes this image yet.
      </span><span class="koboSpan" id="kobo.2458.2">{% endfor %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2459.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2460.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2461.1">&gt;</span></span><span class="koboSpan" id="kobo.2462.1">
  {% endwith %}
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2463.1">In the preceding code, we have added another variable to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2464.1">{% with %}</span></code><span class="koboSpan" id="kobo.2465.1"> template tag to store the results of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2466.1">image.users_like.all</span></code><span class="koboSpan" id="kobo.2467.1"> query and prevent the query from being executed against the </span><a id="_idIndexMarker601"/><span class="koboSpan" id="kobo.2468.1">database multiple times. </span><span class="koboSpan" id="kobo.2468.2">This variable is used to check whether the current user is in this list with </span><code class="inlineCode"><span class="koboSpan" id="kobo.2469.1">{% if request.user in users_like %}</span></code><span class="koboSpan" id="kobo.2470.1"> and </span><a id="_idIndexMarker602"/><span class="koboSpan" id="kobo.2471.1">then with </span><code class="inlineCode"><span class="koboSpan" id="kobo.2472.1">{% if request.user not in users_like %}</span></code><span class="koboSpan" id="kobo.2473.1">. </span><span class="koboSpan" id="kobo.2473.2">The same variable is then used to iterate over the users that like this image with </span><code class="inlineCode"><span class="koboSpan" id="kobo.2474.1">{% for user in users_like %}</span></code><span class="koboSpan" id="kobo.2475.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2476.1">We have added to this page the total number of users who like the image and have included a link for the user to like/unlike the image. </span><span class="koboSpan" id="kobo.2476.2">The related object set, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2477.1">users_like</span></code><span class="koboSpan" id="kobo.2478.1">, is used to check whether </span><code class="inlineCode"><span class="koboSpan" id="kobo.2479.1">request.user</span></code><span class="koboSpan" id="kobo.2480.1"> is contained in the related object set, to display the text </span><strong class="screenText"><span class="koboSpan" id="kobo.2481.1">Like</span></strong><span class="koboSpan" id="kobo.2482.1"> or </span><strong class="screenText"><span class="koboSpan" id="kobo.2483.1">Unlike</span></strong><span class="koboSpan" id="kobo.2484.1"> based on the current relationship between the user and this image. </span><span class="koboSpan" id="kobo.2484.2">We have added the following attributes to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2485.1">&lt;a&gt;</span></code><span class="koboSpan" id="kobo.2486.1"> HTML link element:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2487.1">data-id</span></code><span class="koboSpan" id="kobo.2488.1">: The ID of the image displayed.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2489.1">data-action</span></code><span class="koboSpan" id="kobo.2490.1">: The action to perform when the user clicks on the link. </span><span class="koboSpan" id="kobo.2490.2">This can be either </span><code class="inlineCode"><span class="koboSpan" id="kobo.2491.1">like</span></code><span class="koboSpan" id="kobo.2492.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.2493.1">unlike</span></code><span class="koboSpan" id="kobo.2494.1">.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.2495.1">Any attribute on any HTML element with a name that starts with </span><code class="inlineCode"><span class="koboSpan" id="kobo.2496.1">data-</span></code><span class="koboSpan" id="kobo.2497.1"> is a data attribute. </span><span class="koboSpan" id="kobo.2497.2">Data attributes are used to store custom data for your application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2498.1">We will send the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2499.1">data-id</span></code><span class="koboSpan" id="kobo.2500.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2501.1">data-action</span></code><span class="koboSpan" id="kobo.2502.1"> attributes in the HTTP request to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2503.1">image_like</span></code><span class="koboSpan" id="kobo.2504.1"> view. </span><span class="koboSpan" id="kobo.2504.2">When </span><a id="_idIndexMarker603"/><span class="koboSpan" id="kobo.2505.1">a user clicks on the </span><strong class="screenText"><span class="koboSpan" id="kobo.2506.1">like/unlike</span></strong><span class="koboSpan" id="kobo.2507.1"> link, we will need to perform the following actions in the browser:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2508.1">Send an HTTP </span><code class="inlineCode"><span class="koboSpan" id="kobo.2509.1">POST</span></code><span class="koboSpan" id="kobo.2510.1"> request to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2511.1">image_like</span></code><span class="koboSpan" id="kobo.2512.1"> view, passing the image </span><code class="inlineCode"><span class="koboSpan" id="kobo.2513.1">id</span></code><span class="koboSpan" id="kobo.2514.1"> and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2515.1">action</span></code><span class="koboSpan" id="kobo.2516.1"> parameters to it.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2517.1">If the HTTP request is successful, update</span><a id="_idIndexMarker604"/><span class="koboSpan" id="kobo.2518.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2519.1">data-action</span></code><span class="koboSpan" id="kobo.2520.1"> attribute of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2521.1">&lt;a&gt;</span></code><span class="koboSpan" id="kobo.2522.1"> HTML element with the opposite action (</span><code class="inlineCode"><span class="koboSpan" id="kobo.2523.1">like</span></code><span class="koboSpan" id="kobo.2524.1"> / </span><code class="inlineCode"><span class="koboSpan" id="kobo.2525.1">unlike</span></code><span class="koboSpan" id="kobo.2526.1">), and modify its display text accordingly.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2527.1">Update the total number of likes displayed on the page.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.2528.1">Add the following </span><code class="inlineCode"><span class="koboSpan" id="kobo.2529.1">domready</span></code><span class="koboSpan" id="kobo.2530.1"> block at the bottom of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2531.1">images/image/detail.html</span></code><span class="koboSpan" id="kobo.2532.1"> template:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2533.1">{% block domready %}
  const url = </span><span class="hljs-string"><span class="koboSpan" id="kobo.2534.1">'{% url "images:like" %}'</span></span><span class="koboSpan" id="kobo.2535.1">;
  var options = {
    method: </span><span class="hljs-string"><span class="koboSpan" id="kobo.2536.1">'POST'</span></span><span class="koboSpan" id="kobo.2537.1">,
    headers: {</span><span class="hljs-string"><span class="koboSpan" id="kobo.2538.1">'X-CSRFToken'</span></span><span class="koboSpan" id="kobo.2539.1">: csrftoken},
    mode: </span><span class="hljs-string"><span class="koboSpan" id="kobo.2540.1">'same-origin'</span></span><span class="koboSpan" id="kobo.2541.1">
  }
  document.querySelector(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2542.1">'a.like'</span></span><span class="koboSpan" id="kobo.2543.1">)
          .addEventListener(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2544.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2545.1">click'</span></span><span class="koboSpan" id="kobo.2546.1">, function(e){
    e.preventDefault();
    var likeButton = this;
  });
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2547.1">The preceding code works as follows:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2548.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2549.1">{% url %}</span></code><span class="koboSpan" id="kobo.2550.1"> template tag is used to build the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2551.1">images:like</span></code><span class="koboSpan" id="kobo.2552.1"> URL. </span><span class="koboSpan" id="kobo.2552.2">The generated URL is stored in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2553.1">url</span></code><span class="koboSpan" id="kobo.2554.1"> JavaScript constant.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2555.1">An </span><code class="inlineCode"><span class="koboSpan" id="kobo.2556.1">options</span></code><span class="koboSpan" id="kobo.2557.1"> object is created with the options that will be passed to the HTTP request with the Fetch API. </span><span class="koboSpan" id="kobo.2557.2">These are:</span><ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2558.1">method</span></code><span class="koboSpan" id="kobo.2559.1">: The HTTP method to use. </span><span class="koboSpan" id="kobo.2559.2">In this case, it’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.2560.1">POST</span></code><span class="koboSpan" id="kobo.2561.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2562.1">headers</span></code><span class="koboSpan" id="kobo.2563.1">: Additional HTTP headers to include in the request. </span><span class="koboSpan" id="kobo.2563.2">We include the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2564.1">X-CSRFToken</span></code><span class="koboSpan" id="kobo.2565.1"> header with the value of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2566.1">csrftoken</span></code><span class="koboSpan" id="kobo.2567.1"> constant that we defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2568.1">base.html</span></code><span class="koboSpan" id="kobo.2569.1"> template.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2570.1">mode</span></code><span class="koboSpan" id="kobo.2571.1">: The mode of the HTTP request. </span><span class="koboSpan" id="kobo.2571.2">We use </span><code class="inlineCode"><span class="koboSpan" id="kobo.2572.1">same-origin</span></code><span class="koboSpan" id="kobo.2573.1"> to indicate the request is made to the same origin. </span><span class="koboSpan" id="kobo.2573.2">You can find more information about modes at </span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Request/mode"><span class="url"><span class="koboSpan" id="kobo.2574.1">https://developer.mozilla.org/en-US/docs/Web/API/Request/mode</span></span></a><span class="koboSpan" id="kobo.2575.1">.</span></li>
</ul>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.2576.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2577.1">a.like</span></code><span class="koboSpan" id="kobo.2578.1"> selector is used to find all </span><code class="inlineCode"><span class="koboSpan" id="kobo.2579.1">&lt;a&gt;</span></code><span class="koboSpan" id="kobo.2580.1"> elements of the HTML document with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2581.1">like</span></code><span class="koboSpan" id="kobo.2582.1"> class</span><a id="_idIndexMarker605"/><span class="koboSpan" id="kobo.2583.1"> using </span><code class="inlineCode"><span class="koboSpan" id="kobo.2584.1">document.querySelector()</span></code><span class="koboSpan" id="kobo.2585.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2586.1">An event listener is defined for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2587.1">click</span></code><span class="koboSpan" id="kobo.2588.1"> event on the elements targeted with the selector. </span><span class="koboSpan" id="kobo.2588.2">This function is executed every time the user clicks on the </span><strong class="screenText"><span class="koboSpan" id="kobo.2589.1">like/unlike</span></strong><span class="koboSpan" id="kobo.2590.1"> link.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2591.1">Inside the handler function, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2592.1">e.preventDefault()</span></code><span class="koboSpan" id="kobo.2593.1"> is used to avoid the default behavior of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2594.1">&lt;a&gt;</span></code><span class="koboSpan" id="kobo.2595.1"> element. </span><span class="koboSpan" id="kobo.2595.2">This will prevent the default behavior of the link element, stopping the event </span><a id="_idIndexMarker606"/><span class="koboSpan" id="kobo.2596.1">propagation, and preventing the link from following the URL.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2597.1">A </span><code class="inlineCode"><span class="koboSpan" id="kobo.2598.1">likeButton</span></code><span class="koboSpan" id="kobo.2599.1"> variable is used to store the reference to </span><code class="inlineCode"><span class="koboSpan" id="kobo.2600.1">this</span></code><span class="koboSpan" id="kobo.2601.1">, the element on which the event was triggered.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.2602.1">Now we need to send the HTTP request using the Fetch API. </span><span class="koboSpan" id="kobo.2602.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2603.1">domready</span></code><span class="koboSpan" id="kobo.2604.1"> block of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2605.1">images/image/detail.html</span></code><span class="koboSpan" id="kobo.2606.1"> template and add the following code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2607.1">{% block domready %}
  const url = </span><span class="hljs-string"><span class="koboSpan" id="kobo.2608.1">'{% url "images:like" %}'</span></span><span class="koboSpan" id="kobo.2609.1">;
  var options = {
    method: </span><span class="hljs-string"><span class="koboSpan" id="kobo.2610.1">'POST'</span></span><span class="koboSpan" id="kobo.2611.1">,
    headers: {</span><span class="hljs-string"><span class="koboSpan" id="kobo.2612.1">'X-CSRFToken'</span></span><span class="koboSpan" id="kobo.2613.1">: csrftoken},
    mode: </span><span class="hljs-string"><span class="koboSpan" id="kobo.2614.1">'same-origin'</span></span><span class="koboSpan" id="kobo.2615.1">
  }
  document.querySelector(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2616.1">'a.like'</span></span><span class="koboSpan" id="kobo.2617.1">)
          .addEventListener(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2618.1">'click'</span></span><span class="koboSpan" id="kobo.2619.1">, function(e){
    e.preventDefault();
    var likeButton = this;
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2620.1">    // add request body</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2621.1">    var formData = new FormData();</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2622.1">    formData.append(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2623.1">'id'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2624.1">, likeButton.dataset.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.2625.1">id</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2626.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2627.1">    formData.append(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2628.1">'action'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2629.1">, likeButton.dataset.action);</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2630.1">    options[</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2631.1">'body'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2632.1">] = formData;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2633.1">    // send HTTP request</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2634.1">    fetch(url, options)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2635.1">    .then(response =&gt; response.json())</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2636.1">    .then(data =&gt; {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2637.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2638.1"> (data[</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2639.1">'</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2640.1">status'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2641.1">] === </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2642.1">'ok'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2643.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2644.1">      {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2645.1">      }</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2646.1">    })</span></strong></span><span class="koboSpan" id="kobo.2647.1">
  });
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2648.1">The new code works as follows:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2649.1">A </span><code class="inlineCode"><span class="koboSpan" id="kobo.2650.1">FormData</span></code><span class="koboSpan" id="kobo.2651.1"> object is </span><a id="_idIndexMarker607"/><span class="koboSpan" id="kobo.2652.1">created to construct a set of key/value pairs representing form fields and their values. </span><span class="koboSpan" id="kobo.2652.2">The object is stored in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2653.1">formData</span></code><span class="koboSpan" id="kobo.2654.1"> variable.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2655.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2656.1">id</span></code><span class="koboSpan" id="kobo.2657.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2658.1">action</span></code><span class="koboSpan" id="kobo.2659.1"> parameters expected by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2660.1">image_like</span></code><span class="koboSpan" id="kobo.2661.1"> Django view are added to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2662.1">formData</span></code><span class="koboSpan" id="kobo.2663.1"> object. </span><span class="koboSpan" id="kobo.2663.2">The values for these parameters are retrieved from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2664.1">likeButton</span></code><span class="koboSpan" id="kobo.2665.1"> element clicked. </span><span class="koboSpan" id="kobo.2665.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2666.1">data-id</span></code><span class="koboSpan" id="kobo.2667.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2668.1">data-action</span></code><span class="koboSpan" id="kobo.2669.1"> attributes are accessed with </span><code class="inlineCode"><span class="koboSpan" id="kobo.2670.1">dataset.id</span></code><span class="koboSpan" id="kobo.2671.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2672.1">dataset.action</span></code><span class="koboSpan" id="kobo.2673.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2674.1">A new </span><code class="inlineCode"><span class="koboSpan" id="kobo.2675.1">body</span></code><span class="koboSpan" id="kobo.2676.1"> key is added to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2677.1">options</span></code><span class="koboSpan" id="kobo.2678.1"> object that will be used for the HTTP request. </span><span class="koboSpan" id="kobo.2678.2">The value for this key is the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2679.1">formData</span></code><span class="koboSpan" id="kobo.2680.1"> object.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2681.1">The Fetch API is used by calling the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2682.1">fetch()</span></code><span class="koboSpan" id="kobo.2683.1"> function. </span><span class="koboSpan" id="kobo.2683.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2684.1">url</span></code><span class="koboSpan" id="kobo.2685.1"> variable defined previously is passed as</span><a id="_idIndexMarker608"/><span class="koboSpan" id="kobo.2686.1"> the URL for the request, and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2687.1">options</span></code><span class="koboSpan" id="kobo.2688.1"> object is passed as the options for the request.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2689.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2690.1">fetch()</span></code><span class="koboSpan" id="kobo.2691.1"> function returns a promise that resolves with a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2692.1">Response</span></code><span class="koboSpan" id="kobo.2693.1"> object, which is a representation of the HTTP response. </span><span class="koboSpan" id="kobo.2693.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2694.1">.then()</span></code><span class="koboSpan" id="kobo.2695.1"> method is used to define a handler for the promise. </span><span class="koboSpan" id="kobo.2695.2">To extract the JSON body content, we use </span><code class="inlineCode"><span class="koboSpan" id="kobo.2696.1">response.json()</span></code><span class="koboSpan" id="kobo.2697.1">. </span><span class="koboSpan" id="kobo.2697.2">You can learn more about the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2698.1">Response</span></code><span class="koboSpan" id="kobo.2699.1"> object at </span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Response"><span class="url"><span class="koboSpan" id="kobo.2700.1">https://developer.mozilla.org/en-US/docs/Web/API/Response</span></span></a><span class="koboSpan" id="kobo.2701.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2702.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2703.1">.then()</span></code><span class="koboSpan" id="kobo.2704.1"> method is used again to define a handler for the data extracted to JSON. </span><span class="koboSpan" id="kobo.2704.2">In this handler, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2705.1">status</span></code><span class="koboSpan" id="kobo.2706.1"> attribute of the data received is used to check whether its value is </span><code class="inlineCode"><span class="koboSpan" id="kobo.2707.1">ok</span></code><span class="koboSpan" id="kobo.2708.1">.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.2709.1">You added the functionality to send the HTTP request and handle the response. </span><span class="koboSpan" id="kobo.2709.2">After a successful request, you need to change the button and its related action to the opposite: from </span><em class="italic"><span class="koboSpan" id="kobo.2710.1">like</span></em><span class="koboSpan" id="kobo.2711.1"> to </span><em class="italic"><span class="koboSpan" id="kobo.2712.1">unlike</span></em><span class="koboSpan" id="kobo.2713.1">, or from </span><em class="italic"><span class="koboSpan" id="kobo.2714.1">unlike</span></em><span class="koboSpan" id="kobo.2715.1"> to </span><em class="italic"><span class="koboSpan" id="kobo.2716.1">like</span></em><span class="koboSpan" id="kobo.2717.1">. </span><span class="koboSpan" id="kobo.2717.2">By doing so, users are able to undo their action.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2718.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2719.1">domready</span></code><span class="koboSpan" id="kobo.2720.1"> block of </span><a id="_idIndexMarker609"/><span class="koboSpan" id="kobo.2721.1">the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2722.1">images/image/detail.html</span></code><span class="koboSpan" id="kobo.2723.1"> template and add the following code highlighted</span><a id="_idIndexMarker610"/><span class="koboSpan" id="kobo.2724.1"> in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2725.1">{% block domready %}
  var url = </span><span class="hljs-string"><span class="koboSpan" id="kobo.2726.1">'{% url "images:like" %}'</span></span><span class="koboSpan" id="kobo.2727.1">;
  var options = {
    method: </span><span class="hljs-string"><span class="koboSpan" id="kobo.2728.1">'POST'</span></span><span class="koboSpan" id="kobo.2729.1">,
    headers: {</span><span class="hljs-string"><span class="koboSpan" id="kobo.2730.1">'X-CSRFToken'</span></span><span class="koboSpan" id="kobo.2731.1">: csrftoken},
    mode: </span><span class="hljs-string"><span class="koboSpan" id="kobo.2732.1">'same-origin'</span></span><span class="koboSpan" id="kobo.2733.1">
  }
  document.querySelector(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2734.1">'a.like'</span></span><span class="koboSpan" id="kobo.2735.1">)
          .addEventListener(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2736.1">'click'</span></span><span class="koboSpan" id="kobo.2737.1">, function(e){
    e.preventDefault();
    var likeButton = this;
    // add request body
    var formData = new FormData();
    formData.append(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2738.1">'id'</span></span><span class="koboSpan" id="kobo.2739.1">, likeButton.dataset.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2740.1">id</span></span><span class="koboSpan" id="kobo.2741.1">);
    formData.append(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2742.1">'action'</span></span><span class="koboSpan" id="kobo.2743.1">, likeButton.dataset.action);
    options[</span><span class="hljs-string"><span class="koboSpan" id="kobo.2744.1">'body'</span></span><span class="koboSpan" id="kobo.2745.1">] = formData;
    // send HTTP request
    fetch(url, options)
    .then(response =&gt; response.json())
    .then(data =&gt; {
      </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2746.1">if</span></span><span class="koboSpan" id="kobo.2747.1"> (data[</span><span class="hljs-string"><span class="koboSpan" id="kobo.2748.1">'status'</span></span><span class="koboSpan" id="kobo.2749.1">] === </span><span class="hljs-string"><span class="koboSpan" id="kobo.2750.1">'ok'</span></span><span class="koboSpan" id="kobo.2751.1">)
      {
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2752.1">        var previousAction = likeButton.dataset.action;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2753.1">        // toggle button text </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2754.1">and</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2755.1"> data-action</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2756.1">        var action = previousAction === </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2757.1">'like'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2758.1"> ? </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2759.1">'unlike'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2760.1"> : </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2761.1">'like'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2762.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2763.1">        likeButton.dataset.action = action;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2764.1">        likeButton.innerHTML = action;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2765.1">        // update like count</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2766.1">        var likeCount = document.querySelector(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2767.1">'span.count .total'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2768.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2769.1">        var totalLikes = parseInt(likeCount.innerHTML);</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2770.1">        likeCount.innerHTML = previousAction === </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2771.1">'like'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2772.1"> ? </span><span class="koboSpan" id="kobo.2772.2">totalLikes + </span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.2773.1">1</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2774.1"> : totalLikes - </span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.2775.1">1</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2776.1">;</span></strong></span><span class="koboSpan" id="kobo.2777.1">
      }
    })
  });
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2778.1">The preceding code</span><a id="_idIndexMarker611"/><span class="koboSpan" id="kobo.2779.1"> works as follows:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2780.1">The previous action of the button is retrieved from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2781.1">data-action</span></code><span class="koboSpan" id="kobo.2782.1"> attribute of the link and it is stored in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2783.1">previousAction</span></code><span class="koboSpan" id="kobo.2784.1"> variable.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2785.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2786.1">data-action</span></code><span class="koboSpan" id="kobo.2787.1"> attribute of the link and the link text are toggled. </span><span class="koboSpan" id="kobo.2787.2">This allows users to undo their actions.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2788.1">The total like count is</span><a id="_idIndexMarker612"/><span class="koboSpan" id="kobo.2789.1"> retrieved from the DOM by using the selector </span><code class="inlineCode"><span class="koboSpan" id="kobo.2790.1">span.count.total</span></code><span class="koboSpan" id="kobo.2791.1"> and the value is parsed to an integer with </span><code class="inlineCode"><span class="koboSpan" id="kobo.2792.1">parseInt()</span></code><span class="koboSpan" id="kobo.2793.1">. </span><span class="koboSpan" id="kobo.2793.2">The total like count is increased or decreased according to the action performed (</span><em class="italic"><span class="koboSpan" id="kobo.2794.1">like</span></em><span class="koboSpan" id="kobo.2795.1"> or </span><em class="italic"><span class="koboSpan" id="kobo.2796.1">unlike</span></em><span class="koboSpan" id="kobo.2797.1">).</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.2798.1">Open the image detail page in your browser for an image that you have uploaded. </span><span class="koboSpan" id="kobo.2798.2">You should be able to see the following initial likes count and the </span><strong class="screenText"><span class="koboSpan" id="kobo.2799.1">LIKE</span></strong><span class="koboSpan" id="kobo.2800.1"> button, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2801.1"><img alt="" role="presentation" src="../Images/B21088_06_18.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2802.1">Figure 6.18: The likes count and LIKE button in the image detail template</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2803.1">Click on the </span><strong class="screenText"><span class="koboSpan" id="kobo.2804.1">LIKE</span></strong><span class="koboSpan" id="kobo.2805.1"> button. </span><span class="koboSpan" id="kobo.2805.2">You will note that the total likes count increases by one and the button text changes to </span><strong class="screenText"><span class="koboSpan" id="kobo.2806.1">UNLIKE</span></strong><span class="koboSpan" id="kobo.2807.1">, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2808.1"><img alt="" role="presentation" src="../Images/B21088_06_19.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2809.1">Figure 6.19: The likes count and button after clicking the LIKE button</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2810.1">If you click on the </span><strong class="screenText"><span class="koboSpan" id="kobo.2811.1">UNLIKE</span></strong><span class="koboSpan" id="kobo.2812.1"> button, the action is performed, and then the button’s text changes back to </span><strong class="screenText"><span class="koboSpan" id="kobo.2813.1">LIKE</span></strong><span class="koboSpan" id="kobo.2814.1"> and the total count changes accordingly.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2815.1">When programming JavaScript, especially when performing AJAX requests, it is recommended to use a tool for debugging JavaScript and HTTP requests. </span><span class="koboSpan" id="kobo.2815.2">Most modern browsers include developer tools to debug JavaScript. </span><span class="koboSpan" id="kobo.2815.3">Usually, you can right-click anywhere on the website to open the contextual menu and click on </span><strong class="screenText"><span class="koboSpan" id="kobo.2816.1">Inspect</span></strong><span class="koboSpan" id="kobo.2817.1"> or </span><strong class="screenText"><span class="koboSpan" id="kobo.2818.1">Inspect Element</span></strong><span class="koboSpan" id="kobo.2819.1"> to access the web developer tools of your browser.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2820.1">In the next section, you </span><a id="_idIndexMarker613"/><span class="koboSpan" id="kobo.2821.1">will learn how to use asynchronous </span><a id="_idIndexMarker614"/><span class="koboSpan" id="kobo.2822.1">HTTP requests with JavaScript and Django to implement infinite scroll pagination.</span></p>
<h2 class="heading-2" id="_idParaDest-190"><span class="koboSpan" id="kobo.2823.1">Adding infinite scroll pagination to the image list</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2824.1">Next, we need to list all bookmarked images on the website. </span><span class="koboSpan" id="kobo.2824.2">We will use JavaScript requests to build an infinite scroll functionality. </span><span class="koboSpan" id="kobo.2824.3">Infinite scroll is achieved by loading the next results automatically when</span><a id="_idIndexMarker615"/><span class="koboSpan" id="kobo.2825.1"> the user scrolls to the bottom of the page.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2826.1">Let’s implement an image list view that will handle both standard browser requests and requests originating from JavaScript. </span><span class="koboSpan" id="kobo.2826.2">When the user initially loads the image list page, we will display the first page of images. </span><span class="koboSpan" id="kobo.2826.3">When they scroll to the bottom of the page, we will retrieve the following page of items with JavaScript and append it to the bottom of the main page.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2827.1">The same view will handle both standard and AJAX infinite scroll pagination. </span><span class="koboSpan" id="kobo.2827.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2828.1">views.py</span></code><span class="koboSpan" id="kobo.2829.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2830.1">images</span></code><span class="koboSpan" id="kobo.2831.1"> application and add the following code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2832.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2833.1"> django.core.paginator </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2834.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2835.1"> EmptyPage, PageNotAnInteger, Paginator</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2836.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2837.1"> django.http </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2838.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2839.1"> HttpResponse</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.2840.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-meta-slc"><span class="koboSpan" id="kobo.2841.1">@login_required</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2842.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2843.1">image_list</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2844.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.2845.1">request</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2846.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2847.1">    images = Image.objects.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.2848.1">all</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2849.1">()</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2850.1">    paginator = Paginator(images, </span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.2851.1">8</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2852.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2853.1">    page = request.GET.get(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2854.1">'page'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2855.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2856.1">    images_only = request.GET.get(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2857.1">'images_only'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2858.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2859.1">try</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2860.1">:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2861.1">        images = paginator.page(page)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2862.1">except</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2863.1"> PageNotAnInteger:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.2864.1"># If page is not an integer deliver the first page</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2865.1">        images = paginator.page(</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.2866.1">1</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2867.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2868.1">except</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2869.1"> EmptyPage:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2870.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2871.1"> images_only:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.2872.1"># If AJAX request and page out of range</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.2873.1"># return an empty page</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2874.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2875.1"> HttpResponse(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2876.1">''</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2877.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.2878.1"># If page out of range return last page of results</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2879.1">        images = paginator.page(paginator.num_pages)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2880.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2881.1"> images_only:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2882.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2883.1"> render(</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"> </strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2884.1">request,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2885.1">'images/image/list_images.html'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2886.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2887.1">            {</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2888.1">'section'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2889.1">: </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2890.1">'images'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2891.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2892.1">'</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2893.1">images'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2894.1">: images}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2895.1">        )</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2896.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2897.1"> render(</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"> </strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2898.1">request,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2899.1">'images/image/list.html'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2900.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2901.1">            {</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2902.1">'section'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2903.1">: </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2904.1">'images'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2905.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2906.1">'images'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2907.1">: images}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2908.1">    )</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2909.1">In this view, a QuerySet is created</span><a id="_idIndexMarker616"/><span class="koboSpan" id="kobo.2910.1"> to retrieve all images from the database. </span><span class="koboSpan" id="kobo.2910.2">Then, a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2911.1">Paginator</span></code><span class="koboSpan" id="kobo.2912.1"> object is created to paginate over the results, retrieving eight images per page. </span><span class="koboSpan" id="kobo.2912.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2913.1">page</span></code><span class="koboSpan" id="kobo.2914.1"> HTTP </span><code class="inlineCode"><span class="koboSpan" id="kobo.2915.1">GET</span></code><span class="koboSpan" id="kobo.2916.1"> parameter is retrieved to get the requested page number. </span><span class="koboSpan" id="kobo.2916.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2917.1">images_only</span></code><span class="koboSpan" id="kobo.2918.1"> HTTP </span><code class="inlineCode"><span class="koboSpan" id="kobo.2919.1">GET</span></code><span class="koboSpan" id="kobo.2920.1"> parameter is retrieved to know if the whole page has to be rendered or only the new images. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.2921.1">We will render the whole page when it is requested by the browser. </span><span class="koboSpan" id="kobo.2921.2">However, we will only render the HTML with new images for Fetch API requests, since we will be appending them to the existing HTML page.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2922.1">An </span><code class="inlineCode"><span class="koboSpan" id="kobo.2923.1">EmptyPage</span></code><span class="koboSpan" id="kobo.2924.1"> exception will be triggered if the requested page is out of range. </span><span class="koboSpan" id="kobo.2924.2">If this is the case and only images have to be rendered, an empty </span><code class="inlineCode"><span class="koboSpan" id="kobo.2925.1">HttpResponse</span></code><span class="koboSpan" id="kobo.2926.1"> will be returned. </span><span class="koboSpan" id="kobo.2926.2">This will allow you to stop the AJAX pagination on the client side when reaching the last page. </span><span class="koboSpan" id="kobo.2926.3">The results are rendered using two different templates:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2927.1">For JavaScript HTTP requests, which will include the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2928.1">images_only</span></code><span class="koboSpan" id="kobo.2929.1"> parameter, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2930.1">list_images.html</span></code><span class="koboSpan" id="kobo.2931.1"> template will be rendered. </span><span class="koboSpan" id="kobo.2931.2">This template will only contain the images of the requested page.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2932.1">For browser requests, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2933.1">list.html</span></code><span class="koboSpan" id="kobo.2934.1"> template will be rendered. </span><span class="koboSpan" id="kobo.2934.2">This template will extend the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2935.1">base.html</span></code><span class="koboSpan" id="kobo.2936.1"> template to display the whole page and will include the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2937.1">list_images.html</span></code><span class="koboSpan" id="kobo.2938.1"> template to include the list of images.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.2939.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2940.1">urls.py</span></code><span class="koboSpan" id="kobo.2941.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2942.1">images</span></code><span class="koboSpan" id="kobo.2943.1"> application and add the following URL pattern highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2944.1">urlpatterns = [
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2945.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2946.1">create/'</span></span><span class="koboSpan" id="kobo.2947.1">, views.image_create, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.2948.1">'create'</span></span><span class="koboSpan" id="kobo.2949.1">),
    path(
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2950.1">'detail/&lt;int:id&gt;/&lt;slug:slug&gt;/'</span></span><span class="koboSpan" id="kobo.2951.1">,
        views.image_detail,
        name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.2952.1">'detail'</span></span>
<span class="hljs-string"> </span><span class="koboSpan" id="kobo.2953.1">),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2954.1">'like/'</span></span><span class="koboSpan" id="kobo.2955.1">, views.image_like, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.2956.1">'like'</span></span><span class="koboSpan" id="kobo.2957.1">),
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2958.1">    path(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2959.1">''</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2960.1">, views.image_list, name=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2961.1">'list'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2962.1">),</span></strong></span><span class="koboSpan" id="kobo.2963.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2964.1">Finally, you need to create the templates mentioned here. </span><span class="koboSpan" id="kobo.2964.2">Inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2965.1">images/image/</span></code><span class="koboSpan" id="kobo.2966.1"> template directory, create a new</span><a id="_idIndexMarker617"/><span class="koboSpan" id="kobo.2967.1"> template and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.2968.1">list_images.html</span></code><span class="koboSpan" id="kobo.2969.1">. </span><span class="koboSpan" id="kobo.2969.2">Add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2970.1">{% load thumbnail %}
{% for image in images %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2971.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2972.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2973.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2974.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2975.1">"image"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2976.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2977.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2978.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2979.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2980.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2981.1">"{{ image.get_absolute_url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2982.1">&gt;</span></span><span class="koboSpan" id="kobo.2983.1">
      {% thumbnail image.image 300x300 crop="smart" as im %}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2984.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2985.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2986.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2987.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2988.1">"{{ image.get_absolute_url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2989.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2990.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2991.1">img</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2992.1">src</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2993.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2994.1">"{{ im.url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2995.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2996.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2997.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2998.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2999.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3000.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3001.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3002.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3003.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3004.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3005.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3006.1">"info"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3007.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3008.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3009.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3010.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3011.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3012.1">"{{ image.get_absolute_url }}"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3013.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3014.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3015.1">"title"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3016.1">&gt;</span></span><span class="koboSpan" id="kobo.3017.1">
        {{ image.title }}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.3018.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3019.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3020.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3021.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3022.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3023.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3024.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3025.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3026.1">&gt;</span></span><span class="koboSpan" id="kobo.3027.1">
{% endfor %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3028.1">The preceding template displays the list of images. </span><span class="koboSpan" id="kobo.3028.2">You will use it to return results for AJAX requests. </span><span class="koboSpan" id="kobo.3028.3">In this code, you iterate over images and generate a square thumbnail for each image. </span><span class="koboSpan" id="kobo.3028.4">You normalize the size of the thumbnails to </span><code class="inlineCode"><span class="koboSpan" id="kobo.3029.1">300x300</span></code><span class="koboSpan" id="kobo.3030.1"> pixels. </span><span class="koboSpan" id="kobo.3030.2">You also use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3031.1">smart</span></code><span class="koboSpan" id="kobo.3032.1"> cropping option. </span><span class="koboSpan" id="kobo.3032.2">This option indicates that the image has to be incrementally cropped down to the requested size by removing slices from the edges with the least entropy.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3033.1">Create another template in the same directory and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.3034.1">images/image/list.html</span></code><span class="koboSpan" id="kobo.3035.1">. </span><span class="koboSpan" id="kobo.3035.2">Add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3036.1">{% extends "base.html" %}
{% block title %}Images bookmarked{% endblock %}
{% block content %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.3037.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3038.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3039.1">&gt;</span></span><span class="koboSpan" id="kobo.3040.1">Images bookmarked</span><span class="hljs-tag"><span class="koboSpan" id="kobo.3041.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3042.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3043.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3044.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3045.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3046.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3047.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3048.1">"image-list"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3049.1">&gt;</span></span><span class="koboSpan" id="kobo.3050.1">
    {% include "images/image/list_images.html" %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.3051.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3052.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3053.1">&gt;</span></span><span class="koboSpan" id="kobo.3054.1">
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3055.1">The list template extends the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3056.1">base.html</span></code><span class="koboSpan" id="kobo.3057.1"> template. </span><span class="koboSpan" id="kobo.3057.2">To avoid repeating code, you include the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3058.1">images/image/list_images.html</span></code><span class="koboSpan" id="kobo.3059.1"> template for displaying images. </span><span class="koboSpan" id="kobo.3059.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3060.1">images/image/list.html</span></code><span class="koboSpan" id="kobo.3061.1"> template</span><a id="_idIndexMarker618"/><span class="koboSpan" id="kobo.3062.1"> will hold the JavaScript code for loading additional pages when scrolling to the bottom of the page.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3063.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3064.1">images/image/list.html</span></code><span class="koboSpan" id="kobo.3065.1"> template and add the following code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3066.1">{% extends "base.html" %}
{% block title %}Images bookmarked{% endblock %}
{% block content %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.3067.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3068.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3069.1">&gt;</span></span><span class="koboSpan" id="kobo.3070.1">Images bookmarked</span><span class="hljs-tag"><span class="koboSpan" id="kobo.3071.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3072.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3073.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3074.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3075.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3076.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3077.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3078.1">"image-list"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3079.1">&gt;</span></span><span class="koboSpan" id="kobo.3080.1">
    {% include "images/image/list_images.html" %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.3081.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3082.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3083.1">&gt;</span></span><span class="koboSpan" id="kobo.3084.1">
{% endblock %}
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3085.1">{% block domready %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3086.1">  var page = 1;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3087.1">  var emptyPage = false;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3088.1">  var blockRequest = false;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3089.1">window.addEventListener('scroll', function(e) {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3090.1">    var margin = document.body.clientHeight - window.innerHeight - 200;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3091.1">    if(window.pageYOffset &gt; margin &amp;&amp; !emptyPage &amp;&amp; !blockRequest) {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3092.1">      blockRequest = true;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3093.1">      page += 1;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3094.1">      fetch('?images_only=1&amp;page=' + page)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3095.1">      .then(response =&gt; response.text())</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3096.1">      .then(html =&gt; {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3097.1">        if (html === '') {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3098.1">          emptyPage = true;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3099.1">        }</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3100.1">        else {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3101.1">          var imageList = document.getElementById('image-list');</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3102.1">          imageList.insertAdjacentHTML('beforeEnd', html);</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3103.1">          blockRequest = false;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3104.1">        }</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3105.1">      })</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3106.1">    }</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3107.1">  });</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3108.1">  // Launch scroll event</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3109.1">  const scrollEvent = new Event('scroll');</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3110.1">  window.dispatchEvent(scrollEvent);</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3111.1">{% endblock %}</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3112.1">The preceding code provides the infinite scroll functionality. </span><span class="koboSpan" id="kobo.3112.2">You include the JavaScript code in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3113.1">domready</span></code><span class="koboSpan" id="kobo.3114.1"> block that you</span><a id="_idIndexMarker619"/><span class="koboSpan" id="kobo.3115.1"> defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3116.1">base.html</span></code><span class="koboSpan" id="kobo.3117.1"> template. </span><span class="koboSpan" id="kobo.3117.2">The code is as follows:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.3118.1">You define the following variables:</span><ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.3119.1">page</span></code><span class="koboSpan" id="kobo.3120.1">: Stores the current page number.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.3121.1">empty_page</span></code><span class="koboSpan" id="kobo.3122.1">: Allows you to know whether the user is on the last page and retrieves an empty page. </span><span class="koboSpan" id="kobo.3122.2">As soon as you get an empty page, you will stop sending additional HTTP requests because you will assume that there are no more results.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.3123.1">block_request</span></code><span class="koboSpan" id="kobo.3124.1">: Prevents you from sending additional requests while an HTTP request is in progress.</span></li>
</ul>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.3125.1">You use </span><code class="inlineCode"><span class="koboSpan" id="kobo.3126.1">window.addEventListener()</span></code><span class="koboSpan" id="kobo.3127.1"> to capture the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3128.1">scroll</span></code><span class="koboSpan" id="kobo.3129.1"> event and to define a handler function for it.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.3130.1">You calculate the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3131.1">margin</span></code><span class="koboSpan" id="kobo.3132.1"> variable to get the difference between the total document height and the window inner height, because that’s the height of the remaining content for the user to scroll. </span><span class="koboSpan" id="kobo.3132.2">You subtract a value of </span><code class="inlineCode"><span class="koboSpan" id="kobo.3133.1">200</span></code><span class="koboSpan" id="kobo.3134.1"> from the result so that you load the next page when the user is closer than 200 pixels to the bottom of the page.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.3135.1">Before sending an HTTP request, you check that:</span><ul>
<li class="bulletList"><span class="koboSpan" id="kobo.3136.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3137.1">window.pageYOffset</span></code><span class="koboSpan" id="kobo.3138.1"> is higher than the calculated margin.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3139.1">The user didn’t get to the last page of results (</span><code class="inlineCode"><span class="koboSpan" id="kobo.3140.1">emptyPage</span></code><span class="koboSpan" id="kobo.3141.1"> has to be </span><code class="inlineCode"><span class="koboSpan" id="kobo.3142.1">false</span></code><span class="koboSpan" id="kobo.3143.1">).</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3144.1">There is no other ongoing HTTP request (</span><code class="inlineCode"><span class="koboSpan" id="kobo.3145.1">blockRequest</span></code><span class="koboSpan" id="kobo.3146.1"> has to be </span><code class="inlineCode"><span class="koboSpan" id="kobo.3147.1">false</span></code><span class="koboSpan" id="kobo.3148.1">).</span></li>
</ul>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.3149.1">If the previous conditions are met, you set </span><code class="inlineCode"><span class="koboSpan" id="kobo.3150.1">blockRequest</span></code><span class="koboSpan" id="kobo.3151.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.3152.1">true</span></code><span class="koboSpan" id="kobo.3153.1"> to prevent the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3154.1">scroll</span></code><span class="koboSpan" id="kobo.3155.1"> event from</span><a id="_idIndexMarker620"/><span class="koboSpan" id="kobo.3156.1"> triggering additional HTTP requests, and you increase the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3157.1">page</span></code><span class="koboSpan" id="kobo.3158.1"> counter by </span><code class="inlineCode"><span class="koboSpan" id="kobo.3159.1">1</span></code><span class="koboSpan" id="kobo.3160.1"> to retrieve the next page.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.3161.1">You use </span><code class="inlineCode"><span class="koboSpan" id="kobo.3162.1">fetch()</span></code><span class="koboSpan" id="kobo.3163.1"> to send an HTTP </span><code class="inlineCode"><span class="koboSpan" id="kobo.3164.1">GET</span></code><span class="koboSpan" id="kobo.3165.1"> request, setting the URL parameters </span><code class="inlineCode"><span class="koboSpan" id="kobo.3166.1">image_only=1</span></code><span class="koboSpan" id="kobo.3167.1"> to retrieve only the HTML for images instead of the whole HTML page, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.3168.1">page</span></code><span class="koboSpan" id="kobo.3169.1"> for the requested page number.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.3170.1">The body content is extracted from the HTTP response with </span><code class="inlineCode"><span class="koboSpan" id="kobo.3171.1">response.text()</span></code><span class="koboSpan" id="kobo.3172.1"> and the HTML returned is treated accordingly:</span><ul>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.3173.1">If the response has no content</span></strong><span class="koboSpan" id="kobo.3174.1">: You get to the end of the results and there are no more pages to load. </span><span class="koboSpan" id="kobo.3174.2">You set </span><code class="inlineCode"><span class="koboSpan" id="kobo.3175.1">emptyPage</span></code><span class="koboSpan" id="kobo.3176.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.3177.1">true</span></code><span class="koboSpan" id="kobo.3178.1"> to prevent additional HTTP requests.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.3179.1">If the response contains data</span></strong><span class="koboSpan" id="kobo.3180.1">: You append the data to the HTML element with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3181.1">image-list</span></code><span class="koboSpan" id="kobo.3182.1"> ID. </span><span class="koboSpan" id="kobo.3182.2">The page content expands vertically, appending results when the user approaches the bottom of the page. </span><span class="koboSpan" id="kobo.3182.3">You remove the lock for additional HTTP requests by setting </span><code class="inlineCode"><span class="koboSpan" id="kobo.3183.1">blockRequest</span></code><span class="koboSpan" id="kobo.3184.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.3185.1">false</span></code><span class="koboSpan" id="kobo.3186.1">.</span></li>
</ul>
</li>
<li class="numberedList"><span class="koboSpan" id="kobo.3187.1">Below the event listener, you simulate an initial </span><code class="inlineCode"><span class="koboSpan" id="kobo.3188.1">scroll</span></code><span class="koboSpan" id="kobo.3189.1"> event when the page is loaded. </span><span class="koboSpan" id="kobo.3189.2">You create the event by creating a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.3190.1">Event</span></code><span class="koboSpan" id="kobo.3191.1"> object, and then you launch it with </span><code class="inlineCode"><span class="koboSpan" id="kobo.3192.1">window.dispatchEvent()</span></code><span class="koboSpan" id="kobo.3193.1">. </span><span class="koboSpan" id="kobo.3193.2">By doing this, you ensure that the event is triggered if the initial content fits the window and has no scroll.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.3194.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.3195.1">https://127.0.0.1:8000/images/</span></code><span class="koboSpan" id="kobo.3196.1"> in your browser. </span><span class="koboSpan" id="kobo.3196.2">You will see the list of images that you have bookmarked so far. </span><span class="koboSpan" id="kobo.3196.3">It should look similar to this:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.3197.1"><img alt="" role="presentation" src="../Images/B21088_06_20.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.3198.1">Figure 6.20: The image list page with infinite scroll pagination</span></p>
<div class="note">
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.3199.1">Figure 6.19</span></em><span class="koboSpan" id="kobo.3200.1"> image </span><a id="_idIndexMarker621"/><span class="koboSpan" id="kobo.3201.1">attributions:</span></p>
<ul>
<li class="bulletList"><em class="italic"><span class="koboSpan" id="kobo.3202.1">Chick Corea</span></em><span class="koboSpan" id="kobo.3203.1"> by ataelw (license: Creative Commons Attribution 2.0 Generic: </span><span class="url"><span class="koboSpan" id="kobo.3204.1">https://creativecommons.org/licenses/by/2.0/</span></span><span class="koboSpan" id="kobo.3205.1">)</span></li>
<li class="bulletList"><em class="italic"><span class="koboSpan" id="kobo.3206.1">Al Jarreau - Düsseldorf 1981</span></em><span class="koboSpan" id="kobo.3207.1"> by Eddi Laumanns aka RX-Guru (license: Creative Commons Attribution 3.0 Unported: </span><span class="url"><span class="koboSpan" id="kobo.3208.1">https://creativecommons.org/licenses/by/3.0/</span></span><span class="koboSpan" id="kobo.3209.1">)</span></li>
<li class="bulletList"><em class="italic"><span class="koboSpan" id="kobo.3210.1">Al Jarreau </span></em><span class="koboSpan" id="kobo.3211.1">by Kingkongphoto and www.celebrity-photos.com (license: Creative Commons Attribution-ShareAlike 2.0 Generic: </span><span class="url"><span class="koboSpan" id="kobo.3212.1">https://creativecommons.org/licenses/by-sa/2.0/</span></span><span class="koboSpan" id="kobo.3213.1">)</span></li>
</ul>
</div>
<p class="normal"><span class="koboSpan" id="kobo.3214.1">Scroll to the bottom of the page to load additional pages. </span><span class="koboSpan" id="kobo.3214.2">Ensure that you have bookmarked more than eight images using the bookmarklet, because that’s the number of images you are displaying per page.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3215.1">You can use your browser developer tools to track the AJAX requests. </span><span class="koboSpan" id="kobo.3215.2">Usually, you can right-click anywhere on the website to open the contextual menu and click on </span><strong class="screenText"><span class="koboSpan" id="kobo.3216.1">Inspect</span></strong><span class="koboSpan" id="kobo.3217.1"> or </span><strong class="screenText"><span class="koboSpan" id="kobo.3218.1">Inspect Element</span></strong><span class="koboSpan" id="kobo.3219.1"> to access the </span><a id="_idIndexMarker622"/><span class="koboSpan" id="kobo.3220.1">web developer tools of your browser. </span><span class="koboSpan" id="kobo.3220.2">Look for the panel for network requests. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.3221.1">Reload the page and scroll to the bottom of the page to load new pages. </span><span class="koboSpan" id="kobo.3221.2">You will see the request for the first page and the AJAX requests for additional pages, like in </span><em class="italic"><span class="koboSpan" id="kobo.3222.1">Figure 6.21</span></em><span class="koboSpan" id="kobo.3223.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.3224.1"><img alt="" role="presentation" src="../Images/B21088_06_21.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.3225.1">Figure 6.21: HTTP requests registered in the developer tools of the browser</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3226.1">In the shell where you are running Django, you will see the requests as well, like this:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.3227.1">[04/Jan/2024 08:14:20] "GET /images/ HTTP/1.1" 200
[04/Jan/2024 08:14:25] "GET /images/?images_only=1&amp;page=2 HTTP/1.1" 200
[04/Jan/2024 08:14:26] "GET /images/?images_only=1&amp;page=3 HTTP/1.1" 200
[04/Jan/2024 08:14:26] "GET /images/?images_only=1&amp;page=4 HTTP/1.1" 200
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3228.1">Finally, edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3229.1">base.html</span></code><span class="koboSpan" id="kobo.3230.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3231.1">account</span></code><span class="koboSpan" id="kobo.3232.1"> application and add the URL for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3233.1">images</span></code><span class="koboSpan" id="kobo.3234.1"> item highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.3235.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3236.1">ul</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3237.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3238.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3239.1">"menu"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3240.1">&gt;</span></span><span class="koboSpan" id="kobo.3241.1">
  ...
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.3242.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3243.1">li</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3244.1"> {% </span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.3245.1">if</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3246.1">section</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3247.1"> == </span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3248.1">"images"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3249.1"> %}</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.3250.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3251.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3252.1">"selected"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3253.1">{% </span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.3254.1">endif</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3255.1"> %}&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3256.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3257.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3258.1">href</span></span><span class="koboSpan" id="kobo.3259.1">=</span><span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3260.1">"{% url "</span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.3261.1">images:list</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.3262.1">" %}"</span></strong></span><span class="koboSpan" id="kobo.3263.1">&gt;Images</span><span class="hljs-tag"><span class="koboSpan" id="kobo.3264.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3265.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3266.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3267.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3268.1">li</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3269.1">&gt;</span></span><span class="koboSpan" id="kobo.3270.1">
  ...
</span><span class="hljs-tag"><span class="koboSpan" id="kobo.3271.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3272.1">ul</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3273.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3274.1">Now you can</span><a id="_idIndexMarker623"/><span class="koboSpan" id="kobo.3275.1"> access the image list from the main menu.</span></p>
<h1 class="heading-1" id="_idParaDest-191"><span class="koboSpan" id="kobo.3276.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3277.1">In this chapter, you created models with many-to-many relationships and learned how to customize the behavior of forms. </span><span class="koboSpan" id="kobo.3277.2">You built a JavaScript bookmarklet to share images from other websites on your site. </span><span class="koboSpan" id="kobo.3277.3">This chapter has also covered the creation of image thumbnails using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3278.1">easy-thumbnails</span></code><span class="koboSpan" id="kobo.3279.1"> application. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.3280.1">Finally, you implemented AJAX views using the JavaScript Fetch API and added infinite scroll pagination to the image list view.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3281.1">In the next chapter, you will learn how to build a follow system and an activity stream. </span><span class="koboSpan" id="kobo.3281.2">You will work with generic relations, signals, and denormalization. </span><span class="koboSpan" id="kobo.3281.3">You will also learn how to use Redis with Django to count image views and generate an image ranking.</span></p>
<h1 class="heading-1" id="_idParaDest-192"><span class="koboSpan" id="kobo.3282.1">Additional resources</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3283.1">The following resources provide additional information related to the topics covered in this chapter:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.3284.1">Source code for this chapter: </span><a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter06"><span class="url"><span class="koboSpan" id="kobo.3285.1">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter06</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3286.1">Database indexes: </span><a href="https://docs.djangoproject.com/en/5.0/ref/models/options/#django.db.models.Options.indexes"><span class="url"><span class="koboSpan" id="kobo.3287.1">https://docs.djangoproject.com/en/5.0/ref/models/options/#django.db.models.Options.indexes</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3288.1">Many-to-many relationships: </span><a href="https://docs.djangoproject.com/en/5.0/topics/db/examples/many_to_many/"><span class="url"><span class="koboSpan" id="kobo.3289.1">https://docs.djangoproject.com/en/5.0/topics/db/examples/many_to_many/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3290.1">Requests HTTP library for Python: </span><a href="https://docs.djangoproject.com/en/5.0/topics/db/examples/many_to_many/"><span class="url"><span class="koboSpan" id="kobo.3291.1">https://docs.djangoproject.com/en/5.0/topics/db/examples/many_to_many/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3292.1">Pinterest Save extension: </span><a href="https://help.pinterest.com/en/article/save-pins-with-the-pinterest-browser-button"><span class="url"><span class="koboSpan" id="kobo.3293.1">https://help.pinterest.com/en/article/save-pins-with-the-pinterest-browser-button</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3294.1">Static content for the account application: </span><a href="https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter06/bookmarks/images/static"><span class="url"><span class="koboSpan" id="kobo.3295.1">https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter06/bookmarks/images/static</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3296.1">CSS selectors: </span><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Selectors"><span class="url"><span class="koboSpan" id="kobo.3297.1">https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Selectors</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3298.1">Locating DOM elements using CSS selectors: </span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Document_object_model/Locating_DOM_elements_using_selectors"><span class="url"><span class="koboSpan" id="kobo.3299.1">https://developer.mozilla.org/en-US/docs/Web/API/Document_object_model/Locating_DOM_elements_using_selectors</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3300.1">Let’s Encrypt free automated certificate authority: </span><a href="https://letsencrypt.org"><span class="url"><span class="koboSpan" id="kobo.3301.1">https://letsencrypt.org</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3302.1">Django </span><code class="inlineCode"><span class="koboSpan" id="kobo.3303.1">easy-thumbnails</span></code><span class="koboSpan" id="kobo.3304.1"> app: </span><a href="https://easy-thumbnails.readthedocs.io/"><span class="url"><span class="koboSpan" id="kobo.3305.1">https://easy-thumbnails.readthedocs.io/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3306.1">JavaScript Fetch API usage: </span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch"><span class="url"><span class="koboSpan" id="kobo.3307.1">https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3308.1">JavaScript Cookie library: </span><a href="https://github.com/js-cookie/js-cookie"><span class="url"><span class="koboSpan" id="kobo.3309.1">https://github.com/js-cookie/js-cookie</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3310.1">Django’s CSRF protection and AJAX: </span><a href="https://docs.djangoproject.com/en/5.0/ref/csrf/#ajax"><span class="url"><span class="koboSpan" id="kobo.3311.1">https://docs.djangoproject.com/en/5.0/ref/csrf/#ajax</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3312.1">JavaScript Fetch API Request mode: </span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Request/mode"><span class="url"><span class="koboSpan" id="kobo.3313.1">https://developer.mozilla.org/en-US/docs/Web/API/Request/mode</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3314.1">JavaScript Fetch API Response: </span><a href="https://developer.mozilla.org/en-US/docs/Web/API/Response"><span class="url"><span class="koboSpan" id="kobo.3315.1">https://developer.mozilla.org/en-US/docs/Web/API/Response</span></span></a></li>
</ul>
</div>
</body></html>