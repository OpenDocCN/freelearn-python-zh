<html><head></head><body>
<div><h1 class="chapterNumber">6</h1>
<h1 class="chapterTitle" id="_idParaDest-173">Sharing Content on Your Website</h1>
<p class="normal">In the previous chapter, you added success and error messages to your site using the Django messages framework. You also created an email authentication backend and added social authentication to your site using Google. You learned how to run your development server with HTTPS on your local machine using Django Extensions. You customized the social authentication pipeline to create a user profile for new users automatically.</p>
<p class="normal">In this chapter, you will learn how to create a JavaScript bookmarklet to share content from other sites on your website, and you will implement asynchronous browser requests in your project using JavaScript and Django.</p>
<p class="normal">This chapter will cover the following topics:</p>
<ul>
<li class="bulletList">Creating many-to-many relationships</li>
<li class="bulletList">Customizing behavior for forms</li>
<li class="bulletList">Using JavaScript with Django</li>
<li class="bulletList">Building a JavaScript bookmarklet</li>
<li class="bulletList">Generating image thumbnails using <code class="inlineCode">easy-thumbnails</code></li>
<li class="bulletList">Implementing asynchronous HTTP requests with JavaScript and Django</li>
<li class="bulletList">Building infinite scroll pagination</li>
</ul>
<p class="normal">In this chapter, you will create an image bookmarking system. You will create models with many-to-many relationships and customize the behavior of forms. You will learn how to generate image thumbnails and how to build asynchronous browser functionalities using JavaScript and Django.</p>
<h1 class="heading-1" id="_idParaDest-174">Functional overview</h1>
<p class="normal"><em class="italic">Figure 6.1</em> shows a <a id="_idIndexMarker498"/>representation of the views, templates, and functionalities that will be built in this chapter:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_06_01.png"/></figure>
<p class="packt_figref">Figure 6.1: Diagram of functionalities built in Chapter 6</p>
<p class="normal">In the chapter, you will implement a <strong class="screenText">Bookmark it</strong> button that will allow users to bookmark images from any website. You will use JavaScript to display an image selector on top of any website for users to select an image to bookmark. You will implement the <code class="inlineCode">image_create</code> view and a form to retrieve the image from its original source and store it on your website. You will build the <code class="inlineCode">image_detail</code> view to display single images and you will generate image thumbnails automatically using the <code class="inlineCode">easy-thumbnails</code> package. You will also implement the <code class="inlineCode">image_like</code> view to allow users to <em class="italic">like/unlike</em> images. This view will handle asynchronous HTTP requests performed with JavaScript and return a response in JSON format. You will finally create the <code class="inlineCode">image_list</code> view to display all bookmarked images and you will implement an infinite scroll using JavaScript and Django pagination.</p>
<p class="normal">The source code for this chapter can be found at <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter06">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter06</a>.</p>
<p class="normal">All Python packages used in this chapter are included in the <code class="inlineCode">requirements.txt</code> file in the source code for the chapter. You can follow the instructions to install each Python package in the following sections, or you can install all requirements at once with the <code class="inlineCode">python -m pip install -r requirements.txt</code> command.</p>
<h1 class="heading-1" id="_idParaDest-175">Creating an image bookmarking website</h1>
<p class="normal">We will now learn how to allow users to bookmark images that they find on other websites and <a id="_idIndexMarker499"/>share them on our site. To build this functionality, we will need the following elements:</p>
<ul>
<li class="bulletList">A data model to store images and related information.</li>
<li class="bulletList">A form and a view to handle image uploads.</li>
<li class="bulletList">JavaScript bookmarklet code that can be executed on any website. This code will find images across the page and allow users to select the image they want to bookmark.</li>
</ul>
<p class="normal">First, create a new application inside your <code class="inlineCode">bookmarks</code> project directory by running the following command in the shell prompt:</p>
<pre class="programlisting con"><code class="hljs-con">django-admin startapp images
</code></pre>
<p class="normal">Add the new application to the <code class="inlineCode">INSTALLED_APPS</code> setting in the <code class="inlineCode">settings.py</code> file of the project, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">INSTALLED_APPS = [
    # ...
<strong class="hljs-string-slc">'images.apps.ImagesConfig'</strong><strong class="hljs-slc">,</strong>
]
</code></pre>
<p class="normal">We have activated the <code class="inlineCode">images</code> application in the project.</p>
<h2 class="heading-2" id="_idParaDest-176">Building the image model</h2>
<p class="normal">Edit the <code class="inlineCode">models.py</code> file<a id="_idIndexMarker500"/> of the <code class="inlineCode">images</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.conf import settings
from django.db import models
class Image(models.Model):
    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        related_name='images_created',
        on_delete=models.CASCADE
    )
    title = models.CharField(max_length=200)
    slug = models.SlugField(max_length=200, blank=True)
    url = models.URLField(max_length=2000)
    image = models.ImageField(upload_to='images/%Y/%m/%d/')
    description = models.TextField(blank=True)
    created = models.DateTimeField(auto_now_add=True)
    class Meta:
        indexes = [
            models.Index(fields=['-created']),
        ]
        ordering = ['-created']
    def __str__(self):
        return self.title
</code></pre>
<p class="normal">This is the model that we will use to store images in the platform. Let’s take a look at the fields of this model:</p>
<ul>
<li class="bulletList"><code class="inlineCode">user</code>: This indicates the <code class="inlineCode">User</code> object that bookmarked this image. This is a foreign key field because it specifies a many-to-one relationship: a user can post multiple images, but each image is posted by a single user. We have used <code class="inlineCode">CASCADE</code> for the <code class="inlineCode">on_delete</code> parameter so that related images are deleted when a user is deleted.</li>
<li class="bulletList"><code class="inlineCode">title</code>: A title for the image.</li>
<li class="bulletList"><code class="inlineCode">slug</code>: A short label that contains only letters, numbers, underscores, or hyphens to be used for building beautiful SEO-friendly URLs.</li>
<li class="bulletList"><code class="inlineCode">url</code>: The original URL for this image. We use <code class="inlineCode">max_length</code> to define a maximum length of <code class="inlineCode">2000</code> characters.</li>
<li class="bulletList"><code class="inlineCode">image</code>: The image file.</li>
<li class="bulletList"><code class="inlineCode">description</code>: An optional description for the image.</li>
<li class="bulletList"><code class="inlineCode">created</code>: The date and time that indicate when the object was created in the database. We have added <code class="inlineCode">auto_now_add</code> to automatically set the current datetime when the object is created.</li>
</ul>
<p class="normal">In the <code class="inlineCode">Meta</code> class of the model, we have defined a database index in descending order for the <code class="inlineCode">created</code> field. We<a id="_idIndexMarker501"/> have also added the <code class="inlineCode">ordering</code> attribute to tell Django that it should sort results by the <code class="inlineCode">created</code> field by default. We indicate descending order by using a hyphen before the field name, such as <code class="inlineCode">-created</code>, so that new images will be displayed first.</p>
<p class="normal">Database indexes improve query performance. Consider creating indexes for fields that you frequently query using <code class="inlineCode">filter()</code>, <code class="inlineCode">exclude()</code>, or <code class="inlineCode">order_by()</code>. <code class="inlineCode">ForeignKey</code> fields or fields with <code class="inlineCode">unique=True</code> imply the creation of an index. You can learn more about database indexes at <a href="https://docs.djangoproject.com/en/5.0/ref/models/options/#django.db.models.Options.indexes">https://docs.djangoproject.com/en/5.0/ref/models/options/#django.db.models.Options.indexes</a>.</p>
<p class="normal">We will override the <code class="inlineCode">save()</code> method of the <code class="inlineCode">Image</code> model to automatically generate the <code class="inlineCode">slug</code> field based on the value of the <code class="inlineCode">title</code> field. Import the <code class="inlineCode">slugify()</code> function and add a <code class="inlineCode">save()</code> method to the <code class="inlineCode">Image</code> model, as follows. New lines are highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.utils.text </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> slugify</strong>
class Image(models.Model):
    # ...
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">save</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self, *args, **kwargs</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">not</strong><strong class="hljs-slc"> self.slug:</strong>
<strong class="hljs-slc">            self.slug = slugify(self.title)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">super</strong><strong class="hljs-slc">().save(*args, **kwargs)</strong>
</code></pre>
<p class="normal">When an <code class="inlineCode">Image</code> object is saved, if the <code class="inlineCode">slug</code> field doesn’t have a value, the <code class="inlineCode">slugify()</code> function is used to automatically generate a slug from the <code class="inlineCode">title</code> field of the image. The object is then saved. By generating slugs automatically from the title, users won’t have to provide a slug when <a id="_idIndexMarker502"/>they share images on our website.</p>
<h2 class="heading-2" id="_idParaDest-177">Creating many-to-many relationships</h2>
<p class="normal">Next, we will add another<a id="_idIndexMarker503"/> field to the <code class="inlineCode">Image</code> model to store the users who like an image. We will need a many-to-many relationship in this case because a user might like multiple images and each image can be liked by multiple users.</p>
<p class="normal">Add the following field to the <code class="inlineCode">Image</code> model:</p>
<pre class="programlisting code"><code class="hljs-code">users_like = models.ManyToManyField(
    settings.AUTH_USER_MODEL,
    related_name='images_liked',
    blank=True
)
</code></pre>
<p class="normal">When we define a <code class="inlineCode">ManyToManyField</code> field, Django creates an intermediary join table using the primary keys of both models. <em class="italic">Figure 6.2</em> shows the database table that will be created for this relationship:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_06_02.png"/></figure>
<p class="packt_figref">Figure 6.2: Intermediary database table for the many-to-many relationship</p>
<p class="normal">The <code class="inlineCode">images_image_users_like</code> table is created by Django as an intermediary table that has references to the <code class="inlineCode">images_image</code> table (<code class="inlineCode">Image</code> model) and <code class="inlineCode">auth_user</code> table (<code class="inlineCode">User</code> model). The <code class="inlineCode">ManyToManyField</code> field can be defined in either of the two related models.</p>
<p class="normal">As with <code class="inlineCode">ForeignKey</code> fields, the <code class="inlineCode">related_name</code> attribute of <code class="inlineCode">ManyToManyField</code> allows you to name the relationship from the related object back to this one. <code class="inlineCode">ManyToManyField</code> fields provide a many-to-many manager that allows you to retrieve related objects, such as <code class="inlineCode">image.users_like.all()</code>, or get them from a <code class="inlineCode">user</code> object, such as <code class="inlineCode">user.images_liked.all()</code>.</p>
<p class="normal">You can learn more about many-to-many relationships at <a href="https://docs.djangoproject.com/en/5.0/topics/db/examples/many_to_many/">https://docs.djangoproject.com/en/5.0/topics/db/examples/many_to_many/</a>.</p>
<p class="normal">Open the shell prompt <a id="_idIndexMarker504"/>and run the following command to create an initial migration:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py makemigrations images
</code></pre>
<p class="normal">The output should be similar to the following one:</p>
<pre class="programlisting con"><code class="hljs-con">Migrations for 'images':
  images/migrations/0001_initial.py
    - Create model Image
    - Create index images_imag_created_d57897_idx on field(s) -created of model image
</code></pre>
<p class="normal">Now run the following command to apply your migration:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py migrate images
</code></pre>
<p class="normal">You will get an output that includes the following line:</p>
<pre class="programlisting con"><code class="hljs-con">Applying images.0001_initial... OK
</code></pre>
<p class="normal">The <code class="inlineCode">Image</code> model is now synced to the database.</p>
<h2 class="heading-2" id="_idParaDest-178">Registering the image model in the administration site</h2>
<p class="normal">Edit the <code class="inlineCode">admin.py</code> file of the <code class="inlineCode">images</code> application<a id="_idIndexMarker505"/> and register the <code class="inlineCode">Image</code> model into the administration site, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">from django.contrib import admin
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> .models </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> Image</strong>
<strong class="hljs-meta-slc">@admin.register(</strong><strong class="hljs-params-slc">Image</strong><strong class="hljs-meta-slc">)</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">ImageAdmin</strong><strong class="hljs-slc">(admin.ModelAdmin):</strong>
<strong class="hljs-slc">    list_display = [</strong><strong class="hljs-string-slc">'title'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'slug'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'image'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'created'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">    list_filter = [</strong><strong class="hljs-string-slc">'created'</strong><strong class="hljs-slc">]</strong>
</code></pre>
<p class="normal">Start the development server with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver_plus --cert-file cert.crt
</code></pre>
<p class="normal">Open <code class="inlineCode">https://127.0.0.1:8000/admin/</code> in your browser, and you will see the <code class="inlineCode">Image</code> model in the administration site, like this:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_06_03.png"/></figure>
<p class="packt_figref">Figure 6.3: The Images block on the Django administration site index page</p>
<p class="normal">You have completed the <a id="_idIndexMarker506"/>model to store images. Now you will learn how to implement a form to retrieve images by their URL and store them using the <code class="inlineCode">Image</code> model.</p>
<h1 class="heading-1" id="_idParaDest-179">Posting content from other websites</h1>
<p class="normal">We will allow users to bookmark images<a id="_idIndexMarker507"/> from external websites and share them on our site. Users will provide the URL of the image, a title, and an optional <a id="_idIndexMarker508"/>description. We will create a form and a view to download the image and create a new <code class="inlineCode">Image</code> object in the database.</p>
<p class="normal">Let’s start by building a form to submit new images.</p>
<p class="normal">Create a new <code class="inlineCode">forms.py</code> file inside the <code class="inlineCode">images</code> application directory and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django import forms
from .models import Image
class ImageCreateForm(forms.ModelForm):
    class Meta:
        model = Image
        fields = ['title', 'url', 'description']
        widgets = {
            'url': forms.HiddenInput,
        }
</code></pre>
<p class="normal">We have defined a <code class="inlineCode">ModelForm</code> form from the <code class="inlineCode">Image</code> model, including only the <code class="inlineCode">title</code>, <code class="inlineCode">url</code>, and <code class="inlineCode">description</code> fields. Users will not enter the image URL directly in the form. Instead, we will provide them with a JavaScript tool to choose an image from an external site, and the form will receive the image’s URL as a parameter. We have overridden the default widget of the <code class="inlineCode">url</code> field <a id="_idIndexMarker509"/>to use a <code class="inlineCode">HiddenInput</code> widget. This widget is rendered as an HTML <code class="inlineCode">input</code> element with a <code class="inlineCode">type="hidden"</code> attribute. We use this widget because we don’t want this field to<a id="_idIndexMarker510"/> be visible to users.</p>
<h2 class="heading-2" id="_idParaDest-180">Cleaning form fields</h2>
<p class="normal">In order to verify that the provided<a id="_idIndexMarker511"/> image URL is valid, we will check that the filename ends with a <code class="inlineCode">.jpg</code>, <code class="inlineCode">.jpeg</code>, or <code class="inlineCode">.png</code> extension to allow sharing JPEG and PNG files only. In the previous chapter, we used the <code class="inlineCode">clean_&lt;fieldname&gt;()</code> convention to implement field validation. This method is executed for each field, if the field is present, when we call <code class="inlineCode">is_valid()</code> on a form instance. In the <code class="inlineCode">clean</code> method, you can alter the field’s value or raise any validation errors for the field.</p>
<p class="normal">In the <code class="inlineCode">forms.py</code> file of the <code class="inlineCode">images</code> application, add the following method to the <code class="inlineCode">ImageCreateForm</code> class:</p>
<pre class="programlisting code"><code class="hljs-code">def clean_url(self):
    url = self.cleaned_data['url']
    valid_extensions = ['jpg', 'jpeg', 'png']
    extension = url.rsplit('.', 1)[1].lower()
    if extension not in valid_extensions:
        raise forms.ValidationError(
            'The given URL does not match valid image extensions.'
 )
    return url
</code></pre>
<p class="normal">In the preceding code, we have defined a <code class="inlineCode">clean_url()</code> method to clean the <code class="inlineCode">url</code> field. The code works as follows:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">The value of the <code class="inlineCode">url</code> field is retrieved by accessing the <code class="inlineCode">cleaned_data</code> dictionary of the form instance.</li>
<li class="numberedList">The URL is split to check whether the file has a valid extension. If the extension is invalid, a <code class="inlineCode">ValidationError</code> is raised and the form instance is not validated.</li>
</ol>
<p class="normal">In addition to validating the given URL, we also need to download the image file and save it. We could, for example, use the view that handles the form to download the image file. Instead, let’s take a more general approach by overriding the <code class="inlineCode">save()</code> method of the model form to perform this task when the form is saved.</p>
<h2 class="heading-2" id="_idParaDest-181">Installing the Requests library</h2>
<p class="normal">When a user bookmarks an image, we will need to download the image file by its URL. We will use the Requests Python library for this purpose. Requests is the most popular HTTP library for Python. It abstracts<a id="_idIndexMarker512"/> the complexity of <a id="_idIndexMarker513"/>dealing with HTTP requests and provides a very simple interface to consume HTTP services. You can find the documentation for the Requests library at <a href="https://requests.readthedocs.io/en/master/">https://requests.readthedocs.io/en/master/</a>.</p>
<p class="normal">Open the shell and install the Requests library with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install requests==2.31.0
</code></pre>
<p class="normal">We will now override the <code class="inlineCode">save()</code> method of <code class="inlineCode">ImageCreateForm</code> and use the Requests library to retrieve the image by its URL.</p>
<h2 class="heading-2" id="_idParaDest-182">Overriding the save() method of a ModelForm</h2>
<p class="normal">As you know, <code class="inlineCode">ModelForm</code> provides a <code class="inlineCode">save()</code> method to save the current model instance to the database and return the object. This <a id="_idIndexMarker514"/>method receives a Boolean <code class="inlineCode">commit</code> parameter, which allows you to<a id="_idIndexMarker515"/> specify whether the object has to be persisted to the database. If <code class="inlineCode">commit</code> is <code class="inlineCode">False</code>, the <code class="inlineCode">save()</code> method will return a model instance but will not save it to the database. We will override the form’s <code class="inlineCode">save()</code> method in order to retrieve the image file by the given URL and save it to the file system.</p>
<p class="normal">Add the following imports at the top of the <code class="inlineCode">forms.py</code> file:</p>
<pre class="programlisting code"><code class="hljs-code">import requests
from django.core.files.base import ContentFile
from django.utils.text import slugify
</code></pre>
<p class="normal">Then, add the following <code class="inlineCode">save()</code> method to the <code class="inlineCode">ImageCreateForm</code> form:</p>
<pre class="programlisting code"><code class="hljs-code">def save(self, force_insert=False, force_update=False, commit=True):
    image = super().save(commit=False)
    image_url = self.cleaned_data['url']
    name = slugify(image.title)
    extension = image_url.rsplit('.', 1)[1].lower()
    image_name = f'{name}.{extension}'
# download image from the given URL
    response = requests.get(image_url)
    image.image.save(
        image_name,
        ContentFile(response.content),
        save=False
 )
    if commit:
        image.save()
    return image
</code></pre>
<p class="normal">We have overridden the <code class="inlineCode">save()</code> method, keeping the parameters required by <code class="inlineCode">ModelForm</code>. The preceding code <a id="_idIndexMarker516"/>can be explained as follows:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">A new <code class="inlineCode">image</code> instance is created by calling the <code class="inlineCode">save()</code> method of the form with <code class="inlineCode">commit=False</code>.</li>
<li class="numberedList">The URL of the image is retrieved from the <code class="inlineCode">cleaned_data</code> dictionary of the form.</li>
<li class="numberedList">An image name is<a id="_idIndexMarker517"/> generated by combining the <code class="inlineCode">image</code> title slug with the original file extension of the image.</li>
<li class="numberedList">The Requests Python library is used to download the image by sending an HTTP <code class="inlineCode">GET</code> request using the image URL. The response is stored in the <code class="inlineCode">response</code> object.</li>
<li class="numberedList">The <code class="inlineCode">save()</code> method of the <code class="inlineCode">image</code> field is called, passing it a <code class="inlineCode">ContentFile</code> object that is instantiated with the downloaded file content. In this way, the file is saved to the media directory of the project. The <code class="inlineCode">save=False</code> parameter is passed to prevent the object from being saved to the database.</li>
<li class="numberedList">To maintain the same behavior as the original <code class="inlineCode">save()</code> method of the model form, the form is only saved to the database if the <code class="inlineCode">commit</code> parameter is <code class="inlineCode">True</code>.</li>
</ol>
<p class="normal">We will need a view to create an instance of the form and handle its submission.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">images</code> application <a id="_idIndexMarker518"/>and add the following code to it. New code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.contrib </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> messages</strong>
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.contrib.auth.decorators </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> login_required</strong>
from django.shortcuts import <strong class="hljs-slc">redirect, </strong>render
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> .forms </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> ImageCreateForm</strong>
<strong class="hljs-meta-slc">@login_required</strong>
<strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">image_create</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">request</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> request.method == </strong><strong class="hljs-string-slc">'POST'</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># form is sent</strong>
<strong class="hljs-slc">        form = ImageCreateForm(data=request.POST)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> form.is_valid():</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># form data is valid</strong>
<strong class="hljs-slc">            cd = form.cleaned_data</strong>
<strong class="hljs-slc">            new_image = form.save(commit=</strong><strong class="hljs-literal-slc">False</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># assign current user to the item</strong>
<strong class="hljs-slc">            new_image.user = request.user</strong>
<strong class="hljs-slc">            new_image.save()</strong>
<strong class="hljs-slc">            messages.success(request, </strong><strong class="hljs-string-slc">'Image added successfully'</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># redirect to new created item detail view</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> redirect(new_image.get_absolute_url())</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">else</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># build form with data provided by the bookmarklet via GET</strong>
<strong class="hljs-slc">        form = ImageCreateForm(data=request.GET)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> render(</strong>
<strong class="hljs-slc">        request,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'images/image/create.html'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        {</strong><strong class="hljs-string-slc">'section'</strong><strong class="hljs-slc">: </strong><strong class="hljs-string-slc">'images'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'form'</strong><strong class="hljs-slc">: form}</strong>
<strong class="hljs-slc">    )</strong>
</code></pre>
<p class="normal">In the preceding code, we have created a view to store images on the site. We have added the <code class="inlineCode">login_required</code> decorator to the <code class="inlineCode">image_create</code> view to prevent access to unauthenticated users. This is how<a id="_idIndexMarker519"/> this view works:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">Initial data has to be provided through a <code class="inlineCode">GET</code> HTTP request in order to create an instance of the form. This data will consist of the <code class="inlineCode">url</code> and <code class="inlineCode">title</code> attributes of an image from an external website. Both parameters will be set in the <code class="inlineCode">GET</code> request by the JavaScript bookmarklet that we will create later. For now, we can assume that this data will be available in the request.</li>
<li class="numberedList">When the form is submitted with a <code class="inlineCode">POST</code> HTTP request, it is validated with <code class="inlineCode">form.is_valid()</code>. If the form data is valid, a new <code class="inlineCode">image</code> instance is created by saving the form with <code class="inlineCode">form.save(commit=False)</code>. The new instance is not saved to the database because of <code class="inlineCode">commit=False</code>.</li>
<li class="numberedList">A relationship to the<a id="_idIndexMarker520"/> current user performing the request is added to the new <code class="inlineCode">image</code> instance with <code class="inlineCode">new_image.user = request.user</code>. This is how we will know who uploaded each image.</li>
<li class="numberedList">The <code class="inlineCode">Image</code> object is saved to the database.</li>
<li class="numberedList">Finally, a success message is created using the Django messages framework and the user is redirected to<a id="_idIndexMarker521"/> the canonical URL of the new image. We haven’t yet implemented the <code class="inlineCode">get_absolute_url()</code> method of the <code class="inlineCode">Image</code> model; we will do that later.</li>
</ol>
<p class="normal">Create a new <code class="inlineCode">urls.py</code> file inside the <code class="inlineCode">images</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.urls import path
from . import views
app_name = 'images'
urlpatterns = [
    path('create/', views.image_create, name='create'),
]
</code></pre>
<p class="normal">Edit the main <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">bookmarks</code> project to include the patterns for the <code class="inlineCode">images</code> application, as follows. The new code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    path('admin/', admin.site.urls),
    path('account/', include('account.urls')),
    path(
        'social-auth/',
        include('social_django.urls', namespace='social')
    ),
<strong class="hljs-slc">    path(</strong><strong class="hljs-string-slc">'images/'</strong><strong class="hljs-slc">, include(</strong><strong class="hljs-string-slc">'images.urls'</strong><strong class="hljs-slc">, namespace=</strong><strong class="hljs-string-slc">'images'</strong><strong class="hljs-slc">)),</strong>
]
</code></pre>
<p class="normal">Finally, we need to create a template to render the form. Create the following directory structure inside the <code class="inlineCode">images</code> application directory:</p>
<pre class="programlisting con"><code class="hljs-con">templates/
  images/
    image/
      create.html
</code></pre>
<p class="normal">Edit the new <code class="inlineCode">create.html</code> template<a id="_idIndexMarker522"/> and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Bookmark an image{% endblock %}
{% block content %}
  &lt;h1&gt;Bookmark an image&lt;/h1&gt;
&lt;img src="img/{{ request.GET.url }}" class="image-preview"&gt;
&lt;form method="post"&gt;
    {{ form.as_p }}
    {% csrf_token %}
    &lt;input type="submit" value="Bookmark it!"&gt;
&lt;/form&gt;
{% endblock %}
</code></pre>
<p class="normal">Run the development server <a id="_idIndexMarker523"/>with the following command in the shell prompt:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver_plus --cert-file cert.crt
</code></pre>
<p class="normal">Open <code class="inlineCode">https://127.0.0.1:8000/images/create/?title=...&amp;url=...</code> in your browser, including the <code class="inlineCode">title</code> and <code class="inlineCode">url</code> GET parameters, providing an existing JPEG image URL in the latter. For example, you can use the following URL: <code class="inlineCode">https://127.0.0.1:8000/images/create/?title=%20Django%20and%20Duke&amp;url=https://upload.wikimedia.org/wikipedia/commons/8/85/Django_Reinhardt_and_Duke_Ellington_%28Gottlieb%29.jpg</code>.</p>
<p class="normal">You will see the form with an image preview, like the following:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_06_04.png"/></figure>
<p class="packt_figref">Figure 6.4: The Bookmark an image bookmark page</p>
<p class="normal">Add a description and click on<a id="_idIndexMarker524"/> the <strong class="keyWord">BOOKMARK IT!</strong> button. A new <code class="inlineCode">Image</code> object will be saved in your database. However, you will <a id="_idIndexMarker525"/>get an error that indicates that the <code class="inlineCode">Image</code> model has no <code class="inlineCode">get_absolute_url()</code> method, as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_06_05.png"/></figure>
<p class="packt_figref">Figure 6.5: An error showing that the Image object has no get_absolute_url attribute</p>
<p class="normal">Don’t worry about this error for now; we are going to implement the <code class="inlineCode">get_absolute_url</code> method in the <code class="inlineCode">Image</code> model later.</p>
<p class="normal">Open <code class="inlineCode">https://127.0.0.1:8000/admin/images/image/</code> in your browser and verify that the new <code class="inlineCode">Image</code> object<a id="_idIndexMarker526"/> has been <a id="_idIndexMarker527"/>saved, like this:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_06_06.png"/></figure>
<p class="packt_figref">Figure 6.6: The administration site image list page showing the created Image object</p>
<h2 class="heading-2" id="_idParaDest-183">Building a bookmarklet with JavaScript</h2>
<p class="normal">A bookmarklet is a bookmark stored in a<a id="_idIndexMarker528"/> web browser that contains JavaScript code to extend the browser’s functionality. When you click on the bookmark in the bookmarks or favorites bar of <a id="_idIndexMarker529"/>your browser, the JavaScript code is executed on the website being displayed in the browser. This is very useful for building tools that interact with other websites.</p>
<p class="normal">Some online services, such as Pinterest, implement their own bookmarklet to let users share content from other sites on their platforms. The Pinterest bookmarklet is implemented as a browser extension and is available at <a href="https://help.pinterest.com/en/article/save-pins-with-the-pinterest-browser-button">https://help.pinterest.com/en/article/save-pins-with-the-pinterest-browser-button</a>. The <strong class="screenText">Pinterest Save</strong> extension allows users to save images or websites to their Pinterest account with just one click on the browser.</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_06_07.png"/></figure>
<p class="packt_figref">Figure 6.7: The Pinterest Save extension</p>
<p class="normal">Let’s create a bookmarklet in a similar way for your website. For that, we will be using JavaScript.</p>
<p class="normal">This is how your users will <a id="_idIndexMarker530"/>add the bookmarklet to their browser and use it:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">The user drags a link from<a id="_idIndexMarker531"/> your site to their browser’s bookmarks bar. The link contains JavaScript code in its <code class="inlineCode">href</code> attribute. This code will be stored in the bookmark.</li>
<li class="numberedList">The user navigates to any website and clicks on the bookmark in the bookmarks or favorites bar. The JavaScript code of the bookmark is executed.</li>
</ol>
<p class="normal">Since the JavaScript code will be stored as a bookmark, we will not be able to update it after the user has added it to their bookmarks bar. This is an important drawback that you can solve by implementing a launcher script. Users will save the launcher script as a bookmark, and the launcher script will load the actual JavaScript bookmarklet from a URL. By doing this, you will be able to update the code of the bookmarklet at any time. This is the approach that we will take to build the bookmarklet. Let’s start!</p>
<p class="normal">Create a new template under <code class="inlineCode">images/templates/</code> and name it <code class="inlineCode">bookmarklet_launcher.js</code>. This will be the launcher script. Add the following JavaScript code to the new file:</p>
<pre class="programlisting code"><code class="hljs-code">(function(){
  if(!window.bookmarklet) {
    bookmarklet_js = document.body.appendChild(document.createElement('script'));
    bookmarklet_js.src = '//127.0.0.1:8000/static/js/bookmarklet.js?r='+Math.floor(Math.random()*9999999999999999);
    window.bookmarklet = true;
  }
  else {
    bookmarkletLaunch();
  }
})();
</code></pre>
<p class="normal">The preceding script checks whether the bookmarklet has already been loaded by checking the value of the <code class="inlineCode">bookmarklet</code> window variable with <code class="inlineCode">if(!window.bookmarklet)</code>:</p>
<ul>
<li class="bulletList">If <code class="inlineCode">window.bookmarklet</code> is not<a id="_idIndexMarker532"/> defined or doesn’t have a truthy value (considered <code class="inlineCode">true</code> in a Boolean context), a JavaScript file is loaded by appending a <code class="inlineCode">&lt;script&gt;</code> element <a id="_idIndexMarker533"/>to the body of the HTML document loaded in the browser. The <code class="inlineCode">src</code> attribute is used to load the URL of the <code class="inlineCode">bookmarklet.js</code> script with a random 16-digit integer parameter generated with <code class="inlineCode">Math.random()*9999999999999999</code>. Using a random number, we prevent the browser from loading the file from the browser’s cache. If the bookmarklet JavaScript has been previously loaded, the different parameter value will force the browser to load the script from the source URL again. This way, we make sure the bookmarklet always runs the most up-to-date JavaScript code.</li>
<li class="bulletList">If <code class="inlineCode">window.bookmarklet</code> is defined and has a truthy value, the <code class="inlineCode">bookmarkletLaunch()</code> function is executed. We will define <code class="inlineCode">bookmarkletLaunch()</code> as a global function in the <code class="inlineCode">bookmarklet.js</code> script.</li>
</ul>
<p class="normal">By checking the <code class="inlineCode">bookmarklet</code> window variable, we prevent the bookmarklet JavaScript code from being loaded more than once if users click on the bookmarklet repeatedly.</p>
<p class="normal">You created the bookmarklet launcher code. The actual bookmarklet code will reside in the <code class="inlineCode">bookmarklet.js</code> static file. Using launcher code allows you to update the bookmarklet code at any time without requiring users to change the bookmark they previously added to their browser.</p>
<p class="normal">Let’s add the bookmarklet launcher<a id="_idIndexMarker534"/> to the dashboard pages so that users can add it to the bookmarks bar of their browser.</p>
<p class="normal">Edit the <code class="inlineCode">account/dashboard.html</code> template of the <code class="inlineCode">account</code> application and make it look like the following. New lines<a id="_idIndexMarker535"/> are highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
  &lt;h1&gt;Dashboard&lt;/h1&gt;
<strong class="hljs-slc">  {% with total_images_created=request.user.images_created.count %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">p</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">Welcome to your dashboard. You have bookmarked {{ total_images_created }} image{{ total_images_created|pluralize }}.</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">p</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">  {% endwith %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">p</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">Drag the following button to your bookmarks toolbar to bookmark images from other websites → </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">href</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"</strong><strong class="hljs-string-slc">javascript:{% include "</strong><strong class="hljs-attr-slc">bookmarklet_launcher.js</strong><strong class="hljs-tag-slc">" %}" </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"button"</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">Bookmark it</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc">&gt;&lt;/</strong><strong class="hljs-name-slc">p</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">p</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">You can also </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">href</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"{% url "</strong><strong class="hljs-attr-slc">edit</strong><strong class="hljs-tag-slc">" %}"&gt;</strong><strong class="hljs-slc">edit your profile</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc"> or </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">href</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"{% url "</strong><strong class="hljs-attr-slc">password_change</strong><strong class="hljs-tag-slc">" %}"&gt;</strong><strong class="hljs-slc">change your password</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">.</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">p</strong><strong class="hljs-tag-slc">&gt;</strong>
{% endblock %}
</code></pre>
<p class="normal">Make sure that no template tag is split over multiple lines; Django doesn’t support multiple-line tags.</p>
<p class="normal">The dashboard now displays the total number of images bookmarked by the user. We have added a <code class="inlineCode">{% with %}</code> template tag to create a variable with the total number of images bookmarked by the current user. We have included a link with an <code class="inlineCode">href</code> attribute that contains the bookmarklet launcher script. This JavaScript code is loaded from the <code class="inlineCode">bookmarklet_launcher.js</code> template.</p>
<p class="normal">Open <code class="inlineCode">https://127.0.0.1:8000/account/</code> in your browser. You should see the following page:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_06_08.png"/></figure>
<p class="packt_figref">Figure 6.8: The dashboard page, including the total images bookmarked and the button for the bookmarklet</p>
<p class="normal">Now create the following directories and files inside the <code class="inlineCode">images</code> application directory:</p>
<pre class="programlisting con"><code class="hljs-con">static/
  js/
    bookmarklet.js
</code></pre>
<p class="normal">You will find a <code class="inlineCode">static/css/</code> directory<a id="_idIndexMarker536"/> in the <code class="inlineCode">images</code> application directory<a id="_idIndexMarker537"/> in the code that comes along with this chapter. Copy the <code class="inlineCode">css/</code> directory into the <code class="inlineCode">static/</code> directory of your code. You can find the contents of the directory at <a href="https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter06/bookmarks/images/static">https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter06/bookmarks/images/static</a>.</p>
<p class="normal">The <code class="inlineCode">css/bookmarklet.css</code> file provides the styles for the JavaScript bookmarklet. The <code class="inlineCode">static/</code> directory should contain the following file structure now:</p>
<pre class="programlisting con"><code class="hljs-con">  css/
    bookmarklet.css
  js/
    bookmarklet.js
</code></pre>
<p class="normal">Edit the <code class="inlineCode">bookmarklet.js</code> static file and add the following JavaScript code to it:</p>
<pre class="programlisting code"><code class="hljs-code">const siteUrl = '//127.0.0.1:8000/';
const styleUrl = siteUrl + 'static/css/bookmarklet.css';
const minWidth = 250;
const minHeight = 250;
</code></pre>
<p class="normal">You have declared four different constants that will be used by the bookmarklet. These constants are:</p>
<ul>
<li class="bulletList"><code class="inlineCode">siteUrl</code> and <code class="inlineCode">staticUrl</code>: The base URL for the website and the base URL for static files.</li>
<li class="bulletList"><code class="inlineCode">minWidth</code> and <code class="inlineCode">minHeight</code>: The minimum width and height in pixels for the images that the bookmarklet will collect from the site. The bookmarklet will identify images that have at least <code class="inlineCode">250px</code> width and <code class="inlineCode">250px</code> height.</li>
</ul>
<p class="normal">Edit the <code class="inlineCode">bookmarklet.js</code> static file <a id="_idIndexMarker538"/>and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">const siteUrl = '//127.0.0.1:8000/';
const styleUrl = siteUrl + 'static/css/bookmarklet.css';
const minWidth = 250;
const minHeight = 250;
<strong class="hljs-slc">// load CSS</strong>
<strong class="hljs-slc">var head = document.getElementsByTagName(</strong><strong class="hljs-string-slc">'</strong><strong class="hljs-string-slc">head'</strong><strong class="hljs-slc">)[</strong><strong class="hljs-number-slc">0</strong><strong class="hljs-slc">];</strong>
<strong class="hljs-slc">var link = document.createElement(</strong><strong class="hljs-string-slc">'link'</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">link.rel = </strong><strong class="hljs-string-slc">'stylesheet'</strong><strong class="hljs-slc">;</strong>
<strong class="hljs-slc">link.</strong><strong class="hljs-built_in-slc">type</strong><strong class="hljs-slc"> = </strong><strong class="hljs-string-slc">'text/css'</strong><strong class="hljs-slc">;</strong>
<strong class="hljs-slc">link.href = styleUrl + </strong><strong class="hljs-string-slc">'?r='</strong><strong class="hljs-slc"> + Math.floor(Math.random()*</strong><strong class="hljs-number-slc">9999999999999999</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">head.appendChild(link);</strong>
</code></pre>
<p class="normal">This section loads the CSS stylesheet for the bookmarklet. We use JavaScript to manipulate the <strong class="keyWord">Document Object Model</strong> (<strong class="keyWord">DOM</strong>). The DOM represents an HTML document in memory and it is<a id="_idIndexMarker539"/> created by the browser when a web page is<a id="_idIndexMarker540"/> loaded. The DOM is constructed as a tree of objects that comprise the structure and content of the HTML document.</p>
<p class="normal">The previous code generates an object equivalent to the following JavaScript code and appends it to the <code class="inlineCode">&lt;head&gt;</code> element of the HTML page:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;link rel="stylesheet" type="text/css" href= "//127.0.0.1:8000/static/css/bookmarklet.css?r=1234567890123456"&gt;
</code></pre>
<p class="normal">Let’s review how this is done:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">The <code class="inlineCode">&lt;head&gt;</code> element of the site is retrieved with <code class="inlineCode">document.getElementsByTagName()</code>. This function retrieves all HTML elements of the page with the given tag. By using <code class="inlineCode">[0]</code>, we access the first instance found. We access the first element because all HTML documents should have a single <code class="inlineCode">&lt;head&gt;</code> element.</li>
<li class="numberedList">A <code class="inlineCode">&lt;link&gt;</code> element is created with <code class="inlineCode">document.createElement('link')</code>.</li>
<li class="numberedList">The <code class="inlineCode">rel</code> and <code class="inlineCode">type</code> attributes of the <code class="inlineCode">&lt;link&gt;</code> element are set. This is equivalent to the HTML <code class="inlineCode">&lt;link rel="stylesheet" type="text/css"&gt;</code>.</li>
<li class="numberedList">The <code class="inlineCode">href</code> attribute of the <code class="inlineCode">&lt;link&gt;</code> element is set with the URL of the <code class="inlineCode">bookmarklet.css</code> stylesheet. A 16-digit random number is used as a URL parameter to prevent the browser from loading the file from the cache.</li>
<li class="numberedList">The new <code class="inlineCode">&lt;link&gt;</code> element is added to the <code class="inlineCode">&lt;head&gt;</code> element of the HTML page using <code class="inlineCode">head.appendChild(link)</code>.</li>
</ol>
<p class="normal">Now we will create the HTML element to display a <code class="inlineCode">&lt;div&gt;</code> container on the website where the bookmarklet is<a id="_idIndexMarker541"/> executed. The<a id="_idIndexMarker542"/> HTML container will be used to display all images found on the site and let users choose the image they want to share. It will use the CSS styles defined in the <code class="inlineCode">bookmarklet.css</code> stylesheet.</p>
<p class="normal">Edit the <code class="inlineCode">bookmarklet.js</code> static file and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">const siteUrl = '//127.0.0.1:8000/';
const styleUrl = siteUrl + 'static/css/bookmarklet.css';
const minWidth = 250;
const minHeight = 250;
// load CSS
var head = document.getElementsByTagName('head')[0];
var link = document.createElement('link');
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = styleUrl + '?r=' + Math.floor(Math.random()*9999999999999999);
head.appendChild(link);
<strong class="hljs-slc">// load HTML</strong>
<strong class="hljs-slc">var body = document.getElementsByTagName(</strong><strong class="hljs-string-slc">'body'</strong><strong class="hljs-slc">)[</strong><strong class="hljs-number-slc">0</strong><strong class="hljs-slc">];</strong>
<strong class="hljs-slc">boxHtml = `</strong>
<strong class="hljs-slc">  &lt;div </strong><strong class="hljs-built_in-slc">id</strong><strong class="hljs-slc">=</strong><strong class="hljs-string-slc">"bookmarklet"</strong><strong class="hljs-slc">&gt;</strong>
<strong class="hljs-slc">    &lt;a href=</strong><strong class="hljs-string-slc">"#"</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">id</strong><strong class="hljs-slc">=</strong><strong class="hljs-string-slc">"close"</strong><strong class="hljs-slc">&gt;&amp;times;&lt;/a&gt;</strong>
<strong class="hljs-slc">    &lt;h1&gt;Select an image to bookmark:&lt;/h1&gt;</strong>
<strong class="hljs-slc">    &lt;div </strong><strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc">=</strong><strong class="hljs-string-slc">"images"</strong><strong class="hljs-slc">&gt;&lt;/div&gt;</strong>
<strong class="hljs-slc">   &lt;/div&gt;`;</strong>
<strong class="hljs-slc">body.innerHTML += boxHtml;</strong>
</code></pre>
<p class="normal">With this code, the <code class="inlineCode">&lt;body&gt;</code> element of the DOM is retrieved and new HTML is added to it by modifying its property <code class="inlineCode">innerHTML</code>. A new <code class="inlineCode">&lt;div&gt;</code> element is added to the body of the page. The <code class="inlineCode">&lt;div&gt;</code> container consists of the following elements:</p>
<ul>
<li class="bulletList">A link to close the container defined with <code class="inlineCode">&lt;a href="#" id="close"&gt;&amp;times;&lt;/a&gt;</code>.</li>
<li class="bulletList">A title defined with <code class="inlineCode">&lt;h1&gt;Select an image to bookmark:&lt;/h1&gt;</code>.</li>
<li class="bulletList">A <code class="inlineCode">&lt;div&gt;</code> element to list the images found on the site defined with <code class="inlineCode">&lt;div class="images"&gt;&lt;/div&gt;</code>. This container is initially empty and will be filled with the images found on the site.</li>
</ul>
<p class="normal">The HTML container, including the<a id="_idIndexMarker543"/> previously loaded CSS <a id="_idIndexMarker544"/>styles, will look like <em class="italic">Figure 6.9</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_06_09.png"/></figure>
<p class="packt_figref">Figure 6.9: The image selection container</p>
<p class="normal">Now let’s implement a function to launch the bookmarklet. Edit the <code class="inlineCode">bookmarklet.js</code> static file and add the following code at the bottom:</p>
<pre class="programlisting code"><code class="hljs-code">function bookmarkletLaunch() {
  bookmarklet = document.getElementById('bookmarklet');
  var imagesFound = bookmarklet.querySelector('.images');
  // clear images found
  imagesFound.innerHTML = '';
  // display bookmarklet
  bookmarklet.style.display = 'block';
  // close event
  bookmarklet.querySelector('#close')
             .addEventListener('click', function(){
               bookmarklet.style.display = 'none'
             });
}
// launch the bookmkarklet
bookmarkletLaunch();
</code></pre>
<p class="normal">This is the <code class="inlineCode">bookmarkletLaunch()</code> function. Before the definition of this function, the CSS for the bookmarklet is loaded and the <a id="_idIndexMarker545"/>HTML container is added to the DOM of the page. The <code class="inlineCode">bookmarkletLaunch()</code> function<a id="_idIndexMarker546"/> works as follows:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">The bookmarklet’s main container is retrieved by getting the DOM element with the ID <code class="inlineCode">bookmarklet</code> with <code class="inlineCode">document.getElementById()</code>.</li>
<li class="numberedList">The <code class="inlineCode">bookmarklet</code> element is used to retrieve the child element with the class <code class="inlineCode">images</code>. The <code class="inlineCode">querySelector()</code> method allows you to retrieve DOM elements using CSS selectors. Selectors allow you to find DOM elements to which a set of CSS rules applies. You can find a list of CSS selectors at <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Selectors">https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Selectors</a> and you can read more information about how to locate DOM elements using selectors at <a href="https://developer.mozilla.org/en-US/docs/Web/API/Document_object_model/Locating_DOM_elements_using_selectors">https://developer.mozilla.org/en-US/docs/Web/API/Document_object_model/Locating_DOM_elements_using_selectors</a>.</li>
<li class="numberedList">The <code class="inlineCode">images</code> container is cleared by setting its <code class="inlineCode">innerHTML</code> attribute to an empty string and the bookmarklet is displayed by setting the <code class="inlineCode">display</code> CSS property to <code class="inlineCode">block</code>.</li>
<li class="numberedList">The <code class="inlineCode">#close</code> selector is used to find the DOM element with the ID <code class="inlineCode">close</code>. A <code class="inlineCode">click</code> event is attached to the element with the <code class="inlineCode">addEventListener()</code> method. When users click the element, the bookmarklet’s main container is hidden by setting its <code class="inlineCode">display</code> property to <code class="inlineCode">none</code>.</li>
<li class="numberedList">The <code class="inlineCode">bookmarkletLaunch()</code> function is executed after its definition.</li>
</ol>
<p class="normal">After loading the CSS styles and the HTML container of the bookmarklet, you have to find image elements in the DOM of the current website. Images that have the minimum required dimension have to be added to the HTML container of the bookmarklet. Edit the <code class="inlineCode">bookmarklet.js</code> static<a id="_idIndexMarker547"/> file and add the following code highlighted in bold to the bottom of the <code class="inlineCode">bookmarklet()</code> function:</p>
<pre class="programlisting code"><code class="hljs-code">function bookmarkletLaunch() {
  bookmarklet = document.getElementById('bookmarklet');
  var imagesFound = bookmarklet.querySelector('.images');
  // clear images found
  imagesFound.innerHTML = '';
  // display bookmarklet
  bookmarklet.style.display = 'block';
  // close event
  bookmarklet.querySelector('#close')
             .addEventListener('click', function(){
               bookmarklet.style.display = 'none'
             });
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc">// find images in the DOM with the minimum dimensions</strong>
<strong class="hljs-slc">  images = </strong><strong class="hljs-variable-slc">document</strong><strong class="hljs-slc">.</strong><strong class="hljs-title-slc">querySelectorAll</strong><strong class="hljs-slc">(</strong><strong class="hljs-string-slc">'img[src$=".jpg"], img[src$=".jpeg"], img[src$=".png"]'</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">  images.</strong><strong class="hljs-title-slc">forEach</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">image</strong><strong class="hljs-function-slc"> =&gt;</strong><strong class="hljs-slc"> {</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc">(image.</strong><strong class="hljs-property-slc">naturalWidth</strong><strong class="hljs-slc"> &gt;= minWidth</strong>
<strong class="hljs-slc">       &amp;&amp; image.</strong><strong class="hljs-property-slc">naturalHeight</strong><strong class="hljs-slc"> &gt;= minHeight)</strong>
<strong class="hljs-slc">    {</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">var</strong><strong class="hljs-slc"> imageFound = </strong><strong class="hljs-variable-slc">document</strong><strong class="hljs-slc">.</strong><strong class="hljs-title-slc">createElement</strong><strong class="hljs-slc">(</strong><strong class="hljs-string-slc">'img'</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">      imageFound.</strong><strong class="hljs-property-slc">src</strong><strong class="hljs-slc"> = image.</strong><strong class="hljs-property-slc">src</strong><strong class="hljs-slc">;</strong>
<strong class="hljs-slc">      imagesFound.</strong><strong class="hljs-title-slc">append</strong><strong class="hljs-slc">(imageFound);</strong>
<strong class="hljs-slc">    }</strong>
<strong class="hljs-slc">  })</strong>
<strong class="hljs-slc">}</strong>
<strong class="hljs-comment-slc">// launch the bookmkarklet</strong>
<strong class="hljs-title-slc">bookmarkletLaunch</strong><strong class="hljs-slc">();</strong>
</code></pre>
<p class="normal">The preceding code uses the <code class="inlineCode">img[src$=".jpg"]</code>, <code class="inlineCode">img[src$=".jpeg"]</code>, and <code class="inlineCode">img[src$=".png"]</code> selectors to find all <code class="inlineCode">&lt;img&gt;</code> DOM elements whose <code class="inlineCode">src</code> attribute finishes with <code class="inlineCode">.jpg</code>, <code class="inlineCode">.jpeg</code>, or, <code class="inlineCode">.png</code>, respectively. Using these selectors with <code class="inlineCode">document.querySelectorAll()</code> allows you to find all images in JPEG and PNG format displayed on the website. Iteration over <a id="_idIndexMarker548"/>the results is performed with the <code class="inlineCode">forEach()</code> method. Small images are filtered out because we don’t consider them to be relevant. Only images with a size larger than the one specified with the <code class="inlineCode">minWidth</code> and <code class="inlineCode">minHeight</code> variables are used for the results. A new <code class="inlineCode">&lt;img&gt;</code> element is created for each image found, where the <code class="inlineCode">src</code> source URL attribute is copied from the original image and added to the <code class="inlineCode">imagesFound</code> container.</p>
<p class="normal">For security reasons, your browser will prevent you from running the bookmarklet over HTTP on a site served through HTTPS. That’s the reason we keep using <code class="inlineCode">RunServerPlus</code> to run the development <a id="_idIndexMarker549"/>server using an auto-generated TLS/SSL certificate. Remember that you learned how to run the development server through HTTPS in <em class="italic">Chapter 5, Implementing Social Authentication</em>.</p>
<p class="normal">In a production environment, a valid TLS/SSL certificate will be required. When you own a domain name, you can apply for a trusted <strong class="keyWord">Certification Authority</strong> (<strong class="keyWord">CA</strong>) to issue a TLS/SSL certificate for it so that browsers can verify its identity. If you want to obtain a trusted certificate for a real domain, you can use the <em class="italic">Let’s Encrypt</em> service. <em class="italic">Let’s Encrypt</em> is a non-profit CA that simplifies obtaining and renewing trusted TLS/SSL certificates for free. You can find more<a id="_idIndexMarker550"/> information at <a href="https://letsencrypt.org">https://letsencrypt.org</a>.</p>
<p class="normal">Run the development server with the following command from the shell prompt:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver_plus --cert-file cert.crt
</code></pre>
<p class="normal">Open <code class="inlineCode">https://127.0.0.1:8000/account/</code> in your browser. Log in with an existing user, then click and drag the <strong class="screenText">BOOKMARK IT</strong> button to the bookmarks bar of your browser, as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_06_10.png"/></figure>
<p class="packt_figref">Figure 6.10: Adding the BOOKMARK IT button to the bookmarks bar</p>
<p class="normal">Open a website of your choice in your browser and click on the <strong class="screenText">Bookmark it</strong> bookmarklet in the bookmarks bar. You will see that a new white overlay appears on the website, displaying all JPEG and PNG images found with dimensions higher than 250×250 pixels. </p>
<p class="normal"><em class="italic">Figure 6.11</em> shows the bookmarklet running on <a href="https://amazon.com/">https://amazon.com/</a>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_06_11.png"/></figure>
<p class="packt_figref">Figure 6.11: The bookmarklet loaded on amazon.com</p>
<p class="normal">If the HTML container doesn’t<a id="_idIndexMarker551"/> appear, check the <code class="inlineCode">RunServer</code> shell console log. If you see a MIME type error, it is most likely that your <a id="_idIndexMarker552"/>MIME map files are incorrect or need to be updated. You can apply the correct mapping for JavaScript and CSS files by adding the following lines to the <code class="inlineCode">settings.py</code> file:</p>
<pre class="programlisting code"><code class="hljs-code">if DEBUG:
    import mimetypes
    mimetypes.add_type('application/javascript', '.js', True)
    mimetypes.add_type('text/css', '.css', True)
</code></pre>
<p class="normal">The HTML container includes the images that can be bookmarked. We will now implement the functionality<a id="_idIndexMarker553"/> for users to click on the desired image to bookmark it.</p>
<p class="normal">Edit the <code class="inlineCode">js/bookmarklet.js</code> static file and add the following code at the bottom of the <code class="inlineCode">bookmarklet()</code> function:</p>
<pre class="programlisting code"><code class="hljs-code">function bookmarkletLaunch() {
  bookmarklet = document.getElementById('bookmarklet');
  var imagesFound = bookmarklet.querySelector('.images');
  // clear images found
  imagesFound.innerHTML = '';
  // display bookmarklet
  bookmarklet.style.display = 'block';
  // close event
  bookmarklet.querySelector('#close')
             .addEventListener('click', function(){
               bookmarklet.style.display = 'none'
             });
  // find images in the DOM with the minimum dimensions
  images = document.querySelectorAll('img[src$=".jpg"], img[src$=".jpeg"], img[src$=".png"]');
  images.forEach(image =&gt; {
    if(image.naturalWidth &gt;= minWidth
       &amp;&amp; image.naturalHeight &gt;= minHeight)
    {
      var imageFound = document.createElement('img');
      imageFound.src = image.src;
      imagesFound.append(imageFound);
    }
  })
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc">// select image event</strong>
<strong class="hljs-slc">  imagesFound.</strong><strong class="hljs-title-slc">querySelectorAll</strong><strong class="hljs-slc">(</strong><strong class="hljs-string-slc">'img'</strong><strong class="hljs-slc">).</strong><strong class="hljs-title-slc">forEach</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">image</strong><strong class="hljs-function-slc"> =&gt;</strong><strong class="hljs-slc"> {</strong>
<strong class="hljs-slc">    image.</strong><strong class="hljs-title-slc">addEventListener</strong><strong class="hljs-slc">(</strong><strong class="hljs-string-slc">'click'</strong><strong class="hljs-slc">, </strong><strong class="hljs-keyword-slc">function</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">event</strong><strong class="hljs-slc">){</strong>
<strong class="hljs-slc">      imageSelected = event.</strong><strong class="hljs-property-slc">target</strong><strong class="hljs-slc">;</strong>
<strong class="hljs-slc">      bookmarklet.</strong><strong class="hljs-property-slc">style</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">display</strong><strong class="hljs-slc"> = </strong><strong class="hljs-string-slc">'none'</strong><strong class="hljs-slc">;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-variable-slc">window</strong><strong class="hljs-slc">.</strong><strong class="hljs-title-slc">open</strong><strong class="hljs-slc">(siteUrl + </strong><strong class="hljs-string-slc">'images/create/?url='</strong>
<strong class="hljs-slc">                  + </strong><strong class="hljs-built_in-slc">encodeURIComponent</strong><strong class="hljs-slc">(imageSelected.</strong><strong class="hljs-property-slc">src</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">                  + </strong><strong class="hljs-string-slc">'&amp;title='</strong>
<strong class="hljs-slc">                  + </strong><strong class="hljs-built_in-slc">encodeURIComponent</strong><strong class="hljs-slc">(</strong><strong class="hljs-variable-slc">document</strong><strong class="hljs-slc">.</strong><strong class="hljs-property-slc">title</strong><strong class="hljs-slc">),</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'_blank'</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">    })</strong>
<strong class="hljs-slc">  })</strong>
}
// launch the bookmkarklet
bookmarkletLaunch();
</code></pre>
<p class="normal">The preceding code<a id="_idIndexMarker554"/> works as follows:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">A <code class="inlineCode">click()</code> event is attached to each image element within the <code class="inlineCode">imagesFound</code> container.</li>
<li class="numberedList">When the user clicks on any of the images, the image element clicked is stored in the variable <code class="inlineCode">imageSelected</code>.</li>
<li class="numberedList">The bookmarklet is then hidden by setting its <code class="inlineCode">display</code> property to <code class="inlineCode">none</code>.</li>
<li class="numberedList">A new browser window is <a id="_idIndexMarker555"/>opened with the URL to bookmark a new image on the site. The content of the <code class="inlineCode">&lt;title&gt;</code> element of the website is passed to the URL in the <code class="inlineCode">title</code> <code class="inlineCode">GET</code> parameter and the selected image URL is passed in the <code class="inlineCode">url</code> parameter.</li>
</ol>
<p class="normal">Open a new URL with your <a id="_idIndexMarker556"/>browser, for example, <a href="https://commons.wikimedia.org/">https://commons.wikimedia.org/</a>, as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_06_12.png"/></figure>
<p class="packt_figref">Figure 6.12: The Wikimedia Commons website</p>
<div><p class="normal"><em class="italic">Figures 6.12</em> to <em class="italic">6.15</em> image: <em class="italic">A flock of cranes (Grus grus) in Hula Valley, Northern Israel</em> by Tomere (Licence: Creative Commons Attribution-Share Alike 4.0 International: https://creativecommons.org/licenses/by-sa/4.0/deed.en)</p>
</div>
<p class="normal">Click on the <strong class="screenText">Bookmark it</strong> bookmarklet to display the image selection overlay. You will see the image selection overlay like this:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_06_13.png"/></figure>
<p class="packt_figref">Figure 6.13: The bookmarklet loaded on an external website</p>
<p class="normal">If you click on an image, you will <a id="_idIndexMarker557"/>be redirected to<a id="_idIndexMarker558"/> the image creation page, passing the title of the website and the URL of the selected image as <code class="inlineCode">GET</code> parameters. The page will look as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_06_14.png"/></figure>
<p class="packt_figref">Figure 6.14: The form to bookmark an image</p>
<p class="normal">Congratulations! This is your<a id="_idIndexMarker559"/> first JavaScript <a id="_idIndexMarker560"/>bookmarklet, and it is fully integrated into your Django project. Next, we will create the detail view for images and implement the canonical URL for images.</p>
<h1 class="heading-1" id="_idParaDest-184">Creating a detail view for images</h1>
<p class="normal">Let’s now create a simple detail view to<a id="_idIndexMarker561"/> display images that have been bookmarked on the site. Open the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">images</code> application and <a id="_idIndexMarker562"/>add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.shortcuts import get_object_or_404
from .models import Image
def image_detail(request, id, slug):
    image = get_object_or_404(Image, id=id, slug=slug)
    return render(
 request,
 'images/image/detail.html',
 {'section': 'images', 'image': image}
    )
</code></pre>
<p class="normal">This is a simple view to display an image. Edit the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">images</code> application and add the following URL <a id="_idIndexMarker563"/>pattern highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    path('create/', views.image_create, name='create'),
<strong class="hljs-slc">    path(</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'detail/&lt;int:id&gt;/&lt;slug:slug&gt;/'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        views.image_detail,</strong>
<strong class="hljs-slc">        name=</strong><strong class="hljs-string-slc">'detail'</strong>
<strong class="hljs-string-slc"> </strong><strong class="hljs-slc">),</strong>
]
</code></pre>
<p class="normal">Edit the <code class="inlineCode">models.py</code> file of the <code class="inlineCode">images</code> application and add the <code class="inlineCode">get_absolute_url()</code> method to<a id="_idIndexMarker564"/> the <code class="inlineCode">Image</code> model, as follows:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.urls </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> reverse</strong>
class Image(models.Model):
    # ...
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">get_absolute_url</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> reverse(</strong><strong class="hljs-string-slc">'images:detail'</strong><strong class="hljs-slc">, args=[self.</strong><strong class="hljs-built_in-slc">id</strong><strong class="hljs-slc">, self.slug])</strong>
</code></pre>
<p class="normal">Remember that the common pattern for providing canonical URLs for objects is to define a <code class="inlineCode">get_absolute_url()</code> method in the model.</p>
<p class="normal">Finally, create a template inside the <code class="inlineCode">/templates/images/image/</code> template directory for the <code class="inlineCode">images</code> application and name it <code class="inlineCode">detail.html</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}{{ image.title }}{% endblock %}
{% block content %}
  &lt;h1&gt;{{ image.title }}&lt;/h1&gt;
&lt;img src="img/{{ image.image.url }}" class="image-detail"&gt;
  {% with total_likes=image.users_like.count %}
    &lt;div class="image-info"&gt;
&lt;div&gt;
&lt;span class="count"&gt;
          {{ total_likes }} like{{ total_likes|pluralize }}
        &lt;/span&gt;
&lt;/div&gt;
      {{ image.description|linebreaks }}
    &lt;/div&gt;
&lt;div class="image-likes"&gt;
      {% for user in image.users_like.all %}
        &lt;div&gt;
          {% if user.profile.photo %}
            &lt;img src="img/{{ user.profile.photo.url }}"&gt;
          {% endif %}
          &lt;p&gt;{{ user.first_name }}&lt;/p&gt;
&lt;/div&gt;
      {% empty %}
        Nobody likes this image yet.
      {% endfor %}
    &lt;/div&gt;
  {% endwith %}
{% endblock %}
</code></pre>
<p class="normal">This is the template for displaying the<a id="_idIndexMarker565"/> detail view of a bookmarked image. We have used the <code class="inlineCode">{% with %}</code> tag to create the <code class="inlineCode">total_likes</code> variable with the result of a QuerySet that counts all user likes. By doing so, we avoid evaluating the same QuerySet twice (first to display the total number of likes, then to use the <code class="inlineCode">pluralize</code> template filter). We have also included the image<a id="_idIndexMarker566"/> description and we have added a <code class="inlineCode">{% for %}</code> loop to iterate over <code class="inlineCode">image.users_like.all</code> to display all the users who like this image.</p>
<p class="normal">Whenever you need to repeat a query in your template, use the <code class="inlineCode">{% with %}</code> template tag to prevent additional database queries.</p>
<p class="normal">Now, open an external URL in your browser and use the bookmarklet to bookmark a new image. You will be redirected to the image detail page after you post the image. The page will include a success message, as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_06_15.png"/></figure>
<p class="packt_figref">Figure 6.15: The image detail page for the image bookmark</p>
<p class="normal">Great! You completed the<a id="_idIndexMarker567"/> bookmarklet functionality. Next, you<a id="_idIndexMarker568"/> will learn how to create thumbnails for images.</p>
<h1 class="heading-1" id="_idParaDest-185">Creating image thumbnails using easy-thumbnails</h1>
<p class="normal">We are displaying the original image on the detail page, but the dimensions of different images may vary considerably. The file size <a id="_idIndexMarker569"/>of some images may be <a id="_idIndexMarker570"/>very large, and loading them might take too long. The best way to display optimized images in a uniform manner is to generate thumbnails. A thumbnail is a small image<a id="_idIndexMarker571"/> representation of a larger image. Thumbnails will load faster in the browser and are a great way to homogenize images of very different sizes. We will use a Django application called <code class="inlineCode">easy-thumbnails</code> to generate thumbnails for the images bookmarked by users.</p>
<p class="normal">Open the terminal and install <code class="inlineCode">easy-thumbnails</code> using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install easy-thumbnails==2.8.5
</code></pre>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of the <code class="inlineCode">bookmarks</code> project and add <code class="inlineCode">easy_thumbnails</code> to the <code class="inlineCode">INSTALLED_APPS</code> setting, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">INSTALLED_APPS = [
    # ...
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'</strong><strong class="hljs-string-slc">easy_thumbnails'</strong><strong class="hljs-slc">,</strong>
]
</code></pre>
<p class="normal">Then, run the following <a id="_idIndexMarker572"/>command to sync the application<a id="_idIndexMarker573"/> with your database:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py migrate
</code></pre>
<p class="normal">You will see an output that includes the following lines:</p>
<pre class="programlisting con"><code class="hljs-con">Applying easy_thumbnails.0001_initial... OK
Applying easy_thumbnails.0002_thumbnaildimensions... OK
</code></pre>
<p class="normal">The <code class="inlineCode">easy-thumbnails</code> application offers you <a id="_idIndexMarker574"/>different ways to define image thumbnails. The application provides a <code class="inlineCode">{% thumbnail %}</code> template tag to generate thumbnails in templates and a custom <code class="inlineCode">ImageField</code> if you want to define thumbnails in your models. Let’s use the template tag approach.</p>
<p class="normal">Edit the <code class="inlineCode">images/image/detail.html</code> template and consider the following line:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;img src="img/{{ image.image.url }}" class="image-detail"&gt;
</code></pre>
<p class="normal">The following lines should replace the preceding one:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-template-tag-slc">{% </strong><strong class="hljs-name-slc">load</strong><strong class="hljs-template-tag-slc"> thumbnail %}</strong>
<strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">href</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"</strong><strong class="hljs-template-variable-slc">{{ image.image.url }}</strong><strong class="hljs-string-slc">"</strong><strong class="hljs-tag-slc">&gt;</strong>
&lt;img src="img/<strong class="hljs-template-tag-slc">{% </strong><strong class="hljs-name-slc">thumbnail</strong><strong class="hljs-template-tag-slc"> image.image 300x0 %}</strong>" class="image-detail"&gt;
<strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc">&gt;</strong>
</code></pre>
<p class="normal">We have defined a thumbnail with a fixed width of <code class="inlineCode">300</code> pixels and a flexible height to maintain the aspect ratio by using the value <code class="inlineCode">0</code>. The first time a user loads this page, a thumbnail image will be created. The thumbnail is stored in the same directory as the original file. The location is defined by the <code class="inlineCode">MEDIA_ROOT</code> setting and the <code class="inlineCode">upload_to</code> attribute of the <code class="inlineCode">image</code> field of the <code class="inlineCode">Image</code> model. The generated thumbnail will then be served in the following requests.</p>
<p class="normal">Run the development server with the following command from the shell prompt:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver_plus --cert-file cert.crt
</code></pre>
<p class="normal">Access the image detail page <a id="_idIndexMarker575"/>for an existing image. The thumbnail will <a id="_idIndexMarker576"/>be generated <a id="_idIndexMarker577"/>and displayed on the site. Right-click on the image and open it in a new browser tab, as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_06_16.png"/></figure>
<p class="packt_figref">Figure 6.16: Opening the image in a new browser tab</p>
<p class="normal">Check the URL of the<a id="_idIndexMarker578"/> generated image in your browser. It should look as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_06_17.png"/></figure>
<p class="packt_figref">Figure 6.17: The URL of the generated image</p>
<p class="normal">The original filename <a id="_idIndexMarker579"/> is followed by additional details of the settings used to create the thumbnail. For a JPEG image, you will see a filename like <code class="inlineCode">filename.jpg.300x0_q85.jpg</code>, where <code class="inlineCode">300x0</code> indicates the size parameters used to generate the thumbnail, and <code class="inlineCode">85</code> is the value for the default JPEG quality used by the library to generate the thumbnail.</p>
<p class="normal">You can use a different quality value using the <code class="inlineCode">quality</code> parameter. To set the highest JPEG quality, you can use the value <code class="inlineCode">100</code>, like this: <code class="inlineCode">{% thumbnail image.image 300x0 quality=100 %}</code>. A higher quality will imply a larger file size.</p>
<p class="normal">The <code class="inlineCode">easy-thumbnails</code> application <a id="_idIndexMarker580"/>offers several options to customize your thumbnails, including cropping algorithms and different effects that can be applied. If you run into any issues generating thumbnails, you can<a id="_idIndexMarker581"/> add <code class="inlineCode">THUMBNAIL_DEBUG = True</code> to the <code class="inlineCode">settings.py</code> file to obtain the debug information. You can read the full documentation of <code class="inlineCode">easy-thumbnails</code> at <a href="https://easy-thumbnails.readthedocs.io/">https://easy-thumbnails.readthedocs.io/</a>.</p>
<h1 class="heading-1" id="_idParaDest-186">Adding asynchronous actions with JavaScript</h1>
<p class="normal">We are going to add a <strong class="screenText">like</strong> button to the image detail page to let users click on it to like an image. When users click the <em class="italic">like</em> button, we will send an HTTP request to the web server using JavaScript. This<a id="_idIndexMarker582"/> will perform the <em class="italic">like</em> action without reloading the whole page. For this functionality, we will implement a view that allows <a id="_idIndexMarker583"/>users to like/unlike images.</p>
<p class="normal">The JavaScript <strong class="keyWord">Fetch API</strong> is the built-in way to make asynchronous HTTP requests to web servers from web browsers. By using the Fetch API, you can send and retrieve data from the web server without the need for a whole page refresh. The Fetch API was launched as a modern successor to the <code class="inlineCode">XMLHttpRequest</code> (XHR) object that is built into the browser, used to make HTTP requests without reloading the page. The set of web development techniques to send and retrieve data from a web server asynchronously without reloading the page is also known as <strong class="keyWord">AJAX</strong>, which stands for <strong class="keyWord">Asynchronous JavaScript and XML</strong>. AJAX is a misleading<a id="_idIndexMarker584"/> name because AJAX requests can exchange data not only in XML format but also in formats such as JSON, HTML, and plain text. You might find references to the Fetch <a id="_idIndexMarker585"/>API and AJAX indistinctively on the internet.</p>
<p class="normal">You can find information about the Fetch API at <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch">https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch</a>.</p>
<p class="normal">We will start by implementing the view to perform the <em class="italic">like</em> and <em class="italic">unlike</em> actions, and then we will add the JavaScript code<a id="_idIndexMarker586"/> to the related template to perform asynchronous HTTP requests.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">images</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.http import JsonResponse
from django.views.decorators.http import require_POST
@login_required
@require_POST
def image_like(request):
    image_id = request.POST.get('id')
    action = request.POST.get('action')
    if image_id and action:
        try:
            image = Image.objects.get(id=image_id)
            if action == 'like':
                image.users_like.add(request.user)
            else:
                image.users_like.remove(request.user)
            return JsonResponse({'status': 'ok'})
        except Image.DoesNotExist:
            pass
return JsonResponse({'status': 'error'})
</code></pre>
<p class="normal">We have used two decorators for the new view. The <code class="inlineCode">login_required</code> decorator prevents users who are not logged in from accessing this view. The <code class="inlineCode">require_POST</code> decorator returns an <code class="inlineCode">HttpResponseNotAllowed</code> object (status code <code class="inlineCode">405</code>) if the HTTP request is not done via <code class="inlineCode">POST</code>. This way, you only allow <code class="inlineCode">POST</code> requests for this view.</p>
<p class="normal">Django also provides a <code class="inlineCode">require_GET</code> decorator to only allow <code class="inlineCode">GET</code> requests and a <code class="inlineCode">require_http_methods</code> decorator to which you can pass a list of allowed methods as an argument.</p>
<p class="normal">This view expects the following <code class="inlineCode">POST</code> parameters:</p>
<ul>
<li class="bulletList"><code class="inlineCode">image_id</code>: The ID of the <code class="inlineCode">Image</code> object on which the user is performing the action</li>
<li class="bulletList"><code class="inlineCode">action</code>: The action that the user wants to perform, which should be a string with the value <code class="inlineCode">like</code> or <code class="inlineCode">unlike</code></li>
</ul>
<p class="normal">We have used the manager<a id="_idIndexMarker587"/> provided by Django for the <code class="inlineCode">users_like</code> many-to-many field of the <code class="inlineCode">Image</code> model in order to add or remove objects from the relationship using the <code class="inlineCode">add()</code> or <code class="inlineCode">remove()</code> methods. If the <code class="inlineCode">add()</code> method is called passing an object that is already present in the related object set, it will not be duplicated. If the <code class="inlineCode">remove()</code> method is called with an object that is not in the related object set, nothing will happen. Another useful method of many-to-many managers is <code class="inlineCode">clear()</code>, which removes all objects from the related object set.</p>
<p class="normal">To generate the view <a id="_idIndexMarker588"/>response, we have used the <code class="inlineCode">JsonResponse</code> class provided by Django, which returns an HTTP response with an <code class="inlineCode">application/json</code> content type, converting the given object into a JSON output.</p>
<p class="normal">Edit the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">images</code> application and add the following URL pattern highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    path('create/', views.image_create, name='create'),
    path(
        'detail/&lt;int:id&gt;/&lt;slug:slug&gt;/',
        views.image_detail,
        name='detail'
 ),
<strong class="hljs-slc">    path(</strong><strong class="hljs-string-slc">'like/'</strong><strong class="hljs-slc">, views.image_like, name=</strong><strong class="hljs-string-slc">'like'</strong><strong class="hljs-slc">),</strong>
<strong class="hljs-slc">]</strong>
</code></pre>
<h2 class="heading-2" id="_idParaDest-187">Loading JavaScript on the DOM</h2>
<p class="normal">We need to add JavaScript code to the image detail template. To use JavaScript in our templates, we will add a base <a id="_idIndexMarker589"/>wrapper in the <code class="inlineCode">base.html</code> template of the <a id="_idIndexMarker590"/>project first.</p>
<p class="normal">Edit the <code class="inlineCode">base.html</code> template of the <code class="inlineCode">account</code> application and include the following code highlighted in bold before the closing <code class="inlineCode">&lt;/body&gt;</code> HTML tag:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
 ...
&lt;/head&gt;
&lt;body&gt;
  ...
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">script</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-variable-slc">document</strong><strong class="hljs-slc">.</strong><strong class="hljs-title-slc">addEventListener</strong><strong class="hljs-slc">(</strong><strong class="hljs-string-slc">'DOMContentLoaded'</strong><strong class="hljs-slc">, </strong><strong class="hljs-function-slc">(</strong><strong class="hljs-params-slc">event</strong><strong class="hljs-function-slc">) =&gt;</strong><strong class="hljs-slc"> {</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc">// DOM loaded</strong>
<strong class="hljs-slc">      {% block domready %}</strong>
<strong class="hljs-slc">      {% endblock %}</strong>
<strong class="hljs-slc">    })</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">script</strong><strong class="hljs-tag-slc">&gt;</strong>
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p class="normal">We have added a <code class="inlineCode">&lt;script&gt;</code> tag to include JavaScript code. The <code class="inlineCode">document.addEventListener()</code> method is used to define a function that will be called when the given event is triggered. We pass the event name <code class="inlineCode">DOMContentLoaded</code>, which fires when the initial HTML document <a id="_idIndexMarker591"/>has been completely loaded <a id="_idIndexMarker592"/>and the DOM hierarchy <a id="_idIndexMarker593"/>has been fully constructed. By using this event, we make sure the DOM is fully constructed before we interact with any HTML elements and we manipulate the DOM. The code within the function will only be executed once the DOM is ready.</p>
<p class="normal">Inside the document-ready handler, we have included a Django template block called <code class="inlineCode">domready</code>. Any template that extends the <code class="inlineCode">base.html</code> template can use this block to include specific JavaScript code to execute when the DOM is ready.</p>
<p class="normal">Don’t get confused by the JavaScript code and Django template tags. The Django template language is rendered on the server side to generate the HTML document, and JavaScript is executed in the browser on the client side. In some cases, it is useful to generate JavaScript code dynamically using Django in order to use the results of QuerySets or server-side calculations to define variables in JavaScript.</p>
<p class="normal">The examples in this chapter include JavaScript code in Django templates. The preferred method to add JavaScript code to your templates is by loading <code class="inlineCode">.js</code> files, which are served as static files, especially if you are using large scripts.</p>
<h2 class="heading-2" id="_idParaDest-188">Cross-site request forgery for HTTP requests in JavaScript</h2>
<p class="normal">You learned about <strong class="keyWord">cross-site request forgery</strong> (<strong class="keyWord">CSRF</strong>) in <em class="italic">Chapter 2</em>, <em class="italic">Enhancing Your Blog with Advanced Features</em>. With CSRF protection active, Django looks for a CSRF token in all <code class="inlineCode">POST</code> requests. When you submit forms, you can use the <code class="inlineCode">{% csrf_token %}</code> template tag to send the token along with <a id="_idIndexMarker594"/>the form. HTTP requests made<a id="_idIndexMarker595"/> in JavaScript have to pass the CSRF token as well in every <code class="inlineCode">POST</code> request.</p>
<p class="normal">Django allows you to set a custom <code class="inlineCode">X-CSRFToken</code> header in your HTTP requests with the value of the CSRF token.</p>
<p class="normal">To include the token in HTTP requests that originate from JavaScript, we will need to retrieve the CSRF token from the <code class="inlineCode">csrftoken</code> cookie, which is set by Django if the CSRF protection is active. To handle cookies, we will use JavaScript Cookie. JavaScript Cookie is a lightweight JavaScript API for handling cookies. You can learn more about it at <a href="https://github.com/js-cookie/js-cookie">https://github.com/js-cookie/js-cookie</a>.</p>
<p class="normal">Edit the <code class="inlineCode">base.html</code> template of the <code class="inlineCode">account</code> application and add the following code highlighted in bold at the bottom of the <code class="inlineCode">&lt;body&gt;</code> element like this:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
 ...
&lt;/head&gt;
&lt;body&gt;
  ...
<strong class="hljs-slc">  &lt;script src=</strong><strong class="hljs-string-slc">"//cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"</strong><strong class="hljs-slc">&gt;&lt;/script&gt;</strong>
  &lt;script&gt;
<strong class="hljs-slc">    const csrftoken = Cookies.get(</strong><strong class="hljs-string-slc">'csrftoken'</strong><strong class="hljs-slc">);</strong>
    document.addEventListener('DOMContentLoaded', (event) =&gt; {
      // DOM loaded
      {% block domready %}
      {% endblock %}
    })
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p class="normal">We have implemented the following functionality:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">The JavaScript Cookie plugin is loaded from <a id="_idIndexMarker596"/>a public <strong class="keyWord">Content Delivery Network </strong>(<strong class="keyWord">CDN</strong>).</li>
<li class="numberedList">The value of the <code class="inlineCode">csrftoken</code> cookie is retrieved with <code class="inlineCode">Cookies.get()</code> and stored in the JavaScript constant <code class="inlineCode">csrftoken</code>.</li>
</ol>
<p class="normal">We have to include the CSRF<a id="_idIndexMarker597"/> token in all JavaScript fetch requests that use unsafe HTTP methods, such as <code class="inlineCode">POST</code> or <code class="inlineCode">PUT</code>. We will later include<a id="_idIndexMarker598"/> the <code class="inlineCode">csrftoken</code> constant in a custom HTTP header named <code class="inlineCode">X-CSRFToken</code> when sending HTTP <code class="inlineCode">POST</code> requests.</p>
<p class="normal">You can find more information about Django’s CSRF protection and AJAX at <a href="https://docs.djangoproject.com/en/5.0/ref/csrf/#ajax">https://docs.djangoproject.com/en/5.0/ref/csrf/#ajax</a>.</p>
<p class="normal">Next, we will implement the HTML and JavaScript code for users to like/unlike images.</p>
<h2 class="heading-2" id="_idParaDest-189">Performing HTTP requests with JavaScript</h2>
<p class="normal">Edit the <code class="inlineCode">images/image/detail.html</code> template <a id="_idIndexMarker599"/>and add the following <a id="_idIndexMarker600"/>code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}{{ image.title }}{% endblock %}
{% block content %}
  &lt;h1&gt;{{ image.title }}&lt;/h1&gt;
  {% load thumbnail %}
  &lt;a href="{{ image.image.url }}"&gt;
&lt;img src="img/{% thumbnail image.image 300x0 %}" class="image-detail"&gt;
&lt;/a&gt;
  {% with total_likes=image.users_like.count <strong class="hljs-slc">users_like=image.users_like.all</strong> %}
    &lt;div class="image-info"&gt;
&lt;div&gt;
&lt;span class="count"&gt;
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">span</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"total"</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">{{ total_likes }}</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">span</strong><strong class="hljs-tag-slc">&gt;</strong>
        like{{ total_likes|pluralize }}
        &lt;/span&gt;
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">href</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"</strong><strong class="hljs-string-slc">#"</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">data-id</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"{{ image.id }}"</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">data-action</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"{% if request.user in users_like %}un{% endif %}like"</strong>
<strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"like button"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">          {% if request.user not in users_like %}</strong>
<strong class="hljs-slc">            Like</strong>
<strong class="hljs-slc">          {% else %}</strong>
<strong class="hljs-slc">            Unlike</strong>
<strong class="hljs-slc">          {% endif %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc">&gt;</strong>
&lt;/div&gt;
      {{ image.description|linebreaks }}
    &lt;/div&gt;
&lt;div class="image-likes"&gt;
      {% for user in users_like %}
        &lt;div&gt;
          {% if user.profile.photo %}
            &lt;img src="img/{{ user.profile.photo.url }}"&gt;
          {% endif %}
          &lt;p&gt;{{ user.first_name }}&lt;/p&gt;
&lt;/div&gt;
      {% empty %}
        Nobody likes this image yet.
      {% endfor %}
    &lt;/div&gt;
  {% endwith %}
{% endblock %}
</code></pre>
<p class="normal">In the preceding code, we have added another variable to the <code class="inlineCode">{% with %}</code> template tag to store the results of the <code class="inlineCode">image.users_like.all</code> query and prevent the query from being executed against the <a id="_idIndexMarker601"/>database multiple times. This variable is used to check whether the current user is in this list with <code class="inlineCode">{% if request.user in users_like %}</code> and <a id="_idIndexMarker602"/>then with <code class="inlineCode">{% if request.user not in users_like %}</code>. The same variable is then used to iterate over the users that like this image with <code class="inlineCode">{% for user in users_like %}</code>.</p>
<p class="normal">We have added to this page the total number of users who like the image and have included a link for the user to like/unlike the image. The related object set, <code class="inlineCode">users_like</code>, is used to check whether <code class="inlineCode">request.user</code> is contained in the related object set, to display the text <strong class="screenText">Like</strong> or <strong class="screenText">Unlike</strong> based on the current relationship between the user and this image. We have added the following attributes to the <code class="inlineCode">&lt;a&gt;</code> HTML link element:</p>
<ul>
<li class="bulletList"><code class="inlineCode">data-id</code>: The ID of the image displayed.</li>
<li class="bulletList"><code class="inlineCode">data-action</code>: The action to perform when the user clicks on the link. This can be either <code class="inlineCode">like</code> or <code class="inlineCode">unlike</code>.</li>
</ul>
<p class="normal">Any attribute on any HTML element with a name that starts with <code class="inlineCode">data-</code> is a data attribute. Data attributes are used to store custom data for your application.</p>
<p class="normal">We will send the value of the <code class="inlineCode">data-id</code> and <code class="inlineCode">data-action</code> attributes in the HTTP request to the <code class="inlineCode">image_like</code> view. When <a id="_idIndexMarker603"/>a user clicks on the <strong class="screenText">like/unlike</strong> link, we will need to perform the following actions in the browser:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">Send an HTTP <code class="inlineCode">POST</code> request to the <code class="inlineCode">image_like</code> view, passing the image <code class="inlineCode">id</code> and the <code class="inlineCode">action</code> parameters to it.</li>
<li class="numberedList">If the HTTP request is successful, update<a id="_idIndexMarker604"/> the <code class="inlineCode">data-action</code> attribute of the <code class="inlineCode">&lt;a&gt;</code> HTML element with the opposite action (<code class="inlineCode">like</code> / <code class="inlineCode">unlike</code>), and modify its display text accordingly.</li>
<li class="numberedList">Update the total number of likes displayed on the page.</li>
</ol>
<p class="normal">Add the following <code class="inlineCode">domready</code> block at the bottom of the <code class="inlineCode">images/image/detail.html</code> template:</p>
<pre class="programlisting code"><code class="hljs-code">{% block domready %}
  const url = '{% url "images:like" %}';
  var options = {
    method: 'POST',
    headers: {'X-CSRFToken': csrftoken},
    mode: 'same-origin'
  }
  document.querySelector('a.like')
          .addEventListener('click', function(e){
    e.preventDefault();
    var likeButton = this;
  });
{% endblock %}
</code></pre>
<p class="normal">The preceding code works as follows:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">The <code class="inlineCode">{% url %}</code> template tag is used to build the <code class="inlineCode">images:like</code> URL. The generated URL is stored in the <code class="inlineCode">url</code> JavaScript constant.</li>
<li class="numberedList">An <code class="inlineCode">options</code> object is created with the options that will be passed to the HTTP request with the Fetch API. These are:<ul>
<li class="bulletList"><code class="inlineCode">method</code>: The HTTP method to use. In this case, it’s <code class="inlineCode">POST</code>.</li>
<li class="bulletList"><code class="inlineCode">headers</code>: Additional HTTP headers to include in the request. We include the <code class="inlineCode">X-CSRFToken</code> header with the value of the <code class="inlineCode">csrftoken</code> constant that we defined in the <code class="inlineCode">base.html</code> template.</li>
<li class="bulletList"><code class="inlineCode">mode</code>: The mode of the HTTP request. We use <code class="inlineCode">same-origin</code> to indicate the request is made to the same origin. You can find more information about modes at <a href="https://developer.mozilla.org/en-US/docs/Web/API/Request/mode">https://developer.mozilla.org/en-US/docs/Web/API/Request/mode</a>.</li>
</ul>
</li>
<li class="numberedList">The <code class="inlineCode">a.like</code> selector is used to find all <code class="inlineCode">&lt;a&gt;</code> elements of the HTML document with the <code class="inlineCode">like</code> class<a id="_idIndexMarker605"/> using <code class="inlineCode">document.querySelector()</code>.</li>
<li class="numberedList">An event listener is defined for the <code class="inlineCode">click</code> event on the elements targeted with the selector. This function is executed every time the user clicks on the <strong class="screenText">like/unlike</strong> link.</li>
<li class="numberedList">Inside the handler function, <code class="inlineCode">e.preventDefault()</code> is used to avoid the default behavior of the <code class="inlineCode">&lt;a&gt;</code> element. This will prevent the default behavior of the link element, stopping the event <a id="_idIndexMarker606"/>propagation, and preventing the link from following the URL.</li>
<li class="numberedList">A <code class="inlineCode">likeButton</code> variable is used to store the reference to <code class="inlineCode">this</code>, the element on which the event was triggered.</li>
</ol>
<p class="normal">Now we need to send the HTTP request using the Fetch API. Edit the <code class="inlineCode">domready</code> block of the <code class="inlineCode">images/image/detail.html</code> template and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">{% block domready %}
  const url = '{% url "images:like" %}';
  var options = {
    method: 'POST',
    headers: {'X-CSRFToken': csrftoken},
    mode: 'same-origin'
  }
  document.querySelector('a.like')
          .addEventListener('click', function(e){
    e.preventDefault();
    var likeButton = this;
<strong class="hljs-slc">    // add request body</strong>
<strong class="hljs-slc">    var formData = new FormData();</strong>
<strong class="hljs-slc">    formData.append(</strong><strong class="hljs-string-slc">'id'</strong><strong class="hljs-slc">, likeButton.dataset.</strong><strong class="hljs-built_in-slc">id</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">    formData.append(</strong><strong class="hljs-string-slc">'action'</strong><strong class="hljs-slc">, likeButton.dataset.action);</strong>
<strong class="hljs-slc">    options[</strong><strong class="hljs-string-slc">'body'</strong><strong class="hljs-slc">] = formData;</strong>
<strong class="hljs-slc">    // send HTTP request</strong>
<strong class="hljs-slc">    fetch(url, options)</strong>
<strong class="hljs-slc">    .then(response =&gt; response.json())</strong>
<strong class="hljs-slc">    .then(data =&gt; {</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> (data[</strong><strong class="hljs-string-slc">'</strong><strong class="hljs-string-slc">status'</strong><strong class="hljs-slc">] === </strong><strong class="hljs-string-slc">'ok'</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">      {</strong>
<strong class="hljs-slc">      }</strong>
<strong class="hljs-slc">    })</strong>
  });
{% endblock %}
</code></pre>
<p class="normal">The new code works as follows:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">A <code class="inlineCode">FormData</code> object is <a id="_idIndexMarker607"/>created to construct a set of key/value pairs representing form fields and their values. The object is stored in the <code class="inlineCode">formData</code> variable.</li>
<li class="numberedList">The <code class="inlineCode">id</code> and <code class="inlineCode">action</code> parameters expected by the <code class="inlineCode">image_like</code> Django view are added to the <code class="inlineCode">formData</code> object. The values for these parameters are retrieved from the <code class="inlineCode">likeButton</code> element clicked. The <code class="inlineCode">data-id</code> and <code class="inlineCode">data-action</code> attributes are accessed with <code class="inlineCode">dataset.id</code> and <code class="inlineCode">dataset.action</code>.</li>
<li class="numberedList">A new <code class="inlineCode">body</code> key is added to the <code class="inlineCode">options</code> object that will be used for the HTTP request. The value for this key is the <code class="inlineCode">formData</code> object.</li>
<li class="numberedList">The Fetch API is used by calling the <code class="inlineCode">fetch()</code> function. The <code class="inlineCode">url</code> variable defined previously is passed as<a id="_idIndexMarker608"/> the URL for the request, and the <code class="inlineCode">options</code> object is passed as the options for the request.</li>
<li class="numberedList">The <code class="inlineCode">fetch()</code> function returns a promise that resolves with a <code class="inlineCode">Response</code> object, which is a representation of the HTTP response. The <code class="inlineCode">.then()</code> method is used to define a handler for the promise. To extract the JSON body content, we use <code class="inlineCode">response.json()</code>. You can learn more about the <code class="inlineCode">Response</code> object at <a href="https://developer.mozilla.org/en-US/docs/Web/API/Response">https://developer.mozilla.org/en-US/docs/Web/API/Response</a>.</li>
<li class="numberedList">The <code class="inlineCode">.then()</code> method is used again to define a handler for the data extracted to JSON. In this handler, the <code class="inlineCode">status</code> attribute of the data received is used to check whether its value is <code class="inlineCode">ok</code>.</li>
</ol>
<p class="normal">You added the functionality to send the HTTP request and handle the response. After a successful request, you need to change the button and its related action to the opposite: from <em class="italic">like</em> to <em class="italic">unlike</em>, or from <em class="italic">unlike</em> to <em class="italic">like</em>. By doing so, users are able to undo their action.</p>
<p class="normal">Edit the <code class="inlineCode">domready</code> block of <a id="_idIndexMarker609"/>the <code class="inlineCode">images/image/detail.html</code> template and add the following code highlighted<a id="_idIndexMarker610"/> in bold:</p>
<pre class="programlisting code"><code class="hljs-code">{% block domready %}
  var url = '{% url "images:like" %}';
  var options = {
    method: 'POST',
    headers: {'X-CSRFToken': csrftoken},
    mode: 'same-origin'
  }
  document.querySelector('a.like')
          .addEventListener('click', function(e){
    e.preventDefault();
    var likeButton = this;
    // add request body
    var formData = new FormData();
    formData.append('id', likeButton.dataset.id);
    formData.append('action', likeButton.dataset.action);
    options['body'] = formData;
    // send HTTP request
    fetch(url, options)
    .then(response =&gt; response.json())
    .then(data =&gt; {
      if (data['status'] === 'ok')
      {
<strong class="hljs-slc">        var previousAction = likeButton.dataset.action;</strong>
<strong class="hljs-slc">        // toggle button text </strong><strong class="hljs-keyword-slc">and</strong><strong class="hljs-slc"> data-action</strong>
<strong class="hljs-slc">        var action = previousAction === </strong><strong class="hljs-string-slc">'like'</strong><strong class="hljs-slc"> ? </strong><strong class="hljs-string-slc">'unlike'</strong><strong class="hljs-slc"> : </strong><strong class="hljs-string-slc">'like'</strong><strong class="hljs-slc">;</strong>
<strong class="hljs-slc">        likeButton.dataset.action = action;</strong>
<strong class="hljs-slc">        likeButton.innerHTML = action;</strong>
<strong class="hljs-slc">        // update like count</strong>
<strong class="hljs-slc">        var likeCount = document.querySelector(</strong><strong class="hljs-string-slc">'span.count .total'</strong><strong class="hljs-slc">);</strong>
<strong class="hljs-slc">        var totalLikes = parseInt(likeCount.innerHTML);</strong>
<strong class="hljs-slc">        likeCount.innerHTML = previousAction === </strong><strong class="hljs-string-slc">'like'</strong><strong class="hljs-slc"> ? totalLikes + </strong><strong class="hljs-number-slc">1</strong><strong class="hljs-slc"> : totalLikes - </strong><strong class="hljs-number-slc">1</strong><strong class="hljs-slc">;</strong>
      }
    })
  });
{% endblock %}
</code></pre>
<p class="normal">The preceding code<a id="_idIndexMarker611"/> works as follows:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">The previous action of the button is retrieved from the <code class="inlineCode">data-action</code> attribute of the link and it is stored in the <code class="inlineCode">previousAction</code> variable.</li>
<li class="numberedList">The <code class="inlineCode">data-action</code> attribute of the link and the link text are toggled. This allows users to undo their actions.</li>
<li class="numberedList">The total like count is<a id="_idIndexMarker612"/> retrieved from the DOM by using the selector <code class="inlineCode">span.count.total</code> and the value is parsed to an integer with <code class="inlineCode">parseInt()</code>. The total like count is increased or decreased according to the action performed (<em class="italic">like</em> or <em class="italic">unlike</em>).</li>
</ol>
<p class="normal">Open the image detail page in your browser for an image that you have uploaded. You should be able to see the following initial likes count and the <strong class="screenText">LIKE</strong> button, as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_06_18.png"/></figure>
<p class="packt_figref">Figure 6.18: The likes count and LIKE button in the image detail template</p>
<p class="normal">Click on the <strong class="screenText">LIKE</strong> button. You will note that the total likes count increases by one and the button text changes to <strong class="screenText">UNLIKE</strong>, as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_06_19.png"/></figure>
<p class="packt_figref">Figure 6.19: The likes count and button after clicking the LIKE button</p>
<p class="normal">If you click on the <strong class="screenText">UNLIKE</strong> button, the action is performed, and then the button’s text changes back to <strong class="screenText">LIKE</strong> and the total count changes accordingly.</p>
<p class="normal">When programming JavaScript, especially when performing AJAX requests, it is recommended to use a tool for debugging JavaScript and HTTP requests. Most modern browsers include developer tools to debug JavaScript. Usually, you can right-click anywhere on the website to open the contextual menu and click on <strong class="screenText">Inspect</strong> or <strong class="screenText">Inspect Element</strong> to access the web developer tools of your browser.</p>
<p class="normal">In the next section, you <a id="_idIndexMarker613"/>will learn how to use asynchronous <a id="_idIndexMarker614"/>HTTP requests with JavaScript and Django to implement infinite scroll pagination.</p>
<h2 class="heading-2" id="_idParaDest-190">Adding infinite scroll pagination to the image list</h2>
<p class="normal">Next, we need to list all bookmarked images on the website. We will use JavaScript requests to build an infinite scroll functionality. Infinite scroll is achieved by loading the next results automatically when<a id="_idIndexMarker615"/> the user scrolls to the bottom of the page.</p>
<p class="normal">Let’s implement an image list view that will handle both standard browser requests and requests originating from JavaScript. When the user initially loads the image list page, we will display the first page of images. When they scroll to the bottom of the page, we will retrieve the following page of items with JavaScript and append it to the bottom of the main page.</p>
<p class="normal">The same view will handle both standard and AJAX infinite scroll pagination. Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">images</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.core.paginator </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> EmptyPage, PageNotAnInteger, Paginator</strong>
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.http </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> HttpResponse</strong>
# ...
<strong class="hljs-meta-slc">@login_required</strong>
<strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">image_list</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">request</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc">    images = Image.objects.</strong><strong class="hljs-built_in-slc">all</strong><strong class="hljs-slc">()</strong>
<strong class="hljs-slc">    paginator = Paginator(images, </strong><strong class="hljs-number-slc">8</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    page = request.GET.get(</strong><strong class="hljs-string-slc">'page'</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    images_only = request.GET.get(</strong><strong class="hljs-string-slc">'images_only'</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">try</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">        images = paginator.page(page)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">except</strong><strong class="hljs-slc"> PageNotAnInteger:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># If page is not an integer deliver the first page</strong>
<strong class="hljs-slc">        images = paginator.page(</strong><strong class="hljs-number-slc">1</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">except</strong><strong class="hljs-slc"> EmptyPage:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> images_only:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># If AJAX request and page out of range</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># return an empty page</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> HttpResponse(</strong><strong class="hljs-string-slc">''</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># If page out of range return last page of results</strong>
<strong class="hljs-slc">        images = paginator.page(paginator.num_pages)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> images_only:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> render(</strong>
<strong class="hljs-keyword-slc"> </strong><strong class="hljs-slc">request,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'images/image/list_images.html'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">            {</strong><strong class="hljs-string-slc">'section'</strong><strong class="hljs-slc">: </strong><strong class="hljs-string-slc">'images'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'</strong><strong class="hljs-string-slc">images'</strong><strong class="hljs-slc">: images}</strong>
<strong class="hljs-slc">        )</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> render(</strong>
<strong class="hljs-keyword-slc"> </strong><strong class="hljs-slc">request,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'images/image/list.html'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">            {</strong><strong class="hljs-string-slc">'section'</strong><strong class="hljs-slc">: </strong><strong class="hljs-string-slc">'images'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'images'</strong><strong class="hljs-slc">: images}</strong>
<strong class="hljs-slc">    )</strong>
</code></pre>
<p class="normal">In this view, a QuerySet is created<a id="_idIndexMarker616"/> to retrieve all images from the database. Then, a <code class="inlineCode">Paginator</code> object is created to paginate over the results, retrieving eight images per page. The <code class="inlineCode">page</code> HTTP <code class="inlineCode">GET</code> parameter is retrieved to get the requested page number. The <code class="inlineCode">images_only</code> HTTP <code class="inlineCode">GET</code> parameter is retrieved to know if the whole page has to be rendered or only the new images. </p>
<p class="normal">We will render the whole page when it is requested by the browser. However, we will only render the HTML with new images for Fetch API requests, since we will be appending them to the existing HTML page.</p>
<p class="normal">An <code class="inlineCode">EmptyPage</code> exception will be triggered if the requested page is out of range. If this is the case and only images have to be rendered, an empty <code class="inlineCode">HttpResponse</code> will be returned. This will allow you to stop the AJAX pagination on the client side when reaching the last page. The results are rendered using two different templates:</p>
<ul>
<li class="bulletList">For JavaScript HTTP requests, which will include the <code class="inlineCode">images_only</code> parameter, the <code class="inlineCode">list_images.html</code> template will be rendered. This template will only contain the images of the requested page.</li>
<li class="bulletList">For browser requests, the <code class="inlineCode">list.html</code> template will be rendered. This template will extend the <code class="inlineCode">base.html</code> template to display the whole page and will include the <code class="inlineCode">list_images.html</code> template to include the list of images.</li>
</ul>
<p class="normal">Edit the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">images</code> application and add the following URL pattern highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    path('create/', views.image_create, name='create'),
    path(
        'detail/&lt;int:id&gt;/&lt;slug:slug&gt;/',
        views.image_detail,
        name='detail'
 ),
    path('like/', views.image_like, name='like'),
<strong class="hljs-slc">    path(</strong><strong class="hljs-string-slc">''</strong><strong class="hljs-slc">, views.image_list, name=</strong><strong class="hljs-string-slc">'list'</strong><strong class="hljs-slc">),</strong>
]
</code></pre>
<p class="normal">Finally, you need to create the templates mentioned here. Inside the <code class="inlineCode">images/image/</code> template directory, create a new<a id="_idIndexMarker617"/> template and name it <code class="inlineCode">list_images.html</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% load thumbnail %}
{% for image in images %}
  &lt;div class="image"&gt;
&lt;a href="{{ image.get_absolute_url }}"&gt;
      {% thumbnail image.image 300x300 crop="smart" as im %}
      &lt;a href="{{ image.get_absolute_url }}"&gt;
&lt;img src="img/{{ im.url }}"&gt;
&lt;/a&gt;
&lt;/a&gt;
&lt;div class="info"&gt;
&lt;a href="{{ image.get_absolute_url }}" class="title"&gt;
        {{ image.title }}
      &lt;/a&gt;
&lt;/div&gt;
&lt;/div&gt;
{% endfor %}
</code></pre>
<p class="normal">The preceding template displays the list of images. You will use it to return results for AJAX requests. In this code, you iterate over images and generate a square thumbnail for each image. You normalize the size of the thumbnails to <code class="inlineCode">300x300</code> pixels. You also use the <code class="inlineCode">smart</code> cropping option. This option indicates that the image has to be incrementally cropped down to the requested size by removing slices from the edges with the least entropy.</p>
<p class="normal">Create another template in the same directory and name it <code class="inlineCode">images/image/list.html</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Images bookmarked{% endblock %}
{% block content %}
  &lt;h1&gt;Images bookmarked&lt;/h1&gt;
&lt;div id="image-list"&gt;
    {% include "images/image/list_images.html" %}
  &lt;/div&gt;
{% endblock %}
</code></pre>
<p class="normal">The list template extends the <code class="inlineCode">base.html</code> template. To avoid repeating code, you include the <code class="inlineCode">images/image/list_images.html</code> template for displaying images. The <code class="inlineCode">images/image/list.html</code> template<a id="_idIndexMarker618"/> will hold the JavaScript code for loading additional pages when scrolling to the bottom of the page.</p>
<p class="normal">Edit the <code class="inlineCode">images/image/list.html</code> template and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Images bookmarked{% endblock %}
{% block content %}
  &lt;h1&gt;Images bookmarked&lt;/h1&gt;
&lt;div id="image-list"&gt;
    {% include "images/image/list_images.html" %}
  &lt;/div&gt;
{% endblock %}
<strong class="hljs-slc">{% block domready %}</strong>
<strong class="hljs-slc">  var page = 1;</strong>
<strong class="hljs-slc">  var emptyPage = false;</strong>
<strong class="hljs-slc">  var blockRequest = false;</strong>
<strong class="hljs-slc">window.addEventListener('scroll', function(e) {</strong>
<strong class="hljs-slc">    var margin = document.body.clientHeight - window.innerHeight - 200;</strong>
<strong class="hljs-slc">    if(window.pageYOffset &gt; margin &amp;&amp; !emptyPage &amp;&amp; !blockRequest) {</strong>
<strong class="hljs-slc">      blockRequest = true;</strong>
<strong class="hljs-slc">      page += 1;</strong>
<strong class="hljs-slc">      fetch('?images_only=1&amp;page=' + page)</strong>
<strong class="hljs-slc">      .then(response =&gt; response.text())</strong>
<strong class="hljs-slc">      .then(html =&gt; {</strong>
<strong class="hljs-slc">        if (html === '') {</strong>
<strong class="hljs-slc">          emptyPage = true;</strong>
<strong class="hljs-slc">        }</strong>
<strong class="hljs-slc">        else {</strong>
<strong class="hljs-slc">          var imageList = document.getElementById('image-list');</strong>
<strong class="hljs-slc">          imageList.insertAdjacentHTML('beforeEnd', html);</strong>
<strong class="hljs-slc">          blockRequest = false;</strong>
<strong class="hljs-slc">        }</strong>
<strong class="hljs-slc">      })</strong>
<strong class="hljs-slc">    }</strong>
<strong class="hljs-slc">  });</strong>
<strong class="hljs-slc">  // Launch scroll event</strong>
<strong class="hljs-slc">  const scrollEvent = new Event('scroll');</strong>
<strong class="hljs-slc">  window.dispatchEvent(scrollEvent);</strong>
<strong class="hljs-slc">{% endblock %}</strong>
</code></pre>
<p class="normal">The preceding code provides the infinite scroll functionality. You include the JavaScript code in the <code class="inlineCode">domready</code> block that you<a id="_idIndexMarker619"/> defined in the <code class="inlineCode">base.html</code> template. The code is as follows:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">You define the following variables:<ul>
<li class="bulletList"><code class="inlineCode">page</code>: Stores the current page number.</li>
<li class="bulletList"><code class="inlineCode">empty_page</code>: Allows you to know whether the user is on the last page and retrieves an empty page. As soon as you get an empty page, you will stop sending additional HTTP requests because you will assume that there are no more results.</li>
<li class="bulletList"><code class="inlineCode">block_request</code>: Prevents you from sending additional requests while an HTTP request is in progress.</li>
</ul>
</li>
<li class="numberedList">You use <code class="inlineCode">window.addEventListener()</code> to capture the <code class="inlineCode">scroll</code> event and to define a handler function for it.</li>
<li class="numberedList">You calculate the <code class="inlineCode">margin</code> variable to get the difference between the total document height and the window inner height, because that’s the height of the remaining content for the user to scroll. You subtract a value of <code class="inlineCode">200</code> from the result so that you load the next page when the user is closer than 200 pixels to the bottom of the page.</li>
<li class="numberedList">Before sending an HTTP request, you check that:<ul>
<li class="bulletList">The <code class="inlineCode">window.pageYOffset</code> is higher than the calculated margin.</li>
<li class="bulletList">The user didn’t get to the last page of results (<code class="inlineCode">emptyPage</code> has to be <code class="inlineCode">false</code>).</li>
<li class="bulletList">There is no other ongoing HTTP request (<code class="inlineCode">blockRequest</code> has to be <code class="inlineCode">false</code>).</li>
</ul>
</li>
<li class="numberedList">If the previous conditions are met, you set <code class="inlineCode">blockRequest</code> to <code class="inlineCode">true</code> to prevent the <code class="inlineCode">scroll</code> event from<a id="_idIndexMarker620"/> triggering additional HTTP requests, and you increase the <code class="inlineCode">page</code> counter by <code class="inlineCode">1</code> to retrieve the next page.</li>
<li class="numberedList">You use <code class="inlineCode">fetch()</code> to send an HTTP <code class="inlineCode">GET</code> request, setting the URL parameters <code class="inlineCode">image_only=1</code> to retrieve only the HTML for images instead of the whole HTML page, and <code class="inlineCode">page</code> for the requested page number.</li>
<li class="numberedList">The body content is extracted from the HTTP response with <code class="inlineCode">response.text()</code> and the HTML returned is treated accordingly:<ul>
<li class="bulletList"><strong class="keyWord">If the response has no content</strong>: You get to the end of the results and there are no more pages to load. You set <code class="inlineCode">emptyPage</code> to <code class="inlineCode">true</code> to prevent additional HTTP requests.</li>
<li class="bulletList"><strong class="keyWord">If the response contains data</strong>: You append the data to the HTML element with the <code class="inlineCode">image-list</code> ID. The page content expands vertically, appending results when the user approaches the bottom of the page. You remove the lock for additional HTTP requests by setting <code class="inlineCode">blockRequest</code> to <code class="inlineCode">false</code>.</li>
</ul>
</li>
<li class="numberedList">Below the event listener, you simulate an initial <code class="inlineCode">scroll</code> event when the page is loaded. You create the event by creating a new <code class="inlineCode">Event</code> object, and then you launch it with <code class="inlineCode">window.dispatchEvent()</code>. By doing this, you ensure that the event is triggered if the initial content fits the window and has no scroll.</li>
</ol>
<p class="normal">Open <code class="inlineCode">https://127.0.0.1:8000/images/</code> in your browser. You will see the list of images that you have bookmarked so far. It should look similar to this:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_06_20.png"/></figure>
<p class="packt_figref">Figure 6.20: The image list page with infinite scroll pagination</p>
<div><p class="normal"><em class="italic">Figure 6.19</em> image <a id="_idIndexMarker621"/>attributions:</p>
<ul>
<li class="bulletList"><em class="italic">Chick Corea</em> by ataelw (license: Creative Commons Attribution 2.0 Generic: https://creativecommons.org/licenses/by/2.0/)</li>
<li class="bulletList"><em class="italic">Al Jarreau - Düsseldorf 1981</em> by Eddi Laumanns aka RX-Guru (license: Creative Commons Attribution 3.0 Unported: https://creativecommons.org/licenses/by/3.0/)</li>
<li class="bulletList"><em class="italic">Al Jarreau </em>by Kingkongphoto and www.celebrity-photos.com (license: Creative Commons Attribution-ShareAlike 2.0 Generic: https://creativecommons.org/licenses/by-sa/2.0/)</li>
</ul>
</div>
<p class="normal">Scroll to the bottom of the page to load additional pages. Ensure that you have bookmarked more than eight images using the bookmarklet, because that’s the number of images you are displaying per page.</p>
<p class="normal">You can use your browser developer tools to track the AJAX requests. Usually, you can right-click anywhere on the website to open the contextual menu and click on <strong class="screenText">Inspect</strong> or <strong class="screenText">Inspect Element</strong> to access the <a id="_idIndexMarker622"/>web developer tools of your browser. Look for the panel for network requests. </p>
<p class="normal">Reload the page and scroll to the bottom of the page to load new pages. You will see the request for the first page and the AJAX requests for additional pages, like in <em class="italic">Figure 6.21</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_06_21.png"/></figure>
<p class="packt_figref">Figure 6.21: HTTP requests registered in the developer tools of the browser</p>
<p class="normal">In the shell where you are running Django, you will see the requests as well, like this:</p>
<pre class="programlisting con"><code class="hljs-con">[04/Jan/2024 08:14:20] "GET /images/ HTTP/1.1" 200
[04/Jan/2024 08:14:25] "GET /images/?images_only=1&amp;page=2 HTTP/1.1" 200
[04/Jan/2024 08:14:26] "GET /images/?images_only=1&amp;page=3 HTTP/1.1" 200
[04/Jan/2024 08:14:26] "GET /images/?images_only=1&amp;page=4 HTTP/1.1" 200
</code></pre>
<p class="normal">Finally, edit the <code class="inlineCode">base.html</code> template of the <code class="inlineCode">account</code> application and add the URL for the <code class="inlineCode">images</code> item highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;ul class="menu"&gt;
  ...
  &lt;li {% if section == "images" %}class="selected"{% endif %}&gt;
&lt;a href=<strong class="hljs-string-slc">"{% url "</strong><strong class="hljs-attr-slc">images:list</strong><strong class="hljs-tag-slc">" %}"</strong>&gt;Images&lt;/a&gt;
&lt;/li&gt;
  ...
&lt;/ul&gt;
</code></pre>
<p class="normal">Now you can<a id="_idIndexMarker623"/> access the image list from the main menu.</p>
<h1 class="heading-1" id="_idParaDest-191">Summary</h1>
<p class="normal">In this chapter, you created models with many-to-many relationships and learned how to customize the behavior of forms. You built a JavaScript bookmarklet to share images from other websites on your site. This chapter has also covered the creation of image thumbnails using the <code class="inlineCode">easy-thumbnails</code> application. </p>
<p class="normal">Finally, you implemented AJAX views using the JavaScript Fetch API and added infinite scroll pagination to the image list view.</p>
<p class="normal">In the next chapter, you will learn how to build a follow system and an activity stream. You will work with generic relations, signals, and denormalization. You will also learn how to use Redis with Django to count image views and generate an image ranking.</p>
<h1 class="heading-1" id="_idParaDest-192">Additional resources</h1>
<p class="normal">The following resources provide additional information related to the topics covered in this chapter:</p>
<ul>
<li class="bulletList">Source code for this chapter: <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter06">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter06</a></li>
<li class="bulletList">Database indexes: <a href="https://docs.djangoproject.com/en/5.0/ref/models/options/#django.db.models.Options.indexes">https://docs.djangoproject.com/en/5.0/ref/models/options/#django.db.models.Options.indexes</a></li>
<li class="bulletList">Many-to-many relationships: <a href="https://docs.djangoproject.com/en/5.0/topics/db/examples/many_to_many/">https://docs.djangoproject.com/en/5.0/topics/db/examples/many_to_many/</a></li>
<li class="bulletList">Requests HTTP library for Python: <a href="https://docs.djangoproject.com/en/5.0/topics/db/examples/many_to_many/">https://docs.djangoproject.com/en/5.0/topics/db/examples/many_to_many/</a></li>
<li class="bulletList">Pinterest Save extension: <a href="https://help.pinterest.com/en/article/save-pins-with-the-pinterest-browser-button">https://help.pinterest.com/en/article/save-pins-with-the-pinterest-browser-button</a></li>
<li class="bulletList">Static content for the account application: <a href="https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter06/bookmarks/images/static">https://github.com/PacktPublishing/Django-5-by-Example/tree/main/Chapter06/bookmarks/images/static</a></li>
<li class="bulletList">CSS selectors: <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Selectors">https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Selectors</a></li>
<li class="bulletList">Locating DOM elements using CSS selectors: <a href="https://developer.mozilla.org/en-US/docs/Web/API/Document_object_model/Locating_DOM_elements_using_selectors">https://developer.mozilla.org/en-US/docs/Web/API/Document_object_model/Locating_DOM_elements_using_selectors</a></li>
<li class="bulletList">Let’s Encrypt free automated certificate authority: <a href="https://letsencrypt.org">https://letsencrypt.org</a></li>
<li class="bulletList">Django <code class="inlineCode">easy-thumbnails</code> app: <a href="https://easy-thumbnails.readthedocs.io/">https://easy-thumbnails.readthedocs.io/</a></li>
<li class="bulletList">JavaScript Fetch API usage: <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch">https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch</a></li>
<li class="bulletList">JavaScript Cookie library: <a href="https://github.com/js-cookie/js-cookie">https://github.com/js-cookie/js-cookie</a></li>
<li class="bulletList">Django’s CSRF protection and AJAX: <a href="https://docs.djangoproject.com/en/5.0/ref/csrf/#ajax">https://docs.djangoproject.com/en/5.0/ref/csrf/#ajax</a></li>
<li class="bulletList">JavaScript Fetch API Request mode: <a href="https://developer.mozilla.org/en-US/docs/Web/API/Request/mode">https://developer.mozilla.org/en-US/docs/Web/API/Request/mode</a></li>
<li class="bulletList">JavaScript Fetch API Response: <a href="https://developer.mozilla.org/en-US/docs/Web/API/Response">https://developer.mozilla.org/en-US/docs/Web/API/Response</a></li>
</ul>
</div>
</body></html>