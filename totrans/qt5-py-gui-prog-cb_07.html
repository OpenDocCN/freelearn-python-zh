<html><head></head><body>
  <div id="sbo-rt-content"><div class="chapter" title="Chapter 7. Storing Data in Our MySQL Database via Our GUI"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Storing Data in Our MySQL Database via Our GUI</h1></div></div></div><p>In this chapter we will enhance our Python GUI by connecting to a MySQL database.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Connecting to a MySQL database from Python</li><li class="listitem" style="list-style-type: disc">Configuring the MySQL connection</li><li class="listitem" style="list-style-type: disc">Designing the Python GUI database</li><li class="listitem" style="list-style-type: disc">Using the SQL INSERT command</li><li class="listitem" style="list-style-type: disc">Using the SQL UPDATE command</li><li class="listitem" style="list-style-type: disc">Using the SQL DELETE command</li><li class="listitem" style="list-style-type: disc">Storing and retrieving data from our MySQL database</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec62"/>Introduction</h1></div></div></div><p>Before we can connect to a MySQL server, we have to have access to a MySQL server. The first recipe in this chapter will show you how to install the free MySQL Server Community Edition.</p><p>After successfully connecting to a running instance of our MySQL server, we will design and create a database that will accept a book title, which could be our own journal or a quote we found somewhere on the Internet. We will require a page number for the book, which could be blank, and then we will <code class="literal">insert</code> the quote we like from a book, journal, website or friend into our MySQL database using our GUI built in Python 3.</p><p>We will insert, modify, delete and display our favorite quotes using our Python GUI to issue these SQL commands and to display the data.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note72"/>Note</h3><p>
<span class="strong"><strong>CRUD</strong></span> is<a id="id259" class="indexterm"/> a database term you might come across that abbreviates the four basic SQL commands and stands for <span class="strong"><strong>Create</strong></span>, <span class="strong"><strong>Read</strong></span>, <span class="strong"><strong>Update</strong></span>, and <span class="strong"><strong>Delete</strong></span>.</p></div></div></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Connecting to a MySQL database from Python"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec63"/>Connecting to a MySQL database from Python</h1></div></div></div><p>Before <a id="id260" class="indexterm"/>we can connect to a MySQL database, <a id="id261" class="indexterm"/>we have to connect to the MySQL server.</p><p>In order to do this, we need to know the IP address of the MySQL server as well as the port it is listening on.</p><p>We also have to be a registered user with a password in order to get authenticated by the MySQL server.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec161"/>Getting ready</h2></div></div></div><p>You will need to have access to a running MySQL server instance and you also need to have administrator privileges in order to create databases and tables.</p><p>There is <a id="id262" class="indexterm"/>a free MySQL Community Edition available from the official MySQL website. You can download and install it on your local PC from: <a class="ulink" href="http://dev.mysql.com/downloads/">http://dev.mysql.com/downloads/</a>
</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note73"/>Note</h3><p>In this chapter, we are using MySQL Community Server (GPL) Release: 5.6.26.</p></div></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec162"/>How to do it…</h2></div></div></div><p>In order to connect to MySQL, we first need to install a special Python connector driver. This driver will enable us to talk to the MySQL server from Python.</p><p>The <a id="id263" class="indexterm"/>driver is freely available on the MySQL website and comes with a very nice online tutorial. You can install it from:</p><p>
<a class="ulink" href="http://dev.mysql.com/doc/connector-python/en/index.html">http://dev.mysql.com/doc/connector-python/en/index.html</a>
</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note74"/>Note</h3><p>Make sure you choose the installer that matches the version of Python you have installed. In this chapter, we are using the installer for Python 3.4.</p></div></div><div class="mediaobject"><img src="images/B04829_07_01.jpg" alt="How to do it…"/></div><p>There is currently a little bit of a surprise at the end of the installation process. When we start the <code class="literal">.msi</code> installer we briefly see a MessageBox showing the progress of the installation, but then it disappears. We get no confirmation that the installation actually succeeded.</p><p>One way to verify that we installed the correct driver, that lets Python talk to MySQL, is by looking into the Python site-packages directory.</p><p>If<a id="id264" class="indexterm"/> your site-packages directory looks similar<a id="id265" class="indexterm"/> to the following screenshot and you see some new files that have <code class="literal">mysql_connector_python</code> in their name, well, then we did indeed install something…</p><div class="mediaobject"><img src="images/B04829_07_02.jpg" alt="How to do it…"/></div><p>The official <a id="id266" class="indexterm"/>MySQL website mentioned above comes with a tutorial, at the following URL:</p><p>
<a class="ulink" href="http://dev.mysql.com/doc/connector-python/en/connector-python-tutorials.html">http://dev.mysql.com/doc/connector-python/en/connector-python-tutorials.html</a>
</p><p>The online tutorial example on how to verify that installing the Connector/Python driver worked is a little bit misleading as it tries to connect to an employees' database that did not get created automatically, at least in my Community Edition.</p><p>The way to verify that our Connector/Python driver really did get installed is by just connecting to the MySQL server without specifying a particular database and then printing out the connection object.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note75"/>Note</h3><p>Replace the placeholder bracketed names <code class="literal">&lt;adminUser&gt;</code> and <code class="literal">&lt;adminPwd&gt;</code> with the real credentials you are using in your MySQL installation.</p><p>If you installed the MySQL Community Edition, you are the administrator and will have chosen both a username and password during the MySQL installation.</p></div></div><div class="informalexample"><pre class="programlisting">import mysql.connector as mysql

conn = mysql.connect(user=&lt;adminUser&gt;, password=&lt;adminPwd&gt;,
                     host='127.0.0.1')
print(conn)

conn.close()</pre></div><p>If running the preceding code results in the following output printed to the console, then we are good.</p><div class="mediaobject"><img src="images/B04829_07_03.jpg" alt="How to do it…"/></div><p>If you<a id="id267" class="indexterm"/> are not able to connect to the MySQL<a id="id268" class="indexterm"/> server, then something probably went wrong during the installation. If this is the case, try uninstalling MySQL, reboot your PC, and then run the MySQL installation again. Double-check that you downloaded the MySQL installer to match your version of Python. If you have more than one version of Python installed, that sometimes leads to confusion as the one you installed last gets prepended to the Windows path environmental variable and some installers just use the first Python version they can find in this location.</p><p>That happened to me when I installed a Python 32-bit version in addition to my 64-bit version and I was puzzled why some of my downloaded modules did not work.</p><p>The installers downloaded the 32-bit modules, which are incompatible with a 64-bit version of Python.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec163"/>How it works…</h2></div></div></div><p>In order to connect our GUI to a MySQL server, we need to be able to connect to the server with administrative privileges if we want to create our own database.</p><p>If the<a id="id269" class="indexterm"/> database already exists, then we just<a id="id270" class="indexterm"/> need the authorization rights to connect, insert, update, and delete data.</p><p>We will create a new database on a MySQL server in the next recipe.</p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Configuring the MySQL connection"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec64"/>Configuring the MySQL connection</h1></div></div></div><p>In the<a id="id271" class="indexterm"/> previous recipe, we used the shortest way to connect to a MySQL server by hard-coding the credentials required for authentication into the <code class="literal">connection</code> method. While this is a fast approach for early development, we definitely do not want to expose our MySQL server credentials to anybody unless we <span class="emphasis"><em>grant</em></span> permission to databases, tables, views, and related database commands to specific users.</p><p>A much safer way to get authenticated by a MySQL server is by storing the credentials in a configuration file, which is what we will do in this recipe.</p><p>We will use our configuration file to connect to the MySQL server and then create our own database on the MySQL server.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note76"/>Note</h3><p>We will use this database in all of the following recipes.</p></div></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec164"/>Getting ready</h2></div></div></div><p>Access to a running MySQL server with administrator privileges is required to run the code shown in this recipe.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note77"/>Note</h3><p>The previous recipe shows how to install the free Community Edition of MySQL Server. The administrator privileges will enable you to implement this recipe.</p></div></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec165"/>How to do it…</h2></div></div></div><p>First, we create a dictionary in the same module of the <code class="literal">MySQL.py</code> code.</p><div class="informalexample"><pre class="programlisting"># create dictionary to hold connection info
dbConfig = {
    'user': &lt;adminName&gt;,      # use your admin name 
    'password': &lt;adminPwd&gt;,   # use your admin password
    'host': '127.0.0.1',      # IP address of localhost
    }</pre></div><p>Next, in <a id="id272" class="indexterm"/>the connection method, we unpack the dictionary values. Instead of writing,</p><div class="informalexample"><pre class="programlisting">mysql.connect('user': &lt;adminName&gt;,  'password': &lt;adminPwd&gt;, 'host': '127.0.0.1') </pre></div><p>we use <code class="literal">(**dbConfig)</code>, which does the same as above but is much shorter.</p><div class="informalexample"><pre class="programlisting">import mysql.connector as mysql
# unpack dictionary credentials 
conn = mysql.connect(**dbConfig)
print(conn)</pre></div><p>This results in the same successful connection to the MySQL server, but the difference is that the connection method no longer exposes any mission-critical information.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note78"/>Note</h3><p>A database server is critical to your mission. You realize this once you have lost your valuable data…and can't find any recent backup!</p></div></div><div class="mediaobject"><img src="images/B04829_07_04.jpg" alt="How to do it…"/></div><p>Now, placing the same username, password, database, and so on into a dictionary in the same Python module does not eliminate the risk of having the credentials seen by anyone perusing the code.</p><p>In order to increase database security, we first move the dictionary into its own Python module. Let's call the new Python module <code class="literal">GuiDBConfig.py</code>.</p><p>We then import this module and unpack the credentials, as we did before.</p><div class="informalexample"><pre class="programlisting">import GuiDBConfig as guiConf
# unpack dictionary credentials 
conn = mysql.connect(**guiConf.dbConfig)
print(conn)</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note79"/>Note</h3><p>Once we place this module into a secure place, separated from the rest of the code, we have achieved a better level of security for our MySQL data.</p></div></div><p>Now that <a id="id273" class="indexterm"/>we know how to connect to MySQL and have administrator privileges, we can create our own database by issuing the following commands:</p><div class="informalexample"><pre class="programlisting">GUIDB = 'GuiDB'

# unpack dictionary credentials 
conn = mysql.connect(**guiConf.dbConfig)

cursor = conn.cursor()

try:
    cursor.execute("CREATE DATABASE {} DEFAULT CHARACTER SET 'utf8'".format(GUIDB))

except mysql.Error as err:
    print("Failed to create DB: {}".format(err))

conn.close()</pre></div><p>In order to execute commands to MySQL, we create a cursor object from the connection object.</p><p>A cursor is usually a place in a specific row in a database table, which we move up or down the table, but here we use it to create the database itself.</p><p>We wrap the Python code into a <code class="literal">try…except</code> block and use the built-in error codes of MySQL to tell us if anything went wrong.</p><p>We can verify that this block works by executing the database-creating code twice. The first time, it will create a new database in MySQL, and the second time it will print out an error message stating that this database already exists.</p><p>We can verify which databases exist by executing the following MySQL command using the very same cursor object syntax.</p><p>Instead of issuing the <code class="literal">CREATE DATABASE</code> command, we create a cursor and use it to execute the <code class="literal">SHOW DATABASES</code> command, the result of which we fetch and print to the console output.</p><div class="informalexample"><pre class="programlisting">import mysql.connector as mysql
import GuiDBConfig as guiConf

# unpack dictionary credentials 
conn = mysql.connect(**guiConf.dbConfig)

cursor = conn.cursor()

cursor.execute("SHOW DATABASES")
print(cursor.fetchall())

conn.close()</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note80"/>Note</h3><p>We retrieve the results by calling the <code class="literal">fetchall</code> method on the cursor object.</p></div></div><p>Running<a id="id274" class="indexterm"/> this code shows us which databases currently exist in our MySQL server instance. As we can see from the output, MySQL ships with several built-in databases, such as <code class="literal">information_schema</code>, and so on. We have successfully created our own <code class="literal">guidb</code> database, which is shown in the output. All other databases illustrated come shipped with MySQL.</p><p> </p><div class="mediaobject"><img src="images/B04829_07_05.jpg" alt="How to do it…"/></div><p>
</p><p>Note how, even though we specified the database when we created it in mixed-case letters as GuiDB, the <code class="literal">SHOW DATABASES</code> command shows all existing databases in MySQL in lower-case and displays our database as <code class="literal">guidb</code>.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec166"/>How it works…</h2></div></div></div><p>In order to connect our Python GUI to a MySQL database, we first have to know how to connect to the MySQL server. This requires establishing a connection and this connection will only be accepted by MySQL if we are able to provide the required credentials.</p><p>While it is easy to place strings into one line of Python code, when we deal with databases we have to be really thoughtful, because today's personal sandbox development environment, by tomorrow, could easily end up being accessible on the World Wide Web.</p><p>You do not want to compromise database security and the first part of this recipe showed ways to be more secure by placing the connection credentials to the MySQL server into a separate file, and by placing this file into a location where it is not accessible from the outside world, our database system will become more secure.</p><p>In a real-world production environment, both the MySQL server installation, connection credentials and this dbConfig file would be handled by IT system administrators who would enable you to import the dbConfig file to connect to the MySQL server without you knowing<a id="id275" class="indexterm"/> what the actual credentials are. Unpacking dbConfig would not expose the credentials as it does in our code.</p><p>The second part created our own database in a MySQL server instance and we will extend and use this database in the very next recipes, combining it with our Python GUI.</p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Designing the Python GUI database"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec65"/>Designing the Python GUI database</h1></div></div></div><p>Before we <a id="id276" class="indexterm"/>start creating tables and inserting data into them we have to design the database. Unlike changing local Python variable names, changing a database schema once it has been created and loaded with data is not that easy.</p><p>We would have to <code class="literal">DROP</code> the table, which means we would lose all the data that was in the table. So, before dropping a table, we would have to extract the data, then <code class="literal">DROP</code> the table, and recreate it under a different name and finally reimport the original data.</p><p>You get the picture…</p><p>Designing our GUI MySQL database means first thinking about what we want our Python application to do with it and then choose names for our tables that match the intended purpose.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec167"/>Getting ready</h2></div></div></div><p>We are working with the MySQL database we created in the previous recipe. A running instance of MySQL is necessary and the two previous recipes show how to install MySQL and all necessary additional drivers, as well as how to create the database we are using in this chapter.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec168"/>How to do it…</h2></div></div></div><p>First, we move widgets from our Python GUI around between the two tabs we created in the previous recipes, in order to organize our Python GUI better to connect to a MySQL database.</p><p>We rename several widgets and separate the code that accesses the MySQL data to what used to be named Tab 1, and we will move unrelated widgets to what we called in earlier recipes Tab 2.</p><p>We also adjust some internal Python variable names in order to understand our code better.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note81"/>Note</h3><p>Code<a id="id277" class="indexterm"/> readability is a coding virtue and not a waste of time.</p></div></div><p>Our <a id="id278" class="indexterm"/>refactored Python GUI now looks like the following screenshot. We have renamed the first tab as MySQL and created two tkinter LabelFrame widgets. We labeled the one on the top, Python Database, and it contains two labels and six tkinter entry widgets plus three buttons, which we aligned in four rows and three columns using the tkinter grid layout manager.</p><p>We will enter book titles and pages into the entry widgets and clicking the buttons will result in either inserting, retrieving, or modifying book quotations.</p><p>The LabelFrame at the bottom has a label of <span class="strong"><strong>Book Quotation</strong></span> and the ScrolledText widget that is part of this frame will display our books and quotations.</p><div class="mediaobject"><img src="images/B04829_07_06.jpg" alt="How to do it…"/></div><p>We will create two SQL tables to hold our data. The first will hold the data for the book title and the book page. We will then join with the second table, which will hold the book quotation.</p><p>We will <a id="id279" class="indexterm"/>link the two tables together via primary to foreign key relations.</p><p>So, let's create the first database table now.</p><p>Before we do that, let's verify first that our database indeed has no tables. According to the online MySQL documentation, the command to view the tables that exist in a database is as follows.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note82"/>Note</h3><p>13.7.5.38 <code class="literal">SHOW </code>
<code class="literal">TABLES</code> syntax:</p><div class="informalexample"><pre class="programlisting">SHOW [FULL] TABLES [{FROM | IN} db_name]
    [LIKE 'pattern' | WHERE expr]</pre></div></div></div><p>It is important to note that, in the preceding syntax, arguments in square brackets such as <code class="literal">FULL</code> are optional while arguments in curly braces such as <code class="literal">FROM</code> are required in the description for the <code class="literal">SHOW TABLES</code> command. The pipe symbol between <code class="literal">FROM</code> and <code class="literal">IN</code> means that the MySQL syntax requires one or the other.</p><div class="informalexample"><pre class="programlisting"># unpack dictionary credentials 
conn = mysql.connect(**guiConf.dbConfig)
# create cursor 
cursor = conn.cursor()
# execute command
cursor.execute("SHOW TABLES FROM guidb")
print(cursor.fetchall())

# close connection to MySQL
conn.close()</pre></div><p>When we execute the SQL command in Python we get the expected result, which is an empty list, showing us that our database currently has no tables.</p><div class="mediaobject"><img src="images/B04829_07_07.jpg" alt="How to do it…"/></div><p>We can<a id="id280" class="indexterm"/> also first select the database by executing the <code class="literal">USE &lt;DB&gt;</code> command. Now, we don't have to pass it into the <code class="literal">SHOW TABLES</code> command because we already selected the database we want to talk to.</p><p>The following code creates the same true result as did the previous one:</p><div class="informalexample"><pre class="programlisting">cursor.execute("USE guidb")
cursor.execute("SHOW TABLES")</pre></div><p>Now that we know how to verify that our database has no tables, let's create some. After we have created two tables, we will verify that they have truly made it into our database by using the same commands as before.</p><p>We create the first table, named <code class="literal">Books</code>, by executing the following code.</p><div class="informalexample"><pre class="programlisting"># connect by unpacking dictionary credentials
conn = mysql.connect(**guiConf.dbConfig)

# create cursor 
cursor = conn.cursor()

# select DB
cursor.execute("USE guidb")

# create Table inside DB
cursor.execute("CREATE TABLE Books (       \
      Book_ID INT NOT NULL AUTO_INCREMENT, \
      Book_Title VARCHAR(25) NOT NULL,     \
      Book_Page INT NOT NULL,              \
      PRIMARY KEY (Book_ID)                \
    ) ENGINE=InnoDB")

# close connection to MySQL
conn.close()</pre></div><p>We can verify that the table was created in our database by executing the following commands.</p><div class="mediaobject"><img src="images/B04829_07_08.jpg" alt="How to do it…"/></div><p>Now the <a id="id281" class="indexterm"/>result is no longer an empty list but a list that contains a tuple, showing the <code class="literal">books</code> table we just created.</p><p>We can use the MySQL command line client to see the columns in our table. In order to do this, we have to log in as the root user. We also have to append a semicolon to the end of the command.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note83"/>Note</h3><p>On Windows, you simply double-click the MySQL command line client shortcut, which is automatically installed during the MySQL installation.</p></div></div><p>If you don't have a shortcut on your desktop, you can find the executable at the following path for a typical default installation:</p><p>
<code class="literal">C:\Program Files\MySQL\MySQL Server 5.6\bin\mysql.exe</code>
</p><p>Without a shortcut to run the MySQL client, you have to pass it some parameters:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">C:\Program Files\MySQL\MySQL Server 5.6\bin\mysql.exe</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">--defaults-file=C:\ProgramData\MySQL\MySQL Server 5.6\my.ini</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">-uroot</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">-p</code></li></ul></div><p>Either double-clicking the shortcut, or using the command line with the full path to the executable and passing in the required parameters, will bring up the MySQL command line client which prompts you to enter the password for the root user.</p><p>If you remember the password you assigned to the root user during the installation, you can then run the <code class="literal">SHOW COLUMNS FROM books;</code> command, as shown below. This will display the columns of our <code class="literal">books</code> table from our guidb.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note84"/>Note</h3><p>When executing commands in the MySQL client, the syntax is not Pythonic.</p></div></div><div class="mediaobject"><img src="images/B04829_07_09.jpg" alt="How to do it…"/></div><p>Next, <a id="id282" class="indexterm"/>we will create the second table that will store the book and journal quotations. We will create it by executing the following code:</p><div class="informalexample"><pre class="programlisting"># select DB
cursor.execute("USE guidb")

# create second Table inside DB
cursor.execute("CREATE TABLE Quotations ( \
        Quote_ID INT,                     \
        Quotation VARCHAR(250),           \
        Books_Book_ID INT,                \
        FOREIGN KEY (Books_Book_ID)       \
            REFERENCES Books(Book_ID)     \
            ON DELETE CASCADE             \
    ) ENGINE=InnoDB")</pre></div><p>Executing the <code class="literal">SHOW TABLES</code> command now shows that our database has two tables.</p><div class="mediaobject"><img src="images/B04829_07_10.jpg" alt="How to do it…"/></div><p>We can <a id="id283" class="indexterm"/>see the columns by executing the SQL command using Python.</p><div class="mediaobject"><img src="images/B04829_07_11.jpg" alt="How to do it…"/></div><p>Using the MySQL client might present the data in a better format. We could also use Python's pretty print (<code class="literal">pprint</code>) feature.</p><div class="mediaobject"><img src="images/B04829_07_12.jpg" alt="How to do it…"/></div><p>The MySQL client still shows our columns in a clearer format which can be seen when you run this client.</p></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec169"/>How it works…</h2></div></div></div><p>We <a id="id284" class="indexterm"/>designed our Python GUI database and refactored our GUI in preparation to use our new database. We then created a MySQL database and created two tables within it.</p><p>We verified that the tables made it into our database by using both Python and the MySQL client that ships with the MySQL server.</p><p>In the next recipe, we will insert data into our tables.</p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Using the SQL INSERT command"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec66"/>Using the SQL INSERT command</h1></div></div></div><p>This recipe <a id="id285" class="indexterm"/>presents the entire Python code that shows you how to create and drop MySQL databases and tables, as well as how to display the existing databases, tables, columns, and data of our MySQL instance.</p><p>After creating the database and tables, we will insert data into the two tables we are creating in this recipe.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note85"/>Note</h3><p>We are using a primary to foreign key relationship to connect the data of the two tables.</p></div></div><p>We will go into the details of how this works in the following two recipes, where we modify and delete the data in our MySQL database.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec170"/>Getting ready</h2></div></div></div><p>This recipe builds on the MySQL database we created in the previous recipe and also shows you how to drop and recreate the GuiDB.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note86"/>Note</h3><p>Dropping the database of course deletes all data the database had in its tables, so we will also show you how to re-insert that data.</p></div></div></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec171"/>How to do it…</h2></div></div></div><p>The entire code of our <code class="literal">MySQL.py</code> module is present in the code folder of this chapter, which is available for download from Packt Publishing's website. It creates the database, adds tables to it, and then inserts data into the two tables we created.</p><p>Here we will outline the code without showing all implementation details in order to preserve<a id="id286" class="indexterm"/> space, because it would take too many pages to show the entire code.</p><div class="informalexample"><pre class="programlisting">import mysql.connector as mysql
import GuiDBConfig as guiConf

class MySQL():
    # class variable
    GUIDB  = 'GuiDB'   
     
    #------------------------------------------------------
    def connect(self):
        # connect by unpacking dictionary credentials
        conn = mysql.connector.connect(**guiConf.dbConfig)
    
        # create cursor 
        cursor = conn.cursor()    
            
        return conn, cursor
    
    #------------------------------------------------------
    def close(self, cursor, conn):
        # close cursor

    #------------------------------------------------------
    def showDBs(self):
        # connect to MySQL
                   
    #------------------------------------------------------
    def createGuiDB(self):
        # connect to MySQL

    #------------------------------------------------------
    def dropGuiDB(self):
        # connect to MySQL
             
    #------------------------------------------------------
    def useGuiDB(self, cursor):
        '''Expects open connection.'''
        # select DB

                      
    #------------------------------------------------------
    def createTables(self):
        # connect to MySQL
        
        # create Table inside DB
          
    #------------------------------------------------------
    def dropTables(self):
        # connect to MySQL

    #------------------------------------------------------
    def showTables(self):
        # connect to MySQL
            
    #------------------------------------------------------
    def insertBooks(self, title, page, bookQuote):
        # connect to MySQL
        
        # insert data

    #------------------------------------------------------
    def insertBooksExample(self):
        # connect to MySQL

        # insert hard-coded data
        
    #------------------------------------------------------
    def showBooks(self):
        # connect to MySQL

    #------------------------------------------------------
    def showColumns(self):
        # connect to MySQL


    #------------------------------------------------------
    def showData(self):
        # connect to MySQL
                                
#------------------------------------------------------
if __name__ == '__main__': 

    # Create class instance
    mySQL = MySQL()</pre></div><p>Running<a id="id287" class="indexterm"/> the preceding code creates the following tables and data in the database we created.</p><div class="mediaobject"><img src="images/B04829_07_13.jpg" alt="How to do it…"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec172"/>How it works…</h2></div></div></div><p>We have created a MySQL database, established a connection to it, and then created two tables that hold the data for a favorite book or journal quotation.</p><p>We have distributed the data between two tables because the quotations tend to be rather large while the book titles and book page numbers are very short. By doing this, we can increase the efficiency of our database.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note87"/>Note</h3><p>In SQL database language, separating data into separate tables is called normalization.</p></div></div></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Using the SQL UPDATE command"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec67"/>Using the SQL UPDATE command</h1></div></div></div><p>This<a id="id288" class="indexterm"/> recipe will use the code from the previous recipe, explain it in more detail, and then extend the code to update our data.</p><p>In order to update data we have previously inserted into our MySQL database tables, we use the SQL <code class="literal">UPDATE</code> command.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec173"/>Getting ready</h2></div></div></div><p>This recipe builds on the previous recipe, so read and study the previous recipe in order to follow the coding in this recipe where we modify existing data.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec174"/>How to do it…</h2></div></div></div><p>First, we <a id="id289" class="indexterm"/>will display the data to be modified by running the following Python to MySQL command:</p><div class="informalexample"><pre class="programlisting">import mysql.connector as mysql
import GuiDBConfig as guiConf

class MySQL():
    # class variable
    GUIDB  = 'GuiDB'
    #------------------------------------------------------
    def showData(self):
        # connect to MySQL
        conn, cursor = self.connect()   
        
        self.useGuiDB(cursor)      
         
        # execute command
        cursor.execute("SELECT * FROM books")
        print(cursor.fetchall())

        cursor.execute("SELECT * FROM quotations")
        print(cursor.fetchall())
        
        # close cursor and connection
        self.close(cursor, conn)
#==========================================================
if __name__ == '__main__': 
    # Create class instance
    mySQL = MySQL()
    mySQL.showData()</pre></div><p>Running the code creates the following result:</p><div class="mediaobject"><img src="images/B04829_07_14.jpg" alt="How to do it…"/></div><p>We might not agree with the "Gang of Four", so let's change their famous programming quote.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note88"/>Note</h3><p>The Gang of Four are the four authors who created the world famous book called <span class="emphasis"><em>Design Patterns,</em></span> which strongly influenced our entire software industry to recognize, think, and code using software design patterns.</p></div></div><p>We <a id="id290" class="indexterm"/>will do this by updating our database of favorite quotes.</p><p>First, we retrieve the primary key value by searching for the book title and then we pass that value into our search for the quote.</p><div class="informalexample"><pre class="programlisting">    #------------------------------------------------------
    def updateGOF(self):
        # connect to MySQL
        conn, cursor = self.connect()   
        
        self.useGuiDB(cursor)      
         
        # execute command
        cursor.execute("SELECT Book_ID FROM books WHERE Book_Title = 'Design Patterns'")
        primKey = cursor.fetchall()[0][0]
        print(primKey)

        cursor.execute("SELECT * FROM quotations WHERE Books_Book_ID = (%s)", (primKey,))
        print(cursor.fetchall())
        
        # close cursor and connection
        self.close(cursor, conn) 
#==========================================================
if __name__ == '__main__': 
    # Create class instance
    mySQL = MySQL()
    mySQL.updateGOF()</pre></div><p>This gives us the following result:</p><div class="mediaobject"><img src="images/B04829_07_15.jpg" alt="How to do it…"/></div><p>Now<a id="id291" class="indexterm"/> that we know the primary key of the quote, we can update the quote by executing the following commands.</p><div class="informalexample"><pre class="programlisting">    #------------------------------------------------------
    def updateGOF(self):
        # connect to MySQL
        conn, cursor = self.connect()   
        
        self.useGuiDB(cursor)      
         
        # execute command
        cursor.execute("SELECT Book_ID FROM books WHERE Book_Title = 'Design Patterns'")
        primKey = cursor.fetchall()[0][0]
        print(primKey)

        cursor.execute("SELECT * FROM quotations WHERE Books_Book_ID = (%s)", (primKey,))
        print(cursor.fetchall())
        
        cursor.execute("UPDATE quotations SET Quotation = (%s) WHERE Books_Book_ID = (%s)", \
                       ("Pythonic Duck Typing: If it walks like a duck and talks like a duck it probably is a duck...", primKey))

        # commit transaction
        conn.commit ()
                
        cursor.execute("SELECT * FROM quotations WHERE Books_Book_ID = (%s)", (primKey,))
        print(cursor.fetchall())
        
        # close cursor and connection
        self.close(cursor, conn)
#==========================================================
if __name__ == '__main__': 
    # Create class instance
    mySQL = MySQL()
    #------------------------
    mySQL.updateGOF()
    book, quote = mySQL.showData()    
    print(book, quote)</pre></div><p>By <a id="id292" class="indexterm"/>running the preceding code we make this programming classic more Pythonic.</p><p>As can be seen in the following screenshot, before we ran the preceding code, our title with <code class="literal">Book_ID 1</code> was related via a primary to foreign key relationship to the quotation in the <code class="literal">Books_Book_ID</code> column of the quotation table.</p><p>This is the original quotation from the <span class="emphasis"><em>Design Patterns</em></span> book.</p><p>We then updated the quotation related to this ID via the SQL <code class="literal">UPDATE</code> command.</p><p>None of the IDs have changed, but the quotation that is now associated with <code class="literal">Book_ID 1</code> has changed, as can be seen in the second MySQL client window, as follows.</p><div class="mediaobject"><img src="images/B04829_07_16.jpg" alt="How to do it…"/></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec175"/>How it works…</h2></div></div></div><p>In<a id="id293" class="indexterm"/> this recipe, we retrieved existing data from our database and database tables we created in earlier recipes. We inserted data into the tables and updated our data using the SQL <code class="literal">UPDATE</code> command.</p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Using the SQL DELETE command"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec68"/>Using the SQL DELETE command</h1></div></div></div><p>In this<a id="id294" class="indexterm"/> recipe, we will use the SQL <code class="literal">DELETE</code> command to delete the data we created in the previous recipes.</p><p>While deleting data might at first sight sound trivial, once we get a rather large database design in production, things might not be that easy any more.</p><p>Because we have designed our GUI database by relating two tables via a primary to foreign key relation, when we delete certain data we do not end up with orphan records because this database design takes care of cascading deletes.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec176"/>Getting ready</h2></div></div></div><p>This recipe uses the MySQL database, tables, as well as the data inserted into those tables from the previous recipes in this chapter. In order to show how to create orphan records, we will have to change the design of one of our database tables.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec177"/>How to do it…</h2></div></div></div><p>We kept our database design simple by using only two database tables.</p><p>While this works when we delete data, there is always a chance of ending up with orphan records. What this means is that we delete data in one table but somehow do not delete the related data in another SQL table.</p><p>If we create our <code class="literal">quotations</code> table without a foreign key relationship to the <code class="literal">books</code> table, we can end up with orphan records.</p><div class="informalexample"><pre class="programlisting">        # create second Table inside DB -- 
        # No FOREIGN KEY relation to Books Table
        cursor.execute("CREATE TABLE Quotations ( \
                Quote_ID INT AUTO_INCREMENT,      \
                Quotation VARCHAR(250),           \
                Books_Book_ID INT,                \
                PRIMARY KEY (Quote_ID)            \
            ) ENGINE=InnoDB")  </pre></div><p>After inserting data into the <code class="literal">books</code> and <code class="literal">quotations</code> tables, if we execute the same <code class="literal">delete</code> statement as before we are only deleting the book with <code class="literal">Book_ID 1</code>, while the related quotation with the <code class="literal">Books_Book_ID 1</code> is left behind.</p><p>This in an orphaned record. There no longer exists a book record that has a <code class="literal">Book_ID</code> of <code class="literal">1</code>.</p><div class="mediaobject"><img src="images/B04829_07_17.jpg" alt="How to do it…"/></div><p>This <a id="id295" class="indexterm"/>situation can create a mess, which we can avoid by using cascading deletes.</p><p>We do this in the creation of the tables by adding certain database constraints. When we created the table that holds the quotations in a previous recipe, we created our <code class="literal">quotations</code> table with a foreign key constraint that explicitly references the primary key of the books table, linking the two.</p><div class="informalexample"><pre class="programlisting">        # create second Table inside DB
        cursor.execute("CREATE TABLE Quotations ( \
                Quote_ID INT AUTO_INCREMENT,      \
                Quotation VARCHAR(250),           \
                Books_Book_ID INT,                \
                PRIMARY KEY (Quote_ID),           \
                FOREIGN KEY (Books_Book_ID)       \
                    REFERENCES Books(Book_ID)     \
                    ON DELETE CASCADE             \
            ) ENGINE=InnoDB")  </pre></div><p>The <code class="literal">FOREIGN KEY</code> relation includes the <code class="literal">ON DELETE CASCADE</code> attribute, which basically tells our MySQL server to delete related records in this table when the records this foreign key relates to are deleted.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note89"/>Note</h3><p>Without specifying the <code class="literal">ON DELETE CASCADE</code> attribute in the creation of our table we can neither delete nor update our data because an <code class="literal">UPDATE</code> is a <code class="literal">DELETE</code> followed by an <code class="literal">INSERT</code>.</p></div></div><p>Because <a id="id296" class="indexterm"/>of this design, no orphan records will be left behind, which is what we want.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note90"/>Note</h3><p>In MySQL, we have to specify <code class="literal">ENGINE=InnoDB</code> in order to use foreign keys.</p></div></div><p>Let's display the data in our database.</p><div class="informalexample"><pre class="programlisting">#==========================================================
if __name__ == '__main__': 
    # Create class instance
    mySQL = MySQL()
      mySQL.showData()</pre></div><p>This shows us the following data in our database tables:</p><div class="mediaobject"><img src="images/B04829_07_18.jpg" alt="How to do it…"/></div><p>This shows us that we have two records that are related via primary to foreign key relationships.</p><p>When we now delete a record in the <code class="literal">books</code> table, we expect the related record in the <code class="literal">quotations</code> table to also be deleted by a cascading delete.</p><p>Let's try this by executing the following SQL commands in Python:</p><div class="informalexample"><pre class="programlisting">import mysql.connector as mysql
import GuiDBConfig as guiConf

class MySQL():
    #------------------------------------------------------
    def deleteRecord(self):
        # connect to MySQL
        conn, cursor = self.connect()   
        
        self.useGuiDB(cursor)      
         
        # execute command
        cursor.execute("SELECT Book_ID FROM books WHERE Book_Title = 'Design Patterns'")
        primKey = cursor.fetchall()[0][0]
        # print(primKey)
        
        cursor.execute("DELETE FROM books WHERE Book_ID = (%s)", (primKey,))

        # commit transaction
        conn.commit ()
                
        # close cursor and connection
        self.close(cursor, conn)    
#==========================================================
if __name__ == '__main__': 
    # Create class instance
    mySQL = MySQL()
    #------------------------
    mySQL.deleteRecord()
    mySQL.showData()   </pre></div><p>After<a id="id297" class="indexterm"/> executing the preceding commands to delete records, we get the following new results:</p><div class="mediaobject"><img src="images/B04829_07_19.jpg" alt="How to do it…"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note91"/>Note</h3><p>The famous <code class="literal">Design Patterns</code> are gone from our database of favorite quotations…</p></div></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec178"/>How it works…</h2></div></div></div><p>We triggered cascading deletes in this recipe by designing our database in a solid fashion via primary to foreign key relationships with cascading deletes.</p><p>This <a id="id298" class="indexterm"/>keeps our data sane and integral.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note92"/>Note</h3><p>In this recipe and the sample code we have referred to the same table names sometimes starting capitalized and at other times in all lower-case.</p><p>This works for a Windows default installation of MySQL but might not work on Linux unless we change a setting.</p><p>Here is a link to the official MySQL documentation: <a class="ulink" href="http://dev.mysql.com/doc/refman/5.0/en/identifier-case-sensitivity.html">http://dev.mysql.com/doc/refman/5.0/en/identifier-case-sensitivity.html</a></p></div></div><p>In the next recipe, we will use the code of our <code class="literal">MySQL.py</code> module from our Python GUI.</p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Storing and retrieving data from our MySQL database"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec69"/>Storing and retrieving data from our MySQL database</h1></div></div></div><p>We <a id="id299" class="indexterm"/>will use our Python GUI to insert data into <a id="id300" class="indexterm"/>our MySQL database tables. We have<a id="id301" class="indexterm"/> already refactored the GUI we built in previous<a id="id302" class="indexterm"/> recipes in preparation for connecting and using a database.</p><p>We will use two textbox entry widgets into which we can type the book or journal title and the page number. We will also use a ScrolledText widget to type our favorite book quotations into, which we will then store in our MySQL database.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec179"/>Getting ready</h2></div></div></div><p>This recipe will build on the MySQL database and tables we created in previous recipes.</p></div><div class="section" title="How to do it…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec180"/>How to do it…</h2></div></div></div><p>We will insert, retrieve, and modify our favorite quotations using our Python GUI. We have refactored the MySQL tab of our GUI in preparation for this.</p><div class="mediaobject"><img src="images/B04829_07_20.jpg" alt="How to do it…"/></div><p>In <a id="id303" class="indexterm"/>order to make the buttons do something, we will<a id="id304" class="indexterm"/> connect them to callback functions,<a id="id305" class="indexterm"/> as <a id="id306" class="indexterm"/>we did in previous recipes.</p><p>We will display the data in the ScrolledText widget below the buttons.</p><p>In order to do this, we will import the <code class="literal">MySQL.py</code> module, as we did before. All of the code that talks to our MySQL server instance and database resides in this module, which is a form of encapsulating code in the spirit of object-oriented programming.</p><p>We connect the <span class="strong"><strong>Insert Quote</strong></span> button to the following callback function.</p><div class="informalexample"><pre class="programlisting">        # Adding a Button
        self.action = ttk.Button(self.mySQL, text="Insert Quote", command=self.insertQuote)   
        self.action.grid(column=2, row=1)
    # Button callback
    def insertQuote(self):
        title = self.bookTitle.get()
        page = self.pageNumber.get()
        quote = self.quote.get(1.0, tk.END)
        print(title)
        print(quote)
        self.mySQL.insertBooks(title, page, quote)  </pre></div><p>When <a id="id307" class="indexterm"/>we now run our code, we can insert data<a id="id308" class="indexterm"/> from<a id="id309" class="indexterm"/> our <a id="id310" class="indexterm"/>Python GUI into our MySQL database.</p><div class="mediaobject"><img src="images/B04829_07_21.jpg" alt="How to do it…"/></div><p>After entering a book title and book page plus a quotation from the book or movie, we insert the data into our database by clicking the <span class="strong"><strong>Insert Quote</strong></span> button.</p><p>Our current design allows for titles, pages, and a quotation. We can also insert our favorite quotations from movies. While a movie does not have pages, we can use the page column to insert the approximate time when the quotation occurred within the movie.</p><p>Next, we<a id="id311" class="indexterm"/> can verify that all of this data made it<a id="id312" class="indexterm"/> into <a id="id313" class="indexterm"/>our database tables by <a id="id314" class="indexterm"/>issuing the same commands we used previously.</p><div class="mediaobject"><img src="images/B04829_07_22.jpg" alt="How to do it…"/></div><p>After inserting the data, we can verify that it made it into our two MySQL tables by clicking the <span class="strong"><strong>Get Quotes</strong></span> button which then displays the data we inserted into our two MySQL database tables, as shown above.</p><p>Clicking the <span class="strong"><strong>Get Quotes</strong></span> button invokes the callback method we associated with the button click event. This gives us the data that we display in our ScrolledText widget.</p><div class="informalexample"><pre class="programlisting"># Adding a Button
        self.action1 = ttk.Button(self.mySQL, text="Get Quotes", command=self.getQuote)   
        self.action1.grid(column=2, row=2)
    # Button callback
    def getQuote(self):
        allBooks = self.mySQL.showBooks()  
        print(allBooks)
        self.quote.insert(tk.INSERT, allBooks)</pre></div><p>We <a id="id315" class="indexterm"/>use the <code class="literal">self.mySQL</code> class instance variable<a id="id316" class="indexterm"/> to invoke<a id="id317" class="indexterm"/> the <code class="literal">showBooks()</code> method, which is part of the MySQL class<a id="id318" class="indexterm"/> we imported.</p><div class="informalexample"><pre class="programlisting">from B04829_Ch07_MySQL import MySQL
class OOP():
    def __init__(self):
        # create MySQL instance
        self.mySQL = MySQL()

class MySQL():
    #------------------------------------------------------
    def showBooks(self):
        # connect to MySQL
        conn, cursor = self.connect()    
        
        self.useGuiDB(cursor)    
        
        # print results
        cursor.execute("SELECT * FROM Books")
        allBooks = cursor.fetchall()
        print(allBooks)

        # close cursor and connection
        self.close(cursor, conn)   
        
        return allBooks  </pre></div></div><div class="section" title="How it works…"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec181"/>How it works…</h2></div></div></div><p>In this recipe, we imported the Python module that contains all of the coding logic to connect to our MySQL database and know how to insert, update, delete, and display the data.</p><p>We have now connected our Python GUI to this SQL logic.</p></div></div></div>
</body></html>