<html xml:lang="en-US" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<meta charset="utf-8"/>
<meta content="pandoc" name="generator"/>
<title>ch013.xhtml</title>
<link href="../styles/stylesheet1.css" rel="stylesheet" type="text/css"/>
<!-- kobo-style -->
<style id="koboSpanStyle" type="text/css" xmlns="http://www.w3.org/1999/xhtml">.koboSpan { -webkit-text-combine: inherit; }</style>
</head>
<body epub:type="bodymatter">
<section class="level1" data-number="13" id="chapter-9-project-3.1-data-cleaning-base-application">
<h1 data-number="13"><span class="titlemark"><span class="koboSpan" id="kobo.1.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 9</span></span><br/>
<span id="x1-2080009"/><span class="koboSpan" id="kobo.2.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.1: Data Cleaning Base Application</span></h1>
<p><span class="koboSpan" id="kobo.3.1" xmlns="http://www.w3.org/1999/xhtml">Data validation, cleaning, converting, and standardizing are steps required to transform raw data acquired from source applications into something that can be used for analytical purposes. </span><span class="koboSpan" id="kobo.3.2" xmlns="http://www.w3.org/1999/xhtml">Since we started using a small data set of very clean data, we may need to improvise a bit to create some ”dirty” raw data. </span><span class="koboSpan" id="kobo.3.3" xmlns="http://www.w3.org/1999/xhtml">A good alternative is to search for more complicated, raw data.</span></p>
<p><span class="koboSpan" id="kobo.4.1" xmlns="http://www.w3.org/1999/xhtml">This chapter will guide you through the design of a data cleaning application, separate from the raw data acquisition. </span><span class="koboSpan" id="kobo.4.2" xmlns="http://www.w3.org/1999/xhtml">Many details of cleaning, converting, and standardizing will be left for subsequent projects. </span><span class="koboSpan" id="kobo.4.3" xmlns="http://www.w3.org/1999/xhtml">This initial project creates a foundation that will be extended by adding features. </span><span class="koboSpan" id="kobo.4.4" xmlns="http://www.w3.org/1999/xhtml">The idea is to prepare for the goal of a complete data pipeline that starts with acquisition and passes the data through a separate cleaning stage. </span><span class="koboSpan" id="kobo.4.5" xmlns="http://www.w3.org/1999/xhtml">We want to exploit the Linux principle of having applications connected by a shared buffer, often referred to as a shell pipeline.</span></p>
<p><span class="koboSpan" id="kobo.5.1" xmlns="http://www.w3.org/1999/xhtml">This chapter will cover a number of skills related to the design of data validation and cleaning applications:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.6.1" xmlns="http://www.w3.org/1999/xhtml">CLI architecture and how to design a pipeline of processes</span></p></li>
<li><p><span class="koboSpan" id="kobo.7.1" xmlns="http://www.w3.org/1999/xhtml">The core concepts of validating, cleaning, converting, and standardizing raw data</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.8.1" xmlns="http://www.w3.org/1999/xhtml">We won’t address all the aspects of converting and standardizing data in this chapter. </span><span class="koboSpan" id="kobo.8.2" xmlns="http://www.w3.org/1999/xhtml">Projects in </span><a href="ch014.xhtml#x1-22900010"><em><span class="koboSpan" id="kobo.9.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.10.1" xmlns="http://www.w3.org/1999/xhtml"> 10</span></em></a><span class="koboSpan" id="kobo.11.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch014.xhtml#x1-22900010"><em><span class="koboSpan" id="kobo.12.1" xmlns="http://www.w3.org/1999/xhtml">Data Cleaning Features</span></em></a><span class="koboSpan" id="kobo.13.1" xmlns="http://www.w3.org/1999/xhtml"> will expand on many conversion topics. </span><span class="koboSpan" id="kobo.13.2" xmlns="http://www.w3.org/1999/xhtml">The project in </span><a href="ch016.xhtml#x1-27600012"><em><span class="koboSpan" id="kobo.14.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.15.1" xmlns="http://www.w3.org/1999/xhtml"> 12</span></em></a><span class="koboSpan" id="kobo.16.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch016.xhtml#x1-27600012"><em><span class="koboSpan" id="kobo.17.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.8: Integrated Data</span></em> <em><span class="koboSpan" id="kobo.18.1" xmlns="http://www.w3.org/1999/xhtml">Acquisition Web Service</span></em></a><span class="koboSpan" id="kobo.19.1" xmlns="http://www.w3.org/1999/xhtml"> will address the integrated pipeline idea. </span><span class="koboSpan" id="kobo.19.2" xmlns="http://www.w3.org/1999/xhtml">For now, we want to build an adaptable base application that can be extended to add features.</span></p>
<p><span class="koboSpan" id="kobo.20.1" xmlns="http://www.w3.org/1999/xhtml">We’ll start with a description of an idealized data cleaning application. </span><span id="x1-208001r222"/></p>
<section class="level2" data-number="13.1" id="description-11">
<h2 data-number="13.1"><span class="titlemark"><span class="koboSpan" id="kobo.21.1" xmlns="http://www.w3.org/1999/xhtml">9.1 </span></span> <span id="x1-2090001"/><span class="koboSpan" id="kobo.22.1" xmlns="http://www.w3.org/1999/xhtml">Description</span></h2>
<p><span class="koboSpan" id="kobo.23.1" xmlns="http://www.w3.org/1999/xhtml">We need to build a data validating, cleaning, and standardizing application. </span><span class="koboSpan" id="kobo.23.2" xmlns="http://www.w3.org/1999/xhtml">A data inspection notebook is a </span><span id="dx1-209001"/><span class="koboSpan" id="kobo.24.1" xmlns="http://www.w3.org/1999/xhtml">handy starting point for this design work. </span><span class="koboSpan" id="kobo.24.2" xmlns="http://www.w3.org/1999/xhtml">The goal is a fully-automated application to reflect the lessons learned from inspecting the data.</span></p>
<p><span class="koboSpan" id="kobo.25.1" xmlns="http://www.w3.org/1999/xhtml">A data preparation pipeline </span><span id="dx1-209002"/><span class="koboSpan" id="kobo.26.1" xmlns="http://www.w3.org/1999/xhtml">has the following conceptual tasks:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.27.1" xmlns="http://www.w3.org/1999/xhtml">Validate the acquired source text to be sure it’s usable and to mark invalid data for remediation.</span></p></li>
<li><p><span class="koboSpan" id="kobo.28.1" xmlns="http://www.w3.org/1999/xhtml">Clean any invalid raw data where necessary; this expands the available data in those cases where sensible cleaning can be defined.</span></p></li>
<li><p><span class="koboSpan" id="kobo.29.1" xmlns="http://www.w3.org/1999/xhtml">Convert the validated and cleaned source data from text (or bytes) to usable Python objects.</span></p></li>
<li><p><span class="koboSpan" id="kobo.30.1" xmlns="http://www.w3.org/1999/xhtml">Where necessary, standardize the code or ranges of source data. </span><span class="koboSpan" id="kobo.30.2" xmlns="http://www.w3.org/1999/xhtml">The requirements here vary with the problem domain.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.31.1" xmlns="http://www.w3.org/1999/xhtml">The goal is to create clean, standardized data for subsequent analysis. </span><span class="koboSpan" id="kobo.31.2" xmlns="http://www.w3.org/1999/xhtml">Surprises occur all the time. </span><span class="koboSpan" id="kobo.31.3" xmlns="http://www.w3.org/1999/xhtml">There are several sources:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.32.1" xmlns="http://www.w3.org/1999/xhtml">Technical problems with file formats of the upstream software. </span><span class="koboSpan" id="kobo.32.2" xmlns="http://www.w3.org/1999/xhtml">The intent of the acquisition program is to isolate physical format issues.</span></p></li>
<li><p><span class="koboSpan" id="kobo.33.1" xmlns="http://www.w3.org/1999/xhtml">Data representation problems with the source data. </span><span class="koboSpan" id="kobo.33.2" xmlns="http://www.w3.org/1999/xhtml">The intent of this project is to isolate the validity and standardization of the values.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.34.1" xmlns="http://www.w3.org/1999/xhtml">Once cleaned, the data itself may still contain surprising relationships, trends, or distributions. </span><span class="koboSpan" id="kobo.34.2" xmlns="http://www.w3.org/1999/xhtml">This is discovered with later projects that create analytic notebooks and reports. </span><span class="koboSpan" id="kobo.34.3" xmlns="http://www.w3.org/1999/xhtml">Sometimes a surprise comes from finding the </span><em><span class="koboSpan" id="kobo.35.1" xmlns="http://www.w3.org/1999/xhtml">Null Hypothesis </span></em><span class="koboSpan" id="kobo.36.1" xmlns="http://www.w3.org/1999/xhtml">is true and the data only shows insignificant random variation.</span></p>
<p><span class="koboSpan" id="kobo.37.1" xmlns="http://www.w3.org/1999/xhtml">In many practical cases, the first three steps — validate, clean, and convert — are often combined into a single function call. </span><span class="koboSpan" id="kobo.37.2" xmlns="http://www.w3.org/1999/xhtml">For example, when dealing with numeric values, the </span><code><span class="koboSpan" id="kobo.38.1" xmlns="http://www.w3.org/1999/xhtml">int()</span></code><span class="koboSpan" id="kobo.39.1" xmlns="http://www.w3.org/1999/xhtml"> or </span><code><span class="koboSpan" id="kobo.40.1" xmlns="http://www.w3.org/1999/xhtml">float()</span></code><span class="koboSpan" id="kobo.41.1" xmlns="http://www.w3.org/1999/xhtml"> functions will validate and convert a value, raising an exception for invalid numbers.</span></p>
<p><span class="koboSpan" id="kobo.42.1" xmlns="http://www.w3.org/1999/xhtml">In a few edge cases, these steps </span><span id="dx1-209003"/><span class="koboSpan" id="kobo.43.1" xmlns="http://www.w3.org/1999/xhtml">need to be considered in isolation – often because there’s a tangled interaction between validation and cleaning. </span><span class="koboSpan" id="kobo.43.2" xmlns="http://www.w3.org/1999/xhtml">For example, some data is plagued by dropping the leading zeros from US postal codes. </span><span class="koboSpan" id="kobo.43.3" xmlns="http://www.w3.org/1999/xhtml">This can be a tangled problem where the data is superficially invalid but can be reliably cleaned before attempting validation. </span><span class="koboSpan" id="kobo.43.4" xmlns="http://www.w3.org/1999/xhtml">In this case, validating the postal code against an official list of codes comes after cleaning, not before. </span><span class="koboSpan" id="kobo.43.5" xmlns="http://www.w3.org/1999/xhtml">Since the data will remain as text, there’s no actual conversion step after the clean-and-validate composite step. </span><span id="x1-209004r224"/></p>
<section class="level3" data-number="13.1.1" id="user-experience-1">
<h3 data-number="13.1.1"><span class="titlemark"><span class="koboSpan" id="kobo.44.1" xmlns="http://www.w3.org/1999/xhtml">9.1.1 </span></span> <span id="x1-2100001"/><span class="koboSpan" id="kobo.45.1" xmlns="http://www.w3.org/1999/xhtml">User experience</span></h3>
<p><span class="koboSpan" id="kobo.46.1" xmlns="http://www.w3.org/1999/xhtml">The overall </span><strong><span class="koboSpan" id="kobo.47.1" xmlns="http://www.w3.org/1999/xhtml">User Experience </span></strong><span class="koboSpan" id="kobo.48.1" xmlns="http://www.w3.org/1999/xhtml">(</span><strong><span class="koboSpan" id="kobo.49.1" xmlns="http://www.w3.org/1999/xhtml">UX</span></strong><span class="koboSpan" id="kobo.50.1" xmlns="http://www.w3.org/1999/xhtml">) will be </span><span id="dx1-210001"/><span class="koboSpan" id="kobo.51.1" xmlns="http://www.w3.org/1999/xhtml">two command-line applications. </span><span class="koboSpan" id="kobo.51.2" xmlns="http://www.w3.org/1999/xhtml">The first application will </span><span id="dx1-210002"/><span class="koboSpan" id="kobo.52.1" xmlns="http://www.w3.org/1999/xhtml">acquire the raw data, and the second will clean the data. </span><span class="koboSpan" id="kobo.52.2" xmlns="http://www.w3.org/1999/xhtml">Each has options to fine-tune the </span><code><span class="koboSpan" id="kobo.53.1" xmlns="http://www.w3.org/1999/xhtml">acquire</span></code><span class="koboSpan" id="kobo.54.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.55.1" xmlns="http://www.w3.org/1999/xhtml">cleanse</span></code><span class="koboSpan" id="kobo.56.1" xmlns="http://www.w3.org/1999/xhtml"> steps.</span></p>
<p><span class="koboSpan" id="kobo.57.1" xmlns="http://www.w3.org/1999/xhtml">There are several variations on the </span><code><span class="koboSpan" id="kobo.58.1" xmlns="http://www.w3.org/1999/xhtml">acquire</span></code><span class="koboSpan" id="kobo.59.1" xmlns="http://www.w3.org/1999/xhtml"> command, shown in earlier chapters. </span><span class="koboSpan" id="kobo.59.2" xmlns="http://www.w3.org/1999/xhtml">Most notably, </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.60.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.61.1" xmlns="http://www.w3.org/1999/xhtml"> 3</span></em></a><span class="koboSpan" id="kobo.62.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.63.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.1: Data Acquisition Base Application</span></em></a><span class="koboSpan" id="kobo.64.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch008.xhtml#x1-780004"><em><span class="koboSpan" id="kobo.65.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.66.1" xmlns="http://www.w3.org/1999/xhtml"> 4</span></em></a><span class="koboSpan" id="kobo.67.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch008.xhtml#x1-780004"><em><span class="koboSpan" id="kobo.68.1" xmlns="http://www.w3.org/1999/xhtml">Data Acquisition Features: Web APIs and Scraping</span></em></a><span class="koboSpan" id="kobo.69.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><a href="ch009.xhtml#x1-1140005"><em><span class="koboSpan" id="kobo.70.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.71.1" xmlns="http://www.w3.org/1999/xhtml"> 5</span></em></a><span class="koboSpan" id="kobo.72.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch009.xhtml#x1-1140005"><em><span class="koboSpan" id="kobo.73.1" xmlns="http://www.w3.org/1999/xhtml">Data Acquisition Features: SQL Database</span></em></a><span class="koboSpan" id="kobo.74.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.75.1" xmlns="http://www.w3.org/1999/xhtml">For the </span><strong><span class="koboSpan" id="kobo.76.1" xmlns="http://www.w3.org/1999/xhtml">clean </span></strong><span class="koboSpan" id="kobo.77.1" xmlns="http://www.w3.org/1999/xhtml">application, the expected command-line should like something like this:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-150">
<div class="tcolorbox-content">
<pre class="console"><span class="koboSpan" id="kobo.78.1" xmlns="http://www.w3.org/1999/xhtml">% python src/clean.py -o analysis -i quartet/Series_1.ndjson</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.79.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.80.1" xmlns="http://www.w3.org/1999/xhtml">-o</span></code><code><span class="koboSpan" id="kobo.81.1" xmlns="http://www.w3.org/1999/xhtml"> analysis</span></code><span class="koboSpan" id="kobo.82.1" xmlns="http://www.w3.org/1999/xhtml"> specifies a directory into which the resulting clean data is written.</span></p>
<p><span class="koboSpan" id="kobo.83.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.84.1" xmlns="http://www.w3.org/1999/xhtml">-i</span></code><code><span class="koboSpan" id="kobo.85.1" xmlns="http://www.w3.org/1999/xhtml"> quartet/Series_1.ndjson</span></code><span class="koboSpan" id="kobo.86.1" xmlns="http://www.w3.org/1999/xhtml"> specifies the path to the source data file. </span><span class="koboSpan" id="kobo.86.2" xmlns="http://www.w3.org/1999/xhtml">This is a file written by the acquisition application.</span></p>
<p><span class="koboSpan" id="kobo.87.1" xmlns="http://www.w3.org/1999/xhtml">Note that we’re not using a positional argument to name the input file. </span><span class="koboSpan" id="kobo.87.2" xmlns="http://www.w3.org/1999/xhtml">The use of a positional argument for a filename is a common provision in many — but not all — Linux commands. </span><span class="koboSpan" id="kobo.87.3" xmlns="http://www.w3.org/1999/xhtml">The reason to </span><span id="dx1-210004"/><span class="koboSpan" id="kobo.88.1" xmlns="http://www.w3.org/1999/xhtml">avoid positional arguments is to make it easier to adapt this to become part of a pipeline of processing stages.</span></p>
<p><span class="koboSpan" id="kobo.89.1" xmlns="http://www.w3.org/1999/xhtml">Specifically, we’d like the following to work, also:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-151">
<div class="tcolorbox-content">
<pre class="console"><span class="koboSpan" id="kobo.90.1" xmlns="http://www.w3.org/1999/xhtml">% python src/acquire.py -s Series_1Pair --csv source.csv | \
    python src/clean.py -o analysis/Series_1.ndjson</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.91.1" xmlns="http://www.w3.org/1999/xhtml">This shell line has two commands, one to do the raw data acquisition, and the other to perform the validation and cleaning. </span><span class="koboSpan" id="kobo.91.2" xmlns="http://www.w3.org/1999/xhtml">The acquisition command uses the </span><code><span class="koboSpan" id="kobo.92.1" xmlns="http://www.w3.org/1999/xhtml">-s</span></code><code><span class="koboSpan" id="kobo.93.1" xmlns="http://www.w3.org/1999/xhtml"> Series_1Pair</span></code><span class="koboSpan" id="kobo.94.1" xmlns="http://www.w3.org/1999/xhtml"> argument to name a specific series extraction class. </span><span class="koboSpan" id="kobo.94.2" xmlns="http://www.w3.org/1999/xhtml">This class will be used to create a single series as output. </span><span class="koboSpan" id="kobo.94.3" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.95.1" xmlns="http://www.w3.org/1999/xhtml">--csv</span></code><code><span class="koboSpan" id="kobo.96.1" xmlns="http://www.w3.org/1999/xhtml"> source.csv</span></code><span class="koboSpan" id="kobo.97.1" xmlns="http://www.w3.org/1999/xhtml"> argument names the input file to process. </span><span class="koboSpan" id="kobo.97.2" xmlns="http://www.w3.org/1999/xhtml">Other options could name RESTful APIs or provide a database connection string.</span></p>
<p><span class="koboSpan" id="kobo.98.1" xmlns="http://www.w3.org/1999/xhtml">The second command reads the output from the first command and writes this to a file. </span><span class="koboSpan" id="kobo.98.2" xmlns="http://www.w3.org/1999/xhtml">The file is named by the </span><code><span class="koboSpan" id="kobo.99.1" xmlns="http://www.w3.org/1999/xhtml">-o</span></code><span class="koboSpan" id="kobo.100.1" xmlns="http://www.w3.org/1999/xhtml"> argument value in the second command.</span></p>
<p><span class="koboSpan" id="kobo.101.1" xmlns="http://www.w3.org/1999/xhtml">This pipeline concept, made available with the shell’s </span><code><span class="koboSpan" id="kobo.102.1" xmlns="http://www.w3.org/1999/xhtml">|</span></code><span class="koboSpan" id="kobo.103.1" xmlns="http://www.w3.org/1999/xhtml"> operator, means these two processes will run concurrently. </span><span class="koboSpan" id="kobo.103.2" xmlns="http://www.w3.org/1999/xhtml">This means data is passed from one process to the other as it becomes available. </span><span class="koboSpan" id="kobo.103.3" xmlns="http://www.w3.org/1999/xhtml">For very large source files, cleaning data as it’s being acquired can reduce processing time dramatically.</span></p>
<p><span class="koboSpan" id="kobo.104.1" xmlns="http://www.w3.org/1999/xhtml">In </span><a href="ch014.xhtml#x1-2510005"><em><span class="koboSpan" id="kobo.105.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.6: Integration to create an acquisition pipeline</span></em></a><span class="koboSpan" id="kobo.106.1" xmlns="http://www.w3.org/1999/xhtml"> we’ll expand on this design to include some ideas for concurrent processing.</span></p>
<p><span class="koboSpan" id="kobo.107.1" xmlns="http://www.w3.org/1999/xhtml">Now that we’ve seen an overview of the application’s purpose, let’s take a look at the source data. </span><span id="x1-210007r227"/></p>
</section>
<section class="level3" data-number="13.1.2" id="source-data">
<h3 data-number="13.1.2"><span class="titlemark"><span class="koboSpan" id="kobo.108.1" xmlns="http://www.w3.org/1999/xhtml">9.1.2 </span></span> <span id="x1-2110002"/><span class="koboSpan" id="kobo.109.1" xmlns="http://www.w3.org/1999/xhtml">Source data</span></h3>
<p><span class="koboSpan" id="kobo.110.1" xmlns="http://www.w3.org/1999/xhtml">The earlier projects produced source data in an approximately consistent format. </span><span class="koboSpan" id="kobo.110.2" xmlns="http://www.w3.org/1999/xhtml">These projects focused on acquiring </span><span id="dx1-211001"/><span class="koboSpan" id="kobo.111.1" xmlns="http://www.w3.org/1999/xhtml">data that is text. </span><span class="koboSpan" id="kobo.111.2" xmlns="http://www.w3.org/1999/xhtml">The individual samples were transformed into small JSON-friendly dictionaries, using the NDJSON format. </span><span class="koboSpan" id="kobo.111.3" xmlns="http://www.w3.org/1999/xhtml">This can simplify the validation and cleaning operation.</span></p>
<p><span class="koboSpan" id="kobo.112.1" xmlns="http://www.w3.org/1999/xhtml">The NDJSON file </span><span id="dx1-211002"/><span class="koboSpan" id="kobo.113.1" xmlns="http://www.w3.org/1999/xhtml">format is described at </span><a class="url" href="http://ndjson.org"><span class="koboSpan" id="kobo.114.1" xmlns="http://www.w3.org/1999/xhtml">http://ndjson.org</span></a><span class="koboSpan" id="kobo.115.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><a class="url" href="https://jsonlines.org"><span class="koboSpan" id="kobo.116.1" xmlns="http://www.w3.org/1999/xhtml">https://jsonlines.org</span></a><span class="koboSpan" id="kobo.117.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.118.1" xmlns="http://www.w3.org/1999/xhtml">There are two design principles behind the </span><strong><span class="koboSpan" id="kobo.119.1" xmlns="http://www.w3.org/1999/xhtml">acquire </span></strong><span class="koboSpan" id="kobo.120.1" xmlns="http://www.w3.org/1999/xhtml">application:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.121.1" xmlns="http://www.w3.org/1999/xhtml">Preserve the original source data as much as possible.</span></p></li>
<li><p><span class="koboSpan" id="kobo.122.1" xmlns="http://www.w3.org/1999/xhtml">Perform the fewest text transformations needed during acquisition.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.123.1" xmlns="http://www.w3.org/1999/xhtml">Preserving the source data makes it slightly easier to locate problems when there are unexpected changes to source applications. </span><span class="koboSpan" id="kobo.123.2" xmlns="http://www.w3.org/1999/xhtml">Minimizing the text transformations, similarly, keeps the data closer to the source. </span><span class="koboSpan" id="kobo.123.3" xmlns="http://www.w3.org/1999/xhtml">Moving from a variety of representations to a single representation simplifies the data cleaning and transformation steps.</span></p>
<p><span class="koboSpan" id="kobo.124.1" xmlns="http://www.w3.org/1999/xhtml">All of the data acquisition projects involve some kind of textual transformation from a source representation to ND JSON.</span></p>
<div class="center">
<div class="tabular">
<table class="tabular" id="TBL-2">
<tbody>
<tr class="odd hline">
<td><hr/>
</td>
<td><hr/>
</td>
<td><hr/>
</td>
<td><hr/>
</td>
</tr>
<tr class="even" id="TBL-2-1-" style="vertical-align:baseline;">
<td class="td11" id="TBL-2-1-1" style="text-align: center; white-space: nowrap;"><strong><span class="koboSpan" id="kobo.125.1" xmlns="http://www.w3.org/1999/xhtml">Chapter </span></strong></td>
<td class="td11" id="TBL-2-1-2" style="text-align: center; white-space: nowrap;"><strong><span class="koboSpan" id="kobo.126.1" xmlns="http://www.w3.org/1999/xhtml">Section </span></strong></td>
<td class="td11" id="TBL-2-1-3" style="text-align: center; white-space: nowrap;"><strong><span class="koboSpan" id="kobo.127.1" xmlns="http://www.w3.org/1999/xhtml">Source </span></strong></td>
<td/>
</tr>
<tr class="odd hline">
<td><hr/>
</td>
<td><hr/>
</td>
<td><hr/>
</td>
<td><hr/>
</td>
</tr>
<tr class="even" id="TBL-2-2-" style="vertical-align:baseline;">
<td class="td11" id="TBL-2-2-1" style="text-align: center; white-space: nowrap;"><a href="ch007.xhtml#x1-560003"><span class="koboSpan" id="kobo.128.1" xmlns="http://www.w3.org/1999/xhtml">3</span></a></td>
<td class="td11" id="TBL-2-2-2" style="text-align: center; white-space: nowrap;"><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.129.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.130.1" xmlns="http://www.w3.org/1999/xhtml"> 3</span></em></a><span class="koboSpan" id="kobo.131.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.132.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.1: Data Acquisition Base Application</span></em></a></td>
<td class="td11" id="TBL-2-2-3" style="text-align: center; white-space: nowrap;"><span class="koboSpan" id="kobo.133.1" xmlns="http://www.w3.org/1999/xhtml">CSV parsing</span></td>
<td/>
</tr>
<tr class="odd" id="TBL-2-3-" style="vertical-align:baseline;">
<td class="td11" id="TBL-2-3-1" style="text-align: center; white-space: nowrap;"><a href="ch008.xhtml#x1-780004"><span class="koboSpan" id="kobo.134.1" xmlns="http://www.w3.org/1999/xhtml">4</span></a></td>
<td class="td11" id="TBL-2-3-2" style="text-align: center; white-space: nowrap;"><a href="ch008.xhtml#x1-790001"><em><span class="koboSpan" id="kobo.135.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.2: Acquire data from a web service</span></em></a></td>
<td class="td11" id="TBL-2-3-3" style="text-align: center; white-space: nowrap;"><span class="koboSpan" id="kobo.136.1" xmlns="http://www.w3.org/1999/xhtml">Zipped CSV or JSON</span></td>
<td/>
</tr>
<tr class="even" id="TBL-2-4-" style="vertical-align:baseline;">
<td class="td11" id="TBL-2-4-1" style="text-align: center; white-space: nowrap;"><a href="ch008.xhtml#x1-780004"><span class="koboSpan" id="kobo.137.1" xmlns="http://www.w3.org/1999/xhtml">4</span></a></td>
<td class="td11" id="TBL-2-4-2" style="text-align: center; white-space: nowrap;"><a href="ch008.xhtml#x1-970002"><em><span class="koboSpan" id="kobo.138.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.3: Scrape data from a web page</span></em></a></td>
<td class="td11" id="TBL-2-4-3" style="text-align: center; white-space: nowrap;"><span class="koboSpan" id="kobo.139.1" xmlns="http://www.w3.org/1999/xhtml">HTML</span></td>
<td/>
</tr>
<tr class="odd" id="TBL-2-5-" style="vertical-align:baseline;">
<td class="td11" id="TBL-2-5-1" style="text-align: center; white-space: nowrap;"><a href="ch009.xhtml#x1-1140005"><span class="koboSpan" id="kobo.140.1" xmlns="http://www.w3.org/1999/xhtml">5</span></a></td>
<td class="td11" id="TBL-2-5-2" style="text-align: center; white-space: nowrap;"><a href="ch009.xhtml#x1-1260002"><em><span class="koboSpan" id="kobo.141.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.5: Acquire data from a SQL extract</span></em></a></td>
<td class="td11" id="TBL-2-5-3" style="text-align: center; white-space: nowrap;"><span class="koboSpan" id="kobo.142.1" xmlns="http://www.w3.org/1999/xhtml">SQL Extract</span></td>
<td/>
</tr>
<tr class="even hline">
<td><hr/>
</td>
<td><hr/>
</td>
<td><hr/>
</td>
<td><hr/>
</td>
</tr>
<tr class="odd" id="TBL-2-6-" style="vertical-align:baseline;">
<td class="td11" id="TBL-2-6-1" style="text-align: center; white-space: nowrap;"/>
<td/>
<td/>
<td/>
</tr>
</tbody>
</table>
</div>
</div>
<p><span class="koboSpan" id="kobo.143.1" xmlns="http://www.w3.org/1999/xhtml">In some cases — i.e., extracting HTML — the textual changes to peel the markup away from the data is profound. </span><span class="koboSpan" id="kobo.143.2" xmlns="http://www.w3.org/1999/xhtml">The SQL database extract involves undoing the database’s internal representation of numbers or dates and writing the values as text. </span><span class="koboSpan" id="kobo.143.3" xmlns="http://www.w3.org/1999/xhtml">In some cases, the text transformations are minor. </span><span id="x1-211003r228"/></p>
</section>
<section class="level3" data-number="13.1.3" id="result-data">
<h3 data-number="13.1.3"><span class="titlemark"><span class="koboSpan" id="kobo.144.1" xmlns="http://www.w3.org/1999/xhtml">9.1.3 </span></span> <span id="x1-2120003"/><span class="koboSpan" id="kobo.145.1" xmlns="http://www.w3.org/1999/xhtml">Result data</span></h3>
<p><span class="koboSpan" id="kobo.146.1" xmlns="http://www.w3.org/1999/xhtml">The cleaned output files will be ND JSON; similar to the raw input files. </span><span class="koboSpan" id="kobo.146.2" xmlns="http://www.w3.org/1999/xhtml">We’ll address this output file </span><span id="dx1-212001"/><span class="koboSpan" id="kobo.147.1" xmlns="http://www.w3.org/1999/xhtml">format in detail in </span><a href="ch015.xhtml#x1-26400011"><em><span class="koboSpan" id="kobo.148.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.149.1" xmlns="http://www.w3.org/1999/xhtml"> 11</span></em></a><span class="koboSpan" id="kobo.150.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch015.xhtml#x1-26400011"><em><span class="koboSpan" id="kobo.151.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.7: Interim Data</span></em> <em><span class="koboSpan" id="kobo.152.1" xmlns="http://www.w3.org/1999/xhtml">Persistence</span></em></a><span class="koboSpan" id="kobo.153.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.153.2" xmlns="http://www.w3.org/1999/xhtml">For this project, it’s easiest to stick with writing the JSON representation of a Pydantic dataclass.</span></p>
<p><span class="koboSpan" id="kobo.154.1" xmlns="http://www.w3.org/1999/xhtml">For Python’s native </span><code><span class="koboSpan" id="kobo.155.1" xmlns="http://www.w3.org/1999/xhtml">dataclasses</span></code><span class="koboSpan" id="kobo.156.1" xmlns="http://www.w3.org/1999/xhtml">, the </span><code><span class="koboSpan" id="kobo.157.1" xmlns="http://www.w3.org/1999/xhtml">dataclasses.asdict()</span></code><span class="koboSpan" id="kobo.158.1" xmlns="http://www.w3.org/1999/xhtml"> function will produce a dictionary from a dataclass instance. </span><span class="koboSpan" id="kobo.158.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.159.1" xmlns="http://www.w3.org/1999/xhtml">json.dumps()</span></code><span class="koboSpan" id="kobo.160.1" xmlns="http://www.w3.org/1999/xhtml"> function will convert this to text in JSON syntax.</span></p>
<p><span class="koboSpan" id="kobo.161.1" xmlns="http://www.w3.org/1999/xhtml">For Pydantic dataclasses, however, the </span><code><span class="koboSpan" id="kobo.162.1" xmlns="http://www.w3.org/1999/xhtml">asdict()</span></code><span class="koboSpan" id="kobo.163.1" xmlns="http://www.w3.org/1999/xhtml"> function can’t be used. </span><span class="koboSpan" id="kobo.163.2" xmlns="http://www.w3.org/1999/xhtml">There’s no built-in method for emitting the JSON representation of a </span><code><span class="koboSpan" id="kobo.164.1" xmlns="http://www.w3.org/1999/xhtml">pydantic</span></code><span class="koboSpan" id="kobo.165.1" xmlns="http://www.w3.org/1999/xhtml"> dataclass instance.</span></p>
<p><span class="koboSpan" id="kobo.166.1" xmlns="http://www.w3.org/1999/xhtml">For version 1 of </span><strong><span class="koboSpan" id="kobo.167.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic</span></strong><span class="koboSpan" id="kobo.168.1" xmlns="http://www.w3.org/1999/xhtml">, a slight change is required to write ND JSON. </span><span class="koboSpan" id="kobo.168.2" xmlns="http://www.w3.org/1999/xhtml">An expression like the following will emit a JSON serialization of a </span><code><span class="koboSpan" id="kobo.169.1" xmlns="http://www.w3.org/1999/xhtml">pydantic</span></code><span class="koboSpan" id="kobo.170.1" xmlns="http://www.w3.org/1999/xhtml"> dataclass:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-152">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.171.1" xmlns="http://www.w3.org/1999/xhtml">import json
from pydantic.json import pydantic_encoder
from typing import TextIO, Iterable

import analysis_model

def persist_samples(
        target_file: TextIO,
        analysis_samples: Iterable[analysis_model.SeriesSample | None]
) -&gt; int:
    count = 0
    for result in filter(None, analysis_samples):
        target_file.write(json.dumps(result, default=pydantic_encoder))
        target_file.write("\n")
        count += 1
    return count</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.172.1" xmlns="http://www.w3.org/1999/xhtml">This central feature is the </span><code><span class="koboSpan" id="kobo.173.1" xmlns="http://www.w3.org/1999/xhtml">default=pydantic_encoder</span></code><span class="koboSpan" id="kobo.174.1" xmlns="http://www.w3.org/1999/xhtml"> argument value for the </span><code><span class="koboSpan" id="kobo.175.1" xmlns="http://www.w3.org/1999/xhtml">json.dumps()</span></code><span class="koboSpan" id="kobo.176.1" xmlns="http://www.w3.org/1999/xhtml"> function. </span><span class="koboSpan" id="kobo.176.2" xmlns="http://www.w3.org/1999/xhtml">This will handle the proper decoding of the dataclass structure into JSON notation.</span></p>
<p><span class="koboSpan" id="kobo.177.1" xmlns="http://www.w3.org/1999/xhtml">For version 2 of </span><strong><span class="koboSpan" id="kobo.178.1" xmlns="http://www.w3.org/1999/xhtml">pydantic</span></strong><span class="koboSpan" id="kobo.179.1" xmlns="http://www.w3.org/1999/xhtml">, there will be a slightly different approach. </span><span class="koboSpan" id="kobo.179.2" xmlns="http://www.w3.org/1999/xhtml">This makes use of a </span><code><span class="koboSpan" id="kobo.180.1" xmlns="http://www.w3.org/1999/xhtml">RootModel[classname](object)</span></code><span class="koboSpan" id="kobo.181.1" xmlns="http://www.w3.org/1999/xhtml"> construct to extract the root model for a given class from an object. </span><span class="koboSpan" id="kobo.181.2" xmlns="http://www.w3.org/1999/xhtml">In this case, </span><code><span class="koboSpan" id="kobo.182.1" xmlns="http://www.w3.org/1999/xhtml">RootModel[SeriesSample](result).model_dump()</span></code><span class="koboSpan" id="kobo.183.1" xmlns="http://www.w3.org/1999/xhtml"> will create a root model that can emit a </span><span id="dx1-212018"/><span class="koboSpan" id="kobo.184.1" xmlns="http://www.w3.org/1999/xhtml">nested dictionary structure. </span><span class="koboSpan" id="kobo.184.2" xmlns="http://www.w3.org/1999/xhtml">No special </span><code><span class="koboSpan" id="kobo.185.1" xmlns="http://www.w3.org/1999/xhtml">pydantic_encoder</span></code><span class="koboSpan" id="kobo.186.1" xmlns="http://www.w3.org/1999/xhtml"> will be required for version 2.</span></p>
<p><span class="koboSpan" id="kobo.187.1" xmlns="http://www.w3.org/1999/xhtml">Now that we’ve looked at the inputs and outputs, we can survey the processing concepts. </span><span class="koboSpan" id="kobo.187.2" xmlns="http://www.w3.org/1999/xhtml">Additional processing details will wait for later projects. </span><span id="x1-212019r229"/></p>
</section>
<section class="level3" data-number="13.1.4" id="conversions-and-processing">
<h3 data-number="13.1.4"><span class="titlemark"><span class="koboSpan" id="kobo.188.1" xmlns="http://www.w3.org/1999/xhtml">9.1.4 </span></span> <span id="x1-2130004"/><span class="koboSpan" id="kobo.189.1" xmlns="http://www.w3.org/1999/xhtml">Conversions and processing</span></h3>
<p><span class="koboSpan" id="kobo.190.1" xmlns="http://www.w3.org/1999/xhtml">For this project, we’re trying to minimize the processing complications. </span><span class="koboSpan" id="kobo.190.2" xmlns="http://www.w3.org/1999/xhtml">In the next chapter, </span><a href="ch014.xhtml#x1-22900010"><em><span class="koboSpan" id="kobo.191.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.192.1" xmlns="http://www.w3.org/1999/xhtml"> 10</span></em></a><span class="koboSpan" id="kobo.193.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch014.xhtml#x1-22900010"><em><span class="koboSpan" id="kobo.194.1" xmlns="http://www.w3.org/1999/xhtml">Data Cleaning Features</span></em></a><span class="koboSpan" id="kobo.195.1" xmlns="http://www.w3.org/1999/xhtml">, we’ll look at a number of additional processing requirements that will add complications. </span><span class="koboSpan" id="kobo.195.2" xmlns="http://www.w3.org/1999/xhtml">As a teaser for the </span><span id="dx1-213001"/><span class="koboSpan" id="kobo.196.1" xmlns="http://www.w3.org/1999/xhtml">projects in the next chapter, we’ll describe some of the kinds of field-level validation, cleaning, and conversion that may be required.</span></p>
<p><span class="koboSpan" id="kobo.197.1" xmlns="http://www.w3.org/1999/xhtml">One example we’ve focused on, Anscombe’s Quartet data, needs to be converted to a series of floating-point values. </span><span class="koboSpan" id="kobo.197.2" xmlns="http://www.w3.org/1999/xhtml">While this is painfully obvious, we’ve held off on the conversion from the text to the Python </span><code><span class="koboSpan" id="kobo.198.1" xmlns="http://www.w3.org/1999/xhtml">float</span></code><span class="koboSpan" id="kobo.199.1" xmlns="http://www.w3.org/1999/xhtml"> object to illustrate the more general principle of separating the complications of acquiring data from analyzing the data. </span><span class="koboSpan" id="kobo.199.2" xmlns="http://www.w3.org/1999/xhtml">The output from this application will have each resulting ND JSON document with </span><code><span class="koboSpan" id="kobo.200.1" xmlns="http://www.w3.org/1999/xhtml">float</span></code><span class="koboSpan" id="kobo.201.1" xmlns="http://www.w3.org/1999/xhtml"> values instead of </span><code><span class="koboSpan" id="kobo.202.1" xmlns="http://www.w3.org/1999/xhtml">string</span></code><span class="koboSpan" id="kobo.203.1" xmlns="http://www.w3.org/1999/xhtml"> values.</span></p>
<p><span class="koboSpan" id="kobo.204.1" xmlns="http://www.w3.org/1999/xhtml">The distinction in the JSON documents will be tiny: the use of </span><code><span class="koboSpan" id="kobo.205.1" xmlns="http://www.w3.org/1999/xhtml">"</span></code><span class="koboSpan" id="kobo.206.1" xmlns="http://www.w3.org/1999/xhtml"> for the raw-data strings. </span><span class="koboSpan" id="kobo.206.2" xmlns="http://www.w3.org/1999/xhtml">This will be omitted for the </span><code><span class="koboSpan" id="kobo.207.1" xmlns="http://www.w3.org/1999/xhtml">float</span></code><span class="koboSpan" id="kobo.208.1" xmlns="http://www.w3.org/1999/xhtml"> values.</span></p>
<p><span class="koboSpan" id="kobo.209.1" xmlns="http://www.w3.org/1999/xhtml">This tiny detail is important because every data set will have distinct conversion requirements. </span><span class="koboSpan" id="kobo.209.2" xmlns="http://www.w3.org/1999/xhtml">The data inspection notebook will reveal data domains like text, integers, date-time stamps, durations, and a mixture of more specialized domains. </span><span class="koboSpan" id="kobo.209.3" xmlns="http://www.w3.org/1999/xhtml">It’s essential to examine the data before trusting any schema definition or documentation about the data.</span></p>
<p><span class="koboSpan" id="kobo.210.1" xmlns="http://www.w3.org/1999/xhtml">We’ll look at three common kinds of complications:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.211.1" xmlns="http://www.w3.org/1999/xhtml">Fields that must be decomposed.</span></p></li>
<li><p><span class="koboSpan" id="kobo.212.1" xmlns="http://www.w3.org/1999/xhtml">Fields which must be composed.</span></p></li>
<li><p><span class="koboSpan" id="kobo.213.1" xmlns="http://www.w3.org/1999/xhtml">Unions of sample types in a single collection.</span></p></li>
<li><p><span class="koboSpan" id="kobo.214.1" xmlns="http://www.w3.org/1999/xhtml">”Opaque” codes used to replace particularly sensitive information.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.215.1" xmlns="http://www.w3.org/1999/xhtml">One complication is when multiple source values are collapsed into a single field. </span><span class="koboSpan" id="kobo.215.2" xmlns="http://www.w3.org/1999/xhtml">This single source value will need to be decomposed into multiple values for analysis. </span><span class="koboSpan" id="kobo.215.3" xmlns="http://www.w3.org/1999/xhtml">With the very clean data sets available from Kaggle, a need for decomposition is unusual. </span><span class="koboSpan" id="kobo.215.4" xmlns="http://www.w3.org/1999/xhtml">Enterprise data sets, on the other hand, will often have fields that are not properly decomposed into atomic values, reflecting optimizations or legacy processing requirements. </span><span class="koboSpan" id="kobo.215.5" xmlns="http://www.w3.org/1999/xhtml">For example, a product ID code may include a </span><span id="dx1-213002"/><span class="koboSpan" id="kobo.216.1" xmlns="http://www.w3.org/1999/xhtml">line of business and a year of introduction as part of the code. </span><span class="koboSpan" id="kobo.216.2" xmlns="http://www.w3.org/1999/xhtml">For example, a boat’s hull ID number might include ”421880182,” meaning it’s a 42-foot hull, serial number 188, completed in January 1982. </span><span class="koboSpan" id="kobo.216.3" xmlns="http://www.w3.org/1999/xhtml">Three disparate items were all coded as digits. </span><span class="koboSpan" id="kobo.216.4" xmlns="http://www.w3.org/1999/xhtml">For analytical purposes, it may be necessary to separate the items that comprise the coded value. </span><span class="koboSpan" id="kobo.216.5" xmlns="http://www.w3.org/1999/xhtml">In other cases, several source fields will need to be combined. </span><span class="koboSpan" id="kobo.216.6" xmlns="http://www.w3.org/1999/xhtml">An example data set where a timestamp is decomposed into three separate fields can be found when looking at tidal data.</span></p>
<p><span class="koboSpan" id="kobo.217.1" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://tidesandcurrents.noaa.gov/tide_predictions.html"><span class="koboSpan" id="kobo.218.1" xmlns="http://www.w3.org/1999/xhtml">https://tidesandcurrents.noaa.gov/tide_predictions.html</span></a><span class="koboSpan" id="kobo.219.1" xmlns="http://www.w3.org/1999/xhtml"> for Tide Predictions around the US. </span><span class="koboSpan" id="kobo.219.2" xmlns="http://www.w3.org/1999/xhtml">This site supports downloads in a variety of formats, as well as RESTful API requests for tide predictions.</span></p>
<p><span class="koboSpan" id="kobo.220.1" xmlns="http://www.w3.org/1999/xhtml">Each of the tidal events in an annual tide table has a timestamp. </span><span class="koboSpan" id="kobo.220.2" xmlns="http://www.w3.org/1999/xhtml">The timestamp is decomposed into three separate fields: the date, the day of the week, and the local time. </span><span class="koboSpan" id="kobo.220.3" xmlns="http://www.w3.org/1999/xhtml">The day of the week is helpful, but it is entirely derived from the date. </span><span class="koboSpan" id="kobo.220.4" xmlns="http://www.w3.org/1999/xhtml">The date and time need to be combined into a single datetime value to make this data useful. </span><span class="koboSpan" id="kobo.220.5" xmlns="http://www.w3.org/1999/xhtml">It’s common to use </span><code><span class="koboSpan" id="kobo.221.1" xmlns="http://www.w3.org/1999/xhtml">datetime.combine(date,</span></code><code><span class="koboSpan" id="kobo.222.1" xmlns="http://www.w3.org/1999/xhtml"> time)</span></code><span class="koboSpan" id="kobo.223.1" xmlns="http://www.w3.org/1999/xhtml"> to merge separate date and time values into a single value.</span></p>
<p><span class="koboSpan" id="kobo.224.1" xmlns="http://www.w3.org/1999/xhtml">Sometimes a data set will have records of a variety of subtypes merged into a single collection. </span><span class="koboSpan" id="kobo.224.2" xmlns="http://www.w3.org/1999/xhtml">The various types are often discriminated from each other by the values of a field. </span><span class="koboSpan" id="kobo.224.3" xmlns="http://www.w3.org/1999/xhtml">A financial application might include a mixture of invoices and payments; many fields overlap, but the meanings of these two transaction types are dramatically different. </span><span class="koboSpan" id="kobo.224.4" xmlns="http://www.w3.org/1999/xhtml">A single field with a code value of ”I” or ”P” may be the only way to distinguish the types of business records represented.</span></p>
<p><span class="koboSpan" id="kobo.225.1" xmlns="http://www.w3.org/1999/xhtml">When multiple subtypes are present, the collection can be called a </span><em><span class="koboSpan" id="kobo.226.1" xmlns="http://www.w3.org/1999/xhtml">discriminated</span></em> <em><span class="koboSpan" id="kobo.227.1" xmlns="http://www.w3.org/1999/xhtml">union </span></em><span class="koboSpan" id="kobo.228.1" xmlns="http://www.w3.org/1999/xhtml">of subtypes; sometimes </span><span id="dx1-213003"/><span class="koboSpan" id="kobo.229.1" xmlns="http://www.w3.org/1999/xhtml">simply called a </span><strong><span class="koboSpan" id="kobo.230.1" xmlns="http://www.w3.org/1999/xhtml">union</span></strong><span class="koboSpan" id="kobo.231.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.231.2" xmlns="http://www.w3.org/1999/xhtml">The discriminator and the subtypes suggest a class hierachy is required to describe the variety of sample types. </span><span class="koboSpan" id="kobo.231.3" xmlns="http://www.w3.org/1999/xhtml">A common base class is needed to describe the common fields, including the discriminator. </span><span class="koboSpan" id="kobo.231.4" xmlns="http://www.w3.org/1999/xhtml">Each subclass has a distinct definition for the fields unique to the subclass.</span></p>
<p><span class="koboSpan" id="kobo.232.1" xmlns="http://www.w3.org/1999/xhtml">One additional complication </span><span id="dx1-213004"/><span class="koboSpan" id="kobo.233.1" xmlns="http://www.w3.org/1999/xhtml">stems from data sources with ”opaque” data. </span><span class="koboSpan" id="kobo.233.2" xmlns="http://www.w3.org/1999/xhtml">These are string fields that can be used for equality comparison, but nothing else. </span><span class="koboSpan" id="kobo.233.3" xmlns="http://www.w3.org/1999/xhtml">These values are often the result of a </span><span id="dx1-213005"/><span class="koboSpan" id="kobo.234.1" xmlns="http://www.w3.org/1999/xhtml">data analysis </span><span id="dx1-213006"/><span class="koboSpan" id="kobo.235.1" xmlns="http://www.w3.org/1999/xhtml">approach called </span><strong><span class="koboSpan" id="kobo.236.1" xmlns="http://www.w3.org/1999/xhtml">masking</span></strong><span class="koboSpan" id="kobo.237.1" xmlns="http://www.w3.org/1999/xhtml">, </span><strong><span class="koboSpan" id="kobo.238.1" xmlns="http://www.w3.org/1999/xhtml">deidentification</span></strong><span class="koboSpan" id="kobo.239.1" xmlns="http://www.w3.org/1999/xhtml">, or </span><strong><span class="koboSpan" id="kobo.240.1" xmlns="http://www.w3.org/1999/xhtml">pseudonymization</span></strong><span class="koboSpan" id="kobo.241.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.241.2" xmlns="http://www.w3.org/1999/xhtml">This is </span><span id="dx1-213007"/><span class="koboSpan" id="kobo.242.1" xmlns="http://www.w3.org/1999/xhtml">sometimes also called ”tokenizing” because </span><span id="dx1-213008"/><span class="koboSpan" id="kobo.243.1" xmlns="http://www.w3.org/1999/xhtml">an opaque token has replaced the sensitive data. </span><span class="koboSpan" id="kobo.243.2" xmlns="http://www.w3.org/1999/xhtml">In banking, for example, it’s common for analytical data to have account numbers or payment card numbers transformed into opaque values. </span><span class="koboSpan" id="kobo.243.3" xmlns="http://www.w3.org/1999/xhtml">These can be used to aggregate behavior, but cannot be used to identify an individual account holder or payment card. </span><span class="koboSpan" id="kobo.243.4" xmlns="http://www.w3.org/1999/xhtml">These fields must be treated as strings, and no other processing can be done.</span></p>
<p><span class="koboSpan" id="kobo.244.1" xmlns="http://www.w3.org/1999/xhtml">For now, we’ll defer the implementation details of these complications to a later chapter. </span><span class="koboSpan" id="kobo.244.2" xmlns="http://www.w3.org/1999/xhtml">The ideas should inform design decisions for the initial, foundational application.</span></p>
<p><span class="koboSpan" id="kobo.245.1" xmlns="http://www.w3.org/1999/xhtml">In addition to clean valid data, the application needs to produce information about the invalid data. </span><span class="koboSpan" id="kobo.245.2" xmlns="http://www.w3.org/1999/xhtml">Next, we’ll look at the logs and error reports. </span><span id="x1-213009r230"/></p>
</section>
<section class="level3" data-number="13.1.5" id="error-reports">
<h3 data-number="13.1.5"><span class="titlemark"><span class="koboSpan" id="kobo.246.1" xmlns="http://www.w3.org/1999/xhtml">9.1.5 </span></span> <span id="x1-2140005"/><span class="koboSpan" id="kobo.247.1" xmlns="http://www.w3.org/1999/xhtml">Error reports</span></h3>
<p><span class="koboSpan" id="kobo.248.1" xmlns="http://www.w3.org/1999/xhtml">The central feature of this application is to </span><span id="dx1-214001"/><span class="koboSpan" id="kobo.249.1" xmlns="http://www.w3.org/1999/xhtml">output files with valid, useful data for analytic purposes. </span><span class="koboSpan" id="kobo.249.2" xmlns="http://www.w3.org/1999/xhtml">We’ve left off some details of what happens when an acquired document isn’t actually usable.</span></p>
<p><span class="koboSpan" id="kobo.250.1" xmlns="http://www.w3.org/1999/xhtml">Here are a number of choices related to the observability of invalid data:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.251.1" xmlns="http://www.w3.org/1999/xhtml">Raise an overall exception and stop. </span><span class="koboSpan" id="kobo.251.2" xmlns="http://www.w3.org/1999/xhtml">This is appropriate when working with carefully-curated data sets like the Anscombe Quartet.</span></p></li>
<li><p><span class="koboSpan" id="kobo.252.1" xmlns="http://www.w3.org/1999/xhtml">Make all of the bad data observable, either through the log or by writing bad data to a separate rejected samples file.</span></p></li>
<li><p><span class="koboSpan" id="kobo.253.1" xmlns="http://www.w3.org/1999/xhtml">Silently reject the bad data. </span><span class="koboSpan" id="kobo.253.2" xmlns="http://www.w3.org/1999/xhtml">This is often used with large data sources where there is no curation or quality control over the source.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.254.1" xmlns="http://www.w3.org/1999/xhtml">In all cases, the summary counts of acquired data, usable analytic data, and cleaned, and rejected data are essential. </span><span class="koboSpan" id="kobo.254.2" xmlns="http://www.w3.org/1999/xhtml">It’s imperative to be </span><span id="dx1-214002"/><span class="koboSpan" id="kobo.255.1" xmlns="http://www.w3.org/1999/xhtml">sure the number of raw records read is accounted for, and the provenance of cleaned and rejected data is clear. </span><span class="koboSpan" id="kobo.255.2" xmlns="http://www.w3.org/1999/xhtml">The summary counts, in many cases, are the primary way to observe changes in data sources. </span><span class="koboSpan" id="kobo.255.3" xmlns="http://www.w3.org/1999/xhtml">A non-zero error count, may be so important that it’s used as the final exit status code for the cleaning application.</span></p>
<p><span class="koboSpan" id="kobo.256.1" xmlns="http://www.w3.org/1999/xhtml">In addition to the observability of bad data, we may be able to clean the source data. </span><span class="koboSpan" id="kobo.256.2" xmlns="http://www.w3.org/1999/xhtml">There are several choices here, also:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.257.1" xmlns="http://www.w3.org/1999/xhtml">Log the details of each object where cleaning is done. </span><span class="koboSpan" id="kobo.257.2" xmlns="http://www.w3.org/1999/xhtml">This is often used with data coming from a spreadsheet where the unexpected data may be rows that need to be corrected manually.</span></p></li>
<li><p><span class="koboSpan" id="kobo.258.1" xmlns="http://www.w3.org/1999/xhtml">Count the number of items cleaned without the supporting details. </span><span class="koboSpan" id="kobo.258.2" xmlns="http://www.w3.org/1999/xhtml">This is often used with large data sources where changes are frequent.</span></p></li>
<li><p><span class="koboSpan" id="kobo.259.1" xmlns="http://www.w3.org/1999/xhtml">Quietly clean the bad data as an expected, normal operational step. </span><span class="koboSpan" id="kobo.259.2" xmlns="http://www.w3.org/1999/xhtml">This is often used when raw data comes directly from measurement devices in unreliable environments, perhaps in space, or at the bottom of the ocean.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.260.1" xmlns="http://www.w3.org/1999/xhtml">Further, each field may have distinct rules for whether or not cleaning bad data is a significant concern or a common, expected operation. </span><span class="koboSpan" id="kobo.260.2" xmlns="http://www.w3.org/1999/xhtml">The intersection of observability and automated cleaning has a large number of alternatives.</span></p>
<p><span class="koboSpan" id="kobo.261.1" xmlns="http://www.w3.org/1999/xhtml">The solutions to data cleaning and standardization are often a matter of deep, ongoing conversations with users. </span><span class="koboSpan" id="kobo.261.2" xmlns="http://www.w3.org/1999/xhtml">Each data acquisition pipeline is unique with regard to error reporting and data cleaning.</span></p>
<p><span class="koboSpan" id="kobo.262.1" xmlns="http://www.w3.org/1999/xhtml">It’s sometimes necessary to have a command-line option to choose between logging each error or simply summarizing the number of errors. </span><span class="koboSpan" id="kobo.262.2" xmlns="http://www.w3.org/1999/xhtml">Additionally, the application might return a non-zero exit code when any bad </span><span id="dx1-214003"/><span class="koboSpan" id="kobo.263.1" xmlns="http://www.w3.org/1999/xhtml">records are found; this permits a parent application (e.g., a shell script) to stop processing in the presence of errors.</span></p>
<p><span class="koboSpan" id="kobo.264.1" xmlns="http://www.w3.org/1999/xhtml">We’ve looked at the overall processing, the source files, the result files, and some of the error-reporting alternatives that might be used. </span><span class="koboSpan" id="kobo.264.2" xmlns="http://www.w3.org/1999/xhtml">In the next section, we’ll look at some design approaches we can use to implement this application. </span><span id="x1-214004r226"/></p>
</section>
</section>
<section class="level2" data-number="13.2" id="approach-10">
<h2 data-number="13.2"><span class="titlemark"><span class="koboSpan" id="kobo.265.1" xmlns="http://www.w3.org/1999/xhtml">9.2 </span></span> <span id="x1-2150002"/><span class="koboSpan" id="kobo.266.1" xmlns="http://www.w3.org/1999/xhtml">Approach</span></h2>
<p><span class="koboSpan" id="kobo.267.1" xmlns="http://www.w3.org/1999/xhtml">We’ll take some guidance </span><span id="dx1-215001"/><span class="koboSpan" id="kobo.268.1" xmlns="http://www.w3.org/1999/xhtml">from the C4 model ( </span><a class="url" href="https://c4model.com"><span class="koboSpan" id="kobo.269.1" xmlns="http://www.w3.org/1999/xhtml">https://c4model.com</span></a><span class="koboSpan" id="kobo.270.1" xmlns="http://www.w3.org/1999/xhtml">) when looking at our approach.</span></p>
<ul>
<li><p><strong><span class="koboSpan" id="kobo.271.1" xmlns="http://www.w3.org/1999/xhtml">Context</span></strong><span class="koboSpan" id="kobo.272.1" xmlns="http://www.w3.org/1999/xhtml">: For this project, the context </span><span id="dx1-215002"/><span class="koboSpan" id="kobo.273.1" xmlns="http://www.w3.org/1999/xhtml">diagram has expanded to three use cases: acquire, inspect, and clean.</span></p></li>
<li><p><strong><span class="koboSpan" id="kobo.274.1" xmlns="http://www.w3.org/1999/xhtml">Containers</span></strong><span class="koboSpan" id="kobo.275.1" xmlns="http://www.w3.org/1999/xhtml">: There’s one container for the various applications: the user’s personal computer.</span></p></li>
<li><p><strong><span class="koboSpan" id="kobo.276.1" xmlns="http://www.w3.org/1999/xhtml">Components</span></strong><span class="koboSpan" id="kobo.277.1" xmlns="http://www.w3.org/1999/xhtml">: There are two significantly different collections of software components: the acquisition program and the cleaning program.</span></p></li>
<li><p><strong><span class="koboSpan" id="kobo.278.1" xmlns="http://www.w3.org/1999/xhtml">Code</span></strong><span class="koboSpan" id="kobo.279.1" xmlns="http://www.w3.org/1999/xhtml">: We’ll touch on this to provide some suggested directions.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.280.1" xmlns="http://www.w3.org/1999/xhtml">A context diagram for this application is shown in </span><a href="#9.1"><em><span class="koboSpan" id="kobo.281.1" xmlns="http://www.w3.org/1999/xhtml">Figure 9.1</span></em></a><span class="koboSpan" id="kobo.282.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<figure class="IMG---Figure">
<span class="koboSpan" id="kobo.283.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 9.1: Context Diagram " src="../media/file40.jpg"/></span>
<figcaption class="IMG---Caption"><span class="id" id="9.1"><span class="koboSpan" id="kobo.284.1" xmlns="http://www.w3.org/1999/xhtml">Figure 9.1: </span></span><span class="content"><span class="koboSpan" id="kobo.285.1" xmlns="http://www.w3.org/1999/xhtml">Context Diagram </span></span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.286.1" xmlns="http://www.w3.org/1999/xhtml">A component diagram for the conversion application isn’t going to be as complicated as the component diagrams for acquisition applications. </span><span class="koboSpan" id="kobo.286.2" xmlns="http://www.w3.org/1999/xhtml">One reason for this is there are no choices for reading, extracting, or downloading raw data files. </span><span class="koboSpan" id="kobo.286.3" xmlns="http://www.w3.org/1999/xhtml">The source files are the ND JSON files created by the acquisition application.</span></p>
<p><span class="koboSpan" id="kobo.287.1" xmlns="http://www.w3.org/1999/xhtml">The second reason the conversion programs tend to be simpler is they often rely on built-in Python-type definitions, and packages like </span><code><span class="koboSpan" id="kobo.288.1" xmlns="http://www.w3.org/1999/xhtml">pydantic</span></code><span class="koboSpan" id="kobo.289.1" xmlns="http://www.w3.org/1999/xhtml"> to provide the needed conversion processing. </span><span class="koboSpan" id="kobo.289.2" xmlns="http://www.w3.org/1999/xhtml">The complications of parsing HTML or XML sources were isolated in the acquisition layer, permitting this application to focus on the problem domain data types and relationships.</span></p>
<p><span class="koboSpan" id="kobo.290.1" xmlns="http://www.w3.org/1999/xhtml">The components for this application are shown in </span><a href="#9.2"><em><span class="koboSpan" id="kobo.291.1" xmlns="http://www.w3.org/1999/xhtml">Figure 9.2</span></em></a><span class="koboSpan" id="kobo.292.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<figure class="IMG---Figure">
<span class="koboSpan" id="kobo.293.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 9.2: Component Diagram " src="../media/file41.jpg"/></span>
<figcaption class="IMG---Caption"><span class="id" id="9.2"><span class="koboSpan" id="kobo.294.1" xmlns="http://www.w3.org/1999/xhtml">Figure 9.2: </span></span><span class="content"><span class="koboSpan" id="kobo.295.1" xmlns="http://www.w3.org/1999/xhtml">Component Diagram </span></span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.296.1" xmlns="http://www.w3.org/1999/xhtml">Note that we’ve used a dotted ”depends on” arrow. </span><span class="koboSpan" id="kobo.296.2" xmlns="http://www.w3.org/1999/xhtml">This does not show the data flow from acquire to clean. </span><span class="koboSpan" id="kobo.296.3" xmlns="http://www.w3.org/1999/xhtml">It shows how the clean application depends on the acquire application’s output.</span></p>
<p><span class="koboSpan" id="kobo.297.1" xmlns="http://www.w3.org/1999/xhtml">The design for the </span><strong><span class="koboSpan" id="kobo.298.1" xmlns="http://www.w3.org/1999/xhtml">clean </span></strong><span class="koboSpan" id="kobo.299.1" xmlns="http://www.w3.org/1999/xhtml">application often involves an almost purely functional design. </span><span class="koboSpan" id="kobo.299.2" xmlns="http://www.w3.org/1999/xhtml">Class definitions — of course — can be used. </span><span class="koboSpan" id="kobo.299.3" xmlns="http://www.w3.org/1999/xhtml">Classes don’t seem to be helpful when the application processing involves stateless, immutable objects.</span></p>
<p><span class="koboSpan" id="kobo.300.1" xmlns="http://www.w3.org/1999/xhtml">In rare cases, a cleaning application will be required to perform dramatic reorganizations of data. </span><span class="koboSpan" id="kobo.300.2" xmlns="http://www.w3.org/1999/xhtml">It may be necessary to accumulate </span><span id="dx1-215007"/><span class="koboSpan" id="kobo.301.1" xmlns="http://www.w3.org/1999/xhtml">details from a variety of transactions, updating the state of a composite object. </span><span class="koboSpan" id="kobo.301.2" xmlns="http://www.w3.org/1999/xhtml">For example, there may be multiple payments for an invoice that must be combined for reconciliation purposes. </span><span class="koboSpan" id="kobo.301.3" xmlns="http://www.w3.org/1999/xhtml">In this kind of application, associating payments and invoices may require working through sophisticated matching rules.</span></p>
<p><span class="koboSpan" id="kobo.302.1" xmlns="http://www.w3.org/1999/xhtml">Note that the </span><strong><span class="koboSpan" id="kobo.303.1" xmlns="http://www.w3.org/1999/xhtml">clean </span></strong><span class="koboSpan" id="kobo.304.1" xmlns="http://www.w3.org/1999/xhtml">application and the </span><strong><span class="koboSpan" id="kobo.305.1" xmlns="http://www.w3.org/1999/xhtml">acquire </span></strong><span class="koboSpan" id="kobo.306.1" xmlns="http://www.w3.org/1999/xhtml">application will both share a common set of dataclasses. </span><span class="koboSpan" id="kobo.306.2" xmlns="http://www.w3.org/1999/xhtml">These classes represent the source data, the output from the </span><strong><span class="koboSpan" id="kobo.307.1" xmlns="http://www.w3.org/1999/xhtml">acquire </span></strong><span class="koboSpan" id="kobo.308.1" xmlns="http://www.w3.org/1999/xhtml">application. </span><span class="koboSpan" id="kobo.308.2" xmlns="http://www.w3.org/1999/xhtml">They also define the input to the </span><strong><span class="koboSpan" id="kobo.309.1" xmlns="http://www.w3.org/1999/xhtml">clean</span></strong><span class="koboSpan" id="kobo.310.1" xmlns="http://www.w3.org/1999/xhtml"> application. </span><span class="koboSpan" id="kobo.310.2" xmlns="http://www.w3.org/1999/xhtml">A separate set of dataclasses represent the working values used for later analysis applications.</span></p>
<p><span class="koboSpan" id="kobo.311.1" xmlns="http://www.w3.org/1999/xhtml">Our goal is to create three modules:</span></p>
<ul>
<li><p><code><span class="koboSpan" id="kobo.312.1" xmlns="http://www.w3.org/1999/xhtml">clean.py</span></code><span class="koboSpan" id="kobo.313.1" xmlns="http://www.w3.org/1999/xhtml">: The main application.</span></p></li>
<li><p><code><span class="koboSpan" id="kobo.314.1" xmlns="http://www.w3.org/1999/xhtml">analytical_model.py</span></code><span class="koboSpan" id="kobo.315.1" xmlns="http://www.w3.org/1999/xhtml">: A module with dataclass definitions for the pure-Python objects that we’ll be working with. </span><span class="koboSpan" id="kobo.315.2" xmlns="http://www.w3.org/1999/xhtml">These classes will — generally — be created from JSON-friendly dictionaries with string values.</span></p></li>
<li><p><code><span class="koboSpan" id="kobo.316.1" xmlns="http://www.w3.org/1999/xhtml">conversions.py</span></code><span class="koboSpan" id="kobo.317.1" xmlns="http://www.w3.org/1999/xhtml">: A module with any specialized validation, cleaning, and conversion functions.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.318.1" xmlns="http://www.w3.org/1999/xhtml">If needed, any application-specific conversion functions may be required to transform source values to ”clean,” usable Python objects. </span><span class="koboSpan" id="kobo.318.2" xmlns="http://www.w3.org/1999/xhtml">If this can’t be done, the function can instead raise </span><code><span class="koboSpan" id="kobo.319.1" xmlns="http://www.w3.org/1999/xhtml">ValueError</span></code><span class="koboSpan" id="kobo.320.1" xmlns="http://www.w3.org/1999/xhtml"> exceptions for </span><span id="dx1-215008"/><span class="koboSpan" id="kobo.321.1" xmlns="http://www.w3.org/1999/xhtml">invalid data, following the established pattern for functions like Python’s built-in </span><code><span class="koboSpan" id="kobo.322.1" xmlns="http://www.w3.org/1999/xhtml">float()</span></code><span class="koboSpan" id="kobo.323.1" xmlns="http://www.w3.org/1999/xhtml"> function. </span><span class="koboSpan" id="kobo.323.2" xmlns="http://www.w3.org/1999/xhtml">Additionally, </span><code><span class="koboSpan" id="kobo.324.1" xmlns="http://www.w3.org/1999/xhtml">TypeError</span></code><span class="koboSpan" id="kobo.325.1" xmlns="http://www.w3.org/1999/xhtml"> exceptions may be helpful when the object — as a whole — is invalid. </span><span class="koboSpan" id="kobo.325.2" xmlns="http://www.w3.org/1999/xhtml">In some cases, the </span><code><span class="koboSpan" id="kobo.326.1" xmlns="http://www.w3.org/1999/xhtml">assert</span></code><span class="koboSpan" id="kobo.327.1" xmlns="http://www.w3.org/1999/xhtml"> statement is used, and an </span><code><span class="koboSpan" id="kobo.328.1" xmlns="http://www.w3.org/1999/xhtml">AssertionError</span></code><span class="koboSpan" id="kobo.329.1" xmlns="http://www.w3.org/1999/xhtml"> may be raised to indicate invalid data.</span></p>
<p><span class="koboSpan" id="kobo.330.1" xmlns="http://www.w3.org/1999/xhtml">For this baseline application, we’ll stick to the simpler and more common design pattern. </span><span class="koboSpan" id="kobo.330.2" xmlns="http://www.w3.org/1999/xhtml">We’ll look at individual functions that combine validation and cleaning. </span><span id="x1-215009r231"/></p>
<section class="level3" data-number="13.2.1" id="model-module-refactoring">
<h3 data-number="13.2.1"><span class="titlemark"><span class="koboSpan" id="kobo.331.1" xmlns="http://www.w3.org/1999/xhtml">9.2.1 </span></span> <span id="x1-2160001"/><span class="koboSpan" id="kobo.332.1" xmlns="http://www.w3.org/1999/xhtml">Model module refactoring</span></h3>
<p><span class="koboSpan" id="kobo.333.1" xmlns="http://www.w3.org/1999/xhtml">We appear to have two distinct models: the ”as-acquired” model with text fields, and the ”to-be-analyzed” model with proper Python types, like </span><code><span class="koboSpan" id="kobo.334.1" xmlns="http://www.w3.org/1999/xhtml">float</span></code><span class="koboSpan" id="kobo.335.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.336.1" xmlns="http://www.w3.org/1999/xhtml">int</span></code><span class="koboSpan" id="kobo.337.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.337.2" xmlns="http://www.w3.org/1999/xhtml">The presence of multiple variations on the model </span><span id="dx1-216001"/><span class="koboSpan" id="kobo.338.1" xmlns="http://www.w3.org/1999/xhtml">means we either need a lot of distinct class names, or two distinct modules as namespaces to keep the classes organized.</span></p>
<p><span class="koboSpan" id="kobo.339.1" xmlns="http://www.w3.org/1999/xhtml">The cleaning application is the only application where the acquire and analysis models are </span><strong><span class="koboSpan" id="kobo.340.1" xmlns="http://www.w3.org/1999/xhtml">both </span></strong><span class="koboSpan" id="kobo.341.1" xmlns="http://www.w3.org/1999/xhtml">used. </span><span class="koboSpan" id="kobo.341.2" xmlns="http://www.w3.org/1999/xhtml">All other applications either acquire raw data or work with clean analysis data.</span></p>
<p><span class="koboSpan" id="kobo.342.1" xmlns="http://www.w3.org/1999/xhtml">The previous examples had a single </span><code><span class="koboSpan" id="kobo.343.1" xmlns="http://www.w3.org/1999/xhtml">model.py</span></code><span class="koboSpan" id="kobo.344.1" xmlns="http://www.w3.org/1999/xhtml"> module with dataclasses for the acquired data. </span><span class="koboSpan" id="kobo.344.2" xmlns="http://www.w3.org/1999/xhtml">At this point, it has become more clear that this was not a great long-term decision. </span><span class="koboSpan" id="kobo.344.3" xmlns="http://www.w3.org/1999/xhtml">Because there are two distinct variations on the data model, the generic </span><code><span class="koboSpan" id="kobo.345.1" xmlns="http://www.w3.org/1999/xhtml">model</span></code><span class="koboSpan" id="kobo.346.1" xmlns="http://www.w3.org/1999/xhtml"> module name needs to be refactored. </span><span class="koboSpan" id="kobo.346.2" xmlns="http://www.w3.org/1999/xhtml">To distinguish the acquired data model from the analytic data model, a prefix should be adequate: the module names can be </span><code><span class="koboSpan" id="kobo.347.1" xmlns="http://www.w3.org/1999/xhtml">acquire_model</span></code><span class="koboSpan" id="kobo.348.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.349.1" xmlns="http://www.w3.org/1999/xhtml">analysis_model</span></code><span class="koboSpan" id="kobo.350.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.351.1" xmlns="http://www.w3.org/1999/xhtml">(The English parts of speech don’t match exactly. </span><span class="koboSpan" id="kobo.351.2" xmlns="http://www.w3.org/1999/xhtml">We’d rather not have to type ”acquisition_model”. </span><span class="koboSpan" id="kobo.351.3" xmlns="http://www.w3.org/1999/xhtml">The slightly shorter name seems easier to work with and clear enough.)</span></p>
<p><span class="koboSpan" id="kobo.352.1" xmlns="http://www.w3.org/1999/xhtml">Within these two model files, the class names can be the same. </span><span class="koboSpan" id="kobo.352.2" xmlns="http://www.w3.org/1999/xhtml">We might have names </span><code><span class="koboSpan" id="kobo.353.1" xmlns="http://www.w3.org/1999/xhtml">acquire_model.SeriesSample</span></code><span class="koboSpan" id="kobo.354.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.355.1" xmlns="http://www.w3.org/1999/xhtml">analysis_model.SeriesSample</span></code><span class="koboSpan" id="kobo.356.1" xmlns="http://www.w3.org/1999/xhtml"> as distinct classes.</span></p>
<p><span class="koboSpan" id="kobo.357.1" xmlns="http://www.w3.org/1999/xhtml">To an extent, we can sometimes copy the acquired model module to create the analysis model module. </span><span class="koboSpan" id="kobo.357.2" xmlns="http://www.w3.org/1999/xhtml">We’d need to change </span><code><span class="koboSpan" id="kobo.358.1" xmlns="http://www.w3.org/1999/xhtml">from</span></code><code><span class="koboSpan" id="kobo.359.1" xmlns="http://www.w3.org/1999/xhtml"> dataclasses</span></code><code><span class="koboSpan" id="kobo.360.1" xmlns="http://www.w3.org/1999/xhtml"> import</span></code><code><span class="koboSpan" id="kobo.361.1" xmlns="http://www.w3.org/1999/xhtml"> dataclass</span></code><span class="koboSpan" id="kobo.362.1" xmlns="http://www.w3.org/1999/xhtml"> to the </span><strong><span class="koboSpan" id="kobo.363.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.364.1" xmlns="http://www.w3.org/1999/xhtml">version, </span><code><span class="koboSpan" id="kobo.365.1" xmlns="http://www.w3.org/1999/xhtml">from</span></code><code><span class="koboSpan" id="kobo.366.1" xmlns="http://www.w3.org/1999/xhtml"> pydantic</span></code><code><span class="koboSpan" id="kobo.367.1" xmlns="http://www.w3.org/1999/xhtml"> import</span></code><code><span class="koboSpan" id="kobo.368.1" xmlns="http://www.w3.org/1999/xhtml"> dataclass</span></code><span class="koboSpan" id="kobo.369.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.369.2" xmlns="http://www.w3.org/1999/xhtml">This is a very small change, which makes it easy to start with. </span><span class="koboSpan" id="kobo.369.3" xmlns="http://www.w3.org/1999/xhtml">In some older versions of </span><strong><span class="koboSpan" id="kobo.370.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.371.1" xmlns="http://www.w3.org/1999/xhtml">and </span><strong><span class="koboSpan" id="kobo.372.1" xmlns="http://www.w3.org/1999/xhtml">mypy</span></strong><span class="koboSpan" id="kobo.373.1" xmlns="http://www.w3.org/1999/xhtml">, the </span><strong><span class="koboSpan" id="kobo.374.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.375.1" xmlns="http://www.w3.org/1999/xhtml">version of </span><code><span class="koboSpan" id="kobo.376.1" xmlns="http://www.w3.org/1999/xhtml">dataclass</span></code><span class="koboSpan" id="kobo.377.1" xmlns="http://www.w3.org/1999/xhtml"> doesn’t expose the attribute types in a </span><span id="dx1-216002"/><span class="koboSpan" id="kobo.378.1" xmlns="http://www.w3.org/1999/xhtml">way that is transparent to the </span><strong><span class="koboSpan" id="kobo.379.1" xmlns="http://www.w3.org/1999/xhtml">mypy</span></strong><span class="koboSpan" id="kobo.380.1" xmlns="http://www.w3.org/1999/xhtml"> tool.</span></p>
<p><span class="koboSpan" id="kobo.381.1" xmlns="http://www.w3.org/1999/xhtml">In many cases, it can work out </span><span id="dx1-216003"/><span class="koboSpan" id="kobo.382.1" xmlns="http://www.w3.org/1999/xhtml">well to import </span><code><span class="koboSpan" id="kobo.383.1" xmlns="http://www.w3.org/1999/xhtml">BaseModel</span></code><span class="koboSpan" id="kobo.384.1" xmlns="http://www.w3.org/1999/xhtml"> and use this as the parent class for the analytic models. </span><span class="koboSpan" id="kobo.384.2" xmlns="http://www.w3.org/1999/xhtml">Using the </span><code><span class="koboSpan" id="kobo.385.1" xmlns="http://www.w3.org/1999/xhtml">pydantic.BaseModel</span></code><span class="koboSpan" id="kobo.386.1" xmlns="http://www.w3.org/1999/xhtml"> parent class often has a better coexistence with the </span><strong><span class="koboSpan" id="kobo.387.1" xmlns="http://www.w3.org/1999/xhtml">mypy </span></strong><span class="koboSpan" id="kobo.388.1" xmlns="http://www.w3.org/1999/xhtml">tool. </span><span class="koboSpan" id="kobo.388.2" xmlns="http://www.w3.org/1999/xhtml">This requires a larger change when upgrading from dataclasses to leverage the </span><strong><span class="koboSpan" id="kobo.389.1" xmlns="http://www.w3.org/1999/xhtml">pydantic </span></strong><span class="koboSpan" id="kobo.390.1" xmlns="http://www.w3.org/1999/xhtml">package. </span><span class="koboSpan" id="kobo.390.2" xmlns="http://www.w3.org/1999/xhtml">Since it’s beneficial when using the </span><strong><span class="koboSpan" id="kobo.391.1" xmlns="http://www.w3.org/1999/xhtml">mypy </span></strong><span class="koboSpan" id="kobo.392.1" xmlns="http://www.w3.org/1999/xhtml">tool, it’s the path we recommend following.</span></p>
<p><span class="koboSpan" id="kobo.393.1" xmlns="http://www.w3.org/1999/xhtml">This </span><strong><span class="koboSpan" id="kobo.394.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.395.1" xmlns="http://www.w3.org/1999/xhtml">version of </span><code><span class="koboSpan" id="kobo.396.1" xmlns="http://www.w3.org/1999/xhtml">dataclass</span></code><span class="koboSpan" id="kobo.397.1" xmlns="http://www.w3.org/1999/xhtml"> introduces a separate validator method that will be used (automatically) to process fields. </span><span class="koboSpan" id="kobo.397.2" xmlns="http://www.w3.org/1999/xhtml">For simple class definitions with a relatively clear mapping from the acquire class to the analysis class, a small change is required to the class definition.</span></p>
<p><span class="koboSpan" id="kobo.398.1" xmlns="http://www.w3.org/1999/xhtml">One common design pattern for this new analysis model class is shown in the following example for </span><strong><span class="koboSpan" id="kobo.399.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.400.1" xmlns="http://www.w3.org/1999/xhtml">version 1:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-153">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.401.1" xmlns="http://www.w3.org/1999/xhtml">from pydantic import validator, BaseModel, Field

class SeriesSample(BaseModel):
    """
    An individual sample value.
    </span><span class="koboSpan" id="kobo.401.2" xmlns="http://www.w3.org/1999/xhtml">"""
    x: float = Field(title="The x attribute", ge=0.0)
    y: float = Field(title="The y attribute", ge=0.0)

    @validator(’x’, ’y’, pre=True)
    def clean_value(cls, value: str | float) -&gt; str:
        match value:
            case str():
                for char in "\N{ZERO WIDTH SPACE}":
                    value = value.replace(char, "")
                return value
            case float():
                return value</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.402.1" xmlns="http://www.w3.org/1999/xhtml">This design defines a class-level method, </span><code><span class="koboSpan" id="kobo.403.1" xmlns="http://www.w3.org/1999/xhtml">clean_value()</span></code><span class="koboSpan" id="kobo.404.1" xmlns="http://www.w3.org/1999/xhtml">, to handle cleaning the source data when it’s a string. </span><span class="koboSpan" id="kobo.404.2" xmlns="http://www.w3.org/1999/xhtml">The validator has the </span><code><span class="koboSpan" id="kobo.405.1" xmlns="http://www.w3.org/1999/xhtml">@validator()</span></code><span class="koboSpan" id="kobo.406.1" xmlns="http://www.w3.org/1999/xhtml"> decorator to provide the attribute names to which this function applies, as well as the specific stage in the sequence of operations. </span><span class="koboSpan" id="kobo.406.2" xmlns="http://www.w3.org/1999/xhtml">In this case, </span><code><span class="koboSpan" id="kobo.407.1" xmlns="http://www.w3.org/1999/xhtml">pre=True</span></code><span class="koboSpan" id="kobo.408.1" xmlns="http://www.w3.org/1999/xhtml"> means this validation applies </span><strong><span class="koboSpan" id="kobo.409.1" xmlns="http://www.w3.org/1999/xhtml">before </span></strong><span class="koboSpan" id="kobo.410.1" xmlns="http://www.w3.org/1999/xhtml">the individual fields are validated and converted to useful types.</span></p>
<p><span class="koboSpan" id="kobo.411.1" xmlns="http://www.w3.org/1999/xhtml">This will be replaced by a number of </span><span id="dx1-216022"/><span class="koboSpan" id="kobo.412.1" xmlns="http://www.w3.org/1999/xhtml">much more flexible alternatives in </span><strong><span class="koboSpan" id="kobo.413.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.414.1" xmlns="http://www.w3.org/1999/xhtml">version 2. </span><span class="koboSpan" id="kobo.414.2" xmlns="http://www.w3.org/1999/xhtml">The newer release will step away from the </span><code><span class="koboSpan" id="kobo.415.1" xmlns="http://www.w3.org/1999/xhtml">pre=True</span></code><span class="koboSpan" id="kobo.416.1" xmlns="http://www.w3.org/1999/xhtml"> syntax used to assure this is done prior to the built-in handler accessing the field.</span></p>
<p><span class="koboSpan" id="kobo.417.1" xmlns="http://www.w3.org/1999/xhtml">The Pydantic 2 release will introduce a radically new approach using annotations to specify validation rules. </span><span class="koboSpan" id="kobo.417.2" xmlns="http://www.w3.org/1999/xhtml">It will also retain a decorator that’s very similar to the old version 1 validation.</span></p>
<p><span class="koboSpan" id="kobo.418.1" xmlns="http://www.w3.org/1999/xhtml">One migration path is to replace </span><code><span class="koboSpan" id="kobo.419.1" xmlns="http://www.w3.org/1999/xhtml">validator</span></code><span class="koboSpan" id="kobo.420.1" xmlns="http://www.w3.org/1999/xhtml"> with </span><code><span class="koboSpan" id="kobo.421.1" xmlns="http://www.w3.org/1999/xhtml">field_validator</span></code><span class="koboSpan" id="kobo.422.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.422.2" xmlns="http://www.w3.org/1999/xhtml">This will require changing the </span><code><span class="koboSpan" id="kobo.423.1" xmlns="http://www.w3.org/1999/xhtml">pre=True</span></code><span class="koboSpan" id="kobo.424.1" xmlns="http://www.w3.org/1999/xhtml"> or </span><code><span class="koboSpan" id="kobo.425.1" xmlns="http://www.w3.org/1999/xhtml">post=True</span></code><span class="koboSpan" id="kobo.426.1" xmlns="http://www.w3.org/1999/xhtml"> with a more universal </span><code><span class="koboSpan" id="kobo.427.1" xmlns="http://www.w3.org/1999/xhtml">mode=’before’</span></code><span class="koboSpan" id="kobo.428.1" xmlns="http://www.w3.org/1999/xhtml"> or </span><code><span class="koboSpan" id="kobo.429.1" xmlns="http://www.w3.org/1999/xhtml">mode=’after’</span></code><span class="koboSpan" id="kobo.430.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.430.2" xmlns="http://www.w3.org/1999/xhtml">This new approach permits writing field validators that “wrap” the conversion handler with both before and after processing.</span></p>
<p><span class="koboSpan" id="kobo.431.1" xmlns="http://www.w3.org/1999/xhtml">To use </span><strong><span class="koboSpan" id="kobo.432.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.433.1" xmlns="http://www.w3.org/1999/xhtml">version two, use </span><code><span class="koboSpan" id="kobo.434.1" xmlns="http://www.w3.org/1999/xhtml">@field_validator(’x’,</span></code><code><span class="koboSpan" id="kobo.435.1" xmlns="http://www.w3.org/1999/xhtml"> ’y’,</span></code><code><span class="koboSpan" id="kobo.436.1" xmlns="http://www.w3.org/1999/xhtml"> mode=’before’)</span></code><span class="koboSpan" id="kobo.437.1" xmlns="http://www.w3.org/1999/xhtml"> to replace the </span><code><span class="koboSpan" id="kobo.438.1" xmlns="http://www.w3.org/1999/xhtml">@validator</span></code><span class="koboSpan" id="kobo.439.1" xmlns="http://www.w3.org/1999/xhtml"> decorator in the example. </span><span class="koboSpan" id="kobo.439.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.440.1" xmlns="http://www.w3.org/1999/xhtml">import</span></code><span class="koboSpan" id="kobo.441.1" xmlns="http://www.w3.org/1999/xhtml"> must also change to reflect the new name of the decorator.</span></p>
<p><span class="koboSpan" id="kobo.442.1" xmlns="http://www.w3.org/1999/xhtml">This validator function handles the case where the string version of source data can include Unicode </span><code><span class="koboSpan" id="kobo.443.1" xmlns="http://www.w3.org/1999/xhtml">U+200B</span></code><span class="koboSpan" id="kobo.444.1" xmlns="http://www.w3.org/1999/xhtml">, a special character called the zero-width space. </span><span class="koboSpan" id="kobo.444.2" xmlns="http://www.w3.org/1999/xhtml">In Python, we can use </span><code><span class="koboSpan" id="kobo.445.1" xmlns="http://www.w3.org/1999/xhtml">"\N{ZERO</span></code><code><span class="koboSpan" id="kobo.446.1" xmlns="http://www.w3.org/1999/xhtml"> WIDTH</span></code><code><span class="koboSpan" id="kobo.447.1" xmlns="http://www.w3.org/1999/xhtml"> SPACE}"</span></code><span class="koboSpan" id="kobo.448.1" xmlns="http://www.w3.org/1999/xhtml"> to make this character visible. </span><span class="koboSpan" id="kobo.448.2" xmlns="http://www.w3.org/1999/xhtml">While lengthy, this name seems better than the obscure </span><code><span class="koboSpan" id="kobo.449.1" xmlns="http://www.w3.org/1999/xhtml">"\u200b"</span></code><span class="koboSpan" id="kobo.450.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.451.1" xmlns="http://www.w3.org/1999/xhtml">(See </span><a class="url" href="https://www.fileformat.info/info/unicode/char/200b/index.htm"><span class="koboSpan" id="kobo.452.1" xmlns="http://www.w3.org/1999/xhtml">https://www.fileformat.info/info/unicode/char/200b/index.htm</span></a><span class="koboSpan" id="kobo.453.1" xmlns="http://www.w3.org/1999/xhtml"> for details of this character.)</span></p>
<p><span class="koboSpan" id="kobo.454.1" xmlns="http://www.w3.org/1999/xhtml">When a function works in the </span><code><span class="koboSpan" id="kobo.455.1" xmlns="http://www.w3.org/1999/xhtml">pre=True</span></code><span class="koboSpan" id="kobo.456.1" xmlns="http://www.w3.org/1999/xhtml"> or </span><code><span class="koboSpan" id="kobo.457.1" xmlns="http://www.w3.org/1999/xhtml">mode=’before’</span></code><span class="koboSpan" id="kobo.458.1" xmlns="http://www.w3.org/1999/xhtml"> phase, then </span><strong><span class="koboSpan" id="kobo.459.1" xmlns="http://www.w3.org/1999/xhtml">pydantic </span></strong><span class="koboSpan" id="kobo.460.1" xmlns="http://www.w3.org/1999/xhtml">will automatically apply the final conversion function to complete the essential work of validation and conversion. </span><span class="koboSpan" id="kobo.460.2" xmlns="http://www.w3.org/1999/xhtml">This additional validator function can be designed, then, to focus narrowly only on cleaning the raw data.</span></p>
<p><span class="koboSpan" id="kobo.461.1" xmlns="http://www.w3.org/1999/xhtml">The idea of a validator function must reflect two separate use cases for this class:</span></p>
<ol>
<li><div id="x1-216024x1">
<p><span class="koboSpan" id="kobo.462.1" xmlns="http://www.w3.org/1999/xhtml">Cleaning and converting acquired data, generally strings, to more useful analytical data types.</span></p>
</div></li>
<li><div id="x1-216026x2">
<p><span class="koboSpan" id="kobo.463.1" xmlns="http://www.w3.org/1999/xhtml">Loading already cleaned analytical data, where type conversion is not required.</span></p>
</div></li>
</ol>
<p><span class="koboSpan" id="kobo.464.1" xmlns="http://www.w3.org/1999/xhtml">Our primary interest at this </span><span id="dx1-216027"/><span class="koboSpan" id="kobo.465.1" xmlns="http://www.w3.org/1999/xhtml">time is in the first use case, cleaning and conversion. </span><span class="koboSpan" id="kobo.465.2" xmlns="http://www.w3.org/1999/xhtml">Later, starting in chapter </span><a href="ch017.xhtml#x1-29700013"><em><span class="koboSpan" id="kobo.466.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.467.1" xmlns="http://www.w3.org/1999/xhtml"> 13</span></em></a><span class="koboSpan" id="kobo.468.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch017.xhtml#x1-29700013"><em><span class="koboSpan" id="kobo.469.1" xmlns="http://www.w3.org/1999/xhtml">Project 4.1: Visual Analysis Techniques</span></em></a><span class="koboSpan" id="kobo.470.1" xmlns="http://www.w3.org/1999/xhtml"> we’ll switch over to the second case, loading clean data.</span></p>
<p><span class="koboSpan" id="kobo.471.1" xmlns="http://www.w3.org/1999/xhtml">These two use cases are reflected in the type hint for the validator function. </span><span class="koboSpan" id="kobo.471.2" xmlns="http://www.w3.org/1999/xhtml">The parameter is defined as </span><code><span class="koboSpan" id="kobo.472.1" xmlns="http://www.w3.org/1999/xhtml">value:</span></code><code><span class="koboSpan" id="kobo.473.1" xmlns="http://www.w3.org/1999/xhtml"> str</span></code><code><span class="koboSpan" id="kobo.474.1" xmlns="http://www.w3.org/1999/xhtml"> |</span></code><code><span class="koboSpan" id="kobo.475.1" xmlns="http://www.w3.org/1999/xhtml"> float</span></code><span class="koboSpan" id="kobo.476.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.476.2" xmlns="http://www.w3.org/1999/xhtml">The first use case, conversion, expects a value of type </span><code><span class="koboSpan" id="kobo.477.1" xmlns="http://www.w3.org/1999/xhtml">str</span></code><span class="koboSpan" id="kobo.478.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.478.2" xmlns="http://www.w3.org/1999/xhtml">The second use case, loading cleaned data, expects a cleaned value of type </span><code><span class="koboSpan" id="kobo.479.1" xmlns="http://www.w3.org/1999/xhtml">float</span></code><span class="koboSpan" id="kobo.480.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.480.2" xmlns="http://www.w3.org/1999/xhtml">This kind of type of union is helpful with validator functions.</span></p>
<p><span class="koboSpan" id="kobo.481.1" xmlns="http://www.w3.org/1999/xhtml">Instances of the analytic model will be built from </span><code><span class="koboSpan" id="kobo.482.1" xmlns="http://www.w3.org/1999/xhtml">acquire_model</span></code><span class="koboSpan" id="kobo.483.1" xmlns="http://www.w3.org/1999/xhtml"> objects. </span><span class="koboSpan" id="kobo.483.2" xmlns="http://www.w3.org/1999/xhtml">Because the acquired model uses </span><code><span class="koboSpan" id="kobo.484.1" xmlns="http://www.w3.org/1999/xhtml">dataclasses</span></code><span class="koboSpan" id="kobo.485.1" xmlns="http://www.w3.org/1999/xhtml">, we can leverage the </span><code><span class="koboSpan" id="kobo.486.1" xmlns="http://www.w3.org/1999/xhtml">dataclasses.asdict()</span></code><span class="koboSpan" id="kobo.487.1" xmlns="http://www.w3.org/1999/xhtml"> function to transform a source object into a dictionary. </span><span class="koboSpan" id="kobo.487.2" xmlns="http://www.w3.org/1999/xhtml">This can be used to perform Pydantic validation and conversion to create the analytic model objects.</span></p>
<p><span class="koboSpan" id="kobo.488.1" xmlns="http://www.w3.org/1999/xhtml">We can add the following method in the dataclass definition:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-154">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.489.1" xmlns="http://www.w3.org/1999/xhtml">    @classmethod
    def from_acquire_dataclass(
            cls,
            acquired: acquire_model.SeriesSample
    ) -&gt; "SeriesSample":
        return SeriesSample(**asdict(acquired))</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.490.1" xmlns="http://www.w3.org/1999/xhtml">This method extracts a dictionary from the acquired data model’s version of the </span><code><span class="koboSpan" id="kobo.491.1" xmlns="http://www.w3.org/1999/xhtml">SeriesSample</span></code><span class="koboSpan" id="kobo.492.1" xmlns="http://www.w3.org/1999/xhtml"> class and uses it to create an instance of the analytic model’s variation of this class. </span><span class="koboSpan" id="kobo.492.2" xmlns="http://www.w3.org/1999/xhtml">This method pushes all of the validation and conversion work to the </span><strong><span class="koboSpan" id="kobo.493.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic </span></strong><span class="koboSpan" id="kobo.494.1" xmlns="http://www.w3.org/1999/xhtml">declarations. </span><span class="koboSpan" id="kobo.494.2" xmlns="http://www.w3.org/1999/xhtml">This method also requires </span><code><span class="koboSpan" id="kobo.495.1" xmlns="http://www.w3.org/1999/xhtml">from</span></code><code><span class="koboSpan" id="kobo.496.1" xmlns="http://www.w3.org/1999/xhtml"> dataclasses</span></code><code><span class="koboSpan" id="kobo.497.1" xmlns="http://www.w3.org/1999/xhtml"> import</span></code><code><span class="koboSpan" id="kobo.498.1" xmlns="http://www.w3.org/1999/xhtml"> asdict</span></code><span class="koboSpan" id="kobo.499.1" xmlns="http://www.w3.org/1999/xhtml"> to introduce the needed </span><code><span class="koboSpan" id="kobo.500.1" xmlns="http://www.w3.org/1999/xhtml">asdict()</span></code><span class="koboSpan" id="kobo.501.1" xmlns="http://www.w3.org/1999/xhtml"> function.</span></p>
<p><span class="koboSpan" id="kobo.502.1" xmlns="http://www.w3.org/1999/xhtml">In cases where the field names don’t match, or some other transformation is required, a more complicated dictionary </span><span id="dx1-216034"/><span class="koboSpan" id="kobo.503.1" xmlns="http://www.w3.org/1999/xhtml">builder can replace the </span><code><span class="koboSpan" id="kobo.504.1" xmlns="http://www.w3.org/1999/xhtml">asdict(acquired)</span></code><span class="koboSpan" id="kobo.505.1" xmlns="http://www.w3.org/1999/xhtml"> processing. </span><span class="koboSpan" id="kobo.505.2" xmlns="http://www.w3.org/1999/xhtml">We’ll see examples of this in </span><a href="ch014.xhtml#x1-22900010"><em><span class="koboSpan" id="kobo.506.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.507.1" xmlns="http://www.w3.org/1999/xhtml"> 10</span></em></a><span class="koboSpan" id="kobo.508.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch014.xhtml#x1-22900010"><em><span class="koboSpan" id="kobo.509.1" xmlns="http://www.w3.org/1999/xhtml">Data</span></em> <em><span class="koboSpan" id="kobo.510.1" xmlns="http://www.w3.org/1999/xhtml">Cleaning Features</span></em></a><span class="koboSpan" id="kobo.511.1" xmlns="http://www.w3.org/1999/xhtml">, where acquired fields need to be combined before they can be converted.</span></p>
<p><span class="koboSpan" id="kobo.512.1" xmlns="http://www.w3.org/1999/xhtml">We’ll revisit some aspects of this design decision in </span><a href="ch015.xhtml#x1-26400011"><em><span class="koboSpan" id="kobo.513.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.514.1" xmlns="http://www.w3.org/1999/xhtml"> 11</span></em></a><span class="koboSpan" id="kobo.515.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch015.xhtml#x1-26400011"><em><span class="koboSpan" id="kobo.516.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.7:</span></em> <em><span class="koboSpan" id="kobo.517.1" xmlns="http://www.w3.org/1999/xhtml">Interim Data Persistence</span></em></a><span class="koboSpan" id="kobo.518.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.518.2" xmlns="http://www.w3.org/1999/xhtml">First, however, we’ll look at </span><strong><span class="koboSpan" id="kobo.519.1" xmlns="http://www.w3.org/1999/xhtml">pydantic </span></strong><span class="koboSpan" id="kobo.520.1" xmlns="http://www.w3.org/1999/xhtml">version 2 validation, which offers a somewhat more explict path to validation functions. </span><span id="x1-216035r235"/></p>
</section>
<section class="level3" data-number="13.2.2" id="pydantic-v2-validation">
<h3 data-number="13.2.2"><span class="titlemark"><span class="koboSpan" id="kobo.521.1" xmlns="http://www.w3.org/1999/xhtml">9.2.2 </span></span> <span id="x1-2170002"/><span class="koboSpan" id="kobo.522.1" xmlns="http://www.w3.org/1999/xhtml">Pydantic V2 validation</span></h3>
<p><span class="koboSpan" id="kobo.523.1" xmlns="http://www.w3.org/1999/xhtml">While </span><strong><span class="koboSpan" id="kobo.524.1" xmlns="http://www.w3.org/1999/xhtml">pydantic </span></strong><span class="koboSpan" id="kobo.525.1" xmlns="http://www.w3.org/1999/xhtml">version 2 will offer a </span><code><span class="koboSpan" id="kobo.526.1" xmlns="http://www.w3.org/1999/xhtml">@field_validator</span></code><span class="koboSpan" id="kobo.527.1" xmlns="http://www.w3.org/1999/xhtml"> decorator that’s very similar to the legacy </span><code><span class="koboSpan" id="kobo.528.1" xmlns="http://www.w3.org/1999/xhtml">@validator</span></code><span class="koboSpan" id="kobo.529.1" xmlns="http://www.w3.org/1999/xhtml"> decorator, this approach suffers from an irksome problem. </span><span class="koboSpan" id="kobo.529.2" xmlns="http://www.w3.org/1999/xhtml">It can be confusing to have the decorator </span><span id="dx1-217001"/><span class="koboSpan" id="kobo.530.1" xmlns="http://www.w3.org/1999/xhtml">listing the fields to which the validation rule applies. </span><span class="koboSpan" id="kobo.530.2" xmlns="http://www.w3.org/1999/xhtml">Some confusion can </span><span id="dx1-217002"/><span class="koboSpan" id="kobo.531.1" xmlns="http://www.w3.org/1999/xhtml">arise because of the separation between the field definition and the function that validates the values for the field. </span><span class="koboSpan" id="kobo.531.2" xmlns="http://www.w3.org/1999/xhtml">In our example class, the validator applies to the </span><code><span class="koboSpan" id="kobo.532.1" xmlns="http://www.w3.org/1999/xhtml">x</span></code><span class="koboSpan" id="kobo.533.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.534.1" xmlns="http://www.w3.org/1999/xhtml">y</span></code><span class="koboSpan" id="kobo.535.1" xmlns="http://www.w3.org/1999/xhtml"> fields, a detail that might be difficult to spot when first looking at the class.</span></p>
<p><span class="koboSpan" id="kobo.536.1" xmlns="http://www.w3.org/1999/xhtml">The newer design pattern for the analysis model class is shown in the following example for Pydantic version 2:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-155">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.537.1" xmlns="http://www.w3.org/1999/xhtml">from pydantic import BaseModel
from pydantic.functional_validators import field_validator, BeforeValidator

from typing import Annotated

def clean_value(value: str | float) -&gt; str | float:
    match value:
        case str():
            for char in "\N{ZERO WIDTH SPACE}":
                value = value.replace(char, "")
            return value
        case float():
            return value

class SeriesSample(BaseModel):
    x: Annotated[float, BeforeValidator(clean_value)]
    y: Annotated[float, BeforeValidator(clean_value)]</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.538.1" xmlns="http://www.w3.org/1999/xhtml">We’ve omitted the </span><code><span class="koboSpan" id="kobo.539.1" xmlns="http://www.w3.org/1999/xhtml">from_acquire_dataclass()</span></code><span class="koboSpan" id="kobo.540.1" xmlns="http://www.w3.org/1999/xhtml"> method definition, since it doesn’t change.</span></p>
<p><span class="koboSpan" id="kobo.541.1" xmlns="http://www.w3.org/1999/xhtml">The cleaning function is defined </span><span id="dx1-217022"/><span class="koboSpan" id="kobo.542.1" xmlns="http://www.w3.org/1999/xhtml">outside the class, making it more easily reused in a complicated application where a number of rules may be widely reused in several models. </span><span class="koboSpan" id="kobo.542.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.543.1" xmlns="http://www.w3.org/1999/xhtml">Annotated[]</span></code><span class="koboSpan" id="kobo.544.1" xmlns="http://www.w3.org/1999/xhtml"> type hint combines the </span><span id="dx1-217023"/><span class="koboSpan" id="kobo.545.1" xmlns="http://www.w3.org/1999/xhtml">base type with a sequence of validator objects. </span><span class="koboSpan" id="kobo.545.2" xmlns="http://www.w3.org/1999/xhtml">In this example, the base type is </span><code><span class="koboSpan" id="kobo.546.1" xmlns="http://www.w3.org/1999/xhtml">float</span></code><span class="koboSpan" id="kobo.547.1" xmlns="http://www.w3.org/1999/xhtml"> and the validator objects are </span><code><span class="koboSpan" id="kobo.548.1" xmlns="http://www.w3.org/1999/xhtml">BeforeValidator</span></code><span class="koboSpan" id="kobo.549.1" xmlns="http://www.w3.org/1999/xhtml"> objects that contain the function to apply.</span></p>
<p><span class="koboSpan" id="kobo.550.1" xmlns="http://www.w3.org/1999/xhtml">To reduce the obvious duplication, a </span><code><span class="koboSpan" id="kobo.551.1" xmlns="http://www.w3.org/1999/xhtml">TypeAlias</span></code><span class="koboSpan" id="kobo.552.1" xmlns="http://www.w3.org/1999/xhtml"> can be used. </span><span class="koboSpan" id="kobo.552.2" xmlns="http://www.w3.org/1999/xhtml">For example,</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-156">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.553.1" xmlns="http://www.w3.org/1999/xhtml">from typing import Annotated, TypeAlias

CleanFloat: TypeAlias = Annotated[float, BeforeValidator(clean_value)]</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.554.1" xmlns="http://www.w3.org/1999/xhtml">Using an alias permits the model to use the type hint </span><code><span class="koboSpan" id="kobo.555.1" xmlns="http://www.w3.org/1999/xhtml">CleanFloat</span></code><span class="koboSpan" id="kobo.556.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.556.2" xmlns="http://www.w3.org/1999/xhtml">For example </span><code><span class="koboSpan" id="kobo.557.1" xmlns="http://www.w3.org/1999/xhtml">x:</span></code><code><span class="koboSpan" id="kobo.558.1" xmlns="http://www.w3.org/1999/xhtml"> CleanFloat</span></code><span class="koboSpan" id="kobo.559.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.560.1" xmlns="http://www.w3.org/1999/xhtml">Further, the </span><code><span class="koboSpan" id="kobo.561.1" xmlns="http://www.w3.org/1999/xhtml">Annotated</span></code><span class="koboSpan" id="kobo.562.1" xmlns="http://www.w3.org/1999/xhtml"> hints are composable. </span><span class="koboSpan" id="kobo.562.2" xmlns="http://www.w3.org/1999/xhtml">An annotation can add features to a previously-defined annotation. </span><span class="koboSpan" id="kobo.562.3" xmlns="http://www.w3.org/1999/xhtml">This ability to build more sophisticated annotations on top of foundational annotations offers a great deal of promise for defining classes in a succinct and expressive fashion.</span></p>
<p><span class="koboSpan" id="kobo.563.1" xmlns="http://www.w3.org/1999/xhtml">Now that we’ve seen how to implement a single validation, we need to consider the alternatives, and how many different kinds of validation functions an application might need. </span><span id="x1-217027r236"/></p>
</section>
<section class="level3" data-number="13.2.3" id="validation-function-design">
<h3 data-number="13.2.3"><span class="titlemark"><span class="koboSpan" id="kobo.564.1" xmlns="http://www.w3.org/1999/xhtml">9.2.3 </span></span> <span id="x1-2180003"/><span class="koboSpan" id="kobo.565.1" xmlns="http://www.w3.org/1999/xhtml">Validation function design</span></h3>
<p><span class="koboSpan" id="kobo.566.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.567.1" xmlns="http://www.w3.org/1999/xhtml">pydantic</span></code><span class="koboSpan" id="kobo.568.1" xmlns="http://www.w3.org/1999/xhtml"> package offers a vast number of built-in conversions based entirely on annotations. </span><span class="koboSpan" id="kobo.568.2" xmlns="http://www.w3.org/1999/xhtml">While these can </span><span id="dx1-218001"/><span class="koboSpan" id="kobo.569.1" xmlns="http://www.w3.org/1999/xhtml">cover a large number of common cases, there are still some situations that require special validators, and perhaps even special type definitions.</span></p>
<p><span class="koboSpan" id="kobo.570.1" xmlns="http://www.w3.org/1999/xhtml">In </span><a href="#x1-2130004"><em><span class="koboSpan" id="kobo.571.1" xmlns="http://www.w3.org/1999/xhtml">Conversions and processing</span></em></a><span class="koboSpan" id="kobo.572.1" xmlns="http://www.w3.org/1999/xhtml">, we considered some of the kinds of processing that might be required. </span><span class="koboSpan" id="kobo.572.2" xmlns="http://www.w3.org/1999/xhtml">These included the following kinds of conversions:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.573.1" xmlns="http://www.w3.org/1999/xhtml">Decomposing source fields into their atomic components.</span></p></li>
<li><p><span class="koboSpan" id="kobo.574.1" xmlns="http://www.w3.org/1999/xhtml">Merging separated source fields to create proper value. </span><span class="koboSpan" id="kobo.574.2" xmlns="http://www.w3.org/1999/xhtml">This is common with dates and times, for example.</span></p></li>
<li><p><span class="koboSpan" id="kobo.575.1" xmlns="http://www.w3.org/1999/xhtml">Multiple subentities may be present in a feed of samples. </span><span class="koboSpan" id="kobo.575.2" xmlns="http://www.w3.org/1999/xhtml">This can be called a discriminated union: the feed as a whole is a unique of disjoint types, and a discriminator value (or values) distinguishes the various subtypes.</span></p></li>
<li><p><span class="koboSpan" id="kobo.576.1" xmlns="http://www.w3.org/1999/xhtml">A field may be a “token” used to deidentify something about the original source. </span><span class="koboSpan" id="kobo.576.2" xmlns="http://www.w3.org/1999/xhtml">For example, a replacement token for a driver’s license number may replace the real government-issued number to make the individual anonymous.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.577.1" xmlns="http://www.w3.org/1999/xhtml">Additionally, we may have observability considerations that lead us to write our own a unique validator that can write needed log entries or update counters showing how many times a particular validation found problems. </span><span class="koboSpan" id="kobo.577.2" xmlns="http://www.w3.org/1999/xhtml">This enhanced visibility can help pinpoint problems with data that is often irregular or suffers from poor quality control.</span></p>
<p><span class="koboSpan" id="kobo.578.1" xmlns="http://www.w3.org/1999/xhtml">We’ll dive into these concepts more deeply in </span><a href="ch014.xhtml#x1-22900010"><em><span class="koboSpan" id="kobo.579.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.580.1" xmlns="http://www.w3.org/1999/xhtml"> 10</span></em></a><span class="koboSpan" id="kobo.581.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch014.xhtml#x1-22900010"><em><span class="koboSpan" id="kobo.582.1" xmlns="http://www.w3.org/1999/xhtml">Data Cleaning</span></em> <em><span class="koboSpan" id="kobo.583.1" xmlns="http://www.w3.org/1999/xhtml">Features</span></em></a><span class="koboSpan" id="kobo.584.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.584.2" xmlns="http://www.w3.org/1999/xhtml">In </span><a href="ch014.xhtml#x1-22900010"><em><span class="koboSpan" id="kobo.585.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.586.1" xmlns="http://www.w3.org/1999/xhtml"> 10</span></em></a><span class="koboSpan" id="kobo.587.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch014.xhtml#x1-22900010"><em><span class="koboSpan" id="kobo.588.1" xmlns="http://www.w3.org/1999/xhtml">Data Cleaning Features</span></em></a><span class="koboSpan" id="kobo.589.1" xmlns="http://www.w3.org/1999/xhtml">, we’ll also look at features for handling primary and foreign keys. </span><span class="koboSpan" id="kobo.589.2" xmlns="http://www.w3.org/1999/xhtml">For now, we’ll focus on the built-in type conversion functions that are part of Python’s built-in functions, and the standard library. </span><span class="koboSpan" id="kobo.589.3" xmlns="http://www.w3.org/1999/xhtml">But we need to recognize that there are going to be extensions and exceptions.</span></p>
<p><span class="koboSpan" id="kobo.590.1" xmlns="http://www.w3.org/1999/xhtml">We’ll look at the overall design approach in the next section. </span><span id="x1-218002r237"/></p>
</section>
<section class="level3" data-number="13.2.4" id="incremental-design">
<h3 data-number="13.2.4"><span class="titlemark"><span class="koboSpan" id="kobo.591.1" xmlns="http://www.w3.org/1999/xhtml">9.2.4 </span></span> <span id="x1-2190004"/><span class="koboSpan" id="kobo.592.1" xmlns="http://www.w3.org/1999/xhtml">Incremental design</span></h3>
<p><span class="koboSpan" id="kobo.593.1" xmlns="http://www.w3.org/1999/xhtml">The design of the cleaning application is difficult to finalize without detailed knowledge of the source data. </span><span class="koboSpan" id="kobo.593.2" xmlns="http://www.w3.org/1999/xhtml">This </span><span id="dx1-219001"/><span class="koboSpan" id="kobo.594.1" xmlns="http://www.w3.org/1999/xhtml">means the cleaning application depends on lessons learned by making a data inspection notebook. </span><span class="koboSpan" id="kobo.594.2" xmlns="http://www.w3.org/1999/xhtml">One idealized workflow begins with “understand the requirements” and proceeds to “write the code,” treating these two activities as separate, isolated steps. </span><span class="koboSpan" id="kobo.594.3" xmlns="http://www.w3.org/1999/xhtml">This conceptual workflow is a bit of a fallacy. </span><span class="koboSpan" id="kobo.594.4" xmlns="http://www.w3.org/1999/xhtml">It’s often difficult to understand the requirements without a detailed examination of the actual source </span><span id="dx1-219002"/><span class="koboSpan" id="kobo.595.1" xmlns="http://www.w3.org/1999/xhtml">data to reveal the quirks and oddities that are present. </span><span class="koboSpan" id="kobo.595.2" xmlns="http://www.w3.org/1999/xhtml">The examination of the data often leads to the first drafts of data validation functions. </span><span class="koboSpan" id="kobo.595.3" xmlns="http://www.w3.org/1999/xhtml">In this case, the requirements will take the form of draft versions of the code, not a carefully-crafted document.</span></p>
<p><span class="koboSpan" id="kobo.596.1" xmlns="http://www.w3.org/1999/xhtml">This leads to a kind of back-and-forth between </span><em><span class="koboSpan" id="kobo.597.1" xmlns="http://www.w3.org/1999/xhtml">ad-hoc </span></em><span class="koboSpan" id="kobo.598.1" xmlns="http://www.w3.org/1999/xhtml">inspection and a formal data cleaning application. </span><span class="koboSpan" id="kobo.598.2" xmlns="http://www.w3.org/1999/xhtml">This iterative work often leads to a module of functions to handle the problem domain’s data. </span><span class="koboSpan" id="kobo.598.3" xmlns="http://www.w3.org/1999/xhtml">This module can be shared by inspection notebooks as well as automated applications. </span><span class="koboSpan" id="kobo.598.4" xmlns="http://www.w3.org/1999/xhtml">Proper engineering </span><span id="dx1-219003"/><span class="koboSpan" id="kobo.599.1" xmlns="http://www.w3.org/1999/xhtml">follows the </span><strong><span class="koboSpan" id="kobo.600.1" xmlns="http://www.w3.org/1999/xhtml">DRY </span></strong><span class="koboSpan" id="kobo.601.1" xmlns="http://www.w3.org/1999/xhtml">(</span><strong><span class="koboSpan" id="kobo.602.1" xmlns="http://www.w3.org/1999/xhtml">Don’t Repeat Yourself</span></strong><span class="koboSpan" id="kobo.603.1" xmlns="http://www.w3.org/1999/xhtml">) principle: code should not be copied and pasted between modules. </span><span class="koboSpan" id="kobo.603.2" xmlns="http://www.w3.org/1999/xhtml">It should be put into a shared module so it can be reused properly.</span></p>
<p><span class="koboSpan" id="kobo.604.1" xmlns="http://www.w3.org/1999/xhtml">In some cases, two data cleaning functions will be similar. </span><span class="koboSpan" id="kobo.604.2" xmlns="http://www.w3.org/1999/xhtml">Finding this suggests some kind of decomposition is appropriate to separate the common parts from the unique parts. </span><span class="koboSpan" id="kobo.604.3" xmlns="http://www.w3.org/1999/xhtml">The redesign and refactoring are made easier by having a suite of unit tests to confirm that no old functionality was broken when the functions were transformed to remove duplicated code.</span></p>
<p><span class="koboSpan" id="kobo.605.1" xmlns="http://www.w3.org/1999/xhtml">The work of creating cleaning applications is iterative and incremental. </span><span class="koboSpan" id="kobo.605.2" xmlns="http://www.w3.org/1999/xhtml">Rare special cases are — well — rare, and won’t show up until well after the processing pipeline seems finished. </span><span class="koboSpan" id="kobo.605.3" xmlns="http://www.w3.org/1999/xhtml">The unexpected arrival special case data is something like birders seeing a bird outside its expected habitat. </span><span class="koboSpan" id="kobo.605.4" xmlns="http://www.w3.org/1999/xhtml">It helps to think of a data inspection notebook like a bird watcher’s immense spotting scope, used to look closely at one unexpected, rare bird, often in a flock of birds with similar feeding and roosting preferences. </span><span class="koboSpan" id="kobo.605.5" xmlns="http://www.w3.org/1999/xhtml">The presence of the rare bird becomes a new datapoint for ornithologists (and amateur enthusiasts). </span><span class="koboSpan" id="kobo.605.6" xmlns="http://www.w3.org/1999/xhtml">In the case of unexpected data, the inspection notebook’s lessons become a new code for the conversions module.</span></p>
<p><span class="koboSpan" id="kobo.606.1" xmlns="http://www.w3.org/1999/xhtml">The overall main module in the </span><span id="dx1-219004"/><span class="koboSpan" id="kobo.607.1" xmlns="http://www.w3.org/1999/xhtml">data cleaning application will implement the </span><strong><span class="koboSpan" id="kobo.608.1" xmlns="http://www.w3.org/1999/xhtml">command-line interface </span></strong><span class="koboSpan" id="kobo.609.1" xmlns="http://www.w3.org/1999/xhtml">(</span><strong><span class="koboSpan" id="kobo.610.1" xmlns="http://www.w3.org/1999/xhtml">CLI</span></strong><span class="koboSpan" id="kobo.611.1" xmlns="http://www.w3.org/1999/xhtml">). </span><span class="koboSpan" id="kobo.611.2" xmlns="http://www.w3.org/1999/xhtml">We’ll look at this in the next section. </span><span id="x1-219005r238"/></p>
</section>
<section class="level3" data-number="13.2.5" id="cli-application">
<h3 data-number="13.2.5"><span class="titlemark"><span class="koboSpan" id="kobo.612.1" xmlns="http://www.w3.org/1999/xhtml">9.2.5 </span></span> <span id="x1-2200005"/><span class="koboSpan" id="kobo.613.1" xmlns="http://www.w3.org/1999/xhtml">CLI application</span></h3>
<p><span class="koboSpan" id="kobo.614.1" xmlns="http://www.w3.org/1999/xhtml">The UX for </span><span id="dx1-220001"/><span class="koboSpan" id="kobo.615.1" xmlns="http://www.w3.org/1999/xhtml">this application suggests </span><span id="dx1-220002"/><span class="koboSpan" id="kobo.616.1" xmlns="http://www.w3.org/1999/xhtml">that it operates in the following distinct contexts:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.617.1" xmlns="http://www.w3.org/1999/xhtml">As a standalone application. </span><span class="koboSpan" id="kobo.617.2" xmlns="http://www.w3.org/1999/xhtml">The user runs the </span><code><span class="koboSpan" id="kobo.618.1" xmlns="http://www.w3.org/1999/xhtml">src/acquire.py</span></code><span class="koboSpan" id="kobo.619.1" xmlns="http://www.w3.org/1999/xhtml"> program. </span><span class="koboSpan" id="kobo.619.2" xmlns="http://www.w3.org/1999/xhtml">Then, the user runs the </span><code><span class="koboSpan" id="kobo.620.1" xmlns="http://www.w3.org/1999/xhtml">src/clean.py</span></code><span class="koboSpan" id="kobo.621.1" xmlns="http://www.w3.org/1999/xhtml"> program.</span></p></li>
<li><p><span class="koboSpan" id="kobo.622.1" xmlns="http://www.w3.org/1999/xhtml">As a stage in a processing pipeline. </span><span class="koboSpan" id="kobo.622.2" xmlns="http://www.w3.org/1999/xhtml">The user runs a shell command that pipes the output from the </span><code><span class="koboSpan" id="kobo.623.1" xmlns="http://www.w3.org/1999/xhtml">src/acquire.py</span></code><span class="koboSpan" id="kobo.624.1" xmlns="http://www.w3.org/1999/xhtml"> program into the </span><code><span class="koboSpan" id="kobo.625.1" xmlns="http://www.w3.org/1999/xhtml">src/clean.py</span></code><span class="koboSpan" id="kobo.626.1" xmlns="http://www.w3.org/1999/xhtml"> program. </span><span class="koboSpan" id="kobo.626.2" xmlns="http://www.w3.org/1999/xhtml">This is the subject of </span><a href="ch014.xhtml#x1-2510005"><em><span class="koboSpan" id="kobo.627.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.6: Integration</span></em> <em><span class="koboSpan" id="kobo.628.1" xmlns="http://www.w3.org/1999/xhtml">to create an acquisition pipeline</span></em></a><span class="koboSpan" id="kobo.629.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.630.1" xmlns="http://www.w3.org/1999/xhtml">This leads to the following two runtime contexts:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.631.1" xmlns="http://www.w3.org/1999/xhtml">When the application is provided an input path, it’s being used as a stand-alone application.</span></p></li>
<li><p><span class="koboSpan" id="kobo.632.1" xmlns="http://www.w3.org/1999/xhtml">When no input path is provided, the application reads from </span><code><span class="koboSpan" id="kobo.633.1" xmlns="http://www.w3.org/1999/xhtml">sys.stdin</span></code><span class="koboSpan" id="kobo.634.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.635.1" xmlns="http://www.w3.org/1999/xhtml">A similar analysis can apply to the </span><strong><span class="koboSpan" id="kobo.636.1" xmlns="http://www.w3.org/1999/xhtml">acquire </span></strong><span class="koboSpan" id="kobo.637.1" xmlns="http://www.w3.org/1999/xhtml">application. </span><span class="koboSpan" id="kobo.637.2" xmlns="http://www.w3.org/1999/xhtml">If an output path is provided, the application creates and writes the named file. </span><span class="koboSpan" id="kobo.637.3" xmlns="http://www.w3.org/1999/xhtml">If no output path is provided, the application writes to </span><code><span class="koboSpan" id="kobo.638.1" xmlns="http://www.w3.org/1999/xhtml">sys.stdout</span></code><span class="koboSpan" id="kobo.639.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.640.1" xmlns="http://www.w3.org/1999/xhtml">One essential consequence of this is all logging </span><strong><span class="koboSpan" id="kobo.641.1" xmlns="http://www.w3.org/1999/xhtml">must </span></strong><span class="koboSpan" id="kobo.642.1" xmlns="http://www.w3.org/1999/xhtml">be written to </span><code><span class="koboSpan" id="kobo.643.1" xmlns="http://www.w3.org/1999/xhtml">sys.stderr</span></code><span class="koboSpan" id="kobo.644.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-157">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.645.1" xmlns="http://www.w3.org/1999/xhtml">Use </span><strong><span class="koboSpan" id="kobo.646.1" xmlns="http://www.w3.org/1999/xhtml">stdin </span></strong><span class="koboSpan" id="kobo.647.1" xmlns="http://www.w3.org/1999/xhtml">and </span><strong><span class="koboSpan" id="kobo.648.1" xmlns="http://www.w3.org/1999/xhtml">stdout </span></strong><span class="koboSpan" id="kobo.649.1" xmlns="http://www.w3.org/1999/xhtml">exclusively for application data, nothing else.</span></p>
<p><span class="koboSpan" id="kobo.650.1" xmlns="http://www.w3.org/1999/xhtml">Use a consistent, easy-to-parse text format like ND JSON for application data.</span></p>
<p><span class="koboSpan" id="kobo.651.1" xmlns="http://www.w3.org/1999/xhtml">Use </span><strong><span class="koboSpan" id="kobo.652.1" xmlns="http://www.w3.org/1999/xhtml">stderr </span></strong><span class="koboSpan" id="kobo.653.1" xmlns="http://www.w3.org/1999/xhtml">as the destination for all control and error messages.</span></p>
<p><span class="koboSpan" id="kobo.654.1" xmlns="http://www.w3.org/1999/xhtml">This means </span><code><span class="koboSpan" id="kobo.655.1" xmlns="http://www.w3.org/1999/xhtml">print()</span></code><span class="koboSpan" id="kobo.656.1" xmlns="http://www.w3.org/1999/xhtml"> may require the </span><code><span class="koboSpan" id="kobo.657.1" xmlns="http://www.w3.org/1999/xhtml">file=sys.stderr</span></code><span class="koboSpan" id="kobo.658.1" xmlns="http://www.w3.org/1999/xhtml"> to direct debugging output to </span><strong><span class="koboSpan" id="kobo.659.1" xmlns="http://www.w3.org/1999/xhtml">stderr</span></strong><span class="koboSpan" id="kobo.660.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.660.2" xmlns="http://www.w3.org/1999/xhtml">Or, avoid simple </span><code><span class="koboSpan" id="kobo.661.1" xmlns="http://www.w3.org/1999/xhtml">print()</span></code><span class="koboSpan" id="kobo.662.1" xmlns="http://www.w3.org/1999/xhtml"> and use </span><code><span class="koboSpan" id="kobo.663.1" xmlns="http://www.w3.org/1999/xhtml">logger.debug()</span></code><span class="koboSpan" id="kobo.664.1" xmlns="http://www.w3.org/1999/xhtml"> instead.</span></p>
</div>
</div>
<p><span class="koboSpan" id="kobo.665.1" xmlns="http://www.w3.org/1999/xhtml">For this project, the stand-alone </span><span id="dx1-220003"/><span class="koboSpan" id="kobo.666.1" xmlns="http://www.w3.org/1999/xhtml">option is all that’s needed. </span><span class="koboSpan" id="kobo.666.2" xmlns="http://www.w3.org/1999/xhtml">However, it’s important to understand the alternatives that will be added in later projects. </span><span class="koboSpan" id="kobo.666.3" xmlns="http://www.w3.org/1999/xhtml">See </span><a href="ch014.xhtml#x1-2510005"><em><span class="koboSpan" id="kobo.667.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.6: Integration to create an acquisition pipeline</span></em></a><span class="koboSpan" id="kobo.668.1" xmlns="http://www.w3.org/1999/xhtml"> for this more tightly-integrated alternative.</span></p>
<section class="level4 likesubsubsectionHead" data-number="13.2.5.1" id="redirecting-stdout">
<h4 class="likesubsubsectionHead" data-number="13.2.5.1"><span id="x1-2210005"/><span class="koboSpan" id="kobo.669.1" xmlns="http://www.w3.org/1999/xhtml">Redirecting stdout</span></h4>
<p><span class="koboSpan" id="kobo.670.1" xmlns="http://www.w3.org/1999/xhtml">Python provides a handy tool for managing the choice between ”write to an open file” and ”write to </span><strong><span class="koboSpan" id="kobo.671.1" xmlns="http://www.w3.org/1999/xhtml">stdout</span></strong><span class="koboSpan" id="kobo.672.1" xmlns="http://www.w3.org/1999/xhtml">”. </span><span class="koboSpan" id="kobo.672.2" xmlns="http://www.w3.org/1999/xhtml">It involves the following </span><span id="dx1-221001"/><span class="koboSpan" id="kobo.673.1" xmlns="http://www.w3.org/1999/xhtml">essential design principle.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-158">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.674.1" xmlns="http://www.w3.org/1999/xhtml">Always provide file-like objects to functions and methods processing data.</span></p>
</div>
</div>
<p><span class="koboSpan" id="kobo.675.1" xmlns="http://www.w3.org/1999/xhtml">This suggests a data-cleaning function like the following:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-159">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.676.1" xmlns="http://www.w3.org/1999/xhtml">from typing import TextIO

def clean_all(acquire_file: TextIO, analysis_file: TextIO) -&gt; None:
    ...</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.677.1" xmlns="http://www.w3.org/1999/xhtml">This function can use </span><code><span class="koboSpan" id="kobo.678.1" xmlns="http://www.w3.org/1999/xhtml">json.loads()</span></code><span class="koboSpan" id="kobo.679.1" xmlns="http://www.w3.org/1999/xhtml"> to parse each document from the </span><code><span class="koboSpan" id="kobo.680.1" xmlns="http://www.w3.org/1999/xhtml">acquire_file</span></code><span class="koboSpan" id="kobo.681.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.681.2" xmlns="http://www.w3.org/1999/xhtml">It uses </span><code><span class="koboSpan" id="kobo.682.1" xmlns="http://www.w3.org/1999/xhtml">json.dumps()</span></code><span class="koboSpan" id="kobo.683.1" xmlns="http://www.w3.org/1999/xhtml"> to save each document to the </span><code><span class="koboSpan" id="kobo.684.1" xmlns="http://www.w3.org/1999/xhtml">analysis_file</span></code><span class="koboSpan" id="kobo.685.1" xmlns="http://www.w3.org/1999/xhtml"> to be used for later analytics.</span></p>
<p><span class="koboSpan" id="kobo.686.1" xmlns="http://www.w3.org/1999/xhtml">The overall application can then make a choice among four possible ways to use this </span><code><span class="koboSpan" id="kobo.687.1" xmlns="http://www.w3.org/1999/xhtml">clean_all()</span></code><span class="koboSpan" id="kobo.688.1" xmlns="http://www.w3.org/1999/xhtml"> function:</span></p>
<ul>
<li><p><strong><span class="koboSpan" id="kobo.689.1" xmlns="http://www.w3.org/1999/xhtml">Stand-alone</span></strong><span class="koboSpan" id="kobo.690.1" xmlns="http://www.w3.org/1999/xhtml">: This means </span><code><span class="koboSpan" id="kobo.691.1" xmlns="http://www.w3.org/1999/xhtml">with</span></code><span class="koboSpan" id="kobo.692.1" xmlns="http://www.w3.org/1999/xhtml"> statements </span><span id="dx1-221006"/><span class="koboSpan" id="kobo.693.1" xmlns="http://www.w3.org/1999/xhtml">manage the open files created from the </span><code><span class="koboSpan" id="kobo.694.1" xmlns="http://www.w3.org/1999/xhtml">Path</span></code><span class="koboSpan" id="kobo.695.1" xmlns="http://www.w3.org/1999/xhtml"> names provided as argument values.</span></p></li>
<li><p><strong><span class="koboSpan" id="kobo.696.1" xmlns="http://www.w3.org/1999/xhtml">Head</span></strong> <strong><span class="koboSpan" id="kobo.697.1" xmlns="http://www.w3.org/1999/xhtml">of a pipeline</span></strong><span class="koboSpan" id="kobo.698.1" xmlns="http://www.w3.org/1999/xhtml">: A </span><code><span class="koboSpan" id="kobo.699.1" xmlns="http://www.w3.org/1999/xhtml">with</span></code><span class="koboSpan" id="kobo.700.1" xmlns="http://www.w3.org/1999/xhtml"> statement </span><span id="dx1-221007"/><span class="koboSpan" id="kobo.701.1" xmlns="http://www.w3.org/1999/xhtml">can manage an open file passed to </span><code><span class="koboSpan" id="kobo.702.1" xmlns="http://www.w3.org/1999/xhtml">acquire_file</span></code><span class="koboSpan" id="kobo.703.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.703.2" xmlns="http://www.w3.org/1999/xhtml">The value of </span><code><span class="koboSpan" id="kobo.704.1" xmlns="http://www.w3.org/1999/xhtml">analysis_file</span></code><span class="koboSpan" id="kobo.705.1" xmlns="http://www.w3.org/1999/xhtml"> is </span><code><span class="koboSpan" id="kobo.706.1" xmlns="http://www.w3.org/1999/xhtml">sys.stdout</span></code><span class="koboSpan" id="kobo.707.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p></li>
<li><p><strong><span class="koboSpan" id="kobo.708.1" xmlns="http://www.w3.org/1999/xhtml">Tail of a pipeline</span></strong><span class="koboSpan" id="kobo.709.1" xmlns="http://www.w3.org/1999/xhtml">: The acquired </span><span id="dx1-221008"/><span class="koboSpan" id="kobo.710.1" xmlns="http://www.w3.org/1999/xhtml">input file is </span><code><span class="koboSpan" id="kobo.711.1" xmlns="http://www.w3.org/1999/xhtml">sys.stdin</span></code><span class="koboSpan" id="kobo.712.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.712.2" xmlns="http://www.w3.org/1999/xhtml">A </span><code><span class="koboSpan" id="kobo.713.1" xmlns="http://www.w3.org/1999/xhtml">with</span></code><span class="koboSpan" id="kobo.714.1" xmlns="http://www.w3.org/1999/xhtml"> statement manages an open file (in write mode) for the </span><code><span class="koboSpan" id="kobo.715.1" xmlns="http://www.w3.org/1999/xhtml">analysis_file</span></code><span class="koboSpan" id="kobo.716.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p></li>
<li><p><strong><span class="koboSpan" id="kobo.717.1" xmlns="http://www.w3.org/1999/xhtml">Middle of</span></strong> <strong><span class="koboSpan" id="kobo.718.1" xmlns="http://www.w3.org/1999/xhtml">a pipeline</span></strong><span class="koboSpan" id="kobo.719.1" xmlns="http://www.w3.org/1999/xhtml">: The </span><code><span class="koboSpan" id="kobo.720.1" xmlns="http://www.w3.org/1999/xhtml">acquire_file</span></code><span class="koboSpan" id="kobo.721.1" xmlns="http://www.w3.org/1999/xhtml"> is </span><code><span class="koboSpan" id="kobo.722.1" xmlns="http://www.w3.org/1999/xhtml">sys.stdin</span></code><span class="koboSpan" id="kobo.723.1" xmlns="http://www.w3.org/1999/xhtml">; the </span><code><span class="koboSpan" id="kobo.724.1" xmlns="http://www.w3.org/1999/xhtml">analysis_file</span></code><span class="koboSpan" id="kobo.725.1" xmlns="http://www.w3.org/1999/xhtml"> is </span><code><span class="koboSpan" id="kobo.726.1" xmlns="http://www.w3.org/1999/xhtml">sys.stdout</span></code><span class="koboSpan" id="kobo.727.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.728.1" xmlns="http://www.w3.org/1999/xhtml">Now that we’ve looked at a </span><span id="dx1-221009"/><span class="koboSpan" id="kobo.729.1" xmlns="http://www.w3.org/1999/xhtml">number of technical approaches, we’ll turn to the list of deliverables for this project in the next section. </span><span id="x1-221010r232"/></p>
</section>
</section>
</section>
<section class="level2" data-number="13.3" id="deliverables-11">
<h2 data-number="13.3"><span class="titlemark"><span class="koboSpan" id="kobo.730.1" xmlns="http://www.w3.org/1999/xhtml">9.3 </span></span> <span id="x1-2220003"/><span class="koboSpan" id="kobo.731.1" xmlns="http://www.w3.org/1999/xhtml">Deliverables</span></h2>
<p><span class="koboSpan" id="kobo.732.1" xmlns="http://www.w3.org/1999/xhtml">This project has </span><span id="dx1-222001"/><span class="koboSpan" id="kobo.733.1" xmlns="http://www.w3.org/1999/xhtml">the following deliverables:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.734.1" xmlns="http://www.w3.org/1999/xhtml">Documentation in the </span><code><span class="koboSpan" id="kobo.735.1" xmlns="http://www.w3.org/1999/xhtml">docs</span></code><span class="koboSpan" id="kobo.736.1" xmlns="http://www.w3.org/1999/xhtml"> folder.</span></p></li>
<li><p><span class="koboSpan" id="kobo.737.1" xmlns="http://www.w3.org/1999/xhtml">Acceptance tests in the </span><code><span class="koboSpan" id="kobo.738.1" xmlns="http://www.w3.org/1999/xhtml">tests/features</span></code><span class="koboSpan" id="kobo.739.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.740.1" xmlns="http://www.w3.org/1999/xhtml">tests/steps</span></code><span class="koboSpan" id="kobo.741.1" xmlns="http://www.w3.org/1999/xhtml"> folders.</span></p></li>
<li><p><span class="koboSpan" id="kobo.742.1" xmlns="http://www.w3.org/1999/xhtml">Unit tests for the application modules in the </span><code><span class="koboSpan" id="kobo.743.1" xmlns="http://www.w3.org/1999/xhtml">tests</span></code><span class="koboSpan" id="kobo.744.1" xmlns="http://www.w3.org/1999/xhtml"> folder.</span></p></li>
<li><p><span class="koboSpan" id="kobo.745.1" xmlns="http://www.w3.org/1999/xhtml">Application to clean some acquired data and apply simple conversions to a few fields. </span><span class="koboSpan" id="kobo.745.2" xmlns="http://www.w3.org/1999/xhtml">Later projects will add more complex validation rules.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.746.1" xmlns="http://www.w3.org/1999/xhtml">We’ll look at a few of these deliverables in a little more detail.</span></p>
<p><span class="koboSpan" id="kobo.747.1" xmlns="http://www.w3.org/1999/xhtml">When starting a new kind of application, it often makes sense to start with acceptance tests. </span><span class="koboSpan" id="kobo.747.2" xmlns="http://www.w3.org/1999/xhtml">Later, when adding features, the new acceptance tests may be less important than new unit tests for the features. </span><span class="koboSpan" id="kobo.747.3" xmlns="http://www.w3.org/1999/xhtml">We’ll start by looking at a new scenario for this new application. </span><span id="x1-222002r239"/></p>
<section class="level3" data-number="13.3.1" id="acceptance-tests-3">
<h3 data-number="13.3.1"><span class="titlemark"><span class="koboSpan" id="kobo.748.1" xmlns="http://www.w3.org/1999/xhtml">9.3.1 </span></span> <span id="x1-2230001"/><span class="koboSpan" id="kobo.749.1" xmlns="http://www.w3.org/1999/xhtml">Acceptance tests</span></h3>
<p><span class="koboSpan" id="kobo.750.1" xmlns="http://www.w3.org/1999/xhtml">As we noted in </span><a href="ch008.xhtml#x1-780004"><em><span class="koboSpan" id="kobo.751.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.752.1" xmlns="http://www.w3.org/1999/xhtml"> 4</span></em></a><span class="koboSpan" id="kobo.753.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch008.xhtml#x1-780004"><em><span class="koboSpan" id="kobo.754.1" xmlns="http://www.w3.org/1999/xhtml">Data Acquisition Features: Web APIs and Scraping</span></em></a><span class="koboSpan" id="kobo.755.1" xmlns="http://www.w3.org/1999/xhtml">, we can provide a large </span><span id="dx1-223001"/><span class="koboSpan" id="kobo.756.1" xmlns="http://www.w3.org/1999/xhtml">block of text as part of a Gherkin scenario. </span><span class="koboSpan" id="kobo.756.2" xmlns="http://www.w3.org/1999/xhtml">This can be the </span><span id="dx1-223002"/><span class="koboSpan" id="kobo.757.1" xmlns="http://www.w3.org/1999/xhtml">contents of an input file. </span><span class="koboSpan" id="kobo.757.2" xmlns="http://www.w3.org/1999/xhtml">We can consider something like the following scenario.</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-160">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.758.1" xmlns="http://www.w3.org/1999/xhtml">Scenario: Valid file is recognized.
    </span><span class="koboSpan" id="kobo.758.2" xmlns="http://www.w3.org/1999/xhtml">Given a file "example_1.ndjson" with the following content
        """
        {"x": "1.2", "y": "3.4"}
        {"x": "five", "z": null}
        """
    When the clean tool is run
    Then the output shows 1 good records
    And the output shows 1 faulty records</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.759.1" xmlns="http://www.w3.org/1999/xhtml">This kind of scenario lets us define source documents with valid data. </span><span class="koboSpan" id="kobo.759.2" xmlns="http://www.w3.org/1999/xhtml">We can also define source documents with invalid data.</span></p>
<p><span class="koboSpan" id="kobo.760.1" xmlns="http://www.w3.org/1999/xhtml">We can use the </span><code><span class="koboSpan" id="kobo.761.1" xmlns="http://www.w3.org/1999/xhtml">Then</span></code><span class="koboSpan" id="kobo.762.1" xmlns="http://www.w3.org/1999/xhtml"> steps to confirm additional details of the output. </span><span class="koboSpan" id="kobo.762.2" xmlns="http://www.w3.org/1999/xhtml">For example, if we’ve decided to make all of the cleaning operations visible, the test scenario can confirm the output contains all of the cleanup operations that were applied.</span></p>
<p><span class="koboSpan" id="kobo.763.1" xmlns="http://www.w3.org/1999/xhtml">The variety of bad data </span><span id="dx1-223012"/><span class="koboSpan" id="kobo.764.1" xmlns="http://www.w3.org/1999/xhtml">examples and the number of combinations of good and bad data suggest there can be a lot of scenarios for this </span><span id="dx1-223013"/><span class="koboSpan" id="kobo.765.1" xmlns="http://www.w3.org/1999/xhtml">kind of application. </span><span class="koboSpan" id="kobo.765.2" xmlns="http://www.w3.org/1999/xhtml">Each time new data shows up that is acquired, but cannot be cleaned, new examples will be added to these acceptance test cases.</span></p>
<p><span class="koboSpan" id="kobo.766.1" xmlns="http://www.w3.org/1999/xhtml">It can, in some cases, be very helpful to publish the scenarios widely so all of the stakeholders can understand the data cleaning operations. </span><span class="koboSpan" id="kobo.766.2" xmlns="http://www.w3.org/1999/xhtml">The Gherkin language is designed to make it possible for people with limited technical skills to contribute to the test cases.</span></p>
<p><span class="koboSpan" id="kobo.767.1" xmlns="http://www.w3.org/1999/xhtml">We also need scenarios to run the application from the command-line. </span><span class="koboSpan" id="kobo.767.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.768.1" xmlns="http://www.w3.org/1999/xhtml">When</span></code><span class="koboSpan" id="kobo.769.1" xmlns="http://www.w3.org/1999/xhtml"> step definition for these scenarios will be </span><code><span class="koboSpan" id="kobo.770.1" xmlns="http://www.w3.org/1999/xhtml">subprocess.run()</span></code><span class="koboSpan" id="kobo.771.1" xmlns="http://www.w3.org/1999/xhtml"> to invoke the </span><strong><span class="koboSpan" id="kobo.772.1" xmlns="http://www.w3.org/1999/xhtml">clean </span></strong><span class="koboSpan" id="kobo.773.1" xmlns="http://www.w3.org/1999/xhtml">application, or to invoke a shell command that includes the </span><strong><span class="koboSpan" id="kobo.774.1" xmlns="http://www.w3.org/1999/xhtml">clean</span></strong><span class="koboSpan" id="kobo.775.1" xmlns="http://www.w3.org/1999/xhtml"> application. </span><span id="x1-223014r242"/></p>
</section>
<section class="level3" data-number="13.3.2" id="unit-tests-for-the-model-features">
<h3 data-number="13.3.2"><span class="titlemark"><span class="koboSpan" id="kobo.776.1" xmlns="http://www.w3.org/1999/xhtml">9.3.2 </span></span> <span id="x1-2240002"/><span class="koboSpan" id="kobo.777.1" xmlns="http://www.w3.org/1999/xhtml">Unit tests for the model features</span></h3>
<p><span class="koboSpan" id="kobo.778.1" xmlns="http://www.w3.org/1999/xhtml">It’s important to have automated unit tests for the model definition classes.</span></p>
<p><span class="koboSpan" id="kobo.779.1" xmlns="http://www.w3.org/1999/xhtml">It’s also important to </span><strong><span class="koboSpan" id="kobo.780.1" xmlns="http://www.w3.org/1999/xhtml">not </span></strong><span class="koboSpan" id="kobo.781.1" xmlns="http://www.w3.org/1999/xhtml">test the </span><code><span class="koboSpan" id="kobo.782.1" xmlns="http://www.w3.org/1999/xhtml">pydantic</span></code><span class="koboSpan" id="kobo.783.1" xmlns="http://www.w3.org/1999/xhtml"> components. </span><span class="koboSpan" id="kobo.783.2" xmlns="http://www.w3.org/1999/xhtml">We don’t, for example, need to test the ordinary string-to-float </span><span id="dx1-224001"/><span class="koboSpan" id="kobo.784.1" xmlns="http://www.w3.org/1999/xhtml">conversions the </span><code><span class="koboSpan" id="kobo.785.1" xmlns="http://www.w3.org/1999/xhtml">pydantic</span></code><span class="koboSpan" id="kobo.786.1" xmlns="http://www.w3.org/1999/xhtml"> module already does; we can trust this works perfectly.</span></p>
<p><span class="koboSpan" id="kobo.787.1" xmlns="http://www.w3.org/1999/xhtml">We </span><strong><span class="koboSpan" id="kobo.788.1" xmlns="http://www.w3.org/1999/xhtml">must </span></strong><span class="koboSpan" id="kobo.789.1" xmlns="http://www.w3.org/1999/xhtml">test the validator functions we’ve written. </span><span class="koboSpan" id="kobo.789.2" xmlns="http://www.w3.org/1999/xhtml">This means providing test cases to exercise the various features of the validators. </span><span class="koboSpan" id="kobo.789.3" xmlns="http://www.w3.org/1999/xhtml">Additionally, any overall </span><code><span class="koboSpan" id="kobo.790.1" xmlns="http://www.w3.org/1999/xhtml">from_acquire_dataclass()</span></code><span class="koboSpan" id="kobo.791.1" xmlns="http://www.w3.org/1999/xhtml"> method needs to have test cases.</span></p>
<p><span class="koboSpan" id="kobo.792.1" xmlns="http://www.w3.org/1999/xhtml">Each of these test scenarios works with a given acquired document with the raw data. </span><span class="koboSpan" id="kobo.792.2" xmlns="http://www.w3.org/1999/xhtml">When the </span><code><span class="koboSpan" id="kobo.793.1" xmlns="http://www.w3.org/1999/xhtml">from_acquire_dataclass()</span></code><span class="koboSpan" id="kobo.794.1" xmlns="http://www.w3.org/1999/xhtml"> method is evaluated, then there may be an exception or a resulting analytic model document is created.</span></p>
<p><span class="koboSpan" id="kobo.795.1" xmlns="http://www.w3.org/1999/xhtml">The exception testing can make use of the </span><code><span class="koboSpan" id="kobo.796.1" xmlns="http://www.w3.org/1999/xhtml">pytest.raises()</span></code><span class="koboSpan" id="kobo.797.1" xmlns="http://www.w3.org/1999/xhtml"> context manager. </span><span class="koboSpan" id="kobo.797.2" xmlns="http://www.w3.org/1999/xhtml">The test is written using a </span><code><span class="koboSpan" id="kobo.798.1" xmlns="http://www.w3.org/1999/xhtml">with</span></code><span class="koboSpan" id="kobo.799.1" xmlns="http://www.w3.org/1999/xhtml"> statement to capture the exception.</span></p>
<p><span class="koboSpan" id="kobo.800.1" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://docs.pytest.org/en/7.2.x/how-to/assert.html#assertions-about-expected-exceptions"><span class="koboSpan" id="kobo.801.1" xmlns="http://www.w3.org/1999/xhtml">https://docs.pytest.org/en/7.2.x/how-to/assert.html#assertions-about-expected-exceptions</span></a><span class="koboSpan" id="kobo.802.1" xmlns="http://www.w3.org/1999/xhtml"> for examples.</span></p>
<p><span class="koboSpan" id="kobo.803.1" xmlns="http://www.w3.org/1999/xhtml">Of course, we also need to </span><span id="dx1-224002"/><span class="koboSpan" id="kobo.804.1" xmlns="http://www.w3.org/1999/xhtml">test the processing that’s being done. </span><span class="koboSpan" id="kobo.804.2" xmlns="http://www.w3.org/1999/xhtml">By design, there isn’t very much processing involved in this kind of application. </span><span class="koboSpan" id="kobo.804.3" xmlns="http://www.w3.org/1999/xhtml">The bulk of the processing can be only a few lines of code to consume the raw model objects and produce the analytical objects. </span><span class="koboSpan" id="kobo.804.4" xmlns="http://www.w3.org/1999/xhtml">Most of the work will be delegated to modules like </span><code><span class="koboSpan" id="kobo.805.1" xmlns="http://www.w3.org/1999/xhtml">json</span></code><span class="koboSpan" id="kobo.806.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.807.1" xmlns="http://www.w3.org/1999/xhtml">pydantic</span></code><span class="koboSpan" id="kobo.808.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span id="x1-224003r243"/></p>
</section>
<section class="level3" data-number="13.3.3" id="application-to-clean-data-and-create-an-ndjson-interim-file">
<h3 data-number="13.3.3"><span class="titlemark"><span class="koboSpan" id="kobo.809.1" xmlns="http://www.w3.org/1999/xhtml">9.3.3 </span></span> <span id="x1-2250003"/><span class="koboSpan" id="kobo.810.1" xmlns="http://www.w3.org/1999/xhtml">Application to clean data and create an NDJSON interim file</span></h3>
<p><span class="koboSpan" id="kobo.811.1" xmlns="http://www.w3.org/1999/xhtml">Now that we have acceptance and unit test suites, we’ll need to create the </span><code><span class="koboSpan" id="kobo.812.1" xmlns="http://www.w3.org/1999/xhtml">clean</span></code><span class="koboSpan" id="kobo.813.1" xmlns="http://www.w3.org/1999/xhtml"> application. </span><span class="koboSpan" id="kobo.813.2" xmlns="http://www.w3.org/1999/xhtml">Initially, we can create a place-holder application, just to see the test suite fail. </span><span class="koboSpan" id="kobo.813.3" xmlns="http://www.w3.org/1999/xhtml">Then we can fill in the various </span><span id="dx1-225001"/><span class="koboSpan" id="kobo.814.1" xmlns="http://www.w3.org/1999/xhtml">pieces until the application – as a whole – works.</span></p>
<p><span class="koboSpan" id="kobo.815.1" xmlns="http://www.w3.org/1999/xhtml">Flexibility is paramount in this application. </span><span class="koboSpan" id="kobo.815.2" xmlns="http://www.w3.org/1999/xhtml">In the next chapter, </span><a href="ch014.xhtml#x1-22900010"><em><span class="koboSpan" id="kobo.816.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.817.1" xmlns="http://www.w3.org/1999/xhtml"> 10</span></em></a><span class="koboSpan" id="kobo.818.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch014.xhtml#x1-22900010"><em><span class="koboSpan" id="kobo.819.1" xmlns="http://www.w3.org/1999/xhtml">Data Cleaning Features</span></em></a><span class="koboSpan" id="kobo.820.1" xmlns="http://www.w3.org/1999/xhtml">, we will introduce a large number of </span><span id="dx1-225002"/><span class="koboSpan" id="kobo.821.1" xmlns="http://www.w3.org/1999/xhtml">data validation scenarios. </span><span class="koboSpan" id="kobo.821.2" xmlns="http://www.w3.org/1999/xhtml">In </span><a href="ch015.xhtml#x1-26400011"><em><span class="koboSpan" id="kobo.822.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.823.1" xmlns="http://www.w3.org/1999/xhtml"> 11</span></em></a><span class="koboSpan" id="kobo.824.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch015.xhtml#x1-26400011"><em><span class="koboSpan" id="kobo.825.1" xmlns="http://www.w3.org/1999/xhtml">Project 3.7: Interim Data Persistence</span></em></a><span class="koboSpan" id="kobo.826.1" xmlns="http://www.w3.org/1999/xhtml"> we’ll revisit the idea of saving the cleaned data. </span><span class="koboSpan" id="kobo.826.2" xmlns="http://www.w3.org/1999/xhtml">For now, it’s imperative to create clean data; later, we can consider what format might be best. </span><span id="x1-225003r241"/></p>
</section>
</section>
<section class="level2" data-number="13.4" id="summary-8">
<h2 data-number="13.4"><span class="titlemark"><span class="koboSpan" id="kobo.827.1" xmlns="http://www.w3.org/1999/xhtml">9.4 </span></span> <span id="x1-2260004"/><span class="koboSpan" id="kobo.828.1" xmlns="http://www.w3.org/1999/xhtml">Summary</span></h2>
<p><span class="koboSpan" id="kobo.829.1" xmlns="http://www.w3.org/1999/xhtml">This chapter has covered a number of aspects of data validation and cleaning applications:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.830.1" xmlns="http://www.w3.org/1999/xhtml">CLI architecture and how to design a simple pipeline of processes.</span></p></li>
<li><p><span class="koboSpan" id="kobo.831.1" xmlns="http://www.w3.org/1999/xhtml">The core concepts of validating, cleaning, converting, and standardizing raw data.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.832.1" xmlns="http://www.w3.org/1999/xhtml">In the next chapter, we’ll dive more deeply into a number of data cleaning and standardizing features. </span><span class="koboSpan" id="kobo.832.2" xmlns="http://www.w3.org/1999/xhtml">Those projects will all build on this base application framework. </span><span class="koboSpan" id="kobo.832.3" xmlns="http://www.w3.org/1999/xhtml">After those projects, the next two chapters will look a little more closely at the analytical data persistence choices, and provide an integrated web service for providing cleaned data to other stakeholders. </span><span id="x1-226001r245"/></p>
</section>
<section class="level2" data-number="13.5" id="extras-7">
<h2 data-number="13.5"><span class="titlemark"><span class="koboSpan" id="kobo.833.1" xmlns="http://www.w3.org/1999/xhtml">9.5 </span></span> <span id="x1-2270005"/><span class="koboSpan" id="kobo.834.1" xmlns="http://www.w3.org/1999/xhtml">Extras</span></h2>
<p><span class="koboSpan" id="kobo.835.1" xmlns="http://www.w3.org/1999/xhtml">Here are some ideas for you to add to this project. </span><span id="x1-227001r244"/></p>
<section class="level3" data-number="13.5.1" id="create-an-output-file-with-rejected-samples">
<h3 data-number="13.5.1"><span class="titlemark"><span class="koboSpan" id="kobo.836.1" xmlns="http://www.w3.org/1999/xhtml">9.5.1 </span></span> <span id="x1-2280001"/><span class="koboSpan" id="kobo.837.1" xmlns="http://www.w3.org/1999/xhtml">Create an output file with rejected samples</span></h3>
<p><span class="koboSpan" id="kobo.838.1" xmlns="http://www.w3.org/1999/xhtml">In </span><a href="#x1-2140005"><em><span class="koboSpan" id="kobo.839.1" xmlns="http://www.w3.org/1999/xhtml">Error reports</span></em></a><span class="koboSpan" id="kobo.840.1" xmlns="http://www.w3.org/1999/xhtml"> we suggested there are times when it’s appropriate to create a file of rejected samples. </span><span class="koboSpan" id="kobo.840.2" xmlns="http://www.w3.org/1999/xhtml">For the examples in this book — many of which are drawn from well-curated, carefully managed data sets — it can feel a bit odd to design an application that will reject data.</span></p>
<p><span class="koboSpan" id="kobo.841.1" xmlns="http://www.w3.org/1999/xhtml">For enterprise applications, data rejection is a common need.</span></p>
<p><span class="koboSpan" id="kobo.842.1" xmlns="http://www.w3.org/1999/xhtml">It can help to look at a data set like this: </span><a class="url" href="https://datahub.io/core/co2-ppm"><span class="koboSpan" id="kobo.843.1" xmlns="http://www.w3.org/1999/xhtml">https://datahub.io/core/co2-ppm</span></a><span class="koboSpan" id="kobo.844.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.844.2" xmlns="http://www.w3.org/1999/xhtml">This contains data same with measurements of CO2 levels measures with units of ppm, parts per million.</span></p>
<p><span class="koboSpan" id="kobo.845.1" xmlns="http://www.w3.org/1999/xhtml">This has some samples with an invalid number of days in the month. </span><span class="koboSpan" id="kobo.845.2" xmlns="http://www.w3.org/1999/xhtml">It has some samples where a monthly CO2 level wasn’t recorded.</span></p>
<p><span class="koboSpan" id="kobo.846.1" xmlns="http://www.w3.org/1999/xhtml">It can be insightful to use a rejection file to divide this data set into clearly usable records, and records that are not as clearly usable.</span></p>
<p><span class="koboSpan" id="kobo.847.1" xmlns="http://www.w3.org/1999/xhtml">The output will </span><strong><span class="koboSpan" id="kobo.848.1" xmlns="http://www.w3.org/1999/xhtml">not </span></strong><span class="koboSpan" id="kobo.849.1" xmlns="http://www.w3.org/1999/xhtml">reflect the analysis model. </span><span class="koboSpan" id="kobo.849.2" xmlns="http://www.w3.org/1999/xhtml">These objects will reflect the acquire model; they are the items that would not convert properly from the acquired structure to the desired analysis structure. </span><span id="x1-228001r225"/></p>
</section>
</section>
</section>
</body>
</html>
