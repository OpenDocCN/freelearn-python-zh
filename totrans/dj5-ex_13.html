<html><head></head><body>
<div><h1 class="chapterNumber">13</h1>
<h1 class="chapterTitle" id="_idParaDest-353">Creating a Content Management System</h1>
<p class="normal">In the previous chapter, you created the application models for the e-learning platform and learned how to create and apply data fixtures for models. You created a custom model field to order objects and implemented user authentication.</p>
<p class="normal">In this chapter, you will learn how to build the functionality for instructors to create courses and manage the contents of those courses in a versatile and efficient manner.</p>
<p class="normal">You will be introduced to class-based views, which offer a new perspective to build your application compared to the function-based views you have built in previous examples. You will also explore code reusability and modularity through the use of mixins, which are techniques that you can apply in future projects.</p>
<p class="normal">In this chapter, you will learn how to:</p>
<ul>
<li class="bulletList">Create a <strong class="keyWord">content management system</strong> (<strong class="keyWord">CMS</strong>) using class-based views and mixins</li>
<li class="bulletList">Build formsets and model formsets to edit course modules and module contents</li>
<li class="bulletList">Manage groups and permissions</li>
<li class="bulletList">Implement a drag-and-drop functionality to reorder modules and content</li>
</ul>
<h1 class="heading-1" id="_idParaDest-354">Functional overview</h1>
<p class="normal"><em class="italic">Figure 13.1</em> shows a representation of the views, templates, and functionalities that will be built in this chapter:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_13_01.png"/></figure>
<p class="packt_figref">Figure 13.1: Diagram of functionalities built in Chapter 13</p>
<p class="normal">In this chapter, you will implement different class-based views. You will create the mixin classes <code class="inlineCode">OwnerMixin</code>, <code class="inlineCode">OwnerEditMixin</code>, and <code class="inlineCode">OwnerCourseMixin</code>, which will contain common functionality that you will reuse in other classes. You will create <strong class="keyWord">CRUD</strong> (<strong class="keyWord">Create</strong>, <strong class="keyWord">Read</strong>, <strong class="keyWord">Update</strong>, <strong class="keyWord">Delete</strong>) views for the <code class="inlineCode">Course</code> model by implementing <code class="inlineCode">ManageCourseListView</code> to list courses, <code class="inlineCode">CourseCreateView</code> to create courses, <code class="inlineCode">CourseUpdateView</code> to update courses, and <code class="inlineCode">CourseDeleteView</code> to delete courses. You will build the <code class="inlineCode">CourseModuleUpdateView</code> view to add/edit/delete course modules and <code class="inlineCode">ModuleContentListView</code> to list the module’s contents. You will also implement <code class="inlineCode">ContentCreateUpdateView</code> to create and update course contents and <code class="inlineCode">ContentDeleteView</code> to delete contents. You will finally implement a drag-and-drop functionality to reorder course modules and contents using the <code class="inlineCode">ModuleOrderView</code> and <code class="inlineCode">ContentOrderView</code> views, respectively.</p>
<p class="normal">Note that all views that inherit the mixin <code class="inlineCode">OwnerCourseMixin</code> redirect the user back to the <code class="inlineCode">ManageCourseListView</code> view after a successful action. These redirects have not been added to the diagram for simplicity.</p>
<p class="normal">The source code for this chapter can be found at <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter13">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter13</a>.</p>
<p class="normal">All Python modules used in this chapter are included in the <code class="inlineCode">requirements.txt</code> file in the source code that comes along with this chapter. You can follow the instructions to install each Python module below or you can install all the requirements at once with the command <code class="inlineCode">python -m pip install -r requirements.txt</code>.</p>
<h1 class="heading-1" id="_idParaDest-355">Creating a CMS</h1>
<p class="normal">Now that you have<a id="_idIndexMarker1164"/> created a versatile data model, you are going to build the CMS. The CMS will allow instructors to create courses and manage their content. You <a id="_idIndexMarker1165"/>need to provide the following functionality:</p>
<ul>
<li class="bulletList">List the courses created by the instructor</li>
<li class="bulletList">Create, edit, and delete courses</li>
<li class="bulletList">Add modules to a course and reorder them</li>
<li class="bulletList">Add different types of content to each module</li>
<li class="bulletList">Reorder course modules and content</li>
</ul>
<p class="normal">Let’s start with the basic CRUD views.</p>
<h2 class="heading-2" id="_idParaDest-356">Creating class-based views</h2>
<p class="normal">You are going<a id="_idIndexMarker1166"/> to build views to<a id="_idIndexMarker1167"/> create, edit, and delete courses. You will use class-based views for this. Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">courses</code> application and add the following code:</p>
<pre class="programlisting code"><code class="hljs-code">from django.views.generic.list import ListView
from .models import Course
class ManageCourseListView(ListView):
    model = Course
    template_name = 'courses/manage/course/list.html'
def get_queryset(self):
        qs = super().get_queryset()
        return qs.filter(owner=self.request.user)
</code></pre>
<p class="normal">This is the <code class="inlineCode">ManageCourseListView</code> view. It inherits from Django’s generic <code class="inlineCode">ListView</code>. You override the <code class="inlineCode">get_queryset()</code> method of the view to retrieve only courses created by the current user. To prevent users from editing, updating, or deleting courses they didn’t create, you will also need to override the <code class="inlineCode">get_queryset()</code> method in the create, update, and delete views. When you need to provide a specific behavior for several class-based views, it is recommended that you use <em class="italic">mixins</em>.</p>
<h2 class="heading-2" id="_idParaDest-357">Using mixins for class-based views</h2>
<p class="normal">Mixins are <a id="_idIndexMarker1168"/>a special <a id="_idIndexMarker1169"/>kind of multiple inheritance for a class. If you<a id="_idIndexMarker1170"/> are new to mixins in Python, all you need to understand is that they are a type of class designed to supply methods to other classes but aren’t intended to be used independently. This allows you to develop shared functionalities that can be incorporated into various classes in a modular manner, simply by having those classes inherit from mixins. The concept is similar to a base class but you can use multiple mixins to extend the functionality of a given class.</p>
<p class="normal">There are two main situations for using mixins:</p>
<ul>
<li class="bulletList">You want to provide multiple optional features for a class</li>
<li class="bulletList">You want to use a particular feature in several classes</li>
</ul>
<p class="normal">Django comes with several mixins that provide additional functionality to your class-based views. You can learn more about mixins at <a href="https://docs.djangoproject.com/en/5.0/topics/class-based-views/mixins/">https://docs.djangoproject.com/en/5.0/topics/class-based-views/mixins/</a>.</p>
<p class="normal">You are going to implement a common behavior for multiple views in mixin classes and use it for the <a id="_idIndexMarker1171"/>course <a id="_idIndexMarker1172"/>views. Edit <a id="_idIndexMarker1173"/>the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">courses</code> application and modify it as follows:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.urls </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> reverse_lazy</strong>
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.views.generic.edit </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> CreateView, DeleteView, UpdateView</strong>
from django.views.generic.list import ListView
from .models import Course
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">OwnerMixin</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">get_queryset</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc">        qs = </strong><strong class="hljs-built_in-slc">super</strong><strong class="hljs-slc">().get_queryset()</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> qs.</strong><strong class="hljs-built_in-slc">filter</strong><strong class="hljs-slc">(owner=self.request.user)</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">OwnerEditMixin</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">form_valid</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self, form</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc">        form.instance.owner = self.request.user</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">super</strong><strong class="hljs-slc">().form_valid(form)</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">OwnerCourseMixin</strong><strong class="hljs-slc">(</strong><strong class="hljs-title-slc">OwnerMixin</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc">    model = Course</strong>
<strong class="hljs-slc">    fields = [</strong><strong class="hljs-string-slc">'subject'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'title'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'slug'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'overview'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">    success_url = reverse_lazy(</strong><strong class="hljs-string-slc">'manage_course_list'</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">OwnerCourseEditMixin</strong><strong class="hljs-slc">(OwnerCourseMixin, OwnerEditMixin):</strong>
<strong class="hljs-slc">    template_name = </strong><strong class="hljs-string-slc">'courses/manage/course/form.html'</strong>
class ManageCourseListView(<strong class="hljs-slc">OwnerCourseMixin,</strong> ListView):
    template_name = 'courses/manage/course/list.html'
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">CourseCreateView</strong><strong class="hljs-slc">(OwnerCourseEditMixin, CreateView):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">pass</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">CourseUpdateView</strong><strong class="hljs-slc">(OwnerCourseEditMixin, UpdateView):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">pass</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">CourseDeleteView</strong><strong class="hljs-slc">(OwnerCourseMixin, DeleteView):</strong>
<strong class="hljs-slc">    template_name = </strong><strong class="hljs-string-slc">'courses/manage/course/delete.html'</strong>
</code></pre>
<p class="normal">In this code, you create the <code class="inlineCode">OwnerMixin</code> and <code class="inlineCode">OwnerEditMixin</code> mixins. You will use these mixins together with the <code class="inlineCode">ListView</code>, <code class="inlineCode">CreateView</code>, <code class="inlineCode">UpdateView</code>, and <code class="inlineCode">DeleteView</code> views provided by Django. <code class="inlineCode">OwnerMixin</code> implements the <code class="inlineCode">get_queryset()</code> method, which is used by the views to get the base QuerySet. Your mixin will override this method to filter objects by the <code class="inlineCode">owner</code> attribute to retrieve objects that belong to the current user (<code class="inlineCode">request.user</code>).</p>
<p class="normal"><code class="inlineCode">OwnerEditMixin</code> implements the <code class="inlineCode">form_valid()</code> method, which is used by views that use Django’s <code class="inlineCode">ModelFormMixin</code> mixin – that is, views with forms or model forms such as <code class="inlineCode">CreateView</code> – and <code class="inlineCode">UpdateView</code>. <code class="inlineCode">form_valid()</code> is executed when the submitted form is valid.</p>
<p class="normal">The default behavior for this method is saving the instance (for model forms) and redirecting the user to <code class="inlineCode">success_url</code>. You override this method to automatically set the current user in the <code class="inlineCode">owner</code> attribute of the object being saved. By doing so, you set the owner for an object automatically when it is saved.</p>
<p class="normal">Your <code class="inlineCode">OwnerMixin</code> class <a id="_idIndexMarker1174"/>can<a id="_idIndexMarker1175"/> be <a id="_idIndexMarker1176"/>used for views that interact with any model that contains an <code class="inlineCode">owner</code> attribute.</p>
<p class="normal">You also define an <code class="inlineCode">OwnerCourseMixin</code> class that inherits <code class="inlineCode">OwnerMixin</code> and provides the following attributes for child views:</p>
<ul>
<li class="bulletList"><code class="inlineCode">model</code>: The model used for QuerySets; it is used by all views.</li>
<li class="bulletList"><code class="inlineCode">fields</code>: The fields of the model to build the model form of the <code class="inlineCode">CreateView</code> and <code class="inlineCode">UpdateView</code> views.</li>
<li class="bulletList"><code class="inlineCode">success_url</code>: Used by <code class="inlineCode">CreateView</code>, <code class="inlineCode">UpdateView</code>, and <code class="inlineCode">DeleteView</code> to redirect the user after the form is successfully submitted or the object is deleted. You use a URL with the name <code class="inlineCode">manage_course_list</code>, which you are going to create later.</li>
</ul>
<p class="normal">You define an <code class="inlineCode">OwnerCourseEditMixin</code> mixin with the following attribute:</p>
<ul>
<li class="bulletList"><code class="inlineCode">template_name</code>: The template you will use for the <code class="inlineCode">CreateView</code> and <code class="inlineCode">UpdateView</code> views.</li>
</ul>
<p class="normal">Finally, you create the following views that subclass <code class="inlineCode">OwnerCourseMixin</code>:</p>
<ul>
<li class="bulletList"><code class="inlineCode">ManageCourseListView</code>: Lists the courses created by the user. It inherits from <code class="inlineCode">OwnerCourseMixin</code> and <code class="inlineCode">ListView</code>. It defines a specific <code class="inlineCode">template_name</code> attribute for a template to list courses.</li>
<li class="bulletList"><code class="inlineCode">CourseCreateView</code>: Uses a model form to create a new <code class="inlineCode">Course</code> object. It uses the fields defined in <code class="inlineCode">OwnerCourseMixin</code> to build a model form and also subclasses <code class="inlineCode">CreateView</code>. It uses the template defined in <code class="inlineCode">OwnerCourseEditMixin</code>.</li>
<li class="bulletList"><code class="inlineCode">CourseUpdateView</code>: Allows the editing of an existing <code class="inlineCode">Course</code> object. It uses the fields defined in <code class="inlineCode">OwnerCourseMixin</code> to build a model form and also subclasses <code class="inlineCode">UpdateView</code>. It uses the template defined in <code class="inlineCode">OwnerCourseEditMixin</code>.</li>
<li class="bulletList"><code class="inlineCode">CourseDeleteView</code>: Inherits from <code class="inlineCode">OwnerCourseMixin</code> and the generic <code class="inlineCode">DeleteView</code>. It defines a specific <code class="inlineCode">template_name</code> attribute for a template to confirm the course deletion.</li>
</ul>
<p class="normal">You have created the basic views to manage courses. While you have implemented CRUD views on your own, the third-party application Neapolitan allows you to implement the standard list, detail, create, and delete views within a single view. You can learn <a id="_idIndexMarker1177"/>more<a id="_idIndexMarker1178"/> about <a id="_idIndexMarker1179"/>Neapolitan at <a href="https://github.com/carltongibson/neapolitan">https://github.com/carltongibson/neapolitan</a>.</p>
<p class="normal">Next, you are going to use Django authentication groups and permissions to limit access to these views.</p>
<h2 class="heading-2" id="_idParaDest-358">Working with groups and permissions</h2>
<p class="normal">Currently, any<a id="_idIndexMarker1180"/> user can access the views to manage courses. You want to restrict these views so that only instructors have permission to create and manage courses.</p>
<p class="normal">Django’s authentication framework includes a permission system. By default, Django generates four permissions for each model in the installed applications: <code class="inlineCode">add</code>, <code class="inlineCode">view</code>, <code class="inlineCode">change</code>, and <code class="inlineCode">delete</code>. These permissions correspond to the actions of creating new instances, viewing existing ones, editing, and deleting instances of a model.</p>
<p class="normal">Permissions can be assigned directly to individual users or groups of users. This approach simplifies user management by grouping permissions and enhances the security of your application.</p>
<p class="normal">You are going to create a group for instructor users and assign permissions to create, update, and delete courses.</p>
<p class="normal">Run the development server using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/admin/auth/group/add/</code> in your browser to create a new <code class="inlineCode">Group</code> object. Add the name <code class="inlineCode">Instructors</code> and choose all permissions of the <code class="inlineCode">courses</code> application, except <a id="_idIndexMarker1181"/>those of the <code class="inlineCode">Subject</code> model, as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_13_02.png"/></figure>
<p class="packt_figref">Figure 13.2: The Instructors group permissions</p>
<p class="normal">As you can see, there are four different permissions for each model: <em class="italic">can view</em>, <em class="italic">can add</em>, <em class="italic">can change</em>, and <em class="italic">can delete</em>. After choosing permissions for this group, click the <strong class="screenText">SAVE</strong> button.</p>
<p class="normal">Django creates permissions for models automatically but you can also create custom permissions. You will learn how to create custom permissions in <em class="italic">Chapter 15,</em> <em class="italic">Building an API</em>. You can read more about adding custom permissions at <a href="https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#custom-permissions">https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#custom-permissions</a>.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/admin/auth/user/add/</code> and create a new user. Edit the user and add it to the <strong class="screenText">Instructors</strong> group, as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_13_03.png"/></figure>
<p class="packt_figref">Figure 13.3: User group selection</p>
<p class="normal">Users inherit the permissions of the groups they belong to, but you can also add individual permissions <a id="_idIndexMarker1182"/>to a single user using the administration site. Users that have <code class="inlineCode">is_superuser</code> set to <code class="inlineCode">True</code> have all permissions automatically.</p>
<p class="normal">Next, you will apply permissions in practice by incorporating them into our views.</p>
<h3 class="heading-3" id="_idParaDest-359">Restricting access to class-based views</h3>
<p class="normal">You are <a id="_idIndexMarker1183"/>going to<a id="_idIndexMarker1184"/> restrict access to the views so that only users with the appropriate permissions can add, change, or delete <code class="inlineCode">Course</code> objects. You are going to use the following two mixins provided by <code class="inlineCode">django.contrib.auth</code> to limit access to views:</p>
<ul>
<li class="bulletList"><code class="inlineCode">LoginRequiredMixin</code>: Replicates the <code class="inlineCode">login_required</code> decorator’s functionality.</li>
<li class="bulletList"><code class="inlineCode">PermissionRequiredMixin</code>: Grants access to the view to users with a specific permission. Remember that superusers automatically have all permissions.</li>
</ul>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">courses</code> application and add the following import:</p>
<pre class="programlisting code"><code class="hljs-code">from django.contrib.auth.mixins import (
    LoginRequiredMixin,
    PermissionRequiredMixin
)
</code></pre>
<p class="normal">Make <code class="inlineCode">OwnerCourseMixin</code> inherit <code class="inlineCode">LoginRequiredMixin</code> and <code class="inlineCode">PermissionRequiredMixin</code>, like this:</p>
<pre class="programlisting code"><code class="hljs-code">class OwnerCourseMixin(
    OwnerMixin<strong class="hljs-slc">, LoginRequiredMixin, PermissionRequiredMixin</strong>
):
    model = Course
    fields = ['subject', 'title', 'slug', 'overview']
    success_url = reverse_lazy('manage_course_list')
</code></pre>
<p class="normal">Then, add <a id="_idIndexMarker1185"/>a <code class="inlineCode">permission_required</code> attribute<a id="_idIndexMarker1186"/> to the course views, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">class ManageCourseListView(OwnerCourseMixin, ListView):
    template_name = 'courses/manage/course/list.html'
<strong class="hljs-slc">    permission_required = </strong><strong class="hljs-string-slc">'courses.view_course'</strong>
class CourseCreateView(OwnerCourseEditMixin, CreateView):
<strong class="hljs-slc">    permission_required = </strong><strong class="hljs-string-slc">'courses.add_course'</strong>
class CourseUpdateView(OwnerCourseEditMixin, UpdateView):
<strong class="hljs-slc">    permission_required = </strong><strong class="hljs-string-slc">'courses.change_course'</strong>
class CourseDeleteView(OwnerCourseMixin, DeleteView):
    template_name = 'courses/manage/course/delete.html'
<strong class="hljs-slc">    permission_required = </strong><strong class="hljs-string-slc">'courses.delete_course'</strong>
</code></pre>
<p class="normal"><code class="inlineCode">PermissionRequiredMixin</code> checks that the user accessing the view has the permission specified in the <code class="inlineCode">permission_required</code> attribute. Your views are now only accessible to users with the proper permissions.</p>
<p class="normal">Let’s create URLs for these views. Create a new file inside the <code class="inlineCode">courses</code> application directory and name it <code class="inlineCode">urls.py</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.urls import path
from . import views
urlpatterns = [
    path(
        'mine/',
        views.ManageCourseListView.as_view(),
        name='manage_course_list'
    ),
    path(
        'create/',
        views.CourseCreateView.as_view(),
        name='course_create'
    ),
    path(
        '&lt;pk&gt;/edit/',
        views.CourseUpdateView.as_view(),
        name='course_edit'
    ),
    path(
        '&lt;pk&gt;/delete/',
        views.CourseDeleteView.as_view(),
        name='course_delete'
    ),
]
</code></pre>
<p class="normal">These are the URL patterns for the list, create, edit, and delete course views. The <code class="inlineCode">pk</code> parameter refers to the primary key field. Remember that <strong class="keyWord">pk is short for primary key</strong>. Every Django <a id="_idIndexMarker1187"/>model <a id="_idIndexMarker1188"/>has a field that serves as its primary key. By default, the primary key is the automatically generated <code class="inlineCode">id</code> field. The Django generic views for single objects retrieve an object by its <code class="inlineCode">pk</code> field. Edit the main <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">educa</code> project and include the URL patterns of the <code class="inlineCode">courses</code> application, as follows.</p>
<p class="normal">New code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django.conf import settings
from django.conf.urls.static import static
from django.contrib import admin
from django.contrib.auth import views as auth_views
from django.urls import <strong class="hljs-slc">include, </strong>path
urlpatterns = [
    path(
        'accounts/login/', auth_views.LoginView.as_view(), name='login'
    ),
    path(
        'accounts/logout/',
        auth_views.LogoutView.as_view(),
        name='logout'
    ),
    path('admin/', admin.site.urls),
<strong class="hljs-slc">    path(</strong><strong class="hljs-string-slc">'course/'</strong><strong class="hljs-slc">, include(</strong><strong class="hljs-string-slc">'courses.urls'</strong><strong class="hljs-slc">)),</strong>
]
if settings.DEBUG:
    urlpatterns += static(
        settings.MEDIA_URL, document_root=settings.MEDIA_ROOT
    )
</code></pre>
<p class="normal">You need to<a id="_idIndexMarker1189"/> create <a id="_idIndexMarker1190"/>the templates for these views. Create the following directories and files inside the <code class="inlineCode">templates/</code> directory of the <code class="inlineCode">courses</code> application:</p>
<pre class="programlisting con"><code class="hljs-con">courses/
    manage/
        course/
            list.html
            form.html
            delete.html
</code></pre>
<p class="normal">Edit the <code class="inlineCode">courses/manage/course/list.html</code> template and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}My courses{% endblock %}
{% block content %}
  &lt;h1&gt;My courses&lt;/h1&gt;
&lt;div class="module"&gt;
    {% for course in object_list %}
      &lt;div class="course-info"&gt;
&lt;h3&gt;{{ course.title }}&lt;/h3&gt;
&lt;p&gt;
&lt;a href="{% url "course_edit" course.id %}"&gt;Edit&lt;/a&gt;
&lt;a href="{% url "course_delete" course.id %}"&gt;Delete&lt;/a&gt;
&lt;/p&gt;
&lt;/div&gt;
    {% empty %}
      &lt;p&gt;You haven't created any courses yet.&lt;/p&gt;
    {% endfor %}
    &lt;p&gt;
&lt;a href="{% url "course_create" %}" class="button"&gt;Create new course&lt;/a&gt;
&lt;/p&gt;
&lt;/div&gt;
{% endblock %}
</code></pre>
<p class="normal">This is the <a id="_idIndexMarker1191"/>template<a id="_idIndexMarker1192"/> for the <code class="inlineCode">ManageCourseListView</code> view. In this template, you list the courses created by the current user. You include links to edit or delete each course and a link to create new courses.</p>
<p class="normal">Run the development server using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/accounts/login/?next=/course/mine/</code> in your browser and log in with a user belonging to the <code class="inlineCode">Instructors</code> group. After logging in, you will be redirected to the <code class="inlineCode">http://127.0.0.1:8000/course/mine/</code> URL and you should see the following page:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, chat or text message  Description automatically generated" src="img/B21088_13_04.png"/></figure>
<p class="packt_figref">Figure 13.4: The instructor courses page with no courses</p>
<p class="normal">This page will <a id="_idIndexMarker1193"/>display<a id="_idIndexMarker1194"/> all courses created by the current user.</p>
<p class="normal">Let’s create the template that displays the form for the create and update course views. Edit the <code class="inlineCode">courses/manage/course/form.html</code> template and write the following code:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}
  {% if object %}
    Edit course "{{ object.title }}"
  {% else %}
    Create a new course
  {% endif %}
{% endblock %}
{% block content %}
  &lt;h1&gt;
    {% if object %}
      Edit course "{{ object.title }}"
    {% else %}
      Create a new course
    {% endif %}
  &lt;/h1&gt;
&lt;div class="module"&gt;
&lt;h2&gt;Course info&lt;/h2&gt;
&lt;form method="post"&gt;
      {{ form.as_p }}
      {% csrf_token %}
      &lt;p&gt;&lt;input type="submit" value="Save course"&gt;&lt;/p&gt;
&lt;/form&gt;
&lt;/div&gt;
{% endblock %}
</code></pre>
<p class="normal">The <code class="inlineCode">form.html</code> template<a id="_idIndexMarker1195"/> is <a id="_idIndexMarker1196"/>used for both the <code class="inlineCode">CourseCreateView</code> and <code class="inlineCode">CourseUpdateView</code> views. In this template, you check whether an <code class="inlineCode">object</code> variable is in the context. If <code class="inlineCode">object</code> exists in the context, you know that you are updating an existing course and you use it in the page title. Otherwise, you are creating a new <code class="inlineCode">Course</code> object.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/course/mine/</code> in your browser and click the <strong class="screenText">CREATE NEW COURSE</strong> button. You will see the following page:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" src="img/B21088_13_05.png"/></figure>
<p class="packt_figref">Figure 13.5: The form to create a new course</p>
<p class="normal">Fill in the <a id="_idIndexMarker1197"/>form and click the <strong class="screenText">SAVE COURSE</strong> button. The course will be saved and you will be redirected to the course list page. It should look as follows:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, chat or text message  Description automatically generated" src="img/B21088_13_06.png"/></figure>
<p class="packt_figref">Figure 13.6: The instructor courses page with one course</p>
<p class="normal">Then, click the <strong class="screenText">Edit</strong> link for<a id="_idIndexMarker1198"/> the course you have just created. You will see the form again but, this time, you are editing an existing <code class="inlineCode">Course</code> object instead of creating one.</p>
<p class="normal">Finally, edit the <code class="inlineCode">courses/manage/course/delete.html</code> template and add the following code:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}Delete course{% endblock %}
{% block content %}
  &lt;h1&gt;Delete course "{{ object.title }}"&lt;/h1&gt;
&lt;div class="module"&gt;
&lt;form action="" method="post"&gt;
      {% csrf_token %}
      &lt;p&gt;Are you sure you want to delete "{{ object }}"?&lt;/p&gt;
&lt;input type="submit" value="Confirm"&gt;
&lt;/form&gt;
&lt;/div&gt;
{% endblock %}
</code></pre>
<p class="normal">This is the template for the <code class="inlineCode">CourseDeleteView</code> view. This view inherits from <code class="inlineCode">DeleteView</code>, provided by Django, which expects user confirmation to delete an object.</p>
<p class="normal">Open the course list in the browser and click the <strong class="screenText">Delete</strong> link of your course. You should see the following confirmation page:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, chat or text message  Description automatically generated" src="img/B21088_13_07.png"/></figure>
<p class="packt_figref">Figure 13.7: The Delete course confirmation page</p>
<p class="normal">Click the <strong class="screenText">CONFIRM</strong> button. The course will be deleted and you will be redirected to the course list page again.</p>
<p class="normal">Instructors can <a id="_idIndexMarker1199"/>now<a id="_idIndexMarker1200"/> create, edit, and delete courses. Next, you need to provide them with a CMS to add course modules and their contents. You will start by managing course modules.</p>
<h1 class="heading-1" id="_idParaDest-360">Managing course modules and their contents</h1>
<p class="normal">You are going to<a id="_idIndexMarker1201"/> build a system to manage course modules<a id="_idIndexMarker1202"/> and their contents. You will need to build forms that can be used for managing multiple modules per course and different types of content for each module. Both modules and their contents will have to follow a specific order and you<a id="_idIndexMarker1203"/> should be able to reorder them <a id="_idIndexMarker1204"/>using the CMS.</p>
<h2 class="heading-2" id="_idParaDest-361">Using formsets for course modules</h2>
<p class="normal">Django comes with <a id="_idIndexMarker1205"/>an abstraction layer to work with multiple forms on the same page. These groups of forms are known as <em class="italic">formsets</em>. Formsets manage multiple instances of a certain <code class="inlineCode">Form</code> or <code class="inlineCode">ModelForm</code>. All forms are submitted at once and the formset takes care of the initial number of forms to display, limiting the maximum number of forms that can be submitted and validating all the forms.</p>
<p class="normal">Formsets include an <code class="inlineCode">is_valid()</code> method to validate all forms at once. You can also provide initial data for the forms and specify how many additional empty forms to display. You can learn more about formsets at <a href="https://docs.djangoproject.com/en/5.0/topics/forms/formsets/">https://docs.djangoproject.com/en/5.0/topics/forms/formsets/</a> and about model formsets at <a href="https://docs.djangoproject.com/en/5.0/topics/forms/modelforms/#model-formsets">https://docs.djangoproject.com/en/5.0/topics/forms/modelforms/#model-formsets</a>.</p>
<p class="normal">Since a course is divided into a variable number of modules, it makes sense to use formsets to manage them. Create a <code class="inlineCode">forms.py</code> file in the <code class="inlineCode">courses</code> application directory and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.forms.models import inlineformset_factory
from .models import Course, Module
ModuleFormSet = inlineformset_factory(
    Course,
    Module,
    fields=['title', 'description'],
    extra=2,
    can_delete=True
)
</code></pre>
<p class="normal">This is the <code class="inlineCode">ModuleFormSet</code> formset. You build it using the <code class="inlineCode">inlineformset_factory()</code> function provided by Django. Inline formsets are a small abstraction on top of formsets that simplify working with related objects. This function allows you to build a model formset dynamically for the <code class="inlineCode">Module</code> objects related to a <code class="inlineCode">Course</code> object.</p>
<p class="normal">You use the following parameters to build the formset:</p>
<ul>
<li class="bulletList"><code class="inlineCode">fields</code>: The fields that will be included in each form of the formset.</li>
<li class="bulletList"><code class="inlineCode">extra</code>: Allows you to set the number of empty extra forms to display in the formset.</li>
<li class="bulletList"><code class="inlineCode">can_delete</code>: If you set this to <code class="inlineCode">True</code>, Django will include a Boolean field for each form that will be rendered as a checkbox input. It allows you to mark the objects that you want to delete.</li>
</ul>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file <a id="_idIndexMarker1206"/>of the <code class="inlineCode">courses</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.shortcuts import get_object_or_404, redirect
from django.views.generic.base import TemplateResponseMixin, View
from .forms import ModuleFormSet
class CourseModuleUpdateView(TemplateResponseMixin, View):
    template_name = 'courses/manage/module/formset.html'
    course = None
def get_formset(self, data=None):
        return ModuleFormSet(instance=self.course, data=data)
    def dispatch(self, request, pk):
        self.course = get_object_or_404(
            Course, id=pk, owner=request.user
        )
        return super().dispatch(request, pk)
    def get(self, request, *args, **kwargs):
        formset = self.get_formset()
        return self.render_to_response(
            {'course': self.course, 'formset': formset}
        )
    def post(self, request, *args, **kwargs):
        formset = self.get_formset(data=request.POST)
        if formset.is_valid():
            formset.save()
            return redirect('manage_course_list')
        return self.render_to_response(
            {'course': self.course, 'formset': formset}
        )
</code></pre>
<p class="normal">The <code class="inlineCode">CourseModuleUpdateView</code> view handles the formset to add, update, and delete modules for a specific course. This view inherits from the following mixins and views:</p>
<ul>
<li class="bulletList"><code class="inlineCode">TemplateResponseMixin</code>: This mixin takes charge of rendering templates and returning an HTTP response. It requires a <code class="inlineCode">template_name</code> attribute that indicates the template to be rendered and provides the <code class="inlineCode">render_to_response()</code> method to pass it a context and render the template.</li>
<li class="bulletList"><code class="inlineCode">View</code>: The basic class-based view provided by Django.</li>
</ul>
<p class="normal">In this view, you<a id="_idIndexMarker1207"/> implement the following methods:</p>
<ul>
<li class="bulletList"><code class="inlineCode">get_formset()</code>: You define this method to avoid repeating the code to build the formset. You create a <code class="inlineCode">ModuleFormSet</code> object for the given <code class="inlineCode">Course</code> object with optional data.</li>
<li class="bulletList"><code class="inlineCode">dispatch()</code>: This method is provided by the <code class="inlineCode">View</code> class. It takes an HTTP request and its parameters and attempts to delegate to a lowercase method that matches the HTTP method used. A <code class="inlineCode">GET</code> request is delegated to the <code class="inlineCode">get()</code> method and a <code class="inlineCode">POST</code> request to <code class="inlineCode">post()</code>, respectively. In this method, you use the <code class="inlineCode">get_object_or_404()</code> shortcut function to get the <code class="inlineCode">Course</code> object for the given <code class="inlineCode">id</code> parameter that belongs to the current user. You include this code in the <code class="inlineCode">dispatch()</code> method because you need to retrieve the course for both <code class="inlineCode">GET</code> and <code class="inlineCode">POST</code> requests. You save it into the <code class="inlineCode">course</code> attribute of the view to make it accessible to other methods.</li>
<li class="bulletList"><code class="inlineCode">get()</code>: Executed for <code class="inlineCode">GET</code> requests. You build an empty <code class="inlineCode">ModuleFormSet</code> formset and render it to the template together with the current <code class="inlineCode">Course</code> object, using the <code class="inlineCode">render_to_response()</code> method provided by <code class="inlineCode">TemplateResponseMixin</code>.</li>
<li class="bulletList"><code class="inlineCode">post()</code>: Executed for <code class="inlineCode">POST</code> requests. In this method, you perform the following actions:<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">You build a <code class="inlineCode">ModuleFormSet</code> instance using the submitted data.</li>
<li class="numberedList">You execute the <code class="inlineCode">is_valid()</code> method of the formset to validate all of its forms.</li>
<li class="numberedList">If the formset is valid, you save it by calling the <code class="inlineCode">save()</code> method. At this point, any changes made, such as adding, updating, or marking modules for deletion, are applied to the database. Then, you redirect users to the <code class="inlineCode">manage_course_list</code> URL. If the formset is not valid, you render the template to display any errors instead.</li>
</ol>
</li>
</ul>
<p class="normal">Edit the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">courses</code> application and add the following URL pattern to it:</p>
<pre class="programlisting code"><code class="hljs-code">path(
    '&lt;pk&gt;/module/',
    views.CourseModuleUpdateView.as_view(),
    name='course_module_update'
),
</code></pre>
<p class="normal">Create a new directory inside the <code class="inlineCode">courses/manage/</code> template directory and name it <code class="inlineCode">module</code>. Create <a id="_idIndexMarker1208"/>a <code class="inlineCode">courses/manage/module/formset.html</code> template and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}
  Edit "{{ course.title }}"
{% endblock %}
{% block content %}
  &lt;h1&gt;Edit "{{ course.title }}"&lt;/h1&gt;
&lt;div class="module"&gt;
&lt;h2&gt;Course modules&lt;/h2&gt;
&lt;form method="post"&gt;
      {{ formset }}
      {{ formset.management_form }}
      {% csrf_token %}
      &lt;input type="submit" value="Save modules"&gt;
&lt;/form&gt;
&lt;/div&gt;
{% endblock %}
</code></pre>
<p class="normal">In this template, you create a <code class="inlineCode">&lt;form&gt;</code> HTML element in which you include <code class="inlineCode">formset</code>. You also include the management form for the formset with the variable <code class="inlineCode">{{ formset.management_form }}</code>. The management form includes hidden fields to control the initial, total, minimum, and maximum number of forms.</p>
<p class="normal">Edit the <code class="inlineCode">courses/manage/course/list.html</code> template and add the following link for the <code class="inlineCode">course_module_update</code> URL below the course <strong class="screenText">Edit</strong> and <strong class="screenText">Delete</strong> links:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;a href="{% url "course_edit" course.id %}"&gt;Edit&lt;/a&gt;
&lt;a href="{% url "course_delete" course.id %}"&gt;Delete&lt;/a&gt;
<strong class="hljs-slc">&lt;a href=</strong><strong class="hljs-string-slc">"{% url "</strong><strong class="hljs-slc">course_module_update</strong><strong class="hljs-string-slc">" course.id %}"</strong><strong class="hljs-slc">&gt;Edit modules&lt;/a&gt;</strong>
</code></pre>
<p class="normal">You have included the link to edit the course modules.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/course/mine/</code> in your browser. Create a course and click the <strong class="screenText">Edit modules</strong> link <a id="_idIndexMarker1209"/>for it. You should see a formset, as follows:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" src="img/B21088_13_08.png"/></figure>
<p class="packt_figref">Figure 13.8: The course edit page, including the formset for course modules</p>
<p class="normal">The formset <a id="_idIndexMarker1210"/>includes a form for each <code class="inlineCode">Module</code> object contained in the course. After these, two empty extra forms are displayed because you set <code class="inlineCode">extra=2</code> for <code class="inlineCode">ModuleFormSet</code>. When you save the formset, Django will include another two extra fields to add new modules.</p>
<p class="normal">You can see that formsets are incredibly useful for managing multiple instances of forms on a single page. Formsets simplify the process of collecting and validating data from sets of similar forms efficiently.</p>
<p class="normal">After understanding<a id="_idIndexMarker1211"/> how formsets work, you will explore advanced form capabilities by creating forms dynamically that adapt to the various types of content that will be added to course modules.</p>
<h2 class="heading-2" id="_idParaDest-362">Adding content to course modules</h2>
<p class="normal">Now, you need a<a id="_idIndexMarker1212"/> way to add content to course modules. You have four different types of content: text, video, image, and file. You could consider creating four different views to create content, with one form for each model. However, you are going to take a more versatile approach and create a view that handles creating or updating the objects of any content model. You will build the form for this view dynamically, according to the type of content the instructor wants to add to the course: <code class="inlineCode">Text</code>, <code class="inlineCode">Video</code>, <code class="inlineCode">Image</code>, or <code class="inlineCode">File</code>.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">courses</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.apps import apps
from django.forms.models import modelform_factory
from .models import Module, Content
class ContentCreateUpdateView(TemplateResponseMixin, View):
    module = None
    model = None
    obj = None
    template_name = 'courses/manage/content/form.html'
def get_model(self, model_name):
        if model_name in ['text', 'video', 'image', 'file']:
            return apps.get_model(
                app_label='courses', model_name=model_name
            )
        return None
def get_form(self, model, *args, **kwargs):
        Form = modelform_factory(
            model, exclude=['owner', 'order', 'created', 'updated']
        )
        return Form(*args, **kwargs)
    def dispatch(self, request, module_id, model_name, id=None):
        self.module = get_object_or_404(
            Module, id=module_id, course__owner=request.user
        )
        self.model = self.get_model(model_name)
        if id:
            self.obj = get_object_or_404(
                self.model, id=id, owner=request.user
            )
        return super().dispatch(request, module_id, model_name, id)
</code></pre>
<p class="normal">This is the first part of <code class="inlineCode">ContentCreateUpdateView</code>. It will allow you to create and update different models’ contents. This <a id="_idIndexMarker1213"/>view defines the following methods:</p>
<ul>
<li class="bulletList"><code class="inlineCode">get_model()</code>: Here, you check that the given model name is one of the four content models: <code class="inlineCode">Text</code>, <code class="inlineCode">Video</code>, <code class="inlineCode">Image</code>, or <code class="inlineCode">File</code>. Then, you use Django’s <code class="inlineCode">apps</code> module to obtain the actual class for the given model name. If the given model name is not one of the valid ones, you return <code class="inlineCode">None</code>.</li>
<li class="bulletList"><code class="inlineCode">get_form()</code>: You build a dynamic form using the <code class="inlineCode">modelform_factory()</code> function of the form’s framework. Since you are going to build a form for the <code class="inlineCode">Text</code>, <code class="inlineCode">Video</code>, <code class="inlineCode">Image</code>, and <code class="inlineCode">File</code> models, you use the <code class="inlineCode">exclude</code> parameter to specify the common fields to exclude from the form and let all other attributes be included automatically. By doing so, you don’t have to know which fields to include depending on the model.</li>
<li class="bulletList"><code class="inlineCode">dispatch()</code>: This receives the following URL parameters and stores the corresponding module, model, and content object as class attributes:<ul>
<li class="bulletList"><code class="inlineCode">module_id</code>: The ID for the module that the content is/will be associated with.</li>
<li class="bulletList"><code class="inlineCode">model_name</code>: The model name of the content to create/update.</li>
<li class="bulletList"><code class="inlineCode">id</code>: The ID of the object that is being updated. It’s <code class="inlineCode">None</code> to create new objects.</li>
</ul>
</li>
</ul>
<p class="normal">Add the following <code class="inlineCode">get()</code> and <code class="inlineCode">post()</code> methods to <code class="inlineCode">ContentCreateUpdateView</code>:</p>
<pre class="programlisting code"><code class="hljs-code">def get(self, request, module_id, model_name, id=None):
    form = self.get_form(self.model, instance=self.obj)
    return self.render_to_response(
        {'form': form, 'object': self.obj}
    )
def post(self, request, module_id, model_name, id=None):
    form = self.get_form(
        self.model,
        instance=self.obj,
        data=request.POST,
        files=request.FILES
    )
    if form.is_valid():
        obj = form.save(commit=False)
        obj.owner = request.user
        obj.save()
        if not id:
            # new content
            Content.objects.create(module=self.module, item=obj)
        return redirect('module_content_list', self.module.id)
    return self.render_to_response(
        {'form': form, 'object': self.obj}
    )
</code></pre>
<p class="normal">These methods<a id="_idIndexMarker1214"/> are as follows:</p>
<ul>
<li class="bulletList"><code class="inlineCode">get()</code>: Executed when a <code class="inlineCode">GET</code> request is received. You build the model form for the <code class="inlineCode">Text</code>, <code class="inlineCode">Video</code>, <code class="inlineCode">Image</code>, or <code class="inlineCode">File</code> instance that is being updated. Otherwise, you pass no instance to create a new object since <code class="inlineCode">self.obj</code> is <code class="inlineCode">None</code> if no ID is provided.</li>
<li class="bulletList"><code class="inlineCode">post()</code>: Executed when a <code class="inlineCode">POST</code> request is received. You build the model form, passing any submitted data and files to it. Then, you validate it. If the form is valid, you create a new object and assign <code class="inlineCode">request.user</code> as its owner before saving it to the database. You check for the <code class="inlineCode">id</code> parameter. If no ID is provided, you know the user is creating a new object instead of updating an existing one. If this is a new object, you create a <code class="inlineCode">content</code> object for the given module and associate the new content with it.</li>
</ul>
<p class="normal">Edit the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">courses</code> application and add the following URL patterns to it:</p>
<pre class="programlisting code"><code class="hljs-code">path(
    'module/&lt;int:module_id&gt;/content/&lt;model_name&gt;/create/',
    views.ContentCreateUpdateView.as_view(),
    name='module_content_create'
),
path(
    'module/&lt;int:module_id&gt;/content/&lt;model_name&gt;/&lt;id&gt;/',
    views.ContentCreateUpdateView.as_view(),
    name='module_content_update'
),
</code></pre>
<p class="normal">The new URL patterns are as follows:</p>
<ul>
<li class="bulletList"><code class="inlineCode">module_content_create</code>: To create new text, video, image, or file objects and add them to a module. It includes the <code class="inlineCode">module_id</code> and <code class="inlineCode">model_name</code> parameters. The first one allows you to link the new content object to the given module. The latter specifies the content model for which to build the form.</li>
<li class="bulletList"><code class="inlineCode">module_content_update</code>: To update an existing text, video, image, or file object. It includes the <code class="inlineCode">module_id</code> and <code class="inlineCode">model_name</code> parameters and an <code class="inlineCode">id</code> parameter to identify the content that is being updated.</li>
</ul>
<p class="normal">Create a new directory inside the <code class="inlineCode">courses/manage/</code> template directory and name it <code class="inlineCode">content</code>. Create<a id="_idIndexMarker1215"/> the template <code class="inlineCode">courses/manage/content/form.html</code> and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}
  {% if object %}
    Edit content "{{ object.title }}"
  {% else %}
    Add new content
  {% endif %}
{% endblock %}
{% block content %}
  &lt;h1&gt;
    {% if object %}
      Edit content "{{ object.title }}"
    {% else %}
      Add new content
    {% endif %}
  &lt;/h1&gt;
&lt;div class="module"&gt;
&lt;h2&gt;Course info&lt;/h2&gt;
&lt;form action="" method="post" enctype="multipart/form-data"&gt;
      {{ form.as_p }}
      {% csrf_token %}
      &lt;p&gt;&lt;input type="submit" value="Save content"&gt;&lt;/p&gt;
&lt;/form&gt;
&lt;/div&gt;
{% endblock %}
</code></pre>
<p class="normal">This is the template for the <code class="inlineCode">ContentCreateUpdateView</code> view. In this template, you check whether an <code class="inlineCode">object</code> variable is in the context. If <code class="inlineCode">object</code> exists in the context, you are updating an existing object. Otherwise, you are creating a new object.</p>
<p class="normal">You include <code class="inlineCode">enctype="multipart/form-data"</code> in the <code class="inlineCode">&lt;form&gt;</code> HTML element because the form contains a file upload for the <code class="inlineCode">File</code> and <code class="inlineCode">Image</code> content models.</p>
<p class="normal">Run the <a id="_idIndexMarker1216"/>development server, open <code class="inlineCode">http://127.0.0.1:8000/course/mine/</code>, click <strong class="screenText">Edit modules</strong> for an existing course, and create a module.</p>
<p class="normal">Then, open the Python shell with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py shell
</code></pre>
<p class="normal">Obtain the ID of the most recently created module, as follows:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; from courses.models import Module
&gt;&gt;&gt; Module.objects.latest('id').id
6
</code></pre>
<p class="normal">Run the development server and open <code class="inlineCode">http://127.0.0.1:8000/course/module/6/content/image/create/</code> in your browser, replacing the module ID with the one you obtained before. You will see the form to create an <code class="inlineCode">Image</code> object, as follows:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" src="img/B21088_13_09.png"/></figure>
<p class="packt_figref">Figure 13.9: The course Add new content form</p>
<p class="normal">Don’t submit the<a id="_idIndexMarker1217"/> form yet. If you try to do so, it will fail because you haven’t defined the <code class="inlineCode">module_content_list</code> URL yet. You are going to create it in a bit.</p>
<p class="normal">You also need a view for deleting content. Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">courses</code> application and add the following code:</p>
<pre class="programlisting code"><code class="hljs-code">class ContentDeleteView(View):
    def post(self, request, id):
        content = get_object_or_404(
            Content, id=id, module__course__owner=request.user
        )
        module = content.module
        content.item.delete()
        content.delete()
        return redirect('module_content_list', module.id)
</code></pre>
<p class="normal">The <code class="inlineCode">ContentDeleteView</code> class retrieves the <code class="inlineCode">content</code> object with the given ID. It deletes the related <code class="inlineCode">Text</code>, <code class="inlineCode">Video</code>, <code class="inlineCode">Image</code>, or <code class="inlineCode">File</code> object. Finally, it deletes the <code class="inlineCode">content</code> object and redirects the user to the <code class="inlineCode">module_content_list</code> URL to list the other contents of the module.</p>
<p class="normal">Edit the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">courses</code> application and add the following URL pattern to it:</p>
<pre class="programlisting code"><code class="hljs-code">path(
    'content/&lt;int:id&gt;/delete/',
    views.ContentDeleteView.as_view(),
    name='module_content_delete'
),
</code></pre>
<p class="normal">Now, instructors can create, update, and delete content easily. The approach you have learned in this section is very useful for managing forms with diverse data in a generic manner. This<a id="_idIndexMarker1218"/> method can be applied in other situations where a flexible solution is needed to handle data inputs.</p>
<p class="normal">In the next section, we are going to create the views and templates to display course modules and contents.</p>
<h2 class="heading-2" id="_idParaDest-363">Managing modules and their contents</h2>
<p class="normal">You have built <a id="_idIndexMarker1219"/>views to create, edit, and delete course modules and their contents. Next, you need a view to display all modules for a course and list the contents of a specific module.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">courses</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">class ModuleContentListView(TemplateResponseMixin, View):
    template_name = 'courses/manage/module/content_list.html'
def get(self, request, module_id):
        module = get_object_or_404(
            Module, id=module_id, course__owner=request.user
        )
        return self.render_to_response({'module': module})
</code></pre>
<p class="normal">This is the <code class="inlineCode">ModuleContentListView</code> view. This view gets the <code class="inlineCode">Module</code> object with the given ID that belongs to the current user and renders a template with the given module.</p>
<p class="normal">Edit the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">courses</code> application and add the following URL pattern to it:</p>
<pre class="programlisting code"><code class="hljs-code">path(
    'module/&lt;int:module_id&gt;/',
    views.ModuleContentListView.as_view(),
    name='module_content_list'
),
</code></pre>
<p class="normal">Create a new template inside the <code class="inlineCode">templates/courses/manage/module/</code> directory and name it <code class="inlineCode">content_list.html</code>. Add<a id="_idIndexMarker1220"/> the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "base.html" %}
{% block title %}
  Module {{ module.order|add:1 }}: {{ module.title }}
{% endblock %}
{% block content %}
{% with course=module.course %}
  &lt;h1&gt;Course "{{ course.title }}"&lt;/h1&gt;
&lt;div class="contents"&gt;
&lt;h3&gt;Modules&lt;/h3&gt;
&lt;ul id="modules"&gt;
      {% for m in course.modules.all %}
        &lt;li data-id="{{ m.id }}" {% if m == module %}
 class="selected"{% endif %}&gt;
&lt;a href="{% url "module_content_list" m.id %}"&gt;
&lt;span&gt;
              Module &lt;span class="order"&gt;{{ m.order|add:1 }}&lt;/span&gt;
&lt;/span&gt;
&lt;br&gt;
            {{ m.title }}
          &lt;/a&gt;
&lt;/li&gt;
      {% empty %}
        &lt;li&gt;No modules yet.&lt;/li&gt;
      {% endfor %}
    &lt;/ul&gt;
&lt;p&gt;&lt;a href="{% url "course_module_update" course.id %}"&gt;
    Edit modules&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class="module"&gt;
&lt;h2&gt;Module {{ module.order|add:1 }}: {{ module.title }}&lt;/h2&gt;
&lt;h3&gt;Module contents:&lt;/h3&gt;
&lt;div id="module-contents"&gt;
      {% for content in module.contents.all %}
        &lt;div data-id="{{ content.id }}"&gt;
          {% with item=content.item %}
            &lt;p&gt;{{ item }}&lt;/p&gt;
&lt;a href="#"&gt;Edit&lt;/a&gt;
&lt;form action="{% url "module_content_delete" content.id %}"
 method="post"&gt;
&lt;input type="submit" value="Delete"&gt;
              {% csrf_token %}
            &lt;/form&gt;
          {% endwith %}
        &lt;/div&gt;
      {% empty %}
        &lt;p&gt;This module has no contents yet.&lt;/p&gt;
      {% endfor %}
    &lt;/div&gt;
&lt;h3&gt;Add new content:&lt;/h3&gt;
&lt;ul class="content-types"&gt;
&lt;li&gt;
&lt;a href="{% url "module_content_create" module.id "text" %}"&gt;
          Text
        &lt;/a&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;a href="{% url "module_content_create" module.id "image" %}"&gt;
          Image
        &lt;/a&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;a href="{% url "module_content_create" module.id "video" %}"&gt;
          Video
        &lt;/a&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;a href="{% url "module_content_create" module.id "file" %}"&gt;
          File
        &lt;/a&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
{% endwith %}
{% endblock %}
</code></pre>
<p class="normal">Make sure that no template tag is split over multiple lines; the Django template engine expects the tags to be clearly defined and uninterrupted.</p>
<p class="normal">This is the template that displays all modules for a course and the contents of the selected module. You iterate over the course modules to display them in a sidebar. You iterate over a module’s contents and access <code class="inlineCode">content.item</code> to get the related <code class="inlineCode">Text</code>, <code class="inlineCode">Video</code>, <code class="inlineCode">Image</code>, or <code class="inlineCode">File</code> object. You also include links to create new text, video, image, or file content.</p>
<p class="normal">You want to know which type of object each of the <code class="inlineCode">item</code> objects is: <code class="inlineCode">Text</code>, <code class="inlineCode">Video</code>, <code class="inlineCode">Image</code>, or <code class="inlineCode">File</code>. You need the model name to build the URL to edit the object. Besides this, you could display each item in the template differently based on the type of content it is. You can get the model name for an object from the model’s <code class="inlineCode">Meta</code> class by accessing the object’s <code class="inlineCode">_meta</code> attribute. However, Django doesn’t allow you to access variables or attributes starting with an<a id="_idIndexMarker1221"/> underscore in templates to prevent retrieving private attributes or calling private methods. You can solve this by writing a custom template filter.</p>
<p class="normal">Create the following file structure inside the <code class="inlineCode">courses</code> application directory:</p>
<pre class="programlisting con"><code class="hljs-con">templatetags/
    __init__.py
    course.py
</code></pre>
<p class="normal">Edit the <code class="inlineCode">course.py</code> module and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django import template
register = template.Library()
@register.filter
def model_name(obj):
    try:
        return obj._meta.model_name
    except AttributeError:
        return None
</code></pre>
<p class="normal">This is the <code class="inlineCode">model_name</code> template filter. You can apply it in templates as <code class="inlineCode">object|model_name</code> to get the model name for an object.</p>
<p class="normal">Edit the <code class="inlineCode">templates/courses/manage/module/content_list.html</code> template and add the following line below the <code class="inlineCode">{% extends %}</code> template tag:</p>
<pre class="programlisting code"><code class="hljs-code">{% load course %}
</code></pre>
<p class="normal">This will load the <code class="inlineCode">course</code> template tags. Then, find the following lines:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;p&gt;{{ item }}&lt;/p&gt;
&lt;a href="#"&gt;Edit&lt;/a&gt;
</code></pre>
<p class="normal">Replace them with the following ones:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;p&gt;{{ item }}<strong class="hljs-slc"> ({{ item|model_name }})</strong>&lt;/p&gt;
&lt;a href="<strong class="hljs-string-slc">{% url "</strong><strong class="hljs-attr-slc">module_content_update</strong><strong class="hljs-string-slc">" module.id item</strong><strong class="hljs-string-slc">|model_name item.id %}</strong>"&gt;
  Edit
&lt;/a&gt;
</code></pre>
<p class="normal">In the preceding <a id="_idIndexMarker1222"/>code, you display the item model name in the template and also use the model name to build the link to edit the object.</p>
<p class="normal">Edit the <code class="inlineCode">courses/manage/course/list.html</code> template and add a link to the <code class="inlineCode">module_content_list</code> URL, like this:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;a href="{% url "course_module_update" course.id %}"&gt;Edit modules&lt;/a&gt;
<strong class="hljs-slc">{% if course.modules.count &gt; 0 %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">href</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"{% url "</strong><strong class="hljs-attr-slc">module_content_list</strong><strong class="hljs-string-slc">" </strong><strong class="hljs-string-slc">course.modules.first.id %}"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">    Manage contents</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">{% endif %}</strong>
</code></pre>
<p class="normal">The new link allows users to access the contents of the first module of the course if there are any.</p>
<p class="normal">Stop the development server and run it again using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">By stopping and running the development server, you make sure that the <code class="inlineCode">course</code> template tags file gets loaded.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/course/mine/</code> and click the <strong class="screenText">Manage contents</strong> link for a course that contains at least one module. You will see a page like the following one:</p>
<figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="img/B21088_13_10.png"/></figure>
<p class="packt_figref">Figure 13.10: The page to manage course module contents</p>
<p class="normal">When you click<a id="_idIndexMarker1223"/> on a module in the left sidebar, its contents are displayed in the main area. The template also includes links to add new text, video, image, or file content for the module being displayed.</p>
<p class="normal">Add a couple of different types of content to the module and look at the result. Module contents will appear below <strong class="screenText">Module contents</strong>:</p>
<figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="img/B21088_13_11.png"/></figure>
<p class="packt_figref">Figure 13.11: Managing different module contents</p>
<p class="normal">Next, we will <a id="_idIndexMarker1224"/>allow course instructors to reorder modules and module contents with a simple drag-and-drop functionality.</p>
<h1 class="heading-1" id="_idParaDest-364">Reordering modules and their contents</h1>
<p class="normal">We will implement a<a id="_idIndexMarker1225"/> JavaScript drag-and-drop functionality to let course instructors reorder the modules of a course by dragging them. Drag-and-drop enhances the user interface, offering a natural way to reorder elements that is more intuitive than using numbers or clicking buttons. It is also a time-saver for course instructors, who will be able to reorganize course modules and their contents easily.</p>
<p class="normal">To implement this feature, we will use the HTML5 Sortable library, which simplifies the process of creating sortable lists using the native HTML5 Drag and Drop API.</p>
<p class="normal">When users finish dragging a module, you will use the JavaScript Fetch API to send an asynchronous HTTP request to the server that stores the new module order.</p>
<p class="normal">You can read more information about the HTML5 Drag and Drop API at <a href="https://www.w3schools.com/html/html5_draganddrop.asp">https://www.w3schools.com/html/html5_draganddrop.asp</a>. You can find examples built with <a id="_idIndexMarker1226"/>the HTML5 Sortable <a id="_idIndexMarker1227"/>library at <a href="https://lukasoppermann.github.io/html5sortable/">https://lukasoppermann.github.io/html5sortable/</a>. Documentation<a id="_idIndexMarker1228"/> for the HTML5 Sortable library <a id="_idIndexMarker1229"/>is available at <a href="https://github.com/lukasoppermann/html5sortable">https://github.com/lukasoppermann/html5sortable</a>.</p>
<p class="normal">Let’s implement the views to update the order of course modules and module contents.</p>
<h2 class="heading-2" id="_idParaDest-365">Using mixins from django-braces</h2>
<p class="normal"><code class="inlineCode">django-braces</code> is a <a id="_idIndexMarker1230"/>third-party module<a id="_idIndexMarker1231"/> that <a id="_idIndexMarker1232"/>contains a collection of generic mixins for Django. These mixins provide additional features for class-based views that are useful for various common scenarios. You can see a list of all mixins provided by <code class="inlineCode">django-braces</code> at <a href="https://django-braces.readthedocs.io/">https://django-braces.readthedocs.io/</a>.</p>
<p class="normal">You will use the following mixins of <code class="inlineCode">django-braces</code>:</p>
<ul>
<li class="bulletList"><code class="inlineCode">CsrfExemptMixin</code>: Used to avoid checking the <strong class="keyWord">cross-site request forgery</strong> (<strong class="keyWord">CSRF</strong>) token <a id="_idIndexMarker1233"/>in the <code class="inlineCode">POST</code> requests. You need this to perform AJAX <code class="inlineCode">POST</code> requests without the need to pass a <code class="inlineCode">csrf_token</code>.</li>
<li class="bulletList"><code class="inlineCode">JsonRequestResponseMixin</code>: Parses the request data as JSON and also serializes the response as JSON and returns an HTTP response with the <code class="inlineCode">application/json</code> content type.</li>
</ul>
<p class="normal">Install <code class="inlineCode">django-braces</code> via <code class="inlineCode">pip</code> using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install django-braces==1.15.0
</code></pre>
<p class="normal">You need a view that receives the new order of module IDs encoded in JSON and updates the order accordingly. Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">courses</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from braces.views import CsrfExemptMixin, JsonRequestResponseMixin
class ModuleOrderView(CsrfExemptMixin, JsonRequestResponseMixin, View):
    def post(self, request):
        for id, order in self.request_json.items():
            Module.objects.filter(
                id=id, course__owner=request.user
            ).update(order=order)
        return self.render_json_response({'saved': 'OK'})
</code></pre>
<p class="normal">This is the <code class="inlineCode">ModuleOrderView</code> view, which allows you to update the order of course modules.</p>
<p class="normal">You can build a<a id="_idIndexMarker1234"/> similar view to order<a id="_idIndexMarker1235"/> a <a id="_idIndexMarker1236"/>module’s contents. Add the following code to the <code class="inlineCode">views.py</code> file:</p>
<pre class="programlisting code"><code class="hljs-code">class ContentOrderView(CsrfExemptMixin, JsonRequestResponseMixin, View):
    def post(self, request):
        for id, order in self.request_json.items():
            Content.objects.filter(
                id=id, module__course__owner=request.user
            ).update(order=order)
        return self.render_json_response({'saved': 'OK'})
</code></pre>
<p class="normal">Now, edit the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">courses</code> application and add the following URL patterns to it:</p>
<pre class="programlisting code"><code class="hljs-code">path(
    'module/order/',
    views.ModuleOrderView.as_view(),
    name='module_order'
),
path(
    'content/order/',
    views.ContentOrderView.as_view(),
    name='content_order'
),
</code></pre>
<p class="normal">Finally, you need to implement the drag-and-drop functionality in the template. We will use the HTML5 Sortable library, which simplifies the creation of sortable elements using the standard HTML Drag and Drop API. There are other JavaScript libraries that will allow you to achieve the same, but we chose HTML5 Sortable because it is lightweight and leverages the native HTML5 Drag and Drop API.</p>
<p class="normal">Edit the <code class="inlineCode">base.html</code> template located in the <code class="inlineCode">templates/</code> directory of the <code class="inlineCode">courses</code> application and <a id="_idIndexMarker1237"/>add the following<a id="_idIndexMarker1238"/> block <a id="_idIndexMarker1239"/>highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">{% load static %}
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    # ...
  &lt;/head&gt;
&lt;body&gt;
&lt;div id="header"&gt;
      # ...
    &lt;/div&gt;
&lt;div id="content"&gt;
      {% block content %}
      {% endblock %}
    &lt;/div&gt;
<strong class="hljs-slc">    {% block include_js %}</strong>
<strong class="hljs-slc">    {% endblock %}</strong>
&lt;script&gt;
 document.addEventListener('DOMContentLoaded', (event) =&gt; {
 // DOM loaded
        {% block domready %}
        {% endblock %}
      })
 &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p class="normal">This new block named <code class="inlineCode">include_js</code> will allow you to insert JavaScript files into any template that extends the <code class="inlineCode">base.html</code> template.</p>
<p class="normal">Next, edit the <code class="inlineCode">courses/manage/module/content_list.html</code> template and add the following code highlighted in bold to the bottom of the template:</p>
<pre class="programlisting code"><code class="hljs-code"># ...
{% block content %}
  # ...
{% endblock %}
<strong class="hljs-slc">{% block include_js %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">script</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">src</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"https://cdnjs.cloudflare.com/ajax/libs/html5sortable/0.13.3/html5sortable.min.js"</strong><strong class="hljs-tag-slc">&gt;&lt;/</strong><strong class="hljs-name-slc">script</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">{% endblock %}</strong>
</code></pre>
<p class="normal">In this code, you load the HTML5 Sortable library from a public <strong class="keyWord">content delivery network</strong> (<strong class="keyWord">CDN</strong>). Remember<a id="_idIndexMarker1240"/> you loaded a<a id="_idIndexMarker1241"/> JavaScript<a id="_idIndexMarker1242"/> library from a CDN before in <em class="italic">Chapter 6,</em> <em class="italic">Sharing Content on Your Website</em>.</p>
<p class="normal">Now add the following <code class="inlineCode">domready</code> block highlighted in bold to the <code class="inlineCode">courses/manage/module/content_list.html</code> template:</p>
<pre class="programlisting code"><code class="hljs-code"># ...
{% block content %}
  # ...
{% endblock %}
{% block include_js %}
  &lt;script src="img/html5sortable.min.js"&gt;&lt;/script&gt;
{% endblock %}
<strong class="hljs-slc">{% block domready %}</strong>
<strong class="hljs-slc">  var options = {</strong>
<strong class="hljs-slc">      method: 'POST',</strong>
<strong class="hljs-slc">      mode: 'same-origin'</strong>
<strong class="hljs-slc">  }</strong>
<strong class="hljs-slc">  const moduleOrderUrl = '{% url "module_order" %}';</strong>
<strong class="hljs-slc">{% endblock %}</strong>
</code></pre>
<p class="normal">In these new lines, you add JavaScript code to the <code class="inlineCode">{% block domready %}</code> block that was defined in the event listener for the <code class="inlineCode">DOMContentLoaded</code> event in the <code class="inlineCode">base.html</code> template. This guarantees that your JavaScript code will be executed once the page has been loaded. With this code, you define the options for the HTTP request to reorder modules that you will implement next. You will send a <code class="inlineCode">POST</code> request using the Fetch API to update the module order. The <code class="inlineCode">module_order</code> URL path is built and stored in the JavaScript constant <code class="inlineCode">moduleOrderUrl</code>.</p>
<p class="normal">Add the following code highlighted in bold to the <code class="inlineCode">domready</code> block:</p>
<pre class="programlisting code"><code class="hljs-code">{% block domready %}
  var options = {
      method: 'POST',
      mode: 'same-origin'
  }
  const moduleOrderUrl = '{% url "module_order" %}';
<strong class="hljs-slc">  sortable('#modules', {</strong>
<strong class="hljs-slc">    forcePlaceholderSize: true,</strong>
<strong class="hljs-slc">    placeholderClass: 'placeholder'</strong>
<strong class="hljs-slc">  });</strong>
{% endblock %}
</code></pre>
<p class="normal">In the new code, you define a <code class="inlineCode">sortable</code> element for the HTML element with <code class="inlineCode">id="modules"</code>, which<a id="_idIndexMarker1243"/> is the module list in<a id="_idIndexMarker1244"/> the <a id="_idIndexMarker1245"/>sidebar. Remember that you use a CSS selector <code class="inlineCode">#</code> to select the element with the given <code class="inlineCode">id</code>. When you start dragging an item, the HTML5 Sortable library creates a placeholder item so that you can easily see where the element will be placed.</p>
<p class="normal">You set the <code class="inlineCode">forcePlacehoderSize</code> option to <code class="inlineCode">true</code>, to force the placeholder element to have a height, and you use <code class="inlineCode">placeholderClass</code> to define the CSS class for the placeholder element. You use the class named <code class="inlineCode">placeholder</code> that is defined in the <code class="inlineCode">css/base.css</code> static file loaded in the <code class="inlineCode">base.html</code> template.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/course/mine/</code> in your browser and click on <strong class="screenText">Manage contents</strong> for any course. Now, you can drag and drop the course modules in the left sidebar, as in <em class="italic">Figure 13.12</em>:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application  Description automatically generated" src="img/B21088_13_12.png"/></figure>
<p class="packt_figref">Figure 13.12: Reordering modules with the drag-and-drop functionality</p>
<p class="normal">While you drag <a id="_idIndexMarker1246"/>the element, you will<a id="_idIndexMarker1247"/> see <a id="_idIndexMarker1248"/>the placeholder item created by the Sortable library, which has a dashed-line border. The placeholder element allows you to identify the position in which the dragged element will be dropped.</p>
<p class="normal">When you drag a module to a different position, you need to send an HTTP request to the server to store the new order. This can be done by attaching an event handler to the sortable element and sending a request to the server using the JavaScript Fetch API.</p>
<p class="normal">Edit the <code class="inlineCode">domready</code> block of the <code class="inlineCode">courses/manage/module/content_list.html</code> template and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">{% block domready %}
  var options = {
      method: 'POST',
      mode: 'same-origin'
  }
  const moduleOrderUrl = '{% url "module_order" %}';
  sortable('#modules', {
    forcePlaceholderSize: true,
    placeholderClass: 'placeholder'
  })<strong class="hljs-slc">[0].addEventListener('sortupdate', function(e) {</strong>
<strong class="hljs-slc">    modulesOrder = {};</strong>
<strong class="hljs-slc">    var modules = document.querySelectorAll('#modules li');</strong>
<strong class="hljs-slc">    modules.forEach(function (module, index) {</strong>
<strong class="hljs-comment-slc">      // update module index</strong>
<strong class="hljs-slc">      modulesOrder[module.dataset.id] = index;</strong>
<strong class="hljs-comment-slc">      // update index in HTML element</strong>
<strong class="hljs-slc">      module.querySelector('.order').innerHTML = index + 1;</strong>
<strong class="hljs-slc">    });</strong>
<strong class="hljs-comment-slc">    // add new order to the HTTP request options</strong>
<strong class="hljs-slc">    options['body'] = JSON.stringify(modulesOrder);</strong>
<strong class="hljs-comment-slc">    // send HTTP request</strong>
<strong class="hljs-slc">    fetch(moduleOrderUrl, options)</strong>
<strong class="hljs-slc">  });</strong>
{% endblock %}
</code></pre>
<p class="normal">In the new code, an<a id="_idIndexMarker1249"/> event listener<a id="_idIndexMarker1250"/> is <a id="_idIndexMarker1251"/>created for the <code class="inlineCode">sortupdate</code> event of the sortable element. The <code class="inlineCode">sortupdate</code> event is triggered when an element is dropped in a different position. The following tasks are performed in the event function:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">An empty <code class="inlineCode">modulesOrder</code> dictionary is created. The keys for this dictionary will be the module IDs, and the values will contain the index of each module.</li>
<li class="numberedList">The list elements of the <code class="inlineCode">#modules</code> HTML element are selected with <code class="inlineCode">document.querySelectorAll()</code>, using the <code class="inlineCode">#modules li</code> CSS selector.</li>
<li class="numberedList"><code class="inlineCode">forEach()</code> is used to iterate over each list element.</li>
<li class="numberedList">The new index for each module is stored in the <code class="inlineCode">modulesOrder</code> dictionary. The ID of each module is retrieved from the HTML <code class="inlineCode">data-id</code> attribute by accessing <code class="inlineCode">module.dataset.id</code>. You use the ID as the key of the <code class="inlineCode">modulesOrder</code> dictionary and the new index of the module as the value.</li>
<li class="numberedList">The order displayed for each module is updated by selecting the element with the <code class="inlineCode">order</code> CSS class. Since the index is zero-based and we want to display a one-based index, we add <code class="inlineCode">1</code> to <code class="inlineCode">index</code>.</li>
<li class="numberedList">A key named <code class="inlineCode">body</code> is added to the <code class="inlineCode">options</code> dictionary with the new order contained in <code class="inlineCode">modulesOrder</code>. The <code class="inlineCode">JSON.stringify()</code> method converts the JavaScript object into a JSON string. This is the body for the HTTP request to update the module order.</li>
<li class="numberedList">The Fetch API is used by creating a <code class="inlineCode">fetch()</code> HTTP request to update the module order. The <code class="inlineCode">ModuleOrderView</code> view that corresponds to the <code class="inlineCode">module_order</code> URL takes care of updating the order of the modules.</li>
</ol>
<p class="normal">You can now drag and drop modules. When you finish dragging a module, an HTTP request is sent to the <code class="inlineCode">module_order</code> URL to update the order of the modules. If you refresh<a id="_idIndexMarker1252"/> the<a id="_idIndexMarker1253"/> page, the<a id="_idIndexMarker1254"/> latest module order will be kept because it was updated in the database. <em class="italic">Figure 13.13</em> shows a different order for the modules in the sidebar after sorting them using drag and drop:</p>
<figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="img/B21088_13_13.png"/></figure>
<p class="packt_figref">Figure 13.13: New order for modules after reordering them with drag and drop</p>
<p class="normal">If you run into any issues, remember to use your browser’s developer tools to debug JavaScript and <a id="_idIndexMarker1255"/>HTTP requests. Usually, you<a id="_idIndexMarker1256"/> can right-click anywhere on the website<a id="_idIndexMarker1257"/> to open the contextual menu and click on <strong class="screenText">Inspect</strong> or <strong class="screenText">Inspect Element</strong> to access the web developer tools of your browser.</p>
<p class="normal">Let’s add the same drag-and-drop functionality to allow course instructors to sort module contents as well.</p>
<p class="normal">Edit the <code class="inlineCode">domready</code> block of the <code class="inlineCode">courses/manage/module/content_list.html</code> template and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">{% block domready %}
  // ...
<strong class="hljs-slc">  const contentOrderUrl = '{% url "content_order" %}';</strong>
<strong class="hljs-slc">  sortable('#module-contents', {</strong>
<strong class="hljs-slc">    forcePlaceholderSize: true,</strong>
<strong class="hljs-slc">    placeholderClass: 'placeholder'</strong>
<strong class="hljs-slc">  })[0].addEventListener('sortupdate', function(e) {</strong>
<strong class="hljs-slc">    contentOrder = {};</strong>
<strong class="hljs-slc">    var contents = document.querySelectorAll('#module-contents div');</strong>
<strong class="hljs-slc">    contents.forEach(function (content, index) {</strong>
<strong class="hljs-comment-slc">      // update content index</strong>
<strong class="hljs-slc">      contentOrder[content.dataset.id] = index;</strong>
<strong class="hljs-slc">    });</strong>
<strong class="hljs-comment-slc">    // add new order to the HTTP request options</strong>
<strong class="hljs-slc">    options['body'] = JSON.stringify(contentOrder);</strong>
<strong class="hljs-comment-slc">    // send HTTP request</strong>
<strong class="hljs-slc">    fetch(contentOrderUrl, options)</strong>
<strong class="hljs-slc">  });</strong>
{% endblock %}
</code></pre>
<p class="normal">In this case, you<a id="_idIndexMarker1258"/> use the <code class="inlineCode">content_order</code> URL<a id="_idIndexMarker1259"/> instead of <code class="inlineCode">module_order</code> and build the <code class="inlineCode">sortable</code> functionality<a id="_idIndexMarker1260"/> on the HTML element with the ID <code class="inlineCode">module-contents</code>. The functionality is mainly the same as for ordering course modules. In this case, you don’t need to update the numbering of the contents because they don’t include any visible index.</p>
<p class="normal">Now, you can drag and drop both modules and module contents, as in <em class="italic">Figure 13.14</em>:</p>
<figure class="mediaobject"><img alt="Graphical user interface, application  Description automatically generated" src="img/B21088_13_14.png"/></figure>
<p class="packt_figref">Figure 13.14: Reordering module contents with the drag-and-drop functionality</p>
<p class="normal">Great! You built a<a id="_idIndexMarker1261"/> very versatile CMS for the course instructors.</p>
<h1 class="heading-1" id="_idParaDest-366">Summary</h1>
<p class="normal">In this chapter, you learned how to use class-based views and mixins to create a CMS. You acquired knowledge about reusability and modularity that you can apply to your future applications. You also worked with groups and permissions to restrict access to your views, gaining insights into security and how to control actions on data. You learned how to use formsets and model formsets to manage course modules and their content in a flexible manner. You also built a drag-and-drop functionality with JavaScript to reorder course modules and their contents with an improved user interface.</p>
<p class="normal">In the next chapter, you will create a student registration system and manage student enrollment in courses. You will also learn how to render different types of content and improve the performance of your application by caching content using Django’s cache framework.</p>
<h1 class="heading-1" id="_idParaDest-367">Additional resources</h1>
<p class="normal">The following resources provide additional information related to the topics covered in this chapter:</p>
<ul>
<li class="bulletList">Source code for this chapter: <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter13">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter13</a></li>
<li class="bulletList">Django mixins documentation: <a href="https://docs.djangoproject.com/en/5.0/topics/class-based-views/mixins/">https://docs.djangoproject.com/en/5.0/topics/class-based-views/mixins/</a></li>
<li class="bulletList">Neapolitan package to create CRUD views: <a href="https://github.com/carltongibson/neapolitan">https://github.com/carltongibson/neapolitan</a></li>
<li class="bulletList">Creating custom permissions: <a href="https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#custom-permissions">https://docs.djangoproject.com/en/5.0/topics/auth/customizing/#custom-permissions</a></li>
<li class="bulletList">Django formsets: <a href="https://docs.djangoproject.com/en/5.0/topics/forms/formsets/">https://docs.djangoproject.com/en/5.0/topics/forms/formsets/</a></li>
<li class="bulletList">Django model formsets: <a href="https://docs.djangoproject.com/en/5.0/topics/forms/modelforms/#model-formsets">https://docs.djangoproject.com/en/5.0/topics/forms/modelforms/#model-formsets</a></li>
<li class="bulletList">HTML5 Drag and Drop API: <a href="https://www.w3schools.com/html/html5_draganddrop.asp">https://www.w3schools.com/html/html5_draganddrop.asp</a></li>
<li class="bulletList">HTML5 Sortable library documentation: <a href="https://github.com/lukasoppermann/html5sortable">https://github.com/lukasoppermann/html5sortable</a></li>
<li class="bulletList">HTML5 Sortable library examples: <a href="https://lukasoppermann.github.io/html5sortable">https://lukasoppermann.github.io/html5sortable</a>/</li>
<li class="bulletList"><code class="inlineCode">django-braces</code> documentation: <a href="https://django-braces.readthedocs.io/">https://django-braces.readthedocs.io/</a></li>
</ul>
</div>
</body></html>