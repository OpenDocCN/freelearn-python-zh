<html><head></head><body><div class="chapter" title="Chapter&#xA0;6.&#xA0;Design Patterns"><div class="titlepage"><div><div><h1 class="title"><a id="ch06"/>Chapter 6. Design Patterns</h1></div></div></div><p>This chapter will introduce you to some commonly used design patterns. Here is how the chapter is organized:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">We will start with a quick introduction to design patterns, followed by a discussion on some Python language features that help to simplify their implementation.</li><li class="listitem" style="list-style-type: disc">Next, with the help of a fantasy game theme, we will discuss the following design patterns:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Strategy pattern</li><li class="listitem" style="list-style-type: disc">Simple and abstract factory pattern</li><li class="listitem" style="list-style-type: disc">Adapter pattern</li></ul></div></li><li class="listitem" style="list-style-type: disc">For each pattern, a simple game scenario will demonstrate a practical problem. We will see how the design pattern can help solve this problem.</li><li class="listitem" style="list-style-type: disc">We will also implement each of these patterns using a Pythonic approach.</li></ul></div><p>There are several known design patterns out there. As outlined earlier, we will discuss only a few. The idea is not to present a new cookbook on patterns, but just to show you how design patterns help solve some commonly encountered problems, and how to implement them in Python. Beyond this book, you can explore other traditional design patterns and try adding a Pythonic flavor to them.</p><p>By the way, you are about to get introduced to some new game characters. So get ready to learn design patterns with Sir Foo and friends!</p><div class="section" title="Introduction to design patterns"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec51"/>Introduction to design patterns</h1></div></div></div><p>Let's<a id="id437" class="indexterm"/> say that during application development, you stumble upon a problem that pops up again and again. Frustrated, you ask your co-developers or a community for help. Guess what, you are not alone. Many have encountered a similar problem in their code. Luckily, you get a response from someone who has found a solution. This solution seemed to have worked reliably on similar problems. You change your problematic code so that it conforms to the suggested design, and voila! Your problem is resolved!</p><p>What <a id="id438" class="indexterm"/>we just discussed is a software design pattern. A software design pattern is a tried and tested solution or a strategy that helps us solve a commonly encountered problem in the code. Let's start with the broad categories of design patterns followed by some important design principles.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note14"/>Note</h3><p>
<span class="strong"><strong>The Gang of Four book</strong></span>:</p><p>Before beginning any discussion on the design patterns in Python, it is worth noting that there is an excellent book you may want on your bookshelf, <span class="emphasis"><em>Design Patterns: Elements of Reusable Object-Oriented Software</em></span>, by Erich Gamma, Richard Helm, Ralph Johnson, and John Vlissides. These four authors are commonly referred to as the <a id="id439" class="indexterm"/>
<span class="strong"><strong>Gang of Four</strong></span> (<span class="strong"><strong>GoF</strong></span>). Their book illustrates design patterns using C++ and Smalltalk examples. If you have a background in programming languages such as C++ or Java, this might be of more interest to you. As you will see in this chapter, some high-level language features in Python make many design patterns much simpler to implement. The GoF book is still a great reference, and will help you understand the core concepts behind the design patterns.</p></div></div><div class="section" title="Classification of patterns"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec103"/>Classification of patterns</h2></div></div></div><p>Software design patterns <a id="id440" class="indexterm"/>can be broadly classified into four categories, namely behavioral patterns, creational patterns, structural patterns, and concurrency patterns. In this book, we will limit our discussion to just three design patterns. We will see one example each of behavioral, creational, and structural patterns. The concurrency patterns are not covered here, as it is an advanced topic, beyond the scope of this book. For an in-depth understanding of other design patterns, you can grab a book on design patterns, such as the GoF book mentioned earlier. With this in mind, let's briefly talk about each of these categories next.</p><div class="section" title="Behavioral patterns"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec49"/>Behavioral patterns</h3></div></div></div><p>The <a id="id441" class="indexterm"/>behavioral design patterns try to simplify how different objects communicate with each other. While doing so, these patterns help keep these objects loosely coupled or less dependent on each other. The following is a partial list of behavioral <a id="id442" class="indexterm"/>design patterns: chain of responsibility, command, strategy, observer, iterator, visitor pattern, and many more. In this chapter, we will see how to implement the strategy pattern in Python.</p></div><div class="section" title="Creational patterns"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec50"/>Creational patterns</h3></div></div></div><p>These <a id="id443" class="indexterm"/>patterns are all about instance creation mechanisms. These <a id="id444" class="indexterm"/>design patterns show a better way to create objects depending on the situation you are dealing with.</p><p>Here is a list of the major creational design patterns: abstract factory, factory method, builder, prototype, and singleton pattern. We will discuss the abstract factory pattern in this chapter.</p></div><div class="section" title="Structural patterns"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec51"/>Structural patterns</h3></div></div></div><p>The <a id="id445" class="indexterm"/>structural design patterns typically deal with the relationship between the<a id="id446" class="indexterm"/> components, such as objects or classes, so that it is easier to make these entities work together in a larger and more complex system. Some examples of structural design patterns include adapter, composite, decorator, facade, flyweight, proxy pattern, and so on. In this chapter, we will see a Pythonic implementation of the adapter pattern.</p></div><div class="section" title="Concurrency patterns"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec52"/>Concurrency patterns</h3></div></div></div><p>In a<a id="id447" class="indexterm"/> nutshell, concurrency means simultaneously performing multiple <a id="id448" class="indexterm"/>things. Concurrency enables your application to execute one task (for example, updating a database) while it is also working on something else (such as responding to a user query). Concurrency design patterns, in general, deal with the multi-threaded programming paradigm. The following is a partial list of concurrency patterns: active object, balking, monitor object, double-checked locking, and so on. As mentioned before, we will not talk about any of the concurrency patterns in this book. That said, <a class="link" href="ch09.html" title="Chapter 9. Improving Performance – Part Two, NumPy and Parallelization">Chapter 9</a>, <span class="emphasis"><em>Improving Performance – Part two, NumPy and Parallelization</em></span> will introduce you to some aspects of multi-threaded programming in Python. Visit<a id="id449" class="indexterm"/> the wiki for more information at <a class="ulink" href="https://en.wikipedia.org/wiki/Concurrency_pattern">https://en.wikipedia.org/wiki/Concurrency_pattern</a>.</p></div></div></div></div>
<div class="section" title="Python language and design patterns"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec52"/>Python language and design patterns</h1></div></div></div><p>Thanks to the high-level <a id="id450" class="indexterm"/>built-in language features in Python, many of the formal design patterns are easy to implement. In some cases, the patterns appear so natural to the language that it becomes tough to realize them as formal design patterns. For example, an iterator pattern can be realized by using any iterable object, such as lists, dictionaries, and so on. Let's quickly review such language features or paradigms in this section. It is not an exhaustive list, but we will cover some important aspects.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip59"/>Tip</h3><p>The idioms that you are about to read (first-class functions, closures, and so on) might sound onerous. But do not get overwhelmed by these terms! If you are a Python programmer, it is very likely that you have already used many of these features knowingly or unknowingly. If these idioms mean nothing to you at the moment, skip ahead to the next section where we fast forward to an imaginary game scenario. In the upcoming discussion, we will use some of these language features. You can then come back to this section whenever you need a handy reference.</p></div></div><div class="section" title="First-class functions"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec104"/>First-class functions</h2></div></div></div><p>There is a<a id="id451" class="indexterm"/> programming idiom called<a id="id452" class="indexterm"/> <span class="strong"><strong>first-class citizens</strong></span>. In Python, any function, a class, a class method, or an object, all qualify as first-class citizens. On each of these entities, you can freely perform operations that are typically supported on other entities.</p><p>For example, you can assign a function to a variable as if you are assigning a value to that variable. Likewise, you can pass this function as an argument, or get it as a return value of some other function. Any programming language that supports such operations on functions is said to have first-class functions. The following is a simple piece of code that illustrates what we can accomplish with a first-class function in Python. In this example, a function, <code class="literal">test</code>, is assigned to a variable, <code class="literal">x</code>. After the assignment, the function can be called either <code class="literal">x()</code> or as <code class="literal">test()</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; def test(): </strong></span>
<span class="strong"><strong>...     print("inside test function") </strong></span>
<span class="strong"><strong>... </strong></span>
<span class="strong"><strong>&gt;&gt;&gt; x = test </strong></span>
<span class="strong"><strong>&gt;&gt;&gt; x() </strong></span>
<span class="strong"><strong>inside test function </strong></span>
<span class="strong"><strong>&gt;&gt;&gt; x </strong></span>
<span class="strong"><strong>&lt;function test at 0x7fca460efbf8&gt; </strong></span>
</pre></div><p>Here is another example that illustrates the first-class function feature. It shows how we can pass the same function, <code class="literal">test</code>, as an argument to another function, called <code class="literal">some_function</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; def some_function(y): </strong></span>
<span class="strong"><strong>...     y() </strong></span>
<span class="strong"><strong>... </strong></span>
<span class="strong"><strong>&gt;&gt;&gt; some_function(test) </strong></span>
<span class="strong"><strong>inside test function </strong></span>
</pre></div><p>Let's see what we can do with the other first-class entity, Python classes.</p></div><div class="section" title="Classes as first-class objects"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec105"/>Classes as first-class objects</h2></div></div></div><p>Just like functions, Python <a id="id453" class="indexterm"/>classes are first-class citizens. They can be passed around as an argument, assigned to variables, or returned from a function. Here is an example where a class, <code class="literal">Foo</code>, is assigned to a variable <code class="literal">bar</code>. After this assignment, you can use <code class="literal">bar</code> to create an instance of <code class="literal">Foo</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>&gt;&gt;&gt; class Foo:</strong></span>
<span class="strong"><strong>...     def say_hi(self):</strong></span>
<span class="strong"><strong>...         print("hi!")</strong></span>
<span class="strong"><strong>... </strong></span>
<span class="strong"><strong>&gt;&gt;&gt; bar = Foo</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; z = bar()</strong></span>
<span class="strong"><strong>&gt;&gt;&gt; z.say_hi()</strong></span>
<span class="strong"><strong>hi!</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip60"/>Tip</h3><p>We will not be using closures in this chapter. It is a bit of an advanced topic that is included for completeness. You can optionally skip the next section.</p></div></div></div><div class="section" title="Closures"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec106"/>Closures</h2></div></div></div><p>Take any function in Python <a id="id454" class="indexterm"/>that defines some local variables. You can use these variables inside the function, but those can not be accessed by the outside world (unless you return it from the function). In some sense, the functions can be considered as closed. When the function executes, it uses these local variables; when the function is done, the local variables go out of scope. Their job is done, that's the end of the story. Now what if you want a function that keeps its local environment at the time it was created? </p><p>We want some way to wrap this function along with its local environment. It could be better explained with the following example:</p><div class="mediaobject"><img src="graphics/B05034_06_46.jpg" alt="Closures"/></div><p>In the preceding example:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">modified_number</code> is a nested function within the function <code class="literal">initial_number</code>.</li><li class="listitem" style="list-style-type: disc">This nested function uses a local variable, <code class="literal">x</code>, which is in the scope of the top-level function.</li><li class="listitem" style="list-style-type: disc">In the main program, we create <code class="literal">foo</code>, which is the return value of <code class="literal">initial_number</code>. But look at the return value of the <code class="literal">initial_number</code> function. It returns the nested function, <code class="literal">modified_number</code>.</li><li class="listitem" style="list-style-type: disc">What this means is that the <code class="literal">foo</code> variable becomes the nested function, <code class="literal">modified_number</code>.</li></ul></div><p>What did we achieve <a id="id455" class="indexterm"/>here? We accomplished two things—first, it enabled access to a nested function from the main program, and second, the nested function still has the original working environment we used while instantiating <code class="literal">initial_number</code>. In this example, the working environment refers to the <code class="literal">x</code> argument with a value of <code class="literal">100</code>, passed to this function. The following is the program output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>1. Initial number (orig environment during function creation): 100 </strong></span>
<span class="strong"><strong>2. Now calling this function with its original environment loaded: </strong></span>
<span class="strong"><strong> x: 100, y: 1 , x+y: 101 </strong></span>
<span class="strong"><strong> x: 100, y: 5 , x+y: 105</strong></span>
</pre></div><p>Observe that the value of <code class="literal">x</code> remains unchanged. Any subsequent calls to <code class="literal">foo</code> retain this original local environment, which is used by the nested function <code class="literal">modified_number</code>. Likewise, you can create another instance of <code class="literal">initial_number</code> with a different value of <code class="literal">x</code>. This is called a closure in Python. Closures can be used to realize design patterns such as the observer pattern.</p></div><div class="section" title="Miscellaneous features"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec107"/>Miscellaneous features</h2></div></div></div><p>Let's review <a id="id456" class="indexterm"/>some built-in functions and decorators that would come in handy while implementing some design patterns. Again, it is not a complete list, but enough to aid us in the upcoming discussion on design patterns.</p><div class="section" title="Class method"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec53"/>Class method</h3></div></div></div><p>A class method (<code class="literal">@classmethod</code>) is something that you can call without the need to create an <a id="id457" class="indexterm"/>instance of that class. Unlike a regular instance method, which takes the instance of the class (<code class="literal">self</code>) as its first argument, a class method takes the class as its first argument. The decorator <code class="literal">@classmethod</code> is just one convenient way to create a class method. We will see how to use a class method in the discussion on simple factory.</p></div><div class="section" title="Abstract method"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec54"/>Abstract method</h3></div></div></div><p>The <code class="literal">@abstractmethod</code> decorator<a id="id458" class="indexterm"/> is used to indicate that the given method is abstract and must be reimplemented in subclasses. Recall that we have already used this to implement <code class="literal">AbstractGameUnit.info()</code> as an abstract method using this decorator. See the <span class="emphasis"><em>Abstract base classes in Python</em></span> section in <a class="link" href="ch01.html" title="Chapter 1. Developing Simple Applications">Chapter 1</a>, <span class="emphasis"><em>Developing Simple Applications</em></span> for further details. In this chapter, we won't be using this decorator.</p></div><div class="section" title="The __getattr__ method"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec55"/>The __getattr__ method</h3></div></div></div><p>Python automatically<a id="id459" class="indexterm"/> calls the <code class="literal">__getattr__</code> method when you try to access an instance attribute that is not already defined in your class. You can implement <code class="literal">__getattr__</code> in your class, and use it to add special handling code for all such undefined attributes. The use of this method will be later illustrated in the adapter pattern.</p></div></div><div class="section" title="Duck typing"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec108"/>Duck typing</h2></div></div></div><p>The term <span class="strong"><strong>duck typing</strong></span>
<a id="id460" class="indexterm"/> is often exemplified as, <span class="emphasis"><em>if it swims and quacks like a duck, then we will treat that object as a duck</em></span>. Let's see what this means with a simple example. We have a class, <code class="literal">Knight</code>, with the methods <code class="literal">move</code> and <code class="literal">attack</code>, as follows: </p><div class="informalexample"><pre class="programlisting">class Knight: 
    def move(self): 
        pass 
    def attack(self): 
        pass </pre></div><p>A function takes an instance of <code class="literal">Knight</code> as an argument, and calls these methods like so:</p><div class="informalexample"><pre class="programlisting">def do_something(a_thing): 
    a_thing.move() 
    a_thing.attack() </pre></div><p>However, the function does not check whether the input argument is really an instance of the <code class="literal">Knight</code> class. As long as the object has the <code class="literal">move</code> and <code class="literal">attack</code> methods, it will not complain. Thus, in duck typing, the language does not make any verification of the object. The only thing it cares about is whether or not it can call certain attributes using that object. One advantage of duck typing is code reusability. You can reuse the <code class="literal">do_something</code> function in some other code by passing an object of a different class.</p><p>For example, imagine a <code class="literal">Lion</code> <a id="id461" class="indexterm"/>class that implements the <code class="literal">move</code> and <code class="literal">attack</code> methods. You would like to reuse the aforementioned <code class="literal">do_something</code> function in some other project that is already using this class:</p><div class="informalexample"><pre class="programlisting"> class Lion: 
    def move(self): 
        pass 
    def jump(self): 
        pass 
    def roar(self): 
        pass</pre></div><p>The <code class="literal">do_something</code> function will work just fine as long as the input object has the <code class="literal">move</code> and <code class="literal">attack</code> methods defined. How does this all translate to a design pattern discussion? Other programming languages, such as Java, define a formal interface in the code to implement certain design patterns, such as the abstract factory pattern. In C++, an abstract base class is defined with pure virtual functions. In Python, we have an option to use duck typing instead of implementing an interface or an abstract base class. For clarity on the design pattern itself, you may still want to document such an abstract base class or interface.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip61"/>Tip</h3><p>In Python, we could still use Java-style interfaces. The <span class="strong"><strong>Zope</strong></span> web framework<a id="id462" class="indexterm"/> (not covered in this book) is a good example. Visit the following link for more information: <a class="ulink" href="https://docs.zope.org/zope.interface/README.html">https://docs.zope.org/zope.interface/README.html</a>. Also, see a note in the abstract factory discussion later that shows how to enforce an interface in Python.</p></div></div><p>Duck typing offers a lot of freedom to programmers, so much freedom that it has the potential to introduce bugs that are difficult to notice just by looking at the code. But such errors can be detected with extensive unit testing. Another way to reduce such problems is to enforce strict coding standards and documentation. For example, you can create some custom coding standards that can avoid confusion arising due to duck typing.</p><p>With this basic <a id="id463" class="indexterm"/>introduction to some key language features, let's move on and discuss how to implement some design patterns, and what problems they address.</p></div></div>
<div class="section" title="Structure of the rest of the chapter"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec53"/>Structure of the rest of the chapter</h1></div></div></div><p>Before diving into the discussion on design patterns and their implementation, let's first lay out a strategy for the rest of the discussion. As mentioned before, we will review the strategy pattern, the simple and abstract factory patterns, and the adapter pattern. The discussion on design patterns will be roughly structured as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Start with a formal definition of the pattern</li><li class="listitem" style="list-style-type: disc">Present an imaginary scenario where a new feature is requested</li><li class="listitem" style="list-style-type: disc">Talk about the problem encountered in introducing this new feature</li><li class="listitem" style="list-style-type: disc">Make an attempt to solve this problem, quickly realizing that we need to rethink the design</li><li class="listitem" style="list-style-type: disc">The solution(s) to the problem using the design pattern</li></ul></div><p>For a few design patterns, we will discuss two approaches to solving the problem. A traditional approach that resembles the one followed in languages like C++, and the other, the Pythonic approach.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip62"/>Tip</h3><p>Skip the traditional solution if you are interested only in the Pythonic approach.</p></div></div><p>The following is a list of files from the supporting code bundle that will be reviewed:</p><div class="mediaobject"><img src="graphics/B05034_06_47.jpg" alt="Structure of the rest of the chapter"/></div><p>It is also worth noting that we will not be developing a full-fledged game application. The idea is to use this game theme as an aid to understanding some design patterns. The code used in this chapter is quite simple. While most of the code is illustrated in the upcoming discussion, you can also download and review the source from the supplementary code bundle for this chapter.</p></div>
<div class="section" title="Fast forward &#x2013; Attack of the Orcs v6.0.0"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec54"/>Fast forward – Attack of the Orcs v6.0.0</h1></div></div></div><p>Let's fast<a id="id464" class="indexterm"/> forward to a future imaginary version of the game!</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/></colgroup><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="emphasis"><em>This imaginary version is one of the most downloaded open source Python applications. Now you have a team of developers helping you with application development. The game has evolved quite a bit. It is no longer a simple application where you gain control of a hut by defeating the enemy. It is now a turn-based fantasy game, where the player and the enemy take turns attacking each other, or use that turn to move towards or away from the opponent.</em></span>
</p>
<p>
<span class="emphasis"><em>You have introduced several new game missions, and have redesigned and refactored the code to accommodate the new requirements. In the most recent version, you have the following game characters: Knight, Orc Rider, and Elf Rider.</em></span>
</p>
</td></tr></tbody></table></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip63"/>Tip</h3><p>An<a id="id465" class="indexterm"/> <span class="strong"><strong>Elf</strong></span> is an imaginary supernatural mythical being. Read the <span class="emphasis"><em>The theme of the book</em></span> section in <a class="link" href="ch01.html" title="Chapter 1. Developing Simple Applications">Chapter 1</a>, <span class="emphasis"><em>Developing Simple Applications</em></span> for some references on Elves.</p></div></div><p>Each game character in this version has an ability to attack the enemy, move towards or away from the enemy, or get healed inside a hut. Let's not worry about the actual logic that implements these features in the application. We shall rather focus on the high-level design of the application. The following pseudo-UML diagram shows various classes and a few of their public methods:</p><div class="mediaobject"><img src="graphics/B05034_06_01.jpg" alt="Fast forward – Attack of the Orcs v6.0.0"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note15"/>Note</h3><p>As indicated in <a class="link" href="ch01.html" title="Chapter 1. Developing Simple Applications">Chapter 1</a>, <span class="emphasis"><em>Developing Simple Applications</em></span>, we will loosely follow the UML representation. We referred to it as a pseudo-UML schematic. An explanation for the convention used here is in order. Each class in the schematics is represented by a rounded rectangle. It shows the class name followed by its attributes. The plus sign (<code class="literal">+</code>) before the attribute indicates it is public. A protected or private method is generally represented with a negative sign (<code class="literal">-</code>). For ease of illustration, only a few relevant public attributes will be listed.</p></div></div><p>As illustrated<a id="id466" class="indexterm"/> in the class diagram, all the game characters inherit from a common superclass, <code class="literal">AbstractGameUnit</code>. Each of the subclasses has its own implementation of <code class="literal">info()</code> and <code class="literal">attack()</code>. In other words, each subclass has its own way of attacking the enemy. Further assume that in the aforementioned version, all the subclasses use a common <code class="literal">move()</code> method defined in the superclass. This could be better imagined if you see the game instructions in action. </p><p>See the following screenshot that shows how the player will be prompted to perform a move:</p><div class="mediaobject"><img src="graphics/B05034_06_02.jpg" alt="Fast forward – Attack of the Orcs v6.0.0"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note16"/>Note</h3><p>
<span class="strong"><strong>Cool! I want to play this new game scenario. Where is the source code?</strong></span>
</p><p>The intention here is not to develop the full game logic. This is an imaginary scenario that is used just to highlight some commonly encountered problems in application development. With this scenario, we will see how design patterns could help tackle such problems. No code has been provided to actually "play" this new game. The supporting code illustrates how to implement various design patterns discussed here.</p></div></div><p>As can be <a id="id467" class="indexterm"/>seen from the command-line output, it gives the player a choice to move in one of four directions. It also indicates what lies ahead in each direction. In this particular case, the player decides to go South, but this movement is restricted by a fence.</p></div>
<div class="section" title="Strategy pattern"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec55"/>Strategy pattern</h1></div></div></div><p>A<a id="id468" class="indexterm"/> strategy design pattern is a behavioral pattern that is used to represent a family of algorithms. An algorithm within such a family is represented as a strategy object. The pattern enables easy switching between different strategies (algorithms) of a particular family. This is generally useful when you want to switch to a different strategy at runtime. We will revisit this definition towards the end of the discussion on strategy pattern.</p><div class="section" title="Strategy scenario – The jump feature"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec109"/>Strategy scenario – The jump feature</h2></div></div></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/></colgroup><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="emphasis"><em>There is a high priority</em></span>
<a id="id469" class="indexterm"/>
<span class="emphasis"><em> feature request. Rather, it is a complaint. The users just hate the movement restriction imposed by the fence. Now even Sir Foo has joined the protest...</em></span>
</p>
</td></tr></tbody></table></div><div class="mediaobject"><img src="graphics/B05034_06_03.jpg" alt="Strategy scenario – The jump feature"/></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/></colgroup><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="emphasis"><em>Rather than removing the fence from the scenario, how about a new feature that enables units to jump over the fence or any similar obstacle?</em></span>
</p>
</td></tr></tbody></table></div><p>You have introduced a new method, <code class="literal">jump()</code>, in the superclass <code class="literal">AbstractGameUnit</code>. All the classes inherit this method, as shown in the following class diagram:</p><div class="mediaobject"><img src="graphics/B05034_06_04.jpg" alt="Strategy scenario – The jump feature"/></div><p>The fence no longer prevents <a id="id470" class="indexterm"/>the player from moving around. The new jump option enables crossing the fence without any problem. That was easy, wasn't it? Everyone is happy (especially Sir Foo)! </p></div><div class="section" title="Strategy – The problem"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec110"/>Strategy – The problem</h2></div></div></div><p>Let's fast forward to a few <a id="id471" class="indexterm"/>more major releases of the application.</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/></colgroup><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="emphasis"><em>You have introduced two new imaginary characters to the game, a Dwarf and a Fairy, offering unique skills. For example, the Fairy has powers to heal nearby injured units in your army, and the Dwarf units offer a solid line of defense against enemy attack. With this, the number of application downloads per week has now reached a new high. However, there is a new problem that the users have reported. Let's hear it from The Great Dwarf:</em></span>
</p>
</td></tr></tbody></table></div><div class="mediaobject"><img src="graphics/B05034_06_05.jpg" alt="Strategy – The problem"/></div><p>Do you see the <a id="id472" class="indexterm"/>problem here? The jump feature has an unwanted side effect. It allows even a Fairy or a Dwarf to jump over the fence. The Knight, ElfRider, and OrcRider are all mounted units. It is easier to imagine these units jumping over the fence. However, it is not intuitive to think this way for a game character like a Dwarf. We encounter this issue because all the classes use the default implementation of the <code class="literal">AbstractGameUnit.jump</code> method. This is shown in the following class diagram:</p><div class="mediaobject"><img src="graphics/B05034_06_06.jpg" alt="Strategy – The problem"/></div></div><div class="section" title="Strategy – Attempted solution"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec111"/>Strategy – Attempted solution</h2></div></div></div><p>The Dwarf and <a id="id473" class="indexterm"/>Fairy game units should not have the jump feature. So what can we do here? The Fairy has something to say:</p><div class="mediaobject"><img src="graphics/B05034_06_07.jpg" alt="Strategy – Attempted solution"/></div><p>Using<a id="id474" class="indexterm"/> inheritance is certainly one approach. You can override the <code class="literal">jump</code> method and make it a no operation inside the new classes. However, in the next release, you are planning to introduce a number of new characters that are not supposed to jump, or need to jump differently. Some of the new classes are represented in the following class diagram. All of these need to override and implement their own logic.</p><div class="mediaobject"><img src="graphics/B05034_06_08.jpg" alt="Strategy – Attempted solution"/></div><p>The<a id="id475" class="indexterm"/> jump feature is just one of the many things where you will see this problem. We don't even need to look beyond what we already have. In the preceding diagram, look at the <code class="literal">move</code> and <code class="literal">attack</code> methods. Do you see the same problem brewing?</p><p>The game characters are evolving. They have their own rules to move. For example, a <code class="literal">Knight</code> riding a horse may cross a river in two turns, whereas a <code class="literal">DwarfFighter</code> would need 10 turns for the same task.</p><p>Similarly, each unit has its signature style for attacking the enemy. An old <code class="literal">Wizard</code> in your army can cast magical spells on the enemy. The <code class="literal">ElfRider</code> character attacks twice in a single turn using a bow and arrows. The <code class="literal">DwarfFighter</code> character uses a hammer to attack, and so on.</p><p>If we continue to use the inheritance principle here, it would soon become a maintenance nightmare. Why so? This is because each class that you write is responsible for implementing and maintaining its own logic for its move, jump, and attack abilities. Initially, you may see this as a trivial issue, where overriding the functionality in the subclasses just works. But with a growing number of character types and their ever-growing set of abilities (move, jump, swim, defend, hide, regenerate, and so on), this will turn out to be a daunting task. The code might also get repeated across classes. </p><p>Every small change to the logic will require you to update the corresponding methods in all the classes. It could also invite new bugs if you miss out a few methods during the update process. We need to <a id="id476" class="indexterm"/>rethink the design to accommodate future requirements easily. Let's do that next.</p></div><div class="section" title="Strategy – Rethinking the design"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec112"/>Strategy – Rethinking the design</h2></div></div></div><p>What can we do in <a id="id477" class="indexterm"/>such situations? Observe that the implementation code defining these abilities varies across subclasses. In this example, the <code class="literal">DwarfFighter</code> cannot jump whereas a <code class="literal">Knight</code> jumps using a horse.</p><p>The first question to ask is why do these classes carry the burden of defining abilities? Can this be outsourced to a different class or a function? We will redesign the <code class="literal">AbstractGameUnit</code> class (and its subclasses) so that the various abilities are now handled by objects dedicated to those tasks. In other words, we will use object composition to take this load off <code class="literal">AbstractGameUnit</code> and its subclasses.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note17"/>Note</h3><p>Recall that in <a class="link" href="ch01.html" title="Chapter 1. Developing Simple Applications">Chapter 1</a>, <span class="emphasis"><em>Developing Simple Applications</em></span>, we used object composition in the <code class="literal">Hut</code> class where its <code class="literal">occupant</code> was represented by a different object. Object composition allows you to represent a complex object by putting together simple objects. Just say it out loud, a Knight has-the ability to move, a Knight has the ability to jump, and so on. Each of these abilities will be represented by separate objects.</p></div></div><p>How do we implement this new design? We will discuss two approaches to solving this problem. The first one is more of a classical approach that resembles the one typically followed in other languages, such as C++. If you have such a development background, this approach will look more familiar. The second approach is more Pythonic. It uses first-class functions, a language feature in Python. This second approach will make the whole problem appear trivial. If you are not interested in the traditional approach, skip ahead to the Pythonic solution for the strategy pattern.</p></div><div class="section" title="Strategy solution 1 – Traditional approach"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec113"/>Strategy solution 1 – Traditional approach</h2></div></div></div><p>In the preceding section, we<a id="id478" class="indexterm"/> decided to create dedicated objects to represent abilities such as jump. Let's draw a class diagram that explains this better:</p><div class="mediaobject"><img src="graphics/B05034_06_09.jpg" alt="Strategy solution 1 – Traditional approach"/></div><p>Here is a more verbose <a id="id479" class="indexterm"/>description of what is represented in the preceding diagram:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Three new classes, <code class="literal">AttackStrategy</code>, <code class="literal">MoveStrategy</code>, and <code class="literal">JumpStrategy</code>, now handle the logic for the <code class="literal">attack</code>, <code class="literal">move</code>, and <code class="literal">jump</code> methods respectively.</li><li class="listitem" style="list-style-type: disc">The class <code class="literal">AbstractGameUnit</code> is now composed of the instances of these classes, namely <code class="literal">attack_strategy</code>, <code class="literal">move_strategy</code>, and <code class="literal">jump_strategy</code>.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">AbstractGameUnit.jump</code> method just calls <code class="literal">jump_strategy.jump()</code>. A similar implementation for the <code class="literal">move</code> and <code class="literal">attack</code> methods is followed.</li></ul></div><p>As the game characters need their on-jump implementation, we will create subclasses of <code class="literal">JumpStrategy</code>. For example, a subclass <code class="literal">CanNotJump</code> can be used for game units that are unable to jump. This is illustrated in the following class diagram:</p><div class="mediaobject"><img src="graphics/B05034_06_10.jpg" alt="Strategy solution 1 – Traditional approach"/></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note18"/>Note</h3><p>
<span class="strong"><strong>Revisiting the strategy pattern definition</strong></span>:</p><p>We started the discussion on strategy pattern with a definition. This design pattern represents a family of algorithms. Take a closer look at the preceding class diagram. The <code class="literal">JumpStrategy</code> and its subclasses represent a family of algorithms. Functionality defined in each of these classes is equivalent to an algorithm or a strategy. These classes are part of the same family, because the execution of any of the algorithms is related to a jump. As an example, the <code class="literal">PowerJump</code> class defines an algorithm different from the <code class="literal">HorseJump</code> class. Likewise, <code class="literal">MoveStrategy</code> defines a family of algorithms for movement, and <code class="literal">AttackStrategy</code> for attacking the enemy. There is one last missing piece to complete the strategy pattern. We need a way to dynamically switch between algorithm families. Let's see how to implement this next.</p></div></div><p>Let's review the new <a id="id480" class="indexterm"/>class, <code class="literal">JumpStrategy</code>. It now defines the jump behavior that was earlier defined in <code class="literal">AbstractGameUnit</code>. The overall logic is represented by the following schematic diagram and the code fragments. For easier understanding, we will only discuss the methods related to the jump ability:</p><div class="mediaobject"><img src="graphics/B05034_06_11.jpg" alt="Strategy solution 1 – Traditional approach"/></div><p>Thus, we have a family of<a id="id481" class="indexterm"/> algorithms represented by <code class="literal">JumpStrategy</code> and its subclasses. Here is the related code fragment that shows the classes <code class="literal">AbstractGameUnit</code> and <code class="literal">DwarfFighter</code>. The supporting file, <code class="literal">strategypattern_traditional.py</code>, contains this code:</p><div class="mediaobject"><img src="graphics/B05034_06_12.jpg" alt="Strategy solution 1 – Traditional approach"/></div><p>The instance <a id="id482" class="indexterm"/>variable <code class="literal">self.jump_strategy</code> is used to represent a strategy or an algorithm for the jump behavior. The subclasses of <code class="literal">AbstractGameUnit</code> get to choose any jump strategy from the family of algorithms defined by the <code class="literal">JumpStrategy</code> class and its subclasses. For example, the <code class="literal">DwarfFighter</code> subclass can use the algorithm defined in the <code class="literal">CanNotJump</code> class as its jump strategy, and so on. The <code class="literal">AbstractGameUnit.jump</code> method is now an API method for the calling code. This method relies on the strategy object for the actual jump implementation. It simply calls the corresponding method of that strategy object, as shown in the preceding class diagram. </p><p>The subclass <code class="literal">DwarfFighter</code> in this simple example just overrides the abstract method info. You may include some additional customization to this class. Now let's look at the family of algorithms for the jump feature:</p><div class="mediaobject"><img src="graphics/B05034_06_13.jpg" alt="Strategy solution 1 – Traditional approach"/></div><p>As mentioned earlier, the<a id="id483" class="indexterm"/> purpose is not to develop a full-fledged game application, but just to understand the important concepts in application development. In this trivial example, we just print an informative message to illustrate the concept. In a practical implementation, these are the classes where your algorithms need to be defined. Finally, let's review the calling code that instantiates a game character, and dynamically sets up different jump strategies:</p><div class="mediaobject"><img src="graphics/B05034_06_14.jpg" alt="Strategy solution 1 – Traditional approach"/></div><p>We start by creating <code class="literal">jump_strategy</code>, an object that defines how the unit should jump. In this case, it is passed as an argument to the <code class="literal">__init__</code> method for <code class="literal">DwarfFighter</code>. Alternatively, you could also define a default strategy object in this class, as we know the default behavior for this class (the unit cannot jump). You can then call <code class="literal">set_jump_strategy</code> to switch to a different jump algorithm, as illustrated in the code fragment. Here is the<a id="id484" class="indexterm"/> output of this program:</p><div class="mediaobject"><img src="graphics/B05034_06_15.jpg" alt="Strategy solution 1 – Traditional approach"/></div></div><div class="section" title="Strategy solution 2 – Pythonic approach"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec114"/>Strategy solution 2 – Pythonic approach</h2></div></div></div><p>What we discussed in the<a id="id485" class="indexterm"/> last section was more of a traditional approach, typically followed in programming languages such as C++. Given the flexibility that the Python language offers, there is no real need to define the various strategy classes as illustrated in the previous solution. We will exploit first-class functions, the language feature discussed earlier. Let's look at the revised code. You can also find this code in the <code class="literal">strategypattern_pythonic.py</code> file in the code bundle:</p><div class="mediaobject"><img src="graphics/B05034_06_16.jpg" alt="Strategy solution 2 – Pythonic approach"/></div><p>In the preceding code, we<a id="id486" class="indexterm"/> have used the Python language feature that supports assigning a function (<code class="literal">jump_strategy</code>) to a variable (<code class="literal">self.jump</code>). Why do we do this? It will become clear when we review the next code fragment. Before that, let's quickly discuss the preceding code snippet.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note19"/>Note</h3><p>
<span class="strong"><strong>What exactly do we accomplish with the following assert statement?</strong></span>
</p><div class="informalexample"><pre class="programlisting">assert(isinstance(jump_strategy, Callable))</pre></div><p>This statement is from <code class="literal">AbstractGameUnit.__init__</code> method in the earlier code snippet. Before assigning the function to a variable, we need to make sure that it is indeed a function. The assertion prevents further execution of the code if this condition is not met. The idea is simple. You want to make sure that <code class="literal">jump_strategy</code> is a callable object. Any callable object defines a built-in <code class="literal">__call__()</code> method. The <code class="literal">collections.abc.Callable</code> class is an abstract base class for all the classes that provide a built-in <code class="literal">__call__()</code> method. In the <code class="literal">assert</code> statement, we check whether <code class="literal">jump_strategy</code> is an instance of this <code class="literal">Callable</code> class. For Python 2.7.9, this class should be imported directly as <code class="literal">collections.Callable</code>.</p></div></div><p>As before, let's review the code fragment that instantiates a game character (<code class="literal">dwarf</code>), and dynamically sets up different jump strategies:</p><div class="mediaobject"><img src="graphics/B05034_06_17.jpg" alt="Strategy solution 2 – Pythonic approach"/></div><p>Compare this code <a id="id487" class="indexterm"/>with the first approach discussed earlier. There is a difference. In the previous solution, while instantiating <code class="literal">DwarfFighter</code>, we passed an instance of the class <code class="literal">CanNotJump</code> that deals with the jump behavior. Here, we pass the function <code class="literal">can_not_jump</code> as an argument, just like any simple variable. To dynamically change the <code class="literal">jump</code> algorithm, we just assign <code class="literal">dwarf.jump</code> to <code class="literal">power_jump</code>, as shown. Now when we call <code class="literal">dwarf.jump()</code>, it actually executes the code in the <code class="literal">power_jump()</code> function.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip64"/>Tip</h3><p>
<span class="strong"><strong>Remarks on the Pythonic way</strong></span>:</p><p>What we just saw was a cool Pythonic way that made things very easy. If you are coming from a C++ or Java programming background, at first you might feel uncomfortable with the freedom that Python offers. For example, there could be situations where a programmer mistakenly treats a function argument as a simple variable, leading to potential bugs. But this should not stop you from using this excellent language feature. To avoid such problems, you should document the code well so that the purpose of each input argument is clear.</p></div></div></div></div>
<div class="section" title="Simple factory"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec56"/>Simple factory</h1></div></div></div><p>A simple factory<a id="id488" class="indexterm"/> is generally not viewed as a formal design pattern, but you will find it quite useful in your day-to-day programming. The understanding we gain at the end of this section will be helpful in the discussion on a more formal pattern called abstract factory design pattern. Let's start with the definition of a simple factory.</p><p>A factory encapsulates the instance creation piece. The client code doesn't need to know the logic of instance creation. It just knows that whenever it needs an object of a specific type, the factory is the go-to place. Any class, or function, or class method that is used to construct such objects is often referred to as a factory. A simple factory is something you will use quite often. It is typically considered a better object-oriented technique than a formal design pattern.</p><div class="section" title="Simple factory scenario – The recruit feature"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec115"/>Simple factory scenario – The recruit feature</h2></div></div></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/></colgroup><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="emphasis"><em>Recall that we had fast-forwarded the game to an imaginary future version called Attack of the Orcs v6.0.0. This version introduced another much-anticipated feature that enabled recruiting new units to fight against the enemy.</em></span>
</p>
</td></tr></tbody></table></div><p>Here is the initial<a id="id489" class="indexterm"/> version of the <code class="literal">recruit</code> method of a new class, <code class="literal">Kingdom</code>. Other methods are not shown. Let's assume those exist. Further assume that the player or the enemy is allowed to recruit any of the following game characters: <code class="literal">ElfRider</code>, <code class="literal">Knight</code>, <code class="literal">DwarfFighter</code>, <code class="literal">OrcRider</code>, and <code class="literal">OrcKnight</code>:</p><div class="mediaobject"><img src="graphics/B05034_06_18.jpg" alt="Simple factory scenario – The recruit feature"/></div><p>The <code class="literal">recruit</code> method has the logic to create a game unit based on user input (the <code class="literal">if..else</code> block). Once the character is created, <code class="literal">Kingdom</code> pays for the hiring fees (<code class="literal">pay_gold</code>), and a central <a id="id490" class="indexterm"/>database is updated to reflect the new addition to the army (<code class="literal">update_records</code>).</p></div><div class="section" title="Simple factory – The problem"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec116"/>Simple factory – The problem</h2></div></div></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/></colgroup><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="emphasis"><em>As expected, users liked this </em></span>
<a id="id491" class="indexterm"/>
<span class="emphasis"><em>feature, and now want the ability to recruit even more unit types. Let's see what Sir Foo has to say:</em></span>
</p>
</td></tr></tbody></table></div><div class="mediaobject"><img src="graphics/B05034_06_19.jpg" alt="Simple factory – The problem"/></div><p>Let's add new recruit types, and to avoid Sir Foo's wrath, remove <code class="literal">OrcKnight</code>:</p><div class="mediaobject"><img src="graphics/B05034_06_20.jpg" alt="Simple factory – The problem"/></div><p>As can be seen in the<a id="id492" class="indexterm"/> preceding code snippet, this is already becoming difficult to maintain. Tomorrow, you may decide to support even more units, or remove some of the existing ones. How do we handle this problem? Let's see that next.</p></div><div class="section" title="Simple factory – Rethinking the design"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec117"/>Simple factory – Rethinking the design</h2></div></div></div><p>What can we say<a id="id493" class="indexterm"/> about that big <code class="literal">if..else</code> block in the <code class="literal">recruit</code> method? It is subject to change. The rest of the code in the method is just the bookkeeping (for example, updating records) and remains unchanged. What if we take out the variable piece of code and give it a new home? It will take the load off the <code class="literal">recruit</code> method so that you don't need to open it for editing every time there is a change in the requirements. The next question to ask is where do we put this code?</p><div class="mediaobject"><img src="graphics/B05034_06_21.jpg" alt="Simple factory – Rethinking the design"/></div><p>Yes Fairy, that is <a id="id494" class="indexterm"/>an option. You can create a new method in the <code class="literal">Kingdom</code> class, and dump all this object creation code in there.</p><p>But imagine a game scenario where there is a grand galactic army, represented by a <code class="literal">GalacticArmy</code> class. This class needs a way to recruit or get various game characters. It is not at all related to the <code class="literal">Kingdom</code> class. Thus, we won't be able to reuse the object creation code in <code class="literal">Kingdom.recruit</code>.</p><p>Let's free the <code class="literal">Kingdom</code> class of the responsibility for creating new units. Once again, we will use the object composition principle. Let there be a new class (or even a function) that encapsulates the instance creation piece. We will call this a simple factory. The client code (the <code class="literal">Kingdom</code> or <code class="literal">GalacticArmy</code> class in this discussion) can now use this factory to get specific types of objects.</p></div><div class="section" title="Simple factory solution 1 – Traditional approach"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec118"/>Simple factory solution 1 – Traditional approach</h2></div></div></div><p>It is now time to implement the <a id="id495" class="indexterm"/>simple factory. Let's review a traditional approach first.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip65"/>Tip</h3><p>This is the bare minimum code, without any exception handling. The purpose is just to illustrate a simple factory using a style that somewhat resembles a C++ implementation. You can make it more robust as an exercise. The code can be found in the <code class="literal">simplefactory_traditional.py</code> file. This example is written as a single module for ease of understanding. Ideally, you should refactor this, and put classes in their own modules.</p></div></div><p>Take a look at the following<a id="id496" class="indexterm"/> reworked code. We start with the new class, <code class="literal">UnitFactory</code>, which encapsulates the object creation piece:</p><div class="mediaobject"><img src="graphics/B05034_06_22.jpg" alt="Simple factory solution 1 – Traditional approach"/></div><p>In the preceding code, we have refactored out the big <code class="literal">if..else</code> clause in the <code class="literal">Kingdom.recruit</code> method discussed earlier, and put it in the <code class="literal">create_unit</code> method of the <code class="literal">UnitFactory</code> class. The <code class="literal">create_unit</code> method only has a single responsibility to create and return an instance of a game character for the given input argument (<code class="literal">unit_type</code>). The following is the <code class="literal">Kingdom</code> class after this refactoring:</p><div class="mediaobject"><img src="graphics/B05034_06_23.jpg" alt="Simple factory solution 1 – Traditional approach"/></div><p>The <code class="literal">self.factory</code> instance<a id="id497" class="indexterm"/> represents <code class="literal">UnitFactory</code>. In the <code class="literal">recruit</code> method, the responsibility for creating game characters is delegated to this factory object. The <code class="literal">pay_gold</code> and <code class="literal">update_records</code> methods are just shown for completeness. Let's not worry about the logic inside these two methods. They remain unchanged. Finally, the following is one way to use the factory. The code is self-explanatory:</p><div class="mediaobject"><img src="graphics/B05034_06_24.jpg" alt="Simple factory solution 1 – Traditional approach"/></div><p>What we have not shown in this example is the actual implementation of the concrete product classes that our factory uses to create products, such as <code class="literal">ElfRider</code>, <code class="literal">Knight</code>, and so on. These classes are going to be similar to the ones we have discussed so far. For example, all these concrete classes can be subclasses of <code class="literal">AbstractGameUnit</code>. These details were not shown in the example we just covered. However, this is not the only way to implement a simple factory. In Python, we can deal with this problem in other ways as well. One such approach will be discussed next.</p></div><div class="section" title="Simple factory solution 2 – Pythonic approach"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec119"/>Simple factory solution 2 – Pythonic approach</h2></div></div></div><p>There is one problem<a id="id498" class="indexterm"/> with the solution presented in the previous section. You still need to maintain the <code class="literal">if..else</code> block in <code class="literal">create_unit</code>. Another thing to ask is, do we really need to instantiate <code class="literal">UnitFactory</code>? Depending on your application, the answer could be yes or no. In this example, the <code class="literal">create_unit</code> code would be identical for each instance of the factory you create. So, we do not really need an instance of <code class="literal">UnitFactory</code>. Let's discuss how to implement a simple factory without actually instantiating it.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip66"/>Tip</h3><p>What is illustrated here is not the only way to implement a simple factory. The source code is available in the supporting material as <code class="literal">simplefactory_pythonic.py</code>. Depending on the type of problem you are dealing with, you can tweak this approach further, and come up with a different solution. For example, you can choose a factory instance, and access its methods as normal instance methods. This approach is illustrated in the <code class="literal">simplefactory_pythonic_alternatesolution.py</code> file.</p></div></div><p>Here is the reworked <code class="literal">UnitFactory</code> class from the file <code class="literal">simplefactory_pythonic.py</code>:</p><div class="mediaobject"><img src="graphics/B05034_06_25.jpg" alt="Simple factory solution 2 – Pythonic approach"/></div><p>Earlier in the chapter, we reviewed some Python language features that come in handy for design patterns. Let's see how first-class classes and class methods can be used in a simple factory:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">units_dict</code> is a Python dictionary object declared as a class variable (for the class <code class="literal">UnitFactory</code>).</li><li class="listitem" style="list-style-type: disc">Python classes are first-class objects. So we can simply put them as values of the dictionary, <code class="literal">units_dict</code>. The dictionary keys can be unique strings of your choice. Just make sure that the calling code knows which key corresponds to which class.</li><li class="listitem" style="list-style-type: disc">The method <code class="literal">create_unit</code> is defined as a class method using the decorator <code class="literal">@classmethod</code>. What this means is that the first argument passed to this method is the class itself (denoted by <code class="literal">cls</code>) instead of being self (an instance of the class).</li><li class="listitem" style="list-style-type: disc">Now look at <a id="id499" class="indexterm"/>the <code class="literal">return</code> statement of the <code class="literal">create_unit</code> method:<div class="informalexample"><pre class="programlisting">return cls.units_dict.get(key)()</pre></div><p>Here, we access <code class="literal">units_dict</code>, a class variable, as <code class="literal">cls.units_dict</code>, and get the value for a particular key given as an input argument. This can be better explained with an example. Assume that the given key is <code class="literal">elfrider</code>. The corresponding value in the dictionary is the <code class="literal">ElfRider</code> class. So, the <code class="literal">create_unit</code> method will return <code class="literal">ElfRider()</code>, which is an instance of the <code class="literal">ElfRider</code> class.</p></li></ul></div><p>Compare this code with the one we saw in the previous heading, <span class="emphasis"><em>Simple factory solution 1 – Traditional approach</em></span>. As can be noticed, the number of lines of code has not been reduced significantly. But the code clarity is much better here. You still need to maintain the dictionary object (<code class="literal">units_dict</code>) for all future requirements, which is relatively easy compared to maintaining the <code class="literal">if..else</code> clause.</p><p>Now observe the <code class="literal">Kingdom</code> class. It has just a few changes:</p><div class="mediaobject"><img src="graphics/B05034_06_26.jpg" alt="Simple factory solution 2 – Pythonic approach"/></div><p>Let's review the preceding code snippet</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">First, we assign <a id="id500" class="indexterm"/>the <code class="literal">UnitFactory</code> class to a class variable, <code class="literal">factory</code>. Again, we can do this because Python classes are first-class objects.</li><li class="listitem" style="list-style-type: disc">The <code class="literal">recruit</code> method is just a normal instance method of <code class="literal">Kingdom</code>. The class variable <code class="literal">factory</code> is accessed as <code class="literal">type(self).factory</code>.</li><li class="listitem" style="list-style-type: disc">In this example, <code class="literal">type(self).factory.create_unit</code> is equivalent to <code class="literal">UnitFactory.create_unit</code>. We could have directly written it that way, but if a subclass of <code class="literal">Kingdom</code> defines its <code class="literal">factory</code> as a different class, say <code class="literal">DwarfUnitFactory</code>, then it will require you to write some extra code, such as overriding the <code class="literal">recruit</code> method.</li></ul></div><p>Finally, here is the calling code. Notice that we are not creating any <code class="literal">factory</code> instances:</p><div class="mediaobject"><img src="graphics/B05034_06_27.jpg" alt="Simple factory solution 2 – Pythonic approach"/></div><p>The discussion on the simple factory has set the stage for the formal design pattern called the abstract factory pattern. Let's review that next.</p></div></div>
<div class="section" title="Abstract factory pattern"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec57"/>Abstract factory pattern</h1></div></div></div><p>We have just <a id="id501" class="indexterm"/>learned how to create and use a simple factory in a program. Let's go a little further and study a formal pattern known as the abstract factory pattern.</p><p>Imagine we have a master factory and some follower factories. Further assume that each follower factory is responsible for producing its own trademark products (objects). The follower factories are related in some sense. They create products that share a common theme. For example, each follower factory produces its own version of tomato ketchup. The factories have their own ordering form for their product.</p><p>The customers have a hard time in keeping up with so many forms for ordering a tomato ketchup. For example, one factory says you should call it MyRedTomatoKetchup, otherwise it won't understand. So, the master factory says:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/></colgroup><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="emphasis"><em>We make products that are like a part of an extended family. Our customers would benefit if we can simplify and standardize the procedure to order these products from our group of factories. From now on, every follower factory is required to implement a common ordering form.</em></span>
</p>
</td></tr></tbody></table></div><p>The customers<a id="id502" class="indexterm"/> benefit, as they just need to know the high-level name tomato ketchup and the factory that can supply this product. Let's put this into programming terminology:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The master factory is an abstract factory, and the follower factories are concrete factories.</li><li class="listitem" style="list-style-type: disc">The tomato ketchup is an abstract class. Every concrete factory creates its custom version of tomato ketchup; we will call this a concrete object (an instance of a concrete class).</li><li class="listitem" style="list-style-type: disc">The standardization procedure referenced earlier is called an interface. The abstract factory declares such an interface (or in Python terms, a set of abstract methods) that is required to be implemented by the concrete factories for creating families of concrete objects.</li><li class="listitem" style="list-style-type: disc">The customer is the client code. It doesn't need to know the details of the concrete object received from a concrete factory. It just needs to have knowledge of the abstract class.</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note21"/>Note</h3><p>The Java programming language has a provision to create an abstract type called interface. If a class implements an interface, it must implement all the methods described by that interface. For more information on <a id="id503" class="indexterm"/>interface in the Java language, visit the wiki page: <a class="ulink" href="https://en.wikipedia.org/wiki/Interface_(Java)">https://en.wikipedia.org/wiki/Interface_(Java)</a>. In Python, there is no such formal provision to create and implement an interface. Instead, we can use inheritance, where concrete factories inherit from the abstract factory. Instead, we can use the first-class features offered by Python, as discussed earlier. Let's see these next.</p></div></div><p>Quite a mouthful? Let's dig deeper into the abstract factory pattern with a game scenario.</p><div class="section" title="Abstract factory scenario – An accessory store"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec120"/>Abstract factory scenario – An accessory store</h2></div></div></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/></colgroup><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="emphasis"><em>Imagine </em></span>
<a id="id504" class="indexterm"/>
<span class="emphasis"><em>you have implemented a new feature that enables buying accessories for your army. At the moment, you can buy an armored jacket or a gold locket, as shown in the following code fragment:</em></span>
</p>
</td></tr></tbody></table></div><div class="mediaobject"><img src="graphics/B05034_06_28.jpg" alt="Abstract factory scenario – An accessory store"/></div><p>More choices for<a id="id505" class="indexterm"/> armor and lockets were added as follows:</p><div class="mediaobject"><img src="graphics/B05034_06_29.jpg" alt="Abstract factory scenario – An accessory store"/></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/></colgroup><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="emphasis"><em>You reworked the preceding piece of code, and implemented a simple factory instead. This factory would produce all the accessories for the game characters. In this example, it would return armor and locket objects.</em></span>
</p>
</td></tr></tbody></table></div><p>The reworked code, which implements a simple factory, is shown next:</p><div class="mediaobject"><img src="graphics/B05034_06_30.jpg" alt="Abstract factory scenario – An accessory store"/></div><p>The <code class="literal">Kingdom</code> class and the main<a id="id506" class="indexterm"/> execution code is shown next. The <code class="literal">Kingdom</code> class has an instance variable, <code class="literal">self.factory</code>, which represents our simple factory:</p><div class="mediaobject"><img src="graphics/B05034_06_31.jpg" alt="Abstract factory scenario – An accessory store"/></div><p>The <code class="literal">self.factory</code> variable is used to<a id="id507" class="indexterm"/> create <code class="literal">armor</code> and <code class="literal">locket</code> instances, as indicated in the <code class="literal">buy_accessories</code> method.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip67"/>Tip</h3><p>As illustrated in the section on simple factories, the factory can also be specified as a class attribute accessed as <code class="literal">Kingdom.factory</code>, instead of creating an instance, <code class="literal">self.factory</code>.</p></div></div><div class="mediaobject"><img src="graphics/B05034_06_49.jpg" alt="Abstract factory scenario – An accessory store"/></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/></colgroup><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="emphasis"><em>The changes you made simplified the implementation. Looks like Sir Foo is quite happy with his new Iron jacket, however, that doesn't seem to be the case with others! There is a</em></span>
<a id="id508" class="indexterm"/>
<span class="emphasis"><em> new problem...</em></span>
</p>
</td></tr></tbody></table></div></div><div class="section" title="Abstract factory – The problem"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec121"/>Abstract factory – The problem</h2></div></div></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/></colgroup><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="emphasis"><em>One size</em></span>
<a id="id509" class="indexterm"/>
<span class="emphasis"><em> doesn't fit all! The DwarfKingdom is now using this AccessoryFactory, and has reported problems with the products:</em></span>
</p>
</td></tr></tbody></table></div><div class="mediaobject"><img src="graphics/B05034_06_32.jpg" alt="Abstract factory – The problem"/></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/></colgroup><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="emphasis"><em>The Great Dwarf has reason to be annoyed. The factory does not support customization for the products it creates. How do we address this?</em></span>
</p>
</td></tr></tbody></table></div><p>This is one scenario where <a id="id510" class="indexterm"/>we can use the abstract factory pattern.</p></div><div class="section" title="Abstract factory – Rethinking the design"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec122"/>Abstract factory – Rethinking the design</h2></div></div></div><p>Observe the following class <a id="id511" class="indexterm"/>diagram. It represents a typical abstract factory pattern, our approach to solve the problem:</p><div class="mediaobject"><img src="graphics/B05034_06_33.jpg" alt="Abstract factory – Rethinking the design"/></div><p>Let's review the components <a id="id512" class="indexterm"/>of the UML-like diagram presented here, and correlate them with the terms used in the earlier definition of an abstract factory:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">DwarfAccessoryFactory</code>, <code class="literal">ElfAccessoryFactory</code>: The follower or concrete factories. Recall that each concrete factory creates products that share a common theme. Here, they create accessories for the game characters. As mentioned earlier, they are required to implement standard procedures set by the master factory.</li><li class="listitem" style="list-style-type: disc"><code class="literal">AbstractAccessoryFactory</code>: This is the abstract factory class, or what we referred to as a master factory earlier. It defines an interface (a set of abstract methods) that must be implemented by the concrete factories. In this case, each of the concrete factories is required to implement methods to create armors and lockets.</li><li class="listitem" style="list-style-type: disc">In this example, each concrete factory implements the <code class="literal">create_armor</code> and <code class="literal">create_locket</code> methods. These methods return instances of concrete product classes. Thus, each factory creates its own flavor of the products. For instance, <code class="literal">create_locket</code> of <code class="literal">DwarfAccessoryFactory</code> returns an instance of <code class="literal">DwarfGoldLocket</code>, whereas the same method in <code class="literal">ElfAccessoryFactory</code> returns an instance of <code class="literal">ElfGoldLocket</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">AbstractArmor</code>, <code class="literal">AbstractLocket</code>: These are abstract product classes. There could be several concrete product types that inherit from these abstract classes. For example, the concrete product classes <code class="literal">DwarfGoldLocket</code> and <code class="literal">SuperLocket</code> inherit from <code class="literal">AbstractLocket</code>, and so on.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>The client code</strong></span>: This is<a id="id513" class="indexterm"/> not shown in the class diagram. The client code doesn't need to know which concrete product class gives it the desired product. It just knows the high-level name of the product (for example, <code class="literal">create_locket</code>). Essentially, it chooses the factory, and invokes the standard API methods, such as <code class="literal">create_locket</code>, to get the required objects. See the next solution section for an example.</li></ul></div><div class="section" title="Simplifying the design further"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec56"/>Simplifying the design further</h3></div></div></div><p>The preceding class <a id="id514" class="indexterm"/>diagram shows a classic way of implementing the abstract factory pattern. For ease of understanding, let's simplify the problem further. We will assume that all the concrete factories define the required methods without the abstract factory enforcing the rule (interface) to do so.</p><p>With this assumption, we could even remove the <code class="literal">AbstractAccessoryFactory</code> class from the design, and just have the concrete factories. Recall that we discussed duck typing at the beginning of this chapter. So as long as the concrete factories implement the required methods, the client code (see <code class="literal">Knight.buy_accessories</code> in the next example) won't complain.</p><p>For conceptual understanding, we will retain the inheritance hierarchy in the upcoming discussion. We will call this class simply <code class="literal">AccessoryFactory</code>, and won't define <code class="literal">create_armor</code> and <code class="literal">create_locket</code> as abstract methods. Enforcing an interface will require some minor adjustments in the code. We will briefly discuss this as an optional or advanced topic at the end of the next section, where we look at the actual implementation.</p></div></div><div class="section" title="Abstract factory solution – Pythonic approach"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec123"/>Abstract factory solution – Pythonic approach</h2></div></div></div><p>In the previous section, we<a id="id515" class="indexterm"/> saw a representative class diagram that shows the implementation details for the abstract factory pattern. We will discuss only a Pythonic solution for implementing this pattern. Since we have already covered the simple factory in depth, the abstract factory pattern is just a few steps away. We<a id="id516" class="indexterm"/> will limit our discussion to some of the important classes. Look at the <code class="literal">abstractfactory_pythonic.py</code> file in the supporting code for the complete source. </p><p>The <code class="literal">Kingdom</code> and <code class="literal">DwarfKingdom</code> classes are shown next. The code is self explanatory, and was pretty much discussed earlier:</p><div class="mediaobject"><img src="graphics/B05034_06_34.jpg" alt="Abstract factory solution – Pythonic approach"/></div><p>Let's look at the <code class="literal">AccessoryFactory</code> class (see a note on design simplification under the previous heading, <span class="emphasis"><em>Simplifying the design further</em></span>):</p><div class="mediaobject"><img src="graphics/B05034_06_35.jpg" alt="Abstract factory solution – Pythonic approach"/></div><p>This is very similar to the <code class="literal">UnitFactory</code> class we reviewed in the section on simple factory implementation. The only difference is that the factory produces two separate products, <code class="literal">armor</code> and <code class="literal">locket</code>. So, we have two different class methods (factory methods) for creating each of the concrete products. The <code class="literal">armor_dict</code> dictionary holds armor-related concrete classes as its values, and <code class="literal">locket_dict</code> is used for the locket-related classes. Both of these are defined as class variables.</p><p>The following code snippet is for <code class="literal">DwarfAccessoryFactory</code>, one of the concrete factories. Here, we have only redefined the <code class="literal">armor_dict</code> and <code class="literal">locket_dict</code> dictionaries. Nothing else changes. Likewise, you can define other concrete factories such as <code class="literal">ElfAccesoryFactory</code>. If you want a strict abstract factory pattern implementation, you should also enforce an interface in the concrete factory. This is briefly discussed at the end of this section:</p><div class="mediaobject"><img src="graphics/B05034_06_36.jpg" alt="Abstract factory solution – Pythonic approach"/></div><p>The last piece of the puzzle is the main execution code. It creates two kingdoms, the first is a default <code class="literal">Kingdom</code>, and the second is a kingdom of <span class="emphasis"><em>The Great Dwarfs</em></span>—<code class="literal">DwarfKingdom</code>. This is done as follows:</p><div class="mediaobject"><img src="graphics/B05034_06_37.jpg" alt="Abstract factory solution – Pythonic approach"/></div><p>Observe that <code class="literal">buy_accessories</code> is invoked for<a id="id517" class="indexterm"/> both the kingdoms with the same arguments, <code class="literal">ironjacket</code> and <code class="literal">goldlocket</code>. But what each kingdom gets as the concrete product depends on the factory chosen. For example, as the <code class="literal">DwarfKingdom</code> has selected <code class="literal">DwarfAccessoryFactory</code> as its factory, for the abstract product named <code class="literal">ironjacket</code> it would get an instance of <code class="literal">DwarfIronJacket</code>. The following is a sample output of the code in the <code class="literal">abstractfactory_pythonic.py</code> file:</p><div class="mediaobject"><img src="graphics/B05034_06_38.jpg" alt="Abstract factory solution – Pythonic approach"/></div><div class="section" title="Advanced topic – enforcing an interface"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec57"/>Advanced topic – enforcing an interface</h3></div></div></div><p>This section illustrates one way of enforcing an interface in Python. If this does not mean anything to you right now, just ignore this and move on to the next topic.</p><p>Recall that for ease of illustrating a Pythonic solution, we had simplified the problem. <code class="literal">AccessoryFactory</code> does not enforce any rule that requires the subclasses to implement the <code class="literal">create_armor</code> and <code class="literal">create_locket</code> methods. Actually, it is easy to do so. If you are using Python 3.3 or higher, you can simply define these methods as abstract methods in addition to being class methods, using the two decorators, <code class="literal">@classmethod</code> and <code class="literal">@abstractmethod</code>, like so:</p><div class="informalexample"><pre class="programlisting">@classmethod 
@abstractmethod 
def create_armor(cls, armor_type): 
    return cls.armor_dict.get(armor_type)()</pre></div><p>In subclasses such as <code class="literal">DwarfAccessoryFactory</code>, you just need to implement these class methods. For completeness, make <code class="literal">AccessoryFactory</code> abstract by inheriting from <code class="literal">ABCMeta</code>. Technically, that would confirm the formal design of an abstract factory. But if you look at the code inside this method (<code class="literal">create_armor</code>), it hasn't changed a bit. Thus, in this example, declaring an abstract method would help only to enforce the rule that subclasses must implement certain methods.</p></div></div></div>
<div class="section" title="Adapter pattern"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec58"/>Adapter pattern</h1></div></div></div><p>The adapter design pattern<a id="id518" class="indexterm"/> enables a handshake between two incompatible interfaces. Here, the incompatible interface of a class or a library is transformed into the one expected by your client code. This transformation is accomplished by an adapter class. The other class with a different interface than what the client expects is often referred to as an adaptee.</p><p>There are two broad categories of adapter pattern, namely a class adapter pattern and an object adapter pattern. In the former, the adapter inherits from the adaptee. It is possible to implement a class adapter in Python, as the language supports multiple inheritance. However, it is better to choose object composition (has a relationship) over inheritance. In the object adapter pattern, the adapter object has an adaptee object instead of inheriting from the adaptee class. The object adapter pattern helps maintain a loose coupling between the adaptee and the client code, wherein the client does not need to have any knowledge of the adaptee interface. This offers more flexibility when compared to the class adapter pattern.</p><p>In the upcoming <a id="id519" class="indexterm"/>discussion, we will only talk about the object adapter pattern.</p><div class="section" title="Adapter scenario – Elf's distant cousin"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec124"/>Adapter scenario – Elf's distant cousin</h2></div></div></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/></colgroup><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="emphasis"><em>Let's fast-forward to an</em></span>
<a id="id520" class="indexterm"/>
<span class="emphasis"><em> imaginary future one more time. A group of developers has approached you. They have been working on a similar fantasy game application. Given the popularity of your game, they would like to collaborate. It's a win-win situation for both parties. You happily accept this proposal, as it will give you access to several game characters in their collection.</em></span>
</p>
</td></tr></tbody></table></div></div><div class="section" title="Adapter – The problem"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec125"/>Adapter – The problem</h2></div></div></div><p>You begin the integration work, and <a id="id521" class="indexterm"/>notice a problem. Let's hear it from our friend, the Elf:</p><div class="mediaobject"><img src="graphics/B05034_06_39.jpg" alt="Adapter – The problem"/></div><p>The code that <a id="id522" class="indexterm"/>follows highlights this problem further. What is shown here is a simplified version of the new <code class="literal">WoodElf</code> class that only shows the <code class="literal">leap()</code> method. Assume that all its other methods match our existing interface.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip68"/>Tip</h3><p>There is no correlation between the <code class="literal">jump</code> method (rather, the jump strategies) discussed in the section on <span class="emphasis"><em>Strategy pattern</em></span> with the one illustrated here. For easier understanding of the pattern, only the bare minimum code is shown. For example, the <code class="literal">AbstractGameUnit</code> class is not used here. As an exercise, try to use the code from the strategy pattern here, and implement an adapter so that we can talk to <code class="literal">WoodElf</code> (the solution is not provided)!</p></div></div><div class="mediaobject"><img src="graphics/B05034_06_40.jpg" alt="Adapter – The problem"/></div></div><div class="section" title="Adapter – Attempted solution"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec126"/>Adapter – Attempted solution</h2></div></div></div><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/></colgroup><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="emphasis"><em>The new class </em></span>
<a id="id523" class="indexterm"/>
<span class="emphasis"><em>doesn't have a leap() method. How can we solve this problem? Any thoughts, Fairy?</em></span>
</p>
</td></tr></tbody></table></div><div class="mediaobject"><img src="graphics/B05034_06_41.jpg" alt="Adapter – Attempted solution"/></div><p>We could have possibly <a id="id524" class="indexterm"/>done that, but this code is owned by a third party. If they have shared the source, then you can update it. But that is going to be a maintenance overhead for you. If you don't have the source code, then you have to depend on them to get this method supported. For all these reasons, the solution suggested by the Fairy may not be the best way to go forward. That said, the Fairy is on the right track! She has a <code class="literal">jump()</code> method that delegates this to the <code class="literal">leap()</code> method. Let's see how the adapter pattern can help here.</p><p>How about adding a new class that enables a handshake between these two interfaces? Look at the following code fragment:</p><div class="mediaobject"><img src="graphics/B05034_06_42.jpg" alt="Adapter – Attempted solution"/></div><p>This last code fragment<a id="id525" class="indexterm"/> seems to address one issue. We do not need to make any changes to the third-party class <code class="literal">WoodElf</code>. We feed an instance of <code class="literal">WoodElf</code> to the adapter, <code class="literal">WoodElfAdapter</code>. This adapter class has a <code class="literal">jump</code> method, which calls the <code class="literal">leap</code> method of <code class="literal">WoodElf</code>. The client code simply needs to use this adapter instance instead of the <code class="literal">WoodElf</code> instance. However, there are two main problems with this solution:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The adapter class seems to be tied to the <code class="literal">WoodElf</code> class. What if we have a new class, <code class="literal">MountainElf</code>, which implements the <code class="literal">spring</code> method as an equivalent of the <code class="literal">jump</code> method?</li><li class="listitem" style="list-style-type: disc">Imagine that the <code class="literal">WoodElf</code> class has other methods such as <code class="literal">attack</code>, <code class="literal">info</code>, <code class="literal">climb</code>, and so on. Some might already be compatible with the existing interface, while for others, there is no equivalent. All such methods can be directly called without any special processing like what was done for <code class="literal">leap()</code>. If we follow the approach discussed in the preceding code fragment, you will have to define each of these methods in the adapter class <code class="literal">WoodElfAdapter</code>. Without implementing them, you won't be able to use the adapter class seamlessly in your client code. That's quite a bit of work.</li></ul></div><p>It is very easy to address both these problems. Let's write a generalized solution next.</p></div><div class="section" title="Adapter solution – Pythonic approach"><div class="titlepage"><div><div><h2 class="title"><a id="ch06lvl2sec127"/>Adapter solution – Pythonic approach</h2></div></div></div><p>To summarize the<a id="id526" class="indexterm"/> problem, a new class, <code class="literal">WoodElf</code>, provided by third-party developers, has a <code class="literal">leap()</code> method instead of <code class="literal">jump()</code>. Put another way, it has an incompatible interface. We are seeking a solution that doesn't require us to touch the <code class="literal">WoodElf</code> class. We created an adapter, <code class="literal">WoodElfAdapter</code>, but it had its own shortcomings, as discussed in the previous section, <span class="emphasis"><em>Adapter – Attempted Solution</em></span>.</p><p>Let's generalize the adapter class further to address these issues. See the supplementary <code class="literal">adapterpattern.py</code> file for the source code. This will be illustrated next. First look at the following code fragment, and then we will talk through it:</p><div class="mediaobject"><img src="graphics/B05034_06_43.jpg" alt="Adapter solution – Pythonic approach"/></div><div class="mediaobject"><img src="graphics/B05034_06_44.jpg" alt="Adapter solution – Pythonic approach"/></div><p>The following things are to be <a id="id527" class="indexterm"/>noted in the preceding code screenshots:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The adapter class is renamed as <code class="literal">ForeignUnitAdapter</code>.</li><li class="listitem" style="list-style-type: disc">The first input argument, <code class="literal">adaptee</code>, represents the instance of the class for which we need an adapter. The second argument, <code class="literal">adaptee_method</code>, is the instance method that needs to be adapted (for example, <code class="literal">wood_elf.leap</code> needs to be interpreted as a <code class="literal">jump</code> method).</li><li class="listitem" style="list-style-type: disc">Next, we take advantage of the Python first-class functions to assign <code class="literal">adaptee_method</code> to <code class="literal">self.jump</code>. For example, calling <code class="literal">self.jump()</code> is now equivalent to calling <code class="literal">wood_elf.leap()</code>. This eliminates the need to create a separate <code class="literal">jump</code> method inside the adapter class.</li><li class="listitem" style="list-style-type: disc">Earlier in the chapter, we learned about the <code class="literal">__getattr__</code> method. Here, we have implemented it in the adapter class <code class="literal">ForeignUnitAdapter</code>. The client code assumes that the adapter object (which represents a third-party game character), has defined methods such as <code class="literal">info()</code>, <code class="literal">attack()</code>, and <code class="literal">climb()</code>. The client calls these methods using the adapter object. In reality, the adapter class has not defined any of them. It relies on <code class="literal">self.foreign_unit</code> to provide these methods.</li><li class="listitem" style="list-style-type: disc">This handling code is written in the <code class="literal">__getattr__</code> method. Here, <code class="literal">getattr(self.foreign_unit, item)</code> would simply return <code class="literal">self.foreign_unit.item</code>.</li><li class="listitem" style="list-style-type: disc">You can create <a id="id528" class="indexterm"/>multiple adapter objects by passing in different instances of the game units, and the method that needs to be the adapter. One such example is shown in the preceding code fragment.</li></ul></div><div class="section" title="Adapter – Multiple adapter methods"><div class="titlepage"><div><div><h3 class="title"><a id="ch06lvl3sec58"/>Adapter – Multiple adapter methods</h3></div></div></div><p>In the earlier<a id="id529" class="indexterm"/> illustration, we assumed that <code class="literal">self.jump</code> would be the handling adapter method. What if we have multiple methods that need to be an adapter to conform to our existing API? You can generalize this implementation further. Here is one way to handle multiple methods. This source can be found in the supporting code bundle. Look for the <code class="literal">adapterpattern_multiple_methods.py</code> file:</p><div class="mediaobject"><img src="graphics/B05034_06_45.jpg" alt="Adapter – Multiple adapter methods"/></div><p>The following is the main execution code:</p><div class="mediaobject"><img src="graphics/B05034_06_48.jpg" alt="Adapter – Multiple adapter methods"/></div><p>Again, we take advantage of the <a id="id530" class="indexterm"/>Python first-class functions. The <code class="literal">set_adapter</code> method uses a built-in method, <code class="literal">setattr()</code>, to set new attributes for the <code class="literal">ForeignUnitAdapter</code> class. These act as the adapter methods. Alternatively, you can also set the attributes as follows:</p><div class="informalexample"><pre class="programlisting">foo_elf_adapter.jump = foo_elf.leap 
foo_elf_adapter.attack = foo_elf.hit</pre></div></div></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch06lvl1sec59"/>Summary</h1></div></div></div><p>This chapter provided an introduction to design patterns in Python, an important aspect of application development. We started this chapter with an introduction and saw how design patterns are classified. Next we reviewed some key features offered by the Python language that help simplify several design patterns. With practical illustrations, you learned how design patterns can be implemented to provide a solution to recurring problems in application development. More specifically, you learned about strategy, abstract factory, and adapter patterns. For each of these patterns, we first used an interesting game scenario to describe the problem. We then discussed how the design pattern can tackle this problem, and further implemented the design pattern using a Pythonic approach. For some patterns, we also reviewed a traditional approach to implementing the design pattern. Last but not the least, we met some of Sir Foo's new friends.</p><p>So far, we have discussed several important aspects of application development. This discussion helped us write better code, make the application more robust, and increase the application's life expectancy. In the next three chapters, we will learn various ways to improve the performance of the application.</p></div></body></html>