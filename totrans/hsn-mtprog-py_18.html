<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer149">
<h1 id="_idParaDest-182"><em class="italic"><a id="_idTextAnchor184"/>Chapter 15</em>: Implementing a Case Study</h1>
<p>In this chapter, we will work on implementing a case study by applying the metaprogramming concepts that we have learned so far. For this case study, we will be using the <strong class="source-inline">Automobile.</strong> <strong class="source-inline">(1987)</strong>. <strong class="source-inline">UCI Machine</strong> <strong class="source-inline">Learning</strong> <strong class="source-inline">Repository</strong> dataset.</p>
<p>In this chapter, we will be looking at the following main topics:</p>
<ul>
<li>Explaining the case study</li>
<li>Defining base classes</li>
<li>Developing a code generator library</li>
<li>Generating code</li>
<li>Designing an execution framework</li>
</ul>
<p>By the end of this chapter, you should have an understanding of how to use the existing methods of the ast library in Python to enable your application to generate its own code.</p>
<h1 id="_idParaDest-183"><a id="_idTextAnchor185"/>Technical requirements</h1>
<p>The code examples shared in this chapter are available on GitHub at: <a href="https://github.com/PacktPublishing/Metaprogramming-with-Python/tree/main/Chapter15">https://github.com/PacktPublishing/Metaprogramming-with-Python/tree/main/Chapter15</a>.</p>
<h1 id="_idParaDest-184"><a id="_idTextAnchor186"/>Explaining the case study</h1>
<p>In this section, we will <a id="_idIndexMarker704"/>be looking at the details of the case study before we start implementing it. Let’s consider a car agency, <em class="italic">ABC Car Agency</em>, that focuses on sales of new and used cars from multiple brands. This agency would like to build an application that produces customized catalogs for each car displaying the various specifications and features of the car.</p>
<p>We will look at the details available to develop and build the application by applying the concepts that we have learned throughout this book. There are 205 different cars that need to be <a id="_idIndexMarker705"/>cataloged and the data used to build this case study is taken from the following dataset: <strong class="source-inline">Automobile. (1987). UCI Machine Learning Repository</strong>.</p>
<p>There are many ways to develop an application that can solve this problem. We are going to look at how to develop a reusable application that uses metaprogramming.</p>
<p>A high-level view of the automobile data is as follows:</p>
<div>
<div class="IMG---Figure" id="_idContainer143">
<img alt="Figure 15.1 – The Automobile. (1987). UCI Machine Learning Repository dataset  " height="442" src="image/Figure_15.1_B13426.jpg" width="1311"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.1 – The Automobile. (1987). UCI Machine Learning Repository dataset </p>
<p>For this case study, we are not going to perform any detailed data processing using the automobile dataset. Instead, we will be using the data available in this dataset to create various components for the application’s development. The flow of design for this example will start with developing a code generator library, followed by creating a code generator framework. We will then generate the <em class="italic">ABC Car Agency</em> library and, finally, create an execution framework. All of these processes will be explained in detail in this section.</p>
<p>The Python scripts that will be developed for this case study will be as follows:</p>
<div>
<div class="IMG---Figure" id="_idContainer144">
<img alt="Figure 15.2 – Python scripts for the ABC Car Agency case study" height="353" src="image/Figure_15.2_B13426.jpg" width="1425"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.2 – Python scripts for the ABC Car Agency case study</p>
<p>The<a id="_idIndexMarker706"/> car sales application will be developed by defining the following classes:</p>
<ul>
<li><strong class="source-inline">CarSpecs</strong></li>
<li><strong class="source-inline">CarMake</strong> with its subclasses</li>
<li><strong class="source-inline">CarCatalogue</strong></li>
<li><strong class="source-inline">BodyStyle</strong> with its subclasses</li>
<li><strong class="source-inline">SaleType</strong> with its subclasses</li>
</ul>
<p>Each of these classes will be explained in this section.</p>
<p>The overall structure of classes for this application is going to look as follows:</p>
<div>
<div class="IMG---Figure" id="_idContainer145">
<img alt="Figure 15.3 – Overview of the car sales application" height="1303" src="image/Figure_15.3_B13426.jpg" width="1297"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.3 – Overview of the car sales application</p>
<p>With this <a id="_idIndexMarker707"/>understood, we will look further at the base classes for the application.</p>
<h1 id="_idParaDest-185"><a id="_idTextAnchor187"/>Defining base classes</h1>
<p>We will now<a id="_idIndexMarker708"/> start building the code required for the case study.</p>
<p>Let’s start by developing a metaclass named <strong class="source-inline">CarSpecs</strong>. This class will have the following structure:</p>
<ol>
<li>The <strong class="source-inline">__new__</strong> of the <strong class="source-inline">CarSpecs</strong> class will perform the following tasks:<ol><li>If the attribute of the input class is an integer, then add the attribute name in title case as <strong class="source-inline">feature</strong>, the value in string format as <strong class="source-inline">info</strong>, and <strong class="source-inline">type</strong> as numeric.</li><li>If the attribute of the input class is a string, then add the attribute name in title case as <strong class="source-inline">feature</strong>, the value in string format as <strong class="source-inline">info</strong>, and <strong class="source-inline">type</strong> as varchar.</li><li>If the attribute of the input class is a Boolean, then add the attribute name title case as a <strong class="source-inline">feature</strong>, the value in string format as <strong class="source-inline">info</strong>, and <strong class="source-inline">type</strong> as Boolean.</li><li>If not, the actual attribute will be returned as such.</li></ol></li>
</ol>
<p>Let’s now look at the definition of <strong class="source-inline">CarSpecs</strong>:</p>
<p class="source-code">from abc import ABC, abstractmethod</p>
<p class="source-code">class CarSpecs(type):</p>
<p class="source-code">    def __new__(classitself, classname, baseclasses, attributes):  </p>
<p class="source-code">        newattributes = {}</p>
<p class="source-code">        for attribute, value in attributes.items():</p>
<p class="source-code">            if attribute.startswith("__"):</p>
<p class="source-code">                newattributes[attribute] = value</p>
<p class="source-code">            elif type(value)==int or type(value)==float:</p>
<p class="source-code">                newattributes[attribute] = {}</p>
<p class="source-code">                newattributes[attribute]['feature'] = attribute.title().replace('_', ' ')</p>
<p class="source-code">                newattributes[attribute]['info'] = str(value)</p>
<p class="source-code">                newattributes[attribute]['type'] = 'NUMERIC'</p>
<p class="source-code">            elif type(value)==str:</p>
<p class="source-code">                newattributes[attribute] = {}</p>
<p class="source-code">                newattributes[attribute]['feature'] = attribute.title().replace('_', ' ')</p>
<p class="source-code">                newattributes[attribute]['info'] = value.title()</p>
<p class="source-code">                newattributes[attribute]['type'] = 'VARCHAR'</p>
<p class="source-code">            elif type(value)==bool:</p>
<p class="source-code">                newattributes[attribute] = {}</p>
<p class="source-code">                newattributes[attribute]['feature'] = attribute.title().replace('_', ' ')</p>
<p class="source-code">                newattributes[attribute]['info'] = value.title()</p>
<p class="source-code">                newattributes[attribute]['type'] = 'BOOLEAN'</p>
<p class="source-code">                </p>
<p class="source-code">            else:</p>
<p class="source-code">                newattributes[attribute] = value                </p>
<p class="source-code">        return type.__new__(classitself, classname, baseclasses, newattributes)</p>
<ol>
<li value="2">The<a id="_idIndexMarker709"/> next class in this example will be <strong class="source-inline">CarCatalogue</strong> with two abstract methods to define the color and print the catalog:<p class="source-code">class CarCatalogue(metaclass = CarSpecs):</p><p class="source-code">    @abstractmethod</p><p class="source-code">    def define_color(self):</p><p class="source-code">        pass</p><p class="source-code">    @abstractmethod</p><p class="source-code">    def print_catalogue(self):</p><p class="source-code">        pass</p></li>
<li>The next class will be the parent class or superclass that captures the specifications of the car:<p class="source-code">class CarMake(metaclass = CarSpecs):   </p><p class="source-code">    @abstractmethod</p><p class="source-code">    def define_spec(self):</p><p class="source-code">        pass     </p></li>
<li>Let’s create another superclass named <strong class="source-inline">BodyStyle</strong>, which will capture the body style and engine features of the car:<p class="source-code">class BodyStyle(metaclass = CarSpecs):</p><p class="source-code">    @abstractmethod</p><p class="source-code">    def body_style_features(self):</p><p class="source-code">        pass   </p></li>
<li>The next class for this case study will be <strong class="source-inline">SaleType</strong>, in which we will add an abstract method to calculate the price of the car:<p class="source-code">class SaleType(metaclass = CarSpecs):</p><p class="source-code">    @abstractmethod</p><p class="source-code">    def calculate_price(self):</p><p class="source-code">        pass</p></li>
<li>This class will be a subclass of <strong class="source-inline">SaleType</strong> for calculating the price of new cars:<p class="source-code">class New(SaleType, CarCatalogue,  metaclass = CarSpecs):</p><p class="source-code">    def calculate_price(self, classname):</p><p class="source-code">        car = classname()</p><p class="source-code">        price = float(car.price['info'])</p><p class="source-code">        return price</p></li>
<li>The<a id="_idIndexMarker710"/> next class will be another subclass of <strong class="source-inline">SaleType</strong> for calculating the price of resale cars:<p class="source-code">class Resale(SaleType, CarCatalogue,  metaclass = CarSpecs):</p><p class="source-code">    def calculate_price(self, classname, years):</p><p class="source-code">        car = classname()</p><p class="source-code">        depreciation = years * 0.15</p><p class="source-code">        price = float(car.price['info']) * (1 - depreciation)</p><p class="source-code">        return price</p></li>
</ol>
<p>These are the main classes for which we will be creating templates that will be used to generate code in the next section.</p>
<h1 id="_idParaDest-186"><a id="_idTextAnchor188"/>Developing a code generator library</h1>
<p>In this section, let’s look <a id="_idIndexMarker711"/>at developing a code generator that will be used to generate code for all the base classes – <strong class="source-inline">CarSpecs</strong>, <strong class="source-inline">CarMake</strong>, <strong class="source-inline">CarCatalogue</strong>, <strong class="source-inline">BodyStyle</strong>, and <strong class="source-inline">SaleType</strong>. The detailed steps are as follows:</p>
<ol>
<li value="1">Let’s create a file named <strong class="source-inline">codegenerator.py</strong> and start by defining a class named <strong class="source-inline">CodeGenerator</strong>:<p class="source-code">class CodeGenerator:</p></li>
<li>Let’s define<a id="_idIndexMarker712"/> a method that imports the <strong class="source-inline">ast</strong> library and adds a <strong class="source-inline">meta_template</strong> attribute that has the string format of the <strong class="source-inline">CarSpecs</strong> class as a value. The <strong class="source-inline">meta_template</strong> attribute is further parsed and unparsed into class code:<p class="source-code">def generate_meta(self):</p><p class="source-code">        ast = __import__('ast')</p><p class="source-code">        meta_template = '''</p><p class="source-code">from abc import ABC, abstractmethod, ABCMeta</p><p class="source-code">class CarSpecs(type, metaclass = ABCMeta):</p><p class="source-code">    def __new__(classitself, classname, baseclasses, attributes):  </p><p class="source-code">        newattributes = {}</p><p class="source-code">        for attribute, value in attributes.items():</p><p class="source-code">            if attribute.startswith("__"):</p><p class="source-code">                newattributes[attribute] = value</p><p class="source-code">            elif type(value)==int or type(value)==float:</p><p class="source-code">                newattributes[attribute] = {}</p><p class="source-code">                newattributes[attribute]['feature'] = attribute.title().replace('_', ' ')</p><p class="source-code">                newattributes[attribute]['info'] = str(value)</p><p class="source-code">                newattributes[attribute]['type'] = 'NUMERIC'</p><p class="source-code">            elif type(value)==str:</p><p class="source-code">                newattributes[attribute] = {}</p><p class="source-code">                newattributes[attribute]['feature'] = attribute.title().replace('_', ' ')</p><p class="source-code">                newattributes[attribute]['info'] = value.title()</p><p class="source-code">                newattributes[attribute]['type'] = 'VARCHAR'</p><p class="source-code">            elif type(value)==bool:</p><p class="source-code">                newattributes[attribute] = {}</p><p class="source-code">                newattributes[attribute]['feature'] = attribute.title().replace('_', ' ')</p><p class="source-code">                newattributes[attribute]['info'] = value.title()</p><p class="source-code">                newattributes[attribute]['type'] = 'BOOLEAN'</p><p class="source-code">            else:</p><p class="source-code">                newattributes[attribute] = value                </p><p class="source-code">        return type.__new__(classitself, classname, baseclasses, newattributes)</p><p class="source-code">'''</p><p class="source-code">        meta_tree = ast.parse(meta_template)</p><p class="source-code">        print(ast.unparse(meta_tree))</p><p class="source-code">        print('\n')</p></li>
<li>Let’s now define another method named <strong class="source-inline">generate_car_catalogue</strong> and add the class <a id="_idIndexMarker713"/>template for <strong class="source-inline">CarCatalogue</strong>:<p class="source-code">def generate_car_catalogue(self):</p><p class="source-code">        ast = __import__('ast')</p><p class="source-code">        catalogue_template = '''</p><p class="source-code">class CarCatalogue(metaclass = CarSpecs):</p><p class="source-code">    @abstractmethod</p><p class="source-code">    def define_color(self):</p><p class="source-code">        pass</p><p class="source-code">    </p><p class="source-code">    @abstractmethod</p><p class="source-code">    def print_catalogue(self):</p><p class="source-code">        pass</p><p class="source-code">        '''</p><p class="source-code">        catalogue_tree = ast.parse(catalogue_template)</p><p class="source-code">        print(ast.unparse(catalogue_tree))</p><p class="source-code">        print('\n')</p></li>
<li>The next step is to define a method named <strong class="source-inline">generate_carmake_code</strong> and add the code template for the <strong class="source-inline">CarMake</strong> class:<p class="source-code">def generate_carmake_code(self):</p><p class="source-code">        ast = __import__('ast')</p><p class="source-code">        carmake_template = '''</p><p class="source-code">class CarMake(metaclass = CarSpecs):   </p><p class="source-code">    @abstractmethod</p><p class="source-code">    def define_spec(self):</p><p class="source-code">        pass     </p><p class="source-code">        '''</p><p class="source-code">        carmake_tree = ast.parse(carmake_template)</p><p class="source-code">        print(ast.unparse(carmake_tree))</p><p class="source-code">        print('\n')</p></li>
<li>In the<a id="_idIndexMarker714"/> next code block, we will define another method named <strong class="source-inline">generate_bodystyle_parent</strong> and add the code template for the <strong class="source-inline">BodyStyle</strong> class:<p class="source-code">def generate_bodystyle_parent(self):</p><p class="source-code">        ast = __import__('ast')</p><p class="source-code">        bodystyle_parent_template = '''</p><p class="source-code">class BodyStyle(metaclass = CarSpecs):</p><p class="source-code">    @abstractmethod</p><p class="source-code">    def body_style_features(self):</p><p class="source-code">        pass  </p><p class="source-code">        '''</p><p class="source-code">        bodystyle_parent_tree = ast.parse(bodystyle_parent_template)</p><p class="source-code">        print(ast.unparse(bodystyle_parent_tree))</p><p class="source-code">        print('\n')</p></li>
<li>Let’s further define the <strong class="source-inline">generate_salestype_code</strong> method, which generates the class code for the <strong class="source-inline">SaleType</strong> class:<p class="source-code">def generate_salestype_code(self):</p><p class="source-code">        ast = __import__('ast')</p><p class="source-code">        saletype_template = '''</p><p class="source-code">class SaleType(metaclass = CarSpecs):</p><p class="source-code">    @abstractmethod</p><p class="source-code">    def calculate_price(self):</p><p class="source-code">        pass</p><p class="source-code">        '''</p><p class="source-code">        salestype_tree = ast.parse(saletype_template)</p><p class="source-code">        print(ast.unparse(salestype_tree))</p><p class="source-code">        print('\n')</p></li>
<li>In this<a id="_idIndexMarker715"/> step, let’s define the <strong class="source-inline">generate_newsale_code</strong> method to generate code for the <strong class="source-inline">New</strong> class:<p class="source-code">def generate_newsale_code(self):</p><p class="source-code">        ast = __import__('ast')</p><p class="source-code">        newsale_template = '''</p><p class="source-code">class New(SaleType, CarCatalogue,  metaclass = CarSpecs):</p><p class="source-code">    def calculate_price(self, classname):</p><p class="source-code">        car = classname()</p><p class="source-code">        price = float(car.price['info'])</p><p class="source-code">        return price</p><p class="source-code">        '''</p><p class="source-code">        newsale_tree = ast.parse(newsale_template)</p><p class="source-code">        print(ast.unparse(newsale_tree))</p><p class="source-code">        print('\n')</p></li>
<li>Let’s further define the <strong class="source-inline">generate_resale_code</strong> method, which generates the code<a id="_idIndexMarker716"/> for the <strong class="source-inline">Resale</strong> class and has the method for calculating the resale price of the car:<p class="source-code">    def generate_resale_code(self):</p><p class="source-code">        ast = __import__('ast')</p><p class="source-code">        resale_template = '''</p><p class="source-code">class Resale(SaleType, CarCatalogue,  metaclass = CarSpecs):</p><p class="source-code">    def calculate_price(self, classname, years):</p><p class="source-code">        car = classname()</p><p class="source-code">        depreciation = years * 0.15</p><p class="source-code">        price = float(car.price['info']) * (1 - depreciation)</p><p class="source-code">        return price</p><p class="source-code">        '''</p><p class="source-code">        resale_tree = ast.parse(resale_template)</p><p class="source-code">        print(ast.unparse(resale_tree))</p><p class="source-code">        print('\n')</p></li>
<li>In this step, we will define a <strong class="source-inline">generate_car_code</strong> method; it inherits the <strong class="source-inline">CarMake</strong> class, defines the color and specifications for individual car brands, and prints the catalog:<p class="source-code">def generate_car_code(self, classname, carspecs):</p><p class="source-code">        self.classname = classname</p><p class="source-code">        self.carspecs = carspecs</p><p class="source-code">        ast = __import__('ast')</p><p class="source-code">        car_template = '''</p><p class="source-code">class '''+self.classname+'''(CarMake, CarCatalogue, metaclass = CarSpecs):</p><p class="source-code">    fuel_type = '''+"'"+self.carspecs['fuel_type']+"'"+'''</p><p class="source-code">    aspiration = '''+"'"+self.carspecs['aspiration']+"'"+'''</p><p class="source-code">    num_of_door = '''+"'"+self.carspecs['num_of_door']+"'"+'''</p><p class="source-code">    drive_wheels = '''+"'"+self.carspecs['drive_wheels']+"'"+'''</p><p class="source-code">    wheel_base = '''+"'"+self.carspecs['wheel_base']+"'"+'''</p><p class="source-code">    length = '''+"'"+self.carspecs['length']+"'"+'''</p><p class="source-code">    width = '''+"'"+self.carspecs['width']+"'"+'''</p><p class="source-code">    height = '''+"'"+self.carspecs['height']+"'"+'''</p><p class="source-code">    curb_weight = '''+"'"+self.carspecs['curb_weight']+"'"+'''</p><p class="source-code">    fuel_system = '''+"'"+self.carspecs['fuel_system']+"'"+'''</p><p class="source-code">    city_mpg = '''+"'"+self.carspecs['city_mpg']+"'"+'''</p><p class="source-code">    highway_mpg = '''+"'"+self.carspecs['highway_mpg']+"'"+'''</p><p class="source-code">    price = '''+"'"+self.carspecs['price']+"'"+'''</p><p class="source-code">    def define_color(self):</p><p class="source-code">            BOLD = '\33[5m'</p><p class="source-code">            BLUE = '\033[94m'</p><p class="source-code">            return BOLD + BLUE</p><p class="source-code">    def define_spec(self):</p><p class="source-code">            specs = [self.fuel_type, self.aspiration, self.num_of_door, self.drive_wheels, </p><p class="source-code">                     self.wheel_base, self.length, self.width, self.height, self.curb_weight,</p><p class="source-code">                    self.fuel_system, self.city_mpg, self.highway_mpg]</p><p class="source-code">            return specs</p><p class="source-code">    def print_catalogue(self):</p><p class="source-code">            for i in self.define_spec():</p><p class="source-code">                print(self.define_color() + i['feature'], ": ", self.define_color() + i['info'])   </p><p class="source-code">                '''</p><p class="source-code">        car_tree = ast.parse(car_template)</p><p class="source-code">        print(ast.unparse(car_tree))</p><p class="source-code">        print('\n')</p></li>
<li>The<a id="_idIndexMarker717"/> last method of this code generator is <strong class="source-inline">generate_bodystyle_code</strong>, which generates class code for different body styles, such as Sedan and Hatchback, defines the color and features for an individual car body style, and prints the catalog:<p class="source-code">def generate_bodystyle_code(self, classname, carfeatures):</p><p class="source-code">        self.classname = classname</p><p class="source-code">        self.carfeatures = carfeatures</p><p class="source-code">        ast = __import__('ast')</p><p class="source-code">        bodystyle_template = '''</p><p class="source-code">class '''+self.classname+'''(BodyStyle, CarCatalogue,  metaclass = CarSpecs):</p><p class="source-code">    engine_location = '''+"'"+self.carfeatures['engine_location']+"'"+'''</p><p class="source-code">    engine_type = '''+"'"+self.carfeatures['engine_type']+"'"+'''</p><p class="source-code">    num_of_cylinders = '''+"'"+self.carfeatures['num_of_cylinders']+"'"+''' </p><p class="source-code">    engine_size = '''+"'"+self.carfeatures['engine_size']+"'"+'''</p><p class="source-code">    bore = '''+"'"+self.carfeatures['bore']+"'"+'''</p><p class="source-code">    stroke = '''+"'"+self.carfeatures['stroke']+"'"+'''</p><p class="source-code">    compression_ratio = '''+"'"+self.carfeatures['compression_ratio']+"'"+'''</p><p class="source-code">    horse_power = '''+"'"+self.carfeatures['horse_power']+"'"+'''</p><p class="source-code">    peak_rpm = '''+"'"+self.carfeatures['peak_rpm']+"'"+'''</p><p class="source-code">    def body_style_features(self):</p><p class="source-code">            features = [self.engine_location, self.engine_type, self.num_of_cylinders, self.engine_size,</p><p class="source-code">                     self.bore, self.stroke, self.compression_ratio, self.horse_power, self.peak_rpm]</p><p class="source-code">            return features  </p><p class="source-code">    def define_color(self):</p><p class="source-code">            BOLD = '\33[5m'</p><p class="source-code">            RED = '\033[31m'</p><p class="source-code">            return BOLD + RED</p><p class="source-code">    def print_catalogue(self):</p><p class="source-code">            for i in self.body_style_features():</p><p class="source-code">                print(self.define_color() + i['feature'], ": ", self.define_color() + i['info'])  </p><p class="source-code">                '''</p><p class="source-code">        bodystyle_tree = ast.parse(bodystyle_template)</p><p class="source-code">        print(ast.unparse(bodystyle_tree))</p><p class="source-code">        print('\n')</p></li>
</ol>
<p>With <a id="_idIndexMarker718"/>these methods, we are all set to generate the code required for the ABC Car Agency’s catalog.</p>
<p>Now, let’s proceed further to develop a code generation framework that generates the hundreds of classes required for our application.</p>
<h1 id="_idParaDest-187"><a id="_idTextAnchor189"/>Generating code </h1>
<p>In this section, we are<a id="_idIndexMarker719"/> going to make use of <strong class="source-inline">codegenerator.py</strong> to generate the base classes and its corresponding subclasses, which maintain and print various catalogs for the ABC Car Agency, as follows:</p>
<ol>
<li value="1">To begin with, let’s start using the automobile data to generate the base classes required for this application. For the base data preparation, let’s import the <strong class="source-inline">pandas</strong> library, which helps with processing data:<p class="source-code">import pandas as pd</p></li>
<li>Let’s load the data and make a copy of it. For this application, we need a unique set of car brands and another unique set of car body styles:<p class="source-code">auto = pd.read_csv("automobile.csv")</p><p class="source-code">auto_truncated = auto.copy(deep=True)</p><p class="source-code">auto_truncated.drop_duplicates(subset = ['make','body-style'], inplace = True)</p><p class="source-code">auto_truncated.reset_index(inplace = True, drop = True)</p><p class="source-code">auto_truncated['make'] = auto_truncated['make'].apply(lambda x: x.title().replace('-',''))</p><p class="source-code">auto_truncated.reset_index(inplace = True)</p><p class="source-code">auto_truncated['index'] = auto_truncated['index'].astype('str')</p><p class="source-code">auto_truncated['make'] = auto_truncated['make'] + auto_truncated['index']</p><p class="source-code">auto_truncated['body-style'] = auto_truncated['body-style'].apply(lambda x: x.title().replace('-',''))</p><p class="source-code">auto_truncated['body-style'] = auto_truncated['body-style'] + auto_truncated['index']</p></li>
</ol>
<p>Once <a id="_idIndexMarker720"/>the basic data has been processed, let’s create two DataFrames that will be used to generate multiple classes using the code generator:</p>
<p class="source-code">auto_specs = auto_truncated[['make', 'fuel-type', 'aspiration', 'num-of-doors', 'drive-wheels', 'wheel-base',  'length', 'width', 'height', 'curb-weight', 'fuel-system', 'city-mpg',  'highway-mpg', 'price']].copy(deep = True)</p>
<p class="source-code">auto_specs.columns = ['classname', 'fuel_type', 'aspiration', 'num_of_door', 'drive_wheels',                      'wheel_base', 'length', 'width', 'height', 'curb_weight', 'fuel_system', 'city_mpg', 'highway_mpg', 'price' ]</p>
<p class="source-code">for col in auto_specs.columns:</p>
<p class="source-code">    auto_specs[col] = auto_specs[col].astype('str')</p>
<p class="source-code">auto_features = auto_truncated[['body-style', 'engine-location', 'engine-type', 'num-of-cylinders', 'engine-size', 'bore', 'stroke', 'compression-ratio', 'horsepower', 'peak-rpm']].copy(deep = True)</p>
<p class="source-code">auto_features.columns = ['classname', 'engine_location', 'engine_type', 'num_of_cylinders', 'engine_size', 'bore', 'stroke', 'compression_ratio', 'horse_power', 'peak_rpm']</p>
<p class="source-code">for col in auto_features.columns:</p>
<p class="source-code">    auto_features[col] = auto_features[col].astype('str')</p>
<ol>
<li value="3">After <a id="_idIndexMarker721"/>processing the data into the format that we need to provide as input to the code generator, the sample data for specifications will be as follows:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer146">
<img alt="Figure 15.4 – Sample specifications  " height="197" src="image/Figure_15.4_B13426.jpg" width="942"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.4 – Sample specifications </p>
<ol>
<li value="4">The sample data for features will be as follows:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer147">
<img alt="Figure 15.5 – Sample features " height="192" src="image/Figure_15.5_B13426.jpg" width="970"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.5 – Sample features</p>
<ol>
<li value="5">Now that the base data required to generate code is ready, we can start importing the code generator:<p class="source-code">from codegenerator import CodeGenerator</p><p class="source-code">codegen = CodeGenerator()</p></li>
<li>In this step, let’s now define a function that generates the library by calling the code to <a id="_idIndexMarker722"/>generate each base class in a pipeline followed by generating multiple subclasses for <strong class="source-inline">CarMake</strong> and <strong class="source-inline">BodyStyle</strong>:<p class="source-code">def generatelib():</p><p class="source-code">    codegen.generate_meta()</p><p class="source-code">    codegen.generate_car_catalogue()</p><p class="source-code">    codegen.generate_carmake_code()</p><p class="source-code">    codegen.generate_bodystyle_parent()</p><p class="source-code">    codegen.generate_salestype_code()</p><p class="source-code">    codegen.generate_newsale_code()</p><p class="source-code">    codegen.generate_resale_code()</p><p class="source-code">    for index, row in auto_specs.iterrows():</p><p class="source-code">        carspecs = dict(row)</p><p class="source-code">        classname = carspecs['classname']</p><p class="source-code">        del carspecs['classname']</p><p class="source-code">        codegen.generate_car_code(classname = classname, carspecs = carspecs)</p><p class="source-code">    for index, row in auto_features.iterrows():</p><p class="source-code">        carfeatures = dict(row)</p><p class="source-code">        classname = carfeatures['classname']</p><p class="source-code">        del carfeatures['classname']</p><p class="source-code">        codegen.generate_bodystyle_code(classname = classname, carfeatures = carfeatures)</p></li>
<li>Open a Python file named <strong class="source-inline">abccaragencylib.py</strong> and call a <strong class="source-inline">generatelib</strong> function to write the code generated for all the required classes:<p class="source-code">from contextlib import redirect_stdout</p><p class="source-code">with open('abccaragencylib.py', 'w') as code:</p><p class="source-code">    with redirect_stdout(code):</p><p class="source-code">        generatelib()</p><p class="source-code">code.close()</p></li>
<li>An <a id="_idIndexMarker723"/>example class autogenerated and written into <strong class="source-inline">abccaragencylib.py</strong> is represented in the following screenshot:</li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer148">
<img alt="Figure 15.6 – An autogenerated class code for a car brand " height="494" src="image/Figure_15.6_B13426.jpg" width="1031"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.6 – An autogenerated class code for a car brand</p>
<p>We have not autogenerated the code required for this example. We will now look at designing an execution framework.</p>
<h1 id="_idParaDest-188"><a id="_idTextAnchor190"/>Designing an execution framework</h1>
<p>In this section, let’s look at the last process of designing the ABC Car Agency application where we <a id="_idIndexMarker724"/>will actually run the code generated throughout this case study:</p>
<ol>
<li value="1">Let’s start by loading the autogenerated library:<p class="source-code">import abccaragencylib as carsales</p></li>
<li>At this stage, we will follow a sequence of steps by implementing a façade design pattern so that we can print the specifications and features for different types of cars:<p class="source-code">class Queue:</p><p class="source-code">    def __init__(self, makeclass, styleclass, age):</p><p class="source-code">        self.makeclass = makeclass</p><p class="source-code">        self.styleclass = styleclass</p><p class="source-code">        self.make = self.makeclass()</p><p class="source-code">        self.style = self.styleclass()</p><p class="source-code">        self.new = carsales.New()</p><p class="source-code">        self.resale = carsales.Resale()</p><p class="source-code">        self.age = age</p><p class="source-code">    def pipeline(self):</p><p class="source-code">        print('*********ABC Car Agency - Catalogue***********')</p><p class="source-code">        self.make.print_catalogue()</p><p class="source-code">        print('\n')</p><p class="source-code">        self.style.print_catalogue()</p><p class="source-code">        print('\n')</p><p class="source-code">        print('New Car Price : ' + str(self.new.calculate_price(self.makeclass)))</p><p class="source-code">        print('Resale Price : ' + str(self.resale.calculate_price(self.makeclass, self.age)))</p></li>
<li>Let’s define a method to run the façade pattern:<p class="source-code">def run_facade(makeclass, styleclass, age):</p><p class="source-code">    queue = Queue(makeclass, styleclass, age)</p><p class="source-code">    queue.pipeline()</p></li>
<li>In this <a id="_idIndexMarker725"/>step, we will run one combination of a car brand with a car body style to generate a catalog:<p class="source-code">run_facade(carsales.AlfaRomero1, carsales.Hatchback28, 3)</p></li>
</ol>
<p>The output is as follows:</p>
<p class="source-code"><strong class="bold">*********ABC Car Agency - Catalogue***********</strong></p>
<p class="source-code"><strong class="bold">Fuel Type :  Gas</strong></p>
<p class="source-code"><strong class="bold">Aspiration :  Std</strong></p>
<p class="source-code"><strong class="bold">Num Of Door :  Two</strong></p>
<p class="source-code"><strong class="bold">Drive Wheels :  Rwd</strong></p>
<p class="source-code"><strong class="bold">Wheel Base :  94.5</strong></p>
<p class="source-code"><strong class="bold">Length :  171.2</strong></p>
<p class="source-code"><strong class="bold">Width :  65.5</strong></p>
<p class="source-code"><strong class="bold">Height :  52.4</strong></p>
<p class="source-code"><strong class="bold">Curb Weight :  2823</strong></p>
<p class="source-code"><strong class="bold">Fuel System :  Mpfi</strong></p>
<p class="source-code"><strong class="bold">City Mpg :  19</strong></p>
<p class="source-code"><strong class="bold">Highway Mpg :  26</strong></p>
<p class="source-code"><strong class="bold">Engine Location :  Front</strong></p>
<p class="source-code"><strong class="bold">Engine Type :  Ohc</strong></p>
<p class="source-code"><strong class="bold">Num Of Cylinders :  Four</strong></p>
<p class="source-code"><strong class="bold">Engine Size :  97</strong></p>
<p class="source-code"><strong class="bold">Bore :  3.15</strong></p>
<p class="source-code"><strong class="bold">Stroke :  3.29</strong></p>
<p class="source-code"><strong class="bold">Compression Ratio :  9.4</strong></p>
<p class="source-code"><strong class="bold">Horse Power :  69</strong></p>
<p class="source-code"><strong class="bold">Peak Rpm :  5200</strong></p>
<p class="source-code"><strong class="bold">New Car Price : 16500.0</strong></p>
<p class="source-code"><strong class="bold">Resale Price : 9075.0</strong></p>
<p>There are 56 unique subclasses generated for <strong class="source-inline">CarMake</strong> and 56 unique subclasses generated for <strong class="source-inline">BodyStyle</strong>. We can use various combinations of <strong class="source-inline">CarMake</strong> and <strong class="source-inline">BodyStyle</strong> to print catalogs for this application.</p>
<ol>
<li value="5">Let’s try <a id="_idIndexMarker726"/>another combination:<p class="source-code">run_facade(carsales.Mitsubishi24, carsales.Sedan16, 5)</p></li>
</ol>
<p>The output generated is as follows:</p>
<p class="source-code"><strong class="bold">*********ABC Car Agency - Catalogue***********</strong></p>
<p class="source-code"><strong class="bold">Fuel Type :  Gas</strong></p>
<p class="source-code"><strong class="bold">Aspiration :  Std</strong></p>
<p class="source-code"><strong class="bold">Num Of Door :  Two</strong></p>
<p class="source-code"><strong class="bold">Drive Wheels :  Fwd</strong></p>
<p class="source-code"><strong class="bold">Wheel Base :  93.7</strong></p>
<p class="source-code"><strong class="bold">Length :  157.3</strong></p>
<p class="source-code"><strong class="bold">Width :  64.4</strong></p>
<p class="source-code"><strong class="bold">Height :  50.8</strong></p>
<p class="source-code"><strong class="bold">Curb Weight :  1918</strong></p>
<p class="source-code"><strong class="bold">Fuel System :  2Bbl</strong></p>
<p class="source-code"><strong class="bold">City Mpg :  37</strong></p>
<p class="source-code"><strong class="bold">Highway Mpg :  41</strong></p>
<p class="source-code"><strong class="bold">Engine Location :  Front</strong></p>
<p class="source-code"><strong class="bold">Engine Type :  Dohc</strong></p>
<p class="source-code"><strong class="bold">Num Of Cylinders :  Six</strong></p>
<p class="source-code"><strong class="bold">Engine Size :  258</strong></p>
<p class="source-code"><strong class="bold">Bore :  3.63</strong></p>
<p class="source-code"><strong class="bold">Stroke :  4.17</strong></p>
<p class="source-code"><strong class="bold">Compression Ratio :  8.1</strong></p>
<p class="source-code"><strong class="bold">Horse Power :  176</strong></p>
<p class="source-code"><strong class="bold">Peak Rpm :  4750</strong></p>
<p class="source-code"><strong class="bold">New Car Price : 5389.0</strong></p>
<p class="source-code"><strong class="bold">Resale Price : 1347.25</strong></p>
<p>This is the <a id="_idIndexMarker727"/>step-by-step process of developing an application by applying metaprogramming methodologies in Python.</p>
<h1 id="_idParaDest-189"><a id="_idTextAnchor191"/>Summary</h1>
<p>In this chapter, we have learned how to develop an application by applying various techniques of metaprogramming. We started by explaining the case study, and we defined the base classes required for this case study.</p>
<p>We also learned how to develop a code generator and how to generate code using it. We also designed a framework that could be used to execute or test the code generated for the application in this case study.</p>
<p>In the next chapter, we will be looking at some of the best practices that can be followed while designing an application with Python and metaprogramming.</p>
</div>
</div></body></html>