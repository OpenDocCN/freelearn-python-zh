<html><head></head><body>
		<div id="_idContainer022">
			<h1 id="_idParaDest-157" class="chapter-number"><a id="_idTextAnchor163"/>6</h1>
			<h1 id="_idParaDest-158"><a id="_idTextAnchor164"/>Architectural Design Patterns</h1>
			<p>In the previous chapter, we covered <strong class="bold">behavioral patterns</strong>, patterns that help with object interconnection and algorithms. The next category of design patterns is <strong class="bold">architectural design patterns</strong>. These<a id="_idIndexMarker595"/> patterns provide a template for solving common architectural problems, facilitating the development of scalable, maintainable, and <span class="No-Break">reusable systems.</span></p>
			<p>In this chapter, we’re going to cover the following <span class="No-Break">main topics:</span></p>
			<ul>
				<li>The <strong class="bold">Model-View-Controller</strong> (<span class="No-Break"><strong class="bold">MVC</strong></span><span class="No-Break">) pattern</span></li>
				<li>The <span class="No-Break"><strong class="bold">Microservices</strong></span><span class="No-Break"> pattern</span></li>
				<li>The <span class="No-Break"><strong class="bold">Serverless</strong></span><span class="No-Break"> pattern</span></li>
				<li>The <strong class="bold">Event </strong><span class="No-Break"><strong class="bold">Sourcing</strong></span><span class="No-Break"> pattern</span></li>
				<li>Other architectural <span class="No-Break">design patterns</span></li>
			</ul>
			<p>At the end of this chapter, you will understand how to build robust and flexible software using popular architectural <span class="No-Break">design patterns.</span></p>
			<h1 id="_idParaDest-159"><a id="_idTextAnchor165"/>Technical requirements</h1>
			<p>See the requirements presented in <a href="B21896_01.xhtml#_idTextAnchor017"><span class="No-Break"><em class="italic">Chapter 1</em></span></a>. The additional technical requirements for the code discussed in this chapter are <span class="No-Break">the following:</span></p>
			<ul>
				<li>For the <em class="italic">Microservices pattern</em> section, install <span class="No-Break">the following:</span><ul><li><strong class="bold">gRPC</strong>, using the<a id="_idIndexMarker596"/> following command: <strong class="source-inline">python -m pip </strong><span class="No-Break"><strong class="source-inline">install grpcio</strong></span></li><li><strong class="bold">gRPC-tools</strong>, using the<a id="_idIndexMarker597"/> following command: <strong class="source-inline">python -m pip </strong><span class="No-Break"><strong class="source-inline">install grpcio-tools</strong></span></li><li><strong class="bold">Lanarky</strong> and its <a id="_idIndexMarker598"/>dependencies, using the following command: <strong class="source-inline">python -m pip install "lanarky[openai]"==0.8.6 uvicorn==0.29.0</strong> (Note that this is not compatible with Python 3.12, at the time of writing. In this case, you may reproduce the related example using Python <span class="No-Break">3.11 instead.)</span></li></ul></li>
				<li>For the <em class="italic">Serverless pattern</em> section, install <a id="_idIndexMarker599"/><span class="No-Break">the following:</span><ul><li><span class="No-Break"><strong class="bold">Docker</strong></span></li><li><strong class="bold">LocalStack</strong>, for <a id="_idIndexMarker600"/>testing AWS Lambda locally, using the following command: <strong class="source-inline">python –m pip install localstack</strong> (Note that this is not compatible with Python 3.12, at the time of writing. You may use Python 3.11 instead for <span class="No-Break">this case.)</span></li><li><strong class="bold">awscli-local</strong>, using <a id="_idIndexMarker601"/>the command: <strong class="source-inline">python -m pip </strong><span class="No-Break"><strong class="source-inline">install awscli-local</strong></span></li><li><strong class="source-inline">awscli</strong>, using the command: <strong class="source-inline">python -m pip </strong><span class="No-Break"><strong class="source-inline">install awscli</strong></span></li></ul></li>
				<li>For the <em class="italic">Event Sourcing</em> section, install <span class="No-Break">the following:</span><ul><li><strong class="source-inline">eventsourcing</strong>, using the command: <strong class="source-inline">python –m pip </strong><span class="No-Break"><strong class="source-inline">install eventsourcing</strong></span></li></ul></li>
			</ul>
			<h1 id="_idParaDest-160"><a id="_idTextAnchor166"/>The MVC pattern</h1>
			<p>The <a id="_idIndexMarker602"/>MVC pattern is another application of <a id="_idIndexMarker603"/>the <strong class="bold">loose coupling</strong> principle. The name of the pattern comes from the three main <a id="_idIndexMarker604"/>components used to split a software application: the model, the view, and <span class="No-Break">the controller.</span></p>
			<p>Even if we will never have to implement it from scratch, we need to be familiar with it because all common frameworks use MVC or a slightly different version of it (more on <span class="No-Break">this later).</span></p>
			<p>The model is the core component. It represents knowledge. It contains and manages the (business) logic, data, state, and rules of an application. The view is a visual representation of the model. Examples of views are a computer GUI, the text output of a computer terminal, a smartphone’s application GUI, a PDF document, a pie chart, a bar chart, and so forth. The view only displays the data; it doesn’t handle it. The controller is the link/glue between the model and the view. All communication between the model and the view happens through <span class="No-Break">a controller.</span></p>
			<p>A typical use of an <a id="_idIndexMarker605"/>application that uses MVC, after the initial screen is rendered to the user, is <span class="No-Break">as follows:</span></p>
			<ol>
				<li>The user triggers a view by clicking (typing, touching, and so on) <span class="No-Break">a button.</span></li>
				<li>The view informs the controller of the <span class="No-Break">user’s action.</span></li>
				<li>The controller processes user input and interacts with <span class="No-Break">the model.</span></li>
				<li>The model performs all the necessary validation and state changes and informs the controller about what should <span class="No-Break">be done.</span></li>
				<li>The controller <a id="_idIndexMarker606"/>instructs the view to update and display the output appropriately, following the <span class="No-Break">model’s instructions.</span></li>
			</ol>
			<div>
				<div id="_idContainer019" class="IMG---Figure">
					<img src="image/B21896_06_01.jpg" alt="Figure 6.1 – The MVC pattern"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.1 – The MVC pattern</p>
			<p>But is the controller part necessary? Can’t we just skip it? We could, but then we would lose a big benefit that MVC provides: the ability to use more than one view (even at the same time, if that’s what we want) without modifying the model. To achieve decoupling between the model and its representation, every view typically needs its own controller. If the model <a id="_idIndexMarker607"/>communicated directly with a specific view, we wouldn’t be able to use multiple <a id="_idIndexMarker608"/>views (or, at least, not in a clean and <span class="No-Break">modular way).</span></p>
			<h2 id="_idParaDest-161"><a id="_idTextAnchor167"/>Real-world examples</h2>
			<p>MVC is an <a id="_idIndexMarker609"/>application of the <strong class="bold">separation of concern</strong> principle. Separation of concern is used a lot in real life. For<a id="_idIndexMarker610"/> example, if you build a new house, you usually assign different professionals to 1) install the plumbing and electricity; and, 2) paint <span class="No-Break">the house.</span></p>
			<p>Another example is a restaurant. In a restaurant, the waiters receive orders and serve dishes to the customers, but the meals are cooked by <span class="No-Break">the chefs.</span></p>
			<p>In web development, several frameworks use the MVC idea, <span class="No-Break">for example:</span></p>
			<ul>
				<li>The <strong class="bold">Web2py framework</strong> is a <a id="_idIndexMarker611"/>lightweight Python framework that embraces the MVC pattern. There are many examples that demonstrate how MVC can be used in Web2py on the project’s site (<a href="http://web2py.com/">http://web2py.com/</a>) and in<a id="_idIndexMarker612"/> the <span class="No-Break">GitHub repository.</span></li>
				<li><strong class="bold">Django</strong> (<a href="https://www.djangoproject.com/">https://www.djangoproject.com/</a>) is also an MVC framework, although it<a id="_idIndexMarker613"/> uses different<a id="_idIndexMarker614"/> naming conventions. The controller is called <em class="italic">view</em>, and the view is called <em class="italic">template</em>. Django uses the name <strong class="bold">Model-View Template</strong> (<strong class="bold">MVT</strong>). According to the designers of Django, the view describes <a id="_idIndexMarker615"/>what<a id="_idIndexMarker616"/> data is seen by the user, and therefore, it uses the name view as the Python callback function for a particular URL. The term “template” in Django is used to separate content from representation. It describes how the data is seen by the user, not which data <span class="No-Break">is seen.</span></li>
			</ul>
			<h2 id="_idParaDest-162"><a id="_idTextAnchor168"/>Use cases for the MVC pattern</h2>
			<p>MVC is a <a id="_idIndexMarker617"/>very<a id="_idIndexMarker618"/> generic and useful design pattern. In fact, all popular web frameworks (Django, Rails, Symfony, and Yii) and application<a id="_idIndexMarker619"/> frameworks (iPhone SDK, Android, and QT) make use of MVC or a <a id="_idIndexMarker620"/>variation of it (<strong class="bold">model-view-adapter</strong> (<strong class="bold">MVA</strong>), <strong class="bold">model-view-presenter</strong> (<strong class="bold">MVP</strong>), or <strong class="bold">MVT</strong>, for example). However, even if we don’t use any of these frameworks, it makes sense to implement the pattern on our own because of the benefits it provides, which are <span class="No-Break">as follows:</span></p>
			<ul>
				<li>The separation between the view and model allows graphics designers to focus on the <strong class="bold">user interface</strong> (<strong class="bold">UI</strong>) part and programmers to focus on development, without interfering with <span class="No-Break">each other.</span></li>
				<li>Because of the loose coupling between the view and model, each part can be modified/extended without affecting the other. For example, adding a new view is trivial. Just implement a new controller <span class="No-Break">for it.</span></li>
				<li>Maintaining each part is easier because the responsibilities <span class="No-Break">are clear.</span></li>
			</ul>
			<p>When implementing MVC from scratch, be sure that you create smart models, thin controllers, and <span class="No-Break">dumb views.</span></p>
			<p>A model is considered smart because it does <span class="No-Break">the following:</span></p>
			<ul>
				<li>It contains all the <span class="No-Break">validation/business rules/logic</span></li>
				<li>It handles the state of <span class="No-Break">the application</span></li>
				<li>It has access to application data (database, cloud, and <span class="No-Break">so on)</span></li>
				<li>It does not depend on <span class="No-Break">the UI</span></li>
			</ul>
			<p>A controller is considered thin because it does <span class="No-Break">the following:</span></p>
			<ul>
				<li>It updates the model when the user interacts with <span class="No-Break">the view</span></li>
				<li>It updates the view when the <span class="No-Break">model changes</span></li>
				<li>It processes the data before delivering it to the model/view, <span class="No-Break">if necessary</span></li>
				<li>It does not display <span class="No-Break">the data</span></li>
				<li>It does not access the application <span class="No-Break">data directly</span></li>
				<li>It does not contain <span class="No-Break">validation/business rules/logic</span></li>
			</ul>
			<p>A view is considered dumb because it does <span class="No-Break">the following:</span></p>
			<ul>
				<li>It displays <span class="No-Break">the data</span></li>
				<li>It allows the user to interact <span class="No-Break">with it</span></li>
				<li>It does only minimal processing, usually provided by a template language (for example, using simple variables and <span class="No-Break">loop controls)</span></li>
				<li>It does not store <span class="No-Break">any data</span></li>
				<li>It does not access the application <span class="No-Break">data directly</span></li>
				<li>It does not contain <span class="No-Break">validation/business rules/logic</span></li>
			</ul>
			<p>If you are implementing MVC from scratch and want to find out whether you did it right, you can try answering some <span class="No-Break">key questions:</span></p>
			<ul>
				<li>If your<a id="_idIndexMarker621"/> application <a id="_idIndexMarker622"/>has a GUI, is it skinnable? How easily can you change the skin/look and feel of it? Can you give the user the ability to change the skin of your application during runtime? If this is not simple, it means that something is going wrong with your <span class="No-Break">MVC implementation.</span></li>
				<li>If your application has no GUI (for instance, if it’s a terminal application), how hard is it to add GUI support? Or, if adding a GUI is irrelevant, is it easy to add views to display the results in a chart (pie chart, bar chart, and so on) or a document (PDF, spreadsheet, and so on)? If these changes are not trivial (a matter of creating a new controller with a view attached to it, without modifying the model), MVC is not <span class="No-Break">implemented properly.</span></li>
				<li>If you make<a id="_idIndexMarker623"/> sure that these conditions are satisfied, your application will be more flexible and maintainable compared to an application that does not <span class="No-Break">use MVC.</span></li>
			</ul>
			<h2 id="_idParaDest-163"><a id="_idTextAnchor169"/>Implementing the MVC pattern</h2>
			<p>I could use any of the<a id="_idIndexMarker624"/> common frameworks to demonstrate how to use MVC, but I feel that the picture will be incomplete. So, I decided to show you how to implement MVC from scratch, using a very simple example: a quote printer. The idea is extremely simple. The user enters a number and sees the quote related to that number. The quotes are stored in a <strong class="source-inline">quotes</strong> tuple. This is the data that normally exists in a database, file, and so on, and only the model has direct access <span class="No-Break">to it.</span></p>
			<p>Let’s consider this <a id="_idIndexMarker625"/>example for the <span class="No-Break"><strong class="source-inline">quotes</strong></span><span class="No-Break"> tuple:</span></p>
			<pre class="source-code">
quotes = (
    "A man is not complete until he is married. Then he is finished.",
    "As I said before, I never repeat myself.",
    "Behind a successful man is an exhausted woman.",
    "Black holes really suck...",
    "Facts are stubborn things.",
)</pre>			<p>The model is minimalistic; it only has a <strong class="source-inline">get_quote()</strong> method that returns the quote (string) of the <strong class="source-inline">quotes</strong> tuple based on its index, <strong class="source-inline">n</strong>. The model class is <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
class QuoteModel:
    def get_quote(self, n):
        try:
            value = quotes[n]
        except IndexError as err:
            value = "Not found!"
        return value</pre>			<p>The view has three methods: <strong class="source-inline">show()</strong>, which is used to print a quote (or the <strong class="source-inline">Not found!</strong> message) on the screen; <strong class="source-inline">error()</strong>, which is used to print an error message on the screen; and <strong class="source-inline">select_quote()</strong>, which reads the <a id="_idIndexMarker626"/>user’s selection. This can be seen in the <span class="No-Break">following </span><span class="No-Break"><a id="_idIndexMarker627"/></span><span class="No-Break">code:</span></p>
			<pre class="source-code">
class QuoteTerminalView:
    def show(self, quote):
        print(f'And the quote is: "{quote}"')
    def error(self, msg):
        print(f"Error: {msg}")
    def select_quote(self):
        return input("Which quote number would you like to see? ")</pre>			<p>The controller does the coordination. The <strong class="source-inline">__init__()</strong> method initializes the model and view. The <strong class="source-inline">run()</strong> method validates the quoted index given by the user, gets the quote from the model, and passes it back to the view to be displayed, as shown in the <span class="No-Break">following code:</span></p>
			<pre class="source-code">
class QuoteTerminalController:
    def __init__(self):
        self.model = QuoteModel()
        self.view = QuoteTerminalView()
    def run(self):
        valid_input = False
        while not valid_input:
            try:
                n = self.view.select_quote()
                n = int(n)
                valid_input = True
            except ValueError as err:
                self.view.error(f"Incorrect index '{n}'")
        quote = self.model.get_quote(n)
        self.view.show(quote)</pre>			<p>Finally, the <strong class="source-inline">main()</strong> function initializes and fires the controller, as shown in the <span class="No-Break">following code:</span></p>
			<pre class="source-code">
def main():
    controller = QuoteTerminalController()
    while True:
        controller.run()</pre>			<p>Here is a recap of our <a id="_idIndexMarker628"/>example (the full <a id="_idIndexMarker629"/>code is in <span class="No-Break"><strong class="source-inline">ch06/mvc.py</strong></span><span class="No-Break"> file):</span></p>
			<ol>
				<li>We start by defining a variable for the list <span class="No-Break">of quotes.</span></li>
				<li>We define the model <span class="No-Break">class, </span><span class="No-Break"><strong class="source-inline">QuoteModel</strong></span><span class="No-Break">.</span></li>
				<li>We define the view <span class="No-Break">class, </span><span class="No-Break"><strong class="source-inline">QuoteTerminalView</strong></span><span class="No-Break">.</span></li>
				<li>We define the controller <span class="No-Break">class, </span><span class="No-Break"><strong class="source-inline">QuoteTermin<a id="_idTextAnchor170"/>alController</strong></span><span class="No-Break">.</span></li>
				<li>Finally, we add the <strong class="source-inline">main()</strong> function to test the different classes, followed by the usual trick to <span class="No-Break">call it.</span></li>
			</ol>
			<p>A sample <a id="_idIndexMarker630"/>execution of the <strong class="source-inline">python ch06/mvc.py</strong> command shows how the program prints quotes to <span class="No-Break">the </span><span class="No-Break"><a id="_idIndexMarker631"/></span><span class="No-Break">user:</span></p>
			<pre class="source-code">
<strong class="bold">Which quote number would you like to see? 3</strong>
<strong class="bold">And the quote is: "Black holes really suck..."</strong>
<strong class="bold">Which quote number would you like to see? 2</strong>
<strong class="bold">And the quote is: "Behind a successful man is an exhausted woman."</strong>
<strong class="bold">Which quote number would you like to see? 6</strong>
<strong class="bold">And the quote is: "Not found!"</strong>
<strong class="bold">Which quote number would you like to see? 4</strong>
<strong class="bold">And the quote is: "Facts are stubborn things."</strong>
<strong class="bold">Which quote number would you like to see? 3</strong>
<strong class="bold">And the quote is: "Black holes really suck..."</strong>
<strong class="bold">Which quote number would you like to see? 1</strong>
<strong class="bold">And the quote is: "As I said before, I never repeat myself."</strong></pre>			<h1 id="_idParaDest-164"><a id="_idTextAnchor171"/>The Microservices pattern</h1>
			<p>Traditionally, developers working on <a id="_idIndexMarker632"/>building a server-side application have been using a <a id="_idIndexMarker633"/>single code base and implementing all or most functionalities right there, using common development practices such as functions and classes, and design patterns such as the ones we have covered in this book <span class="No-Break">so far.</span></p>
			<p>However, with the evolution of the IT industry, economic factors, and pressure for fast times to market and returns on investment, there is a constant need to improve the practices of engineering teams and ensure more reactivity and scalability with servers, service delivery, and operations. We need to learn about other useful patterns, not only object-oriented <span class="No-Break">programming ones.</span></p>
			<div>
				<div id="_idContainer020" class="IMG---Figure">
					<img src="image/B21896_06_02.jpg" alt="Figure 6.2 – The Microservices pattern"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.2 – The Microservices pattern</p>
			<p>One of the main additions to the catalog of patterns for engineers in recent years has been the <strong class="bold">Microservice Architecture</strong> pattern or <strong class="bold">Microservices</strong>. The idea is that we can build an <a id="_idIndexMarker634"/>application as a set of loosely coupled, collaborating services. In this architectural style, an application might consist of services such as the order management service, the customer management service, and so on. These services are loosely <a id="_idIndexMarker635"/>coupled, independently deployable, and communicate via <span class="No-Break">well-defined APIs.</span></p>
			<h2 id="_idParaDest-165"><a id="_idTextAnchor172"/>Real-world examples</h2>
			<p>We can cite several<a id="_idIndexMarker636"/> examples, such as <span class="No-Break">the following:</span></p>
			<ul>
				<li><strong class="bold">Netflix</strong>: One of the pioneers in adopting microservices to handle millions of content <span class="No-Break">streams simultaneously</span></li>
				<li><strong class="bold">Uber</strong>: The company uses microservices to handle different aspects such as billing, notifications, and <span class="No-Break">ride tracking</span></li>
				<li><strong class="bold">Amazon</strong>: They transitioned from a monolithic architecture to microservices to support their <span class="No-Break">ever-growing scale</span></li>
			</ul>
			<h2 id="_idParaDest-166"><a id="_idTextAnchor173"/>Use cases for the Microservices pattern</h2>
			<p>We can<a id="_idIndexMarker637"/> think of several use cases<a id="_idIndexMarker638"/> where Microservices offer a clever answer. We can use a Microservices architecture-based design every time we are building an application that has at least one of the <span class="No-Break">following characteristics:</span></p>
			<ul>
				<li>There is a requirement to support different clients, including desktop <span class="No-Break">and mobile</span></li>
				<li>There is an API for third parties <span class="No-Break">to consume</span></li>
				<li>We must communicate with other applications <span class="No-Break">using messaging</span></li>
				<li>We serve requests by accessing a database, communicating with other systems, and returning the right type of response (JSON, XML, HTML, or <span class="No-Break">even PDF)</span></li>
				<li>There are logical components corresponding to different functional areas of <span class="No-Break">the application</span></li>
			</ul>
			<h2 id="_idParaDest-167"><a id="_idTextAnchor174"/>Implementing the microservices pattern – a payment service using gRPC</h2>
			<p>Let’s briefly talk about<a id="_idIndexMarker639"/> software installation and application deployment in<a id="_idIndexMarker640"/> the Microservices world. Switching from deploying a single application to deploying many small services means that the number of things that need to be handled increases exponentially. While you might have been fine with a single application server and a few runtime dependencies, when moving to Microservices, the number of dependencies will increase drastically. For example, one service could benefit from the relational database while the other would <a id="_idIndexMarker641"/>need <strong class="bold">ElasticSearch</strong>. You may need a service that uses <strong class="bold">MySQL</strong> and <a id="_idIndexMarker642"/>another one that uses <a id="_idIndexMarker643"/>the <strong class="bold">Redis</strong> server. So, using the Microservices approach also means you will need to <a id="_idIndexMarker644"/><span class="No-Break">use </span><span class="No-Break"><strong class="bold">containers</strong></span><span class="No-Break">.</span></p>
			<p>Thanks to Docker, things have become easier, since we can run those services as containers. The idea is that your application server, dependencies and runtime libraries, compiled code, configurations, and so on, are inside those containers. Then, all you must do is run services packed as containers and make sure that they can communicate with <span class="No-Break">each other.</span></p>
			<p>You can<a id="_idIndexMarker645"/> implement the Microservices pattern, for a<a id="_idIndexMarker646"/> web app or an API, by directly using Django, Flask, or FastAPI. However, to quickly show a working example, we are going to use gRPC, a high-performance universal RPC framework that uses <strong class="bold">Protocol Buffers</strong> (<strong class="bold">protobuf</strong>) as its<a id="_idIndexMarker647"/> interface description language, making it an ideal candidate for microservices communication due to its efficiency and <span class="No-Break">cross-language support.</span></p>
			<p>Imagine a scenario where your application architecture includes a microservice dedicated to handling payment<a id="_idIndexMarker648"/> processing. This microservice (let’s call it <strong class="source-inline">PaymentService</strong>), is responsible for processing payments and interacts with other services such as <strong class="source-inline">OrderService</strong> and <strong class="source-inline">AccountService</strong>. We are going to focus on the implementation of such a service <span class="No-Break">using gRPC.</span></p>
			<p>First, we define the service and its methods using protobuf, in the <strong class="source-inline">ch06/microservices/grpc/payment.proto</strong> file. This includes specifying request and response <span class="No-Break">message formats:</span></p>
			<pre class="source-code">
syntax = "proto3";
package payment;
// The payment service definition.
service PaymentService {
  // Processes a payment
  rpc ProcessPayment (PaymentRequest) returns (PaymentResponse) {}
}
// The request message containing payment details.
message PaymentRequest {
  string order_id = 1;
  double amount = 2;
  string currency = 3;
  string user_id = 4;
}
// The response message containing the result of the payment process.
message PaymentResponse {
  string payment_id = 1;
  string status = 2; // e.g., "SUCCESS", "FAILED"
}</pre>			<p>Then, you <a id="_idIndexMarker649"/>must compile the <strong class="source-inline">payment.proto</strong> file into <a id="_idIndexMarker650"/>Python code using the protobuf compiler (<strong class="source-inline">protoc</strong>). For that, you need to use a specific command line that <a id="_idIndexMarker651"/>invokes <strong class="source-inline">protoc</strong> with the appropriate plugins and options <span class="No-Break">for Python.</span></p>
			<p>Here is the general form of the command line for compiling <strong class="source-inline">.proto</strong> files for use with gRPC <span class="No-Break">in Python:</span></p>
			<pre class="source-code">
<strong class="bold">python -m grpc_tools.protoc -I&lt;PROTO_DIR&gt; --python_out=&lt;OUTPUT_DIR&gt; --grpc_python_out=&lt;OUTPUT_DIR&gt; &lt;PROTO_FILES&gt;</strong></pre>			<p>In this case, we make sure we change the directory to be under the right path (for example, by doing <strong class="source-inline">cd ch06/microservices/grpc</strong>), and then we run the <span class="No-Break">following command:</span></p>
			<pre class="source-code">
<strong class="bold">python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. payment.proto</strong></pre>			<p>This will generate two files in the current directory: <strong class="source-inline">payment_pb2.py</strong> and <strong class="source-inline">payment_pb2_grpc.py</strong>. Those files are not to be <span class="No-Break">manually edited.</span></p>
			<p>Next, we provide, in a <strong class="source-inline">payment_service.py</strong> file, the service logic for the payment processing, extending what has been provided in the generated <strong class="source-inline">.py</strong> files. In the module, we define the <strong class="source-inline">Pay<a id="_idTextAnchor175"/>mentServiceImpl</strong> class, inheriting from the <strong class="source-inline">payment_pb2_grpc.PaymentServiceServicer</strong> class, and we override the <strong class="source-inline">ProcessPayment()</strong> method that will do what is needed to process the payment (e.g., calling external APIs, doing database updates, etc.) Note that here, we have a simplified example, but you would have more complex logic. The code is <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
from concurrent.futures import ThreadPoolExecutor
import grpc
import payment_pb2
import payment_pb2_grpc
class PaymentServiceImpl(payment_pb2_grpc.PaymentServiceServicer):
    def ProcessPayment(self, request, context):
        return payment_pb2.PaymentResponse(payment_id="12345", status="SUCCESS")</pre>			<p>Then, we have <a id="_idIndexMarker652"/>the <strong class="source-inline">main()</strong> function, with the code<a id="_idIndexMarker653"/> needed to start the <a id="_idIndexMarker654"/>processing service, created by calling <strong class="source-inline">grpc.server(ThreadPoolExecutor(max_workers=10))</strong>. The code of the function is <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
def main():
    print("Payment Processing Service ready!")
    server = grpc.server(ThreadPoolExecutor(max_workers=10))
    payment_pb2_grpc.add_PaymentServiceServicer_to_server(PaymentServiceImpl(), server)
    server.add_insecure_port("[::]:50051")
    server.start()
    server.wait_for_termination()</pre>			<p>With th<a id="_idTextAnchor176"/>at, the<a id="_idIndexMarker655"/> service is done and ready to be tested. We need a client to be able to test it. We can write a test client with code that calls the <a id="_idIndexMarker656"/>service using gRPC, with the<a id="_idIndexMarker657"/> following code (in the <span class="No-Break"><strong class="source-inline">ch06/microservices/grpc/client.py</strong></span><span class="No-Break"> file):</span></p>
			<pre class="source-code">
import grpc
import payment_pb2
import payment_pb2_grpc
with grpc.insecure_channel("localhost:50051") as chan:
    stub = payment_pb2_grpc.PaymentServiceStub(chan)
    resp = stub.ProcessPayment(
        payment_pb2.PaymentRequest(
            order_id="order123",
            amount=99.99,
            currency="USD",
            user_id="user456",
        )
    )
    print("Payment Service responded.")
    print(f"Response status: {resp.status}")</pre>			<p>To start the service (in the <strong class="source-inline">ch06/microservices/grpc/payment_service.py</strong> file), you can run the <span class="No-Break">following command:</span></p>
			<pre class="source-code">
<strong class="bold">python ch06/microservices/grpc/payment_service.py</strong></pre>			<p>You will get the following output, showing that the service has started <span class="No-Break">as expected:</span></p>
			<pre class="source-code">
<strong class="bold">Payment Processing Service ready!</strong></pre>			<p>Now, open another terminal to run the client (in the <span class="No-Break"><strong class="source-inline">ch06/microservices/grpc/client.py</strong></span><span class="No-Break"> file):</span></p>
			<pre class="source-code">
<strong class="bold">python ch06/microservices/grpc/client.py</strong></pre>			<p>In the terminal where you have run the client code, you should get the <span class="No-Break">following output:</span></p>
			<pre class="source-code">
<strong class="bold">Payment Service responded.</strong>
<strong class="bold">Response status: SUCCESS</strong></pre>			<p>This output is what <span class="No-Break">is expected.</span></p>
			<p>Note <a id="_idIndexMarker658"/>that while gRPC is a powerful choice for Microservices communication, other approaches such as <strong class="bold">REST over HTTP</strong> can also<a id="_idIndexMarker659"/> be used, especially when human readability or web<a id="_idIndexMarker660"/> integration is a priority. However, gRPC <a id="_idIndexMarker661"/>provides advantages in terms of performance and support for streaming requests and responses, and it was interesting to introduce it with <span class="No-Break">this example.</span></p>
			<h2 id="_idParaDest-168"><a id="_idTextAnchor177"/>Implementing the microservices pattern – an LLM service using Lanarky</h2>
			<p>Lanarky<a id="_idIndexMarker662"/> is a web<a id="_idIndexMarker663"/> framework that builds upon the FastAPI <a id="_idIndexMarker664"/>framework, to provide batteries for building Microservices that<a id="_idIndexMarker665"/> use <strong class="bold">large language </strong><span class="No-Break"><strong class="bold">models</strong></span><span class="No-Break"> (</span><span class="No-Break"><strong class="bold">LLMs</strong></span><span class="No-Break">).</span></p>
			<p>We will follow the <em class="italic">Getting started</em> instructions from the website (<a href="https://lanarky.ajndkr.com">https://lanarky.ajndkr.com</a>) to showcase a microservice backed by Lanarky. To be able to test the example, you need to set the <strong class="source-inline">OPENAI_API_KEY</strong> environment variable to use OpenAI. Visit <a href="https://openai.com">https://openai.com</a> and follow the instructions to get your <span class="No-Break">API key.</span></p>
			<p>The LLM service code starts by importing the modules <span class="No-Break">we need:</span></p>
			<pre class="source-code">
import os
import uvicorn
from lanarky import Lanarky
from lanarky.adapters.openai.resources import ChatCompletionResource
from lanarky.adapters.openai.routing import OpenAIAPIRouter</pre>			<p>Before <a id="_idIndexMarker666"/>starting the actual application code, you need to pass the<a id="_idIndexMarker667"/> OpenAI API key, which is used by<a id="_idIndexMarker668"/> Lanarky’s code via the <strong class="source-inline">os.environ</strong> object. For example, pass the value of the secret key via <span class="No-Break">this line:</span></p>
			<pre class="source-code">
os.environ["OPENAI_API_KEY"] = "Your OpenAI API key here"</pre>			<p class="callout-heading">Security practice</p>
			<p class="callout">It is recommended that you pass secret keys to the code, by setting an environment variable in <span class="No-Break">your shell.</span></p>
			<p>Then, we create an <strong class="source-inline">app</strong> object, an instance of the <strong class="source-inline">Lanarky</strong> class, and the <strong class="source-inline">router</strong> object that will be used for the definition of the service’s routes, as is conventional with FastAPI. This router is an instance of the <strong class="source-inline">OpenAPIRouter</strong> class provided by the <span class="No-Break">Lanarky f<a id="_idTextAnchor178"/>ramework:</span></p>
			<pre class="source-code">
app = Lanarky()
router = OpenAIAPIRouter()</pre>			<p>Next, we provide a <strong class="source-inline">chat()</strong> function for the <strong class="source-inline">/chat</strong> route, when there is a <strong class="source-inline">POST</strong> request, <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
@router.post("/chat")
def chat(stream: bool = True) -&gt; ChatCompletionResource:
    system = "Here is your assistant"
    return ChatCompletionResource(stream=stream, system=system)</pre>			<p>Finally, we associate the router to the FastAPI application (standard FastAPI convention) and we run the FastAPI application (our service) using <strong class="source-inline">uvicorn.run()</strong>, <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
if __name__ == "__main__":
    app.include_router(router)
    uvicorn.run(app)</pre>			<p>To finalize this <a id="_idIndexMarker669"/>demonstration implementation, we can write client <a id="_idIndexMarker670"/>code to interact with the service. The<a id="_idIndexMarker671"/> code for that part is <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
import click
import sys
from lanarky.clients import StreamingClient
args = sys.argv[1:]
if len(args) == 1:
    message = args[0]
    client = StreamingClient()
    for event in client.stream_response(
        "POST",
        "/chat",
        params={"stream": "false"},
        json={"messages": [dict(role="user", content=message)]},
    ):
        print(f"{event.event}: {event.data}")
else:
    print("You need to pass a message!")</pre>			<p>To test the <a id="_idIndexMarker672"/>example, similarly to the previous one (where we<a id="_idIndexMarker673"/> tested a gRPC-based microservice), open <a id="_idIndexMarker674"/>a terminal, and run the LLM service code (in the <strong class="source-inline">ch06/microservices/lanarky/llm_service.py</strong> file) using the <span class="No-Break">following command:</span></p>
			<pre class="source-code">
<strong class="bold">python ch06/microservices/lanarky/llm_service.py</strong></pre>			<p>You should get an output like <span class="No-Break">the following:</span></p>
			<pre class="source-code">
<strong class="bold">INFO:   Started server process [18617]</strong>
<strong class="bold">INFO:   Waiting for application startup.</strong>
<strong class="bold">INFO:   Application startup complete.</strong>
<strong class="bold">INFO:   Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)</strong></pre>			<p>Then, open a second terminal to run the client program, using the <span class="No-Break">following command:</span></p>
			<pre class="source-code">
<strong class="bold">python ch06/microservices/lanarky/client.py "Hello"</strong></pre>			<p>You should get the <span class="No-Break">following output:</span></p>
			<pre class="source-code">
<strong class="bold">completion: Hello! How can I assist you today?</strong></pre>			<p>Now, you can continue sending messages via the client program, and wait for the service to come back with the completion, as you would do via the <span class="No-Break">ChatGPT interface.</span></p>
			<p>For example, see the <span class="No-Break">following code:</span></p>
			<pre class="source-code">
<strong class="bold">python ch06/microservices/lanarky/client.py "What is the capital of Switzerland?"</strong>
<strong class="bold">completion: The capital of Switzerland is Bern.</strong></pre>			<h1 id="_idParaDest-169"><a id="_idTextAnchor179"/>The Serverless pattern</h1>
			<p>The <a id="_idIndexMarker675"/>Serverless pattern<a id="_idIndexMarker676"/> abstracts server management, allowing developers to focus solely on code. Cloud providers handle the scaling and execution based on event triggers, such <a id="_idIndexMarker677"/>as HTTP requests, file uploads, or <span class="No-Break">database modifications.</span></p>
			<div>
				<div id="_idContainer021" class="IMG---Figure">
					<img src="image/B21896_06_03.jpg" alt="Figure 6.3 – The Serverless pattern"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 6.3 – The Serverless pattern</p>
			<p>The<a id="_idIndexMarker678"/> Serverless pattern is particularly useful for Microservices, APIs, and <span class="No-Break">event-driven architectures.</span></p>
			<h2 id="_idParaDest-170"><a id="_idTextAnchor180"/>Real-world examples</h2>
			<p>There are several examples we can<a id="_idIndexMarker679"/> think of for the Serverless pattern. Here are some <span class="No-Break">of them:</span></p>
			<ul>
				<li><strong class="bold">Automated data backups</strong>: Serverless functions can be scheduled to automatically back up important data to <span class="No-Break">cloud storage</span></li>
				<li><strong class="bold">Image processing</strong>: Whenever a user uploads an image, a serverless function can automatically resize, compress, or apply filters to <span class="No-Break">the image</span></li>
				<li><strong class="bold">PDF generation for E-commerce receipts</strong>: After a purchase is made, a serverless function generates a PDF receipt and emails it to <span class="No-Break">the customer</span></li>
			</ul>
			<h2 id="_idParaDest-171"><a id="_idTextAnchor181"/>Use cases for the Serverless pattern</h2>
			<p>There are two types of use cases<a id="_idIndexMarker680"/> the Serverless pattern can be <span class="No-Break">used for.</span></p>
			<p>First, Serverless is useful for handling event-driven architectures where specific functions need to be executed in response to events, such as doing image processing (cropping, resizing) or dynamic <span class="No-Break">PDF generation.</span></p>
			<p>The second type of <a id="_idIndexMarker681"/>architecture where Serverless can be used<a id="_idIndexMarker682"/> is <strong class="bold">Microservices</strong>. Each microservice can be a serverless function, making it easier to manage <span class="No-Break">and scale.</span></p>
			<p>Since we have already <a id="_idIndexMarker683"/>discussed the Microservices pattern in the previous section, we are going to focus on how to implement the first <span class="No-Break">use case.</span></p>
			<h2 id="_idParaDest-172"><a id="_idTextAnchor182"/>Implementing the Serverless pattern</h2>
			<p>Let’s see a simple example<a id="_idIndexMarker684"/> using AWS Lambda to create a function that squares a number. AWS Lambda<a id="_idIndexMarker685"/> is Amazon’s serverless <strong class="bold">compute</strong> service, which runs code in response to triggers such as changes in data, shifts in system state, or actions <span class="No-Break">by users.</span></p>
			<p>There is no need to add more complexity since there’s already enough to get right with the Serverless architecture itself and AWS Lambda’s <span class="No-Break">deployment details.</span></p>
			<p>First, we need to write the Python code for the function. We create a <strong class="source-inline">lambda_handler()</strong> function, which takes two parameters, <strong class="source-inline">event</strong> and <strong class="source-inline">context</strong>. In our case, the input number is accessed as a value of the “number” key in the event dictionary. We take the square of that value and we return a a string containing the expected result. The code is <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
import json
def lambda_handler(event, context):
    number = event["number"]
    squared = number * number
    return f"The square of {number} is {squared}."</pre>			<p>Once we have the<a id="_idIndexMarker686"/> Py<a id="_idTextAnchor183"/>thon function, we need to deploy it<a id="_idIndexMarker687"/> so that it can be invoked as an AWS Lambda function. For our learning, instead of going through the procedure of deploying to AWS infrastructure, we can use a method that consists of testing things locally. This is what the <strong class="source-inline">LocalStack</strong> Python package allows us to do. Once it is installed, from your environment, you can start LocalStack inside a Docker container by running the available executable in your Python environment, using <span class="No-Break">the command:</span></p>
			<pre class="source-code">
<strong class="bold">localstack start -d</strong></pre>			<p>Then, we compress our Python code file (<strong class="source-inline">ch06/lambda_function_square.py</strong>) to a ZIP file, for example, by using the ZIP program <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
<strong class="bold">zip lambda.zip lambda_function_square.py</strong></pre>			<p>The other tool we are going to use here is the <strong class="source-inline">awslocal</strong> tool (a Python module we need to install). Once installed, we can use this program to deploy the Lambda function into the “local stack” AWS infrastructure. This is done, in our case, using the <span class="No-Break">following command:</span></p>
			<pre class="source-code">
<strong class="bold">awslocal lambda create-function \</strong>
<strong class="bold">    --function-name lambda_function_square \</strong>
<strong class="bold">    --runtime python3.11 \</strong>
<strong class="bold">    --zip-file fileb://lambda.zip \</strong>
<strong class="bold">    --handler lambda_function_square.lambda_handler \</strong>
<strong class="bold">    --role arn:aws:iam::000000000000:role/lambda-role</strong></pre>			<p class="callout-heading">Adapt to your Python version</p>
			<p class="callout">At the time of writing, this was tested with Python 3.11. You must adapt this command to your <span class="No-Break">Python version.</span></p>
			<p>You can test the Lambda function, providing an input using the <strong class="source-inline">payload.json</strong> file, using <span class="No-Break">the command:</span></p>
			<pre class="source-code">
<strong class="bold">awslocal lambda invoke --function-name lambda_function_square \</strong>
<strong class="bold">    --payload file://payload.json output.txt</strong></pre>			<p>You can then check the result by looking into the <strong class="source-inline">output.txt</strong> file’s content. You should see <span class="No-Break">the text:</span></p>
			<pre class="source-code">
<strong class="bold">The square of 6 is 36.</strong></pre>			<p>Okay, this was a <a id="_idIndexMarker688"/>preliminary test, but we can go further. We <a id="_idIndexMarker689"/>can create a URL for the Lambda function. Again, thanks to <strong class="source-inline">awslocal</strong>, running the <span class="No-Break">following command:</span></p>
			<pre class="source-code">
<strong class="bold">awslocal lambda create-function-url-config \</strong>
<strong class="bold">    --function-name lambda_function_square \</strong>
<strong class="bold">    --auth-type NONE</strong></pre>			<p>This will generate a URL that can be used to invoke the Lambda function. The URL will be in the <span class="No-Break"><strong class="source-inline">http://&lt;XXXXXXXX&gt;.lambda-url.us-east-1.localhost.localstack.cloud:4566</strong></span><span class="No-Break"> format.</span></p>
			<p>Now, for example, we can trigger the Lambda function URL <span class="No-Break">using </span><span class="No-Break"><strong class="source-inline">cUrl</strong></span><span class="No-Break">:</span></p>
			<pre class="source-code">
<strong class="bold">curl -X POST \</strong>
<strong class="bold">    'http://iu4s187onr1oabg50dbvm77bk6r5sunk.lambda-url.us-east-1.localhost.localstack.cloud:4566/' \</strong>
<strong class="bold">    -H 'Content-Type: application/json' \</strong>
<strong class="bold">    -d '{"number": 6}'</strong></pre>			<p>For up-to-date and detailed guides related to AWS Lambda, consult the documentation <span class="No-Break">at </span><a href="https://docs.aws.amazon.com/lambda/"><span class="No-Break">https://docs.aws.amazon.com/lambda/</span></a><span class="No-Break">.</span></p>
			<p>This was a minimal example. Another example of a serverless application could be a function that generates PDF receipts for a business. This would allow the business to not worry about server management and only pay for the computing time that <span class="No-Break">is consumed.</span></p>
			<h1 id="_idParaDest-173"><a id="_idTextAnchor184"/>The Event Sourcing pattern</h1>
			<p>The Event Sourcing pattern <a id="_idIndexMarker690"/>stores state changes as a sequence of events, allowing the <a id="_idIndexMarker691"/>reconstruction of past states and providing an audit trail. This pattern is particularly useful in systems where the state is complex and the business rules for transitions <span class="No-Break">are complex.</span></p>
			<p>As we will see in implementation examples later, the Event Sourcing pattern emphasizes the importance of capturing all changes to an application state as a sequence of events. An outcome of this is that the application state can be reconstructed at any point in time by replaying <span class="No-Break">these events.</span></p>
			<h2 id="_idParaDest-174"><a id="_idTextAnchor185"/>Real-world examples</h2>
			<p>There are several real-world<a id="_idIndexMarker692"/> examples in the <span class="No-Break">software category:</span></p>
			<ul>
				<li><strong class="bold">Audit trails</strong>: Keeping a record of all changes made to a database <span class="No-Break">for compliance</span></li>
				<li><strong class="bold">Collaborative editing</strong>: Allowing multiple users to edit a <span class="No-Break">document simultaneously</span></li>
				<li><strong class="bold">Undo/redo features</strong>: Providing the ability to undo or redo actions in <span class="No-Break">an application</span></li>
			</ul>
			<h2 id="_idParaDest-175"><a id="_idTextAnchor186"/>Use cases for the Event Sourcing pattern</h2>
			<p>There are several use cases<a id="_idIndexMarker693"/> for the Event Sourcing pattern. Let’s consider the <span class="No-Break">following three:</span></p>
			<ul>
				<li><strong class="bold">Financial transactions</strong>: Event <a id="_idIndexMarker694"/>Sourcing can be used to record every change to an account’s balance as a chronological series of immutable events. This method ensures that every deposit, withdrawal, or transfer is captured as a distinct event. This way, we can provide a transparent, auditable, and secure ledger of all <span class="No-Break">financial activities.</span></li>
				<li><strong class="bold">Inventory management</strong>: Within inventory management contexts, Event Sourcing helps in tracking each item’s life cycle by logging all changes as events. This enables businesses to maintain accurate and up-to-date records of stock levels, identify patterns in item usage or sales, and predict future inventory needs. It also facilitates tracing the history of any item, aiding in recall processes or quality <span class="No-Break">assurance investigations.</span></li>
				<li><strong class="bold">Customer behavior tracking</strong>: Event Sourcing plays a critical role in capturing and storing every interaction a customer has with a platform, from browsing history and cart modifications to purchases and returns. This wealth of data, structured as a series of events, becomes a valuable resource for analyzing customer behavior, personalizing marketing strategies, enhancing user experience, and improving<a id="_idIndexMarker695"/> <span class="No-Break">product recommendations.</span></li>
			</ul>
			<p>Let’s now see how we can implement <span class="No-Break">this pattern.</span></p>
			<h2 id="_idParaDest-176"><a id="_idTextAnchor187"/>Implementing the event sourcing pattern – the manual way</h2>
			<p>Let’s start with some <a id="_idIndexMarker696"/>definitions. The components of the Event<a id="_idIndexMarker697"/> Sourcing pattern implementation are <span class="No-Break">as follows:</span></p>
			<ul>
				<li><strong class="bold">Event</strong>: A representation of a state change, typically containing the type of event and the data associated with that event. Once an event is created and applied, it cannot <span class="No-Break">be changed.</span></li>
				<li><strong class="bold">Aggregate</strong>: An object (or group of objects) that represents a single unit of business logic or data. It keeps track of things, and every time something changes (an event), it makes a record <span class="No-Break">of it.</span></li>
				<li><strong class="bold">Event store</strong>: A collection of all the events that <span class="No-Break">have occurred.</span></li>
			</ul>
			<p>By handling state changes through events, the business logic becomes more flexible and easier to extend. For example, adding new types of events or modifying the handling of existing events can be done with minimal impact on the rest of <span class="No-Break">the system.</span></p>
			<p>In this first example, for the bank account use case, we will see how to implement the event sourcing pattern in a manual way. In such an implementation, you would typically define your event classes and manually write the logic to apply these events to your aggregates. Let’s <span class="No-Break">see that.</span></p>
			<p>We start by defining an <strong class="source-inline">Account</strong> class <a id="_idIndexMarker698"/>representing a bank account with a balance and a list of events attached to it, for the operations on the account. This class acts as the aggregate. Its <strong class="source-inline">events</strong> attribute represents the event store. Here, an event will be represented by a dictionary containing the type of operation (“deposited” or “withdrawn”) and the <span class="No-Break">amount value.</span></p>
			<p>We then add the <strong class="source-inline">apply_event()</strong> method taking an event as the input. Depending on <strong class="source-inline">event["type"]</strong>, we increment or decrement the account balance by the event’s amount, and we add the event to the <strong class="source-inline">events</strong> list, effectively storing <span class="No-Break">the event:</span></p>
			<pre class="source-code">
class Account:
    def __init__(self):
        self.balance = 0
        self.events = []
    def apply_event(self, event):
        if event["type"] == "deposited":
            self.balance += event["amount"]
        elif event["type"] == "withdrawn":
            self.balance -= event["amount"]
        self.events.append(event)</pre>			<p>Then, we add a <strong class="source-inline">deposit()</strong> method <a id="_idIndexMarker699"/>and a <strong class="source-inline">withdraw()</strong> method, which both call the <strong class="source-inline">apply_event()</strong> method, <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
    def deposit(self, amount):
        event = {"type": "deposited", "amount": amount}
        self.apply_event(event)
    def withdraw(self, amount):
        event = {"type": "withdrawn", "amount": amount}
        self.apply_event(event)</pre>			<p>Finally, we<a id="_idIndexMarker700"/> add the <strong class="source-inline">main()</strong> function, <span class="No-Break">as </span><span class="No-Break"><a id="_idIndexMarker701"/></span><span class="No-Break">follows:</span></p>
			<pre class="source-code">
def main():
    account = Account()
    account.deposit(100)
    account.deposit(50)
    account.withdraw(30)
    account.deposit(30)
    for evt in account.events:
        print(evt)
    print(f"Balance: {account.balance}")</pre>			<p>Running the code, using the <strong class="source-inline">python ch06/ event_sourcing/bankaccount.py</strong> command, gives the <span class="No-Break">following output:</span></p>
			<pre class="source-code">
<strong class="bold">{'type': 'deposited', 'amount': 100}</strong>
<strong class="bold">{'type': 'deposited', 'amount': 50}</strong>
<strong class="bold">{'type': 'withdrawn', 'amount': 30}</strong>
<strong class="bold">{'type': 'deposited', 'amount': 30}</strong>
<strong class="bold">Balance: 150</strong></pre>			<p>This example provided a first understanding of Event Sourcing through a simple, manual implementation. For more complex systems, frameworks and libraries designed for Event Sourcing can help manage some of this complexity, providing utilities for event storage, querying, and processing. We will test such a <span class="No-Break">library next.</span></p>
			<h2 id="_idParaDest-177"><a id="_idTextAnchor188"/>Implementing the Event Sourcing pattern – using a library</h2>
			<p>In this second example, we <a id="_idIndexMarker702"/>will use the <strong class="source-inline">eventsourcing</strong> library to<a id="_idIndexMarker703"/> implement the Event Sourcing pattern. Let’s consider an inventory management system where we track the quantity <span class="No-Break">of items.</span></p>
			<p>We start by importing what we need, <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
from eventsourcing.domain import Aggregate, event
from eventsourcing.application import Application</pre>			<p>Then, we define the class for the aggregate object, <strong class="source-inline">InventoryItem</strong>, by inheriting from the <strong class="source-inline">Aggregate</strong> class. The class has an <strong class="source-inline">increase_quantity()</strong> and a <strong class="source-inline">decrease_quantity</strong> method, each decorated with the <strong class="source-inline">@event</strong> decorator. The code for this class is <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
class InventoryItem(Aggregate):
    @event("ItemCreated")
    def __init__(self, name, quantity=0):
        self.name = name
        self.quantity = quantity
    @event("QuantityIncreased")
    def increase_quantity(self, amount):
        self.quantity += amount
    @event("QuantityDecreased")
    def decrease_quantity(self, amount):
        self.quantity -= amount</pre>			<p>Next, we create our inventory application’s class, <strong class="source-inline">InventoryApp</strong>, inheriting from the <strong class="source-inline">eventsourcing</strong> library’s <strong class="source-inline">Application</strong> class. The first method handles the creation of an item, taking an instance of the <strong class="source-inline">InventoryItem</strong> class (<strong class="source-inline">item</strong>) and calling the <strong class="source-inline">save()</strong> method on the <strong class="source-inline">InventoryApp</strong> object using the item. But what exactly does the <strong class="source-inline">save()</strong> method do? It collects pending events from given aggregates and puts them in the application’s event store. The definition of the class starts <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
class InventoryApp(Application):
    def create_item(self, name, quantity):
        item = InventoryItem(name, quantity)
        self.save(item)
        return item.id</pre>			<p>Next, similarly to what we did in the previous example, we add an <strong class="source-inline">increase_item_quantity()</strong> method, which handles the increase of the item’s quantity (for the aggregate object) and then saves the aggregate object on the application, followed by the corresponding <strong class="source-inline">decrease_item_quantity()</strong> method, for the decreasing action, <span class="No-Break">as follows:</span></p>
			<pre class="source-code">
    def increase_item_quantity(self, item_id, amount):
        item = self.repository.get(item_id)
        item.increase_quantity(amount)
        self.save(item)
    def decrease_item_quantity(self, item_id, amount):
        item = self.repository.get(item_id)
        item.decrease_quantity(amount)
        self.save(item)</pre>			<p>Finally, we add the <strong class="source-inline">main()</strong> function, with <a id="_idIndexMarker704"/>some code to test our design, <span class="No-Break">as</span><span class="No-Break"><a id="_idIndexMarker705"/></span><span class="No-Break"> follows:</span></p>
			<pre class="source-code">
def main():
    app = InventoryApp()
    # Create a new item
    item_id = app.create_item("Laptop", 10)
    # Increase quantity
    app.increase_item_quantity(item_id, 5)
    # Decrease quantity
    app.decrease_item_quantity(item_id, 3)
    notifs = app.notification_log.select(start=1, limit=5)
    notifs = [notif.state for notif in notifs]
    for notif in notifs:
        print(notif.decode())</pre>			<p>Running the <a id="_idIndexMarker706"/>code, using the <strong class="source-inline">python ch06/ event_sourcing/inventory.py</strong> command, gives the<a id="_idIndexMarker707"/> <span class="No-Break">following output:</span></p>
			<pre class="source-code">
<strong class="bold">{"timestamp":{"_type_":"datetime_iso","_data_":"2024-03-18T08:05:10.583875+00:00"},"originator_topic":"__main__:InventoryItem","name":"Laptop","quantity":10}</strong>
<strong class="bold">{"timestamp":{"_type_":"datetime_iso","_data_":"2024-03-18T08:05:10.584818+00:00"},"amount":5}</strong>
<strong class="bold">{"timestamp":{"_type_":"datetime_iso","_data_":"2024-03-18T08:05:10.585128+00:00"},"amount":3}</strong></pre>			<p>Nice work! This example and the previous one helped introduce the way to design an event-sourced application. For an ambitious project, we can leverage the <strong class="source-inline">eventsourcing</strong> library, which makes it easier to implement this type <span class="No-Break">of application.</span></p>
			<h1 id="_idParaDest-178"><a id="_idTextAnchor189"/>Other architectural design patterns</h1>
			<p>You may encounter documentation about other architectural design patterns. Here are three <span class="No-Break">other patterns:</span></p>
			<ul>
				<li><strong class="bold">Event-Driven Architecture (EDA)</strong>: This <a id="_idIndexMarker708"/>pattern emphasizes the production, detection, consumption of, and reaction to events. EDA <a id="_idIndexMarker709"/>is highly adaptable and scalable, making it suitable for environments where systems need to react to significant events in <span class="No-Break">real time.</span></li>
				<li><strong class="bold">Command Query Responsibility Segregation (CQRS)</strong>: This pattern separates the models for reading <a id="_idIndexMarker710"/>and writing data, allowing for more scalable and maintainable architectures, especially <a id="_idIndexMarker711"/>when there are clear distinctions between operations that mutate data and those that only <span class="No-Break">read data.</span></li>
				<li><strong class="bold">Clean Architecture</strong>: This<a id="_idIndexMarker712"/> pattern proposes a<a id="_idIndexMarker713"/> way to organize code such that it encapsulates the business logic but keeps it separate from the interfaces through which the application is exposed to users or other systems. It emphasizes the use of dependency inversion to drive the decoupling of <span class="No-Break">software components.</span></li>
			</ul>
			<h1 id="_idParaDest-179"><a id="_idTextAnchor190"/>Summary</h1>
			<p>In this chapter, we explored several foundational architectural design patterns that are pivotal in modern software development, each useful for different requirements and solving <span class="No-Break">unique challenges.</span></p>
			<p>We first covered the MVC pattern, which promotes the separation of concerns by dividing the application into three interconnected components. This separation allows for more manageable, scalable, and testable code by isolating the UI, the data, and the logic that connects <span class="No-Break">the two.</span></p>
			<p>Then, we looked at the Microservices pattern, which takes a different approach by structuring an application as a collection of small, independent services, each responsible for a specific business function. This pattern enhances scalability, flexibility, and ease of deployment, making it an ideal choice for complex, evolving applications that need to rapidly adapt to changing <span class="No-Break">business requirements.</span></p>
			<p>Next, we looked at the Serverless pattern, which shifts the focus from server management to pure business logic by leveraging cloud services to execute code snippets in response to events. This pattern offers significant cost savings, scalability, and productivity benefits by abstracting the underlying infrastructure, allowing developers to concentrate on writing code that adds <span class="No-Break">direct value.</span></p>
			<p>Afterward, we went over the Event Sourcing pattern, which offers another way to handle data changes in an application by storing each change as a sequence of events. This not only provides a robust audit trail and enables complex business functionalities but also allows the system to reconstruct past states, offering invaluable insights into the data life cycle and changes <span class="No-Break">over time.</span></p>
			<p>Lastly, we touched upon other architectural design patterns, such as CQRS and Clean Architecture. Each offers unique advantages and addresses different aspects of software design and architecture. Even if we could not dive deep into these patterns, they complement the developer’s toolkit for building well-structured and <span class="No-Break">maintainable systems.</span></p>
			<p>In the next chapter, we will discuss concurrency and asynchronous patterns and techniques to help our program manage multiple operations simultaneously or move on to other tasks while waiting for operations <span class="No-Break">to complete.</span></p>
		</div>
	</body></html>