<html><head></head><body>
<div class="Basic-Text-Frame" id="_idContainer119">
<h1 class="chapterNumber"><span class="koboSpan" id="kobo.1.1">3</span></h1>
<h1 class="chapterTitle" id="_idParaDest-113"><span class="koboSpan" id="kobo.2.1">Extending Your Blog Application</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">The previous chapter went through the basics of forms and the creation of a comment system. </span><span class="koboSpan" id="kobo.3.2">You also learned how to send emails with Django. </span><span class="koboSpan" id="kobo.3.3">In this chapter, you will extend your blog application with other popular features used on blogging platforms, such as tagging, recommending similar posts, providing an RSS feed to readers, and allowing them to search posts. </span><span class="koboSpan" id="kobo.3.4">You will learn about new components and functionalities with Django by building these functionalities.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4.1">The chapter will cover the following topics:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.5.1">Implementing tagging using </span><code class="inlineCode"><span class="koboSpan" id="kobo.6.1">django-taggit</span></code></li>
<li class="bulletList"><span class="koboSpan" id="kobo.7.1">Retrieving posts by similarity</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.8.1">Creating custom template tags and filters to display the latest posts and most commented posts</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.9.1">Adding a sitemap to the site</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.10.1">Creating feeds for blog posts</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.11.1">Installing PostgreSQL</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.12.1">Using fixtures to dump and load data into the database</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.13.1">Implementing a full-text search engine with Django and PostgreSQL</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-114"><span class="koboSpan" id="kobo.14.1">Functional overview</span></h1>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.15.1">Figure 3.1</span></em><span class="koboSpan" id="kobo.16.1"> shows a</span><a id="_idIndexMarker252"/><span class="koboSpan" id="kobo.17.1"> representation of the views, templates, and functionalities that will be built in this chapter:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.18.1"><img alt="" role="presentation" src="../Images/B21088_03_01.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.19.1">Figure 3.1: Diagram of functionalities built in Chapter 3</span></p>
<p class="normal"><span class="koboSpan" id="kobo.20.1">In this chapter, we will build the functionality to add tags to posts. </span><span class="koboSpan" id="kobo.20.2">We will extend the </span><code class="inlineCode"><span class="koboSpan" id="kobo.21.1">post_list</span></code><span class="koboSpan" id="kobo.22.1"> view to filter </span><a id="_idIndexMarker253"/><span class="koboSpan" id="kobo.23.1">posts by tag. </span><span class="koboSpan" id="kobo.23.2">When loading a single post in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.24.1">post_detail</span></code><span class="koboSpan" id="kobo.25.1"> view, we will retrieve similar posts based on common tags. </span><span class="koboSpan" id="kobo.25.2">We will also create custom template tags to display a sidebar with the total number of posts, the latest posts published, and the most commented posts.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.26.1">We will add support to write posts with Markdown syntax and convert the content to HTML. </span><span class="koboSpan" id="kobo.26.2">We will create a sitemap for the blog with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.27.1">PostSitemap</span></code><span class="koboSpan" id="kobo.28.1"> class and implement an RSS feed with the latest posts in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.29.1">LatestPostsFeed</span></code><span class="koboSpan" id="kobo.30.1"> class. </span><span class="koboSpan" id="kobo.30.2">Finally, we will implement a search engine with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.31.1">post_search</span></code><span class="koboSpan" id="kobo.32.1"> view and use PostgreSQL full-text search capabilities.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.33.1">The source code for this chapter can be found at </span><a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter03"><span class="url"><span class="koboSpan" id="kobo.34.1">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter03</span></span></a><span class="koboSpan" id="kobo.35.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.36.1">All Python packages used in this chapter are included in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.37.1">requirements.txt</span></code><span class="koboSpan" id="kobo.38.1"> file in the source code for the chapter. </span><span class="koboSpan" id="kobo.38.2">You can follow the instructions to install each Python package in the following sections, or you can install all the requirements at once with the command </span><code class="inlineCode"><span class="koboSpan" id="kobo.39.1">python</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.40.1">-m</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.41.1">pip install -r requirements.txt</span></code><span class="koboSpan" id="kobo.42.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-115"><span class="koboSpan" id="kobo.43.1">Implementing tagging with django-taggit</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.44.1">A very common functionality in blogs is categorizing posts using tags. </span><span class="koboSpan" id="kobo.44.2">Tags allow you to categorize content in a non-hierarchical manner, using simple keywords. </span><span class="koboSpan" id="kobo.44.3">A tag is simply a label or keyword that can </span><a id="_idIndexMarker254"/><span class="koboSpan" id="kobo.45.1">be assigned to posts. </span><span class="koboSpan" id="kobo.45.2">We will </span><a id="_idIndexMarker255"/><span class="koboSpan" id="kobo.46.1">create a tagging system by integrating a third-party Django tagging application into the project.</span></p>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.47.1">django-taggit</span></code><span class="koboSpan" id="kobo.48.1"> is a reusable application that primarily offers you a </span><code class="inlineCode"><span class="koboSpan" id="kobo.49.1">Tag</span></code><span class="koboSpan" id="kobo.50.1"> model and a manager to easily add tags to any model. </span><span class="koboSpan" id="kobo.50.2">You can take a look at its source code at </span><a href="https://github.com/jazzband/django-taggit"><span class="url"><span class="koboSpan" id="kobo.51.1">https://github.com/jazzband/django-taggit</span></span></a><span class="koboSpan" id="kobo.52.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.53.1">Let’s add tagging to our blog. </span><span class="koboSpan" id="kobo.53.2">First, you need to install </span><code class="inlineCode"><span class="koboSpan" id="kobo.54.1">django-taggit</span></code><span class="koboSpan" id="kobo.55.1"> via </span><code class="inlineCode"><span class="koboSpan" id="kobo.56.1">pip</span></code><span class="koboSpan" id="kobo.57.1"> by running the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.58.1">python -m pip install django-taggit==5.0.1
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.59.1">Then, open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.60.1">settings.py</span></code><span class="koboSpan" id="kobo.61.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.62.1">mysite</span></code><span class="koboSpan" id="kobo.63.1"> project and add </span><code class="inlineCode"><span class="koboSpan" id="kobo.64.1">taggit</span></code><span class="koboSpan" id="kobo.65.1"> to your </span><code class="inlineCode"><span class="koboSpan" id="kobo.66.1">INSTALLED_APPS</span></code><span class="koboSpan" id="kobo.67.1"> setting, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.68.1">INSTALLED_APPS = [
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.69.1">'django.contrib.admin'</span></span><span class="koboSpan" id="kobo.70.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.71.1">'django.contrib.auth'</span></span><span class="koboSpan" id="kobo.72.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.73.1">'django.contrib.contenttypes'</span></span><span class="koboSpan" id="kobo.74.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.75.1">'django.contrib.sessions'</span></span><span class="koboSpan" id="kobo.76.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.77.1">'django.contrib.messages'</span></span><span class="koboSpan" id="kobo.78.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.79.1">'django.contrib.staticfiles'</span></span><span class="koboSpan" id="kobo.80.1">,
    </span><span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.81.1">'taggit'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.82.1">,</span></strong></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.83.1">'blog.apps.BlogConfig'</span></span><span class="koboSpan" id="kobo.84.1">,
]
</span></code></pre>
<div class="packt_tip">
<p class="normal"><span class="koboSpan" id="kobo.85.1">It’s good practice to keep the Django packages at the top, third-party packages in the middle, and local applications at the end of </span><code class="inlineCode"><span class="koboSpan" id="kobo.86.1">INSTALLED_APPS</span></code><span class="koboSpan" id="kobo.87.1">.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.88.1">Open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.89.1">models.py</span></code><span class="koboSpan" id="kobo.90.1"> file of your </span><code class="inlineCode"><span class="koboSpan" id="kobo.91.1">blog</span></code><span class="koboSpan" id="kobo.92.1"> application and add the </span><code class="inlineCode"><span class="koboSpan" id="kobo.93.1">TaggableManager</span></code><span class="koboSpan" id="kobo.94.1"> manager provided by </span><code class="inlineCode"><span class="koboSpan" id="kobo.95.1">django-taggit</span></code><span class="koboSpan" id="kobo.96.1"> to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.97.1">Post</span></code><span class="koboSpan" id="kobo.98.1"> model using the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.99.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.100.1"> taggit.managers </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.101.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.102.1"> TaggableManager</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.103.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.104.1">Post</span></span><span class="koboSpan" id="kobo.105.1">(models.Model):
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.106.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.107.1">tags = TaggableManager()</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.108.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.109.1">tags</span></code><span class="koboSpan" id="kobo.110.1"> manager will allow you to add, retrieve, and remove tags from </span><code class="inlineCode"><span class="koboSpan" id="kobo.111.1">Post</span></code><span class="koboSpan" id="kobo.112.1"> objects.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.113.1">The following schema</span><a id="_idIndexMarker256"/><span class="koboSpan" id="kobo.114.1"> shows the data models defined by </span><code class="inlineCode"><span class="koboSpan" id="kobo.115.1">django-taggit</span></code><span class="koboSpan" id="kobo.116.1"> to create tags and store related tagged objects:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.117.1"><img alt="Diagram  Description automatically generated with low confidence" src="../Images/B21088_03_02.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.118.1">Figure 3.2: Tag models of django-taggit</span></p>
<p class="normal"><span class="koboSpan" id="kobo.119.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.120.1">Tag</span></code><span class="koboSpan" id="kobo.121.1"> model is used to store tags. </span><span class="koboSpan" id="kobo.121.2">It contains a </span><code class="inlineCode"><span class="koboSpan" id="kobo.122.1">name</span></code><span class="koboSpan" id="kobo.123.1"> and a </span><code class="inlineCode"><span class="koboSpan" id="kobo.124.1">slug</span></code><span class="koboSpan" id="kobo.125.1"> field.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.126.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.127.1">TaggedItem</span></code><span class="koboSpan" id="kobo.128.1"> model is used to store the related tagged objects. </span><span class="koboSpan" id="kobo.128.2">It has a </span><code class="inlineCode"><span class="koboSpan" id="kobo.129.1">ForeignKey</span></code><span class="koboSpan" id="kobo.130.1"> field for the related </span><code class="inlineCode"><span class="koboSpan" id="kobo.131.1">Tag</span></code><span class="koboSpan" id="kobo.132.1"> object. </span><span class="koboSpan" id="kobo.132.2">It contains a </span><code class="inlineCode"><span class="koboSpan" id="kobo.133.1">ForeignKey</span></code><span class="koboSpan" id="kobo.134.1"> to a </span><code class="inlineCode"><span class="koboSpan" id="kobo.135.1">ContentType</span></code><span class="koboSpan" id="kobo.136.1"> object and an </span><code class="inlineCode"><span class="koboSpan" id="kobo.137.1">IntegerField</span></code><span class="koboSpan" id="kobo.138.1"> to store the related </span><code class="inlineCode"><span class="koboSpan" id="kobo.139.1">id</span></code><span class="koboSpan" id="kobo.140.1"> of the tagged object. </span><span class="koboSpan" id="kobo.140.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.141.1">content_type</span></code><span class="koboSpan" id="kobo.142.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.143.1">object_id</span></code><span class="koboSpan" id="kobo.144.1"> fields combined </span><a id="_idIndexMarker257"/><span class="koboSpan" id="kobo.145.1">form a generic relationship with any model in your project. </span><span class="koboSpan" id="kobo.145.2">This allows you to create relationships between a </span><code class="inlineCode"><span class="koboSpan" id="kobo.146.1">Tag</span></code><span class="koboSpan" id="kobo.147.1"> instance and any other model instance of your applications. </span><span class="koboSpan" id="kobo.147.2">You will learn about generic relations ship in </span><em class="chapterRef"><span class="koboSpan" id="kobo.148.1">Chapter 7</span></em><span class="koboSpan" id="kobo.149.1">, </span><em class="italic"><span class="koboSpan" id="kobo.150.1">Tracking User Actions</span></em><span class="koboSpan" id="kobo.151.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.152.1">Run the following command in the shell prompt to create a migration for your model changes:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.153.1">python manage.py makemigrations blog
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.154.1">You should get the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.155.1">Migrations for 'blog':
  blog/migrations/0004_post_tags.py
    - Add field tags to post
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.156.1">Now, run the following command to create the required database tables for </span><code class="inlineCode"><span class="koboSpan" id="kobo.157.1">django-taggit</span></code><span class="koboSpan" id="kobo.158.1"> models and to synchronize your model changes:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.159.1">python manage.py migrate
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.160.1">You will see an output indicating that migrations have been applied, as follows:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.161.1">Applying taggit.0001_initial... </span><span class="koboSpan" id="kobo.161.2">OK
Applying taggit.0002_auto_20150616_2121... </span><span class="koboSpan" id="kobo.161.3">OK
Applying taggit.0003_taggeditem_add_unique_index... </span><span class="koboSpan" id="kobo.161.4">OK
Applying taggit.0004_alter_taggeditem_content_type_alter_taggeditem_tag... </span><span class="koboSpan" id="kobo.161.5">OK
Applying taggit.0005_auto_20220424_2025... </span><span class="koboSpan" id="kobo.161.6">OK
Applying taggit.0006_rename_taggeditem_content_type_object_id_taggit_tagg_content_8fc721_idx... </span><span class="koboSpan" id="kobo.161.7">OK
Applying blog.0004_post_tags... </span><span class="koboSpan" id="kobo.161.8">OK
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.162.1">The database is now in sync with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.163.1">taggit</span></code><span class="koboSpan" id="kobo.164.1"> models and we can start using the functionalities of </span><code class="inlineCode"><span class="koboSpan" id="kobo.165.1">django-taggit</span></code><span class="koboSpan" id="kobo.166.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.167.1">Let’s now explore how to </span><a id="_idIndexMarker258"/><span class="koboSpan" id="kobo.168.1">use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.169.1">tags</span></code><span class="koboSpan" id="kobo.170.1"> manager.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.171.1">Open the Django </span><a id="_idIndexMarker259"/><span class="koboSpan" id="kobo.172.1">shell by running the following command in the system shell prompt:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.173.1">python manage.py shell
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.174.1">Run the following code to retrieve one of the posts (the one with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.175.1">1</span></code><span class="koboSpan" id="kobo.176.1"> ID):</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.177.1">&gt;&gt;&gt;</span></span> <span class="hljs-con-keyword"><span class="koboSpan" id="kobo.178.1">from</span></span><span class="koboSpan" id="kobo.179.1"> blog.models </span><span class="hljs-con-keyword"><span class="koboSpan" id="kobo.180.1">import</span></span><span class="koboSpan" id="kobo.181.1"> Post
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.182.1">&gt;&gt;&gt;</span></span><span class="koboSpan" id="kobo.183.1"> post = Post.objects.get(</span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.184.1">id</span></span><span class="koboSpan" id="kobo.185.1">=</span><span class="hljs-con-number"><span class="koboSpan" id="kobo.186.1">1</span></span><span class="koboSpan" id="kobo.187.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.188.1">Then, add some tags to it and retrieve its tags to check whether they were successfully added:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.189.1">&gt;&gt;&gt;</span></span><span class="koboSpan" id="kobo.190.1"> post.tags.add(</span><span class="hljs-con-string"><span class="koboSpan" id="kobo.191.1">'music'</span></span><span class="koboSpan" id="kobo.192.1">, </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.193.1">'jazz'</span></span><span class="koboSpan" id="kobo.194.1">, </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.195.1">'django'</span></span><span class="koboSpan" id="kobo.196.1">)
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.197.1">&gt;&gt;&gt;</span></span><span class="koboSpan" id="kobo.198.1"> post.tags.</span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.199.1">all</span></span><span class="koboSpan" id="kobo.200.1">()
&lt;QuerySet [&lt;Tag: jazz&gt;, &lt;Tag: music&gt;, &lt;Tag: django&gt;]&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.201.1">Finally, remove a tag and check the list of tags again:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.202.1">&gt;&gt;&gt;</span></span><span class="koboSpan" id="kobo.203.1"> post.tags.remove(</span><span class="hljs-con-string"><span class="koboSpan" id="kobo.204.1">'django'</span></span><span class="koboSpan" id="kobo.205.1">)
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.206.1">&gt;&gt;&gt;</span></span><span class="koboSpan" id="kobo.207.1"> post.tags.</span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.208.1">all</span></span><span class="koboSpan" id="kobo.209.1">()
&lt;QuerySet [&lt;Tag: jazz&gt;, &lt;Tag: music&gt;]&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.210.1">It’s really easy to add, retrieve, or remove tags from a model using the manager we have defined.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.211.1">Start the development </span><a id="_idIndexMarker260"/><span class="koboSpan" id="kobo.212.1">server from the shell prompt with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.213.1">python manage.py runserver
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.214.1">Open </span><a href="http://127.0.0.1:8000/admin/taggit/tag/"><span class="url"><span class="koboSpan" id="kobo.215.1">http://127.0.0.1:8000/admin/taggit/tag/</span></span></a><span class="koboSpan" id="kobo.216.1"> in your browser.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.217.1">You will see the administration </span><a id="_idIndexMarker261"/><span class="koboSpan" id="kobo.218.1">page with the list of </span><code class="inlineCode"><span class="koboSpan" id="kobo.219.1">Tag</span></code><span class="koboSpan" id="kobo.220.1"> objects of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.221.1">taggit</span></code><span class="koboSpan" id="kobo.222.1"> application:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.223.1"><img alt="" role="presentation" src="../Images/B21088_03_03.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.224.1">Figure 3.3: The tag change list view on the Django administration site</span></p>
<p class="normal"><span class="koboSpan" id="kobo.225.1">Click on the </span><strong class="screenText"><span class="koboSpan" id="kobo.226.1">jazz</span></strong><span class="koboSpan" id="kobo.227.1"> tag. </span><span class="koboSpan" id="kobo.227.2">You will see the following:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.228.1"><img alt="" role="presentation" src="../Images/B21088_03_04.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.229.1">Figure 3.4: The tag edit view on the Django administration site</span></p>
<p class="normal"><span class="koboSpan" id="kobo.230.1">Navigate to </span><code class="inlineCode"><span class="koboSpan" id="kobo.231.1">http://127.0.0.1:8000/admin/blog/post/1/change/</span></code><span class="koboSpan" id="kobo.232.1"> to edit the post with ID 1.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.233.1">You will see that posts </span><a id="_idIndexMarker262"/><span class="koboSpan" id="kobo.234.1">now include a new </span><strong class="screenText"><span class="koboSpan" id="kobo.235.1">Tags</span></strong><span class="koboSpan" id="kobo.236.1"> field, as follows, where</span><a id="_idIndexMarker263"/><span class="koboSpan" id="kobo.237.1"> you can easily edit tags:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.238.1"><img alt="" role="presentation" src="../Images/B21088_03_05.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.239.1">Figure 3.5: The related Tags field of a Post object</span></p>
<p class="normal"><span class="koboSpan" id="kobo.240.1">Now, you need to edit your blog posts to display tags.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.241.1">Open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.242.1">blog/post/list.html</span></code><span class="koboSpan" id="kobo.243.1"> template and add the following HTML code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.244.1">{% extends "blog/base.html" %}
{% block title %}My Blog{% endblock %}
{% block content %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.245.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.246.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.247.1">&gt;</span></span><span class="koboSpan" id="kobo.248.1">My Blog</span><span class="hljs-tag"><span class="koboSpan" id="kobo.249.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.250.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.251.1">&gt;</span></span><span class="koboSpan" id="kobo.252.1">
  {% for post in posts %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.253.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.254.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.255.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.256.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.257.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.258.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.259.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.260.1">"{{ post.get_absolute_url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.261.1">&gt;</span></span><span class="koboSpan" id="kobo.262.1">
        {{ post.title }}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.263.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.264.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.265.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.266.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.267.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.268.1">&gt;</span></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.269.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.270.1">p</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.271.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.272.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.273.1">"tags"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.274.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.275.1">Tags: {{ post.tags.all|join:", " }}</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.276.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.277.1">p</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.278.1">&gt;</span></strong></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.279.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.280.1">p</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.281.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.282.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.283.1">"date"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.284.1">&gt;</span></span><span class="koboSpan" id="kobo.285.1">
      Published {{ post.publish }} by {{ post.author }}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.286.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.287.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.288.1">&gt;</span></span><span class="koboSpan" id="kobo.289.1">
    {{ post.body|truncatewords:30|linebreaks }}
  {% endfor %}
  {% include "pagination.html" with page=page_obj %}
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.290.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.291.1">join</span></code><span class="koboSpan" id="kobo.292.1"> template filter works analogously</span><a id="_idIndexMarker264"/><span class="koboSpan" id="kobo.293.1"> to Python’s string </span><code class="inlineCode"><span class="koboSpan" id="kobo.294.1">join()</span></code><span class="koboSpan" id="kobo.295.1"> method. </span><span class="koboSpan" id="kobo.295.2">You can concatenate a list of items</span><a id="_idIndexMarker265"/><span class="koboSpan" id="kobo.296.1"> into one string, using a specific character or string to separate each item. </span><span class="koboSpan" id="kobo.296.2">For example, a list of tags like </span><code class="inlineCode"><span class="koboSpan" id="kobo.297.1">['music', 'jazz', 'piano']</span></code><span class="koboSpan" id="kobo.298.1"> is converted into a single string, </span><code class="inlineCode"><span class="koboSpan" id="kobo.299.1">'music, jazz, piano'</span></code><span class="koboSpan" id="kobo.300.1">, by joining them with </span><code class="inlineCode"><span class="koboSpan" id="kobo.301.1">','</span></code><span class="koboSpan" id="kobo.302.1"> as the </span><code class="inlineCode"><span class="koboSpan" id="kobo.303.1">join()</span></code><span class="koboSpan" id="kobo.304.1"> separator.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.305.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.306.1">http://127.0.0.1:8000/blog/</span></code><span class="koboSpan" id="kobo.307.1"> in your browser. </span><span class="koboSpan" id="kobo.307.2">You should be able to see the list of tags under each post title:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.308.1"><img alt="" role="presentation" src="../Images/B21088_03_06.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.309.1">Figure 3.6: The Post list item, including related tags</span></p>
<p class="normal"><span class="koboSpan" id="kobo.310.1">Next, we will edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.311.1">post_list</span></code><span class="koboSpan" id="kobo.312.1"> view to let users list all posts tagged with a specific tag.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.313.1">Open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.314.1">views.py</span></code><span class="koboSpan" id="kobo.315.1"> file of your </span><code class="inlineCode"><span class="koboSpan" id="kobo.316.1">blog</span></code><span class="koboSpan" id="kobo.317.1"> application, import</span><a id="_idIndexMarker266"/><span class="koboSpan" id="kobo.318.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.319.1">Tag</span></code><span class="koboSpan" id="kobo.320.1"> model from </span><code class="inlineCode"><span class="koboSpan" id="kobo.321.1">django-taggit</span></code><span class="koboSpan" id="kobo.322.1">, and change the </span><code class="inlineCode"><span class="koboSpan" id="kobo.323.1">post_list</span></code><span class="koboSpan" id="kobo.324.1"> view to</span><a id="_idIndexMarker267"/><span class="koboSpan" id="kobo.325.1"> optionally filter posts by a tag, as follows. </span><span class="koboSpan" id="kobo.325.2">New code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.326.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.327.1"> taggit.models </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.328.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.329.1"> Tag</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.330.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.331.1">post_list</span></span><span class="koboSpan" id="kobo.332.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.333.1">request</span></span><span class="code-highlight"><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.334.1">, tag_slug=</span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.335.1">None</span></strong></span><span class="koboSpan" id="kobo.336.1">):
    post_list = Post.published.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.337.1">all</span></span><span class="koboSpan" id="kobo.338.1">()
    </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.339.1">tag = </span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.340.1">None</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.341.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.342.1"> tag_slug:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.343.1">        tag = get_object_or_404(Tag, slug=tag_slug)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.344.1">        post_list = post_list.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.345.1">filter</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.346.1">(tags__in=[tag])</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.347.1"># Pagination with 3 posts per page</span></span><span class="koboSpan" id="kobo.348.1">
    paginator = Paginator(post_list, </span><span class="hljs-number"><span class="koboSpan" id="kobo.349.1">3</span></span><span class="koboSpan" id="kobo.350.1">)
    page_number = request.GET.get(</span><span class="hljs-string"><span class="koboSpan" id="kobo.351.1">'page'</span></span><span class="koboSpan" id="kobo.352.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.353.1">1</span></span><span class="koboSpan" id="kobo.354.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.355.1">try</span></span><span class="koboSpan" id="kobo.356.1">:
        posts = paginator.page(page_number)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.357.1">except</span></span><span class="koboSpan" id="kobo.358.1"> PageNotAnInteger:
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.359.1"># If page_number is not an integer get the first page</span></span><span class="koboSpan" id="kobo.360.1">
        posts = paginator.page(</span><span class="hljs-number"><span class="koboSpan" id="kobo.361.1">1</span></span><span class="koboSpan" id="kobo.362.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.363.1">except</span></span><span class="koboSpan" id="kobo.364.1"> EmptyPage:
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.365.1"># If page_number is out of range get last page of results</span></span><span class="koboSpan" id="kobo.366.1">
        posts = paginator.page(paginator.num_pages)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.367.1">return</span></span><span class="koboSpan" id="kobo.368.1"> render(
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.369.1">request,
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.370.1">'blog/post/list.html'</span></span><span class="koboSpan" id="kobo.371.1">,
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.372.1">{
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.373.1">'posts'</span></span><span class="koboSpan" id="kobo.374.1">: posts</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.375.1">,</span></strong></span>
<span class="hljs-keyword"> </span><span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.376.1">'</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.377.1">tag'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.378.1">: tag</span></strong></span><span class="koboSpan" id="kobo.379.1">
        }
    )
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.380.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.381.1">post_list</span></code><span class="koboSpan" id="kobo.382.1"> view now works as follows:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.383.1">It takes an optional </span><code class="inlineCode"><span class="koboSpan" id="kobo.384.1">tag_slug</span></code><span class="koboSpan" id="kobo.385.1"> parameter that has a </span><code class="inlineCode"><span class="koboSpan" id="kobo.386.1">None</span></code><span class="koboSpan" id="kobo.387.1"> default value. </span><span class="koboSpan" id="kobo.387.2">This parameter will be passed in the URL.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.388.1">Inside the view, we build the initial QuerySet, retrieving all published posts, and if there is a given tag slug, we get the </span><code class="inlineCode"><span class="koboSpan" id="kobo.389.1">Tag</span></code><span class="koboSpan" id="kobo.390.1"> object with the given slug using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.391.1">get_object_or_404()</span></code><span class="koboSpan" id="kobo.392.1"> shortcut.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.393.1">Then, we filter the list of posts by the ones that contain the given tag. </span><span class="koboSpan" id="kobo.393.2">Since this is a many-to-many relationship, we have to filter posts by tags contained in a given list, which, in this case, contains only one element. </span><span class="koboSpan" id="kobo.393.3">We use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.394.1">__in</span></code><span class="koboSpan" id="kobo.395.1"> field lookup. </span><span class="koboSpan" id="kobo.395.2">Many-to-many relationships occur when multiple objects of a model are associated with multiple objects of another model. </span><span class="koboSpan" id="kobo.395.3">In our application, a post can have multiple tags and a tag can be related to multiple posts. </span><span class="koboSpan" id="kobo.395.4">You will learn how</span><a id="_idIndexMarker268"/><span class="koboSpan" id="kobo.396.1"> to create many-to-many relationships in </span><em class="chapterRef"><span class="koboSpan" id="kobo.397.1">Chapter 6</span></em><span class="koboSpan" id="kobo.398.1">, </span><em class="italic"><span class="koboSpan" id="kobo.399.1">Sharing Content on Your Website</span></em><span class="koboSpan" id="kobo.400.1">. </span><span class="koboSpan" id="kobo.400.2">You can discover more about many-to-many relationships at </span><a href="https://docs.djangoproject.com/en/5.0/topics/db/examples/many_to_many/"><span class="url"><span class="koboSpan" id="kobo.401.1">https://docs.djangoproject.com/en/5.0/topics/db/examples/many_to_many/</span></span></a><span class="koboSpan" id="kobo.402.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.403.1">Finally, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.404.1">render()</span></code><span class="koboSpan" id="kobo.405.1"> function now passes the new </span><code class="inlineCode"><span class="koboSpan" id="kobo.406.1">tag</span></code><span class="koboSpan" id="kobo.407.1"> variable to the template.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.408.1">Remember that QuerySets </span><a id="_idIndexMarker269"/><span class="koboSpan" id="kobo.409.1">are lazy. </span><span class="koboSpan" id="kobo.409.2">The QuerySets to retrieve posts will only be evaluated when you loop over </span><code class="inlineCode"><span class="koboSpan" id="kobo.410.1">post_list</span></code><span class="koboSpan" id="kobo.411.1"> when rendering the template.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.412.1">Open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.413.1">urls.py</span></code><span class="koboSpan" id="kobo.414.1"> file of your </span><code class="inlineCode"><span class="koboSpan" id="kobo.415.1">blog</span></code><span class="koboSpan" id="kobo.416.1"> application, comment out the class-based </span><code class="inlineCode"><span class="koboSpan" id="kobo.417.1">PostListView</span></code><span class="koboSpan" id="kobo.418.1"> URL pattern, and uncomment the </span><code class="inlineCode"><span class="koboSpan" id="kobo.419.1">post_list</span></code><span class="koboSpan" id="kobo.420.1"> view, like this:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.421.1">path(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.422.1">''</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.423.1">, views.post_list, name=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.424.1">'post_list'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.425.1">),</span></strong></span>
<span class="code-highlight"><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.426.1">#</span></strong></span><span class="hljs-comment"><span class="koboSpan" id="kobo.427.1"> path('', views.PostListView.as_view(), name='post_list'),</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.428.1">Add the following additional URL pattern to list posts by tag:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.429.1">path(
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.430.1">'tag/&lt;slug:tag_slug&gt;/'</span></span><span class="koboSpan" id="kobo.431.1">, views.post_list, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.432.1">'post_list_by_tag'</span></span><span class="koboSpan" id="kobo.433.1">
    ),
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.434.1">As you can see, both patterns point to the same view, but they have different names. </span><span class="koboSpan" id="kobo.434.2">The first pattern will call the </span><code class="inlineCode"><span class="koboSpan" id="kobo.435.1">post_list</span></code><span class="koboSpan" id="kobo.436.1"> view without any optional parameters, whereas the second pattern will call the view with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.437.1">tag_slug</span></code><span class="koboSpan" id="kobo.438.1"> parameter. </span><span class="koboSpan" id="kobo.438.2">You use a </span><code class="inlineCode"><span class="koboSpan" id="kobo.439.1">slug</span></code><span class="koboSpan" id="kobo.440.1"> path converter to match the parameter as a lowercase string with ASCII letters or numbers, plus the hyphen and underscore characters.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.441.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.442.1">urls.py</span></code><span class="koboSpan" id="kobo.443.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.444.1">blog</span></code><span class="koboSpan" id="kobo.445.1"> application should now look like this:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.446.1">from</span></span><span class="koboSpan" id="kobo.447.1"> django.urls </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.448.1">import</span></span><span class="koboSpan" id="kobo.449.1"> path
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.450.1">from</span></span><span class="koboSpan" id="kobo.451.1"> . </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.452.1">import</span></span><span class="koboSpan" id="kobo.453.1"> views
app_name = </span><span class="hljs-string"><span class="koboSpan" id="kobo.454.1">'blog'</span></span><span class="koboSpan" id="kobo.455.1">
urlpatterns = [
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.456.1"># Post views</span></span><span class="koboSpan" id="kobo.457.1">
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.458.1">''</span></span><span class="koboSpan" id="kobo.459.1">, views.post_list, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.460.1">'post_list'</span></span><span class="koboSpan" id="kobo.461.1">),
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.462.1"># path('', views.PostListView.as_view(), name='post_list'),</span></span><span class="koboSpan" id="kobo.463.1">
    path(
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.464.1">'tag/&lt;slug:tag_slug&gt;/'</span></span><span class="koboSpan" id="kobo.465.1">, views.post_list, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.466.1">'post_list_by_tag'</span></span>
<span class="hljs-string"> </span><span class="koboSpan" id="kobo.467.1">),
    path(
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.468.1">'&lt;int:year&gt;/&lt;int:month&gt;/&lt;int:day&gt;/&lt;slug:post&gt;/'</span></span><span class="koboSpan" id="kobo.469.1">,
        views.post_detail,
        name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.470.1">'post_detail'</span></span>
<span class="hljs-string"> </span><span class="koboSpan" id="kobo.471.1">),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.472.1">'&lt;int:post_id&gt;/share/'</span></span><span class="koboSpan" id="kobo.473.1">, views.post_share, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.474.1">'post_share'</span></span><span class="koboSpan" id="kobo.475.1">),
    path(
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.476.1">'&lt;int:post_id&gt;/comment/'</span></span><span class="koboSpan" id="kobo.477.1">, views.post_comment, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.478.1">'post_comment'</span></span>
<span class="hljs-string"> </span><span class="koboSpan" id="kobo.479.1">),
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.480.1">Since you are using </span><a id="_idIndexMarker270"/><span class="koboSpan" id="kobo.481.1">the </span><code class="inlineCode"><span class="koboSpan" id="kobo.482.1">post_list</span></code><span class="koboSpan" id="kobo.483.1"> view, edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.484.1">blog/post/list.html</span></code><span class="koboSpan" id="kobo.485.1"> template</span><a id="_idIndexMarker271"/><span class="koboSpan" id="kobo.486.1"> and modify the pagination to use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.487.1">posts</span></code><span class="koboSpan" id="kobo.488.1"> object:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.489.1">{% include "pagination.html" with page=</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.490.1">posts</span></strong></span><span class="koboSpan" id="kobo.491.1"> %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.492.1">Add the following lines highlighted in bold to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.493.1">blog/post/list.html</span></code><span class="koboSpan" id="kobo.494.1"> template:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.495.1">{% extends "blog/base.html" %}
{% block title %}My Blog{% endblock %}
{% block content %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.496.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.497.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.498.1">&gt;</span></span><span class="koboSpan" id="kobo.499.1">My Blog</span><span class="hljs-tag"><span class="koboSpan" id="kobo.500.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.501.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.502.1">&gt;</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.503.1">  {% if tag %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.504.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.505.1">h2</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.506.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.507.1">Posts tagged with "{{ tag.name }}"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.508.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.509.1">h2</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.510.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.511.1">  {% endif %}</span></strong></span><span class="koboSpan" id="kobo.512.1">
  {% for post in posts %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.513.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.514.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.515.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.516.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.517.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.518.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.519.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.520.1">"{{ post.get_absolute_url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.521.1">&gt;</span></span><span class="koboSpan" id="kobo.522.1">
        {{ post.title }}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.523.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.524.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.525.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.526.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.527.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.528.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.529.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.530.1">p</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.531.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.532.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.533.1">"tags"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.534.1">&gt;</span></span><span class="koboSpan" id="kobo.535.1">Tags: {{ post.tags.all|join:", " }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.536.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.537.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.538.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.539.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.540.1">p</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.541.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.542.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.543.1">"date"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.544.1">&gt;</span></span><span class="koboSpan" id="kobo.545.1">
      Published {{ post.publish }} by {{ post.author }}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.546.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.547.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.548.1">&gt;</span></span><span class="koboSpan" id="kobo.549.1">
    {{ post.body|truncatewords:30|linebreaks }}
  {% endfor %}
  {% include "pagination.html" with page=posts %}
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.550.1">If a user is accessing the blog, they will </span><a id="_idIndexMarker272"/><span class="koboSpan" id="kobo.551.1">see the list of all posts. </span><span class="koboSpan" id="kobo.551.2">If they filter by posts tagged with a specific tag, they </span><a id="_idIndexMarker273"/><span class="koboSpan" id="kobo.552.1">will see the tag that they are filtering by.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.553.1">Now, edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.554.1">blog/post/list.html</span></code><span class="koboSpan" id="kobo.555.1"> template and change the way tags are displayed, as follows. </span><span class="koboSpan" id="kobo.555.2">New lines are highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.556.1">{% extends "blog/base.html" %}
{% block title %}My Blog{% endblock %}
{% block content %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.557.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.558.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.559.1">&gt;</span></span><span class="koboSpan" id="kobo.560.1">My Blog</span><span class="hljs-tag"><span class="koboSpan" id="kobo.561.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.562.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.563.1">&gt;</span></span><span class="koboSpan" id="kobo.564.1">
  {% if tag %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.565.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.566.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.567.1">&gt;</span></span><span class="koboSpan" id="kobo.568.1">Posts tagged with "{{ tag.name }}"</span><span class="hljs-tag"><span class="koboSpan" id="kobo.569.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.570.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.571.1">&gt;</span></span><span class="koboSpan" id="kobo.572.1">
  {% endif %}
  {% for post in posts %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.573.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.574.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.575.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.576.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.577.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.578.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.579.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.580.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.581.1">{{ post.get_absolute_url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.582.1">&gt;</span></span><span class="koboSpan" id="kobo.583.1">
        {{ post.title }}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.584.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.585.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.586.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.587.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.588.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.589.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.590.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.591.1">p</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.592.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.593.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.594.1">"tags"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.595.1">&gt;</span></span><span class="koboSpan" id="kobo.596.1">
      Tags:
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.597.1">      {% for tag in post.tags.all %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.598.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.599.1">a</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.600.1">href</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.601.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.602.1">"{% url "</span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.603.1">blog:post_list_by_tag</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.604.1">" </span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.605.1">tag.slug</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.606.1"> %}"&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.607.1">          {{ tag.name }}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.608.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.609.1">a</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.610.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.611.1">{% if not forloop.last %}, {% endif %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.612.1">      {% endfor %}</span></strong></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.613.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.614.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.615.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.616.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.617.1">p</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.618.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.619.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.620.1">"date"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.621.1">&gt;</span></span><span class="koboSpan" id="kobo.622.1">
      Published {{ post.publish }} by {{ post.author }}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.623.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.624.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.625.1">&gt;</span></span><span class="koboSpan" id="kobo.626.1">
    {{ post.body|truncatewords:30|linebreaks }}
  {% endfor %}
  {% include "pagination.html" with page=posts %}
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.627.1">In the preceding code, we loop through all the tags of a post displaying a custom link to the URL to filter posts by that tag. </span><span class="koboSpan" id="kobo.627.2">We build the URL with </span><code class="inlineCode"><span class="koboSpan" id="kobo.628.1">{% url "blog:post_list_by_tag" tag.slug %}</span></code><span class="koboSpan" id="kobo.629.1">, using the name of the URL and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.630.1">slug</span></code><span class="koboSpan" id="kobo.631.1"> tag as its parameter. </span><span class="koboSpan" id="kobo.631.2">You separate the tags with commas.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.632.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.633.1">http://127.0.0.1:8000/blog/tag/jazz/</span></code><span class="koboSpan" id="kobo.634.1"> in your </span><a id="_idIndexMarker274"/><span class="koboSpan" id="kobo.635.1">browser. </span><span class="koboSpan" id="kobo.635.2">You will </span><a id="_idIndexMarker275"/><span class="koboSpan" id="kobo.636.1">see the list of posts filtered by that tag, like this:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.637.1"><img alt="" role="presentation" src="../Images/B21088_03_07.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.638.1">Figure 3.7: A post filtered by the tag “jazz”</span></p>
<h1 class="heading-1" id="_idParaDest-116"><span class="koboSpan" id="kobo.639.1">Retrieving posts by similarity</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.640.1">Now that we have implemented tagging for </span><a id="_idIndexMarker276"/><span class="koboSpan" id="kobo.641.1">blog posts, you can do many interesting things with tags. </span><span class="koboSpan" id="kobo.641.2">Tags allow you to categorize posts in a non-hierarchical manner. </span><span class="koboSpan" id="kobo.641.3">Posts about similar topics will have several tags in common. </span><span class="koboSpan" id="kobo.641.4">We will build a functionality to display similar posts by the number of tags they share. </span><span class="koboSpan" id="kobo.641.5">In this way, when a user reads a post, we can suggest to them that they read other related posts.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.642.1">In order to retrieve similar </span><a id="_idIndexMarker277"/><span class="koboSpan" id="kobo.643.1">posts for a specific post, you need to perform the following steps:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.644.1">Retrieve all tags for the current post.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.645.1">Get all posts that are tagged with any of those tags.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.646.1">Exclude the current post from that list to avoid recommending the same post.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.647.1">Order the results by the number of tags shared with the current post.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.648.1">In the case of two or more posts with the same number of tags, recommend the most recent post.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.649.1">Limit the query to the number of posts you want to recommend.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.650.1">These steps are translated into a complex QuerySet. </span><span class="koboSpan" id="kobo.650.2">Let’s edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.651.1">post_detail</span></code><span class="koboSpan" id="kobo.652.1"> view to incorporate these similarity-based post suggestions.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.653.1">Open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.654.1">views.py</span></code><span class="koboSpan" id="kobo.655.1"> file of your </span><code class="inlineCode"><span class="koboSpan" id="kobo.656.1">blog</span></code><span class="koboSpan" id="kobo.657.1"> application and add the following import at the top of it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.658.1">from</span></span><span class="koboSpan" id="kobo.659.1"> django.db.models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.660.1">import</span></span><span class="koboSpan" id="kobo.661.1"> Count
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.662.1">This is the </span><code class="inlineCode"><span class="koboSpan" id="kobo.663.1">Count</span></code><span class="koboSpan" id="kobo.664.1"> aggregation function of the Django ORM. </span><span class="koboSpan" id="kobo.664.2">This function will allow you to perform aggregated counts of tags. </span><code class="inlineCode"><span class="koboSpan" id="kobo.665.1">django.db.models</span></code><span class="koboSpan" id="kobo.666.1"> includes the following aggregation functions:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.667.1">Avg</span></code><span class="koboSpan" id="kobo.668.1">: The mean value</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.669.1">Max</span></code><span class="koboSpan" id="kobo.670.1">: The maximum value</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.671.1">Min</span></code><span class="koboSpan" id="kobo.672.1">: The minimum value</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.673.1">Count</span></code><span class="koboSpan" id="kobo.674.1">: The total number of objects</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.675.1">You can learn about aggregation at </span><a href="https://docs.djangoproject.com/en/5.0/topics/db/aggregation/"><span class="url"><span class="koboSpan" id="kobo.676.1">https://docs.djangoproject.com/en/5.0/topics/db/aggregation/</span></span></a><span class="koboSpan" id="kobo.677.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.678.1">Open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.679.1">views.py</span></code><span class="koboSpan" id="kobo.680.1"> file of your </span><code class="inlineCode"><span class="koboSpan" id="kobo.681.1">blog</span></code><span class="koboSpan" id="kobo.682.1"> application and add the following lines to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.683.1">post_detail</span></code><span class="koboSpan" id="kobo.684.1"> view. </span><span class="koboSpan" id="kobo.684.2">New lines are highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.685.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.686.1">post_detail</span></span><span class="koboSpan" id="kobo.687.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.688.1">request, year, month, day, post</span></span><span class="koboSpan" id="kobo.689.1">):
    post = get_object_or_404(
        Post,
        status=Post.Status.PUBLISHED,
        slug=post,
        publish__year=year,
        publish__month=month,
        publish__day=day
    )
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.690.1"># List of active comments for this post</span></span><span class="koboSpan" id="kobo.691.1">
    comments = post.comments.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.692.1">filter</span></span><span class="koboSpan" id="kobo.693.1">(active=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.694.1">True</span></span><span class="koboSpan" id="kobo.695.1">)
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.696.1"># Form for users to comment</span></span><span class="koboSpan" id="kobo.697.1">
    form = CommentForm()
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.698.1"># List of similar posts</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.699.1">    post_tags_ids = post.tags.values_list(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.700.1">'id'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.701.1">, flat=</span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.702.1">True</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.703.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.704.1">    similar_posts = Post.published.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.705.1">filter</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.706.1">(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.707.1">        tags__in=post_tags_ids</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.708.1">    ).exclude(</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.709.1">id</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.710.1">=post.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.711.1">id</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.712.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.713.1">    similar_posts = similar_posts.annotate(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.714.1">        same_tags=Count(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.715.1">'tags'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.716.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.717.1">    ).order_by(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.718.1">'-same_tags'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.719.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.720.1">'-publish'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.721.1">)[:</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.722.1">4</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.723.1">]</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.724.1">return</span></span><span class="koboSpan" id="kobo.725.1"> render(
        request,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.726.1">'blog/post/detail.html'</span></span><span class="koboSpan" id="kobo.727.1">,
        {
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.728.1">'post'</span></span><span class="koboSpan" id="kobo.729.1">: post,
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.730.1">'comments'</span></span><span class="koboSpan" id="kobo.731.1">: comments,
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.732.1">'form'</span></span><span class="koboSpan" id="kobo.733.1">: form</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.734.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.735.1">'similar_posts'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.736.1">: similar_posts</span></strong></span><span class="koboSpan" id="kobo.737.1">
        }
    )
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.738.1">The preceding code is as follows:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.739.1">You retrieve a</span><a id="_idIndexMarker278"/><span class="koboSpan" id="kobo.740.1"> Python list of IDs for the tags of the current post. </span><span class="koboSpan" id="kobo.740.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.741.1">values_list()</span></code><span class="koboSpan" id="kobo.742.1"> QuerySet returns tuples with the values for the given fields. </span><span class="koboSpan" id="kobo.742.2">You pass </span><code class="inlineCode"><span class="koboSpan" id="kobo.743.1">flat=True</span></code><span class="koboSpan" id="kobo.744.1"> to it to get single values such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.745.1">[1, 2, 3, ...]</span></code><span class="koboSpan" id="kobo.746.1"> instead of one tuple such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.747.1">[(1,), (2,), (3,) ...]</span></code><span class="koboSpan" id="kobo.748.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.749.1">You get all posts that contain any of these tags, excluding the current post itself.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.750.1">You use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.751.1">Count</span></code><span class="koboSpan" id="kobo.752.1"> aggregation function to generate a calculated field—</span><code class="inlineCode"><span class="koboSpan" id="kobo.753.1">same_tags</span></code><span class="koboSpan" id="kobo.754.1">—that contains the number of tags shared with all the tags queried.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.755.1">You order the result by the number of shared tags (descending order) and by </span><code class="inlineCode"><span class="koboSpan" id="kobo.756.1">publish</span></code><span class="koboSpan" id="kobo.757.1"> to display recent posts first for the posts with the same number of shared tags. </span><span class="koboSpan" id="kobo.757.2">You slice the result to retrieve only the first four posts.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.758.1">You pass the </span><code class="inlineCode"><span class="koboSpan" id="kobo.759.1">similar_posts</span></code><span class="koboSpan" id="kobo.760.1"> object to the context dictionary for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.761.1">render()</span></code><span class="koboSpan" id="kobo.762.1"> function.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.763.1">Now, edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.764.1">blog/post/detail.html</span></code><span class="koboSpan" id="kobo.765.1"> template</span><a id="_idIndexMarker279"/><span class="koboSpan" id="kobo.766.1"> and add the following code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.767.1">{% extends "blog/base.html" %}
{% block title %}{{ post.title }}{% endblock %}
{% block content %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.768.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.769.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.770.1">&gt;</span></span><span class="koboSpan" id="kobo.771.1">{{ post.title }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.772.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.773.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.774.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.775.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.776.1">p</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.777.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.778.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.779.1">"date"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.780.1">&gt;</span></span><span class="koboSpan" id="kobo.781.1">
    Published {{ post.publish }} by {{ post.author }}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.782.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.783.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.784.1">&gt;</span></span><span class="koboSpan" id="kobo.785.1">
  {{ post.body|linebreaks }}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.786.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.787.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.788.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.789.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.790.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.791.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.792.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.793.1">"{% url "</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.794.1">blog:post_share</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.795.1">" </span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.796.1">post.id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.797.1"> %}"&gt;</span></span><span class="koboSpan" id="kobo.798.1">
      Share this post
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.799.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.800.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.801.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.802.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.803.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.804.1">&gt;</span></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.805.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.806.1">h2</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.807.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.808.1">Similar posts</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.809.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.810.1">h2</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.811.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.812.1">  {% for post in similar_posts %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.813.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.814.1">p</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.815.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.816.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.817.1">a</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.818.1">href</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.819.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.820.1">"{{ post.get_absolute_url }}"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.821.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.822.1">{{ post.title }}</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.823.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.824.1">a</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.825.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.826.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.827.1">p</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.828.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.829.1">  {% empty %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.830.1">    There are no similar posts yet.</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.831.1">  {% endfor %}</span></strong></span><span class="koboSpan" id="kobo.832.1">
  {% with comments.count as total_comments %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.833.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.834.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.835.1">&gt;</span></span><span class="koboSpan" id="kobo.836.1">
      {{ total_comments }} comment{{ total_comments|pluralize }}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.837.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.838.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.839.1">&gt;</span></span><span class="koboSpan" id="kobo.840.1">
  {% endwith %}
  {% for comment in comments %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.841.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.842.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.843.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.844.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.845.1">"comment"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.846.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.847.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.848.1">p</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.849.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.850.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.851.1">"info"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.852.1">&gt;</span></span><span class="koboSpan" id="kobo.853.1">
        Comment {{ forloop.counter }} by {{ comment.name }}
        {{ comment.created }}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.854.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.855.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.856.1">&gt;</span></span><span class="koboSpan" id="kobo.857.1">
      {{ comment.body|linebreaks }}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.858.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.859.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.860.1">&gt;</span></span><span class="koboSpan" id="kobo.861.1">
  {% empty %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.862.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.863.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.864.1">&gt;</span></span><span class="koboSpan" id="kobo.865.1">There are no comments yet.</span><span class="hljs-tag"><span class="koboSpan" id="kobo.866.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.867.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.868.1">&gt;</span></span><span class="koboSpan" id="kobo.869.1">
  {% endfor %}
  {% include "blog/post/includes/comment_form.html" %}
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.870.1">The post detail page should look like this:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.871.1"><img alt="" role="presentation" src="../Images/B21088_03_08.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.872.1">Figure 3.8: The post detail page, including a list of similar posts</span></p>
<p class="normal"><span class="koboSpan" id="kobo.873.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.874.1">http://127.0.0.1:8000/admin/blog/post/</span></code><span class="koboSpan" id="kobo.875.1"> in your </span><a id="_idIndexMarker280"/><span class="koboSpan" id="kobo.876.1">browser, edit a post that has no tags, and add the </span><code class="inlineCode"><span class="koboSpan" id="kobo.877.1">music</span></code><span class="koboSpan" id="kobo.878.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.879.1">jazz</span></code><span class="koboSpan" id="kobo.880.1"> tags, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.881.1"><img alt="" role="presentation" src="../Images/B21088_03_09.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.882.1">Figure 3.9: Adding the “jazz” and “music” tags to a post</span></p>
<p class="normal"><span class="koboSpan" id="kobo.883.1">Edit another post </span><a id="_idIndexMarker281"/><span class="koboSpan" id="kobo.884.1">and add the </span><code class="inlineCode"><span class="koboSpan" id="kobo.885.1">jazz</span></code><span class="koboSpan" id="kobo.886.1"> tag, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.887.1"><img alt="" role="presentation" src="../Images/B21088_03_10.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.888.1">Figure 3.10: Adding the “jazz” tag to a post</span></p>
<p class="normal"><span class="koboSpan" id="kobo.889.1">The post detail page for</span><a id="_idIndexMarker282"/><span class="koboSpan" id="kobo.890.1"> the first post should now look like this:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.891.1"><img alt="" role="presentation" src="../Images/B21088_03_11.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.892.1">Figure 3.11: The post detail page, including a list of similar posts</span></p>
<p class="normal"><span class="koboSpan" id="kobo.893.1">The posts </span><a id="_idIndexMarker283"/><span class="koboSpan" id="kobo.894.1">recommended in the </span><strong class="screenText"><span class="koboSpan" id="kobo.895.1">Similar posts</span></strong><span class="koboSpan" id="kobo.896.1"> section of the page appear in descending order based on the number of shared tags with the original post.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.897.1">We are now able to successfully recommend similar posts to readers. </span><code class="inlineCode"><span class="koboSpan" id="kobo.898.1">django-taggit</span></code><span class="koboSpan" id="kobo.899.1"> also includes a </span><code class="inlineCode"><span class="koboSpan" id="kobo.900.1">similar_objects()</span></code><span class="koboSpan" id="kobo.901.1"> manager that you can use to retrieve objects by shared tags. </span><span class="koboSpan" id="kobo.901.2">You can take a look at all </span><code class="inlineCode"><span class="koboSpan" id="kobo.902.1">django-taggit</span></code><span class="koboSpan" id="kobo.903.1"> managers at </span><a href="https://django-taggit.readthedocs.io/en/latest/api.html"><span class="url"><span class="koboSpan" id="kobo.904.1">https://django-taggit.readthedocs.io/en/latest/api.html</span></span></a><span class="koboSpan" id="kobo.905.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.906.1">You can also add the list of tags to your post detail template in the same way as you did in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.907.1">blog/post/list.html</span></code><span class="koboSpan" id="kobo.908.1"> template.</span></p>
<h1 class="heading-1" id="_idParaDest-117"><span class="koboSpan" id="kobo.909.1">Creating custom template tags and filters</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.910.1">Django offers a variety</span><a id="_idIndexMarker284"/><span class="koboSpan" id="kobo.911.1"> of built-in template tags, such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.912.1">{% if %}</span></code><span class="koboSpan" id="kobo.913.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.914.1">{% block %}</span></code><span class="koboSpan" id="kobo.915.1">. </span><span class="koboSpan" id="kobo.915.2">You used different template tags in </span><em class="chapterRef"><span class="koboSpan" id="kobo.916.1">Chapter 1</span></em><span class="koboSpan" id="kobo.917.1">, </span><em class="italic"><span class="koboSpan" id="kobo.918.1">Building a Blog Application</span></em><span class="koboSpan" id="kobo.919.1">, and </span><em class="italic"><span class="koboSpan" id="kobo.920.1">Chapter 2</span></em><span class="koboSpan" id="kobo.921.1">, </span><em class="italic"><span class="koboSpan" id="kobo.922.1">Enhancing Your Blog with Advanced Features</span></em><span class="koboSpan" id="kobo.923.1">. </span><span class="koboSpan" id="kobo.923.2">You can find a complete reference of built-in template tags and filters at </span><a href="https://docs.djangoproject.com/en/5.0/ref/templates/builtins/"><span class="url"><span class="koboSpan" id="kobo.924.1">https://docs.djangoproject.com/en/5.0/ref/templates/builtins/</span></span></a><span class="koboSpan" id="kobo.925.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.926.1">Django also allows you to create your own template tags to perform custom actions. </span><span class="koboSpan" id="kobo.926.2">Custom template tags come in very handy when you need to add a functionality to your templates that is not covered by the core set of Django template tags. </span><span class="koboSpan" id="kobo.926.3">This can be a tag to execute a QuerySet or any server-side processing that you want to reuse across templates. </span><span class="koboSpan" id="kobo.926.4">For example, we could build a template tag to display a list of the latest posts published on the blog. </span><span class="koboSpan" id="kobo.926.5">We </span><a id="_idIndexMarker285"/><span class="koboSpan" id="kobo.927.1">could include this list in the sidebar so that it is always visible, regardless of the view that processes the request.</span></p>
<h2 class="heading-2" id="_idParaDest-118"><span class="koboSpan" id="kobo.928.1">Implementing custom template tags</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.929.1">Django provides the </span><a id="_idIndexMarker286"/><span class="koboSpan" id="kobo.930.1">following helper functions, which allow you to easily create template tags:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.931.1">simple_tag</span></code><span class="koboSpan" id="kobo.932.1">: Processes the given data and returns a string</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.933.1">inclusion_tag</span></code><span class="koboSpan" id="kobo.934.1">: Processes the given data and returns a rendered template</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.935.1">Template tags must live inside Django applications.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.936.1">Inside your </span><code class="inlineCode"><span class="koboSpan" id="kobo.937.1">blog</span></code><span class="koboSpan" id="kobo.938.1"> application directory, create a new directory, name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.939.1">templatetags</span></code><span class="koboSpan" id="kobo.940.1">, and add an empty </span><code class="inlineCode"><span class="koboSpan" id="kobo.941.1">__init__.py</span></code><span class="koboSpan" id="kobo.942.1"> file to it. </span><span class="koboSpan" id="kobo.942.2">Create another file in the same folder and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.943.1">blog_tags.py</span></code><span class="koboSpan" id="kobo.944.1">. </span><span class="koboSpan" id="kobo.944.2">The file structure of the blog application should look like the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.945.1">blog/
    __init__.py
    models.py
    ...
    </span><span class="code-highlight"><strong class="hljs-con-slc"><span class="koboSpan" id="kobo.946.1">templatetags/</span></strong></span>
<span class="code-highlight"><strong class="hljs-con-slc"><span class="koboSpan" id="kobo.947.1">__init__.py</span></strong></span>
<span class="code-highlight"><strong class="hljs-con-slc"><span class="koboSpan" id="kobo.948.1">blog_tags.py</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.949.1">The way you name the file is important because you will use the name of this module to load tags in templates.</span></p>
<h2 class="heading-2" id="_idParaDest-119"><span class="koboSpan" id="kobo.950.1">Creating a simple template tag</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.951.1">Let’s start by creating a</span><a id="_idIndexMarker287"/><span class="koboSpan" id="kobo.952.1"> simple tag to retrieve the total posts that have been published on the blog.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.953.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.954.1">templatetags/blog_tags.py</span></code><span class="koboSpan" id="kobo.955.1"> file you just created and add the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.956.1">from</span></span><span class="koboSpan" id="kobo.957.1"> django </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.958.1">import</span></span><span class="koboSpan" id="kobo.959.1"> template
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.960.1">from</span></span><span class="koboSpan" id="kobo.961.1"> ..models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.962.1">import</span></span><span class="koboSpan" id="kobo.963.1"> Post
register = template.Library()
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.964.1">@register.simple_tag</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.965.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.966.1">total_posts</span></span><span class="koboSpan" id="kobo.967.1">():
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.968.1">return</span></span><span class="koboSpan" id="kobo.969.1"> Post.published.count()
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.970.1">We have created a simple template tag that returns the number of posts published on the blog.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.971.1">Each module that contains template tags needs to define a variable called </span><code class="inlineCode"><span class="koboSpan" id="kobo.972.1">register</span></code><span class="koboSpan" id="kobo.973.1"> to be a valid tag library. </span><span class="koboSpan" id="kobo.973.2">This variable is an instance of </span><code class="inlineCode"><span class="koboSpan" id="kobo.974.1">template.Library</span></code><span class="koboSpan" id="kobo.975.1">, and it’s used to register the template tags and filters of the application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.976.1">In the preceding code, we have defined a tag called </span><code class="inlineCode"><span class="koboSpan" id="kobo.977.1">total_posts</span></code><span class="koboSpan" id="kobo.978.1"> with a simple Python function. </span><span class="koboSpan" id="kobo.978.2">We have added </span><a id="_idIndexMarker288"/><span class="koboSpan" id="kobo.979.1">the </span><code class="inlineCode"><span class="koboSpan" id="kobo.980.1">@register.simple_tag</span></code><span class="koboSpan" id="kobo.981.1"> decorator to the function, to register it as a simple tag. </span><span class="koboSpan" id="kobo.981.2">Django will use the function’s name as the tag name. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.982.1">If you want to register it using a different name, you can do so by specifying a </span><code class="inlineCode"><span class="koboSpan" id="kobo.983.1">name</span></code><span class="koboSpan" id="kobo.984.1"> attribute, such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.985.1">@register.simple_tag(name='my_tag')</span></code><span class="koboSpan" id="kobo.986.1">.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.987.1">After adding a new template tags module, you will need to restart the Django development server in order to use the new tags and filters in templates.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.988.1">Before using custom template tags, we have to make them available for the template using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.989.1">{% load %}</span></code><span class="koboSpan" id="kobo.990.1"> tag. </span><span class="koboSpan" id="kobo.990.2">As mentioned before, we need to use the name of the Python module containing our template tags and filters.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.991.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.992.1">blog/templates/base.html</span></code><span class="koboSpan" id="kobo.993.1"> template and add </span><code class="inlineCode"><span class="koboSpan" id="kobo.994.1">{% load blog_tags %}</span></code><span class="koboSpan" id="kobo.995.1"> at the top of it to load your template tags module. </span><span class="koboSpan" id="kobo.995.2">Then, use the tag you created to display your total posts, as follows. </span><span class="koboSpan" id="kobo.995.3">The new lines are highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.996.1">{% load blog_tags %}</span></strong></span><span class="koboSpan" id="kobo.997.1">
{% load static %}
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.998.1">&lt;!DOCTYPE </span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.999.1">html</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.1000.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1001.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1002.1">html</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1003.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1004.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1005.1">head</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1006.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1007.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1008.1">title</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1009.1">&gt;</span></span><span class="koboSpan" id="kobo.1010.1">{% block title %}{% endblock %}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1011.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1012.1">title</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1013.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1014.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1015.1">link</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1016.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1017.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1018.1">"{% static "</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1019.1">css</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1020.1">/</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1021.1">blog.css</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1022.1">" %}" </span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1023.1">rel</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1024.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1025.1">"stylesheet"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1026.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1027.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1028.1">head</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1029.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1030.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1031.1">body</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1032.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1033.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1034.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1035.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1036.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1037.1">"content"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1038.1">&gt;</span></span><span class="koboSpan" id="kobo.1039.1">
    {% block content %}
    {% endblock %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1040.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1041.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1042.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1043.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1044.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1045.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1046.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1047.1">"sidebar"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1048.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1049.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1050.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1051.1">&gt;</span></span><span class="koboSpan" id="kobo.1052.1">My blog</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1053.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1054.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1055.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1056.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1057.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1058.1">&gt;</span></span><span class="koboSpan" id="kobo.1059.1">
      This is my blog.
      </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1060.1">I've written {% total_posts %} posts so far.</span></strong></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1061.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1062.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1063.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1064.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1065.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1066.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1067.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1068.1">body</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1069.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1070.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1071.1">html</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1072.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1073.1">You will need to restart the </span><a id="_idIndexMarker289"/><span class="koboSpan" id="kobo.1074.1">server to keep track of the new files added to the project. </span><span class="koboSpan" id="kobo.1074.2">Stop the development server with </span><em class="italic"><span class="koboSpan" id="kobo.1075.1">Ctrl</span></em><span class="koboSpan" id="kobo.1076.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.1077.1">C</span></em><span class="koboSpan" id="kobo.1078.1"> and run it again using the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1079.1">python manage.py runserver
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1080.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.1081.1">http://127.0.0.1:8000/blog/</span></code><span class="koboSpan" id="kobo.1082.1"> in your browser. </span><span class="koboSpan" id="kobo.1082.2">You should see the total number of posts in the sidebar of the site, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1083.1"><img alt="" role="presentation" src="../Images/B21088_03_12.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1084.1">Figure 3.12: The total posts published included in the sidebar</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1085.1">If you see the following error message, it’s very likely you didn’t restart the development server:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1086.1"><img alt="" role="presentation" src="../Images/B21088_03_13.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1087.1">Figure 3.13: The error message when a template tag library is not registered</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1088.1">Template tags allow you to </span><a id="_idIndexMarker290"/><span class="koboSpan" id="kobo.1089.1">process any data and add it to any template regardless of the view executed. </span><span class="koboSpan" id="kobo.1089.2">You can perform QuerySets or process any data to display results in your templates.</span></p>
<h2 class="heading-2" id="_idParaDest-120"><span class="koboSpan" id="kobo.1090.1">Creating an inclusion template tag</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1091.1">We will create another tag to display the latest posts in the sidebar of the blog. </span><span class="koboSpan" id="kobo.1091.2">This time, we will implement an inclusion </span><a id="_idIndexMarker291"/><span class="koboSpan" id="kobo.1092.1">tag. </span><span class="koboSpan" id="kobo.1092.2">Using an inclusion tag, you can render a template with context variables returned by your template tag.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1093.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1094.1">templatetags/blog_tags.py</span></code><span class="koboSpan" id="kobo.1095.1"> file and add the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.1096.1">@register.inclusion_tag(</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1097.1">'blog/post/latest_posts.html'</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.1098.1">)</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1099.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1100.1">show_latest_posts</span></span><span class="koboSpan" id="kobo.1101.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1102.1">count=</span></span><span class="hljs-number"><span class="koboSpan" id="kobo.1103.1">5</span></span><span class="koboSpan" id="kobo.1104.1">):
    latest_posts = Post.published.order_by(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1105.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1106.1">-publish'</span></span><span class="koboSpan" id="kobo.1107.1">)[:count]
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1108.1">return</span></span><span class="koboSpan" id="kobo.1109.1"> {</span><span class="hljs-string"><span class="koboSpan" id="kobo.1110.1">'latest_posts'</span></span><span class="koboSpan" id="kobo.1111.1">: latest_posts}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1112.1">In the preceding code, we have registered the template tag using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1113.1">@register.inclusion_tag</span></code><span class="koboSpan" id="kobo.1114.1"> decorator. </span><span class="koboSpan" id="kobo.1114.2">We have specified the template that will be rendered with the returned values using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1115.1">blog/post/latest_posts.html</span></code><span class="koboSpan" id="kobo.1116.1">. </span><span class="koboSpan" id="kobo.1116.2">The template tag will accept an optional </span><code class="inlineCode"><span class="koboSpan" id="kobo.1117.1">count</span></code><span class="koboSpan" id="kobo.1118.1"> parameter that defaults to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1119.1">5</span></code><span class="koboSpan" id="kobo.1120.1">. </span><span class="koboSpan" id="kobo.1120.2">This parameter will allow us to specify the number of posts to display. </span><span class="koboSpan" id="kobo.1120.3">We use this variable to limit the results of the query </span><code class="inlineCode"><span class="koboSpan" id="kobo.1121.1">Post.published.order_by('-publish')[:count]</span></code><span class="koboSpan" id="kobo.1122.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1123.1">Note that the function returns a dictionary of variables instead of a simple value. </span><span class="koboSpan" id="kobo.1123.2">Inclusion tags have to return a dictionary of values, which is used as the context to render the specified template. </span><span class="koboSpan" id="kobo.1123.3">The template tag we just created allows us to specify the optional number of </span><a id="_idIndexMarker292"/><span class="koboSpan" id="kobo.1124.1">posts to display as </span><code class="inlineCode"><span class="koboSpan" id="kobo.1125.1">{% show_latest_posts 3 %}</span></code><span class="koboSpan" id="kobo.1126.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1127.1">Now, create a new template file under </span><code class="inlineCode"><span class="koboSpan" id="kobo.1128.1">blog/post/</span></code><span class="koboSpan" id="kobo.1129.1"> and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.1130.1">latest_posts.html</span></code><span class="koboSpan" id="kobo.1131.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1132.1">Edit the new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1133.1">blog/post/latest_posts.html</span></code><span class="koboSpan" id="kobo.1134.1"> template and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.1135.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1136.1">ul</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1137.1">&gt;</span></span><span class="koboSpan" id="kobo.1138.1">
  {% for post in latest_posts %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1139.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1140.1">li</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1141.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1142.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1143.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1144.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1145.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1146.1">"{{ post.get_absolute_url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1147.1">&gt;</span></span><span class="koboSpan" id="kobo.1148.1">{{ post.title }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1149.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1150.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1151.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1152.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1153.1">li</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1154.1">&gt;</span></span><span class="koboSpan" id="kobo.1155.1">
  {% endfor %}
</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1156.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1157.1">ul</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1158.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1159.1">In the preceding code, you have added an unordered list of posts using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1160.1">latest_posts</span></code><span class="koboSpan" id="kobo.1161.1"> variable returned by your template tag. </span><span class="koboSpan" id="kobo.1161.2">Now, edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1162.1">blog/base.html</span></code><span class="koboSpan" id="kobo.1163.1"> template and add the new template tag to display the last three posts, as follows. </span><span class="koboSpan" id="kobo.1163.2">The new lines are highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1164.1">{% load blog_tags %}
{% load static %}
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.1165.1">&lt;!DOCTYPE </span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1166.1">html</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.1167.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1168.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1169.1">html</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1170.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1171.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1172.1">head</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1173.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1174.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1175.1">title</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1176.1">&gt;</span></span><span class="koboSpan" id="kobo.1177.1">{% block title %}{% endblock %}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1178.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1179.1">title</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1180.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1181.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1182.1">link</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1183.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1184.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1185.1">"{% static "</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1186.1">css</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1187.1">/</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1188.1">blog.css</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1189.1">" %}" </span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1190.1">rel</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1191.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1192.1">"stylesheet"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1193.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1194.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1195.1">head</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1196.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1197.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1198.1">body</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1199.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1200.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1201.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1202.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1203.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1204.1">"content"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1205.1">&gt;</span></span><span class="koboSpan" id="kobo.1206.1">
    {% block content %}
    {% endblock %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1207.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1208.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1209.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1210.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1211.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1212.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1213.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1214.1">"sidebar"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1215.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1216.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1217.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1218.1">&gt;</span></span><span class="koboSpan" id="kobo.1219.1">My blog</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1220.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1221.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1222.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1223.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1224.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1225.1">&gt;</span></span><span class="koboSpan" id="kobo.1226.1">
      This is my blog.
      </span><span class="koboSpan" id="kobo.1226.2">I've written {% total_posts %} posts so far.
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1227.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1228.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1229.1">&gt;</span></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1230.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1231.1">h3</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1232.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1233.1">Latest posts</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1234.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1235.1">h3</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1236.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1237.1">    {% show_latest_posts 3 %}</span></strong></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1238.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1239.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1240.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1241.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1242.1">body</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1243.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1244.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1245.1">html</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1246.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1247.1">The template tag is called, passing the number of posts to display, and the template is rendered in place with the given context.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1248.1">Next, return to your </span><a id="_idIndexMarker293"/><span class="koboSpan" id="kobo.1249.1">browser and refresh the page. </span><span class="koboSpan" id="kobo.1249.2">The sidebar should now look like this:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1250.1"><img alt="" role="presentation" src="../Images/B21088_03_14.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1251.1">Figure 3.14: The blog sidebar, including the latest published posts</span></p>
<h2 class="heading-2" id="_idParaDest-121"><span class="koboSpan" id="kobo.1252.1">Creating a template tag that returns a QuerySet</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1253.1">Finally, we will create a simple template tag that returns a value. </span><span class="koboSpan" id="kobo.1253.2">We will store the result in a variable that can be</span><a id="_idIndexMarker294"/><span class="koboSpan" id="kobo.1254.1"> reused, rather than outputting it directly. </span><span class="koboSpan" id="kobo.1254.2">We will create a tag to display the most commented posts.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1255.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1256.1">templatetags/blog_tags.py</span></code><span class="koboSpan" id="kobo.1257.1"> file and add the following import and template tag to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1258.1">from</span></span><span class="koboSpan" id="kobo.1259.1"> django.db.models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1260.1">import</span></span><span class="koboSpan" id="kobo.1261.1"> Count
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.1262.1">@register.simple_tag</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1263.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1264.1">get_most_commented_posts</span></span><span class="koboSpan" id="kobo.1265.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1266.1">count=</span></span><span class="hljs-number"><span class="koboSpan" id="kobo.1267.1">5</span></span><span class="koboSpan" id="kobo.1268.1">):
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1269.1">return</span></span><span class="koboSpan" id="kobo.1270.1"> Post.published.annotate(
        total_comments=Count(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1271.1">'comments'</span></span><span class="koboSpan" id="kobo.1272.1">)
    ).order_by(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1273.1">'-total_comments'</span></span><span class="koboSpan" id="kobo.1274.1">)[:count]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1275.1">In the preceding template tag, you build a QuerySet using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1276.1">annotate()</span></code><span class="koboSpan" id="kobo.1277.1"> function to aggregate the total number of comments for each post. </span><span class="koboSpan" id="kobo.1277.2">You use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1278.1">Count</span></code><span class="koboSpan" id="kobo.1279.1"> aggregation function to store the number of comments in the computed </span><code class="inlineCode"><span class="koboSpan" id="kobo.1280.1">total_comments</span></code><span class="koboSpan" id="kobo.1281.1"> field for each </span><code class="inlineCode"><span class="koboSpan" id="kobo.1282.1">Post</span></code><span class="koboSpan" id="kobo.1283.1"> object. </span><span class="koboSpan" id="kobo.1283.2">You order the QuerySet by the computed field in descending order. </span><span class="koboSpan" id="kobo.1283.3">You also provide an optional </span><code class="inlineCode"><span class="koboSpan" id="kobo.1284.1">count</span></code><span class="koboSpan" id="kobo.1285.1"> variable to limit the total number of objects returned.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1286.1">In addition to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1287.1">Count</span></code><span class="koboSpan" id="kobo.1288.1">, Django</span><a id="_idIndexMarker295"/><span class="koboSpan" id="kobo.1289.1"> offers the aggregation functions </span><code class="inlineCode"><span class="koboSpan" id="kobo.1290.1">Avg</span></code><span class="koboSpan" id="kobo.1291.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1292.1">Max</span></code><span class="koboSpan" id="kobo.1293.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1294.1">Min</span></code><span class="koboSpan" id="kobo.1295.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1296.1">Sum</span></code><span class="koboSpan" id="kobo.1297.1">. </span><span class="koboSpan" id="kobo.1297.2">You can read more about aggregation functions at </span><a href="https://docs.djangoproject.com/en/5.0/topics/db/aggregation/"><span class="url"><span class="koboSpan" id="kobo.1298.1">https://docs.djangoproject.com/en/5.0/topics/db/aggregation/</span></span></a><span class="koboSpan" id="kobo.1299.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1300.1">Next, edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1301.1">blog/base.html</span></code><span class="koboSpan" id="kobo.1302.1"> template and add the following code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1303.1">{% load blog_tags %}
{% load static %}
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.1304.1">&lt;!DOCTYPE </span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1305.1">html</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.1306.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1307.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1308.1">html</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1309.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1310.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1311.1">head</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1312.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1313.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1314.1">title</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1315.1">&gt;</span></span><span class="koboSpan" id="kobo.1316.1">{% block title %}{% endblock %}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1317.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1318.1">title</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1319.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1320.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1321.1">link</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1322.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1323.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1324.1">"{% static "</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1325.1">css</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1326.1">/</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1327.1">blog.css</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1328.1">" %}" </span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1329.1">rel</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1330.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1331.1">"stylesheet"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1332.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1333.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1334.1">head</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1335.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1336.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1337.1">body</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1338.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1339.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1340.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1341.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1342.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1343.1">"content"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1344.1">&gt;</span></span><span class="koboSpan" id="kobo.1345.1">
    {% block content %}
    {% endblock %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1346.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1347.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1348.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1349.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1350.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1351.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1352.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1353.1">"sidebar"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1354.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1355.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1356.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1357.1">&gt;</span></span><span class="koboSpan" id="kobo.1358.1">My blog</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1359.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1360.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1361.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1362.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1363.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1364.1">&gt;</span></span><span class="koboSpan" id="kobo.1365.1">
      This is my blog.
      </span><span class="koboSpan" id="kobo.1365.2">I've written {% total_posts %} posts so far.
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1366.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1367.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1368.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1369.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1370.1">h3</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1371.1">&gt;</span></span><span class="koboSpan" id="kobo.1372.1">Latest posts</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1373.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1374.1">h3</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1375.1">&gt;</span></span><span class="koboSpan" id="kobo.1376.1">
    {% show_latest_posts 3 %}
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1377.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1378.1">h3</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1379.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1380.1">Most commented posts</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1381.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1382.1">h3</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1383.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1384.1">    {% get_most_commented_posts as most_commented_posts %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1385.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1386.1">ul</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1387.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1388.1">      {% for post in most_commented_posts %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1389.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1390.1">li</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1391.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1392.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1393.1">a</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1394.1">href</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1395.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1396.1">"{{ post.get_absolute_url }}"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1397.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1398.1">{{ post.title }}</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1399.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1400.1">a</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1401.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1402.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1403.1">li</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1404.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1405.1">      {% endfor %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1406.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1407.1">ul</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1408.1">&gt;</span></strong></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1409.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1410.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1411.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1412.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1413.1">body</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1414.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1415.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1416.1">html</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1417.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1418.1">In the preceding code, we store the result in a custom variable using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1419.1">as</span></code><span class="koboSpan" id="kobo.1420.1"> argument followed by the variable name. </span><span class="koboSpan" id="kobo.1420.2">For the </span><a id="_idIndexMarker296"/><span class="koboSpan" id="kobo.1421.1">template tag, we use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1422.1">{% get_most_commented_posts as most_commented_posts %}</span></code><span class="koboSpan" id="kobo.1423.1"> to store the result of the template tag in a new variable named </span><code class="inlineCode"><span class="koboSpan" id="kobo.1424.1">most_commented_posts</span></code><span class="koboSpan" id="kobo.1425.1">. </span><span class="koboSpan" id="kobo.1425.2">Then, we display the returned posts using an HTML unordered list element.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1426.1">Now open your browser and refresh the page to see the final result. </span><span class="koboSpan" id="kobo.1426.2">It should look like the following:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1427.1"><img alt="" role="presentation" src="../Images/B21088_03_15.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1428.1">Figure 3.15: The post list view, including the complete sidebar with the latest and most commented posts</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1429.1">You now have a clear </span><a id="_idIndexMarker297"/><span class="koboSpan" id="kobo.1430.1">idea of how to build custom template tags. </span><span class="koboSpan" id="kobo.1430.2">You can read more about them at </span><a href="https://docs.djangoproject.com/en/5.0/howto/custom-template-tags/"><span class="url"><span class="koboSpan" id="kobo.1431.1">https://docs.djangoproject.com/en/5.0/howto/custom-template-tags/</span></span></a><span class="koboSpan" id="kobo.1432.1">.</span></p>
<h2 class="heading-2" id="_idParaDest-122"><span class="koboSpan" id="kobo.1433.1">Implementing custom template filters</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1434.1">Django has a variety of built-in template filters that allow you to alter variables in templates. </span><span class="koboSpan" id="kobo.1434.2">These are Python</span><a id="_idIndexMarker298"/><span class="koboSpan" id="kobo.1435.1"> functions that take one or two parameters, the value of the variable that the filter is applied to, and an optional argument. </span><span class="koboSpan" id="kobo.1435.2">They return a value that can be displayed or treated by another filter.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1436.1">A filter is written like </span><code class="inlineCode"><span class="koboSpan" id="kobo.1437.1">{{ variable</span></code><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1438.1">|my_filter </span></code><code class="inlineCode"><span class="koboSpan" id="kobo.1439.1">}}</span></code><span class="koboSpan" id="kobo.1440.1">. </span><span class="koboSpan" id="kobo.1440.2">Filters with an argument are written like </span><code class="inlineCode"><span class="koboSpan" id="kobo.1441.1">{{ variable</span></code><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1442.1">|my_filter:"foo" </span></code><code class="inlineCode"><span class="koboSpan" id="kobo.1443.1">}}</span></code><span class="koboSpan" id="kobo.1444.1">. </span><span class="koboSpan" id="kobo.1444.2">For example, you can use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1445.1">capfirst</span></code><span class="koboSpan" id="kobo.1446.1"> filter to capitalize the first character of the value, like </span><code class="inlineCode"><span class="koboSpan" id="kobo.1447.1">{{ value</span></code><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1448.1">|capfirst </span></code><code class="inlineCode"><span class="koboSpan" id="kobo.1449.1">}}</span></code><span class="koboSpan" id="kobo.1450.1">. </span><span class="koboSpan" id="kobo.1450.2">If </span><code class="inlineCode"><span class="koboSpan" id="kobo.1451.1">value</span></code><span class="koboSpan" id="kobo.1452.1"> is </span><code class="inlineCode"><span class="koboSpan" id="kobo.1453.1">django</span></code><span class="koboSpan" id="kobo.1454.1">, the output will be </span><code class="inlineCode"><span class="koboSpan" id="kobo.1455.1">Django</span></code><span class="koboSpan" id="kobo.1456.1">. </span><span class="koboSpan" id="kobo.1456.2">You can apply as many filters as you like to a variable, for example, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1457.1">{{ variable</span></code><code class="codeHighlighted" style="font-weight: bold;"><span class="koboSpan" id="kobo.1458.1">|filter1|filter2 </span></code><code class="inlineCode"><span class="koboSpan" id="kobo.1459.1">}}</span></code><span class="koboSpan" id="kobo.1460.1">, and each filter will be applied to the output generated by the preceding filter.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1461.1">You can find the list of Django’s built-in template filters at </span><a href="https://docs.djangoproject.com/en/5.0/ref/templates/builtins/#built-in-filter-reference"><span class="url"><span class="koboSpan" id="kobo.1462.1">https://docs.djangoproject.com/en/5.0/ref/templates/builtins/#built-in-filter-reference</span></span></a><span class="koboSpan" id="kobo.1463.1">.</span></p>
<h2 class="heading-2" id="_idParaDest-123"><span class="koboSpan" id="kobo.1464.1">Creating a template filter to support Markdown syntax</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1465.1">We will create a custom filter to enable you to use Markdown syntax in your blog posts and then convert the post body to HTML in the templates.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1466.1">Markdown is a plain-text formatting </span><a id="_idIndexMarker299"/><span class="koboSpan" id="kobo.1467.1">syntax that is very simple to use, and it’s intended to be converted into HTML. </span><span class="koboSpan" id="kobo.1467.2">You can write posts using simple Markdown syntax and get the content automatically converted into HTML code. </span><span class="koboSpan" id="kobo.1467.3">Learning Markdown syntax is much easier than learning HTML. </span><span class="koboSpan" id="kobo.1467.4">By using Markdown, you can get other non-tech-savvy contributors to easily write posts for your blog. </span><span class="koboSpan" id="kobo.1467.5">You can learn the basics of the Markdown format at </span><a href="https://daringfireball.net/projects/markdown/basics"><span class="url"><span class="koboSpan" id="kobo.1468.1">https://daringfireball.net/projects/markdown/basics</span></span></a><span class="koboSpan" id="kobo.1469.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1470.1">First, install the Python </span><code class="inlineCode"><span class="koboSpan" id="kobo.1471.1">markdown</span></code><span class="koboSpan" id="kobo.1472.1"> module via </span><code class="inlineCode"><span class="koboSpan" id="kobo.1473.1">pip</span></code><span class="koboSpan" id="kobo.1474.1"> using the following command in the shell prompt:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1475.1">python -m pip install markdown==3.6
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1476.1">Then, edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1477.1">templatetags/blog_tags.py</span></code><span class="koboSpan" id="kobo.1478.1"> file and include the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1479.1">import</span></span><span class="koboSpan" id="kobo.1480.1"> markdown
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1481.1">from</span></span><span class="koboSpan" id="kobo.1482.1"> django.utils.safestring </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1483.1">import</span></span><span class="koboSpan" id="kobo.1484.1"> mark_safe
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.1485.1">@register.filter(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1486.1">name=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1487.1">'markdown'</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.1488.1">)</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1489.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1490.1">markdown_format</span></span><span class="koboSpan" id="kobo.1491.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1492.1">text</span></span><span class="koboSpan" id="kobo.1493.1">):
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1494.1">return</span></span><span class="koboSpan" id="kobo.1495.1"> mark_safe(markdown.markdown(text))
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1496.1">We register template filters in the same way as template tags. </span><span class="koboSpan" id="kobo.1496.2">To prevent a name clash between the function </span><a id="_idIndexMarker300"/><span class="koboSpan" id="kobo.1497.1">name and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1498.1">markdown</span></code><span class="koboSpan" id="kobo.1499.1"> module, we have named the function </span><code class="inlineCode"><span class="koboSpan" id="kobo.1500.1">markdown_format</span></code><span class="koboSpan" id="kobo.1501.1"> and we have named the filter </span><code class="inlineCode"><span class="koboSpan" id="kobo.1502.1">markdown</span></code><span class="koboSpan" id="kobo.1503.1"> for use in templates, such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.1504.1">{{ variable|markdown }}</span></code><span class="koboSpan" id="kobo.1505.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1506.1">Django escapes the HTML code generated by filters; characters of HTML entities are replaced with their HTML-encoded characters. </span><span class="koboSpan" id="kobo.1506.2">For example, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1507.1">&lt;p&gt;</span></code><span class="koboSpan" id="kobo.1508.1"> is converted to </span><code class="inlineCode"><span class="koboSpan" id="kobo.1509.1">&amp;lt;p&amp;gt;</span></code><span class="koboSpan" id="kobo.1510.1"> (</span><em class="italic"><span class="koboSpan" id="kobo.1511.1">less than</span></em><span class="koboSpan" id="kobo.1512.1"> symbol, </span><em class="italic"><span class="koboSpan" id="kobo.1513.1">p</span></em><span class="koboSpan" id="kobo.1514.1"> character, </span><em class="italic"><span class="koboSpan" id="kobo.1515.1">greater than</span></em><span class="koboSpan" id="kobo.1516.1"> symbol).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1517.1">We use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1518.1">mark_safe</span></code><span class="koboSpan" id="kobo.1519.1"> function provided by Django to mark the result as safe HTML to be rendered in the template. </span><span class="koboSpan" id="kobo.1519.2">By default, Django will not trust any HTML code and will escape it before placing it in the output. </span><span class="koboSpan" id="kobo.1519.3">The only exceptions are variables that are marked as safe from escaping. </span><span class="koboSpan" id="kobo.1519.4">This behavior prevents Django from outputting potentially dangerous HTML and allows you to create exceptions for returning safe HTML.</span></p>
<div class="packt_tip">
<p class="normal"><span class="koboSpan" id="kobo.1520.1"> In Django, HTML content is escaped by default for security. </span><span class="koboSpan" id="kobo.1520.2">Use </span><code class="inlineCode"><span class="koboSpan" id="kobo.1521.1">mark_safe</span></code><span class="koboSpan" id="kobo.1522.1"> cautiously, only on content you control. </span><span class="koboSpan" id="kobo.1522.2">Avoid using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1523.1">mark_safe</span></code><span class="koboSpan" id="kobo.1524.1"> on any content submitted by non-staff users to prevent security vulnerabilities.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.1525.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1526.1">blog/post/detail.html</span></code><span class="koboSpan" id="kobo.1527.1"> template and add the following new code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1528.1">{% extends "blog/base.html" %}
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1529.1">{% load blog_tags %}</span></strong></span><span class="koboSpan" id="kobo.1530.1">
{% block title %}{{ post.title }}{% endblock %}
{% block content %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1531.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1532.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1533.1">&gt;</span></span><span class="koboSpan" id="kobo.1534.1">{{ post.title }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1535.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1536.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1537.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1538.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1539.1">p</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1540.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1541.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1542.1">"date"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1543.1">&gt;</span></span><span class="koboSpan" id="kobo.1544.1">
    Published {{ post.publish }} by {{ post.author }}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1545.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1546.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1547.1">&gt;</span></span><span class="koboSpan" id="kobo.1548.1">
  {{ post.body</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1549.1">|markdown</span></strong></span><span class="koboSpan" id="kobo.1550.1"> }}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1551.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1552.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1553.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1554.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1555.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1556.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1557.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1558.1">"{% url "</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1559.1">blog:post_share</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1560.1">" </span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1561.1">post.id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1562.1"> %}"&gt;</span></span><span class="koboSpan" id="kobo.1563.1">
      Share this post
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1564.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1565.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1566.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1567.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1568.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1569.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1570.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1571.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1572.1">&gt;</span></span><span class="koboSpan" id="kobo.1573.1">Similar posts</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1574.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1575.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1576.1">&gt;</span></span><span class="koboSpan" id="kobo.1577.1">
  {% for post in similar_posts %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1578.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1579.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1580.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1581.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1582.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1583.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1584.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1585.1">"{{ post.get_absolute_url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1586.1">&gt;</span></span><span class="koboSpan" id="kobo.1587.1">{{ post.title }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1588.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1589.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1590.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1591.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1592.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1593.1">&gt;</span></span><span class="koboSpan" id="kobo.1594.1">
  {% empty %}
    There are no similar posts yet.
  </span><span class="koboSpan" id="kobo.1594.2">{% endfor %}
  {% with comments.count as total_comments %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1595.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1596.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1597.1">&gt;</span></span><span class="koboSpan" id="kobo.1598.1">
      {{ total_comments }} comment{{ total_comments|pluralize }}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1599.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1600.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1601.1">&gt;</span></span><span class="koboSpan" id="kobo.1602.1">
  {% endwith %}
  {% for comment in comments %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1603.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1604.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1605.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1606.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1607.1">"comment"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1608.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1609.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1610.1">p</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1611.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1612.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1613.1">"info"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1614.1">&gt;</span></span><span class="koboSpan" id="kobo.1615.1">
        Comment {{ forloop.counter }} by {{ comment.name }}
        {{ comment.created }}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1616.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1617.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1618.1">&gt;</span></span><span class="koboSpan" id="kobo.1619.1">
      {{ comment.body|linebreaks }}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1620.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1621.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1622.1">&gt;</span></span><span class="koboSpan" id="kobo.1623.1">
  {% empty %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1624.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1625.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1626.1">&gt;</span></span><span class="koboSpan" id="kobo.1627.1">There are no comments yet.</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1628.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1629.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1630.1">&gt;</span></span><span class="koboSpan" id="kobo.1631.1">
  {% endfor %}
  {% include "blog/post/includes/comment_form.html" %}
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1632.1">We have replaced the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1633.1">linebreaks</span></code><span class="koboSpan" id="kobo.1634.1"> filter of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1635.1">{{ post.body }}</span></code><span class="koboSpan" id="kobo.1636.1"> template variable with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1637.1">markdown</span></code><span class="koboSpan" id="kobo.1638.1"> filter. </span><span class="koboSpan" id="kobo.1638.2">This filter </span><a id="_idIndexMarker301"/><span class="koboSpan" id="kobo.1639.1">will not only transform line breaks into </span><code class="inlineCode"><span class="koboSpan" id="kobo.1640.1">&lt;p&gt;</span></code><span class="koboSpan" id="kobo.1641.1"> tags; it will also transform Markdown formatting into HTML.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.1642.1">Storing text in Markdown format in the database, rather than HTML, is a wise security strategy. </span><span class="koboSpan" id="kobo.1642.2">Markdown limits the potential for injecting malicious content. </span><span class="koboSpan" id="kobo.1642.3">This approach ensures that any text formatting is safely converted to HTML only at the point of rendering the template.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.1643.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1644.1">blog/post/list.html</span></code><span class="koboSpan" id="kobo.1645.1"> template</span><a id="_idIndexMarker302"/><span class="koboSpan" id="kobo.1646.1"> and add the following new code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1647.1">{% extends "blog/base.html" %}
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1648.1">{% load blog_tags %}</span></strong></span><span class="koboSpan" id="kobo.1649.1">
{% block title %}My Blog{% endblock %}
{% block content %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1650.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1651.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1652.1">&gt;</span></span><span class="koboSpan" id="kobo.1653.1">My Blog</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1654.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1655.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1656.1">&gt;</span></span><span class="koboSpan" id="kobo.1657.1">
  {% if tag %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1658.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1659.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1660.1">&gt;</span></span><span class="koboSpan" id="kobo.1661.1">Posts tagged with "{{ tag.name }}"</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1662.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1663.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1664.1">&gt;</span></span><span class="koboSpan" id="kobo.1665.1">
  {% endif %}
  {% for post in posts %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1666.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1667.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1668.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1669.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1670.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1671.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1672.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1673.1">"{{ post.get_absolute_url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1674.1">&gt;</span></span><span class="koboSpan" id="kobo.1675.1">
        {{ post.title }}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1676.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1677.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1678.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1679.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1680.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1681.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1682.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1683.1">p</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1684.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1685.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1686.1">"tags"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1687.1">&gt;</span></span><span class="koboSpan" id="kobo.1688.1">
      Tags:
      {% for tag in post.tags.all %}
        </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1689.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1690.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1691.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1692.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1693.1">"{% url "</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1694.1">blog:post_list_by_tag</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1695.1">" </span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.1696.1">tag.slug</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1697.1"> %}"&gt;</span></span><span class="koboSpan" id="kobo.1698.1">
          {{ tag.name }}
        </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1699.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1700.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1701.1">&gt;</span></span><span class="koboSpan" id="kobo.1702.1">
        {% if not forloop.last %}, {% endif %}
      {% endfor %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1703.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1704.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1705.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1706.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1707.1">p</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1708.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1709.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1710.1">"date"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1711.1">&gt;</span></span><span class="koboSpan" id="kobo.1712.1">
      Published {{ post.publish }} by {{ post.author }}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1713.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1714.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1715.1">&gt;</span></span><span class="koboSpan" id="kobo.1716.1">
    {{ post.body</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1717.1">|markdown|truncatewords_html:30</span></strong></span><span class="koboSpan" id="kobo.1718.1"> }}
  {% endfor %}
  {% include "pagination.html" with page=posts %}
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1719.1">We have added the new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1720.1">markdown</span></code><span class="koboSpan" id="kobo.1721.1"> filter to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1722.1">{{ post.body }}</span></code><span class="koboSpan" id="kobo.1723.1"> template variable. </span><span class="koboSpan" id="kobo.1723.2">This filter will transform the Markdown content into HTML. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.1724.1">Therefore, we have replaced the previous </span><code class="inlineCode"><span class="koboSpan" id="kobo.1725.1">truncatewords</span></code><span class="koboSpan" id="kobo.1726.1"> filter with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1727.1">truncatewords_html</span></code><span class="koboSpan" id="kobo.1728.1"> filter. </span><span class="koboSpan" id="kobo.1728.2">This filter truncates a string after a certain number of words, avoiding unclosed HTML tags.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1729.1">Now open </span><code class="inlineCode"><span class="koboSpan" id="kobo.1730.1">http://127.0.0.1:8000/admin/blog/post/add/</span></code><span class="koboSpan" id="kobo.1731.1"> in your browser and create a new post with the</span><a id="_idIndexMarker303"/><span class="koboSpan" id="kobo.1732.1"> following body:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1733.1">This is a post formatted with markdown
--------------------------------------
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.1734.1">*This is emphasized*</span></span><span class="koboSpan" id="kobo.1735.1"> and </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1736.1">**this is more emphasized**</span></span><span class="koboSpan" id="kobo.1737.1">.
</span><span class="koboSpan" id="kobo.1737.2">Here is a list:
* One
* Two
* Three
And a [link to the Django website](https://www.djangoproject.com/).
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1738.1">The form should look like this:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1739.1"><img alt="" role="presentation" src="../Images/B21088_03_16.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1740.1">Figure 3.16: The post with Markdown content rendered as HTML</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1741.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.1742.1">http://127.0.0.1:8000/blog/</span></code><span class="koboSpan" id="kobo.1743.1"> in your </span><a id="_idIndexMarker304"/><span class="koboSpan" id="kobo.1744.1">browser and take a look at how the new post is rendered. </span><span class="koboSpan" id="kobo.1744.2">You should see the following output:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1745.1"><img alt="" role="presentation" src="../Images/B21088_03_17.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1746.1">Figure 3.17: The post with Markdown content rendered as HTML</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1747.1">As you can see in </span><em class="italic"><span class="koboSpan" id="kobo.1748.1">Figure 3.17</span></em><span class="koboSpan" id="kobo.1749.1">, custom </span><a id="_idIndexMarker305"/><span class="koboSpan" id="kobo.1750.1">template filters are very useful for customizing formatting. </span><span class="koboSpan" id="kobo.1750.2">You can find more information about custom filters at </span><a href="https://docs.djangoproject.com/en/5.0/howto/custom-template-tags/#writing-custom-template-filters"><span class="url"><span class="koboSpan" id="kobo.1751.1">https://docs.djangoproject.com/en/5.0/howto/custom-template-tags/#writing-custom-template-filters</span></span></a><span class="koboSpan" id="kobo.1752.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-124"><span class="koboSpan" id="kobo.1753.1">Adding a sitemap to the site</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1754.1">Django comes with a sitemap framework, which allows you to generate sitemaps for your site dynamically. </span><span class="koboSpan" id="kobo.1754.2">A sitemap</span><a id="_idIndexMarker306"/><span class="koboSpan" id="kobo.1755.1"> is an XML file that tells search engines the pages of your website, their relevance, and how frequently they are updated. </span><span class="koboSpan" id="kobo.1755.2">Using a sitemap will make your site more visible in search engine rankings because it helps crawlers to index your website’s content.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1756.1">The Django sitemap framework depends on </span><code class="inlineCode"><span class="koboSpan" id="kobo.1757.1">django.contrib.sites</span></code><span class="koboSpan" id="kobo.1758.1">, which allows you to associate objects to particular websites that are running with your project. </span><span class="koboSpan" id="kobo.1758.2">This comes in handy when you want to run multiple sites using a single Django project. </span><span class="koboSpan" id="kobo.1758.3">To install the sitemap framework, we will need to activate both the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1759.1">sites</span></code><span class="koboSpan" id="kobo.1760.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1761.1">sitemap</span></code><span class="koboSpan" id="kobo.1762.1"> applications in your project. </span><span class="koboSpan" id="kobo.1762.2">We are going to build a sitemap for the blog that includes the links to all published posts.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1763.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1764.1">settings.py</span></code><span class="koboSpan" id="kobo.1765.1"> file of the project and add </span><code class="inlineCode"><span class="koboSpan" id="kobo.1766.1">django.contrib.sites</span></code><span class="koboSpan" id="kobo.1767.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1768.1">django.contrib.sitemaps</span></code><span class="koboSpan" id="kobo.1769.1"> to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1770.1">INSTALLED_APPS</span></code><span class="koboSpan" id="kobo.1771.1"> setting. </span><span class="koboSpan" id="kobo.1771.2">Also, define a new setting for the site ID, as follows. </span><span class="koboSpan" id="kobo.1771.3">New</span><a id="_idIndexMarker307"/><span class="koboSpan" id="kobo.1772.1"> code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1773.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1774.1">SITE_ID = </span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.1775.1">1</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1776.1"># Application definition</span></span><span class="koboSpan" id="kobo.1777.1">
INSTALLED_APPS = [
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1778.1">'django.contrib.admin'</span></span><span class="koboSpan" id="kobo.1779.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1780.1">'django.contrib.auth'</span></span><span class="koboSpan" id="kobo.1781.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1782.1">'django.contrib.contenttypes'</span></span><span class="koboSpan" id="kobo.1783.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1784.1">'django.contrib.sessions'</span></span><span class="koboSpan" id="kobo.1785.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1786.1">'django.contrib.messages'</span></span><span class="koboSpan" id="kobo.1787.1">,
    </span><span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1788.1">'django.contrib.sites'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1789.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1790.1">'django.contrib.sitemaps'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1791.1">,</span></strong></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.1792.1">'django.contrib.staticfiles'</span></span><span class="koboSpan" id="kobo.1793.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1794.1">'taggit'</span></span><span class="koboSpan" id="kobo.1795.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1796.1">'blog.apps.BlogConfig'</span></span><span class="koboSpan" id="kobo.1797.1">,
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1798.1">Now, run the following command from the shell prompt to create the tables of the Django site application in the database:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1799.1">python manage.py migrate
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1800.1">You should see an output that contains the following lines:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1801.1">Applying sites.0001_initial... </span><span class="koboSpan" id="kobo.1801.2">OK
Applying sites.0002_alter_domain_unique... </span><span class="koboSpan" id="kobo.1801.3">OK
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1802.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1803.1">sites</span></code><span class="koboSpan" id="kobo.1804.1"> application is now synced with the database.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1805.1">Next, create a new file inside your </span><code class="inlineCode"><span class="koboSpan" id="kobo.1806.1">blog</span></code><span class="koboSpan" id="kobo.1807.1"> application directory and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.1808.1">sitemaps.py</span></code><span class="koboSpan" id="kobo.1809.1">. </span><span class="koboSpan" id="kobo.1809.2">Open the file and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1810.1">from</span></span><span class="koboSpan" id="kobo.1811.1"> django.contrib.sitemaps </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1812.1">import</span></span><span class="koboSpan" id="kobo.1813.1"> Sitemap
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1814.1">from</span></span><span class="koboSpan" id="kobo.1815.1"> .models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1816.1">import</span></span><span class="koboSpan" id="kobo.1817.1"> Post
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1818.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1819.1">PostSitemap</span></span><span class="koboSpan" id="kobo.1820.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1821.1">Sitemap</span></span><span class="koboSpan" id="kobo.1822.1">):
    changefreq = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1823.1">'weekly'</span></span><span class="koboSpan" id="kobo.1824.1">
    priority = </span><span class="hljs-number"><span class="koboSpan" id="kobo.1825.1">0.9</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1826.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1827.1">items</span></span><span class="koboSpan" id="kobo.1828.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1829.1">self</span></span><span class="koboSpan" id="kobo.1830.1">):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1831.1">return</span></span><span class="koboSpan" id="kobo.1832.1"> Post.published.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1833.1">all</span></span><span class="koboSpan" id="kobo.1834.1">()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1835.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1836.1">lastmod</span></span><span class="koboSpan" id="kobo.1837.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1838.1">self, obj</span></span><span class="koboSpan" id="kobo.1839.1">):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1840.1">return</span></span><span class="koboSpan" id="kobo.1841.1"> obj.updated
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1842.1">We have defined a custom sitemap by inheriting the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1843.1">Sitemap</span></code><span class="koboSpan" id="kobo.1844.1"> class of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1845.1">sitemaps</span></code><span class="koboSpan" id="kobo.1846.1"> module. </span><span class="koboSpan" id="kobo.1846.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1847.1">changefreq</span></code><span class="koboSpan" id="kobo.1848.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1849.1">priority</span></code><span class="koboSpan" id="kobo.1850.1"> attributes indicate the change frequency of your post pages and their </span><a id="_idIndexMarker308"/><span class="koboSpan" id="kobo.1851.1">relevance in your website (the maximum value is </span><code class="inlineCode"><span class="koboSpan" id="kobo.1852.1">1</span></code><span class="koboSpan" id="kobo.1853.1">).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1854.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1855.1">items()</span></code><span class="koboSpan" id="kobo.1856.1"> method returns the QuerySet of objects to include in this sitemap. </span><span class="koboSpan" id="kobo.1856.2">By default, Django calls the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1857.1">get_absolute_url()</span></code><span class="koboSpan" id="kobo.1858.1"> method on each object to retrieve its URL. </span><span class="koboSpan" id="kobo.1858.2">Remember that we implemented this method in </span><em class="italic"><span class="koboSpan" id="kobo.1859.1">Chapter 2</span></em><span class="koboSpan" id="kobo.1860.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1861.1">Enhancing Your Blog with Advanced Features</span></em><span class="koboSpan" id="kobo.1862.1">, to define the canonical URL for posts. </span><span class="koboSpan" id="kobo.1862.2">If you want to specify the URL for each object, you can add a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1863.1">location</span></code><span class="koboSpan" id="kobo.1864.1"> method to your sitemap class.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1865.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1866.1">lastmod</span></code><span class="koboSpan" id="kobo.1867.1"> method receives each object returned by </span><code class="inlineCode"><span class="koboSpan" id="kobo.1868.1">items()</span></code><span class="koboSpan" id="kobo.1869.1"> and returns the last time the object was modified.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1870.1">Both the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1871.1">changefreq</span></code><span class="koboSpan" id="kobo.1872.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1873.1">priority</span></code><span class="koboSpan" id="kobo.1874.1"> attributes can be either methods or attributes. </span><span class="koboSpan" id="kobo.1874.2">You can take a look at the complete sitemap reference in the official Django documentation located at </span><a href="https://docs.djangoproject.com/en/5.0/ref/contrib/sitemaps/"><span class="url"><span class="koboSpan" id="kobo.1875.1">https://docs.djangoproject.com/en/5.0/ref/contrib/sitemaps/</span></span></a><span class="koboSpan" id="kobo.1876.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1877.1">We have created the sitemap. </span><span class="koboSpan" id="kobo.1877.2">Now we just need to create a URL for it.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1878.1">Edit the main </span><code class="inlineCode"><span class="koboSpan" id="kobo.1879.1">urls.py</span></code><span class="koboSpan" id="kobo.1880.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1881.1">mysite</span></code><span class="koboSpan" id="kobo.1882.1"> project and add the sitemap, as follows. </span><span class="koboSpan" id="kobo.1882.2">New lines are highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1883.1">from</span></span><span class="koboSpan" id="kobo.1884.1"> django.contrib </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1885.1">import</span></span><span class="koboSpan" id="kobo.1886.1"> admin
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1887.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1888.1"> django.contrib.sitemaps.views </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1889.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1890.1"> sitemap</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1891.1">from</span></span><span class="koboSpan" id="kobo.1892.1"> django.urls </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1893.1">import</span></span><span class="koboSpan" id="kobo.1894.1"> include, path
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1895.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1896.1"> blog.sitemaps </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1897.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1898.1"> PostSitemap</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1899.1">sitemaps = {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1900.1">'posts'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1901.1">: PostSitemap,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1902.1">}</span></strong></span><span class="koboSpan" id="kobo.1903.1">
urlpatterns = [
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1904.1">'admin/'</span></span><span class="koboSpan" id="kobo.1905.1">, admin.site.urls),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1906.1">'blog/'</span></span><span class="koboSpan" id="kobo.1907.1">, include(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1908.1">'blog.urls'</span></span><span class="koboSpan" id="kobo.1909.1">, namespace=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1910.1">'blog'</span></span><span class="koboSpan" id="kobo.1911.1">)),
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1912.1">    path(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1913.1">'sitemap.xml'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1914.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1915.1">        sitemap,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1916.1">        {</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1917.1">'sitemaps'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1918.1">: sitemaps},</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1919.1">        name=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1920.1">'django.contrib.sitemaps.views.sitemap'</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1921.1">    )</span></strong></span><span class="koboSpan" id="kobo.1922.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1923.1">In the preceding code, we have included the required imports and defined a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1924.1">sitemaps</span></code><span class="koboSpan" id="kobo.1925.1"> dictionary. </span><span class="koboSpan" id="kobo.1925.2">Multiple sitemaps can be defined for the site. </span><span class="koboSpan" id="kobo.1925.3">We have defined a URL pattern that matches the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1926.1">sitemap.xml</span></code><span class="koboSpan" id="kobo.1927.1"> pattern and uses the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1928.1">sitemap</span></code><span class="koboSpan" id="kobo.1929.1"> view provided by Django. </span><span class="koboSpan" id="kobo.1929.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1930.1">sitemaps</span></code><span class="koboSpan" id="kobo.1931.1"> dictionary is</span><a id="_idIndexMarker309"/><span class="koboSpan" id="kobo.1932.1"> passed to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1933.1">sitemap</span></code><span class="koboSpan" id="kobo.1934.1"> view.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1935.1">Start the development server from the shell prompt with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1936.1">python manage.py runserver
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1937.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.1938.1">http://127.0.0.1:8000/sitemap.xml</span></code><span class="koboSpan" id="kobo.1939.1"> in your browser. </span><span class="koboSpan" id="kobo.1939.2">You will see an XML output including all of the published posts, like this:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.1940.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1941.1">urlset</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1942.1">xmlns</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1943.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1944.1">"http://www.sitemaps.org/schemas/sitemap/0.9"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1945.1">xmlns:xhtml</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1946.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1947.1">"http://www.w3.org/1999/xhtml"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1948.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1949.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1950.1">url</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1951.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1952.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1953.1">loc</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1954.1">&gt;</span></span><span class="koboSpan" id="kobo.1955.1">http://example.com/blog/2024/1/2/markdown-post/</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1956.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1957.1">loc</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1958.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1959.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1960.1">lastmod</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1961.1">&gt;</span></span><span class="koboSpan" id="kobo.1962.1">2024-01-02</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1963.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1964.1">lastmod</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1965.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1966.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1967.1">changefreq</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1968.1">&gt;</span></span><span class="koboSpan" id="kobo.1969.1">weekly</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1970.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1971.1">changefreq</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1972.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1973.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1974.1">priority</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1975.1">&gt;</span></span><span class="koboSpan" id="kobo.1976.1">0.9</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1977.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1978.1">priority</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1979.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1980.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1981.1">url</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1982.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1983.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1984.1">url</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1985.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1986.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1987.1">loc</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1988.1">&gt;</span></span><span class="koboSpan" id="kobo.1989.1">http://example.com/blog/2024/1/2/notes-on-duke-ellington/</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1990.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1991.1">loc</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1992.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1993.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1994.1">lastmod</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1995.1">&gt;</span></span><span class="koboSpan" id="kobo.1996.1">2024-01-02</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1997.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1998.1">lastmod</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1999.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2000.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2001.1">changefreq</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2002.1">&gt;</span></span><span class="koboSpan" id="kobo.2003.1">weekly</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2004.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2005.1">changefreqa</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2006.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2007.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2008.1">priority</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2009.1">&gt;</span></span><span class="koboSpan" id="kobo.2010.1">0.9</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2011.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2012.1">priority</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2013.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2014.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2015.1">url</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2016.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2017.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2018.1">url</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2019.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2020.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2021.1">loc</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2022.1">&gt;</span></span><span class="koboSpan" id="kobo.2023.1">http://example.com/blog/2024/1/2/who-was-miles-davis/</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2024.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2025.1">loc</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2026.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2027.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2028.1">lastmod</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2029.1">&gt;</span></span><span class="koboSpan" id="kobo.2030.1">2024-01-02</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2031.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2032.1">lastmod</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2033.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2034.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2035.1">changefreq</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2036.1">&gt;</span></span><span class="koboSpan" id="kobo.2037.1">weekly</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2038.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2039.1">changefreq</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2040.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2041.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2042.1">priority</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2043.1">&gt;</span></span><span class="koboSpan" id="kobo.2044.1">0.9</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2045.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2046.1">priority</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2047.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2048.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2049.1">url</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2050.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2051.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2052.1">url</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2053.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2054.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2055.1">loc</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2056.1">&gt;</span></span><span class="koboSpan" id="kobo.2057.1">http://example.com/blog/2024/1/1/who-was-django-reinhardt/</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2058.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2059.1">loc</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2060.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2061.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2062.1">lastmod</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2063.1">&gt;</span></span><span class="koboSpan" id="kobo.2064.1">2024-01-01</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2065.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2066.1">lastmod</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2067.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2068.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2069.1">changefreq</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2070.1">&gt;</span></span><span class="koboSpan" id="kobo.2071.1">weekly</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2072.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2073.1">changefreq</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2074.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2075.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2076.1">priority</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2077.1">&gt;</span></span><span class="koboSpan" id="kobo.2078.1">0.9</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2079.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2080.1">priority</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2081.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2082.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2083.1">url</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2084.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2085.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2086.1">url</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2087.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2088.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2089.1">loc</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2090.1">&gt;</span></span><span class="koboSpan" id="kobo.2091.1">http://example.com/blog/2024/1/1/another-post/</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2092.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2093.1">loc</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2094.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2095.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2096.1">lastmod</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2097.1">&gt;</span></span><span class="koboSpan" id="kobo.2098.1">2024-01-01</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2099.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2100.1">lastmod</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2101.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2102.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2103.1">changefreq</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2104.1">&gt;</span></span><span class="koboSpan" id="kobo.2105.1">weekly</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2106.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2107.1">changefreq</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2108.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2109.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2110.1">priority</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2111.1">&gt;</span></span><span class="koboSpan" id="kobo.2112.1">0.9</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2113.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2114.1">priority</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2115.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2116.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2117.1">url</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2118.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2119.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2120.1">urlset</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2121.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2122.1">The URL for each </span><code class="inlineCode"><span class="koboSpan" id="kobo.2123.1">Post</span></code><span class="koboSpan" id="kobo.2124.1"> object is built by calling its </span><code class="inlineCode"><span class="koboSpan" id="kobo.2125.1">get_absolute_url()</span></code><span class="koboSpan" id="kobo.2126.1"> method.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2127.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2128.1">lastmod</span></code><span class="koboSpan" id="kobo.2129.1"> attribute corresponds</span><a id="_idIndexMarker310"/><span class="koboSpan" id="kobo.2130.1"> to the post </span><code class="inlineCode"><span class="koboSpan" id="kobo.2131.1">updated</span></code><span class="koboSpan" id="kobo.2132.1"> date field, as you specified in your sitemap, and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2133.1">changefreq</span></code><span class="koboSpan" id="kobo.2134.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2135.1">priority</span></code><span class="koboSpan" id="kobo.2136.1"> attributes are also taken from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2137.1">PostSitemap</span></code><span class="koboSpan" id="kobo.2138.1"> class.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2139.1">The domain used to build the URLs is </span><code class="inlineCode"><span class="koboSpan" id="kobo.2140.1">example.com</span></code><span class="koboSpan" id="kobo.2141.1">. </span><span class="koboSpan" id="kobo.2141.2">This domain comes from a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2142.1">Site</span></code><span class="koboSpan" id="kobo.2143.1"> object stored in the database. </span><span class="koboSpan" id="kobo.2143.2">This default object was created when you synced the site’s framework with your database. </span><span class="koboSpan" id="kobo.2143.3">You can read more about the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2144.1">sites</span></code><span class="koboSpan" id="kobo.2145.1"> framework at </span><a href="https://docs.djangoproject.com/en/5.0/ref/contrib/sites/"><span class="url"><span class="koboSpan" id="kobo.2146.1">https://docs.djangoproject.com/en/5.0/ref/contrib/sites/</span></span></a><span class="koboSpan" id="kobo.2147.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2148.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.2149.1">http://127.0.0.1:8000/admin/sites/site/</span></code><span class="koboSpan" id="kobo.2150.1"> in your browser. </span><span class="koboSpan" id="kobo.2150.2">You should see something like this:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2151.1"><img alt="" role="presentation" src="../Images/B21088_03_18.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2152.1">Figure 3.18: The Django administration list view for the Site model of the site’s framework</span></p>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.2153.1">Figure 3.18</span></em><span class="koboSpan" id="kobo.2154.1"> contains the list display administration view for the site’s framework. </span><span class="koboSpan" id="kobo.2154.2">Here, you can set the domain or </span><a id="_idIndexMarker311"/><span class="koboSpan" id="kobo.2155.1">host to be used by the site’s framework and the applications that depend on it. </span><span class="koboSpan" id="kobo.2155.2">To generate URLs that exist in your local environment, change the domain name to </span><code class="inlineCode"><span class="koboSpan" id="kobo.2156.1">localhost:8000</span></code><span class="koboSpan" id="kobo.2157.1">, as shown in </span><em class="italic"><span class="koboSpan" id="kobo.2158.1">Figure 3.19</span></em><span class="koboSpan" id="kobo.2159.1">, and save it:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2160.1"><img alt="" role="presentation" src="../Images/B21088_03_19.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2161.1">Figure 3.19: The Django administration edit view for the Site model of the site’s framework</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2162.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.2163.1">http://127.0.0.1:8000/sitemap.xml</span></code><span class="koboSpan" id="kobo.2164.1"> in your browser again. </span><span class="koboSpan" id="kobo.2164.2">The URLs displayed in your sitemap will now use the new hostname and look like </span><code class="inlineCode"><span class="koboSpan" id="kobo.2165.1">http://localhost:8000/blog/2024/1/22/markdown-post/</span></code><span class="koboSpan" id="kobo.2166.1">. </span><span class="koboSpan" id="kobo.2166.2">Links are now accessible in your local environment. </span><span class="koboSpan" id="kobo.2166.3">In a production environment, you will have to use your website’s domain to </span><a id="_idIndexMarker312"/><span class="koboSpan" id="kobo.2167.1">generate absolute URLs.</span></p>
<h1 class="heading-1" id="_idParaDest-125"><span class="koboSpan" id="kobo.2168.1">Creating feeds for blog posts</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2169.1">Django has a built-in syndication feed framework that you can use to dynamically generate RSS or Atom feeds </span><a id="_idIndexMarker313"/><span class="koboSpan" id="kobo.2170.1">in a similar manner to creating sitemaps using the site’s framework. </span><span class="koboSpan" id="kobo.2170.2">A web feed is a data format (usually XML) that provides users with the most</span><a id="_idIndexMarker314"/><span class="koboSpan" id="kobo.2171.1"> recently updated content. </span><span class="koboSpan" id="kobo.2171.2">Users can subscribe to the feed using a feed aggregator, a software that is used to read feeds and get new content notifications.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2172.1">Create a new file in your </span><code class="inlineCode"><span class="koboSpan" id="kobo.2173.1">blog</span></code><span class="koboSpan" id="kobo.2174.1"> application directory and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.2175.1">feeds.py</span></code><span class="koboSpan" id="kobo.2176.1">. </span><span class="koboSpan" id="kobo.2176.2">Add the following lines to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2177.1">import</span></span><span class="koboSpan" id="kobo.2178.1"> markdown
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2179.1">from</span></span><span class="koboSpan" id="kobo.2180.1"> django.contrib.syndication.views </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2181.1">import</span></span><span class="koboSpan" id="kobo.2182.1"> Feed
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2183.1">from</span></span><span class="koboSpan" id="kobo.2184.1"> django.template.defaultfilters </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2185.1">import</span></span><span class="koboSpan" id="kobo.2186.1"> truncatewords_html
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2187.1">from</span></span><span class="koboSpan" id="kobo.2188.1"> django.urls </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2189.1">import</span></span><span class="koboSpan" id="kobo.2190.1"> reverse_lazy
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2191.1">from</span></span><span class="koboSpan" id="kobo.2192.1"> .models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2193.1">import</span></span><span class="koboSpan" id="kobo.2194.1"> Post
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2195.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2196.1">LatestPostsFeed</span></span><span class="koboSpan" id="kobo.2197.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.2198.1">Feed</span></span><span class="koboSpan" id="kobo.2199.1">):
    title = </span><span class="hljs-string"><span class="koboSpan" id="kobo.2200.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2201.1">My blog'</span></span><span class="koboSpan" id="kobo.2202.1">
    link = reverse_lazy(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2203.1">'blog:post_list'</span></span><span class="koboSpan" id="kobo.2204.1">)
    description = </span><span class="hljs-string"><span class="koboSpan" id="kobo.2205.1">'New posts of my blog.'</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2206.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2207.1">items</span></span><span class="koboSpan" id="kobo.2208.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2209.1">self</span></span><span class="koboSpan" id="kobo.2210.1">):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2211.1">return</span></span><span class="koboSpan" id="kobo.2212.1"> Post.published.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2213.1">all</span></span><span class="koboSpan" id="kobo.2214.1">()[:</span><span class="hljs-number"><span class="koboSpan" id="kobo.2215.1">5</span></span><span class="koboSpan" id="kobo.2216.1">]
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2217.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2218.1">item_title</span></span><span class="koboSpan" id="kobo.2219.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2220.1">self, item</span></span><span class="koboSpan" id="kobo.2221.1">):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2222.1">return</span></span><span class="koboSpan" id="kobo.2223.1"> item.title
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2224.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2225.1">item_description</span></span><span class="koboSpan" id="kobo.2226.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2227.1">self, item</span></span><span class="koboSpan" id="kobo.2228.1">):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2229.1">return</span></span><span class="koboSpan" id="kobo.2230.1"> truncatewords_html(markdown.markdown(item.body), </span><span class="hljs-number"><span class="koboSpan" id="kobo.2231.1">30</span></span><span class="koboSpan" id="kobo.2232.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2233.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2234.1">item_pubdate</span></span><span class="koboSpan" id="kobo.2235.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2236.1">self, item</span></span><span class="koboSpan" id="kobo.2237.1">):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2238.1">return</span></span><span class="koboSpan" id="kobo.2239.1"> item.publish
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2240.1">In the preceding code, we have defined a feed by subclassing the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2241.1">Feed</span></code><span class="koboSpan" id="kobo.2242.1"> class of the syndication framework. </span><span class="koboSpan" id="kobo.2242.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2243.1">title</span></code><span class="koboSpan" id="kobo.2244.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2245.1">link</span></code><span class="koboSpan" id="kobo.2246.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2247.1">description</span></code><span class="koboSpan" id="kobo.2248.1"> attributes correspond to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2249.1">&lt;title&gt;</span></code><span class="koboSpan" id="kobo.2250.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2251.1">&lt;link&gt;</span></code><span class="koboSpan" id="kobo.2252.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2253.1">&lt;description&gt;</span></code><span class="koboSpan" id="kobo.2254.1"> RSS elements, respectively.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2255.1">We use </span><code class="inlineCode"><span class="koboSpan" id="kobo.2256.1">reverse_lazy()</span></code><span class="koboSpan" id="kobo.2257.1"> to generate the URL for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2258.1">link</span></code><span class="koboSpan" id="kobo.2259.1"> attribute. </span><span class="koboSpan" id="kobo.2259.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2260.1">reverse()</span></code><span class="koboSpan" id="kobo.2261.1"> method allows you to build URLs by their name and pass optional parameters. </span><span class="koboSpan" id="kobo.2261.2">We used </span><code class="inlineCode"><span class="koboSpan" id="kobo.2262.1">reverse()</span></code><span class="koboSpan" id="kobo.2263.1"> in </span><em class="italic"><span class="koboSpan" id="kobo.2264.1">Chapter 2</span></em><span class="koboSpan" id="kobo.2265.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2266.1">Enhancing Your Blog with Advanced Features</span></em><span class="koboSpan" id="kobo.2267.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2268.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2269.1">reverse_lazy()</span></code><span class="koboSpan" id="kobo.2270.1"> utility function is a lazily evaluated version of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2271.1">reverse()</span></code><span class="koboSpan" id="kobo.2272.1">. </span><span class="koboSpan" id="kobo.2272.2">It allows you to use a URL reversal before the </span><a id="_idIndexMarker315"/><span class="koboSpan" id="kobo.2273.1">project’s URL configuration is loaded.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2274.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2275.1">items()</span></code><span class="koboSpan" id="kobo.2276.1"> method</span><a id="_idIndexMarker316"/><span class="koboSpan" id="kobo.2277.1"> retrieves the objects to be included in the feed. </span><span class="koboSpan" id="kobo.2277.2">We retrieve the last five published posts to include them in the feed.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2278.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2279.1">item_title()</span></code><span class="koboSpan" id="kobo.2280.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2281.1">item_description()</span></code><span class="koboSpan" id="kobo.2282.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2283.1">item_pubdate()</span></code><span class="koboSpan" id="kobo.2284.1"> methods will receive each object returned by </span><code class="inlineCode"><span class="koboSpan" id="kobo.2285.1">items()</span></code><span class="koboSpan" id="kobo.2286.1"> and return the title, description, and publication date for each item.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2287.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2288.1">item_description()</span></code><span class="koboSpan" id="kobo.2289.1"> method, we use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2290.1">markdown()</span></code><span class="koboSpan" id="kobo.2291.1"> function to convert Markdown content to HTML and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2292.1">truncatewords_html()</span></code><span class="koboSpan" id="kobo.2293.1"> template filter function to cut the description of posts after 30 words, avoiding unclosed HTML tags.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2294.1">Now, edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2295.1">blog/urls.py</span></code><span class="koboSpan" id="kobo.2296.1"> file, import the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2297.1">LatestPostsFeed</span></code><span class="koboSpan" id="kobo.2298.1"> class, and instantiate the feed in a new URL pattern, as follows. </span><span class="koboSpan" id="kobo.2298.2">New lines are highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2299.1">from</span></span><span class="koboSpan" id="kobo.2300.1"> django.urls </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2301.1">import</span></span><span class="koboSpan" id="kobo.2302.1"> path
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2303.1">from</span></span><span class="koboSpan" id="kobo.2304.1"> . </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2305.1">import</span></span><span class="koboSpan" id="kobo.2306.1"> views
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2307.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2308.1"> .feeds </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2309.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2310.1"> LatestPostsFeed</span></strong></span><span class="koboSpan" id="kobo.2311.1">
app_name = </span><span class="hljs-string"><span class="koboSpan" id="kobo.2312.1">'blog'</span></span><span class="koboSpan" id="kobo.2313.1">
urlpatterns = [
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.2314.1"># Post views</span></span><span class="koboSpan" id="kobo.2315.1">
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2316.1">''</span></span><span class="koboSpan" id="kobo.2317.1">, views.post_list, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.2318.1">'post_list'</span></span><span class="koboSpan" id="kobo.2319.1">),
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.2320.1"># path('', views.PostListView.as_view(), name='post_list'),</span></span><span class="koboSpan" id="kobo.2321.1">
    path(
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2322.1">'tag/&lt;slug:tag_slug&gt;/'</span></span><span class="koboSpan" id="kobo.2323.1">, views.post_list, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.2324.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2325.1">post_list_by_tag'</span></span>
<span class="hljs-string"> </span><span class="koboSpan" id="kobo.2326.1">),
    path(
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2327.1">'&lt;int:year&gt;/&lt;int:month&gt;/&lt;int:day&gt;/&lt;slug:post&gt;/'</span></span><span class="koboSpan" id="kobo.2328.1">,
        views.post_detail,
        name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.2329.1">'post_detail'</span></span>
<span class="hljs-string"> </span><span class="koboSpan" id="kobo.2330.1">),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2331.1">'&lt;int:post_id&gt;/share/'</span></span><span class="koboSpan" id="kobo.2332.1">, views.post_share, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.2333.1">'post_share'</span></span><span class="koboSpan" id="kobo.2334.1">),
    path(
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2335.1">'&lt;int:post_id&gt;/comment/'</span></span><span class="koboSpan" id="kobo.2336.1">, views.post_comment, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.2337.1">'post_comment'</span></span>
<span class="hljs-string"> </span><span class="koboSpan" id="kobo.2338.1">),
    </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2339.1">path(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2340.1">'feed/'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2341.1">, LatestPostsFeed(), name=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2342.1">'post_feed'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2343.1">),</span></strong></span><span class="koboSpan" id="kobo.2344.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2345.1">Navigate to </span><code class="inlineCode"><span class="koboSpan" id="kobo.2346.1">http://127.0.0.1:8000/blog/feed/</span></code><span class="koboSpan" id="kobo.2347.1"> in your browser. </span><span class="koboSpan" id="kobo.2347.2">You should now see the RSS feed, including the</span><a id="_idIndexMarker317"/><span class="koboSpan" id="kobo.2348.1"> last five blog posts:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.2349.1">&lt;?xml version=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2350.1">"1.0"</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.2351.1"> encoding=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2352.1">"utf-8"</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.2353.1">?&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2354.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2355.1">rss</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2356.1">xmlns:atom</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2357.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2358.1">"http://www.w3.org/2005/Atom"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2359.1">version</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2360.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2361.1">"2.0"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2362.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2363.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2364.1">channel</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2365.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2366.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2367.1">title</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2368.1">&gt;</span></span><span class="koboSpan" id="kobo.2369.1">My blog</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2370.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2371.1">title</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2372.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2373.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2374.1">link</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2375.1">&gt;</span></span><span class="koboSpan" id="kobo.2376.1">http://localhost:8000/blog/</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2377.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2378.1">link</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2379.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2380.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2381.1">description</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2382.1">&gt;</span></span><span class="koboSpan" id="kobo.2383.1">New posts of my blog.</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2384.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2385.1">description</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2386.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2387.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2388.1">atom:link</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2389.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2390.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2391.1">"http://localhost:8000/blog/feed/"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2392.1">rel</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2393.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2394.1">"self"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2395.1">/&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2396.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2397.1">language</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2398.1">&gt;</span></span><span class="koboSpan" id="kobo.2399.1">en-us</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2400.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2401.1">language</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2402.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2403.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2404.1">lastBuildDate</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2405.1">&gt;</span></span><span class="koboSpan" id="kobo.2406.1">Tue, 02 Jan 2024 16:30:00 +0000</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2407.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2408.1">lastBuildDate</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2409.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2410.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2411.1">item</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2412.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2413.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2414.1">title</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2415.1">&gt;</span></span><span class="koboSpan" id="kobo.2416.1">Markdown post</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2417.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2418.1">title</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2419.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2420.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2421.1">link</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2422.1">&gt;</span></span><span class="koboSpan" id="kobo.2423.1">http://localhost:8000/blog/2024/1/2/markdown-post/</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2424.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2425.1">link</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2426.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2427.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2428.1">description</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2429.1">&gt;</span></span><span class="koboSpan" id="kobo.2430.1">This is a post formatted with ...</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2431.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2432.1">description</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2433.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2434.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2435.1">guid</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2436.1">&gt;</span></span><span class="koboSpan" id="kobo.2437.1">http://localhost:8000/blog/2024/1/2/markdown-post/</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2438.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2439.1">guid</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2440.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2441.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2442.1">item</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2443.1">&gt;</span></span><span class="koboSpan" id="kobo.2444.1">
    ...
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2445.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2446.1">channel</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2447.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2448.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2449.1">rss</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2450.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2451.1">If you use Chrome, you will </span><a id="_idIndexMarker318"/><span class="koboSpan" id="kobo.2452.1">see the XML code. </span><span class="koboSpan" id="kobo.2452.2">If you use Safari, it will ask you to install an RSS feed reader.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2453.1">Let’s install an RSS desktop client to view the RSS feed with a user-friendly interface. </span><span class="koboSpan" id="kobo.2453.2">We will use Fluent Reader, which is a multi-platform RSS reader.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2454.1">Download Fluent Reader for Linux, macOS, or Windows from </span><a href="https://github.com/yang991178/fluent-reader/releases"><span class="url"><span class="koboSpan" id="kobo.2455.1">https://github.com/yang991178/fluent-reader/releases</span></span></a><span class="koboSpan" id="kobo.2456.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2457.1">Install Fluent Reader and open it. </span><span class="koboSpan" id="kobo.2457.2">You will see the following screen:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2458.1"><img alt="A picture containing chart  Description automatically generated" src="../Images/B21088_03_20.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2459.1">Figure 3.20: Fluent Reader with no RSS feed sources</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2460.1">Click on the settings icon in the top-right</span><a id="_idIndexMarker319"/><span class="koboSpan" id="kobo.2461.1"> corner of the window. </span><span class="koboSpan" id="kobo.2461.2">You will see a screen to add RSS feed sources</span><a id="_idIndexMarker320"/><span class="koboSpan" id="kobo.2462.1"> like the following one:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2463.1"><img alt="Text  Description automatically generated" src="../Images/B21088_03_21.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2464.1">Figure 3.21: Adding an RSS feed in Fluent Reader</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2465.1">Enter </span><code class="inlineCode"><span class="koboSpan" id="kobo.2466.1">http://127.0.0.1:8000/blog/feed/</span></code><span class="koboSpan" id="kobo.2467.1"> in the </span><strong class="screenText"><span class="koboSpan" id="kobo.2468.1">Add source</span></strong><span class="koboSpan" id="kobo.2469.1"> field and click on the </span><strong class="screenText"><span class="koboSpan" id="kobo.2470.1">Add </span></strong><span class="koboSpan" id="kobo.2471.1">button.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2472.1">You will see a new entry with the RSS feed of the blog in the table below the form, like this:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2473.1"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="../Images/B21088_03_22.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2474.1">Figure 3.22: RSS feed sources in Fluent Reader</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2475.1">Now, go back to the main screen </span><a id="_idIndexMarker321"/><span class="koboSpan" id="kobo.2476.1">of Fluent Reader. </span><span class="koboSpan" id="kobo.2476.2">You should be able to see the posts</span><a id="_idIndexMarker322"/><span class="koboSpan" id="kobo.2477.1"> included in the blog RSS feed, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2478.1"><img alt="Graphical user interface, text  Description automatically generated" src="../Images/B21088_03_23.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2479.1">Figure 3.23: RSS feed of the blog in Fluent Reader</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2480.1">Click on a post to see a description:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2481.1"><img alt="" role="presentation" src="../Images/B21088_03_24.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2482.1">Figure 3.24: The post description in Fluent Reader</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2483.1">Click on the third icon</span><a id="_idIndexMarker323"/><span class="koboSpan" id="kobo.2484.1"> in the top-right corner of the window to load the full content of the </span><a id="_idIndexMarker324"/><span class="koboSpan" id="kobo.2485.1">post page:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2486.1"><img alt="" role="presentation" src="../Images/B21088_03_25.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2487.1">Figure 3.25: The full content of a post in Fluent Reader</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2488.1">The final step is to </span><a id="_idIndexMarker325"/><span class="koboSpan" id="kobo.2489.1">add an RSS feed subscription link to the blog’s sidebar.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2490.1">Open the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2491.1">blog/base.html</span></code><span class="koboSpan" id="kobo.2492.1"> template and</span><a id="_idIndexMarker326"/><span class="koboSpan" id="kobo.2493.1"> add the following code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2494.1">{% load blog_tags %}
{% load static %}
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.2495.1">&lt;!DOCTYPE </span></span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2496.1">html</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.2497.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2498.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2499.1">html</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2500.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2501.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2502.1">head</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2503.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2504.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2505.1">title</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2506.1">&gt;</span></span><span class="koboSpan" id="kobo.2507.1">{% block title %}{% endblock %}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2508.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2509.1">title</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2510.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2511.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2512.1">link</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2513.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2514.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2515.1">"{% static "</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.2516.1">css</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2517.1">/</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.2518.1">blog.css</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2519.1">" %}" </span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.2520.1">rel</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2521.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2522.1">"stylesheet"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2523.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2524.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2525.1">head</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2526.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2527.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2528.1">body</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2529.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2530.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2531.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2532.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2533.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2534.1">"content"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2535.1">&gt;</span></span><span class="koboSpan" id="kobo.2536.1">
    {% block content %}
    {% endblock %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2537.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2538.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2539.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2540.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2541.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2542.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2543.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2544.1">"sidebar"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2545.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2546.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2547.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2548.1">&gt;</span></span><span class="koboSpan" id="kobo.2549.1">My blog</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2550.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2551.1">h2</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2552.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2553.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2554.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2555.1">&gt;</span></span><span class="koboSpan" id="kobo.2556.1">
      This is my blog.
      </span><span class="koboSpan" id="kobo.2556.2">I've written {% total_posts %} posts so far.
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2557.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2558.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2559.1">&gt;</span></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2560.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2561.1">p</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2562.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2563.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2564.1">a</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.2565.1">href</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2566.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2567.1">"{% url "</span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.2568.1">blog:post_feed</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2569.1">" %}"&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2570.1">        Subscribe to my RSS feed</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2571.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2572.1">a</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2573.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2574.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2575.1">p</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2576.1">&gt;</span></strong></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2577.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2578.1">h3</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2579.1">&gt;</span></span><span class="koboSpan" id="kobo.2580.1">Latest posts</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2581.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2582.1">h3</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2583.1">&gt;</span></span><span class="koboSpan" id="kobo.2584.1">
    {% show_latest_posts 3 %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2585.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2586.1">h3</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2587.1">&gt;</span></span><span class="koboSpan" id="kobo.2588.1">Most commented posts</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2589.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2590.1">h3</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2591.1">&gt;</span></span><span class="koboSpan" id="kobo.2592.1">
    {% get_most_commented_posts as most_commented_posts %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2593.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2594.1">ul</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2595.1">&gt;</span></span><span class="koboSpan" id="kobo.2596.1">
      {% for post in most_commented_posts %}
        </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2597.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2598.1">li</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2599.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2600.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2601.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2602.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2603.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2604.1">"{{ post.get_absolute_url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2605.1">&gt;</span></span><span class="koboSpan" id="kobo.2606.1">{{ post.title }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2607.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2608.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2609.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2610.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2611.1">li</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2612.1">&gt;</span></span><span class="koboSpan" id="kobo.2613.1">
      {% endfor %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2614.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2615.1">ul</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2616.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2617.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2618.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2619.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2620.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2621.1">body</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2622.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2623.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2624.1">html</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2625.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2626.1">Now open </span><code class="inlineCode"><span class="koboSpan" id="kobo.2627.1">http://127.0.0.1:8000/blog/</span></code><span class="koboSpan" id="kobo.2628.1"> in your browser </span><a id="_idIndexMarker327"/><span class="koboSpan" id="kobo.2629.1">and take a look at the sidebar. </span><span class="koboSpan" id="kobo.2629.2">The new</span><a id="_idIndexMarker328"/><span class="koboSpan" id="kobo.2630.1"> link will take users to the blog’s feed:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2631.1"><img alt="" role="presentation" src="../Images/B21088_03_26.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2632.1">Figure 3.26: The RSS feed subscription link added to the sidebar</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2633.1">You can</span><a id="_idIndexMarker329"/><span class="koboSpan" id="kobo.2634.1"> read more </span><a id="_idIndexMarker330"/><span class="koboSpan" id="kobo.2635.1">about the Django syndication feed framework at </span><a href="https://docs.djangoproject.com/en/5.0/ref/contrib/syndication/"><span class="url"><span class="koboSpan" id="kobo.2636.1">https://docs.djangoproject.com/en/5.0/ref/contrib/syndication/</span></span></a><span class="koboSpan" id="kobo.2637.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-126"><span class="koboSpan" id="kobo.2638.1">Adding full-text search to the blog</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2639.1">Next, we will add search capabilities to the</span><a id="_idIndexMarker331"/><span class="koboSpan" id="kobo.2640.1"> blog. </span><span class="koboSpan" id="kobo.2640.2">Searching for data in the database with user input is a common task for web applications. </span><span class="koboSpan" id="kobo.2640.3">The Django </span><a id="_idIndexMarker332"/><span class="koboSpan" id="kobo.2641.1">ORM allows you to perform simple matching operations using, for example, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2642.1">contains</span></code><span class="koboSpan" id="kobo.2643.1"> filter (or its case-insensitive version, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2644.1">icontains</span></code><span class="koboSpan" id="kobo.2645.1">). </span><span class="koboSpan" id="kobo.2645.2">You can use the following query to find posts that contain the word </span><code class="inlineCode"><span class="koboSpan" id="kobo.2646.1">framework</span></code><span class="koboSpan" id="kobo.2647.1"> in their body:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2648.1">from</span></span><span class="koboSpan" id="kobo.2649.1"> blog.models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2650.1">import</span></span><span class="koboSpan" id="kobo.2651.1"> Post
Post.objects.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2652.1">filter</span></span><span class="koboSpan" id="kobo.2653.1">(body__contains=</span><span class="hljs-string"><span class="koboSpan" id="kobo.2654.1">'framework'</span></span><span class="koboSpan" id="kobo.2655.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2656.1">However, if you want to perform complex search lookups, retrieving results by similarity, or by weighting terms based on how frequently they appear in the text or how important different fields are (for example, the relevancy of the term appearing in the title versus in the body), you will need to use a full-text search engine. </span><span class="koboSpan" id="kobo.2656.2">When you consider large blocks of text, building queries with operations on a string of characters is not enough. </span><span class="koboSpan" id="kobo.2656.3">A full-text search examines the</span><a id="_idIndexMarker333"/><span class="koboSpan" id="kobo.2657.1"> actual words against stored content as it tries to match search criteria.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2658.1">Django provides a powerful </span><a id="_idIndexMarker334"/><span class="koboSpan" id="kobo.2659.1">search functionality built on top of PostgreSQL database full-text search features. </span><span class="koboSpan" id="kobo.2659.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2660.1">django.contrib.postgres</span></code><span class="koboSpan" id="kobo.2661.1"> module provides functionalities offered by PostgreSQL that are not shared by the other databases that Django supports. </span><span class="koboSpan" id="kobo.2661.2">You can learn about PostgreSQL’s full-text search support at </span><a href="https://www.postgresql.org/docs/16/textsearch.html"><span class="url"><span class="koboSpan" id="kobo.2662.1">https://www.postgresql.org/docs/16/textsearch.html</span></span></a><span class="koboSpan" id="kobo.2663.1">.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.2664.1">Although Django is a database-agnostic web framework, it provides a module that supports part of the rich feature set offered by PostgreSQL, which is not offered by other databases that Django supports.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.2665.1">We are currently using an SQLite database for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2666.1">mysite</span></code><span class="koboSpan" id="kobo.2667.1"> project. </span><span class="koboSpan" id="kobo.2667.2">SQLite support for full-text search is limited and Django doesn’t support it out of the box. </span><span class="koboSpan" id="kobo.2667.3">However, PostgreSQL is much better suited for full-text search and we can use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2668.1">django.contrib.postgres</span></code><span class="koboSpan" id="kobo.2669.1"> module to use PostgreSQL’s full-text search capabilities. </span><span class="koboSpan" id="kobo.2669.2">We will migrate our data from SQLite to PostgreSQL to benefit from its full-text search features.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.2670.1">SQLite is sufficient for development purposes. </span><span class="koboSpan" id="kobo.2670.2">However, for a production environment, you will need a more powerful database, such as PostgreSQL, MariaDB, MySQL, or Oracle.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.2671.1">PostgreSQL provides a Docker image that makes it very easy to deploy a PostgreSQL server with a standard configuration.</span></p>
<h2 class="heading-2" id="_idParaDest-127"><span class="koboSpan" id="kobo.2672.1">Installing Docker</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2673.1">Docker is a popular </span><a id="_idIndexMarker335"/><span class="koboSpan" id="kobo.2674.1">open-source containerization platform. </span><span class="koboSpan" id="kobo.2674.2">It enables </span><a id="_idIndexMarker336"/><span class="koboSpan" id="kobo.2675.1">developers to package applications into containers, simplifying the process of building, running, managing, and distributing applications.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2676.1">First, download and install Docker for your OS. </span><span class="koboSpan" id="kobo.2676.2">You will find instructions for downloading and installing</span><a id="_idIndexMarker337"/><span class="koboSpan" id="kobo.2677.1"> Docker on Linux, macOS, and Windows at </span><a href="https://docs.docker.com/get-docker/"><span class="url"><span class="koboSpan" id="kobo.2678.1">https://docs.docker.com/get-docker/</span></span></a><span class="koboSpan" id="kobo.2679.1">. </span><span class="koboSpan" id="kobo.2679.2">The installation includes both Docker Desktop and Docker command-line interface </span><a id="_idIndexMarker338"/><span class="koboSpan" id="kobo.2680.1">tools.</span></p>
<h2 class="heading-2" id="_idParaDest-128"><span class="koboSpan" id="kobo.2681.1">Installing PostgreSQL</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2682.1">After installing Docker on </span><a id="_idIndexMarker339"/><span class="koboSpan" id="kobo.2683.1">your Linux, macOS, or Windows machine, you </span><a id="_idIndexMarker340"/><span class="koboSpan" id="kobo.2684.1">can easily pull the PostgreSQL Docker image. </span><span class="koboSpan" id="kobo.2684.2">Run the following command from the shell:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2685.1">docker pull postgres:16.2
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2686.1">This will download the PostgreSQL Docker image to your local machine. </span><span class="koboSpan" id="kobo.2686.2">You can find information about the official PostgreSQL Docker image at </span><a href="https://hub.docker.com/_/postgres"><span class="url"><span class="koboSpan" id="kobo.2687.1">https://hub.docker.com/_/postgres</span></span></a><span class="koboSpan" id="kobo.2688.1">. </span><span class="koboSpan" id="kobo.2688.2">You can find other PostgreSQL packages and installers at </span><a href="https://www.postgresql.org/download/"><span class="url"><span class="koboSpan" id="kobo.2689.1">https://www.postgresql.org/download/</span></span></a><span class="koboSpan" id="kobo.2690.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2691.1">Execute the following command in the shell to start the PostgreSQL Docker container:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2692.1">docker run --name=blog_db -e POSRGRES_DB=blog -e POSTGRES_USER=blog -e POSTGRES_PASSWORD=xxxxx -p 5432:5432 -d postgres:16.2
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2693.1">Replace </span><code class="inlineCode"><span class="koboSpan" id="kobo.2694.1">xxxxx</span></code><span class="koboSpan" id="kobo.2695.1"> with the desired password for your database user.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2696.1">This command starts a PostgreSQL instance. </span><span class="koboSpan" id="kobo.2696.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2697.1">--name</span></code><span class="koboSpan" id="kobo.2698.1"> option is used to assign a name to the container, in this case, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2699.1">blog_db</span></code><span class="koboSpan" id="kobo.2700.1">. </span><span class="koboSpan" id="kobo.2700.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2701.1">-e</span></code><span class="koboSpan" id="kobo.2702.1"> option is to define environment variables for the instance. </span><span class="koboSpan" id="kobo.2702.2">We set the following environment variables:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2703.1">POSTGRES_DB</span></code><span class="koboSpan" id="kobo.2704.1">: Name of the PostgreSQL database. </span><span class="koboSpan" id="kobo.2704.2">If not defined, the value of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2705.1">POSTGRES_USER</span></code><span class="koboSpan" id="kobo.2706.1"> is used for the database name.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2707.1">POSTGRES_USER</span></code><span class="koboSpan" id="kobo.2708.1">: Used in conjunction with </span><code class="inlineCode"><span class="koboSpan" id="kobo.2709.1">POSTGRES_PASSWORD</span></code><span class="koboSpan" id="kobo.2710.1"> to define a username and password. </span><span class="koboSpan" id="kobo.2710.2">The user is created with superuser power.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2711.1">POSTGRES_PASSWORD</span></code><span class="koboSpan" id="kobo.2712.1">: Sets the superuser password for PostgreSQL.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.2713.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2714.1">-p</span></code><span class="koboSpan" id="kobo.2715.1"> option is used to publish the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2716.1">5432</span></code><span class="koboSpan" id="kobo.2717.1"> port, on which PostgreSQL runs, to the same host interface port. </span><span class="koboSpan" id="kobo.2717.2">This allows external applications to access the database. </span><span class="koboSpan" id="kobo.2717.3">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2718.1">-d</span></code><span class="koboSpan" id="kobo.2719.1"> option is for </span><em class="italic"><span class="koboSpan" id="kobo.2720.1">detached mode</span></em><span class="koboSpan" id="kobo.2721.1">, which runs the Docker container in the background.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2722.1">Open the Docker Desktop application. </span><span class="koboSpan" id="kobo.2722.2">You should see the new container running, as in </span><em class="italic"><span class="koboSpan" id="kobo.2723.1">Figure 3.27</span></em><span class="koboSpan" id="kobo.2724.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2725.1"><img alt="" role="presentation" src="../Images/B21088_03_27.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2726.1">Figure 3.27: PostgreSQL instance running in Docker Desktop</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2727.1">You will see the newly created </span><code class="inlineCode"><span class="koboSpan" id="kobo.2728.1">blog_db</span></code><span class="koboSpan" id="kobo.2729.1"> container, with the status </span><strong class="screenText"><span class="koboSpan" id="kobo.2730.1">Running</span></strong><span class="koboSpan" id="kobo.2731.1">. </span><span class="koboSpan" id="kobo.2731.2">Under </span><strong class="screenText"><span class="koboSpan" id="kobo.2732.1">Actions</span></strong><span class="koboSpan" id="kobo.2733.1">, you can stop or restart the service. </span><span class="koboSpan" id="kobo.2733.2">You can also delete the container. </span><span class="koboSpan" id="kobo.2733.3">Note that deleting the container will also eliminate the database and all the data it contains. </span><span class="koboSpan" id="kobo.2733.4">You will learn how to persist </span><a id="_idIndexMarker341"/><span class="koboSpan" id="kobo.2734.1">PostgreSQL data in the local filesystem using Docker in </span><em class="chapterRef"><span class="koboSpan" id="kobo.2735.1">Chapter 17</span></em><span class="koboSpan" id="kobo.2736.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2737.1">Going Live</span></em><span class="koboSpan" id="kobo.2738.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2739.1">You also need to install the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2740.1">psycopg</span></code><span class="koboSpan" id="kobo.2741.1"> PostgreSQL</span><a id="_idIndexMarker342"/><span class="koboSpan" id="kobo.2742.1"> adapter for Python. </span><span class="koboSpan" id="kobo.2742.2">Run the following command in the shell prompt to install it:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2743.1">python -m pip install psycopg==3.1.18
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2744.1">Next, we will migrate the existing data in the SQLite database to the new PostgreSQL instance.</span></p>
<h2 class="heading-2" id="_idParaDest-129"><span class="koboSpan" id="kobo.2745.1">Dumping the existing data</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2746.1">Before switching the database</span><a id="_idIndexMarker343"/><span class="koboSpan" id="kobo.2747.1"> in the Django project, we need to dump the existing data from the SQLite database. </span><span class="koboSpan" id="kobo.2747.2">We will export the data, switch the project’s database to PostgreSQL, and import the data into the new database.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2748.1">Django comes with a simple way to load and dump data from the database into files that are called </span><strong class="keyWord"><span class="koboSpan" id="kobo.2749.1">fixtures</span></strong><span class="koboSpan" id="kobo.2750.1">. </span><span class="koboSpan" id="kobo.2750.2">Django supports fixtures</span><a id="_idIndexMarker344"/><span class="koboSpan" id="kobo.2751.1"> in JSON, XML, or YAML format. </span><span class="koboSpan" id="kobo.2751.2">We are going to create a fixture with all data contained in the database.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2752.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2753.1">dumpdata</span></code><span class="koboSpan" id="kobo.2754.1"> command dumps data from the database into the standard output, serialized in JSON format by default. </span><span class="koboSpan" id="kobo.2754.2">The resulting data structure includes information about the model and its fields for Django to be able to load it into the database.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2755.1">You can limit the output to the models of an application by providing the application names to the command, or specifying single models for outputting data using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2756.1">app.Model</span></code><span class="koboSpan" id="kobo.2757.1"> format. </span><span class="koboSpan" id="kobo.2757.2">You can also specify the format using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2758.1">--format</span></code><span class="koboSpan" id="kobo.2759.1"> flag. </span><span class="koboSpan" id="kobo.2759.2">By default, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2760.1">dumpdata</span></code><span class="koboSpan" id="kobo.2761.1"> outputs the serialized data to the standard output. </span><span class="koboSpan" id="kobo.2761.2">However, you can indicate an output file using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2762.1">--output</span></code><span class="koboSpan" id="kobo.2763.1"> flag. </span><span class="koboSpan" id="kobo.2763.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2764.1">--indent</span></code><span class="koboSpan" id="kobo.2765.1"> flag allows you to specify indentation. </span><span class="koboSpan" id="kobo.2765.2">For more information on </span><code class="inlineCode"><span class="koboSpan" id="kobo.2766.1">dumpdata</span></code><span class="koboSpan" id="kobo.2767.1"> parameters, run </span><code class="inlineCode"><span class="koboSpan" id="kobo.2768.1">python manage.py dumpdata --help</span></code><span class="koboSpan" id="kobo.2769.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2770.1">Execute the following command from the shell prompt:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2771.1">python manage.py dumpdata --indent=2 --output=mysite_data.json
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2772.1">All existing data has been </span><a id="_idIndexMarker345"/><span class="koboSpan" id="kobo.2773.1">exported in JSON format to a new file named </span><code class="inlineCode"><span class="koboSpan" id="kobo.2774.1">mysite_data.json</span></code><span class="koboSpan" id="kobo.2775.1">. </span><span class="koboSpan" id="kobo.2775.2">You can view the file contents to see the JSON structure that includes all the different data objects for the different models of your installed applications. </span><span class="koboSpan" id="kobo.2775.3">If you get an encoding error when running the command, include the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2776.1">-Xutf8</span></code><span class="koboSpan" id="kobo.2777.1"> flag as follows to activate Python UTF-8 mode:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2778.1">python -Xutf8 manage.py dumpdata --indent=2 --output=mysite_data.json
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2779.1">We will now switch the database in the Django project and then we will import the data into the new database.</span></p>
<h2 class="heading-2" id="_idParaDest-130"><span class="koboSpan" id="kobo.2780.1">Switching the database in the project</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2781.1">Now you will add the PostgreSQL database </span><a id="_idIndexMarker346"/><span class="koboSpan" id="kobo.2782.1">configuration to your project settings.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2783.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2784.1">settings.py</span></code><span class="koboSpan" id="kobo.2785.1"> file of your project and modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2786.1">DATABASES</span></code><span class="koboSpan" id="kobo.2787.1"> setting to make it look as follows. </span><span class="koboSpan" id="kobo.2787.2">New code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2788.1">DATABASES = {
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.2789.1">'default'</span></span><span class="koboSpan" id="kobo.2790.1">: {
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2791.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2792.1">ENGINE'</span></span><span class="koboSpan" id="kobo.2793.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.2794.1">'django.db.backends.</span></span><span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2795.1">postgresql</span></strong></span><span class="hljs-string"><span class="koboSpan" id="kobo.2796.1">'</span></span><span class="koboSpan" id="kobo.2797.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2798.1">'NAME'</span></span><span class="koboSpan" id="kobo.2799.1">: </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2800.1">config(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2801.1">'DB_NAME'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2802.1">),</span></strong></span>
<span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2803.1">'USER'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2804.1">: config(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2805.1">'DB_USER'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2806.1">),</span></strong></span>
<span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2807.1">'PASSWORD'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2808.1">: config(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2809.1">'DB_PASSWORD'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2810.1">),</span></strong></span>
<span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2811.1">'HOST'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2812.1">: config(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2813.1">'DB_HOST'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2814.1">),</span></strong></span><span class="koboSpan" id="kobo.2815.1">
    }
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2816.1">The database engine is now </span><code class="inlineCode"><span class="koboSpan" id="kobo.2817.1">postgresql</span></code><span class="koboSpan" id="kobo.2818.1">. </span><span class="koboSpan" id="kobo.2818.2">The database credentials are now loaded from environment variables using </span><code class="inlineCode"><span class="koboSpan" id="kobo.2819.1">python-decouple</span></code><span class="koboSpan" id="kobo.2820.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2821.1">Let’s add values to the environment variables. </span><span class="koboSpan" id="kobo.2821.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2822.1">.env</span></code><span class="koboSpan" id="kobo.2823.1"> file of your project and add the following lines highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2824.1">EMAIL_HOST_USER=your_account@gmail.com
EMAIL_HOST_PASSWORD=xxxxxxxxxxxx
DEFAULT_FROM_EMAIL=My Blog &lt;your_account@gmail.com&gt;
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2825.1">DB_NAME=blog</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2826.1">DB_USER=blog</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2827.1">DB_PASSWORD=xxxxx</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2828.1">DB_HOST=localhost</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2829.1">Replace </span><code class="inlineCode"><span class="koboSpan" id="kobo.2830.1">xxxxxx</span></code><span class="koboSpan" id="kobo.2831.1"> with the password</span><a id="_idIndexMarker347"/><span class="koboSpan" id="kobo.2832.1"> you used when starting the PostgreSQL container. </span><span class="koboSpan" id="kobo.2832.2">The new database is empty.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2833.1">Run the following command to apply all database migrations to the new PostgreSQL database:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2834.1">python manage.py migrate
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2835.1">You will see an output, including all the migrations that have been applied, like this:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2836.1">Operations to perform:
  Apply all migrations: admin, auth, blog, contenttypes, sessions, sites, taggit
Running migrations:
  Applying contenttypes.0001_initial... </span><span class="koboSpan" id="kobo.2836.2">OK
  Applying auth.0001_initial... </span><span class="koboSpan" id="kobo.2836.3">OK
  Applying admin.0001_initial... </span><span class="koboSpan" id="kobo.2836.4">OK
  Applying admin.0002_logentry_remove_auto_add... </span><span class="koboSpan" id="kobo.2836.5">OK
  Applying admin.0003_logentry_add_action_flag_choices... </span><span class="koboSpan" id="kobo.2836.6">OK
  Applying contenttypes.0002_remove_content_type_name... </span><span class="koboSpan" id="kobo.2836.7">OK
  Applying auth.0002_alter_permission_name_max_length... </span><span class="koboSpan" id="kobo.2836.8">OK
  Applying auth.0003_alter_user_email_max_length... </span><span class="koboSpan" id="kobo.2836.9">OK
  Applying auth.0004_alter_user_username_opts... </span><span class="koboSpan" id="kobo.2836.10">OK
  Applying auth.0005_alter_user_last_login_null... </span><span class="koboSpan" id="kobo.2836.11">OK
  Applying auth.0006_require_contenttypes_0002... </span><span class="koboSpan" id="kobo.2836.12">OK
  Applying auth.0007_alter_validators_add_error_messages... </span><span class="koboSpan" id="kobo.2836.13">OK
  Applying auth.0008_alter_user_username_max_length... </span><span class="koboSpan" id="kobo.2836.14">OK
  Applying auth.0009_alter_user_last_name_max_length... </span><span class="koboSpan" id="kobo.2836.15">OK
  Applying auth.0010_alter_group_name_max_length... </span><span class="koboSpan" id="kobo.2836.16">OK
  Applying auth.0011_update_proxy_permissions... </span><span class="koboSpan" id="kobo.2836.17">OK
  Applying auth.0012_alter_user_first_name_max_length... </span><span class="koboSpan" id="kobo.2836.18">OK
  Applying taggit.0001_initial... </span><span class="koboSpan" id="kobo.2836.19">OK
  Applying taggit.0002_auto_20150616_2121... </span><span class="koboSpan" id="kobo.2836.20">OK
  Applying taggit.0003_taggeditem_add_unique_index... </span><span class="koboSpan" id="kobo.2836.21">OK
  Applying taggit.0004_alter_taggeditem_content_type_alter_taggeditem_tag... </span><span class="koboSpan" id="kobo.2836.22">OK
  Applying taggit.0005_auto_20220424_2025... </span><span class="koboSpan" id="kobo.2836.23">OK
  Applying taggit.0006_rename_taggeditem_content_type_object_id_taggit_tagg_content_8fc721_idx... </span><span class="koboSpan" id="kobo.2836.24">OK
  Applying blog.0001_initial... </span><span class="koboSpan" id="kobo.2836.25">OK
  Applying blog.0002_alter_post_slug... </span><span class="koboSpan" id="kobo.2836.26">OK
  Applying blog.0003_comment... </span><span class="koboSpan" id="kobo.2836.27">OK
  Applying blog.0004_post_tags... </span><span class="koboSpan" id="kobo.2836.28">OK
  Applying sessions.0001_initial... </span><span class="koboSpan" id="kobo.2836.29">OK
  Applying sites.0001_initial... </span><span class="koboSpan" id="kobo.2836.30">OK
  Applying sites.0002_alter_domain_unique... </span><span class="koboSpan" id="kobo.2836.31">OK
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2837.1">The PostgreSQL database is now in sync with your data models and you can run your Django project pointing to the new database. </span><span class="koboSpan" id="kobo.2837.2">Let’s get the database to the same state by loading the data we </span><a id="_idIndexMarker348"/><span class="koboSpan" id="kobo.2838.1">previously exported from SQLite.</span></p>
<h2 class="heading-2" id="_idParaDest-131"><span class="koboSpan" id="kobo.2839.1">Loading the data into the new database</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2840.1">We are going to load the data fixtures we</span><a id="_idIndexMarker349"/><span class="koboSpan" id="kobo.2841.1"> generated previously into our new PostgreSQL database.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2842.1">Run the following command to load the previously exported data into the PostgreSQL database:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2843.1">python manage.py loaddata mysite_data.json
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2844.1">You will see the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2845.1">Installed 104 object(s) from 1 fixture(s)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2846.1">The number of objects might differ, depending on the users, posts, comments, and other objects that have been created in the database.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2847.1">Start the development server from the shell prompt with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2848.1">python manage.py runserver
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2849.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.2850.1">http://127.0.0.1:8000/admin/blog/post/</span></code><span class="koboSpan" id="kobo.2851.1"> in your browser to verify that all posts have been loaded</span><a id="_idIndexMarker350"/><span class="koboSpan" id="kobo.2852.1"> into the new database. </span><span class="koboSpan" id="kobo.2852.2">You should see all the posts, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2853.1"><img alt="" role="presentation" src="../Images/B21088_03_28.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2854.1">Figure 3.28: The list of posts on the administration site</span></p>
<h2 class="heading-2" id="_idParaDest-132"><span class="koboSpan" id="kobo.2855.1">Simple search lookups</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2856.1">Having enabled PostgreSQL in our project, we can now build a powerful search engine by leveraging PostgreSQL’s full-text search capabilities. </span><span class="koboSpan" id="kobo.2856.2">We will begin with basic search lookups and progressively incorporate</span><a id="_idIndexMarker351"/><span class="koboSpan" id="kobo.2857.1"> more sophisticated features, such as stemming, ranking, or weighting queries, to build a comprehensive full-text search engine.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2858.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2859.1">settings.py</span></code><span class="koboSpan" id="kobo.2860.1"> file of your project and add </span><code class="inlineCode"><span class="koboSpan" id="kobo.2861.1">django.contrib.postgres</span></code><span class="koboSpan" id="kobo.2862.1"> to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2863.1">INSTALLED_APPS</span></code><span class="koboSpan" id="kobo.2864.1"> setting, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2865.1">INSTALLED_APPS = [
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.2866.1">'django.contrib.admin'</span></span><span class="koboSpan" id="kobo.2867.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.2868.1">'django.contrib.auth'</span></span><span class="koboSpan" id="kobo.2869.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.2870.1">'django.contrib.contenttypes'</span></span><span class="koboSpan" id="kobo.2871.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.2872.1">'django.contrib.sessions'</span></span><span class="koboSpan" id="kobo.2873.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.2874.1">'django.contrib.messages'</span></span><span class="koboSpan" id="kobo.2875.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.2876.1">'django.contrib.sites'</span></span><span class="koboSpan" id="kobo.2877.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.2878.1">'django.contrib.sitemaps'</span></span><span class="koboSpan" id="kobo.2879.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.2880.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2881.1">django.contrib.staticfiles'</span></span><span class="koboSpan" id="kobo.2882.1">,
</span><span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2883.1">    'django.contrib.postgres'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2884.1">,</span></strong></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.2885.1">'taggit'</span></span><span class="koboSpan" id="kobo.2886.1">,
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.2887.1">'blog.apps.BlogConfig'</span></span><span class="koboSpan" id="kobo.2888.1">,
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2889.1">Open the Django shell by running the following command in the system shell prompt:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2890.1">python manage.py shell
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2891.1">Now you can search against a single field using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2892.1">search</span></code><span class="koboSpan" id="kobo.2893.1"> QuerySet lookup.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2894.1">Run the following code in the Python shell:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2895.1">&gt;&gt;&gt;</span></span> <span class="hljs-con-keyword"><span class="koboSpan" id="kobo.2896.1">from</span></span><span class="koboSpan" id="kobo.2897.1"> blog.models </span><span class="hljs-con-keyword"><span class="koboSpan" id="kobo.2898.1">import</span></span><span class="koboSpan" id="kobo.2899.1"> Post
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2900.1">&gt;&gt;&gt;</span></span><span class="koboSpan" id="kobo.2901.1"> Post.objects.</span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.2902.1">filter</span></span><span class="koboSpan" id="kobo.2903.1">(title__search=</span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2904.1">'django'</span></span><span class="koboSpan" id="kobo.2905.1">)
&lt;QuerySet [&lt;Post: Who was Django Reinhardt?&gt;]&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2906.1">This query uses PostgreSQL to create</span><a id="_idIndexMarker352"/><span class="koboSpan" id="kobo.2907.1"> a search vector for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2908.1">title</span></code><span class="koboSpan" id="kobo.2909.1"> field and a search query from the term </span><code class="inlineCode"><span class="koboSpan" id="kobo.2910.1">django</span></code><span class="koboSpan" id="kobo.2911.1">. </span><span class="koboSpan" id="kobo.2911.2">Results are obtained by matching the query with the vector.</span></p>
<h2 class="heading-2" id="_idParaDest-133"><span class="koboSpan" id="kobo.2912.1">Searching against multiple fields</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2913.1">You might want to search against </span><a id="_idIndexMarker353"/><span class="koboSpan" id="kobo.2914.1">multiple fields. </span><span class="koboSpan" id="kobo.2914.2">In this case, you will need to define a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2915.1">SearchVector</span></code><span class="koboSpan" id="kobo.2916.1"> object. </span><span class="koboSpan" id="kobo.2916.2">Let’s build a vector that allows you to search against the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2917.1">title</span></code><span class="koboSpan" id="kobo.2918.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2919.1">body</span></code><span class="koboSpan" id="kobo.2920.1"> fields of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2921.1">Post</span></code><span class="koboSpan" id="kobo.2922.1"> model.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2923.1">Run the following code in the Python shell:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2924.1">&gt;&gt;&gt;</span></span> <span class="hljs-con-keyword"><span class="koboSpan" id="kobo.2925.1">from</span></span><span class="koboSpan" id="kobo.2926.1"> django.contrib.postgres.search </span><span class="hljs-con-keyword"><span class="koboSpan" id="kobo.2927.1">import</span></span><span class="koboSpan" id="kobo.2928.1"> SearchVector
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2929.1">&gt;&gt;&gt;</span></span> <span class="hljs-con-keyword"><span class="koboSpan" id="kobo.2930.1">from</span></span><span class="koboSpan" id="kobo.2931.1"> blog.models </span><span class="hljs-con-keyword"><span class="koboSpan" id="kobo.2932.1">import</span></span><span class="koboSpan" id="kobo.2933.1"> Post
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2934.1">&gt;&gt;&gt;</span></span>
<span class="hljs-con-meta"><span class="koboSpan" id="kobo.2935.1">&gt;&gt;&gt;</span></span><span class="koboSpan" id="kobo.2936.1"> Post.objects.annotate(
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2937.1">...</span></span><span class="koboSpan" id="kobo.2938.1">     search=SearchVector(</span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2939.1">'title'</span></span><span class="koboSpan" id="kobo.2940.1">, </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2941.1">'body'</span></span><span class="koboSpan" id="kobo.2942.1">),
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2943.1">...</span></span><span class="koboSpan" id="kobo.2944.1"> ).</span><span class="hljs-con-built_in"><span class="koboSpan" id="kobo.2945.1">filter</span></span><span class="koboSpan" id="kobo.2946.1">(search=</span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2947.1">'django'</span></span><span class="koboSpan" id="kobo.2948.1">)
&lt;QuerySet [&lt;Post: Markdown post&gt;, &lt;Post: Who was Django Reinhardt?&gt;]&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2949.1">Using </span><code class="inlineCode"><span class="koboSpan" id="kobo.2950.1">annotate</span></code><span class="koboSpan" id="kobo.2951.1"> and defining </span><code class="inlineCode"><span class="koboSpan" id="kobo.2952.1">SearchVector</span></code><span class="koboSpan" id="kobo.2953.1"> with both fields, you provide a functionality to match the query against both the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2954.1">title</span></code><span class="koboSpan" id="kobo.2955.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2956.1">body</span></code><span class="koboSpan" id="kobo.2957.1"> of the posts.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.2958.1">Full-text search is an intensive process. </span><span class="koboSpan" id="kobo.2958.2">If you are searching for more than a few hundred rows, you should define a functional index that matches the search vector you are using. </span><span class="koboSpan" id="kobo.2958.3">Django provides a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2959.1">SearchVectorField</span></code><span class="koboSpan" id="kobo.2960.1"> field for your models. </span><span class="koboSpan" id="kobo.2960.2">You can read more about this at </span><a href="https://docs.djangoproject.com/en/5.0/ref/contrib/postgres/search/#performance"><span class="url"><span class="koboSpan" id="kobo.2961.1">https://docs.djangoproject.com/en/5.0/ref/contrib/postgres/search/#performance</span></span></a><span class="koboSpan" id="kobo.2962.1">.</span></p>
</div>
<h2 class="heading-2" id="_idParaDest-134"><span class="koboSpan" id="kobo.2963.1">Building a search view</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2964.1">Now, you will create a</span><a id="_idIndexMarker354"/><span class="koboSpan" id="kobo.2965.1"> custom view to allow your users to search posts. </span><span class="koboSpan" id="kobo.2965.2">First, you will need a search form. </span><span class="koboSpan" id="kobo.2965.3">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2966.1">forms.py</span></code><span class="koboSpan" id="kobo.2967.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2968.1">blog</span></code><span class="koboSpan" id="kobo.2969.1"> application and add the following form:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2970.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2971.1">SearchForm</span></span><span class="koboSpan" id="kobo.2972.1">(forms.Form):
    query = forms.CharField()
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2973.1">You will use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2974.1">query</span></code><span class="koboSpan" id="kobo.2975.1"> field to let users introduce search terms. </span><span class="koboSpan" id="kobo.2975.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2976.1">views.py</span></code><span class="koboSpan" id="kobo.2977.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2978.1">blog</span></code><span class="koboSpan" id="kobo.2979.1"> application and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.2980.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2981.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2982.1"> django.contrib.postgres.search </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2983.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2984.1"> SearchVector</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2985.1">from</span></span><span class="koboSpan" id="kobo.2986.1"> .forms </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2987.1">import</span></span><span class="koboSpan" id="kobo.2988.1"> CommentForm, EmailPostForm</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2989.1">, SearchForm</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.2990.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2991.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2992.1">post_search</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2993.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.2994.1">request</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2995.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2996.1">form = SearchForm()</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2997.1">query = </span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.2998.1">None</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2999.1">results = []</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3000.1">if</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3001.1">'query'</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3002.1">in</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3003.1"> request.GET:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3004.1">form = SearchForm(request.GET)</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3005.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3006.1"> form.is_valid():</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3007.1">query = form.cleaned_data[</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3008.1">'query'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3009.1">]</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3010.1">results = (</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3011.1">                Post.published.annotate(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3012.1">search=SearchVector(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3013.1">'title'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3014.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3015.1">'body'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3016.1">),</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3017.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3018.1">                .</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.3019.1">filter</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3020.1">(search=query)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3021.1">            )</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3022.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3023.1"> render(</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"> </strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3024.1">request,</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3025.1">'blog/post/search.html'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3026.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"> </strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3027.1">{</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3028.1">'form'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3029.1">: form,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3030.1">'query'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3031.1">: query,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3032.1">'results'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3033.1">: results</span></strong></span>
<span class="code-highlight"><strong class="hljs-string-slc"> </strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3034.1">}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3035.1">    )</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3036.1">In the preceding view, first, we instantiate the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3037.1">SearchForm</span></code><span class="koboSpan" id="kobo.3038.1"> form. </span><span class="koboSpan" id="kobo.3038.2">To check whether the form is submitted, we look for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3039.1">query</span></code><span class="koboSpan" id="kobo.3040.1"> parameter in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3041.1">request.GET</span></code><span class="koboSpan" id="kobo.3042.1"> dictionary. </span><span class="koboSpan" id="kobo.3042.2">We send the form using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3043.1">GET</span></code><span class="koboSpan" id="kobo.3044.1"> method instead of </span><code class="inlineCode"><span class="koboSpan" id="kobo.3045.1">POST</span></code><span class="koboSpan" id="kobo.3046.1"> so that the resulting URL includes the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3047.1">query</span></code><span class="koboSpan" id="kobo.3048.1"> parameter and is </span><a id="_idIndexMarker355"/><span class="koboSpan" id="kobo.3049.1">easy to share. </span><span class="koboSpan" id="kobo.3049.2">When the form is submitted, we instantiate it with the submitted </span><code class="inlineCode"><span class="koboSpan" id="kobo.3050.1">GET</span></code><span class="koboSpan" id="kobo.3051.1"> data and verify that the form data is valid. </span><span class="koboSpan" id="kobo.3051.2">If the form is valid, we search for published posts with a custom </span><code class="inlineCode"><span class="koboSpan" id="kobo.3052.1">SearchVector</span></code><span class="koboSpan" id="kobo.3053.1"> instance built with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3054.1">title</span></code><span class="koboSpan" id="kobo.3055.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.3056.1">body</span></code><span class="koboSpan" id="kobo.3057.1"> fields.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3058.1">The search view is now ready. </span><span class="koboSpan" id="kobo.3058.2">We need to create a template to display the form and the results when the user performs a search.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3059.1">Create a new file inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3060.1">templates/blog/post/</span></code><span class="koboSpan" id="kobo.3061.1"> directory, name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.3062.1">search.html</span></code><span class="koboSpan" id="kobo.3063.1">, and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3064.1">{% extends "blog/base.html" %}
{% load blog_tags %}
{% block title %}Search{% endblock %}
{% block content %}
  {% if query %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.3065.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3066.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3067.1">&gt;</span></span><span class="koboSpan" id="kobo.3068.1">Posts containing "{{ query }}"</span><span class="hljs-tag"><span class="koboSpan" id="kobo.3069.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3070.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3071.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3072.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3073.1">h3</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3074.1">&gt;</span></span><span class="koboSpan" id="kobo.3075.1">
      {% with results.count as total_results %}
        Found {{ total_results }} result{{ total_results|pluralize }}
      {% endwith %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.3076.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3077.1">h3</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3078.1">&gt;</span></span><span class="koboSpan" id="kobo.3079.1">
    {% for post in results %}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.3080.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3081.1">h4</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3082.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3083.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3084.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3085.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3086.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3087.1">"{{ post.get_absolute_url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3088.1">&gt;</span></span><span class="koboSpan" id="kobo.3089.1">
          {{ post.title }}
        </span><span class="hljs-tag"><span class="koboSpan" id="kobo.3090.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3091.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3092.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3093.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3094.1">h4</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3095.1">&gt;</span></span><span class="koboSpan" id="kobo.3096.1">
      {{ post.body|markdown|truncatewords_html:12 }}
    {% empty %}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.3097.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3098.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3099.1">&gt;</span></span><span class="koboSpan" id="kobo.3100.1">There are no results for your query.</span><span class="hljs-tag"><span class="koboSpan" id="kobo.3101.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3102.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3103.1">&gt;</span></span><span class="koboSpan" id="kobo.3104.1">
    {% endfor %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.3105.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3106.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3107.1">&gt;&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3108.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3109.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3110.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3111.1">"{% url "</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.3112.1">blog:post_search</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3113.1">" %}"&gt;</span></span><span class="koboSpan" id="kobo.3114.1">Search again</span><span class="hljs-tag"><span class="koboSpan" id="kobo.3115.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3116.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3117.1">&gt;&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3118.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3119.1">&gt;</span></span><span class="koboSpan" id="kobo.3120.1">
  {% else %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.3121.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3122.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3123.1">&gt;</span></span><span class="koboSpan" id="kobo.3124.1">Search for posts</span><span class="hljs-tag"><span class="koboSpan" id="kobo.3125.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3126.1">h1</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3127.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3128.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3129.1">form</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3130.1">method</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3131.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3132.1">"get"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3133.1">&gt;</span></span><span class="koboSpan" id="kobo.3134.1">
      {{ form.as_p }}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.3135.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3136.1">input</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3137.1">type</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3138.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3139.1">"submit"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.3140.1">value</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3141.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3142.1">"Search"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3143.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.3144.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.3145.1">form</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.3146.1">&gt;</span></span><span class="koboSpan" id="kobo.3147.1">
  {% endif %}
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3148.1">As in the search view, we distinguish whether the form has been submitted by the presence of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3149.1">query</span></code><span class="koboSpan" id="kobo.3150.1"> parameter. </span><span class="koboSpan" id="kobo.3150.2">Before</span><a id="_idIndexMarker356"/><span class="koboSpan" id="kobo.3151.1"> the query is submitted, we display the form and a submit button. </span><span class="koboSpan" id="kobo.3151.2">When the search form is submitted, we display the query performed, the total number of results, and the list of posts that match the search query.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3152.1">Finally, edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3153.1">urls.py</span></code><span class="koboSpan" id="kobo.3154.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3155.1">blog</span></code><span class="koboSpan" id="kobo.3156.1"> application and add the following URL pattern highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3157.1">urlpatterns = [
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.3158.1"># Post views</span></span><span class="koboSpan" id="kobo.3159.1">
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.3160.1">''</span></span><span class="koboSpan" id="kobo.3161.1">, views.post_list, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.3162.1">'post_list'</span></span><span class="koboSpan" id="kobo.3163.1">),
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.3164.1"># path('', views.PostListView.as_view(), name='post_list'),</span></span><span class="koboSpan" id="kobo.3165.1">
    path(
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.3166.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.3167.1">tag/&lt;slug:tag_slug&gt;/'</span></span><span class="koboSpan" id="kobo.3168.1">, views.post_list, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.3169.1">'post_list_by_tag'</span></span>
<span class="hljs-string"> </span><span class="koboSpan" id="kobo.3170.1">),
    path(
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.3171.1">'&lt;int:year&gt;/&lt;int:month&gt;/&lt;int:day&gt;/&lt;slug:post&gt;/'</span></span><span class="koboSpan" id="kobo.3172.1">,
        views.post_detail,
        name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.3173.1">'post_detail'</span></span>
<span class="hljs-string"> </span><span class="koboSpan" id="kobo.3174.1">),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.3175.1">'&lt;int:post_id&gt;/share/'</span></span><span class="koboSpan" id="kobo.3176.1">, views.post_share, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.3177.1">'post_share'</span></span><span class="koboSpan" id="kobo.3178.1">),
    path(
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.3179.1">'&lt;int:post_id&gt;/comment/'</span></span><span class="koboSpan" id="kobo.3180.1">, views.post_comment, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.3181.1">'post_comment'</span></span>
<span class="hljs-string"> </span><span class="koboSpan" id="kobo.3182.1">),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.3183.1">'feed/'</span></span><span class="koboSpan" id="kobo.3184.1">, LatestPostsFeed(), name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.3185.1">'post_feed'</span></span><span class="koboSpan" id="kobo.3186.1">),
    </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3187.1">path(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3188.1">'search/'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3189.1">, views.post_search, name=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3190.1">'post_search'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3191.1">),</span></strong></span><span class="koboSpan" id="kobo.3192.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3193.1">Next, open </span><code class="inlineCode"><span class="koboSpan" id="kobo.3194.1">http://127.0.0.1:8000/blog/search/</span></code><span class="koboSpan" id="kobo.3195.1"> in your browser. </span><span class="koboSpan" id="kobo.3195.2">You should see the following</span><a id="_idIndexMarker357"/><span class="koboSpan" id="kobo.3196.1"> search form:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.3197.1"><img alt="" role="presentation" src="../Images/B21088_03_29.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.3198.1">Figure 3.29: The form with the query field to search for posts</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3199.1">Enter a query and click on the </span><strong class="screenText"><span class="koboSpan" id="kobo.3200.1">SEARCH</span></strong><span class="koboSpan" id="kobo.3201.1"> button. </span><span class="koboSpan" id="kobo.3201.2">You will see the results of the search query, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.3202.1"><img alt="" role="presentation" src="../Images/B21088_03_30.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.3203.1">Figure 3.30: Search results for the term “jazz”</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3204.1">Congratulations! </span><span class="koboSpan" id="kobo.3204.2">You have</span><a id="_idIndexMarker358"/><span class="koboSpan" id="kobo.3205.1"> created a basic search engine for your blog.</span></p>
<h2 class="heading-2" id="_idParaDest-135"><span class="koboSpan" id="kobo.3206.1">Stemming and ranking results</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.3207.1">Stemming is the process of reducing </span><a id="_idIndexMarker359"/><span class="koboSpan" id="kobo.3208.1">words to their word stem, base, or root form. </span><span class="koboSpan" id="kobo.3208.2">Stemming is used by search engines to reduce indexed words to their stem, and to be able to match inflected or derived words. </span><span class="koboSpan" id="kobo.3208.3">For example, the words “music,” “musical,” and “musicality” can be considered similar words by a search engine. </span><span class="koboSpan" id="kobo.3208.4">The stemming</span><a id="_idIndexMarker360"/><span class="koboSpan" id="kobo.3209.1"> process normalizes each search token into a lexeme, a unit of lexical meaning that underlies a set of words that are related through inflection. </span><span class="koboSpan" id="kobo.3209.2">The words “music,” “musical,” and “musicality” would convert to “music” when creating a search query.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3210.1">Django provides a </span><code class="inlineCode"><span class="koboSpan" id="kobo.3211.1">SearchQuery</span></code><span class="koboSpan" id="kobo.3212.1"> class to translate terms into a search query object. </span><span class="koboSpan" id="kobo.3212.2">By default, the terms are passed through stemming algorithms, which helps you to obtain better matches.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3213.1">The PostgreSQL search engine also removes stop words, such as “a,” “the,” “on,” and “of.” </span><span class="koboSpan" id="kobo.3213.2">Stop words are a set of commonly used words in a language. </span><span class="koboSpan" id="kobo.3213.3">They are removed when creating a search query because they appear too frequently to be relevant to searches. </span><span class="koboSpan" id="kobo.3213.4">You can find the list of stop words used by PostgreSQL for the English language at </span><a href="https://github.com/postgres/postgres/blob/master/src/backend/snowball/stopwords/english.stop"><span class="url"><span class="koboSpan" id="kobo.3214.1">https://github.com/postgres/postgres/blob/master/src/backend/snowball/stopwords/english.stop</span></span></a><span class="koboSpan" id="kobo.3215.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3216.1">We also want to order results by relevancy. </span><span class="koboSpan" id="kobo.3216.2">PostgreSQL provides a ranking function that orders results based on how</span><a id="_idIndexMarker361"/><span class="koboSpan" id="kobo.3217.1"> often the query terms appear and how close together they are.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3218.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3219.1">views.py</span></code><span class="koboSpan" id="kobo.3220.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3221.1">blog</span></code><span class="koboSpan" id="kobo.3222.1"> application and add the following imports:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3223.1">from</span></span><span class="koboSpan" id="kobo.3224.1"> django.contrib.postgres.search </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3225.1">import</span></span><span class="koboSpan" id="kobo.3226.1"> (
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.3227.1">SearchVector,
    SearchQuery,
    SearchRank
)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3228.1">Then, edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3229.1">post_search</span></code><span class="koboSpan" id="kobo.3230.1"> view, as follows. </span><span class="koboSpan" id="kobo.3230.2">New code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3231.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3232.1">post_search</span></span><span class="koboSpan" id="kobo.3233.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3234.1">request</span></span><span class="koboSpan" id="kobo.3235.1">):
    form = SearchForm()
    query = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.3236.1">None</span></span><span class="koboSpan" id="kobo.3237.1">
    results = []
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3238.1">if</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.3239.1">'query'</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3240.1">in</span></span><span class="koboSpan" id="kobo.3241.1"> request.GET:
        form = SearchForm(request.GET)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3242.1">if</span></span><span class="koboSpan" id="kobo.3243.1"> form.is_valid():
            query = form.cleaned_data[</span><span class="hljs-string"><span class="koboSpan" id="kobo.3244.1">'query'</span></span><span class="koboSpan" id="kobo.3245.1">]
            </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3246.1">search_vector = SearchVector(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3247.1">'title'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3248.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3249.1">'body'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3250.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3251.1">search_query = SearchQuery(query)</span></strong></span><span class="koboSpan" id="kobo.3252.1">
            results = (
                Post.published.annotate(
                    search=</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3253.1">search_vector,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3254.1">rank=SearchRank(search_vector, search_query)</span></strong></span><span class="koboSpan" id="kobo.3255.1">
                )
                .</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3256.1">filter</span></span><span class="koboSpan" id="kobo.3257.1">(search=</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3258.1">search_query</span></strong></span><span class="koboSpan" id="kobo.3259.1">)
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3260.1">                .order_by(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3261.1">'-rank'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3262.1">)</span></strong></span><span class="koboSpan" id="kobo.3263.1">
            )
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3264.1">return</span></span><span class="koboSpan" id="kobo.3265.1"> render(
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.3266.1">request,
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.3267.1">'blog/post/search.html'</span></span><span class="koboSpan" id="kobo.3268.1">,
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.3269.1">{
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.3270.1">'form'</span></span><span class="koboSpan" id="kobo.3271.1">: form,
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.3272.1">'query'</span></span><span class="koboSpan" id="kobo.3273.1">: query,
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.3274.1">'results'</span></span><span class="koboSpan" id="kobo.3275.1">: results
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.3276.1">}
    )
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3277.1">In the preceding code, we create a </span><code class="inlineCode"><span class="koboSpan" id="kobo.3278.1">SearchQuery</span></code><span class="koboSpan" id="kobo.3279.1"> object, filter results by it, and use </span><code class="inlineCode"><span class="koboSpan" id="kobo.3280.1">SearchRank</span></code><span class="koboSpan" id="kobo.3281.1"> to order the results by relevancy.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3282.1">You can open </span><code class="inlineCode"><span class="koboSpan" id="kobo.3283.1">http://127.0.0.1:8000/blog/search/</span></code><span class="koboSpan" id="kobo.3284.1"> in your browser and test different searches to test stemming and ranking. </span><span class="koboSpan" id="kobo.3284.2">The following is</span><a id="_idIndexMarker362"/><span class="koboSpan" id="kobo.3285.1"> an example of ranking by the number of occurrences of the word </span><code class="inlineCode"><span class="koboSpan" id="kobo.3286.1">django</span></code><span class="koboSpan" id="kobo.3287.1"> in the title and body of the posts:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.3288.1"><img alt="" role="presentation" src="../Images/B21088_03_31.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.3289.1">Figure 3.31: Search results for the term “django”</span></p>
<h2 class="heading-2" id="_idParaDest-136"><span class="koboSpan" id="kobo.3290.1">Stemming and removing stop words in different languages</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.3291.1">We can set up </span><code class="inlineCode"><span class="koboSpan" id="kobo.3292.1">SearchVector</span></code><span class="koboSpan" id="kobo.3293.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.3294.1">SearchQuery</span></code><span class="koboSpan" id="kobo.3295.1"> to execute stemming and remove stop words in any language. </span><span class="koboSpan" id="kobo.3295.2">We can </span><a id="_idIndexMarker363"/><span class="koboSpan" id="kobo.3296.1">pass a </span><code class="inlineCode"><span class="koboSpan" id="kobo.3297.1">config</span></code><span class="koboSpan" id="kobo.3298.1"> attribute to </span><code class="inlineCode"><span class="koboSpan" id="kobo.3299.1">SearchVector</span></code><span class="koboSpan" id="kobo.3300.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.3301.1">SearchQuery</span></code><span class="koboSpan" id="kobo.3302.1"> to use a different search configuration. </span><span class="koboSpan" id="kobo.3302.2">This allows us to use different language parsers and dictionaries. </span><span class="koboSpan" id="kobo.3302.3">The following example executes stemming and removes stop words in Spanish:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.3303.1">search_vector = SearchVector(</span><span class="hljs-string"><span class="koboSpan" id="kobo.3304.1">'title'</span></span><span class="koboSpan" id="kobo.3305.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.3306.1">'body'</span></span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3307.1">, config=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3308.1">'spanish'</span></strong></span><span class="koboSpan" id="kobo.3309.1">)
search_query = SearchQuery(query</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3310.1">, config=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3311.1">'spanish'</span></strong></span><span class="koboSpan" id="kobo.3312.1">)
results = (
    Post.published.annotate(
        search=search_vector,
        rank=SearchRank(search_vector, search_query)
    )
    .</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3313.1">filter</span></span><span class="koboSpan" id="kobo.3314.1">(search=search_query)
    .order_by(</span><span class="hljs-string"><span class="koboSpan" id="kobo.3315.1">'-rank'</span></span><span class="koboSpan" id="kobo.3316.1">)
)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3317.1">You can find the Spanish </span><a id="_idIndexMarker364"/><span class="koboSpan" id="kobo.3318.1">stop words dictionary used by PostgreSQL at </span><a href="https://github.com/postgres/postgres/blob/master/src/backend/snowball/stopwords/spanish.stop"><span class="url"><span class="koboSpan" id="kobo.3319.1">https://github.com/postgres/postgres/blob/master/src/backend/snowball/stopwords/spanish.stop</span></span></a><span class="koboSpan" id="kobo.3320.1">.</span></p>
<h2 class="heading-2" id="_idParaDest-137"><span class="koboSpan" id="kobo.3321.1">Weighting queries</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.3322.1">We can boost specific vectors so that more weight is attributed to them when ordering results by relevancy. </span><span class="koboSpan" id="kobo.3322.2">For example, we </span><a id="_idIndexMarker365"/><span class="koboSpan" id="kobo.3323.1">can use this to give more relevance to posts that are matched by title rather than by content.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3324.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3325.1">views.py</span></code><span class="koboSpan" id="kobo.3326.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3327.1">blog</span></code><span class="koboSpan" id="kobo.3328.1"> application and modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3329.1">post_search</span></code><span class="koboSpan" id="kobo.3330.1"> view as follows. </span><span class="koboSpan" id="kobo.3330.2">New code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3331.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3332.1">post_search</span></span><span class="koboSpan" id="kobo.3333.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3334.1">request</span></span><span class="koboSpan" id="kobo.3335.1">):
    form = SearchForm()
    query = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.3336.1">None</span></span><span class="koboSpan" id="kobo.3337.1">
    results = []
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3338.1">if</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.3339.1">'query'</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3340.1">in</span></span><span class="koboSpan" id="kobo.3341.1"> request.GET:
        form = SearchForm(request.GET)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3342.1">if</span></span><span class="koboSpan" id="kobo.3343.1"> form.is_valid():
            query = form.cleaned_data[</span><span class="hljs-string"><span class="koboSpan" id="kobo.3344.1">'query'</span></span><span class="koboSpan" id="kobo.3345.1">]
            search_vector = SearchVector(
                </span><span class="hljs-string"><span class="koboSpan" id="kobo.3346.1">'title'</span></span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3347.1">, weight=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3348.1">'A'</span></strong></span>
<span class="hljs-string"> </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3349.1">) + SearchVector(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3350.1">'body'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3351.1">, weight=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3352.1">'B'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3353.1">)</span></strong></span><span class="koboSpan" id="kobo.3354.1">
            search_query = SearchQuery(query)
            results = (
                Post.published.annotate(
                    search=search_vector,
                    rank=SearchRank(search_vector, search_query)
                )
                .</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3355.1">filter</span></span><span class="koboSpan" id="kobo.3356.1">(</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3357.1">rank__gte=</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.3358.1">0.3</span></strong></span><span class="koboSpan" id="kobo.3359.1">)
                .order_by(</span><span class="hljs-string"><span class="koboSpan" id="kobo.3360.1">'-rank'</span></span><span class="koboSpan" id="kobo.3361.1">)
            )
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3362.1">return</span></span><span class="koboSpan" id="kobo.3363.1"> render(
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.3364.1">request,
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.3365.1">'blog/post/search.html'</span></span><span class="koboSpan" id="kobo.3366.1">,
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.3367.1">{
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.3368.1">'form'</span></span><span class="koboSpan" id="kobo.3369.1">: form,
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.3370.1">'query'</span></span><span class="koboSpan" id="kobo.3371.1">: query,
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.3372.1">'results'</span></span><span class="koboSpan" id="kobo.3373.1">: results
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.3374.1">}
    )
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3375.1">In the preceding code, we apply different weights to the search vectors built using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3376.1">title</span></code><span class="koboSpan" id="kobo.3377.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.3378.1">body</span></code><span class="koboSpan" id="kobo.3379.1"> fields. </span><span class="koboSpan" id="kobo.3379.2">The </span><a id="_idIndexMarker366"/><span class="koboSpan" id="kobo.3380.1">default weights are </span><code class="inlineCode"><span class="koboSpan" id="kobo.3381.1">D</span></code><span class="koboSpan" id="kobo.3382.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.3383.1">C</span></code><span class="koboSpan" id="kobo.3384.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.3385.1">B</span></code><span class="koboSpan" id="kobo.3386.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.3387.1">A</span></code><span class="koboSpan" id="kobo.3388.1">, and they refer to the numbers </span><code class="inlineCode"><span class="koboSpan" id="kobo.3389.1">0.1</span></code><span class="koboSpan" id="kobo.3390.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.3391.1">0.2</span></code><span class="koboSpan" id="kobo.3392.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.3393.1">0.4</span></code><span class="koboSpan" id="kobo.3394.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.3395.1">1.0</span></code><span class="koboSpan" id="kobo.3396.1">, respectively. </span><span class="koboSpan" id="kobo.3396.2">We apply a weight of </span><code class="inlineCode"><span class="koboSpan" id="kobo.3397.1">1.0</span></code><span class="koboSpan" id="kobo.3398.1"> to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3399.1">title</span></code><span class="koboSpan" id="kobo.3400.1"> search vector (</span><code class="inlineCode"><span class="koboSpan" id="kobo.3401.1">A</span></code><span class="koboSpan" id="kobo.3402.1">) and a weight of </span><code class="inlineCode"><span class="koboSpan" id="kobo.3403.1">0.4</span></code><span class="koboSpan" id="kobo.3404.1"> to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3405.1">body</span></code><span class="koboSpan" id="kobo.3406.1"> vector (</span><code class="inlineCode"><span class="koboSpan" id="kobo.3407.1">B</span></code><span class="koboSpan" id="kobo.3408.1">). </span><span class="koboSpan" id="kobo.3408.2">Title matches will prevail over body content matches. </span><span class="koboSpan" id="kobo.3408.3">We filter the results to display only the ones with a rank higher than </span><code class="inlineCode"><span class="koboSpan" id="kobo.3409.1">0.3</span></code><span class="koboSpan" id="kobo.3410.1">.</span></p>
<h2 class="heading-2" id="_idParaDest-138"><span class="koboSpan" id="kobo.3411.1">Searching with trigram similarity</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.3412.1">Another search approach is trigram similarity. </span><span class="koboSpan" id="kobo.3412.2">A trigram is a group of three consecutive characters. </span><span class="koboSpan" id="kobo.3412.3">You can measure the similarity of two strings by counting the number of trigrams that they share. </span><span class="koboSpan" id="kobo.3412.4">This </span><a id="_idIndexMarker367"/><span class="koboSpan" id="kobo.3413.1">approach turns out to be very effective for measuring the similarity of words in many languages.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3414.1">To use trigrams in PostgreSQL, you will need to install the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3415.1">pg_trgm</span></code><span class="koboSpan" id="kobo.3416.1"> database extension first. </span><span class="koboSpan" id="kobo.3416.2">Django provides database migration operations to create PostgreSQL extensions. </span><span class="koboSpan" id="kobo.3416.3">Let’s add a migration that creates the extension in the database.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3417.1">First, execute the following command in the shell prompt to create an empty migration:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.3418.1">python manage.py makemigrations --name=trigram_ext --empty blog
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3419.1">This will create an empty migration for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3420.1">blog</span></code><span class="koboSpan" id="kobo.3421.1"> application. </span><span class="koboSpan" id="kobo.3421.2">You will see the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.3422.1">Migrations for 'blog':
  blog/migrations/0005_trigram_ext.py
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3423.1">Edit the file </span><code class="inlineCode"><span class="koboSpan" id="kobo.3424.1">blog/migrations/0005_trigram_ext.py</span></code><span class="koboSpan" id="kobo.3425.1"> and add the following lines highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3426.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3427.1"> django.contrib.postgres.operations </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.3428.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3429.1"> TrigramExtension</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.3430.1">from</span></span><span class="koboSpan" id="kobo.3431.1"> django.db </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3432.1">import</span></span><span class="koboSpan" id="kobo.3433.1"> migrations
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3434.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3435.1">Migration</span></span><span class="koboSpan" id="kobo.3436.1">(migrations.Migration):
    dependencies = [
        (</span><span class="hljs-string"><span class="koboSpan" id="kobo.3437.1">'blog'</span></span><span class="koboSpan" id="kobo.3438.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.3439.1">'0004_post_tags'</span></span><span class="koboSpan" id="kobo.3440.1">),
    ]
    operations = [
        </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3441.1">TrigramExtension()</span></strong></span><span class="koboSpan" id="kobo.3442.1">
    ]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3443.1">You have added the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3444.1">TrigramExtension</span></code><span class="koboSpan" id="kobo.3445.1"> operation to the database migration. </span><span class="koboSpan" id="kobo.3445.2">This operation executes the SQL </span><a id="_idIndexMarker368"/><span class="koboSpan" id="kobo.3446.1">statement </span><code class="inlineCode"><span class="koboSpan" id="kobo.3447.1">CREATE EXTENSION pg_trgm</span></code><span class="koboSpan" id="kobo.3448.1"> to create the extension in PostgreSQL. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.3449.1">You can find more information about database migration operations at </span><a href="https://docs.djangoproject.com/en/5.0/ref/contrib/postgres/operations/"><span class="url"><span class="koboSpan" id="kobo.3450.1">https://docs.djangoproject.com/en/5.0/ref/contrib/postgres/operations/</span></span></a><span class="koboSpan" id="kobo.3451.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3452.1">Now execute the migration with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.3453.1">python manage.py migrate blog
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3454.1">You will see the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.3455.1">Running migrations:
  Applying blog.0005_trigram_ext... </span><span class="koboSpan" id="kobo.3455.2">OK
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3456.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.3457.1">pg_trgm</span></code><span class="koboSpan" id="kobo.3458.1"> extension has been created in the database. </span><span class="koboSpan" id="kobo.3458.2">Let’s modify </span><code class="inlineCode"><span class="koboSpan" id="kobo.3459.1">post_search</span></code><span class="koboSpan" id="kobo.3460.1"> to search for trigrams.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3461.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3462.1">views.py</span></code><span class="koboSpan" id="kobo.3463.1"> file of your </span><code class="inlineCode"><span class="koboSpan" id="kobo.3464.1">blog</span></code><span class="koboSpan" id="kobo.3465.1"> application and add the following import:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3466.1">from</span></span><span class="koboSpan" id="kobo.3467.1"> django.contrib.postgres.search </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3468.1">import</span></span><span class="koboSpan" id="kobo.3469.1"> TrigramSimilarity
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3470.1">Then, modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3471.1">post_search</span></code><span class="koboSpan" id="kobo.3472.1"> view as</span><a id="_idIndexMarker369"/><span class="koboSpan" id="kobo.3473.1"> follows. </span><span class="koboSpan" id="kobo.3473.2">New code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.3474.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.3475.1">post_search</span></span><span class="koboSpan" id="kobo.3476.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.3477.1">request</span></span><span class="koboSpan" id="kobo.3478.1">):
    form = SearchForm()
    query = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.3479.1">None</span></span><span class="koboSpan" id="kobo.3480.1">
    results = []
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3481.1">if</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.3482.1">'query'</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.3483.1">in</span></span><span class="koboSpan" id="kobo.3484.1"> request.GET:
        form = SearchForm(request.GET)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3485.1">if</span></span><span class="koboSpan" id="kobo.3486.1"> form.is_valid():
            query = form.cleaned_data[</span><span class="hljs-string"><span class="koboSpan" id="kobo.3487.1">'query'</span></span><span class="koboSpan" id="kobo.3488.1">]
            results = (
                Post.published.annotate(
                    </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3489.1">similarity=TrigramSimilarity(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3490.1">'title'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.3491.1">, query),</span></strong></span><span class="koboSpan" id="kobo.3492.1">
                )
                .</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.3493.1">filter</span></span><span class="koboSpan" id="kobo.3494.1">(</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.3495.1">similarity__gt=</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.3496.1">0.1</span></strong></span><span class="koboSpan" id="kobo.3497.1">)
                .order_by(</span><span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.3498.1">'-similarity'</span></strong></span><span class="koboSpan" id="kobo.3499.1">)
            )
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.3500.1">return</span></span><span class="koboSpan" id="kobo.3501.1"> render(
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.3502.1">request,
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.3503.1">'blog/post/search.html'</span></span><span class="koboSpan" id="kobo.3504.1">,
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.3505.1">{
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.3506.1">'form'</span></span><span class="koboSpan" id="kobo.3507.1">: form,
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.3508.1">'query'</span></span><span class="koboSpan" id="kobo.3509.1">: query,
</span><span class="hljs-keyword"> </span><span class="hljs-string"><span class="koboSpan" id="kobo.3510.1">'results'</span></span><span class="koboSpan" id="kobo.3511.1">: results
</span><span class="hljs-keyword"> </span><span class="koboSpan" id="kobo.3512.1">}
    )
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.3513.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.3514.1">http://127.0.0.1:8000/blog/search/</span></code><span class="koboSpan" id="kobo.3515.1"> in your browser and test different searches for trigrams. </span><span class="koboSpan" id="kobo.3515.2">The following example displays a hypothetical typo in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.3516.1">django</span></code><span class="koboSpan" id="kobo.3517.1"> term, showing search results for </span><code class="inlineCode"><span class="koboSpan" id="kobo.3518.1">yango</span></code><span class="koboSpan" id="kobo.3519.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.3520.1"><img alt="" role="presentation" src="../Images/B21088_03_32.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.3521.1">Figure 3.32: Search results for the term “yango”</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3522.1">We have added a </span><a id="_idIndexMarker370"/><span class="koboSpan" id="kobo.3523.1">powerful search engine to the blog application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3524.1">You can find more information about full-text search with Django and PostgreSQL at </span><a href="https://docs.djangoproject.com/en/5.0/ref/contrib/postgres/search/"><span class="url"><span class="koboSpan" id="kobo.3525.1">https://docs.djangoproject.com/en/5.0/ref/contrib/postgres/search/</span></span></a><span class="koboSpan" id="kobo.3526.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-139"><span class="koboSpan" id="kobo.3527.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3528.1">In this chapter, you implemented a tagging system by integrating a third-party application into your project. </span><span class="koboSpan" id="kobo.3528.2">You generated post recommendations using complex QuerySets. </span><span class="koboSpan" id="kobo.3528.3">You also learned how to create custom Django template tags and filters to provide templates with custom functionalities. </span><span class="koboSpan" id="kobo.3528.4">You also created a sitemap for search engines to crawl your site and an RSS feed for users to subscribe to your blog. </span><span class="koboSpan" id="kobo.3528.5">You then built a search engine for your blog using the full-text search engine of PostgreSQL.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3529.1">In the next chapter, you will learn how to build a social website using the Django authentication framework and how to implement user account functionalities and custom user profiles.</span></p>
<h1 class="heading-1" id="_idParaDest-140"><span class="koboSpan" id="kobo.3530.1">Expanding your project using AI</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3531.1">Having completed the blog application, you likely have numerous ideas for adding new functionalities to your blog. </span><span class="koboSpan" id="kobo.3531.2">This section aims to provide some insights into exploring new functionalities to incorporate into your project with the assistance of ChatGPT. </span><span class="koboSpan" id="kobo.3531.3">ChatGPT is a sophisticated AI </span><strong class="keyWord"><span class="koboSpan" id="kobo.3532.1">Large Language Model</span></strong><span class="koboSpan" id="kobo.3533.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.3534.1">LLM</span></strong><span class="koboSpan" id="kobo.3535.1">) created by OpenAI that generates human-like responses based on the </span><a id="_idIndexMarker371"/><span class="koboSpan" id="kobo.3536.1">prompts it receives. </span><span class="koboSpan" id="kobo.3536.2">In this section, you will be presented with a task to extend your project, accompanied by a sample prompt for ChatGPT to assist you.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3537.1">Engage with ChatGPT at </span><a href="https://chat.openai.com/"><span class="url"><span class="koboSpan" id="kobo.3538.1">https://chat.openai.com/</span></span></a><span class="koboSpan" id="kobo.3539.1">. </span><span class="koboSpan" id="kobo.3539.2">You will find similar guidance after completing each Django project within this book, in </span><em class="italic"><span class="koboSpan" id="kobo.3540.1">Chapter 7</span></em><span class="koboSpan" id="kobo.3541.1">, </span><em class="italic"><span class="koboSpan" id="kobo.3542.1">Tracking User Actions</span></em><span class="koboSpan" id="kobo.3543.1">, </span><em class="italic"><span class="koboSpan" id="kobo.3544.1">Chapter 11</span></em><span class="koboSpan" id="kobo.3545.1">, </span><em class="italic"><span class="koboSpan" id="kobo.3546.1">Adding Internationalization to Your Shop</span></em><span class="koboSpan" id="kobo.3547.1">, and </span><em class="italic"><span class="koboSpan" id="kobo.3548.1">Chapter 17</span></em><span class="koboSpan" id="kobo.3549.1">, </span><em class="italic"><span class="koboSpan" id="kobo.3550.1">Going Live</span></em><span class="koboSpan" id="kobo.3551.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.3552.1">Let’s further enhance your blog with the help of ChatGPT. </span><span class="koboSpan" id="kobo.3552.2">Your blog currently allows filtering posts by tags. </span><span class="koboSpan" id="kobo.3552.3">Adding these tags to our sitemap could significantly improve the SEO optimization of the blog. </span><span class="koboSpan" id="kobo.3552.4">Use the prompt provided at </span><a href="https://github.com/PacktPublishing/Django-5-by-example/blob/main/Chapter03/prompts/task.md"><span class="url"><span class="koboSpan" id="kobo.3553.1">https://github.com/PacktPublishing/Django-5-by-example/blob/main/Chapter03/prompts/task.md</span></span></a><span class="koboSpan" id="kobo.3554.1"> for adding tag pages to the sitemap. </span><span class="koboSpan" id="kobo.3554.2">This challenge is an excellent opportunity to refine your project and deepen your understanding of Django, while learning to interact with ChatGPT.</span></p>
<div class="packt_tip">
<p class="normal"><span class="koboSpan" id="kobo.3555.1">ChatGPT is ready to assist with code issues. </span><span class="koboSpan" id="kobo.3555.2">Simply share your code along with any errors you’re facing, and ChatGPT can help you identify and resolve the issues.</span></p>
</div>
<h1 class="heading-1" id="_idParaDest-141"><span class="koboSpan" id="kobo.3556.1">Additional resources</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3557.1">The following resources provide additional information related to the topics covered in this chapter:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.3558.1">Source code for this chapter: </span><a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter03"><span class="url"><span class="koboSpan" id="kobo.3559.1">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter03</span></span></a></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.3560.1">django-taggit</span></code><span class="koboSpan" id="kobo.3561.1">: </span><a href="https://github.com/jazzband/django-taggit"><span class="url"><span class="koboSpan" id="kobo.3562.1">https://github.com/jazzband/django-taggit</span></span></a></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.3563.1">django-taggit</span></code><span class="koboSpan" id="kobo.3564.1"> ORM managers: </span><a href="https://django-taggit.readthedocs.io/en/latest/api.html"><span class="url"><span class="koboSpan" id="kobo.3565.1">https://django-taggit.readthedocs.io/en/latest/api.html</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3566.1">Many-to-many relationships: </span><a href="https://docs.djangoproject.com/en/5.0/topics/db/examples/many_to_many/"><span class="url"><span class="koboSpan" id="kobo.3567.1">https://docs.djangoproject.com/en/5.0/topics/db/examples/many_to_many/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3568.1">Django aggregation functions: </span><a href="https://docs.djangoproject.com/en/5.0/topics/db/aggregation/"><span class="url"><span class="koboSpan" id="kobo.3569.1">https://docs.djangoproject.com/en/5.0/topics/db/aggregation/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3570.1">Built-in template tags and filters: </span><a href="https://docs.djangoproject.com/en/5.0/ref/templates/builtins/"><span class="url"><span class="koboSpan" id="kobo.3571.1">https://docs.djangoproject.com/en/5.0/ref/templates/builtins/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3572.1">Writing custom template tags: </span><a href="https://docs.djangoproject.com/en/5.0/howto/custom-template-tags/"><span class="url"><span class="koboSpan" id="kobo.3573.1">https://docs.djangoproject.com/en/5.0/howto/custom-template-tags/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3574.1">Markdown format reference: </span><a href="https://daringfireball.net/projects/markdown/basics "><span class="url"><span class="koboSpan" id="kobo.3575.1">https://daringfireball.net/projects/markdown/basics</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3576.1">Django sitemap framework: </span><a href="https://docs.djangoproject.com/en/5.0/ref/contrib/sitemaps/"><span class="url"><span class="koboSpan" id="kobo.3577.1">https://docs.djangoproject.com/en/5.0/ref/contrib/sitemaps/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3578.1">Django sites framework: </span><a href="https://docs.djangoproject.com/en/5.0/ref/contrib/sites/"><span class="url"><span class="koboSpan" id="kobo.3579.1">https://docs.djangoproject.com/en/5.0/ref/contrib/sites/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3580.1">Django syndication feed framework: </span><a href="https://docs.djangoproject.com/en/5.0/ref/contrib/syndication/"><span class="url"><span class="koboSpan" id="kobo.3581.1">https://docs.djangoproject.com/en/5.0/ref/contrib/syndication/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3582.1">Docker download and installation instructions: </span><a href="https://docs.docker.com/get-docker/"><span class="url"><span class="koboSpan" id="kobo.3583.1">https://docs.docker.com/get-docker/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3584.1">PostgreSQL Docker image: </span><a href="https://hub.docker.com/_/postgres"><span class="url"><span class="koboSpan" id="kobo.3585.1">https://hub.docker.com/_/postgres</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3586.1">PostgreSQL downloads: </span><a href="https://www.postgresql.org/download/"><span class="url"><span class="koboSpan" id="kobo.3587.1">https://www.postgresql.org/download/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3588.1">PostgreSQL full-text search capabilities: </span><a href="https://www.postgresql.org/docs/16/textsearch.html"><span class="url"><span class="koboSpan" id="kobo.3589.1">https://www.postgresql.org/docs/16/textsearch.html</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3590.1">Database migration operations: </span><a href="https://docs.djangoproject.com/en/5.0/ref/contrib/postgres/operations/"><span class="url"><span class="koboSpan" id="kobo.3591.1">https://docs.djangoproject.com/en/5.0/ref/contrib/postgres/operations/</span></span></a><span class="koboSpan" id="kobo.3592.1">.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3593.1">Django support for PostgreSQL full-text search – </span><a href="https://docs.djangoproject.com/en/5.0/ref/contrib/postgres/search/"><span class="url"><span class="koboSpan" id="kobo.3594.1">https://docs.djangoproject.com/en/5.0/ref/contrib/postgres/search/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3595.1">ChatGPT interface – </span><a href="https://chat.openai.com/"><span class="url"><span class="koboSpan" id="kobo.3596.1">https://chat.openai.com/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.3597.1">Sample ChatGPT prompt to add tag pages to the sitemap – </span><a href="https://github.com/PacktPublishing/Django-5-by-example/blob/main/Chapter03/prompts/task.md"><span class="url"><span class="koboSpan" id="kobo.3598.1">https://github.com/PacktPublishing/Django-5-by-example/blob/main/Chapter03/prompts/task.md</span></span></a></li>
</ul>
</div>
</body></html>