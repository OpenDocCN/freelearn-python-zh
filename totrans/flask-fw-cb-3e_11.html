<html><head></head><body>
<div id="_idContainer090">
<h1 class="chapter-number" id="_idParaDest-320"><a id="_idTextAnchor610"/><a id="_idTextAnchor611"/><span class="koboSpan" id="kobo.1.1">11</span></h1>
<h1 id="_idParaDest-321"><a id="_idTextAnchor612"/><span class="koboSpan" id="kobo.2.1">Deployment and Post-Deployment</span></h1>
<p><span class="koboSpan" id="kobo.3.1">So far, we have learned how to write Flask applications in different ways. </span><span class="koboSpan" id="kobo.3.2">Deploying an application and managing the application post-deployment is as important as developing it. </span><span class="koboSpan" id="kobo.3.3">There can be various ways of deploying an application and choosing the best way depends on the requirements. </span><span class="koboSpan" id="kobo.3.4">Deploying an application correctly is very important from a security and performance point of view. </span><span class="koboSpan" id="kobo.3.5">There are multiple ways of monitoring an application after deployment, of which some are paid and others are free to use. </span><span class="koboSpan" id="kobo.3.6">Using them depends on the requirements and features that are offered </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">by them.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">In this chapter, we will talk about various application deployment techniques, followed by some monitoring tools that are </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">used post-deployment.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">Each of the tools and techniques we will cover has a set of features. </span><span class="koboSpan" id="kobo.7.2">For example, adding too much monitoring to an application can prove to be an extra overhead to the application and the developers. </span><span class="koboSpan" id="kobo.7.3">Similarly, missing out on monitoring can lead to undetected user errors and overall </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">user dissatisfaction.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.9.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.10.1">In this chapter, I will be focusing on deployment to </span><strong class="bold"><span class="koboSpan" id="kobo.11.1">Ubuntu 22.04</span></strong><span class="koboSpan" id="kobo.12.1"> servers. </span><span class="koboSpan" id="kobo.12.2">This should cover most cases. </span><span class="koboSpan" id="kobo.12.3">I will try to cover any special steps needed for macOS and Windows but do not treat those </span><span class="No-Break"><span class="koboSpan" id="kobo.13.1">as exhaustive.</span></span></p>
<p><span class="koboSpan" id="kobo.14.1">Hence, we should choose the tools that we use wisely, which, in turn, will ease our lives as much </span><span class="No-Break"><span class="koboSpan" id="kobo.15.1">as possible.</span></span></p>
<p><span class="koboSpan" id="kobo.16.1">In terms of post-deployment monitoring tools, we will discuss New Relic. </span><span class="koboSpan" id="kobo.16.2">Sentry is another tool that will prove to be the most beneficial of all from a developer’s perspective. </span><span class="koboSpan" id="kobo.16.3">We covered this in the </span><em class="italic"><span class="koboSpan" id="kobo.17.1">Using Sentry to monitor exceptions</span></em><span class="koboSpan" id="kobo.18.1"> recipe in </span><a href="B19111_10.xhtml#_idTextAnchor502"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.19.1">Chapter 10</span></em></span></a><span class="koboSpan" id="kobo.20.1">, </span><em class="italic"><span class="koboSpan" id="kobo.21.1">Debugging, Error Handling, </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.22.1">and Testing</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.23.1">.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.24.1">Tip</span></p>
<p class="callout"><span class="koboSpan" id="kobo.25.1">Several topics will be covered in this chapter and all of them can be followed/implemented independently of each other. </span><span class="koboSpan" id="kobo.25.2">You can club some of them together to make use of multiple features and I have mentioned this wherever I felt best. </span><span class="koboSpan" id="kobo.25.3">As a software developer, feel free to use your judgment about which library to use for </span><span class="No-Break"><span class="koboSpan" id="kobo.26.1">what purpose.</span></span></p>
<p><span class="koboSpan" id="kobo.27.1">In this chapter, we will cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.28.1">following recipes:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.29.1">Deploying </span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">with Apache</span></span></li>
<li><span class="koboSpan" id="kobo.31.1">Deploying with uWSGI </span><span class="No-Break"><span class="koboSpan" id="kobo.32.1">and Nginx</span></span></li>
<li><span class="koboSpan" id="kobo.33.1">Deploying with Gunicorn </span><span class="No-Break"><span class="koboSpan" id="kobo.34.1">and Supervisor</span></span></li>
<li><span class="koboSpan" id="kobo.35.1">Deploying </span><span class="No-Break"><span class="koboSpan" id="kobo.36.1">with Tornado</span></span></li>
<li><span class="koboSpan" id="kobo.37.1">Using S3 storage for </span><span class="No-Break"><span class="koboSpan" id="kobo.38.1">file uploads</span></span></li>
<li><span class="koboSpan" id="kobo.39.1">Managing and monitoring application performance with </span><span class="No-Break"><span class="koboSpan" id="kobo.40.1">New Relic</span></span></li>
<li><span class="koboSpan" id="kobo.41.1">Infrastructure and application monitoring </span><span class="No-Break"><span class="koboSpan" id="kobo.42.1">with Datadog</span></span></li>
</ul>
<h1 id="_idParaDest-322"><a id="_idTextAnchor613"/><span class="koboSpan" id="kobo.43.1">Deploying with Apache</span></h1>
<p><a id="_idTextAnchor614"/><span class="koboSpan" id="kobo.44.1">In this recipe, we will learn how to </span><a id="_idIndexMarker462"/><span class="koboSpan" id="kobo.45.1">deploy a Flask application with </span><strong class="source-inline"><span class="koboSpan" id="kobo.46.1">Apache</span></strong><span class="koboSpan" id="kobo.47.1">, which is, arguably, the most popular HTTP server. </span><span class="koboSpan" id="kobo.47.2">For Python web applications, we will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.48.1">mod_wsgi</span></strong><span class="koboSpan" id="kobo.49.1">, which </span><a id="_idIndexMarker463"/><span class="koboSpan" id="kobo.50.1">implements a simple Apache module that can host any Python applications that support the </span><span class="No-Break"><span class="koboSpan" id="kobo.51.1">WSGI interface.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.52.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.53.1">Remember that </span><strong class="source-inline"><span class="koboSpan" id="kobo.54.1">mod_wsgi</span></strong><span class="koboSpan" id="kobo.55.1"> is not the same as Apache and needs to be </span><span class="No-Break"><span class="koboSpan" id="kobo.56.1">installed separately</span><a id="_idTextAnchor615"/><span class="koboSpan" id="kobo.57.1">.</span></span></p>
<h2 id="_idParaDest-323"><a id="_idTextAnchor616"/><span class="koboSpan" id="kobo.58.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.59.1">We will </span><a id="_idIndexMarker464"/><span class="koboSpan" id="kobo.60.1">start with the catalog application from the previous</span><a id="_idIndexMarker465"/><span class="koboSpan" id="kobo.61.1"> chapter. </span><span class="koboSpan" id="kobo.61.2">There is no need to make any changes to the </span><span class="No-Break"><span class="koboSpan" id="kobo.62.1">existing code.</span></span></p>
<p><span class="koboSpan" id="kobo.63.1">For deploying with Apache, it is important to make sure that the latest version of the Apache </span><strong class="source-inline"><span class="koboSpan" id="kobo.64.1">httpd</span></strong><span class="koboSpan" id="kobo.65.1"> server is installed on the machine on which you intend to deploy. </span><span class="koboSpan" id="kobo.65.2">Usually, the versions of Apache shipped with the operating systems (especially macOS) might be older and will not be</span><a id="_idIndexMarker466"/><span class="koboSpan" id="kobo.66.1"> supported by the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.67.1">mod_wsgi</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.68.1"> library.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.69.1">Note</span></p>
<p class="callout"><strong class="source-inline"><span class="koboSpan" id="kobo.70.1">httpd</span></strong><span class="koboSpan" id="kobo.71.1"> stands</span><a id="_idIndexMarker467"/><span class="koboSpan" id="kobo.72.1"> for </span><strong class="bold"><span class="koboSpan" id="kobo.73.1">Hypertext Transfer Protocol Daemon</span></strong><span class="koboSpan" id="kobo.74.1">, which refers to a program that waits for requests from web clients and serves them. </span><span class="koboSpan" id="kobo.74.2">In the context of Apache, </span><strong class="source-inline"><span class="koboSpan" id="kobo.75.1">httpd</span></strong><span class="koboSpan" id="kobo.76.1"> refers to the web server that implements the daemon created by Apache Software Foundation. </span><strong class="source-inline"><span class="koboSpan" id="kobo.77.1">apache</span></strong><span class="koboSpan" id="kobo.78.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.79.1">httpd</span></strong><span class="koboSpan" id="kobo.80.1"> are mostly </span><span class="No-Break"><span class="koboSpan" id="kobo.81.1">used interchangeably.</span></span></p>
<p><span class="koboSpan" id="kobo.82.1">For </span><a id="_idIndexMarker468"/><span class="koboSpan" id="kobo.83.1">macOS, </span><strong class="source-inline"><span class="koboSpan" id="kobo.84.1">httpd</span></strong><span class="koboSpan" id="kobo.85.1"> can be </span><a id="_idIndexMarker469"/><span class="koboSpan" id="kobo.86.1">installed </span><span class="No-Break"><span class="koboSpan" id="kobo.87.1">using Homebrew:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.88.1">
$ brew install httpd</span></pre>
<p><span class="koboSpan" id="kobo.89.1">For Ubuntu, </span><strong class="source-inline"><span class="koboSpan" id="kobo.90.1">httpd</span></strong><span class="koboSpan" id="kobo.91.1"> is provided by default. </span><span class="koboSpan" id="kobo.91.2">Just simply </span><span class="No-Break"><span class="koboSpan" id="kobo.92.1">upgrade it:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.93.1">
$ sudo apt update
$ sudo apt install python3-dev
$ sudo apt install apache2 apache2-dev</span></pre>
<p><span class="koboSpan" id="kobo.94.1">For Windows operating systems, please follow the official documentation </span><span class="No-Break"><span class="koboSpan" id="kobo.95.1">at </span></span><a href="https://httpd.apache.org/docs/trunk/platform/"><span class="No-Break"><span class="koboSpan" id="kobo.96.1">https://httpd.apache.org/docs/trunk/platform/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.97.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.98.1">Once Apache has been successfully installed/updated, the next step is to install the </span><strong class="source-inline"><span class="koboSpan" id="kobo.99.1">mod_wsgi</span></strong><span class="koboSpan" id="kobo.100.1"> library. </span><span class="koboSpan" id="kobo.100.2">It can simply be installed inside your </span><span class="No-Break"><span class="koboSpan" id="kobo.101.1">virtual environment:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.102.1">
$ pip install m</span><a id="_idTextAnchor617"/><span class="koboSpan" id="kobo.103.1">od_wsgi</span></pre>
<h2 id="_idParaDest-324"><a id="_idTextAnchor618"/><span class="koboSpan" id="kobo.104.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.105.1">In </span><a id="_idIndexMarker470"/><span class="koboSpan" id="kobo.106.1">stark contrast to </span><a id="_idIndexMarker471"/><span class="koboSpan" id="kobo.107.1">the previous editions of this book, </span><strong class="source-inline"><span class="koboSpan" id="kobo.108.1">mod_wsgi</span></strong><span class="koboSpan" id="kobo.109.1"> now ships with a modern </span><strong class="source-inline"><span class="koboSpan" id="kobo.110.1">mod_wsgi-express</span></strong><span class="koboSpan" id="kobo.111.1"> command, which </span><a id="_idIndexMarker472"/><span class="koboSpan" id="kobo.112.1">removes all the complexity of writing the Apache </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.113.1">httpd</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.114.1"> configuration.</span></span></p>
<p><span class="koboSpan" id="kobo.115.1">The only argument to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.116.1">mod_wsgi-express</span></strong><span class="koboSpan" id="kobo.117.1"> command is a file containing the Flask application object. </span><span class="koboSpan" id="kobo.117.2">So, create a file called </span><strong class="source-inline"><span class="koboSpan" id="kobo.118.1">wsgi.py</span></strong><span class="koboSpan" id="kobo.119.1"> with the </span><span class="No-Break"><span class="koboSpan" id="kobo.120.1">following content:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.121.1">
from my_app import app as application</span></pre>
<p class="callout-heading"><span class="koboSpan" id="kobo.122.1">Important</span></p>
<p class="callout"><span class="koboSpan" id="kobo.123.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.124.1">app</span></strong><span class="koboSpan" id="kobo.125.1"> object needs to be imported as </span><strong class="source-inline"><span class="koboSpan" id="kobo.126.1">application</span></strong><span class="koboSpan" id="kobo.127.1"> since </span><strong class="source-inline"><span class="koboSpan" id="kobo.128.1">mod_wsgi</span></strong><span class="koboSpan" id="kobo.129.1"> expects the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.130.1">applicatio</span><a id="_idTextAnchor619"/><span class="koboSpan" id="kobo.131.1">n</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.132.1"> keyword.</span></span></p>
<h2 id="_idParaDest-325"><a id="_idTextAnchor620"/><span class="koboSpan" id="kobo.133.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.134.1">Run the following command to invoke the web server </span><span class="No-Break"><span class="koboSpan" id="kobo.135.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.136.1">mod_wsgi</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.137.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.138.1">
$ mod_wsgi-express start-server wsgi.py --processes 4</span></pre>
<p><span class="koboSpan" id="kobo.139.1">Now, visit </span><strong class="source-inline"><span class="koboSpan" id="kobo.140.1">http://localhost:8000/</span></strong><span class="koboSpan" id="kobo.141.1"> to see the application </span><span class="No-Break"><span class="koboSpan" id="kobo.142.1">in action.</span></span></p>
<p><span class="koboSpan" id="kobo.143.1">You can also run your application on privileged ports such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.144.1">80</span></strong><span class="koboSpan" id="kobo.145.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.146.1">443</span></strong><span class="koboSpan" id="kobo.147.1"> by providing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.148.1">--port</span></strong><span class="koboSpan" id="kobo.149.1"> parameter. </span><span class="koboSpan" id="kobo.149.2">Just make sure that the shell user/group running the command has permission to access the port(s). </span><span class="koboSpan" id="kobo.149.3">If not, you can change the user/group to the relevant ones by</span><a id="_idIndexMarker473"/><span class="koboSpan" id="kobo.150.1"> passing</span><a id="_idIndexMarker474"/><span class="koboSpan" id="kobo.151.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.152.1">--user</span></strong><span class="koboSpan" id="kobo.153.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.154.1">--</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.155.1">group</span><a id="_idTextAnchor621"/></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.156.1"> parameters.</span></span></p>
<h2 id="_idParaDest-326"><a id="_idTextAnchor622"/><span class="koboSpan" id="kobo.157.1">See also</span></h2>
<p><span class="koboSpan" id="kobo.158.1">Refer to </span><a href="http://httpd.apache.org/"><span class="koboSpan" id="kobo.159.1">http://httpd.apache.org/</span></a><span class="koboSpan" id="kobo.160.1"> to read more </span><a id="_idIndexMarker475"/><span class="No-Break"><span class="koboSpan" id="kobo.161.1">about Apache.</span></span></p>
<p><span class="koboSpan" id="kobo.162.1">The latest documentation on </span><strong class="source-inline"><span class="koboSpan" id="kobo.163.1">mod_wgsi</span></strong><span class="koboSpan" id="kobo.164.1"> can </span><a id="_idIndexMarker476"/><span class="koboSpan" id="kobo.165.1">be found </span><span class="No-Break"><span class="koboSpan" id="kobo.166.1">at </span></span><a href="https://modwsgi.readthedocs.io/en/develop"><span class="No-Break"><span class="koboSpan" id="kobo.167.1">https://modwsgi.readthedocs.io/en/develop</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.168.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.169.1">You can read about WSGI</span><a id="_idIndexMarker477"/><span class="koboSpan" id="kobo.170.1"> in general </span><span class="No-Break"><span class="koboSpan" id="kobo.171.1">at </span></span><a href="http://wsgi.readthedocs.org/en/latest/"><span class="No-Break"><span class="koboSpan" id="kobo.172.1">http://wsgi.readthedocs.</span><span id="_idTextAnchor623"/><span class="koboSpan" id="kobo.173.1">org/en/latest/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.174.1">.</span></span></p>
<h1 id="_idParaDest-327"><a id="_idTextAnchor624"/><span class="koboSpan" id="kobo.175.1">Deploying with uWSGI and Nginx</span></h1>
<p><span class="koboSpan" id="kobo.176.1">For those who are already aware of the usefulness of uWSGI and Nginx, not much needs to be explained. </span><span class="koboSpan" id="kobo.176.2">uWSGI</span><a id="_idIndexMarker478"/><span class="koboSpan" id="kobo.177.1"> is a protocol as well as an application server and provides a complete stack so that you can build hosting services. </span><span class="koboSpan" id="kobo.177.2">Nginx</span><a id="_idIndexMarker479"/><span class="koboSpan" id="kobo.178.1"> is a reverse proxy and HTTP server that is very lightweight and capable of handling virtually unlimited requests. </span><span class="koboSpan" id="kobo.178.2">Nginx works seamlessly with uWSGI and provides many under-the-hood optimizations for better performance. </span><span class="koboSpan" id="kobo.178.3">In this recipe, we will use uWSGI and Nginx together to facilitate the deployment of</span><a id="_idTextAnchor625"/> <span class="No-Break"><span class="koboSpan" id="kobo.179.1">our application.</span></span></p>
<h2 id="_idParaDest-328"><a id="_idTextAnchor626"/><span class="koboSpan" id="kobo.180.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.181.1">We will</span><a id="_idIndexMarker480"/><span class="koboSpan" id="kobo.182.1"> use our </span><a id="_idIndexMarker481"/><span class="koboSpan" id="kobo.183.1">application from the previous recipe, </span><em class="italic"><span class="koboSpan" id="kobo.184.1">Deploying with Apache</span></em><span class="koboSpan" id="kobo.185.1">, and</span><a id="_idIndexMarker482"/><span class="koboSpan" id="kobo.186.1"> use the </span><a id="_idIndexMarker483"/><span class="koboSpan" id="kobo.187.1">same </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.188.1">wsgi.py</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.189.1"> file.</span></span></p>
<p><span class="koboSpan" id="kobo.190.1">Now, install Nginx and uWSGI. </span><span class="koboSpan" id="kobo.190.2">On Debian-based distributions such as Ubuntu, they can be easily installed using the </span><span class="No-Break"><span class="koboSpan" id="kobo.191.1">following commands:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.192.1">
$ sudo apt-get install nginx
$ pip install pyuwsgi</span></pre>
<p><span class="koboSpan" id="kobo.193.1">These installation instructions are OS-specific, so please refer to the respective documentation as per the OS that </span><span class="No-Break"><span class="koboSpan" id="kobo.194.1">you’re using.</span></span></p>
<p><span class="koboSpan" id="kobo.195.1">Make sure that you have a </span><strong class="source-inline"><span class="koboSpan" id="kobo.196.1">sites-enabled</span></strong><span class="koboSpan" id="kobo.197.1"> folder for Nginx since this is where we will keep our site-specific configuration files. </span><span class="koboSpan" id="kobo.197.2">Usually, it is already present in most installations in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.198.1">/etc/</span></strong><span class="koboSpan" id="kobo.199.1"> folder. </span><span class="koboSpan" id="kobo.199.2">If not, please refer to the OS-specific documentation for your O</span><a id="_idTextAnchor627"/><span class="koboSpan" id="kobo.200.1">S to figure </span><span class="No-Break"><span class="koboSpan" id="kobo.201.1">this out.</span></span></p>
<h2 id="_idParaDest-329"><a id="_idTextAnchor628"/><span class="koboSpan" id="kobo.202.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.203.1">Follow these steps to deploy the application using uWSGI first and then combine it with Nginx as a </span><span class="No-Break"><span class="koboSpan" id="kobo.204.1">reverse proxy:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.205.1">The first step is to create a file </span><span class="No-Break"><span class="koboSpan" id="kobo.206.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.207.1">wsgi.py</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.208.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.209.1">
from my_app import app as application</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.210.1">This is needed because </span><strong class="source-inline"><span class="koboSpan" id="kobo.211.1">uwsgi</span></strong><span class="koboSpan" id="kobo.212.1"> expects to find an executable named </span><strong class="source-inline"><span class="koboSpan" id="kobo.213.1">application</span></strong><span class="koboSpan" id="kobo.214.1">, so we just import our </span><strong class="source-inline"><span class="koboSpan" id="kobo.215.1">app</span></strong><span class="koboSpan" id="kobo.216.1"> as </span><strong class="source-inline"><span class="koboSpan" id="kobo.217.1">application</span></strong><span class="koboSpan" id="kobo.218.1">.</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.219.1">Next, create a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.220.1">uwsgi.ini</span></strong><span class="koboSpan" id="kobo.221.1"> in our application </span><span class="No-Break"><span class="koboSpan" id="kobo.222.1">root folder:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.223.1">
[uwsgi]</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.224.1">
http-socket    = :9090</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.225.1">
wsgi-file = /home/ubuntu/cookbook3/Chapter-11/wsgi.py</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.226.1">
processes   = 3</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.227.1">Here, we have configured </span><strong class="source-inline"><span class="koboSpan" id="kobo.228.1">uwsgi</span></strong><span class="koboSpan" id="kobo.229.1"> to run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.230.1">wsgi-file</span></strong><span class="koboSpan" id="kobo.231.1"> provided at the HTTP address mentioned with the number of workers, as specified in </span><strong class="source-inline"><span class="koboSpan" id="kobo.232.1">processes</span></strong><span class="koboSpan" id="kobo.233.1">.</span></p>
<p><span class="koboSpan" id="kobo.234.1">To test whether uWSGI is working as expected, run the following command:</span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.235.1">$ uwsgi --ini uwsgi.ini</span></strong></pre>
<p><span class="koboSpan" id="kobo.236.1">Now, point </span><a id="_idIndexMarker484"/><span class="koboSpan" id="kobo.237.1">your </span><a id="_idIndexMarker485"/><span class="koboSpan" id="kobo.238.1">browser </span><a id="_idIndexMarker486"/><span class="koboSpan" id="kobo.239.1">to </span><strong class="source-inline"><span class="koboSpan" id="kobo.240.1">http://127.0.0.1:9090/</span></strong><span class="koboSpan" id="kobo.241.1">; this </span><a id="_idIndexMarker487"/><span class="koboSpan" id="kobo.242.1">should open the home page of the application.</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.243.1">Before moving on, edit the preceding file to replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.244.1">http-socket</span></strong><span class="koboSpan" id="kobo.245.1"> with </span><strong class="source-inline"><span class="koboSpan" id="kobo.246.1">socket</span></strong><span class="koboSpan" id="kobo.247.1">. </span><span class="koboSpan" id="kobo.247.2">This will </span><a id="_idIndexMarker488"/><span class="koboSpan" id="kobo.248.1">change the protocol from HTTP to uWSGI (you can read more about this </span><span class="No-Break"><span class="koboSpan" id="kobo.249.1">at </span></span><a href="https://uwsgi-docs.readthedocs.io/en/latest/Protocol.html"><span class="No-Break"><span class="koboSpan" id="kobo.250.1">https://uwsgi-docs.readthedocs.io/en/latest/Protocol.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.251.1">)</span></span><span class="No-Break"><span class="koboSpan" id="kobo.252.1">.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.253.1">Important</span></p>
<p class="callout"><span class="koboSpan" id="kobo.254.1">You must keep the </span><strong class="source-inline"><span class="koboSpan" id="kobo.255.1">uwsgi</span></strong><span class="koboSpan" id="kobo.256.1"> process running. </span><span class="koboSpan" id="kobo.256.2">Right now, we have run this as a </span><span class="No-Break"><span class="koboSpan" id="kobo.257.1">foreground process.</span></span></p>
<p class="callout"><span class="koboSpan" id="kobo.258.1">You might want to keep the uWSGI process running automatically in the background as a headless service rather than having it run manually in the foreground. </span><span class="koboSpan" id="kobo.258.2">There are multiple tools to do this, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.259.1">supervisord</span></strong><span class="koboSpan" id="kobo.260.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.261.1">circus</span></strong><span class="koboSpan" id="kobo.262.1">, and so on. </span><span class="koboSpan" id="kobo.262.2">We will touch on </span><strong class="source-inline"><span class="koboSpan" id="kobo.263.1">supervisord</span></strong><span class="koboSpan" id="kobo.264.1"> in the next recipe for a different purpose, but that can be replicated here as well. </span><span class="koboSpan" id="kobo.264.2">I will leave it to you to try this out </span><span class="No-Break"><span class="koboSpan" id="kobo.265.1">for yourself.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.266.1">Now, create</span><a id="_idIndexMarker489"/><span class="koboSpan" id="kobo.267.1"> a new file called </span><strong class="source-inline"><span class="koboSpan" id="kobo.268.1">nginx-wsgi.conf</span></strong><span class="koboSpan" id="kobo.269.1">. </span><span class="koboSpan" id="kobo.269.2">This will</span><a id="_idIndexMarker490"/><span class="koboSpan" id="kobo.270.1"> contain the Nginx configuration that’s </span><a id="_idIndexMarker491"/><span class="koboSpan" id="kobo.271.1">needed to serve our application and the</span><a id="_idIndexMarker492"/> <span class="No-Break"><span class="koboSpan" id="kobo.272.1">static content:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.273.1">
server {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.274.1">
  location / {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.275.1">
    include uwsgi_params;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.276.1">
    uwsgi_pass 0.0.0.0:9090;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.277.1">
  }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.278.1">
  location /static/uploads/ {</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.279.1">
    alias /home/ubuntu/cookbook3/Chapter-</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.280.1">
      11/flask_test_uploads/;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.281.1">
  }</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.282.1">
}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.283.1">In the preceding code block, </span><strong class="source-inline"><span class="koboSpan" id="kobo.284.1">uwsgi_pass</span></strong><span class="koboSpan" id="kobo.285.1"> specifies the uWSGI server that needs to be mapped to the specified location.</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.286.1">Tip</span></p>
<p class="callout"><span class="koboSpan" id="kobo.287.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.288.1">nginx-wsgi.conf</span></strong><span class="koboSpan" id="kobo.289.1"> file can be created anywhere. </span><span class="koboSpan" id="kobo.289.2">It can be created with your code bundle so that it can be version controlled, or it can be placed at </span><strong class="source-inline"><span class="koboSpan" id="kobo.290.1">/etc/nginx/sites-available</span></strong><span class="koboSpan" id="kobo.291.1"> for easier maintenance if you have multiple </span><strong class="source-inline"><span class="koboSpan" id="kobo.292.1">.</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.293.1">conf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.294.1"> files.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.295.1">Create a soft link from this file to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.296.1">sites-enabled</span></strong><span class="koboSpan" id="kobo.297.1"> folder we mentioned earlier using the </span><span class="No-Break"><span class="koboSpan" id="kobo.298.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.299.1">$ sudo ln -s ~/cookbook3/Chapter-11/nginx-wsgi.conf /etc/nginx/sites-enabled/</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.300.1">By default, Nginx comes with a site configuration named </span><strong class="source-inline"><span class="koboSpan" id="kobo.301.1">default</span></strong><span class="koboSpan" id="kobo.302.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.303.1">sites-available</span></strong><span class="koboSpan" id="kobo.304.1"> folder with a symlink to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.305.1">sites-enabled</span></strong><span class="koboSpan" id="kobo.306.1"> folder. </span><span class="koboSpan" id="kobo.306.2">Unlink the same to serve our application; otherwise, the default will block our application from </span><span class="No-Break"><span class="koboSpan" id="kobo.307.1">being loaded:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.308.1">$ sudo unlink /etc/nginx/sites-enabled/default</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.309.1">After all of this, reload the Nginx server using the </span><span class="No-Break"><span class="koboSpan" id="kobo.310.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.311.1">$ sudo systemctl reload nginx.service</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.312.1">Point your </span><a id="_idIndexMarker493"/><span class="koboSpan" id="kobo.313.1">browser</span><a id="_idIndexMarker494"/><span class="koboSpan" id="kobo.314.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.315.1">http://127.0.0.1/</span></strong><span class="koboSpan" id="kobo.316.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.317.1">http://&lt;your server IP or domain address&gt;</span></strong><span class="koboSpan" id="kobo.318.1"> to see the </span><a id="_idIndexMarker495"/><span class="koboSpan" id="kobo.319.1">application</span><a id="_idTextAnchor629"/><span class="koboSpan" id="kobo.320.1"> that serves via Nginx </span><span class="No-Break"><span class="koboSpan" id="kobo.321.1">and </span></span><span class="No-Break"><a id="_idIndexMarker496"/></span><span class="No-Break"><span class="koboSpan" id="kobo.322.1">uWSGI.</span></span></p>
<h2 id="_idParaDest-330"><a id="_idTextAnchor630"/><span class="koboSpan" id="kobo.323.1">See also</span></h2>
<p><span class="koboSpan" id="kobo.324.1">Refer</span><a id="_idIndexMarker497"/><span class="koboSpan" id="kobo.325.1"> to </span><a href="https://uwsgi-docs.readthedocs.org/en/latest/"><span class="koboSpan" id="kobo.326.1">https://uwsgi-docs.readthedocs.org/en/latest/</span></a><span class="koboSpan" id="kobo.327.1"> for more information </span><span class="No-Break"><span class="koboSpan" id="kobo.328.1">on uWSGI.</span></span></p>
<p><span class="koboSpan" id="kobo.329.1">Refer to </span><a href="https://www.nginx.com/"><span class="koboSpan" id="kobo.330.1">https://www.nginx.com/</span></a><span class="koboSpan" id="kobo.331.1"> for more</span><a id="_idIndexMarker498"/><span class="koboSpan" id="kobo.332.1"> information </span><span class="No-Break"><span class="koboSpan" id="kobo.333.1">on Nginx.</span></span></p>
<p><span class="koboSpan" id="kobo.334.1">There is a good article </span><a id="_idIndexMarker499"/><span class="koboSpan" id="kobo.335.1">by DigitalOcean on Nginx and uWSGI. </span><span class="koboSpan" id="kobo.335.2">I advise you to go through it so that you have a better understanding of the topic. </span><span class="koboSpan" id="kobo.335.3">It is available </span><span class="No-Break"><span class="koboSpan" id="kobo.336.1">at </span></span><a href="https://www.digitalocean.com/community/tutorials/how-to-serve-flask-applications-with-uwsgi-and-nginx-on-ubuntu-22-04"><span class="No-Break"><span class="koboSpan" id="kobo.337.1">https://www.digitalocean.com/community/tutorials/how-to-serve-flask-applications-with-uwsgi-and-nginx-on-ubuntu-22-04</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.338.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.339.1">To get an insight into the</span><a id="_idIndexMarker500"/><span class="koboSpan" id="kobo.340.1"> differences between Apache and Nginx, I think an article by Anturis, which can be found at </span><a href="https://anturis.com/blog/nginx-vs-apache/"><span class="koboSpan" id="kobo.341.1">https://anturis.com/</span><span id="_idTextAnchor631"/><span class="koboSpan" id="kobo.342.1">blog/nginx-vs-apache/</span></a><span class="koboSpan" id="kobo.343.1">, is </span><span class="No-Break"><span class="koboSpan" id="kobo.344.1">pretty good.</span></span></p>
<h1 id="_idParaDest-331"><a id="_idTextAnchor632"/><span class="koboSpan" id="kobo.345.1">Deploying with Gunicorn and Supervisor</span></h1>
<p><strong class="bold"><span class="koboSpan" id="kobo.346.1">Gunicorn</span></strong><span class="koboSpan" id="kobo.347.1"> is </span><a id="_idIndexMarker501"/><span class="koboSpan" id="kobo.348.1">a WSGI HTTP server for Unix. </span><span class="koboSpan" id="kobo.348.2">It is very simple to implement, ultra-light, and fairly speedy. </span><span class="koboSpan" id="kobo.348.3">Its simplicity lies in its broad compatibility with various </span><span class="No-Break"><span class="koboSpan" id="kobo.349.1">web frameworks.</span></span></p>
<p><strong class="bold"><span class="koboSpan" id="kobo.350.1">Supervisor</span></strong><span class="koboSpan" id="kobo.351.1"> is a </span><a id="_idIndexMarker502"/><span class="koboSpan" id="kobo.352.1">monitoring tool that controls various child processes and handles starting/restarting these child processes when they exit abruptly, or due to some other reason. </span><span class="koboSpan" id="kobo.352.2">It can be extended to control processes via the XML-RPC API over remote locations without you having to log into the server (we won’t discuss this here as it is beyond the scope of </span><span class="No-Break"><span class="koboSpan" id="kobo.353.1">this book).</span></span></p>
<p><span class="koboSpan" id="kobo.354.1">One thing to remember is that these tools can be used along with the other tools mentioned in the applications in the previous recipe, such as using Nginx as a proxy</span><a id="_idTextAnchor633"/><span class="koboSpan" id="kobo.355.1"> server. </span><span class="koboSpan" id="kobo.355.2">This is left to you to </span><span class="No-Break"><span class="koboSpan" id="kobo.356.1">try out.</span></span></p>
<h2 id="_idParaDest-332"><a id="_idTextAnchor634"/><span class="koboSpan" id="kobo.357.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.358.1">We will </span><a id="_idIndexMarker503"/><span class="koboSpan" id="kobo.359.1">start by</span><a id="_idIndexMarker504"/><span class="koboSpan" id="kobo.360.1"> installing</span><a id="_idIndexMarker505"/><span class="koboSpan" id="kobo.361.1"> both the packages – that </span><a id="_idIndexMarker506"/><span class="koboSpan" id="kobo.362.1">is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.363.1">gunicorn</span></strong><span class="koboSpan" id="kobo.364.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.365.1">supervisor</span></strong><span class="koboSpan" id="kobo.366.1">. </span><span class="koboSpan" id="kobo.366.2">Both can be directly installed </span><span class="No-Break"><span class="koboSpan" id="kobo.367.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.368.1">pip</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.369.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.370.1">
$ p</span><a id="_idTextAnchor635"/><span class="koboSpan" id="kobo.371.1">ip install gunicorn
$ pip install supervisor</span></pre>
<h2 id="_idParaDest-333"><a id="_idTextAnchor636"/><span class="koboSpan" id="kobo.372.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.373.1">Follow </span><span class="No-Break"><span class="koboSpan" id="kobo.374.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.375.1">To check whether the </span><strong class="source-inline"><span class="koboSpan" id="kobo.376.1">gunicorn</span></strong><span class="koboSpan" id="kobo.377.1"> package works as expected, just run the following command from inside our </span><span class="No-Break"><span class="koboSpan" id="kobo.378.1">application folder:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.379.1">$ gunicorn -w 4 -b 0.0.0.0:8000 my_app:app</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.380.1">After this, point your browser to </span><strong class="source-inline"><span class="koboSpan" id="kobo.381.1">http://0.0.0.0:8000/</span></strong><span class="koboSpan" id="kobo.382.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.383.1">http://&lt;IP address or domain name&gt;:8000/</span></strong><span class="koboSpan" id="kobo.384.1"> to see the application’s home page.</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.385.1">Now, we</span><a id="_idIndexMarker507"/><span class="koboSpan" id="kobo.386.1"> need to do the same as in the previous</span><a id="_idIndexMarker508"/><span class="koboSpan" id="kobo.387.1"> step using Supervisor so that this</span><a id="_idIndexMarker509"/><span class="koboSpan" id="kobo.388.1"> process runs as a daemon that will be controlled by Supervisor itself rather than through human intervention. </span><span class="koboSpan" id="kobo.388.2">First</span><a id="_idIndexMarker510"/><span class="koboSpan" id="kobo.389.1"> of all, we need a Supervisor configuration file. </span><span class="koboSpan" id="kobo.389.2">This can be achieved by running the following command inside your virtual environment. </span><span class="koboSpan" id="kobo.389.3">Supervisor, by default, looks for an </span><strong class="source-inline"><span class="koboSpan" id="kobo.390.1">etc</span></strong><span class="koboSpan" id="kobo.391.1"> folder that has a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.392.1">supervisord.conf</span></strong><span class="koboSpan" id="kobo.393.1">. </span><span class="koboSpan" id="kobo.393.2">In system-wide installations, this folder is </span><strong class="source-inline"><span class="koboSpan" id="kobo.394.1">/etc/</span></strong><span class="koboSpan" id="kobo.395.1">, while in a virtual environment, it will look for an </span><strong class="source-inline"><span class="koboSpan" id="kobo.396.1">etc</span></strong><span class="koboSpan" id="kobo.397.1"> folder in the virtual environment root folder and then fall back to </span><strong class="source-inline"><span class="koboSpan" id="kobo.398.1">/etc/</span></strong><span class="koboSpan" id="kobo.399.1">. </span><span class="koboSpan" id="kobo.399.2">Hence, it is suggested that you create a folder named </span><strong class="source-inline"><span class="koboSpan" id="kobo.400.1">etc</span></strong><span class="koboSpan" id="kobo.401.1"> in your virtual environment to maintain separation </span><span class="No-Break"><span class="koboSpan" id="kobo.402.1">of concerns:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.403.1">$ mkdir etc</span></strong></pre><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.404.1">$ echo_supervisord_conf &gt; etc/supervisord.conf</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.405.1">The last command will create a configuration file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.406.1">supervisord.conf</span></strong><span class="koboSpan" id="kobo.407.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.408.1">etc</span></strong><span class="koboSpan" id="kobo.409.1"> folder. </span><span class="koboSpan" id="kobo.409.2">This file houses all the configurations for the processes that would be run using the Supervisor daemon.</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.410.1">Information</span></p>
<p class="callout"><span class="koboSpan" id="kobo.411.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.412.1">echo_supervisord_conf</span></strong><span class="koboSpan" id="kobo.413.1"> program is provided by Supervisor; it prints a sample config file to the location specified. </span><span class="koboSpan" id="kobo.413.2">If you run into permission issues while running the command, try </span><span class="No-Break"><span class="koboSpan" id="kobo.414.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.415.1">sudo</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.416.1">.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.417.1">Now, add the following configuration block in the file you </span><span class="No-Break"><span class="koboSpan" id="kobo.418.1">created previously:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.419.1">
[program:flask_catalog]</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.420.1">
command=&lt;path to virtual environment&gt;/bin/gunicorn -w</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.421.1">
  4 -b 0.0.0.0:8000 my_app:app</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.422.1">
directory=&lt;path to application directory&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.423.1">
user=someuser # some user with relevant permissions</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.424.1">
autostart=true</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.425.1">
autorestart=true</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.426.1">
stdout_logfile=/tmp/app.log</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.427.1">
stderr_logfile=/tmp/error.log</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.428.1">Here, we specified the </span><strong class="source-inline"><span class="koboSpan" id="kobo.429.1">gunicorn</span></strong><span class="koboSpan" id="kobo.430.1"> process as the command to run, along with the directory and user to be used for the process. </span><span class="koboSpan" id="kobo.430.2">Other settings specify the behavior at the start or restart of the Supervisor daemon and the locations to save respective log files in.</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.431.1">Tip</span></p>
<p class="callout"><span class="koboSpan" id="kobo.432.1">Note that you should never run the applications as a </span><strong class="source-inline"><span class="koboSpan" id="kobo.433.1">root</span></strong><span class="koboSpan" id="kobo.434.1"> user. </span><span class="koboSpan" id="kobo.434.2">This is a huge security flaw in itself as the application may crash or the flaws may harm the </span><span class="No-Break"><span class="koboSpan" id="kobo.435.1">OS itself.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.436.1">After</span><a id="_idIndexMarker511"/><span class="koboSpan" id="kobo.437.1"> the setup is </span><a id="_idIndexMarker512"/><span class="koboSpan" id="kobo.438.1">complete, run </span><strong class="source-inline"><span class="koboSpan" id="kobo.439.1">supervi</span><a id="_idTextAnchor637"/><span class="koboSpan" id="kobo.440.1">sord</span></strong><span class="koboSpan" id="kobo.441.1"> by </span><a id="_idIndexMarker513"/><span class="koboSpan" id="kobo.442.1">using the </span><span class="No-Break"><span class="koboSpan" id="kobo.443.1">following</span></span><span class="No-Break"><a id="_idIndexMarker514"/></span><span class="No-Break"><span class="koboSpan" id="kobo.444.1"> command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.445.1">$ supervisord</span></strong></pre></li>
</ol>
<h2 id="_idParaDest-334"><a id="_idTextAnchor638"/><span class="koboSpan" id="kobo.446.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.447.1">To check the status of the application, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.448.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.449.1">
$ supervisorctl status
flask_catalog           RUNNING   pid 112039, uptime 0:00:06</span></pre>
<p><span class="koboSpan" id="kobo.450.1">This command provides a status for all of the </span><span class="No-Break"><span class="koboSpan" id="kobo.451.1">child processes.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.452.1">Tip</span></p>
<p class="callout"><span class="koboSpan" id="kobo.453.1">The tools that were discussed in this recipe can be coupled with Nginx to serve as a reverse proxy server. </span><span class="koboSpan" id="kobo.453.2">I suggest that you try this out </span><span class="No-Break"><span class="koboSpan" id="kobo.454.1">for yourself.</span></span></p>
<p><span class="koboSpan" id="kobo.455.1">Every time you make a change to your application and then wish to restart Gunicorn for it to reflect the changes that have been made, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.456.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.457.1">
$ supervisorctl restart all</span></pre>
<p><span class="koboSpan" id="kobo.458.1">You can also</span><a id="_idIndexMarker515"/><span class="koboSpan" id="kobo.459.1"> specify</span><a id="_idIndexMarker516"/><span class="koboSpan" id="kobo.460.1"> specific processes instead of </span><a id="_idIndexMarker517"/><span class="No-Break"><span class="koboSpan" id="kobo.461.1">resta</span><a id="_idTextAnchor639"/><span class="koboSpan" id="kobo.462.1">rting</span></span><span class="No-Break"><a id="_idIndexMarker518"/></span><span class="No-Break"><span class="koboSpan" id="kobo.463.1"> everything:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.464.1">
$ supervisorctl restart flask_catalog</span></pre>
<h2 id="_idParaDest-335"><a id="_idTextAnchor640"/><span class="koboSpan" id="kobo.465.1">See also</span></h2>
<p><span class="koboSpan" id="kobo.466.1">You can read more about</span><a id="_idIndexMarker519"/><span class="koboSpan" id="kobo.467.1"> Gunicorn </span><span class="No-Break"><span class="koboSpan" id="kobo.468.1">at </span></span><a href="http://gunicorn-docs.readthedocs.org/en/latest/index.html"><span class="No-Break"><span class="koboSpan" id="kobo.469.1">http://gunicorn-docs.readthedocs.org/en/latest/index.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.470.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.471.1">For more information on Super</span><a id="_idTextAnchor641"/><span class="koboSpan" id="kobo.472.1">visor, please </span><a id="_idIndexMarker520"/><span class="koboSpan" id="kobo.473.1">refer </span><span class="No-Break"><span class="koboSpan" id="kobo.474.1">to </span></span><a href="http://supervisord.org/index.html"><span class="No-Break"><span class="koboSpan" id="kobo.475.1">http://supervisord.org/index.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.476.1">.</span></span></p>
<h1 id="_idParaDest-336"><a id="_idTextAnchor642"/><span class="koboSpan" id="kobo.477.1">Deploying with Tornado</span></h1>
<p><span class="koboSpan" id="kobo.478.1">Tornado </span><a id="_idIndexMarker521"/><span class="koboSpan" id="kobo.479.1">is a complete web framework and a standalone web server in itself. </span><span class="koboSpan" id="kobo.479.2">Here, we will use Flask to create our application, which is a combination of URL routing and templating, and leave the server part to Tornado. </span><span class="koboSpan" id="kobo.479.3">Tornado is built to hold thousands of simultaneous standing connections and makes applications </span><span class="No-Break"><span class="koboSpan" id="kobo.480.1">very scalable.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.481.1">Information</span></p>
<p class="callout"><span class="koboSpan" id="kobo.482.1">Tornado has limitations while working with WSGI applications, so choose wisely! </span><span class="koboSpan" id="kobo.482.2">You can read more about this </span><span class="No-Break"><span class="koboSpan" id="kobo.483.1">at </span></span><a href="http://www.tornadoweb.org/en/stable/wsgi.html#running-wsgi-apps-on-tornado-servers"><span class="No-Break"><span class="koboSpan" id="kobo.484.1">http://www.tornadoweb.or</span><span id="_idTextAnchor643"/><span class="koboSpan" id="kobo.485.1">g/en/stable/wsgi.html#running-wsgi-apps-on-tornado-servers</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.486.1">.</span></span></p>
<h2 id="_idParaDest-337"><a id="_idTextAnchor644"/><span class="koboSpan" id="kobo.487.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.488.1">Inst</span><a id="_idTextAnchor645"/><span class="koboSpan" id="kobo.489.1">alling </span><a id="_idIndexMarker522"/><span class="koboSpan" id="kobo.490.1">Tornado</span><a id="_idIndexMarker523"/><span class="koboSpan" id="kobo.491.1"> can be done </span><span class="No-Break"><span class="koboSpan" id="kobo.492.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.493.1">pip</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.494.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.495.1">
$ pip install tornado</span></pre>
<h2 id="_idParaDest-338"><a id="_idTextAnchor646"/><span class="koboSpan" id="kobo.496.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.497.1">Let’s create a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.498.1">tornado_server.py</span></strong><span class="koboSpan" id="kobo.499.1"> and put the following code </span><span class="No-Break"><span class="koboSpan" id="kobo.500.1">in it:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.501.1">
from tornado.wsgi import WSGIContainer
from tornado.httpserver import HTTPServer
from tornado.ioloop import IOLoop
from my_app import app
http_server = HTTPServer(WSGIContainer(app))
http_server.listen(8000)
IOLoop.instance().start()</span></pre>
<p><span class="koboSpan" id="kobo.502.1">Here, we created a WSGI container for our application; this container is then used to creat</span><a id="_idTextAnchor647"/><span class="koboSpan" id="kobo.503.1">e an HTTP server, and the application is hosted on </span><span class="No-Break"><span class="koboSpan" id="kobo.504.1">port </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.505.1">8000</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.506.1">.</span></span></p>
<h2 id="_idParaDest-339"><a id="_idTextAnchor648"/><span class="koboSpan" id="kobo.507.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.508.1">Run the</span><a id="_idIndexMarker524"/><span class="koboSpan" id="kobo.509.1"> Python file we created in the previous section</span><a id="_idIndexMarker525"/><span class="koboSpan" id="kobo.510.1"> using the </span><span class="No-Break"><span class="koboSpan" id="kobo.511.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.512.1">
$ python tornado_server.py</span></pre>
<p><span class="koboSpan" id="kobo.513.1">Point your browser to </span><strong class="source-inline"><span class="koboSpan" id="kobo.514.1">http://0.0.0.0:8000/</span></strong><span class="koboSpan" id="kobo.515.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.516.1">http://&lt;IP address or domain name&gt;:8000/</span></strong><span class="koboSpan" id="kobo.517.1"> to see the home page </span><span class="No-Break"><span class="koboSpan" id="kobo.518.1">being served.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.519.1">Tip</span></p>
<p class="callout"><span class="koboSpan" id="kobo.520.1">We can couple Tornado with Nginx (as a reverse proxy to serve static content) and Supervisor (as a process mana</span><a id="_idTextAnchor649"/><span class="koboSpan" id="kobo.521.1">ger) for the best results. </span><span class="koboSpan" id="kobo.521.2">This is left for you as </span><span class="No-Break"><span class="koboSpan" id="kobo.522.1">an exercise.</span></span></p>
<h1 id="_idParaDest-340"><a id="_idTextAnchor650"/><span class="koboSpan" id="kobo.523.1">Using S3 storage for file uploads</span></h1>
<p><strong class="bold"><span class="koboSpan" id="kobo.524.1">Amazon Web Services</span></strong><span class="koboSpan" id="kobo.525.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.526.1">AWS</span></strong><span class="koboSpan" id="kobo.527.1">) explains</span><a id="_idIndexMarker526"/><span class="koboSpan" id="kobo.528.1"> S3 as the storage for the internet that is designed to make web-scale computing easier for developers. </span><span class="koboSpan" id="kobo.528.2">S3 provides a very simple interface via web services; this makes storing and retrieving any amount of data very simple at any time from anywhere on the internet. </span><span class="koboSpan" id="kobo.528.3">Until now, in our catalog application, we saw that there were issues in managing the product images that were uploaded as a part of the creation process. </span><span class="koboSpan" id="kobo.528.4">This whole headache will go away if the images are stored somewhere globally and are easil</span><a id="_idTextAnchor651"/><span class="koboSpan" id="kobo.529.1">y accessible from anywhere. </span><span class="koboSpan" id="kobo.529.2">We will use S3 for the </span><span class="No-Break"><span class="koboSpan" id="kobo.530.1">same purpose.</span></span></p>
<h2 id="_idParaDest-341"><a id="_idTextAnchor652"/><span class="koboSpan" id="kobo.531.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.532.1">Amazon offers </span><strong class="bold"><span class="koboSpan" id="kobo.533.1">boto3</span></strong><span class="koboSpan" id="kobo.534.1">, a </span><a id="_idIndexMarker527"/><span class="koboSpan" id="kobo.535.1">complete Python library that interfaces with AWS via web </span><a id="_idIndexMarker528"/><span class="koboSpan" id="kobo.536.1">services. </span><span class="koboSpan" id="kobo.536.2">Almost</span><a id="_idIndexMarker529"/><span class="koboSpan" id="kobo.537.1"> all of the AWS features can be control</span><a id="_idTextAnchor653"/><span class="koboSpan" id="kobo.538.1">led using </span><strong class="source-inline"><span class="koboSpan" id="kobo.539.1">boto3</span></strong><span class="koboSpan" id="kobo.540.1">. </span><span class="koboSpan" id="kobo.540.2">It can be installed </span><span class="No-Break"><span class="koboSpan" id="kobo.541.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.542.1">pip</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.543.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.544.1">
$ pip install boto3</span></pre>
<h2 id="_idParaDest-342"><a id="_idTextAnchor654"/><span class="koboSpan" id="kobo.545.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.546.1">Now, make some changes to our existing catalog application to accommodate support for file upload and retrieval </span><span class="No-Break"><span class="koboSpan" id="kobo.547.1">from S3:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.548.1">First, we need to store the AWS-specific configuration to allow </span><strong class="source-inline"><span class="koboSpan" id="kobo.549.1">boto3</span></strong><span class="koboSpan" id="kobo.550.1"> to make calls to S3. </span><span class="koboSpan" id="kobo.550.2">Add the following statements to the application’s configuration file – that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.551.1">my_app/__init__.py</span></strong><span class="koboSpan" id="kobo.552.1">. </span><span class="koboSpan" id="kobo.552.2">Make sure that you group the following configuration values along with other pre-existing </span><span class="No-Break"><span class="koboSpan" id="kobo.553.1">configuration values:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.554.1">
    app.config['AWS_ACCESS_KEY'] = 'AWS Access Key'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.555.1">
    app.config['AWS_SECRET_KEY'] = 'AWS Secret Key'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.556.1">
    app.config['AWS_BUCKET'] = 'Name of AWS Bucket'</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.557.1">You can get these values from AWS IAM. </span><span class="koboSpan" id="kobo.557.2">Ensure that the user associated with these credentials has access to create and get objects from S3.</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.558.1">Next, we need to change our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.559.1">views.py</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.560.1"> file:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.561.1">
import boto3</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.562.1">This is the import that we need from </span><strong class="source-inline"><span class="koboSpan" id="kobo.563.1">boto3</span></strong><span class="koboSpan" id="kobo.564.1">. </span><span class="koboSpan" id="kobo.564.2">Next, we need to replace the following line in </span><strong class="source-inline"><span class="koboSpan" id="kobo.565.1">create_product()</span></strong><span class="koboSpan" id="kobo.566.1">:</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.567.1">
image.save(os.path.join(current_app.config['UPLOAD_FOL
  DER'], filename))</span></pre>
<p><span class="koboSpan" id="kobo.568.1">We must </span><a id="_idIndexMarker530"/><span class="koboSpan" id="kobo.569.1">replace this </span><a id="_idIndexMarker531"/><span class="koboSpan" id="kobo.570.1">with the following block of code:</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.571.1">
            session = boto3.Session(
                aws_access_key_id=current_app
                  .config['AWS_ACCESS_KEY'],
                aws_secret_access_key=current_app
                  .config['AWS_SECRET_KEY']
            )
            s3 = session.resource('s3')
            bucket = s3.Bucket(current_app
              .config['AWS_BUCKET'])
            if bucket not in list(s3.buckets.all()):
                bucket = s3.create_bucket(
                    Bucket=current_app
                      .config['AWS_BUCKET'],
                    CreateBucketConfiguration={
                        'LocationConstraint':
                          'ap-south-1'
                    },
                )
            bucket.upload_fileobj(
                image, filename,
                ExtraArgs={'ACL': 'public-read'})</span></pre>
<p><span class="koboSpan" id="kobo.572.1">With this </span><a id="_idIndexMarker532"/><span class="koboSpan" id="kobo.573.1">code change, we are essentially </span><a id="_idIndexMarker533"/><span class="koboSpan" id="kobo.574.1">changing how we save files. </span><span class="koboSpan" id="kobo.574.2">Earlier, the image was being saved locally using </span><strong class="source-inline"><span class="koboSpan" id="kobo.575.1">image.save</span></strong><span class="koboSpan" id="kobo.576.1">. </span><span class="koboSpan" id="kobo.576.2">Now, this is done by creating an S3 connection and uploading the image to a bucket there. </span><span class="koboSpan" id="kobo.576.3">First, we create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.577.1">session</span></strong><span class="koboSpan" id="kobo.578.1"> connection with AWS using </span><strong class="source-inline"><span class="koboSpan" id="kobo.579.1">boto3.Session</span></strong><span class="koboSpan" id="kobo.580.1">. </span><span class="koboSpan" id="kobo.580.2">We use this session to access S3 resources and then create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.581.1">bucket</span></strong><span class="koboSpan" id="kobo.582.1"> (if it doesn’t exist; otherwise, use the same) with a location constraint to </span><strong class="source-inline"><span class="koboSpan" id="kobo.583.1">'ap-south-1'</span></strong><span class="koboSpan" id="kobo.584.1">. </span><span class="koboSpan" id="kobo.584.2">This location constraint isn’t necessary and can be used as needed. </span><span class="koboSpan" id="kobo.584.3">Finally, we upload our image to the bucket.</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.585.1">The last change will be made to our </span><strong class="source-inline"><span class="koboSpan" id="kobo.586.1">product.html</span></strong><span class="koboSpan" id="kobo.587.1"> template, where we need to change the image’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.588.1">src</span></strong><span class="koboSpan" id="kobo.589.1"> path. </span><span class="koboSpan" id="kobo.589.2">Replace the original </span><strong class="source-inline"><span class="koboSpan" id="kobo.590.1">img src</span></strong><span class="koboSpan" id="kobo.591.1"> statement with the </span><span class="No-Break"><span class="koboSpan" id="kobo.592.1">following statement:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.593.1">
    &lt;img src="{{ 'https://s3.ap-south-</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.594.1">
      1.amazon</span><a id="_idTextAnchor655"/><span class="koboSpan" id="kobo.595.1">aws.com/' + config['AWS_BUCKET']</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.596.1">
      + '/' + product.image_path }}"/&gt;</span></pre></li>
</ol>
<h2 id="_idParaDest-343"><a id="_idTextAnchor656"/><span class="koboSpan" id="kobo.597.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.598.1">Now, run </span><a id="_idIndexMarker534"/><span class="koboSpan" id="kobo.599.1">the application as usual and create a product. </span><span class="koboSpan" id="kobo.599.2">When the</span><a id="_idIndexMarker535"/><span class="koboSpan" id="kobo.600.1"> created product is rendered, the product image will take a bit of time to come up as it is now being served from S3 (and not from a local mac</span><a id="_idTextAnchor657"/><span class="koboSpan" id="kobo.601.1">hine). </span><span class="koboSpan" id="kobo.601.2">If this happens, then the integration with S3 has </span><span class="No-Break"><span class="koboSpan" id="kobo.602.1">been successful.</span></span></p>
<h1 id="_idParaDest-344"><a id="_idTextAnchor658"/><span class="koboSpan" id="kobo.603.1">Managing and monitoring application performance with New Relic</span></h1>
<p><strong class="bold"><span class="koboSpan" id="kobo.604.1">New Relic</span></strong><span class="koboSpan" id="kobo.605.1"> is an</span><a id="_idIndexMarker536"/><span class="koboSpan" id="kobo.606.1"> analytics software that provides near real-time operational and business analytics related to your application. </span><span class="koboSpan" id="kobo.606.2">It provides deep analytics on the behavior of the application from various aspects. </span><span class="koboSpan" id="kobo.606.3">It does the job of a profiler, as well as eliminates the need to maintain extra moving parts in the application. </span><span class="koboSpan" id="kobo.606.4">It works in the data push principle, where our application sends data to N</span><a id="_idTextAnchor659"/><span class="koboSpan" id="kobo.607.1">ew Relic rather than New Relic asking for statistics from </span><span class="No-Break"><span class="koboSpan" id="kobo.608.1">our application.</span></span></p>
<h2 id="_idParaDest-345"><a id="_idTextAnchor660"/><span class="koboSpan" id="kobo.609.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.610.1">We will use the </span><a id="_idIndexMarker537"/><span class="koboSpan" id="kobo.611.1">catalog application that </span><a id="_idIndexMarker538"/><span class="koboSpan" id="kobo.612.1">we have built throughout this book. </span><span class="koboSpan" id="kobo.612.2">In essence, the application to be used does not matter here; it should just be a running </span><span class="No-Break"><span class="koboSpan" id="kobo.613.1">Flask application.</span></span></p>
<p><span class="koboSpan" id="kobo.614.1">The first step will be to sign up with New Relic for an account. </span><span class="koboSpan" id="kobo.614.2">Follow the simple sign-up process and, upon completion and email verification, you will be sent to your dashboard. </span><span class="koboSpan" id="kobo.614.3">Here, choose </span><strong class="bold"><span class="koboSpan" id="kobo.615.1">Application monitoring</span></strong><span class="koboSpan" id="kobo.616.1"> as the product that we need to use from the suite of offerings from New Relic and choose </span><strong class="bold"><span class="koboSpan" id="kobo.617.1">Python</span></strong><span class="koboSpan" id="kobo.618.1"> as the </span><span class="No-Break"><span class="koboSpan" id="kobo.619.1">tech stack:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer080">
<span class="koboSpan" id="kobo.620.1"><img alt="Figure 11.1 – New Relic stack selection" src="image/B19111_11_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.621.1">Figure 11.1 – New Relic stack selection</span></p>
<p><span class="koboSpan" id="kobo.622.1">This guided install widget will ask about the operating system being used before handing out the commands to </span><span class="No-Break"><span class="koboSpan" id="kobo.623.1">be run:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer081">
<span class="koboSpan" id="kobo.624.1"><img alt="Figure 11.2 – New Relic install configuration" src="image/B19111_11_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.625.1">Figure 11.2 – New Relic install configuration</span></p>
<p><span class="koboSpan" id="kobo.626.1">Following this, you can choose to do the configuration and setup manually or just follow the steps that are outlined by New Relic. </span><span class="koboSpan" id="kobo.626.2">I will discuss both approaches in the </span><span class="No-Break"><span class="koboSpan" id="kobo.627.1">following section.</span></span></p>
<p><span class="koboSpan" id="kobo.628.1">For the manual </span><a id="_idIndexMarker539"/><span class="koboSpan" id="kobo.629.1">metho</span><a id="_idTextAnchor661"/><span class="koboSpan" id="kobo.630.1">d, make</span><a id="_idIndexMarker540"/><span class="koboSpan" id="kobo.631.1"> sure to copy the license key, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.632.1">preceding screenshot.</span></span></p>
<h2 id="_idParaDest-346"><a id="_idTextAnchor662"/><span class="koboSpan" id="kobo.633.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.634.1">You can choose either guided or </span><span class="No-Break"><span class="koboSpan" id="kobo.635.1">manual configuration.</span></span></p>
<h3><span class="koboSpan" id="kobo.636.1">Guided configuration</span></h3>
<p><span class="koboSpan" id="kobo.637.1">The following screenshot </span><a id="_idIndexMarker541"/><span class="koboSpan" id="kobo.638.1">lists all the steps that you need to follow to make your application work with New Relic </span><span class="No-Break"><span class="koboSpan" id="kobo.639.1">for APM:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer082">
<span class="koboSpan" id="kobo.640.1"><img alt="Figure 11.3 – New Relic guided configuration" src="image/B19111_11_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.641.1">Figure 11.3 – New Relic guided configuration</span></p>
<h3><span class="koboSpan" id="kobo.642.1">Manual configuration</span></h3>
<p><span class="koboSpan" id="kobo.643.1">Once we have the license key, we</span><a id="_idIndexMarker542"/><span class="koboSpan" id="kobo.644.1"> need to install the </span><strong class="source-inline"><span class="koboSpan" id="kobo.645.1">newrelic</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.646.1">Python library:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.647.1">
$ pip install newrelic</span></pre>
<p><span class="koboSpan" id="kobo.648.1">Now, we need to generate a file called </span><strong class="source-inline"><span class="koboSpan" id="kobo.649.1">newrelic.ini</span></strong><span class="koboSpan" id="kobo.650.1">, which will contain details regarding the license key, the name of our application, and so on. </span><span class="koboSpan" id="kobo.650.2">This can be done using the </span><span class="No-Break"><span class="koboSpan" id="kobo.651.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.652.1">
$ newrelic-admin generate-config &lt;LICENSE-KEY&gt; newrelic.ini</span></pre>
<p><span class="koboSpan" id="kobo.653.1">In the preceding command, replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.654.1">LICENSE-KEY</span></strong><span class="koboSpan" id="kobo.655.1"> with the actual license key of your account. </span><span class="koboSpan" id="kobo.655.2">Now, we have a new file called </span><strong class="source-inline"><span class="koboSpan" id="kobo.656.1">newrelic.ini</span></strong><span class="koboSpan" id="kobo.657.1">. </span><span class="koboSpan" id="kobo.657.2">Open and edit the file in terms of the application name and anything else, </span><span class="No-Break"><span class="koboSpan" id="kobo.658.1">as needed.</span></span></p>
<p><span class="koboSpan" id="kobo.659.1">To check whether the </span><strong class="source-inline"><span class="koboSpan" id="kobo.660.1">newrelic.ini</span></strong><span class="koboSpan" id="kobo.661.1"> file is working successfully, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.662.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.663.1">
$ newrelic-admin validate-config newrelic.ini</span></pre>
<p><span class="koboSpan" id="kobo.664.1">This will tell us whether the validation was successful or not. </span><span class="koboSpan" id="kobo.664.2">If not, then check the license key and </span><span class="No-Break"><span class="koboSpan" id="kobo.665.1">its validity.</span></span></p>
<p><span class="koboSpan" id="kobo.666.1">Now, add the following lines at the top of the application’s configuration file, which is </span><strong class="source-inline"><span class="koboSpan" id="kobo.667.1">my_app/__init__.py</span></strong><span class="koboSpan" id="kobo.668.1"> in our case. </span><span class="koboSpan" id="kobo.668.2">Make sure that you add these lines before anything else</span><a id="_idTextAnchor663"/> <span class="No-Break"><span class="koboSpan" id="kobo.669.1">is imported:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.670.1">
import newrelic.agent
newrelic.agent.initialize('newrelic.ini')</span></pre>
<h2 id="_idParaDest-347"><a id="_idTextAnchor664"/><span class="koboSpan" id="kobo.671.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.672.1">Now, when </span><a id="_idIndexMarker543"/><span class="koboSpan" id="kobo.673.1">you run your </span><a id="_idIndexMarker544"/><span class="koboSpan" id="kobo.674.1">application, it will start sending statistics to New Relic, and the dashboard will have a new application added to it. </span><span class="koboSpan" id="kobo.674.2">In the following screenshot, there are two applications, where one corresponds to the application that we are working on and the other is the test that we ran a while back to validate whether New Relic is </span><span class="No-Break"><span class="koboSpan" id="kobo.675.1">working correctly:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer083">
<span class="koboSpan" id="kobo.676.1"><img alt="Figure 11.4 – New Relic application list" src="image/B19111_11_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.677.1">Figure 11.4 – New Relic application list</span></p>
<p><span class="koboSpan" id="kobo.678.1">Open the</span><a id="_idIndexMarker545"/><span class="koboSpan" id="kobo.679.1"> application-specific page; a whole lot of statistics will appear. </span><span class="koboSpan" id="kobo.679.2">It will also show you which calls have taken</span><a id="_idIndexMarker546"/><span class="koboSpan" id="kobo.680.1"> the most amount of time and how the application is performing. </span><span class="koboSpan" id="kobo.680.2">You will also see multiple menu items, where each one will </span><a id="_idTextAnchor665"/><span class="koboSpan" id="kobo.681.1">correspond to a different type of monitoring to cover all the </span><span class="No-Break"><span class="koboSpan" id="kobo.682.1">necessary aspects.</span></span></p>
<h2 id="_idParaDest-348"><a id="_idTextAnchor666"/><span class="koboSpan" id="kobo.683.1">See also</span></h2>
<p><span class="koboSpan" id="kobo.684.1">You ca</span><a id="_idTextAnchor667"/><span class="koboSpan" id="kobo.685.1">n read more about New Relic</span><a id="_idIndexMarker547"/><span class="koboSpan" id="kobo.686.1"> and its configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.687.1">at </span></span><a href="https://docs.newrelic.com/"><span class="No-Break"><span class="koboSpan" id="kobo.688.1">https://docs.newrelic.com/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.689.1">.</span></span></p>
<h1 id="_idParaDest-349"><a id="_idTextAnchor668"/><span class="koboSpan" id="kobo.690.1">Infrastructure and application monitoring with Datadog</span></h1>
<p><strong class="bold"><span class="koboSpan" id="kobo.691.1">Datadog</span></strong><span class="koboSpan" id="kobo.692.1"> is an </span><a id="_idIndexMarker548"/><span class="koboSpan" id="kobo.693.1">observability service that provides detailed analytics for infrastructure, databases, applications, and services. </span><span class="koboSpan" id="kobo.693.2">Just like New Relic, Datadog is a full-stack platform that allows all-around monitoring that provides great insights into the health of an application </span><span class="No-Break"><span class="koboSpan" id="kobo.694.1">and infrastructure.</span></span></p>
<p><span class="koboSpan" id="kobo.695.1">Although both Datadog and New Relic are similar in almost all aspects, both of them have some benefits over each other. </span><span class="koboSpan" id="kobo.695.2">For example, a popular opinion is that while New Relic is great</span><a id="_idIndexMarker549"/><span class="koboSpan" id="kobo.696.1"> at </span><strong class="bold"><span class="koboSpan" id="kobo.697.1">Application Performance Monitoring</span></strong><span class="koboSpan" id="kobo.698.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.699.1">APM</span></strong><span class="koboSpan" id="kobo.700.1">), Datadog is stronger at </span><span class="No-Break"><span class="koboSpan" id="kobo.701.1">infrastructure monitoring.</span></span></p>
<p><span class="koboSpan" id="kobo.702.1">In short, both these platforms are great for most purposes and you c</span><a id="_idTextAnchor669"/><span class="koboSpan" id="kobo.703.1">an choose to use any of them or maybe some other tool/platform based on </span><span class="No-Break"><span class="koboSpan" id="kobo.704.1">your needs.</span></span></p>
<h2 id="_idParaDest-350"><a id="_idTextAnchor670"/><span class="koboSpan" id="kobo.705.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.706.1">Just like in the </span><a id="_idIndexMarker550"/><span class="koboSpan" id="kobo.707.1">previous recipe, we will use the </span><a id="_idIndexMarker551"/><span class="koboSpan" id="kobo.708.1">catalog application that we have built throughout this book. </span><span class="koboSpan" id="kobo.708.2">In essence, the application to be used does not matter here; it should just be a running </span><span class="No-Break"><span class="koboSpan" id="kobo.709.1">Flask application.</span></span></p>
<p><span class="koboSpan" id="kobo.710.1">The first step is to create a new account with Datadog. </span><span class="koboSpan" id="kobo.710.2">They have a free tier that would suffice for testing, as in our case. </span><span class="koboSpan" id="kobo.710.3">Once you’ve signed up and logged in, the first step is to enable/install the Python integration in the </span><span class="No-Break"><span class="koboSpan" id="kobo.711.1">Datadog console:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer084">
<span class="koboSpan" id="kobo.712.1"><img alt="Figure 11.5 – Installing the Python integration" src="image/B19111_11_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.713.1">Figure 11.5 – Installing the Python integration</span></p>
<p><span class="koboSpan" id="kobo.714.1">As shown in the preceding screenshot, click on the </span><strong class="bold"><span class="koboSpan" id="kobo.715.1">Python</span></strong><span class="koboSpan" id="kobo.716.1"> tile and install </span><span class="No-Break"><span class="koboSpan" id="kobo.717.1">the integration.</span></span></p>
<p><span class="koboSpan" id="kobo.718.1">As soon as you create an account on Datadog, it creates an API key by default. </span><span class="koboSpan" id="kobo.718.2">This API key will be needed in all further steps to make sure that monitoring statistics from your machine/server and application are sent to the correct Datadog account. </span><span class="koboSpan" id="kobo.718.3">Navigate to </span><strong class="bold"><span class="koboSpan" id="kobo.719.1">Your account</span></strong><span class="koboSpan" id="kobo.720.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.721.1">Organization Settings</span></strong><span class="koboSpan" id="kobo.722.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.723.1">API Keys</span></strong><span class="koboSpan" id="kobo.724.1"> to get your API key or just go </span><span class="No-Break"><span class="koboSpan" id="kobo.725.1">to </span></span><a href="https://app.datadoghq.com/organization-settings/api-keys"><span class="No-Break"><span class="koboSpan" id="kobo.726.1">https://app</span><span id="_idTextAnchor671"/><span class="koboSpan" id="kobo.727.1">.datadoghq.com/organization-settings/api-keys</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.728.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer085">
<span class="koboSpan" id="kobo.729.1"><img alt="Figure 11.6 – Fetching the API key" src="image/B19111_11_06.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.730.1">Figure 11.6 – Fetching the API key</span></p>
<h2 id="_idParaDest-351"><a id="_idTextAnchor672"/><span class="koboSpan" id="kobo.731.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.732.1">Go through</span><a id="_idIndexMarker552"/><span class="koboSpan" id="kobo.733.1"> the following steps to set up</span><a id="_idIndexMarker553"/><span class="koboSpan" id="kobo.734.1"> infrastructure and application monitoring </span><span class="No-Break"><span class="koboSpan" id="kobo.735.1">with Datadog:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.736.1">Once you get the API key, the next step is to install the Datadog agent on your operating system to allow for infrastructure monitoring. </span><span class="koboSpan" id="kobo.736.2">Follow the instructions according to your OS or infrastructure by navigating to </span><strong class="bold"><span class="koboSpan" id="kobo.737.1">Integrations</span></strong><span class="koboSpan" id="kobo.738.1"> | </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.739.1">Agent</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.740.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer086">
<span class="koboSpan" id="kobo.741.1"><img alt="Figure 11.7 – Installing the Datadog agent" src="image/B19111_11_07.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.742.1">Figure 11.7 – Installing the Datadog agent</span></p>
<p><span class="koboSpan" id="kobo.743.1">As shown in the preceding screenshot, select your OS and follow the instructions accordingly. </span><span class="koboSpan" id="kobo.743.2">Your OS might ask for some permissions, which you will need to grant for Datadog to work properly.</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.744.1">Once you’ve installed the agent, navigate to </span><strong class="bold"><span class="koboSpan" id="kobo.745.1">Infrastructure</span></strong><span class="koboSpan" id="kobo.746.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.747.1">Infrastructure List</span></strong><span class="koboSpan" id="kobo.748.1"> to validate that your infrastructure is </span><span class="No-Break"><span class="koboSpan" id="kobo.749.1">being monitored:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer087">
<span class="koboSpan" id="kobo.750.1"><img alt="Figure 11.8 – Infrastructure monitoring validation" src="image/B19111_11_08.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.751.1">Figure 11.8 – Infrastructure monitoring validation</span></p>
<p><span class="koboSpan" id="kobo.752.1">Feel free to explore other options or drill down into the details here to see more analytics.</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.753.1">The next </span><a id="_idIndexMarker554"/><span class="koboSpan" id="kobo.754.1">step is to install</span><a id="_idIndexMarker555"/><span class="koboSpan" id="kobo.755.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.756.1">ddtrace</span></strong><span class="koboSpan" id="kobo.757.1"> utility, which is Datadog’s Python APM client and allows you to profile code, requests, and trace data to flow </span><span class="No-Break"><span class="koboSpan" id="kobo.758.1">to Datadog:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.759.1">$ pip install ddtrace</span></strong></pre></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.760.1">Important</span></p>
<p class="callout"><span class="koboSpan" id="kobo.761.1">If your application is running on port 5000, make sure you change the port to something else – ports 5000 to 5002 are used by Datadog for its agent and </span><span class="No-Break"><span class="koboSpan" id="kobo.762.1">other utilities.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.763.1">Following the installation of </span><strong class="source-inline"><span class="koboSpan" id="kobo.764.1">ddtrace</span></strong><span class="koboSpan" id="kobo.765.1">, run your Flask application using the </span><span class="No-Break"><span class="koboSpan" id="kobo.766.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.767.1">$ DD_SERVICE="&lt;your service name&gt;" DD_ENV="&lt;your environment name&gt;" ddtrace-run python run.py</span></strong></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.768.1">Note the </span><strong class="source-inline"><span class="koboSpan" id="kobo.769.1">DD_SERVICE</span></strong><span class="koboSpan" id="kobo.770.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.771.1">DD_ENV</span></strong><span class="koboSpan" id="kobo.772.1"> environment variables. </span><span class="koboSpan" id="kobo.772.2">These are important for Datadog to decide how to segregate and group your application logs.</span></p>
<p><span class="koboSpan" id="kobo.773.1">If you get an error, as shown in the following screenshot, just set </span><strong class="source-inline"><span class="koboSpan" id="kobo.774.1">DD_REMOTE_CONFIGURATION_ENABLED=false</span></strong><span class="koboSpan" id="kobo.775.1">:</span></p>
<div>
<div class="IMG---Figure" id="_idContainer088">
<span class="koboSpan" id="kobo.776.1"><img alt="Figure 11.9 – Handling configuration errors" src="image/B19111_11_09.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.777.1">Figure 11.9 – Handling configuration errors</span></p>
<p><span class="koboSpan" id="kobo.778.1">Hence, in my case, the command looks like this:</span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.779.1">$ DD_SERVICE="flask-cookbook" DD_ENV="stage" DD_REMOTE_CONFIGURATION_ENABLED=false ddtrace-run python run.py</span></strong></pre>
<ol>
<li value="5"><span class="koboSpan" id="kobo.780.1">Now, just</span><a id="_idIndexMarker556"/><span class="koboSpan" id="kobo.781.1"> wait for a few</span><a id="_idIndexMarker557"/><span class="koboSpan" id="kobo.782.1"> minutes – your application statistics should start reflecting </span><span class="No-Break"><span class="koboSpan" id="kobo.783.1">on Datadog:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer089">
<span class="koboSpan" id="kobo.784.1"><img alt="Figure 11.10 – APM in action" src="image/B19111_11_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.785.1">Figure 11.10 – APM in action</span></p>
<p><span class="koboSpan" id="kobo.786.1">Feel free to play around and dig into </span><a id="_idTextAnchor673"/><span class="koboSpan" id="kobo.787.1">more details to understand how Datadog works and what kind of statistics </span><span class="No-Break"><span class="koboSpan" id="kobo.788.1">it provides.</span></span></p>
<h2 id="_idParaDest-352"><a id="_idTextAnchor674"/><span class="koboSpan" id="kobo.789.1">See also</span></h2>
<p><span class="koboSpan" id="kobo.790.1">You can read more about Datadog and </span><strong class="source-inline"><span class="koboSpan" id="kobo.791.1">ddtrace</span></strong><span class="koboSpan" id="kobo.792.1"> at the </span><span class="No-Break"><span class="koboSpan" id="kobo.793.1">following links:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.794.1">Flask </span><a id="_idIndexMarker558"/><span class="koboSpan" id="kobo.795.1">configuration for </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.796.1">ddtrace</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.797.1">: </span></span><a href="https://ddtrace.readthedocs.io/en/stable/integrations.html#flask"><span class="No-Break"><span class="koboSpan" id="kobo.798.1">https://ddtrace.readthedocs.io/en/stable/integrations.html#flask</span></span></a></li>
<li><span class="koboSpan" id="kobo.799.1">Datadog </span><a id="_idIndexMarker559"/><span class="No-Break"><span class="koboSpan" id="kobo.800.1">documentation: </span></span><a href="https://docs.datadoghq.com/"><span class="No-Break"><span class="koboSpan" id="kobo.801.1">https://docs.datadoghq.com/</span></span></a></li>
</ul>
</div>
</body></html>