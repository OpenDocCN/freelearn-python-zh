<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Making a Command-Line Utility</h1>
                </header>
            
            <article>
                
<p>In the previous chapter, we visited some best practices that would help us in the long run when using Python. In this chapter, we're going to see how to make Python command-line programs and some features that make such programs easier and more useful. We're going to see how to create an entry point for code execution in a package and see how to run the package as a program.</p>
<p>We're also going to see how to make the program read data from its command line and how to easily handle reading data from our program's command-line arguments. We'll also look at how to actually run other programs from inside our code.</p>
<p>In this chapter, we will cover the following topics:</p>
<ul>
<li>Making a package executable via Python <kbd>-m</kbd></li>
<li>Handling command-line argument with <kbd>argparse</kbd></li>
<li>Python tools to interact with the user</li>
<li>Executing other programs with subprocess</li>
<li>Using shell script or batch files to run our programs</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Making a package executable via Python -m</h1>
                </header>
            
            <article>
                
<p>In the previous chapter, we ran command-line tools, such as <kbd>doctest</kbd> and <kbd>venv</kbd>, by typing in the <kbd>python3 -m</kbd> command followed by the name of the tool we wanted it to run:</p>
<div class="CDPAlignCenter CDPAlign"><img height="107" width="677" class="image-border" src="assets/7708e7b2-2b70-4976-a5bb-db912475dd01.jpg"/></div>
<p>What were we actually asking Python to do when we did that?</p>
<p>The <kbd>-m</kbd> command-line switch for Python tells it to run a module. It uses the same mechanism to find the module that it would if we'd used an <kbd>import</kbd> statement with the module's name and then it executes it.</p>
<p>However, <kbd>venv</kbd> isn't a module, it's a package. So, what's happening when we use <kbd>python -m venv</kbd>? We gave Python a package name, but we didn't give it a module name inside the package that it should run. When that happens, Python looks for a module named <kbd>__main__</kbd> in the package and runs that:</p>
<div class="CDPAlignCenter CDPAlign"><img class="image-border" src="assets/86829831-f3ee-469a-8014-1b8f271088bb.jpg"/></div>
<p>So, <kbd>python -m venv</kbd> means the same thing as <kbd>python -m venv.__main__</kbd>.</p>
<p>Any module that's meant to contain a program's entry point has a problem because simply importing the module will run the code too. This can be annoying or troublesome at the best of times, but it becomes unacceptable when we're using tools, such as Sphinx or doctest, that need to import modules in order to do their jobs, but which really shouldn't actually run the module code as a program.</p>
<p>Fortunately, there's an easy fix because the Python interpreter itself knows which module it was told to start running and marks it as such. All modules are automatically given a variable called <kbd>__name__</kbd>, which contains the module's name. All modules, that is, except for the program entry point.</p>
<p>The program entry point is always given the name <kbd>__main__</kbd>, even if its filename is something entirely different:</p>
<div class="CDPAlignCenter CDPAlign"><img height="136" width="234" class="image-border" src="assets/8c876c86-f805-4e4d-81d5-6471f1450d5c.jpg"/></div>
<p>So, we can check whether our code was the program entry point by checking this, <kbd>__name__ == '__main__'</kbd>. If our code was indeed the program entry point, then we should run the program, as in the example above. If it isn't, we would import it normally as code and should not run the program as main code.</p>
<p>This distinguishes between importing of the <kbd>__main__</kbd> module of the package and running it. Because when we import it, the name variable contains the package name <kbd>__main__</kbd>, not just <kbd>__main__</kbd>. In the upcoming sections in this chapter, we're going to work through the process of building a complete utility program called <strong>Pipeline</strong>.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Pipeline program</h1>
                </header>
            
            <article>
                
<p>Pipeline will be a text-mode program that can be configured to run a sequence of other programs and feed data from each program into the next. In each section, we'll apply what we talked about developing Pipeline further.</p>
<p>So far, what we talked about in this chapter is how to make the program able to be run from <kbd>python -m</kbd>, but in the previous chapters, we saw how to create a virtual environment to work in, how to create a package, and how to layout the code in the packages modules for readability.</p>
<p>So, let's put those lessons to use.</p>
<p>Create a folder within the virtual environment to be the package and call it <kbd>pipeline</kbd>. Inside the <kbd>package</kbd> folder, place an <kbd>__init__.py</kbd> file, which can be empty, and a <kbd>__main__.py</kbd> file:</p>
<div class="CDPAlignCenter CDPAlign"><img height="31" width="329" class="image-border" src="assets/94ad8085-b6b8-4473-b127-d286074bc5ea.jpg"/></div>
<p>For now, the contents of the <kbd>__main__.py</kbd> file can be very simple, as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img height="243" width="466" class="image-border" src="assets/e3a07e6f-53d5-4ce2-ae82-c7a3a36ca49f.jpg"/></div>
<p>The contents of the <kbd>__main__.py</kbd> file are as follows:</p>
<ul>
<li>A docstring for the module</li>
<li>A function that should be called if the module is the program entry point</li>
<li>The <kbd>if</kbd> statement that decides whether or not to call the <strong>launch function</strong></li>
</ul>
<p>The launch function doesn't have a docstring, which is allowed because it's marked as non-public by having an underscore as the first letter of its name. The launch function also doesn't do anything interesting yet; it just uses the print function to tell us that it was successfully executed.</p>
<p>Let's run it so we can see for ourselves.</p>
<ol>
<li>Open a command-line window,</li>
<li>Go to the virtual environment where we created the package</li>
<li>Activate the virtual environment.</li>
<li>Then, type the following command:</li>
</ol>
<pre>
      <strong>(pipeline) $ python -m pipeline</strong>
</pre>
<p>The output is as follows:</p>
<div class="CDPAlignCenter CDPAlign"><img height="43" width="356" class="image-border" src="assets/f7d01bc6-4d55-454e-bb00-808b1d21e48a.jpg"/></div>
<p>We should see the message printed out (as shown in the preceding screenshot) and then the program will end.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Handling command-line arguments with argparse</h1>
                </header>
            
            <article>
                
<p>In this section, we'll see how to make the program read data from its command line, a common feature for programs of all sorts. Most command-line programs and a surprising number of graphical user interface programs as well can be given extra information on the command line, after the command that invokes the program. These extra bits of information are referred to as <strong>arguments</strong> and they are delivered to Python programs as a list of strings. It turns out that there's quite a lot of code involved in turning an argument list into useful information, especially, if we want to make the program as convenient for our users as possible. Fortunately, a lot of that code can be the same from program to program, and the Python standard library's <strong>argparse</strong> module takes care of much of the effort for us.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating an ArgumentParser object</h1>
                </header>
            
            <article>
                
<p>The primary component of the <kbd>argparse</kbd> module is the <kbd>ArgumentParser</kbd> class. In the minimal case, it only takes three lines of code to use <kbd>argparse</kbd>. We need to import it, create an argument parser instance, and call that instance's <kbd>parse_args()</kbd> function:</p>
<div class="CDPAlignCenter CDPAlign"><img height="93" width="269" class="image-border" src="assets/55cb4b89-7a8b-4907-b5cc-65d1907de2f7.jpg"/></div>
<p>As usual, with minimal cases that's not very useful. The only arguments that the program will respond to are <kbd>-h</kbd> or <kbd>--help</kbd>, either of which would print out an automatically generated <kbd>how to use this program</kbd> message and then exit the program.</p>
<p>The first thing we could do to make the <kbd>ArgumentParser</kbd> class more useful is to provide a value for the <kbd>description</kbd> parameter of its constructor, as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img height="81" width="413" class="image-border" src="assets/d4100d3b-1264-4c12-9f1c-5ffee58fa9df.jpg"/></div>
<p>ArgumentParser's automatically generated help message will explain all the arguments that the program expects, but it doesn't say anything about what the program is actually supposed to do, unless we provide a description ourselves.</p>
<p>The next way we can improve the ArgumentParser's behavior is by telling it the name of the program. If we don't provide a name, it will do its best to make a reasonable guess, but we're better off telling it ourselves. I consider the <kbd>python3 -m</kbd> command (refer to the following code example) to be the canonical name for my own programs so that's what we'll use in our examples:</p>
<div class="CDPAlignCenter CDPAlign"><img height="107" width="235" class="image-border" src="assets/e9bd1132-8524-4c32-8d46-6e36dc6e1906.jpg"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Setting the name of argument</h1>
                </header>
            
            <article>
                
<p>We set the name of an argument by passing it as a string to the <kbd>ArgumentParser</kbd> constructor's <kbd>prog</kbd> parameter. These changes make the help output of the program prettier and more useful, but they don't actually give the program any new capabilities.</p>
<p>We need to start adding argument specifications to the parser, so it can check for them in the argument list.</p>
<p>We do that by calling the <kbd>ArgumentParser</kbd> instance's <kbd>add_argument</kbd> method:</p>
<div class="CDPAlignCenter CDPAlign"><img height="130" width="515" class="image-border" src="assets/081e4595-1f00-4df7-bc52-de2106ddf0ea.jpg"/></div>
<p>The <kbd>argparse</kbd> module recognizes two kinds of arguments:</p>
<ul>
<li>Optional arguments</li>
<li>Positional arguments</li>
</ul>
<p>As the name implies, <strong>optional arguments</strong> are not required, but if the user chooses to include them, they have meaning. <strong>Positional arguments</strong>, on the other hand, are required by default, although we can modify that behavior. Optional arguments have names that start with the <kbd>-</kbd> character. They can have more than one alternate name for the same argument. The names are passed as parameters to the <kbd>add_argument</kbd> method, as in the preceding example, where <kbd>-p</kbd> and <kbd>--print</kbd> are alternate names for the same optional argument.</p>
<div class="packt_infobox">There are a lot of ways of configuring an argument when we add it to the parser, which are detailed in the <kbd>argparse</kbd> documentation in the library reference at <a href="https://docs.python.org/3/"><span class="URLPACKT">https://docs.python.org/3/</span></a>.</div>
<p>For options like our print example though, the important configuration items are <kbd>action</kbd> and <kbd>default</kbd>:</p>
<ul>
<li>The <kbd>action</kbd> parameter tells <kbd>argparse</kbd> what to do when it finds the argument on the command line</li>
<li>The <kbd>default</kbd> parameter tells it what to do when it doesn't find the argument on the command line</li>
</ul>
<p>The <kbd>action</kbd> parameter can either be a string containing the name of one of the well-known actions, such as <kbd>store_true</kbd>, or it could be a subclass of the <kbd>argparse.action</kbd> class:</p>
<div class="CDPAlignCenter CDPAlign"><img height="116" width="518" class="image-border" src="assets/268fc3eb-9a19-4411-89fc-07303539e8f1.jpg"/></div>
<p>The <kbd>default</kbd> parameter can be any arbitrary value, which will be stored as the value of the argument. If it's missing when we actually ask the <kbd>parser</kbd> to parse out the argument values, the other kind of argument has to have just one name and it can't start with a <kbd>-</kbd> character.</p>
<p>By default, these arguments collect one word that isn't part of an optional argument from the command line in the order that they were added to the parser. If we configure the argument using the <kbd>nargs</kbd> option, we can change the number of words that the argument collects.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">nargs</h1>
                </header>
            
            <article>
                
<p>If we set <kbd>nargs</kbd> to a number, that many words will be collected for the argument. We can also set <kbd>nargs</kbd> to <kbd>*</kbd> to mean any number of words or <kbd>+</kbd> to mean at least one word. There are a few other values we could set <kbd>nargs</kbd> to, but we won't talk about them here in this section.</p>
<p>Let's look back at our Pipeline program. I think we want it to understand two arguments-an <kbd>optional</kbd> argument that tells it to keep going, even if one of the programs returns an error code, and a filename, where it should load and store a pipeline configuration:</p>
<div class="CDPAlignCenter CDPAlign"><img height="391" width="502" class="image-border" src="assets/6b0c5e43-5496-4877-ba32-e0a176d61ad2.jpg"/></div>
<p>After the call to parse <kbd>parse_args</kbd>, we have an object named <kbd>args</kbd> that contains a <kbd>keep_going</kbd> attribute set to either <kbd>true</kbd> or <kbd>false</kbd> and a <kbd>filename</kbd> attribute containing a string.</p>
<div class="packt_infobox">Notice that the attribute of the arguments object is <kbd>keep_going</kbd>, not <kbd>keep-going</kbd>. Python doesn't allow <kbd>-</kbd> characters inside of attribute names and <kbd>argparse</kbd> is smart enough to fix that for us automatically.</div>
<p>If we wanted to set the name of the argument object attribute manually, we could have passed the name we wanted to the <kbd>add_argument</kbd> method as its best parameter.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Python tools to interact with the user</h1>
                </header>
            
            <article>
                
<p>In the previous section, we saw how to get information from the user on the command line, but what do we do when we need a more dynamic form of interaction? So, let's take a look at some of Python's tools for sending information to the user and requesting information from the user.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Python's built-in functions - print and input</h1>
                </header>
            
            <article>
                
<p>The fundamentals of interactivity are simple. We need to be able to tell the user things and we need the user to be able to tell us things. In service of those two goals, Python provides two built-in functions. These are <kbd>print</kbd> and <kbd>input</kbd>.</p>
<p>Create a <kbd>simple.py</kbd> file with the following code:</p>
<div class="CDPAlignCenter CDPAlign"><img height="76" width="190" class="image-border" src="assets/1d62021f-27e7-4b79-8c36-319b6af93530.jpg"/></div>
<p>The <kbd>print</kbd> function takes any number of Python objects as parameters and prints them on the screen. The <kbd>input</kbd> function takes a string prompt as its parameter, prints it out, then reads text until the user hits <em><span class="KeyPACKT">Enter</span></em>, and returns what the user typed as a string.</p>
<p>Run the following command to see how the <kbd>print</kbd> and <kbd>input</kbd> functions work:</p>
<pre>
<strong>python3 simple.py</strong>  
</pre>
<p>That's about as simple as interactivity can get. The following screenshot shows the output of the preceding command:</p>
<div class="CDPAlignCenter CDPAlign"><img height="58" width="347" class="image-border" src="assets/004d1d55-dd68-4898-914b-4ed3dcb65a3f.jpg"/></div>
<p>The <kbd>print</kbd> and <kbd>input</kbd> functions can do a lot, but there are a couple of corner cases where they don't work so well.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">The getpass package</h1>
                </header>
            
            <article>
                
<p>One of those corner cases I just mentioned is when we want the user to type in a password. If we use the <kbd>input</kbd> function to read the password, it would be displayed on the screen for anybody to read. The <kbd>getpass</kbd> package contains a function, also called <kbd>getpass</kbd>, which works just like <kbd>input</kbd>, except that it doesn't show the text that the user types.</p>
<div class="CDPAlignCenter CDPAlign"><img height="112" width="348" class="image-border" src="assets/6436f6cd-4ec0-48fc-8d46-8e2b7ada0e5c.jpg"/></div>
<p>The other corner case I want to mention is that, although the <kbd>print</kbd>  function can print out any Python object, it doesn't do a good job presenting complex data structures.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">The pprint package</h1>
                </header>
            
            <article>
                
<p>The <kbd>pprint</kbd> function, from the package of the same name, makes complex data structures much more readable. If we want to display a list of dictionaries, <kbd>pprint</kbd> will do a better job of it than the <kbd>print</kbd> function would.</p>
<p>Create a <kbd>special.py</kbd> file with the following code:</p>
<div class="CDPAlignCenter CDPAlign"><img height="86" width="382" class="aligncenter size-full wp-image-1125 image-border" src="assets/d12adfd5-c031-4985-9656-934dfa0a8470.jpg"/></div>
<p>Run the following command to execute the <kbd>special.py</kbd> file:</p>
<pre>
<strong>python3 special.py </strong>  
</pre>
<p>The following screenshot is the output of the preceding command:</p>
<div class="CDPAlignCenter CDPAlign"><img height="409" width="337" class="image-border" src="assets/97978ef3-bccf-4f42-ba90-e88c389a366e.jpg"/></div>
<p>Between these four functions - <kbd>print</kbd>, <kbd>input</kbd>, <kbd>getpass</kbd>, and <kbd>pprint</kbd> - there's a wide range of user interfaces we could make, but they are pretty basic tools. We'd be reinventing a lot of wheels and wasting time. Fortunately, thanks to Python's <em>batteries included</em> philosophy, we don't have to do that. Instead, we'll use the <kbd>cmd</kbd> package of the standard libraries to quickly build our user interface.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">The cmd class</h1>
                </header>
            
            <article>
                
<p>All we have to do is inherit from the <kbd>cmd</kbd> class and define the methods that implement commands the user can type.</p>
<p>Create a <kbd>usecmd.py</kbd> file with the following code:</p>
<div class="CDPAlignCenter CDPAlign"><img height="151" width="172" class="image-border" src="assets/71be32bb-288a-450d-9e93-63cfc2ae4f32.jpg"/></div>
<p>We'll set the prompt attribute to a string that will be used to prompt the user for a command. Run the following command to execute the <kbd>usecmd.py</kbd> file:</p>
<pre>
<strong>$ python3 usecmd.py</strong>
</pre>
<p>The output of the preceding command is as follows:</p>
<div class="CDPAlignCenter CDPAlign"><img height="147" width="283" class="image-border" src="assets/66c6e417-b161-461a-9275-cf7ca3ed803e.jpg"/></div>
<p>Next, we'll create an instance of our <kbd>Interface</kbd> class (shown in the following screenshot) and call it the <kbd>cmdloop</kbd> method. Presto! Instant interface:</p>
<div class="CDPAlignCenter CDPAlign"><img height="125" width="392" class="aligncenter size-full wp-image-1130 image-border" src="assets/942b5989-76ae-420b-94ec-05172467b332.jpg"/></div>
<p>In this example, we see that the <kbd>cmd</kbd> class takes care of displaying props, reading and commands, and invoking the correct methods, but that's all it does. We still need the <kbd>print</kbd> function if we want to display data from inside of a command handler method.</p>
<p>The <kbd>cmd</kbd> class isn't exclusive. It does a lot of work for us, but we could still use the <kbd>print</kbd> and <kbd>input</kbd> functions directly, if we need to. That's very nearly everything there is to say about text mode interactivity in Python, at least if we want our programs to be portable across platforms.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">The Pipeline user interface</h1>
                </header>
            
            <article>
                
<p>There's another standard library module called <kbd>curses</kbd>, which enables much more sophisticated text load operations; however, as the <kbd>curses</kbd> module is not portable to Windows, we're not going to go into detail in this chapter.</p>
<p>Instead, let's look at defining the user interface for our <strong>Pipeline</strong> program:</p>
<div class="CDPAlignCenter CDPAlign"><img class="image-border" src="assets/feca7569-39dd-4280-9b2f-a545966ed81e.jpg"/></div>
<p>Now it seems like we'd want to be able to add programs to Pipeline and manipulate the data passing between the programs in various ways:</p>
<div class="CDPAlignCenter CDPAlign"><img height="69" width="528" class="aligncenter size-full wp-image-1131 image-border" src="assets/0d99c6ec-3ca7-4ee2-a699-3f309e36f14f.jpg"/></div>
<p>We'll also want to be able to save the pipeline when we're happy with it and to be able to actually run it. Finally, we'll want to be able to quit the program using the <kbd>quit</kbd> command.</p>
<p>A <kbd>help</kbd> command would also be helpful, but luckily, the <kbd>cmd</kbd> class will provide that automatically using the <kbd>docstrings</kbd> for the command handler functions:</p>
<div class="CDPAlignCenter CDPAlign"><img height="147" width="368" class="aligncenter size-full wp-image-1132 image-border" src="assets/e05f26cc-fef3-4fc3-b6d8-b88eb3a8bb12.jpg"/></div>
<p>We're just going to stub in the command handlers here because we're focusing on the interface implementation for now. So, there we have a pretty decent user interface with very little work on our part. That wraps up our look at text-mode interaction here. Let's now focus on some of our options around program control.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Executing other programs with subprocess</h1>
                </header>
            
            <article>
                
<p>In this section, you will learn how to execute and control other programs from within our own, allowing us to create the heart of our example program. This ability is often useful for all sorts of system automation tasks. Create an <kbd>echo.py</kbd> file with the following content:</p>
<div class="CDPAlignCenter CDPAlign"><img height="92" width="193" class="image-border" src="assets/7d789add-216e-49ee-b304-1843ca0b448d.jpg"/></div>
<p>Making other programs run used to be something of a mess. There were different mechanisms that worked on different platforms, there were mechanisms that were convenient and there were different mechanisms that were secure. Fortunately, all that changed since Python version 2.4 with the introduction of the <kbd>subprocess</kbd> module, which abstracts away the differences between platforms and makes some more secure paradigms easy to use.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Subprocess and its variants</h1>
                </header>
            
            <article>
                
<p>There are six objects in the <kbd>subprocess</kbd> package that are of particular interest. Three of them are the <kbd>call</kbd>, <kbd>check_call</kbd>, and <kbd>check_output</kbd> functions, which are three variants on the same basic idea:</p>
<pre>
<strong>from subprocess import call, check_call, check_output</strong>
</pre>
<p>These three objects run a program, wait for it to terminate, and then tell us something about what the program did:</p>
<ul>
<li>The <kbd>call</kbd> function returns the program's exit code, which is an integer that has a program-defined meaning, which is usually used to know whether the program has succeeded or failed.</li>
<li>The <kbd>check_call</kbd> function raises an exception if the program's exit code is non-zero, which, by convention, means that it exited with an error.</li>
<li>The <kbd>check_output</kbd> function returns whatever text the program printed and raises an exception if the program exited with a non-zero exit code. The raised exception has an attribute called <kbd>output</kbd> that contains the text output of the program. So, even if the program exited with an error code, we could still get the output if we want it.</li>
</ul>
<p>The <kbd>run</kbd> function is similar to the <kbd>call</kbd> function we were looking at just a moment ago:</p>
<pre>
<strong>from subprocess import run</strong>  
</pre>
<p>In fact, the <kbd>run</kbd> function is capable of doing anything that anyone would do, in combination. However it is not necessarily possible to use it in other projects, at least not yet.</p>
<p>The three call functions and the run function are invoked in largely the same way. Each of them is passed as a list containing the program name and its arguments. We see the output of this <kbd>'ls','-l'</kbd> function on the screen that wasn't from the call because <kbd>'ls','-l'</kbd> prints something out when it runs.</p>
<p>Type the following statement:</p>
<pre>
<strong>call(['ls', '-l', '/dev/null'])  </strong>
</pre>
<p>The following is the output of the preceding statement:</p>
<div class="CDPAlignCenter CDPAlign"><img height="63" width="377" class="image-border" src="assets/2469ea6e-4110-43d6-800b-dd5ca6b0d595.jpg"/></div>
<p>The exit code returned <kbd>0</kbd>, though. So that becomes your call. If you wanted to take that printout from the <kbd>'ls'</kbd> program and use it in our program, we need to capture it.</p>
<p>The <kbd>check_output</kbd> function has a noteworthy keyword-only parameter called <kbd>universal_newlines</kbd>, which defaults to <kbd>False</kbd>. If we set <kbd>universal_newlines</kbd> to <kbd>True</kbd>, the text output of the program is decoded into unicode characters, using the system's default text codec, and the newline characters are normalized.</p>
<p>If we leave <kbd>universal_newlines</kbd> at its default value of <kbd>False</kbd>, the program output is returned as bytes and it's up to us to do any decoding and to deal with whatever sequence of characters the current system considers to be a newline character:</p>
<pre>
<strong>lines = check_output(['ls', '-l', '/dev/'], universal_newlines = True).split('\n')</strong>
</pre>
<p>Now type the following and press <em><span class="KeyPACKT">Enter</span></em>:</p>
<pre>
<strong>lines     </strong>
</pre>
<p>In this code example, we did set <kbd>universal_newlines</kbd> to <kbd>True</kbd> and then split it at <kbd>\n</kbd>, which is the standard newline character, and that gave us back a list of the lines that are output from the program:</p>
<div class="CDPAlignCenter CDPAlign"><img height="495" width="750" class="image-border" src="assets/52af42cf-6348-4020-8a1b-dda1e719bfc1.jpg"/></div>
<p>If we want to get fancier with our running of other programs, we'll want to use instances of the <kbd>Popen</kbd> class-the fourth interesting thing in the <kbd>subprocess</kbd> package and which allows us a great deal of flexibility and control over the execution of other programs.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Using the Popen subprocess</h1>
                </header>
            
            <article>
                
<p>At the cost of a bit more complexity, the <kbd>Popen</kbd> constructor accepts the same list of program and command-line arguments that the call functions do and a very large number of optional keyword arguments, including <kbd>universal_newlines</kbd>.</p>
<p>We're going to focus on a particular use of the <kbd>Popen</kbd> constructor that is useful, but goes beyond what we can achieve using one of the call functions. We're going to see how to run a program in the background while our own code is also running, and send and receive data between the two programs.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">The PIPE constant</h1>
                </header>
            
            <article>
                
<p>To manage that, we're going to need the last of our six interesting things in the <kbd>subprocess</kbd> package-the <kbd>PIPE</kbd> constant. The <kbd>PIPE</kbd> constant is used in conjunction with the <kbd>stdin</kbd>, <kbd>stdout</kbd>, or <kbd>stderr</kbd> keyword parameters of the <kbd>Popen</kbd> constructor:</p>
<pre>
<strong>p = Popen(['python3', 'echo.py'], stdin = PIPE, stout = PIPE, bufsize = 0)   </strong>
</pre>
<p>These parameters represent the other program's textual input, output, and error reporting. Any of them that we set to <kbd>PIPE</kbd> are redirected to our program. In the preceding example, we're redirecting the program's inputs and output to ourselves, which gives us a bi-directional data channel with the other programs.</p>
<p>Now you see, we are interacting programmatically with the code on screen that was at the beginning of this example. However, since it sets in a loop, inputs, and then outputs, accord. Also, whenever there is input, once we have <kbd>PIPE</kbd> set up, we could send data to the other program by calling the <kbd>write</kbd> method on the Popen object's <kbd>stdin</kbd> attribute:</p>
<div class="CDPAlignCenter CDPAlign"><img height="97" width="229" class="image-border" src="assets/05f55bf5-c7bb-4baf-982c-742dca0180f6.jpg"/></div>
<p>We can read data by calling the <kbd>read</kbd> method or its relatives on the Popen object's <kbd>stdout</kbd> attribute, as shown in the preceding example code.</p>
<p>In spite of disabling buffering with the <kbd>bufsize = 0</kbd> parameter to the <kbd>Popen</kbd> constructor, it's usually a good idea to call the <kbd>flush</kbd> method on <kbd>stdin</kbd> after writing to it and on <kbd>stdout</kbd> before reading from it. We can keep on sending and receiving data for as long as both programs are running. However, if the time comes when we're done interacting and just want to wait for the other program to terminate, we can call the Popen object's <kbd>wait</kbd> method to do that.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">The wait method</h1>
                </header>
            
            <article>
                
<p>The <kbd>wait</kbd> method will return the exit code of the other program once it's done running. A lot of the complexity of working with <kbd>PIPE</kbd>, <kbd>stdin</kbd>, and <kbd>stdout</kbd> is wrapped up in the <kbd>Popen</kbd> class's <kbd>communicate</kbd> method, which accepts the input as a parameter and returns the output:</p>
<div class="CDPAlignCenter CDPAlign"><img height="101" width="244" class="image-border" src="assets/4c1f0a89-bd57-47f9-8f33-8daca8e3650a.jpg"/></div>
<p>Communication is simple, but somewhat limited because it can only be called once for each <kbd>Popen</kbd> object and doesn't return until the other program finishes. This isn't any good for two programs that need to talk back and forth to each other, but it should be just perfect for our pipeline program, where each program receives the output of the previous program as its input.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Finishing up our code example</h1>
                </header>
            
            <article>
                
<p>We're going to create a bunch of classes to represent the different kinds of steps in the pipeline and integrate those classes into the interface as well. Once we've done that, the program is functional, although there's plenty of room for improvement.</p>
<p>Our particular interest is the <kbd>ExecStep</kbd> class on the top right-hand side of the following screenshot, which uses <kbd>Popen</kbd> to actually execute a program and break free of the output.</p>
<div class="CDPAlignCenter CDPAlign"><img class="image-border" src="assets/b2b4eb14-bff6-4b46-8db4-bf89a74d2e7d.jpg"/></div>
<p>We've got our example program working now, so we're going to move on to the last section in this chapter.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Setting up a shell script or batch file to launch the program</h1>
                </header>
            
            <article>
                
<p>In this section, we're going to wrap up this chapter's example program by making it simple to launch. We can run our program using <kbd>python -m</kbd> as long as it's installed in the system <kbd>PYTHONPATH</kbd> or we've activated the virtual environment containing it, as shown here:</p>
<div class="CDPAlignCenter CDPAlign"><img height="85" width="454" class="image-border" src="assets/66009b75-2947-4004-bd9b-836294b749b5.jpg"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating launches for our program</h1>
                </header>
            
            <article>
                
<p>Once the program is solid, we really just want to be able to type its name or double-click on it and have it run. One convenient way to do that is to use a shell script or a batch file:</p>
<ul>
<li>On Unix-style operating systems including macOS, a shell script is a text file that starts with <kbd>#bang/bin/sh</kbd> and has been marked as executable</li>
<li>On Windows, a batch file is a file whose name ends in <kbd>.bat</kbd></li>
</ul>
<p>Both shell scripts and batch files are text files containing a sequence of command-line commands, one on each line. When we type the name of the script or batch file, those commands are executed one after the other, as if we type them all into the command line.</p>
<p>Similarly, if we trigger the script or batch file through a graphical user interface, the commands are still executed as if we typed them into a command line one by one. Consider this example:</p>
<div class="CDPAlignCenter CDPAlign"><img height="134" width="359" class="aligncenter size-full wp-image-1133 image-border" src="assets/ec7b834a-3cc2-42c4-90e9-b84dbb98aa9f.jpg"/></div>
<p>For our purposes here, this means that we can put whatever sequence of commands necessary to launch a program into a shell script or a batch file. After that, we could treat that script as if it were the program itself. That's all there is to the simple case.</p>
<p>Shell scripts are capable of representing a lot more complexity, but Python is a better tool for that. So, the simple case, here, is all we really need.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In the earlier sections of the chapter, you learned about how to make our Python packages into programs, get data from the command line, interact with the user, and run other programs as subprocesses. We saw how to make our Python programs as simple to watch as any other program from the GUI or the command line. We constructed a user interface for our Pipeline program and learned about several of Python's text mode tools along the way.</p>
<p>In the next chapter, we'll look at how to use parallel processing to take advantage of computers with multiple processors or cores.</p>


            </article>

            
        </section>
    </body></html>