<html><head></head><body>
<div id="_idContainer062">
<h1 class="chapter-number" id="_idParaDest-220"><a id="_idTextAnchor414"/><a id="_idTextAnchor415"/><span class="koboSpan" id="kobo.1.1">8</span></h1>
<h1 id="_idParaDest-221"><a id="_idTextAnchor416"/><span class="koboSpan" id="kobo.2.1">Admin Interface for Flask Apps</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Many applications require an interface that provides special privileges to some users and can be used to maintain and upgrade an application’s resources. </span><span class="koboSpan" id="kobo.3.2">For example, we can have an interface in an e-commerce application that will allow some special users to create categories, products, and more. </span><span class="koboSpan" id="kobo.3.3">Some users might have special permissions to handle other users who shop on the website, deal with their account information, and so on. </span><span class="koboSpan" id="kobo.3.4">Similarly, there can be many cases where we need to isolate some parts of the interface of our application from </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">normal users.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">In comparison to the very popular Python-based web framework, Django, Flask does not provide any admin interface by default. </span><span class="koboSpan" id="kobo.5.2">Although this can be seen as a shortcoming by many, this gives developers the flexibility to create the admin interface as per their requirements and have complete control over </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">the application.</span></span></p>
<p><span class="koboSpan" id="kobo.7.1">We can choose to write an admin interface for our application from scratch or use an extension of Flask, which does most of the work for us and gives us the option to customize the logic as needed. </span><span class="koboSpan" id="kobo.7.2">One very popular extension for creating admin interfaces in Flask is Flask-Admin (</span><a href="https://flask-admin.readthedocs.io/en/latest/"><span class="koboSpan" id="kobo.8.1">https://flask-admin.readthedocs.io/en/latest/</span></a><span class="koboSpan" id="kobo.9.1">). </span><span class="koboSpan" id="kobo.9.2">It is inspired by the Django admin but is implemented in a way that gives the developer complete control over the look, feel, and functionality of the application. </span><span class="koboSpan" id="kobo.9.3">In this chapter, we will start with the creation of an admin interface on our own, and then move on to using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.10.1">Flask-Admin</span></strong><span class="koboSpan" id="kobo.11.1"> extension and fine-tune this </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">as needed.</span></span></p>
<p><span class="koboSpan" id="kobo.13.1">In this chapter, we will cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">following recipes:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.15.1">Creating a simple </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">CRUD interface</span></span></li>
<li><span class="koboSpan" id="kobo.17.1">Using the </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">Flask-Admin extension</span></span></li>
<li><span class="koboSpan" id="kobo.19.1">Registering models </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1">with Flask-Admin</span></span></li>
<li><span class="koboSpan" id="kobo.21.1">Creating custom forms </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">and actions</span></span></li>
<li><span class="koboSpan" id="kobo.23.1">Using a WYSIWYG editor for </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.24.1">textarea</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.25.1"> integration</span></span></li>
<li><span class="koboSpan" id="kobo.26.1">Creating </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">user roles</span></span></li>
</ul>
<h1 id="_idParaDest-222"><a id="_idTextAnchor417"/><span class="koboSpan" id="kobo.28.1">Creating a simple CRUD interface</span></h1>
<p><strong class="bold"><a id="_idTextAnchor418"/><span class="koboSpan" id="kobo.29.1">CRUD</span></strong><span class="koboSpan" id="kobo.30.1"> refers to </span><strong class="bold"><span class="koboSpan" id="kobo.31.1">Create, Read, Update, and Delete</span></strong><span class="koboSpan" id="kobo.32.1">. </span><span class="koboSpan" id="kobo.32.2">A basic </span><a id="_idIndexMarker324"/><span class="koboSpan" id="kobo.33.1">necessity </span><a id="_idIndexMarker325"/><span class="koboSpan" id="kobo.34.1">of an admin interface is to have the ability to create, modify, or delete the records/resources from the application as and when needed. </span><span class="koboSpan" id="kobo.34.2">We will create a simple admin interface that will allow admin users to perform these operations on the records that other normal users </span><span class="No-Break"><span class="koboSpan" id="kobo.35.1">generally can’t</span><a id="_idTextAnchor419"/><span class="koboSpan" id="kobo.36.1">.</span></span></p>
<h2 id="_idParaDest-223"><a id="_idTextAnchor420"/><span class="koboSpan" id="kobo.37.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.38.1">We will start with the authentication application from the </span><em class="italic"><span class="koboSpan" id="kobo.39.1">Authenticating using the Flask-Login extension</span></em><span class="koboSpan" id="kobo.40.1"> recipe in </span><a href="B19111_06.xhtml#_idTextAnchor328"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.41.1">Chapter 6</span></em></span></a><span class="koboSpan" id="kobo.42.1">, </span><em class="italic"><span class="koboSpan" id="kobo.43.1">Authenticating in Flask</span></em><span class="koboSpan" id="kobo.44.1">, and add admin authentication with an interface for admins, which would allow only the admin users to create, update, and delete user records. </span><span class="koboSpan" id="kobo.44.2">Here, in this recipe, I will cover some specific parts that are necessary to understand the concepts. </span><span class="koboSpan" id="kobo.44.3">For the complete application, you can refer to the code samples available for </span><span class="No-Break"><span class="koboSpan" id="kobo.45.1">the book</span><a id="_idTextAnchor421"/><span class="koboSpan" id="kobo.46.1">.</span></span></p>
<h2 id="_idParaDest-224"><a id="_idTextAnchor422"/><span class="koboSpan" id="kobo.47.1">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.48.1">To create a simple admin interface, perform the </span><span class="No-Break"><span class="koboSpan" id="kobo.49.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.50.1">Start with the models by adding a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.51.1">BooleanField</span></strong><span class="koboSpan" id="kobo.52.1"> field called </span><strong class="source-inline"><span class="koboSpan" id="kobo.53.1">admin</span></strong><span class="koboSpan" id="kobo.54.1"> to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.55.1">User</span></strong><span class="koboSpan" id="kobo.56.1"> model in </span><strong class="source-inline"><span class="koboSpan" id="kobo.57.1">auth/models.py</span></strong><span class="koboSpan" id="kobo.58.1">. </span><span class="koboSpan" id="kobo.58.2">This field will help in identifying whether the user is an admin </span><span class="No-Break"><span class="koboSpan" id="kobo.59.1">or not:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.60.1">
from wtforms import BooleanField</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.61.1">
class User(db.Model):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.62.1">
    id = db.Column(db.Integer, primary_key=True)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.63.1">
    username = db.Column(db.String(100))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.64.1">
    pwdhash = db.Column(db.String())</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.65.1">
    admin = db.Column(db.Boolean())</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.66.1">
    def __init__(self, username, password,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.67.1">
      admin=False):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.68.1">
        self.username = username</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.69.1">
        self.pwdhash =</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.70.1">
          generate_password_hash(password)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.71.1">
        self.admin = admin</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.72.1">
    def is_admin(self):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.73.1">
        return self.admin</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.74.1">The preceding method simply returns the value of the admin field. </span><span class="koboSpan" id="kobo.74.2">This can have a custom implementation as per our requirements.</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.75.1">Tip</span></p>
<p class="callout"><span class="koboSpan" id="kobo.76.1">Since this is a new field being added to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.77.1">User</span></strong><span class="koboSpan" id="kobo.78.1"> model, database migration should be done. </span><span class="koboSpan" id="kobo.78.2">You can refer to the </span><em class="italic"><span class="koboSpan" id="kobo.79.1">Migrating databases using Alembic and Flask-Migrate</span></em><span class="koboSpan" id="kobo.80.1"> recipe in </span><a href="B19111_03.xhtml#_idTextAnchor129"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.81.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.82.1">, </span><em class="italic"><span class="koboSpan" id="kobo.83.1">Data Modeling in Flask</span></em><span class="koboSpan" id="kobo.84.1">, for </span><span class="No-Break"><span class="koboSpan" id="kobo.85.1">more details.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.86.1">Create two</span><a id="_idIndexMarker326"/><span class="koboSpan" id="kobo.87.1"> forms that will be used by the admin views </span><span class="No-Break"><span class="koboSpan" id="kobo.88.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.89.1">auth/models.py</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.90.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.91.1">
class AdminUserCreateForm(FlaskForm):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.92.1">
    username = StringField('Username',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.93.1">
      [InputRequired()])</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.94.1">
    password = PasswordField('Password',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.95.1">
      [InputRequired()])</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.96.1">
    admin = BooleanField('Is Admin ?')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.97.1">
class AdminUserUpdateForm(FlaskForm):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.98.1">
    username = StringField('Username',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.99.1">
      [InputRequired()])</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.100.1">
    admin = BooleanField('Is Admin ?')</span></pre></li>
<li><span class="koboSpan" id="kobo.101.1">Now, modify the views in </span><strong class="source-inline"><span class="koboSpan" id="kobo.102.1">auth/views.py</span></strong><span class="koboSpan" id="kobo.103.1"> to implement the </span><span class="No-Break"><span class="koboSpan" id="kobo.104.1">admin interface:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.105.1">
from functools import wraps</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.106.1">
from flask import abort</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.107.1">
from my_app.auth.models import AdminUserCreateForm,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.108.1">
  AdminUserUpdateForm</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.109.1">
def admin_login_required(func):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.110.1">
    @wraps(func)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.111.1">
    def decorated_view(*args, **kwargs):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.112.1">
        if not current_user.is_admin():</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.113.1">
            return abort(403)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.114.1">
        return func(*args, **kwargs)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.115.1">
    return decorated_view</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.116.1">The preceding </span><a id="_idIndexMarker327"/><span class="koboSpan" id="kobo.117.1">code is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.118.1">admin_login_required</span></strong><span class="koboSpan" id="kobo.119.1"> decorator, which works just like the </span><strong class="source-inline"><span class="koboSpan" id="kobo.120.1">login_required</span></strong><span class="koboSpan" id="kobo.121.1"> decorator. </span><span class="koboSpan" id="kobo.121.2">Here, the difference is that it needs to be implemented along with </span><strong class="source-inline"><span class="koboSpan" id="kobo.122.1">login_required</span></strong><span class="koboSpan" id="kobo.123.1">, and it checks whether the currently logged-in user is an admin.</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.124.1">Create the following handlers, which will be needed to create a simple admin interface. </span><span class="koboSpan" id="kobo.124.2">Note the usage of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.125.1">@admin_login_required</span></strong><span class="koboSpan" id="kobo.126.1"> decorator. </span><span class="koboSpan" id="kobo.126.2">Everything else is pretty much standard, as we learned in the previous chapters of this book that focused on views and authentication handling. </span><span class="koboSpan" id="kobo.126.3">All the handlers will go </span><span class="No-Break"><span class="koboSpan" id="kobo.127.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.128.1">auth/views.py</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.129.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.130.1">
@auth.route('/admin')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.131.1">
@login_required</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.132.1">
@admin_login_required</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.133.1">
def home_admin():</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.134.1">
    return render_template('admin-home.html')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.135.1">
@auth.route('/admin/users-list')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.136.1">
@login_required</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.137.1">
@admin_login_required</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.138.1">
def users_list_admin():</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.139.1">
    users = User.query.all()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.140.1">
    return render_template('users-list-admin.html',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.141.1">
      users=users)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.142.1">
@auth.route('/admin/create-user', methods=['GET',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.143.1">
  'POST'])</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.144.1">
@login_required</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.145.1">
@admin_login_required</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.146.1">
def user_create_admin():</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.147.1">
    form = AdminUserCreateForm()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.148.1">
    if form.validate_on_submit():</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.149.1">
        username = form.username.data</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.150.1">
        password = form.password.data</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.151.1">
        admin = form.admin.data</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.152.1">
        existing_username = User.query.filter_by</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.153.1">
          (username=username).first()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.154.1">
        if existing_username:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.155.1">
            flash(</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.156.1">
                'This username has been already taken.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.157.1">
                  Try another one.',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.158.1">
                'warning'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.159.1">
            )</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.160.1">
            return render_template('register.html',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.161.1">
              form=form)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.162.1">
        user = User(username, password, admin)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.163.1">
        db.session.add(user)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.164.1">
        db.session.commit()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.165.1">
        flash('New User Created.', 'info')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.166.1">
        return</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.167.1">
          redirect(url_for('auth.users_list_admin'))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.168.1">
    if form.errors:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.169.1">
        flash(form.errors, 'danger')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.170.1">
    return render_template('user-create-admin.html',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.171.1">
      form=form)</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.172.1">The preceding method allows admin users to create new users in the system. </span><span class="koboSpan" id="kobo.172.2">This works in a manner that is pretty similar to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.173.1">register()</span></strong><span class="koboSpan" id="kobo.174.1"> method but allows the admin to set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.175.1">admin</span></strong><span class="koboSpan" id="kobo.176.1"> flag on the user.</span></p>
<p><span class="koboSpan" id="kobo.177.1">The following </span><a id="_idIndexMarker328"/><span class="koboSpan" id="kobo.178.1">method allows the admin users to update the records of other users:</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.179.1">
@auth.route('/admin/update-user/&lt;id&gt;', methods=['GET', 'POST'])
@login_required
@admin_login_required
def user_update_admin(id):
    user = User.query.get(id)
    form = AdminUserUpdateForm(
        username=user.username,
        admin=user.admin
    )
    if form.validate_on_submit():
        username = form.username.data
        admin = form.admin.data
        User.query.filter_by(id=id).update({
            'username': username,
            'admin': admin,
        })
        db.session.commit()
        flash('User Updated.', 'info')
        return
          redirect(url_for('auth.users_list_admin'))
    if form.errors:
        flash(form.errors, 'danger')
    return render_template('user-update-admin.html', form=form, 
      user=user)</span></pre>
<p><span class="koboSpan" id="kobo.180.1">However, as per the best practices of writing web applications, we do not allow the admin to simply view and change the passwords of any user. </span><span class="koboSpan" id="kobo.180.2">In most cases, the provision to change passwords should rest with the user who owns the account. </span><span class="koboSpan" id="kobo.180.3">Although admins can have the provision to update the password in some cases, still, it should never be possible for them to see the passwords set by the user earlier. </span><span class="koboSpan" id="kobo.180.4">This </span><a id="_idIndexMarker329"/><span class="koboSpan" id="kobo.181.1">topic is discussed in the </span><em class="italic"><span class="koboSpan" id="kobo.182.1">Creating custom forms and actions</span></em><span class="koboSpan" id="kobo.183.1"> recipe.</span></p>
<p><span class="koboSpan" id="kobo.184.1">The following method handles the deletion of a user by an admin:</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.185.1">
@auth.route('/admin/delete-user/&lt;id&gt;')
@login_required
@admin_login_required
def user_delete_admin(id):
    user = User.query.get(id)
    db.session.delete(user)
    db.session.commit()
    flash('User Deleted.', 'info')
    return redirect(url_for('auth.users_list_admin'))</span></pre>
<p><span class="koboSpan" id="kobo.186.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.187.1">user_delete_admin()</span></strong><span class="koboSpan" id="kobo.188.1"> method should actually be implemented on a </span><strong class="source-inline"><span class="koboSpan" id="kobo.189.1">POST</span></strong><span class="koboSpan" id="kobo.190.1"> request. </span><span class="koboSpan" id="kobo.190.2">This is left to you to implement by yourself.</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.191.1">Followed by models and views, create some templates to complement them. </span><span class="koboSpan" id="kobo.191.2">It might have been evident to many of you from the code of the views itself that we need to add four new templates, namely, </span><strong class="source-inline"><span class="koboSpan" id="kobo.192.1">admin-home.html</span></strong><span class="koboSpan" id="kobo.193.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.194.1">user-create- admin.html</span></strong><span class="koboSpan" id="kobo.195.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.196.1">user-update-admin.html</span></strong><span class="koboSpan" id="kobo.197.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.198.1">users-list-admin.html</span></strong><span class="koboSpan" id="kobo.199.1">. </span><span class="koboSpan" id="kobo.199.2">How these work is shown in the next section. </span><span class="koboSpan" id="kobo.199.3">You should now be able to implement these templates by yourself; however, for reference, the code is always available with the samples provided with </span><span class="No-Break"><span class="koboSpan" id="kobo.200.1">the </span><a id="_idTextAnchor423"/><span class="koboSpan" id="kobo.201.1">book.</span></span></li>
</ol>
<h2 id="_idParaDest-225"><a id="_idTextAnchor424"/><span class="koboSpan" id="kobo.202.1">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.203.1">To begin, we added a menu item to the application; this provides a direct link to the admin home page, which will look like the </span><span class="No-Break"><span class="koboSpan" id="kobo.204.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer051">
<span class="koboSpan" id="kobo.205.1"><img alt="Figure 8.1 – Menu item for admin access" src="image/B19111_08_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.206.1">Figure 8.1 – Menu item for admin access</span></p>
<p><span class="koboSpan" id="kobo.207.1">A user must be </span><a id="_idIndexMarker330"/><span class="koboSpan" id="kobo.208.1">logged in as the admin to access this page and other admin-related pages. </span><span class="koboSpan" id="kobo.208.2">If a user is not logged in as the admin, then the application will show an error, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.209.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer052">
<span class="koboSpan" id="kobo.210.1"><img alt="Figure 8.2 – Forbidden error for non-admin users" src="image/B19111_08_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.211.1">Figure 8.2 – Forbidden error for non-admin users</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.212.1">Information</span></p>
<p class="callout"><span class="koboSpan" id="kobo.213.1">Create an admin user before you can log in as the admin. </span><span class="koboSpan" id="kobo.213.2">To create an admin user, you can make DB changes in SQLAlchemy from the command line using SQL queries. </span><span class="koboSpan" id="kobo.213.3">Another simpler but hacky way of doing this is to change the </span><strong class="source-inline"><span class="koboSpan" id="kobo.214.1">admin</span></strong><span class="koboSpan" id="kobo.215.1"> flag to </span><strong class="source-inline"><span class="koboSpan" id="kobo.216.1">True</span></strong><span class="koboSpan" id="kobo.217.1"> in </span><strong class="source-inline"><span class="koboSpan" id="kobo.218.1">auth/models.py</span></strong><span class="koboSpan" id="kobo.219.1"> and then register a new user. </span><span class="koboSpan" id="kobo.219.2">This new user will be an admin user. </span><span class="koboSpan" id="kobo.219.3">Make sure that you revert the </span><strong class="source-inline"><span class="koboSpan" id="kobo.220.1">admin</span></strong><span class="koboSpan" id="kobo.221.1"> flag to </span><strong class="source-inline"><span class="koboSpan" id="kobo.222.1">False</span></strong><span class="koboSpan" id="kobo.223.1"> as the default after this </span><span class="No-Break"><span class="koboSpan" id="kobo.224.1">is done.</span></span></p>
<p><span class="koboSpan" id="kobo.225.1">To a logged-in admin user, the admin home page will look </span><span class="No-Break"><span class="koboSpan" id="kobo.226.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer053">
<span class="koboSpan" id="kobo.227.1"><img alt="Figure 8.3 – Admin home page" src="image/B19111_08_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.228.1">Figure 8.3 – Admin home page</span></p>
<p><span class="koboSpan" id="kobo.229.1">From here, the </span><a id="_idIndexMarker331"/><span class="koboSpan" id="kobo.230.1">admin can see the list of users on a system or create a new user. </span><span class="koboSpan" id="kobo.230.2">The options to edit or delete the users will be available on the user list </span><span class="No-Break"><span class="koboSpan" id="kobo.231.1">page its</span><a id="_idTextAnchor425"/><span class="koboSpan" id="kobo.232.1">elf.</span></span></p>
<h1 id="_idParaDest-226"><a id="_idTextAnchor426"/><span class="koboSpan" id="kobo.233.1">Using the Flask-Admin extension</span></h1>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.234.1">Flask-Admin</span></strong><span class="koboSpan" id="kobo.235.1"> is an </span><a id="_idIndexMarker332"/><span class="koboSpan" id="kobo.236.1">available extension that helps in the creation of admin interfaces for our application in a simpler and faster way. </span><span class="koboSpan" id="kobo.236.2">All the subsequent recipes in this chapter will focus on using and extending </span><span class="No-Break"><span class="koboSpan" id="kobo.237.1">this exten</span><a id="_idTextAnchor427"/><span class="koboSpan" id="kobo.238.1">sion.</span></span></p>
<h2 id="_idParaDest-227"><a id="_idTextAnchor428"/><span class="koboSpan" id="kobo.239.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.240.1">First, we need to install the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.241.1">Flask-Admin</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.242.1"> extension:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.243.1">
$ pip install Flask-Admin</span></pre>
<p><span class="koboSpan" id="kobo.244.1">We will extend our application from the previous recipe and keep building on </span><span class="No-Break"><span class="koboSpan" id="kobo.245.1">the </span><a id="_idTextAnchor429"/><span class="koboSpan" id="kobo.246.1">same.</span></span></p>
<h2 id="_idParaDest-228"><a id="_idTextAnchor430"/><span class="koboSpan" id="kobo.247.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.248.1">Adding a simple admin interface to any Flask application using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.249.1">Flask-Admin</span></strong><span class="koboSpan" id="kobo.250.1"> extension is just a matter of a couple </span><span class="No-Break"><span class="koboSpan" id="kobo.251.1">of statements.</span></span></p>
<p><span class="koboSpan" id="kobo.252.1">Simply add the following lines to the application’s configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.253.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.254.1">my_app/__init__.py</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.255.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.256.1">
from flask_admin import Admin
app = Flask(__name__)
# Add any other application configurations
admin = Admin(app)</span></pre>
<p><span class="koboSpan" id="kobo.257.1">You can also add</span><a id="_idIndexMarker333"/><span class="koboSpan" id="kobo.258.1"> your own views to this; this is as simple as adding a new class as a new view that inherits from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.259.1">BaseView</span></strong><span class="koboSpan" id="kobo.260.1"> class, as shown in the following code block. </span><span class="koboSpan" id="kobo.260.2">This code block goes </span><span class="No-Break"><span class="koboSpan" id="kobo.261.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.262.1">auth/views.py</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.263.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.264.1">
from flask_admin import BaseView, expose
class HelloView(BaseView):
    @expose('/')
    def index(self):
        return self.render('some-template.html')</span></pre>
<p><span class="koboSpan" id="kobo.265.1">After this, add this view to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.266.1">admin</span></strong><span class="koboSpan" id="kobo.267.1"> object in the Flask configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.268.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.269.1">my_app/__init__.py</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.270.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.271.1">
import my_app.auth.views as views
admin.add_view(views.HelloView(name='Hello'))</span></pre>
<p><span class="koboSpan" id="kobo.272.1">One thing to notice here is that this page does not have any authentication or authorization logic implemented by default, and it will be accessible to all. </span><span class="koboSpan" id="kobo.272.2">The reason for this is that </span><strong class="source-inline"><span class="koboSpan" id="kobo.273.1">Flask-Admin</span></strong><span class="koboSpan" id="kobo.274.1"> does not make any assumptions about the authentication system in place. </span><span class="koboSpan" id="kobo.274.2">As we are using </span><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">Flask-Login</span></strong><span class="koboSpan" id="kobo.276.1"> for our applications, you can add a method named </span><strong class="source-inline"><span class="koboSpan" id="kobo.277.1">is_accessible()</span></strong><span class="koboSpan" id="kobo.278.1"> to your </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.279.1">HelloView</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.280.1"> class:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.281.1">
    def is_accessible(self):
        return current_user.is_authenticated and \
            current_user.is_a</span><a id="_idTextAnchor431"/><span class="koboSpan" id="kobo.282.1">dmin()</span></pre>
<h2 id="_idParaDest-229"><a id="_idTextAnchor432"/><span class="koboSpan" id="kobo.283.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.284.1">Just initializing an application with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.285.1">Admin</span></strong><span class="koboSpan" id="kobo.286.1"> class from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.287.1">Flask-Admin extension</span></strong><span class="koboSpan" id="kobo.288.1">, as </span><a id="_idIndexMarker334"/><span class="koboSpan" id="kobo.289.1">demonstrated in the first step of this recipe, will put up a basic admin page, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.290.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer054">
<span class="koboSpan" id="kobo.291.1"><img alt="Figure 8.4 – Admin home page using Flask-Admin" src="image/B19111_08_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.292.1">Figure 8.4 – Admin home page using Flask-Admin</span></p>
<p><span class="koboSpan" id="kobo.293.1">Notice the URL in the screenshot, which is </span><strong class="source-inline"><span class="koboSpan" id="kobo.294.1">http://127.0.0.1:5000/admin/</span></strong><span class="koboSpan" id="kobo.295.1">. </span><span class="koboSpan" id="kobo.295.2">Pay special attention to the forward slash (</span><strong class="source-inline"><span class="koboSpan" id="kobo.296.1">/</span></strong><span class="koboSpan" id="kobo.297.1">) at the end of the URL. </span><span class="koboSpan" id="kobo.297.2">If you miss that forward slash, then it would open the web page from the </span><span class="No-Break"><span class="koboSpan" id="kobo.298.1">last recipe.</span></span></p>
<p><span class="koboSpan" id="kobo.299.1">The addition of the custom </span><strong class="source-inline"><span class="koboSpan" id="kobo.300.1">HelloView</span></strong><span class="koboSpan" id="kobo.301.1"> in the second step will make the admin page look like the </span><span class="No-Break"><span class="koboSpan" id="kobo.302.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer055">
<span class="koboSpan" id="kobo.303.1"><img alt="Figure 8.5 – Adding a dummy Hello﻿ view" src="image/B19111_08_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.304.1">Figure 8.5 – Adding a dummy Hello</span><a id="_idTextAnchor433"/><span class="koboSpan" id="kobo.305.1"> view</span></p>
<h2 id="_idParaDest-230"><a id="_idTextAnchor434"/><span class="koboSpan" id="kobo.306.1">There’s more…</span></h2>
<p><span class="koboSpan" id="kobo.307.1">After implementing the preceding code, there is still an admin view that won’t be completely user-protected and will be publicly available. </span><span class="koboSpan" id="kobo.307.2">This will be the admin home page. </span><span class="koboSpan" id="kobo.307.3">To make this available only to the admins, we have to inherit from </span><strong class="source-inline"><span class="koboSpan" id="kobo.308.1">AdminIndexView</span></strong><span class="koboSpan" id="kobo.309.1"> and </span><span class="No-Break"><span class="koboSpan" id="kobo.310.1">implement </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.311.1">is_accessible()</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.312.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.313.1">
from flask_admin import BaseView, expose, AdminIndexView
class MyAdminIndexView(AdminIndexView):
    def is_accessible(self):
        return current_user.is_authenticated and
          current_user.is_admin()</span></pre>
<p><span class="koboSpan" id="kobo.314.1">Then, just pass this view to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.315.1">admin</span></strong><span class="koboSpan" id="kobo.316.1"> object in the application’s configuration as </span><strong class="source-inline"><span class="koboSpan" id="kobo.317.1">index_view</span></strong><span class="koboSpan" id="kobo.318.1">, and we </span><span class="No-Break"><span class="koboSpan" id="kobo.319.1">are done:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.320.1">
admin = Admin(app, index_view=views.MyAdminIndexView())</span></pre>
<p><span class="koboSpan" id="kobo.321.1">This approach makes</span><a id="_idIndexMarker335"/><span class="koboSpan" id="kobo.322.1"> all our admin views accessible only to the admin users. </span><span class="koboSpan" id="kobo.322.2">We can also implement any permission or conditional access rules in </span><strong class="source-inline"><span class="koboSpan" id="kobo.323.1">is_accessible()</span></strong><span class="koboSpan" id="kobo.324.1"> as and </span><span class="No-Break"><span class="koboSpan" id="kobo.325.1">when req</span><a id="_idTextAnchor435"/><span class="koboSpan" id="kobo.326.1">uired.</span></span></p>
<h1 id="_idParaDest-231"><a id="_idTextAnchor436"/><span class="koboSpan" id="kobo.327.1">Registering models with Flask-Admin</span></h1>
<p><span class="koboSpan" id="kobo.328.1">In the</span><a id="_idIndexMarker336"/><span class="koboSpan" id="kobo.329.1"> previous </span><a id="_idIndexMarker337"/><span class="koboSpan" id="kobo.330.1">recipe, we learned how to get started with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.331.1">Flask-Admin</span></strong><span class="koboSpan" id="kobo.332.1"> extension to create admin interfaces/views for our application. </span><span class="koboSpan" id="kobo.332.2">In this recipe, we will examine how to implement admin views for our existing models with the facilities to perform </span><span class="No-Break"><span class="koboSpan" id="kobo.333.1">CRUD ope</span><a id="_idTextAnchor437"/><span class="koboSpan" id="kobo.334.1">rations.</span></span></p>
<h2 id="_idParaDest-232"><a id="_idTextAnchor438"/><span class="koboSpan" id="kobo.335.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.336.1">We will extend our application from the previous recipe to include an admin interface for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.337.1">Use</span><a id="_idTextAnchor439"/><span class="koboSpan" id="kobo.338.1">r</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.339.1"> model.</span></span></p>
<h2 id="_idParaDest-233"><a id="_idTextAnchor440"/><span class="koboSpan" id="kobo.340.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.341.1">Again, with </span><strong class="source-inline"><span class="koboSpan" id="kobo.342.1">Flask-Admin</span></strong><span class="koboSpan" id="kobo.343.1">, registering a model with the admin interface is very easy; perform the </span><span class="No-Break"><span class="koboSpan" id="kobo.344.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.345.1">Just add the following single line of code </span><span class="No-Break"><span class="koboSpan" id="kobo.346.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.347.1">auth/views.py</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.348.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.349.1">
from flask_admin.contrib.sqla import ModelView</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.350.1">
# Other admin configuration as shown in last recipe</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.351.1">
admin.add_view(ModelView(views.User, db.session))</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.352.1">Here, in the first line, we imported </span><strong class="source-inline"><span class="koboSpan" id="kobo.353.1">ModelView</span></strong><span class="koboSpan" id="kobo.354.1"> from </span><strong class="source-inline"><span class="koboSpan" id="kobo.355.1">flask_admin.contrib.sqla</span></strong><span class="koboSpan" id="kobo.356.1">, which is provided by </span><strong class="source-inline"><span class="koboSpan" id="kobo.357.1">Flask-Admin</span></strong><span class="koboSpan" id="kobo.358.1"> to integrate SQLAlchemy models.</span></p>
<p><span class="koboSpan" id="kobo.359.1">Looking at the screenshot corresponding to the first step in the </span><em class="italic"><span class="koboSpan" id="kobo.360.1">How it works…</span></em><span class="koboSpan" id="kobo.361.1"> section of </span><a id="_idIndexMarker338"/><span class="koboSpan" id="kobo.362.1">this </span><a id="_idIndexMarker339"/><span class="koboSpan" id="kobo.363.1">recipe (</span><em class="italic"><span class="koboSpan" id="kobo.364.1">Figure 8.6</span></em><span class="koboSpan" id="kobo.365.1">), most of us will agree that showing the password hash to any user, be they an admin or a normal user, does not make sense. </span><span class="koboSpan" id="kobo.365.2">Additionally, the default model-creation mechanism provided by </span><strong class="source-inline"><span class="koboSpan" id="kobo.366.1">Flask-Admin</span></strong><span class="koboSpan" id="kobo.367.1"> will fail for our </span><strong class="source-inline"><span class="koboSpan" id="kobo.368.1">User</span></strong><span class="koboSpan" id="kobo.369.1"> creation, because we have an </span><strong class="source-inline"><span class="koboSpan" id="kobo.370.1">__init__()</span></strong><span class="koboSpan" id="kobo.371.1"> method in our </span><strong class="source-inline"><span class="koboSpan" id="kobo.372.1">User</span></strong><span class="koboSpan" id="kobo.373.1"> model. </span><span class="koboSpan" id="kobo.373.2">This method expects values for the three fields (</span><strong class="source-inline"><span class="koboSpan" id="kobo.374.1">username</span></strong><span class="koboSpan" id="kobo.375.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.376.1">password</span></strong><span class="koboSpan" id="kobo.377.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.378.1">is_admin</span></strong><span class="koboSpan" id="kobo.379.1">), while the model-creation logic implemented in </span><strong class="source-inline"><span class="koboSpan" id="kobo.380.1">Flask-Admin</span></strong><span class="koboSpan" id="kobo.381.1"> is very generic and does not provide any value during model creation.</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.382.1">Now, customize the default behavior of </span><strong class="source-inline"><span class="koboSpan" id="kobo.383.1">Flask-Admin</span></strong><span class="koboSpan" id="kobo.384.1"> to something of your own, where you fix the </span><strong class="source-inline"><span class="koboSpan" id="kobo.385.1">User</span></strong><span class="koboSpan" id="kobo.386.1"> creation mechanism and hide the password hash from view </span><span class="No-Break"><span class="koboSpan" id="kobo.387.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.388.1">auth/views.py</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.389.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.390.1">
from wtforms import PasswordField</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.391.1">
from flask_admin.contrib.sqla import ModelView</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.392.1">
class UserAdminView(ModelView):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.393.1">
    column_searchable_list = ('username',)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.394.1">
    column_sortable_list = ('username', 'admin')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.395.1">
    column_exclude_list = ('pwdhash',)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.396.1">
    form_excluded_columns = ('pwdhash',)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.397.1">
    form_edit_rules = ('username', 'admin')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.398.1">
    def is_accessible(self):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.399.1">
        return current_user.is_authenticated and</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.400.1">
          current_user.is_admin()</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.401.1">The preceding code shows some rules and settings that our admin view for </span><strong class="source-inline"><span class="koboSpan" id="kobo.402.1">User</span></strong><span class="koboSpan" id="kobo.403.1"> will follow. </span><span class="koboSpan" id="kobo.403.2">These are self-explanatory via their names. </span><span class="koboSpan" id="kobo.403.3">A couple of them, </span><strong class="source-inline"><span class="koboSpan" id="kobo.404.1">column_exclude_list</span></strong><span class="koboSpan" id="kobo.405.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.406.1">form_excluded_columns</span></strong><span class="koboSpan" id="kobo.407.1">, might appear to be slightly confusing. </span><span class="koboSpan" id="kobo.407.2">The former will exclude the columns mentioned from the admin view itself and refrain from using them in search, creation, and other CRUD </span><a id="_idIndexMarker340"/><span class="koboSpan" id="kobo.408.1">operations. </span><span class="koboSpan" id="kobo.408.2">The </span><a id="_idIndexMarker341"/><span class="koboSpan" id="kobo.409.1">latter will prevent the field from being shown on the form for CRUD operations.</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.410.1">Create a method in </span><strong class="source-inline"><span class="koboSpan" id="kobo.411.1">auth/views.py</span></strong><span class="koboSpan" id="kobo.412.1"> that overrides the creation of the form from the model and adds a </span><strong class="source-inline"><span class="koboSpan" id="kobo.413.1">password</span></strong><span class="koboSpan" id="kobo.414.1"> field, which will be used in place of the </span><span class="No-Break"><span class="koboSpan" id="kobo.415.1">password hash:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.416.1">
    def scaffold_form(self):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.417.1">
        form_class = super(UserAdminView,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.418.1">
          self).scaffold_form()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.419.1">
        form_class.password =</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.420.1">
          PasswordField('Password')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.421.1">
        return form_class</span></pre></li>
<li><span class="koboSpan" id="kobo.422.1">Then, override the model-creation logic in </span><strong class="source-inline"><span class="koboSpan" id="kobo.423.1">auth/views.py</span></strong><span class="koboSpan" id="kobo.424.1"> to suit </span><span class="No-Break"><span class="koboSpan" id="kobo.425.1">the application:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.426.1">
    def create_model(self, form):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.427.1">
        model = self.model(</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.428.1">
            form.username.data, form.password.data,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.429.1">
              form.admin.data</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.430.1">
        )</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.431.1">
        form.populate_obj(model)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.432.1">
        self.session.add(model)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.433.1">
        self._on_model_change(form, model, True)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.434.1">
        self.session.commit()</span></pre></li>
<li><span class="koboSpan" id="kobo.435.1">Finally, add this model to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.436.1">admin</span></strong><span class="koboSpan" id="kobo.437.1"> object in the application config in </span><strong class="source-inline"><span class="koboSpan" id="kobo.438.1">my_app/__init__.py</span></strong><span class="koboSpan" id="kobo.439.1"> by writing </span><span class="No-Break"><span class="koboSpan" id="kobo.440.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.441.1">
admin.add_view(views.UserAdminView(views.User,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.442.1">
  db.session))</span></pre></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.443.1">Information</span></p>
<p class="callout"><span class="koboSpan" id="kobo.444.1">Notice the </span><strong class="source-inline"><span class="koboSpan" id="kobo.445.1">self._on_model_change(form, model, True)</span></strong><span class="koboSpan" id="kobo.446.1"> statement. </span><span class="koboSpan" id="kobo.446.2">Here, the last parameter, </span><strong class="source-inline"><span class="koboSpan" id="kobo.447.1">True</span></strong><span class="koboSpan" id="kobo.448.1">, signifies that the call is for the creation of a</span><a id="_idTextAnchor441"/> <span class="No-Break"><span class="koboSpan" id="kobo.449.1">new record.</span></span></p>
<h2 id="_idParaDest-234"><a id="_idTextAnchor442"/><span class="koboSpan" id="kobo.450.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.451.1">The first step will create</span><a id="_idIndexMarker342"/><span class="koboSpan" id="kobo.452.1"> a </span><a id="_idIndexMarker343"/><span class="koboSpan" id="kobo.453.1">new admin view for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.454.1">User</span></strong><span class="koboSpan" id="kobo.455.1"> model, which will look like the </span><span class="No-Break"><span class="koboSpan" id="kobo.456.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer056">
<span class="koboSpan" id="kobo.457.1"><img alt="Figure 8.6 – List of users without custom logic" src="image/B19111_08_06.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.458.1">Figure 8.6 – List of users without custom logic</span></p>
<p><span class="koboSpan" id="kobo.459.1">After all the steps have been followed, the admin interface for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.460.1">User</span></strong><span class="koboSpan" id="kobo.461.1"> model will look like the </span><span class="No-Break"><span class="koboSpan" id="kobo.462.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer057">
<span class="koboSpan" id="kobo.463.1"><img alt="Figure 8.7 – List of users with password hash hidden" src="image/B19111_08_07.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.464.1">Figure 8.7 – List of users with password hash hidden</span></p>
<p><span class="koboSpan" id="kobo.465.1">We have a search box here, and no password hash is visible. </span><span class="koboSpan" id="kobo.465.2">There are changes to the user creation and</span><a id="_idIndexMarker344"/><span class="koboSpan" id="kobo.466.1"> edit</span><a id="_idIndexMarker345"/><span class="koboSpan" id="kobo.467.1"> views too. </span><span class="koboSpan" id="kobo.467.2">I recommend that you run the application to see this</span><a id="_idTextAnchor443"/> <span class="No-Break"><span class="koboSpan" id="kobo.468.1">for yourself.</span></span></p>
<h1 id="_idParaDest-235"><a id="_idTextAnchor444"/><span class="koboSpan" id="kobo.469.1">Creating custom forms and actions</span></h1>
<p><span class="koboSpan" id="kobo.470.1">In this recipe, we will </span><a id="_idIndexMarker346"/><span class="koboSpan" id="kobo.471.1">create a</span><a id="_idIndexMarker347"/><span class="koboSpan" id="kobo.472.1"> custom form using the forms provided by </span><strong class="source-inline"><span class="koboSpan" id="kobo.473.1">Flask-Admin</span></strong><span class="koboSpan" id="kobo.474.1">. </span><span class="koboSpan" id="kobo.474.2">Additionally, we will create a custom action using </span><a id="_idTextAnchor445"/><span class="koboSpan" id="kobo.475.1">the </span><span class="No-Break"><span class="koboSpan" id="kobo.476.1">custom form.</span></span></p>
<h2 id="_idParaDest-236"><a id="_idTextAnchor446"/><span class="koboSpan" id="kobo.477.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.478.1">In the previous recipe, we saw that the edit form view for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.479.1">User</span></strong><span class="koboSpan" id="kobo.480.1"> record update had no option to update the password for the user. </span><span class="koboSpan" id="kobo.480.2">The form looked like the </span><span class="No-Break"><span class="koboSpan" id="kobo.481.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer058">
<span class="koboSpan" id="kobo.482.1"><img alt="Figure 8.8 – ﻿Built-in user edit form" src="image/B19111_08_08.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.483.1">Figure 8.8 – Built-in user edit form</span></p>
<p><span class="koboSpan" id="kobo.484.1">In this recipe, we will customize this form to allow administrators to update the passwor</span><a id="_idTextAnchor447"/><span class="koboSpan" id="kobo.485.1">d for </span><span class="No-Break"><span class="koboSpan" id="kobo.486.1">any user.</span></span></p>
<h2 id="_idParaDest-237"><a id="_idTextAnchor448"/><span class="koboSpan" id="kobo.487.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.488.1">The implementation of this feature will only require changes </span><span class="No-Break"><span class="koboSpan" id="kobo.489.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.490.1">views.py</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.491.1">:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.492.1">First, start</span><a id="_idIndexMarker348"/><span class="koboSpan" id="kobo.493.1"> by </span><a id="_idIndexMarker349"/><span class="koboSpan" id="kobo.494.1">importing </span><strong class="source-inline"><span class="koboSpan" id="kobo.495.1">rules</span></strong><span class="koboSpan" id="kobo.496.1"> from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.497.1">Flask-Admin</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.498.1"> form:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.499.1">
from flask_admin.form import rules</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.500.1">In the previous recipe, we had </span><strong class="source-inline"><span class="koboSpan" id="kobo.501.1">form_edit_rules</span></strong><span class="koboSpan" id="kobo.502.1">, which had just two fields – that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.503.1">username</span></strong><span class="koboSpan" id="kobo.504.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.505.1">admin</span></strong><span class="koboSpan" id="kobo.506.1"> – as a list. </span><span class="koboSpan" id="kobo.506.2">This denoted the fields that will be available for editing to the admin user in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.507.1">User</span></strong><span class="koboSpan" id="kobo.508.1"> model’s update view.</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.509.1">Updating the password is not simply a case of just adding one more field to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.510.1">form_edit_rules</span></strong><span class="koboSpan" id="kobo.511.1"> list; this is because we do not store cleartext passwords. </span><span class="koboSpan" id="kobo.511.2">Instead, we store password hashes that cannot be edited directly by users. </span><span class="koboSpan" id="kobo.511.3">We need to input the password from the user and then convert it to a hash while storing. </span><span class="koboSpan" id="kobo.511.4">Take a look at how to do this in the </span><span class="No-Break"><span class="koboSpan" id="kobo.512.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.513.1">
form_edit_rules = (</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.514.1">
        'username', 'admin',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.515.1">
        rules.Header('Reset Password'),</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.516.1">
        'new_password', 'confirm'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.517.1">
    )</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.518.1">
    form_create_rules = (</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.519.1">
        'username', 'admin', 'notes', 'password'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.520.1">
    )</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.521.1">The preceding piece of code signifies that we now have a header in our form; this header separates the password reset section from the rest of the section. </span><span class="koboSpan" id="kobo.521.2">Then, add two new fields, </span><strong class="source-inline"><span class="koboSpan" id="kobo.522.1">new_password</span></strong><span class="koboSpan" id="kobo.523.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.524.1">confirm</span></strong><span class="koboSpan" id="kobo.525.1">, which will help us safely change the password.</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.526.1">This also calls for a change to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.527.1">scaffold_form()</span></strong><span class="koboSpan" id="kobo.528.1"> method so that the two new fields </span><a id="_idIndexMarker350"/><span class="koboSpan" id="kobo.529.1">become</span><a id="_idIndexMarker351"/><span class="koboSpan" id="kobo.530.1"> valid while </span><span class="No-Break"><span class="koboSpan" id="kobo.531.1">form rendering:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.532.1">
    def scaffold_form(self):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.533.1">
        form_class = super(UserAdminView,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.534.1">
          self).scaffold_form()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.535.1">
        form_class.password =</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.536.1">
          PasswordField('Password')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.537.1">
        form_class.new_password = PasswordField('New</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.538.1">
          Password')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.539.1">
        form_class.confirm = PasswordField('Confirm</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.540.1">
          New Password')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.541.1">
        return form_class</span></pre></li>
<li><span class="koboSpan" id="kobo.542.1">Finally, implement the </span><strong class="source-inline"><span class="koboSpan" id="kobo.543.1">update_model()</span></strong><span class="koboSpan" id="kobo.544.1"> method, which is called when we try to update </span><span class="No-Break"><span class="koboSpan" id="kobo.545.1">the record:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.546.1">
    def update_model(self, form, model):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.547.1">
        form.populate_obj(model)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.548.1">
        if form.new_password.data:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.549.1">
            if form.new_password.data !=</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.550.1">
              form.confirm.data:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.551.1">
                flash('Passwords must match')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.552.1">
                return</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.553.1">
            model.pwdhash = generate_password_hash(</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.554.1">
                form.new_password.data)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.555.1">
        self.session.add(model)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.556.1">
        self._on_model_change(form, model, False)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.557.1">
        self.session.commit()</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.558.1">In the preceding code, we will first make sure that the password entered in both fields is</span><a id="_idIndexMarker352"/><span class="koboSpan" id="kobo.559.1"> the</span><a id="_idIndexMarker353"/><span class="koboSpan" id="kobo.560.1"> same. </span><span class="koboSpan" id="kobo.560.2">If it is, then we will proceed with resetting the password, along w</span><a id="_idTextAnchor449"/><span class="koboSpan" id="kobo.561.1">ith any other change.</span></p>
<h2 id="_idParaDest-238"><a id="_idTextAnchor450"/><span class="koboSpan" id="kobo.562.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.563.1">The user update form will now look like the </span><span class="No-Break"><span class="koboSpan" id="kobo.564.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer059">
<span class="koboSpan" id="kobo.565.1"><img alt="Figure 8.9 – Custom form with a custom action" src="image/B19111_08_09.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.566.1">Figure 8.9 – Custom form with a custom action</span></p>
<p><span class="koboSpan" id="kobo.567.1">Here, if we enter </span><a id="_idIndexMarker354"/><span class="koboSpan" id="kobo.568.1">the</span><a id="_idIndexMarker355"/><span class="koboSpan" id="kobo.569.1"> same password in both of the password fields, the user pas</span><a id="_idTextAnchor451"/><span class="koboSpan" id="kobo.570.1">sword will </span><span class="No-Break"><span class="koboSpan" id="kobo.571.1">be updated.</span></span></p>
<h1 id="_idParaDest-239"><a id="_idTextAnchor452"/><span class="koboSpan" id="kobo.572.1">Using a WYSIWYG editor for textarea integration</span></h1>
<p><span class="koboSpan" id="kobo.573.1">As users of websites, we</span><a id="_idIndexMarker356"/><span class="koboSpan" id="kobo.574.1"> all know that writing </span><a id="_idIndexMarker357"/><span class="koboSpan" id="kobo.575.1">beautifully formatted text using the normal </span><strong class="source-inline"><span class="koboSpan" id="kobo.576.1">textarea</span></strong><span class="koboSpan" id="kobo.577.1"> fields is a nightmare. </span><span class="koboSpan" id="kobo.577.2">There are plugins that make our life easier and turn simple </span><strong class="source-inline"><span class="koboSpan" id="kobo.578.1">textarea</span></strong><span class="koboSpan" id="kobo.579.1"> fields</span><a id="_idIndexMarker358"/><span class="koboSpan" id="kobo.580.1"> into </span><strong class="bold"><span class="koboSpan" id="kobo.581.1">What You See Is What You Get</span></strong><span class="koboSpan" id="kobo.582.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.583.1">WYSIWYG</span></strong><span class="koboSpan" id="kobo.584.1">) editors. </span><span class="koboSpan" id="kobo.584.2">One such editor is </span><strong class="bold"><span class="koboSpan" id="kobo.585.1">CKEditor</span></strong><span class="koboSpan" id="kobo.586.1">. </span><span class="koboSpan" id="kobo.586.2">It is </span><a id="_idIndexMarker359"/><span class="koboSpan" id="kobo.587.1">open source, provides good flexibility, and has a huge community for support. </span><span class="koboSpan" id="kobo.587.2">Additionally, it is customizable and allows users to build add-ons as needed. </span><span class="koboSpan" id="kobo.587.3">In this recipe, we will understand how CKEditor can be leveraged to build </span><a id="_idTextAnchor453"/><span class="koboSpan" id="kobo.588.1">beautiful </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.589.1">textarea</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.590.1"> fields.</span></span></p>
<h2 id="_idParaDest-240"><a id="_idTextAnchor454"/><span class="koboSpan" id="kobo.591.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.592.1">We start by adding a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.593.1">textarea</span></strong><span class="koboSpan" id="kobo.594.1"> field to our </span><strong class="source-inline"><span class="koboSpan" id="kobo.595.1">User</span></strong><span class="koboSpan" id="kobo.596.1"> model for notes and then integrate this field with CKEditor to write formatted text. </span><span class="koboSpan" id="kobo.596.2">This will include the addition of a JavaScript library and a CSS class to a normal </span><strong class="source-inline"><span class="koboSpan" id="kobo.597.1">textarea</span></strong><span class="koboSpan" id="kobo.598.1"> field to convert this into a CKEditor-</span><a id="_idTextAnchor455"/><span class="koboSpan" id="kobo.599.1">compatible </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.600.1">textarea</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.601.1"> field.</span></span></p>
<h2 id="_idParaDest-241"><a id="_idTextAnchor456"/><span class="koboSpan" id="kobo.602.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.603.1">To integrate CKEditor with your application, perform the </span><span class="No-Break"><span class="koboSpan" id="kobo.604.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.605.1">First, add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.606.1">notes</span></strong><span class="koboSpan" id="kobo.607.1"> field to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.608.1">User</span></strong><span class="koboSpan" id="kobo.609.1"> model in </span><strong class="source-inline"><span class="koboSpan" id="kobo.610.1">auth/models.py</span></strong><span class="koboSpan" id="kobo.611.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.612.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.613.1">
class User(db.Model):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.614.1">
    id = db.Column(db.Integer, primary_key=True)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.615.1">
    username = db.Column(db.String(100))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.616.1">
    pwdhash = db.Column(db.String())</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.617.1">
    admin = db.Column(db.Boolean())</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.618.1">
    notes = db.Column(db.UnicodeText)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.619.1">
    def __init__(self, username, password,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.620.1">
      admin=False, notes=''):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.621.1">
        self.username = username</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.622.1">
        self.pwdhash =</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.623.1">
          generate_password_hash(password)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.624.1">
        self.admin = admin</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.625.1">
        self.notes = notes</span></pre></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.626.1">Important</span></p>
<p class="callout"><span class="koboSpan" id="kobo.627.1">In order to add a new field, you might need to run migration scripts. </span><span class="koboSpan" id="kobo.627.2">You can refer to the </span><em class="italic"><span class="koboSpan" id="kobo.628.1">Migrating databases using Alembic and Flask-Migrate</span></em><span class="koboSpan" id="kobo.629.1"> recipe in </span><a href="B19111_03.xhtml#_idTextAnchor129"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.630.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.631.1">, </span><em class="italic"><span class="koboSpan" id="kobo.632.1">Data Modeling in Flask</span></em><span class="koboSpan" id="kobo.633.1">, for </span><span class="No-Break"><span class="koboSpan" id="kobo.634.1">more details.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.635.1">After this, create</span><a id="_idIndexMarker360"/><span class="koboSpan" id="kobo.636.1"> a custom </span><strong class="source-inline"><span class="koboSpan" id="kobo.637.1">wtform</span></strong><span class="koboSpan" id="kobo.638.1"> widget</span><a id="_idIndexMarker361"/><span class="koboSpan" id="kobo.639.1"> and a field for the CKEditor </span><strong class="source-inline"><span class="koboSpan" id="kobo.640.1">textarea</span></strong><span class="koboSpan" id="kobo.641.1"> field </span><span class="No-Break"><span class="koboSpan" id="kobo.642.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.643.1">auth/models.py</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.644.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.645.1">
from wtforms import widgets, TextAreaField</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.646.1">
class CKTextAreaWidget(widgets.TextArea):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.647.1">
    def __call__(self, field, **kwargs):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.648.1">
        kwargs.setdefault('class_', 'ckeditor')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.649.1">
        return super(CKTextAreaWidget,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.650.1">
          self).__call__(field, **kwargs)</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.651.1">In the custom widget in the preceding code, we added a </span><strong class="source-inline"><span class="koboSpan" id="kobo.652.1">ckeditor</span></strong><span class="koboSpan" id="kobo.653.1"> class to our </span><strong class="source-inline"><span class="koboSpan" id="kobo.654.1">TextArea</span></strong><span class="koboSpan" id="kobo.655.1"> widget. </span><span class="koboSpan" id="kobo.655.2">For more insights into the WTForms widgets, you can refer to the </span><em class="italic"><span class="koboSpan" id="kobo.656.1">Creating a custom widget</span></em><span class="koboSpan" id="kobo.657.1"> recipe in </span><a href="B19111_05.xhtml#_idTextAnchor273"><em class="italic"><span class="koboSpan" id="kobo.658.1">Chapter 5</span></em></a><span class="koboSpan" id="kobo.659.1">, </span><em class="italic"><span class="koboSpan" id="kobo.660.1">Web Forms </span></em><em class="italic"><span class="koboSpan" id="kobo.661.1">with WTForms</span></em><span class="koboSpan" id="kobo.662.1">.</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.663.1">Next, create a custom field that inherits </span><strong class="source-inline"><span class="koboSpan" id="kobo.664.1">TextAreaField</span></strong><span class="koboSpan" id="kobo.665.1"> and updates it to use the widget created in the </span><span class="No-Break"><span class="koboSpan" id="kobo.666.1">previous step:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.667.1">
class CKTextAreaField(TextAreaField):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.668.1">
    widget = CKTextAreaWidget()</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.669.1">In the custom field in the preceding code, we set the widget to </span><strong class="source-inline"><span class="koboSpan" id="kobo.670.1">CKTextAreaWidget</span></strong><span class="koboSpan" id="kobo.671.1">, and when this field will be rendered, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.672.1">ckeditor</span></strong><span class="koboSpan" id="kobo.673.1"> CSS class will be added to it.</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.674.1">Next, modify </span><strong class="source-inline"><span class="koboSpan" id="kobo.675.1">form_edit_rules</span></strong><span class="koboSpan" id="kobo.676.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.677.1">UserAdminView</span></strong><span class="koboSpan" id="kobo.678.1"> class in </span><strong class="source-inline"><span class="koboSpan" id="kobo.679.1">auth/views.py</span></strong><span class="koboSpan" id="kobo.680.1">, where we specify the template to be used for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.681.1">create</span></strong><span class="koboSpan" id="kobo.682.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.683.1">edit</span></strong><span class="koboSpan" id="kobo.684.1"> forms. </span><span class="koboSpan" id="kobo.684.2">Additionally, override</span><a id="_idIndexMarker362"/><span class="koboSpan" id="kobo.685.1"> the </span><a id="_idIndexMarker363"/><span class="koboSpan" id="kobo.686.1">normal </span><strong class="source-inline"><span class="koboSpan" id="kobo.687.1">TextAreaField</span></strong><span class="koboSpan" id="kobo.688.1"> object with </span><strong class="source-inline"><span class="koboSpan" id="kobo.689.1">CKTextAreaField</span></strong><span class="koboSpan" id="kobo.690.1"> for </span><strong class="source-inline"><span class="koboSpan" id="kobo.691.1">notes</span></strong><span class="koboSpan" id="kobo.692.1">. </span><span class="koboSpan" id="kobo.692.2">Make sure that you import </span><strong class="source-inline"><span class="koboSpan" id="kobo.693.1">CKTextAreaField</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.694.1">from </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.695.1">auth/models.py</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.696.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.697.1">
    form_overrides = dict(notes=CKTextAreaField)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.698.1">
    create_template = 'edit.html'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.699.1">
    edit_template = 'edit.html'</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.700.1">In the preceding code block, </span><strong class="source-inline"><span class="koboSpan" id="kobo.701.1">form_overrides</span></strong><span class="koboSpan" id="kobo.702.1"> enables the overriding of a normal </span><strong class="source-inline"><span class="koboSpan" id="kobo.703.1">textarea</span></strong><span class="koboSpan" id="kobo.704.1"> field with the CKEditor </span><strong class="source-inline"><span class="koboSpan" id="kobo.705.1">textarea</span></strong><span class="koboSpan" id="kobo.706.1"> field.</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.707.1">The final part of this recipe is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.708.1">templates/edit.html</span></strong><span class="koboSpan" id="kobo.709.1"> template, which was </span><span class="No-Break"><span class="koboSpan" id="kobo.710.1">mentioned earlier:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.711.1">
{% extends 'admin/model/edit.html' %}</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.712.1">
{% block tail %}</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.713.1">
    {{ super() }}</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.714.1">
    &lt;script src="https://cdn.ckeditor.com</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.715.1">
      /4.20.1/standard/ckeditor.js"&gt;&lt;/script&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.716.1">
{% endblock %}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.717.1">Here, we extend the default </span><strong class="source-inline"><span class="koboSpan" id="kobo.718.1">edit.html</span></strong><span class="koboSpan" id="kobo.719.1"> file provided by Flask-Admin and add the CKEditor JS file so that our </span><strong class="source-inline"><span class="koboSpan" id="kobo.720.1">ckeditor</span></strong><span class="koboSpan" id="kobo.721.1"> c</span><a id="_idTextAnchor457"/><span class="koboSpan" id="kobo.722.1">lass in </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.723.1">CKTextAreaField</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.724.1"> works.</span></span></p>
<h2 id="_idParaDest-242"><a id="_idTextAnchor458"/><span class="koboSpan" id="kobo.725.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.726.1">After we have</span><a id="_idIndexMarker364"/><span class="koboSpan" id="kobo.727.1"> made </span><a id="_idIndexMarker365"/><span class="koboSpan" id="kobo.728.1">all the changes, the create user form will look like the following screenshot; in particular, notice the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.729.1">Notes</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.730.1"> field:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer060">
<span class="koboSpan" id="kobo.731.1"><img alt="Figure 8.10 – Notes field created using a WYSIWYG editor" src="image/B19111_08_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.732.1">Figure 8.10 – Notes field created using a WYSIWYG editor</span></p>
<p><span class="koboSpan" id="kobo.733.1">Here, anything entered in the </span><strong class="bold"><span class="koboSpan" id="kobo.734.1">Notes</span></strong><span class="koboSpan" id="kobo.735.1"> field will be automatically formatted in HTML while saving and can be used anywh</span><a id="_idTextAnchor459"/><span class="koboSpan" id="kobo.736.1">ere later for </span><span class="No-Break"><span class="koboSpan" id="kobo.737.1">display purposes.</span></span></p>
<h2 id="_idParaDest-243"><a id="_idTextAnchor460"/><span class="koboSpan" id="kobo.738.1">See also</span></h2>
<p><span class="koboSpan" id="kobo.739.1">This recipe is inspired by the </span><strong class="bold"><span class="koboSpan" id="kobo.740.1">gist</span></strong><span class="koboSpan" id="kobo.741.1"> by the author of Flask-Admin. </span><span class="koboSpan" id="kobo.741.2">The gist can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.742.1">at </span></span><a href="https://gist.github.com/mrjoes/5189850"><span class="No-Break"><span class="koboSpan" id="kobo.743.1">https://gist.github.com/mrjoes/5189850</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.744.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.745.1">You can also choose to directly use the Flask-CKEditor extension, which can be found at </span><a href="https://flask-ckeditor.readthedocs.io/en/latest/"><span class="koboSpan" id="kobo.746.1">https://flask-ckeditor.readthedocs.io/en/latest/</span></a><span class="koboSpan" id="kobo.747.1">. </span><span class="koboSpan" id="kobo.747.2">I have not used the extension because I wanted</span><a id="_idIndexMarker366"/><span class="koboSpan" id="kobo.748.1"> to</span><a id="_idIndexMarker367"/><span class="koboSpan" id="kobo.749.1"> demonstrat</span><a id="_idTextAnchor461"/><span class="koboSpan" id="kobo.750.1">e the concept from a </span><span class="No-Break"><span class="koboSpan" id="kobo.751.1">lower level.</span></span></p>
<h1 id="_idParaDest-244"><a id="_idTextAnchor462"/><span class="koboSpan" id="kobo.752.1">Creating user roles</span></h1>
<p><span class="koboSpan" id="kobo.753.1">So far, we have</span><a id="_idIndexMarker368"/><span class="koboSpan" id="kobo.754.1"> discovered how a view that is accessible to a certain set of admin users can be created easily using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.755.1">is_accessible()</span></strong><span class="koboSpan" id="kobo.756.1"> method. </span><span class="koboSpan" id="kobo.756.2">This can be extended to have different kinds of scenarios, where specific users will be able to view specific views. </span><span class="koboSpan" id="kobo.756.3">There is another way of implementing user roles at a much more granular level in a model, where the roles determine whether a user can perform all, so</span><a id="_idTextAnchor463"/><span class="koboSpan" id="kobo.757.1">me, or any of the </span><span class="No-Break"><span class="koboSpan" id="kobo.758.1">CRUD operations.</span></span></p>
<h2 id="_idParaDest-245"><a id="_idTextAnchor464"/><span class="koboSpan" id="kobo.759.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.760.1">In this recipe, we will explore a basic way of creating user roles, where an admin user can only perform actions they are </span><span class="No-Break"><span class="koboSpan" id="kobo.761.1">entitled to.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.762.1">Information</span></p>
<p class="callout"><span class="koboSpan" id="kobo.763.1">Remember that this is just one way of implementing user roles. </span><span class="koboSpan" id="kobo.763.2">There are a number of better ways of doing this, but this one appears to be the best one to demonstrate the concept of creating user roles. </span><span class="koboSpan" id="kobo.763.3">One such method would be to create user groups and assign roles to the groups, rather than individual users. </span><span class="koboSpan" id="kobo.763.4">Another method can be the more complex policy-based user roles, which will include defining the roles according to complex business logic. </span><span class="koboSpan" id="kobo.763.5">This approach is usually employed by business s</span><a id="_idTextAnchor465"/><span class="koboSpan" id="kobo.764.1">ystems such as ERP, CRM, </span><span class="No-Break"><span class="koboSpan" id="kobo.765.1">and more.</span></span></p>
<h2 id="_idParaDest-246"><a id="_idTextAnchor466"/><span class="koboSpan" id="kobo.766.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.767.1">To add basic user roles to the application, perform the </span><span class="No-Break"><span class="koboSpan" id="kobo.768.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.769.1">First, add a field named </span><strong class="source-inline"><span class="koboSpan" id="kobo.770.1">roles</span></strong><span class="koboSpan" id="kobo.771.1"> to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.772.1">User</span></strong><span class="koboSpan" id="kobo.773.1"> model in </span><strong class="source-inline"><span class="koboSpan" id="kobo.774.1">auth/models.py</span></strong><span class="koboSpan" id="kobo.775.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.776.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.777.1">
class User(db.Model):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.778.1">
    id = db.Column(db.Integer, primary_key=True)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.779.1">
    username = db.Column(db.String(100))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.780.1">
    pwdhash = db.Column(db.String())</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.781.1">
    admin = db.Column(db.Boolean())</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.782.1">
    notes = db.Column(db.UnicodeText)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.783.1">
    roles = db.Column(db.String(4))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.784.1">
    def __init__(self, username, password,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.785.1">
      admin=False, notes='', roles='R'):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.786.1">
        self.username = username</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.787.1">
        self.pwdhash =</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.788.1">
          generate_password_hash(password)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.789.1">
        self.admin = admin</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.790.1">
        self.notes = notes</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.791.1">
        self.roles = self.admin and roles or ''</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.792.1">Here, we added </span><a id="_idIndexMarker369"/><span class="koboSpan" id="kobo.793.1">a new field, </span><strong class="source-inline"><span class="koboSpan" id="kobo.794.1">roles</span></strong><span class="koboSpan" id="kobo.795.1">, which is a string field with a length of </span><strong class="source-inline"><span class="koboSpan" id="kobo.796.1">4</span></strong><span class="koboSpan" id="kobo.797.1">. </span><span class="koboSpan" id="kobo.797.2">We assumed that the only entries that are possible in this field are any combinations of </span><strong class="source-inline"><span class="koboSpan" id="kobo.798.1">C</span></strong><span class="koboSpan" id="kobo.799.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.800.1">R</span></strong><span class="koboSpan" id="kobo.801.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.802.1">U</span></strong><span class="koboSpan" id="kobo.803.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.804.1">D</span></strong><span class="koboSpan" id="kobo.805.1">. </span><span class="koboSpan" id="kobo.805.2">A user with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.806.1">roles</span></strong><span class="koboSpan" id="kobo.807.1"> value as </span><strong class="source-inline"><span class="koboSpan" id="kobo.808.1">CRUD</span></strong><span class="koboSpan" id="kobo.809.1"> will have permission to perform all the actions, while any missing permissions will prevent the user from performing that action. </span><span class="koboSpan" id="kobo.809.2">Note that read permissions are always implied to any admin user, whether specified or not.</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.810.1">Important</span></p>
<p class="callout"><span class="koboSpan" id="kobo.811.1">In order to add a new field, you might need to run migration scripts. </span><span class="koboSpan" id="kobo.811.2">You can refer to the </span><em class="italic"><span class="koboSpan" id="kobo.812.1">Migrating databases using Alembic and Flask-Migrate</span></em><span class="koboSpan" id="kobo.813.1"> recipe in </span><a href="B19111_03.xhtml#_idTextAnchor129"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.814.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.815.1">, </span><em class="italic"><span class="koboSpan" id="kobo.816.1">Data Modeling in Flask</span></em><span class="koboSpan" id="kobo.817.1">, for </span><span class="No-Break"><span class="koboSpan" id="kobo.818.1">more details.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.819.1">Next, make some changes to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.820.1">UserAdminView</span></strong><span class="koboSpan" id="kobo.821.1"> class </span><span class="No-Break"><span class="koboSpan" id="kobo.822.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.823.1">auth/views.py</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.824.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.825.1">
from flask_admin.actions import ActionsMixin</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.826.1">
class UserAdminView(ModelView, ActionsMixin):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.827.1">
    form_edit_rules = (</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.828.1">
        'username', 'admin', 'roles', 'notes',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.829.1">
        rules.Header('Reset Password'),</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.830.1">
        'new_password', 'confirm'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.831.1">
    )</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.832.1">
    form_create_rules = (</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.833.1">
        'username', 'admin', 'roles', 'notes',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.834.1">
          'password'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.835.1">
    )</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.836.1">In the preceding code, we just added the </span><strong class="source-inline"><span class="koboSpan" id="kobo.837.1">roles</span></strong><span class="koboSpan" id="kobo.838.1"> field to our </span><strong class="source-inline"><span class="koboSpan" id="kobo.839.1">create</span></strong><span class="koboSpan" id="kobo.840.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.841.1">edit</span></strong><span class="koboSpan" id="kobo.842.1"> forms. </span><span class="koboSpan" id="kobo.842.2">We also inherited a class called </span><strong class="source-inline"><span class="koboSpan" id="kobo.843.1">ActionsMixin</span></strong><span class="koboSpan" id="kobo.844.1">. </span><span class="koboSpan" id="kobo.844.2">This is necessary to handle the mass update actions such as mass deletion.</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.845.1">Next, we have the </span><a id="_idIndexMarker370"/><span class="koboSpan" id="kobo.846.1">methods that we need to implement conditions and handle the logic for </span><span class="No-Break"><span class="koboSpan" id="kobo.847.1">various roles:</span></span><ol><li><span class="koboSpan" id="kobo.848.1">First is the method that handled the creation of </span><span class="No-Break"><span class="koboSpan" id="kobo.849.1">a model:</span></span></li></ol><pre class="source-code"><span class="koboSpan" id="kobo.850.1">
    def create_model(self, form):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.851.1">
        if 'C' not in current_user.roles:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.852.1">
            flash('You are not allowed to create</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.853.1">
              users.', 'warning')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.854.1">
            return</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.855.1">
        model = self.model(</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.856.1">
            form.username.data, form.password.data,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.857.1">
              form.admin.data,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.858.1">
            form.notes.data</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.859.1">
        )</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.860.1">
        form.populate_obj(model)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.861.1">
        self.session.add(model)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.862.1">
        self._on_model_change(form, model, True)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.863.1">
        self.session.commit()</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.864.1">In the preceding method, we first checked whether the </span><strong class="source-inline"><span class="koboSpan" id="kobo.865.1">roles</span></strong><span class="koboSpan" id="kobo.866.1"> field in </span><strong class="source-inline"><span class="koboSpan" id="kobo.867.1">current_user</span></strong><span class="koboSpan" id="kobo.868.1"> has permission to create records (this is denoted by </span><strong class="source-inline"><span class="koboSpan" id="kobo.869.1">C</span></strong><span class="koboSpan" id="kobo.870.1">). </span><span class="koboSpan" id="kobo.870.2">If not, we show an error message and return from the method.</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.871.1">Next is the </span><a id="_idIndexMarker371"/><span class="koboSpan" id="kobo.872.1">method that would handle </span><span class="No-Break"><span class="koboSpan" id="kobo.873.1">the update:</span></span></li>
</ol>
<pre class="source-code"><span class="koboSpan" id="kobo.874.1">
    def update_model(self, form, model):
        if 'U' not in current_user.roles:
            flash('You are not allowed to edit
              users.', 'warning')
            return
        form.populate_obj(model)
        if form.new_password.data:
            if form.new_password.data !=
              form.confirm.data:
                flash('Passwords must match')
                return
            model.pwdhash = generate_password_hash(
                form.new_password.data)
        self.session.add(model)
        self._on_model_change(form, model, False)
        self.session.commit()</span></pre>
<p><span class="koboSpan" id="kobo.875.1">In the preceding method, we first checked whether the </span><strong class="source-inline"><span class="koboSpan" id="kobo.876.1">roles</span></strong><span class="koboSpan" id="kobo.877.1"> field in </span><strong class="source-inline"><span class="koboSpan" id="kobo.878.1">current_user</span></strong><span class="koboSpan" id="kobo.879.1"> has permission to update records (this is denoted by </span><strong class="source-inline"><span class="koboSpan" id="kobo.880.1">U</span></strong><span class="koboSpan" id="kobo.881.1">). </span><span class="koboSpan" id="kobo.881.2">If not, we show an error message and return from the method.</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.882.1">The next method handles </span><span class="No-Break"><span class="koboSpan" id="kobo.883.1">the deletion:</span></span></li>
</ol>
<pre class="source-code"><span class="koboSpan" id="kobo.884.1">
    def delete_model(self, model):
        if 'D' not in current_user.roles:
            flash('You are not allowed to delete
              users.', 'warning')
            return
        super(UserAdminView, self).delete_model(model)</span></pre>
<p><span class="koboSpan" id="kobo.885.1">Similarly, in the preceding method, we checked whether </span><strong class="source-inline"><span class="koboSpan" id="kobo.886.1">current_user</span></strong><span class="koboSpan" id="kobo.887.1"> is allowed to delete</span><a id="_idIndexMarker372"/><span class="koboSpan" id="kobo.888.1"> records.</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.889.1">Finally, the need to check for relevant roles and permission </span><span class="No-Break"><span class="koboSpan" id="kobo.890.1">is addressed:</span></span></li>
</ol>
<pre class="source-code"><span class="koboSpan" id="kobo.891.1">
    def is_action_allowed(self, name):
        if name == 'delete' and 'D' not in
          current_user.roles:
            flash('You are not allowed to delete
              users.', 'warning')
            return False
        return True</span></pre>
<p><span class="koboSpan" id="kobo.892.1">In the preceding method, we checked whether the action is </span><strong class="source-inline"><span class="koboSpan" id="kobo.893.1">delete</span></strong><span class="koboSpan" id="kobo.894.1"> and whether </span><strong class="source-inline"><span class="koboSpan" id="kobo.895.1">current_user</span></strong><span class="koboSpan" id="kobo.896.1"> is allowed to delete. </span><span class="koboSpan" id="kobo.896.2">If not, then we flash the error message and return a </span><strong class="source-inline"><span class="koboSpan" id="kobo.897.1">False</span></strong><span class="koboSpan" id="kobo.898.1"> value. </span><span class="koboSpan" id="kobo.898.2">This method can be extended to </span><a id="_idTextAnchor467"/><span class="koboSpan" id="kobo.899.1">handle any custom-written actions too.</span></p>
<h2 id="_idParaDest-247"><a id="_idTextAnchor468"/><span class="koboSpan" id="kobo.900.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.901.1">This recipe works in a manner that is very similar to how our application has been working so far, except for the fact that, now, users with designated roles will be able to perform specific operations. </span><span class="koboSpan" id="kobo.901.2">Otherwise, error messages will </span><span class="No-Break"><span class="koboSpan" id="kobo.902.1">be displayed.</span></span></p>
<p><span class="koboSpan" id="kobo.903.1">The user list will now look like the </span><span class="No-Break"><span class="koboSpan" id="kobo.904.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer061">
<span class="koboSpan" id="kobo.905.1"><img alt="Figure 8.11 – Admin role assigned to users" src="image/B19111_08_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.906.1">Figure 8.11 – Admin role assigned to users</span></p>
<p><span class="koboSpan" id="kobo.907.1">To test the rest of</span><a id="_idIndexMarker373"/><span class="koboSpan" id="kobo.908.1"> the functionality, such as creating new users (both normal and admin), deleting users, updating user records, and more, I urge you to try it </span><span class="No-Break"><span class="koboSpan" id="kobo.909.1">for yourself.</span></span></p>
</div>
</body></html>