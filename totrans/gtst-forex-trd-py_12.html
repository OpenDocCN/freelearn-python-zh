<html><head></head><body>
<div id="_idContainer125">
<h1 class="chapter-number" id="_idParaDest-202"><a id="_idTextAnchor203"/><span class="koboSpan" id="kobo.1.1">12</span></h1>
<h1 id="_idParaDest-203"><a id="_idTextAnchor204"/><span class="koboSpan" id="kobo.2.1">Sample Strategy – Trend-Following</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In the previous chapter, we developed two trading applications: one to use in production and another one to facilitate the testing and research of trading strategies. </span><span class="koboSpan" id="kobo.3.2">Better said, these are two versions of the same application, with different data processing modules. </span><span class="koboSpan" id="kobo.3.3">We designed them so that the trading logic developed in the backtesting app could be used in the production one without modifications (or with just minimal modifications in complex cases). </span><span class="koboSpan" id="kobo.3.4">We also tested the code using a sample "</span><em class="italic"><span class="koboSpan" id="kobo.4.1">strategy"</span></em><span class="koboSpan" id="kobo.5.1"> and saw that the code worked correctly, but the "</span><em class="italic"><span class="koboSpan" id="kobo.6.1">strategy"</span></em><span class="koboSpan" id="kobo.7.1"> was steadily losing money – fortunately only on paper (and that’s why I consistently put this word </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">in "italics").</span></span></p>
<p><span class="koboSpan" id="kobo.9.1">Now it’s time to learn the process of researching and developing one of the most popular classical trading strategies applied to the FX market. </span><span class="koboSpan" id="kobo.9.2">We already discussed it earlier in the book, but only from a qualitative, not a quantitative, perspective. </span><span class="koboSpan" id="kobo.9.3">Now we will suggest a formal mathematical model and implement it in code. </span><span class="koboSpan" id="kobo.9.4">And, of course, we will backtest and check whether the result can be used for </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">live trading.</span></span></p>
<p><span class="koboSpan" id="kobo.11.1">In this chapter, we will consider trend-following strategies and learn about the </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">following topics:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.13.1">Trend-following revisited – </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">trading setup</span></span></li>
<li><span class="koboSpan" id="kobo.15.1">Choosing the market and </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">preparing data</span></span></li>
<li><span class="koboSpan" id="kobo.17.1">Trend-following strategy – </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">implementation</span></span></li>
</ul>
<h1 id="_idParaDest-204"><a id="_idTextAnchor205"/><span class="koboSpan" id="kobo.19.1">Trend-following revisited – trading setup</span></h1>
<p><span class="koboSpan" id="kobo.20.1">In </span><a href="B19145_09.xhtml#_idTextAnchor152"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.21.1">Chapter 9</span></em></span></a><span class="koboSpan" id="kobo.22.1">, </span><em class="italic"><span class="koboSpan" id="kobo.23.1">Trading Strategies and Their Core Elements</span></em><span class="koboSpan" id="kobo.24.1">, we considered trend-following</span><a id="_idIndexMarker829"/><span class="koboSpan" id="kobo.25.1"> and came to the conclusion that although it is one of the simplest and most intuitive trading strategies, we still need a set of rules that determine </span><span class="No-Break"><span class="koboSpan" id="kobo.26.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.27.1">Whether there is a trend in </span><span class="No-Break"><span class="koboSpan" id="kobo.28.1">the market</span></span></li>
<li><span class="koboSpan" id="kobo.29.1">Whether the trend goes north or south (up or down, </span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">that is)</span></span></li>
<li><span class="koboSpan" id="kobo.31.1">When it’s time to join the trend (buy or </span><span class="No-Break"><span class="koboSpan" id="kobo.32.1">sell respectively)</span></span></li>
<li><span class="koboSpan" id="kobo.33.1">When it’s time to exit the existing</span><a id="_idIndexMarker830"/><span class="koboSpan" id="kobo.34.1"> position (so we expect the trend to end </span><span class="No-Break"><span class="koboSpan" id="kobo.35.1">and/or reverse)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.36.1">Let’s understand more in the </span><span class="No-Break"><span class="koboSpan" id="kobo.37.1">upcoming sections.</span></span></p>
<h2 id="_idParaDest-205"><a id="_idTextAnchor206"/><span class="koboSpan" id="kobo.38.1">Determining a trend, part 1 – market model</span></h2>
<p><span class="koboSpan" id="kobo.39.1">If I ask you whether it’s sunny</span><a id="_idIndexMarker831"/><span class="koboSpan" id="kobo.40.1"> or rainy outdoors, I’m sure you won’t hesitate with an answer</span><a id="_idIndexMarker832"/><span class="koboSpan" id="kobo.41.1"> in most cases. </span><span class="koboSpan" id="kobo.41.2">You can easily tell one from another because you are very familiar with a number of attributes that help you make the decision. </span><span class="koboSpan" id="kobo.41.3">Indeed, it’s easy to tell light from darkness, warmth from cold, moisture from dryness, and </span><span class="No-Break"><span class="koboSpan" id="kobo.42.1">so on.</span></span></p>
<p><span class="koboSpan" id="kobo.43.1">Now, say I ask you whether it’s slightly rainy or foggy and do so in the middle of the night. </span><span class="koboSpan" id="kobo.43.2">I imagine you’d have a really hard time telling one from another. </span><span class="koboSpan" id="kobo.43.3">Most likely, you would even go outside, try to feel the air on your skin and smell the air, and finally return with something such as </span><em class="italic"><span class="koboSpan" id="kobo.44.1">“well, it seems to be rain.”</span></em><span class="koboSpan" id="kobo.45.1"> In this case, you had to do several tests and use their results to make </span><span class="No-Break"><span class="koboSpan" id="kobo.46.1">your judgment.</span></span></p>
<p><span class="koboSpan" id="kobo.47.1">Why were you able to do these tests and use </span><span class="No-Break"><span class="koboSpan" id="kobo.48.1">their results?</span></span></p>
<p><span class="koboSpan" id="kobo.49.1">Because you have a </span><em class="italic"><span class="koboSpan" id="kobo.50.1">model</span></em><span class="koboSpan" id="kobo.51.1"> in your mind, a model of the weather. </span><span class="koboSpan" id="kobo.51.2">You wouldn’t think about it unless it’s your profession and, in most cases, you make decisions intuitively and instantly. </span><span class="koboSpan" id="kobo.51.3">However, if put under pressure, you can find some more or less formal attributes – such as humidity, temperature, and wind – to decide upon the weather, again within the framework of the </span><span class="No-Break"><span class="koboSpan" id="kobo.52.1">weather model.</span></span></p>
<p><span class="koboSpan" id="kobo.53.1">Let’s now develop a model of market trends following the same example with </span><span class="No-Break"><span class="koboSpan" id="kobo.54.1">the weather.</span></span></p>
<p><span class="koboSpan" id="kobo.55.1">First, and above all, we should decide whether trends are something that always exists or occurs only at times. </span><span class="koboSpan" id="kobo.55.2">If we compare both models (permanent trends and occasional trends) with our weather example, we will see the </span><span class="No-Break"><span class="koboSpan" id="kobo.56.1">following parallels:</span></span></p>
<table class="T---Table _idGenTablePara-1" id="table001-2">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="T---Table">
<td class="T---Table T---Body T---Body">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.57.1">Market</span></strong></span></p>
</td>
<td class="T---Table T---Body T---Body">
<p><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.58.1">Weather</span></strong></span></p>
</td>
</tr>
<tr class="T---Table">
<td class="T---Table T---Body T---Body">
<p><span class="koboSpan" id="kobo.59.1">The market is always in an uptrend or downtrend. </span><span class="koboSpan" id="kobo.59.2">Trends may be more or </span><span class="No-Break"><span class="koboSpan" id="kobo.60.1">less visible.</span></span></p>
</td>
<td class="T---Table T---Body T---Body">
<p><span class="koboSpan" id="kobo.61.1">The wind blows all the time, only sometimes stronger and other </span><span class="No-Break"><span class="koboSpan" id="kobo.62.1">times weaker.</span></span></p>
</td>
</tr>
<tr class="T---Table">
<td class="T---Table T---Body T---Body">
<p><span class="koboSpan" id="kobo.63.1">The market can be in </span><em class="italic"><span class="koboSpan" id="kobo.64.1">trend mode</span></em><span class="koboSpan" id="kobo.65.1"> or </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.66.1">non-trend</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.67.1"> mode.</span></span></p>
</td>
<td class="T---Table T---Body T---Body">
<p><span class="koboSpan" id="kobo.68.1">Sometimes the wind blows and other times the wind doesn’t blow </span><span class="No-Break"><span class="koboSpan" id="kobo.69.1">at all.</span></span></p>
</td>
</tr>
</tbody>
</table>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.70.1">Table 12.1 – Drawing parallels between market trends and the weather</span></p>
<p><span class="koboSpan" id="kobo.71.1">Despite looking quite simple, this table</span><a id="_idIndexMarker833"/><span class="koboSpan" id="kobo.72.1"> perfectly illustrates the fundamental difference</span><a id="_idIndexMarker834"/><span class="koboSpan" id="kobo.73.1"> in approaches to modeling the process (market or weather). </span><span class="koboSpan" id="kobo.73.2">It is up to the model’s developer to decide either that the observed process can only be in one state (only in trend; only wind blowing) or that it can be in multiple states (trend or non-trend in the market example; windy or not windy in the </span><span class="No-Break"><span class="koboSpan" id="kobo.74.1">weather example).</span></span></p>
<p><span class="koboSpan" id="kobo.75.1">This said, we come to a very </span><span class="No-Break"><span class="koboSpan" id="kobo.76.1">important conclusion.</span></span></p>
<p><span class="koboSpan" id="kobo.77.1">There is no such thing as a </span><em class="italic"><span class="koboSpan" id="kobo.78.1">true</span></em><span class="koboSpan" id="kobo.79.1"> or </span><em class="italic"><span class="koboSpan" id="kobo.80.1">false</span></em><span class="koboSpan" id="kobo.81.1"> model. </span><span class="koboSpan" id="kobo.81.2">A model only tries to explain the observed phenomena with certain precision and serves the purpose of </span><span class="No-Break"><span class="koboSpan" id="kobo.82.1">making decisions.</span></span></p>
<p><span class="koboSpan" id="kobo.83.1">So, the ability of a model to help make a practical decision is the only criterion of the model’s validity. </span><span class="koboSpan" id="kobo.83.2">If looking outside the window is enough to know how to dress for the day, then the weather model is valid. </span><span class="koboSpan" id="kobo.83.3">If you make decisions whether to take an umbrella with you by consulting sophisticated equipment and still regularly get wet to the skin, most likely, the model used in this sophisticated equipment is </span><span class="No-Break"><span class="koboSpan" id="kobo.84.1">not valid.</span></span></p>
<p><span class="koboSpan" id="kobo.85.1">In the market, the situation is similar. </span><span class="koboSpan" id="kobo.85.2">If we can suggest a simplistic market model that nevertheless is able to consistently outperform a benchmark (see </span><a href="B19145_09.xhtml#_idTextAnchor152"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.86.1">Chapter 9</span></em></span></a><span class="koboSpan" id="kobo.87.1">, </span><em class="italic"><span class="koboSpan" id="kobo.88.1">Trading Strategies and Their Core Elements</span></em><span class="koboSpan" id="kobo.89.1">), then this is an acceptable model. </span><span class="koboSpan" id="kobo.89.2">At the same time, we may have an extremely sophisticated model that uses artificial intelligence and quantum mechanics, but if in the long run it doesn’t beat the market, then it may only be interesting from an </span><span class="No-Break"><span class="koboSpan" id="kobo.90.1">academic standpoint.</span></span></p>
<p><span class="koboSpan" id="kobo.91.1">As we’re making our first steps in algo trading, let’s start with something simple. </span><span class="koboSpan" id="kobo.91.2">We can make our model more complicated later if a simplistic model </span><span class="No-Break"><span class="koboSpan" id="kobo.92.1">doesn’t work.</span></span></p>
<p><span class="koboSpan" id="kobo.93.1">In our present case, we should make a decision regarding how we model the market from a </span><span class="No-Break"><span class="koboSpan" id="kobo.94.1">trending standpoint:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.95.1">The market is always in a trend, up or down; it’s just the duration of these trends that may be long </span><span class="No-Break"><span class="koboSpan" id="kobo.96.1">or short</span></span></li>
<li><span class="koboSpan" id="kobo.97.1">The market is in either a trend or non-trend state, and we should distinguish between the two before determining an uptrend </span><span class="No-Break"><span class="koboSpan" id="kobo.98.1">or downtrend</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.99.1">Of course, the first model is simpler: we don’t need to suggest a method to tell trend from non-trend, focusing now only on technical setups that tell an uptrend from a downtrend. </span><span class="koboSpan" id="kobo.99.2">Again, if this approach doesn’t work, we can return to this decision point, change our model, and start the research </span><span class="No-Break"><span class="koboSpan" id="kobo.100.1">all over.</span></span></p>
<p><span class="koboSpan" id="kobo.101.1">So, we have decided upon the first point in our checklist: we choose the </span><em class="italic"><span class="koboSpan" id="kobo.102.1">always-in-trend</span></em><span class="koboSpan" id="kobo.103.1"> market model for </span><span class="No-Break"><span class="koboSpan" id="kobo.104.1">further research.</span></span></p>
<p><span class="koboSpan" id="kobo.105.1">Now that we have decided</span><a id="_idIndexMarker835"/><span class="koboSpan" id="kobo.106.1"> upon the market model, let’s move on to finding a proper tool </span><a id="_idIndexMarker836"/><span class="koboSpan" id="kobo.107.1">to distinguish an uptrend from a downtrend. </span><span class="koboSpan" id="kobo.107.2">Again, we start this step with the simplest solution: </span><span class="No-Break"><span class="koboSpan" id="kobo.108.1">moving averages.</span></span></p>
<h2 id="_idParaDest-206"><a id="_idTextAnchor207"/><span class="koboSpan" id="kobo.109.1">Determining a trend, part 2 – moving averages</span></h2>
<p><span class="koboSpan" id="kobo.110.1">One of the classical technical</span><a id="_idIndexMarker837"/><span class="koboSpan" id="kobo.111.1"> analysis studies typically used to determine</span><a id="_idIndexMarker838"/><span class="koboSpan" id="kobo.112.1"> trends is the moving average. </span><span class="koboSpan" id="kobo.112.2">In </span><a href="B19145_07.xhtml#_idTextAnchor114"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.113.1">Chapter 7</span></em></span></a><span class="koboSpan" id="kobo.114.1">, </span><em class="italic"><span class="koboSpan" id="kobo.115.1">Technical Analysis and Its Implementation in Python</span></em><span class="koboSpan" id="kobo.116.1">, we already considered moving averages and found that they act as digital filters that eliminate higher frequencies (short-term price fluctuations) and keep lower frequencies, which we consider as dominating long-term tendencies in price movements. </span><span class="koboSpan" id="kobo.116.2">Let’s quickly refresh our knowledge of this by plotting a 20-period moving average (MA20) over a </span><span class="No-Break"><span class="koboSpan" id="kobo.117.1">price chart.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer122">
<span class="koboSpan" id="kobo.118.1"><img alt="Figure 12.1 – 20-period moving average on top of a 1-minute chart of EURJPY. Chart by Multicharts" src="image/B19145_12_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.119.1">Figure 12.1 – 20-period moving average on top of a 1-minute chart of EURJPY. </span><span class="koboSpan" id="kobo.119.2">Chart by Multicharts</span></p>
<p><span class="koboSpan" id="kobo.120.1">We can see that sometimes, the bars’ closing prices tend to remain above the MA20, while sometimes they are below it. </span><span class="koboSpan" id="kobo.120.2">It is reasonable to suppose that as long as these closing prices remain above the MA20, the market is in an uptrend, and while they remain below it, it is in </span><span class="No-Break"><span class="koboSpan" id="kobo.121.1">a downtrend.</span></span></p>
<p><span class="koboSpan" id="kobo.122.1">The problem with this technical</span><a id="_idIndexMarker839"/><span class="koboSpan" id="kobo.123.1"> setup is that sometimes prices remain</span><a id="_idIndexMarker840"/><span class="koboSpan" id="kobo.124.1"> above or below a moving average for too short a period of time. </span><span class="koboSpan" id="kobo.124.2">We already agreed that in our model the market is always in trend and we do not separate any special non-trending condition. </span><span class="koboSpan" id="kobo.124.3">However, maybe there’s a better technical setup, something that would better indicate an uptrend or downtrend without so many </span><em class="italic"><span class="koboSpan" id="kobo.125.1">short-term trends</span></em><span class="koboSpan" id="kobo.126.1">, which we intuitively wouldn’t like to even </span><span class="No-Break"><span class="koboSpan" id="kobo.127.1">call </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.128.1">trends</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.129.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.130.1">Yes, there is, and this is one of the oldest classical technical trading setups: we use two moving averages, one with a short period and another one with a long period. </span><span class="koboSpan" id="kobo.130.2">Then, we consider an uptrend only when both of the following two conditions </span><span class="No-Break"><span class="koboSpan" id="kobo.131.1">are met:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.132.1">The price is above the short-period </span><span class="No-Break"><span class="koboSpan" id="kobo.133.1">moving average</span></span></li>
<li><span class="koboSpan" id="kobo.134.1">The short-period moving average is itself above the long-period </span><span class="No-Break"><span class="koboSpan" id="kobo.135.1">moving average</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.136.1">It is similar </span><span class="No-Break"><span class="koboSpan" id="kobo.137.1">for downtrends:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.138.1">The price is below the short-term </span><span class="No-Break"><span class="koboSpan" id="kobo.139.1">moving average</span></span></li>
<li><span class="koboSpan" id="kobo.140.1">The short-period moving average is itself below the long-period </span><span class="No-Break"><span class="koboSpan" id="kobo.141.1">moving average</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.142.1">Let’s see what it may look like on </span><span class="No-Break"><span class="koboSpan" id="kobo.143.1">a chart.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer123">
<span class="koboSpan" id="kobo.144.1"><img alt="Figure 12.2 – Adding a longer-term moving average helps exclude unwanted situations" src="image/B19145_12_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.145.1">Figure 12.2 – Adding a longer-term moving average helps exclude unwanted situations</span></p>
<p><span class="koboSpan" id="kobo.146.1">In the preceding figure, I added</span><a id="_idIndexMarker841"/><span class="koboSpan" id="kobo.147.1"> a 50-period moving average (MA50) to the existing</span><a id="_idIndexMarker842"/><span class="koboSpan" id="kobo.148.1"> MA20 and zoomed the figure in to see more details. </span><span class="koboSpan" id="kobo.148.2">The area encompassed by a dotted oval illustrates how adding the second moving average may filter out certain (but, of course, not all) unwanted situations. </span><span class="koboSpan" id="kobo.148.3">If we decide whether it’s an uptrend or a downtrend only by closing prices being above or below MA20, then during the phase shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.149.1">Figure 12</span></em></span><em class="italic"><span class="koboSpan" id="kobo.150.1">.2</span></em><span class="koboSpan" id="kobo.151.1">, we would have to decide whether there was a downtrend. </span><span class="koboSpan" id="kobo.151.2">However, if we use a setup with both requirements as we suggested previously (that the price should be below MA20 and MA20 should be below MA50), then we can qualify it neither as an uptrend nor as a downtrend. </span><span class="koboSpan" id="kobo.151.3">So, in the trade logic, we simply skip this interval – and then we can see that the following price movement develops into a </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.152.1">true</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.153.1"> uptrend.</span></span></p>
<p><span class="koboSpan" id="kobo.154.1">Great, now we have covered</span><a id="_idIndexMarker843"/><span class="koboSpan" id="kobo.155.1"> two points in our list– we know when there’s a trend</span><a id="_idIndexMarker844"/><span class="koboSpan" id="kobo.156.1"> in the market and know its direction. </span><span class="koboSpan" id="kobo.156.2">Now we need to decide when we actually enter and exit a position in </span><span class="No-Break"><span class="koboSpan" id="kobo.157.1">the market.</span></span></p>
<h2 id="_idParaDest-207"><a id="_idTextAnchor208"/><span class="koboSpan" id="kobo.158.1">Entry and exit rules</span></h2>
<p><span class="koboSpan" id="kobo.159.1">After all the elements of a technical trading</span><a id="_idIndexMarker845"/><span class="koboSpan" id="kobo.160.1"> setup are determined, the key </span><a id="_idIndexMarker846"/><span class="koboSpan" id="kobo.161.1">question remains of when to actually enter and exit a position. </span><span class="koboSpan" id="kobo.161.2">In some cases, it may be a non-trivial question and the answer to it may seriously affect the resulting performance of a strategy. </span><span class="koboSpan" id="kobo.161.3">However, within our simplistic model, we can assume that we can enter the market as soon as the trend conditions are met. </span><span class="koboSpan" id="kobo.161.4">This means that we open a new long position when the </span><span class="No-Break"><span class="koboSpan" id="kobo.162.1">following apply:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.163.1">The bar’s closing price is above the short-period </span><span class="No-Break"><span class="koboSpan" id="kobo.164.1">moving average</span></span></li>
<li><span class="koboSpan" id="kobo.165.1">The short-period moving average is above the long-period </span><span class="No-Break"><span class="koboSpan" id="kobo.166.1">moving average</span></span></li>
<li><span class="koboSpan" id="kobo.167.1">Currently, we don’t have a long position in the market (so we don’t add to an existing position, and we don’t buy more if we’re </span><span class="No-Break"><span class="koboSpan" id="kobo.168.1">already long)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.169.1">As to exiting from an open position – again, within our market model there’s no need to actually exit a position because the model assumes that the market is always in a trend. </span><span class="koboSpan" id="kobo.169.2">So, we exit a long position only when we open a short position and </span><span class="No-Break"><span class="koboSpan" id="kobo.170.1">vice versa.</span></span></p>
<p><span class="koboSpan" id="kobo.171.1">In other words, we plan a strategy that is </span><em class="italic"><span class="koboSpan" id="kobo.172.1">always in the market</span></em><span class="koboSpan" id="kobo.173.1"> and changes the trade’s direction as soon as the change in the trend </span><span class="No-Break"><span class="koboSpan" id="kobo.174.1">is detected.</span></span></p>
<p><span class="koboSpan" id="kobo.175.1">As with the market model, we can change this approach later, if testing the current simplistic model doesn’t produce </span><span class="No-Break"><span class="koboSpan" id="kobo.176.1">acceptable results.</span></span></p>
<h2 id="_idParaDest-208"><a id="_idTextAnchor209"/><span class="koboSpan" id="kobo.177.1">Money management</span></h2>
<p><strong class="bold"><span class="koboSpan" id="kobo.178.1">Money management</span></strong><span class="koboSpan" id="kobo.179.1"> means how much you trade with each</span><a id="_idIndexMarker847"/><span class="koboSpan" id="kobo.180.1"> new order. </span><span class="koboSpan" id="kobo.180.2">There are many money management</span><a id="_idIndexMarker848"/><span class="koboSpan" id="kobo.181.1"> theories and techniques, from very simple to quite sophisticated. </span><span class="koboSpan" id="kobo.181.2">Unfortunately, we cannot really cover all of them in one chapter – it would require a separate book! </span><span class="koboSpan" id="kobo.181.3">But since we are keeping things simple at the moment and are more interested in learning how the trade logic works in general, let’s use the most simplistic money management concept as well: we will use the same constant trading size for all trades, doubling it when we should make a reversal from long to short or from short to long. </span><span class="koboSpan" id="kobo.181.4">We already did that in the previous chapter when we developed our </span><span class="No-Break"><span class="koboSpan" id="kobo.182.1">backtesting platform.</span></span></p>
<p><span class="koboSpan" id="kobo.183.1">The rule of thumb is: if your strategy performs acceptably well with a constant trading size, its performance may be improved with money management. </span><span class="koboSpan" id="kobo.183.2">If the strategy doesn’t perform well with constant trading size then attempts to improve its performance by using various money management rules fail most of </span><span class="No-Break"><span class="koboSpan" id="kobo.184.1">the time.</span></span></p>
<p><span class="koboSpan" id="kobo.185.1">So, we have successfully covered the four key points that we outlined at the beginning of </span><span class="No-Break"><span class="koboSpan" id="kobo.186.1">this chapter:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.187.1">We know when the market is </span><span class="No-Break"><span class="koboSpan" id="kobo.188.1">in trend</span></span></li>
<li><span class="koboSpan" id="kobo.189.1">We know the </span><span class="No-Break"><span class="koboSpan" id="kobo.190.1">trend’s direction</span></span></li>
<li><span class="koboSpan" id="kobo.191.1">We know when to enter </span><span class="No-Break"><span class="koboSpan" id="kobo.192.1">the market</span></span></li>
<li><span class="koboSpan" id="kobo.193.1">We know when to </span><span class="No-Break"><span class="koboSpan" id="kobo.194.1">exit it</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.195.1">Plus, we also know how much we have at stake with </span><span class="No-Break"><span class="koboSpan" id="kobo.196.1">each trade.</span></span></p>
<p><span class="koboSpan" id="kobo.197.1">Great, now we can proceed</span><a id="_idIndexMarker849"/><span class="koboSpan" id="kobo.198.1"> to choose the market we’re going to trade</span><a id="_idIndexMarker850"/><span class="koboSpan" id="kobo.199.1"> using trend-following and prepare </span><span class="No-Break"><span class="koboSpan" id="kobo.200.1">the data.</span></span></p>
<h1 id="_idParaDest-209"><a id="_idTextAnchor210"/><span class="koboSpan" id="kobo.201.1">Choosing the market and preparing data</span></h1>
<p><span class="koboSpan" id="kobo.202.1">There is one very common</span><a id="_idIndexMarker851"/><span class="koboSpan" id="kobo.203.1"> misconception regarding systematic trading: it is believed that a technical trading</span><a id="_idIndexMarker852"/><span class="koboSpan" id="kobo.204.1"> strategy should work in any market. </span><span class="koboSpan" id="kobo.204.2">I hope that the previous chapters have already dispelled this myth. </span><span class="koboSpan" id="kobo.204.3">Just as an example, let’s recall the famous EURCHF market while the Swiss national bank was keeping the rate of the Swiss franc pegged to the euro (see </span><a href="B19145_09.xhtml#_idTextAnchor152"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.205.1">Chapter 9</span></em></span></a><span class="koboSpan" id="kobo.206.1">, </span><em class="italic"><span class="koboSpan" id="kobo.207.1">Trading Strategies and Their Core Elements</span></em><span class="koboSpan" id="kobo.208.1">) – go and trade it using trend-following if the price virtually doesn’t move </span><span class="No-Break"><span class="koboSpan" id="kobo.209.1">at all!</span></span></p>
<p><span class="koboSpan" id="kobo.210.1">Even if we set aside such extreme examples, anyway, choosing the market can be a non-trivial task. </span><span class="koboSpan" id="kobo.210.2">Most of the time, we have to try many markets even if we can make an educated guess about which should perform better with a specific kind of strategy. </span><span class="koboSpan" id="kobo.210.3">However, there are some general guidelines that we are going to </span><span class="No-Break"><span class="koboSpan" id="kobo.211.1">use now.</span></span></p>
<p><span class="koboSpan" id="kobo.212.1">First, since we’re focused on trend-following, we would like to trade a market that is full of trends (however much it may sound like a truism). </span><span class="koboSpan" id="kobo.212.2">If we are in the FX domain, we may want to focus on currency pairs with the greatest difference in the interest rates between the two currencies (see the </span><em class="italic"><span class="koboSpan" id="kobo.213.1">Fundamental analysis</span></em><span class="koboSpan" id="kobo.214.1"> section of </span><a href="B19145_06.xhtml#_idTextAnchor101"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.215.1">Chapter 6</span></em></span></a><span class="koboSpan" id="kobo.216.1">, </span><em class="italic"><span class="koboSpan" id="kobo.217.1">Basics of Fundamental Analysis and Its Possible Use in FX Trading</span></em><span class="koboSpan" id="kobo.218.1">, for a brief discussion on interest rates and carry trading) because this is one of the very few factors that may lead to forming a more or less long-term trend. </span><span class="koboSpan" id="kobo.218.2">So, pairs with currencies such as the Australian dollar or the New Zealand dollar versus the Japanese yen or even the US dollar (especially when the US rates were low) may be good to </span><span class="No-Break"><span class="koboSpan" id="kobo.219.1">start with.</span></span></p>
<p><span class="koboSpan" id="kobo.220.1">Another reason to choose the Australian dollar for trading with a trend-following strategy is that the Australian economy is dependent on gold production, much like the Canadian economy depends on oil (though perhaps to a lesser extent). </span><span class="koboSpan" id="kobo.220.2">As a result, the rate of the Australian dollar is prone to corresponding changes in the price of gold and other export commodities. </span><span class="koboSpan" id="kobo.220.3">Since commodity prices exhibit cyclic behavior due to manufacturing cycles, we can see this reflected in AUDUSD or AUDJPY. </span><span class="koboSpan" id="kobo.220.4">Therefore, with these two considerations in mind, choosing AUDUSD as the first currency pair to try a trend-following strategy seems like a </span><span class="No-Break"><span class="koboSpan" id="kobo.221.1">natural choice.</span></span></p>
<p><span class="koboSpan" id="kobo.222.1">Second, we should decide upon the timeframe or data resolution. </span><span class="koboSpan" id="kobo.222.2">Although the previous sample charts with moving averages were made using a resolution of 1 minute, intraday data is not really good for trend-following strategies. </span><span class="koboSpan" id="kobo.222.3">The reason is that intraday the FX market exhibits strongly cyclical behavior in volatility patterns (see the </span><em class="italic"><span class="koboSpan" id="kobo.223.1">Liquidity and volatility – how one transforms into another</span></em><span class="koboSpan" id="kobo.224.1"> section of </span><a href="B19145_03.xhtml#_idTextAnchor044"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.225.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.226.1">, </span><em class="italic"><span class="koboSpan" id="kobo.227.1">FX Market Overview from a Developer’s Standpoint</span></em><span class="koboSpan" id="kobo.228.1">). </span><span class="koboSpan" id="kobo.228.2">These markets are active during the daytime and slow during the night. </span><span class="koboSpan" id="kobo.228.3">This periodicity will produce many </span><em class="italic"><span class="koboSpan" id="kobo.229.1">false trends</span></em><span class="koboSpan" id="kobo.230.1"> and make the task of determining a </span><em class="italic"><span class="koboSpan" id="kobo.231.1">true trend</span></em><span class="koboSpan" id="kobo.232.1"> significantly more difficult. </span><span class="koboSpan" id="kobo.232.2">At the same time, the daily timeframe is free from this feature and we may expect more steady trending behavior with this data resolution (of course, depending on whether the market is prone to trending at all). </span><span class="koboSpan" id="kobo.232.3">So, when we have a choice of making our model more complicated by adding a module to the trading logic, which would distinguish between </span><em class="italic"><span class="koboSpan" id="kobo.233.1">true</span></em><span class="koboSpan" id="kobo.234.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.235.1">false</span></em><span class="koboSpan" id="kobo.236.1"> trends, we’d rather use data with higher resolution to eliminate the </span><span class="No-Break"><span class="koboSpan" id="kobo.237.1">problem completely.</span></span></p>
<p><span class="koboSpan" id="kobo.238.1">Thus, we have decided</span><a id="_idIndexMarker853"/><span class="koboSpan" id="kobo.239.1"> upon the market (let’s start with AUDUSD) and the dat</span><a id="_idIndexMarker854"/><span class="koboSpan" id="kobo.240.1">a resolution (daily). </span><span class="koboSpan" id="kobo.240.2">As always, let me note that if we get unsatisfactory results, we can try different markets </span><span class="No-Break"><span class="koboSpan" id="kobo.241.1">and timeframes.</span></span></p>
<p><span class="koboSpan" id="kobo.242.1">Now that we have settled upon all the prerequisites, let’s get </span><span class="No-Break"><span class="koboSpan" id="kobo.243.1">to coding.</span></span></p>
<h2 id="_idParaDest-210"><a id="_idTextAnchor211"/><span class="koboSpan" id="kobo.244.1">Compressing data to a daily timeframe</span></h2>
<p><span class="koboSpan" id="kobo.245.1">Let’s start with writing</span><a id="_idIndexMarker855"/><span class="koboSpan" id="kobo.246.1"> a simple utility that would compress the market data to the required resolution and convert it into the desired format, compatible with our backtesting and live trading code (see </span><a href="B19145_11.xhtml#_idTextAnchor186"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.247.1">Chapter 11</span></em></span></a><span class="koboSpan" id="kobo.248.1">, </span><em class="italic"><span class="koboSpan" id="kobo.249.1">Backtesting and Theoretical Performance</span></em><span class="koboSpan" id="kobo.250.1">). </span><span class="koboSpan" id="kobo.250.2">We will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.251.1">getBarRealtime()</span></strong><span class="koboSpan" id="kobo.252.1"> function from the live version and slightly adapt it as a </span><span class="No-Break"><span class="koboSpan" id="kobo.253.1">stand-alone utility.</span></span></p>
<p><span class="koboSpan" id="kobo.254.1">This utility should do </span><span class="No-Break"><span class="koboSpan" id="kobo.255.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.256.1">Read the source data file (tick or </span><span class="No-Break"><span class="koboSpan" id="kobo.257.1">1-minute bars)</span></span></li>
<li><span class="koboSpan" id="kobo.258.1">Aggregate data into any </span><span class="No-Break"><span class="koboSpan" id="kobo.259.1">greater timeframe</span></span></li>
<li><span class="koboSpan" id="kobo.260.1">Save data to disk using a format compatible with </span><span class="No-Break"><span class="koboSpan" id="kobo.261.1">the backtester</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.262.1">As always, we start </span><span class="No-Break"><span class="koboSpan" id="kobo.263.1">with imports:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.264.1">
import csv
from datetime import datetime</span></pre>
<p><span class="koboSpan" id="kobo.265.1">We add a sliding window class similar to the one we used in </span><a href="B19145_06.xhtml#_idTextAnchor101"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.266.1">Chapter 6</span></em></span></a><span class="koboSpan" id="kobo.267.1">, </span><em class="italic"><span class="koboSpan" id="kobo.268.1">Basics of Fundamental Analysis and Its Possible Use in FX Trading</span></em><span class="koboSpan" id="kobo.269.1">, but we will use it in a bit of a different way: to store values of any parameter (price, time, volume, or whatever) on the current bar and the previous bar. </span><span class="koboSpan" id="kobo.269.2">Thus, we add two respective methods to quickly retrieve </span><span class="No-Break"><span class="koboSpan" id="kobo.270.1">these values:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.271.1">
class slidingWindow:
    def __init__(self, len):
        self.data = [0 for i in range(len)]
    def add(self, element):
        self.data.pop(0)
        self.data.append(element)
    def last(self):
        return self.data[-1]
    def previous(self):
        return self.data[-2]</span></pre>
<p><span class="koboSpan" id="kobo.272.1">Then, we specify the source file and the destination file and read the saved data (tick or 1 minute) – pretty much like we did in the </span><span class="No-Break"><span class="koboSpan" id="kobo.273.1">previous chapter:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.274.1">
source_file = open("LMAX AUD_USD 1 Minute.txt")
dest_file = open("AUDUSD_daily.csv", "w")
csvFile = csv.DictReader(source_file)
all_data = list(csvFile)</span></pre>
<p><span class="koboSpan" id="kobo.275.1">We immediately write the first line to the destination file – this line will act as a header for further processing the file as </span><span class="No-Break"><span class="koboSpan" id="kobo.276.1">a CSV:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.277.1">
dest_file.write(("Date,Time,Open,High,Low,Close\n"))</span></pre>
<p><span class="koboSpan" id="kobo.278.1">Then, we create an instance of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.279.1">slidingWindow</span></strong><span class="koboSpan" id="kobo.280.1"> class and initiate the first bar, which we’re going to aggregate and then save to the </span><span class="No-Break"><span class="koboSpan" id="kobo.281.1">destination file:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.282.1">
timestamp = slidingWindow(2)
bar = {'Open': 0, 'High': 0, 'Low': 0, 'Close': 0}</span></pre>
<p><span class="koboSpan" id="kobo.283.1">Now, we start iterating over all samples in the source file, convert the data, and add the timestamp to the timestamp</span><a id="_idIndexMarker856"/> <span class="No-Break"><span class="koboSpan" id="kobo.284.1">sliding window:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.285.1">
for sample in all_data:
    open = float(sample[' &lt;Open&gt;'])
    high = float(sample[' &lt;High&gt;'])
    low = float(sample[' &lt;Low&gt;'])
    close = float(sample[' &lt;Close&gt;'])
    ts = datetime.strptime(sample['&lt;Date&gt;'] + 'T' + sample[' &lt;Time&gt;'] + 'Z', "%m/%d/%YT%H:%M:%SZ")
    timestamp.add(ts)</span></pre>
<p class="callout-heading"><span class="koboSpan" id="kobo.286.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.287.1">The header format of the source file may be different. </span><span class="koboSpan" id="kobo.287.2">In the files that I use in this book, there are at least two different formats: plain words (</span><strong class="source-inline"><span class="koboSpan" id="kobo.288.1">'Open'</span></strong><span class="koboSpan" id="kobo.289.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.290.1">'High'</span></strong><span class="koboSpan" id="kobo.291.1">, etc.) and words in triangle brackets (</span><strong class="source-inline"><span class="koboSpan" id="kobo.292.1">&lt;Open&gt;</span></strong><span class="koboSpan" id="kobo.293.1">, etc.). </span><span class="koboSpan" id="kobo.293.2">Be careful and don’t forget to adapt this piece of code to the source data you’re going to </span><span class="No-Break"><span class="koboSpan" id="kobo.294.1">use yourself!</span></span></p>
<p><span class="koboSpan" id="kobo.295.1">If the date of the timestamp is not equal to that of the previous timestamp – meaning that a new day had started – we save the updated daily bar to the destination file and reinitialize </span><span class="No-Break"><span class="koboSpan" id="kobo.296.1">the bar:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.297.1">
    if timestamp.previous() != 0:
        if timestamp.last().date() != timestamp.previous().date():
            if bar['Open'] != 0:
                dest_file.write(','.join(map(str,[*bar.values()])) + "\n")
            bar = {'Date': timestamp.last().date(), 'Time': timestamp.last().time(), 'Open': open, 'High': high, 'Low': low, 'Close': close}</span></pre>
<p><span class="koboSpan" id="kobo.298.1">Finally, we update</span><a id="_idIndexMarker857"/><span class="koboSpan" id="kobo.299.1"> the currently </span><span class="No-Break"><span class="koboSpan" id="kobo.300.1">forming bar:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.301.1">
    bar['High'] = max([bar['High'], high])
    bar['Low'] = min([bar['Low'], low])
    bar['Close'] = close
    bar['Time'] = timestamp.last().time()</span></pre>
<p><span class="koboSpan" id="kobo.302.1">Don’t forget to close the destination file after the </span><strong class="source-inline"><span class="koboSpan" id="kobo.303.1">for</span></strong><span class="koboSpan" id="kobo.304.1"> loop </span><span class="No-Break"><span class="koboSpan" id="kobo.305.1">has finished:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.306.1">
dest_file.close()</span></pre>
<p><span class="koboSpan" id="kobo.307.1">If you run this code using the same AUDUSD 1-minute historical data as I used (you can find it on GitHub along with the code), you will get a CSV file with daily bars where the </span><strong class="source-inline"><span class="koboSpan" id="kobo.308.1">'Time'</span></strong><span class="koboSpan" id="kobo.309.1"> column features two different times: </span><strong class="source-inline"><span class="koboSpan" id="kobo.310.1">17:00</span></strong><span class="koboSpan" id="kobo.311.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.312.1">23:59</span></strong><span class="koboSpan" id="kobo.313.1">. </span><span class="koboSpan" id="kobo.313.2">Why </span><span class="No-Break"><span class="koboSpan" id="kobo.314.1">is that?</span></span></p>
<p><span class="koboSpan" id="kobo.315.1">In fact, this is a very important question that deserves an </span><span class="No-Break"><span class="koboSpan" id="kobo.316.1">insightful answer.</span></span></p>
<h2 id="_idParaDest-211"><a id="_idTextAnchor212"/><span class="koboSpan" id="kobo.317.1">Be careful with time!</span></h2>
<p><span class="koboSpan" id="kobo.318.1">No, this doesn’t mean that</span><a id="_idIndexMarker858"/><span class="koboSpan" id="kobo.319.1"> you should be looking at your watch every other minute. </span><span class="koboSpan" id="kobo.319.2">It means that when working with market data, time is the very thing that leads to confusion, especially in cases where you work with data from decentralized markets such </span><span class="No-Break"><span class="koboSpan" id="kobo.320.1">as forex.</span></span></p>
<p><span class="koboSpan" id="kobo.321.1">Working with data from a centralized exchange is somewhat easier: in this case, we always know in which time zone the exchange is located and its working hours. </span><span class="koboSpan" id="kobo.321.2">So, in any market data from that exchange, all timestamps will be in the same time zone as the exchange and only between market open </span><span class="No-Break"><span class="koboSpan" id="kobo.322.1">and close.</span></span></p>
<p><span class="koboSpan" id="kobo.323.1">With forex, it’s different. </span><span class="koboSpan" id="kobo.323.2">We know that there’s no single exchange in this market and that it works almost 24 hours, 5 days </span><span class="No-Break"><span class="koboSpan" id="kobo.324.1">a week.</span></span></p>
<p><em class="italic"><span class="koboSpan" id="kobo.325.1">Almost</span></em><span class="koboSpan" id="kobo.326.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.327.1">mind you.</span></span></p>
<p><span class="koboSpan" id="kobo.328.1">First, we must consider time zones. </span><span class="koboSpan" id="kobo.328.2">Every FX data vendor and every FX broker may deliver data in any time zone they think is correct. </span><span class="koboSpan" id="kobo.328.3">Most frequently used are GMT (UTC) or BST (UTC+1) for London, CET (UTC+1) or CEST (UTC+2) for Frankfurt, and EST (UTC-5) or EDT (UTC-4) for New York. </span><span class="koboSpan" id="kobo.328.4">You should check the data source about the time zone used before you do any manipulations </span><span class="No-Break"><span class="koboSpan" id="kobo.329.1">with timestamps.</span></span></p>
<p><span class="koboSpan" id="kobo.330.1">Second, we must consider working hours. </span><span class="koboSpan" id="kobo.330.2">Most FX trading venues open on Sunday at around 5 p.m. </span><span class="koboSpan" id="kobo.330.3">New York time (New York bank settlement time; see the </span><em class="italic"><span class="koboSpan" id="kobo.331.1">FX instruments</span></em><span class="koboSpan" id="kobo.332.1"> section of </span><a href="B19145_03.xhtml#_idTextAnchor044"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.333.1">Chapter 3</span></em></span></a><span class="koboSpan" id="kobo.334.1">, </span><em class="italic"><span class="koboSpan" id="kobo.335.1">FX Market Overview from a Developer’s Standpoint</span></em><span class="koboSpan" id="kobo.336.1">), but some may open at a later time. </span><span class="koboSpan" id="kobo.336.2">Same with the market close before the weekend: most venues close on Friday at that same time of 5 p.m. </span><span class="koboSpan" id="kobo.336.3">in New York, but some even offer weekend trading. </span><span class="koboSpan" id="kobo.336.4">We can’t consider this weekend trading seriously because the trading volume for weekend deals is negligible, but you may get hold of market data from a venue which provides weekend trading and this weekend data will add quite some confusion to your research process. </span><span class="koboSpan" id="kobo.336.5">If you plan to trade exotic currencies, most likely they will only be traded during the work hours of the respective state central bank or just a </span><span class="No-Break"><span class="koboSpan" id="kobo.337.1">bit longer.</span></span></p>
<p><span class="koboSpan" id="kobo.338.1">Besides regular working hours, there are exceptions, mostly around holidays. </span><span class="koboSpan" id="kobo.338.2">For example, don’t be surprised if you see an early close before or a late open </span><span class="No-Break"><span class="koboSpan" id="kobo.339.1">after Christmas.</span></span></p>
<p><span class="koboSpan" id="kobo.340.1">Third, we must consider how 0:00 time is interpreted. </span><span class="koboSpan" id="kobo.340.2">Some data providers treat this time as the start of a new day, while others believe it refers to the previous day. </span><span class="koboSpan" id="kobo.340.3">Moreover, some data providers even don’t have such a timestamp and the last time of the day in their data is 23:59 (for </span><span class="No-Break"><span class="koboSpan" id="kobo.341.1">1-minute data).</span></span></p>
<p><span class="koboSpan" id="kobo.342.1">This 0:00 time is quite confusing. </span><span class="koboSpan" id="kobo.342.2">When we work with data compressed in bars, the bar’s timestamp means the time when the bar closes. </span><span class="koboSpan" id="kobo.342.3">Therefore, 0:00 means that the bar closed at midnight. </span><span class="koboSpan" id="kobo.342.4">But it still represents price movements that happened before midnight, so they belong to the day that just finished! </span><span class="koboSpan" id="kobo.342.5">So, if you want to be absolutely precise when working with time, you may want to add some additional checks to your code that take into account the issues we’ve </span><span class="No-Break"><span class="koboSpan" id="kobo.343.1">just discussed.</span></span></p>
<p><span class="koboSpan" id="kobo.344.1">Now, let’s look at the data we used in our example and see what we actually did. </span><span class="koboSpan" id="kobo.344.2">This data is in the New York time zone, so the last time of the week is 17:00 – and this is what we see in the compressed daily data for every Friday. </span><span class="koboSpan" id="kobo.344.3">This data provider treats 0:00 as the first time of the new day, so since we divide days by date and do not take time into consideration, the last time of a day is </span><span class="No-Break"><span class="koboSpan" id="kobo.345.1">now 23:59.</span></span></p>
<p><span class="koboSpan" id="kobo.346.1">We may want to modify the new day conditions in the code of the bar-making utility. </span><span class="koboSpan" id="kobo.346.2">One of the possible solutions could be a condition </span><span class="No-Break"><span class="koboSpan" id="kobo.347.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.348.1">
if (timestamp.last().date() != timestamp.previous().date() and str(timestamp.last().time()) != '00:00:00') or (str(timestamp.previous().time()) == '00:00:00'):</span></pre>
<p><span class="koboSpan" id="kobo.349.1">If we now run the modified </span><a id="_idIndexMarker859"/><span class="koboSpan" id="kobo.350.1">code, we get correctly compressed data, but keep in mind that 0:00 timestamps now denote the end of the day, not </span><span class="No-Break"><span class="koboSpan" id="kobo.351.1">its beginning!</span></span></p>
<p><span class="koboSpan" id="kobo.352.1">Now we have all the data prepared and it’s time to try writing the code for our </span><span class="No-Break"><span class="koboSpan" id="kobo.353.1">first strategy.</span></span></p>
<h1 id="_idParaDest-212"><a id="_idTextAnchor213"/><span class="koboSpan" id="kobo.354.1">Trend-following strategy – implementation</span></h1>
<p><span class="koboSpan" id="kobo.355.1">Since we’re going to use</span><a id="_idIndexMarker860"/><span class="koboSpan" id="kobo.356.1"> the backtesting code that we developed in the previous chapter (see the </span><em class="italic"><span class="koboSpan" id="kobo.357.1">Backtesting platform with historical data feed</span></em><span class="koboSpan" id="kobo.358.1"> section in </span><a href="B19145_11.xhtml#_idTextAnchor186"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.359.1">Chapter 11</span></em></span></a><span class="koboSpan" id="kobo.360.1">, </span><em class="italic"><span class="koboSpan" id="kobo.361.1">Backtesting and Theoretical Performance</span></em><span class="koboSpan" id="kobo.362.1">), we need to add only small pieces of code that support the </span><span class="No-Break"><span class="koboSpan" id="kobo.363.1">required objects.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.364.1">Note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.365.1">Don’t forget to change the data source to the file with the daily AUDUSD data that we’ve </span><span class="No-Break"><span class="koboSpan" id="kobo.366.1">just created!</span></span></p>
<p><span class="koboSpan" id="kobo.367.1">Let’s start with adding the </span><strong class="source-inline"><span class="koboSpan" id="kobo.368.1">slidingWindow</span></strong><span class="koboSpan" id="kobo.369.1"> class to implement moving averages. </span><span class="koboSpan" id="kobo.369.2">Obviously, we copy it from the code in the preceding section. </span><span class="koboSpan" id="kobo.369.3">The code (as usual with class declaration) goes somewhere after the imports and before the declaration of the </span><span class="No-Break"><span class="koboSpan" id="kobo.370.1">first function:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.371.1">
class slidingWindow:
    def __init__(self, len):
        self.data = [0 for i in range(len)]
    def add(self, element):
        self.data.pop(0)
        self.data.append(element)</span></pre>
<p><span class="koboSpan" id="kobo.372.1">As you progress in developing various strategies, sooner or later you will find that many classes or functions are used in most strategies, so you can move them to a separate module and import the module into any </span><span class="No-Break"><span class="koboSpan" id="kobo.373.1">strategy prototype.</span></span></p>
<p><span class="koboSpan" id="kobo.374.1">We add two sliding windows to implement </span><span class="No-Break"><span class="koboSpan" id="kobo.375.1">moving averages:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.376.1">
data_window_small = slidingWindow(5)
data_window_large = slidingWindow(20)</span></pre>
<p><span class="koboSpan" id="kobo.377.1">Why </span><strong class="source-inline"><span class="koboSpan" id="kobo.378.1">5</span></strong><span class="koboSpan" id="kobo.379.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.380.1">20</span></strong><span class="koboSpan" id="kobo.381.1"> for periods of moving </span><a id="_idIndexMarker861"/><span class="koboSpan" id="kobo.382.1">averages? </span><span class="koboSpan" id="kobo.382.2">Well, no real reason in particular: when we work with daily data, </span><strong class="source-inline"><span class="koboSpan" id="kobo.383.1">5</span></strong><span class="koboSpan" id="kobo.384.1"> is usually used to represent a work week and </span><strong class="source-inline"><span class="koboSpan" id="kobo.385.1">20</span></strong><span class="koboSpan" id="kobo.386.1"> a work month. </span><span class="koboSpan" id="kobo.386.2">These values can often be found in technical analysis studies. </span><span class="koboSpan" id="kobo.386.3">Other popular periods are </span><strong class="source-inline"><span class="koboSpan" id="kobo.387.1">50</span></strong><span class="koboSpan" id="kobo.388.1"> (for a quarter) and </span><strong class="source-inline"><span class="koboSpan" id="kobo.389.1">200</span></strong><span class="koboSpan" id="kobo.390.1"> (for a year). </span><span class="koboSpan" id="kobo.390.2">In any case, this is only a draft, so we will be able to modify these values later, after having evaluated the </span><span class="No-Break"><span class="koboSpan" id="kobo.391.1">strategy performance.</span></span></p>
<p><span class="koboSpan" id="kobo.392.1">Then we have the function that actually calculates a </span><span class="No-Break"><span class="koboSpan" id="kobo.393.1">moving average:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.394.1">
def moving_average(data):
    return sum(data) / len(data)</span></pre>
<p><span class="koboSpan" id="kobo.395.1">All that we need to modify now is part of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.396.1">tradeLogic()</span></strong><span class="koboSpan" id="kobo.397.1"> function. </span><span class="koboSpan" id="kobo.397.2">It is the block of code between the </span><strong class="source-inline"><span class="koboSpan" id="kobo.398.1">trade logic starts here</span></strong><span class="koboSpan" id="kobo.399.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.400.1">trade logic ends </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.401.1">here</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.402.1"> comments:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.403.1">
        ####################################
        #     trade logic starts here     #
        ####################################</span></pre>
<p><span class="koboSpan" id="kobo.404.1">First of all, we retrieve a new closing price and add it to both sliding windows. </span><span class="koboSpan" id="kobo.404.2">Then we calculate the </span><span class="No-Break"><span class="koboSpan" id="kobo.405.1">moving averages:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.406.1">
        close = bar['Close']
        data_window_small.add(close)
        data_window_large.add(close)
        ma_small = moving_average(data_window_small.data)
        ma_large = moving_average(data_window_large.data)</span></pre>
<p><span class="koboSpan" id="kobo.407.1">Now the main part: the entry</span><a id="_idIndexMarker862"/><span class="koboSpan" id="kobo.408.1"> condition. </span><span class="koboSpan" id="kobo.408.2">We sell if the close is below the short-period MA and the short-period MA is below the long-period MA. </span><span class="koboSpan" id="kobo.408.3">Don’t forget that we do that only if we don’t have an open short position already (see the </span><em class="italic"><span class="koboSpan" id="kobo.409.1">Trading application with live data feed</span></em><span class="koboSpan" id="kobo.410.1"> section in </span><a href="B19145_11.xhtml#_idTextAnchor186"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.411.1">Chapter 11</span></em></span></a><span class="koboSpan" id="kobo.412.1">, </span><em class="italic"><span class="koboSpan" id="kobo.413.1">Backtesting and </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.414.1">Theoretical Performance</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.415.1">):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.416.1">
        if close &lt; ma_small and ma_small &lt; ma_large and System.market_position &gt;= 0:</span></pre>
<p><span class="koboSpan" id="kobo.417.1">The rest of the trade logic code in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.418.1">'Sell'</span></strong><span class="koboSpan" id="kobo.419.1"> clause remains untouched, and I have reproduced it here only to </span><span class="No-Break"><span class="koboSpan" id="kobo.420.1">maintain integrity:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.421.1">
            order = {}
            order['Type'] = 'Market'
            order['Price'] = close
            order['Side'] = 'Sell'
            if System.market_position == 0:
                order['Size'] = 10000
            else:
                order['Size'] = 20000
            orders_stream.put(order)</span></pre>
<p><span class="koboSpan" id="kobo.422.1">And symmetrical for a buy order: we buy when the close is greater than the short-period MA and the short-period MA is greater than the </span><span class="No-Break"><span class="koboSpan" id="kobo.423.1">long-period MA:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.424.1">
        if close &gt; ma_small and ma_small &gt; ma_large and System.market_position &lt;= 0:
            order = {}
            order['Type'] = 'Market'
            order['Price'] = close
            order['Side'] = 'Buy'
            if System.market_position == 0:
                order['Size'] = 10000
            else:
                order['Size'] = 20000
            orders_stream.put(order)
        ####################################
        #      trade logic ends here      #
        ####################################</span></pre>
<p><span class="koboSpan" id="kobo.425.1">This is it. </span><span class="koboSpan" id="kobo.425.2">Nothing else needs </span><span class="No-Break"><span class="koboSpan" id="kobo.426.1">any modification.</span></span></p>
<p><span class="koboSpan" id="kobo.427.1">Are you ready to test your first</span><a id="_idIndexMarker863"/><span class="koboSpan" id="kobo.428.1"> trading strategy? </span><span class="koboSpan" id="kobo.428.2">Let’s run the code and look at the </span><span class="No-Break"><span class="koboSpan" id="kobo.429.1">equity curve.</span></span></p>
<p><span class="koboSpan" id="kobo.430.1">If you did everything correctly so far, you should see an equity curve similar to the one shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.431.1">Figure 12</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.432.1">.3</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.433.1">.</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer124">
<span class="koboSpan" id="kobo.434.1"><img alt="Figure 12.3 – Equity curve of the backtest of the trend-following strategy using AUDUSD daily data" src="image/B19145_12_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.435.1">Figure 12.3 – Equity curve of the backtest of the trend-following strategy using AUDUSD daily data</span></p>
<p><span class="koboSpan" id="kobo.436.1">Not a bad start! </span><span class="koboSpan" id="kobo.436.2">In </span><a href="B19145_11.xhtml#_idTextAnchor186"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.437.1">Chapter 11</span></em></span></a><span class="koboSpan" id="kobo.438.1">, </span><em class="italic"><span class="koboSpan" id="kobo.439.1">Backtesting and Theoretical Performance</span></em><span class="koboSpan" id="kobo.440.1">, we talked about the equity curve and noted that traders (and investors, above all!) are looking for strategies that demonstrate consistent growth over time. </span><span class="koboSpan" id="kobo.440.2">Since our equity curve is a representation of our trend-following strategy PnL day by day, we can agree that this strategy indeed demonstrates growth </span><span class="No-Break"><span class="koboSpan" id="kobo.441.1">in equity.</span></span></p>
<p><span class="koboSpan" id="kobo.442.1">However, this result raises</span><a id="_idIndexMarker864"/><span class="koboSpan" id="kobo.443.1"> further questions. </span><span class="koboSpan" id="kobo.443.2">What is the meaning of the numbers on the </span><em class="italic"><span class="koboSpan" id="kobo.444.1">x</span></em><span class="koboSpan" id="kobo.445.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.446.1">y</span></em><span class="koboSpan" id="kobo.447.1"> axes? </span><span class="koboSpan" id="kobo.447.2">How do we interpret this result in terms of money or percent growth? </span><span class="koboSpan" id="kobo.447.3">Can we say that the growth demonstrated by the backtest is consistent? </span><span class="koboSpan" id="kobo.447.4">These and other questions will be discussed in the very </span><span class="No-Break"><span class="koboSpan" id="kobo.448.1">next chapter.</span></span></p>
<h1 id="_idParaDest-213"><a id="_idTextAnchor214"/><span class="koboSpan" id="kobo.449.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.450.1">Let’s quickly recap what we learned in this chapter. </span><span class="koboSpan" id="kobo.450.2">It indeed is the ultimate point where all the knowledge and skills we obtained in previous chapters unite and transform into a working trading application. </span><span class="koboSpan" id="kobo.450.3">More than that, in fact, we’ve got now a scalable </span><em class="italic"><span class="koboSpan" id="kobo.451.1">trading platform</span></em><span class="koboSpan" id="kobo.452.1"> suitable for both research and live trading. </span><span class="koboSpan" id="kobo.452.2">We suggested a robust design of the platform that keeps the architecture modular and scalable. </span><span class="koboSpan" id="kobo.452.3">We learned how to synchronize threads to ensure the correct order of execution of the platform modules while keeping these modules isolated. </span><span class="koboSpan" id="kobo.452.4">We saw practical examples of using various data sources that allow the platform to work with both live data feeds and historical data. </span><span class="koboSpan" id="kobo.452.5">We completely isolated the trade logic from the rest of the app so now we can develop a strategy using a backtest and then immediately copy and paste the code into the production version of our platform. </span><span class="koboSpan" id="kobo.452.6">Finally, using our knowledge of FX markets from previous chapters, we developed a simple trend-following strategy, tested it, and saw a </span><span class="No-Break"><span class="koboSpan" id="kobo.453.1">promising result.</span></span></p>
<p><span class="koboSpan" id="kobo.454.1">Now it’s time to analyze our result to get a full understanding of the strategy’s behavior </span><span class="No-Break"><span class="koboSpan" id="kobo.455.1">and performance.</span></span></p>
</div>
</body></html>