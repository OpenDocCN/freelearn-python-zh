<html><head></head><body>
  <div id="sbo-rt-content"><div class="chapter" title="Chapter 9. Advanced Techniques of Selenium WebDriver"><div class="titlepage"><div><div><h1 class="title"><a id="ch09"/>Chapter 9. Advanced Techniques of Selenium WebDriver</h1></div></div></div><p>So far in the book, we have seen how to set up Selenium WebDriver for testing web applications and some of the important features and APIs for locating and interacting with various elements in the browser.</p><p>In this chapter, we will explore some of the advanced APIs of Selenium WebDriver. These features come in handy when you're testing fairly complex applications.</p><p>In this chapter, you will learn more about:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating tests that simulate keyboard or mouse events using the <code class="literal">Actions</code> class</li><li class="listitem" style="list-style-type: disc">Simulating mouse operations such as drag-and-drop and double-click</li><li class="listitem" style="list-style-type: disc">Running JavaScript code</li><li class="listitem" style="list-style-type: disc">Capturing screenshots and movies of test runs</li><li class="listitem" style="list-style-type: disc">Handling browser navigation and cookies</li></ul></div><div class="section" title="Methods for performing keyboard and mouse actions"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec49"/>Methods for performing keyboard and mouse actions</h1></div></div></div><p>The Selenium WebDriver's advanced user interactions API allows us to perform operations from <a id="id551" class="indexterm"/>simple keyboard and mouse events to complex mouse events such as drag-and-drop, pressing a hotkey combination, holding a key, and <a id="id552" class="indexterm"/>performing mouse operations. This is accomplished by using the <code class="literal">ActionChains</code> class in the Selenium WebDriver Python API.</p><p>Here is a list of the important methods supported by the <code class="literal">ActionChains</code> class for performing keyboard and mouse events:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Method</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th><th style="text-align: left" valign="bottom">
<p>Argument</p>
</th><th style="text-align: left" valign="bottom">
<p>Example</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">click(on_element=None)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id553" class="indexterm"/>method performs the <a id="id554" class="indexterm"/>click operation.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">on_element</code>: This is the element to click. If <code class="literal">None</code>, clicks on the current mouse position.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">click(main_link)</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">click_and_hold(on_element=None)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id555" class="indexterm"/>method holds down the left mouse <a id="id556" class="indexterm"/>button on an element.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">on_element</code>: This is the element to click and hold down the mouse button. If <code class="literal">None</code>, clicks on current mouse position.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">click_and_hold(gmail_link)</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">double_click(on_element=None) </code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id557" class="indexterm"/>method performs a double-click on an element.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">on_element</code>: This is the element <a id="id558" class="indexterm"/>to double-click. If <code class="literal">None</code>, clicks on current mouse position.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">double_click(info_box)</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">drag_and_drop(source, target)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id559" class="indexterm"/>method performs the drag-and-drop <a id="id560" class="indexterm"/>operation.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">source</code>: This is the element to mouse down.</p>
<p>
<code class="literal">target</code>: The element to mouse up.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">drag_and_drop(img, canvas)</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">key_down(value, element=None)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id561" class="indexterm"/>method sends a key press only, without releasing it. This <a id="id562" class="indexterm"/>should only be used with modifier keys (such as the <span class="emphasis"><em>Ctrl</em></span>, <span class="emphasis"><em>Alt</em></span>, and <span class="emphasis"><em>Shift</em></span> keys).</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">key</code>: This is the modifier key to send. Values are defined in the <code class="literal">Keys</code> class.</p>
<p>
<code class="literal">target</code>: The element to send keys. If <code class="literal">None</code>, sends a key to current focused element.</p>
</td><td rowspan="2" style="text-align: left" valign="top">
<p>
<code class="literal">key_down(Keys.SHIFT)\      send_keys('n')\            key_up(Keys.SHIFT)</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">key_up(value, element=None)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id563" class="indexterm"/>method releases a modifier <a id="id564" class="indexterm"/>key.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">key</code>: This is the modifier key to send. Values are defined in the <code class="literal">Keys</code> class.</p>
<p>
<code class="literal">target</code>: This is the element to send keys. If <code class="literal">None</code>, sends a key to current focused element.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">move_to_element(to_element)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id565" class="indexterm"/>method moves the mouse to the middle <a id="id566" class="indexterm"/>of an element.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">to_element</code>: This is the element to move to.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">move_to_element(gmail_link)</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">perform()</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id567" class="indexterm"/>method performs all stored <a id="id568" class="indexterm"/>actions.</p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>
<code class="literal">perform()</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">release(on_element=None)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id569" class="indexterm"/>method releases a held <a id="id570" class="indexterm"/>mouse button.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">on_element</code>: This is the element to mouse up</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">release(banner_img)</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">send_keys(keys_to_send)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id571" class="indexterm"/>method sends keys to an <a id="id572" class="indexterm"/>element that has current focus.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">keys_to_send</code>: This is the keys to send</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">send_keys("hello")</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">send_keys_to_element(element, keys_to_send)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This method sends keys to <a id="id573" class="indexterm"/>an element.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">element</code>: This <a id="id574" class="indexterm"/>is the element to send keys.</p>
<p>
<code class="literal">keys_to_send</code>: The keys to send.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">send_keys_to_element(firstName, "John")</code>
</p>
</td></tr></tbody></table></div><p>For a detailed list visit <a class="ulink" href="http://selenium.googlecode.com/git/docs/api/py/webdriver/selenium.webdriver.common.action_chains.html">http://selenium.googlecode.com/git/docs/api/py/webdriver/selenium.webdriver.common.action_chains.html</a>.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note19"/>Note</h3><p>The <code class="literal">Interactions</code> <a id="id575" class="indexterm"/>API is not supported on Safari. Also, there are limitations for certain events on various browsers. For more details, refer to <a class="ulink" href="https://code.google.com/p/selenium/wiki/AdvancedUserInteractions">https://code.google.com/p/selenium/wiki/AdvancedUserInteractions</a>.</p></div></div><div class="section" title="Keyboard actions"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec58"/>Keyboard actions</h2></div></div></div><p>Let's create a <a id="id576" class="indexterm"/>test that demonstrates how to use the keyboard actions such as pressing a hot key combination. In the sample app when we press the <span class="emphasis"><em>Shift</em></span> + <span class="emphasis"><em>N</em></span> key combination, a label will change its color, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions
from selenium.webdriver.common.action_chains import ActionChains
from selenium.webdriver.common.keys import Keys
import unittest


class HotkeyTest(unittest.TestCase):
    URL = "https://rawgit.com/jeresig/jquery.hotkeys/master/test-static-05.html"

    def setUp(self):
        self.driver = webdriver.Chrome()
        self.driver.get(self.URL)
        self.driver.implicitly_wait(30)
        self.driver.maximize_window()

    def test_hotkey(self):
        driver = self.driver

        shift_n_label = WebDriverWait(self.driver, 10).\
            until(expected_conditions.visibility_of_element_located((By.ID, "_shift_n")))

        ActionChains(driver).\
            key_down(Keys.SHIFT).\
            send_keys('n').\
            key_up(Keys.SHIFT).perform()
        self.assertEqual("rgba(12, 162, 255, 1)",
                         shift_n_label.value_of_css_property("background-color"))

    def tearDown(self):
        self.driver.close()

if __name__ == "__main__":
    unittest.main(verbosity=2)</pre></div><p>We can perform a hotkey press operation using the <code class="literal">ActionChains</code> class. In this example, we used a <a id="id577" class="indexterm"/>combination of <code class="literal">key_down()</code>, <code class="literal">send_key()</code>, and <code class="literal">key_up()</code> methods to perform <span class="emphasis"><em>Shift</em></span> + <span class="emphasis"><em>N</em></span> key press as if a real user has pressed these keys:</p><div class="informalexample"><pre class="programlisting">ActionChains(driver).\
    key_down(Keys.SHIFT).\
    send_keys('n').\
    key_up(Keys.SHIFT).perform()</pre></div><p>The <code class="literal">ActionChains</code> class requires the <code class="literal">driver</code> instance to be passed. We can then arrange the sequence of events by <a id="id578" class="indexterm"/>calling the available methods and executing the action calling the <code class="literal">perform()</code> method.</p></div><div class="section" title="The mouse movement"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec59"/>The mouse movement</h2></div></div></div><p>Here is another <a id="id579" class="indexterm"/>example that calls the mouse move event by calling the <code class="literal">move_to_element()</code> method of the <code class="literal">ActionChains</code> class. This is equivalent to the <code class="literal">onMouseOver</code> event. The <code class="literal">move_to_element()</code> method will move the mouse cursor from its current location to the supplied element.</p><div class="informalexample"><pre class="programlisting">from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions
from selenium.webdriver.common.action_chains import ActionChains
import unittest


class ToolTipTest (unittest.TestCase):
    def setUp(self):
        self.driver = webdriver.Firefox()
        self.driver.get("http://jqueryui.com/tooltip/")
        self.driver.implicitly_wait(30)
        self.driver.maximize_window()

    def test_tool_tip(self):
        driver = self.driver

        frame_elm = driver.find_element_by_class_name("demo-frame")
        driver.switch_to.frame(frame_elm)

        age_field = driver.find_element_by_id("age")
        ActionChains(self.driver).move_to_element(age_field).perform()

        tool_tip_elm = WebDriverWait(self.driver, 10)\            .until(expected_conditions.visibility_of_element_located((By.CLASS_NAME, "ui-tooltip-content")))

        # verify tooltip message
        self.assertEqual("We ask for your age only for statistical purposes.", tool_tip_elm.text)

    def tearDown(self):
        self.driver.close()

if __name__ == "__main__":
    unittest.main(verbosity=2)</pre></div><div class="section" title="The double_click method"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec23"/>The double_click method</h3></div></div></div><p>We can <a id="id580" class="indexterm"/>double-click on an element by calling the <code class="literal">double_click()</code> <a id="id581" class="indexterm"/>method of the <code class="literal">ActionChains</code> class in the following way:</p><div class="informalexample"><pre class="programlisting">from selenium import webdriver

from selenium.webdriver.common.action_chains import ActionChains
import unittest

class DoubleClickTest (unittest.TestCase):
    URL = "http://api.jquery.com/dblclick/"

    def setUp(self):
        self.driver = webdriver.Chrome()
        self.driver.get(self.URL)
        self.driver.maximize_window()

    def test_double_click(self):
        driver = self.driver
        frame = driver.find_element_by_tag_name("iframe")
        driver.switch_to.frame(frame)
        box = driver.find_element_by_tag_name("div")

        # verify color is Blue
        self.assertEqual("rgba(0, 0, 255, 1)",
                         box.value_of_css_property("background-color"))

        ActionChains(driver).move_to_element(
            driver.find_element_by_tag_name("span"))\
            .perform()

        ActionChains(driver).double_click(box).perform()

        # verify Color is Yellow
        self.assertEqual("rgba(255, 255, 0, 1)",
                         box.value_of_css_property("background-color"))

    def tearDown(self):
        self.driver.close()

if __name__ == "__main__":
    unittest.main(verbosity=2)</pre></div></div><div class="section" title="The drag_and_drop method"><div class="titlepage"><div><div><h3 class="title"><a id="ch09lvl3sec24"/>The drag_and_drop method</h3></div></div></div><p>In Selenium <a id="id582" class="indexterm"/>WebDriver, we can perform the drag-and-drop operation by calling the <code class="literal">drag_and_drop()</code> method of the <code class="literal">ActionChains</code> class. This method requires the source element that will be dragged, and the target element where the <a id="id583" class="indexterm"/>source element will be dropped. Here is an example of the <code class="literal">drag_and_drop</code> method:</p><div class="informalexample"><pre class="programlisting">from selenium import webdriver
from selenium.webdriver.common.action_chains import ActionChains
import unittest


class DragAndDropTest (unittest.TestCase):

    URL = "http://jqueryui.com/resources/demos/droppable/default.html"

    def setUp(self):
        self.driver = webdriver.Firefox()
        self.driver.get(self.URL)
        self.driver.maximize_window(30)
        self.driver.maximize_window()

    def test_drag_and_drop(self):
        driver = self.driver

        source = driver.find_element_by_id("draggable")
        target = driver.find_element_by_id("droppable")

        ActionChains(self.driver).drag_and_drop(source, target).perform()
        self.assertEqual("Dropped!", target.text)

    def tearDown(self):
        self.driver.close()

if __name__ == "__main__":
    unittest.main(verbosity=2)</pre></div></div></div></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Executing JavaScript"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec50"/>Executing JavaScript</h1></div></div></div><p>We can <a id="id584" class="indexterm"/>execute JavaScript code through Selenium WebDriver using the methods available from the <code class="literal">WebDriver</code> class. This is useful when we cannot perform certain operations using the Selenium WebDriver API or we want to test the JavaScript code.</p><p>The WebDriver <a id="id585" class="indexterm"/>class provides the following methods to execute JavaScript code:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Method</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th><th style="text-align: left" valign="bottom">
<p>Argument</p>
</th><th style="text-align: left" valign="bottom">
<p>Example</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">execute_async_script(script, *args)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id586" class="indexterm"/>method asynchronously executes <a id="id587" class="indexterm"/>JavaScript in the current window/frame.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">script</code>: This is the JavaScript code</p>
<p>
<code class="literal">args</code>: This is any arguments for the JavaScript code</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">driver.execute_async_script("return document.title")</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">execute_script(script, *args)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id588" class="indexterm"/>method synchronously executes JavaScript in the current window/frame.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">script</code>: This <a id="id589" class="indexterm"/>is the JavaScript code</p>
<p>
<code class="literal">args</code>: This is any arguments for the JavaScript code</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">driver.execute_script("return document.title")</code>
</p>
</td></tr></tbody></table></div><p>Let's create a test <a id="id590" class="indexterm"/>with a utility method, which <a id="id591" class="indexterm"/>highlights the elements before performing actions on these elements by using the JavaScript methods:</p><div class="informalexample"><pre class="programlisting">from selenium import webdriver
import unittest


class ExecuteJavaScriptTest (unittest.TestCase):  def setUp(self):
        # create a new Firefox session
        self.driver = webdriver.Firefox()
        self.driver.implicitly_wait(30)
        self.driver.maximize_window()

        # navigate to the application home page
        self.driver.get("http://demo.magentocommerce.com/")

    def test_search_by_category(self):

        # get the search textbox
        search_field = self.driver.find_element_by_name("q")
        self.highlightElement(search_field)
        search_field.clear()

        # enter search keyword and submit
        self.highlightElement(search_field)
        search_field.send_keys("phones")
        search_field.submit()

        # get all the anchor elements which have product names # displayed currently on result page using # find_elements_by_xpath method
        products = self.driver.find_elements_by_xpath("//h2[@class='product-name']/a")

        # check count of products shown in results
        self.assertEqual(2, len(products))

    def tearDown(self):
        # close the browser window
        self.driver.quit()

    def highlightElement(self, element):
        self.driver.execute_script("arguments[0].setAttribute('style', arguments[1]);",
        element, "color: green; border: 2px solid green;")
        self.driver.execute_script("arguments[0].setAttribute('style', arguments[1]);",
        element , "")

if __name__ == "__main__":
    unittest.main(verbosity=2)</pre></div><p>We can execute the JavaScript code by calling the <code class="literal">execute_script</code> method of the <code class="literal">WebDriver</code> class, as shown in the following example. We can also pass arguments to the JavaScript code through <a id="id592" class="indexterm"/>this method. In this example, we are modifying the border style for a moment and reverting that change back. This will highlight the given element with green border during the execution. It is useful to know which step is being executed on screen:</p><div class="informalexample"><pre class="programlisting">def highlightElement(self, element):
      self.driver.execute_script("arguments[0].setAttribute('style', arguments[1]);",
      element, "color: green; border: 2px solid green;")
      self.driver.execute_script("arguments[0].setAttribute('style', arguments[1]);",
      element , "")</pre></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Capturing screenshots of failures"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec51"/>Capturing screenshots of failures</h1></div></div></div><p>Capturing <a id="id593" class="indexterm"/>screenshots during the test run comes very handy when you want to communicate failures to the developers. It also helps in debugging tests or creating evidence of the test run. Selenium WebDriver comes with built-in methods to capture screenshots during the test run. The <code class="literal">WebDriver</code> class provides the <a id="id594" class="indexterm"/>following methods to capture and save a screenshot:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Method</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th><th style="text-align: left" valign="bottom">
<p>Argument</p>
</th><th style="text-align: left" valign="bottom">
<p>Example</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">Save_screenshot(filename)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id595" class="indexterm"/>method gets the screenshot of the <a id="id596" class="indexterm"/>current window and saves the image to the specified file.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">filename</code>: This is the path/name of the file to which the screenshot will be saved</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">Driver.save_screenshot("homepage.png")</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">get_screenshot_as_base64()</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id597" class="indexterm"/>method gets the screenshot of the current window <a id="id598" class="indexterm"/>as a base64 encoded string, which is useful in embedding images in HTML.</p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>
<code class="literal">driver.get_screenshot_as_base64()</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">get_screenshot_as_file(filename)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id599" class="indexterm"/>method gets the screenshot of the current window. It returns <code class="literal">False</code> if there is any <a id="id600" class="indexterm"/>IOError, else returns <code class="literal">Tr</code>
<code class="literal">ue</code>. It uses full paths in your filename.</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">filename</code>: This is the path/name of the file to which the screenshot will be saved</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">driver.get_screenshot_as_file('/results/screenshots/HomePage.png')</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">get_screenshot_as_png()</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id601" class="indexterm"/>method gets the screenshot of the current window <a id="id602" class="indexterm"/>as binary data.</p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>
<code class="literal">driver.get_screenshot_as_png()</code>
</p>
</td></tr></tbody></table></div><p>Let's create a test that captures a screenshot when it leads to failure. In this example, we'll locate an element that should be present on the application's home page. However, if the test doesn't find <a id="id603" class="indexterm"/>this element, it will throw <a id="id604" class="indexterm"/>
<code class="literal">NoSuchElementException</code> and take a screenshot of the page displayed in the browser window, which we can use for debugging or sending to a developer as evidence.</p><div class="informalexample"><pre class="programlisting">from selenium import webdriver
import datetime, time, unittest
from selenium.common.exceptions import NoSuchElementException


class ScreenShotTest(unittest.TestCase):
    def setUp(self):
        self.driver = webdriver.Firefox()
        self.driver.get("http://demo.magentocommerce.com/")

    def test_screen_shot(self):
        driver = self.driver
        try:
            promo_banner_elem = driver.find_element_by_id("promo_banner")
            self.assertEqual("Promotions", promo_banner_elem.text)
        except NoSuchElementException:
            st = datetime.datetime\
                .fromtimestamp(time.time()).strftime('%Y%m%d_%H%M%S')
            file_name = "main_page_missing_banner" + st + ".png"
            driver.save_screenshot(file_name)
            raise

    def tearDown(self):
        self.driver.close()

if __name__ == "__main__":
    unittest.main(verbosity=2)</pre></div><p>In this example, when the test doesn't find the promotion banner element, it takes a screenshot using the <code class="literal">save_screenshot()</code> method. We need to pass the path and name of the file to which the <a id="id605" class="indexterm"/>resulting image will be saved, as shown:</p><div class="informalexample"><pre class="programlisting">try:
    promo_banner_elem = driver.find_element_by_id("promo_banner")
    self.assertEqual("Promotions", promo_banner_elem.text)
except NoSuchElementException:
    st = datetime.datetime.fromtimestamp(time.time()).strftime('%Y%m%d_%H%M%S')
    file__name = "main_page_missing_banner" + st + ".png"
    <span class="strong"><strong>driver.save_screenshot(file__name)</strong></span>
    raise</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip13"/>Tip</h3><p>While capturing and saving the screenshot, it is recommended to use unique names for the image files such as including a timestamp and also using the <span class="strong"><strong>Portable Network </strong></span>
<a id="id606" class="indexterm"/>
<span class="strong"><strong>Graphics</strong></span> (<span class="strong"><strong>PNG</strong></span>) format for highest compression of the file, which also results in minimal file size.</p></div></div><div class="section" title="Recording a video of the test run"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec60"/>Recording a video of the test run</h2></div></div></div><p>Similar to <a id="id607" class="indexterm"/>capturing screenshots, recording a video of the test run helps in recording complete test sessions in a visual way. We can watch the recorded video to understand what happens during the test run. This can be used as evidence for other project stakeholders as well, or can also be used as demos.</p><p>Selenium WebDriver does not have built-in features to record video. Recording a video of the test run can be achieved by using a Python library called <code class="literal">Castro</code> separately. It was created by Jason Huggin, the creator of Selenium.</p><p>Castro is based on a <a id="id608" class="indexterm"/>cross-platform screen recording tool named <span class="strong"><strong>Pyvnc2swf</strong></span> (refer to <a class="ulink" href="http://www.unixuser.org/~euske/vnc2swf/pyvnc2swf.html">http://www.unixuser.org/~euske/vnc2swf/pyvnc2swf.html</a>). It captures the screen where the tests are running using the VNC protocol and generates a <span class="strong"><strong>Shockwave Flash</strong></span> (<span class="strong"><strong>SWF</strong></span>) <a id="id609" class="indexterm"/>movie file.</p><p>Castro also allows recording sessions from a remote machine using the VNC protocol. It needs a VNC program installed on the machine to record the videos. Before installing Castro we need PyGame library to be installed. The PyGame package cannot be installed with pip command and we need to get PyGame installer from <a class="ulink" href="http://www.pygame.org/download.shtml">http://www.pygame.org/download.shtml</a>.</p><p>We can install <a id="id610" class="indexterm"/>Castro using <code class="literal">pip</code> with the following command line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>pip install Castro</strong></span>
</pre></div><p>We also need to install or enable VNC on the desktop, where the tests will be executed. On Windows, we need to install a VNC program. <span class="strong"><strong>TightVNC</strong></span> (<a class="ulink" href="http://www.tightvnc.com/">http://www.tightvnc.com/</a>) will <a id="id611" class="indexterm"/>be a good choice. Install the TightVNC server and viewer on Windows.</p><p>On Ubuntu, go to <span class="strong"><strong>Settings</strong></span> | <span class="strong"><strong>Preference</strong></span> | <span class="strong"><strong>Remote Desktop</strong></span> and check the <span class="strong"><strong>Allow other users to view your </strong></span>
<a id="id612" class="indexterm"/>
<span class="strong"><strong>desktop</strong></span> checkbox. For Mac, we can install the Vine VNC server from <a class="ulink" href="http://www.testplant.com/products/vine/">http://www.testplant.com/products/vine/</a> or enable <span class="strong"><strong>Remote Desktop</strong></span> from <span class="strong"><strong>System Preferences</strong></span>.</p><p>Let's capture a video recording of the search test case that we created in the earlier chapters, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">import unittest
from selenium import webdriver
from castro import Castro

class SearchProductTest(unittest.TestCase):
    def setUp(self):
        # create an instance of Castro and provide name for the output # file
        self.screenCapture = Castro(filename="testSearchByCategory.swf")
        # start the recording of movie
        self.screenCapture.start()

        # create a new Firefox session
        self.driver = webdriver.Firefox()
        self.driver.implicitly_wait(30)
        self.driver.maximize_window()

        # navigate to the application home page
        self.driver.get("http://demo.magentocommerce.com/")

    def test_search_by_category(self):

        # get the search textbox
        search_field = self.driver.find_element_by_name("q")
        search_field.clear()

        # enter search keyword and submit
        search_field.send_keys("phones")
        search_field.submit()

        # get all the anchor elements which have product names # displayed
        # currently on result page using find_elements_by_xpath method
        products = self.driver.find_elements_by_xpath("//h2[@class='product-name']/a")

        # check count of products shown in results
        self.assertEqual(2, len(products))

    def tearDown(self):
        # close the browser window
        self.driver.quit()
        # Stop the recording
        self.screenCapture.stop()

if __name__ == '__main__':
    unittest.main(verbosity=2)</pre></div><p>To create a new video recording session, we need to create an Castro object and initialize the instance <a id="id613" class="indexterm"/>with the path and name of the capture file as an argument to the constructor. Screen capture is started with the <code class="literal">start()</code> method, which will record the entire screen until the <code class="literal">stop</code> method is called. Testing with the <code class="literal">setUp()</code> method is the best way to initialize the Castro instance and start the recording as shown in the following example:</p><div class="informalexample"><pre class="programlisting">def setUp(self):
      #Create an instance of Castro and provide name for the output # file
      <span class="strong"><strong>self.screenCapture = Castro(filename="testSearchByCategory.swf")</strong></span>
      <span class="strong"><strong># Start the recording of movie</strong></span>
      <span class="strong"><strong>self.screenCapture.start()</strong></span>
      
      # create a new Firefox session
      self.driver = webdriver.Firefox()
      self.driver.implicitly_wait(30)
      self.driver.maximize_window()

      # navigate to the application home page
      self.driver.get("http://demo.magentocommerce.com/")</pre></div><p>To stop the recording, call the <code class="literal">stop()</code> method. Again, the <code class="literal">teadDown()</code> method is a good place to call this method <a id="id614" class="indexterm"/>so that we can capture the entire test case, as shown in the following code:</p><div class="informalexample"><pre class="programlisting">def tearDown(self):
    # close the browser window
    self.driver.quit()
    <span class="strong"><strong># Stop the recording</strong></span>
    <span class="strong"><strong>self.screenCapture.stop()</strong></span>
</pre></div><p>If there are multiple tests in a class, we can initialize and stop the recording in the class level using the <code class="literal">setUp()</code> and <code class="literal">teardown()</code> methods instead of creating a new file for each test.</p></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Handling pop-up windows"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec52"/>Handling pop-up windows</h1></div></div></div><p>Testing <a id="id615" class="indexterm"/>pop-up windows involves identifying a pop-up window by its name attribute or window handle, switching the driver context to the desired pop-up window and then executing steps on the pop-up window, and finally switching back to the parent window.</p><p>When we create an instance of the browser from our tests, it is a parent window and any subsequent windows that are created from the parent window are called child windows or pop-up windows. We can work with any child window as long as it belongs to the current WebDriver context.</p><p>Here is an example <a id="id616" class="indexterm"/>of a pop-up window:</p><div class="mediaobject"><img src="images/3506OS_09_01.jpg" alt="Handling pop-up windows"/></div><p>Create a new test class <code class="literal">PopupWindowTest</code> with the test method <code class="literal">test_popup_window()</code> as shown in the following code:</p><div class="informalexample"><pre class="programlisting">from selenium import webdriver
import unittest


class PopupWindowTest(unittest.TestCase):

    URL = "https://rawgit.com/upgundecha/learnsewithpython/master/pages/Config.html"

    def setUp(self)    :
        self.driver = webdriver.Firefox()
        self.driver.get(self.URL)
        self.driver.maximize_window()

    def test_window_popup(self):
        driver = self.driver

        # save the WindowHandle of Parent Browser Window
        parent_window_id = driver.current_window_handle

        # clicking Help Button will open Help Page in a new Popup # Browser Window
        help_button = driver.find_element_by_id("helpbutton")
        help_button.click()
        driver.switch_to.window("HelpWindow")
        driver.close()
        driver.switch_to.window(parent_window_id)

    def tearDown(self):
        self.driver.close()

if __name__ == "__main__":
    unittest.main(verbosity=2)</pre></div><p>Before the context is moved to the child window, we can save the handle of the parent window using the <code class="literal">current_window_handle</code> property. We will use this value later to switch back to the parent window from the child window. We can switch to the child window by using its <a id="id617" class="indexterm"/>name or window handle by calling the <code class="literal">switch_to.window()</code> method of the <code class="literal">WebDriver</code> class. In this example, we are using the name of the window, as shown:</p><div class="informalexample"><pre class="programlisting">driver.switch_to_window("HelpWindow")</pre></div><p>After performing actions and checking on the help window, we can close it by calling the <code class="literal">close()</code> method and <a id="id618" class="indexterm"/>switch back to the parent window, as shown:</p><div class="informalexample"><pre class="programlisting">driver.close()

# switch back to Home page window using the handle
driver.switch_to_window(default_window)</pre></div></div></div>


  <div id="sbo-rt-content"><div class="section" title="Managing cookies"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec53"/>Managing cookies</h1></div></div></div><p>Cookies are important <a id="id619" class="indexterm"/>for any web applications to store information on the user's computer for a better user experience. Cookies are used to store user preferences, login information, and various other details of the client. The Selenium WebDriver API provides various methods to manage these cookies during testing. We can read cookie values, add cookies, and delete cookies during the test. This can be used to test how the application reacts when cookies are manipulated. The <code class="literal">WebDriver</code> class provides the following methods to manage cookies:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Method</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th><th style="text-align: left" valign="bottom">
<p>Argument</p>
</th><th style="text-align: left" valign="bottom">
<p>Example</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">add_cookie(cookie_dict)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id620" class="indexterm"/>method adds a <a id="id621" class="indexterm"/>cookie to the current session</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">cookie_dict</code>: This is a dictionary containing a cookie name and value pair</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">driver.add_cookie({"foo","bar"})</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">delete_all_cookies()</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id622" class="indexterm"/>method deletes all the cookies from the <a id="id623" class="indexterm"/>current session</p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>
<code class="literal">driver.delete_all_cookies()</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">delete_cookie(name)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id624" class="indexterm"/>method deletes a single cookie with the <a id="id625" class="indexterm"/>specified name</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">name</code>: This is the name of the cookie to be deleted</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">driver.delete_cookie("foo")</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">get_cookie(name)</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id626" class="indexterm"/>method gets a single cookie by the name and returns the dictionary for the <a id="id627" class="indexterm"/>cookie if found, none, if not</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">name</code>: This is the name of the cookie to search</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">driver.get_cookie("foo")</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">get_cookies() </code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id628" class="indexterm"/>method gets a set of dictionaries corresponding to cookies <a id="id629" class="indexterm"/>from the current session</p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top">
<p>
<code class="literal">driver.get_cookies()</code>
</p>
</td></tr></tbody></table></div><p>Here is an example that validates a cookie created to store the language selected by the user on the demo application's home page:</p><div class="informalexample"><pre class="programlisting">import unittest
from selenium import webdriver
from selenium.webdriver.support.ui import Select


class CookiesTest(unittest.TestCase):
    def setUp(self):
        # create a new Firefox session
        self.driver = webdriver.Firefox()
        self.driver.implicitly_wait(30)
        self.driver.maximize_window()

        # navigate to the application home page
        self.driver.get("http://demo.magentocommerce.com/")

    def test_store_cookie(self):
        driver = self.driver
        # get the Your language dropdown as instance of Select class
        select_language = \
            Select(self.driver.find_element_by_id("select-language"))

        # check default selected option is English
        self.assertEqual("ENGLISH", select_language.first_selected_option.text)
        # store cookies should be none
        store_cookie = driver.get_cookie("store")
        self.assertEqual(None, store_cookie)

         # select an option using select_by_visible text
        select_language.select_by_visible_text("French")

        # store cookie should be populated with selected country
        store_cookie = driver.get_cookie("store")['value']
        self.assertEqual("french", store_cookie)

    def tearDown(self):
        # close the browser window
        self.driver.quit()

if __name__ == '__main__':
    unittest.main(verbosity=2)</pre></div><p>We can retrieve the value of the cookie using the <code class="literal">get_cookie()</code> method of the <code class="literal">WebDriver</code> class. We need to <a id="id630" class="indexterm"/>pass the name of the cookie. This method returns a dictionary.</p></div></div>


  <div id="sbo-rt-content"><div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec54"/>Summary</h1></div></div></div><p>In this chapter, you learned about advanced features of Selenium WebDriver API for handling the keyboard and mouse events, capturing screenshots, recording videos, and handling cookies.</p><p>We used the <code class="literal">ActionChains</code> class to perform various keyboard and mouse operations. These features are very useful when dealing with applications that heavily use keyboard and mouse actions.</p><p>You saw how to run JavaScript code from your tests. This is a very powerful feature while dealing with applications that use Ajax and we can use the underlying JavaScript API from our scripts.</p><p>You captured screenshots for errors during test runs and also recorded a test session. This helps in debugging the tests as well as creating evidences for test runs.</p><p>Finally, you learned about the browser navigation methods and cookies.</p><p>In the next chapter, you will learn how to integrate our tests with other tools such as Continuous Integration tools to run the tests as part of the build process.</p></div></div>
</body></html>