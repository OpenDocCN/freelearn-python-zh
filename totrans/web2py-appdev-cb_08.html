<html><head></head><body>
  <div id="sbo-rt-content"><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Authentication and Authorization</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Customizing Auth</p></li><li class="listitem"><p>Using CAPTCHA on login failure</p></li><li class="listitem"><p>Using pyGravatar to get avatars for user profile pages</p></li><li class="listitem"><p>Multi-user and teacher modes</p></li><li class="listitem"><p>Authenticating with Facebook using OAuth 2.0</p></li></ul></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec01"/>Introduction</h1></div></div></div><p>Almost every application needs to be able to authenticate users and set permissions. web2py comes with an extensive and customizable role-based access control mechanism. In this chapter, we show you how to customize it by adding fields to the user table, adding<span class="strong"><strong> CAPTCHA</strong></span> security after repeated failed logins, and how to create<span class="strong"><strong> Globally Recognized Avatars</strong></span> (Gravatars&amp;mdash;icons representing the users). We also discuss the<code class="literal"> teacher</code> mode of web2py that allows students to share one web2py instance to develop and deploy their applications. Finally, we provide an example of integration with<span class="strong"><strong> OAuth 2.0</strong></span>, one of the newest protocols for federated authentication. Web2py also supports<code class="literal"> ofthe</code> protocols, such as CAS, OpenID, OAuth 1.0, LDAP, PAM, X509, and many more. But, once you learn one, it should be easy to learn the others using the official documentation.<a id="id284" class="indexterm"/>
</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec02"/>Customizing Auth</h1></div></div></div><p>There are two ways to customize Auth. The old way of doing it consists of defining a custom<code class="literal"> db.auth_user</code> table from scratch. A new way consists of letting web2py define the<code class="literal"> auth</code> table, but listing extra fields that web2py should include in the table. Here, we will review the latter method.<a id="id285" class="indexterm"/>
</p><p>Specifically, we will assume that each user must also have a username, a phone number, and an address.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec01"/>How to do it...</h2></div></div></div><p>In the<code class="literal"> db.py</code> model, replace the following line:<a id="id286" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">auth.define_tables()
</pre></div><p>Replace it with the following code:</p><div class="informalexample"><pre class="programlisting">
auth.settings.extra_fields['auth_user'] = [
	Field('phone_number',requires=IS_MATCH('\d{3}\-\d{3}\-\d{4}')),
	Field('address','text')]
auth.define_tables(username=True)
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec02"/>How it works...</h2></div></div></div><p>
<code class="literal">auth.settings.extra_fields</code> is a dictionary of extra fields. The<code class="literal"> key</code> is the name of the<code class="literal"> auth</code> table to which to add the extra fields. The<code class="literal"> value</code> is a list of extra fields. Notice that we have added two extra fields (phone_number and<code class="literal"> address)</code>, but not<code class="literal"> username</code>, here, for<code class="literal"> auth_user</code>.<a id="id287" class="indexterm"/>
</p><p>
<code class="literal">username</code> has to be treated in a special way, because it is involved in the authentication process, which is normally based on the<code class="literal"> email</code> field. By passing the username argument to the following line, we tell web2py that we want the<code class="literal"> username</code> field, and we want to use it for login instead of the<code class="literal"> email</code> field.</p><div class="informalexample"><pre class="programlisting">auth.define_tables(username=True)
</pre></div><p>The username will also be made unique.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec03"/>There's more...</h2></div></div></div><p>There may be cases when registration happens outside the normal registration form (for example, when using<code class="literal"> Janrain</code>, or when users are registered by the administrator). Yet you may need to force a new user, after their first login, to complete their registration. This can be done using a dummy hidden extra field,<code class="literal"> complete_registration</code> that is set to<code class="literal"> False</code>, by default, and is set to<code class="literal"> True</code> when they update their profile:</p><div class="informalexample"><pre class="programlisting">
auth.settings.extra_fields['auth_user'] = [
	Field('phone_number',requires=IS_MATCH('\d{3}\-\d{3}\-\d{4}'),
	comment = "i.e. 123-123-1234"),
	Field('address','text'),
	Field('complete_registration',default=False,update=True,
		writable=False, readable=False)]
uth.define_tables(username=True)
</pre></div><p>Then, we may want to force new users, upon login, to complete their registration. In<code class="literal"> db.py</code>, we can append the following code:</p><div class="informalexample"><pre class="programlisting">
if auth.user and not auth.user.complete_registration:
	if not (request.controller,request.function) == ('default','user'):
		redirect(URL('default','user/profile'))
</pre></div><p>This will force new users to edit their profile.</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec03"/>Using CAPTCHA on login failure</h1></div></div></div><p>web2py has built-in<span class="strong"><strong> ReCaptcha</strong></span> support (<a class="ulink" href="http://www.google.com/recaptcha">http://www.google.com/recaptcha</a>), but it is usually<code class="literal"> ON</code> or<code class="literal"> OFF</code>. It's useful to have it<code class="literal"> ON</code>, which prevents brute force attacks on the application forms, yet it can be annoying to regular users. Here, we propose a solution, a plugin that conditionally turns<code class="literal"> ON</code> ReCaptcha after a fixed number of login failures.<a id="id288" class="indexterm"/>
</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec04"/>How to do it...</h2></div></div></div><p>All you need to do is create a new<code class="literal"> models/plugin_conditionalrecaptcha.py</code>, which contains the following code, and your job is done:</p><div class="informalexample"><pre class="programlisting">
MAX_LOGIN_FAILURES = 3
# You must request the ReCaptcha keys
# in order to use this feature
RECAPTCHA_PUBLIC_KEY = ''
RECAPTCHA_PRIVATE_KEY = ''

def _():
	from gluon.tools import Recaptcha
	key = 'login_from:%s' % request.env.remote_addr
	num_login_attempts = cache.ram(key,lambda:0,None)
	
	if num_login_attempts &gt;= MAX_LOGIN_FAILURES:
		auth.settings.login_captcha = Recaptcha(
			request,RECAPTCHA_PUBLIC_KEY,RECAPTCHA_PRIVATE_KEY)
		
		def login_attempt(form,key=key,n=num_login_attempts+1):
			cache.ram(key,lambda n=n:n,0)
			
		def login_success(form,key=key):
			cache.ram(key,lambda:0,0)
			
		auth.settings.login_onvalidation.append(login_attempt)
		auth.settings.login_onaccept.append(login_success)
_()
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec05"/>There's more...</h2></div></div></div><p>You can customize the ReCaptcha appearance, by passing parameters to it through JavaScript. If you are using the default user controller for exposing<code class="literal"> auth</code> login forms, you can simply edit the<code class="literal"> user.html</code> view, and add the following code:</p><div class="informalexample"><pre class="programlisting">
&lt;script&gt;
var RecaptchaOptions = {
	theme : 'clean',
	tabindex : 2
};
&lt;/script&gt;
</pre></div><p>Add it before the following line:</p><div class="informalexample"><pre class="programlisting">{{=form}}
</pre></div><p>The full ReCaptcha client API can be viewed at the following URL:<a id="id289" class="indexterm"/>
</p><p>
<a class="ulink" href="http://recaptcha.net/apidocs/captcha/client.html">http://recaptcha.net/apidocs/captcha/client.html</a>
</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec04"/>Using pyGravatar to get avatars for user profile pages</h1></div></div></div><p>First download<span class="strong"><strong> pyGravatar</strong></span> from the following URL:<a id="id290" class="indexterm"/>
</p><p>
<a class="ulink" href="http://https://bitbucket.org/gridaphobe/pygravatar/src">https://bitbucket.org/gridaphobe/pygravatar/src</a>
</p><p>Put the<code class="literal"> gravatar.py</code> in<code class="literal"> applications/yourapp/modules</code>. If you prefer, you can use the following command:</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong>pip install pyGravatar</strong></span>
</pre></div><p>In any of your models source files, you have to import the Gravatar library to be able to use it, as shown in the following example:</p><div class="informalexample"><pre class="programlisting">from gravatar import Gravatar
</pre></div><p>If you are using the scaffold application, edit the<code class="literal"> default/user.html</code> view, as follows:</p><div class="informalexample"><pre class="programlisting">
{{extend 'layout.html'}}
&lt;h3&gt;{{=T( request.args(0).replace('_',' ').capitalize() )}}&lt;/h3&gt;
&lt;div id="web2py_user_form"&gt;
{{if 'profile' in request.args:}}
	&lt;img src="{{=Gravatar(auth.user.email).thumb}}" /&gt;
{{pass}}
</pre></div><p>You will now have a profile page that will look like the following screenshot:</p><div class="mediaobject"><img src="images/5467OS_08_40.jpg" alt="Using pyGravatar to get avatars for user profile pages"/></div><p>Now, in any page, if you want the user avatar, then you just need to use the following code:</p><div class="informalexample"><pre class="programlisting">&lt;img src='{{=Gravatar(auth.user.email).thumb}}' /&gt;
&lt;img src='{{=Gravatar('email@domain.com').thumb}}' /&gt;
</pre></div><p>You can go further and get the user profile bio from<a class="ulink" href="http://en.gravatar.com/"> http://en.gravatar.com/</a>. Add the following code to<code class="literal"> default/user.html</code>.<a id="id291" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
{extend 'layout.html'}}
&lt;h2&gt;{{=T( request.args(0).replace('_',' ').capitalize() )}}&lt;/h2&gt;
&lt;div id="web2py_user_form"&gt;
{{if 'profile' in request.args:}}
	{{user = Gravatar(auth.user.email)}}
	&lt;img src="{{=user.thumb}}" /&gt;
	&lt;blockquote style='width:300px;'&gt;
	
		{{try:}}
			{{=user.profile['aboutMe']}}
			
		{{except Exception:}}
			No profile information
		{{pass}}
		
	&lt;/blockquote&gt;
{{pass}}
</pre></div><p>Then, you get the following:</p><div class="mediaobject"><img src="images/5467OS_08_41.jpg" alt="Using pyGravatar to get avatars for user profile pages"/></div><p>You can also get extra services that your user has registered in Gravatar, in the<code class="literal"> default/user.html</code> view:<a id="id292" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">
{extend 'layout.html'}}
&lt;div id="web2py_user_form"&gt;
{{if 'profile' in request.args:}}
	{{user = Gravatar(auth.user.email)}}
	&lt;img src="{{=user.thumb}}" /&gt;
	&lt;blockquote style='width:300px;'&gt;
	
		{{try:}}
			{{=user.profile['aboutMe']}}
			{{services = user.profile.get('accounts', {})}}
			{{=UL(*[LI(A(service['shortname'], _href=service['url'])) for
				service in services])}}
				
		{{except Exception:}}
			No profile information
			
			{{pass}}
	&lt;/blockquote&gt;
{{pass}}
</pre></div><p>And then, you will see the additional information (about me and URL of registered services), in your web page:<a id="id293" class="indexterm"/>
</p><div class="mediaobject"><img src="images/5467OS_08_42.jpg" alt="Using pyGravatar to get avatars for user profile pages"/></div><p>Tell your users to register in<a class="ulink" href="http://en.gravatar.com/"> http://en.gravatar.com/</a>, using the same e-mail address used in your application.<a id="id294" class="indexterm"/>
</p></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec05"/>Multi-user and teacher modes</h1></div></div></div><p>Since version 1.92, you can set up web2py in a<code class="literal"> mult-iuser</code> or<code class="literal"> teaching</code> mode. There is one instance of web2py installed on a system, one account is the<code class="literal"> admin</code> (or<code class="literal"> teacher)</code>, and the other accounts are the<code class="literal"> students</code>. Students can only see their own applications. It works as follows: The admin page is changed and now contains a login and register header. The first user to log in, in this mode, gets the role of<code class="literal"> teacher</code>. Subsequent registrations will become<code class="literal"> students</code>, after approval by the<code class="literal"> teacher</code>. In the following recipe, I assume running web2py locally at<code class="literal"> 127.0.0.1</code> on port<code class="literal"> 8000</code>. The<code class="literal"> teacher</code> and the<code class="literal"> students</code> will need an<span class="strong"><strong> SSL-secured</strong></span> web2py instance. See<a class="link" href="ch11.html" title="Chapter 11. Other Tips and Tricks"> Chapter 11</a>,<span class="emphasis"><em> Other Tips and Tricks</em></span>, for more details.<a id="id295" class="indexterm"/>
</p><p>Note that in the<code class="literal"> multi-user</code> mode, there is no security mechanism to prevent interference between administrators.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec06"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Install web2py in a folder; let's say<code class="literal"> web2py_mu</code>.</p></li><li class="listitem"><p>Set<code class="literal"> MULTI_USER_MODE = True</code>, in<code class="literal"> admin/appadmin/0.py</code>.</p></li><li class="listitem"><p>Start web2py in the usual way, and click on the link for the administrative interface. Now you see the adapted administrative login.</p><p>Click register to create the teacher account. You now enter the admin application.
</p></li><li class="listitem"><p>Click on<code class="literal"> logout</code>, and click on<code class="literal"> register</code> to create the first<code class="literal"> student</code> account (you can let the students do this; provide them with the link).</p><p>After a student registers, his/her status is <span class="strong"><strong>Pending.Approving the students.</strong></span>
</p></li><li class="listitem"><p>Enter into the web2py<code class="literal"> appadmin</code>, of the admin application, using the following URL:<code class="literal"> http://127.0.0.1:8000/admin/appadmin</code>.</p></li><li class="listitem"><p>Click on the<code class="literal"> auth_user</code> table.</p><p>You're now looking at the teacher and students accounts. For each approved student:
</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Click on its ID (leftmost column)</p></li><li class="listitem"><p>Remove the word<span class="strong"><strong> pending</strong></span> in the field<code class="literal"> registration_key</code>
</p></li></ul></div></li></ol></div><p>If available, you can also import a list of students by using a CSV file (to be expanded upon).</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec07"/>There's more...</h2></div></div></div><p>For students just starting with Python and webapps, starting with a minimal application could be helpful. This simple setup will not include Ajax, and it will cover just minimal templating features.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="note07"/>Note</h3><p>On the right side, we need an extra option to load a minimal application, based on a file<code class="literal"> minimal.w2p</code>.</p></div><p>The components of<code class="literal"> appadmin</code> are not relevant for the beginning student, and intimidating, a configuration option<code class="literal"> BASIC_STUDENT</code> as<code class="literal"> False</code>, by default, could help. The teacher can turn this on, and at a later stage off. When<code class="literal"> False</code>, these files can be hidden from sight, the admin screen, the wizard, and other advanced options.<a id="id296" class="indexterm"/>
</p></div></div><div class="section"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec06"/>Authenticating with Facebook using OAuth 2.0</h1></div></div></div><p>The following recipe will show how to build a simple application that authenticates users using Facebook's OAuth 2.0 authentication service.<a id="id297" class="indexterm"/>
</p><p>OAuth 2.0 is the evolution of the OAuth 1.0a protocol. You can find the exact description of the protocol at the following URL:</p><p>
<a class="ulink" href="http://oauth.net/2">http://oauth.net/2</a>
</p><p>Without entering in details, the main object of the protocol is allowing sites (<span class="strong"><strong>providers</strong></span>) give trusted authentication credentials to other sites (<span class="strong"><strong>consumers</strong></span>). This is very similar in scope to CAS authentication system, which is already implemented by web2py.</p><p>At the moment, web2py implements OAuth 2.0 as consumer only. But, that is enough to allow any web2py application to authenticate against a provider of OAuth 2.0 services.</p><p>We show how to implement a small application that uses Facebook as OAuth 2.0 provider, since it is the provider that was tested more in depth.</p><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec08"/>Getting ready</h2></div></div></div><p>Before you start, you need to register an application on Facebook:</p><p>
<a class="ulink" href="http://developers.facebook.com">http://developers.facebook.com</a>
</p><div class="mediaobject"><img src="images/5467OS_08_39.jpg" alt="Getting ready"/></div><p>You must be careful about using the exact same URL (including the TCP port) that you use with the application.</p><p>Now, it is suggested that you use the Facebook Graph API Python library, to access the<code class="literal"> REST</code> interface in a programmatic way. This recipe uses that library. You can download it here: https://github.com/facebook/python-sdk. Copy it to the<code class="literal"> *modules*</code> directory of your application.</p><p>If you want to use the JSON engine that comes with web2py, change the<code class="literal"> import</code> code at the beginning of the file to look simply like the following (the other statements are not needed):<a id="id298" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting"># for web2py
from gluon.contrib import simplejson
_parse_json = lambda s: simplejson.loads(s)
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec09"/>How to do it...</h2></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Create a file containing the<span class="strong"><strong> App Id</strong></span> and the<span class="strong"><strong> App Secret</strong></span>, shown in the registration page. Save it in the<code class="literal"> modules</code> directory of you application, with the name<code class="literal"> fbappauth.py:</code>
</p><div class="informalexample"><pre class="programlisting">CLIENT_ID="xxxxxxxxxxxxxxxx"
CLIENT_SECRET="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
</pre></div></li><li class="listitem"><p>Now, you only need to change the<code class="literal"> auth</code> code in your model. You can put it in the usual<code class="literal"> db.py</code> model that comes with the scaffolding application.</p><div class="informalexample"><pre class="programlisting">
#########################################
## use fb auth
## for facebook "graphbook" application
#########################################

import sys, os
from fbappauth import CLIENT_ID,CLIENT_SECRET
from facebook import GraphAPI, GraphAPIError
from gluon.contrib.login_methods.oauth20_account import
OAuthAccount

class FaceBookAccount(OAuthAccount):
	"""OAuth impl for FaceBook"""
	AUTH_URL="https://graph.facebook.com/oauth/authorize"
	TOKEN_URL="https://graph.facebook.com/oauth/access_token"
	
def __init__(self, g):
	OAuthAccount.__init__(self, g, CLIENT_ID, CLIENT_SECRET,
		self.AUTH_URL, self.TOKEN_URL,
		scope='user_photos,friends_photos')
	self.graph = None
	
def get_user(self):
	'''Returns the user using the Graph API.'''
	if not self.accessToken():
		return None
		
	if not self.graph:
		self.graph = GraphAPI((self.accessToken()))
		user = None
		
	try:
		user = self.graph.get_object("me")
		except GraphAPIError, e:
			self.session.token = None
			self.graph = None
			
		if user:
			return dict(first_name = user['first_name'],
				last_name = user['last_name'],
				username = user['id'])
				
auth.settings.actions_disabled = ['register','change_password',
	'request_reset_password','profile']
auth.settings.login_form=FaceBookAccount(globals())
auth.settings.login_next=URL(f='index')
</pre></div><p>As you can see, this class specializes the generic <code class="literal">OAuthAccount</code> class from <code class="literal">gluon.contrib.login_methods.oauth20_account.py</code>, so that it can work with the Facebook authentication server.
</p></li></ol></div><p>The following line defines where the user lands after the authentication server has positively accepted the user identity. Change it to whatever you need.<a id="id299" class="indexterm"/>
</p><div class="informalexample"><pre class="programlisting">auth.settings.login_next=URL(f='index')
</pre></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec10"/>There's more...</h2></div></div></div><p>Often, you cannot test your application on the public server, where you will deploy the final application. Usually you can test it using<code class="literal"> localhost</code> or<code class="literal"> 127.0.0.1</code> as a host.</p><p>In the common case, using<code class="literal"> localhost</code> as hostname does not work with your application. Add the proper entry in<code class="literal"> /etc/hosts</code> (in the previous registered example application).</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong># fb app testing setup
127.0.0.1 bozzatest.example.com</strong></span>
</pre></div><p>But, be aware that, in either case, you need to use port<code class="literal"> 80</code> to avoid problems.</p><div class="informalexample"><pre class="programlisting"><span class="strong"><strong># python web2py.py -p 80 -a &lt;secret&gt;</strong></span>
</pre></div><p>This often requires administrator permissions when starting web2py, or using capabilities where your system supports them.</p></div></div></div></div>
</body></html>