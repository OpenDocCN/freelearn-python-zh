<html><head></head><body>
  <div><div><div><div><div><h1 class="title"><a id="ch10"/>Chapter 10. Customizing the CRM Application</h1></div></div></div><div><blockquote class="blockquote"><p>In this final chapter, we will add functionality to our framework to allow for some finishing touches.</p></blockquote></div><p>Specifically, we will see:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">What is needed to enhance the user interface to use the sort and filter capabilities in the framework</li><li class="listitem" style="list-style-type: disc">How we can provide the end user with the means to customize an application without the need to program</li><li class="listitem" style="list-style-type: disc">How to use these customizations to enhance the display of items and list of items</li><li class="listitem" style="list-style-type: disc">How to enhance the stored information with information from external sources such as Google Maps</li></ul></div><div><div><div><div><h1 class="title"><a id="ch10lvl1sec01"/>Time for action sorting</h1></div></div></div><p>When we implemented the<code class="literal"> Browse</code> class in<a class="link" href="ch08.html" title="Chapter 8. Managing Customer Relations"> Chapter 8</a>,<em> Managing Customer Relations</em>, together with the underlying functionality in the<code class="literal"> listids()</code> method of the<code class="literal"> AbstractEntity</code> class, we already took care of sorting and filtering.<a id="id422" class="indexterm"/>
</p><p>We did not yet allow for any user interaction to make it actually possible to sort the list of entities shown. What was missing was the JavaScript code and some CSS to make this happen. Take a look at the following screenshot and notice the small arrow icons next to some headers on top of the list of accounts:</p><div><img src="img/3746_10_01.jpg" height="83" alt="Time for action sorting"/></div><p>You can try the sort options for yourself when you run<code class="literal"> crm2.py</code>.<a id="id423" class="indexterm"/>
</p><p>Clicking once on a column marked with the small double arrows will sort the list on that specific column in ascending order. The header will change its background color to indicate that the list is now sorted and the small icon will change into a single up arrow.</p><p>Clicking it again will sort the list in descending order and this will be indicated by a small icon of a downward pointing arrow. A final click will render the list of items unsorted, as clicking the reset button will (not shown).</p><div><div><div><div><h2 class="title"><a id="ch10lvl2sec01"/>What just happened?</h2></div></div></div><p>This sorting behavior is implemented by a few small parts:<a id="id424" class="indexterm"/>
</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">jQuery click handlers associated with the table headers</li><li class="listitem" style="list-style-type: disc">Some CSS to style those headers with suitable icons</li><li class="listitem" style="list-style-type: disc">Minor changes to the Python code that produces the table to make it simpler to track the sorting state in the browser.</li></ul></div><p>First, let's see what has to be added to the JavaScript (the complete file is available as<code class="literal"> browse.js):</code>
</p><p>
<strong>Chapter10/browse.js</strong>
</p><div><pre class="programlisting">
$(".notsorted").live('click',function(){
	$("input[name=sortorder]").remove();
	$(".content form").first() 
	.append('&lt;input type="hidden" name="sortorder" value="' 
			+$("div.colname",this).text()+',asc"&gt;');
	$("button[name=first]").click();
}).live('mouseenter mouseleave',function(){
	$(this).toggleClass("ui-state-highlight");
});
$(".sorted-asc").live('click',function(){
	//alert('sorted-asc '+$(this).text())
	$("input[name=sortorder]").remove();<strong>
	$(".content form").first() 
	.append('&lt;input type="hidden" name="sortorder" value="' 
			+$("div.colname",this).text()+',desc"&gt;');</strong>
	$("button[name=first]").click();
}).live('mouseenter mouseleave',function(){
	$(this).toggleClass("ui-state-highlight");
});
$(".sorted-desc").live('click',function(){
	//alert('sorted-desc '+$(this).text())
	$("button[name=clear]").click();
}).live('mouseenter mouseleave',function(){
	$(this).toggleClass("ui-state-highlight");
});
</pre></div><p>Installing the click handlers is straightforward in itself, but what they have to accomplish is a little complicated.</p><p>The click handler must first determine which column will be used as the sort key. The element that is clicked on is available to the handler as<code class="literal"> this</code> and this will give us access to a<code class="literal">&lt;div&gt;</code> element within the header that contains the column's name. This<code class="literal">&lt;div&gt;</code> element is not shown because its<code class="literal"> display</code> attribute will be set to<code class="literal"> none</code>. It is added because we need access to the column's canonical name. The<code class="literal">&lt;th&gt;</code> element itself contains just the display name of the column, which may be different from its canonical name.</p><p>This sort key will have to be passed to the application server and to this end we will use the machinery already in place: if we trigger submission of the form with the navigation buttons and make sure the proper sort parameters are passed along, we're almost there. How can this be accomplished?</p><p>jQuery provides convenient methods to insert new HTML elements into the existing markup (highlighted). From the name of the column, we construct a suitable value by appending either<code class="literal"> asc</code> or<code class="literal"> desc</code> to it, separated by a comma and use this as the value of a new hidden input element with a name of<code class="literal"> sortorder</code> and insert this into the first<code class="literal">&lt;form&gt;</code> element with the<code class="literal"> append()</code> method. The first form in the page is the form element containing the navigation buttons.<a id="id425" class="indexterm"/>
</p><p>Because these same types of hidden<code class="literal">&lt;input&gt;</code> elements are used to maintain state when the user pages through the list of items, we first remove any<code class="literal">&lt;input&gt;</code> elements with a<code class="literal"> name</code> attribute equal to<code class="literal"> sortorder</code> to make sure these elements reflect the newly selected sort order and not any old one. The removal is accomplished by the aptly named<code class="literal"> remove()</code> method.</p><p>The final step is to submit the form. We could trigger the submit event itself but because we have several buttons with a<code class="literal"> type</code> attribute equal to<code class="literal"> submit</code>, we have to be more specific.</p><p>It is not possible to trigger a<code class="literal"> submit</code> event on a button, only on a form, but it is possible to trigger the<code class="literal"> click</code> event on a button, thus mimicking the user interaction. Once the<code class="literal"> click</code> event is triggered on the button with the<code class="literal"> name</code> attribute of<code class="literal"> first</code>, the form is submitted together with all its<code class="literal">&lt;input&gt;</code> elements, even hidden ones, including the new or replaced ones that indicate the sort order.</p><p>The handler for a<code class="literal">&lt;th&gt;</code> element that is already sorted in ascending order and marked by a<code class="literal"> sorted-asc</code> class is almost identical. The only change we make is that the value of the hidden<code class="literal">&lt;input&gt;</code> element with<code class="literal"> name=sortorder</code> is the column name with a<code class="literal"> ,desc</code> suffix instead of an<code class="literal"> ,asc</code> suffix.</p><p>Clicking on the<code class="literal">&lt;th&gt;</code> element when it is already sorted in descending order will cycle back to showing the unsorted state, so this click handler is even simpler as it just triggers the click handler of the clear button, which will result in an unsorted list.</p><p>The changes in the<code class="literal"> index()</code> method in the<code class="literal"> Browse</code> class are as follows (full code available as<code class="literal"> browse.py):</code>
</p><p>
<strong>Chapter10/browse.py</strong>
</p><div><pre class="programlisting">
yield '&lt;thead&gt;&lt;tr&gt;'
				for col in self.columns:
					if type(col) == str :
						sortclass="notsorted"
						iconclass="ui-icon ui-icon-triangle-2-n-s"
						for s in sortorder:
								if s[0]==col :
									sortclass='sorted-'+s[1]<strong>
									iconclass=' ui-icon ui-icon-
triangle-1-%s'%({'asc':'n','desc':'s'}[s[1]])</strong>
									break
						yield '&lt;th class="%s"&gt;&lt;div class="colname" 
style="display:none"&gt;%s&lt;/div&gt;'%(sortclass,col)+self.entity.
displaynames[col]+'&lt;span class="%s"&gt;&lt;span&gt;&lt;/th&gt;'%iconclass
				else :
						yield '&lt;th&gt;'+col.__name__+'&lt;/th&gt;'
		yield '&lt;/tr&gt;&lt;/thead&gt;\n&lt;tbody&gt;\n'
</pre></div><p>The Python code in our application barely has to change to accommodate this way of interaction. We merely adorn the<code class="literal">&lt;th&gt;</code> element of a column with a class that indicates the state of sorting.<a id="id426" class="indexterm"/>
</p><p>It's either<code class="literal"> notsorted, sorted-asc</code>, or<code class="literal"> sorted-desc</code>. We also insert a<code class="literal">&lt;div&gt;</code> element to hold the true name of the column and an empty<code class="literal">&lt;span&gt;</code> element flagged with suitable jQuery UI icon classes to hold the icons that signal the sorting state (highlighted).</p><p>The<code class="literal"> sortorder</code> list holds a number of tuples, each with the name of the column to sort as the first element and either<code class="literal"> asc</code> or<code class="literal"> desc</code> as the second element. This second element is used as the index into a dictionary that maps<code class="literal"> asc</code> to<code class="literal"> n</code> and<code class="literal"> desc</code> to<code class="literal"> s</code>, resulting in choosing either a<code class="literal"> ui-icon-triangle-1-n</code> or a<code class="literal"> ui-icon-triangle-1-s</code> class. Appending these classes together with a<code class="literal"> ui-icon</code> class is all we need to let the jQuery UI stylesheets render our<code class="literal">&lt;span&gt;</code> element with a meaningful icon.</p><div><h3 class="title"><a id="note40"/>Note</h3><p>Many arrow-like icons, available in jQuery UI, follow a naming pattern similar to those for the small triangles here. The final part indicates a compass direction (here<code class="literal"> n</code> for north, or upward) and the number indicates how many arrowheads are depicted in the icon (here just one, but there are many double-headed variants).</p></div><p>The resulting HTML for a column named<code class="literal"> time</code> that is currently sorted in ascending order, would look something like this:</p><div><pre class="programlisting">
&lt;th class="sorted-asc"&gt;
&lt;div class="colname" style="display:none"&gt;time&lt;/div&gt;
Time
&lt;span class="ui-icon ui-icon-triangle-1-n"&gt;&lt;span&gt;
&lt;/th&gt;
</pre></div><p>Besides the icon, we add some additional styles to<code class="literal"> base.css</code> to make the headers more visible:</p><p>
<strong>Chapter10/base.css</strong>
</p><div><pre class="programlisting">
th.notsorted { padding-right:1px; border:solid 1px #f0f0f0; }
th.sorted-asc { padding-right:1px; border:solid 1px #f0f0f0; 
background-color: #fff0f0; }
th.sorted-desc { padding-right:1px; border:solid 1px #f0f0f0; 
background-color: #fffff0; }
th span { float:right; }
</pre></div><p>The table headers themselves are merely styled with a light gray color, but floating the<code class="literal">&lt;span&gt;</code> element that will hold the icon to the right is important, otherwise it would move below the text in the column header instead of the side.<a id="id427" class="indexterm"/>
</p></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch10lvl1sec02"/>Time for action filtering</h1></div></div></div><p>Almost the same approach we used for sorting can be used for filtering as well, only this time it is not a single click on a column header that does the trick, but we must provide the user with a way to enter the filter values. Take a look at the following screenshot or filter the data yourself by running<code class="literal"> crm2.py</code> again:<a id="id428" class="indexterm"/>
</p><div><img src="img/3746_10_03.jpg" height="123" alt="Time for action filtering"/></div><p>If you insert values in any of the input fields below the columns in the table and click on the filter button (the one with the magnifying glass icon), the list of items to show is reduced to those items that match the filter values. Note that sorting and filtering may be combined and that clicking the clear button will remove both sorting and filtering settings.</p><div><div><div><div><h2 class="title"><a id="ch10lvl2sec02"/>What just happened?</h2></div></div></div><p>Let's have a look at the JavaScript code:</p><p>
<strong>Chapter10/browse.js</strong>
</p><div><pre class="programlisting">
$("button[name=search]").button({
	icons: {
		primary: "ui-icon-search"
		},
		text: false
}).click(function(){<strong>
		$("input[name=pattern]", $(".content form").first()).remove();</strong>
		$("input[name=pattern]").each(function(i,e){
			var val=$(e).val();
			var col=$(e).next().text();
			$(".content form").first() 
			.append(
			'&lt;input type="hidden" name="pattern" value="' 
			+col+','+val+'"&gt;');
	});
		$("button[name=first]").click();
});
</pre></div><p>Most of the work is done in the click handler of the search button. When the search button is clicked, we have to construct hidden<code class="literal">&lt;input&gt;</code> elements in the first form with a<code class="literal"> name</code> attribute equal to<code class="literal"> pattern</code> because it is those hidden filter inputs that will be passed to the server as arguments to the action URL when we trigger a submit of the form.<a id="id429" class="indexterm"/>
</p><p>Note the second argument to the jQuery function ($) that selects an<code class="literal">&lt;input&gt;</code> element (highlighted). Both the visible<code class="literal">&lt;input&gt;</code> elements provided for the user to enter pattern values and the hidden ones in the form containing the navigation buttons have the same<code class="literal"> name</code> attribute (pattern). We do not want to remove the visible ones as they contain the pattern values we are interested in. Therefore, we restrict the selection to the context of the first form, which is passed as the second argument.</p><p>After this, we are left with just the visible<code class="literal">&lt;input&gt;</code> elements which we iterate over with the<code class="literal"> .each()</code> method. We collect both, the value of the<code class="literal">&lt;input&gt;</code> element and the content of its next sibling, which will be a (hidden)<code class="literal">&lt;span&gt;</code> element containing the true name of the column to filter. Together, these are used to construct a new hidden<code class="literal">&lt;input&gt;</code> element that is appended to the form that will be submitted.</p><p>After the elements are inserted, we submit this form by triggering the click handler of the submit button with the<code class="literal"> name</code> attribute equal to<code class="literal"> first</code>.</p><p>
<strong>Chapter10/browse.py</strong>
</p><div><pre class="programlisting">
			yield '&lt;tfoot&gt;&lt;tr&gt;'
			for col in self.columns:
				if type(col)==str:
					filtervalue=dict(pattern).get(col,'')
					yield '''&lt;td&gt;&lt;input name="pattern" 
							value="%s"&gt;&lt;span 
							style="display:none"&gt;%s&lt;/span&gt; 
							&lt;/td&gt;'''%(filtervalue,col)
			yield '&lt;/tr&gt;&lt;/tfoot&gt;\n'
</pre></div><p>The only changes needed in the Python part of our web application are the insertion of suitable<code class="literal">&lt;input&gt;</code> elements that are initialized with the current pattern values to give a visible feedback to the user. The resulting HTML for a column that is currently filtered on the value ABC might look like this:<a id="id430" class="indexterm"/>
</p><div><pre class="programlisting">&lt;td&gt;
&lt;input name="pattern" value="ABC"&gt;
&lt;span style="display:none"&gt;name&lt;/span&gt;
&lt;/td&gt;
</pre></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch10lvl1sec03"/>Customization</h1></div></div></div><p>No matter how well designed and elaborate your application is, there is always more functionality that the user wants from it. Of course, with a proper framework in place and your code well documented, changes should not be a big problem, but on the other hand, you wouldn't want to restart an application just because some minor customizations are needed.</p><p>Many requests regarding an application will be concerned with the usability of the user interface, for example, different behavior of widgets or some additional features with regard to the information shown, like spell-checking entered text, finding stock market information related to a company shown, or the current exchange rate of a value on screen in a different currency. Quite a few companies including Microsoft, Yahoo!, and Google offer all sorts of free API's that may be used to enhance the display of values.</p></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch10lvl1sec04"/>Time for action customizing entity displays</h1></div></div></div><p>Say we want to offer the end user the possibility to locate an address on Google Maps by simply clicking a button next to an address. Run<code class="literal"> crmcustomize.py</code> and add a new address or edit an existing address. The edit/add screen will look similar to this:<a id="id431" class="indexterm"/>
</p><div><img src="img/3746_10_04.jpg" height="82" alt="Time for action customizing entity displays"/></div><p>When you click on the<strong> Map</strong> button, a new window will open, showing a map of that address as long as Google Maps was able to find it.</p><p>This functionality was added by the end user without the need to restart the server. Notice that in the opening screen, we have a new menu,<strong> Customize</strong>. If that menu is selected, we get a familiar looking interface showing a list of customizations added for different entities. If we double-click the one for<code class="literal"> Address</code> with the Google Maps description, we get an edit screen, as shown in the following illustration:<a id="id432" class="indexterm"/>
</p><div><img src="img/3746_10_05.jpg" height="204" alt="Time for action customizing entity displays"/></div><p>A quick glance will show that the customization itself is simply HTML mixed with some JavaScript that is added to the markup produced by the application each time we open an edit or add screen for an<code class="literal"> Address</code> entity.</p><div><h3 class="title"><a id="note41"/>Note</h3><p>It might not always be a good idea to allow any end user to customize an application. You might want to restrict some or all of the customization options to a subset of end users. Role-based access control is then again a suitable way to administer privileges.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec03"/>What just happened?</h2></div></div></div><p>Let's first have a look at the customization itself to get a feel of what can be accomplished. The code consists of a few lines of HTML and an embedded piece of JavaScript:<a id="id433" class="indexterm"/>
</p><p>
<strong>Chapter10/customization.html</strong>
</p><div><pre class="programlisting">
&lt;button id="showmap"&gt;Map&lt;/button&gt;
&lt;script&gt;
$("#showmap").click(function(){
	var url = "http://maps.google.com/maps?f=q&amp;q="
	url +=$("input[name=address]").val()+',';
	url +=$("input[name=city]").val()+',';
	url +=$("input[name=country]").val();
	window.open(url);
});
&lt;/script&gt;
</pre></div><p>Because our application itself relies on jQuery, any customization code may use this library as well, so after we have defined a suitable button, we add a click handler to this button (highlighted) that constructs a Google Maps URL from the values of several<code class="literal">&lt;input&gt;</code> elements that will be present on the edit or add page of an<code class="literal"> Address</code>, notably<code class="literal"> address, city</code>, and<code class="literal"> country</code>. This URL is then passed the<code class="literal"> window.open()</code> method to open a new screen or tab with the results of this query.</p><div><h3 class="title"><a id="note42"/>Note</h3><p>Even better results may be obtained when the Google Maps API is used see<a class="ulink" href="http://code.google.com/intl/nl/apis/maps/documentation/javascript"> http://code.google.com/intl/nl/apis/maps/documentation/javascript</a>.</p></div><p>What do we need to change in our framework to allow for this simple end user customization?</p><p>We need several related components to make this work:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The<code class="literal"> Display</code> class needs to be adapted to produce the custom code suitable for the instance that is shown.</li><li class="listitem" style="list-style-type: disc">We need some way of storing the customization in the database together with the rest of the application.</li><li class="listitem" style="list-style-type: disc">We need to allow a way to edit these customizations.</li></ul></div><p>Let's look at these requirements in detail. The most important part is a way to store this information. Like we did for role-based access control, we can actually use our framework again; this time by defining a<code class="literal"> custom</code> class. This<code class="literal"> custom</code> class will create a<code class="literal"> DisplayCustomization</code> class and provide access to it for all entities derived from the<code class="literal"> AbstractEntity</code> class. The changes needed in the entity module are modest (the full code is available in<code class="literal"> rbacentity.py):</code>
</p><p>
<strong>Chapter10/rbacentity.py</strong>
</p><div><pre class="programlisting">
class custom:
	def __init__(self,db):
		class CustomEntity(AbstractEntity):
			database=db
		class DisplayCustomization(CustomEntity):
			entity = Attribute(notnull= True, 
					displayname = "Entity")
			description = Attribute(displayname = "Description")
			customhtml = Attribute(displayname = "Custom HTML", 
						htmlescape=True, displayclass="mb-textarea")
		self.DisplayCustomization = DisplayCustomization
	def getDisplayCustomization(self):
		return self.DisplayCustomization
	def getDisplayCustomHTML(self,entity):
		return "".join(dc.customhtml for dc in self.
DisplayCustomization.list(pattern=[('entity',entity)]))
</pre></div><p>Now that we have access to this storage for customization, any application can use it, but it also has to provide a way to let the application user edit these customizations. This entails defining a<code class="literal"> Browse</code> class and adding a link to provide access to it. This is how it was done in the<code class="literal"> crmcustomize</code> application, shown in the example (relevant changes only, full code available in<code class="literal"> crmcustomize.py):</code>
<a id="id434" class="indexterm"/>
</p><p>
<strong>Chapter10/crmcustomize.py</strong>
</p><div><pre class="programlisting">
...
displaycustom = User._custom().getDisplayCustomization()
class DisplayCustomizationBrowser(Browse):
	edit = Display(displaycustom, edit=True, logon=logon)
	add = Display(displaycustom, add=True, logon=logon)
...
class Root():
	logon = logon
	user = UserBrowser(User)
	account = AccountBrowser(Account, 
				columns=Account.columns+[User,Address,Contact])
	contact = ContactBrowser(Contact, 
				columns=Contact.columns+[Address,Account])
	address = AddressBrowser(Address)
	displaycustomization = DisplayCustomizationBrowser(displaycustom, 
		columns=['entity','description'])
	@cherrypy.expose
	def index(self):
			return Root.logon.index(returnpage='../entities')
	@cherrypy.expose
	def entities(self):
		username = self.logon.checkauth()
		if username is None : raise HTTPRedirect('.')
		user=User.list(pattern=[('name',username)])
		if len(user) &lt; 1 : User(name=username)
		return basepage%'''&lt;div class="navigation"&gt;
		&lt;a href="user"&gt;Users&lt;/a&gt;
		&lt;a href="displaycustomization"&gt;Customize&lt;/a&gt;
		&lt;a href="http://account"&gt;Accounts&lt;/a&gt;
		&lt;a href="contact"&gt;Contacts&lt;/a&gt;
		&lt;a href="http://address"&gt;Addresses&lt;/a&gt;
		&lt;/div&gt;&lt;div class="content"&gt;
		&lt;/div&gt;
		&lt;script src="img/browse.js" type="text/javascript"&gt;&lt;/script&gt;
		'''
</pre></div><p>The final step is to enhance the display module with the means to retrieve and deliver these customizations. This is done by adding a few lines to the end of the<code class="literal"> index()</code> method, as shown:<a id="id435" class="indexterm"/>
</p><p>
<strong>Chapter10/display.py</strong>
</p><div><pre class="programlisting">
yield self.entity._custom().getDisplayCustomHTML('*')
yield self.entity._custom().getDisplayCustomHTML(self.entity.__name__)
</pre></div><p>Retrieving is straightforward enough and we actually retrieve two bits of customization: one for the specific entity we are showing and one for the customization code that is relevant for all entities. The user can add such customization with a special entity name of * (a single asterisk character). By putting the general customizations first in the markup we deliver, it is possible to override anything that is provided for the general case with customizations for the specific entities.</p><p>There is a bit of trickery needed elsewhere in the code of the<code class="literal"> Display</code> class, however. Because the customization code may consist of HTML, including<code class="literal">&lt;script&gt;</code> elements containing JavaScript and<code class="literal">&lt;style&gt;</code> elements containing CSS, we might run into trouble when we display the forms to edit the customization code as these forms are HTML themselves. We, therefore, need some way to escape this code to prevent the content of the input box from being interpreted as HTML.</p><p>This is accomplished in the following way (the relevant changes to the<code class="literal"> Attribute</code> class are shown):</p><p>
<strong>Chapter10/rbacentity.py</strong>
</p><div><pre class="programlisting">
class Attribute:
	def __init__(self,
			unique =False,
			notnull =False,
			default =None,
			affinity =None,
			validate =None,
			displayname =None,
			primary =False,
			displayclass =None,
			htmlescape =False):
			self.unique =unique
			self.notnull =notnull
			self.default =default
			self.affinity=affinity
			self.coldef = ( 
				affinity+' ' if not affinity is None else '') 
				+ ('unique ' if unique else '') 
				+ ('not null ' if notnull else '') 
				+ ('default %s '%default if not default is None else '')
			self.validate = validate?
			self.displayname = displayname
			self.primary = primary
			self.displayclass = displayclass
			self.htmlescape = htmlescape
</pre></div><p>The<code class="literal"> Attribute</code> class provided in the entity module is extended to take an extra<code class="literal"> htmlescape</code> parameter. If we set this to<code class="literal"> True</code>, we indicate that the contents of this attribute should be escaped prior to showing it in a page.<a id="id436" class="indexterm"/>
</p><p>The<code class="literal"> MetaEntity</code> class will have to be extended as well to act upon these new features in the<code class="literal"> Attribute</code> class:</p><p>
<strong>Chapter10/rbacentity.py</strong>
</p><div><pre class="programlisting">
classdict['htmlescape']={ k:v.htmlescape 
			for k,v in classdict.items() if type(v) == Attribute}
</pre></div><p>The<code class="literal"> MetaEntity</code> class is changed to store any<code class="literal"> htmlescape</code> attributes in the<code class="literal"> htmlescape</code> class attribute, a dictionary indexed by the attribute name.</p><p>At this point, we can create new entities with attributes marked for escape, but the<code class="literal"> Display</code> class itself has to act on this information. We therefore add the following lines to the<code class="literal"> index()</code> method of the<code class="literal"> Display</code> class:</p><p>
<strong>Chapter10/display.py</strong>
</p><div><pre class="programlisting">
val=getattr(e,c)
if self.entity.htmlescape[c] :
		val=escape(val,{'"':'&amp;quot;','\n':'
'})
		line='''&lt;input type="text" name="%s" 
				value="%s" 
				class="%s"&gt;'''%(c,val,displayclass)
</pre></div><p>In the<code class="literal"> index()</code> method of the<code class="literal"> Display</code> class, before constructing an<code class="literal">&lt;input&gt;</code> element we can now check this<code class="literal"> htmlescape</code> dictionary to see if we should escape the value of the attribute, and if so, use the<code class="literal"> escape()</code> function provided in Python's<code class="literal"> xml.sax.saxutils</code> module to convert any characters that might interfere.<a id="id437" class="indexterm"/>
</p><div><h3 class="title"><a id="note43"/>Note</h3><p><strong>A note of caution:</strong></p><p>Allowing people to customize an application with HTML and JavaScript carries an inherent risk. When we developed a wiki application, we restricted the allowed input on pages by scrubbing the input of unwanted HTML. If you are serious about security (and you should be!), you have to think about what you will allow for customizations as well, especially to prevent cross-site scripting (XSS). Check, for example,<a class="ulink" href="http://www.owasp.org/"> http://www.owasp.org/</a> for more on this and other security subjects.</p></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch10lvl1sec05"/>Time for action customizing entity lists</h1></div></div></div><p>Of course, if we offer the user the opportunity to customize the display of<em> individual</em> entities, it makes sense to offer the same functionality for lists of entities. If you run<code class="literal"> crm4.py</code> and click on the<strong> Contacts</strong> menu item, you will see a list as follows:<a id="id438" class="indexterm"/>
</p><div><img src="img/3746_10_06.jpg" height="49" alt="Time for action customizing entity lists"/></div><p>You will notice that in the column containing the telephone numbers, those beginning with a plus sign are shown in a bold font. This will give a visible hint that this is probably a foreign number that needs some special code on your telephone switch.</p><div><div><div><div><h2 class="title"><a id="ch10lvl2sec04"/>What just happened?</h2></div></div></div><p>The customization itself is a small piece of JavaScript that is inserted at the end of the page that shows the list of contacts:<a id="id439" class="indexterm"/>
</p><p>
<strong>Chapter10/customizationexample3.html</strong>
</p><div><pre class="programlisting">
&lt;script&gt;
var re = new RegExp("^\\s*\\+");<strong>
$("td:nth-child(4)").each(function(i){</strong>
	if($(this).text().match(re)){
		$(this).css({'font-weight':'bold'})
	};
});
&lt;/script&gt;
</pre></div><p>It uses jQuery to iterate over all<code class="literal">&lt;td&gt;</code> elements, which is the fourth child of their parent (a<code class="literal">&lt;tr&gt;</code> element, code highlighted). If the text contained in that element matches something that begins with optional whitespace and a plus sign (the regular expression itself is defined in the first line of the script), we set the<code class="literal"> font-weight</code> CSS attribute of that element to<code class="literal"> bold</code>.</p><p>Just as with the customization of<code class="literal"> Display</code>, we need to add some way to store the customizations. The alterations to the<code class="literal"> custom</code> class in the entity module are straightforward and copy the pattern set for<code class="literal"> Display</code> (the complete code is available in<code class="literal"> rbacentity.py):</code>
</p><p>
<strong>Chapter10/rbacentity.py</strong>
</p><div><pre class="programlisting">
def __init__(self):
		...
		class BrowseCustomization(CustomEntity):
			entity = Attribute(notnull= True, displayname = "Entity")
			description = Attribute(displayname = "Description")
			customhtml = Attribute(displayname = "Custom HTML", 
				htmlescape=True, displayclass="mb-textarea")
		self.BrowseCustomization = BrowseCustomization
		...
def getBrowseCustomization(self):
		return self.BrowseCustomization
def getBrowseCustomHTML(self,entity):
		return "".join(dc.customhtml 
		for dc in self.BrowseCustomization.list( 
					pattern=[('entity',entity)]))
</pre></div><p>The definition of the<code class="literal"> Browse</code> class in<code class="literal"> browse.py</code> needs to be extended as well to retrieve and deliver the customizations (shown are the relevant lines from<code class="literal"> browse.py):</code>
</p><p>
<strong>Chapter10/browse.py</strong>
</p><div><pre class="programlisting">
yield self.entity._custom().getBrowseCustomHTML('*')
yield self.entity._custom().getBrowseCustomHTML(self.entity.__name__)
</pre></div><p>And the final step is to provide the user with a link to edit the customizations. This is done in the main application (available as	<code class="literal"> crm4.py)</code> by adding these lines, again following the pattern set for the display customizations (the lines relevant for the browse customizations are highlighted):<a id="id440" class="indexterm"/>
</p><p>
<strong>Chapter10/crm4.py</strong>
</p><div><pre class="programlisting">
displaycustom = User._custom().getDisplayCustomization()<strong>
browsecustom = User._custom().getBrowseCustomization()</strong>
class DisplayCustomizationBrowser(Browse):
	edit = Display(displaycustom, edit=True, logon=logon)
	add = Display(displaycustom, add=True, logon=logon)<strong>
class BrowseCustomizationBrowser(Browse):
	edit = Display(browsecustom, edit=True, logon=logon)
	add = Display(browsecustom, add=True, logon=logon)</strong>
with open('basepage.html') as f:
	basepage=f.read(-1)
class Root():
	logon = logon
	user = UserBrowser(User)
	account = AccountBrowser(Account, 
				columns=Account.columns+[User,Address,Contact])
	contact = ContactBrowser(Contact, 
				columns=Contact.columns+[Address,Account])
	address = AddressBrowser(Address)
	displaycustomization = DisplayCustomizationBrowser( 
				displaycustom,columns=['entity','description'])<strong>
	browsecustomization = BrowseCustomizationBrowser( 
				browsecustom,columns=['entity','description'])</strong>
	@cherrypy.expose
	def index(self):
		return Root.logon.index(returnpage='../entities')
	@cherrypy.expose
	def entities(self):
		username = self.logon.checkauth()
	if username is None : raise HTTPRedirect('.')
	user=User.list(pattern=[('name',username)])
	if len(user) &lt; 1 : User(name=username)
	return basepage%'''&lt;div class="navigation"&gt;
	&lt;a href="user"&gt;Users&lt;/a&gt;
	&lt;a href="displaycustomization"&gt;Customize Item&lt;/a&gt;<strong>
	&lt;a href="http://browsecustomization"&gt;Customize List&lt;/a&gt;</strong>
	&lt;a href="http://account"&gt;Accounts&lt;/a&gt;
	&lt;a href="contact"&gt;Contacts&lt;/a&gt;
	&lt;a href="http://address"&gt;Addresses&lt;/a&gt;
	&lt;/div&gt;&lt;div class="content"&gt;
	&lt;/div&gt;
	&lt;script src="img/browse.js" type="text/javascript"&gt;&lt;/script&gt;
	'''
</pre></div><p>We are, of course, not restricted to actions on the client-side only. As we may utilize all the AJAX capabilities of jQuery, we can do quite elaborate things.<a id="id441" class="indexterm"/>
</p><p>Our entity browser already has the functionality to mark a row as selected if we click it a single time. However, we did not implement any useful action to go with this selection.</p><p>When we first implemented the<code class="literal"> Display</code> class, we added a<code class="literal"> delete()</code> method and exposed it to the CherryPy engine. We do not make use of this method in any way. Now that we can customize the entity browser, we can correct this and implement some functionality to add a button that when clicked will delete all selected entries. Mind you, it probably makes more sense to provide such basic functionality in a real application from the start, but it does show what is possible.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch10lvl1sec06"/>Time for action adding a delete button</h1></div></div></div><p>Run<code class="literal"> crm4.py</code> once more, and in the<strong> Customize List</strong> menu, add an item that applies to all entities (and hence is marked as '*') as follows:<a id="id442" class="indexterm"/>
</p><div><img src="img/3746_10_07.jpg" height="207" alt="Time for action adding a delete button"/></div><p>If we now open, for example, the list of contacts, we see a new button with a trashcan icon:<a id="id443" class="indexterm"/>
</p><div><img src="img/3746_10_08.jpg" height="138" alt="Time for action adding a delete button"/></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec05"/>What just happened?</h2></div></div></div><p>The customization we added consists of some HTML to define a<code class="literal">&lt;button&gt;</code> element and some JavaScript to render it as a nice trashcan button and to act on a click:</p><p>
<strong>Chapter10/customizationexample4.html</strong>
</p><div><pre class="programlisting">
&lt;button class="delete"&gt;delete&lt;/button&gt;
&lt;script&gt;
$("button.delete").click(function(){<strong>
	var url = $("form").last().attr('action')+'/delete';</strong>
	$("tr.selected").each(function(i){
			var id=$(this).attr('id');
			$.get(url,{'id':id});
	});
	$("input[name=cacheid]").remove();
	$("button[name=first]").click();
	false;
}).button({icons: { primary: "ui-icon-trash" },text: false});
&lt;/script&gt;
</pre></div><p>The click handler fetches the<code class="literal"> action</code> attribute from the last form in the list of entities (highlighted). This form holds the add button and this<code class="literal"> action</code> attribute will therefore point to the URL serviced by the<code class="literal"> index()</code> method of a<code class="literal"> Display</code> instance. We simply add<code class="literal"> delete</code> to it to make it point to the URL that will be serviced by the<code class="literal"> delete()</code> method.<a id="id444" class="indexterm"/>
</p><p>The next step is to iterate over all<code class="literal">&lt;tr&gt;</code> elements with a<code class="literal"> selected</code> class and use jQuery's<code class="literal"> get()</code> method to fetch the URL with the<code class="literal"> id</code> attribute from the<code class="literal">&lt;tr&gt;</code> element added as an argument.</p><p>Finally, we have to redisplay the list of entities to show the effects of the deletion. If the list was filtered and/or sorted, we would like to retain that, but we still have to remove the hidden<code class="literal">&lt;input&gt;</code> element that holds the<code class="literal"> cacheid</code>, otherwise we would be presenting the old list. After removing it, we trigger the click handler on the first button to initiate a reload.</p><p>Like almost every jQuery method, the<code class="literal"> click()</code> method returns the selected elements it was invoked on, so we can chain a<code class="literal"> button()</code> method to adorn our button element with a proper icon.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch10lvl1sec07"/>Summary</h1></div></div></div><p>This final chapter was all about polishing up our CRM application. We enhanced the user interface to utilize the sort and filter features of the underlying framework, reused the framework itself to store and manage user customizations, and showed how powerful these customizations can be by enhancing the display of items and list of items by retrieving data from Google Maps.</p></div></div>


  <div><div><div><div><div><h1 class="title"><a id="appA"/>Appendix A. References to Resources</h1></div></div></div><div><blockquote class="blockquote"><p>Without repeating each and every reference given in the book, this appendix lists a number of resources that give good and comprehensive information on various subjects of interest to people building web applications.</p></blockquote></div><div><div><div><div><h1 class="title"><a id="ch10lvl1sec08"/>Good old offline reference books</h1></div></div></div><p>Sometimes it's nice to leave the keyboard and just relax with a book (or e-reader) and do some reading about our favorite subjects. The following small selection of books is reference work I pick up regularly (some ISBNs may reflect the e-book version):</p><p>Especially for people familiar with Python, having some good books around about JavaScript and the jQuery libraries is very convenient. The following three books are good starters:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Learning JavaScript, Second Edition, Shelley Powers, O'Reilly, 978-0-596-52187-5</strong><a id="id445" class="indexterm"/><p>Comprehensive introduction to JavaScript basics.
</p></li><li class="listitem" style="list-style-type: disc"><strong>jQuery Cookbook, Cody Lindley, O'Reilly, 978-0-596-15977-1</strong><p>A large selection of practical examples of how to solve common requirements with jQuery.
</p></li><li class="listitem" style="list-style-type: disc"><strong>jQuery UI 1.7, Dan Wellman, Packt, 978-1-847199-72-0</strong><p>A step-by-step explanation of all the functionality of the jQuery UI library, including advanced features like drag-and-drop.
</p></li></ul></div><p>Python has very good documentation online. Especially the coverage of the standard modules distributed with Python is excellent, but to get a thorough insight into the language itself and the features added in version 3, this book is a good start:<strong> Programming in Python 3, Mark Summerfield, Addison Wesley, 978-0-32168056-3</strong>
</p><p>All of the following books cover Python subjects that play an important role in this book:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Python Testing Beginner's Guide, Daniel Arbuckle, Packt, 978-1847198-84-6</strong><p>Testing doesn't have to be difficult and this book shows why.
</p></li><li class="listitem" style="list-style-type: disc"><strong>CherryPy Essentials, Sylvain Hellegouarch, Packt, 978-1904811-84-8</strong><p>The CherryPy application server that we use extensively in the examples in this book is capable of much more. Written by its primary developer, this book covers all the features and gives practical examples of some web applications as well.
</p></li><li class="listitem" style="list-style-type: disc"><strong>Using SQLite, Jay A. Kreibich, O'Reilly, 978-0-596-52118-9</strong><a id="id446" class="indexterm"/><p>This book shows what SQLite is capable of and is even a good introduction to database design and the use of SQL. Not Python-specific (SQLite is used in many more places than Python alone).
</p></li><li class="listitem" style="list-style-type: disc"><strong>Mastering Regular Expressions, Third Edition, O'Reilly, 978-0-596-52812-6</strong><p>This book is everything there is to know about regular expressions. It's mostly not Python-specific, but as the regular expression library in Python closely resembles the one in Perl, almost all examples can be used as is in Python.
</p></li><li class="listitem" style="list-style-type: disc"><strong>CSS Mastery, Andy Budd, Friends of Ed, 978-159059-614-2</strong><p>Not all style issues are covered by jQuery UI of course and CSS can be tricky. This book is one of the most readable ones I've found.
</p></li></ul></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch10lvl1sec09"/>Additional websites, wikis, and blogs</h1></div></div></div><p>Additional information on the tools and resources used in the book can be found online.</p><div><div><div><div><h2 class="title"><a id="ch10lvl4sec01"/>Tools and frameworks</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://www.cherrypy.org/">http://www.cherrypy.org/</a><a id="id447" class="indexterm"/><p>The pure Python application server used in the examples in this book.
</p></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://projects.apache.org/projects/http_server.html">http://projects.apache.org/projects/http_server.html</a><p>Apache is much more than just a web server, but this links to this webserver workhorse directly.
<a id="id448" class="indexterm"/>
</p></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://jquery.com/">http://jquery.com/</a><p><a class="ulink" href="http://jqueryui.com/%20">http://jqueryui.com/
</a>
</p><p>All about the JavaScript libraries used throughout this book to spice up the user interface.
</p></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://www.prototypejs.org/">http://www.prototypejs.org/</a><p><a class="ulink" href="http://www.sencha.com/products/extjs/%20">http://www.sencha.com/products/extjs/
</a>
</p><p><a class="ulink" href="http://mootools.net/%20">http://mootools.net/
</a>
</p><p><a class="ulink" href="http://dojotoolkit.org/">http://dojotoolkit.org/
</a>
</p><p>Possible alternatives to the jQuery/jQuery UI libraries. Each has its own strengths and weaknesses.
</p></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://sqlite.org/">http://sqlite.org/</a><p><a class="ulink" href="http://wiki.python.org/moin/DatabaseInterfaces">http://wiki.python.org/moin/DatabaseInterfaces
</a>
</p><p>The home of the embedded database engine bundled with Python and a list of alternative database engines that work with Python.
<a id="id449" class="indexterm"/>
</p></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://www.aminus.net/dejavu">http://www.aminus.net/dejavu</a><p><a class="ulink" href="http://www.djangoproject.com/%20">http://www.djangoproject.com/
</a>
</p><p><a class="ulink" href="http://www.sqlalchemy.org/%20">http://www.sqlalchemy.org/
</a>
</p><p><a class="ulink" href="http://elixir.ematia.de/trac/%20">http://elixir.ematia.de/trac/
</a>
</p><p>Some quality object relational mappers.
</p></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://subversion.apache.org/">http://subversion.apache.org/</a><p><a class="ulink" href="http://git-scm.com/%20">http://git-scm.com/
</a>
</p><p>Both good! Widely used version management tools.
</p></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://code.google.com/apis/libraries/devguide.html">http://code.google.com/apis/libraries/devguide.html</a><p><a class="ulink" href="http://www.asp.net/ajaxlibrary/cdn.ashx%20">http://www.asp.net/ajaxlibrary/cdn.ashx
</a>
</p><p>Content delivery frameworks may reduce the load on your own web server significantly.
</p></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://pypi.python.org/pypi">http://pypi.python.org/pypi</a><p>The Python package index. Lists thousands of packages ready for use with Python. Check this first before reinventing the wheel.
</p></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://www.datatables.net/">http://www.datatables.net/</a><p><a class="ulink" href="http://www.appelsiini.net/projects/jeditable">http://www.appelsiini.net/projects/jeditable
</a>
</p><p>Two very capable jQuery plugins. Both are excellent examples of how to extend jQuery.
</p></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://getfirebug.com/">http://getfirebug.com/</a><p>An extension for the Firefox browser. Invaluable when debugging web applications.
</p></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://seleniumhq.org">http://seleniumhq.org</a><p>A tool to test user interfaces/web pages.
</p></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://www.owasp.org/index.php/Main_Page">http://www.owasp.org/index.php/Main_Page</a><p>Securing your application is very important. On this site, you will find information about general principles as well as specific attack patterns (and their remedies).
<a id="id450" class="indexterm"/>
</p></li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl4sec02"/>Newsfeeds</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://planet.python.org/">http://planet.python.org/</a><p>A large collection of blogs about Python.
</p></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://michelanders.blogspot.com/">http://michelanders.blogspot.com/</a><p>The author's blog about writing web applications in Python.
</p></li></ul></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="appB"/>Appendix B. Pop Quiz Answers</h1></div></div></div><div><div><div><div><h1 class="title"><a id="ch10lvl1sec10"/>Chapter 2, Creating a Simple Spreadsheet</h1></div></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec07"/>Serving content with CherryPy</h2></div></div></div><p>Answer:</p><p>Rename the<code class="literal"> index()</code> method to<code class="literal"> content()</code>
</p><p>Remember that in order to serve the content referred to by a URL such as<a class="ulink" href="http://127.0.0.1/content"> http://127.0.0.1/content</a>, CherryPy looks for a method named<code class="literal"> content()</code> in the object instance passed to the<code class="literal"> quickstart()</code> function. Later on, we will see that it is also possible to build hierarchies of classes that enable CherryPy to serve URLs like<code class="literal"> http://127.0.0.1/app/toplevel/content</code> as well.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec08"/>Adding an icon to a button</h2></div></div></div><p>Answer:</p><p>
<code class="literal">$("button").button({icons: {primary: 'ui-icon-refresh'}})</code>
</p><p>Like many jQuery and jQuery UI plugins, the button widget takes an<code class="literal"> options</code> object as an argument. This<code class="literal"> options</code> object may have a number of attributes, one of them the<code class="literal"> icons</code> attribute. The value of this attribute itself is an object again, its<code class="literal"> primary</code> attribute determining which of the many standard icons will be displayed on the button. Refer to the online documentation of the button widget to see all options:<a class="ulink" href="http://jqueryui.com/demos/button/"> http://jqueryui.com/demos/button/</a> and check jQuery UI's themeroller page at<a class="ulink" href="http://jqueryui.com/themeroller/"> http://jqueryui.com/themeroller/</a> for an overview of all available icons for a given theme.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec09"/>Adding conversions to a unitconverter instance</h2></div></div></div><p>Answer:</p><div><pre class="programlisting">$("#example").unitconverter({'cubic feet_litres':1.0/28.3168466 })
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec10"/>Changing option defaults</h2></div></div></div><p>Answer: b</p></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch10lvl1sec11"/>Chapter 3, Tasklist I: Persistence</h1></div></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec11"/>Session IDs</h2></div></div></div><p>Answer 1:</p><p>No, CherryPy will only save the session data to persistent storage if something is written to the session data while preparing a response. If an unknown session ID is received, the application cannot identify the user and will signal that to the client, but it will not store anything in the session data.</p><p>Answer 2:</p><p>c, because a client that doesn't store cookies will never send a request containing the session ID, the server will generate a new one.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec12"/>Styling screen elements</h2></div></div></div><p>Answer 1:</p><p>Either leave out the<code class="literal"> text:false</code> in the<code class="literal"> options</code> object passed to the<code class="literal"> button()</code> function or explicitly show it with<code class="literal"> text:true</code>.</p><p>Answer 2:</p><p>The<code class="literal">&lt;div&gt;</code> element that encloses the<code class="literal">&lt;form&gt;</code> element might be wider and an unsuitable background color may show up where the form isn't covering the full width.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch10lvl1sec12"/>Chapter 4, Tasklist II: Databases and AJAX</h1></div></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec13"/>Using variable selection criteria</h2></div></div></div><p>Answer:</p><p>
<code class="literal">cursor.execute('select * from task where user_id = ?',(username,))</code>
</p><p>A working implementation is available as<code class="literal"> taskdb3.py</code>. Note that because there may be more than one placeholder present in a query, we pass the actual values for these placeholders as a tuple. A peculiarity of the Python syntax demands that a tuple is defined as parentheses containing a comma separated list of expressions and that a tuple consisting of a single item still has to contain a comma.<code class="literal"> (username,)</code> is, therefore, a tuple with a single item.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec14"/>Spotting the error</h2></div></div></div><p>Answer:</p><p>
<code class="literal">test_number()</code>
</p><p>It will fail in the very first assertion with an output like the following:</p><div><pre class="programlisting">
python.exe test_factorial.py
.F.
======================================================================
FAIL: test_number (__main__.Test)
----------------------------------------------------------------------
Traceback (most recent call last):
File "test_factorial.py", line 7, in test_number
self.assertEqual(24,fac(4))
AssertionError: 24 != 12
----------------------------------------------------------------------
Ran 3 tests in 0.094s
FAILED (failures=1)
</pre></div><p>It still doesn't say what is wrong in the code, but now you know that the new implementation does not calculate the factorial of a number correctly. The solution might not be hard to spot this time: the<code class="literal"> range()</code> function should be passed<code class="literal"> 2</code> as its first argument, because only 0 and 1 are treated as special-case in the code</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch10lvl1sec13"/>Chapter 5, Entities and Relations</h1></div></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec15"/>How to check a class</h2></div></div></div><p>Answer:</p><p>Python's built-in function<code class="literal"> issubclass()</code> can provide the information we need. Checking, for example, the<code class="literal"> instance_a</code> attribute might be implemented like:</p><div><pre class="programlisting">if not issubclass(instance_a, Entity) : raise TypeError()
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec16"/>How to select a limited number of books</h2></div></div></div><p>Answer:</p><p>
<code class="literal">booksdb.list(offset=20,limit=10)</code>
</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch10lvl1sec14"/>Chapter 6, Building a Wiki</h1></div></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec17"/>Pop quiz</h2></div></div></div><p>Answer:</p><p>The<code class="literal"> id</code>, as it is unique as well.</p></div></div></div>
</body></html>