<html><head></head><body>
<section data-number="0.18" id="chapter-15-testing">
<h2 class="likechapterhead" data-number="0.18"><span><span class="kobospan" id="kobo.1.1">15</span></span><br class="tipbox1"/> <span id="x1-79400015"/><span class="kobospan" id="kobo.2.1">Testing</span></h2>
<p class="normal"><span class="kobospan" id="kobo.3.1">Testing is central to creating</span><span id="dx1-794001"/><span class="kobospan" id="kobo.4.1"> working software. </span><span class="kobospan" id="kobo.4.2">Here’s the canonical statement describing the importance of testing:</span></p>
<blockquote class="calibre8">
<p class="normal3"><span class="cmti-10x-x"><span class="kobospan" id="kobo.5.1">”Any program feature without an automated test simply doesn’t</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.6.1">exist”</span></span><span class="kobospan" id="kobo.7.1">.</span></p>
<p class="normal4"><span class="kobospan" id="kobo.8.1">(Kent Beck, </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.9.1">Extreme Programming Explained: Embrace</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.10.1">Change</span></span><span class="kobospan" id="kobo.11.1">)</span></p>
</blockquote>
<p class="normal1"><span class="kobospan" id="kobo.12.1">We can distinguish several kinds of testing:</span></p>
<p class="normal1"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.13.1">Unit testing:</span></span></p>
<p class="normal1"><span class="kobospan" id="kobo.14.1">This applies to independent</span><span id="dx1-794002"/> <span class="cmti-10x-x"><span class="kobospan" id="kobo.15.1">units </span></span><span class="kobospan" id="kobo.16.1">of software: functions, classes, or modules. </span><span class="kobospan" id="kobo.16.2">The unit is tested in isolation to confirm that it works correctly.</span></p>
<p class="normal1"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.17.1">Integration testing</span></span></p>
<p class="normal1"><span class="kobospan" id="kobo.18.1">: This combines units to be sure</span><span id="dx1-794003"/><span class="kobospan" id="kobo.19.1"> they integrate properly.</span></p>
<p class="normal1"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.20.1">System testing</span></span></p>
<p class="normal1"><span class="kobospan" id="kobo.21.1">: This tests an entire application</span><span id="dx1-794004"/><span class="kobospan" id="kobo.22.1"> or a system of interrelated applications to be sure that the suite of software</span><span id="dx1-794005"/><span class="kobospan" id="kobo.23.1"> components works properly. </span><span class="kobospan" id="kobo.23.2">This is</span><span id="dx1-794006"/><span class="kobospan" id="kobo.24.1"> also called </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.25.1">end-to-end testing </span></span><span class="kobospan" id="kobo.26.1">or </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.27.1">functional</span></span> <span class="cmbx-10x-x"><span class="kobospan" id="kobo.28.1">testing</span></span><span class="kobospan" id="kobo.29.1">. </span><span class="kobospan" id="kobo.29.2">This is often used for </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.30.1">acceptance testing </span></span><span class="kobospan" id="kobo.31.1">to confirm that software is fit</span><span id="dx1-794007"/><span class="kobospan" id="kobo.32.1"> for use.</span></p>
<p class="normal1"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.33.1">Performance testing</span></span></p>
<p class="normal1"><span class="kobospan" id="kobo.34.1">: This ensures that a unit, subsystem, or whole system</span><span id="dx1-794008"/><span class="kobospan" id="kobo.35.1"> meets performance objectives (also often known as </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.36.1">load testing</span></span><span class="kobospan" id="kobo.37.1">). </span><span class="kobospan" id="kobo.37.2">In some</span><span id="dx1-794009"/><span class="kobospan" id="kobo.38.1"> cases, performance testing includes the study of resources such as memory, threads, or file descriptors. </span><span class="kobospan" id="kobo.38.2">The goal is to be sure that software makes appropriate use of system resources. </span><span class="kobospan" id="kobo.38.3">This</span><span id="dx1-794010"/><span class="kobospan" id="kobo.39.1"> is sometimes called </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.40.1">benchmarking</span></span><span class="kobospan" id="kobo.41.1">, when the goal is to measure</span><span id="dx1-794011"/><span class="kobospan" id="kobo.42.1"> resource usage instead of ensuring that the usage is below some threshold.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.43.1">These are some of the more common types. </span><span class="kobospan" id="kobo.43.2">In this chapter, we’ll focus on unit testing since it is foundational to creating trust that software works reliably. </span><span class="kobospan" id="kobo.43.3">Other forms of testing rest on the foundation of reasonably complete unit tests.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.44.1">It’s sometimes helpful to summarize a test scenario following the Gherkin language. </span><span class="kobospan" id="kobo.44.2">In this test specification language, each scenario</span><span id="dx1-794012"/><span class="kobospan" id="kobo.45.1"> is described by </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.46.1">GIVEN-WHEN-THEN </span></span><span class="kobospan" id="kobo.47.1">steps. </span><span class="kobospan" id="kobo.47.2">Here’s an example:</span></p>
<pre class="programlisting" id="listing-91"><code class="calibre13"><span class="kobospan" id="kobo.48.1">Scenario: Binomial coefficient typical case. 
 
 
 
Given n = 52 
 
And k = 5 
 
When The binomial coefficient is computed with c = binom(n, k) 
 
Then the result, c, is 2,598,960</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.49.1">This approach to writing tests describes the given starting state or arrangement, an action to perform, and one or more assertions about the resulting state after the action. </span><span class="kobospan" id="kobo.49.2">This is sometimes</span><span id="dx1-794019"/><span class="kobospan" id="kobo.50.1"> called the ”arrange-act-assert” pattern.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.51.1">In this chapter, we’ll look at the following recipes:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><a href="ch019_split_000.xhtml#x1-7950001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.52.1">Using docstrings for testing</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch019_split_000.xhtml#x1-8040002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.53.1">Testing functions that raise exceptions</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch019_split_000.xhtml#x1-8100003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.54.1">Handling common doctest issues</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch019_split_000.xhtml#x1-8190004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.55.1">Unit testing with the unittest module</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch019_split_000.xhtml#x1-8250005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.56.1">Combining unittest and doctest tests</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch019_split_001.xhtml#x1-8310006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.57.1">Unit testing with the pytest module</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch019_split_001.xhtml#x1-8370007" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.58.1">Combining pytest and doctest tests</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch019_split_001.xhtml#x1-8430008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.59.1">Testing things that involve dates or times</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch019_split_001.xhtml#x1-8490009" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.60.1">Testing things that involve randomness</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch019_split_001.xhtml#x1-85500010" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.61.1">Mocking external resources</span></span></a></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.62.1">We’ll start by including tests within the docstring of a module, class, or function. </span><span class="kobospan" id="kobo.62.2">This makes the test case act as both documentation of the design intent and a verifiable confirmation that it really does work as advertised. </span><span id="x1-794020r1696"/></p>
<section data-number="0.18.1" id="using-docstrings-for-testing">
<h1 class="unnumbered" data-number="0.18.1"><span><span class="kobospan" id="kobo.63.1">15.1 </span></span> <span id="x1-7950001"/><span class="kobospan" id="kobo.64.1">Using docstrings for testing</span></h1>
<p class="normal"><span class="kobospan" id="kobo.65.1">Good Python includes docstrings</span><span id="dx1-795001"/><span class="kobospan" id="kobo.66.1"> inside every</span><span id="dx1-795002"/><span class="kobospan" id="kobo.67.1"> module, class, function, and method. </span><span class="kobospan" id="kobo.67.2">Many tools can create useful, informative documentation from docstrings. </span><span class="kobospan" id="kobo.67.3">Refer back to the </span><a href="ch007_split_001.xhtml#x1-2030007" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.68.1">Writing clear documentation strings</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.69.1">with RST markup</span></span></a><span class="kobospan" id="kobo.70.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.71.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.72.1"> </span></span><a href="ch007_split_000.xhtml#x1-1610003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.73.1">3</span></span></a><span class="kobospan" id="kobo.74.1"> for an example of how to create docstrings.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.75.1">One important element of a docstring is a concrete example. </span><span class="kobospan" id="kobo.75.2">The examples provided in docstrings can become unit-test cases</span><span id="dx1-795003"/><span class="kobospan" id="kobo.76.1"> that are exercised by Python’s </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.77.1">doctest </span></span><span class="kobospan" id="kobo.78.1">tool.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.79.1">In this recipe, we’ll look at ways to turn examples into proper automated test cases. </span><span id="x1-795004r1694"/></p>
<section data-number="0.18.1.1" id="getting-ready-110">
<h2 class="likechapterhead" data-number="0.18.1.1"><span><span class="kobospan" id="kobo.80.1">15.1.1 </span></span> <span id="x1-7960001"/><span class="kobospan" id="kobo.81.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.82.1">We’ll look at a small function definition as well as a class definition. </span><span class="kobospan" id="kobo.82.2">Each of these will contain docstrings that include examples that can be used as automated tests.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.83.1">We’ll use a function to compute the binomial coefficient of two numbers. </span><span class="kobospan" id="kobo.83.2">It shows the number of combinations of </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.84.1">n </span></span><span class="kobospan" id="kobo.85.1">things taken in groups of size </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.86.1">k</span></span><span class="kobospan" id="kobo.87.1">. </span><span class="kobospan" id="kobo.87.2">For example, how many ways a 52-card deck can be dealt into 5-card hands is computed like this:</span></p>
<div class="math-display">
<span class="kobospan" id="kobo.88.1"><img alt="( ) n = ----n!--- k k!(n− k)! " class="calibre9" src="../media/file80.png"/></span>
</div>
<p class="normal1"><span class="kobospan" id="kobo.89.1">This can be implemented by a Python function that looks like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.90.1">from math import factorial 
 
 
 
def binom_draft(n: int, k: int) -&gt; int: 
 
    return factorial(n) // (factorial(k) * factorial(n - k))</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.91.1">Functions, generally, have no internal state, making a function like this relatively easy to test. </span><span class="kobospan" id="kobo.91.2">This will be one of the examples used for showing the unit testing tools available.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.92.1">We’ll also look at a class that uses lazy calculation of the mean and median of a collection of numbers. </span><span class="kobospan" id="kobo.92.2">Objects often have internal state, defined by the various </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.93.1">self.</span></span></span></span><span class="kobospan" id="kobo.94.1"> attributes. </span><span class="kobospan" id="kobo.94.2">State changes are often difficult. </span><span class="kobospan" id="kobo.94.3">This is similar to the classes shown in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.95.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.96.1"> </span></span><a href="ch011_split_000.xhtml#x1-3760007" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.97.1">7</span></span></a><span class="kobospan" id="kobo.98.1">. </span><span class="kobospan" id="kobo.98.2">The </span><a href="ch011_split_000.xhtml#x1-3890003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.99.1">Designing classes with lots of processing</span></span></a><span class="kobospan" id="kobo.100.1"> and </span><a href="ch011_split_001.xhtml#x1-43100010" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.101.1">Using properties for lazy attributes</span></span></a><span class="kobospan" id="kobo.102.1"> recipes both have classes similar to this.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.103.1">Here is an outline</span><span id="dx1-796006"/><span class="kobospan" id="kobo.104.1"> of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.105.1">Summary</span></span></span></span><span class="kobospan" id="kobo.106.1"> class, with some implementation</span><span id="dx1-796007"/><span class="kobospan" id="kobo.107.1"> details omitted:</span></p>
<pre class="programlisting" id="listing-92"><code class="calibre13"><span class="kobospan" id="kobo.108.1">from collections import Counter 
 
 
 
class Summary: 
 
   def __init__(self) -&gt; None: 
 
       self.counts: Counter[int] = collections.Counter() 
 
 
 
   def __str__(self) -&gt; str: 
 
       ... 
 
 
 
   def add(self, value: int) -&gt; None: 
 
       self.counts[value] += 1 
 
 
 
   @property 
 
   def mean(self) -&gt; float: 
 
       ... 
 
 
 
   @property 
 
   def median(self) -&gt; float: 
 
        ...</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.109.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.110.1">add()</span></span></span></span><span class="kobospan" id="kobo.111.1"> method changes the internal state of a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.112.1">Summary</span></span></span></span><span class="kobospan" id="kobo.113.1"> object. </span><span class="kobospan" id="kobo.113.2">Because of this state change to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.114.1">self.counts</span></span></span></span><span class="kobospan" id="kobo.115.1"> attribute, we’ll need to provide more sophisticated examples to show how an instance of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.116.1">Summary</span></span></span></span><span class="kobospan" id="kobo.117.1"> class behaves. </span><span id="x1-796027r1700"/></p>
</section>
<section data-number="0.18.1.2" id="how-to-do-it...-111">
<h2 class="likechapterhead" data-number="0.18.1.2"><span><span class="kobospan" id="kobo.118.1">15.1.2 </span></span> <span id="x1-7970002"/><span class="kobospan" id="kobo.119.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.120.1">We’ll show two variations</span><span id="dx1-797001"/><span class="kobospan" id="kobo.121.1"> in this recipe. </span><span class="kobospan" id="kobo.121.2">The first variation</span><span id="dx1-797002"/><span class="kobospan" id="kobo.122.1"> can be applied to functions like the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.123.1">binom()</span></span></span></span><span class="kobospan" id="kobo.124.1"> function where there is no object with a mutable state. </span><span class="kobospan" id="kobo.124.2">The second is more appropriate for stateful operations, such as the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.125.1">Summary</span></span></span></span><span class="kobospan" id="kobo.126.1"> class. </span><span class="kobospan" id="kobo.126.2">We’ll look at them together because they’re very similar, even though they apply to different kinds of applications.</span></p>
<section data-number="0.18.1.2.1" id="writing-examples-for-functions">
<h3 class="likesubsubsectionhead" data-number="0.18.1.2.1"><span id="x1-7980002"/><span class="kobospan" id="kobo.127.1">Writing examples for functions</span></h3>
<p class="normal"><span class="kobospan" id="kobo.128.1">This recipe starts by creating</span><span id="dx1-798001"/><span class="kobospan" id="kobo.129.1"> the function’s docstring, and then adds an example of how the function works:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-798003x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.130.1">Start the docstring with a summary:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.131.1">def binom(n: int, k: int) -&gt; int: 
 
    """ 
 
    Computes the binomial coefficient. 
 
    This shows how many combinations exist of 
 
    *n* things taken in groups of size *k*.</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-798011x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.132.1">Include the parameter definitions and the return value definition:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.133.1">
    :param n: size of the universe 
 
    :param k: size of each subset 
 
    :returns: the number of combinations</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-798017x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.134.1">Mock up an example of using the function at Python’s </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.135.1">&gt;&gt;&gt;</span></span></span></span><span class="kobospan" id="kobo.136.1"> prompt:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.137.1">
    &gt;&gt;&gt; binom(52, 5) 
 
    2598960</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-798022x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.138.1">Close the docstring with the appropriate quotation marks:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.139.1">
    """</span></code></pre>
</div></li>
</ol>
</section>
<section data-number="0.18.1.2.2" id="writing-examples-for-stateful-objects">
<h3 class="likesubsubsectionhead" data-number="0.18.1.2.2"><span id="x1-7990002"/><span class="kobospan" id="kobo.140.1">Writing examples for stateful objects</span></h3>
<p class="normal"><span class="kobospan" id="kobo.141.1">This recipe also starts with writing</span><span id="dx1-799001"/><span class="kobospan" id="kobo.142.1"> a docstring. </span><span class="kobospan" id="kobo.142.2">The docstring will show several steps using the stateful object to show the object’s internal state changes:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-799003x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.143.1">Write a class-level docstring with a summary. </span><span class="kobospan" id="kobo.143.2">It can help to leave some blank lines in front of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.144.1">doctest</span></span></span></span><span class="kobospan" id="kobo.145.1"> example:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.146.1">class Summary: 
 
    """ 
 
    Computes summary statistics.</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-799009x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.147.1">Extend the class-level docstring with a concrete example of how the class works. </span><span class="kobospan" id="kobo.147.2">In this case, we’ll show how the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.148.1">add()</span></span></span></span><span class="kobospan" id="kobo.149.1"> method sets the state of the object. </span><span class="kobospan" id="kobo.149.2">We’ll also show how to interrogate the state of the object:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.150.1">
    &gt;&gt;&gt; s = Summary() 
 
    &gt;&gt;&gt; s.add(8) 
 
    &gt;&gt;&gt; s.add(9) 
 
    &gt;&gt;&gt; s.add(9) 
 
    &gt;&gt;&gt; round(s.mean, 2) 
 
    8.67 
 
    &gt;&gt;&gt; s.median 
 
    9 
 
    &gt;&gt;&gt; print(str(s)) 
 
    mean = 8.67 
 
    median = 9</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-799023x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.151.1">Finish with the triple quotes to end the docstring for this class:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.152.1">
    """</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.153.1">Because this example uses floating-point values, we’ve rounded the result of the mean in the docstring example. </span><span class="kobospan" id="kobo.153.2">Floating-point values might not have the exact same text representation on all platforms and an exact test for equality may fail unexpectedly.</span></p>
</section>
<section data-number="0.18.1.2.3" id="running-the-tests">
<h3 class="likesubsubsectionhead" data-number="0.18.1.2.3"><span id="x1-8000002"/><span class="kobospan" id="kobo.154.1">Running the tests</span></h3>
<p class="normal"><span class="kobospan" id="kobo.155.1">When we run</span><span id="dx1-800001"/><span class="kobospan" id="kobo.156.1"> the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.157.1">doctest </span></span><span class="kobospan" id="kobo.158.1">program, we’ll generally get a silent</span><span id="dx1-800002"/><span class="kobospan" id="kobo.159.1"> response because the test passed.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.160.1">The interaction looks like this:</span></p>
<pre class="programlisting" id="listing-93"><code class="calibre13"><span class="kobospan" id="kobo.161.1">(cookbook3) % python -m doctest recipe_01.py</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.162.1">When the tests pass, there is no output. </span><span class="kobospan" id="kobo.162.2">We can add a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.163.1">-v</span></span></span></span><span class="kobospan" id="kobo.164.1"> command-line option to see an enumeration of the tests run. </span><span class="kobospan" id="kobo.164.2">This can be helpful to confirm that all of the tests in the module were found.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.165.1">What happens when something doesn’t work? </span><span class="kobospan" id="kobo.165.2">We’ll modify a test case to have a wrong answer and force a failure. </span><span class="kobospan" id="kobo.165.3">When we run the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.166.1">doctest </span></span><span class="kobospan" id="kobo.167.1">program – using a broken test case – we’ll see output like this:</span></p>
<pre class="programlisting" id="listing-94"><code class="calibre13"><span class="kobospan" id="kobo.168.1">(cookbook3) % python -m doctest recipe_01.py 
 
********************************************************************** 
 
File "/Users/slott/Documents/Writing/Python/Python Cookbook 3e/src/ch15/recipe_01.py", line 29, in recipe_01.Summary 
 
Failed example: 
 
    s.median 
 
Expected: 
 
    10 
 
Got: 
 
    9 
 
********************************************************************** 
 
1 items had failures: 
 
   1 of   7 in recipe_01.Summary 
 
***Test Failed*** 1 failures.</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.169.1">This shows where the error is. </span><span class="kobospan" id="kobo.169.2">It shows an expected value from the test example, and the actual answer that failed to match the expected answer. </span><span class="kobospan" id="kobo.169.3">Ordinarily – without the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.170.1">-v</span></span></span></span><span class="kobospan" id="kobo.171.1"> option – silence means all tests were passed successfully. </span><span id="x1-800017r1702"/></p>
</section>
</section>
<section data-number="0.18.1.3" id="how-it-works...-111">
<h2 class="likechapterhead" data-number="0.18.1.3"><span><span class="kobospan" id="kobo.172.1">15.1.3 </span></span> <span id="x1-8010003"/><span class="kobospan" id="kobo.173.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.174.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.175.1">doctest</span></span></span></span><span class="kobospan" id="kobo.176.1"> module includes</span><span id="dx1-801001"/><span class="kobospan" id="kobo.177.1"> a main</span><span id="dx1-801002"/><span class="kobospan" id="kobo.178.1"> program – as well as several functions – that scan a Python file for examples. </span><span class="kobospan" id="kobo.178.2">The scanning operation looks for blocks of text that have a characteristic pattern of the Python REPL: a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.179.1">&gt;&gt;&gt;</span></span></span></span><span class="kobospan" id="kobo.180.1"> prompt with code, followed by lines that show the response from the code, followed by a blank line to end the example output. </span><span class="kobospan" id="kobo.180.2">Clearly, these must be formatted to precisely match the Python REPL output to be found.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.181.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.182.1">doctest</span></span></span></span><span class="kobospan" id="kobo.183.1"> parser creates a small test case object from the prompt line and the block of response text. </span><span class="kobospan" id="kobo.183.2">There are three common</span><span id="dx1-801003"/><span class="kobospan" id="kobo.184.1"> cases:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.185.1">No expected response text</span></span><span class="kobospan" id="kobo.186.1">: We saw this pattern when we defined the tests for the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.187.1">add()</span></span></span></span><span class="kobospan" id="kobo.188.1"> method of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.189.1">Summary</span></span></span></span><span class="kobospan" id="kobo.190.1"> class.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.191.1">A single line of response text</span></span><span class="kobospan" id="kobo.192.1">: This was exemplified by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.193.1">binom()</span></span></span></span><span class="kobospan" id="kobo.194.1"> function and the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.195.1">mean()</span></span></span></span><span class="kobospan" id="kobo.196.1"> method of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.197.1">Summary</span></span></span></span><span class="kobospan" id="kobo.198.1"> class.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.199.1">Multiple lines of response</span></span><span class="kobospan" id="kobo.200.1">: Responses are bounded by either the next </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.201.1">&gt;&gt;&gt;</span></span></span></span><span class="kobospan" id="kobo.202.1"> prompt or a blank line. </span><span class="kobospan" id="kobo.202.2">This was exemplified by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.203.1">str()</span></span></span></span><span class="kobospan" id="kobo.204.1"> example of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.205.1">Summary</span></span></span></span><span class="kobospan" id="kobo.206.1"> class.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.207.1">Unless special annotations are used, the output text must precisely match the expectation text. </span><span class="kobospan" id="kobo.207.2">In general, every space counts.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.208.1">This testing protocol imposes some software design constraints. </span><span class="kobospan" id="kobo.208.2">Functions and classes must be designed to work from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.209.1">&gt;&gt;&gt;</span></span></span></span><span class="kobospan" id="kobo.210.1"> prompt. </span><span class="kobospan" id="kobo.210.2">Because it can become awkward to create very complex objects as part of a docstring example, class designs must be kept simple enough to be demonstrated at the interactive prompt. </span><span class="kobospan" id="kobo.210.3">These constraints often have the benefit of keeping a design understandable.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.211.1">The simplicity of the final comparison with the expected result can create some complications. </span><span class="kobospan" id="kobo.211.2">In the example, we rounded the value of the mean to two decimal places. </span><span class="kobospan" id="kobo.211.3">This is because the display of floating-point values may vary slightly from platform to platform. </span><span id="x1-801004r1713"/></p>
</section>
<section data-number="0.18.1.4" id="theres-more...-102">
<h2 class="likechapterhead" data-number="0.18.1.4"><span><span class="kobospan" id="kobo.212.1">15.1.4 </span></span> <span id="x1-8020004"/><span class="kobospan" id="kobo.213.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.214.1">One of the important considerations in test design is identifying</span><span id="dx1-802001"/><span class="kobospan" id="kobo.215.1"> edge cases. </span><span class="kobospan" id="kobo.215.2">An </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.216.1">edge case </span></span><span class="kobospan" id="kobo.217.1">generally focuses on the limits for which a calculation is designed.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.218.1">There are, for example, two edge cases for the binomial function:</span></p>
<div class="math-display">
<span class="kobospan" id="kobo.219.1"><img alt="( ) ( ) n n 0 = n = 1 " class="calibre9" src="../media/file81.png"/></span>
</div>
<p class="normal1"><span class="kobospan" id="kobo.220.1">We can add these to the examples to be sure that our implementation is sound. </span><span class="kobospan" id="kobo.220.2">This leads to a docstring that looks like the following:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.221.1">
 
 
    """ 
 
    Computes the binomial coefficient. 
 
    This shows how many combinations exist of 
 
    *n* things taken in groups of size *k*. 
 
 
 
    :param n: size of the universe 
 
    :param k: size of each subset 
 
    :returns: the number of combinations 
 
 
 
    &gt;&gt;&gt; binom(52, 5) 
 
    2598960 
 
    &gt;&gt;&gt; binom(52, 0) 
 
    1 
 
    &gt;&gt;&gt; binom(52, 52) 
 
    1 
 
 
 
    """</span></code></pre>
<div class="tipbox1" id="tcolobox-29">
<div class="note">
<p class="normal1"><span class="kobospan" id="kobo.222.1">To keep the examples straight in the source code files, we’ve changed the name of this function to </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.223.1">binom2</span></span></span></span><span class="kobospan" id="kobo.224.1">. </span><span class="kobospan" id="kobo.224.2">This hack lets us keep both examples in a single Python module.</span></p>
</div>
</div>
<p class="normal1"><span class="kobospan" id="kobo.225.1">In some cases, we might need to test values that are outside the valid range of values. </span><span class="kobospan" id="kobo.225.2">These cases raise exceptions, which means they aren’t really ideal for putting into the docstring. </span><span class="kobospan" id="kobo.225.3">The examples can clutter the explanation with details of things that should never normally happen. </span><span class="kobospan" id="kobo.225.4">Fortunately, we have a place to put additional examples.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.226.1">In addition to reading docstrings, the tool also looks for test cases in a global variable named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.227.1">__test__</span></span></span></span><span class="kobospan" id="kobo.228.1">. </span><span class="kobospan" id="kobo.228.2">This variable must refer to a mapping. </span><span class="kobospan" id="kobo.228.3">The keys to the mapping will be test case names, and the values of the mapping must be </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.229.1">doctest</span></span></span></span><span class="kobospan" id="kobo.230.1"> examples. </span><span class="kobospan" id="kobo.230.2">Generally, each value will need to be a triple-quoted string.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.231.1">Because the examples in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.232.1">__test__</span></span></span></span><span class="kobospan" id="kobo.233.1"> variable are not inside the docstrings, they don’t show up when using the built-in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.234.1">help()</span></span></span></span><span class="kobospan" id="kobo.235.1"> function. </span><span class="kobospan" id="kobo.235.2">Nor do they show up when using other tools to create documentation from source code. </span><span class="kobospan" id="kobo.235.3">This might be a place to put examples of failures or complex exceptions.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.236.1">We might add something like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.237.1">__test__ = { 
 
    "GIVEN_binom_WHEN_0_0_THEN_1": """ 
 
        &gt;&gt;&gt; binom(0, 0) 
 
        1 
 
        """, 
 
    "GIVEN_binom_WHEN_52_52_THEN_1": """ 
 
        &gt;&gt;&gt; binom(52, 52) 
 
        1 
 
        """, 
 
}</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.238.1">We can use this for tests that don’t need to be as visible as the docstring examples. </span><span id="x1-802031r1714"/></p>
</section>
<section data-number="0.18.1.5" id="see-also-109">
<h2 class="likechapterhead" data-number="0.18.1.5"><span><span class="kobospan" id="kobo.239.1">15.1.5 </span></span> <span id="x1-8030005"/><span class="kobospan" id="kobo.240.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.241.1">In the </span><a href="ch019_split_000.xhtml#x1-8040002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.242.1">Testing functions that raise exceptions</span></span></a><span class="kobospan" id="kobo.243.1"> and </span><a href="ch019_split_000.xhtml#x1-8100003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.244.1">Handling common</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.245.1">doctest issues</span></span></a><span class="kobospan" id="kobo.246.1"> recipes later in this chapter, we’ll look at two additional doctest techniques.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.247.1">For more background to the concept of stateless functions, see </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.248.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.249.1"> </span></span><a href="ch007_split_000.xhtml#x1-1610003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.250.1">3</span></span></a><span class="kobospan" id="kobo.251.1"> and </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.252.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.253.1"> </span></span><a href="ch013_split_000.xhtml#x1-5020009" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.254.1">9</span></span></a><span class="kobospan" id="kobo.255.1">.</span></p></li>
</ul>
<p class="normal1"><span id="x1-803001r1699"/></p>
</section>
</section>
<section data-number="0.18.2" id="testing-functions-that-raise-exceptions">
<h1 class="unnumbered" data-number="0.18.2"><span><span class="kobospan" id="kobo.256.1">15.2 </span></span> <span id="x1-8040002"/><span class="kobospan" id="kobo.257.1">Testing functions that raise exceptions</span></h1>
<p class="normal"><span class="kobospan" id="kobo.258.1">Python permits docstrings</span><span id="dx1-804001"/><span class="kobospan" id="kobo.259.1"> inside packages, modules, classes, functions, and methods. </span><span class="kobospan" id="kobo.259.2">A good docstring</span><span id="dx1-804002"/><span class="kobospan" id="kobo.260.1"> should contain an example of how the feature is used. </span><span class="kobospan" id="kobo.260.2">The example may need to include common exceptions, too. </span><span class="kobospan" id="kobo.260.3">There’s one complicating factor, however, to including exceptions.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.261.1">When an exception is raised, the traceback messages created by Python are not completely predictable. </span><span class="kobospan" id="kobo.261.2">The message may include object ID values that are impossible to predict or module line numbers that may vary slightly depending on the context in which the test is executed. </span><span class="kobospan" id="kobo.261.3">The general matching rules for </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.262.1">doctest</span></span></span></span><span class="kobospan" id="kobo.263.1"> compare expected and actual results precisely. </span><span class="kobospan" id="kobo.263.2">In this recipe, we’ll look at additional techniques to add flexibility. </span><span id="x1-804003r1717"/></p>
<section data-number="0.18.2.1" id="getting-ready-111">
<h2 class="likechapterhead" data-number="0.18.2.1"><span><span class="kobospan" id="kobo.264.1">15.2.1 </span></span> <span id="x1-8050001"/><span class="kobospan" id="kobo.265.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.266.1">We’ll look at a small function definition as well as a class definition. </span><span class="kobospan" id="kobo.266.2">Each of these will contain docstrings that include examples that can be used as formal tests.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.267.1">We’ll use the function from the </span><a href="ch019_split_000.xhtml#x1-7950001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.268.1">Using docstrings for testing</span></span></a><span class="kobospan" id="kobo.269.1"> recipe, shown earlier in this chapter, that computes the binomial coefficient of two numbers. </span><span class="kobospan" id="kobo.269.2">It shows the number of combinations of </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.270.1">n </span></span><span class="kobospan" id="kobo.271.1">things taken in groups of </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.272.1">k</span></span><span class="kobospan" id="kobo.273.1">. </span><span class="kobospan" id="kobo.273.2">For example, it shows how many ways a 52-card deck can be dealt into 5-card hands.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.274.1">This function does a simple calculation and returns a value; it lacks any internal state, making each request independent. </span><span class="kobospan" id="kobo.274.2">We’d like to include some additional test cases in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.275.1">__test__</span></span></span></span><span class="kobospan" id="kobo.276.1"> variable to show what this does when given values outside the expected ranges. </span><span id="x1-805001r1719"/></p>
</section>
<section data-number="0.18.2.2" id="how-to-do-it...-112">
<h2 class="likechapterhead" data-number="0.18.2.2"><span><span class="kobospan" id="kobo.277.1">15.2.2 </span></span> <span id="x1-8060002"/><span class="kobospan" id="kobo.278.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.279.1">We start by running the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.280.1">binom</span></span></span></span><span class="kobospan" id="kobo.281.1"> function we defined previously. </span><span class="kobospan" id="kobo.281.2">This output provides a handy template to show the expected output:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-806002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.282.1">Run the function manually at the interactive Python prompt to collect the actual exception details. </span><span class="kobospan" id="kobo.282.2">Copy and paste these results.</span></p>
</div></li>
<li class="calibre7"><div id="x1-806004x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.283.1">Create a global </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.284.1">__test__</span></span></span></span><span class="kobospan" id="kobo.285.1"> variable at the end of the module. </span><span class="kobospan" id="kobo.285.2">One approach is to build the mapping from all global variables with names that start with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.286.1">test_</span></span></span></span><span class="kobospan" id="kobo.287.1">:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.288.1">
    recipe_02 
 
2 items passed all tests: 
 
   2 tests in recipe_02.__test__.test_GIVEN_n_5_k_52_THEN_ValueError 
 
   3 tests in recipe_02.binom 
 
5 tests in 3 items.</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-806012x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.289.1">Define each test case</span><span id="dx1-806013"/><span class="kobospan" id="kobo.290.1"> as a global variable</span><span id="dx1-806014"/><span class="kobospan" id="kobo.291.1"> with a block of text containing the doctest example. </span><span class="kobospan" id="kobo.291.2">This can include additional notes about the scenario. </span><span class="kobospan" id="kobo.291.3">These variables must be set before the final creation of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.292.1">__test__</span></span></span></span><span class="kobospan" id="kobo.293.1"> mapping.</span></p>
</div></li>
<li class="calibre7"><div id="x1-806016x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.294.1">Paste in the interactive session session output.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.295.1">It will start like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.296.1">test_GIVEN_n_5_k_52_THEN_ValueError_1 = """ 
 
    GIVEN n=5, k=52 WHEN binom(n, k) THEN exception 
 
    &gt;&gt;&gt; binom(52, -5) 
 
    Traceback (most recent call last): 
 
      File "/Users/slott/miniconda3/envs/cookbook3/lib/python3.12/doctest.py", line 1357, in __run 
 
        exec(compile(example.source, filename, "single", 
 
      File "&lt;doctest recipe_02.__test__.test_GIVEN_n_5_k_52_THEN_ValueError[0]&gt;", line 1, in &lt;module&gt; 
 
        binom(52, -5) 
 
      File "/Users/slott/Documents/Writing/Python/Python Cookbook 3e/src/ch15/recipe_02.py", line 29, in binom 
 
        return factorial(n) // (factorial(k) * factorial(n - k)) 
 
                                ^^^^^^^^^^^^ 
 
    ValueError: factorial() not defined for negative values 
 
"""</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-806032x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.297.1">Replace the traceback details with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.298.1">...</span></span></span></span><span class="kobospan" id="kobo.299.1">. </span><span class="kobospan" id="kobo.299.2">Leave the initial line and the final exception in place. </span><span class="kobospan" id="kobo.299.3">Add a directive to doctest, by putting </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.300.1">#</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.301.1"> doctest:</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.302.1"> +ELLIPSIS</span></span></span></span><span class="kobospan" id="kobo.303.1"> after the line to be executed. </span><span class="kobospan" id="kobo.303.2">It will look like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.304.1">test_GIVEN_n_5_k_52_THEN_ValueError_2 = """ 
 
    GIVEN n=5, k=52 WHEN binom(n, k) THEN exception 
 
    &gt;&gt;&gt; binom(5, 52) 
 
    Traceback (most recent call last): 
 
    ... 
 
    ValueError: factorial() not defined for negative values 
 
"""</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.305.1">We can now use a command like this to test the entire module’s features:</span></p>
<pre class="programlisting" id="listing-95"><code class="calibre13"><span class="kobospan" id="kobo.306.1">(cookbook3) % python -m doctest recipe_02.py</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.307.1">Because each test is a separate global variable, we can easily add test scenarios. </span><span class="kobospan" id="kobo.307.2">All of the names starting with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.308.1">test_</span></span></span></span><span class="kobospan" id="kobo.309.1"> will become part of the final </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.310.1">__test__</span></span></span></span><span class="kobospan" id="kobo.311.1"> mapping that’s used by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.312.1">doctest</span></span></span></span><span class="kobospan" id="kobo.313.1"> tool. </span><span id="x1-806042r1720"/></p>
</section>
<section data-number="0.18.2.3" id="how-it-works...-112">
<h2 class="likechapterhead" data-number="0.18.2.3"><span><span class="kobospan" id="kobo.314.1">15.2.3 </span></span> <span id="x1-8070003"/><span class="kobospan" id="kobo.315.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.316.1">Because eliding traceback</span><span id="dx1-807001"/><span class="kobospan" id="kobo.317.1"> details is so</span><span id="dx1-807002"/><span class="kobospan" id="kobo.318.1"> common, the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.319.1">doctest </span></span><span class="kobospan" id="kobo.320.1">tool recognizes the</span><span id="dx1-807003"/><span class="kobospan" id="kobo.321.1"> ellipsis (</span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.322.1">...</span></span></span></span><span class="kobospan" id="kobo.323.1">) in the context of a traceback. </span><span class="kobospan" id="kobo.323.2">The ellipsis is also available in other contexts as one of many directives to modify the testing behavior. </span><span class="kobospan" id="kobo.323.3">The directives are included as special comments with the line of code that performs the test action. </span><span class="kobospan" id="kobo.323.4">They can also be provided as general instructions on the command line.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.324.1">We have two additional ways to handle tests that include an exception:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.325.1">We can use a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.326.1">#</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.327.1"> doctest:</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.328.1"> +IGNORE_EXCEPTION_DETAIL</span></span></span></span><span class="kobospan" id="kobo.329.1"> directive on the line of code that will raise the exception. </span><span class="kobospan" id="kobo.329.2">This lets us provide a full traceback error message. </span><span class="kobospan" id="kobo.329.3">The details of the traceback are ignored, and only the final exception line is matched against the expected value. </span><span class="kobospan" id="kobo.329.4">This makes it possible to copy an actual error and paste it into the documentation.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.330.1">We can use a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.331.1">#</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.332.1"> doctest:</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.333.1"> +ELLIPSIS</span></span></span></span><span class="kobospan" id="kobo.334.1"> directive and replace parts of the traceback message with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.335.1">...</span></span></span></span><span class="kobospan" id="kobo.336.1">. </span><span class="kobospan" id="kobo.336.2">This directive is redundant for traceback messages.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.337.1">The use of an explicit directive can help to make it clear what the intent is. </span><span id="x1-807004r1724"/></p>
</section>
<section data-number="0.18.2.4" id="theres-more...-103">
<h2 class="likechapterhead" data-number="0.18.2.4"><span><span class="kobospan" id="kobo.338.1">15.2.4 </span></span> <span id="x1-8080004"/><span class="kobospan" id="kobo.339.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.340.1">There are two more directives that are often useful:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.341.1">+NORMALIZE_WHITESPACE</span></span></span></span><span class="kobospan" id="kobo.342.1">: Using this directive allows some flexibility in the whitespace for the expected value.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.343.1">+SKIP</span></span></span></span><span class="kobospan" id="kobo.344.1">: The test is skipped.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.345.1">There are a few more directives, but they’re rarely needed. </span><span id="x1-808001r1725"/></p>
</section>
<section data-number="0.18.2.5" id="see-also-110">
<h2 class="likechapterhead" data-number="0.18.2.5"><span><span class="kobospan" id="kobo.346.1">15.2.5 </span></span> <span id="x1-8090005"/><span class="kobospan" id="kobo.347.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.348.1">See the </span><a href="ch019_split_000.xhtml#x1-7950001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.349.1">Using docstrings for testing</span></span></a><span class="kobospan" id="kobo.350.1"> recipe earlier in this chapter. </span><span class="kobospan" id="kobo.350.2">This recipe shows the basics of doctest.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.351.1">See the </span><a href="ch019_split_000.xhtml#x1-8100003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.352.1">Handling common doctest issues</span></span></a><span class="kobospan" id="kobo.353.1"> recipe next in this chapter. </span><span class="kobospan" id="kobo.353.2">This shows other special cases that require doctest directives.</span></p></li>
</ul>
<p class="normal1"><span id="x1-809001r1718"/></p>
</section>
</section>
<section data-number="0.18.3" id="handling-common-doctest-issues">
<h1 class="unnumbered" data-number="0.18.3"><span><span class="kobospan" id="kobo.354.1">15.3 </span></span> <span id="x1-8100003"/><span class="kobospan" id="kobo.355.1">Handling common doctest issues</span></h1>
<p class="normal"><span class="kobospan" id="kobo.356.1">A docstring that contains an example</span><span id="dx1-810001"/><span class="kobospan" id="kobo.357.1"> is part of good Python programming. </span><span class="kobospan" id="kobo.357.2">The way the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.358.1">doctest</span></span></span></span><span class="kobospan" id="kobo.359.1"> tool uses literal matching of the expected text output against the actual text can make testing complicated for Python objects that do not have a consistent text representation.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.360.1">For example, object hash values are randomized. </span><span class="kobospan" id="kobo.360.2">This often results in the order of elements in a set collection being unpredictable. </span><span class="kobospan" id="kobo.360.3">We have several choices for creating test case example output:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.361.1">Write examples that can tolerate randomization. </span><span class="kobospan" id="kobo.361.2">One technique is by sorting the elements of a set into a defined order.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.362.1">Stipulate a specific value for the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.363.1">PYTHONHASHSEED</span></span></span></span><span class="kobospan" id="kobo.364.1"> environment variable.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.365.1">There are several other considerations beyond simple variability in the location of keys or items in a set. </span><span class="kobospan" id="kobo.365.2">Here are some other concerns:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.366.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.367.1">id()</span></span></span></span><span class="kobospan" id="kobo.368.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.369.1">repr()</span></span></span></span><span class="kobospan" id="kobo.370.1"> functions may expose an internal object ID. </span><span class="kobospan" id="kobo.370.2">No guarantees can be made about these values.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.371.1">Floating-point values may vary across platforms.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.372.1">The current date, time, and local timezone cannot meaningfully be used in a test case.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.373.1">Random numbers using the default seed are difficult to predict.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.374.1">OS resources may not exist, or may not be in the proper state.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.375.1">It’s important to note that doctest</span><span id="dx1-810002"/><span class="kobospan" id="kobo.376.1"> examples require an </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.377.1">exact </span></span><span class="kobospan" id="kobo.378.1">match with the text. </span><span class="kobospan" id="kobo.378.2">This means our test cases must avoid unpredictable results stemming from hash randomization or floating-point implementation details. </span><span id="x1-810003r1726"/></p>
<section data-number="0.18.3.1" id="getting-ready-112">
<h2 class="likechapterhead" data-number="0.18.3.1"><span><span class="kobospan" id="kobo.379.1">15.3.1 </span></span> <span id="x1-8110001"/><span class="kobospan" id="kobo.380.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.381.1">We’ll look at three separate versions of this recipe. </span><span class="kobospan" id="kobo.381.2">The first will include a function where the output includes the contents of a set. </span><span class="kobospan" id="kobo.381.3">Because the order of items in a set can vary, this isn’t as easy to test as we’d like. </span><span class="kobospan" id="kobo.381.4">Here’s the function definition:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.382.1">from string import ascii_letters 
 
 
 
def unique_letters(text: str) -&gt; set[str]: 
 
    letters = set(text.lower()) 
 
    non_letters = letters - set(ascii_letters) 
 
    return letters - non_letters</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.383.1">Testing the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.384.1">unique_letters()</span></span></span></span><span class="kobospan" id="kobo.385.1"> function is difficult because the order of items within a set is unpredictable.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.386.1">The second example will be a class that doesn’t define a unique </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.387.1">__repr__()</span></span></span></span><span class="kobospan" id="kobo.388.1"> definition. </span><span class="kobospan" id="kobo.388.2">The default definition of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.389.1">__repr__()</span></span></span></span><span class="kobospan" id="kobo.390.1"> method will expose an internal object ID. </span><span class="kobospan" id="kobo.390.2">Since these vary, the test results will vary. </span><span class="kobospan" id="kobo.390.3">Here’s the class definition:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.391.1">class Point: 
 
    def __init__(self, lat: float, lon: float) -&gt; None: 
 
        self.lat = lat 
 
        self.lon = lon 
 
 
 
    @property 
 
    def text(self) -&gt; str: 
 
        ns_hemisphere = "S" if self.lat &lt; 0 else "N" 
 
        ew_hemisphere = "W" if self.lon &lt; 0 else "E" 
 
        lat_deg, lat_ms = divmod(abs(self.lat), 1.0) 
 
        lon_deg, lon_ms = divmod(abs(self.lon), 1.0) 
 
        return ( 
 
            f"{lat_deg:02.0f}{lat_ms*60:4.3f}{ns_hemisphere}" 
 
            f" {lon_deg:03.0f}{lon_ms*60:4.3f}{ew_hemisphere}" 
 
        )</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.392.1">For the third example, we’ll look</span><span id="dx1-811024"/><span class="kobospan" id="kobo.393.1"> at a real-valued function so that we can work with floating-point values:</span></p>
<div class="math-display">
<span class="kobospan" id="kobo.394.1"><img alt="ϕ (n) = 1[1 + erf√n-] 2 2 " class="calibre9" src="../media/file82.png"/></span>
</div>
<p class="normal1"><span class="kobospan" id="kobo.395.1">This function is the cumulative probability density function for standard z-scores. </span><span class="kobospan" id="kobo.395.2">See the </span><a href="ch013_split_001.xhtml#x1-5560008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.396.1">Creating a partial function</span></span></a><span class="kobospan" id="kobo.397.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.398.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.399.1"> </span></span><a href="ch013_split_000.xhtml#x1-5020009" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.400.1">9</span></span></a><span class="kobospan" id="kobo.401.1">, for more information on the idea of normalized scores.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.402.1">Here’s the Python implementation:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.403.1">from math import sqrt, pi, exp, erf 
 
 
 
def phi(n: float) -&gt; float: 
 
    return (1 + erf(n / sqrt(2))) / 2 
 
 
 
def frequency(n: float) -&gt; float: 
 
    return phi(n) - phi(-n)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.404.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.405.1">phi()</span></span></span></span><span class="kobospan" id="kobo.406.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.407.1">frequency()</span></span></span></span><span class="kobospan" id="kobo.408.1"> functions involve some rather complicated numeric processing. </span><span class="kobospan" id="kobo.408.2">The unit tests have to reflect the floating-point precision issues. </span><span id="x1-811033r1728"/></p>
</section>
<section data-number="0.18.3.2" id="how-to-do-it...-113">
<h2 class="likechapterhead" data-number="0.18.3.2"><span><span class="kobospan" id="kobo.409.1">15.3.2 </span></span> <span id="x1-8120002"/><span class="kobospan" id="kobo.410.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.411.1">We’ll look at set ordering</span><span id="dx1-812001"/><span class="kobospan" id="kobo.412.1"> and object representation in three mini-recipes. </span><span class="kobospan" id="kobo.412.2">We’ll start with set ordering, then look at object IDs, and finally, floating-point values.</span></p>
<section data-number="0.18.3.2.1" id="writing-doctest-examples-with-unpredictable-set-ordering">
<h3 class="likesubsubsectionhead" data-number="0.18.3.2.1"><span id="x1-8130002"/><span class="kobospan" id="kobo.413.1">Writing doctest examples with unpredictable set ordering</span></h3>
<ol class="calibre2">
<li class="calibre7"><div id="x1-813002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.414.1">Write a draft of the test</span><span id="dx1-813003"/><span class="kobospan" id="kobo.415.1"> that seems to capture</span><span id="dx1-813004"/><span class="kobospan" id="kobo.416.1"> the essence:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.417.1">&gt;&gt;&gt; phrase = "The quick brown fox..." 
 
&gt;&gt;&gt; unique_letters(phrase) 
 
{’b’, ’c’, ’e’, ’f’, ’h’, ’i’, ’k’, ’n’, ’o’, ’q’, ’r’, ’t’, ’u’, ’w’, ’x’}</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.418.1">This test will work when the hash values for these strings happen to fall into this specific order.</span></p>
</div></li>
<li class="calibre7"><div id="x1-813010x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.419.1">One possible fix is to sort the results to impose an order.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.420.1">Another alternative is to compare the output to a set object. </span><span class="kobospan" id="kobo.420.2">The two choices look like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.421.1">&gt;&gt;&gt; phrase = "The quick brown fox..." 
 
&gt;&gt;&gt; sorted(unique_letters(phrase)) 
 
[’b’, ’c’, ’e’, ’f’, ’h’, ’i’, ’k’, ’n’, ’o’, ’q’, ’r’, ’t’, ’u’, ’w’, ’x’] 
 
&gt;&gt;&gt; (unique_letters(phrase) == 
 
... </span><span class="kobospan" id="kobo.421.2">   {’b’, ’c’, ’e’, ’f’, ’h’, ’i’, ’k’, ’n’, ’o’, ’q’, ’r’, ’t’, ’u’, ’w’, ’x’} 
 
... </span><span class="kobospan" id="kobo.421.3">) 
 
True</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.422.1">A third choice is to set the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.423.1">PYTHONHASHSEED</span></span></span></span><span class="kobospan" id="kobo.424.1"> environment variable to force known orderings. </span><span class="kobospan" id="kobo.424.2">We’ll look at this alternative below.</span></p>
</section>
<section data-number="0.18.3.2.2" id="writing-doctest-examples-with-object-ids">
<h3 class="likesubsubsectionhead" data-number="0.18.3.2.2"><span id="x1-8140002"/><span class="kobospan" id="kobo.425.1">Writing doctest examples with object IDs</span></h3>
<p class="normal"><span class="kobospan" id="kobo.426.1">Ideally, our applications</span><span id="dx1-814001"/><span class="kobospan" id="kobo.427.1"> won’t display</span><span id="dx1-814002"/><span class="kobospan" id="kobo.428.1"> object IDs. </span><span class="kobospan" id="kobo.428.2">These are essentially impossible to predict. </span><span class="kobospan" id="kobo.428.3">Here’s what we can do:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-814004x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.429.1">Define a </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.430.1">happy path </span></span><span class="kobospan" id="kobo.431.1">doctest scenario to show that the class performs its essential methods correctly. </span><span class="kobospan" id="kobo.431.2">In this case, we’ll create a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.432.1">Point</span></span></span></span><span class="kobospan" id="kobo.433.1"> instance and use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.434.1">text</span></span></span></span><span class="kobospan" id="kobo.435.1"> property to see a representation of the point:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.436.1">&gt;&gt;&gt; Point(36.8439, -76.2936).text 
 
’3650.634N 07617.616W’</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-814009x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.437.1">When we define a test that displays the object’s representation string, the test will include results that include the unpredictable object ID. </span><span class="kobospan" id="kobo.437.2">The doctest might look like the following:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.438.1">&gt;&gt;&gt; Point(36.8439, -76.2936) 
 
&lt;recipe_03.Point object at 0x107910610&gt;</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.439.1">We need to change the test by using a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.440.1">#</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.441.1"> doctest:</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.442.1"> +ELLIPSIS</span></span></span></span><span class="kobospan" id="kobo.443.1"> directive. </span><span class="kobospan" id="kobo.443.2">This means changing the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.444.1">&gt;&gt;&gt;</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.445.1"> Point(36.8439,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.446.1"> -76.2936)</span></span></span></span><span class="kobospan" id="kobo.447.1"> line in the test, and using an ellipsis on the exception displayed in the expected output to look like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.448.1">&gt;&gt;&gt; Point(36.8439, -76.2936) # doctest: +ELLIPSIS 
 
&lt;recipe_03.Point object at ...&gt;</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.449.1">This kind of test suggest</span><span id="dx1-814016"/><span class="kobospan" id="kobo.450.1"> a design</span><span id="dx1-814017"/><span class="kobospan" id="kobo.451.1"> improvement. </span><span class="kobospan" id="kobo.451.2">It’s often best to define </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.452.1">__repr__()</span></span></span></span><span class="kobospan" id="kobo.453.1">. </span><span class="kobospan" id="kobo.453.2">Another choice is to avoid tests where </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.454.1">__repr__()</span></span></span></span><span class="kobospan" id="kobo.455.1"> may be used.</span></p>
</section>
<section data-number="0.18.3.2.3" id="writing-doctest-examples-for-floating-point-values">
<h3 class="likesubsubsectionhead" data-number="0.18.3.2.3"><span id="x1-8150002"/><span class="kobospan" id="kobo.456.1">Writing doctest examples for floating-point values</span></h3>
<p class="normal"><span class="kobospan" id="kobo.457.1">We have two choices</span><span id="dx1-815001"/><span class="kobospan" id="kobo.458.1"> when working</span><span id="dx1-815002"/><span class="kobospan" id="kobo.459.1"> with float values. </span><span class="kobospan" id="kobo.459.2">We can round the values to a certain number of decimal places. </span><span class="kobospan" id="kobo.459.3">An alternative is to use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.460.1">math.isclose()</span></span></span></span><span class="kobospan" id="kobo.461.1"> function. </span><span class="kobospan" id="kobo.461.2">We’ll show both:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-815004x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.462.1">Import the necessary libraries and define the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.463.1">phi()</span></span></span></span><span class="kobospan" id="kobo.464.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.465.1">frequency()</span></span></span></span><span class="kobospan" id="kobo.466.1"> functions as shown previously.</span></p>
</div></li>
<li class="calibre7"><div id="x1-815006x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.467.1">For each example, include an explicit use of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.468.1">round()</span></span></span></span><span class="kobospan" id="kobo.469.1">:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.470.1">&gt;&gt;&gt; round(phi(0), 3) 
 
0.5 
 
&gt;&gt;&gt; round(phi(-1), 3) 
 
0.159 
 
&gt;&gt;&gt; round(phi(+1), 3) 
 
0.841</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-815015x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.471.1">An alternative is to use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.472.1">isclose()</span></span></span></span><span class="kobospan" id="kobo.473.1"> function from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.474.1">math</span></span></span></span><span class="kobospan" id="kobo.475.1"> module:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.476.1">&gt;&gt;&gt; from math import isclose 
 
&gt;&gt;&gt; isclose(phi(0), 0.5) 
 
True 
 
&gt;&gt;&gt; isclose(phi(1), 0.8413, rel_tol=.0001) 
 
True 
 
&gt;&gt;&gt; isclose(phi(2), 0.9772, rel_tol=1e-4) 
 
True</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.477.1">Because float values can’t be compared exactly, it’s best to display values that have been rounded to an appropriate</span><span id="dx1-815024"/><span class="kobospan" id="kobo.478.1"> number of decimal</span><span id="dx1-815025"/><span class="kobospan" id="kobo.479.1"> places. </span><span class="kobospan" id="kobo.479.2">It’s sometimes nicer for readers of examples to use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.480.1">round()</span></span></span></span><span class="kobospan" id="kobo.481.1"> because it may be slightly easier to visualize how the function works, compared to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.482.1">isclose()</span></span></span></span><span class="kobospan" id="kobo.483.1"> alternative. </span><span id="x1-815026r1732"/></p>
</section>
</section>
<section data-number="0.18.3.3" id="how-it-works...-113">
<h2 class="likechapterhead" data-number="0.18.3.3"><span><span class="kobospan" id="kobo.484.1">15.3.3 </span></span> <span id="x1-8160003"/><span class="kobospan" id="kobo.485.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.486.1">Because of hash</span><span id="dx1-816001"/><span class="kobospan" id="kobo.487.1"> randomization, the hash keys used for sets are unpredictable. </span><span class="kobospan" id="kobo.487.2">This is an important security feature, used to defeat a subtle denial-of-service attack. </span><span class="kobospan" id="kobo.487.3">For details, see url: </span><a class="url" href="https://packt.link/dHrHU"><span class="url1"><span class="kobospan" id="kobo.488.1">http://www.ocert.org/advisories/ocert-2011-003.html.</span></span></a></p>
<p class="normal1"><span class="kobospan" id="kobo.489.1">Since Python 3.7, dictionary keys are guaranteed to be kept in insertion order. </span><span class="kobospan" id="kobo.489.2">This means that an algorithm that builds a dictionary will provide a consistent sequence of key values. </span><span class="kobospan" id="kobo.489.3">The same ordering guarantee is not made for sets. </span><span class="kobospan" id="kobo.489.4">Interestingly, sets of integers tend to have a consistent ordering because of the way hash values are computed for numbers. </span><span class="kobospan" id="kobo.489.5">Sets of other types of objects, however, will not show consistent ordering of items.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.490.1">When confronted with unpredictable results like set ordering or internal object identification revealed by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.491.1">__repr__()</span></span></span></span><span class="kobospan" id="kobo.492.1"> method, we have a testability issue. </span><span class="kobospan" id="kobo.492.2">We can either change the software to be more testable, or we can change the test to tolerate some unpredictability.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.493.1">Most floating-point implementations are reasonably consistent. </span><span class="kobospan" id="kobo.493.2">However, there are few formal guarantees about the last few bits of any given floating-point number. </span><span class="kobospan" id="kobo.493.3">Rather than trusting that all of the bits have exactly the right value, it’s often a good practice to round the value to a precision consistent with other values in the problem domain.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.494.1">Being tolerant of unpredictability can be taken too far, allowing the test to tolerate bugs. </span><span class="kobospan" id="kobo.494.2">For more in-depth testing of mathematical functions, the </span><a href="https://hypothesis.readthedocs.io/en/latest/" class="url"><span class="kobospan" id="kobo.495.1">hypothesis</span></a><span class="kobospan" id="kobo.496.1"> package provides ways to define a domain</span><span id="dx1-816002"/><span class="kobospan" id="kobo.497.1"> of robust test cases. </span><span id="x1-816003r1743"/></p>
</section>
<section data-number="0.18.3.4" id="theres-more...-104">
<h2 class="likechapterhead" data-number="0.18.3.4"><span><span class="kobospan" id="kobo.498.1">15.3.4 </span></span> <span id="x1-8170004"/><span class="kobospan" id="kobo.499.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.500.1">We can run the tests with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.501.1">PYTHONHASHSEED</span></span></span></span><span class="kobospan" id="kobo.502.1"> environment variable set. </span><span class="kobospan" id="kobo.502.2">In Linux (and macOS X) we can do this in a single command-line statement:</span></p>
<pre class="programlisting" id="listing-96"><code class="calibre13"><span class="kobospan" id="kobo.503.1">(cookbook3) % PYTHONHASHSEED=42 python3 -m doctest recipe_03.py</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.504.1">This will provide a fixed, reproducible hash randomization while running doctest. </span><span class="kobospan" id="kobo.504.2">We can also use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.505.1">PYTHONHASHSEED=0</span></span></span></span><span class="kobospan" id="kobo.506.1"> to disable hash randomization.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.507.1">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.508.1">tox </span></span><span class="kobospan" id="kobo.509.1">tool has a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.510.1">--hashseed=x</span></span></span></span><span class="kobospan" id="kobo.511.1"> option to allow setting a consistent hash seed to an integer value prior to running tests. </span><span id="x1-817002r1744"/></p>
</section>
<section data-number="0.18.3.5" id="see-also-111">
<h2 class="likechapterhead" data-number="0.18.3.5"><span><span class="kobospan" id="kobo.512.1">15.3.5 </span></span> <span id="x1-8180005"/><span class="kobospan" id="kobo.513.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.514.1">The </span><a href="ch019_split_001.xhtml#x1-8430008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.515.1">Testing things that involve dates or times</span></span></a><span class="kobospan" id="kobo.516.1"> recipe, in particular, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.517.1">now()</span></span></span></span><span class="kobospan" id="kobo.518.1"> method of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.519.1">datetime</span></span></span></span><span class="kobospan" id="kobo.520.1"> requires some care.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.521.1">The </span><a href="ch019_split_001.xhtml#x1-8490009" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.522.1">Testing things that involve randomness</span></span></a><span class="kobospan" id="kobo.523.1"> recipe shows how to test processing that involves using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.524.1">random</span></span></span></span><span class="kobospan" id="kobo.525.1"> module.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.526.1">We’ll look at how to work with external resources in the </span><a href="ch019_split_001.xhtml#x1-85500010" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.527.1">Mocking</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.528.1">external resources</span></span></a><span class="kobospan" id="kobo.529.1"> recipe later in this chapter.</span></p></li>
</ul>
<p class="normal1"><span id="x1-818001r1727"/></p>
</section>
</section>
<section data-number="0.18.4" id="unit-testing-with-the-unittest-module">
<h1 class="unnumbered" data-number="0.18.4"><span><span class="kobospan" id="kobo.530.1">15.4 </span></span> <span id="x1-8190004"/><span class="kobospan" id="kobo.531.1">Unit testing with the unittest module</span></h1>
<p class="normal"><span class="kobospan" id="kobo.532.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.533.1">unittest</span></span></span></span><span class="kobospan" id="kobo.534.1"> module allows</span><span id="dx1-819001"/><span class="kobospan" id="kobo.535.1"> us to step beyond the examples used by doctest. </span><span class="kobospan" id="kobo.535.2">Each test case can have one more scenario built as a subclass of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.536.1">TestCase</span></span></span></span><span class="kobospan" id="kobo.537.1"> class. </span><span class="kobospan" id="kobo.537.2">These use result checks that are more sophisticated than the literal text matching used by the doctest tool.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.538.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.539.1">unittest</span></span></span></span><span class="kobospan" id="kobo.540.1"> module also allows us to package tests outside docstrings. </span><span class="kobospan" id="kobo.540.2">This can be helpful for tests for edge cases that might be too detailed to be helpful documentation. </span><span class="kobospan" id="kobo.540.3">Often, doctest cases focus on the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.541.1">happy path </span></span><span class="kobospan" id="kobo.542.1">– the most common</span><span id="dx1-819002"/><span class="kobospan" id="kobo.543.1"> use cases, where everything works as expected. </span><span class="kobospan" id="kobo.543.2">We can use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.544.1">unittest</span></span></span></span><span class="kobospan" id="kobo.545.1"> module to more easily define test cases that diverge from the happy path.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.546.1">This recipe will show how we can use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.547.1">unittest</span></span></span></span><span class="kobospan" id="kobo.548.1"> module to create more sophisticated tests. </span><span id="x1-819003r1745"/></p>
<section data-number="0.18.4.1" id="getting-ready-113">
<h2 class="likechapterhead" data-number="0.18.4.1"><span><span class="kobospan" id="kobo.549.1">15.4.1 </span></span> <span id="x1-8200001"/><span class="kobospan" id="kobo.550.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.551.1">It’s sometimes helpful to summarize a test following ideas behind the Gherkin language. </span><span class="kobospan" id="kobo.551.2">In this test specification language, each scenario is described by </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.552.1">GIVEN-WHEN-THEN </span></span><span class="kobospan" id="kobo.553.1">steps. </span><span class="kobospan" id="kobo.553.2">For this case, we have a scenario like this:</span></p>
<pre class="programlisting" id="listing-97"><code class="calibre13"><span class="kobospan" id="kobo.554.1">Scenario: Summary object can add values and compute statistics. 
 
 
 
Given a Summary object 
 
And numbers in the range 0 to 1000 (inclusive) shuffled randomly 
 
When all numbers are added to the Summary object 
 
Then the mean is 500 
 
And the median is 500</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.555.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.556.1">TestCase</span></span></span></span><span class="kobospan" id="kobo.557.1"> class doesn’t precisely follow this three-part given-when-then (or arrange-act-assert) structure. </span><span class="kobospan" id="kobo.557.2">A </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.558.1">TestCase</span></span></span></span><span class="kobospan" id="kobo.559.1"> class generally has two parts:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.560.1">A </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.561.1">setUp()</span></span></span></span><span class="kobospan" id="kobo.562.1"> method must implement the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.563.1">Given </span></span><span class="kobospan" id="kobo.564.1">steps of the test case.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.565.1">A </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.566.1">runTest()</span></span></span></span><span class="kobospan" id="kobo.567.1"> method must handle the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.568.1">Then </span></span><span class="kobospan" id="kobo.569.1">steps to confirm the results using a number of assertion methods to confirm the actual results match the expected results.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.570.1">The </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.571.1">When </span></span><span class="kobospan" id="kobo.572.1">steps can be in either method. </span><span class="kobospan" id="kobo.572.2">The choice of where to implement the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.573.1">When </span></span><span class="kobospan" id="kobo.574.1">steps is often tied to the question of reuse. </span><span class="kobospan" id="kobo.574.2">For example, a class or function may have a number of methods to take different actions or make a number of state changes. </span><span class="kobospan" id="kobo.574.3">In this case, it makes sense to pair each </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.575.1">When </span></span><span class="kobospan" id="kobo.576.1">step with distinct </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.577.1">Then </span></span><span class="kobospan" id="kobo.578.1">steps to confirm correct operation. </span><span class="kobospan" id="kobo.578.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.579.1">runTest()</span></span></span></span><span class="kobospan" id="kobo.580.1"> method can implement both </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.581.1">When </span></span><span class="kobospan" id="kobo.582.1">and </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.583.1">Then </span></span><span class="kobospan" id="kobo.584.1">steps. </span><span class="kobospan" id="kobo.584.2">A number of subclasses can share the common </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.585.1">setUp()</span></span></span></span><span class="kobospan" id="kobo.586.1"> method.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.587.1">As another example, a class hierarchy</span><span id="dx1-820008"/><span class="kobospan" id="kobo.588.1"> may offer a number of alternative implementations for the same algorithm. </span><span class="kobospan" id="kobo.588.2">In this case, the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.589.1">Then </span></span><span class="kobospan" id="kobo.590.1">step confirmation of correct behavior is in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.591.1">runTest()</span></span></span></span><span class="kobospan" id="kobo.592.1"> method. </span><span class="kobospan" id="kobo.592.2">Each alternative implementation has a distinct subclass with a unique </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.593.1">setup()</span></span></span></span><span class="kobospan" id="kobo.594.1"> method for the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.595.1">Given </span></span><span class="kobospan" id="kobo.596.1">and </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.597.1">When</span></span><span class="kobospan" id="kobo.598.1"> steps.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.599.1">An optional </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.600.1">tearDown()</span></span></span></span><span class="kobospan" id="kobo.601.1"> method is available for those tests that need to perform some cleanup of left-over resources. </span><span class="kobospan" id="kobo.601.2">This is outside the test’s essential scenario specification.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.602.1">We’ll create some tests for a class that is designed to compute some basic descriptive statistics. </span><span class="kobospan" id="kobo.602.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.603.1">unittest</span></span></span></span><span class="kobospan" id="kobo.604.1"> test cases let us define sample data that’s larger than anything we’d ever choose to enter as doctest examples. </span><span class="kobospan" id="kobo.604.2">We can easily use thousands of data points rather than two or three as part of evaluating performance.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.605.1">The bulk of the code that we’re going to test was shown in the </span><a href="ch019_split_000.xhtml#x1-7950001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.606.1">Using docstrings</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.607.1">for testing</span></span></a><span class="kobospan" id="kobo.608.1"> recipe earlier in this chapter.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.609.1">Because we’re not looking at the implementation details, we can think of this as opaque-box testing; the implementation details are not known to the tester.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.610.1">We’d like to be sure that when we use thousands of samples, the class performs correctly. </span><span class="kobospan" id="kobo.610.2">We’d also like to ensure that it works quickly; we’ll use this as part of an overall performance test, as well as a unit test. </span><span id="x1-820009r1747"/></p>
</section>
<section data-number="0.18.4.2" id="how-to-do-it...-114">
<h2 class="likechapterhead" data-number="0.18.4.2"><span><span class="kobospan" id="kobo.611.1">15.4.2 </span></span> <span id="x1-8210002"/><span class="kobospan" id="kobo.612.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.613.1">We’ll need to create a separate module and a subclass of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.614.1">TestCase</span></span></span></span><span class="kobospan" id="kobo.615.1"> in that module. </span><span class="kobospan" id="kobo.615.2">Tools like </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.616.1">pytest </span></span><span class="kobospan" id="kobo.617.1">can discover test modules</span><span id="dx1-821001"/><span class="kobospan" id="kobo.618.1"> if their names begin with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.619.1">test_</span></span></span></span><span class="kobospan" id="kobo.620.1">, giving us a naming convention for these additional modules. </span><span class="kobospan" id="kobo.620.2">Here’s how we can creates tests separate from the module’s code:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-821003x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.621.1">Create a file with a name related to the module under test. </span><span class="kobospan" id="kobo.621.2">If the module was named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.622.1">summary.py</span></span></span></span><span class="kobospan" id="kobo.623.1">, then a good name for a test module would be </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.624.1">test_summary.py</span></span></span></span><span class="kobospan" id="kobo.625.1">. </span><span class="kobospan" id="kobo.625.2">Using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.626.1">test_</span></span></span></span><span class="kobospan" id="kobo.627.1"> prefix makes it easier for tools like </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.628.1">pytest </span></span><span class="kobospan" id="kobo.629.1">to find the test.</span></p>
</div></li>
<li class="calibre7"><div id="x1-821005x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.630.1">We’ll use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.631.1">unittest</span></span></span></span><span class="kobospan" id="kobo.632.1"> module</span><span id="dx1-821006"/><span class="kobospan" id="kobo.633.1"> for creating test classes. </span><span class="kobospan" id="kobo.633.2">We’ll also be using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.634.1">random</span></span></span></span><span class="kobospan" id="kobo.635.1"> module to scramble the input data. </span><span class="kobospan" id="kobo.635.2">We’ll also import the module under test:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.636.1">import unittest 
 
import random 
 
 
 
from recipe_01 import Summary</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-821013x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.637.1">Create a subclass of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.638.1">TestCase</span></span></span></span><span class="kobospan" id="kobo.639.1">. </span><span class="kobospan" id="kobo.639.2">Provide this class with a name that shows the intent of the test. </span><span class="kobospan" id="kobo.639.3">We’ve chosen a name with a summary of the three steps:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.640.1">class GIVEN_Summary_WHEN_1k_samples_THEN_mean_median(unittest.TestCase):</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-821017x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.641.1">Define a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.642.1">setUp()</span></span></span></span><span class="kobospan" id="kobo.643.1"> method in this class that handles the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.644.1">Given </span></span><span class="kobospan" id="kobo.645.1">step of the test. </span><span class="kobospan" id="kobo.645.2">We’ve created a collection of 1,001 samples shuffled into a random order:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.646.1">
    def setUp(self) -&gt; None: 
 
        self.summary = Summary() 
 
        self.data = list(range(1001)) 
 
        random.shuffle(self.data)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-821024x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.647.1">Define a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.648.1">runTest()</span></span></span></span><span class="kobospan" id="kobo.649.1"> method that handles the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.650.1">When </span></span><span class="kobospan" id="kobo.651.1">step of the test:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.652.1">
    def runTest(self) -&gt; None: 
 
        for sample in self.data: 
 
            self.summary.add(sample)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-821030x6" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.653.1">Add assertions to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.654.1">runTest()</span></span></span></span><span class="kobospan" id="kobo.655.1"> method to implement the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.656.1">Then </span></span><span class="kobospan" id="kobo.657.1">steps of the test:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.658.1">
        self.assertEqual(500, self.summary.mean) 
 
        self.assertEqual(500, self.summary.median)</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.659.1">If our test module is called </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.660.1">recipe_04.py</span></span></span></span><span class="kobospan" id="kobo.661.1">, we can use the following command to find </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.662.1">TestCase</span></span></span></span><span class="kobospan" id="kobo.663.1"> classes in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.664.1">recipe_04</span></span></span></span><span class="kobospan" id="kobo.665.1"> module and run them:</span></p>
<pre class="programlisting" id="listing-98"><code class="calibre13"><span class="kobospan" id="kobo.666.1">(cookbook3) % python -m unittest recipe_04.py</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.667.1">If all of the assertions pass, then the test suite will pass and the test run will be successful overall. </span><span id="x1-821035r1748"/></p>
</section>
<section data-number="0.18.4.3" id="how-it-works...-114">
<h2 class="likechapterhead" data-number="0.18.4.3"><span><span class="kobospan" id="kobo.668.1">15.4.3 </span></span> <span id="x1-8220003"/><span class="kobospan" id="kobo.669.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.670.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.671.1">TestCase</span></span></span></span><span class="kobospan" id="kobo.672.1"> class is used to define</span><span id="dx1-822001"/><span class="kobospan" id="kobo.673.1"> one test case. </span><span class="kobospan" id="kobo.673.2">The class can have a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.674.1">setUp()</span></span></span></span><span class="kobospan" id="kobo.675.1"> method to create the unit and possibly the request. </span><span class="kobospan" id="kobo.675.2">The class must have at least a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.676.1">runTest()</span></span></span></span><span class="kobospan" id="kobo.677.1"> method to make a request of the unit and check the response.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.678.1">A single test often isn’t sufficient. </span><span class="kobospan" id="kobo.678.2">If we created three separate test classes in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.679.1">recipe_04.py</span></span></span></span><span class="kobospan" id="kobo.680.1"> module, then we would see output that looks like this:</span></p>
<pre class="programlisting" id="listing-99"><code class="calibre13"><span class="kobospan" id="kobo.681.1">(cookbook3) % python -m unittest recipe_04.py 
 
... 
 
---------------------------------------------------------------------- 
 
Ran 3 tests in 0.003s 
 
 
 
OK</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.682.1">As each test is passed, a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.683.1">.</span></span></span></span><span class="kobospan" id="kobo.684.1"> is displayed. </span><span class="kobospan" id="kobo.684.2">This shows that the test suite is making progress. </span><span class="kobospan" id="kobo.684.3">The summary shows the number of tests run and the time. </span><span class="kobospan" id="kobo.684.4">If there are failures or exceptions, the counts shown at the end will reflect these.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.685.1">Finally, there’s a summary line. </span><span class="kobospan" id="kobo.685.2">In this case, it consists of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.686.1">OK</span></span></span></span><span class="kobospan" id="kobo.687.1">, showing that all the tests passed.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.688.1">If we include a test that fails, we’ll see the following output when we use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.689.1">-v</span></span></span></span><span class="kobospan" id="kobo.690.1"> option to get verbose output:</span></p>
<pre class="programlisting" id="listing-100"><code class="calibre13"><span class="kobospan" id="kobo.691.1">(cookbook3) % python -m unittest -v recipe_04.py 
 
runTest (recipe_04.GIVEN_Summary_WHEN_1k_samples_THEN_mean_median.runTest) ... </span><span class="kobospan" id="kobo.691.2">ok 
 
test_mean (recipe_04.GIVEN_Summary_WHEN_1k_samples_THEN_mean_median_2.test_mean) ... </span><span class="kobospan" id="kobo.691.3">FAIL 
 
test_median (recipe_04.GIVEN_Summary_WHEN_1k_samples_THEN_mean_median_2.test_median) ... </span><span class="kobospan" id="kobo.691.4">ok 
 
test_mode (recipe_04.GIVEN_Summary_WHEN_1k_samples_THEN_mode.test_mode) ... </span><span class="kobospan" id="kobo.691.5">ok 
 
 
 
====================================================================== 
 
FAIL: test_mean (recipe_04.GIVEN_Summary_WHEN_1k_samples_THEN_mean_median_2.test_mean) 
 
---------------------------------------------------------------------- 
 
Traceback (most recent call last): 
 
  File "/Users/slott/Documents/Writing/Python/Python Cookbook 3e/src/ch15/recipe_04.py", line 122, in test_mean 
 
    self.assertEqual(501, self.summary.mean) 
 
AssertionError: 501 != 500.0 
 
 
 
---------------------------------------------------------------------- 
 
Ran 4 tests in 0.004s 
 
 
 
FAILED (failures=1)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.692.1">There’s a final summary</span><span id="dx1-822026"/><span class="kobospan" id="kobo.693.1"> of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.694.1">FAILED</span></span></span></span><span class="kobospan" id="kobo.695.1">. </span><span class="kobospan" id="kobo.695.2">This includes </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.696.1">(failures=1)</span></span></span></span><span class="kobospan" id="kobo.697.1"> to show how many tests failed. </span><span id="x1-822027r1754"/></p>
</section>
<section data-number="0.18.4.4" id="theres-more...-105">
<h2 class="likechapterhead" data-number="0.18.4.4"><span><span class="kobospan" id="kobo.698.1">15.4.4 </span></span> <span id="x1-8230004"/><span class="kobospan" id="kobo.699.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.700.1">In these examples, we have two assertions for the two </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.701.1">Then </span></span><span class="kobospan" id="kobo.702.1">steps inside the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.703.1">runTest()</span></span></span></span><span class="kobospan" id="kobo.704.1"> method. </span><span class="kobospan" id="kobo.704.2">If one fails, the test stops as a failure, and the other step is not exercised.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.705.1">This is a weakness in the design of this test. </span><span class="kobospan" id="kobo.705.2">If the first assertion fails, we may not get all of the diagnostic information we might want. </span><span class="kobospan" id="kobo.705.3">We should avoid having a sequence of otherwise independent assertions in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.706.1">runTest()</span></span></span></span><span class="kobospan" id="kobo.707.1"> method.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.708.1">When we want more diagnostic details, we have two general choices:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.709.1">Use multiple test methods instead of a single </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.710.1">runTest()</span></span></span></span><span class="kobospan" id="kobo.711.1">. </span><span class="kobospan" id="kobo.711.2">We can create multiple methods with names that start with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.712.1">test_</span></span></span></span><span class="kobospan" id="kobo.713.1">. </span><span class="kobospan" id="kobo.713.2">The default implementation of the test loader will execute the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.714.1">setUp()</span></span></span></span><span class="kobospan" id="kobo.715.1"> method prior to each separate </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.716.1">test_</span></span></span></span><span class="kobospan" id="kobo.717.1"> method when there is no overall </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.718.1">runTest()</span></span></span></span><span class="kobospan" id="kobo.719.1"> method. </span><span class="kobospan" id="kobo.719.2">This is often the simplest way to group a number of related tests together.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.720.1">Use multiple subclasses of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.721.1">TestCase</span></span></span></span><span class="kobospan" id="kobo.722.1"> subclass, each with a separate </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.723.1">Then </span></span><span class="kobospan" id="kobo.724.1">step implementation. </span><span class="kobospan" id="kobo.724.2">When the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.725.1">setUp()</span></span></span></span><span class="kobospan" id="kobo.726.1"> is inherited, this will be shared by each subclass.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.727.1">Following the first alternative, the test class would look like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.728.1">class GIVEN_Summary_WHEN_1k_samples_THEN_mean_median_2(unittest.TestCase): 
 
    def setUp(self) -&gt; None: 
 
        self.summary = Summary() 
 
        self.data = list(range(1001)) 
 
        random.shuffle(self.data) 
 
 
 
        for sample in self.data: 
 
            self.summary.add(sample) 
 
 
 
    def test_mean(self) -&gt; None: 
 
        self.assertEqual(500, self.summary.mean) 
 
 
 
    def test_median(self) -&gt; None: 
 
        self.assertEqual(500, self.summary.median)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.729.1">We’ve refactored the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.730.1">setUp()</span></span></span></span><span class="kobospan" id="kobo.731.1"> method to include the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.732.1">Given </span></span><span class="kobospan" id="kobo.733.1">and </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.734.1">When </span></span><span class="kobospan" id="kobo.735.1">steps of the test. </span><span class="kobospan" id="kobo.735.2">The two independent </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.736.1">Then </span></span><span class="kobospan" id="kobo.737.1">steps are refactored into their own separate </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.738.1">test_mean()</span></span></span></span><span class="kobospan" id="kobo.739.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.740.1">test_median()</span></span></span></span><span class="kobospan" id="kobo.741.1"> methods. </span><span class="kobospan" id="kobo.741.2">These two methods are used instead of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.742.1">runTest()</span></span></span></span><span class="kobospan" id="kobo.743.1"> method.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.744.1">Since each test is run separately, we’ll see separate error reports for problems with computing the mean or with</span><span id="dx1-823016"/><span class="kobospan" id="kobo.745.1"> computing the median.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.746.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.747.1">TestCase</span></span></span></span><span class="kobospan" id="kobo.748.1"> class defines numerous assertions that can be used as part of the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.749.1">Then </span></span><span class="kobospan" id="kobo.750.1">steps. </span><span class="kobospan" id="kobo.750.2">We encourage careful study of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.751.1">unittest</span></span></span></span><span class="kobospan" id="kobo.752.1"> section of the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.753.1">Python Standard Library </span></span><span class="kobospan" id="kobo.754.1">documentation to see all of the variations available.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.755.1">In all but the smallest projects, it’s common practice to sequester the test files into a separate directory, often called </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.756.1">tests</span></span></span></span><span class="kobospan" id="kobo.757.1">. </span><span class="kobospan" id="kobo.757.2">When this is done, we can rely on the discovery application that’s part of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.758.1">unittest</span></span></span></span><span class="kobospan" id="kobo.759.1"> framework.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.760.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.761.1">unittest</span></span></span></span><span class="kobospan" id="kobo.762.1"> loader</span><span id="dx1-823017"/><span class="kobospan" id="kobo.763.1"> can search each module in a given directory for all classes that are derived from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.764.1">TestCase</span></span></span></span><span class="kobospan" id="kobo.765.1"> class. </span><span class="kobospan" id="kobo.765.2">This collection of classes within the larger collection of modules becomes the complete </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.766.1">TestSuite</span></span></span></span><span class="kobospan" id="kobo.767.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.768.1">We can do this with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.769.1">discover</span></span></span></span><span class="kobospan" id="kobo.770.1"> command</span><span id="dx1-823018"/><span class="kobospan" id="kobo.771.1"> of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.772.1">unittest</span></span></span></span><span class="kobospan" id="kobo.773.1"> package:</span></p>
<pre class="programlisting" id="listing-101"><code class="calibre13"><span class="kobospan" id="kobo.774.1">(cookbook3) % (cd src; python -m unittest discover -s ch15) 
 
............... 
 
---------------------------------------------------------------------- 
 
Ran 15 tests in 0.008s 
 
 
 
OK</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.775.1">This will locate all test cases in all test modules in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.776.1">tests</span></span></span></span><span class="kobospan" id="kobo.777.1"> directory of a project. </span><span id="x1-823025r1755"/></p>
</section>
<section data-number="0.18.4.5" id="see-also-112">
<h2 class="likechapterhead" data-number="0.18.4.5"><span><span class="kobospan" id="kobo.778.1">15.4.5 </span></span> <span id="x1-8240005"/><span class="kobospan" id="kobo.779.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.780.1">We’ll combine </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.781.1">unittest</span></span></span></span><span class="kobospan" id="kobo.782.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.783.1">doctest</span></span></span></span><span class="kobospan" id="kobo.784.1"> in the </span><a href="ch019_split_001.xhtml#x1-8370007" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.785.1">Combining pytest and</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.786.1">doctest tests</span></span></a><span class="kobospan" id="kobo.787.1"> recipe next in this chapter. </span><span class="kobospan" id="kobo.787.2">We’ll look at mocking external objects in the </span><a href="ch019_split_001.xhtml#x1-85500010" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.788.1">Mocking external resources</span></span></a><span class="kobospan" id="kobo.789.1"> recipe later in this chapter.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.790.1">The </span><a href="ch019_split_001.xhtml#x1-8310006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.791.1">Unit testing with the pytest module</span></span></a><span class="kobospan" id="kobo.792.1"> recipe later in this chapter covers the same test case from the perspective of the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.793.1">pytest </span></span><span class="kobospan" id="kobo.794.1">tool.</span></p></li>
</ul>
<p class="normal1"><span id="x1-824001r1746"/></p>
</section>
</section>
<section data-number="0.18.5" id="combining-unittest-and-doctest-tests">
<h1 class="unnumbered" data-number="0.18.5"><span><span class="kobospan" id="kobo.795.1">15.5 </span></span> <span id="x1-8250005"/><span class="kobospan" id="kobo.796.1">Combining unittest and doctest tests</span></h1>
<p class="normal"><span class="kobospan" id="kobo.797.1">In some cases, we’ll want to combine</span><span id="dx1-825001"/><span class="kobospan" id="kobo.798.1"> tests written for the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.799.1">unittest</span></span></span></span><span class="kobospan" id="kobo.800.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.801.1">doctest</span></span></span></span><span class="kobospan" id="kobo.802.1"> tools. </span><span class="kobospan" id="kobo.802.2">For examples of using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.803.1">doctest</span></span></span></span><span class="kobospan" id="kobo.804.1"> tool, see the </span><a href="ch019_split_000.xhtml#x1-7950001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.805.1">Using docstrings for</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.806.1">testing</span></span></a><span class="kobospan" id="kobo.807.1"> recipe earlier in this chapter. </span><span class="kobospan" id="kobo.807.2">For examples of using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.808.1">unittest</span></span></span></span><span class="kobospan" id="kobo.809.1"> tool, see the </span><a href="ch019_split_000.xhtml#x1-8190004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.810.1">Unit testing with the unittest module</span></span></a><span class="kobospan" id="kobo.811.1"> recipe earlier in this chapter.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.812.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.813.1">doctest</span></span></span></span><span class="kobospan" id="kobo.814.1"> examples are an essential element of the documentation strings on modules, classes, methods, and functions. </span><span class="kobospan" id="kobo.814.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.815.1">unittest</span></span></span></span><span class="kobospan" id="kobo.816.1"> cases will often be in a separate </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.817.1">tests</span></span></span></span><span class="kobospan" id="kobo.818.1"> directory in files with names that match the pattern </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.819.1">test_*.py</span></span></span></span><span class="kobospan" id="kobo.820.1">. </span><span class="kobospan" id="kobo.820.2">An important part of creating trustworthy software is running as wide a variety of tests as possible.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.821.1">In this recipe, we’ll look at ways to combine a variety of tests into one tidy package. </span><span id="x1-825002r1757"/></p>
<section data-number="0.18.5.1" id="getting-ready-114">
<h2 class="likechapterhead" data-number="0.18.5.1"><span><span class="kobospan" id="kobo.822.1">15.5.1 </span></span> <span id="x1-8260001"/><span class="kobospan" id="kobo.823.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.824.1">We’ll refer back to the example from the </span><a href="ch019_split_000.xhtml#x1-7950001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.825.1">Using docstrings for testing</span></span></a><span class="kobospan" id="kobo.826.1"> recipe, shown earlier in this chapter. </span><span class="kobospan" id="kobo.826.2">This recipe created tests for a class, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.827.1">Summary</span></span></span></span><span class="kobospan" id="kobo.828.1">, that does some statistical calculations. </span><span class="kobospan" id="kobo.828.2">In that recipe, we included examples in the docstrings.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.829.1">In the </span><a href="ch019_split_000.xhtml#x1-8190004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.830.1">Unit testing with the unittest module</span></span></a><span class="kobospan" id="kobo.831.1"> recipe earlier in this chapter, we wrote some </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.832.1">TestCase</span></span></span></span><span class="kobospan" id="kobo.833.1"> classes to provide additional tests for this class.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.834.1">As context, we’ll assume</span><span id="dx1-826001"/><span class="kobospan" id="kobo.835.1"> there’s a project folder structure that looks like the following directory tree:</span></p>
<pre class="programlisting" id="listing-102"><code class="calibre13"><span class="kobospan" id="kobo.836.1">project-name/ 
 
    src/ 
 
        summary.py 
 
    tests/ 
 
        test_summary.py 
 
    README 
 
    pyproject.toml 
 
    requirements.txt 
 
    tox.ini</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.837.1">This means tests are in both the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.838.1">src/summary.py</span></span></span></span><span class="kobospan" id="kobo.839.1"> module and in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.840.1">tests/test_summary.py</span></span></span></span><span class="kobospan" id="kobo.841.1"> file.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.842.1">We need to combine all of the tests into a single, comprehensive test suite.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.843.1">The recipe examples use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.844.1">recipe_01.py</span></span></span></span><span class="kobospan" id="kobo.845.1"> instead of some cooler name such as </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.846.1">summary.py</span></span></span></span><span class="kobospan" id="kobo.847.1">. </span><span class="kobospan" id="kobo.847.2">Ideally, a module should have a memorable, meaningful name. </span><span class="kobospan" id="kobo.847.3">The book content is quite large, and the names are designed to match the overall chapter and recipe outline. </span><span id="x1-826011r1759"/></p>
</section>
<section data-number="0.18.5.2" id="how-to-do-it...-115">
<h2 class="likechapterhead" data-number="0.18.5.2"><span><span class="kobospan" id="kobo.848.1">15.5.2 </span></span> <span id="x1-8270002"/><span class="kobospan" id="kobo.849.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.850.1">To combine </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.851.1">unittest</span></span></span></span><span class="kobospan" id="kobo.852.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.853.1">doctest</span></span></span></span><span class="kobospan" id="kobo.854.1"> test cases, we’ll start with an existing test module, and add a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.855.1">load_tests()</span></span></span></span><span class="kobospan" id="kobo.856.1"> function to merge the relevant </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.857.1">doctest</span></span></span></span><span class="kobospan" id="kobo.858.1"> with the existing </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.859.1">unittest</span></span></span></span><span class="kobospan" id="kobo.860.1"> test cases. </span><span class="kobospan" id="kobo.860.2">A function named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.861.1">load_tests()</span></span></span></span><span class="kobospan" id="kobo.862.1"> must be provided. </span><span class="kobospan" id="kobo.862.2">This name is required so the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.863.1">unittest</span></span></span></span><span class="kobospan" id="kobo.864.1"> loader will use it:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-827002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.865.1">To use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.866.1">doctest</span></span></span></span><span class="kobospan" id="kobo.867.1"> tests, import the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.868.1">doctest</span></span></span></span><span class="kobospan" id="kobo.869.1"> module. </span><span class="kobospan" id="kobo.869.2">To write </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.870.1">TestCase</span></span></span></span><span class="kobospan" id="kobo.871.1"> classes, import the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.872.1">unittest</span></span></span></span><span class="kobospan" id="kobo.873.1"> module. </span><span class="kobospan" id="kobo.873.2">We’ll also need the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.874.1">random</span></span></span></span><span class="kobospan" id="kobo.875.1"> module so we can control the random seeds in use:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.876.1">import unittest 
 
import doctest 
 
import random</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-827008x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.877.1">Import the modules</span><span id="dx1-827009"/><span class="kobospan" id="kobo.878.1"> containing doctest examples:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.879.1">import recipe_01</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-827013x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.880.1">To implement the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.881.1">load_tests</span></span></span></span><span class="kobospan" id="kobo.882.1"> protocol, define a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.883.1">load_tests()</span></span></span></span><span class="kobospan" id="kobo.884.1"> function in the test module. </span><span class="kobospan" id="kobo.884.2">We’ll combine the standard tests automatically discovered by </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.885.1">unittest</span></span></span></span><span class="kobospan" id="kobo.886.1"> with the additional tests found by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.887.1">doctest</span></span></span></span><span class="kobospan" id="kobo.888.1"> module:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.889.1">def load_tests( 
 
    loader: unittest.TestLoader, standard_tests: unittest.TestSuite, pattern: str 
 
) -&gt; unittest.TestSuite: 
 
    dt = doctest.DocTestSuite(recipe_01) 
 
    standard_tests.addTests(dt) 
 
    return standard_tests</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.890.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.891.1">loader</span></span></span></span><span class="kobospan" id="kobo.892.1"> argument value to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.893.1">load_tests()</span></span></span></span><span class="kobospan" id="kobo.894.1"> function is the test case loader currently being used; this is generally ignored. </span><span class="kobospan" id="kobo.894.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.895.1">standard_tests</span></span></span></span><span class="kobospan" id="kobo.896.1"> argument value will be all of the tests loaded by default. </span><span class="kobospan" id="kobo.896.2">Generally, this is the suite of all subclasses of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.897.1">TestCase</span></span></span></span><span class="kobospan" id="kobo.898.1">. </span><span class="kobospan" id="kobo.898.2">The function updates this object with the additional tests. </span><span class="kobospan" id="kobo.898.3">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.899.1">pattern</span></span></span></span><span class="kobospan" id="kobo.900.1"> value is the value provided to the loader to locate tests; this is also ignored.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.901.1">When we run this from the OS command prompt, we see the following:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.902.1">(cookbook3) % python -m unittest -v recipe_05.py 
 
test_mean (recipe_05.GIVEN_Summary_WHEN_1k_samples_THEN_mean_median.test_mean) ... </span><span class="kobospan" id="kobo.902.2">ok 
 
test_median (recipe_05.GIVEN_Summary_WHEN_1k_samples_THEN_mean_median.test_median) ... </span><span class="kobospan" id="kobo.902.3">ok 
 
Summary (recipe_01) 
 
Doctest: recipe_01.Summary ... </span><span class="kobospan" id="kobo.902.4">ok 
 
Twc (recipe_01) 
 
Doctest: recipe_01.Twc ... </span><span class="kobospan" id="kobo.902.5">ok 
 
GIVEN_binom_WHEN_0_0_THEN_1 (recipe_01.__test__) 
 
Doctest: recipe_01.__test__.GIVEN_binom_WHEN_0_0_THEN_1 ... </span><span class="kobospan" id="kobo.902.6">ok 
 
GIVEN_binom_WHEN_52_52_THEN_1 (recipe_01.__test__) 
 
Doctest: recipe_01.__test__.GIVEN_binom_WHEN_52_52_THEN_1 ... </span><span class="kobospan" id="kobo.902.7">ok 
 
binom (recipe_01) 
 
Doctest: recipe_01.binom ... </span><span class="kobospan" id="kobo.902.8">ok 
 
binom2 (recipe_01) 
 
Doctest: recipe_01.binom2 ... </span><span class="kobospan" id="kobo.902.9">ok 
 
 
 
---------------------------------------------------------------------- 
 
Ran 8 tests in 0.006s 
 
 
 
OK</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.903.1">This shows us that the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.904.1">unittest</span></span></span></span><span class="kobospan" id="kobo.905.1"> test cases were included as well as doctest test cases. </span><span id="x1-827042r1760"/></p>
</section>
</section>
</section>


<section data-number="0.18" id="chapter-15-testing">
<section data-number="0.18.5" id="combining-unittest-and-doctest-tests">
<section data-number="0.18.5.3" id="how-it-works...-115">
<h2 class="likechapterhead" data-number="0.18.5.3"><span><span class="kobospan" id="kobo.906.1">15.5.3 </span></span> <span id="x1-8280003"/><span class="kobospan" id="kobo.907.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.908.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.909.1">unittest.main()</span></span></span></span><span class="kobospan" id="kobo.910.1"> application</span><span id="dx1-828001"/><span class="kobospan" id="kobo.911.1"> uses a test loader to find all of the relevant test cases. </span><span class="kobospan" id="kobo.911.2">The loader is designed to find all classes that extend </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.912.1">TestCase</span></span></span></span><span class="kobospan" id="kobo.913.1">. </span><span class="kobospan" id="kobo.913.2">It will also look for a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.914.1">load_tests()</span></span></span></span><span class="kobospan" id="kobo.915.1"> function. </span><span class="kobospan" id="kobo.915.2">This function can provide a suite of additional tests. </span><span class="kobospan" id="kobo.915.3">It can also do non-default searches for tests when that’s needed.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.916.1">Generally, we can import a module with docstrings and use a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.917.1">DocTestSuite</span></span></span></span><span class="kobospan" id="kobo.918.1"> to build a test suite from the imported module. </span><span class="kobospan" id="kobo.918.2">We can, of course, import other modules or even scan the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.919.1">README</span></span></span></span><span class="kobospan" id="kobo.920.1"> file for more examples to test. </span><span class="kobospan" id="kobo.920.2">The goal is to make sure every example in both the code and the documentation actually works. </span><span id="x1-828002r1765"/></p>
</section>
<section data-number="0.18.5.4" id="theres-more...-106">
<h2 class="likechapterhead" data-number="0.18.5.4"><span><span class="kobospan" id="kobo.921.1">15.5.4 </span></span> <span id="x1-8290004"/><span class="kobospan" id="kobo.922.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.923.1">In some cases, a module may be quite complicated; this can lead to multiple test modules. </span><span class="kobospan" id="kobo.923.2">The test modules may have names such as </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.924.1">tests/test_module_feature_X.py</span></span></span></span><span class="kobospan" id="kobo.925.1"> to show that there are tests for separate features of a very complex module. </span><span class="kobospan" id="kobo.925.2">The volume of code for test cases can be quite large, and keeping the features separate can be helpful.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.926.1">In other cases, we might have a test module that has tests for several different but closely related small modules. </span><span class="kobospan" id="kobo.926.2">A single test module may employ inheritance techniques to cover all the modules in a package.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.927.1">When combining many smaller modules, there may be multiple suites built in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.928.1">load_tests()</span></span></span></span><span class="kobospan" id="kobo.929.1"> function. </span><span class="kobospan" id="kobo.929.2">The body might look like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.930.1">import doctest 
 
import unittest 
 
 
 
import recipe_01 as ch15_r01 
 
import recipe_02 as ch15_r02 
 
import recipe_03 as ch15_r03 
 
import recipe_05 as ch15_r04 
 
 
 
def load_tests( 
 
    loader: unittest.TestLoader, standard_tests: unittest.TestSuite, pattern: str 
 
) -&gt; unittest.TestSuite: 
 
    for module in (ch15_r01, ch15_r02, ch15_r03, ch15_r04): 
 
        dt = doctest.DocTestSuite(module) 
 
        standard_tests.addTests(dt) 
 
    return standard_tests</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.931.1">This will incorporate doctest examples from multiple modules into a single, comprehensive test suite. </span><span id="x1-829017r1766"/></p>
</section>
<section data-number="0.18.5.5" id="see-also-113">
<h2 class="likechapterhead" data-number="0.18.5.5"><span><span class="kobospan" id="kobo.932.1">15.5.5 </span></span> <span id="x1-8300005"/><span class="kobospan" id="kobo.933.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.934.1">For examples of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.935.1">doctest</span></span></span></span><span class="kobospan" id="kobo.936.1">, see the </span><a href="ch019_split_000.xhtml#x1-7950001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.937.1">Using docstrings for testing</span></span></a><span class="kobospan" id="kobo.938.1"> recipe earlier in the chapter. </span><span class="kobospan" id="kobo.938.2">For examples of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.939.1">unittest</span></span></span></span><span class="kobospan" id="kobo.940.1">, see the </span><a href="ch019_split_000.xhtml#x1-8190004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.941.1">Unit testing</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.942.1">with the unittest module</span></span></a><span class="kobospan" id="kobo.943.1"> recipe earlier in this chapter.</span></p></li>
</ul>
<p class="normal1"><span id="x1-830001r1758"/></p>
</section>
</section>
<section data-number="0.18.6" id="unit-testing-with-the-pytest-module">
<h1 class="unnumbered" data-number="0.18.6"><span><span class="kobospan" id="kobo.944.1">15.6 </span></span> <span id="x1-8310006"/><span class="kobospan" id="kobo.945.1">Unit testing with the pytest module</span></h1>
<p class="normal"><span class="kobospan" id="kobo.946.1">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.947.1">pytest </span></span><span class="kobospan" id="kobo.948.1">tool allows us to step beyond</span><span id="dx1-831001"/><span class="kobospan" id="kobo.949.1"> the examples used</span><span id="dx1-831002"/><span class="kobospan" id="kobo.950.1"> by </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.951.1">doctest</span></span></span></span><span class="kobospan" id="kobo.952.1"> in docstrings. </span><span class="kobospan" id="kobo.952.2">Instead of using a subclass of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.953.1">TestCase</span></span></span></span><span class="kobospan" id="kobo.954.1">, the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.955.1">pytest </span></span><span class="kobospan" id="kobo.956.1">tool lets us use function definitions. </span><span class="kobospan" id="kobo.956.2">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.957.1">pytest </span></span><span class="kobospan" id="kobo.958.1">approach uses Python’s built-in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.959.1">assert</span></span></span></span><span class="kobospan" id="kobo.960.1"> statement, leaving the test case looking somewhat simpler.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.961.1">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.962.1">pytest </span></span><span class="kobospan" id="kobo.963.1">tool is not part of Python; it needs to be installed separately. </span><span class="kobospan" id="kobo.963.2">Use a command like this:</span></p>
<pre class="programlisting" id="listing-103"><code class="calibre13"><span class="kobospan" id="kobo.964.1">(cookbook3) % python -m pip install pytest</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.965.1">In this recipe, we’ll look at how we can use </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.966.1">pytest </span></span><span class="kobospan" id="kobo.967.1">to simplify our test cases. </span><span id="x1-831004r1768"/></p>
<section data-number="0.18.6.1" id="getting-ready-115">
<h2 class="likechapterhead" data-number="0.18.6.1"><span><span class="kobospan" id="kobo.968.1">15.6.1 </span></span> <span id="x1-8320001"/><span class="kobospan" id="kobo.969.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.970.1">The Gherkin language can help to structure a test. </span><span class="kobospan" id="kobo.970.2">For this recipe, we have a scenario like this:</span></p>
<pre class="programlisting" id="listing-104"><code class="calibre13"><span class="kobospan" id="kobo.971.1">Scenario: Summary object can add values and compute statistics. 
 
 
 
Given a Summary object 
 
And numbers in the range 0 to 1000 (inclusive) shuffled randomly 
 
When all numbers are added to the Summary object 
 
Then the mean is 500 
 
And the median is 500</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.972.1">A </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.973.1">pytest</span></span></span></span><span class="kobospan" id="kobo.974.1"> test function doesn’t precisely follow the Gherkin three-part structure. </span><span class="kobospan" id="kobo.974.2">A test function generally has two parts:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.975.1">If necessary, fixtures are defined to establish the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.976.1">Given </span></span><span class="kobospan" id="kobo.977.1">steps. </span><span class="kobospan" id="kobo.977.2">Fixtures are designed for reuse as well as composition. </span><span class="kobospan" id="kobo.977.3">A fixture can also tear down resources after a test has finished.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.978.1">The body of the function will usually handle the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.979.1">When </span></span><span class="kobospan" id="kobo.980.1">steps to exercise the object being tested and the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.981.1">Then </span></span><span class="kobospan" id="kobo.982.1">steps to confirm the results.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.983.1">These boundaries are not fixed. </span><span class="kobospan" id="kobo.983.2">A fixture might, for example, create an object and also take action, executing both the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.984.1">Given </span></span><span class="kobospan" id="kobo.985.1">and </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.986.1">When </span></span><span class="kobospan" id="kobo.987.1">steps. </span><span class="kobospan" id="kobo.987.2">This permits multiple test functions to apply several independent </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.988.1">Then</span></span><span class="kobospan" id="kobo.989.1"> steps.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.990.1">We’ll create some tests for a class that is designed to compute some basic descriptive statistics. </span><span class="kobospan" id="kobo.990.2">The bulk of the code was shown in the </span><a href="ch019_split_000.xhtml#x1-7950001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.991.1">Using docstrings for</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.992.1">testing</span></span></a><span class="kobospan" id="kobo.993.1"> recipe.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.994.1">This is an outline of the class, provided as a reminder of what the method names are:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.995.1">class Summary: 
 
    def __init__(self) -&gt; None: ... 
 
    def __str__(self) -&gt; str: ... 
 
    def add(self, value: int) -&gt; None: ... 
 
    @property 
 
    def mean(self) -&gt; float: ... 
 
    @property 
 
    def median(self) -&gt; float: ... 
 
    @property 
 
    def count(self) -&gt; int: ... 
 
    @property 
 
    def mode(self) -&gt; list[tuple[int, int]]: ...</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.996.1">We want to duplicate testing</span><span id="dx1-832021"/><span class="kobospan" id="kobo.997.1"> shown in the </span><a href="ch019_split_000.xhtml#x1-8190004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.998.1">Unit testing with the unittest module</span></span></a><span class="kobospan" id="kobo.999.1"> recipe. </span><span class="kobospan" id="kobo.999.2">We’ll use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1000.1">pytest</span></span></span></span><span class="kobospan" id="kobo.1001.1"> features</span><span id="dx1-832022"/><span class="kobospan" id="kobo.1002.1"> to do this. </span><span id="x1-832023r1770"/></p>
</section>
<section data-number="0.18.6.2" id="how-to-do-it...-116">
<h2 class="likechapterhead" data-number="0.18.6.2"><span><span class="kobospan" id="kobo.1003.1">15.6.2 </span></span> <span id="x1-8330002"/><span class="kobospan" id="kobo.1004.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1005.1">It’s often best to start with a separate test file, perhaps even a separate </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1006.1">tests</span></span></span></span><span class="kobospan" id="kobo.1007.1"> directory:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-833002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1008.1">Create a test file with a name similar to the module under test. </span><span class="kobospan" id="kobo.1008.2">If the module file was named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1009.1">summary.py</span></span></span></span><span class="kobospan" id="kobo.1010.1">, then a good name for a test module would be </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1011.1">test_summary.py</span></span></span></span><span class="kobospan" id="kobo.1012.1">. </span><span class="kobospan" id="kobo.1012.2">Using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1013.1">test_</span></span></span></span><span class="kobospan" id="kobo.1014.1"> prefix makes the test easier to find.</span></p>
</div></li>
<li class="calibre7"><div id="x1-833004x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1015.1">We’ll use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1016.1">pytest</span></span></span></span><span class="kobospan" id="kobo.1017.1"> module for creating test classes. </span><span class="kobospan" id="kobo.1017.2">We’ll also be using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1018.1">random</span></span></span></span><span class="kobospan" id="kobo.1019.1"> module to scramble the input data. </span><span class="kobospan" id="kobo.1019.2">Also, we need to import the module under test:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1020.1">import random 
 
import pytest 
 
from recipe_01 import Summary
                                                                     

                                                                     </span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-833010x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1021.1">Implement the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1022.1">Given </span></span><span class="kobospan" id="kobo.1023.1">step as a fixture. </span><span class="kobospan" id="kobo.1023.2">This is marked with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1024.1">@pytest.fixture</span></span></span></span><span class="kobospan" id="kobo.1025.1"> decorator. </span><span class="kobospan" id="kobo.1025.2">It creates a function that can return a useful object, data for creating an object, or a mocked object:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1026.1">@pytest.fixture() 
 
def flat_data() -&gt; list[int]: 
 
    data = list(range(1001)) 
 
    random.shuffle(data) 
 
    return data</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-833018x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1027.1">Implement the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1028.1">When </span></span><span class="kobospan" id="kobo.1029.1">and </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1030.1">Then </span></span><span class="kobospan" id="kobo.1031.1">steps as a test function with a name visible to </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1032.1">pytest</span></span></span></span><span class="kobospan" id="kobo.1033.1">. </span><span class="kobospan" id="kobo.1033.2">This means the function name must begin with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1034.1">test_</span></span></span></span><span class="kobospan" id="kobo.1035.1">:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1036.1">def test_flat(flat_data: list[int]) -&gt; None:</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1037.1">When a parameter name</span><span id="dx1-833021"/><span class="kobospan" id="kobo.1038.1"> in a test function</span><span id="dx1-833022"/><span class="kobospan" id="kobo.1039.1"> definition is the name of a fixture function, the fixture function is evaluated automatically. </span><span class="kobospan" id="kobo.1039.2">The results of the fixture function are provided at runtime. </span><span class="kobospan" id="kobo.1039.3">This means the shuffled set of 1,000 values will be provided as an argument value for the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1040.1">flat_data</span></span></span></span><span class="kobospan" id="kobo.1041.1"> parameter.</span></p>
</div></li>
<li class="calibre7"><div id="x1-833024x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1042.1">Implement a </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1043.1">When </span></span><span class="kobospan" id="kobo.1044.1">step to perform an operation on an object:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1045.1">
    summary = Summary() 
 
    for sample in flat_data: 
 
        summary.add(sample)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-833030x6" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1046.1">Implement the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1047.1">Then </span></span><span class="kobospan" id="kobo.1048.1">steps to validate the outcome:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1049.1">
    assert summary.mean == 500 
 
    assert summary.median == 500</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.1050.1">If our test module is called </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1051.1">test_summary.py</span></span></span></span><span class="kobospan" id="kobo.1052.1">, we can often execute the tests found in it with a command like the following:</span></p>
<pre class="programlisting" id="listing-105"><code class="calibre13"><span class="kobospan" id="kobo.1053.1">(cookbook3) % python -m pytest test_summary.py</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1054.1">This will invoke the main application that’s part of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1055.1">pytest</span></span></span></span><span class="kobospan" id="kobo.1056.1"> package. </span><span class="kobospan" id="kobo.1056.2">It will search the given file for functions with names starting with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1057.1">test_</span></span></span></span><span class="kobospan" id="kobo.1058.1"> and execute those test functions. </span><span id="x1-833035r1772"/></p>
</section>
<section data-number="0.18.6.3" id="how-it-works...-116">
<h2 class="likechapterhead" data-number="0.18.6.3"><span><span class="kobospan" id="kobo.1059.1">15.6.3 </span></span> <span id="x1-8340003"/><span class="kobospan" id="kobo.1060.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1061.1">We’re using several</span><span id="dx1-834001"/><span class="kobospan" id="kobo.1062.1"> parts of the</span><span id="dx1-834002"/> <span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1063.1">pytest</span></span></span></span><span class="kobospan" id="kobo.1064.1"> package:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1065.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1066.1">@fixture</span></span></span></span><span class="kobospan" id="kobo.1067.1"> decorator can be used to create reusable test fixtures with objects in known states, ready for further processing.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1068.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1069.1">pytest</span></span></span></span><span class="kobospan" id="kobo.1070.1"> application to do several things:</span></p>
<ul class="calibre25">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1071.1">Discover tests. </span><span class="kobospan" id="kobo.1071.2">By default, it searches a directory named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1072.1">tests</span></span></span></span><span class="kobospan" id="kobo.1073.1"> for module names starting with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1074.1">test_</span></span></span></span><span class="kobospan" id="kobo.1075.1">. </span><span class="kobospan" id="kobo.1075.2">Within those, it looks for functions with names starting with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1076.1">test_</span></span></span></span><span class="kobospan" id="kobo.1077.1">. </span><span class="kobospan" id="kobo.1077.2">It also finds </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1078.1">unittest.TestCase</span></span></span></span><span class="kobospan" id="kobo.1079.1"> classes.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1080.1">Run all of the tests, evaluating the fixtures as needed.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1081.1">Display a summary of the results.</span></p></li>
</ul></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1082.1">When we run the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1083.1">pytest</span></span></span></span><span class="kobospan" id="kobo.1084.1"> command, we’ll see output that looks like this:</span></p>
<pre class="programlisting" id="listing-106"><code class="calibre13"><span class="kobospan" id="kobo.1085.1">(cookbook3) % python -m pytest recipe_06.py 
 
=========================== test session starts ============================ 
 
platform darwin -- Python 3.12.0, pytest-7.4.3, pluggy-1.3.0 
 
rootdir: /Users/slott/Documents/Writing/Python/Python Cookbook 3e 
 
configfile: pytest.ini 
 
plugins: anyio-4.0.0 
 
collected 3 items 
 
 
 
recipe_06.py ... </span><span class="kobospan" id="kobo.1085.2">                                                    [100%] 
 
 
 
============================ 3 passed in 0.02s =============================</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1086.1">As each test is passed, a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1087.1">.</span></span></span></span><span class="kobospan" id="kobo.1088.1"> is displayed. </span><span class="kobospan" id="kobo.1088.2">This shows that the test suite is making progress. </span><span class="kobospan" id="kobo.1088.3">The summary shows the number of tests run and the time. </span><span class="kobospan" id="kobo.1088.4">If there are failures or exceptions, the counts on the last line will reflect this.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1089.1">If we change one test slightly to be sure that it fails, we’ll see the following output:</span></p>
<pre class="programlisting" id="listing-107"><code class="calibre13"><span class="kobospan" id="kobo.1090.1">(cookbook3) % python -m pytest recipe_06.py 
 
=========================== test session starts ============================ 
 
platform darwin -- Python 3.12.0, pytest-7.4.3, pluggy-1.3.0 
 
rootdir: /Users/slott/Documents/Writing/Python/Python Cookbook 3e 
 
configfile: pytest.ini 
 
plugins: anyio-4.0.0 
 
collected 3 items 
 
 
 
recipe_06.py F.. </span><span class="kobospan" id="kobo.1090.2">                                                    [100%] 
 
 
 
================================= FAILURES ================================= 
 
________________________________ test_flat _________________________________ 
 
 
 
flat_data = [883, 104, 898, 113, 519, 94, ...] 
 
 
 
    def test_flat(flat_data: list[int]) -&gt; None: 
 
        summary = Summary() 
 
        for sample in flat_data: 
 
            summary.add(sample) 
 
&gt;       assert summary.mean == 501 
 
E       assert 500.0 == 501 
 
E        +  where 500.0 = &lt;recipe_01.Summary object at 0x10fdcb350&gt;.mean 
 
 
 
recipe_06.py:57: AssertionError 
 
========================= short test summary info ========================== 
 
FAILED recipe_06.py::test_flat - assert 500.0 == 501 
 
======================= 1 failed, 2 passed in 0.17s ========================</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1091.1">This shows a summary of passing</span><span id="dx1-834041"/><span class="kobospan" id="kobo.1092.1"> and failing</span><span id="dx1-834042"/><span class="kobospan" id="kobo.1093.1"> tests and the details of each failure. </span><span id="x1-834043r1778"/></p>
</section>
<section data-number="0.18.6.4" id="theres-more...-107">
<h2 class="likechapterhead" data-number="0.18.6.4"><span><span class="kobospan" id="kobo.1094.1">15.6.4 </span></span> <span id="x1-8350004"/><span class="kobospan" id="kobo.1095.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1096.1">In this example, we have two </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1097.1">Then </span></span><span class="kobospan" id="kobo.1098.1">steps inside the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1099.1">test_flat()</span></span></span></span><span class="kobospan" id="kobo.1100.1"> function. </span><span class="kobospan" id="kobo.1100.2">These are implemented as two </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1101.1">assert</span></span></span></span><span class="kobospan" id="kobo.1102.1"> statements. </span><span class="kobospan" id="kobo.1102.2">If the first one fails, the test stops as a failure, and the following step will be skipped. </span><span class="kobospan" id="kobo.1102.3">This means we might not see all the diagnostic information we might need.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1103.1">A better design is to use multiple test functions. </span><span class="kobospan" id="kobo.1103.2">All of the functions can share a common fixture. </span><span class="kobospan" id="kobo.1103.3">In this case, we can create a second fixture that depends on the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1104.1">flat_data</span></span></span></span><span class="kobospan" id="kobo.1105.1"> fixture and builds a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1106.1">Summary</span></span></span></span><span class="kobospan" id="kobo.1107.1"> object to be used by a number of tests:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1108.1">@pytest.fixture() 
 
def summary_object(flat_data: list[int]) -&gt; Summary: 
 
    summary = Summary() 
 
    for sample in flat_data: 
 
        summary.add(sample) 
 
    return summary 
 
 
 
def test_mean(summary_object: Summary) -&gt; None: 
 
    assert summary_object.mean == 500 
 
 
 
def test_median(summary_object: Summary) -&gt; None: 
 
    assert summary_object.median == 500</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1109.1">Since each of these test functions are run separately, we’ll see separate error reports for problems when computing the mean and the median, or possibly when computing both. </span><span id="x1-835014r1779"/></p>
</section>
<section data-number="0.18.6.5" id="see-also-114">
<h2 class="likechapterhead" data-number="0.18.6.5"><span><span class="kobospan" id="kobo.1110.1">15.6.5 </span></span> <span id="x1-8360005"/><span class="kobospan" id="kobo.1111.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1112.1">The </span><a href="ch019_split_000.xhtml#x1-8190004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1113.1">Unit testing with the unittest module</span></span></a><span class="kobospan" id="kobo.1114.1"> recipe in this chapter covers the same test case from the perspective of the unittest module.</span></p></li>
</ul>
<p class="normal1"><span id="x1-836001r1769"/></p>
</section>
</section>
<section data-number="0.18.7" id="combining-pytest-and-doctest-tests">
<h1 class="unnumbered" data-number="0.18.7"><span><span class="kobospan" id="kobo.1115.1">15.7 </span></span> <span id="x1-8370007"/><span class="kobospan" id="kobo.1116.1">Combining pytest and doctest tests</span></h1>
<p class="normal"><span class="kobospan" id="kobo.1117.1">In most cases, we’ll have a combination</span><span id="dx1-837001"/><span class="kobospan" id="kobo.1118.1"> of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1119.1">pytest</span></span></span></span><span class="kobospan" id="kobo.1120.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1121.1">doctest</span></span></span></span><span class="kobospan" id="kobo.1122.1"> test cases. </span><span class="kobospan" id="kobo.1122.2">For examples of using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1123.1">doctest</span></span></span></span><span class="kobospan" id="kobo.1124.1"> tool, see the </span><a href="ch019_split_000.xhtml#x1-7950001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1125.1">Using docstrings for testing</span></span></a><span class="kobospan" id="kobo.1126.1"> recipe. </span><span class="kobospan" id="kobo.1126.2">For examples of using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1127.1">pytest</span></span></span></span><span class="kobospan" id="kobo.1128.1"> tool, see the </span><a href="ch019_split_001.xhtml#x1-8310006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1129.1">Unit testing with the pytest</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1130.1">module</span></span></a><span class="kobospan" id="kobo.1131.1"> recipe.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1132.1">Frequently, documentation will contain </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1133.1">doctest</span></span></span></span><span class="kobospan" id="kobo.1134.1">. </span><span class="kobospan" id="kobo.1134.2">We need to be sure all examples – in docstrings and documentation – work correctly. </span><span class="kobospan" id="kobo.1134.3">In this recipe, we’ll combine these </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1135.1">doctest</span></span></span></span><span class="kobospan" id="kobo.1136.1"> examples and the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1137.1">pytest</span></span></span></span><span class="kobospan" id="kobo.1138.1"> test cases into one tidy package. </span><span id="x1-837002r1781"/></p>
<section data-number="0.18.7.1" id="getting-ready-116">
<h2 class="likechapterhead" data-number="0.18.7.1"><span><span class="kobospan" id="kobo.1139.1">15.7.1 </span></span> <span id="x1-8380001"/><span class="kobospan" id="kobo.1140.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1141.1">We’ll refer back to the example from the </span><a href="ch019_split_000.xhtml#x1-7950001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1142.1">Using docstrings for testing</span></span></a><span class="kobospan" id="kobo.1143.1"> recipe. </span><span class="kobospan" id="kobo.1143.2">This recipe created tests for a class, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1144.1">Summary</span></span></span></span><span class="kobospan" id="kobo.1145.1">, that does some statistical calculations. </span><span class="kobospan" id="kobo.1145.2">In that recipe, we included examples in the docstrings.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1146.1">In the </span><a href="ch019_split_001.xhtml#x1-8310006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1147.1">Unit testing with the pytest module</span></span></a><span class="kobospan" id="kobo.1148.1"> recipe, we wrote some test functions to provide additional tests for this class. </span><span class="kobospan" id="kobo.1148.2">These tests were put into a separate module, with a name starting with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1149.1">test_</span></span></span></span><span class="kobospan" id="kobo.1150.1">, specifically, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1151.1">test_summary.py</span></span></span></span><span class="kobospan" id="kobo.1152.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1153.1">Following the </span><a href="ch019_split_000.xhtml#x1-8250005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1154.1">Combining unittest and doctest tests</span></span></a><span class="kobospan" id="kobo.1155.1"> recipe, we’ll also assume</span><span id="dx1-838001"/><span class="kobospan" id="kobo.1156.1"> there’s a project folder structure that looks like the following directory tree:</span></p>
<pre class="programlisting" id="listing-108"><code class="calibre13"><span class="kobospan" id="kobo.1157.1">project-name/ 
 
    src/ 
 
        summary.py 
 
    tests/ 
 
        test_summary.py 
 
    README 
 
    pyproject.toml 
 
    requirements.txt 
 
    tox.ini</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1158.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1159.1">tests</span></span></span></span><span class="kobospan" id="kobo.1160.1"> directory should contain all the module files with tests. </span><span class="kobospan" id="kobo.1160.2">We’ve chosen the directory named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1161.1">tests</span></span></span></span><span class="kobospan" id="kobo.1162.1"> and a module named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1163.1">test_*.py</span></span></span></span><span class="kobospan" id="kobo.1164.1"> so that they fit well with the automated test discovery features of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1165.1">pytest</span></span></span></span><span class="kobospan" id="kobo.1166.1"> tool.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1167.1">The recipe examples use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1168.1">recipe_07</span></span></span></span><span class="kobospan" id="kobo.1169.1"> instead of a cooler name such as </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1170.1">summary</span></span></span></span><span class="kobospan" id="kobo.1171.1">. </span><span class="kobospan" id="kobo.1171.2">As a general practice, a module should have a memorable, meaningful name. </span><span class="kobospan" id="kobo.1171.3">The book’s content is quite large, and the names are designed to match the overall chapter and recipe outline. </span><span id="x1-838011r1783"/></p>
</section>
<section data-number="0.18.7.2" id="how-to-do-it...-117">
<h2 class="likechapterhead" data-number="0.18.7.2"><span><span class="kobospan" id="kobo.1172.1">15.7.2 </span></span> <span id="x1-8390002"/><span class="kobospan" id="kobo.1173.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1174.1">It turns out that we don’t need to write any Python code to combine the tests. </span><span class="kobospan" id="kobo.1174.2">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1175.1">pytest </span></span><span class="kobospan" id="kobo.1176.1">module will locate test functions. </span><span class="kobospan" id="kobo.1176.2">It can also be used to locate doctest cases:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-839002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1177.1">Create a shell command to run the test suite in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1178.1">recipe_07.py</span></span></span></span><span class="kobospan" id="kobo.1179.1"> file, as well as to examine the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1180.1">recipe_01.py</span></span></span></span><span class="kobospan" id="kobo.1181.1"> module for the additional doctest cases:</span></p>
<pre class="programlisting" id="listing-109"><code class="calibre13"><span class="kobospan" id="kobo.1182.1">% pytest recipe_07.py --doctest-modules recipe_01.py</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.1183.1">When we run this from the OS command prompt, we see the following:</span></p>
<pre class="programlisting" id="listing-110"><code class="calibre13"><span class="kobospan" id="kobo.1184.1">(cookbook3) % pytest recipe_07.py --doctest-modules recipe_01.py 
 
=========================== test session starts ============================ 
 
platform darwin -- Python 3.12.0, pytest-7.4.3, pluggy-1.3.0 
 
rootdir: /Users/slott/Documents/Writing/Python/Python Cookbook 3e 
 
configfile: pytest.ini 
 
plugins: anyio-4.0.0 
 
collected 7 items 
 
 
 
recipe_07.py .. </span><span class="kobospan" id="kobo.1184.2">                                                     [ 28%] 
 
recipe_01.py ..... </span><span class="kobospan" id="kobo.1184.3">                                                  [100%] 
 
 
 
============================ 7 passed in 0.06s =============================</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1185.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1186.1">pytest</span></span></span></span><span class="kobospan" id="kobo.1187.1"> command worked</span><span id="dx1-839016"/><span class="kobospan" id="kobo.1188.1"> with both files. </span><span class="kobospan" id="kobo.1188.2">The dots after </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1189.1">recipe_07.py</span></span></span></span><span class="kobospan" id="kobo.1190.1"> show that two test cases were found in this file. </span><span class="kobospan" id="kobo.1190.2">This was 28% of the test suite. </span><span class="kobospan" id="kobo.1190.3">The dots after </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1191.1">recipe_01.py</span></span></span></span><span class="kobospan" id="kobo.1192.1"> show that five test cases more were found; this was the remaining 72% of the suite.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1193.1">This shows us that the pytest test cases were included as well as doctest test cases. </span><span class="kobospan" id="kobo.1193.2">What’s helpful is that we don’t have to adjust anything in either of the test suites to execute all of the available test cases. </span><span id="x1-839017r1784"/></p>
</section>
<section data-number="0.18.7.3" id="how-it-works...-117">
<h2 class="likechapterhead" data-number="0.18.7.3"><span><span class="kobospan" id="kobo.1194.1">15.7.3 </span></span> <span id="x1-8400003"/><span class="kobospan" id="kobo.1195.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1196.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1197.1">pytest</span></span></span></span><span class="kobospan" id="kobo.1198.1"> application has a variety of ways to search for test cases. </span><span class="kobospan" id="kobo.1198.2">The default is to search the given paths for all functions with names that start with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1199.1">test_</span></span></span></span><span class="kobospan" id="kobo.1200.1"> in a given module. </span><span class="kobospan" id="kobo.1200.2">It will also search for all subclasses of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1201.1">TestCase</span></span></span></span><span class="kobospan" id="kobo.1202.1">. </span><span class="kobospan" id="kobo.1202.2">If we provide a directory, it will search it for all modules with names that begin with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1203.1">test_</span></span></span></span><span class="kobospan" id="kobo.1204.1">. </span><span class="kobospan" id="kobo.1204.2">Often, we’ll collect our test files in a directory named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1205.1">tests</span></span></span></span><span class="kobospan" id="kobo.1206.1"> because this is the default directory that will be searched.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1207.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1208.1">--doctest-modules</span></span></span></span><span class="kobospan" id="kobo.1209.1"> command-line option is used to mark modules that contain doctest examples. </span><span class="kobospan" id="kobo.1209.2">These examples are also added to the test suite as test cases.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1210.1">This level of sophistication in finding and executing a variety of types of tests makes </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1211.1">pytest </span></span><span class="kobospan" id="kobo.1212.1">a very powerful tool. </span><span class="kobospan" id="kobo.1212.2">It makes it easy to create tests in a variety of forms to create confidence that our software</span><span id="dx1-840001"/><span class="kobospan" id="kobo.1213.1"> will work as intended. </span><span id="x1-840002r1785"/></p>
</section>
<section data-number="0.18.7.4" id="theres-more...-108">
<h2 class="likechapterhead" data-number="0.18.7.4"><span><span class="kobospan" id="kobo.1214.1">15.7.4 </span></span> <span id="x1-8410004"/><span class="kobospan" id="kobo.1215.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1216.1">Adding the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1217.1">-v</span></span></span></span><span class="kobospan" id="kobo.1218.1"> option provides a more detailed view of the tests found by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1219.1">pytest</span></span></span></span><span class="kobospan" id="kobo.1220.1"> tool. </span><span class="kobospan" id="kobo.1220.2">Here’s how the additional details are displayed:</span></p>
<pre class="programlisting" id="listing-111"><code class="calibre13"><span class="kobospan" id="kobo.1221.1">(cookbook3) % python -m pytest -v recipe_07.py --doctest-modules recipe_01.py 
 
=========================== test session starts ============================ 
 
platform darwin -- Python 3.12.0, pytest-7.4.3, pluggy-1.3.0 -- /Users/slott/miniconda3/envs/cookbook3/bin/python 
 
cachedir: .pytest_cache 
 
rootdir: /Users/slott/Documents/Writing/Python/Python Cookbook 3e 
 
configfile: pytest.ini 
 
plugins: anyio-4.0.0 
 
collected 7 items 
 
 
 
recipe_07.py::recipe_07.__test__.test_example_class PASSED           [ 14%] 
 
recipe_07.py::test_flat PASSED                                       [ 28%] 
 
recipe_01.py::recipe_01.Summary PASSED                               [ 42%] 
 
recipe_01.py::recipe_01.__test__.GIVEN_binom_WHEN_0_0_THEN_1 PASSED  [ 57%] 
 
recipe_01.py::recipe_01.__test__.GIVEN_binom_WHEN_52_52_THEN_1 PASSED [ 71%] 
 
recipe_01.py::recipe_01.binom PASSED                                 [ 85%] 
 
recipe_01.py::recipe_01.binom2 PASSED                                [100%] 
 
 
 
============================ 7 passed in 0.05s =============================</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1222.1">Each individual test is identified, providing us with a detailed explanation of the test processing. </span><span class="kobospan" id="kobo.1222.2">This can help confirm that all of the expected doctest examples were properly located in the module under test. </span><span id="x1-841019r1786"/></p>
</section>
<section data-number="0.18.7.5" id="see-also-115">
<h2 class="likechapterhead" data-number="0.18.7.5"><span><span class="kobospan" id="kobo.1223.1">15.7.5 </span></span> <span id="x1-8420005"/><span class="kobospan" id="kobo.1224.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1225.1">For examples of doctest, see the </span><a href="ch019_split_000.xhtml#x1-7950001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1226.1">Using docstrings for testing</span></span></a><span class="kobospan" id="kobo.1227.1"> recipe earlier in this chapter.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1228.1">The </span><a href="ch019_split_001.xhtml#x1-8310006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1229.1">Unit testing with the pytest module</span></span></a><span class="kobospan" id="kobo.1230.1"> recipe earlier in this chapter has the pytest test cases used for this recipe.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1231.1">For examples of the unittest version of these tests, see the </span><a href="ch019_split_000.xhtml#x1-8190004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1232.1">Unit testing</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1233.1">with the unittest module</span></span></a><span class="kobospan" id="kobo.1234.1"> recipe earlier in this chapter.</span></p></li>
</ul>
<p class="normal1"><span id="x1-842001r1782"/></p>
</section>
</section>
<section data-number="0.18.8" id="testing-things-that-involve-dates-or-times">
<h1 class="unnumbered" data-number="0.18.8"><span><span class="kobospan" id="kobo.1235.1">15.8 </span></span> <span id="x1-8430008"/><span class="kobospan" id="kobo.1236.1">Testing things that involve dates or times</span></h1>
<p class="normal"><span class="kobospan" id="kobo.1237.1">Many applications</span><span id="dx1-843001"/><span class="kobospan" id="kobo.1238.1"> rely on functions</span><span id="dx1-843002"/><span class="kobospan" id="kobo.1239.1"> like </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1240.1">datetime.datetime.now()</span></span></span></span><span class="kobospan" id="kobo.1241.1"> or </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1242.1">time.time()</span></span></span></span><span class="kobospan" id="kobo.1243.1"> to create a timestamp. </span><span class="kobospan" id="kobo.1243.2">When we use one of these functions with a unit test, the results are essentially impossible to predict. </span><span class="kobospan" id="kobo.1243.3">This is an interesting dependency injection problem here: our application depends on a class that we would like to replace only when we’re testing.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1244.1">One option is to design our application to avoid functions like </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1245.1">now()</span></span></span></span><span class="kobospan" id="kobo.1246.1">. </span><span class="kobospan" id="kobo.1246.2">Instead of using this method directly, we can create a factory function that emits timestamps. </span><span class="kobospan" id="kobo.1246.3">For test purposes, this function can be replaced with one that produces known results.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1247.1">The alternative is called </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1248.1">monkey-patching </span></span><span class="kobospan" id="kobo.1249.1">– injecting a new object at test time. </span><span class="kobospan" id="kobo.1249.2">This can reduce the design complexity; it tends to increase the test complexity.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1250.1">In this recipe, we’ll write tests with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1251.1">datetime</span></span></span></span><span class="kobospan" id="kobo.1252.1"> objects. </span><span class="kobospan" id="kobo.1252.2">We’ll need to create mock objects for </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1253.1">datetime</span></span></span></span><span class="kobospan" id="kobo.1254.1"> instances to create repeatable test values. </span><span class="kobospan" id="kobo.1254.2">We’ll use the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1255.1">pytest </span></span><span class="kobospan" id="kobo.1256.1">package features for monkey-patching. </span><span id="x1-843003r1787"/></p>
<section data-number="0.18.8.1" id="getting-ready-117">
<h2 class="likechapterhead" data-number="0.18.8.1"><span><span class="kobospan" id="kobo.1257.1">15.8.1 </span></span> <span id="x1-8440001"/><span class="kobospan" id="kobo.1258.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1259.1">We’ll work with a small function that creates a CSV file. </span><span class="kobospan" id="kobo.1259.2">This file’s name will include the date and time in the format of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1260.1">YYYYMMDDHHMMSS</span></span></span></span><span class="kobospan" id="kobo.1261.1"> as a long string of digits. </span><span class="kobospan" id="kobo.1261.2">This kind of file-naming convention might be used by a long-running server application. </span><span class="kobospan" id="kobo.1261.3">The name helps match a file and related log events. </span><span class="kobospan" id="kobo.1261.4">It can help to trace the work being done by the server.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1262.1">The application uses this function to create these files:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1263.1">import datetime 
 
import json 
 
from pathlib import Path 
 
from typing import Any 
 
 
 
 
 
def save_data(base: Path, some_payload: Any) -&gt; None: 
 
    now_date = datetime.datetime.now(tz=datetime.timezone.utc) 
 
    now_text = now_date.strftime("extract_%Y%m%d%H%M%S") 
 
    file_path = (base / now_text).with_suffix(".json") 
 
    with file_path.open("w") as target_file: 
 
        json.dump(some_payload, target_file, indent=2)
                                                                     

                                                                     </span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1264.1">This function has the use</span><span id="dx1-844014"/><span class="kobospan" id="kobo.1265.1"> of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1266.1">now()</span></span></span></span><span class="kobospan" id="kobo.1267.1">, which produces</span><span id="dx1-844015"/><span class="kobospan" id="kobo.1268.1"> a distinct value each time this is run. </span><span class="kobospan" id="kobo.1268.2">Since this value is difficult to predict, it makes test assertions difficult to write.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1269.1">To create a reproducible test output, we can create a mock version of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1270.1">datetime</span></span></span></span><span class="kobospan" id="kobo.1271.1"> module. </span><span class="kobospan" id="kobo.1271.2">We can then </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1272.1">monkey patch </span></span><span class="kobospan" id="kobo.1273.1">the test context to use this mock object instead of the actual </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1274.1">datetime</span></span></span></span><span class="kobospan" id="kobo.1275.1"> module. </span><span class="kobospan" id="kobo.1275.2">Within the mocked module, we can create a mock class with a mock </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1276.1">now()</span></span></span></span><span class="kobospan" id="kobo.1277.1"> method to provide a fixed, easy-to-test response.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1278.1">For this case, we have a scenario like this:</span></p>
<pre class="programlisting" id="listing-112"><code class="calibre13"><span class="kobospan" id="kobo.1279.1">Scenario: save_date function writes JSON data to a date-stamped file. 
 
 
 
Given a base directory Path 
 
And a payload object {"primes": [2, 3, 5, 7, 11, 13, 17, 19]} 
 
And a known date and time of 2017-9-10 11:12:13 UTC 
 
When save_data(base, payload) function is executed 
 
Then the output file of "extract_20170910111213.json" is found in the base directory 
 
And the output file has a properly serialized version of the payload 
 
And the datetime.datetime.now() function was called once to get the date and time</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1280.1">This can be implemented</span><span id="dx1-844025"/><span class="kobospan" id="kobo.1281.1"> as a test case using the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1282.1">pytest </span></span><span class="kobospan" id="kobo.1283.1">constructs. </span><span id="x1-844026r1789"/></p>
</section>
<section data-number="0.18.8.2" id="how-to-do-it...-118">
<h2 class="likechapterhead" data-number="0.18.8.2"><span><span class="kobospan" id="kobo.1284.1">15.8.2 </span></span> <span id="x1-8450002"/><span class="kobospan" id="kobo.1285.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1286.1">This recipe will create</span><span id="dx1-845001"/><span class="kobospan" id="kobo.1287.1"> and patch mock objects</span><span id="dx1-845002"/><span class="kobospan" id="kobo.1288.1"> to create a test fixture:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-845004x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1289.1">We’ll need to import a number of modules required by the module we’re testing:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1290.1">import datetime 
 
import json 
 
from pathlib import Path</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-845010x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1291.1">We’ll also need the core tools for creating mock objects and test fixtures. </span><span class="kobospan" id="kobo.1291.2">Also, we’ll need the module we’re going to test:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1292.1">from unittest.mock import Mock 
 
import pytest 
 
 
 
import recipe_08</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-845017x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1293.1">We must create an object that will behave like the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1294.1">datetime</span></span></span></span><span class="kobospan" id="kobo.1295.1"> module for the purposes of the test scenario. </span><span class="kobospan" id="kobo.1295.2">This mocked module must</span><span id="dx1-845018"/><span class="kobospan" id="kobo.1296.1"> contain a name that appears to be a class, also named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1297.1">datetime</span></span></span></span><span class="kobospan" id="kobo.1298.1">. </span><span class="kobospan" id="kobo.1298.2">The class must appear</span><span id="dx1-845019"/><span class="kobospan" id="kobo.1299.1"> to contain a method, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1300.1">now()</span></span></span></span><span class="kobospan" id="kobo.1301.1">, which returns a known object rather than a date that changes each time the test is run. </span><span class="kobospan" id="kobo.1301.2">We’ll create a fixture, and the fixture will return this mock object with a small set of attributes and behaviors defined:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1302.1">@pytest.fixture() 
 
def mock_datetime() -&gt; Mock: 
 
    return Mock( 
 
        name="mock datetime", 
 
        datetime=Mock( 
 
            name="mock datetime.datetime", 
 
            now=Mock(return_value=datetime.datetime(2017, 9, 10, 11, 12, 13)), 
 
        ), 
 
        timezone=Mock(name="mock datetime.timezone", utc=Mock(name="UTC")), 
 
    )</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1303.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1304.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1305.1"> object is a </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1306.1">namespace</span></span><span class="kobospan" id="kobo.1307.1">, a feature that packages, modules, and classes all share. </span><span class="kobospan" id="kobo.1307.2">In this example, each attribute name is another </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1308.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1309.1"> object. </span><span class="kobospan" id="kobo.1309.2">The most deeply-buried object has a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1310.1">return_value</span></span></span></span><span class="kobospan" id="kobo.1311.1"> attribute to make it behave like a function.</span></p>
</div></li>
<li class="calibre7"><div id="x1-845032x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1312.1">We also need a way to isolate the behavior of the filesystem into test directories. </span><span class="kobospan" id="kobo.1312.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1313.1">tmppath</span></span></span></span><span class="kobospan" id="kobo.1314.1"> fixture is built in to </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1315.1">pytest</span></span></span></span><span class="kobospan" id="kobo.1316.1"> and provides temporary directories into which test files can be written safely.</span></p>
</div></li>
<li class="calibre7"><div id="x1-845034x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1317.1">We can now define a test function</span><span id="dx1-845035"/><span class="kobospan" id="kobo.1318.1"> that will use</span><span id="dx1-845036"/><span class="kobospan" id="kobo.1319.1"> the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1320.1">mock_datetime</span></span></span></span><span class="kobospan" id="kobo.1321.1"> fixture and the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1322.1">tmppath</span></span></span></span><span class="kobospan" id="kobo.1323.1"> fixture. </span><span class="kobospan" id="kobo.1323.2">It will use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1324.1">monkeypatch</span></span></span></span><span class="kobospan" id="kobo.1325.1"> fixture to adjust the context of the module under test:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1326.1">def test_save_data( 
 
    mock_datetime: Mock, tmp_path: Path, monkeypatch: pytest.MonkeyPatch 
 
) -&gt; None:</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-845042x6" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1327.1">We can use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1328.1">monkeypatch</span></span></span></span><span class="kobospan" id="kobo.1329.1"> fixture to replace an attribute of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1330.1">recipe_08</span></span></span></span><span class="kobospan" id="kobo.1331.1"> module. </span><span class="kobospan" id="kobo.1331.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1332.1">datetime</span></span></span></span><span class="kobospan" id="kobo.1333.1"> attribute value will be replaced with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1334.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1335.1"> object created by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1336.1">mock_datetime</span></span></span></span><span class="kobospan" id="kobo.1337.1"> fixture:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1338.1">
    monkeypatch.setattr(recipe_08, "datetime", mock_datetime)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1339.1">Between the fixture definitions and this patch, we’ve created a </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1340.1">Given</span></span><span class="kobospan" id="kobo.1341.1"> step that defines the test arrangement.</span></p>
</div></li>
<li class="calibre7"><div id="x1-845046x7" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1342.1">We can now exercise the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1343.1">save_data()</span></span></span></span><span class="kobospan" id="kobo.1344.1"> function in a controlled test environment. </span><span class="kobospan" id="kobo.1344.2">This is the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1345.1">When </span></span><span class="kobospan" id="kobo.1346.1">step that exercises the code under test:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1347.1">
    data = {"primes": [2, 3, 5, 7, 11, 13, 17, 19]} 
 
    recipe_08.save_data(tmp_path, data)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-845051x8" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1348.1">Since the date and time are fixed by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1349.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1350.1"> object, the output file has a known, predictable name. </span><span class="kobospan" id="kobo.1350.2">We can read and validate the expected data in the file. </span><span class="kobospan" id="kobo.1350.3">Further, we can interrogate the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1351.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1352.1"> object to be sure it was called exactly once with no argument values. </span><span class="kobospan" id="kobo.1352.2">This is a </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1353.1">Then</span></span><span class="kobospan" id="kobo.1354.1"> step to confirm the expected results:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1355.1">
    expected_path = tmp_path / "extract_20170910111213.json" 
 
    with expected_path.open() as result_file: 
 
        result_data = json.load(result_file) 
 
    assert data == result_data 
 
    mock_datetime.datetime.now.assert_called_once_with(tz=mock_datetime. 
 
                                                       timezone.utc)
                                                                     

                                                                     </span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.1356.1">This test confirms the application’s </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1357.1">save_data()</span></span></span></span><span class="kobospan" id="kobo.1358.1"> function will create the expected file with the proper content. </span><span id="x1-845059r1791"/></p>
</section>
<section data-number="0.18.8.3" id="how-it-works...-118">
<h2 class="likechapterhead" data-number="0.18.8.3"><span><span class="kobospan" id="kobo.1359.1">15.8.3 </span></span> <span id="x1-8460003"/><span class="kobospan" id="kobo.1360.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1361.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1362.1">unittest.mock</span></span></span></span><span class="kobospan" id="kobo.1363.1"> module has a wonderfully</span><span id="dx1-846001"/><span class="kobospan" id="kobo.1364.1"> sophisticated class</span><span id="dx1-846002"/><span class="kobospan" id="kobo.1365.1"> definition, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1366.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1367.1"> class. </span><span class="kobospan" id="kobo.1367.2">A </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1368.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1369.1"> object can behave like other Python objects, while offering a limited subset of behaviors. </span><span class="kobospan" id="kobo.1369.2">In this example, we’ve created three different kinds of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1370.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1371.1"> objects.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1372.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1373.1">Mock(wraps="datetime",</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1374.1"> ...)</span></span></span></span><span class="kobospan" id="kobo.1375.1"> object mocks a complete module. </span><span class="kobospan" id="kobo.1375.2">It will behave, to the extent needed by this test scenario, like the standard library </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1376.1">datetime</span></span></span></span><span class="kobospan" id="kobo.1377.1"> module. </span><span class="kobospan" id="kobo.1377.2">Within this object, we created a mock class definition but didn’t assign it to any variable.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1378.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1379.1">Mock(now=...)</span></span></span></span><span class="kobospan" id="kobo.1380.1"> object behaves like a mock class definition inside the mock module. </span><span class="kobospan" id="kobo.1380.2">We’ve created a single </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1381.1">now</span></span></span></span><span class="kobospan" id="kobo.1382.1"> attribute value, which will behave like a static function.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1383.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1384.1">Mock(return_value=...)</span></span></span></span><span class="kobospan" id="kobo.1385.1"> object behaves like an ordinary function or method. </span><span class="kobospan" id="kobo.1385.2">We provide the return value required for this test.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1386.1">In addition to returning the given value, a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1387.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1388.1"> object records the history of calls. </span><span class="kobospan" id="kobo.1388.2">This means an assertion can checks those calls. </span><span class="kobospan" id="kobo.1388.3">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1389.1">call()</span></span></span></span><span class="kobospan" id="kobo.1390.1"> function from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1391.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1392.1"> module provides a way to describe the arguments that are expected in the function call. </span><span id="x1-846003r1799"/></p>
</section>
<section data-number="0.18.8.4" id="theres-more...-109">
<h2 class="likechapterhead" data-number="0.18.8.4"><span><span class="kobospan" id="kobo.1393.1">15.8.4 </span></span> <span id="x1-8470004"/><span class="kobospan" id="kobo.1394.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1395.1">In this example, we created a mock for the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1396.1">datetime</span></span></span></span><span class="kobospan" id="kobo.1397.1"> module that had a very narrow feature set for this test. </span><span class="kobospan" id="kobo.1397.2">The module contained a mocked class named </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1398.1">datetime</span></span></span></span><span class="kobospan" id="kobo.1399.1">. </span><span class="kobospan" id="kobo.1399.2">This class has a single attribute, a mocked function, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1400.1">now()</span></span></span></span><span class="kobospan" id="kobo.1401.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1402.1">Instead of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1403.1">return_value</span></span></span></span><span class="kobospan" id="kobo.1404.1"> attribute, we can use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1405.1">side_effect</span></span></span></span><span class="kobospan" id="kobo.1406.1"> attribute to raise an exception instead of returning a value. </span><span class="kobospan" id="kobo.1406.2">We can use this to spot code that’s not using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1407.1">now()</span></span></span></span><span class="kobospan" id="kobo.1408.1"> method properly, but using the deprecated </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1409.1">utcnow()</span></span></span></span><span class="kobospan" id="kobo.1410.1"> or the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1411.1">today()</span></span></span></span><span class="kobospan" id="kobo.1412.1"> methods.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1413.1">We can extend this pattern and mock more than one attribute to behave like a function. </span><span class="kobospan" id="kobo.1413.2">Here’s an example that mocks several functions:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1414.1">@pytest.fixture() 
 
def mock_datetime_now() -&gt; Mock: 
 
    return Mock( 
 
        name="mock datetime", 
 
        datetime=Mock( 
 
            name="mock datetime.datetime", 
 
            utcnow=Mock(side_effect=AssertionError("Convert to now()")), 
 
            today=Mock(side_effect=AssertionError("Convert to now()")), 
 
            now=Mock(return_value=datetime.datetime(2017, 7, 4, 4, 2, 3)), 
 
        ),</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1415.1">Two of the mocked methods, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1416.1">utcnow()</span></span></span></span><span class="kobospan" id="kobo.1417.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1418.1">today()</span></span></span></span><span class="kobospan" id="kobo.1419.1">, each define a side effect that will raise an exception. </span><span class="kobospan" id="kobo.1419.2">This allows us confirm legacy code has been converted to make proper use of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1420.1">now()</span></span></span></span><span class="kobospan" id="kobo.1421.1"> method. </span><span id="x1-847013r1800"/></p>
</section>
<section data-number="0.18.8.5" id="see-also-116">
<h2 class="likechapterhead" data-number="0.18.8.5"><span><span class="kobospan" id="kobo.1422.1">15.8.5 </span></span> <span id="x1-8480005"/><span class="kobospan" id="kobo.1423.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1424.1">The </span><a href="ch019_split_000.xhtml#x1-8190004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1425.1">Unit testing with the unittest module</span></span></a><span class="kobospan" id="kobo.1426.1"> recipe earlier in this chapter has more information about the basic use of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1427.1">unittest</span></span></span></span><span class="kobospan" id="kobo.1428.1"> module.</span></p></li>
</ul>
<p class="normal1"><span id="x1-848001r1788"/></p>
</section>
</section>
<section data-number="0.18.9" id="testing-things-that-involve-randomness">
<h1 class="unnumbered" data-number="0.18.9"><span><span class="kobospan" id="kobo.1429.1">15.9 </span></span> <span id="x1-8490009"/><span class="kobospan" id="kobo.1430.1">Testing things that involve randomness</span></h1>
<p class="normal"><span class="kobospan" id="kobo.1431.1">Many applications rely</span><span id="dx1-849001"/><span class="kobospan" id="kobo.1432.1"> on the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1433.1">random</span></span></span></span><span class="kobospan" id="kobo.1434.1"> module to create random values or put values into a random order. </span><span class="kobospan" id="kobo.1434.2">In many statistical tests, repeated random shuffling or random selection is done. </span><span class="kobospan" id="kobo.1434.3">When we want to test one of these algorithms, any intermediate results or details of the processing are essentially impossible to predict.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1435.1">We have two choices for trying to make the random module predictable enough to write detailed unit tests:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1436.1">Use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1437.1">random</span></span></span></span><span class="kobospan" id="kobo.1438.1"> module with a known seed value.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1439.1">Use a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1440.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1441.1"> object to replace the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1442.1">random</span></span></span></span><span class="kobospan" id="kobo.1443.1"> module with a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1444.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1445.1"> object to produce predictable values.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.1446.1">In this recipe, we’ll look at ways to unit test algorithms that involve randomness. </span><span id="x1-849002r1802"/></p>
<section data-number="0.18.9.1" id="getting-ready-118">
<h2 class="likechapterhead" data-number="0.18.9.1"><span><span class="kobospan" id="kobo.1447.1">15.9.1 </span></span> <span id="x1-8500001"/><span class="kobospan" id="kobo.1448.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1449.1">Given a sample dataset, we can compute</span><span id="dx1-850001"/><span class="kobospan" id="kobo.1450.1"> a statistical measure such as a mean or median. </span><span class="kobospan" id="kobo.1450.2">A common next step is to determine the likely values of these statistical measures for some overall population. </span><span class="kobospan" id="kobo.1450.3">This can</span><span id="dx1-850002"/><span class="kobospan" id="kobo.1451.1"> be done by a technique called </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1452.1">bootstrapping</span></span><span class="kobospan" id="kobo.1453.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1454.1">The idea is to resample the initial set of data repeatedly. </span><span class="kobospan" id="kobo.1454.2">Each of the resamples provides a different estimate of the statistical measures for the population.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1455.1">In order to be sure that a resampling algorithm is implemented correctly, it helps to eliminate randomness from the processing. </span><span class="kobospan" id="kobo.1455.2">We can resample a carefully planned set of data with a non-randomized version of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1456.1">random.choice()</span></span></span></span><span class="kobospan" id="kobo.1457.1"> function. </span><span class="kobospan" id="kobo.1457.2">If this works properly, then we have confidence that the randomized version will also work.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1458.1">Here’s our candidate resampling function:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1459.1">from collections.abc import Iterator 
 
import random 
 
 
 
def resample(population: list[int], N: int) -&gt; Iterator[int]: 
 
    for i in range(N): 
 
        sample = random.choice(population) 
 
        yield sample</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1460.1">For our example, we’ll compute alternative values of the mean based on resampling. </span><span class="kobospan" id="kobo.1460.2">The overall resampling procedure looks like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1461.1">from collections import Counter 
 
import statistics 
 
 
 
def mean_distribution(population: list[int], N: int) -&gt; Counter[float]: 
 
    means: Counter[float] = Counter() 
 
    for _ in range(1000): 
 
        subset = list(resample(population, N)) 
 
        measure = round(statistics.mean(subset), 1) 
 
        means[measure] += 1 
 
    return means
                                                                     

                                                                     </span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1462.1">This evaluates the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1463.1">resample()</span></span></span></span><span class="kobospan" id="kobo.1464.1"> function to create</span><span id="dx1-850022"/><span class="kobospan" id="kobo.1465.1"> a number of subsets. </span><span class="kobospan" id="kobo.1465.2">Each subset’s mean populates the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1466.1">means</span></span></span></span><span class="kobospan" id="kobo.1467.1"> collection. </span><span class="kobospan" id="kobo.1467.2">The histogram created by this </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1468.1">mean_distribution()</span></span></span></span><span class="kobospan" id="kobo.1469.1"> function will provide a helpful estimate for population variance.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1470.1">Here’s what the output looks like:</span></p>
<div class="tipbox" id="tcolobox-30">
<span id="x1-850028x1"/>
<div class="note">
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1471.1">&gt;&gt;&gt; random.seed(42) 
 
&gt;&gt;&gt; population = [8.04, 6.95, 7.58, 8.81, 8.33, 9.96, 7.24, 4.26, 10.84, 4.82, 5.68] 
 
 
 
&gt;&gt;&gt; mean_distribution(population, 4).most_common(5) 
 
[(7.8, 51), (7.2, 45), (7.5, 44), (7.1, 41), (7.7, 40)]</span></code></pre>
</div>
</div>
<p class="normal1"><span class="kobospan" id="kobo.1472.1">This shows us that the most likely value for the mean of the overall population could be between 7.1 and 7.8. </span><span class="kobospan" id="kobo.1472.2">There’s more to this kind of analysis than we’re showing here. </span><span class="kobospan" id="kobo.1472.3">Our focus is limited to the narrow question of testing the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1473.1">resample()</span></span></span></span><span class="kobospan" id="kobo.1474.1"> function.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1475.1">The test for resampling involves a scenario like the following:</span></p>
<pre class="programlisting" id="listing-113"><code class="calibre13"><span class="kobospan" id="kobo.1476.1">Scenario: Resample example 
 
 
 
Given a random number generator where choice() always return the sequence [23, 29, 31, 37, 41, 43, 47, 53] 
 
When we evaluate the expression resample(any 8 values, 8) 
 
Then the expected results are [23, 29, 31, 37, 41, 43, 47, 53] 
 
And the choice() function was called 8 times</span></code></pre>
<p class="normal1"><span id="x1-850041r1804"/></p>
</section>
<section data-number="0.18.9.2" id="how-to-do-it...-119">
<h2 class="likechapterhead" data-number="0.18.9.2"><span><span class="kobospan" id="kobo.1477.1">15.9.2 </span></span> <span id="x1-8510002"/><span class="kobospan" id="kobo.1478.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1479.1">We’ll define a mock object</span><span id="dx1-851001"/><span class="kobospan" id="kobo.1480.1"> that can be used instead of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1481.1">random.choice()</span></span></span></span><span class="kobospan" id="kobo.1482.1"> function. </span><span class="kobospan" id="kobo.1482.2">With this fixture in place, the results are fixed and predictable:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-851003x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1483.1">We’ll need the core tools for creating mock objects and test fixtures. </span><span class="kobospan" id="kobo.1483.2">Also, we’ll need the module we’re going to test:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1484.1">from unittest.mock import Mock 
 
import pytest 
 
import recipe_09</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-851009x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1485.1">We’ll need an object that will behave like the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1486.1">choice()</span></span></span></span><span class="kobospan" id="kobo.1487.1"> function. </span><span class="kobospan" id="kobo.1487.2">We’ll create a fixture built on another fixture:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1488.1">@pytest.fixture() 
 
def expected_resample_data() -&gt; list[int]: 
 
    return [23, 29, 31, 37, 41, 43, 47, 53] 
 
 
 
@pytest.fixture() 
 
def mock_random_choice(expected_resample_data: list[int]) -&gt; Mock: 
 
    mock_choice = Mock(name="mock random.choice", side_effect=expected_resample_data) 
 
    return mock_choice</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1489.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1490.1">expected_resample_data</span></span></span></span><span class="kobospan" id="kobo.1491.1"> fixture provides a specific list of values that will provide expected results. </span><span class="kobospan" id="kobo.1491.2">Using this fixture, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1492.1">mock_random_choice</span></span></span></span><span class="kobospan" id="kobo.1493.1"> choice fixture returns the expected values in response to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1494.1">choice()</span></span></span></span><span class="kobospan" id="kobo.1495.1"> function.</span></p>
</div></li>
<li class="calibre7"><div id="x1-851020x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1496.1">We can now define a test function that will use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1497.1">mock_random_choice</span></span></span></span><span class="kobospan" id="kobo.1498.1"> fixture, which creates a mock object, and the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1499.1">monkeypatch</span></span></span></span><span class="kobospan" id="kobo.1500.1"> fixture, which lets us adjust the context of the module under test:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1501.1">def test_resample( 
 
    mock_random_choice: Mock, 
 
    expected_resample_data: list[int], 
 
    monkeypatch: pytest.MonkeyPatch, 
 
) -&gt; None:</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-851028x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1502.1">We can use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1503.1">monkeypatch</span></span></span></span><span class="kobospan" id="kobo.1504.1"> fixture to replace the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1505.1">choice</span></span></span></span><span class="kobospan" id="kobo.1506.1"> attribute of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1507.1">random</span></span></span></span><span class="kobospan" id="kobo.1508.1"> module with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1509.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1510.1"> object created by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1511.1">mock_random_choice</span></span></span></span><span class="kobospan" id="kobo.1512.1"> fixture:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1513.1">
    monkeypatch.setattr(recipe_09.random, "choice", mock_random_choice)  # type: ignore [attr-defined]</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1514.1">Between the fixture definitions and this patch, we’ve created a </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1515.1">Given</span></span><span class="kobospan" id="kobo.1516.1"> step that defines the test arrangement.</span></p>
</div></li>
<li class="calibre7"><div id="x1-851032x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1517.1">We can now exercise the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1518.1">resample()</span></span></span></span><span class="kobospan" id="kobo.1519.1"> function in a controlled test environment. </span><span class="kobospan" id="kobo.1519.2">This is the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1520.1">When </span></span><span class="kobospan" id="kobo.1521.1">step that exercises the code under test:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1522.1">
    data = [2, 3, 5, 7, 11, 13, 17, 19] 
 
    resample_data = list(recipe_09.resample(data, 8))</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-851037x6" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1523.1">Since the random choices are fixed by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1524.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1525.1"> object, the result is fixed. </span><span class="kobospan" id="kobo.1525.2">We can confirm that the data created by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1526.1">mock_random_choice</span></span></span></span><span class="kobospan" id="kobo.1527.1"> fixture was used for resampling. </span><span class="kobospan" id="kobo.1527.2">We can also confirm that the mocked choice function was properly called with the input data:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1528.1">
    assert resample_data == expected_resample_data 
 
    assert mock_random_choice.mock_calls == 8 * [call(data)]</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.1529.1">This test helps to confirm</span><span id="dx1-851041"/><span class="kobospan" id="kobo.1530.1"> that our </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1531.1">resample()</span></span></span></span><span class="kobospan" id="kobo.1532.1"> function will create the output based on the given input and the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1533.1">random.choice()</span></span></span></span><span class="kobospan" id="kobo.1534.1"> function. </span><span id="x1-851042r1808"/></p>
</section>
<section data-number="0.18.9.3" id="how-it-works...-119">
<h2 class="likechapterhead" data-number="0.18.9.3"><span><span class="kobospan" id="kobo.1535.1">15.9.3 </span></span> <span id="x1-8520003"/><span class="kobospan" id="kobo.1536.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1537.1">When we create a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1538.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1539.1"> object, we must provide the methods and attributes to define the behavior of the object being mocked. </span><span class="kobospan" id="kobo.1539.2">When we create an instance of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1540.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1541.1"> that provides the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1542.1">side_effect</span></span></span></span><span class="kobospan" id="kobo.1543.1"> argument value, we’re creating a callable object. </span><span class="kobospan" id="kobo.1543.2">The callable object will return the next value from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1544.1">side_effect</span></span></span></span><span class="kobospan" id="kobo.1545.1"> sequence each time the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1546.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1547.1"> object is called. </span><span class="kobospan" id="kobo.1547.2">This gives us a handy way to mock iterators.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1548.1">If any value in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1549.1">side_effect</span></span></span></span><span class="kobospan" id="kobo.1550.1"> is an exception, this is raised.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1551.1">We can also see the call history using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1552.1">mock_calls</span></span></span></span><span class="kobospan" id="kobo.1553.1"> attribute of a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1554.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1555.1"> object. </span><span class="kobospan" id="kobo.1555.2">This lets us confirm that the callable</span><span id="dx1-852001"/><span class="kobospan" id="kobo.1556.1"> was provided proper argument values. </span><span id="x1-852002r1815"/></p>
</section>
<section data-number="0.18.9.4" id="theres-more...-110">
<h2 class="likechapterhead" data-number="0.18.9.4"><span><span class="kobospan" id="kobo.1557.1">15.9.4 </span></span> <span id="x1-8530004"/><span class="kobospan" id="kobo.1558.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1559.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1560.1">resample()</span></span></span></span><span class="kobospan" id="kobo.1561.1"> function has an interesting pattern to it. </span><span class="kobospan" id="kobo.1561.2">When we take a step back from the details, we see this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1562.1">def resample_pattern(X: Any, Y: Any) -&gt; Iterator[Any]: 
 
    for _ in range(Y): 
 
        yield another_function(X)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1563.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1564.1">X</span></span></span></span><span class="kobospan" id="kobo.1565.1"> argument value is simply passed through to another function without any processing. </span><span class="kobospan" id="kobo.1565.2">For testing purposes, it doesn’t matter what the value of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1566.1">X</span></span></span></span><span class="kobospan" id="kobo.1567.1"> is. </span><span class="kobospan" id="kobo.1567.2">What we’re testing is that the parameter’s value in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1568.1">resample()</span></span></span></span><span class="kobospan" id="kobo.1569.1"> function is provided to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1570.1">another_function()</span></span></span></span><span class="kobospan" id="kobo.1571.1"> function, untouched.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1572.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1573.1">mock</span></span></span></span><span class="kobospan" id="kobo.1574.1"> library provides an object called </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1575.1">sentinel</span></span></span></span><span class="kobospan" id="kobo.1576.1"> that can be used to create an opaque argument value in these circumstances. </span><span class="kobospan" id="kobo.1576.2">When we refer to an attribute of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1577.1">sentinel</span></span></span></span><span class="kobospan" id="kobo.1578.1"> object, this reference creates a distinct object. </span><span class="kobospan" id="kobo.1578.2">We might use </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1579.1">sentinel.POPULATION</span></span></span></span><span class="kobospan" id="kobo.1580.1"> as a kind of mock for a collection of values. </span><span class="kobospan" id="kobo.1580.2">The exact collection doesn’t matter since it’s simply passed as an argument to another function (called </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1581.1">random.choice()</span></span></span></span><span class="kobospan" id="kobo.1582.1"> in the actual code).</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1583.1">Here’s how this use of a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1584.1">sentinel</span></span></span></span><span class="kobospan" id="kobo.1585.1"> object can change this test:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1586.1">from unittest.mock import Mock, call, sentinel 
 
 
 
@pytest.fixture() 
 
def mock_choice_s() -&gt; Mock: 
 
    mock_choice = Mock(name="mock random.choice()", return_value=sentinel.CHOICE) 
 
    return mock_choice 
 
 
 
def test_resample_2( 
 
        mock_choice_s: Mock, monkeypatch: pytest.MonkeyPatch 
 
) -&gt; None: 
 
    monkeypatch.setattr( 
 
        recipe_09.random, "choice", mock_choice_s # type: ignore [attr-defined] 
 
    ) 
 
    resample_data = list(recipe_09.resample(sentinel.POPULATION, 8)) 
 
    assert resample_data == [sentinel.CHOICE] * 8</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1587.1">The output from the mocked </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1588.1">choice()</span></span></span></span><span class="kobospan" id="kobo.1589.1"> function is a recognizable </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1590.1">sentinel</span></span></span></span><span class="kobospan" id="kobo.1591.1"> object. </span><span class="kobospan" id="kobo.1591.2">Similarly, the parameter to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1592.1">resample()</span></span></span></span><span class="kobospan" id="kobo.1593.1"> function is a different </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1594.1">sentinel</span></span></span></span><span class="kobospan" id="kobo.1595.1"> object. </span><span class="kobospan" id="kobo.1595.2">We expect this to be called 8 times, because the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1596.1">N</span></span></span></span><span class="kobospan" id="kobo.1597.1"> parameter is set to </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1598.1">8</span></span></span></span><span class="kobospan" id="kobo.1599.1"> in the test case.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1600.1">When an object should pass through a function untouched, we can write test assertions to confirm this expected behavior. </span><span class="kobospan" id="kobo.1600.2">If the code we’re testing uses the population object improperly, the test can fail when the result is not the untouched </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1601.1">sentinel</span></span></span></span><span class="kobospan" id="kobo.1602.1"> object.</span></p>
<div class="tipbox" id="tcolobox-31">
<div class="note">
<p class="normal1"><span class="kobospan" id="kobo.1603.1">The 1.7.1 release of the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.1604.1">mypy </span></span><span class="kobospan" id="kobo.1605.1">tool struggles with the imports</span><span id="dx1-853021"/><span class="kobospan" id="kobo.1606.1"> in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1607.1">recipe_09</span></span></span></span><span class="kobospan" id="kobo.1608.1"> module. </span><span class="kobospan" id="kobo.1608.2">We used a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1609.1">#</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1610.1"> type:</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1611.1"> ignore</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1612.1"> [attr-defined]</span></span></span></span><span class="kobospan" id="kobo.1613.1"> comment to suppress a confusing </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1614.1">mypy</span></span></span></span><span class="kobospan" id="kobo.1615.1"> message.</span></p>
</div>
</div>
<p class="normal1"><span class="kobospan" id="kobo.1616.1">This test gives us confidence that the population of values is provided, untouched, to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1617.1">random.choice()</span></span></span></span><span class="kobospan" id="kobo.1618.1"> function and the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1619.1">N</span></span></span></span><span class="kobospan" id="kobo.1620.1"> parameter value defines the size of the returned set of items from the population. </span><span id="x1-853022r1816"/></p>
</section>
<section data-number="0.18.9.5" id="see-also-117">
<h2 class="likechapterhead" data-number="0.18.9.5"><span><span class="kobospan" id="kobo.1621.1">15.9.5 </span></span> <span id="x1-8540005"/><span class="kobospan" id="kobo.1622.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1623.1">The </span><a href="ch008_split_001.xhtml#x1-2670007" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1624.1">Building sets – literals, adding, comprehensions, and operators</span></span></a><span class="kobospan" id="kobo.1625.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1626.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1627.1"> </span></span><a href="ch008_split_000.xhtml#x1-2240004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1628.1">4</span></span></a><span class="kobospan" id="kobo.1629.1">, and the </span><a href="ch009.xhtml#x1-2900001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1630.1">Creating dictionaries – inserting and</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1631.1">updating</span></span></a><span class="kobospan" id="kobo.1632.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1633.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1634.1"> </span></span><a href="ch009.xhtml#x1-2890005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1635.1">5</span></span></a><span class="kobospan" id="kobo.1636.1">, the </span><a href="ch010.xhtml#x1-3610006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1637.1">Using cmd to create command-line</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1638.1">applications</span></span></a><span class="kobospan" id="kobo.1639.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1640.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1641.1"> </span></span><a href="ch010.xhtml#x1-3300006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1642.1">6</span></span></a><span class="kobospan" id="kobo.1643.1"> show how to seed the random number generator to create a predictable sequence of values.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1644.1">In </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1645.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1646.1"> </span></span><a href="ch011_split_000.xhtml#x1-3760007" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1647.1">7</span></span></a><span class="kobospan" id="kobo.1648.1">, there are several other recipes that show an alternative approach, for example, </span><a href="ch011_split_000.xhtml#x1-3770001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1649.1">Using a class to encapsulate data and</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1650.1">processing</span></span></a><span class="kobospan" id="kobo.1651.1">, </span><a href="ch011_split_000.xhtml#x1-3890003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1652.1">Designing classes with lots of processing</span></span></a><span class="kobospan" id="kobo.1653.1">, </span><a href="ch011_split_001.xhtml#x1-4130007" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1654.1">Optimizing small</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1655.1">objects with </span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1656.1">_</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1657.1">_slots</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1658.1">_</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1659.1">_</span></span></a><span class="kobospan" id="kobo.1660.1">, and </span><a href="ch011_split_001.xhtml#x1-43100010" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1661.1">Using properties for lazy attributes</span></span></a><span class="kobospan" id="kobo.1662.1">.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1663.1">Also, in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1664.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1665.1"> </span></span><a href="ch012.xhtml#x1-4520008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1666.1">8</span></span></a><span class="kobospan" id="kobo.1667.1">, see the </span><a href="ch012.xhtml#x1-4530001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1668.1">Choosing between inheritance and</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1669.1">composition – the ”is-a” question</span></span></a><span class="kobospan" id="kobo.1670.1">, </span><a href="ch012.xhtml#x1-4610002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1671.1">Separating concerns via multiple</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1672.1">inheritance</span></span></a><span class="kobospan" id="kobo.1673.1">, </span><a href="ch012.xhtml#x1-4670003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1674.1">Leveraging Python’s duck typing</span></span></a><span class="kobospan" id="kobo.1675.1">, and </span><a href="ch012.xhtml#x1-4870006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1676.1">Creating a class that</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1677.1">has orderable objects</span></span></a><span class="kobospan" id="kobo.1678.1"> recipes.</span></p></li>
</ul>
<p class="normal1"><span id="x1-854001r1803"/></p>
</section>
</section>
<section data-number="0.18.10" id="mocking-external-resources">
<h1 class="unnumbered" data-number="0.18.10"><span><span class="kobospan" id="kobo.1679.1">15.10 </span></span> <span id="x1-85500010"/><span class="kobospan" id="kobo.1680.1">Mocking external resources</span></h1>
<p class="normal"><span class="kobospan" id="kobo.1681.1">In earlier recipes</span><span id="dx1-855001"/><span class="kobospan" id="kobo.1682.1"> in this chapter, namely, </span><a href="ch019_split_001.xhtml#x1-8430008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1683.1">Testing things that involve dates or</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1684.1">times</span></span></a><span class="kobospan" id="kobo.1685.1"> and </span><a href="ch019_split_001.xhtml#x1-8490009" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1686.1">Testing things that involve randomness</span></span></a><span class="kobospan" id="kobo.1687.1">, we wrote tests for involving resources with states that we could predict and mock. </span><span class="kobospan" id="kobo.1687.2">In one case, we created a mock </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1688.1">datetime</span></span></span></span><span class="kobospan" id="kobo.1689.1"> module that had a fixed response for the current time. </span><span class="kobospan" id="kobo.1689.2">In the other case, we created a mock function from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1690.1">random</span></span></span></span><span class="kobospan" id="kobo.1691.1"> module.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1692.1">A Python application can use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1693.1">os</span></span></span></span><span class="kobospan" id="kobo.1694.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1695.1">subprocess</span></span></span></span><span class="kobospan" id="kobo.1696.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1697.1">pathlib</span></span></span></span><span class="kobospan" id="kobo.1698.1"> modules to make significant changes to the internal states of a running computer. </span><span class="kobospan" id="kobo.1698.2">We’d like to be able to test these external requests in a safe environment, using mocked objects, and avoid the horror of corrupting a working system with a misconfigured test. </span><span class="kobospan" id="kobo.1698.3">Another example is database access, which requires mock objects to respond to create, retrieve, update, and delete requests.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1699.1">In this recipe, we’ll look at ways to create more sophisticated mock objects. </span><span class="kobospan" id="kobo.1699.2">These will allow the safe testing of changes to precious OS resources like files and directories. </span><span id="x1-855002r1819"/></p>
<section data-number="0.18.10.1" id="getting-ready-119">
<h2 class="likechapterhead" data-number="0.18.10.1"><span><span class="kobospan" id="kobo.1700.1">15.10.1 </span></span> <span id="x1-8560001"/><span class="kobospan" id="kobo.1701.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1702.1">We’ll revisit an application that makes a number of OS changes. </span><span class="kobospan" id="kobo.1702.2">In </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1703.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1704.1"> </span></span><a href="ch015_split_000.xhtml#x1-61500011" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1705.1">11</span></span></a><span class="kobospan" id="kobo.1706.1">, the </span><a href="ch015_split_000.xhtml#x1-6260002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1707.1">Replacing a file while preserving the previous version</span></span></a><span class="kobospan" id="kobo.1708.1"> recipe showed how to write a new file and then rename it so that the previous copy was always preserved.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1709.1">A thorough set of test cases would present a variety of failure modes. </span><span class="kobospan" id="kobo.1709.2">Having tests for several different kinds of errors can help provide confidence that the function behaves properly.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1710.1">The essential design was a definition of a class of objects, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1711.1">Quotient</span></span></span></span><span class="kobospan" id="kobo.1712.1">, and a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1713.1">save_data()</span></span></span></span><span class="kobospan" id="kobo.1714.1"> function to write one of those objects to a file. </span><span class="kobospan" id="kobo.1714.2">Here’s an overview of the code:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1715.1">from pathlib import Path 
 
import csv 
 
from dataclasses import dataclass, asdict, fields 
 
 
 
@dataclass 
 
class Quotient: 
 
    numerator: int 
 
    denominator: int 
 
 
 
def save_data(output_path: Path, data: Quotient) -&gt; None:</span></code></pre>
<pre class="programlisting" id="listing-114"><code class="calibre13"><span class="kobospan" id="kobo.1716.1">    ... </span><span class="kobospan" id="kobo.1716.2"># Details omitted</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1717.1">Consider what happens</span><span id="dx1-856013"/><span class="kobospan" id="kobo.1718.1"> when there’s a failure in the middle of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1719.1">save_data()</span></span></span></span><span class="kobospan" id="kobo.1720.1"> function. </span><span class="kobospan" id="kobo.1720.2">Outcomes include a file that’s partially rewritten, and useless to other applications. </span><span class="kobospan" id="kobo.1720.3">To prevent this, the recipe presented a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1721.1">safe_write()</span></span></span></span><span class="kobospan" id="kobo.1722.1"> function that included several steps to create a temporary file and then rename that file to be the desired output file. </span><span class="kobospan" id="kobo.1722.2">Essentially, the function looked like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1723.1">def safe_write(output_path: Path, data: Quotient) -&gt; None:
                                                                     

                                                                     </span></code></pre>
<pre class="programlisting" id="listing-115"><code class="calibre13"><span class="kobospan" id="kobo.1724.1">    ... </span><span class="kobospan" id="kobo.1724.2"># Details omitted</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1725.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1726.1">safe_write()</span></span></span></span><span class="kobospan" id="kobo.1727.1"> function is shown in detail in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1728.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1729.1"> </span></span><a href="ch015_split_000.xhtml#x1-61500011" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1730.1">11</span></span></a><span class="kobospan" id="kobo.1731.1">. </span><span class="kobospan" id="kobo.1731.2">This is designed to handle a number of scenarios:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-856018x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1732.1">Everything works – sometimes called the ”happy path” – and the file is created properly.</span></p>
</div></li>
<li class="calibre7"><div id="x1-856020x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1733.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1734.1">save_data()</span></span></span></span><span class="kobospan" id="kobo.1735.1"> function raises an exception. </span><span class="kobospan" id="kobo.1735.2">The corrupted file is removed and the original left in place.</span></p>
</div></li>
<li class="calibre7"><div id="x1-856022x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1736.1">Failure occurs elsewhere in the processing of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1737.1">safe_write()</span></span></span></span><span class="kobospan" id="kobo.1738.1"> processing. </span><span class="kobospan" id="kobo.1738.2">There are three scenarios where a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1739.1">Path</span></span></span></span><span class="kobospan" id="kobo.1740.1"> method raises an exception.</span></p>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.1741.1">Each of the above scenarios can be translated into Gherkin to help clarify precisely what it means; for example:</span></p>
<pre class="programlisting" id="listing-116"><code class="calibre13"><span class="kobospan" id="kobo.1742.1">Scenario: save_data() function is broken. 
 
 
 
Given some faulty set of data, "faulty_data", that causes a failure in the save_data() function 
 
And an existing file, "important_data.csv" 
 
When safe_write("important_data.csv", faulty_data) is processed 
 
Then safe_write raises an exception 
 
And the existing file, "important_data.csv" is untouched</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1743.1">Detailing each of the five scenarios</span><span id="dx1-856030"/><span class="kobospan" id="kobo.1744.1"> helps us define </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1745.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1746.1"> objects to provide the various kinds of external resource behaviors we need. </span><span class="kobospan" id="kobo.1746.2">Each scenario suggests a distinct fixture to reflect the distinct failure mode. </span><span id="x1-856031r1821"/></p>
</section>
<section data-number="0.18.10.2" id="how-to-do-it...-120">
<h2 class="likechapterhead" data-number="0.18.10.2"><span><span class="kobospan" id="kobo.1747.1">15.10.2 </span></span> <span id="x1-8570002"/><span class="kobospan" id="kobo.1748.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1749.1">We’ll use a variety of testing techniques. </span><span class="kobospan" id="kobo.1749.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1750.1">pytest</span></span></span></span><span class="kobospan" id="kobo.1751.1"> package offers the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1752.1">tmp_path</span></span></span></span><span class="kobospan" id="kobo.1753.1"> fixture, which can be used to create isolated files and directories. </span><span class="kobospan" id="kobo.1753.2">In addition to an isolated directory, we’ll also want to use a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1754.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1755.1"> to stand in for the parts of the application that we’re not testing:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-857002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1756.1">Identify all of the fixtures required for the various scenarios. </span><span class="kobospan" id="kobo.1756.2">For the happy path, where the mocking is minimal, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1757.1">tmp_path</span></span></span></span><span class="kobospan" id="kobo.1758.1"> fixture is all we need. </span><span class="kobospan" id="kobo.1758.2">For scenario two, where the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1759.1">save_data()</span></span></span></span><span class="kobospan" id="kobo.1760.1"> function is broken, this function should be mocked. </span><span class="kobospan" id="kobo.1760.2">For the remaining three scenarios, mock objects can be defined that will replace methods of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1761.1">Path</span></span></span></span><span class="kobospan" id="kobo.1762.1"> objects.</span></p>
</div></li>
<li class="calibre7"><div id="x1-857004x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1763.1">This test will use a number of features from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1764.1">pytest</span></span></span></span><span class="kobospan" id="kobo.1765.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1766.1">unittest.mock</span></span></span></span><span class="kobospan" id="kobo.1767.1"> modules. </span><span class="kobospan" id="kobo.1767.2">It will be creating </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1768.1">Path</span></span></span></span><span class="kobospan" id="kobo.1769.1"> objects and test functions defined in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1770.1">recipe_10</span></span></span></span><span class="kobospan" id="kobo.1771.1"> module:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1772.1">from pathlib import Path 
 
from typing import Any 
 
 
 
from unittest.mock import Mock, sentinel 
 
import pytest 
 
 
 
import recipe_10</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-857014x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1773.1">Write a test fixture to create the original file, which should not be disturbed unless everything works correctly. </span><span class="kobospan" id="kobo.1773.2">We’ll use a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1774.1">sentinel</span></span></span></span><span class="kobospan" id="kobo.1775.1"> object to provide some text that is unique and recognizable as part of this test scenario:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1776.1">@pytest.fixture() 
 
def original_file(tmp_path: Path) -&gt; Path: 
 
    precious_file = tmp_path / "important_data.csv" 
 
    precious_file.write_text(hex(id(sentinel.ORIGINAL_DATA)), encoding="utf-8") 
 
    return precious_file</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-857022x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1777.1">Write a mock to replace</span><span id="dx1-857023"/><span class="kobospan" id="kobo.1778.1"> the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1779.1">save_data()</span></span></span></span><span class="kobospan" id="kobo.1780.1"> function. </span><span class="kobospan" id="kobo.1780.2">This will create mock data used to validate that the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1781.1">safe_write()</span></span></span></span><span class="kobospan" id="kobo.1782.1"> function works. </span><span class="kobospan" id="kobo.1782.2">In this, too, we’ll use a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1783.1">sentinel</span></span></span></span><span class="kobospan" id="kobo.1784.1"> object to create a unique string that is recognizable later in the test:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1785.1">def save_data_good(path: Path, content: recipe_10.Quotient) -&gt; None: 
 
    path.write_text(hex(id(sentinel.GOOD_DATA)), encoding="utf-8")</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-857028x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1786.1">Write the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1787.1">happy path </span></span><span class="kobospan" id="kobo.1788.1">scenario. </span><span class="kobospan" id="kobo.1788.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1789.1">save_data_good()</span></span></span></span><span class="kobospan" id="kobo.1790.1"> function can be given as the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1791.1">side_effect</span></span></span></span><span class="kobospan" id="kobo.1792.1"> of a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1793.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1794.1"> object and used in place of the original </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1795.1">save_data()</span></span></span></span><span class="kobospan" id="kobo.1796.1"> function. </span><span class="kobospan" id="kobo.1796.2">Using a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1797.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1798.1"> means the call history will be tracked. </span><span class="kobospan" id="kobo.1798.2">This helps to confirm that the overall </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1799.1">safe_write()</span></span></span></span><span class="kobospan" id="kobo.1800.1"> function being tested really does use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1801.1">save_data()</span></span></span></span><span class="kobospan" id="kobo.1802.1"> function to create the expected resulting file:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1803.1">def test_safe_write_happy(original_file: Path, monkeypatch: pytest.MonkeyPatch) -&gt; None: 
 
    mock_save_data = Mock(side_effect=save_data_good) 
 
    monkeypatch.setattr(recipe_10, "save_data", mock_save_data) 
 
    data = recipe_10.Quotient(355, 113) 
 
    recipe_10.safe_write(Path(original_file), data) 
 
    actual = original_file.read_text(encoding="utf-8") 
 
 
 
    assert actual == hex(id(sentinel.GOOD_DATA))</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-857039x6" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1804.1">Write a mock for scenario two, in which the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1805.1">save_data()</span></span></span></span><span class="kobospan" id="kobo.1806.1"> function fails to work correctly. </span><span class="kobospan" id="kobo.1806.2">The mock can rely on a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1807.1">save_data_failure()</span></span></span></span><span class="kobospan" id="kobo.1808.1"> function to write recognizably corrupt data, and then also raise an unexpected exception:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1809.1">def save_data_failure(path: Path, content: recipe_10.Quotient) -&gt; None: 
 
    path.write_text(hex(id(sentinel.CORRUPT_DATA)), encoding="utf-8") 
 
    raise RuntimeError("mock exception")</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-857045x7" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.1810.1">Write the test case for scenario two, using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1811.1">save_data_failure()</span></span></span></span><span class="kobospan" id="kobo.1812.1"> function as the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1813.1">side_effect</span></span></span></span><span class="kobospan" id="kobo.1814.1"> of a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1815.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1816.1"> object:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1817.1">def test_safe_write_scenario_2( 
 
    original_file: Path, monkeypatch: pytest.MonkeyPatch 
 
) -&gt; None: 
 
    mock_save_data = Mock(side_effect=save_data_failure) 
 
    monkeypatch.setattr(recipe_10, "save_data", mock_save_data) 
 
    data = recipe_10.Quotient(355, 113) 
 
    with pytest.raises(RuntimeError) as ex: 
 
        recipe_10.safe_write(Path(original_file), data) 
 
    actual = original_file.read_text(encoding="utf-8") 
 
    assert actual == hex(id(sentinel.ORIGINAL_DATA))</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1818.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1819.1">save_data_failure()</span></span></span></span><span class="kobospan" id="kobo.1820.1"> function wrote corrupt data, but the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1821.1">safe_write()</span></span></span></span><span class="kobospan" id="kobo.1822.1"> function preserved the original file.</span></p>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.1823.1">This recipe produced two test scenarios</span><span id="dx1-857057"/><span class="kobospan" id="kobo.1824.1"> that confirm the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1825.1">safe_write()</span></span></span></span><span class="kobospan" id="kobo.1826.1"> function will work. </span><span class="kobospan" id="kobo.1826.2">We’ll turn to the remaining three scenarios in the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1827.1">There’s more</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1828.1">…</span></span><span class="kobospan" id="kobo.1829.1"> section later in this recipe. </span><span id="x1-857058r1824"/></p>
</section>
<section data-number="0.18.10.3" id="how-it-works...-120">
<h2 class="likechapterhead" data-number="0.18.10.3"><span><span class="kobospan" id="kobo.1830.1">15.10.3 </span></span> <span id="x1-8580003"/><span class="kobospan" id="kobo.1831.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1832.1">When testing software that makes OS, network, or database requests, it’s imperative to include cases where the external resource fails to operate as expected. </span><span class="kobospan" id="kobo.1832.2">The principal tools for doing this are </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1833.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1834.1"> objects and the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1835.1">monkeypatch</span></span></span></span><span class="kobospan" id="kobo.1836.1"> fixture. </span><span class="kobospan" id="kobo.1836.2">A test can replace Python library functions with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1837.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1838.1"> objects that raise exceptions instead of working correctly.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1839.1">For the happy path scenario, we replaced the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1840.1">save_data()</span></span></span></span><span class="kobospan" id="kobo.1841.1"> function with a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1842.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1843.1"> object that wrote some recognizable data. </span><span class="kobospan" id="kobo.1843.2">Because we’re using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1844.1">tmp_path</span></span></span></span><span class="kobospan" id="kobo.1845.1"> fixture, the file was written into a safe, temporary directory, where it could be examined to confirm that new, good data replaced the original data.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1846.1">For the first of the failure scenarios, we used the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1847.1">monkeypatch</span></span></span></span><span class="kobospan" id="kobo.1848.1"> fixture to replace the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1849.1">save_data()</span></span></span></span><span class="kobospan" id="kobo.1850.1"> function with a function that both wrote corrupt data and also raised an exception as if an OS problem occurred. </span><span class="kobospan" id="kobo.1850.2">This is one way to simulate a broad spectrum of application failures that involve some kind of persistent filesystem artifact. </span><span class="kobospan" id="kobo.1850.3">In simpler cases, where there is no artifact, a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1851.1">Mock</span></span></span></span><span class="kobospan" id="kobo.1852.1"> object with an exception class as the value of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1853.1">side_effect</span></span></span></span><span class="kobospan" id="kobo.1854.1"> parameter is all that’s required to simulate a failure.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1855.1">These test scenarios also made use of unique </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1856.1">sentinel</span></span></span></span><span class="kobospan" id="kobo.1857.1"> objects. </span><span class="kobospan" id="kobo.1857.2">Evaluating the value of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1858.1">hex(id(x))</span></span></span></span><span class="kobospan" id="kobo.1859.1"> provides a distinct</span><span id="dx1-858001"/><span class="kobospan" id="kobo.1860.1"> string value that’s difficult to predict. </span><span id="x1-858002r1831"/></p>
</section>
<section data-number="0.18.10.4" id="theres-more...-111">
<h2 class="likechapterhead" data-number="0.18.10.4"><span><span class="kobospan" id="kobo.1861.1">15.10.4 </span></span> <span id="x1-8590004"/><span class="kobospan" id="kobo.1862.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.1863.1">The remaining scenarios are very similar; they can all share the following test function:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1864.1">def test_safe_write_scenarios( 
 
        original_file: Path, 
 
        mock_pathlib_path: Mock, 
 
        monkeypatch: pytest.MonkeyPatch 
 
) -&gt; None: 
 
    mock_save_data = Mock(side_effect=save_data_good) 
 
    monkeypatch.setattr(recipe_10, "save_data", mock_save_data) 
 
    data = recipe_10.Quotient(355, 113) 
 
    with pytest.raises(RuntimeError) as exc_info: 
 
        recipe_10.safe_write(mock_pathlib_path, data) 
 
    actual = original_file.read_text(encoding="utf-8") 
 
    assert actual == hex(id(sentinel.ORIGINAL_DATA)) 
 
    mock_save_data.assert_called_once() 
 
    mock_pathlib_path.with_suffix.mock_calls == [ 
 
        call("suffix.new"), call("suffix.old") 
 
    ] 
 
    # Scenario-specific details...</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1865.1">This function uses the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1866.1">save_data_good()</span></span></span></span><span class="kobospan" id="kobo.1867.1"> function as the side effect when the mocked </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1868.1">save_data()</span></span></span></span><span class="kobospan" id="kobo.1869.1"> function is invoked. </span><span class="kobospan" id="kobo.1869.2">The given </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1870.1">save_data_good()</span></span></span></span><span class="kobospan" id="kobo.1871.1"> function will be executed and will write a known good test file. </span><span class="kobospan" id="kobo.1871.2">Each of these scenarios involve exceptions from </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1872.1">Path</span></span></span></span><span class="kobospan" id="kobo.1873.1"> operations after the good file was created.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1874.1">We’ve omitted showing any scenario-specific details. </span><span class="kobospan" id="kobo.1874.2">The key feature of this test is preserving the original good data in spite of exceptions.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1875.1">To support multiple exception scenarios, we want to use three different versions of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1876.1">mock_pathlib_path</span></span></span></span><span class="kobospan" id="kobo.1877.1"> mock object.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1878.1">We can use a parameterized fixture to spell out these three alternative configurations of the mock objects. </span><span class="kobospan" id="kobo.1878.2">First, we’ll package the choices as three separate dictionaries that provide the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1879.1">side_effect</span></span></span></span><span class="kobospan" id="kobo.1880.1"> values:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1881.1">scenario_3 = { 
 
    "original": None, "new": None, "old": RuntimeError("3")} 
 
 
 
scenario_4 = { 
 
    "original": RuntimeError("4"), "new": None, "old": None} 
 
 
 
scenario_5 = { 
 
    "original": None, "new": RuntimeError("5"), "old": None}</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1882.1">We’ve used </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1883.1">RuntimeError</span></span></span></span><span class="kobospan" id="kobo.1884.1"> as the exception to raise, triggering alternative execution paths. </span><span class="kobospan" id="kobo.1884.2">In some cases, it may be necessary to use a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1885.1">IOError</span></span></span></span><span class="kobospan" id="kobo.1886.1"> exception. </span><span class="kobospan" id="kobo.1886.2">In this case, any exception would be fine.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1887.1">Given these three dictionary objects, we can plug the values into a fixture via the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1888.1">request.params</span></span></span></span><span class="kobospan" id="kobo.1889.1"> option provided by </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1890.1">pytest</span></span></span></span><span class="kobospan" id="kobo.1891.1">:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.1892.1">@pytest.fixture( 
 
    params=[scenario_3, scenario_4, scenario_5], 
 
) 
 
def mock_pathlib_path(request: pytest.FixtureRequest) -&gt; Mock: 
 
    mock_mapping = request.param 
 
    new_path = Mock(rename=Mock(side_effect=mock_mapping["new"])) 
 
    old_path = Mock(unlink=Mock(side_effect=mock_mapping["old"])) 
 
    output_path = Mock( 
 
        name="mock output_path", 
 
        suffix="suffix", 
 
        with_suffix=Mock(side_effect=[new_path, old_path]), 
 
        rename=Mock(side_effect=mock_mapping["original"]), 
 
    ) 
 
    return output_path</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.1893.1">Because this fixture has three parameter values, any test using this fixture will be run three times, once with each of the values. </span><span class="kobospan" id="kobo.1893.2">This lets us reuse the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.1894.1">test_safe_write_scenarios()</span></span></span></span><span class="kobospan" id="kobo.1895.1"> test case to be sure it works with a variety of system failures.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1896.1">We’ve created a variety of mock objects to inject failures throughout the processing in a complex function. </span><span class="kobospan" id="kobo.1896.2">Using parameterized fixture helps to define consistent mock objects for these tests.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1897.1">There’s yet another scenario that involves a successful operation followed by a failing operation on the same file. </span><span class="kobospan" id="kobo.1897.2">This doesn’t fit the above pattern and requires another test case with a slightly more sophisticated set of mock objects. </span><span class="kobospan" id="kobo.1897.3">We leave this as an exercise for you. </span><span id="x1-859043r1832"/></p>
</section>
<section data-number="0.18.10.5" id="see-also-118">
<h2 class="likechapterhead" data-number="0.18.10.5"><span><span class="kobospan" id="kobo.1898.1">15.10.5 </span></span> <span id="x1-8600005"/><span class="kobospan" id="kobo.1899.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1900.1">The </span><a href="ch019_split_001.xhtml#x1-8430008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1901.1">Testing things that involve dates or times</span></span></a><span class="kobospan" id="kobo.1902.1"> and </span><a href="ch019_split_001.xhtml#x1-8490009" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1903.1">Testing things that</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1904.1">involve randomness</span></span></a><span class="kobospan" id="kobo.1905.1"> recipes earlier in this chapter show techniques for dealing with unpredictable data.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1906.1">Elements of this can be tested with the doctest module. </span><span class="kobospan" id="kobo.1906.2">See the </span><a href="ch019_split_000.xhtml#x1-7950001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1907.1">Using</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1908.1">docstrings for testing</span></span></a><span class="kobospan" id="kobo.1909.1"> recipe earlier in this chapter for examples. </span><span class="kobospan" id="kobo.1909.2">It’s also important to combine these tests with any doctests. </span><span class="kobospan" id="kobo.1909.3">See the </span><a href="ch019_split_001.xhtml#x1-8370007" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1910.1">Combining pytest and doctest tests</span></span></a><span class="kobospan" id="kobo.1911.1"> recipe earlier in this chapter for more information on how to do this.</span></p></li>
</ul>
<p class="normal1"><span id="x1-860001r1820"/></p>
</section>
</section>
<section data-number="0.18.13" id="join-our-community-discord-space-15">
<h1 class="unnumbered" data-number="0.18.13"><span id="x1-86300012"/><span class="kobospan" id="kobo.1912.1">Join our community Discord space</span></h1>
<p class="normal"><span class="kobospan" id="kobo.1913.1">Join our Python Discord workspace to discuss and find out more about the book: </span><a class="url" href="https://packt.link/dHrHU"><span class="url1"><span class="kobospan" id="kobo.1914.1">https://packt.link/dHrHU</span></span></a></p>
<p class="normal1"><span class="kobospan" id="kobo.1915.1"><img alt="PIC" src="../media/file1.png" class="calibre9"/></span></p>
<p class="normal1"><span id="x1-863001r1698"/></p>
</section>
</section>
</body></html>