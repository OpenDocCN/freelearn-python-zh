<html><head></head><body>
		<div><h1 id="_idParaDest-225" class="chapter-number"><a id="_idTextAnchor231"/><a id="_idTextAnchor232"/><a id="_idTextAnchor233"/><st c="0">12</st></h1>
			<h1 id="_idParaDest-226"><a id="_idTextAnchor234"/><st c="3">Implementing the Purchase and Orders Pages</st></h1>
			<p><st c="46">During the previous chapter, we implemented the models required to store the purchase information. </st><st c="146">In this chapter, we will implement the purchase functionality and finalize the Movies Store project with an orders page. </st><st c="267">Users will be able to check their placed orders. </st><st c="316">Later, we will recap the Movies Store MVT architecture to check the consistency between the Python code and the </st><st c="428">architecture diagram.</st></p>
			<p><st c="449">In this chapter, we will be covering the </st><st c="491">following topics:</st></p>
			<ul>
				<li><st c="508">Creating the </st><st c="522">purchase page</st></li>
				<li><st c="535">Creating the </st><st c="549">orders page</st></li>
				<li><st c="560">Recapping the Movies Store </st><st c="588">MVT architecture</st></li>
			</ul>
			<p><st c="604">By the end of the chapter, we will have the complete code for our Movies Store project. </st><st c="693">We will also be capable of relating architecture diagrams to the actual </st><st c="765">implemented code.</st></p>
			<h1 id="_idParaDest-227"><a id="_idTextAnchor235"/><st c="782">Technical requirements</st></h1>
			<p><st c="805">In this chapter, we will be using Python 3.10+. </st><st c="854">Additionally, we will be using the </st><strong class="bold"><st c="889">VS Code</st></strong><st c="896"> editor in this book, which you can download </st><st c="941">from </st><a href="https://code.visualstudio.com/"><st c="946">https://code.visualstudio.com/</st></a><st c="976">.</st></p>
			<p><st c="977">The code for this chapter is located </st><st c="1015">at </st><a href="https://github.com/PacktPublishing/Django-5-for-the-Impatient-Second-Edition/tree/main/Chapter12/moviesstore"><st c="1018">https://github.com/PacktPublishing/Django-5-for-the-Impatient-Second-Edition/tree/main/Chapter12/moviesstore</st></a><st c="1126">.</st></p>
			<p><st c="1127">The CiA video for this chapter can be found </st><st c="1172">at </st><a href="https://packt.link/4NyAv"><st c="1175">https://packt.link/4NyAv</st></a></p>
			<h1 id="_idParaDest-228"><a id="_idTextAnchor236"/><st c="1199">Creating the purchase page</st></h1>
			<p><st c="1226">Let’s improve our shopping cart page</st><a id="_idIndexMarker402"/><st c="1263"> and include some functionalities to allow users to make purchases. </st><st c="1331">To achieve that, we need to follow </st><st c="1366">these steps:</st></p>
			<ol>
				<li><st c="1378">Configuring the </st><st c="1395">purchase URL.</st></li>
				<li><st c="1408">Defining the </st><code><st c="1422">purchase</st></code><st c="1430"> function.</st></li>
				<li><st c="1440">Updating the </st><code><st c="1454">cart.index</st></code><st c="1464"> template.</st></li>
				<li><st c="1474">Creating the </st><code><st c="1488">cart.purchase</st></code><st c="1501"> template.</st></li>
			</ol>
			<h2 id="_idParaDest-229"><a id="_idTextAnchor237"/><st c="1511">Configuring the purchase URL</st></h2>
			<p><st c="1540">In </st><code><st c="1544">/cart/urls.py</st></code><st c="1557">, add the next</st><a id="_idIndexMarker403"/><st c="1571"> path as shown </st><st c="1586">in </st><strong class="bold"><st c="1589">bold</st></strong><st c="1593">:</st></p>
			<pre class="source-code"><st c="1595">
from django.urls import path
from . </st><st c="1632">import views
urlpatterns = [
    path('', views.index, name='cart.index'),
    path('&lt;int:id&gt;/add/', views.add, name='cart.add'),
    path('clear/', views.clear, name='cart.clear'),
    </st><strong class="bold"><st c="1802">path('purchase/', views.purchase,</st></strong>
<strong class="bold"><st c="1835">        name='cart.purchase'),</st></strong><st c="1858">
]</st></pre>			<p><st c="1860">We defined a </st><code><st c="1873">cart/purchase/</st></code><st c="1887"> path that will execute the </st><code><st c="1915">purchase</st></code><st c="1923"> function defined in the </st><code><st c="1948">views</st></code><st c="1953"> file. </st><st c="1960">We will implement the </st><code><st c="1982">purchase</st></code> <st c="1990">function later.</st></p>
			<h2 id="_idParaDest-230"><a id="_idTextAnchor238"/><st c="2006">Defining the purchase function</st></h2>
			<p><st c="2037">In </st><code><st c="2041">/cart/views.py</st></code><st c="2055">, add the </st><a id="_idIndexMarker404"/><st c="2065">following lines </st><a id="_idIndexMarker405"/><st c="2081">of code </st><st c="2089">in </st><strong class="bold"><st c="2092">bold</st></strong><st c="2096">:</st></p>
			<pre class="source-code"><st c="2098">
…
from movies.models import Movie
from .utils import calculate_cart_total
</st><strong class="bold"><st c="2172">from .models import Order, Item</st></strong>
<strong class="bold"><st c="2203">from django.contrib.auth.decorators import login_required</st></strong><st c="2261">
…
</st><strong class="bold"><st c="2263">@login_required</st></strong>
<strong class="bold"><st c="2278">def purchase(request):</st></strong>
<strong class="bold"><st c="2301">    cart = request.session.get('cart', {})</st></strong>
<strong class="bold"><st c="2340">    movie_ids = list(cart.keys())</st></strong>
<strong class="bold"><st c="2370">    if (movie_ids == []):</st></strong>
<strong class="bold"><st c="2392">        return redirect('cart.index')</st></strong>
<strong class="bold"><st c="2422">    movies_in_cart = Movie.objects.filter(id__in=movie_ids)</st></strong>
<strong class="bold"><st c="2478">    cart_total = calculate_cart_total(cart, movies_in_cart)</st></strong>
<strong class="bold"><st c="2534">    order = Order()</st></strong>
<strong class="bold"><st c="2550">    order.user = request.user</st></strong>
<strong class="bold"><st c="2576">    order.total = cart_total</st></strong>
<strong class="bold"><st c="2601">    order.save()</st></strong>
<strong class="bold"><st c="2614">    for movie in movies_in_cart:</st></strong>
<strong class="bold"><st c="2643">        item = Item()</st></strong>
<strong class="bold"><st c="2657">        item.movie = movie</st></strong>
<strong class="bold"><st c="2676">        item.price = movie.price</st></strong>
<strong class="bold"><st c="2701">        item.order = order</st></strong>
<strong class="bold"><st c="2720">        item.quantity = cart[str(movie.id)]</st></strong>
<strong class="bold"/><strong class="bold"><st c="2756">item.save()</st></strong>
<strong class="bold"><st c="2768">    request.session['cart'] = {}</st></strong>
<strong class="bold"><st c="2797">    template_data = {}</st></strong>
<strong class="bold"><st c="2816">    template_data['title'] = 'Purchase confirmation'</st></strong>
<strong class="bold"><st c="2865">    template_data['order_id'] = order.id</st></strong>
<strong class="bold"><st c="2902">    return render(request, 'cart/purchase.html',</st></strong>
<strong class="bold"><st c="2947">        {'template_data': template_data})</st></strong></pre>			<p><st c="2981">The previous function is the largest one </st><a id="_idIndexMarker406"/><st c="3023">we have implemented in</st><a id="_idIndexMarker407"/><st c="3045"> this book. </st><st c="3057">Let’s explain this function by breaking it down </st><st c="3105">into parts:</st></p>
			<ul>
				<li><code><st c="3116">from .models import </st></code><code><st c="3137">Order, Item</st></code><p class="list-inset"><code><st c="3148">from django.contrib.auth.decorators </st></code><code><st c="3185">import login_required</st></code></p><p class="list-inset"><st c="3206">Let’s analyze this piece </st><st c="3232">of code:</st></p><ul><li><st c="3240">We import the </st><code><st c="3255">Order</st></code><st c="3260"> and </st><code><st c="3265">Item</st></code><st c="3269"> models from the current </st><st c="3294">app directory.</st></li><li><st c="3308">We import the </st><code><st c="3323">login_required</st></code><st c="3337"> decorator.</st></li></ul></li>
				<li><code><st c="3348">@</st></code><code><st c="3350">login_required</st></code><p class="list-inset"><code><st c="3364">def purchase(request):</st></code></p><p class="list-inset"><code><st c="3387">    cart = </st></code><code><st c="3395">request.session.get('cart', {})</st></code></p><p class="list-inset"><code><st c="3426">    movie_ids = </st></code><code><st c="3439">list(cart.keys())</st></code></p><p class="list-inset"><code><st c="3456">    if (movie_ids == []):</st></code></p><p class="list-inset"><code><strong class="source-inline"><st c="3478">return redirect('cart.index')</st></code></p><p class="list-inset"><st c="3508">Let’s analyze this piece </st><st c="3534">of code:</st></p><ul><li><st c="3542">We use the </st><code><st c="3554">login_required</st></code><st c="3568"> decorator to </st><a id="_idIndexMarker408"/><st c="3582">ensure that the user must be logged in to access the </st><code><st c="3635">purchase</st></code><st c="3643"> function.</st></li><li><st c="3653">We define the </st><code><st c="3668">purchase</st></code><st c="3676"> function, which will handle the </st><st c="3709">purchase process.</st></li><li><st c="3726">We retrieve the cart data from the user’s session. </st><st c="3778">The </st><code><st c="3782">cart</st></code><st c="3786"> variable will contain a dictionary with </st><a id="_idIndexMarker409"/><st c="3827">movie IDs as keys and quantities </st><st c="3860">as values.</st></li><li><st c="3870">We retrieve the movie IDs stored in the </st><code><st c="3911">cart</st></code><st c="3915"> dict and convert them into a list </st><st c="3950">named </st><code><st c="3956">movie_ids</st></code><st c="3965">.</st></li><li><st c="3966">We check if the </st><code><st c="3983">movie_ids</st></code><st c="3992"> list is empty (which indicates the cart is empty). </st><st c="4044">In this case, the user is redirected to the </st><code><st c="4088">cart.index</st></code><st c="4098"> page (here, the </st><code><st c="4115">purchase</st></code><st c="4123"> function finalizes </st><st c="4143">its execution).</st></li></ul></li>
				<li><code><st c="4158">    movies_in_cart = </st></code><code><st c="4176">Movie.objects.filter(id__in=movie_ids)</st></code><p class="list-inset"><code><st c="4214">    cart_total = </st></code><code><st c="4228">calculate_cart_total(cart, movies_in_cart)</st></code></p><p class="list-inset"><code><st c="4270">    order = </st></code><code><st c="4279">Order()</st></code></p><p class="list-inset"><code><st c="4286">    order.user = </st></code><code><st c="4300">request.user</st></code></p><p class="list-inset"><code><st c="4312">    order.total = </st></code><code><st c="4327">cart_total</st></code></p><p class="list-inset"><code><strong class="source-inline"><st c="4337">order.save()</st></code></p><p class="list-inset"><code><st c="4350">    for movie </st></code><code><st c="4361">in movies_in_cart:</st></code></p><p class="list-inset"><code><st c="4379">        item = </st></code><code><st c="4387">Item()</st></code></p><p class="list-inset"><code><st c="4393">        item.movie = </st></code><code><st c="4407">movie</st></code></p><p class="list-inset"><code><st c="4412">        item.price = </st></code><code><st c="4426">movie.price</st></code></p><p class="list-inset"><code><st c="4437">        item.order = </st></code><code><st c="4451">order</st></code></p><p class="list-inset"><code><st c="4456">        item.quantity = </st></code><code><st c="4473">cart[str(movie.id)]</st></code></p><p class="list-inset"><code><strong class="source-inline"><st c="4492">item.save()</st></code></p><p class="list-inset"><st c="4504">Let’s analyze this piece </st><a id="_idIndexMarker410"/><st c="4530">of code:</st></p><ul><li><st c="4538">If the cart is not empty, we</st><a id="_idIndexMarker411"/><st c="4567"> continue the </st><st c="4581">purchase process.</st></li><li><st c="4598">We retrieve movie objects from the database based on the IDs stored in the cart </st><st c="4679">using </st><code><st c="4685">Movie.objects.filter(id__in=movie_ids</st></code><st c="4722">.</st></li><li><st c="4723">We calculate the total cost of the movies in the cart using the </st><code><st c="4788">calculate_cart_total()</st></code><st c="4810"> function.</st></li><li><st c="4820">We create a new </st><code><st c="4837">Order</st></code><st c="4842"> object. </st><st c="4851">We set its attributes such as </st><code><st c="4881">user</st></code><st c="4885"> (the logged-in user) and </st><code><st c="4911">total</st></code><st c="4916"> (the cart total), and save it to </st><st c="4950">the database.</st></li><li><st c="4963">We iterate over the movies in the cart. </st><st c="5004">We create an </st><code><st c="5017">Item</st></code><st c="5021"> object for each movie in the cart. </st><st c="5057">For each </st><code><st c="5066">Item</st></code><st c="5070">, we set its </st><code><st c="5083">price</st></code><st c="5088"> and </st><code><st c="5093">quantity</st></code><st c="5101">, link the corresponding </st><code><st c="5126">movie</st></code><st c="5131"> and </st><code><st c="5136">order</st></code><st c="5141">, and save it to </st><st c="5158">the database.</st></li></ul></li>
				<li><code><st c="5171">    request.session['cart'] = {}</st></code><p class="list-inset"><code><st c="5200">    template_data = {}</st></code></p><p class="list-inset"><code><st c="5219">    template_data['title'] = '</st></code><code><st c="5246">Purchase confirmation'</st></code></p><p class="list-inset"><code><st c="5269">    template_data['order_id'] = </st></code><code><st c="5298">order.id</st></code></p><p class="list-inset"><code><st c="5306">    return render(request, 'cart/purchase.html',         {'</st></code><code><st c="5354">template_data': template_data})</st></code></p><p class="list-inset"><st c="5386">Let’s analyze this piece </st><st c="5412">of code:</st></p><ul><li><st c="5420">After the purchase is completed, we clear the cart in the user’s session by setting </st><code><st c="5505">request.session['cart']</st></code><st c="5528"> to an </st><st c="5535">empty dictionary.</st></li><li><st c="5552">We prepare the data to be </st><a id="_idIndexMarker412"/><st c="5579">sent to the purchase confirmation template. </st><st c="5623">This data includes the title of the page and the ID of the</st><a id="_idIndexMarker413"/> <st c="5681">created order.</st></li><li><st c="5696">Finally, we render the </st><code><st c="5720">cart/purchase.html</st></code><st c="5738"> template.</st></li></ul></li>
			</ul>
			<p><st c="5748">Now that we have finished the purchase function, let’s include a button that links to </st><st c="5835">this function.</st></p>
			<h2 id="_idParaDest-231"><a id="_idTextAnchor239"/><st c="5849">Updating cart.index template</st></h2>
			<p><st c="5878">In the </st><code><st c="5886">/cart/templates/cart/index.html</st></code><st c="5917"> file, add </st><a id="_idIndexMarker414"/><st c="5928">the following lines </st><st c="5948">in </st><strong class="bold"><st c="5951">bold</st></strong><st c="5955">:</st></p>
			<pre class="source-code"><st c="5957">
        …
        &lt;a class="btn btn-outline-secondary mb-2"&gt;
          &lt;b&gt;Total to pay:&lt;/b&gt; ${{ template_data.cart_total
        }}&lt;/a&gt;
        {% if template_data.movies_in_cart|length &gt; 0 %}
        </st><strong class="bold"><st c="6108">&lt;a href="{% url 'cart.purchase' %}"</st></strong>
<strong class="bold"><st c="6143">          class="btn bg-dark text-white mb-2"&gt;Purchase</st></strong><strong class="bold"><st c="6188">&lt;/a&gt;</st></strong><st c="6193">
        &lt;a href="{% url 'cart.clear' %}"&gt;
          &lt;button class="btn btn-danger mb-2"&gt;
            Remove all movies from Cart
          &lt;/button&gt;
        &lt;/a&gt;
        {% endif %}
        …</st></pre>			<p><st c="6321">We have added a button that links the shopping cart page with the purchase function. </st><st c="6407">This button will be only displayed if</st><a id="_idIndexMarker415"/><st c="6444"> there are movies added </st><a id="_idIndexMarker416"/><st c="6468">to </st><st c="6471">the cart.</st></p>
			<h2 id="_idParaDest-232"><a id="_idTextAnchor240"/><st c="6480">Creating cart.purchase template</st></h2>
			<p><st c="6512">Now, in </st><code><st c="6521">/cart/templates/cart/</st></code><st c="6542">, create a new file, </st><code><st c="6563">purchase.html</st></code><st c="6576">. For now, fill it with </st><a id="_idIndexMarker417"/><st c="6600">the following:</st></p>
			<pre class="source-code"><st c="6614">
{% extends 'base.html' %}
{% block content %}
&lt;div class="p-3"&gt;
  &lt;div class="container"&gt;
    &lt;div class="row mt-3"&gt;
      &lt;div class="col mx-auto mb-3"&gt;
        &lt;h2&gt;Purchase Completed&lt;/h2&gt;
        &lt;hr /&gt;
        &lt;p&gt;Congratulations, purchase completed. </st><st c="6832">Order
          number is: &lt;b&gt;#{{ template_data.order_id }}&lt;/b&gt;
        &lt;/p&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
{% endblock content %}</st></pre>			<p><st c="6941">We have created a simple template that extends the </st><code><st c="6993">base.html</st></code><st c="7002"> template and shows a congratulations message to the user, including the order number of the </st><st c="7095">current purchase.</st></p>
			<p><st c="7112">Now, save those files, run the server, go to </st><code><st c="7158">http://localhost:8000/movies</st></code><st c="7186">, click on a couple of movies, and add them to the cart. </st><st c="7243">Then, go to the </st><strong class="bold"><st c="7259">Cart</st></strong><st c="7263"> section and click </st><strong class="bold"><st c="7282">Purchase</st></strong><st c="7290"> (you will need to</st><a id="_idIndexMarker418"/><st c="7308"> be logged in to execute the purchase action). </st><st c="7355">Then, you will see a purchase confirmation message (</st><em class="italic"><st c="7407">Figure 12</st></em><em class="italic"><st c="7417">.1</st></em><st c="7419">):</st></p>
			<div><div><img src="img/B22457_12_01.jpg" alt="Figure 12.1 – Purchase page"/><st c="7422"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><st c="7512">Figure 12.1 – Purchase page</st></p>
			<p><st c="7539">If you navigate to the admin panel, you will see a new order registered (linked to the user who made the purchase) and a couple of items (linked to the previous order), as shown in </st><em class="italic"><st c="7721">Figure 12</st></em><em class="italic"><st c="7730">.2</st></em><st c="7732">:</st></p>
			<div><div><img src="img/B22457_12_02.jpg" alt="Figure 12.2 – Order and items in the admin panel"/><st c="7734"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><st c="7915">Figure 12.2 – Order and items in the admin panel</st></p>
			<p><st c="7963">At this point, we are able to create</st><a id="_idIndexMarker419"/><st c="8000"> orders and register the corresponding information into the database. </st><st c="8070">Now, let’s implement a page to see </st><st c="8105">the orders.</st></p>
			<h1 id="_idParaDest-233"><a id="_idTextAnchor241"/><st c="8116">Creating the orders page</st></h1>
			<p><st c="8141">Let’s finalize our Movies Store</st><a id="_idIndexMarker420"/><st c="8173"> by allowing users to see their orders. </st><st c="8213">To achieve that, we need to follow </st><st c="8248">these steps:</st></p>
			<ol>
				<li><st c="8260">Configuring the </st><st c="8277">orders URL.</st></li>
				<li><st c="8288">Defining the </st><code><st c="8302">orders</st></code><st c="8308"> function.</st></li>
				<li><st c="8318">Creating the </st><code><st c="8332">accounts.orders</st></code><st c="8347"> template.</st></li>
				<li><st c="8357">Adding a link to the </st><st c="8379">base template.</st></li>
			</ol>
			<h2 id="_idParaDest-234"><a id="_idTextAnchor242"/><st c="8393">Configuring the orders URL</st></h2>
			<p><st c="8420">An order belongs to a</st><a id="_idIndexMarker421"/><st c="8442"> specific user. </st><st c="8458">Because of this, we will add the orders functionality inside the </st><code><st c="8523">accounts</st></code><st c="8531"> app. </st><st c="8537">In </st><code><st c="8540">/accounts/urls.py</st></code><st c="8557">, add the next path </st><st c="8577">in </st><strong class="bold"><st c="8580">bold</st></strong><st c="8584">:</st></p>
			<pre class="source-code"><st c="8586">
from django.urls import path
from . </st><st c="8623">import views
urlpatterns = [
    path('signup', views.signup, name='accounts.signup'),
    path('login/', views.login, name='accounts.login'),
    path('logout/', views.logout, name='accounts.logout'),
    </st><strong class="bold"><st c="8813">path('orders/', views.orders, name='accounts.orders'),</st></strong><st c="8867">
]</st></pre>			<p><st c="8869">We defined an </st><code><st c="8883">accounts/orders/</st></code><st c="8899"> path, which will execute the </st><code><st c="8929">orders</st></code><st c="8935"> function defined in the </st><code><st c="8960">views</st></code><st c="8965"> file. </st><st c="8972">We </st><a id="_idIndexMarker422"/><st c="8975">will implement the </st><code><st c="8994">orders</st></code> <st c="9000">function later.</st></p>
			<h2 id="_idParaDest-235"><a id="_idTextAnchor243"/><st c="9016">Defining the orders function</st></h2>
			<p><st c="9045">In </st><code><st c="9049">/accounts/views.py</st></code><st c="9067">, add the</st><a id="_idIndexMarker423"/><st c="9076"> following </st><a id="_idIndexMarker424"/><st c="9087">lines </st><st c="9093">in </st><strong class="bold"><st c="9096">bold</st></strong><st c="9100">:</st></p>
			<pre class="source-code"><st c="9102">
…
from django.shortcuts import redirect
from django.contrib.auth.decorators import login_required
</st><strong class="bold"><st c="9200">from django.contrib.auth.models import User</st></strong><st c="9243">
…
</st><strong class="bold"><st c="9245">@login_required</st></strong>
<strong class="bold"><st c="9260">def orders(request):</st></strong>
<strong class="bold"/><strong class="bold"><st c="9281">template_data = {}</st></strong>
<strong class="bold"><st c="9300">    template_data['title'] = 'Orders'</st></strong>
<strong class="bold"><st c="9334">    template_data['orders'] = request.user.order_set.all()</st></strong>
<strong class="bold"><st c="9389">    return render(request, 'accounts/orders.html',</st></strong>
<strong class="bold"><st c="9436">        {'template_data': template_data})</st></strong></pre>			<p><st c="9470">Let’s explain the </st><st c="9489">previous code:</st></p>
			<ul>
				<li><st c="9503">We import the </st><code><st c="9518">User</st></code><st c="9522"> model</st><a id="_idIndexMarker425"/><st c="9528"> from Django’s </st><st c="9543">authentication system.</st></li>
				<li><st c="9565">We use the </st><code><st c="9577">login_required</st></code><st c="9591"> decorator to ensure that the user must be logged in to access the </st><code><st c="9658">orders</st></code><st c="9664"> function.</st></li>
				<li><st c="9674">We define the </st><code><st c="9689">orders</st></code><st c="9695"> function, which</st><a id="_idIndexMarker426"/><st c="9711"> takes a </st><code><st c="9720">request</st></code><st c="9727"> object as </st><st c="9738">a parameter.</st></li>
				<li><st c="9750">We define the </st><code><st c="9765">template_data</st></code><st c="9778"> variable and assign it </st><st c="9802">a </st><code><st c="9804">title</st></code><st c="9809">.</st></li>
				<li><st c="9810">We retrieve all orders belonging to the currently logged-in user (</st><code><st c="9877">request.user</st></code><st c="9890">). </st><st c="9894">The </st><code><st c="9898">order_set</st></code><st c="9907"> attribute is used to access the related orders associated with the user through their relationship (you can learn more about this type of relationship here </st><a href="https://docs.djangoproject.com/en/5.0/topics/db/examples/many_to_one/"><st c="10064">https://docs.djangoproject.com/en/5.0/topics/db/examples/many_to_one/</st></a><st c="10133">). </st><st c="10137">Remember that there is a </st><code><st c="10162">ForeignKey</st></code><st c="10172"> relationship between the </st><code><st c="10198">User</st></code><st c="10202"> model and the </st><code><st c="10217">Order</st></code><st c="10222"> model.</st></li>
				<li><st c="10229">Finally, we pass the orders to the template and </st><st c="10278">render it.</st></li>
			</ul>
			<h2 id="_idParaDest-236"><a id="_idTextAnchor244"/><st c="10288">Creating accounts.orders template</st></h2>
			<p><st c="10322">Now, in </st><code><st c="10331">/accounts/templates/accounts/</st></code><st c="10360">, create a </st><a id="_idIndexMarker427"/><st c="10371">new file, </st><code><st c="10381">orders.html</st></code><st c="10392">. For now, fill it with</st><a id="_idIndexMarker428"/> <st c="10415">the following:</st></p>
			<pre class="source-code"><st c="10430">
{% extends 'base.html' %}
{% block content %}
&lt;div class="p-3"&gt;
  &lt;div class="container"&gt;
    &lt;div class="row mt-3"&gt;
      &lt;div class="col mx-auto mb-3"&gt;
        &lt;h2&gt;My Orders&lt;/h2&gt;
        &lt;hr /&gt;
        {% for order in template_data.orders %}
        &lt;div class="card mb-4"&gt;
          &lt;div class="card-header"&gt;
            Order #{{ order.id }}
          &lt;/div&gt;
          &lt;div class="card-body"&gt;
            &lt;b&gt;Date:&lt;/b&gt; {{ order.date }}&lt;br /&gt;
            &lt;b&gt;Total:&lt;/b&gt; ${{ order.total }}&lt;br /&gt;
            &lt;table class="table table-bordered
              table-striped text-center mt-3"&gt;
              &lt;thead&gt;
                &lt;tr&gt;
                  &lt;th scope="col"&gt;Item ID&lt;/th&gt;
                  &lt;th scope="col"&gt;Movie&lt;/th&gt;
                  &lt;th scope="col"&gt;Price&lt;/th&gt;
                  &lt;th scope="col"&gt;Quantity&lt;/th&gt;
                &lt;/tr&gt;
              &lt;/thead&gt;
              &lt;tbody&gt;
                {% for item in order.item_set.all %}
                &lt;tr&gt;
                  &lt;td&gt;{{ item.movie.id }}&lt;/td&gt;
                  &lt;td&gt;
                    &lt;a class="link-dark"
                      href="{% url 'movies.show'
                      id=item.movie.id %}"&gt;
                      {{ item.movie.name }}
                    &lt;/a&gt;
                  &lt;/td&gt;
                  &lt;td&gt;${{ item.movie.price }}&lt;/td&gt;
                  &lt;td&gt;{{ item.quantity }}&lt;/td&gt;
                &lt;/tr&gt;
                {% endfor %}
              &lt;/tbody&gt;
            &lt;/table&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        {% endfor %}
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
{% endblock content %}</st></pre>			<p><st c="11389">Let’s explain the </st><st c="11408">previous </st><a id="_idIndexMarker429"/><st c="11417">code:</st></p>
			<ul>
				<li><st c="11422">We extend the </st><code><st c="11437">base.html</st></code><st c="11446"> template.</st></li>
				<li><st c="11456">We iterate over each order object stored in </st><code><st c="11501">template_data.orders</st></code><st c="11521">. For each order, we display its </st><code><st c="11554">date</st></code> <st c="11558">and </st><code><st c="11563">total</st></code><st c="11568">.</st></li>
				<li><st c="11569">Then, we iterate we iterate over each item in the current order. </st><st c="11635">The </st><code><st c="11639">order.item_set.all</st></code><st c="11657"> retrieves all related items associated with the current order. </st><st c="11721">For each of those items, we display its </st><code><st c="11761">price</st></code><st c="11766"> and </st><code><st c="11771">quantity</st></code><st c="11779">, and the corresponding movie</st><a id="_idIndexMarker430"/><st c="11808"> id </st><st c="11812">and name.</st></li>
			</ul>
			<h2 id="_idParaDest-237"><a id="_idTextAnchor245"/><st c="11821">Adding a link in the base template</st></h2>
			<p><st c="11856">Let’s add the orders link in the</st><a id="_idIndexMarker431"/><st c="11889"> base template. </st><st c="11905">In </st><code><st c="11908">/moviesstore/templates/base.html</st></code><st c="11940">, in the header section, add the following lines </st><st c="11989">in </st><strong class="bold"><st c="11992">bold</st></strong><st c="11996">:</st></p>
			<pre class="source-code"><st c="11998">
            …
            {% if user.is_authenticated %}
            </st><strong class="bold"><st c="12031">&lt;a class="nav-link"</st></strong>
<strong class="bold"><st c="12050">              href="{% url 'accounts.orders' %}"&gt;Orders</st></strong><strong class="bold"><st c="12092">&lt;/a&gt;</st></strong><st c="12097">
            &lt;a class="nav-link"
              href="{% url 'accounts.logout' %}"&gt;Logout
              ({{ user.username }})
            &lt;/a&gt;
            {% else %}
            &lt;a class="nav-link"
              href="{% url 'accounts.login' %}"&gt;Login
            &lt;/a&gt;
            &lt;a class="nav-link"
              href="{% url 'accounts.signup' %}"&gt;Sign Up
            &lt;/a&gt;
            {% endif %}
            …</st></pre>			<p><st c="12344">Now, save those files, run the server, and go to </st><code><st c="12394">http://localhost:8000/accounts/orders</st></code><st c="12431">. If you made a purchase, you would see your corresponding orders (</st><em class="italic"><st c="12498">Figure 12</st></em><em class="italic"><st c="12508">.3</st></em><st c="12510">):</st></p>
			<div><div><img src="img/B22457_12_03.jpg" alt="Figure 12.3 – Orders page"/><st c="12513"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><st c="12761">Figure 12.3 – Orders page</st></p>
			<p><st c="12786">We have completed the </st><a id="_idIndexMarker432"/><st c="12809">Movies Store project code. </st><st c="12836">We have implemented all the functionalities planned in </st><a href="B22457_01.xhtml#_idTextAnchor014"><em class="italic"><st c="12891">Chapter 1</st></em></a><st c="12900">. Now, let’s compare the implemented code with the </st><st c="12951">architecture diagram.</st></p>
			<h1 id="_idParaDest-238"><a id="_idTextAnchor246"/><st c="12972">Recapping the Movies Store MVT architecture</st></h1>
			<p><st c="13016">The architecture diagram of the Movies Store that we designed in </st><a href="B22457_01.xhtml#_idTextAnchor014"><em class="italic"><st c="13082">Chapter 1</st></em></a><st c="13091"> served as a blueprint for designing the</st><a id="_idIndexMarker433"/><st c="13131"> applications, layers, and code of the Movies Store. </st><st c="13184">We have already implemented all the applications and elements described in that diagram. </st><st c="13273">So, let’s quickly recap what we have accomplished </st><st c="13323">so far.</st></p>
			<p><em class="italic"><st c="13330">Figure 12</st></em><em class="italic"><st c="13340">.4</st></em><st c="13342"> displays the complete project tree directory structure and compares it with a simple version of the project architecture. </st><st c="13465">We have successfully implemented four apps (</st><code><st c="13509">accounts</st></code><st c="13518">, </st><code><st c="13520">cart</st></code><st c="13524">, </st><code><st c="13526">home</st></code><st c="13530">, and </st><code><st c="13536">movies</st></code><st c="13542">), which contain most of the </st><st c="13572">project’s functionalities.</st></p>
			<div><div><img src="img/B22457_12_04.jpg" alt="Figure 12.4 – Project tree directory compared with simplified architecture"/><st c="13598"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><st c="13801">Figure 12.4 – Project tree directory compared with simplified architecture</st></p>
			<p><em class="italic"><st c="13875">Figure 12</st></em><em class="italic"><st c="13885">.5</st></em><st c="13887"> displays the complete </st><a id="_idIndexMarker434"/><st c="13910">architecture. </st><st c="13924">We hope you understand each of the architectural elements better and how they relate to </st><st c="14012">each other.</st></p>
			<div><div><img src="img/B22457_12_05.jpg" alt="Figure 12.5 – Movies Store architecture"/><st c="14023"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><st c="14401">Figure 12.5 – Movies Store architecture</st></p>
			<p><st c="14440">Let’s make a last </st><st c="14459">quick analysis:</st></p>
			<ul>
				<li><st c="14474">We implemented a project-level folder named </st><code><st c="14519">moviesstore</st></code><st c="14530">. This folder contained the project-level URL file, which connected with app-level </st><st c="14613">URL files.</st></li>
				<li><st c="14623">We implemented four</st><a id="_idIndexMarker435"/><st c="14643"> Django apps. </st><st c="14657">For each of those apps, we illustrated the communication between the three main layers: models, views, </st><st c="14760">and templates.</st></li>
				<li><st c="14774">We learned how to divide the code across multiple apps to improve maintainability and </st><st c="14861">separate responsibilities.</st></li>
				<li><st c="14887">We practiced the implementation of those files and layers by implementing a set of functionalities for our Movies </st><st c="15002">Store project.</st></li>
			</ul>
			<p><st c="15016">What a journey! </st><st c="15033">We’ve utilized numerous Django modules, libraries, functions, concepts, and elements to</st><a id="_idIndexMarker436"/><st c="15120"> implement </st><st c="15131">this project.</st></p>
			<h1 id="_idParaDest-239"><a id="_idTextAnchor247"/><st c="15144">Summary</st></h1>
			<p><st c="15152">In this chapter, we completed the Movies Store project. </st><st c="15209">We implemented purchase functionality, which took advantage of the </st><code><st c="15276">Order</st></code><st c="15281"> and </st><code><st c="15286">Item</st></code><st c="15290"> models. </st><st c="15299">We created an orders page to allow users to view their orders. </st><st c="15362">We recapped our Movies Store architecture diagram and engaged in comparisons and discussions with the actual project code. </st><st c="15485">We have learned a lot since we started. </st><st c="15525">Now, it’s time for the final chapter. </st><st c="15563">Let’s learn how to deploy our Movies Store project to </st><st c="15617">the cloud.</st></p>
		</div>
	<div></body></html>