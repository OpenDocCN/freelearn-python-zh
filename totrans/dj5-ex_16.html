<html><head></head><body>
<div class="Basic-Text-Frame" id="_idContainer424">
<h1 class="chapterNumber"><span class="koboSpan" id="kobo.1.1">16</span></h1>
<h1 class="chapterTitle" id="_idParaDest-421"><span class="koboSpan" id="kobo.2.1">Building a Chat Server</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">In the previous chapter, you created a RESTful API for your project that provides a programmable interface for your application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4.1">In this chapter, you will develop a chat server for students using Django Channels, enabling students to engage in real-time messaging within course chat rooms. </span><span class="koboSpan" id="kobo.4.2">You will learn how to build real-time applications through asynchronous programming with Django Channels. </span><span class="koboSpan" id="kobo.4.3">By serving your Django project through </span><strong class="keyWord"><span class="koboSpan" id="kobo.5.1">Asynchronous Server Gateway Interface</span></strong><span class="koboSpan" id="kobo.6.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.7.1">ASGI</span></strong><span class="koboSpan" id="kobo.8.1">), and </span><a id="_idIndexMarker1426"/><span class="koboSpan" id="kobo.9.1">implementing asynchronous communication, you will enhance the responsiveness and scalability of your server. </span><span class="koboSpan" id="kobo.9.2">Additionally, you will persist chat messages into the database, building a comprehensive chat history and enriching the user experience and functionality of the chat application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.10.1">In this chapter, you will:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.11.1">Add Channels to your project</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.12.1">Build a WebSocket consumer and appropriate routing</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.13.1">Implement a WebSocket client</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.14.1">Enable a channel layer with Redis</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.15.1">Make your consumer fully asynchronous</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.16.1">Persist chat messages into the database</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-422"><span class="koboSpan" id="kobo.17.1">Functional overview</span></h1>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.18.1">Figure 16.1</span></em><span class="koboSpan" id="kobo.19.1"> shows a representation of the views, templates, and functionalities that will be built in this chapter:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.20.1"><img alt="" role="presentation" src="../Images/B21088_16_01.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.21.1">Figure 16.1: Diagram of functionalities built in this chapter</span></p>
<p class="normal"><span class="koboSpan" id="kobo.22.1">In this chapter, you will implement the </span><code class="inlineCode"><span class="koboSpan" id="kobo.23.1">course_chat_room</span></code><span class="koboSpan" id="kobo.24.1"> view in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.25.1">chat</span></code><span class="koboSpan" id="kobo.26.1"> application. </span><span class="koboSpan" id="kobo.26.2">This view will serve the template that displays the chat room for a given course. </span><span class="koboSpan" id="kobo.26.3">The latest chat messages will be displayed when a user joins a chat room. </span><span class="koboSpan" id="kobo.26.4">You will use JavaScript to establish a WebSocket connection in the browser, and you will build the </span><code class="inlineCode"><span class="koboSpan" id="kobo.27.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.28.1"> WebSocket consumer to handle WebSocket connections and to exchange messages. </span><span class="koboSpan" id="kobo.28.2">You will use Redis to implement the channel layer that allows broadcasting messages to all users in the chat room.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.29.1">The source code for this chapter can be found at </span><a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter16"><span class="url"><span class="koboSpan" id="kobo.30.1">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter16</span></span></a><span class="koboSpan" id="kobo.31.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.32.1">All Python modules used in this chapter are included in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.33.1">requirements.txt</span></code><span class="koboSpan" id="kobo.34.1"> file in the source code that comes along with this chapter. </span><span class="koboSpan" id="kobo.34.2">You can follow the instructions to install each Python module below or you can install all requirements at once with the command </span><code class="inlineCode"><span class="koboSpan" id="kobo.35.1">python -m pip install -r requirements.txt</span></code><span class="koboSpan" id="kobo.36.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-423"><span class="koboSpan" id="kobo.37.1">Creating a chat application</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.38.1">You are going to implement a</span><a id="_idIndexMarker1427"/><span class="koboSpan" id="kobo.39.1"> chat server to provide students with a chat room for each course. </span><span class="koboSpan" id="kobo.39.2">Students enrolled in a course will be able to access the course chat room and exchange messages in real time. </span><span class="koboSpan" id="kobo.39.3">You will use Channels to build this functionality. </span><span class="koboSpan" id="kobo.39.4">Channels is </span><a id="_idIndexMarker1428"/><span class="koboSpan" id="kobo.40.1">a Django application that extends Django to handle protocols that require long-running connections, such as WebSockets, chatbots, or MQTT (a lightweight publish/subscribe message </span><a id="_idIndexMarker1429"/><span class="koboSpan" id="kobo.41.1">transport commonly used in </span><strong class="keyWord"><span class="koboSpan" id="kobo.42.1">Internet of Things</span></strong><span class="koboSpan" id="kobo.43.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.44.1">IoT</span></strong><span class="koboSpan" id="kobo.45.1">) projects).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.46.1">Using Channels, you can easily implement real-time or asynchronous functionalities into your project in addition to your standard HTTP synchronous views. </span><span class="koboSpan" id="kobo.46.2">You will start by adding a new application to your project. </span><span class="koboSpan" id="kobo.46.3">The new application will contain the logic for the chat server.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.47.1">You can the documentation for</span><a id="_idIndexMarker1430"/><span class="koboSpan" id="kobo.48.1"> Django Channels at </span><a href="https://channels.readthedocs.io/"><span class="url"><span class="koboSpan" id="kobo.49.1">https://channels.readthedocs.io/</span></span></a><span class="koboSpan" id="kobo.50.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.51.1">Let’s start implementing the chat server. </span><span class="koboSpan" id="kobo.51.2">Run the following command from the project’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.52.1">educa</span></code><span class="koboSpan" id="kobo.53.1"> directory to create the new application file structure:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.54.1">django-admin startapp chat
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.55.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.56.1">settings.py</span></code><span class="koboSpan" id="kobo.57.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.58.1">educa</span></code><span class="koboSpan" id="kobo.59.1"> project and activate the </span><code class="inlineCode"><span class="koboSpan" id="kobo.60.1">chat</span></code><span class="koboSpan" id="kobo.61.1"> application in your project by editing the </span><code class="inlineCode"><span class="koboSpan" id="kobo.62.1">INSTALLED_APPS</span></code><span class="koboSpan" id="kobo.63.1"> setting, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.64.1">INSTALLED_APPS = [
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.65.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.66.1">'chat.apps.ChatConfig'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.67.1">,</span></strong></span><span class="koboSpan" id="kobo.68.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.69.1">The new </span><code class="inlineCode"><span class="koboSpan" id="kobo.70.1">chat</span></code><span class="koboSpan" id="kobo.71.1"> application is now </span><a id="_idIndexMarker1431"/><span class="koboSpan" id="kobo.72.1">active in your project. </span><span class="koboSpan" id="kobo.72.2">Next, you are going to build a view for course chat rooms.</span></p>
<h2 class="heading-2" id="_idParaDest-424"><span class="koboSpan" id="kobo.73.1">Implementing the chat room view</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.74.1">You will provide students with a </span><a id="_idIndexMarker1432"/><span class="koboSpan" id="kobo.75.1">different chat room for each course. </span><span class="koboSpan" id="kobo.75.2">You need to create a view for students to join the chat room of a given course. </span><span class="koboSpan" id="kobo.75.3">Only students who are enrolled in a course will be able to access the course chat room.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.76.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.77.1">views.py</span></code><span class="koboSpan" id="kobo.78.1"> file of the new </span><code class="inlineCode"><span class="koboSpan" id="kobo.79.1">chat</span></code><span class="koboSpan" id="kobo.80.1"> application and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.81.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.82.1"> django.contrib.auth.decorators </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.83.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.84.1"> login_required</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.85.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.86.1"> django.http </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.87.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.88.1"> HttpResponseForbidden</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.89.1">from</span></span><span class="koboSpan" id="kobo.90.1"> django.shortcuts </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.91.1">import</span></span><span class="koboSpan" id="kobo.92.1"> render
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.93.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.94.1"> courses.models </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.95.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.96.1"> Course</span></strong></span>
<span class="code-highlight"><strong class="hljs-meta-slc"><span class="koboSpan" id="kobo.97.1">@login_required</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.98.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.99.1">course_chat_room</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.100.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.101.1">request, course_id</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.102.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.103.1">try</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.104.1">:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.105.1"># retrieve course with given id joined by the current user</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.106.1">        course = request.user.courses_joined.get(</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.107.1">id</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.108.1">=course_id)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.109.1">except</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.110.1"> Course.DoesNotExist:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.111.1"># user is not a student of the course or course does not exist</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.112.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.113.1"> HttpResponseForbidden()</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.114.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.115.1"> render(request, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.116.1">'chat/room.html'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.117.1">, {</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.118.1">'course'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.119.1">: course})</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.120.1">This is the </span><code class="inlineCode"><span class="koboSpan" id="kobo.121.1">course_chat_room</span></code><span class="koboSpan" id="kobo.122.1"> view. </span><span class="koboSpan" id="kobo.122.2">In </span><a id="_idIndexMarker1433"/><span class="koboSpan" id="kobo.123.1">this view, you use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.124.1">@login_required</span></code><span class="koboSpan" id="kobo.125.1"> decorator to prevent any non-authenticated user from accessing the view. </span><span class="koboSpan" id="kobo.125.2">The view works as follows:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.126.1">The view receives a required </span><code class="inlineCode"><span class="koboSpan" id="kobo.127.1">course_id</span></code><span class="koboSpan" id="kobo.128.1"> parameter that is used to retrieve the course with the given </span><code class="inlineCode"><span class="koboSpan" id="kobo.129.1">id</span></code><span class="koboSpan" id="kobo.130.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.131.1">The courses that the user is enrolled in are retrieved through the </span><code class="inlineCode"><span class="koboSpan" id="kobo.132.1">courses_joined</span></code><span class="koboSpan" id="kobo.133.1"> relationship and the course with the given </span><code class="inlineCode"><span class="koboSpan" id="kobo.134.1">id</span></code><span class="koboSpan" id="kobo.135.1"> is obtained from that subset of courses. </span><span class="koboSpan" id="kobo.135.2">If the course with the given </span><code class="inlineCode"><span class="koboSpan" id="kobo.136.1">id</span></code><span class="koboSpan" id="kobo.137.1"> does not exist or the user is not enrolled in it, an </span><code class="inlineCode"><span class="koboSpan" id="kobo.138.1">HttpResponseForbidden</span></code><span class="koboSpan" id="kobo.139.1"> response is returned, which translates to an HTTP response with status </span><code class="inlineCode"><span class="koboSpan" id="kobo.140.1">403</span></code><span class="koboSpan" id="kobo.141.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.142.1">If the course with the given </span><code class="inlineCode"><span class="koboSpan" id="kobo.143.1">id</span></code><span class="koboSpan" id="kobo.144.1"> exists and the user is enrolled in it, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.145.1">chat/room.html</span></code><span class="koboSpan" id="kobo.146.1"> template is rendered, passing the </span><code class="inlineCode"><span class="koboSpan" id="kobo.147.1">course</span></code><span class="koboSpan" id="kobo.148.1"> object to the template context.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.149.1">You need to add a URL pattern for this view. </span><span class="koboSpan" id="kobo.149.2">Create a new file inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.150.1">chat</span></code><span class="koboSpan" id="kobo.151.1"> application directory and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.152.1">urls.py</span></code><span class="koboSpan" id="kobo.153.1">. </span><span class="koboSpan" id="kobo.153.2">Add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.154.1">from</span></span><span class="koboSpan" id="kobo.155.1"> django.urls </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.156.1">import</span></span><span class="koboSpan" id="kobo.157.1"> path
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.158.1">from</span></span><span class="koboSpan" id="kobo.159.1"> . </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.160.1">import</span></span><span class="koboSpan" id="kobo.161.1"> views
app_name = </span><span class="hljs-string"><span class="koboSpan" id="kobo.162.1">'chat'</span></span><span class="koboSpan" id="kobo.163.1">
urlpatterns = [
    path(
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.164.1">'room/&lt;int:course_id&gt;/'</span></span><span class="koboSpan" id="kobo.165.1">,
        views.course_chat_room,
        name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.166.1">'course_chat_room'</span></span><span class="koboSpan" id="kobo.167.1">),
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.168.1">This is the initial URL </span><a id="_idIndexMarker1434"/><span class="koboSpan" id="kobo.169.1">patterns file for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.170.1">chat</span></code><span class="koboSpan" id="kobo.171.1"> application. </span><span class="koboSpan" id="kobo.171.2">You define the </span><code class="inlineCode"><span class="koboSpan" id="kobo.172.1">course_chat_room</span></code><span class="koboSpan" id="kobo.173.1"> URL pattern, including the </span><code class="inlineCode"><span class="koboSpan" id="kobo.174.1">course_id</span></code><span class="koboSpan" id="kobo.175.1"> parameter with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.176.1">int</span></code><span class="koboSpan" id="kobo.177.1"> prefix, as you only expect an integer value here.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.178.1">Include the new URL patterns of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.179.1">chat</span></code><span class="koboSpan" id="kobo.180.1"> application in the main URL patterns of the project. </span><span class="koboSpan" id="kobo.180.2">Edit the main </span><code class="inlineCode"><span class="koboSpan" id="kobo.181.1">urls.py</span></code><span class="koboSpan" id="kobo.182.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.183.1">educa</span></code><span class="koboSpan" id="kobo.184.1"> project and add the following line to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.185.1">urlpatterns = [
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.186.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.187.1">    path(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.188.1">'chat/'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.189.1">, include(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.190.1">'chat.urls'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.191.1">, namespace=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.192.1">'chat'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.193.1">)),</span></strong></span><span class="koboSpan" id="kobo.194.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.195.1">URL patterns for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.196.1">chat</span></code><span class="koboSpan" id="kobo.197.1"> application are added to the project under the </span><code class="inlineCode"><span class="koboSpan" id="kobo.198.1">chat/</span></code><span class="koboSpan" id="kobo.199.1"> path.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.200.1">You need to create a template for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.201.1">course_chat_room</span></code><span class="koboSpan" id="kobo.202.1"> view. </span><span class="koboSpan" id="kobo.202.2">This template will contain an area to visualize the messages that are exchanged in the chat, and a text input with a submit button to send text messages to the chat.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.203.1">Create the following file structure within the </span><code class="inlineCode"><span class="koboSpan" id="kobo.204.1">chat</span></code><span class="koboSpan" id="kobo.205.1"> application directory:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.206.1">templates/
    chat/
        room.html
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.207.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.208.1">chat/room.html</span></code><span class="koboSpan" id="kobo.209.1"> template and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.210.1">{% extends "base.html" %}
{% block title %}Chat room for "{{ course.title }}"{% endblock %}
{% block content %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.211.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.212.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.213.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.214.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.215.1">"chat"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.216.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.217.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.218.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.219.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.220.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.221.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.222.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.223.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.224.1">"chat-input"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.225.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.226.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.227.1">input</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.228.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.229.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.230.1">"chat-message-input"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.231.1">type</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.232.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.233.1">"text"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.234.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.235.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.236.1">input</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.237.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.238.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.239.1">"chat-message-submit"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.240.1">type</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.241.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.242.1">"submit"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.243.1">value</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.244.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.245.1">"Send"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.246.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.247.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.248.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.249.1">&gt;</span></span><span class="koboSpan" id="kobo.250.1">
{% endblock %}
{% block include_js %}
{% endblock %}
{% block domready %}
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.251.1">This is the template for the course chat room. </span><span class="koboSpan" id="kobo.251.2">In this template, you perform the following actions:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.252.1">You extend the </span><code class="inlineCode"><span class="koboSpan" id="kobo.253.1">base.html</span></code><span class="koboSpan" id="kobo.254.1"> template of your project and fill its </span><code class="inlineCode"><span class="koboSpan" id="kobo.255.1">content</span></code><span class="koboSpan" id="kobo.256.1"> block.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.257.1">You define a </span><code class="inlineCode"><span class="koboSpan" id="kobo.258.1">&lt;div&gt;</span></code><span class="koboSpan" id="kobo.259.1"> HTML element with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.260.1">chat</span></code><span class="koboSpan" id="kobo.261.1"> ID that you will use to display the chat messages sent by the user and by other students.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.262.1">You also define a second </span><code class="inlineCode"><span class="koboSpan" id="kobo.263.1">&lt;div&gt;</span></code><span class="koboSpan" id="kobo.264.1"> element with a </span><code class="inlineCode"><span class="koboSpan" id="kobo.265.1">text</span></code><span class="koboSpan" id="kobo.266.1"> input and a submit button that will allow the user to send messages.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.267.1">You add the </span><code class="inlineCode"><span class="koboSpan" id="kobo.268.1">include_js</span></code><span class="koboSpan" id="kobo.269.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.270.1">domready</span></code><span class="koboSpan" id="kobo.271.1"> blocks defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.272.1">base.html</span></code><span class="koboSpan" id="kobo.273.1"> template, which you are going to implement later, to establish a connection with a WebSocket and send or receive messages.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.274.1">Run the development </span><a id="_idIndexMarker1435"/><span class="koboSpan" id="kobo.275.1">server and open </span><code class="inlineCode"><span class="koboSpan" id="kobo.276.1">http://127.0.0.1:8000/chat/room/1/</span></code><span class="koboSpan" id="kobo.277.1"> in your browser, replacing </span><code class="inlineCode"><span class="koboSpan" id="kobo.278.1">1</span></code><span class="koboSpan" id="kobo.279.1"> with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.280.1">id</span></code><span class="koboSpan" id="kobo.281.1"> of an existing course in the database. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.282.1">Access the chat room with a logged-in user who is enrolled in the course. </span><span class="koboSpan" id="kobo.282.2">You will see the following screen:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.283.1"><img alt="" role="presentation" src="../Images/B21088_16_02.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.284.1">Figure 16.2: The course chat room page</span></p>
<p class="normal"><span class="koboSpan" id="kobo.285.1">This is the course </span><a id="_idIndexMarker1436"/><span class="koboSpan" id="kobo.286.1">chat room screen that students will use to discuss topics within a course.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.287.1">You have created the base view for the course chat room. </span><span class="koboSpan" id="kobo.287.2">Now you need to handle messages between students. </span><span class="koboSpan" id="kobo.287.3">The next section will introduce asynchronous support with Channels for real-time communication.</span></p>
<h1 class="heading-1" id="_idParaDest-425"><span class="koboSpan" id="kobo.288.1">Real-time Django with Channels</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.289.1">You are building a chat</span><a id="_idIndexMarker1437"/><span class="koboSpan" id="kobo.290.1"> server to provide students with a chat room for each</span><a id="_idIndexMarker1438"/><span class="koboSpan" id="kobo.291.1"> course. </span><span class="koboSpan" id="kobo.291.2">Students enrolled in a course will be able to access the course chat room and exchange messages. </span><span class="koboSpan" id="kobo.291.3">This functionality requires real-time communication between the server and the client.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.292.1">A standard HTTP request/response model doesn’t work here because you need the browser to receive notifications as soon as new messages arrive. </span><span class="koboSpan" id="kobo.292.2">There are several ways you could implement this feature, using AJAX polling or long polling in combination with storing the messages in your database or Redis. </span><span class="koboSpan" id="kobo.292.3">However, there is no efficient way to implement real-time communication using a standard synchronous web application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.293.1">You need asynchronous communication, which allows real-time interactions, where the server can push updates to the client as soon as new messages arrive without the client needing to request updates periodically. </span><span class="koboSpan" id="kobo.293.2">Asynchronous communication also comes with other advantages, such as reduced latency, improved performance under load, and a better overall user experience. </span><span class="koboSpan" id="kobo.293.3">You are going to build a chat server using asynchronous communication through ASGI.</span></p>
<h2 class="heading-2" id="_idParaDest-426"><span class="koboSpan" id="kobo.294.1">Asynchronous applications using ASGI</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.295.1">Django is usually deployed</span><a id="_idIndexMarker1439"/><span class="koboSpan" id="kobo.296.1"> using </span><strong class="keyWord"><span class="koboSpan" id="kobo.297.1">Web Server Gateway Interface</span></strong><span class="koboSpan" id="kobo.298.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.299.1">WSGI</span></strong><span class="koboSpan" id="kobo.300.1">), which is the standard interface for Python applications to</span><a id="_idIndexMarker1440"/><span class="koboSpan" id="kobo.301.1"> handle HTTP requests. </span><span class="koboSpan" id="kobo.301.2">However, to work with asynchronous applications, you need to use another interface called ASGI, which can handle WebSocket requests as well. </span><span class="koboSpan" id="kobo.301.3">ASGI is the emerging Python standard for asynchronous web servers and applications. </span><span class="koboSpan" id="kobo.301.4">By using ASGI, we will enable Django to handle each message independently and in real time, creating a smooth and live chat experience for students.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.302.1">You can find an introduction to </span><a id="_idIndexMarker1441"/><span class="koboSpan" id="kobo.303.1">ASGI at </span><a href="https://asgi.readthedocs.io/en/latest/introduction.html"><span class="url"><span class="koboSpan" id="kobo.304.1">https://asgi.readthedocs.io/en/latest/introduction.html</span></span></a><span class="koboSpan" id="kobo.305.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.306.1">Django comes with support for running asynchronous Python through ASGI. </span><span class="koboSpan" id="kobo.306.2">Writing asynchronous views has been supported since Django 3.1, and Django 4.1 introduced asynchronous handlers for class-based views. </span><span class="koboSpan" id="kobo.306.3">Django 5.0 adds handling for disconnect events in asynchronous views before the response is generated. </span><span class="koboSpan" id="kobo.306.4">It also adds asynchronous functions to the authentication framework, provides support for asynchronous signal dispatching, and adds async support to multiple built-in decorators.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.307.1">Channels builds upon the</span><a id="_idIndexMarker1442"/><span class="koboSpan" id="kobo.308.1"> native ASGI support available in Django and provides additional functionalities to handle protocols that require long-running connections, such as WebSockets, IoT protocols, and chat protocols.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.309.1">WebSockets</span><a id="_idIndexMarker1443"/><span class="koboSpan" id="kobo.310.1"> provide full-duplex communication by establishing a persistent, open, bidirectional </span><strong class="keyWord"><span class="koboSpan" id="kobo.311.1">Transmission Control Protocol</span></strong><span class="koboSpan" id="kobo.312.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.313.1">TCP</span></strong><span class="koboSpan" id="kobo.314.1">) connection between servers and clients. </span><span class="koboSpan" id="kobo.314.2">Instead of sending </span><a id="_idIndexMarker1444"/><span class="koboSpan" id="kobo.315.1">HTTP requests to the server, you establish a connection with the server; once the channel is open, messages can be exchanged in both directions without needing to establish a new connection each time. </span><span class="koboSpan" id="kobo.315.2">You are going to use WebSockets to implement your chat server.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.316.1">You can read more about </span><a id="_idIndexMarker1445"/><span class="koboSpan" id="kobo.317.1">WebSockets at </span><a href="https://en.wikipedia.org/wiki/WebSocket"><span class="url"><span class="koboSpan" id="kobo.318.1">https://en.wikipedia.org/wiki/WebSocket</span></span></a><span class="koboSpan" id="kobo.319.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.320.1">You can find </span><a id="_idIndexMarker1446"/><span class="koboSpan" id="kobo.321.1">more information about deploying Django with ASGI at </span><a href="https://docs.djangoproject.com/en/5.0/howto/deployment/asgi/"><span class="url"><span class="koboSpan" id="kobo.322.1">https://docs.djangoproject.com/en/5.0/howto/deployment/asgi/</span></span></a><span class="koboSpan" id="kobo.323.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.324.1">You can find more information about Django’s support</span><a id="_idIndexMarker1447"/><span class="koboSpan" id="kobo.325.1"> for writing asynchronous views at </span><a href="https://docs.djangoproject.com/en/5.0/topics/async/"><span class="url"><span class="koboSpan" id="kobo.326.1">https://docs.djangoproject.com/en/5.0/topics/async/</span></span></a><span class="koboSpan" id="kobo.327.1"> and Django’s support for asynchronous class-based views</span><a id="_idIndexMarker1448"/><span class="koboSpan" id="kobo.328.1"> at </span><a href="https://docs.djangoproject.com/en/5.0/topics/class-based-views/#async-class-based-views"><span class="url"><span class="koboSpan" id="kobo.329.1">https://docs.djangoproject.com/en/5.0/topics/class-based-views/#async-class-based-views</span></span></a><span class="koboSpan" id="kobo.330.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.331.1">Next, we are going to learn how the Django request/response cycle is altered by using Channels.</span></p>
<h2 class="heading-2" id="_idParaDest-427"><span class="koboSpan" id="kobo.332.1">The request/response cycle using Channels</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.333.1">It’s important to</span><a id="_idIndexMarker1449"/><span class="koboSpan" id="kobo.334.1"> understand the differences in a request cycle</span><a id="_idIndexMarker1450"/><span class="koboSpan" id="kobo.335.1"> between a standard synchronous request cycle and a Channels implementation. </span><span class="koboSpan" id="kobo.335.2">The following schema shows the request cycle of a synchronous Django setup:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.336.1"><img alt="" role="presentation" src="../Images/B21088_16_03.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.337.1">Figure 16.3: The Django request/response cycle</span></p>
<p class="normal"><span class="koboSpan" id="kobo.338.1">When an HTTP request is sent by the browser to the web server, Django handles the request and passes the </span><code class="inlineCode"><span class="koboSpan" id="kobo.339.1">HttpRequest</span></code><span class="koboSpan" id="kobo.340.1"> object to the corresponding view. </span><span class="koboSpan" id="kobo.340.2">The view processes the request and returns an </span><code class="inlineCode"><span class="koboSpan" id="kobo.341.1">HttpResponse</span></code><span class="koboSpan" id="kobo.342.1"> object that is sent back to the browser as an HTTP response. </span><span class="koboSpan" id="kobo.342.2">There is no mechanism to maintain an open connection or send data to the browser without an associated HTTP request.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.343.1">The following schema shows the request cycle of a Django project using Channels with WebSockets:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.344.1"><img alt="" role="presentation" src="../Images/B21088_16_04.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.345.1">Figure 16.4: The Django Channels request/response cycle</span></p>
<p class="normal"><span class="koboSpan" id="kobo.346.1">Channels</span><a id="_idIndexMarker1451"/><span class="koboSpan" id="kobo.347.1"> replaces Django’s request/response cycle with</span><a id="_idIndexMarker1452"/><span class="koboSpan" id="kobo.348.1"> messages that are sent across channels. </span><span class="koboSpan" id="kobo.348.2">HTTP requests are still routed to view functions using Django, but they get routed over channels. </span><span class="koboSpan" id="kobo.348.3">This allows WebSocket message handling as well, where you have producers and consumers that exchange messages across a channel layer. </span><span class="koboSpan" id="kobo.348.4">Channels preserves Django’s synchronous architecture, allowing you to choose between writing synchronous code and asynchronous code, or a combination of both.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.349.1">Your </span><a id="_idIndexMarker1453"/><span class="koboSpan" id="kobo.350.1">existing synchronous views will co-exist with the</span><a id="_idIndexMarker1454"/><span class="koboSpan" id="kobo.351.1"> WebSocket functionality that we will implement with Daphne, and you will serve both HTTP and WebSocket requests.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.352.1">Next, you are going to install Channels and add it to your project.</span></p>
<h1 class="heading-1" id="_idParaDest-428"><span class="koboSpan" id="kobo.353.1">Installing Channels and Daphne</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.354.1">You are going to add Channels to your project and set up the required basic ASGI application routing for it to manage HTTP requests.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.355.1">Install Channels in your </span><a id="_idIndexMarker1455"/><span class="koboSpan" id="kobo.356.1">virtual environment with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.357.1">python -m pip install -U 'channels[daphne]==4.1.0'
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.358.1">This will simultaneously install Channels along with the Daphne ASGI application server. </span><span class="koboSpan" id="kobo.358.2">An ASGI server is necessary for handling asynchronous requests, and we choose Daphne for its simplicity and compatibility, as it comes bundled with Channels.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.359.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.360.1">settings.py</span></code><span class="koboSpan" id="kobo.361.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.362.1">educa</span></code><span class="koboSpan" id="kobo.363.1"> project and add </span><code class="inlineCode"><span class="koboSpan" id="kobo.364.1">daphne</span></code><span class="koboSpan" id="kobo.365.1"> to the beginning of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.366.1">INSTALLED_APPS</span></code><span class="koboSpan" id="kobo.367.1"> setting as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.368.1">INSTALLED_APPS = [
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.369.1">'daphne'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.370.1">,</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.371.1"># ...</span></span><span class="koboSpan" id="kobo.372.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.373.1">When </span><code class="inlineCode"><span class="koboSpan" id="kobo.374.1">daphne</span></code><span class="koboSpan" id="kobo.375.1"> is added </span><a id="_idIndexMarker1456"/><span class="koboSpan" id="kobo.376.1">to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.377.1">INSTALLED_APPS</span></code><span class="koboSpan" id="kobo.378.1"> setting, it takes control over the </span><code class="inlineCode"><span class="koboSpan" id="kobo.379.1">runserver</span></code><span class="koboSpan" id="kobo.380.1"> command, replacing the standard Django development server. </span><span class="koboSpan" id="kobo.380.2">This will allow you to serve asynchronous requests during development. </span><span class="koboSpan" id="kobo.380.3">Besides handling URL routing to Django views for synchronous requests, Daphne also manages routes to WebSocket consumers. </span><span class="koboSpan" id="kobo.380.4">You can find more </span><a id="_idIndexMarker1457"/><span class="koboSpan" id="kobo.381.1">information about Daphne at </span><a href="https://github.com/django/daphne"><span class="url"><span class="koboSpan" id="kobo.382.1">https://github.com/django/daphne</span></span></a><span class="koboSpan" id="kobo.383.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.384.1">Channels expects you to define a single root application that will be executed for all requests. </span><span class="koboSpan" id="kobo.384.2">You can define the root application by adding the </span><code class="inlineCode"><span class="koboSpan" id="kobo.385.1">ASGI_APPLICATION</span></code><span class="koboSpan" id="kobo.386.1"> setting to your project. </span><span class="koboSpan" id="kobo.386.2">This is similar to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.387.1">ROOT_URLCONF</span></code><span class="koboSpan" id="kobo.388.1"> setting that points to the base URL patterns of your project. </span><span class="koboSpan" id="kobo.388.2">You can place the root application anywhere in your project, but it is recommended to put it in a project-level file. </span><span class="koboSpan" id="kobo.388.3">You can add your root routing configuration to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.389.1">asgi.py</span></code><span class="koboSpan" id="kobo.390.1"> file directly, where the ASGI application will be defined.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.391.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.392.1">asgi.py</span></code><span class="koboSpan" id="kobo.393.1"> file in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.394.1">educa</span></code><span class="koboSpan" id="kobo.395.1"> project directory and add the following code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.396.1">import</span></span><span class="koboSpan" id="kobo.397.1"> os
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.398.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.399.1"> channels.routing </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.400.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.401.1"> ProtocolTypeRouter</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.402.1">from</span></span><span class="koboSpan" id="kobo.403.1"> django.core.asgi </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.404.1">import</span></span><span class="koboSpan" id="kobo.405.1"> get_asgi_application
os.environ.setdefault(</span><span class="hljs-string"><span class="koboSpan" id="kobo.406.1">'DJANGO_SETTINGS_MODULE'</span></span><span class="koboSpan" id="kobo.407.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.408.1">'educa.settings'</span></span><span class="koboSpan" id="kobo.409.1">)
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.410.1">django_asgi_app</span></strong></span><span class="koboSpan" id="kobo.411.1"> = get_asgi_application()
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.412.1">application = ProtocolTypeRouter({</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.413.1">'http'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.414.1">: django_asgi_app,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.415.1">})</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.416.1">In the previous code, you define the main ASGI application that will be executed when serving the </span><a id="_idIndexMarker1458"/><span class="koboSpan" id="kobo.417.1">Django project through ASGI. </span><span class="koboSpan" id="kobo.417.2">You use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.418.1">ProtocolTypeRouter</span></code><span class="koboSpan" id="kobo.419.1"> class provided by Channels as the main entry point of your routing system. </span><code class="inlineCode"><span class="koboSpan" id="kobo.420.1">ProtocolTypeRouter</span></code><span class="koboSpan" id="kobo.421.1"> takes a dictionary that maps communication types like </span><code class="inlineCode"><span class="koboSpan" id="kobo.422.1">http</span></code><span class="koboSpan" id="kobo.423.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.424.1">websocket</span></code><span class="koboSpan" id="kobo.425.1"> to ASGI applications. </span><span class="koboSpan" id="kobo.425.2">You instantiate this class with the default application for the HTTP protocol. </span><span class="koboSpan" id="kobo.425.3">Later, you will add a protocol for the WebSocket.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.426.1">Add the following line to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.427.1">settings.py</span></code><span class="koboSpan" id="kobo.428.1"> file of your project:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.429.1">ASGI_APPLICATION = </span><span class="hljs-string"><span class="koboSpan" id="kobo.430.1">'educa.asgi.application'</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.431.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.432.1">ASGI_APPLICATION</span></code><span class="koboSpan" id="kobo.433.1"> setting is used by Channels to locate the root routing configuration.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.434.1">Start the development server using the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.435.1">python manage.py runserver
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.436.1">You will see output similar to the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.437.1">Watching for file changes with StatReloader
Performing system checks...
</span><span class="koboSpan" id="kobo.437.2">System check identified no issues (0 silenced).
</span><span class="koboSpan" id="kobo.437.3">April 14, 2024 - 08:02:57
Django version 5.0.4, using settings 'educa.settings'
Starting ASGI/Daphne version 4.1.0 development server at http://127.0.0.1:8000/
Quit the server with CONTROL-C.
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.438.1">Check that the output contains the line </span><code class="inlineCode"><span class="koboSpan" id="kobo.439.1">Starting ASGI/Daphne version 4.1.0 development server</span></code><span class="koboSpan" id="kobo.440.1">. </span><span class="koboSpan" id="kobo.440.2">This line confirms that you are using the Daphne development server, which is capable of managing synchronous and asynchronous requests, instead of the standard Django development server. </span><span class="koboSpan" id="kobo.440.3">HTTP requests continue to behave the same as before, but they get routed over Channels.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.441.1">Now that Channels is installed in your project, you can build the chat server for courses. </span><span class="koboSpan" id="kobo.441.2">To implement the chat server for your project, you will need to take the following steps:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><strong class="keyWord"><span class="koboSpan" id="kobo.442.1">Set up a consumer</span></strong><span class="koboSpan" id="kobo.443.1">: Consumers are individual pieces of code that can handle WebSockets in a very similar way to traditional HTTP views. </span><span class="koboSpan" id="kobo.443.2">You will build a consumer to read and write messages to a communication channel.</span></li>
<li class="numberedList"><strong class="keyWord"><span class="koboSpan" id="kobo.444.1">Configure routing</span></strong><span class="koboSpan" id="kobo.445.1">: Channels provides routing classes that allow you to combine and stack your consumers. </span><span class="koboSpan" id="kobo.445.2">You will configure URL routing for your chat consumer.</span></li>
<li class="numberedList"><strong class="keyWord"><span class="koboSpan" id="kobo.446.1">Implement a WebSocket client</span></strong><span class="koboSpan" id="kobo.447.1">: When the student accesses the chat room, you will connect to the WebSocket from the browser and send or receive messages using JavaScript.</span></li>
<li class="numberedList"><strong class="keyWord"><span class="koboSpan" id="kobo.448.1">Enable a channel layer</span></strong><span class="koboSpan" id="kobo.449.1">: Channel layers allow you to talk between different instances of an application. </span><span class="koboSpan" id="kobo.449.2">They’re a useful part of making a distributed real-time application. </span><span class="koboSpan" id="kobo.449.3">You will set up a channel layer using Redis.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.450.1">Let’s start by writing your own consumer to handle connecting to a WebSocket, receiving and sending messages, and disconnecting.</span></p>
<h1 class="heading-1" id="_idParaDest-429"><span class="koboSpan" id="kobo.451.1">Writing a consumer</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.452.1">Consumers</span><a id="_idIndexMarker1459"/><span class="koboSpan" id="kobo.453.1"> are the equivalent of Django views for asynchronous applications. </span><span class="koboSpan" id="kobo.453.2">As mentioned, they handle WebSockets in a very similar way to how traditional views handle HTTP </span><a id="_idIndexMarker1460"/><span class="koboSpan" id="kobo.454.1">requests. </span><span class="koboSpan" id="kobo.454.2">Consumers are ASGI applications that can handle messages, notifications, and other things. </span><span class="koboSpan" id="kobo.454.3">Unlike Django </span><a id="_idIndexMarker1461"/><span class="koboSpan" id="kobo.455.1">views, consumers are built for long-running communication. </span><span class="koboSpan" id="kobo.455.2">URLs are mapped to consumers through routing classes that allow you to combine and stack consumers.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.456.1">Let’s implement a basic consumer that can accept WebSocket connections and echoes every message it receives from the WebSocket back to it. </span><span class="koboSpan" id="kobo.456.2">This initial functionality will allow the student to send messages to the consumer and receive back the messages it sends.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.457.1">Create a new file inside </span><a id="_idIndexMarker1462"/><span class="koboSpan" id="kobo.458.1">the </span><code class="inlineCode"><span class="koboSpan" id="kobo.459.1">chat</span></code><span class="koboSpan" id="kobo.460.1"> application directory and</span><a id="_idIndexMarker1463"/><span class="koboSpan" id="kobo.461.1"> name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.462.1">consumers.py</span></code><span class="koboSpan" id="kobo.463.1">. </span><span class="koboSpan" id="kobo.463.2">Add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.464.1">import</span></span><span class="koboSpan" id="kobo.465.1"> json
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.466.1">from</span></span><span class="koboSpan" id="kobo.467.1"> channels.generic.websocket </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.468.1">import</span></span><span class="koboSpan" id="kobo.469.1"> WebsocketConsumer
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.470.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.471.1">ChatConsumer</span></span><span class="koboSpan" id="kobo.472.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.473.1">WebsocketConsumer</span></span><span class="koboSpan" id="kobo.474.1">):
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.475.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.476.1">connect</span></span><span class="koboSpan" id="kobo.477.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.478.1">self</span></span><span class="koboSpan" id="kobo.479.1">):
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.480.1"># accept connection</span></span><span class="koboSpan" id="kobo.481.1">
        self.accept()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.482.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.483.1">disconnect</span></span><span class="koboSpan" id="kobo.484.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.485.1">self, close_code</span></span><span class="koboSpan" id="kobo.486.1">):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.487.1">pass</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.488.1"># receive message from WebSocket</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.489.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.490.1">receive</span></span><span class="koboSpan" id="kobo.491.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.492.1">self, text_data</span></span><span class="koboSpan" id="kobo.493.1">):
        text_data_json = json.loads(text_data)
        message = text_data_json[</span><span class="hljs-string"><span class="koboSpan" id="kobo.494.1">'message'</span></span><span class="koboSpan" id="kobo.495.1">]
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.496.1"># send message to WebSocket</span></span><span class="koboSpan" id="kobo.497.1">
        self.send(text_data=json.dumps({</span><span class="hljs-string"><span class="koboSpan" id="kobo.498.1">'message'</span></span><span class="koboSpan" id="kobo.499.1">: message}))
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.500.1">This is the </span><code class="inlineCode"><span class="koboSpan" id="kobo.501.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.502.1"> consumer. </span><span class="koboSpan" id="kobo.502.2">This class inherits from the Channels </span><code class="inlineCode"><span class="koboSpan" id="kobo.503.1">WebsocketConsumer</span></code><span class="koboSpan" id="kobo.504.1"> class to implement a basic WebSocket consumer. </span><span class="koboSpan" id="kobo.504.2">In this consumer, you implement the following methods:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.505.1">connnect()</span></code><span class="koboSpan" id="kobo.506.1">: Called when a new connection is received. </span><span class="koboSpan" id="kobo.506.2">You accept any connection with </span><code class="inlineCode"><span class="koboSpan" id="kobo.507.1">self.accept()</span></code><span class="koboSpan" id="kobo.508.1">. </span><span class="koboSpan" id="kobo.508.2">You can also reject a connection by calling </span><code class="inlineCode"><span class="koboSpan" id="kobo.509.1">self.close()</span></code><span class="koboSpan" id="kobo.510.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.511.1">disconnect()</span></code><span class="koboSpan" id="kobo.512.1">: Called when the socket closes. </span><span class="koboSpan" id="kobo.512.2">You use </span><code class="inlineCode"><span class="koboSpan" id="kobo.513.1">pass</span></code><span class="koboSpan" id="kobo.514.1"> because you don’t need to implement any action when a client closes the connection.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.515.1">receive()</span></code><span class="koboSpan" id="kobo.516.1">: Called whenever data is received from the WebSocket. </span><span class="koboSpan" id="kobo.516.2">You expect text to be received as </span><code class="inlineCode"><span class="koboSpan" id="kobo.517.1">text_data</span></code><span class="koboSpan" id="kobo.518.1"> (this could also be </span><code class="inlineCode"><span class="koboSpan" id="kobo.519.1">binary_data</span></code><span class="koboSpan" id="kobo.520.1"> for binary data). </span><span class="koboSpan" id="kobo.520.2">You treat the text data received as JSON. </span><span class="koboSpan" id="kobo.520.3">Therefore, you use </span><code class="inlineCode"><span class="koboSpan" id="kobo.521.1">json.loads()</span></code><span class="koboSpan" id="kobo.522.1"> to load the received JSON data into a Python dictionary. </span><span class="koboSpan" id="kobo.522.2">You access the </span><code class="inlineCode"><span class="koboSpan" id="kobo.523.1">message</span></code><span class="koboSpan" id="kobo.524.1"> key, which you expect to be present in the JSON structure received. </span><span class="koboSpan" id="kobo.524.2">To echo the message, you send the message back to the WebSocket with </span><code class="inlineCode"><span class="koboSpan" id="kobo.525.1">self.send()</span></code><span class="koboSpan" id="kobo.526.1">, transforming it into JSON format again through </span><code class="inlineCode"><span class="koboSpan" id="kobo.527.1">json.dumps()</span></code><span class="koboSpan" id="kobo.528.1">.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.529.1">The </span><a id="_idIndexMarker1464"/><span class="koboSpan" id="kobo.530.1">initial version of your </span><code class="inlineCode"><span class="koboSpan" id="kobo.531.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.532.1"> consumer accepts any WebSocket </span><a id="_idIndexMarker1465"/><span class="koboSpan" id="kobo.533.1">connection and echoes to the WebSocket client every message it receives. </span><span class="koboSpan" id="kobo.533.2">Note that the consumer does not broadcast messages to other clients yet. </span><span class="koboSpan" id="kobo.533.3">You will build this functionality by implementing a channel layer later.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.534.1">First, let’s expose our consumer by adding it to the URLs of the project.</span></p>
<h1 class="heading-1" id="_idParaDest-430"><span class="koboSpan" id="kobo.535.1">Routing</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.536.1">You need to define </span><a id="_idIndexMarker1466"/><span class="koboSpan" id="kobo.537.1">a URL to </span><a id="_idIndexMarker1467"/><span class="koboSpan" id="kobo.538.1">route connections to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.539.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.540.1"> consumer you have implemented. </span><span class="koboSpan" id="kobo.540.2">Channels provides routing classes that allow you to combine and stack consumers to dispatch based on what the connection is. </span><span class="koboSpan" id="kobo.540.3">You can think of them as the URL routing system of Django for asynchronous applications.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.541.1">Create a new file inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.542.1">chat</span></code><span class="koboSpan" id="kobo.543.1"> application directory and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.544.1">routing.py</span></code><span class="koboSpan" id="kobo.545.1">. </span><span class="koboSpan" id="kobo.545.2">Add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.546.1">from</span></span><span class="koboSpan" id="kobo.547.1"> django.urls </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.548.1">import</span></span><span class="koboSpan" id="kobo.549.1"> re_path
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.550.1">from</span></span><span class="koboSpan" id="kobo.551.1"> . </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.552.1">import</span></span><span class="koboSpan" id="kobo.553.1"> consumers
websocket_urlpatterns = [
    re_path(
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.554.1">r'ws/chat/room/(?P&lt;course_id&gt;\d+)/$'</span></span><span class="koboSpan" id="kobo.555.1">,
        consumers.ChatConsumer.as_asgi()
    ),
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.556.1">In this code, you map a URL pattern with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.557.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.558.1"> class that you defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.559.1">chat/consumers.py</span></code><span class="koboSpan" id="kobo.560.1"> file. </span><span class="koboSpan" id="kobo.560.2">There are some details that are worth reviewing:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.561.1">You use Django’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.562.1">re_path()</span></code><span class="koboSpan" id="kobo.563.1"> to define the path with a regular expression instead of </span><code class="inlineCode"><span class="koboSpan" id="kobo.564.1">path()</span></code><span class="koboSpan" id="kobo.565.1">. </span><span class="koboSpan" id="kobo.565.2">Channels’ URL routing may not function correctly with </span><code class="inlineCode"><span class="koboSpan" id="kobo.566.1">path()</span></code><span class="koboSpan" id="kobo.567.1"> routes if inner routers are wrapped by additional middleware, so this approach helps avoid any issues.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.568.1">The URL includes an integer parameter called </span><code class="inlineCode"><span class="koboSpan" id="kobo.569.1">course_id</span></code><span class="koboSpan" id="kobo.570.1">. </span><span class="koboSpan" id="kobo.570.2">This parameter will be available in the scope of the consumer and will allow you to identify the course chat room that the user is connecting to.</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.571.1">You call the </span><code class="inlineCode"><span class="koboSpan" id="kobo.572.1">as_asgi()</span></code><span class="koboSpan" id="kobo.573.1"> method of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.574.1">consumer</span></code><span class="koboSpan" id="kobo.575.1"> class in order to get an ASGI application that will instantiate an instance of the consumer for each user connection. </span><span class="koboSpan" id="kobo.575.2">This behavior is similar to Django’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.576.1">as_view()</span></code><span class="koboSpan" id="kobo.577.1"> method for class-based views.</span></li>
</ul>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.578.1">It is a good practice to prepend WebSocket URLs with </span><code class="inlineCode"><span class="koboSpan" id="kobo.579.1">/ws/</span></code><span class="koboSpan" id="kobo.580.1"> to differentiate them from URLs used for standard synchronous HTTP requests. </span><span class="koboSpan" id="kobo.580.2">This also simplifies the production setup when an HTTP server routes requests based on the path.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.581.1">Edit the global </span><code class="inlineCode"><span class="koboSpan" id="kobo.582.1">asgi.py</span></code><span class="koboSpan" id="kobo.583.1"> file </span><a id="_idIndexMarker1468"/><span class="koboSpan" id="kobo.584.1">located next to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.585.1">settings.py</span></code><span class="koboSpan" id="kobo.586.1"> file</span><a id="_idIndexMarker1469"/><span class="koboSpan" id="kobo.587.1"> so that it looks like this:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.588.1">import</span></span><span class="koboSpan" id="kobo.589.1"> os
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.590.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.591.1"> channels.auth </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.592.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.593.1"> AuthMiddlewareStack</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.594.1">from</span></span><span class="koboSpan" id="kobo.595.1"> channels.routing </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.596.1">import</span></span><span class="koboSpan" id="kobo.597.1"> ProtocolTypeRouter</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.598.1">, URLRouter</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.599.1">from</span></span><span class="koboSpan" id="kobo.600.1"> django.core.asgi </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.601.1">import</span></span><span class="koboSpan" id="kobo.602.1"> get_asgi_application
os.environ.setdefault(</span><span class="hljs-string"><span class="koboSpan" id="kobo.603.1">'DJANGO_SETTINGS_MODULE'</span></span><span class="koboSpan" id="kobo.604.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.605.1">'educa.settings'</span></span><span class="koboSpan" id="kobo.606.1">)
django_asgi_app = get_asgi_application()
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.607.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.608.1"> chat.routing </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.609.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.610.1"> websocket_urlpatterns</span></strong></span><span class="koboSpan" id="kobo.611.1">
application = ProtocolTypeRouter({
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.612.1">'http'</span></span><span class="koboSpan" id="kobo.613.1">: django_asgi_app,
    </span><span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.614.1">'websocket'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.615.1">: AuthMiddlewareStack(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.616.1">        URLRouter(websocket_urlpatterns)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.617.1">    ),</span></strong></span><span class="koboSpan" id="kobo.618.1">
})
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.619.1">In this code, you have added:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.620.1">A new route for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.621.1">websocket</span></code><span class="koboSpan" id="kobo.622.1"> protocol. </span><span class="koboSpan" id="kobo.622.2">You use </span><code class="inlineCode"><span class="koboSpan" id="kobo.623.1">URLRouter</span></code><span class="koboSpan" id="kobo.624.1"> to map </span><code class="inlineCode"><span class="koboSpan" id="kobo.625.1">websocket</span></code><span class="koboSpan" id="kobo.626.1"> connections to the URL patterns defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.627.1">websocket_urlpatterns</span></code><span class="koboSpan" id="kobo.628.1"> list of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.629.1">chat.routing</span></code><span class="koboSpan" id="kobo.630.1"> module.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.631.1">AuthMiddlewareStack</span></code><span class="koboSpan" id="kobo.632.1"> as a wrapper function for the URL router. </span><span class="koboSpan" id="kobo.632.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.633.1">AuthMiddlewareStack</span></code><span class="koboSpan" id="kobo.634.1"> class provided by Channels supports standard Django authentication, where the user details are stored in the session. </span><span class="koboSpan" id="kobo.634.2">Later, you will access the user instance in the scope of the consumer to identify the user who sends a message.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.635.1">Note that </span><a id="_idIndexMarker1470"/><span class="koboSpan" id="kobo.636.1">the </span><code class="inlineCode"><span class="koboSpan" id="kobo.637.1">websocket_urlpatterns</span></code><span class="koboSpan" id="kobo.638.1"> import </span><a id="_idIndexMarker1471"/><span class="koboSpan" id="kobo.639.1">is below the </span><code class="inlineCode"><span class="koboSpan" id="kobo.640.1">get_asgi_application()</span></code><span class="koboSpan" id="kobo.641.1"> function call. </span><span class="koboSpan" id="kobo.641.2">This is needed to ensure the application registry is populated before importing code that may import ORM models.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.642.1">Now that we have a functioning WebSocket consumer that is available through a URL, we can implement the WebSocket client.</span></p>
<h1 class="heading-1" id="_idParaDest-431"><span class="koboSpan" id="kobo.643.1">Implementing the WebSocket client</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.644.1">So far, you have </span><a id="_idIndexMarker1472"/><span class="koboSpan" id="kobo.645.1">created the </span><code class="inlineCode"><span class="koboSpan" id="kobo.646.1">course_chat_room</span></code><span class="koboSpan" id="kobo.647.1"> view and its corresponding template for students to access the</span><a id="_idIndexMarker1473"/><span class="koboSpan" id="kobo.648.1"> course chat room. </span><span class="koboSpan" id="kobo.648.2">You have implemented a WebSocket consumer for the chat server and tied it with URL routing. </span><span class="koboSpan" id="kobo.648.3">Now, you need to build a WebSocket client to establish a connection with the WebSocket in the course chat room template and be able to send/receive messages.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.649.1">You are going to implement the WebSocket client with JavaScript to open and maintain a connection in the browser, and you will</span><a id="_idIndexMarker1474"/><span class="koboSpan" id="kobo.650.1"> interact with the </span><strong class="keyWord"><span class="koboSpan" id="kobo.651.1">Document Object Model</span></strong><span class="koboSpan" id="kobo.652.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.653.1">DOM</span></strong><span class="koboSpan" id="kobo.654.1">) using JavaScript.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.655.1">You will perform the following tasks related to the WebSocket client:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.656.1">Open a WebSocket connection with the server when the page is loaded.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.657.1">Add messages to an HTML container when data is received through the WebSocket.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.658.1">Attach a listener to the submit button to send messages through the WebSocket when the user clicks the </span><strong class="screenText"><span class="koboSpan" id="kobo.659.1">SEND</span></strong><span class="koboSpan" id="kobo.660.1"> button or presses the </span><em class="italic"><span class="koboSpan" id="kobo.661.1">Enter</span></em><span class="koboSpan" id="kobo.662.1"> key.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.663.1">Let’s start by opening the WebSocket connection.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.664.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.665.1">chat/room.html</span></code><span class="koboSpan" id="kobo.666.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.667.1">chat</span></code><span class="koboSpan" id="kobo.668.1"> application and modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.669.1">include_js</span></code><span class="koboSpan" id="kobo.670.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.671.1">domready</span></code><span class="koboSpan" id="kobo.672.1"> blocks, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.673.1">{% block include_js %}
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.674.1">  {{ course.id|json_script:"course-id" }}</span></strong></span><span class="koboSpan" id="kobo.675.1">
{% endblock %}
{% block domready %}
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.676.1">  const courseId = JSON.parse(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.677.1">    document.getElementById('course-id').textContent</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.678.1">  );</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.679.1">  const url = 'ws://' + window.location.host +</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.680.1">              '/ws/chat/room/' + courseId + '/';</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.681.1">  const chatSocket = new WebSocket(url);</span></strong></span><span class="koboSpan" id="kobo.682.1">
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.683.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.684.1">include_js</span></code><span class="koboSpan" id="kobo.685.1"> block, you</span><a id="_idIndexMarker1475"/><span class="koboSpan" id="kobo.686.1"> use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.687.1">json_script</span></code><span class="koboSpan" id="kobo.688.1"> template</span><a id="_idIndexMarker1476"/><span class="koboSpan" id="kobo.689.1"> filter to securely use the value of </span><code class="inlineCode"><span class="koboSpan" id="kobo.690.1">course.id</span></code><span class="koboSpan" id="kobo.691.1"> with JavaScript. </span><span class="koboSpan" id="kobo.691.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.692.1">json_script</span></code><span class="koboSpan" id="kobo.693.1"> template filter provided by Django outputs a Python object as JSON, wrapped in a </span><code class="inlineCode"><span class="koboSpan" id="kobo.694.1">&lt;script&gt;</span></code><span class="koboSpan" id="kobo.695.1"> tag, so that you can safely use it with JavaScript. </span><span class="koboSpan" id="kobo.695.2">The code </span><code class="inlineCode"><span class="koboSpan" id="kobo.696.1">{{ course.id|json_script:"course-id" }}</span></code><span class="koboSpan" id="kobo.697.1"> is rendered as </span><code class="inlineCode"><span class="koboSpan" id="kobo.698.1">&lt;script id="course-id" type="application/json"&gt;6&lt;/script&gt;</span></code><span class="koboSpan" id="kobo.699.1">. </span><span class="koboSpan" id="kobo.699.2">This value is then retrieved in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.700.1">domready</span></code><span class="koboSpan" id="kobo.701.1"> block by parsing the content of the element with </span><code class="inlineCode"><span class="koboSpan" id="kobo.702.1">id="course-id"</span></code><span class="koboSpan" id="kobo.703.1"> using </span><code class="inlineCode"><span class="koboSpan" id="kobo.704.1">JSON.parse()</span></code><span class="koboSpan" id="kobo.705.1">. </span><span class="koboSpan" id="kobo.705.2">This is the safe way to use Python objects in JavaScript.</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.706.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.707.1">json_script</span></code><span class="koboSpan" id="kobo.708.1"> template filter securely encodes Python objects as JSON and safely embeds them in a </span><code class="inlineCode"><span class="koboSpan" id="kobo.709.1">&lt;script&gt;</span></code><span class="koboSpan" id="kobo.710.1"> HTML tag, protecting against </span><strong class="keyWord"><span class="koboSpan" id="kobo.711.1">cross-site scripting</span></strong><span class="koboSpan" id="kobo.712.1"> (</span><strong class="keyWord"><span class="koboSpan" id="kobo.713.1">XSS</span></strong><span class="koboSpan" id="kobo.714.1">) attacks by escaping potentially harmful characters.</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.715.1">You can find more information </span><a id="_idIndexMarker1477"/><span class="koboSpan" id="kobo.716.1">about the </span><code class="inlineCode"><span class="koboSpan" id="kobo.717.1">json_script</span></code><span class="koboSpan" id="kobo.718.1"> template filter at </span><a href="https://docs.djangoproject.com/en/5.0/ref/templates/builtins/#json-script"><span class="url"><span class="koboSpan" id="kobo.719.1">https://docs.djangoproject.com/en/5.0/ref/templates/builtins/#json-script</span></span></a><span class="koboSpan" id="kobo.720.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.721.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.722.1">domready</span></code><span class="koboSpan" id="kobo.723.1"> block, you define an URL with the WebSocket protocol, which looks like </span><code class="inlineCode"><span class="koboSpan" id="kobo.724.1">ws://</span></code><span class="koboSpan" id="kobo.725.1"> (or </span><code class="inlineCode"><span class="koboSpan" id="kobo.726.1">wss://</span></code><span class="koboSpan" id="kobo.727.1"> for secure WebSockets, just like </span><code class="inlineCode"><span class="koboSpan" id="kobo.728.1">https://</span></code><span class="koboSpan" id="kobo.729.1">). </span><span class="koboSpan" id="kobo.729.2">You build the URL using the current location of the browser, which you obtain from </span><code class="inlineCode"><span class="koboSpan" id="kobo.730.1">window.location.host</span></code><span class="koboSpan" id="kobo.731.1">. </span><span class="koboSpan" id="kobo.731.2">The rest of the URL is built with the path for the chat room URL pattern that you defined in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.732.1">routing.py</span></code><span class="koboSpan" id="kobo.733.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.734.1">chat</span></code><span class="koboSpan" id="kobo.735.1"> application.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.736.1">You write the URL instead of building it with a resolver because Channels does not provide a way to reverse URLs. </span><span class="koboSpan" id="kobo.736.2">You use the current course </span><code class="inlineCode"><span class="koboSpan" id="kobo.737.1">ID</span></code><span class="koboSpan" id="kobo.738.1"> to generate the URL for the current course and store the URL in a new constant named </span><code class="inlineCode"><span class="koboSpan" id="kobo.739.1">url</span></code><span class="koboSpan" id="kobo.740.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.741.1">You then open a WebSocket connection to the stored URL using </span><code class="inlineCode"><span class="koboSpan" id="kobo.742.1">new</span></code> <code class="inlineCode"><span class="koboSpan" id="kobo.743.1">WebSocket(url)</span></code><span class="koboSpan" id="kobo.744.1">. </span><span class="koboSpan" id="kobo.744.2">You assign the instantiated WebSocket client object to the new constant </span><code class="inlineCode"><span class="koboSpan" id="kobo.745.1">chatSocket</span></code><span class="koboSpan" id="kobo.746.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.747.1">You have created a</span><a id="_idIndexMarker1478"/><span class="koboSpan" id="kobo.748.1"> WebSocket consumer, you</span><a id="_idIndexMarker1479"/><span class="koboSpan" id="kobo.749.1"> have included routing for it, and you have implemented a basic WebSocket client. </span><span class="koboSpan" id="kobo.749.2">Let’s try the initial version of your chat.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.750.1">Start the development server using the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.751.1">python manage.py runserver
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.752.1">Open the URL </span><code class="inlineCode"><span class="koboSpan" id="kobo.753.1">http://127.0.0.1:8000/chat/room/1/</span></code><span class="koboSpan" id="kobo.754.1"> in your browser, replacing </span><code class="inlineCode"><span class="koboSpan" id="kobo.755.1">1</span></code><span class="koboSpan" id="kobo.756.1"> with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.757.1">id</span></code><span class="koboSpan" id="kobo.758.1"> of an existing course in the database. </span><span class="koboSpan" id="kobo.758.2">Take a look at the console output. </span><span class="koboSpan" id="kobo.758.3">Besides the HTTP </span><code class="inlineCode"><span class="koboSpan" id="kobo.759.1">GET</span></code><span class="koboSpan" id="kobo.760.1"> requests for the page and its static files, you should see two lines, including </span><code class="inlineCode"><span class="koboSpan" id="kobo.761.1">WebSocket HANDSHAKING</span></code><span class="koboSpan" id="kobo.762.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.763.1">WebSocket CONNECT</span></code><span class="koboSpan" id="kobo.764.1">, like the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.765.1">HTTP GET /chat/room/1/ 200 [0.02, 127.0.0.1:57141]
WebSocket HANDSHAKING /ws/chat/room/1/ [127.0.0.1:57144]
WebSocket CONNECT /ws/chat/room/1/ [127.0.0.1:57144]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.766.1">The Daphne server listens for incoming socket connections using a standard TCP socket. </span><span class="koboSpan" id="kobo.766.2">The handshake is the bridge from HTTP to WebSockets. </span><span class="koboSpan" id="kobo.766.3">In the handshake, details of the connection are negotiated and either party can close the connection before completion. </span><span class="koboSpan" id="kobo.766.4">Remember that you are using </span><code class="inlineCode"><span class="koboSpan" id="kobo.767.1">self.accept()</span></code><span class="koboSpan" id="kobo.768.1"> to accept any connection in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.769.1">connect()</span></code><span class="koboSpan" id="kobo.770.1"> method of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.771.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.772.1"> class, implemented in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.773.1">consumers.py</span></code><span class="koboSpan" id="kobo.774.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.775.1">chat</span></code><span class="koboSpan" id="kobo.776.1"> application. </span><span class="koboSpan" id="kobo.776.2">The connection is accepted, and therefore, you see the </span><code class="inlineCode"><span class="koboSpan" id="kobo.777.1">WebSocket CONNECT</span></code><span class="koboSpan" id="kobo.778.1"> message in the console.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.779.1">If you use the browser developer tools to track network connections, you can also see information for the WebSocket connection that has been established.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.780.1">It should look like </span><em class="italic"><span class="koboSpan" id="kobo.781.1">Figure 16.5</span></em><span class="koboSpan" id="kobo.782.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.783.1"><img alt="Graphical user interface, application, table  Description automatically generated" src="../Images/B21088_16_05.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.784.1">Figure 16.5: The browser developer tools showing that the WebSocket connection has been established</span></p>
<p class="normal"><span class="koboSpan" id="kobo.785.1">Now that you </span><a id="_idIndexMarker1480"/><span class="koboSpan" id="kobo.786.1">can connect to the WebSocket, it’s time to interact with it. </span><span class="koboSpan" id="kobo.786.2">You will implement the methods to handle common events, such </span><a id="_idIndexMarker1481"/><span class="koboSpan" id="kobo.787.1">as receiving a message and closing the connection. </span><span class="koboSpan" id="kobo.787.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.788.1">chat/room.html</span></code><span class="koboSpan" id="kobo.789.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.790.1">chat</span></code><span class="koboSpan" id="kobo.791.1"> application and modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.792.1">domready</span></code><span class="koboSpan" id="kobo.793.1"> block, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.794.1">{% block domready %}
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.795.1">const</span></span><span class="koboSpan" id="kobo.796.1"> courseId = </span><span class="hljs-title"><span class="koboSpan" id="kobo.797.1">JSON</span></span><span class="koboSpan" id="kobo.798.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.799.1">parse</span></span><span class="koboSpan" id="kobo.800.1">(
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.801.1">document</span></span><span class="koboSpan" id="kobo.802.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.803.1">getElementById</span></span><span class="koboSpan" id="kobo.804.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.805.1">'course-id'</span></span><span class="koboSpan" id="kobo.806.1">).</span><span class="hljs-property"><span class="koboSpan" id="kobo.807.1">textContent</span></span><span class="koboSpan" id="kobo.808.1">
  );
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.809.1">const</span></span><span class="koboSpan" id="kobo.810.1"> url = </span><span class="hljs-string"><span class="koboSpan" id="kobo.811.1">'ws://'</span></span><span class="koboSpan" id="kobo.812.1"> + </span><span class="hljs-variable"><span class="koboSpan" id="kobo.813.1">window</span></span><span class="koboSpan" id="kobo.814.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.815.1">location</span></span><span class="koboSpan" id="kobo.816.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.817.1">host</span></span><span class="koboSpan" id="kobo.818.1"> +
              </span><span class="hljs-string"><span class="koboSpan" id="kobo.819.1">'/ws/chat/room/'</span></span><span class="koboSpan" id="kobo.820.1"> + courseId + </span><span class="hljs-string"><span class="koboSpan" id="kobo.821.1">'/'</span></span><span class="koboSpan" id="kobo.822.1">;
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.823.1">const</span></span><span class="koboSpan" id="kobo.824.1"> chatSocket = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.825.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.826.1">WebSocket</span></span><span class="koboSpan" id="kobo.827.1">(url);
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.828.1">  chatSocket.</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.829.1">onmessage = </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.830.1">function</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.831.1">(event) {</span></strong></span>
<span class="code-highlight"><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.832.1">    const data = </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.833.1">JSON</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.834.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.835.1">parse</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.836.1">(event.data);</span></strong></span>
<span class="code-highlight"><strong class="hljs-params-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.837.1">const</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.838.1"> chat = </span></strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.839.1">document</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.840.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.841.1">getElementById</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.842.1">(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.843.1">'chat'</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.844.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.845.1">    chat.innerHTML += </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.846.1">'&lt;div class="message"&gt;'</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.847.1"> +</span></strong></span>
<span class="code-highlight"><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.848.1">                      data.message + </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.849.1">'</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.850.1">&lt;/div&gt;'</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.851.1">;</span></strong></span>
<span class="code-highlight"><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.852.1">    chat.scrollTop = chat.scrollHeight;</span></strong></span>
<span class="code-highlight"><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.853.1">  };</span></strong></span>
<span class="code-highlight"><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.854.1">  chatSocket.onclose = </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.855.1">function</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.856.1">(event) {</span></strong></span>
<span class="code-highlight"><strong class="hljs-params-slc"> </strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.857.1">console</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.858.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.859.1">error</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.860.1">(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.861.1">'Chat socket closed unexpectedly'</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.862.1">);</span></strong></span>
<span class="code-highlight"><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.863.1">  };</span></strong></span><span class="koboSpan" id="kobo.864.1">
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.865.1">In this code, you define the following events for the WebSocket client:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.866.1">onmessage</span></code><span class="koboSpan" id="kobo.867.1">: Fired when data is received through the WebSocket. </span><span class="koboSpan" id="kobo.867.2">You parse the message, which you expect in JSON format, and access its </span><code class="inlineCode"><span class="koboSpan" id="kobo.868.1">message</span></code><span class="koboSpan" id="kobo.869.1"> attribute. </span><span class="koboSpan" id="kobo.869.2">You then append a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.870.1">&lt;div&gt;</span></code><span class="koboSpan" id="kobo.871.1"> element with the message received to the HTML element with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.872.1">chat</span></code><span class="koboSpan" id="kobo.873.1"> ID. </span><span class="koboSpan" id="kobo.873.2">This will add new messages to the chat log, while keeping all previous messages that have been added to the log. </span><span class="koboSpan" id="kobo.873.3">You scroll the chat log </span><code class="inlineCode"><span class="koboSpan" id="kobo.874.1">&lt;div&gt;</span></code><span class="koboSpan" id="kobo.875.1"> to the bottom to ensure that the new message gets visibility. </span><span class="koboSpan" id="kobo.875.2">You achieve this by scrolling to the total scrollable height of the chat log, which can be obtained by accessing its </span><code class="inlineCode"><span class="koboSpan" id="kobo.876.1">scrollHeight</span></code><span class="koboSpan" id="kobo.877.1"> attribute.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.878.1">onclose</span></code><span class="koboSpan" id="kobo.879.1">: Fired when the connection with the WebSocket is closed. </span><span class="koboSpan" id="kobo.879.2">You don’t expect to close the connection, and therefore, you write the error </span><code class="inlineCode"><span class="koboSpan" id="kobo.880.1">Chat socket closed unexpectedly</span></code><span class="koboSpan" id="kobo.881.1"> to the console log if this happens.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.882.1">You have implemented the action to display the message when a new message is received. </span><span class="koboSpan" id="kobo.882.2">You need to implement the functionality to send messages to the socket as well.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.883.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.884.1">chat/room.html</span></code><span class="koboSpan" id="kobo.885.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.886.1">chat</span></code><span class="koboSpan" id="kobo.887.1"> application and add the following JavaScript code </span><a id="_idIndexMarker1482"/><span class="koboSpan" id="kobo.888.1">to the bottom of</span><a id="_idIndexMarker1483"/><span class="koboSpan" id="kobo.889.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.890.1">domready</span></code><span class="koboSpan" id="kobo.891.1"> block:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.892.1">const</span></span><span class="koboSpan" id="kobo.893.1"> input = </span><span class="hljs-variable"><span class="koboSpan" id="kobo.894.1">document</span></span><span class="koboSpan" id="kobo.895.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.896.1">getElementById</span></span><span class="koboSpan" id="kobo.897.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.898.1">'chat-message-input'</span></span><span class="koboSpan" id="kobo.899.1">);
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.900.1">const</span></span><span class="koboSpan" id="kobo.901.1"> submitButton = </span><span class="hljs-variable"><span class="koboSpan" id="kobo.902.1">document</span></span><span class="koboSpan" id="kobo.903.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.904.1">getElementById</span></span><span class="koboSpan" id="kobo.905.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.906.1">'chat-message-submit'</span></span><span class="koboSpan" id="kobo.907.1">);
submitButton.</span><span class="hljs-title"><span class="koboSpan" id="kobo.908.1">addEventListener</span></span><span class="koboSpan" id="kobo.909.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.910.1">'click'</span></span><span class="koboSpan" id="kobo.911.1">, </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.912.1">function</span></span><span class="koboSpan" id="kobo.913.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.914.1">event</span></span><span class="koboSpan" id="kobo.915.1">) {
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.916.1">const</span></span><span class="koboSpan" id="kobo.917.1"> message = input.</span><span class="hljs-property"><span class="koboSpan" id="kobo.918.1">value</span></span><span class="koboSpan" id="kobo.919.1">;
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.920.1">if</span></span><span class="koboSpan" id="kobo.921.1">(message) {
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.922.1">// send message in JSON format</span></span><span class="koboSpan" id="kobo.923.1">
    chatSocket.</span><span class="hljs-title"><span class="koboSpan" id="kobo.924.1">send</span></span><span class="koboSpan" id="kobo.925.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.926.1">JSON</span></span><span class="koboSpan" id="kobo.927.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.928.1">stringify</span></span><span class="koboSpan" id="kobo.929.1">({</span><span class="hljs-string"><span class="koboSpan" id="kobo.930.1">'message'</span></span><span class="koboSpan" id="kobo.931.1">: message}));
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.932.1">// clear input</span></span><span class="koboSpan" id="kobo.933.1">
    input.</span><span class="hljs-property"><span class="koboSpan" id="kobo.934.1">value</span></span><span class="koboSpan" id="kobo.935.1"> = </span><span class="hljs-string"><span class="koboSpan" id="kobo.936.1">''</span></span><span class="koboSpan" id="kobo.937.1">;
    input.</span><span class="hljs-title"><span class="koboSpan" id="kobo.938.1">focus</span></span><span class="koboSpan" id="kobo.939.1">();
  }
});
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.940.1">In this code, you define an event listener for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.941.1">click</span></code><span class="koboSpan" id="kobo.942.1"> event of the submit button, which you select by its ID </span><code class="inlineCode"><span class="koboSpan" id="kobo.943.1">chat-message-submit</span></code><span class="koboSpan" id="kobo.944.1">. </span><span class="koboSpan" id="kobo.944.2">When the button is clicked, you perform the following actions:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.945.1">You read the message entered by the user from the value of the text input element with the ID </span><code class="inlineCode"><span class="koboSpan" id="kobo.946.1">chat-message-input</span></code><span class="koboSpan" id="kobo.947.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.948.1">You check whether the message has any content with </span><code class="inlineCode"><span class="koboSpan" id="kobo.949.1">if(message)</span></code><span class="koboSpan" id="kobo.950.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.951.1">If the user has entered a message, you form JSON content such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.952.1">{'message': 'string entered by the user'}</span></code><span class="koboSpan" id="kobo.953.1"> by using </span><code class="inlineCode"><span class="koboSpan" id="kobo.954.1">JSON.stringify()</span></code><span class="koboSpan" id="kobo.955.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.956.1">You send the JSON content through the WebSocket, calling the </span><code class="inlineCode"><span class="koboSpan" id="kobo.957.1">send()</span></code><span class="koboSpan" id="kobo.958.1"> method of </span><code class="inlineCode"><span class="koboSpan" id="kobo.959.1">chatSocket</span></code><span class="koboSpan" id="kobo.960.1"> client.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.961.1">You clear the contents of the text input by setting its value to an empty string with </span><code class="inlineCode"><span class="koboSpan" id="kobo.962.1">input.value = ''</span></code><span class="koboSpan" id="kobo.963.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.964.1">You return the focus to the text input with </span><code class="inlineCode"><span class="koboSpan" id="kobo.965.1">input.focus()</span></code><span class="koboSpan" id="kobo.966.1"> so that the user can write a new message straight away.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.967.1">The user is now able to send messages using the text input and by clicking the submit button.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.968.1">To improve the</span><a id="_idIndexMarker1484"/><span class="koboSpan" id="kobo.969.1"> user experience, you will give focus to the text input when the page loads, allowing users to begin typing immediately without needing to click on it first. </span><span class="koboSpan" id="kobo.969.2">You will also capture keyboard </span><a id="_idIndexMarker1485"/><span class="koboSpan" id="kobo.970.1">keypress events to identify the </span><em class="italic"><span class="koboSpan" id="kobo.971.1">Enter</span></em><span class="koboSpan" id="kobo.972.1"> key and fire the </span><code class="inlineCode"><span class="koboSpan" id="kobo.973.1">click</span></code><span class="koboSpan" id="kobo.974.1"> event on the submit button. </span><span class="koboSpan" id="kobo.974.2">Users will be able to either click the button or press the </span><em class="italic"><span class="koboSpan" id="kobo.975.1">Enter</span></em><span class="koboSpan" id="kobo.976.1"> key to send a message.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.977.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.978.1">chat/room.html</span></code><span class="koboSpan" id="kobo.979.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.980.1">chat</span></code><span class="koboSpan" id="kobo.981.1"> application and add the following JavaScript code to the bottom of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.982.1">domready</span></code><span class="koboSpan" id="kobo.983.1"> block:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.984.1">input.</span><span class="hljs-title"><span class="koboSpan" id="kobo.985.1">addEventListener</span></span><span class="koboSpan" id="kobo.986.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.987.1">'keypress'</span></span><span class="koboSpan" id="kobo.988.1">, </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.989.1">function</span></span><span class="koboSpan" id="kobo.990.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.991.1">event</span></span><span class="koboSpan" id="kobo.992.1">) {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.993.1">if</span></span><span class="koboSpan" id="kobo.994.1"> (event.</span><span class="hljs-property"><span class="koboSpan" id="kobo.995.1">key</span></span><span class="koboSpan" id="kobo.996.1"> === </span><span class="hljs-string"><span class="koboSpan" id="kobo.997.1">'Enter'</span></span><span class="koboSpan" id="kobo.998.1">) {
      </span><span class="hljs-comment"><span class="koboSpan" id="kobo.999.1">// cancel the default action, if needed</span></span><span class="koboSpan" id="kobo.1000.1">
      event.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1001.1">preventDefault</span></span><span class="koboSpan" id="kobo.1002.1">();
      </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1003.1">// trigger click event on button</span></span><span class="koboSpan" id="kobo.1004.1">
      submitButton.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1005.1">click</span></span><span class="koboSpan" id="kobo.1006.1">();
    }
  });
 
input.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1007.1">focus</span></span><span class="koboSpan" id="kobo.1008.1">();
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1009.1">In this code, you also define a function for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1010.1">keypress</span></code><span class="koboSpan" id="kobo.1011.1"> event of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1012.1">input</span></code><span class="koboSpan" id="kobo.1013.1"> element. </span><span class="koboSpan" id="kobo.1013.2">For any key that the user presses, you perform the following actions:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1014.1">You check whether its key is </span><em class="italic"><span class="koboSpan" id="kobo.1015.1">Enter</span></em><span class="koboSpan" id="kobo.1016.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1017.1">If the </span><em class="italic"><span class="koboSpan" id="kobo.1018.1">Enter</span></em><span class="koboSpan" id="kobo.1019.1"> key is pressed:</span><ol class="alphabeticList" style="list-style-type: lower-alpha;">
<li class="alphabeticList" value="1"><span class="koboSpan" id="kobo.1020.1">You prevent the default behavior for this key with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1021.1">event.preventDefault()</span></code><span class="koboSpan" id="kobo.1022.1">.</span></li>
<li class="alphabeticList"><span class="koboSpan" id="kobo.1023.1">Then you fire the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1024.1">click</span></code><span class="koboSpan" id="kobo.1025.1"> event on the submit button to send the message to the WebSocket.</span></li>
</ol>
</li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1026.1">Outside of the</span><a id="_idIndexMarker1486"/><span class="koboSpan" id="kobo.1027.1"> event handler, in the </span><a id="_idIndexMarker1487"/><span class="koboSpan" id="kobo.1028.1">main JavaScript code for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1029.1">domready</span></code><span class="koboSpan" id="kobo.1030.1"> block, you give the focus to the text input with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1031.1">input.focus()</span></code><span class="koboSpan" id="kobo.1032.1">. </span><span class="koboSpan" id="kobo.1032.2">By doing so, when the DOM is loaded, the focus will be set on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1033.1">input</span></code><span class="koboSpan" id="kobo.1034.1"> element for the user to type a message.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1035.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1036.1">domready</span></code><span class="koboSpan" id="kobo.1037.1"> block of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1038.1">chat/room.html</span></code><span class="koboSpan" id="kobo.1039.1"> template should now look as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1040.1">{% block domready %}
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1041.1">const</span></span><span class="koboSpan" id="kobo.1042.1"> courseId = </span><span class="hljs-title"><span class="koboSpan" id="kobo.1043.1">JSON</span></span><span class="koboSpan" id="kobo.1044.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1045.1">parse</span></span><span class="koboSpan" id="kobo.1046.1">(
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1047.1">document</span></span><span class="koboSpan" id="kobo.1048.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1049.1">getElementById</span></span><span class="koboSpan" id="kobo.1050.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1051.1">'course-id'</span></span><span class="koboSpan" id="kobo.1052.1">).</span><span class="hljs-property"><span class="koboSpan" id="kobo.1053.1">textContent</span></span><span class="koboSpan" id="kobo.1054.1">
  );
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1055.1">const</span></span><span class="koboSpan" id="kobo.1056.1"> url = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1057.1">'ws://'</span></span><span class="koboSpan" id="kobo.1058.1"> + </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1059.1">window</span></span><span class="koboSpan" id="kobo.1060.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1061.1">location</span></span><span class="koboSpan" id="kobo.1062.1">.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1063.1">host</span></span><span class="koboSpan" id="kobo.1064.1"> +
              </span><span class="hljs-string"><span class="koboSpan" id="kobo.1065.1">'/ws/chat/room/'</span></span><span class="koboSpan" id="kobo.1066.1"> + courseId + </span><span class="hljs-string"><span class="koboSpan" id="kobo.1067.1">'/'</span></span><span class="koboSpan" id="kobo.1068.1">;
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1069.1">const</span></span><span class="koboSpan" id="kobo.1070.1"> chatSocket = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1071.1">new</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1072.1">WebSocket</span></span><span class="koboSpan" id="kobo.1073.1">(url);
  chatSocket.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1074.1">onmessage</span></span><span class="koboSpan" id="kobo.1075.1"> = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1076.1">function</span></span><span class="koboSpan" id="kobo.1077.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1078.1">event</span></span><span class="koboSpan" id="kobo.1079.1">) {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1080.1">const</span></span><span class="koboSpan" id="kobo.1081.1"> data = </span><span class="hljs-title"><span class="koboSpan" id="kobo.1082.1">JSON</span></span><span class="koboSpan" id="kobo.1083.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1084.1">parse</span></span><span class="koboSpan" id="kobo.1085.1">(event.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1086.1">data</span></span><span class="koboSpan" id="kobo.1087.1">);
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1088.1">const</span></span><span class="koboSpan" id="kobo.1089.1"> chat = </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1090.1">document</span></span><span class="koboSpan" id="kobo.1091.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1092.1">getElementById</span></span><span class="koboSpan" id="kobo.1093.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1094.1">'chat'</span></span><span class="koboSpan" id="kobo.1095.1">);
    chat.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1096.1">innerHTML</span></span><span class="koboSpan" id="kobo.1097.1"> += </span><span class="hljs-string"><span class="koboSpan" id="kobo.1098.1">'&lt;div class="message"&gt;'</span></span><span class="koboSpan" id="kobo.1099.1"> +
                      data.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1100.1">message</span></span><span class="koboSpan" id="kobo.1101.1"> + </span><span class="hljs-string"><span class="koboSpan" id="kobo.1102.1">'&lt;/div&gt;'</span></span><span class="koboSpan" id="kobo.1103.1">;
    chat.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1104.1">scrollTop</span></span><span class="koboSpan" id="kobo.1105.1"> = chat.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1106.1">scrollHeight</span></span><span class="koboSpan" id="kobo.1107.1">;
  };
  chatSocket.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1108.1">onclose</span></span><span class="koboSpan" id="kobo.1109.1"> = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1110.1">function</span></span><span class="koboSpan" id="kobo.1111.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1112.1">event</span></span><span class="koboSpan" id="kobo.1113.1">) {
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1114.1">console</span></span><span class="koboSpan" id="kobo.1115.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1116.1">error</span></span><span class="koboSpan" id="kobo.1117.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1118.1">'Chat socket closed unexpectedly'</span></span><span class="koboSpan" id="kobo.1119.1">);
  };
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1120.1">const</span></span><span class="koboSpan" id="kobo.1121.1"> input = </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1122.1">document</span></span><span class="koboSpan" id="kobo.1123.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1124.1">getElementById</span></span><span class="koboSpan" id="kobo.1125.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1126.1">'chat-message-input'</span></span><span class="koboSpan" id="kobo.1127.1">);
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1128.1">const</span></span><span class="koboSpan" id="kobo.1129.1"> submitButton = </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1130.1">document</span></span><span class="koboSpan" id="kobo.1131.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1132.1">getElementById</span></span><span class="koboSpan" id="kobo.1133.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1134.1">'chat-message-submit'</span></span><span class="koboSpan" id="kobo.1135.1">);
  submitButton.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1136.1">addEventListener</span></span><span class="koboSpan" id="kobo.1137.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1138.1">'click'</span></span><span class="koboSpan" id="kobo.1139.1">, </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1140.1">function</span></span><span class="koboSpan" id="kobo.1141.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1142.1">event</span></span><span class="koboSpan" id="kobo.1143.1">) {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1144.1">const</span></span><span class="koboSpan" id="kobo.1145.1"> message = input.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1146.1">value</span></span><span class="koboSpan" id="kobo.1147.1">;
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1148.1">if</span></span><span class="koboSpan" id="kobo.1149.1">(message) {
      </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1150.1">// send message in JSON format</span></span><span class="koboSpan" id="kobo.1151.1">
      chatSocket.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1152.1">send</span></span><span class="koboSpan" id="kobo.1153.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1154.1">JSON</span></span><span class="koboSpan" id="kobo.1155.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1156.1">stringify</span></span><span class="koboSpan" id="kobo.1157.1">({</span><span class="hljs-string"><span class="koboSpan" id="kobo.1158.1">'message'</span></span><span class="koboSpan" id="kobo.1159.1">: message}));
      </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1160.1">// clear input</span></span><span class="koboSpan" id="kobo.1161.1">
      input.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1162.1">value</span></span><span class="koboSpan" id="kobo.1163.1"> = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1164.1">''</span></span><span class="koboSpan" id="kobo.1165.1">;
      input.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1166.1">focus</span></span><span class="koboSpan" id="kobo.1167.1">();
    }
  });
  input.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1168.1">addEventListener</span></span><span class="koboSpan" id="kobo.1169.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1170.1">'keypress'</span></span><span class="koboSpan" id="kobo.1171.1">, </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1172.1">function</span></span><span class="koboSpan" id="kobo.1173.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1174.1">event</span></span><span class="koboSpan" id="kobo.1175.1">) {
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1176.1">if</span></span><span class="koboSpan" id="kobo.1177.1"> (event.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1178.1">key</span></span><span class="koboSpan" id="kobo.1179.1"> === </span><span class="hljs-string"><span class="koboSpan" id="kobo.1180.1">'Enter'</span></span><span class="koboSpan" id="kobo.1181.1">) {
      </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1182.1">// cancel the default action, if needed</span></span><span class="koboSpan" id="kobo.1183.1">
      event.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1184.1">preventDefault</span></span><span class="koboSpan" id="kobo.1185.1">();
      </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1186.1">// trigger click event on button</span></span><span class="koboSpan" id="kobo.1187.1">
      submitButton.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1188.1">click</span></span><span class="koboSpan" id="kobo.1189.1">();
    }
  });
 
  input.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1190.1">focus</span></span><span class="koboSpan" id="kobo.1191.1">();
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1192.1">Open the URL </span><code class="inlineCode"><span class="koboSpan" id="kobo.1193.1">http://127.0.0.1:8000/chat/room/1/</span></code><span class="koboSpan" id="kobo.1194.1"> in your browser, replacing </span><code class="inlineCode"><span class="koboSpan" id="kobo.1195.1">1</span></code><span class="koboSpan" id="kobo.1196.1"> with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1197.1">id</span></code><span class="koboSpan" id="kobo.1198.1"> of an existing course in the database. </span><span class="koboSpan" id="kobo.1198.2">With a logged-in user who is enrolled in the course, write some text in the input field and click the </span><strong class="screenText"><span class="koboSpan" id="kobo.1199.1">SEND</span></strong><span class="koboSpan" id="kobo.1200.1"> button or press the </span><em class="italic"><span class="koboSpan" id="kobo.1201.1">Enter</span></em><span class="koboSpan" id="kobo.1202.1"> key.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1203.1">You will see that </span><a id="_idIndexMarker1488"/><span class="koboSpan" id="kobo.1204.1">your message appears</span><a id="_idIndexMarker1489"/><span class="koboSpan" id="kobo.1205.1"> in the chat log:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1206.1"><img alt="" role="presentation" src="../Images/B21088_16_06.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1207.1">Figure 16.6: The chat room page, including messages sent through the WebSocket</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1208.1">Great! </span><span class="koboSpan" id="kobo.1208.2">The message has been sent through the WebSocket and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1209.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.1210.1"> consumer has received the message and has sent it back through the WebSocket. </span><span class="koboSpan" id="kobo.1210.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1211.1">chatSocket</span></code><span class="koboSpan" id="kobo.1212.1"> client has received a message event and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1213.1">onmessage</span></code><span class="koboSpan" id="kobo.1214.1"> function has been fired, adding the message to the chat log.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1215.1">You have </span><a id="_idIndexMarker1490"/><span class="koboSpan" id="kobo.1216.1">implemented the</span><a id="_idIndexMarker1491"/><span class="koboSpan" id="kobo.1217.1"> functionality with a WebSocket consumer and a WebSocket client to establish client/server communication and can send or receive events. </span><span class="koboSpan" id="kobo.1217.2">However, the chat server is not able to broadcast messages to other clients. </span><span class="koboSpan" id="kobo.1217.3">If you open a second browser tab and enter a message, the message will not appear on the first tab. </span><span class="koboSpan" id="kobo.1217.4">In order to build communication between consumers, you have to enable a channel layer.</span></p>
<h1 class="heading-1" id="_idParaDest-432"><span class="koboSpan" id="kobo.1218.1">Enabling a channel layer</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1219.1">Channel layers</span><a id="_idIndexMarker1492"/><span class="koboSpan" id="kobo.1220.1"> allow you to communicate between different instances of an </span><a id="_idIndexMarker1493"/><span class="koboSpan" id="kobo.1221.1">application. </span><span class="koboSpan" id="kobo.1221.2">A channel layer is the transport mechanism that allows multiple consumer instances to communicate with each other and with other parts of Django.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1222.1">In your chat server, you plan to have multiple instances of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1223.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.1224.1"> consumer for the same course chat room. </span><span class="koboSpan" id="kobo.1224.2">Each student who joins the chat room will instantiate the WebSocket client in their browser, and that will open a connection with an instance of the WebSocket consumer. </span><span class="koboSpan" id="kobo.1224.3">You need a common channel layer to distribute messages between consumers.</span></p>
<h2 class="heading-2" id="_idParaDest-433"><span class="koboSpan" id="kobo.1225.1">Channels and groups</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1226.1">Channel layers provide two abstractions to manage communications: channels and groups:</span></p>
<ul>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.1227.1">Channel</span></strong><span class="koboSpan" id="kobo.1228.1">: You </span><a id="_idIndexMarker1494"/><span class="koboSpan" id="kobo.1229.1">can think of a channel as an inbox where messages can be sent or as a task queue. </span><span class="koboSpan" id="kobo.1229.2">Each channel has a name. </span><span class="koboSpan" id="kobo.1229.3">Messages are sent to a channel by anyone who knows the channel name and then given to consumers listening on that channel.</span></li>
<li class="bulletList"><strong class="keyWord"><span class="koboSpan" id="kobo.1230.1">Group</span></strong><span class="koboSpan" id="kobo.1231.1">: Multiple </span><a id="_idIndexMarker1495"/><span class="koboSpan" id="kobo.1232.1">channels can be grouped into a group. </span><span class="koboSpan" id="kobo.1232.2">Each group has a name. </span><span class="koboSpan" id="kobo.1232.3">A channel can be added or removed from a group by anyone who knows the group name. </span><span class="koboSpan" id="kobo.1232.4">Using the group name, you can also send a message to all channels in the group.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1233.1">You will work with channel groups to implement the chat server. </span><span class="koboSpan" id="kobo.1233.2">By creating a channel group for each course chat room, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1234.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.1235.1"> instances will be able to communicate with each other.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1236.1">Let’s add a channel layer to our project.</span></p>
<h2 class="heading-2" id="_idParaDest-434"><span class="koboSpan" id="kobo.1237.1">Setting up a channel layer with Redis</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1238.1">Redis</span><a id="_idIndexMarker1496"/><span class="koboSpan" id="kobo.1239.1"> is the preferred option for a channel layer, though Channels has support for other types of channel layers. </span><span class="koboSpan" id="kobo.1239.2">Redis works as the communication store for the channel layer. </span><span class="koboSpan" id="kobo.1239.3">Remember that you already used Redis in </span><em class="italic"><span class="koboSpan" id="kobo.1240.1">Chapter 7</span></em><span class="koboSpan" id="kobo.1241.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1242.1">Tracking User Actions</span></em><span class="koboSpan" id="kobo.1243.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1244.1">Chapter 10</span></em><span class="koboSpan" id="kobo.1245.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1246.1">Extending Your Shop</span></em><span class="koboSpan" id="kobo.1247.1">, and </span><em class="italic"><span class="koboSpan" id="kobo.1248.1">Chapter 14</span></em><span class="koboSpan" id="kobo.1249.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1250.1">Rendering and Caching Content</span></em><span class="koboSpan" id="kobo.1251.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1252.1">If you haven’t </span><a id="_idIndexMarker1497"/><span class="koboSpan" id="kobo.1253.1">installed</span><a id="_idIndexMarker1498"/><span class="koboSpan" id="kobo.1254.1"> Redis yet, you can find installation instructions in </span><em class="italic"><span class="koboSpan" id="kobo.1255.1">Chapter 7</span></em><span class="koboSpan" id="kobo.1256.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1257.1">Tracking User Actions</span></em><span class="koboSpan" id="kobo.1258.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1259.1">To use Redis as a channel layer, you have to install the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1260.1">channels-redis</span></code><span class="koboSpan" id="kobo.1261.1"> package. </span><span class="koboSpan" id="kobo.1261.2">Install </span><code class="inlineCode"><span class="koboSpan" id="kobo.1262.1">channels-redis</span></code><span class="koboSpan" id="kobo.1263.1"> in your virtual environment with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1264.1">python -m pip install channels-redis==4.2.0
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1265.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1266.1">settings.py</span></code><span class="koboSpan" id="kobo.1267.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1268.1">educa</span></code><span class="koboSpan" id="kobo.1269.1"> project and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1270.1">CHANNEL_LAYERS = {
    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1271.1">'default'</span></span><span class="koboSpan" id="kobo.1272.1">: {
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1273.1">'BACKEND'</span></span><span class="koboSpan" id="kobo.1274.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1275.1">'channels_redis.core.RedisChannelLayer'</span></span><span class="koboSpan" id="kobo.1276.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1277.1">'CONFIG'</span></span><span class="koboSpan" id="kobo.1278.1">: {
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.1279.1">'hosts'</span></span><span class="koboSpan" id="kobo.1280.1">: [(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1281.1">'127.0.0.1'</span></span><span class="koboSpan" id="kobo.1282.1">, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1283.1">6379</span></span><span class="koboSpan" id="kobo.1284.1">)],
        },
    },
}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1285.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1286.1">CHANNEL_LAYERS</span></code><span class="koboSpan" id="kobo.1287.1"> setting defines the configuration for the channel layers available to the project. </span><span class="koboSpan" id="kobo.1287.2">You define a default channel layer using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1288.1">RedisChannelLayer</span></code><span class="koboSpan" id="kobo.1289.1"> backend provided by </span><code class="inlineCode"><span class="koboSpan" id="kobo.1290.1">channels-redis</span></code><span class="koboSpan" id="kobo.1291.1"> and specify the host </span><code class="inlineCode"><span class="koboSpan" id="kobo.1292.1">127.0.0.1</span></code><span class="koboSpan" id="kobo.1293.1"> and the port </span><code class="inlineCode"><span class="koboSpan" id="kobo.1294.1">6379</span></code><span class="koboSpan" id="kobo.1295.1">, on which Redis is running.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1296.1">Let’s try the channel layer. </span><span class="koboSpan" id="kobo.1296.2">Initialize the Redis Docker container using the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1297.1">docker run -it --rm --name redis -p 6379:6379 redis:7.2.4
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1298.1">If you want to run the command in the background (in detached mode) you can use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1299.1">-d</span></code><span class="koboSpan" id="kobo.1300.1"> option.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1301.1">Open the Django shell using the following command from the project directory:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1302.1">python manage.py shell
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1303.1">To verify that the </span><a id="_idIndexMarker1499"/><span class="koboSpan" id="kobo.1304.1">channel layer can communicate with Redis, write the following</span><a id="_idIndexMarker1500"/><span class="koboSpan" id="kobo.1305.1"> code to send a message to a test channel named </span><code class="inlineCode"><span class="koboSpan" id="kobo.1306.1">test_channel</span></code><span class="koboSpan" id="kobo.1307.1"> and receive it back:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1308.1">&gt;&gt;&gt;</span></span> <span class="hljs-con-keyword"><span class="koboSpan" id="kobo.1309.1">import</span></span><span class="koboSpan" id="kobo.1310.1"> channels.layers
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1311.1">&gt;&gt;&gt;</span></span> <span class="hljs-con-keyword"><span class="koboSpan" id="kobo.1312.1">from</span></span><span class="koboSpan" id="kobo.1313.1"> asgiref.sync </span><span class="hljs-con-keyword"><span class="koboSpan" id="kobo.1314.1">import</span></span><span class="koboSpan" id="kobo.1315.1"> async_to_sync
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1316.1">&gt;&gt;&gt;</span></span><span class="koboSpan" id="kobo.1317.1"> channel_layer = channels.layers.get_channel_layer()
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1318.1">&gt;&gt;&gt;</span></span><span class="koboSpan" id="kobo.1319.1"> async_to_sync(channel_layer.send)(</span><span class="hljs-con-string"><span class="koboSpan" id="kobo.1320.1">'test_channel'</span></span><span class="koboSpan" id="kobo.1321.1">, {</span><span class="hljs-con-string"><span class="koboSpan" id="kobo.1322.1">'message'</span></span><span class="koboSpan" id="kobo.1323.1">: </span><span class="hljs-con-string"><span class="koboSpan" id="kobo.1324.1">'hello'</span></span><span class="koboSpan" id="kobo.1325.1">})
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.1326.1">&gt;&gt;&gt;</span></span><span class="koboSpan" id="kobo.1327.1"> async_to_sync(channel_layer.receive)(</span><span class="hljs-con-string"><span class="koboSpan" id="kobo.1328.1">'test_channel'</span></span><span class="koboSpan" id="kobo.1329.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1330.1">You should get the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1331.1">{'message': 'hello'}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1332.1">In the previous code, you send a message to a test channel through the channel layer, and then you retrieve it from the channel layer. </span><span class="koboSpan" id="kobo.1332.2">The channel layer is communicating successfully with Redis.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1333.1">Next, we will add the channel layer to our project.</span></p>
<h2 class="heading-2" id="_idParaDest-435"><span class="koboSpan" id="kobo.1334.1">Updating the consumer to broadcast messages</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1335.1">Let’s edit</span><a id="_idIndexMarker1501"/><span class="koboSpan" id="kobo.1336.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1337.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.1338.1"> consumer to use the channel layer we have implemented with Redis. </span><span class="koboSpan" id="kobo.1338.2">You will use a channel group for each course chat room. </span><span class="koboSpan" id="kobo.1338.3">Therefore, you will use the course </span><code class="inlineCode"><span class="koboSpan" id="kobo.1339.1">id</span></code><span class="koboSpan" id="kobo.1340.1"> to build the group name. </span><code class="inlineCode"><span class="koboSpan" id="kobo.1341.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.1342.1"> instances will know the group name and will be able to communicate with each other.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1343.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1344.1">consumers.py</span></code><span class="koboSpan" id="kobo.1345.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1346.1">chat</span></code><span class="koboSpan" id="kobo.1347.1"> application, import the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1348.1">async_to_sync()</span></code><span class="koboSpan" id="kobo.1349.1"> function, and modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1350.1">connect()</span></code><span class="koboSpan" id="kobo.1351.1"> method of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1352.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.1353.1"> class, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1354.1">import</span></span><span class="koboSpan" id="kobo.1355.1"> json
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1356.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1357.1"> asgiref.sync </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1358.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1359.1"> async_to_sync</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1360.1">from</span></span><span class="koboSpan" id="kobo.1361.1"> channels.generic.websocket </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1362.1">import</span></span><span class="koboSpan" id="kobo.1363.1"> WebsocketConsumer
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1364.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1365.1">ChatConsumer</span></span><span class="koboSpan" id="kobo.1366.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1367.1">WebsocketConsumer</span></span><span class="koboSpan" id="kobo.1368.1">):
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1369.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1370.1">connect</span></span><span class="koboSpan" id="kobo.1371.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1372.1">self</span></span><span class="koboSpan" id="kobo.1373.1">):
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1374.1">        self.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1375.1">id</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1376.1"> = self.scope[</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1377.1">'url_route'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1378.1">][</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1379.1">'kwargs'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1380.1">][</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1381.1">'course_id'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1382.1">]</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1383.1">        self.room_group_name = </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1384.1">f'chat_</span></strong><strong class="hljs-subst-slc"><span class="koboSpan" id="kobo.1385.1">{self.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1386.1">id</span></strong><strong class="hljs-subst-slc"><span class="koboSpan" id="kobo.1387.1">}</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1388.1">'</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1389.1"># join room group</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1390.1">        async_to_sync(self.channel_layer.group_add)(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1391.1">            self.room_group_name, self.channel_name</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1392.1">        )</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1393.1"># accept connection</span></span><span class="koboSpan" id="kobo.1394.1">
        self.accept()
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1395.1"># ...</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1396.1">In this code, you import the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1397.1">async_to_sync()</span></code><span class="koboSpan" id="kobo.1398.1"> helper function to wrap calls to asynchronous channel</span><a id="_idIndexMarker1502"/><span class="koboSpan" id="kobo.1399.1"> layer methods. </span><code class="inlineCode"><span class="koboSpan" id="kobo.1400.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.1401.1"> is a synchronous </span><code class="inlineCode"><span class="koboSpan" id="kobo.1402.1">WebsocketConsumer</span></code><span class="koboSpan" id="kobo.1403.1"> consumer, but it needs to call asynchronous methods of the channel layer.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1404.1">In the new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1405.1">connect()</span></code><span class="koboSpan" id="kobo.1406.1"> method, you perform the following tasks:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1407.1">You retrieve the course </span><code class="inlineCode"><span class="koboSpan" id="kobo.1408.1">id</span></code><span class="koboSpan" id="kobo.1409.1"> from the scope to know the course that the chat room is associated with. </span><span class="koboSpan" id="kobo.1409.2">You access </span><code class="inlineCode"><span class="koboSpan" id="kobo.1410.1">self.scope['url_route']['kwargs']['course_id']</span></code><span class="koboSpan" id="kobo.1411.1"> to retrieve the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1412.1">course_id</span></code><span class="koboSpan" id="kobo.1413.1"> parameter from the URL. </span><span class="koboSpan" id="kobo.1413.2">Every consumer has a scope with information about its connection, arguments passed by the URL, and the authenticated user, if any.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1414.1">You build the group name with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1415.1">id</span></code><span class="koboSpan" id="kobo.1416.1"> of the course that the group corresponds to. </span><span class="koboSpan" id="kobo.1416.2">Remember that you will have a channel group for each course chat room. </span><span class="koboSpan" id="kobo.1416.3">You store the group name in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1417.1">room_group_name</span></code><span class="koboSpan" id="kobo.1418.1"> attribute of the consumer.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1419.1">You join the group by adding the current channel to the group. </span><span class="koboSpan" id="kobo.1419.2">You obtain the channel name from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1420.1">channel_name</span></code><span class="koboSpan" id="kobo.1421.1"> attribute of the consumer. </span><span class="koboSpan" id="kobo.1421.2">You use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1422.1">group_add</span></code><span class="koboSpan" id="kobo.1423.1"> method of the channel layer to add the channel to the group. </span><span class="koboSpan" id="kobo.1423.2">You use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1424.1">async_to_sync()</span></code><span class="koboSpan" id="kobo.1425.1"> wrapper to use the channel layer asynchronous method.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1426.1">You keep the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1427.1">self.accept()</span></code><span class="koboSpan" id="kobo.1428.1"> call to accept the WebSocket connection.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1429.1">When the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1430.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.1431.1"> consumer receives a new WebSocket connection, it adds the channel to the group associated with the course in its scope. </span><span class="koboSpan" id="kobo.1431.2">The consumer is now able to receive any messages sent to the group.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1432.1">In the same </span><code class="inlineCode"><span class="koboSpan" id="kobo.1433.1">consumers.py</span></code><span class="koboSpan" id="kobo.1434.1"> file, modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1435.1">disconnect()</span></code><span class="koboSpan" id="kobo.1436.1"> method of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1437.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.1438.1"> class, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1439.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1440.1">ChatConsumer</span></span><span class="koboSpan" id="kobo.1441.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1442.1">WebsocketConsumer</span></span><span class="koboSpan" id="kobo.1443.1">):
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1444.1"># ...</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1445.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1446.1">disconnect</span></span><span class="koboSpan" id="kobo.1447.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1448.1">self, close_code</span></span><span class="koboSpan" id="kobo.1449.1">):
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1450.1"># leave room group</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1451.1">        async_to_sync(self.channel_layer.group_discard)(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1452.1">            self.room_group_name, self.channel_name</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1453.1">        )</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1454.1"># ...</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1455.1">When the connection is</span><a id="_idIndexMarker1503"/><span class="koboSpan" id="kobo.1456.1"> closed, you call the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1457.1">group_discard()</span></code><span class="koboSpan" id="kobo.1458.1"> method of the channel layer to leave the group. </span><span class="koboSpan" id="kobo.1458.2">You use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1459.1">async_to_sync()</span></code><span class="koboSpan" id="kobo.1460.1"> wrapper to use the channel layer asynchronous method.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1461.1">In the same </span><code class="inlineCode"><span class="koboSpan" id="kobo.1462.1">consumers.py</span></code><span class="koboSpan" id="kobo.1463.1"> file, modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1464.1">receive()</span></code><span class="koboSpan" id="kobo.1465.1"> method of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1466.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.1467.1"> class, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1468.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1469.1">ChatConsumer</span></span><span class="koboSpan" id="kobo.1470.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1471.1">WebsocketConsumer</span></span><span class="koboSpan" id="kobo.1472.1">):
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1473.1"># ...</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1474.1"># receive message from WebSocket</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1475.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1476.1">receive</span></span><span class="koboSpan" id="kobo.1477.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1478.1">self, text_data</span></span><span class="koboSpan" id="kobo.1479.1">):
        text_data_json = json.loads(text_data)
        message = text_data_json[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1480.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1481.1">message'</span></span><span class="koboSpan" id="kobo.1482.1">]
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1483.1"># send message to room group</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1484.1">        async_to_sync(self.channel_layer.group_send)(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1485.1">            self.room_group_name,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1486.1">            {</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1487.1">'type'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1488.1">: </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1489.1">'chat_message'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1490.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1491.1">'message'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1492.1">: message,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1493.1">            }</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1494.1">        )</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1495.1">When you receive a message from the WebSocket connection, instead of sending the message to the associated channel, you send the message to the group. </span><span class="koboSpan" id="kobo.1495.2">You do this by calling the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1496.1">group_send()</span></code><span class="koboSpan" id="kobo.1497.1"> method of the channel layer. </span><span class="koboSpan" id="kobo.1497.2">You use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1498.1">async_to_sync()</span></code><span class="koboSpan" id="kobo.1499.1"> wrapper to use the channel layer asynchronous method. </span><span class="koboSpan" id="kobo.1499.2">You pass the following information in the event sent to the group:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1500.1">type</span></code><span class="koboSpan" id="kobo.1501.1">: The event type. </span><span class="koboSpan" id="kobo.1501.2">This is a special key that corresponds to the name of the method that should be invoked on consumers that receive the event. </span><span class="koboSpan" id="kobo.1501.3">You can implement a method in the consumer named the same as the message type so that it gets executed every time a message with that specific type is received.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1502.1">message</span></code><span class="koboSpan" id="kobo.1503.1">: The actual message you are sending.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1504.1">In the same </span><code class="inlineCode"><span class="koboSpan" id="kobo.1505.1">consumers.py</span></code><span class="koboSpan" id="kobo.1506.1"> file, add </span><a id="_idIndexMarker1504"/><span class="koboSpan" id="kobo.1507.1">a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1508.1">chat_message()</span></code><span class="koboSpan" id="kobo.1509.1"> method in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1510.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.1511.1"> class, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1512.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1513.1">ChatConsumer</span></span><span class="koboSpan" id="kobo.1514.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1515.1">WebsocketConsumer</span></span><span class="koboSpan" id="kobo.1516.1">):
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1517.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1518.1"># receive message from room group</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1519.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1520.1">chat_message</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1521.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1522.1">self, event</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1523.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1524.1"># send message to WebSocket</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1525.1">        self.send(text_data=json.dumps(event))</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1526.1">You name this method </span><code class="inlineCode"><span class="koboSpan" id="kobo.1527.1">chat_message()</span></code><span class="koboSpan" id="kobo.1528.1"> to match the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1529.1">type</span></code><span class="koboSpan" id="kobo.1530.1"> key that is sent to the channel group when a message is received from the WebSocket. </span><span class="koboSpan" id="kobo.1530.2">When a message with type </span><code class="inlineCode"><span class="koboSpan" id="kobo.1531.1">chat_message</span></code><span class="koboSpan" id="kobo.1532.1"> is sent to the group, all consumers subscribed to the group will receive the message and will execute the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1533.1">chat_message()</span></code><span class="koboSpan" id="kobo.1534.1"> method. </span><span class="koboSpan" id="kobo.1534.2">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1535.1">chat_message()</span></code><span class="koboSpan" id="kobo.1536.1"> method, you send the event message received to the WebSocket.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1537.1">The complete </span><code class="inlineCode"><span class="koboSpan" id="kobo.1538.1">consumers.py</span></code><span class="koboSpan" id="kobo.1539.1"> file should now look like this:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1540.1">import</span></span><span class="koboSpan" id="kobo.1541.1"> json
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1542.1">from</span></span><span class="koboSpan" id="kobo.1543.1"> asgiref.sync </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1544.1">import</span></span><span class="koboSpan" id="kobo.1545.1"> async_to_sync
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1546.1">from</span></span><span class="koboSpan" id="kobo.1547.1"> channels.generic.websocket </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1548.1">import</span></span><span class="koboSpan" id="kobo.1549.1"> WebsocketConsumer
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1550.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1551.1">ChatConsumer</span></span><span class="koboSpan" id="kobo.1552.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1553.1">WebsocketConsumer</span></span><span class="koboSpan" id="kobo.1554.1">):
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1555.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1556.1">connect</span></span><span class="koboSpan" id="kobo.1557.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1558.1">self</span></span><span class="koboSpan" id="kobo.1559.1">):
        self.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1560.1">id</span></span><span class="koboSpan" id="kobo.1561.1"> = self.scope[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1562.1">'url_route'</span></span><span class="koboSpan" id="kobo.1563.1">][</span><span class="hljs-string"><span class="koboSpan" id="kobo.1564.1">'kwargs'</span></span><span class="koboSpan" id="kobo.1565.1">][</span><span class="hljs-string"><span class="koboSpan" id="kobo.1566.1">'course_id'</span></span><span class="koboSpan" id="kobo.1567.1">]
        self.room_group_name = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1568.1">f'chat_</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1569.1">{self.</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1570.1">id</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1571.1">}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1572.1">'</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1573.1"># join room group</span></span><span class="koboSpan" id="kobo.1574.1">
        async_to_sync(self.channel_layer.group_add)(
            self.room_group_name, self.channel_name
        )
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1575.1"># accept connection</span></span><span class="koboSpan" id="kobo.1576.1">
        self.accept()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1577.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1578.1">disconnect</span></span><span class="koboSpan" id="kobo.1579.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1580.1">self, close_code</span></span><span class="koboSpan" id="kobo.1581.1">):
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1582.1"># leave room group</span></span><span class="koboSpan" id="kobo.1583.1">
        async_to_sync(self.channel_layer.group_discard)(
            self.room_group_name, self.channel_name
        )
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1584.1"># receive message from WebSocket</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1585.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1586.1">receive</span></span><span class="koboSpan" id="kobo.1587.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1588.1">self, text_data</span></span><span class="koboSpan" id="kobo.1589.1">):
        text_data_json = json.loads(text_data)
        message = text_data_json[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1590.1">'message'</span></span><span class="koboSpan" id="kobo.1591.1">]
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1592.1"># send message to room group</span></span><span class="koboSpan" id="kobo.1593.1">
        async_to_sync(self.channel_layer.group_send)(
            self.room_group_name,
            {
                </span><span class="hljs-string"><span class="koboSpan" id="kobo.1594.1">'type'</span></span><span class="koboSpan" id="kobo.1595.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1596.1">'chat_message'</span></span><span class="koboSpan" id="kobo.1597.1">,
                </span><span class="hljs-string"><span class="koboSpan" id="kobo.1598.1">'message'</span></span><span class="koboSpan" id="kobo.1599.1">: message,
            }
        )
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1600.1"># receive message from room group</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1601.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1602.1">chat_message</span></span><span class="koboSpan" id="kobo.1603.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1604.1">self, event</span></span><span class="koboSpan" id="kobo.1605.1">):
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1606.1"># send message to WebSocket</span></span><span class="koboSpan" id="kobo.1607.1">
        self.send(text_data=json.dumps(event))
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1608.1">You have implemented a </span><a id="_idIndexMarker1505"/><span class="koboSpan" id="kobo.1609.1">channel layer in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1610.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.1611.1">, allowing consumers to broadcast messages and communicate with each other.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1612.1">Run the development server with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1613.1">python manage.py runserver
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1614.1">Open the URL </span><code class="inlineCode"><span class="koboSpan" id="kobo.1615.1">http://127.0.0.1:8000/chat/room/1/</span></code><span class="koboSpan" id="kobo.1616.1"> in your browser, replacing </span><code class="inlineCode"><span class="koboSpan" id="kobo.1617.1">1</span></code><span class="koboSpan" id="kobo.1618.1"> with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1619.1">id</span></code><span class="koboSpan" id="kobo.1620.1"> of an existing course in the database. </span><span class="koboSpan" id="kobo.1620.2">Write a message and send it. </span><span class="koboSpan" id="kobo.1620.3">Then, open a second browser window and access the same URL. </span><span class="koboSpan" id="kobo.1620.4">Send a message from each browser window.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1621.1">The result should look like this:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1622.1"><img alt="" role="presentation" src="../Images/B21088_16_07.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1623.1">Figure 16.7: The chat room page with messages sent from different browser windows</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1624.1">You will see that the </span><a id="_idIndexMarker1506"/><span class="koboSpan" id="kobo.1625.1">first message is only displayed in the first browser window. </span><span class="koboSpan" id="kobo.1625.2">When you open a second browser window, messages sent in any of the browser windows are displayed in both of them. </span><span class="koboSpan" id="kobo.1625.3">When you open a new browser window and access the chat room URL, a new WebSocket connection is established between the JavaScript WebSocket client in the browser and the WebSocket consumer in the server. </span><span class="koboSpan" id="kobo.1625.4">Each channel gets added to the group associated with the course ID and passed through the URL to the consumer. </span><span class="koboSpan" id="kobo.1625.5">Messages are sent to the group and received by all consumers.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1626.1">Next, we are going to enrich messages with additional context.</span></p>
<h2 class="heading-2" id="_idParaDest-436"><span class="koboSpan" id="kobo.1627.1">Adding context to the messages</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1628.1">Now that messages can</span><a id="_idIndexMarker1507"/><span class="koboSpan" id="kobo.1629.1"> be exchanged between all users in a chat room, you probably want to display who sent which message and when it was sent. </span><span class="koboSpan" id="kobo.1629.2">Let’s add some context to the messages.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1630.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1631.1">consumers.py</span></code><span class="koboSpan" id="kobo.1632.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1633.1">chat</span></code><span class="koboSpan" id="kobo.1634.1"> application and implement the following changes:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1635.1">import</span></span><span class="koboSpan" id="kobo.1636.1"> json
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1637.1">from</span></span><span class="koboSpan" id="kobo.1638.1"> asgiref.sync </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1639.1">import</span></span><span class="koboSpan" id="kobo.1640.1"> async_to_sync
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1641.1">from</span></span><span class="koboSpan" id="kobo.1642.1"> channels.generic.websocket </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1643.1">import</span></span><span class="koboSpan" id="kobo.1644.1"> WebsocketConsumer
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1645.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1646.1"> django.utils </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1647.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1648.1"> timezone</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1649.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1650.1">ChatConsumer</span></span><span class="koboSpan" id="kobo.1651.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1652.1">WebsocketConsumer</span></span><span class="koboSpan" id="kobo.1653.1">):
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1654.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1655.1">connect</span></span><span class="koboSpan" id="kobo.1656.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1657.1">self</span></span><span class="koboSpan" id="kobo.1658.1">):
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1659.1">        self.user = self.scope[</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1660.1">'user'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1661.1">]</span></strong></span><span class="koboSpan" id="kobo.1662.1">
        self.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1663.1">id</span></span><span class="koboSpan" id="kobo.1664.1"> = self.scope[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1665.1">'url_route'</span></span><span class="koboSpan" id="kobo.1666.1">][</span><span class="hljs-string"><span class="koboSpan" id="kobo.1667.1">'kwargs'</span></span><span class="koboSpan" id="kobo.1668.1">][</span><span class="hljs-string"><span class="koboSpan" id="kobo.1669.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1670.1">course_id'</span></span><span class="koboSpan" id="kobo.1671.1">]
        self.room_group_name = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1672.1">f'chat_</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1673.1">{self.</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1674.1">id</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1675.1">}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1676.1">'</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1677.1"># join room group</span></span><span class="koboSpan" id="kobo.1678.1">
        async_to_sync(self.channel_layer.group_add)(
            self.room_group_name, self.channel_name
        )
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1679.1"># accept connection</span></span><span class="koboSpan" id="kobo.1680.1">
        self.accept()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1681.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1682.1">disconnect</span></span><span class="koboSpan" id="kobo.1683.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1684.1">self, close_code</span></span><span class="koboSpan" id="kobo.1685.1">):
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1686.1"># leave room group</span></span><span class="koboSpan" id="kobo.1687.1">
        async_to_sync(self.channel_layer.group_discard)(
            self.room_group_name, self.channel_name
        )
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1688.1"># receive message from WebSocket</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1689.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1690.1">receive</span></span><span class="koboSpan" id="kobo.1691.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1692.1">self, text_data</span></span><span class="koboSpan" id="kobo.1693.1">):
        text_data_json = json.loads(text_data)
        message = text_data_json[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1694.1">'message'</span></span><span class="koboSpan" id="kobo.1695.1">]
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1696.1">        now = timezone.now()</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1697.1"># send message to room group</span></span><span class="koboSpan" id="kobo.1698.1">
        async_to_sync(self.channel_layer.group_send)(
            self.room_group_name,
            {
                </span><span class="hljs-string"><span class="koboSpan" id="kobo.1699.1">'type'</span></span><span class="koboSpan" id="kobo.1700.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1701.1">'chat_message'</span></span><span class="koboSpan" id="kobo.1702.1">,
                </span><span class="hljs-string"><span class="koboSpan" id="kobo.1703.1">'message'</span></span><span class="koboSpan" id="kobo.1704.1">: message,
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1705.1">'user'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1706.1">: self.user.username,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1707.1">'datetime'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1708.1">: now.isoformat(),</span></strong></span><span class="koboSpan" id="kobo.1709.1">
            }
        )
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1710.1"># receive message from room group</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1711.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1712.1">chat_message</span></span><span class="koboSpan" id="kobo.1713.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1714.1">self, event</span></span><span class="koboSpan" id="kobo.1715.1">):
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1716.1"># send message to WebSocket</span></span><span class="koboSpan" id="kobo.1717.1">
        self.send(text_data=json.dumps(event))
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1718.1">You now import </span><a id="_idIndexMarker1508"/><span class="koboSpan" id="kobo.1719.1">the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1720.1">timezone</span></code><span class="koboSpan" id="kobo.1721.1"> module provided by Django. </span><span class="koboSpan" id="kobo.1721.2">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1722.1">connect()</span></code><span class="koboSpan" id="kobo.1723.1"> method of the consumer, you retrieve the current user from the scope with </span><code class="inlineCode"><span class="koboSpan" id="kobo.1724.1">self.scope['user']</span></code><span class="koboSpan" id="kobo.1725.1"> and store them in a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1726.1">user</span></code><span class="koboSpan" id="kobo.1727.1"> attribute of the consumer. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.1728.1">When the consumer receives a message through the WebSocket, it gets the current time using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1729.1">timezone.now()</span></code><span class="koboSpan" id="kobo.1730.1"> and passes the current </span><code class="inlineCode"><span class="koboSpan" id="kobo.1731.1">user</span></code><span class="koboSpan" id="kobo.1732.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1733.1">datetime</span></code><span class="koboSpan" id="kobo.1734.1"> in ISO 8601 format along with the message in the event sent to the channel group.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1735.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1736.1">chat/room.html</span></code><span class="koboSpan" id="kobo.1737.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1738.1">chat</span></code><span class="koboSpan" id="kobo.1739.1"> application and add the following line highlighted in bold to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1740.1">include_js</span></code><span class="koboSpan" id="kobo.1741.1"> block:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1742.1">{% block include_js %}
  {{ course.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1743.1">id</span></span><span class="koboSpan" id="kobo.1744.1">|json_script:</span><span class="hljs-string"><span class="koboSpan" id="kobo.1745.1">"course-id"</span></span><span class="koboSpan" id="kobo.1746.1"> }}
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1747.1">  {{ request.user.username|json_script:</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1748.1">"request-user"</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1749.1"> }}</span></strong></span><span class="koboSpan" id="kobo.1750.1">
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1751.1">Using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1752.1">json_script</span></code><span class="koboSpan" id="kobo.1753.1"> template, you safely print the username of the request user to use it with JavaScript.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1754.1">In the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1755.1">domready</span></code><span class="koboSpan" id="kobo.1756.1"> block of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1757.1">chat/room.html</span></code><span class="koboSpan" id="kobo.1758.1"> template, add the following lines highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1759.1">{% block domready %}
  </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1760.1">const</span></span><span class="koboSpan" id="kobo.1761.1"> courseId = </span><span class="hljs-title"><span class="koboSpan" id="kobo.1762.1">JSON</span></span><span class="koboSpan" id="kobo.1763.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1764.1">parse</span></span><span class="koboSpan" id="kobo.1765.1">(
    </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1766.1">document</span></span><span class="koboSpan" id="kobo.1767.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1768.1">getElementById</span></span><span class="koboSpan" id="kobo.1769.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1770.1">'course-id'</span></span><span class="koboSpan" id="kobo.1771.1">).</span><span class="hljs-property"><span class="koboSpan" id="kobo.1772.1">textContent</span></span><span class="koboSpan" id="kobo.1773.1">
  );
</span><span class="code-highlight"><strong class="hljs-params-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1774.1">const</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1775.1"> requestUser = </span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1776.1">JSON</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1777.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1778.1">parse</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1779.1">(</span></strong></span>
<span class="code-highlight"><strong class="hljs-params-slc"> </strong><strong class="hljs-variable-slc"><span class="koboSpan" id="kobo.1780.1">document</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1781.1">.</span></strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1782.1">getElementById</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1783.1">(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1784.1">'request-user'</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1785.1">).textContent</span></strong></span>
<span class="code-highlight"><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.1786.1">  );</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1787.1">  # ...</span></span><span class="koboSpan" id="kobo.1788.1">
{% endblock %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1789.1">In the new code, you safely parse the data of the element with the ID </span><code class="inlineCode"><span class="koboSpan" id="kobo.1790.1">request-user</span></code><span class="koboSpan" id="kobo.1791.1"> and store it in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1792.1">requestUser</span></code><span class="koboSpan" id="kobo.1793.1"> constant.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1794.1">Then, in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1795.1">domready</span></code><span class="koboSpan" id="kobo.1796.1"> block, find the following lines:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1797.1">const</span></span><span class="koboSpan" id="kobo.1798.1"> data = </span><span class="hljs-title"><span class="koboSpan" id="kobo.1799.1">JSON</span></span><span class="koboSpan" id="kobo.1800.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1801.1">parse</span></span><span class="koboSpan" id="kobo.1802.1">(event.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1803.1">data</span></span><span class="koboSpan" id="kobo.1804.1">);
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1805.1">const</span></span><span class="koboSpan" id="kobo.1806.1"> chat = </span><span class="hljs-variable"><span class="koboSpan" id="kobo.1807.1">document</span></span><span class="koboSpan" id="kobo.1808.1">.</span><span class="hljs-title"><span class="koboSpan" id="kobo.1809.1">getElementById</span></span><span class="koboSpan" id="kobo.1810.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1811.1">'chat'</span></span><span class="koboSpan" id="kobo.1812.1">);
chat.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1813.1">innerHTML</span></span><span class="koboSpan" id="kobo.1814.1"> += </span><span class="hljs-string"><span class="koboSpan" id="kobo.1815.1">'&lt;div class="message"&gt;'</span></span><span class="koboSpan" id="kobo.1816.1"> +
                  data.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1817.1">message</span></span><span class="koboSpan" id="kobo.1818.1"> + </span><span class="hljs-string"><span class="koboSpan" id="kobo.1819.1">'&lt;/div&gt;'</span></span><span class="koboSpan" id="kobo.1820.1">;
chat.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1821.1">scrollTop</span></span><span class="koboSpan" id="kobo.1822.1"> = chat.</span><span class="hljs-property"><span class="koboSpan" id="kobo.1823.1">scrollHeight</span></span><span class="koboSpan" id="kobo.1824.1">;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1825.1">Replace those lines with the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.1826.1">const data = JSON.parse(event.data);
const chat = document.getElementById('chat');
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1827.1">const dateOptions = {hour: 'numeric', minute: 'numeric', hour12: true};</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1828.1">const datetime = new Date(data.datetime).toLocaleString('en', dateOptions);</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1829.1">const isMe = data.user === requestUser;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1830.1">const source = isMe ? </span><span class="koboSpan" id="kobo.1830.2">'me' : 'other';</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1831.1">const name = isMe ? </span><span class="koboSpan" id="kobo.1831.2">'Me' : data.user;</span></strong></span><span class="koboSpan" id="kobo.1832.1">
chat.innerHTML += '</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1833.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1834.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1835.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1836.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1837.1">"message </span></span><span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1838.1">' + source + '</span></strong></span><span class="hljs-string"><span class="koboSpan" id="kobo.1839.1">"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1840.1">&gt;</span></span><span class="koboSpan" id="kobo.1841.1">' +
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1842.1">                  '</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1843.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1844.1">strong</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1845.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1846.1">' + name + '</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1847.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1848.1">strong</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1849.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1850.1"> ' +</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1851.1">                  '</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1852.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1853.1">span</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1854.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1855.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1856.1">"date"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1857.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1858.1">' + datetime + '</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1859.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1860.1">span</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1861.1">&gt;&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1862.1">br</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1863.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1864.1">' +</span></strong></span><span class="koboSpan" id="kobo.1865.1">
                  data.message + '</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1866.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1867.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1868.1">&gt;</span></span><span class="koboSpan" id="kobo.1869.1">';
chat.scrollTop = chat.scrollHeight;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1870.1">In this code, you</span><a id="_idIndexMarker1509"/><span class="koboSpan" id="kobo.1871.1"> implement the following changes:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1872.1">You convert the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1873.1">datetime</span></code><span class="koboSpan" id="kobo.1874.1"> received in the message to a JavaScript </span><code class="inlineCode"><span class="koboSpan" id="kobo.1875.1">Date</span></code><span class="koboSpan" id="kobo.1876.1"> object and format it with a specific locale.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1877.1">You compare the username received in the message with two different constants as helpers to identify the user.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1878.1">The constant </span><code class="inlineCode"><span class="koboSpan" id="kobo.1879.1">source</span></code><span class="koboSpan" id="kobo.1880.1"> gets the value </span><code class="inlineCode"><span class="koboSpan" id="kobo.1881.1">me</span></code><span class="koboSpan" id="kobo.1882.1"> if the user sending the message is the current user, or </span><code class="inlineCode"><span class="koboSpan" id="kobo.1883.1">other</span></code><span class="koboSpan" id="kobo.1884.1"> otherwise.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1885.1">The constant </span><code class="inlineCode"><span class="koboSpan" id="kobo.1886.1">name</span></code><span class="koboSpan" id="kobo.1887.1"> gets the value </span><code class="inlineCode"><span class="koboSpan" id="kobo.1888.1">Me</span></code><span class="koboSpan" id="kobo.1889.1"> if the user sending the message is the current user or the name of the user sending the message otherwise. </span><span class="koboSpan" id="kobo.1889.2">You use it to display the name of the user sending the message.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1890.1">You use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1891.1">source</span></code><span class="koboSpan" id="kobo.1892.1"> value as a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1893.1">class</span></code><span class="koboSpan" id="kobo.1894.1"> of the main </span><code class="inlineCode"><span class="koboSpan" id="kobo.1895.1">&lt;div&gt;</span></code><span class="koboSpan" id="kobo.1896.1"> message element to differentiate messages sent by the current user from messages sent by others. </span><span class="koboSpan" id="kobo.1896.2">Different CSS styles are applied based on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1897.1">class</span></code><span class="koboSpan" id="kobo.1898.1"> attribute. </span><span class="koboSpan" id="kobo.1898.2">These CSS styles are declared in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1899.1">css/base.css</span></code><span class="koboSpan" id="kobo.1900.1"> static file.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1901.1">You use the username and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1902.1">datetime</span></code><span class="koboSpan" id="kobo.1903.1"> in the message that you append to the chat log.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.1904.1">Open the URL </span><code class="inlineCode"><span class="koboSpan" id="kobo.1905.1">http://127.0.0.1:8000/chat/room/1/</span></code><span class="koboSpan" id="kobo.1906.1"> in your browser, replacing </span><code class="inlineCode"><span class="koboSpan" id="kobo.1907.1">1</span></code><span class="koboSpan" id="kobo.1908.1"> with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1909.1">id</span></code><span class="koboSpan" id="kobo.1910.1"> of an existing course in the database. </span><span class="koboSpan" id="kobo.1910.2">With a logged-in user who is enrolled in the course, write a message and send it.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1911.1">Then, open a second browser window in incognito mode to prevent the use of the same session. </span><span class="koboSpan" id="kobo.1911.2">Log in with a different user, also enrolled in the same course, and send a message.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1912.1">You will be able to</span><a id="_idIndexMarker1510"/><span class="koboSpan" id="kobo.1913.1"> exchange messages using the two different users and see the user and time, with a clear distinction between messages sent by the user and messages sent by others. </span><span class="koboSpan" id="kobo.1913.2">The conversation between two users should look similar to the following one:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1914.1"><img alt="" role="presentation" src="../Images/B21088_16_08.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1915.1">Figure 16.8: The chat room page with messages from two different user sessions</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1916.1">Great! </span><span class="koboSpan" id="kobo.1916.2">You have built a functional real-time chat application using Channels. </span><span class="koboSpan" id="kobo.1916.3">Next, you will learn how to improve the chat consumer by making it fully asynchronous.</span></p>
<h1 class="heading-1" id="_idParaDest-437"><span class="koboSpan" id="kobo.1917.1">Modifying the consumer to be fully asynchronous</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1918.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1919.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.1920.1"> you have</span><a id="_idIndexMarker1511"/><span class="koboSpan" id="kobo.1921.1"> implemented inherits from the synchronous base class </span><code class="inlineCode"><span class="koboSpan" id="kobo.1922.1">WebsocketConsumer</span></code><span class="koboSpan" id="kobo.1923.1">. </span><span class="koboSpan" id="kobo.1923.2">Synchronous consumers operate in a way that each request must be processed in sequence, one after the other. </span><span class="koboSpan" id="kobo.1923.3">Synchronous consumers are convenient for accessing Django models and calling regular synchronous I/O functions. </span><span class="koboSpan" id="kobo.1923.4">However, asynchronous consumers perform better because of their ability to perform non-blocking operations, moving to another task without waiting for the first operation to complete. </span><span class="koboSpan" id="kobo.1923.5">They don’t require additional threads when handling requests, thus reducing wait times and increasing the ability to scale to more users and requests simultaneously.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1924.1">Given that you are already using the asynchronous channel layer functions, you can seamlessly rewrite the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1925.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.1926.1"> class to make it asynchronous.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1927.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1928.1">consumers.py</span></code><span class="koboSpan" id="kobo.1929.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1930.1">chat</span></code><span class="koboSpan" id="kobo.1931.1"> application and implement the following changes:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1932.1">import</span></span><span class="koboSpan" id="kobo.1933.1"> json
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1934.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1935.1"> channels.generic.websocket </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1936.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1937.1"> AsyncWebsocketConsumer</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1938.1">from</span></span><span class="koboSpan" id="kobo.1939.1"> django.utils </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1940.1">import</span></span><span class="koboSpan" id="kobo.1941.1"> timezone
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1942.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1943.1">ChatConsumer</span></span><span class="koboSpan" id="kobo.1944.1">(</span><span class="code-highlight"><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.1945.1">AsyncWebsocketConsumer</span></strong></span><span class="koboSpan" id="kobo.1946.1">):
    </span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1947.1">async</span></strong></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1948.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1949.1">connect</span></span><span class="koboSpan" id="kobo.1950.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1951.1">self</span></span><span class="koboSpan" id="kobo.1952.1">):
        self.user = self.scope[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1953.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1954.1">user'</span></span><span class="koboSpan" id="kobo.1955.1">]
        self.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1956.1">id</span></span><span class="koboSpan" id="kobo.1957.1"> = self.scope[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1958.1">'url_route'</span></span><span class="koboSpan" id="kobo.1959.1">][</span><span class="hljs-string"><span class="koboSpan" id="kobo.1960.1">'kwargs'</span></span><span class="koboSpan" id="kobo.1961.1">][</span><span class="hljs-string"><span class="koboSpan" id="kobo.1962.1">'course_id'</span></span><span class="koboSpan" id="kobo.1963.1">]
        self.room_group_name = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1964.1">'chat_%s'</span></span><span class="koboSpan" id="kobo.1965.1"> % self.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1966.1">id</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1967.1"># join room group</span></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1968.1">await</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1969.1"> self.channel_layer.group_add(</span></strong></span><span class="koboSpan" id="kobo.1970.1">
            self.room_group_name, self.channel_name
        </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1971.1">)</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1972.1"># accept connection</span></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1973.1">await</span></strong></span><span class="koboSpan" id="kobo.1974.1"> self.accept()
    </span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1975.1">async</span></strong></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1976.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1977.1">disconnect</span></span><span class="koboSpan" id="kobo.1978.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1979.1">self, close_code</span></span><span class="koboSpan" id="kobo.1980.1">):
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1981.1"># leave room group</span></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1982.1">await</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1983.1"> self.channel_layer.group_discard(</span></strong></span><span class="koboSpan" id="kobo.1984.1">
            self.room_group_name, self.channel_name
        </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1985.1">)</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1986.1"># receive message from WebSocket</span></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1987.1">async</span></strong></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1988.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1989.1">receive</span></span><span class="koboSpan" id="kobo.1990.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1991.1">self, text_data</span></span><span class="koboSpan" id="kobo.1992.1">):
        text_data_json = json.loads(text_data)
        message = text_data_json[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1993.1">'message'</span></span><span class="koboSpan" id="kobo.1994.1">]
        now = timezone.now()
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1995.1"># send message to room group</span></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1996.1">await</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1997.1"> self.channel_layer.group_send(</span></strong></span><span class="koboSpan" id="kobo.1998.1">
            self.room_group_name,
            {
                </span><span class="hljs-string"><span class="koboSpan" id="kobo.1999.1">'type'</span></span><span class="koboSpan" id="kobo.2000.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.2001.1">'chat_message'</span></span><span class="koboSpan" id="kobo.2002.1">,
                </span><span class="hljs-string"><span class="koboSpan" id="kobo.2003.1">'message'</span></span><span class="koboSpan" id="kobo.2004.1">: message,
                </span><span class="hljs-string"><span class="koboSpan" id="kobo.2005.1">'user'</span></span><span class="koboSpan" id="kobo.2006.1">: self.user.username,
                </span><span class="hljs-string"><span class="koboSpan" id="kobo.2007.1">'datetime'</span></span><span class="koboSpan" id="kobo.2008.1">: now.isoformat(),
            }
        </span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2009.1">)</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.2010.1"># receive message from room group</span></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2011.1">async</span></strong></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2012.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2013.1">chat_message</span></span><span class="koboSpan" id="kobo.2014.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2015.1">self, event</span></span><span class="koboSpan" id="kobo.2016.1">):
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.2017.1"># send message to WebSocket</span></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2018.1">await</span></strong></span><span class="koboSpan" id="kobo.2019.1"> self.send(text_data=json.dumps(event))
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2020.1">You have implemented the following changes:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2021.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2022.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.2023.1"> consumer now inherits from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2024.1">AsyncWebsocketConsumer</span></code><span class="koboSpan" id="kobo.2025.1"> class to implement asynchronous calls.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2026.1">You have changed the definition of all methods from </span><code class="inlineCode"><span class="koboSpan" id="kobo.2027.1">def</span></code><span class="koboSpan" id="kobo.2028.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.2029.1">async def</span></code><span class="koboSpan" id="kobo.2030.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2031.1">You use </span><code class="inlineCode"><span class="koboSpan" id="kobo.2032.1">await</span></code><span class="koboSpan" id="kobo.2033.1"> to call asynchronous functions that perform I/O operations.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2034.1">You no longer use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2035.1">async_to_sync()</span></code><span class="koboSpan" id="kobo.2036.1"> helper function when calling methods on the channel layer.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.2037.1">Open the URL </span><code class="inlineCode"><span class="koboSpan" id="kobo.2038.1">http://127.0.0.1:8000/chat/room/1/</span></code><span class="koboSpan" id="kobo.2039.1"> with two different browser windows again and </span><a id="_idIndexMarker1512"/><span class="koboSpan" id="kobo.2040.1">verify that the chat server still works. </span><span class="koboSpan" id="kobo.2040.2">The chat server is now fully asynchronous!</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2041.1">Next, we are going to implement a chat history by storing messages in the database.</span></p>
<h1 class="heading-1" id="_idParaDest-438"><span class="koboSpan" id="kobo.2042.1">Persisting messages into the database</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2043.1">Let’s enhance the </span><a id="_idIndexMarker1513"/><span class="koboSpan" id="kobo.2044.1">chat application by adding message persistence. </span><span class="koboSpan" id="kobo.2044.2">We will develop functionality to store messages in the database, allowing us to present a chat history to users when they join a chat room. </span><span class="koboSpan" id="kobo.2044.3">This feature is essential for real-time applications, where it’s necessary to display both current and previously generated data. </span><span class="koboSpan" id="kobo.2044.4">For example, consider a stock trading application: upon logging in, users should see not only the current stock values but also the historical values from the time the stock market opened.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2045.1">To implement the chat history functionality, we will follow these steps:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2046.1">We will create Django model to store chat messages and add it to the administration site.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2047.1">We will modify the WebSocket consumer to persist messages.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2048.1">We will retrieve the chat history to display the latest messages when users enter a chat room.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.2049.1">Let’s start by creating the message model.</span></p>
<h2 class="heading-2" id="_idParaDest-439"><span class="koboSpan" id="kobo.2050.1">Creating a model for chat messages</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2051.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2052.1">models.py</span></code><span class="koboSpan" id="kobo.2053.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2054.1">chat</span></code><span class="koboSpan" id="kobo.2055.1"> application</span><a id="_idIndexMarker1514"/><span class="koboSpan" id="kobo.2056.1"> and add the following lines highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2057.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2058.1"> django.conf </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2059.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2060.1"> settings</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2061.1">from</span></span><span class="koboSpan" id="kobo.2062.1"> django.db </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2063.1">import</span></span><span class="koboSpan" id="kobo.2064.1"> models
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2065.1">class</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2066.1">Message</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2067.1">(models.Model):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2068.1">    user = models.ForeignKey(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2069.1">        settings.AUTH_USER_MODEL,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2070.1">        on_delete=models.PROTECT,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2071.1">        related_name=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2072.1">'chat_messages'</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2073.1">    )</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2074.1">    course = models.ForeignKey(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2075.1">'courses.Course'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2076.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2077.1">        on_delete=models.PROTECT,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2078.1">        related_name=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2079.1">'chat_messages'</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2080.1">    )</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2081.1">    content = models.TextField()</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2082.1">    sent_on = models.DateTimeField(auto_now_add=</span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.2083.1">True</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2084.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2085.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2086.1">__str__</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2087.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.2088.1">self</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2089.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2090.1">return</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2091.1">f'</span></strong><strong class="hljs-subst-slc"><span class="koboSpan" id="kobo.2092.1">{self.user}</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2093.1"> on </span></strong><strong class="hljs-subst-slc"><span class="koboSpan" id="kobo.2094.1">{self.course}</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2095.1"> at </span></strong><strong class="hljs-subst-slc"><span class="koboSpan" id="kobo.2096.1">{self.sent_on}</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2097.1">'</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2098.1">This is the data model to</span><a id="_idIndexMarker1515"/><span class="koboSpan" id="kobo.2099.1"> persist chat messages. </span><span class="koboSpan" id="kobo.2099.2">Let’s take a look at the fields of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2100.1">Message</span></code><span class="koboSpan" id="kobo.2101.1"> model:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2102.1">user</span></code><span class="koboSpan" id="kobo.2103.1">: The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2104.1">User</span></code><span class="koboSpan" id="kobo.2105.1"> object that wrote the message. </span><span class="koboSpan" id="kobo.2105.2">This is a foreign key field because it specifies a many-to-one relationship: a user can send multiple messages, but each message is sent by a single user. </span><span class="koboSpan" id="kobo.2105.3">By using </span><code class="inlineCode"><span class="koboSpan" id="kobo.2106.1">PROTECT</span></code><span class="koboSpan" id="kobo.2107.1"> for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2108.1">on_delete</span></code><span class="koboSpan" id="kobo.2109.1"> parameter, a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2110.1">User</span></code><span class="koboSpan" id="kobo.2111.1"> object cannot be deleted if related messages exist.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2112.1">course</span></code><span class="koboSpan" id="kobo.2113.1">: A relationship with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2114.1">Course</span></code><span class="koboSpan" id="kobo.2115.1"> object. </span><span class="koboSpan" id="kobo.2115.2">Each message belongs to the chat room of a course. </span><span class="koboSpan" id="kobo.2115.3">By using </span><code class="inlineCode"><span class="koboSpan" id="kobo.2116.1">PROTECT</span></code><span class="koboSpan" id="kobo.2117.1"> for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2118.1">on_delete</span></code><span class="koboSpan" id="kobo.2119.1"> parameter, a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2120.1">Course</span></code><span class="koboSpan" id="kobo.2121.1"> object cannot be deleted if related messages exist.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2122.1">content</span></code><span class="koboSpan" id="kobo.2123.1">: A </span><code class="inlineCode"><span class="koboSpan" id="kobo.2124.1">TextField</span></code><span class="koboSpan" id="kobo.2125.1"> to store the content of the message.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2126.1">sent_on</span></code><span class="koboSpan" id="kobo.2127.1">: A </span><code class="inlineCode"><span class="koboSpan" id="kobo.2128.1">DateTimeField</span></code><span class="koboSpan" id="kobo.2129.1"> to store the date and time when the message object is saved the first time.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.2130.1">Run the following command in the shell prompt to generate the database migrations for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2131.1">chat</span></code><span class="koboSpan" id="kobo.2132.1"> application:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2133.1">python manage.py makemigrations chat
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2134.1">You should get the following output:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2135.1">Migrations for 'chat':
    chat/migrations/0001_initial.py
        - Create model Message
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2136.1">Apply the newly created migration to your database with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2137.1">python manage.py migrate
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2138.1">You will get an output that ends with the following line:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2139.1">Applying chat.0001_initial... </span><span class="koboSpan" id="kobo.2139.2">OK
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2140.1">The database is now in sync with the new model. </span><span class="koboSpan" id="kobo.2140.2">Let’s add the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2141.1">Message</span></code><span class="koboSpan" id="kobo.2142.1"> model to the administration site.</span></p>
<h2 class="heading-2" id="_idParaDest-440"><span class="koboSpan" id="kobo.2143.1">Adding the message model to the administration site</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2144.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2145.1">admin.py</span></code><span class="koboSpan" id="kobo.2146.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2147.1">chat</span></code><span class="koboSpan" id="kobo.2148.1"> application and </span><a id="_idIndexMarker1516"/><span class="koboSpan" id="kobo.2149.1">register the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2150.1">Message</span></code><span class="koboSpan" id="kobo.2151.1"> model into the administration site, as follows. </span><span class="koboSpan" id="kobo.2151.2">The new code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2152.1">from</span></span><span class="koboSpan" id="kobo.2153.1"> django.contrib </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2154.1">import</span></span><span class="koboSpan" id="kobo.2155.1"> admin
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2156.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2157.1"> chat.models </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2158.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2159.1"> Message</span></strong></span>
<span class="code-highlight"><strong class="hljs-meta-slc"><span class="koboSpan" id="kobo.2160.1">@admin.register(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.2161.1">Message</span></strong><strong class="hljs-meta-slc"><span class="koboSpan" id="kobo.2162.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2163.1">class</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2164.1">MessageAdmin</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2165.1">(admin.ModelAdmin):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2166.1">list_display = [</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2167.1">'sent_on'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2168.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2169.1">'user'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2170.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2171.1">'course'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2172.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2173.1">'content'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2174.1">]</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2175.1">list_filter = [</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2176.1">'sent_on'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2177.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2178.1">'course'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2179.1">]</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2180.1">search_fields = [</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2181.1">'content'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2182.1">]</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2183.1">raw_id_fields = [</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2184.1">'user'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2185.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2186.1">'content'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2187.1">]</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2188.1">Run the development server and open </span><code class="inlineCode"><span class="koboSpan" id="kobo.2189.1">http://127.0.0.1:8000/admin/</span></code><span class="koboSpan" id="kobo.2190.1"> in your browser. </span><span class="koboSpan" id="kobo.2190.2">You should see the </span><strong class="screenText"><span class="koboSpan" id="kobo.2191.1">CHAT</span></strong><span class="koboSpan" id="kobo.2192.1"> block and the </span><strong class="screenText"><span class="koboSpan" id="kobo.2193.1">Messages</span></strong><span class="koboSpan" id="kobo.2194.1"> section on the administration site:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2195.1"><img alt="" role="presentation" src="../Images/B21088_16_09.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2196.1">Figure 16.9: The Chat application and Messages section on the administration site</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2197.1">We will continue by saving messages to the database when they are sent by users.</span></p>
<h2 class="heading-2" id="_idParaDest-441"><span class="koboSpan" id="kobo.2198.1">Storing messages in the database</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2199.1">We will modify the </span><a id="_idIndexMarker1517"/><span class="koboSpan" id="kobo.2200.1">WebSocket consumer to persist each message that is received through the WebSocket. </span><span class="koboSpan" id="kobo.2200.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2201.1">consumers.py</span></code><span class="koboSpan" id="kobo.2202.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2203.1">chat</span></code><span class="koboSpan" id="kobo.2204.1"> application, and add the following code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2205.1">import</span></span><span class="koboSpan" id="kobo.2206.1"> json
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2207.1">from</span></span><span class="koboSpan" id="kobo.2208.1"> channels.generic.websocket </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2209.1">import</span></span><span class="koboSpan" id="kobo.2210.1"> AsyncWebsocketConsumer
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2211.1">from</span></span><span class="koboSpan" id="kobo.2212.1"> django.utils </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2213.1">import</span></span><span class="koboSpan" id="kobo.2214.1"> timezone
</span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2215.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2216.1"> chat.models </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2217.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2218.1"> Message</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2219.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2220.1">ChatConsumer</span></span><span class="koboSpan" id="kobo.2221.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.2222.1">AsyncWebsocketConsumer</span></span><span class="koboSpan" id="kobo.2223.1">):
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.2224.1">    # ...</span></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2225.1">    async</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2226.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.2227.1">persist_message</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2228.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.2229.1">self, message</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2230.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.2231.1"># send message to WebSocket</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2232.1">await</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2233.1"> Message.objects.acreate(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2234.1">            user=self.user, course_id=self.id, content=message</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2235.1">        )</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.2236.1"># receive message from WebSocket</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2237.1">async</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2238.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2239.1">receive</span></span><span class="koboSpan" id="kobo.2240.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2241.1">self, text_data</span></span><span class="koboSpan" id="kobo.2242.1">):
        text_data_json = json.loads(text_data)
        message = text_data_json[</span><span class="hljs-string"><span class="koboSpan" id="kobo.2243.1">'message'</span></span><span class="koboSpan" id="kobo.2244.1">]
        now = timezone.now()
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.2245.1"># send message to room group</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2246.1">await</span></span><span class="koboSpan" id="kobo.2247.1"> self.channel_layer.group_send(
            self.room_group_name,
            {
                </span><span class="hljs-string"><span class="koboSpan" id="kobo.2248.1">'type': 'chat_message',</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.2249.1">                'message': </span></span><span class="koboSpan" id="kobo.2250.1">message,
</span><span class="hljs-string"><span class="koboSpan" id="kobo.2251.1">                'user': </span></span><span class="koboSpan" id="kobo.2252.1">self.user.username,
</span><span class="hljs-string"><span class="koboSpan" id="kobo.2253.1">                'datetime': </span></span><span class="koboSpan" id="kobo.2254.1">now.isoformat(),
</span><span class="hljs-string"> </span><span class="koboSpan" id="kobo.2255.1">},
</span><span class="hljs-string"> </span><span class="koboSpan" id="kobo.2256.1">)
</span><span class="code-highlight"><strong class="hljs-string-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.2257.1"># persist message</span></strong></span>
<span class="code-highlight"><strong class="hljs-string-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2258.1">await</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2259.1"> self.persist_message(message)</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.2260.1">    # ...</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2261.1">In this code, we add </span><a id="_idIndexMarker1518"/><span class="koboSpan" id="kobo.2262.1">the asynchronous </span><code class="inlineCode"><span class="koboSpan" id="kobo.2263.1">persist_message()</span></code><span class="koboSpan" id="kobo.2264.1"> method to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2265.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.2266.1"> class. </span><span class="koboSpan" id="kobo.2266.2">This method takes a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2267.1">message</span></code><span class="koboSpan" id="kobo.2268.1"> parameter and creates a </span><code class="inlineCode"><span class="koboSpan" id="kobo.2269.1">Message</span></code><span class="koboSpan" id="kobo.2270.1"> object in the database with the given message, the related authenticated </span><code class="inlineCode"><span class="koboSpan" id="kobo.2271.1">user</span></code><span class="koboSpan" id="kobo.2272.1">, and the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2273.1">id</span></code><span class="koboSpan" id="kobo.2274.1"> of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2275.1">Course</span></code><span class="koboSpan" id="kobo.2276.1"> object that the group chat room belongs to. </span><span class="koboSpan" id="kobo.2276.2">Since the is </span><code class="inlineCode"><span class="koboSpan" id="kobo.2277.1">ChatConsumer</span></code><span class="koboSpan" id="kobo.2278.1"> is fully asynchronous, we use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2279.1">acreate()</span></code><span class="koboSpan" id="kobo.2280.1"> QuerySet method, which is the asynchronous version of </span><code class="inlineCode"><span class="koboSpan" id="kobo.2281.1">create()</span></code><span class="koboSpan" id="kobo.2282.1">. </span><span class="koboSpan" id="kobo.2282.2">You can read more about how to write asynchronous queries with the Django ORM at </span><a href="https://docs.djangoproject.com/en/5.0/topics/db/queries/#asynchronous-queries"><span class="url"><span class="koboSpan" id="kobo.2283.1">https://docs.djangoproject.com/en/5.0/topics/db/queries/#asynchronous-queries</span></span></a><span class="koboSpan" id="kobo.2284.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2285.1">We call the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2286.1">persist_message()</span></code><span class="koboSpan" id="kobo.2287.1"> method asynchronously in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2288.1">receive()</span></code><span class="koboSpan" id="kobo.2289.1"> method that is executed when a message is received by the consumer through the WebSocket.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2290.1">Run the development server and open </span><code class="inlineCode"><span class="koboSpan" id="kobo.2291.1">http://127.0.0.1:8000/chat/room/1/</span></code><span class="koboSpan" id="kobo.2292.1"> in your browser, replacing </span><code class="inlineCode"><span class="koboSpan" id="kobo.2293.1">1</span></code><span class="koboSpan" id="kobo.2294.1"> with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2295.1">id</span></code><span class="koboSpan" id="kobo.2296.1"> of an existing course in the database. </span><span class="koboSpan" id="kobo.2296.2">With a logged-in user who is enrolled in the course, write a message and send it.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2297.1">Then, open a second browser window in incognito mode to prevent the use of the same session. </span><span class="koboSpan" id="kobo.2297.2">Log in with a different user, also enrolled in the same course, and send a few messages as well.</span></p>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.2298.1">Figure 16.10</span></em><span class="koboSpan" id="kobo.2299.1"> shows an</span><a id="_idIndexMarker1519"/><span class="koboSpan" id="kobo.2300.1"> example of messages sent by two different users:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2301.1"><img alt="" role="presentation" src="../Images/B21088_16_10.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2302.1">Figure 16.10: Chat room example with messages sent by two different users</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2303.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.2304.1">http://127.0.0.1:8000/admin/chat/message/</span></code><span class="koboSpan" id="kobo.2305.1"> in your browser. </span><span class="koboSpan" id="kobo.2305.2">The messages sent should appear on the administration site, as in </span><em class="italic"><span class="koboSpan" id="kobo.2306.1">Figure 16.11</span></em><span class="koboSpan" id="kobo.2307.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2308.1"><img alt="" role="presentation" src="../Images/B21088_16_11.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2309.1">Figure 16.11: Admin list display view of messages stored in the database</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2310.1">All messages are now persisted in the database.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2311.1">Note that messages</span><a id="_idIndexMarker1520"/><span class="koboSpan" id="kobo.2312.1"> could contain malicious code, for example, JavaScript fragments. </span><span class="koboSpan" id="kobo.2312.2">We do not mark the messages as safe in our template, providing an initial layer of protection against malicious content. </span><span class="koboSpan" id="kobo.2312.3">However, to further enhance security, consider sanitizing the messages before storing them in the database. </span><span class="koboSpan" id="kobo.2312.4">A reliable option for sanitizing content is the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2313.1">nh3</span></code><span class="koboSpan" id="kobo.2314.1"> package. </span><span class="koboSpan" id="kobo.2314.2">You can read more</span><a id="_idIndexMarker1521"/><span class="koboSpan" id="kobo.2315.1"> about </span><code class="inlineCode"><span class="koboSpan" id="kobo.2316.1">nh3</span></code><span class="koboSpan" id="kobo.2317.1"> at </span><a href="https://nh3.readthedocs.io/en/latest/"><span class="url"><span class="koboSpan" id="kobo.2318.1">https://nh3.readthedocs.io/en/latest/</span></span></a><span class="koboSpan" id="kobo.2319.1">. </span><span class="koboSpan" id="kobo.2319.2">Additionally, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2320.1">django-nh3</span></code><span class="koboSpan" id="kobo.2321.1"> is a Django integration available that offers custom </span><code class="inlineCode"><span class="koboSpan" id="kobo.2322.1">nh3</span></code><span class="koboSpan" id="kobo.2323.1"> model fields and form </span><a id="_idIndexMarker1522"/><span class="koboSpan" id="kobo.2324.1">fields. </span><span class="koboSpan" id="kobo.2324.2">More information is available at </span><a href="https://github.com/marksweb/django-nh3"><span class="url"><span class="koboSpan" id="kobo.2325.1">https://github.com/marksweb/django-nh3</span></span></a><span class="koboSpan" id="kobo.2326.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2327.1">Now that you are storing the complete chat history in your database, let’s learn how to present the latest messages in the chat history to users when they join a chat room.</span></p>
<h2 class="heading-2" id="_idParaDest-442"><span class="koboSpan" id="kobo.2328.1">Displaying the chat history</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.2329.1">When users join a course </span><a id="_idIndexMarker1523"/><span class="koboSpan" id="kobo.2330.1">chat room, we will display the latest five messages of the chat history. </span><span class="koboSpan" id="kobo.2330.2">This will ensure that users gain immediate context for ongoing conversations.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2331.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2332.1">views.py</span></code><span class="koboSpan" id="kobo.2333.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2334.1">chat</span></code><span class="koboSpan" id="kobo.2335.1"> application and add the following code highlighted in bold to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2336.1">course_chat_room</span></code><span class="koboSpan" id="kobo.2337.1"> view:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.2338.1">@login_required</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2339.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2340.1">course_chat_room</span></span><span class="koboSpan" id="kobo.2341.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2342.1">request, course_id</span></span><span class="koboSpan" id="kobo.2343.1">):
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2344.1">try</span></span><span class="koboSpan" id="kobo.2345.1">:
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.2346.1"># retrieve course with given id joined by the current user</span></span><span class="koboSpan" id="kobo.2347.1">
        course = request.user.courses_joined.get(</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2348.1">id</span></span><span class="koboSpan" id="kobo.2349.1">=course_id)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2350.1">except</span></span><span class="koboSpan" id="kobo.2351.1"> Course.DoesNotExist:
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.2352.1"># user is not a student of the course or course does not exist</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2353.1">return</span></span><span class="koboSpan" id="kobo.2354.1"> HttpResponseForbidden()
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.2355.1"># retrieve chat history</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2356.1">    latest_messages = course.chat_messages.select_related(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2357.1">'user'</span></strong></span>
<span class="code-highlight"><strong class="hljs-string-slc"> </strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2358.1">).order_by(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2359.1">'-id'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2360.1">)[:</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.2361.1">5</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2362.1">]</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2363.1">    latest_messages = </span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.2364.1">reversed</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2365.1">(latest_messages)</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2366.1">return</span></span><span class="koboSpan" id="kobo.2367.1"> render(
        request,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2368.1">'chat/room.html'</span></span><span class="koboSpan" id="kobo.2369.1">,
        {</span><span class="hljs-string"><span class="koboSpan" id="kobo.2370.1">'course'</span></span><span class="koboSpan" id="kobo.2371.1">: course</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2372.1">, </span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2373.1">'latest_messages'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2374.1">: latest_messages</span></strong></span><span class="koboSpan" id="kobo.2375.1">}
    )
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2376.1">We retrieve the chat </span><a id="_idIndexMarker1524"/><span class="koboSpan" id="kobo.2377.1">messages related to the course and use </span><code class="inlineCode"><span class="koboSpan" id="kobo.2378.1">select_related()</span></code><span class="koboSpan" id="kobo.2379.1"> to fetch the related user in the same query. </span><span class="koboSpan" id="kobo.2379.2">This will prevent the generation of additional SQL queries when accessing the username to display it alongside each message. </span><span class="koboSpan" id="kobo.2379.3">Django’s ORM doesn’t support negative indexing, so we retrieve the first five messages in reverse chronological order, and we utilize the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2380.1">reversed()</span></code><span class="koboSpan" id="kobo.2381.1"> function to reorder them back into chronological sequence.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2382.1">Now, we will add the chat history to the chat room template. </span><span class="koboSpan" id="kobo.2382.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2383.1">chat/room.html</span></code><span class="koboSpan" id="kobo.2384.1"> template and add the following lines highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.2385.1"># ...</span></span><span class="koboSpan" id="kobo.2386.1">
{% block content %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2387.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2388.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2389.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2390.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2391.1">"chat"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2392.1">&gt;</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2393.1">    {% for message in latest_messages %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2394.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2395.1">div</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.2396.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2397.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2398.1">"</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2399.1">message {% if message.user == request.user %}me{% else %}other{% endif %}"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2400.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2401.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2402.1">strong</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2403.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2404.1">{{ message.user.username }}</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2405.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2406.1">strong</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2407.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2408.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2409.1">span</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.2410.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2411.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2412.1">"date"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2413.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2414.1">          {{ message.sent_on|date:"Y.m.d H:i A" }}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2415.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2416.1">span</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2417.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2418.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2419.1">br</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2420.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2421.1">        {{ message.content }}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2422.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2423.1">div</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2424.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2425.1">    {% endfor %}</span></strong></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2426.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2427.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2428.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2429.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2430.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2431.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2432.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2433.1">"chat-input"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2434.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2435.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2436.1">input</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2437.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2438.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2439.1">"chat-message-input"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2440.1">type</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2441.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2442.1">"text"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2443.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2444.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2445.1">input</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2446.1">id</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2447.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2448.1">"chat-message-submit"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2449.1">type</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2450.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2451.1">"submit"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2452.1">value</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2453.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2454.1">"Send"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2455.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2456.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2457.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2458.1">&gt;</span></span><span class="koboSpan" id="kobo.2459.1">
{% endblock %}
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.2460.1"># ...</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2461.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.2462.1">http://127.0.0.1:8000/chat/room/1/</span></code><span class="koboSpan" id="kobo.2463.1"> in your browser, replacing </span><code class="inlineCode"><span class="koboSpan" id="kobo.2464.1">1</span></code><span class="koboSpan" id="kobo.2465.1"> with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2466.1">id</span></code><span class="koboSpan" id="kobo.2467.1"> of an existing course in the database. </span><span class="koboSpan" id="kobo.2467.2">You</span><a id="_idIndexMarker1525"/><span class="koboSpan" id="kobo.2468.1"> should now see the latest messages, as shown in </span><em class="italic"><span class="koboSpan" id="kobo.2469.1">Figure 16.12</span></em><span class="koboSpan" id="kobo.2470.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2471.1"><img alt="" role="presentation" src="../Images/B21088_16_12.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2472.1">Figure 16.12: Chat room initially displaying the latest messages</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2473.1">Users can now see the </span><a id="_idIndexMarker1526"/><span class="koboSpan" id="kobo.2474.1">latest messages in the chat history upon joining a chat room. </span><span class="koboSpan" id="kobo.2474.2">Next, we are going to add a link to the menu so that users can enter the course chat room.</span></p>
<h1 class="heading-1" id="_idParaDest-443"><span class="koboSpan" id="kobo.2475.1">Integrating the chat application with existing views</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2476.1">The chat server</span><a id="_idIndexMarker1527"/><span class="koboSpan" id="kobo.2477.1"> is now fully implemented, and students enrolled in a course can communicate with each other. </span><span class="koboSpan" id="kobo.2477.2">Let’s add a link for students to join the chat room for each course.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2478.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2479.1">students/course/detail.html</span></code><span class="koboSpan" id="kobo.2480.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2481.1">students</span></code><span class="koboSpan" id="kobo.2482.1"> application and add the following </span><code class="inlineCode"><span class="koboSpan" id="kobo.2483.1">&lt;h3&gt;</span></code><span class="koboSpan" id="kobo.2484.1"> HTML element code at the bottom of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2485.1">&lt;div class="contents"&gt;</span></code><span class="koboSpan" id="kobo.2486.1"> element:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.2487.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2488.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2489.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2490.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2491.1">"contents"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2492.1">&gt;</span></span>
<span class="hljs-con-comment"><span class="koboSpan" id="kobo.2493.1">  ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2494.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2495.1">h3</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2496.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2497.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2498.1">a</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.2499.1">href</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2500.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2501.1">"{% url "</span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.2502.1">chat:course_chat_room</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2503.1">" </span></strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.2504.1">object.id</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2505.1"> %}"&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2506.1">      Course chat room</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2507.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2508.1">a</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2509.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2510.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.2511.1">h3</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.2512.1">&gt;</span></strong></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2513.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2514.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2515.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2516.1">Open the browser and access any course that the student is enrolled in to view the course contents. </span><span class="koboSpan" id="kobo.2516.2">The sidebar will now contain a </span><strong class="screenText"><span class="koboSpan" id="kobo.2517.1">Course chat room</span></strong><span class="koboSpan" id="kobo.2518.1"> link that points to the course chat room view. </span><span class="koboSpan" id="kobo.2518.2">If you click on it, you will enter the chat room:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2519.1"><img alt="Graphical user interface, application  Description automatically generated" src="../Images/B21088_16_13.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2520.1">Figure 16.13: The course detail page, including a link to the course chat room</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2521.1">Congratulations! </span><span class="koboSpan" id="kobo.2521.2">You </span><a id="_idIndexMarker1528"/><span class="koboSpan" id="kobo.2522.1">successfully built your first asynchronous application using Django Channels.</span></p>
<h1 class="heading-1" id="_idParaDest-444"><span class="koboSpan" id="kobo.2523.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2524.1">In this chapter, you learned how to create a chat server using Channels. </span><span class="koboSpan" id="kobo.2524.2">You implemented both a WebSocket consumer and a client. </span><span class="koboSpan" id="kobo.2524.3">By enabling communication through a channel layer with Redis and modifying the consumer to be fully asynchronous, you improved the responsiveness and scalability of your application. </span><span class="koboSpan" id="kobo.2524.4">Additionally, you implemented chat message persistence, providing a robust and user-friendly experience and maintaining chat history for users over time. </span><span class="koboSpan" id="kobo.2524.5">The skills you learned in this chapter will help you in any future implementations of asynchronous real-time functionalities.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2525.1">The next chapter will teach you how to build a production environment for your Django project using NGINX, uWSGI, and Daphne with Docker Compose. </span><span class="koboSpan" id="kobo.2525.2">You will also learn how to implement custom middleware for request/response processing across your entire application, and how to develop custom management commands, which enable you to automate tasks and execute them via the command line.</span></p>
<h1 class="heading-1" id="_idParaDest-445"><span class="koboSpan" id="kobo.2526.1">Additional resources</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2527.1">The following resources provide additional information related to the topics covered in this chapter:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2528.1">Source code for this chapter: </span><a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter16"><span class="url"><span class="koboSpan" id="kobo.2529.1">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter16</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2530.1">Introduction to ASGI: </span><a href="https://asgi.readthedocs.io/en/latest/introduction.html"><span class="url"><span class="koboSpan" id="kobo.2531.1">https://asgi.readthedocs.io/en/latest/introduction.html</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2532.1">Django support for asynchronous views: </span><a href="https://docs.djangoproject.com/en/5.0/topics/async/"><span class="url"><span class="koboSpan" id="kobo.2533.1">https://docs.djangoproject.com/en/5.0/topics/async/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2534.1">Django support for asynchronous class-based views: </span><a href="https://docs.djangoproject.com/en/5.0/topics/class-based-views/#async-class-based-views"><span class="url"><span class="koboSpan" id="kobo.2535.1">https://docs.djangoproject.com/en/5.0/topics/class-based-views/#async-class-based-views</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2536.1">Daphne ASGI server: </span><a href="https://github.com/django/daphne"><span class="url"><span class="koboSpan" id="kobo.2537.1">https://github.com/django/daphne</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2538.1">Django Channels documentation: </span><a href="https://channels.readthedocs.io/"><span class="url"><span class="koboSpan" id="kobo.2539.1">https://channels.readthedocs.io/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2540.1">Deploying Django with ASGI: </span><a href="https://docs.djangoproject.com/en/5.0/howto/deployment/asgi/"><span class="url"><span class="koboSpan" id="kobo.2541.1">https://docs.djangoproject.com/en/5.0/howto/deployment/asgi/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2542.1">Introduction to WebSockets: </span><a href="https://en.wikipedia.org/wiki/WebSocket"><span class="url"><span class="koboSpan" id="kobo.2543.1">https://en.wikipedia.org/wiki/WebSocket</span></span></a><span class="koboSpan" id="kobo.2544.1">.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2545.1">json_script</span></code><span class="koboSpan" id="kobo.2546.1"> template filter usage: </span><a href="https://docs.djangoproject.com/en/5.0/ref/templates/builtins/#json-script"><span class="url"><span class="koboSpan" id="kobo.2547.1">https://docs.djangoproject.com/en/5.0/ref/templates/builtins/#json-script</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2548.1">Django ORM asynchronous queries: </span><a href="https://docs.djangoproject.com/en/5.0/topics/db/queries/#asynchronous-queries"><span class="url"><span class="koboSpan" id="kobo.2549.1">https://docs.djangoproject.com/en/5.0/topics/db/queries/#asynchronous-queries</span></span></a></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2550.1">nh3</span></code><span class="koboSpan" id="kobo.2551.1"> documentation: </span><a href="https://nh3.readthedocs.io/en/latest/"><span class="url"><span class="koboSpan" id="kobo.2552.1">https://nh3.readthedocs.io/en/latest/</span></span></a></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.2553.1">django-nh3</span></code><span class="koboSpan" id="kobo.2554.1"> project: </span><a href="https://github.com/marksweb/django-nh3"><span class="url"><span class="koboSpan" id="kobo.2555.1">https://github.com/marksweb/django-nh3</span></span></a></li>
</ul>
</div>
</body></html>