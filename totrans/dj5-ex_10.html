<html><head></head><body>
<div><h1 class="chapterNumber">10</h1>
<h1 class="chapterTitle" id="_idParaDest-283">Extending Your Shop</h1>
<p class="normal">In the previous chapter, you learned how to integrate a payment gateway into your shop. You also learned how to generate CSV and PDF files.</p>
<p class="normal">In this chapter, you will add a coupon system to your shop and create a product recommendation engine.</p>
<p class="normal">This chapter will cover the following points:</p>
<ul>
<li class="bulletList">Creating a coupon system</li>
<li class="bulletList">Applying coupons to the shopping cart</li>
<li class="bulletList">Applying coupons to orders</li>
<li class="bulletList">Creating coupons for Stripe Checkout</li>
<li class="bulletList">Storing products that are usually bought together</li>
<li class="bulletList">Building a product recommendation engine with Redis</li>
</ul>
<h1 class="heading-1" id="_idParaDest-284">Functional overview</h1>
<p class="normal"><em class="italic">Figure 10.1</em> shows a representation of the views, templates, and functionalities that will be built in this chapter:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_10_01.png"/></figure>
<p class="packt_figref">Figure 10.1: Diagram of functionalities built in Chapter 10</p>
<p class="normal">In this chapter, you will build a new <code class="inlineCode">coupons</code> application and create the <code class="inlineCode">coupon_apply</code> view to apply discount coupons to the cart session. You will add the discount applied to the template of the <code class="inlineCode">cart_detail</code> view of the <code class="inlineCode">cart</code> application. When an order is created with the <code class="inlineCode">order_create</code> view of the <code class="inlineCode">orders</code> application, you will save the coupon to the order created. Then, when you create the Stripe session in the <code class="inlineCode">payment_process</code> view of the <code class="inlineCode">payment</code> application, you will add the coupon to the Stripe checkout session before redirecting the user to Stripe to complete the payment. You will add the discount applied to the templates of the admin views <code class="inlineCode">admin_order_detail</code> and <code class="inlineCode">admin_order_pdf</code> of the <code class="inlineCode">order</code> application. In addition to the coupon system, you will also implement a recommendation system. When the <code class="inlineCode">checkout.session.completed</code> Stripe event is received by the <code class="inlineCode">stripe_webhook</code> view, you will save the products that have been bought together in Redis. You will add product recommendations to the <code class="inlineCode">product_detail</code> and <code class="inlineCode">cart_detail</code> views by retrieving from Redis the items that are frequently bought together.</p>
<p class="normal">The source code for this chapter can be found at <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter10">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter10</a>.</p>
<p class="normal">All the Python packages used in this chapter are included in the <code class="inlineCode">requirements.txt</code> file in the source code for the chapter. You can follow the instructions to install each Python package in the following sections, or you can install all the requirements at once with the command <code class="inlineCode">python -m pip install -r requirements.txt</code>.</p>
<h1 class="heading-1" id="_idParaDest-285">Creating a coupon system</h1>
<p class="normal">Many online shops<a id="_idIndexMarker923"/> give out coupons to customers that can be redeemed for discounts on their purchases. An online coupon usually consists of a code that is given to users and is valid for a specific time frame.</p>
<p class="normal">You are going to create a coupon system for your shop. Your coupons will be valid for customers during a certain time frame. The coupons will not have any limitations in terms of the number of times they can be redeemed, and they will be applied to the total value of the shopping cart.</p>
<p class="normal">For this functionality, you will need to create a model to store the coupon code, a valid time frame, and the discount to apply.</p>
<p class="normal">Create a new application inside the <code class="inlineCode">myshop</code> project using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py startapp coupons
</code></pre>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of <code class="inlineCode">myshop</code> and add the application to the <code class="inlineCode">INSTALLED_APPS</code> setting, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">INSTALLED_APPS = [
    # ...
<strong class="hljs-string-slc">'coupons.apps.CouponsConfig'</strong><strong class="hljs-slc">,</strong>
]
</code></pre>
<p class="normal">The new application is now active in your Django project.</p>
<h2 class="heading-2" id="_idParaDest-286">Building the coupon model</h2>
<p class="normal">Let’s start by<a id="_idIndexMarker924"/> creating the <code class="inlineCode">Coupon</code> model. Edit the <code class="inlineCode">models.py</code> file of the <code class="inlineCode">coupons</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.core.validators import MaxValueValidator, MinValueValidator
from django.db import models
class Coupon(models.Model):
    code = models.CharField(max_length=50, unique=True)
    valid_from = models.DateTimeField()
    valid_to = models.DateTimeField()
    discount = models.IntegerField(
        validators=[MinValueValidator(0), MaxValueValidator(100)],
        help_text='Percentage value (0 to 100)'
 )
    active = models.BooleanField()
    def __str__(self):
        return self.code
</code></pre>
<p class="normal">This is the model that you are going to use to store coupons. The <code class="inlineCode">Coupon</code> model contains the following fields:</p>
<ul>
<li class="bulletList"><code class="inlineCode">code</code>: The code that users have to enter in order to apply the coupon to their purchase.</li>
<li class="bulletList"><code class="inlineCode">valid_from</code>: The datetime value that indicates when the coupon becomes valid.</li>
<li class="bulletList"><code class="inlineCode">valid_to</code>: The datetime value that indicates when the coupon becomes invalid.</li>
<li class="bulletList"><code class="inlineCode">discount</code>: The discount rate to apply (this is a percentage, so it takes values from <code class="inlineCode">0</code> to <code class="inlineCode">100</code>). You use validators for this field to limit the minimum and maximum accepted values.</li>
<li class="bulletList"><code class="inlineCode">active</code>: A Boolean that indicates whether the coupon is active.</li>
</ul>
<p class="normal">Run the following command to generate the initial migration for the <code class="inlineCode">coupons</code> application:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py makemigrations
</code></pre>
<p class="normal">The output should include the following lines:</p>
<pre class="programlisting con"><code class="hljs-con">Migrations for 'coupons':
  coupons/migrations/0001_initial.py
    - Create model Coupon
</code></pre>
<p class="normal">Then, execute the next command to apply migrations:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py migrate
</code></pre>
<p class="normal">You should see an output that includes the following line:</p>
<pre class="programlisting con"><code class="hljs-con">Applying coupons.0001_initial... OK
</code></pre>
<p class="normal">The migrations have now been applied to the database. Let’s add the <code class="inlineCode">Coupon</code> model to the administration <a id="_idIndexMarker925"/>site. Edit the <code class="inlineCode">admin.py</code> file of the <code class="inlineCode">coupons</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.contrib import admin
from .models import Coupon
@admin.register(Coupon)
class CouponAdmin(admin.ModelAdmin):
    list_display = [
        'code',
        'valid_from',
        'valid_to',
        'discount',
        'active'
 ]
    list_filter = ['active', 'valid_from', 'valid_to']
    search_fields = ['code']
</code></pre>
<p class="normal">The <code class="inlineCode">Coupon</code> model is now registered on the administration site. Ensure that your local server is running with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/admin/coupons/coupon/add/</code> in your browser.</p>
<p class="normal">You should see the following form:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_10_02.png"/></figure>
<p class="packt_figref">Figure 10.2: The Add coupon form on the Django administration site</p>
<p class="normal">Fill in the form to<a id="_idIndexMarker926"/> create a new coupon that is valid for the current date. Make sure that you check the <strong class="screenText">Active</strong> checkbox, and click the <strong class="screenText">SAVE</strong> button. <em class="italic">Figure 10.3</em> shows an example of creating a coupon:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_10_03.png"/></figure>
<p class="packt_figref">Figure 10.3: The Add coupon form with sample data</p>
<p class="normal">After creating the<a id="_idIndexMarker927"/> coupon, the coupon change list page on the administration site will look similar to <em class="italic">Figure 10.4</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_10_04.png"/></figure>
<p class="packt_figref">Figure 10.4: The coupon change list page on the Django administration site</p>
<p class="normal">Next, we will<a id="_idIndexMarker928"/> implement the functionality to apply coupons to the shopping cart.</p>
<h2 class="heading-2" id="_idParaDest-287">Applying a coupon to the shopping cart</h2>
<p class="normal">You can store new <a id="_idIndexMarker929"/>coupons and make queries to retrieve existing coupons. Now you need a way for customers to apply coupons to their purchases. The functionality to apply a coupon would be as follows:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">The user adds products to the shopping cart.</li>
<li class="numberedList">The user can enter a coupon code in a form displayed on the shopping cart details page.</li>
<li class="numberedList">When the user enters a coupon code and submits the form, you look for an existing coupon with the given code that is currently valid. You have to check that the coupon code matches the one entered by the user, that the <code class="inlineCode">active</code> attribute is <code class="inlineCode">True</code>, and that the current datetime is between the <code class="inlineCode">valid_from</code> and <code class="inlineCode">valid_to</code> values.</li>
<li class="numberedList">If a coupon is found, you save it in the user’s session and display the cart, including the discount applied to it and the updated total amount.</li>
<li class="numberedList">When the user places an order, you save the coupon to the given order.</li>
</ol>
<p class="normal">Create a new file inside the <code class="inlineCode">coupons</code> application directory and name it <code class="inlineCode">forms.py</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django import forms
class CouponApplyForm(forms.Form):
    code = forms.CharField()
</code></pre>
<p class="normal">This is the form that you are going to use for the user to enter a coupon code. Edit the <code class="inlineCode">views.py</code> file inside the <code class="inlineCode">coupons</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.shortcuts import redirect
from django.utils import timezone
from django.views.decorators.http import require_POST
from .forms import CouponApplyForm
from .models import Coupon
@require_POST
def coupon_apply(request):
    now = timezone.now()
    form = CouponApplyForm(request.POST)
    if form.is_valid():
        code = form.cleaned_data['code']
        try:
            coupon = Coupon.objects.get(
                code__iexact=code,
                valid_from__lte=now,
                valid_to__gte=now,
                active=True
            )
            request.session['coupon_id'] = coupon.id
except Coupon.DoesNotExist:
            request.session['coupon_id'] = None
return redirect('cart:cart_detail')
</code></pre>
<p class="normal">The <code class="inlineCode">coupon_apply</code> view validates the coupon and stores it in the user’s session. You apply the <code class="inlineCode">require_POST</code> decorator<a id="_idIndexMarker930"/> to this view to restrict it to <code class="inlineCode">POST</code> requests. In the view, you perform the following tasks:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">You instantiate the <code class="inlineCode">CouponApplyForm</code> form using the posted data and check that the form is valid.</li>
<li class="numberedList">If the form is valid, you get the <code class="inlineCode">code</code> entered by the user from the form’s <code class="inlineCode">cleaned_data</code> dictionary. You try to retrieve the <code class="inlineCode">Coupon</code> object with the given code. You use the <code class="inlineCode">iexact</code> field lookup to perform a case-insensitive exact match. The coupon has to be currently active (<code class="inlineCode">active=True</code>) and valid for the current datetime. You use Django’s <code class="inlineCode">timezone.now()</code> function to get the current timezone-aware datetime, and you compare it with the <code class="inlineCode">valid_from</code> and <code class="inlineCode">valid_to</code> fields by performing the <code class="inlineCode">lte</code> (less than or equal to) and <code class="inlineCode">gte</code> (greater than or equal to) field lookups, respectively.</li>
<li class="numberedList">You store the coupon ID in the user’s session.</li>
<li class="numberedList">You redirect the user to the <code class="inlineCode">cart_detail</code> URL to display the cart with the coupon applied.</li>
</ol>
<p class="normal">You need a URL pattern for the <code class="inlineCode">coupon_apply</code> view. Create a new file inside the <code class="inlineCode">coupons</code> application directory and name it <code class="inlineCode">urls.py</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from django.urls import path
from . import views
app_name = 'coupons'
urlpatterns = [
    path('apply/', views.coupon_apply, name='apply'),
]
</code></pre>
<p class="normal">Then, edit the main <code class="inlineCode">urls.py</code> of the <code class="inlineCode">myshop</code> project and include the <code class="inlineCode">coupons</code> URL patterns with the<a id="_idIndexMarker931"/> following line highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    path('admin/', admin.site.urls),
    path('cart/', include('cart.urls', namespace='cart')),
    path('orders/', include('orders.urls', namespace='orders')),
    path('payment/', include('payment.urls', namespace='payment')),
<strong class="hljs-slc">    path(</strong><strong class="hljs-string-slc">'coupons/'</strong><strong class="hljs-slc">, include(</strong><strong class="hljs-string-slc">'coupons.urls'</strong><strong class="hljs-slc">, namespace=</strong><strong class="hljs-string-slc">'coupons'</strong><strong class="hljs-slc">)),</strong>
    path('', include('shop.urls', namespace='shop')),
]
</code></pre>
<p class="normal">Remember to place this pattern before the <code class="inlineCode">shop.urls</code> pattern.</p>
<p class="normal">Now, edit the <code class="inlineCode">cart.py</code> file of the <code class="inlineCode">cart</code> application. Include the following import:</p>
<pre class="programlisting code"><code class="hljs-code">from coupons.models import Coupon
</code></pre>
<p class="normal">Add the following code highlighted in bold to the end of the <code class="inlineCode">__init__()</code> method of the <code class="inlineCode">Cart</code> class to initialize the coupon from the current session:</p>
<pre class="programlisting code"><code class="hljs-code">class Cart:
    def __init__(self, request):
        """
        Initialize the cart.
        """
        self.session = request.session
        cart = self.session.get(settings.CART_SESSION_ID)
        if not cart:
            # save an empty cart in the session
            cart = self.session[settings.CART_SESSION_ID] = {}
        self.cart = cart
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># store current applied coupon</strong>
<strong class="hljs-slc">        self.coupon_id = self.session.get(</strong><strong class="hljs-string-slc">'coupon_id'</strong><strong class="hljs-slc">)</strong>
</code></pre>
<p class="normal">In this code, you try to get the <code class="inlineCode">coupon_id</code> session key from the current session and store its value in the <code class="inlineCode">Cart</code> object. Add<a id="_idIndexMarker932"/> the following methods highlighted in bold to the <code class="inlineCode">Cart</code> object:</p>
<pre class="programlisting code"><code class="hljs-code">class Cart:
    # ...
<strong class="hljs-meta-slc">    @property</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">coupon</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> self.coupon_id:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">try</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> Coupon.objects.get(</strong><strong class="hljs-built_in-slc">id</strong><strong class="hljs-slc">=self.coupon_id)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">except</strong><strong class="hljs-slc"> Coupon.DoesNotExist:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">pass</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> </strong><strong class="hljs-literal-slc">None</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">get_discount</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> self.coupon:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> (</strong>
<strong class="hljs-slc">                self.coupon.discount / Decimal(</strong><strong class="hljs-number-slc">100</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">            ) * self.get_total_price()</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> Decimal(</strong><strong class="hljs-number-slc">0</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">get_total_price_after_discount</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> self.get_total_price() - self.get_discount()</strong>
</code></pre>
<p class="normal">These methods are as follows:</p>
<ul>
<li class="bulletList"><code class="inlineCode">coupon()</code>: You define this method as a <code class="inlineCode">property</code>. If the cart contains a <code class="inlineCode">coupon_id</code> attribute, the <code class="inlineCode">Coupon</code> object with the given ID is returned.</li>
<li class="bulletList"><code class="inlineCode">get_discount()</code>: If the cart contains a coupon, you retrieve its discount rate and return the amount to be deducted from the total amount of the cart.</li>
<li class="bulletList"><code class="inlineCode">get_total_price_after_discount()</code>: You return the total amount of the cart after deducting the amount returned by the <code class="inlineCode">get_discount()</code> method.</li>
</ul>
<p class="normal">The <code class="inlineCode">Cart</code> class is now prepared to handle a coupon applied to the current session and apply the corresponding discount.</p>
<p class="normal">Let’s include the coupon system in the cart’s detail view. Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">cart</code> application and add the following import to the top of the file:</p>
<pre class="programlisting code"><code class="hljs-code">from coupons.forms import CouponApplyForm
</code></pre>
<p class="normal">Further down, edit<a id="_idIndexMarker933"/> the <code class="inlineCode">cart_detail</code> view and add the new form to it, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">def cart_detail(request):
    cart = Cart(request)
    for item in cart:
        item['update_quantity_form'] = CartAddProductForm(
            initial={'quantity': item['quantity'], 'override': True}
        )
<strong class="hljs-slc">    coupon_apply_form = CouponApplyForm()</strong>
return render(
        request,
        'cart/detail.html',
        {
            'cart': cart<strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'coupon_apply_form'</strong><strong class="hljs-slc">: coupon_apply_form</strong>
        }
    )
</code></pre>
<p class="normal">Edit the <code class="inlineCode">cart/detail.html</code> template of the <code class="inlineCode">cart</code> application and locate the following lines:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;tr class="total"&gt;
  &lt;td&gt;Total&lt;/td&gt;
  &lt;td colspan="4"&gt;&lt;/td&gt;
  &lt;td class="num"&gt;${{ cart.get_total_price }}&lt;/td&gt;
&lt;/tr&gt;
</code></pre>
<p class="normal">Replace them with the following code:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-slc">{% if cart.coupon %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">tr</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"subtotal"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">Subtotal</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">colspan</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"4"</strong><strong class="hljs-tag-slc">&gt;&lt;/</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"num"</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">${{ cart.get_total_price|floatformat:2 }}</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">tr</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">tr</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">      "{{ cart.coupon.code }}" coupon</strong>
<strong class="hljs-slc">      ({{ cart.coupon.discount }}% off)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">colspan</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"4"</strong><strong class="hljs-tag-slc">&gt;&lt;/</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"num neg"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">      - ${{ cart.get_discount|floatformat:2 }}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">tr</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">{% endif %}</strong>
&lt;tr class="total"&gt;
&lt;td&gt;Total&lt;/td&gt;
&lt;td colspan="4"&gt;&lt;/td&gt;
&lt;td class="num"&gt;
    ${{ cart.<strong class="hljs-slc">get_total_price_after_discount|floatformat:2</strong> }}
  &lt;/td&gt;
&lt;/tr&gt;
</code></pre>
<p class="normal">This is the code for displaying an optional coupon and its discount rate. If the cart contains a coupon, you<a id="_idIndexMarker934"/> display the first row, including the total amount of the cart as the subtotal. Then, you use a second row to display the current coupon applied to the cart. Finally, you display the total price, including any discount, by calling the <code class="inlineCode">get_total_price_after_discount()</code> method of the <code class="inlineCode">cart</code> object.</p>
<p class="normal">In the same file, include the following code after the <code class="inlineCode">&lt;/table&gt;</code> HTML tag:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;p&gt;Apply a coupon:&lt;/p&gt;
&lt;form action="{% url "coupons:apply" %}" method="post"&gt;
  {{ coupon_apply_form }}
  &lt;input type="submit" value="Apply"&gt;
  {% csrf_token %}
&lt;/form&gt;
</code></pre>
<p class="normal">This will display the form to enter a coupon code and apply it to the current cart.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/</code> in your browser and add a product to the cart. You will see that the shopping cart page now includes a form to apply a coupon:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_10_05.png"/></figure>
<p class="packt_figref">Figure 10.5: The cart detail page, including a form to apply a coupon</p>
<div><p class="normal">Image of <em class="italic">Tea powder</em>: Photo by Phuong Nguyen on Unsplash</p>
</div>
<p class="normal">In the <strong class="screenText">Code</strong> field, enter<a id="_idIndexMarker935"/> the coupon code you created using the administration site:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_10_06.png"/></figure>
<p class="packt_figref">Figure 10.6: The cart detail page, including a coupon code on the form</p>
<p class="normal">Click the <strong class="screenText">Apply</strong> button. The coupon will be applied, and the cart will display the coupon discount as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_10_07.png"/></figure>
<p class="packt_figref">Figure 10.7: The cart detail page, including the coupon applied</p>
<p class="normal">Let’s add the <a id="_idIndexMarker936"/>coupon to the next step of the purchase process. Edit the <code class="inlineCode">orders/order/create.html</code> template of the <code class="inlineCode">orders</code> application and locate the following lines:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;ul&gt;
  {% for item in cart %}
    &lt;li&gt;
      {{ item.quantity }}x {{ item.product.name }}
      &lt;span&gt;${{ item.total_price }}&lt;/span&gt;
&lt;/li&gt;
  {% endfor %}
&lt;/ul&gt;
</code></pre>
<p class="normal">Replace them with the following code:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;ul&gt;
  {% for item in cart %}
    &lt;li&gt;
      {{ item.quantity }}x {{ item.product.name }}
      &lt;span&gt;${{ item.total_price|floatformat:2 }}&lt;/span&gt;
&lt;/li&gt;
  {% endfor %}
<strong class="hljs-slc">  {% if cart.coupon %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">li</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">      "{{ cart.coupon.code }}" ({{ cart.coupon.discount }}% off)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">span</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"neg"</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">- ${{ cart.get_discount|floatformat:2 }}</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">span</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">li</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">  {% endif %}</strong>
&lt;/ul&gt;
</code></pre>
<p class="normal">The order summary <a id="_idIndexMarker937"/>should now include the coupon applied, if there is one. Now find the following line:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;p&gt;Total: ${{ cart.get_total_price }}&lt;/p&gt;
</code></pre>
<p class="normal">Replace it with the following:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;p&gt;Total: ${{ cart.<strong class="hljs-slc">get_total_price_after_discount|floatformat:2</strong> }}&lt;/p&gt;
</code></pre>
<p class="normal">By doing this, the total price will also be calculated by applying the discount of the coupon.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/orders/create/</code> in your browser. You should see that the order summary includes the applied coupon, as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_10_08.png"/></figure>
<p class="packt_figref">Figure 10.8: The order summary, including the coupon applied to the cart</p>
<p class="normal">Users can now<a id="_idIndexMarker938"/> apply coupons to their shopping carts. However, you still need to store coupon information in the order that it is created when users check out the cart.</p>
<h2 class="heading-2" id="_idParaDest-288">Applying coupons to orders</h2>
<p class="normal">You are going to<a id="_idIndexMarker939"/> store the coupon that was applied to each order. First, you need to modify the <code class="inlineCode">Order</code> model to store the related <code class="inlineCode">Coupon</code> object, if there is one.</p>
<p class="normal">Edit the <code class="inlineCode">models.py</code> file of the <code class="inlineCode">orders</code> application and add the following imports to it:</p>
<pre class="programlisting code"><code class="hljs-code">from decimal import Decimal
from django.core.validators import MaxValueValidator, MinValueValidator
from coupons.models import Coupon
</code></pre>
<p class="normal">Then, add the following fields to the <code class="inlineCode">Order</code> model:</p>
<pre class="programlisting code"><code class="hljs-code">class Order(models.Model):
    # ...
<strong class="hljs-slc">coupon = models.ForeignKey(</strong>
<strong class="hljs-slc">        Coupon,</strong>
<strong class="hljs-slc">        related_name=</strong><strong class="hljs-string-slc">'orders'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        null=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        blank=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        on_delete=models.SET_NULL</strong>
<strong class="hljs-slc">    )</strong>
<strong class="hljs-slc">    discount = models.IntegerField(</strong>
<strong class="hljs-slc">        default=</strong><strong class="hljs-number-slc">0</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        validators=[MinValueValidator(</strong><strong class="hljs-number-slc">0</strong><strong class="hljs-slc">), MaxValueValidator(</strong><strong class="hljs-number-slc">100</strong><strong class="hljs-slc">)]</strong>
<strong class="hljs-slc">    )</strong>
</code></pre>
<p class="normal">These fields allow you to store an optional coupon for the order and the discount percentage applied with the coupon. The discount is stored in the related <code class="inlineCode">Coupon</code> object, but you can include it in the <code class="inlineCode">Order</code> model to preserve it if the coupon has been modified or deleted. You set <code class="inlineCode">on_delete</code> to <code class="inlineCode">models.SET_NULL</code> so that if the coupon gets deleted, the <code class="inlineCode">coupon</code> field is set to <code class="inlineCode">Null</code>, but the discount is preserved.</p>
<p class="normal">You need to create a migration to include the new fields of the <code class="inlineCode">Order</code> model. Run the following command from the command line:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py makemigrations
</code></pre>
<p class="normal">You should see an output like the following:</p>
<pre class="programlisting con"><code class="hljs-con">Migrations for 'orders':
  orders/migrations/0003_order_coupon_order_discount.py
    - Add field coupon to order
    - Add field discount to order
</code></pre>
<p class="normal">Apply the new migration with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py migrate orders
</code></pre>
<p class="normal">You should see the<a id="_idIndexMarker940"/> following confirmation indicating that the new migration has been applied:</p>
<pre class="programlisting con"><code class="hljs-con">Applying orders.0003_order_coupon_order_discount... OK
</code></pre>
<p class="normal">The <code class="inlineCode">Order</code> model field changes are now synced with the database.</p>
<p class="normal">Edit the <code class="inlineCode">models.py</code> file, and add two new methods, <code class="inlineCode">get_total_cost_before_discount()</code> and <code class="inlineCode">get_discount()</code>, to the <code class="inlineCode">Order</code> model like this. The new code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">class Order(models.Model):
    # ...
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">get_total_cost_before_discount</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">sum</strong><strong class="hljs-slc">(item.get_cost() </strong><strong class="hljs-keyword-slc">for</strong><strong class="hljs-slc"> item </strong><strong class="hljs-keyword-slc">in</strong><strong class="hljs-slc"> self.items.</strong><strong class="hljs-built_in-slc">all</strong><strong class="hljs-slc">())</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">get_discount</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc">        total_cost = self.get_total_cost_before_discount()</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> self.discount:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> total_cost * (self.discount / Decimal(</strong><strong class="hljs-number-slc">100</strong><strong class="hljs-slc">))</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> Decimal(</strong><strong class="hljs-number-slc">0</strong><strong class="hljs-slc">)</strong>
</code></pre>
<p class="normal">Then, edit the <code class="inlineCode">get_total_cost()</code> method of the <code class="inlineCode">Order</code> model as follows. The new code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"> def get_total_cost(self):
<strong class="hljs-slc">        total_cost = self.get_total_cost_before_discount()</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> total_cost - self.get_discount()</strong>
</code></pre>
<p class="normal">The <code class="inlineCode">get_total_cost()</code> method of the <code class="inlineCode">Order</code> model will now take into account the discount applied, if there is one.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">orders</code> application and modify the <code class="inlineCode">order_create</code> view to save the related coupon and its discount when creating a new order. Add the following code highlighted in<a id="_idIndexMarker941"/> bold to the <code class="inlineCode">order_create</code> view:</p>
<pre class="programlisting code"><code class="hljs-code">def order_create(request):
    cart = Cart(request)
    if request.method == 'POST':
        form = OrderCreateForm(request.POST)
        if form.is_valid():
            order = form.save(<strong class="hljs-slc">commit=</strong><strong class="hljs-literal-slc">False</strong>)
            <strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> cart.coupon:</strong>
<strong class="hljs-slc">                order.coupon = cart.coupon</strong>
<strong class="hljs-slc">                order.discount = cart.coupon.discount</strong>
<strong class="hljs-slc">            order.save()</strong>
for item in cart:
                OrderItem.objects.create(
                    order=order,
                    product=item['product'],
                    price=item['price'],
                    quantity=item['quantity']
                )
            # clear the cart
            cart.clear()
            # launch asynchronous task
            order_created.delay(order.id)
            # set the order in the session
            request.session['order_id'] = order.id
# redirect for payment
return redirect('payment:process')
    else:
        form = OrderCreateForm()
    return render(
        request,
        'orders/order/create.html',
        {'cart': cart, 'form': form}
    )
</code></pre>
<p class="normal">In the new code, you create an <code class="inlineCode">Order</code> object using the <code class="inlineCode">save()</code> method of the <code class="inlineCode">OrderCreateForm</code> form. You avoid saving it to the database yet by using <code class="inlineCode">commit=False</code>. If the cart contains a coupon, you store the related coupon and the discount that was applied. Then, you save the <code class="inlineCode">order</code> object to the database.</p>
<p class="normal">Edit the <code class="inlineCode">payment/process.html</code> template of the <code class="inlineCode">payment</code> application and locate the following lines:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;tr class="total"&gt;
&lt;td&gt;Total&lt;/td&gt;
&lt;td colspan="4"&gt;&lt;/td&gt;
&lt;td class="num"&gt;${{ order.get_total_cost }}&lt;/td&gt;
&lt;/tr&gt;
</code></pre>
<p class="normal">Replace them with<a id="_idIndexMarker942"/> the following code. New lines are highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-slc">{% if order.coupon %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">tr</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"subtotal"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">Subtotal</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">colspan</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"3"</strong><strong class="hljs-tag-slc">&gt;&lt;/</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"num"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">      ${{ order.get_total_cost_before_discount|floatformat:2 }}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">tr</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">tr</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">      "{{ order.coupon.code }}" coupon</strong>
<strong class="hljs-slc">      ({{ order.discount }}% off)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">colspan</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"3"</strong><strong class="hljs-tag-slc">&gt;&lt;/</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"</strong><strong class="hljs-string-slc">num neg"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">      - ${{ order.get_discount|floatformat:2 }}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">tr</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">{% endif %}</strong>
&lt;tr class="total"&gt;
&lt;td&gt;Total&lt;/td&gt;
&lt;td colspan="3"&gt;&lt;/td&gt;
&lt;td class="num"&gt;
    ${{ order.get_total_cost<strong class="hljs-slc">|floatformat:2</strong> }}
  &lt;/td&gt;
&lt;/tr&gt;
</code></pre>
<p class="normal">We have updated the order summary before payment.</p>
<p class="normal">Make sure that the development server is running with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Make sure Docker is running, and execute the following command in another shell to start the RabbitMQ server with Docker:</p>
<pre class="programlisting con"><code class="hljs-con">docker run -it --rm --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3.13.1-management
</code></pre>
<p class="normal">Open another shell <a id="_idIndexMarker943"/>and start the Celery worker from your project directory with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">celery -A myshop worker -l info
</code></pre>
<p class="normal">Open an additional shell and execute the following command to forward Stripe events to your local webhook URL:</p>
<pre class="programlisting con"><code class="hljs-con">stripe listen --forward-to localhost:8000/payment/webhook/
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/</code> in your browser and create an order using the coupon you created. After validating the items in the shopping cart, on the <strong class="screenText">Order summary</strong> page, you will see the coupon applied to the order:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_10_09.png"/></figure>
<p class="packt_figref">Figure 10.9: The Order summary page, including the coupon applied to the order</p>
<p class="normal">If you click on <strong class="screenText">Pay now</strong>, you will see that Stripe is not aware of the discount applied, as displayed in <em class="italic">Figure 10.10</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_10_10.png"/></figure>
<p class="packt_figref">Figure 10.10: The item details of the Stripe Checkout page, including no discount coupon</p>
<p class="normal">Stripe shows the <a id="_idIndexMarker944"/>full amount to be paid without any deduction. This is because we are not passing on the discount to Stripe. Remember that in the <code class="inlineCode">payment_process</code> view, we pass the order items as <code class="inlineCode">line_items</code> to Stripe, including the cost and quantity of each order item.</p>
<h2 class="heading-2" id="_idParaDest-289">Creating coupons for Stripe Checkout</h2>
<p class="normal">Stripe allows<a id="_idIndexMarker945"/> you to define discount coupons and link them to one-time payments. You can find more information about creating discounts for Stripe Checkout at <a href="https://stripe.com/docs/payments/checkout/discounts">https://stripe.com/docs/payments/checkout/discounts</a>.</p>
<p class="normal">Let’s edit the <code class="inlineCode">payment_process</code> view to create a coupon for Stripe Checkout. Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">payment</code> application and add the following code highlighted in bold to the <code class="inlineCode">payment_process</code> view:</p>
<pre class="programlisting code"><code class="hljs-code">def payment_process(request):
    order_id = request.session.get('order_id')
    order = get_object_or_404(Order, id=order_id)
    if request.method == 'POST':
        success_url = request.build_absolute_uri(
            reverse('payment:completed')
        )
        cancel_url = request.build_absolute_uri(
            reverse('payment:canceled')
        )
        # Stripe checkout session data
        session_data = {
            'mode': 'payment',
            'client_reference_id': order.id,
            'success_url': success_url,
            'cancel_url': cancel_url,
            'line_items': []
        }
        # add order items to the Stripe checkout session
for item in order.items.all():
            session_data['line_items'].append(
                {
                    'price_data': {
                        'unit_amount': int(item.price * Decimal('100')),
                        'currency': 'usd',
                        'product_data': {
                            'name': item.product.name,
                        },
                    },
                    'quantity': item.quantity,
                }
            )
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># Stripe coupon</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> order.coupon:</strong>
<strong class="hljs-slc">            stripe_coupon = stripe.Coupon.create(</strong>
<strong class="hljs-slc">                name=order.coupon.code,</strong>
<strong class="hljs-slc">                percent_off=order.discount,</strong>
<strong class="hljs-slc">                duration=</strong><strong class="hljs-string-slc">'once'</strong>
<strong class="hljs-slc">            )</strong>
<strong class="hljs-slc">            session_data[</strong><strong class="hljs-string-slc">'discounts'</strong><strong class="hljs-slc">] = [{</strong><strong class="hljs-string-slc">'coupon'</strong><strong class="hljs-slc">: stripe_coupon.</strong><strong class="hljs-built_in-slc">id</strong><strong class="hljs-slc">}]</strong>
# create Stripe checkout session
        session = stripe.checkout.Session.create(**session_data)
        # redirect to Stripe payment form
return redirect(session.url, code=303)
    else:
        return render(request, 'payment/process.html', locals())
</code></pre>
<p class="normal">In the new code, you check if the order has a related coupon. In that case, you use the Stripe SDK to create <a id="_idIndexMarker946"/>a Stripe coupon using <code class="inlineCode">stripe.Coupon.create()</code>. You use the following attributes for the coupon:</p>
<ul>
<li class="bulletList"><code class="inlineCode">name</code>: The <code class="inlineCode">code</code> of the coupon related to the <code class="inlineCode">order</code> object is used.</li>
<li class="bulletList"><code class="inlineCode">percent_off</code>: The <code class="inlineCode">discount</code> of the <code class="inlineCode">order</code> object is issued.</li>
<li class="bulletList"><code class="inlineCode">duration</code>: The value <code class="inlineCode">once</code> is used. This indicates to Stripe that this is a coupon for a one-time payment.</li>
</ul>
<p class="normal">After creating the coupon, its <code class="inlineCode">id</code> is added to the <code class="inlineCode">session_data</code> dictionary used to create the Stripe Checkout session. This links the coupon to the checkout session.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/</code> in your browser and complete a purchase using the coupon you created. When redirected to the Stripe Checkout page, you will see the coupon applied:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_10_11.png"/></figure>
<p class="packt_figref">Figure 10.11: The item details of the Stripe Checkout page, including a discount coupon named SUMMER</p>
<p class="normal">The Stripe Checkout <a id="_idIndexMarker947"/>page now includes the order coupon, and the total amount to pay now includes the amount deducted using the coupon.</p>
<p class="normal">Complete the purchase and then open <code class="inlineCode">http://127.0.0.1:8000/admin/orders/order/</code> in your browser. Click on the <code class="inlineCode">order</code> object for which the coupon was used. The edit form will display the discount applied, as shown in <em class="italic">Figure 10.12</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_10_12.png"/></figure>
<p class="packt_figref">Figure 10.12: The order edit form, including the coupon and discount applied</p>
<p class="normal">You have successfully stored coupons for orders and processed payments with discounts. Next, you <a id="_idIndexMarker948"/>will add coupons to the order detail view of the administration site and to PDF invoices for orders.</p>
<h2 class="heading-2" id="_idParaDest-290">Adding coupons to orders on the administration site and to PDF invoices</h2>
<p class="normal">Let’s add <a id="_idIndexMarker949"/>the coupon to<a id="_idIndexMarker950"/> the order detail page on the administration site. Edit the <code class="inlineCode">admin/orders/order/detail.html</code> template of the <code class="inlineCode">orders</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">...
&lt;table style="width:100%"&gt;
...
&lt;tbody&gt;
    {% for item in order.items.all %}
      &lt;tr class="row{% cycle "1" "2" %}"&gt;
&lt;td&gt;{{ item.product.name }}&lt;/td&gt;
&lt;td class="num"&gt;${{ item.price }}&lt;/td&gt;
&lt;td class="num"&gt;{{ item.quantity }}&lt;/td&gt;
&lt;td class="num"&gt;${{ item.get_cost }}&lt;/td&gt;
&lt;/tr&gt;
    {% endfor %}
<strong class="hljs-slc">    {% if order.coupon %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">tr</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"subtotal"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">colspan</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"3"</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">Subtotal</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"num"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">          ${{ order.get_total_cost_before_discount|floatformat:2 }}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">tr</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">tr</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">colspan</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"3"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">          "{{ order.coupon.code }}" coupon</strong>
<strong class="hljs-slc">          ({{ order.discount }}% off)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"num neg"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">          - ${{ order.get_discount|floatformat:2 }}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">tr</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">    {% endif %}</strong>
&lt;tr class="total"&gt;
&lt;td colspan="3"&gt;Total&lt;/td&gt;
&lt;td class="num"&gt;
        ${{ order.get_total_cost<strong class="hljs-slc">|floatformat:2</strong> }}
      &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
...
</code></pre>
<p class="normal">Access <code class="inlineCode">http://127.0.0.1:8000/admin/orders/order/</code> with your browser, and click on the <strong class="screenText">View</strong> link of<a id="_idIndexMarker951"/> the <a id="_idIndexMarker952"/>latest order. The <strong class="screenText">Items bought</strong> table will now include the coupon used, as shown in <em class="italic">Figure 10.13</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_10_13.png"/></figure>
<p class="packt_figref">Figure 10.13: The product detail page on the administration site, including the coupon used</p>
<p class="normal">Now, let’s modify the order invoice template to include the coupon used for the order. Edit the <code class="inlineCode">orders/order/pdf.html</code> template of the <code class="inlineCode">orders</code> application and add the following<a id="_idIndexMarker953"/> code <a id="_idIndexMarker954"/>highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">...
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Product&lt;/th&gt;
&lt;th&gt;Price&lt;/th&gt;
&lt;th&gt;Quantity&lt;/th&gt;
&lt;th&gt;Cost&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
    {% for item in order.items.all %}
      &lt;tr class="row{% cycle "1" "2" %}"&gt;
&lt;td&gt;{{ item.product.name }}&lt;/td&gt;
&lt;td class="num"&gt;${{ item.price }}&lt;/td&gt;
&lt;td class="num"&gt;{{ item.quantity }}&lt;/td&gt;
&lt;td class="num"&gt;${{ item.get_cost }}&lt;/td&gt;
&lt;/tr&gt;
    {% endfor %}
<strong class="hljs-slc">    {% if order.coupon %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">tr</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"subtotal"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">colspan</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"3"</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">Subtotal</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"num"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">          ${{ order.get_total_cost_before_discount|floatformat:2 }}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">tr</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">tr</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">colspan</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"3"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">          "{{ order.coupon.code }}" coupon</strong>
<strong class="hljs-slc">          ({{ order.discount }}% off)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"num neg"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">          - ${{ order.get_discount|floatformat:2 }}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">td</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">tr</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">    {% endif %}</strong>
&lt;tr class="total"&gt;
&lt;td colspan="3"&gt;Total&lt;/td&gt;
&lt;td class="num"&gt;${{ order.get_total_cost<strong class="hljs-slc">|floatformat:2</strong> }}&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
...
</code></pre>
<p class="normal">Access <code class="inlineCode">http://127.0.0.1:8000/admin/orders/order/</code> with your browser, and click on the <strong class="screenText">PDF</strong> link of the <a id="_idIndexMarker955"/>latest <a id="_idIndexMarker956"/>order. The <strong class="screenText">Items bought</strong> table will now include the coupon used, as shown in <em class="italic">Figure 10.14</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_10_14.png"/></figure>
<p class="packt_figref">Figure 10.14: The PDF order invoice, including the coupon used</p>
<p class="normal">You successfully added a coupon system to your shop. Next, you are going to build a product recommendation engine.</p>
<h1 class="heading-1" id="_idParaDest-291">Building a recommendation engine</h1>
<p class="normal">A recommendation <a id="_idIndexMarker957"/>engine is a system that predicts the preference or rating that a user would give to an item. The system selects relevant items for a user based on their behavior and the knowledge it has about them. Nowadays, recommendation systems are used in many online services. They help users by selecting the stuff they might be interested in from the vast amount of available data that is irrelevant to them. Offering good recommendations enhances user engagement. E-commerce sites also benefit from offering relevant product recommendations by increasing their average revenue per user.</p>
<p class="normal">You are going to create a simple yet powerful recommendation engine that suggests products that are usually bought together. You will suggest products based on historical sales, thus identifying products that are usually bought together. You are going to suggest complementary products in two different scenarios:</p>
<ul>
<li class="bulletList"><strong class="screenText">Product detail page</strong>: You will display a list of products that are usually bought with the given product. This will be displayed as <em class="italic">users who bought this also bought X, Y, and Z</em>. You need a data structure that allows you to store the number of times each product has been bought together with the product being displayed.</li>
<li class="bulletList"><strong class="screenText">Cart detail page</strong>: Based on the products that users add to the cart, you are going to suggest products that are usually bought together with these ones. In this case, the score you calculate to obtain related products has to be aggregated.</li>
</ul>
<p class="normal">You are going to use Redis to store products that are usually purchased together. Remember that you already used Redis in <em class="italic">Chapter 7</em>, <em class="italic">Tracking User Actions</em>. If you haven’t installed Redis yet, you can find installation instructions in that chapter.</p>
<h2 class="heading-2" id="_idParaDest-292">Recommending products based on previous purchases</h2>
<p class="normal">We will <a id="_idIndexMarker958"/>recommend products to users based on items that are frequently bought together. For that, we are going to use Redis sorted sets. Remember that you used sorted sets in <em class="chapterRef">Chapter 7</em>, <em class="italic">Tracking User Actions</em>, to create a ranking of the most viewed images on your site.</p>
<p class="normal"><em class="italic">Figure 10.15</em> shows a representation of a sorted set, where set members are strings associated with a score:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_10_15.png"/></figure>
<p class="packt_figref">Figure 10.15: Redis sorted set representation</p>
<p class="normal">We are going to store a key in Redis for each product bought on the site. The product key will contain a Redis sorted set with scores. Every time a new purchase is completed, we will increment the score by 1 for each product bought together. The sorted set will allow you to give scores to products that are bought together. We will use the number of times the product is bought with another product as the score for that item.</p>
<p class="normal">Remember to <a id="_idIndexMarker959"/>install <code class="inlineCode">redis-py</code> in your environment using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install redis==5.0.4
</code></pre>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of your project and add the following settings to it:</p>
<pre class="programlisting code"><code class="hljs-code"># Redis settings
REDIS_HOST = 'localhost'
REDIS_PORT = 6379
REDIS_DB = 1
</code></pre>
<p class="normal">These are the settings required to establish a connection with the Redis server. Create a new file inside the <code class="inlineCode">shop</code> application directory and name it <code class="inlineCode">recommender.py</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">import redis
from django.conf import settings
from .models import Product
# connect to redis
r = redis.Redis(
    host=settings.REDIS_HOST,
    port=settings.REDIS_PORT,
    db=settings.REDIS_DB
)
class Recommender:
    def get_product_key(self, id):
        return f'product:{id}:purchased_with'
def products_bought(self, products):
        product_ids = [p.id for p in products]
        for product_id in product_ids:
            for with_id in product_ids:
                # get the other products bought with each product
if product_id != with_id:
                    # increment score for product purchased together
                    r.zincrby(
                        self.get_product_key(product_id), 1, with_id
                    )
</code></pre>
<p class="normal">This is the <code class="inlineCode">Recommender</code> class, which will allow you to store product purchases and retrieve product <a id="_idIndexMarker960"/>suggestions for a given product or products.</p>
<p class="normal">The <code class="inlineCode">get_product_key()</code> method receives the ID of a <code class="inlineCode">Product</code> object and builds the Redis key for the sorted set where related products are stored, which looks like <code class="inlineCode">product:[id]:purchased_with</code>.</p>
<p class="normal">The <code class="inlineCode">products_bought()</code> method receives a list of <code class="inlineCode">Product</code> objects that have been bought together (that is, belong to the same order).</p>
<p class="normal">In this method, you perform the following tasks:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">You get the product IDs for the given <code class="inlineCode">Product</code> objects.</li>
<li class="numberedList">You iterate over the product IDs. For each ID, you iterate again over the product IDs and skip the same product so that you get the products that are bought together with each product.</li>
<li class="numberedList">You get the Redis product key for each product bought using the <code class="inlineCode">get_product_id()</code> method. For a product with an ID of <code class="inlineCode">33</code>, this method returns the key <code class="inlineCode">product:33:purchased_with</code>. This is the key for the sorted set that contains the product IDs of products that were bought together with this one.</li>
<li class="numberedList">You increment the score of each product ID contained in the sorted set by 1 using the Redis <code class="inlineCode">ZINCRBY</code> operation. The score represents the number of times another product has been bought together with the given product.</li>
</ol>
<p class="normal"><em class="italic">Figure 10.16</em> shows an example of five different products with IDs 1 to 5 and five purchase orders <a id="_idIndexMarker961"/>of different combinations of products:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_10_16.png"/></figure>
<p class="packt_figref">Figure 10.16: Five products with respective IDs and purchase order combinations</p>
<p class="normal">In the figure, you can see a sorted set created in Redis for each product, with the key <code class="inlineCode">product:&lt;id&gt;:purchased_with</code>, where <code class="inlineCode">&lt;id&gt;</code> is the product’s unique identifier. The sorted set members are the IDs of the products that have been purchased alongside the principal product. The score for each member reflects the cumulative count of joint purchases. The figure shows the <code class="inlineCode">ZINCRBY</code> Redis operation to increment by 1 the score of products purchased together in one order.</p>
<p class="normal">You now have a method to store and score the products that were bought together. Next, you need a method to retrieve the products that were bought together for a list of given products. Add the <a id="_idIndexMarker962"/>following <code class="inlineCode">suggest_products_for()</code> method to the <code class="inlineCode">Recommender</code> class:</p>
<pre class="programlisting code"><code class="hljs-code">def suggest_products_for(self, products, max_results=6):
    product_ids = [p.id for p in products]
    if len(products) == 1:
        # only 1 product
        suggestions = r.zrange(
            self.get_product_key(product_ids[0]), 0, -1, desc=True
 )[:max_results]
    else:
        # generate a temporary key
        flat_ids = ''.join([str(id) for id in product_ids])
        tmp_key = f'tmp_{flat_ids}'
# multiple products, combine scores of all products
# store the resulting sorted set in a temporary key
        keys = [self.get_product_key(id) for id in product_ids]
        r.zunionstore(tmp_key, keys)
        # remove ids for the products the recommendation is for
        r.zrem(tmp_key, *product_ids)
        # get the product ids by their score, descendant sort
        suggestions = r.zrange(
            tmp_key, 0, -1, desc=True
 )[:max_results]
        # remove the temporary key
        r.delete(tmp_key)
    suggested_products_ids = [int(id) for id in suggestions]
    # get suggested products and sort by order of appearance
    suggested_products = list(
        Product.objects.filter(id__in=suggested_products_ids)
    )
    suggested_products.sort(
        key=lambda x: suggested_products_ids.index(x.id)
    )
    return suggested_products
</code></pre>
<p class="normal">The <code class="inlineCode">suggest_products_for()</code> method receives the following parameters:</p>
<ul>
<li class="bulletList"><code class="inlineCode">products</code>: This is a list of <code class="inlineCode">Product</code> objects to get recommendations for. It can contain one or more products.</li>
<li class="bulletList"><code class="inlineCode">max_results</code>: This is an integer that represents the maximum number of recommendations to return.</li>
</ul>
<p class="normal">In this method, you perform the following actions:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">You get the product IDs for the given <code class="inlineCode">Product</code> objects.</li>
<li class="numberedList">If only one product is given, you retrieve the ID of the products that were bought together with the given product, ordered by the total number of times that they were bought together. To do so, you use Redis’ <code class="inlineCode">ZRANGE</code> command. You limit the number of results to the number specified in the <code class="inlineCode">max_results</code> attribute (<code class="inlineCode">6</code> by default). You can read more about the <code class="inlineCode">ZRANGE</code> command at <a href="https://redis.io/commands/zrange/">https://redis.io/commands/zrange/</a>.</li>
<li class="numberedList">If more than one product is given, you generate a temporary Redis key built with the IDs of the products.</li>
<li class="numberedList">Combine and sum all scores for the items contained in the sorted set of each of the given products. This is done using the Redis <code class="inlineCode">ZUNIONSTORE</code> command. The <code class="inlineCode">ZUNIONSTORE</code> command<a id="_idIndexMarker963"/> performs a union of the sorted sets with the given keys and stores the aggregated sum of scores of the elements in a new Redis key. You can read more about this command at <a href="https://redis.io/commands/zunionstore/">https://redis.io/commands/zunionstore/</a>. You save the aggregated scores in the temporary key.</li>
<li class="numberedList">Since you are aggregating scores, you might obtain the same products you are getting recommendations for. You remove them from the generated sorted set using the <code class="inlineCode">ZREM</code> command. You can read more about the <code class="inlineCode">ZREM</code> command at <a href="https://redis.io/commands/zrem/">https://redis.io/commands/zrem/</a>.</li>
<li class="numberedList">You retrieve the IDs of the products from the temporary key, ordered by their scores using the <code class="inlineCode">ZRANGE</code> command. You limit the number of results to the number specified in the <code class="inlineCode">max_results</code> attribute.</li>
<li class="numberedList">Then, you remove the temporary key using the <code class="inlineCode">redis-py delete()</code> method that executes the Redis <code class="inlineCode">DEL</code> command. You can read more about the <code class="inlineCode">DEL</code> command at <a href="https://redis.io/commands/del/">https://redis.io/commands/del/</a>.</li>
<li class="numberedList">Finally, you get the <code class="inlineCode">Product</code> objects with the given IDs, and you order the products in the same order as the sorted set members.</li>
</ol>
<p class="normal"><em class="italic">Figure 10.17</em> shows an example of a session where two products have been added to the shopping cart and the Redis operations performed to obtain related product recommendations:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_10_17.png"/></figure>
<p class="packt_figref">Figure 10.17: Product recommendation system</p>
<p class="normal">In the figure, you <a id="_idIndexMarker964"/>can see the four steps to generate product recommendations for the items in the cart:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">The <code class="inlineCode">ZUNIONSTORE</code> Redis command is used to aggregate the scores of products purchased frequently with the products in the shopping cart. The resulting sorted set of this operation is stored in a new Redis key named after the IDs of the products in the shopping cart, <code class="inlineCode">tmp_34</code> for IDs <code class="inlineCode">3</code> and <code class="inlineCode">4</code>.</li>
<li class="numberedList">The <code class="inlineCode">ZREM</code> command is used to remove the products being purchased from the sorted set, to avoid recommending products that are already in the shopping cart.</li>
<li class="numberedList">The <code class="inlineCode">ZRANGE</code> command is used to return the <code class="inlineCode">tmp_34</code> sorted set members ordered by score.</li>
<li class="numberedList">Finally, the <code class="inlineCode">DEL</code> command is used to delete the Redis key <code class="inlineCode">tmp_34</code>.</li>
</ol>
<p class="normal">For practical purposes, let’s also add a method to clear the recommendations. Add the following method to the <code class="inlineCode">Recommender</code> class:</p>
<pre class="programlisting code"><code class="hljs-code">def clear_purchases(self):
    for id in Product.objects.values_list('id', flat=True):
        r.delete(self.get_product_key(id))
</code></pre>
<p class="normal">Let’s try the recommendation engine. Make sure you include several <code class="inlineCode">Product</code> objects in the database and initialize the Redis Docker container using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">docker run -it --rm --name redis -p 6379:6379 redis:7.2.4
</code></pre>
<p class="normal">Open another shell and run the following command to open the Python shell:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py shell
</code></pre>
<p class="normal">Make sure that you have at least four different products in your database. Retrieve four different products <a id="_idIndexMarker965"/>by their names:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; from shop.models import Product
&gt;&gt;&gt; black_tea = Product.objects.get(name='Black tea')
&gt;&gt;&gt; red_tea = Product.objects.get(name='Red tea')
&gt;&gt;&gt; green_tea = Product.objects.get(name='Green tea')
&gt;&gt;&gt; tea_powder = Product.objects.get(name='Tea powder')
</code></pre>
<p class="normal">Then, add some test purchases to the recommendation engine:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; from shop.recommender import Recommender
&gt;&gt;&gt; r = Recommender()
&gt;&gt;&gt; r.products_bought([black_tea, red_tea])
&gt;&gt;&gt; r.products_bought([black_tea, green_tea])
&gt;&gt;&gt; r.products_bought([red_tea, black_tea, tea_powder])
&gt;&gt;&gt; r.products_bought([green_tea, tea_powder])
&gt;&gt;&gt; r.products_bought([black_tea, tea_powder])
&gt;&gt;&gt; r.products_bought([red_tea, green_tea])
</code></pre>
<p class="normal">You have stored the following scores:</p>
<pre class="programlisting con"><code class="hljs-con">black_tea:  red_tea (2), tea_powder (2), green_tea (1)
red_tea:    black_tea (2), tea_powder (1), green_tea (1)
green_tea:  black_tea (1), tea_powder (1), red_tea(1)
tea_powder: black_tea (2), red_tea (1), green_tea (1)
</code></pre>
<p class="normal">This is a representation of products that have been bought together with each of the products, including how many times they have been bought together.</p>
<p class="normal">Let’s retrieve product recommendations for a single product:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; r.suggest_products_for([black_tea])
[&lt;Product: Tea powder&gt;, &lt;Product: Red tea&gt;, &lt;Product: Green tea&gt;]
&gt;&gt;&gt; r.suggest_products_for([red_tea])
[&lt;Product: Black tea&gt;, &lt;Product: Tea powder&gt;, &lt;Product: Green tea&gt;]
&gt;&gt;&gt; r.suggest_products_for([green_tea])
[&lt;Product: Black tea&gt;, &lt;Product: Tea powder&gt;, &lt;Product: Red tea&gt;]
&gt;&gt;&gt; r.suggest_products_for([tea_powder])
[&lt;Product: Black tea&gt;, &lt;Product: Red tea&gt;, &lt;Product: Green tea&gt;]
</code></pre>
<p class="normal">You can see that the order for recommended products is based on their score. Let’s get recommendations for multiple products with aggregated scores:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; r.suggest_products_for([black_tea, red_tea])
[&lt;Product: Tea powder&gt;, &lt;Product: Green tea&gt;]
&gt;&gt;&gt; r.suggest_products_for([green_tea, red_tea])
[&lt;Product: Black tea&gt;, &lt;Product: Tea powder&gt;]
&gt;&gt;&gt; r.suggest_products_for([tea_powder, black_tea])
[&lt;Product: Red tea&gt;, &lt;Product: Green tea&gt;]
</code></pre>
<p class="normal">You can see<a id="_idIndexMarker966"/> that the order of the suggested products matches the aggregated scores. For example, products suggested for <code class="inlineCode">black_tea</code> and <code class="inlineCode">red_tea</code> are <code class="inlineCode">tea_powder</code> (<code class="inlineCode">2+1</code>) and <code class="inlineCode">green_tea</code> (<code class="inlineCode">1+1</code>).</p>
<p class="normal">You have verified that your recommendation algorithm works as expected.</p>
<p class="normal">Let’s store the products that are bought together every time a payment is confirmed. Edit the <code class="inlineCode">webhooks.py</code> file of the <code class="inlineCode">payment</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"># ...
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> shop.models </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> Product</strong>
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> shop.recommender </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> Recommender</strong>
@csrf_exempt
def stripe_webhook(request):
    # ...
if event.type == 'checkout.session.completed':
        session = event.data.object
if (
            session.mode == 'payment'
and session.payment_status == 'paid'
        ):
            try:
                order = Order.objects.get(
                    id=session.client_reference_id
                )
            except Order.DoesNotExist:
                return HttpResponse(status=404)
            # mark order as paid
            order.paid = True
# store Stripe payment ID
            order.stripe_id = session.payment_intent
            order.save()
            <strong class="hljs-comment-slc"># save items bought for product recommendations</strong>
<strong class="hljs-slc">            product_ids = order.items.values_list(</strong><strong class="hljs-string-slc">'product_id'</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">            products = Product.objects.</strong><strong class="hljs-built_in-slc">filter</strong><strong class="hljs-slc">(id__in=product_ids)</strong>
<strong class="hljs-slc">            r = Recommender()</strong>
<strong class="hljs-slc">            r.products_bought(products)</strong>
# launch asynchronous task
            payment_completed.delay(order.id)
    return HttpResponse(status=200)
</code></pre>
<p class="normal">In the new code, when a<a id="_idIndexMarker967"/> new order payment is confirmed, you retrieve the <code class="inlineCode">Product</code> objects associated with the order items. Then, you create an instance of the <code class="inlineCode">Recommender</code> class and call the <code class="inlineCode">products_bought()</code> method to store the products bought together in Redis.</p>
<p class="normal">You are now storing the related products that are bought together when orders are paid. Let’s now display recommendations for products on your site.</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">shop</code> application. Add the functionality to retrieve a maximum of four recommended products into the <code class="inlineCode">product_detail</code> view, as follows:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> .recommender </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> Recommender</strong>
def product_detail(request, id, slug):
    product = get_object_or_404(
        Product, id=id, slug=slug, available=True
 )
    cart_product_form = CartAddProductForm()
<strong class="hljs-slc">    r = Recommender()</strong>
<strong class="hljs-slc">    recommended_products = r.suggest_products_for([product], </strong><strong class="hljs-number-slc">4</strong><strong class="hljs-slc">)</strong>
return render(
        request,
        'shop/product/detail.html',
        {
            'product': product,
            'cart_product_form': cart_product_form<strong class="hljs-slc">,</strong>
<strong class="hljs-string-slc">           'recommended_products'</strong><strong class="hljs-slc">: recommended_products</strong>
        }
    )
</code></pre>
<p class="normal">Edit the <code class="inlineCode">shop/product/detail.html</code> template of the <code class="inlineCode">shop</code> application and add the following code<a id="_idIndexMarker968"/> after <code class="inlineCode">{{ product.description|linebreaks }}</code>:</p>
<pre class="programlisting code"><code class="hljs-code">{% if recommended_products %}
  &lt;div class="recommendations"&gt;
&lt;h3&gt;People who bought this also bought&lt;/h3&gt;
    {% for p in recommended_products %}
      &lt;div class="item"&gt;
&lt;a href="{{ p.get_absolute_url }}"&gt;
&lt;img src="{% if p.image %}{{ p.image.url }}{% else %}
          {% static  "img/no_image.png" %}{% endif %}"&gt;
&lt;/a&gt;
&lt;p&gt;&lt;a href="{{ p.get_absolute_url }}"&gt;{{ p.name }}&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
    {% endfor %}
  &lt;/div&gt;
{% endif %}
</code></pre>
<p class="normal">Run the development server, and open <code class="inlineCode">http://127.0.0.1:8000/</code> in your browser. Click on any product to view its details. You should see that recommended products are displayed below the<a id="_idIndexMarker969"/> product, as shown in <em class="italic">Figure 10.18</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_10_18.png"/></figure>
<p class="packt_figref">Figure 10.18: The product detail page, including recommended products</p>
<div><p class="normal">Images in this chapter:</p>
<ul>
<li class="bulletList"><em class="italic">Green tea</em>: Photo by Jia Ye on Unsplash</li>
<li class="bulletList"><em class="italic">Red tea</em>: Photo by Manki Kim on Unsplash</li>
<li class="bulletList"><em class="italic">Tea powder</em>: Photo by Phuong Nguyen on Unsplash</li>
</ul>
</div>
<p class="normal">You are also going to include product recommendations in the cart. The recommendations will be based on the products that the user has added to the cart.</p>
<p class="normal">Edit <code class="inlineCode">views.py</code> inside the <code class="inlineCode">cart</code> application, import the <code class="inlineCode">Recommender</code> class, and edit the <code class="inlineCode">cart_detail</code> view to <a id="_idIndexMarker970"/>make it look like the following:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> shop.recommender </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> Recommender</strong>
def cart_detail(request):
    cart = Cart(request)
    for item in cart:
        item['update_quantity_form'] = CartAddProductForm(
            initial={'quantity': item['quantity'], 'override': True}
        )
    coupon_apply_form = CouponApplyForm()
<strong class="hljs-slc">    r = Recommender()</strong>
<strong class="hljs-slc">    cart_products = [item[</strong><strong class="hljs-string-slc">'product'</strong><strong class="hljs-slc">] </strong><strong class="hljs-keyword-slc">for</strong><strong class="hljs-slc"> item </strong><strong class="hljs-keyword-slc">in</strong><strong class="hljs-slc"> cart]</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc">(cart_products):</strong>
<strong class="hljs-slc">        recommended_products = r.suggest_products_for(</strong>
<strong class="hljs-slc">            cart_products, max_results=</strong><strong class="hljs-number-slc">4</strong>
<strong class="hljs-number-slc"> </strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">else</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">        recommended_products = []</strong>
return render(
        request,
        'cart/detail.html',
        {
            'cart': cart,
            'coupon_apply_form': coupon_apply_form<strong class="hljs-slc">,</strong>
<strong class="hljs-string-slc">           'recommended_products'</strong><strong class="hljs-slc">: recommended_products})</strong>
        }
    )
</code></pre>
<p class="normal">Edit the <code class="inlineCode">cart/detail.html</code> template of the <code class="inlineCode">cart</code> application and add the following code just after the <code class="inlineCode">&lt;/table&gt;</code> HTML tag:</p>
<pre class="programlisting code"><code class="hljs-code">{% if recommended_products %}
  &lt;div class="recommendations cart"&gt;
&lt;h3&gt;People who bought this also bought&lt;/h3&gt;
    {% for p in recommended_products %}
      &lt;div class="item"&gt;
&lt;a href="{{ p.get_absolute_url }}"&gt;
&lt;img src="{% if p.image %}{{ p.image.url }}{% else %}
          {% static "img/no_image.png" %}{% endif %}"&gt;
&lt;/a&gt;
&lt;p&gt;&lt;a href="{{ p.get_absolute_url }}"&gt;{{ p.name }}&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
    {% endfor %}
  &lt;/div&gt;
{% endif %}
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/en/</code> in your browser and add a couple of products to your cart. When you navigate to <code class="inlineCode">http://127.0.0.1:8000/en/cart/</code>, you should see the aggregated product<a id="_idIndexMarker971"/> recommendations for the items in the cart, as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_10_19.png"/></figure>
<p class="packt_figref">Figure 10.19: The shopping cart details page, including recommended products</p>
<p class="normal">Congratulations! You<a id="_idIndexMarker972"/> have built a complete recommendation engine using Django and Redis.</p>
<h1 class="heading-1" id="_idParaDest-293">Summary</h1>
<p class="normal">In this chapter, you created a coupon system using Django sessions and integrated it with Stripe. You also built a recommendation engine using Redis to recommend products that are usually purchased together.</p>
<p class="normal">The next chapter will give you an insight into the internationalization and localization of Django projects. You will learn how to translate code and manage translations with Rosetta. You will implement URLs for translations and build a language selector. You will also implement model translations using <code class="inlineCode">django-parler</code> and you will validate localized form fields using <code class="inlineCode">django-localflavor</code>.</p>
<h1 class="heading-1" id="_idParaDest-294">Additional resources</h1>
<p class="normal">The following resources provide additional information related to the topics covered in this chapter:</p>
<ul>
<li class="bulletList">Source code for this chapter: <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter10">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter10</a></li>
<li class="bulletList">Discounts for Stripe Checkout: <a href="https://stripe.com/docs/payments/checkout/discounts">https://stripe.com/docs/payments/checkout/discounts</a></li>
<li class="bulletList">The Redis <code class="inlineCode">ZRANGE</code> command: <a href="https://redis.io/commands/zrange/">https://redis.io/commands/zrange/</a></li>
<li class="bulletList">The Redis <code class="inlineCode">ZUNIONSTORE</code> command: <a href="https://redis.io/commands/zunionstore/">https://redis.io/commands/zunionstore/</a></li>
<li class="bulletList">The Redis <code class="inlineCode">ZREM</code> command: <a href="https://redis.io/commands/zrem/">https://redis.io/commands/zrem/</a></li>
<li class="bulletList">The Redis <code class="inlineCode">DEL</code> command: <a href="https://redis.io/commands/del/">https://redis.io/commands/del/</a></li>
</ul>
</div>
</body></html>