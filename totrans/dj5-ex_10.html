<html><head></head><body>
<div class="Basic-Text-Frame" id="_idContainer325">
<h1 class="chapterNumber"><span class="koboSpan" id="kobo.1.1">10</span></h1>
<h1 class="chapterTitle" id="_idParaDest-283"><span class="koboSpan" id="kobo.2.1">Extending Your Shop</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">In the previous chapter, you learned how to integrate a payment gateway into your shop. </span><span class="koboSpan" id="kobo.3.2">You also learned how to generate CSV and PDF files.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.4.1">In this chapter, you will add a coupon system to your shop and create a product recommendation engine.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.5.1">This chapter will cover the following points:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.6.1">Creating a coupon system</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.7.1">Applying coupons to the shopping cart</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.8.1">Applying coupons to orders</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.9.1">Creating coupons for Stripe Checkout</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.10.1">Storing products that are usually bought together</span></li>
<li class="bulletList"><span class="koboSpan" id="kobo.11.1">Building a product recommendation engine with Redis</span></li>
</ul>
<h1 class="heading-1" id="_idParaDest-284"><span class="koboSpan" id="kobo.12.1">Functional overview</span></h1>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.13.1">Figure 10.1</span></em><span class="koboSpan" id="kobo.14.1"> shows a representation of the views, templates, and functionalities that will be built in this chapter:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.15.1"><img alt="" role="presentation" src="../Images/B21088_10_01.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.16.1">Figure 10.1: Diagram of functionalities built in Chapter 10</span></p>
<p class="normal"><span class="koboSpan" id="kobo.17.1">In this chapter, you will build a new </span><code class="inlineCode"><span class="koboSpan" id="kobo.18.1">coupons</span></code><span class="koboSpan" id="kobo.19.1"> application and create the </span><code class="inlineCode"><span class="koboSpan" id="kobo.20.1">coupon_apply</span></code><span class="koboSpan" id="kobo.21.1"> view to apply discount coupons to the cart session. </span><span class="koboSpan" id="kobo.21.2">You will add the discount applied to the template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.22.1">cart_detail</span></code><span class="koboSpan" id="kobo.23.1"> view of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.24.1">cart</span></code><span class="koboSpan" id="kobo.25.1"> application. </span><span class="koboSpan" id="kobo.25.2">When an order is created with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.26.1">order_create</span></code><span class="koboSpan" id="kobo.27.1"> view of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.28.1">orders</span></code><span class="koboSpan" id="kobo.29.1"> application, you will save the coupon to the order created. </span><span class="koboSpan" id="kobo.29.2">Then, when you create the Stripe session in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.30.1">payment_process</span></code><span class="koboSpan" id="kobo.31.1"> view of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.32.1">payment</span></code><span class="koboSpan" id="kobo.33.1"> application, you will add the coupon to the Stripe checkout session before redirecting the user to Stripe to complete the payment. </span><span class="koboSpan" id="kobo.33.2">You will add the discount applied to the templates of the admin views </span><code class="inlineCode"><span class="koboSpan" id="kobo.34.1">admin_order_detail</span></code><span class="koboSpan" id="kobo.35.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.36.1">admin_order_pdf</span></code><span class="koboSpan" id="kobo.37.1"> of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.38.1">order</span></code><span class="koboSpan" id="kobo.39.1"> application. </span><span class="koboSpan" id="kobo.39.2">In addition to the coupon system, you will also implement a recommendation system. </span><span class="koboSpan" id="kobo.39.3">When the </span><code class="inlineCode"><span class="koboSpan" id="kobo.40.1">checkout.session.completed</span></code><span class="koboSpan" id="kobo.41.1"> Stripe event is received by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.42.1">stripe_webhook</span></code><span class="koboSpan" id="kobo.43.1"> view, you will save the products that have been bought together in Redis. </span><span class="koboSpan" id="kobo.43.2">You will add product recommendations to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.44.1">product_detail</span></code><span class="koboSpan" id="kobo.45.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.46.1">cart_detail</span></code><span class="koboSpan" id="kobo.47.1"> views by retrieving from Redis the items that are frequently bought together.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.48.1">The source code for this chapter can be found at </span><a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter10"><span class="url"><span class="koboSpan" id="kobo.49.1">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter10</span></span></a><span class="koboSpan" id="kobo.50.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.51.1">All the Python packages used in this chapter are included in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.52.1">requirements.txt</span></code><span class="koboSpan" id="kobo.53.1"> file in the source code for the chapter. </span><span class="koboSpan" id="kobo.53.2">You can follow the instructions to install each Python package in the following sections, or you can install all the requirements at once with the command </span><code class="inlineCode"><span class="koboSpan" id="kobo.54.1">python -m pip install -r requirements.txt</span></code><span class="koboSpan" id="kobo.55.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-285"><span class="koboSpan" id="kobo.56.1">Creating a coupon system</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.57.1">Many online shops</span><a id="_idIndexMarker923"/><span class="koboSpan" id="kobo.58.1"> give out coupons to customers that can be redeemed for discounts on their purchases. </span><span class="koboSpan" id="kobo.58.2">An online coupon usually consists of a code that is given to users and is valid for a specific time frame.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.59.1">You are going to create a coupon system for your shop. </span><span class="koboSpan" id="kobo.59.2">Your coupons will be valid for customers during a certain time frame. </span><span class="koboSpan" id="kobo.59.3">The coupons will not have any limitations in terms of the number of times they can be redeemed, and they will be applied to the total value of the shopping cart.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.60.1">For this functionality, you will need to create a model to store the coupon code, a valid time frame, and the discount to apply.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.61.1">Create a new application inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.62.1">myshop</span></code><span class="koboSpan" id="kobo.63.1"> project using the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.64.1">python manage.py startapp coupons
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.65.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.66.1">settings.py</span></code><span class="koboSpan" id="kobo.67.1"> file of </span><code class="inlineCode"><span class="koboSpan" id="kobo.68.1">myshop</span></code><span class="koboSpan" id="kobo.69.1"> and add the application to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.70.1">INSTALLED_APPS</span></code><span class="koboSpan" id="kobo.71.1"> setting, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.72.1">INSTALLED_APPS = [
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.73.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.74.1">'coupons.apps.CouponsConfig'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.75.1">,</span></strong></span><span class="koboSpan" id="kobo.76.1">
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.77.1">The new application is now active in your Django project.</span></p>
<h2 class="heading-2" id="_idParaDest-286"><span class="koboSpan" id="kobo.78.1">Building the coupon model</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.79.1">Let’s start by</span><a id="_idIndexMarker924"/><span class="koboSpan" id="kobo.80.1"> creating the </span><code class="inlineCode"><span class="koboSpan" id="kobo.81.1">Coupon</span></code><span class="koboSpan" id="kobo.82.1"> model. </span><span class="koboSpan" id="kobo.82.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.83.1">models.py</span></code><span class="koboSpan" id="kobo.84.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.85.1">coupons</span></code><span class="koboSpan" id="kobo.86.1"> application and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.87.1">from</span></span><span class="koboSpan" id="kobo.88.1"> django.core.validators </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.89.1">import</span></span><span class="koboSpan" id="kobo.90.1"> MaxValueValidator, MinValueValidator
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.91.1">from</span></span><span class="koboSpan" id="kobo.92.1"> django.db </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.93.1">import</span></span><span class="koboSpan" id="kobo.94.1"> models
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.95.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.96.1">Coupon</span></span><span class="koboSpan" id="kobo.97.1">(models.Model):
    code = models.CharField(max_length=</span><span class="hljs-number"><span class="koboSpan" id="kobo.98.1">50</span></span><span class="koboSpan" id="kobo.99.1">, unique=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.100.1">True</span></span><span class="koboSpan" id="kobo.101.1">)
    valid_from = models.DateTimeField()
    valid_to = models.DateTimeField()
    discount = models.IntegerField(
        validators=[MinValueValidator(</span><span class="hljs-number"><span class="koboSpan" id="kobo.102.1">0</span></span><span class="koboSpan" id="kobo.103.1">), MaxValueValidator(</span><span class="hljs-number"><span class="koboSpan" id="kobo.104.1">100</span></span><span class="koboSpan" id="kobo.105.1">)],
        help_text=</span><span class="hljs-string"><span class="koboSpan" id="kobo.106.1">'Percentage value (0 to 100)'</span></span>
<span class="hljs-string"> </span><span class="koboSpan" id="kobo.107.1">)
    active = models.BooleanField()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.108.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.109.1">__str__</span></span><span class="koboSpan" id="kobo.110.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.111.1">self</span></span><span class="koboSpan" id="kobo.112.1">):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.113.1">return</span></span><span class="koboSpan" id="kobo.114.1"> self.code
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.115.1">This is the model that you are going to use to store coupons. </span><span class="koboSpan" id="kobo.115.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.116.1">Coupon</span></code><span class="koboSpan" id="kobo.117.1"> model contains the following fields:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.118.1">code</span></code><span class="koboSpan" id="kobo.119.1">: The code that users have to enter in order to apply the coupon to their purchase.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.120.1">valid_from</span></code><span class="koboSpan" id="kobo.121.1">: The datetime value that indicates when the coupon becomes valid.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.122.1">valid_to</span></code><span class="koboSpan" id="kobo.123.1">: The datetime value that indicates when the coupon becomes invalid.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.124.1">discount</span></code><span class="koboSpan" id="kobo.125.1">: The discount rate to apply (this is a percentage, so it takes values from </span><code class="inlineCode"><span class="koboSpan" id="kobo.126.1">0</span></code><span class="koboSpan" id="kobo.127.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.128.1">100</span></code><span class="koboSpan" id="kobo.129.1">). </span><span class="koboSpan" id="kobo.129.2">You use validators for this field to limit the minimum and maximum accepted values.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.130.1">active</span></code><span class="koboSpan" id="kobo.131.1">: A Boolean that indicates whether the coupon is active.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.132.1">Run the following command to generate the initial migration for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.133.1">coupons</span></code><span class="koboSpan" id="kobo.134.1"> application:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.135.1">python manage.py makemigrations
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.136.1">The output should include the following lines:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.137.1">Migrations for 'coupons':
  coupons/migrations/0001_initial.py
    - Create model Coupon
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.138.1">Then, execute the next command to apply migrations:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.139.1">python manage.py migrate
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.140.1">You should see an output that includes the following line:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.141.1">Applying coupons.0001_initial... </span><span class="koboSpan" id="kobo.141.2">OK
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.142.1">The migrations have now been applied to the database. </span><span class="koboSpan" id="kobo.142.2">Let’s add the </span><code class="inlineCode"><span class="koboSpan" id="kobo.143.1">Coupon</span></code><span class="koboSpan" id="kobo.144.1"> model to the administration </span><a id="_idIndexMarker925"/><span class="koboSpan" id="kobo.145.1">site. </span><span class="koboSpan" id="kobo.145.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.146.1">admin.py</span></code><span class="koboSpan" id="kobo.147.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.148.1">coupons</span></code><span class="koboSpan" id="kobo.149.1"> application and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.150.1">from</span></span><span class="koboSpan" id="kobo.151.1"> django.contrib </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.152.1">import</span></span><span class="koboSpan" id="kobo.153.1"> admin
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.154.1">from</span></span><span class="koboSpan" id="kobo.155.1"> .models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.156.1">import</span></span><span class="koboSpan" id="kobo.157.1"> Coupon
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.158.1">@admin.register(</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.159.1">Coupon</span></span><span class="hljs-meta"><span class="koboSpan" id="kobo.160.1">)</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.161.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.162.1">CouponAdmin</span></span><span class="koboSpan" id="kobo.163.1">(admin.ModelAdmin):
    list_display = [
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.164.1">'code'</span></span><span class="koboSpan" id="kobo.165.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.166.1">'valid_from'</span></span><span class="koboSpan" id="kobo.167.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.168.1">'valid_to'</span></span><span class="koboSpan" id="kobo.169.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.170.1">'discount'</span></span><span class="koboSpan" id="kobo.171.1">,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.172.1">'active'</span></span>
<span class="hljs-string"> </span><span class="koboSpan" id="kobo.173.1">]
    list_filter = [</span><span class="hljs-string"><span class="koboSpan" id="kobo.174.1">'active'</span></span><span class="koboSpan" id="kobo.175.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.176.1">'valid_from'</span></span><span class="koboSpan" id="kobo.177.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.178.1">'valid_to'</span></span><span class="koboSpan" id="kobo.179.1">]
    search_fields = [</span><span class="hljs-string"><span class="koboSpan" id="kobo.180.1">'code'</span></span><span class="koboSpan" id="kobo.181.1">]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.182.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.183.1">Coupon</span></code><span class="koboSpan" id="kobo.184.1"> model is now registered on the administration site. </span><span class="koboSpan" id="kobo.184.2">Ensure that your local server is running with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.185.1">python manage.py runserver
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.186.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.187.1">http://127.0.0.1:8000/admin/coupons/coupon/add/</span></code><span class="koboSpan" id="kobo.188.1"> in your browser.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.189.1">You should see the following form:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.190.1"><img alt="" role="presentation" src="../Images/B21088_10_02.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.191.1">Figure 10.2: The Add coupon form on the Django administration site</span></p>
<p class="normal"><span class="koboSpan" id="kobo.192.1">Fill in the form to</span><a id="_idIndexMarker926"/><span class="koboSpan" id="kobo.193.1"> create a new coupon that is valid for the current date. </span><span class="koboSpan" id="kobo.193.2">Make sure that you check the </span><strong class="screenText"><span class="koboSpan" id="kobo.194.1">Active</span></strong><span class="koboSpan" id="kobo.195.1"> checkbox, and click the </span><strong class="screenText"><span class="koboSpan" id="kobo.196.1">SAVE</span></strong><span class="koboSpan" id="kobo.197.1"> button. </span><em class="italic"><span class="koboSpan" id="kobo.198.1">Figure 10.3</span></em><span class="koboSpan" id="kobo.199.1"> shows an example of creating a coupon:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.200.1"><img alt="" role="presentation" src="../Images/B21088_10_03.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.201.1">Figure 10.3: The Add coupon form with sample data</span></p>
<p class="normal"><span class="koboSpan" id="kobo.202.1">After creating the</span><a id="_idIndexMarker927"/><span class="koboSpan" id="kobo.203.1"> coupon, the coupon change list page on the administration site will look similar to </span><em class="italic"><span class="koboSpan" id="kobo.204.1">Figure 10.4</span></em><span class="koboSpan" id="kobo.205.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.206.1"><img alt="" role="presentation" src="../Images/B21088_10_04.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.207.1">Figure 10.4: The coupon change list page on the Django administration site</span></p>
<p class="normal"><span class="koboSpan" id="kobo.208.1">Next, we will</span><a id="_idIndexMarker928"/><span class="koboSpan" id="kobo.209.1"> implement the functionality to apply coupons to the shopping cart.</span></p>
<h2 class="heading-2" id="_idParaDest-287"><span class="koboSpan" id="kobo.210.1">Applying a coupon to the shopping cart</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.211.1">You can store new </span><a id="_idIndexMarker929"/><span class="koboSpan" id="kobo.212.1">coupons and make queries to retrieve existing coupons. </span><span class="koboSpan" id="kobo.212.2">Now you need a way for customers to apply coupons to their purchases. </span><span class="koboSpan" id="kobo.212.3">The functionality to apply a coupon would be as follows:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.213.1">The user adds products to the shopping cart.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.214.1">The user can enter a coupon code in a form displayed on the shopping cart details page.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.215.1">When the user enters a coupon code and submits the form, you look for an existing coupon with the given code that is currently valid. </span><span class="koboSpan" id="kobo.215.2">You have to check that the coupon code matches the one entered by the user, that the </span><code class="inlineCode"><span class="koboSpan" id="kobo.216.1">active</span></code><span class="koboSpan" id="kobo.217.1"> attribute is </span><code class="inlineCode"><span class="koboSpan" id="kobo.218.1">True</span></code><span class="koboSpan" id="kobo.219.1">, and that the current datetime is between the </span><code class="inlineCode"><span class="koboSpan" id="kobo.220.1">valid_from</span></code><span class="koboSpan" id="kobo.221.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.222.1">valid_to</span></code><span class="koboSpan" id="kobo.223.1"> values.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.224.1">If a coupon is found, you save it in the user’s session and display the cart, including the discount applied to it and the updated total amount.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.225.1">When the user places an order, you save the coupon to the given order.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.226.1">Create a new file inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.227.1">coupons</span></code><span class="koboSpan" id="kobo.228.1"> application directory and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.229.1">forms.py</span></code><span class="koboSpan" id="kobo.230.1">. </span><span class="koboSpan" id="kobo.230.2">Add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.231.1">from</span></span><span class="koboSpan" id="kobo.232.1"> django </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.233.1">import</span></span><span class="koboSpan" id="kobo.234.1"> forms
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.235.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.236.1">CouponApplyForm</span></span><span class="koboSpan" id="kobo.237.1">(forms.Form):
    code = forms.CharField()
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.238.1">This is the form that you are going to use for the user to enter a coupon code. </span><span class="koboSpan" id="kobo.238.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.239.1">views.py</span></code><span class="koboSpan" id="kobo.240.1"> file inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.241.1">coupons</span></code><span class="koboSpan" id="kobo.242.1"> application and add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.243.1">from</span></span><span class="koboSpan" id="kobo.244.1"> django.shortcuts </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.245.1">import</span></span><span class="koboSpan" id="kobo.246.1"> redirect
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.247.1">from</span></span><span class="koboSpan" id="kobo.248.1"> django.utils </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.249.1">import</span></span><span class="koboSpan" id="kobo.250.1"> timezone
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.251.1">from</span></span><span class="koboSpan" id="kobo.252.1"> django.views.decorators.http </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.253.1">import</span></span><span class="koboSpan" id="kobo.254.1"> require_POST
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.255.1">from</span></span><span class="koboSpan" id="kobo.256.1"> .forms </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.257.1">import</span></span><span class="koboSpan" id="kobo.258.1"> CouponApplyForm
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.259.1">from</span></span><span class="koboSpan" id="kobo.260.1"> .models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.261.1">import</span></span><span class="koboSpan" id="kobo.262.1"> Coupon
</span><span class="hljs-meta"><span class="koboSpan" id="kobo.263.1">@require_POST</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.264.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.265.1">coupon_apply</span></span><span class="koboSpan" id="kobo.266.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.267.1">request</span></span><span class="koboSpan" id="kobo.268.1">):
    now = timezone.now()
    form = CouponApplyForm(request.POST)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.269.1">if</span></span><span class="koboSpan" id="kobo.270.1"> form.is_valid():
        code = form.cleaned_data[</span><span class="hljs-string"><span class="koboSpan" id="kobo.271.1">'code'</span></span><span class="koboSpan" id="kobo.272.1">]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.273.1">try</span></span><span class="koboSpan" id="kobo.274.1">:
            coupon = Coupon.objects.get(
                code__iexact=code,
                valid_from__lte=now,
                valid_to__gte=now,
                active=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.275.1">True</span></span><span class="koboSpan" id="kobo.276.1">
            )
            request.session[</span><span class="hljs-string"><span class="koboSpan" id="kobo.277.1">'coupon_id'</span></span><span class="koboSpan" id="kobo.278.1">] = coupon.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.279.1">id</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.280.1">except</span></span><span class="koboSpan" id="kobo.281.1"> Coupon.DoesNotExist:
            request.session[</span><span class="hljs-string"><span class="koboSpan" id="kobo.282.1">'coupon_id'</span></span><span class="koboSpan" id="kobo.283.1">] = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.284.1">None</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.285.1">return</span></span><span class="koboSpan" id="kobo.286.1"> redirect(</span><span class="hljs-string"><span class="koboSpan" id="kobo.287.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.288.1">cart:cart_detail'</span></span><span class="koboSpan" id="kobo.289.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.290.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.291.1">coupon_apply</span></code><span class="koboSpan" id="kobo.292.1"> view validates the coupon and stores it in the user’s session. </span><span class="koboSpan" id="kobo.292.2">You apply the </span><code class="inlineCode"><span class="koboSpan" id="kobo.293.1">require_POST</span></code><span class="koboSpan" id="kobo.294.1"> decorator</span><a id="_idIndexMarker930"/><span class="koboSpan" id="kobo.295.1"> to this view to restrict it to </span><code class="inlineCode"><span class="koboSpan" id="kobo.296.1">POST</span></code><span class="koboSpan" id="kobo.297.1"> requests. </span><span class="koboSpan" id="kobo.297.2">In the view, you perform the following tasks:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.298.1">You instantiate the </span><code class="inlineCode"><span class="koboSpan" id="kobo.299.1">CouponApplyForm</span></code><span class="koboSpan" id="kobo.300.1"> form using the posted data and check that the form is valid.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.301.1">If the form is valid, you get the </span><code class="inlineCode"><span class="koboSpan" id="kobo.302.1">code</span></code><span class="koboSpan" id="kobo.303.1"> entered by the user from the form’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.304.1">cleaned_data</span></code><span class="koboSpan" id="kobo.305.1"> dictionary. </span><span class="koboSpan" id="kobo.305.2">You try to retrieve the </span><code class="inlineCode"><span class="koboSpan" id="kobo.306.1">Coupon</span></code><span class="koboSpan" id="kobo.307.1"> object with the given code. </span><span class="koboSpan" id="kobo.307.2">You use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.308.1">iexact</span></code><span class="koboSpan" id="kobo.309.1"> field lookup to perform a case-insensitive exact match. </span><span class="koboSpan" id="kobo.309.2">The coupon has to be currently active (</span><code class="inlineCode"><span class="koboSpan" id="kobo.310.1">active=True</span></code><span class="koboSpan" id="kobo.311.1">) and valid for the current datetime. </span><span class="koboSpan" id="kobo.311.2">You use Django’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.312.1">timezone.now()</span></code><span class="koboSpan" id="kobo.313.1"> function to get the current timezone-aware datetime, and you compare it with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.314.1">valid_from</span></code><span class="koboSpan" id="kobo.315.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.316.1">valid_to</span></code><span class="koboSpan" id="kobo.317.1"> fields by performing the </span><code class="inlineCode"><span class="koboSpan" id="kobo.318.1">lte</span></code><span class="koboSpan" id="kobo.319.1"> (less than or equal to) and </span><code class="inlineCode"><span class="koboSpan" id="kobo.320.1">gte</span></code><span class="koboSpan" id="kobo.321.1"> (greater than or equal to) field lookups, respectively.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.322.1">You store the coupon ID in the user’s session.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.323.1">You redirect the user to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.324.1">cart_detail</span></code><span class="koboSpan" id="kobo.325.1"> URL to display the cart with the coupon applied.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.326.1">You need a URL pattern for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.327.1">coupon_apply</span></code><span class="koboSpan" id="kobo.328.1"> view. </span><span class="koboSpan" id="kobo.328.2">Create a new file inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.329.1">coupons</span></code><span class="koboSpan" id="kobo.330.1"> application directory and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.331.1">urls.py</span></code><span class="koboSpan" id="kobo.332.1">. </span><span class="koboSpan" id="kobo.332.2">Add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.333.1">from</span></span><span class="koboSpan" id="kobo.334.1"> django.urls </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.335.1">import</span></span><span class="koboSpan" id="kobo.336.1"> path
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.337.1">from</span></span><span class="koboSpan" id="kobo.338.1"> . </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.339.1">import</span></span><span class="koboSpan" id="kobo.340.1"> views
app_name = </span><span class="hljs-string"><span class="koboSpan" id="kobo.341.1">'coupons'</span></span><span class="koboSpan" id="kobo.342.1">
urlpatterns = [
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.343.1">'apply/'</span></span><span class="koboSpan" id="kobo.344.1">, views.coupon_apply, name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.345.1">'apply'</span></span><span class="koboSpan" id="kobo.346.1">),
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.347.1">Then, edit the main </span><code class="inlineCode"><span class="koboSpan" id="kobo.348.1">urls.py</span></code><span class="koboSpan" id="kobo.349.1"> of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.350.1">myshop</span></code><span class="koboSpan" id="kobo.351.1"> project and include the </span><code class="inlineCode"><span class="koboSpan" id="kobo.352.1">coupons</span></code><span class="koboSpan" id="kobo.353.1"> URL patterns with the</span><a id="_idIndexMarker931"/><span class="koboSpan" id="kobo.354.1"> following line highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.355.1">urlpatterns = [
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.356.1">'admin/'</span></span><span class="koboSpan" id="kobo.357.1">, admin.site.urls),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.358.1">'cart/'</span></span><span class="koboSpan" id="kobo.359.1">, include(</span><span class="hljs-string"><span class="koboSpan" id="kobo.360.1">'cart.urls'</span></span><span class="koboSpan" id="kobo.361.1">, namespace=</span><span class="hljs-string"><span class="koboSpan" id="kobo.362.1">'cart'</span></span><span class="koboSpan" id="kobo.363.1">)),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.364.1">'orders/'</span></span><span class="koboSpan" id="kobo.365.1">, include(</span><span class="hljs-string"><span class="koboSpan" id="kobo.366.1">'orders.urls'</span></span><span class="koboSpan" id="kobo.367.1">, namespace=</span><span class="hljs-string"><span class="koboSpan" id="kobo.368.1">'orders'</span></span><span class="koboSpan" id="kobo.369.1">)),
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.370.1">'payment/'</span></span><span class="koboSpan" id="kobo.371.1">, include(</span><span class="hljs-string"><span class="koboSpan" id="kobo.372.1">'payment.urls'</span></span><span class="koboSpan" id="kobo.373.1">, namespace=</span><span class="hljs-string"><span class="koboSpan" id="kobo.374.1">'payment'</span></span><span class="koboSpan" id="kobo.375.1">)),
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.376.1">    path(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.377.1">'coupons/'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.378.1">, include(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.379.1">'coupons.urls'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.380.1">, namespace=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.381.1">'coupons'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.382.1">)),</span></strong></span><span class="koboSpan" id="kobo.383.1">
    path(</span><span class="hljs-string"><span class="koboSpan" id="kobo.384.1">''</span></span><span class="koboSpan" id="kobo.385.1">, include(</span><span class="hljs-string"><span class="koboSpan" id="kobo.386.1">'shop.urls'</span></span><span class="koboSpan" id="kobo.387.1">, namespace=</span><span class="hljs-string"><span class="koboSpan" id="kobo.388.1">'shop'</span></span><span class="koboSpan" id="kobo.389.1">)),
]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.390.1">Remember to place this pattern before the </span><code class="inlineCode"><span class="koboSpan" id="kobo.391.1">shop.urls</span></code><span class="koboSpan" id="kobo.392.1"> pattern.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.393.1">Now, edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.394.1">cart.py</span></code><span class="koboSpan" id="kobo.395.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.396.1">cart</span></code><span class="koboSpan" id="kobo.397.1"> application. </span><span class="koboSpan" id="kobo.397.2">Include the following import:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.398.1">from</span></span><span class="koboSpan" id="kobo.399.1"> coupons.models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.400.1">import</span></span><span class="koboSpan" id="kobo.401.1"> Coupon
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.402.1">Add the following code highlighted in bold to the end of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.403.1">__init__()</span></code><span class="koboSpan" id="kobo.404.1"> method of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.405.1">Cart</span></code><span class="koboSpan" id="kobo.406.1"> class to initialize the coupon from the current session:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.407.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.408.1">Cart</span></span><span class="koboSpan" id="kobo.409.1">:
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.410.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.411.1">__init__</span></span><span class="koboSpan" id="kobo.412.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.413.1">self, request</span></span><span class="koboSpan" id="kobo.414.1">):
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.415.1">"""</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.416.1">        Initialize the cart.</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.417.1">        """</span></span><span class="koboSpan" id="kobo.418.1">
        self.session = request.session
        cart = self.session.get(settings.CART_SESSION_ID)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.419.1">if</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.420.1">not</span></span><span class="koboSpan" id="kobo.421.1"> cart:
            </span><span class="hljs-comment"><span class="koboSpan" id="kobo.422.1"># save an empty cart in the session</span></span><span class="koboSpan" id="kobo.423.1">
            cart = self.session[settings.CART_SESSION_ID] = {}
        self.cart = cart
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.424.1"># store current applied coupon</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.425.1">        self.coupon_id = self.session.get(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.426.1">'coupon_id'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.427.1">)</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.428.1">In this code, you try to get the </span><code class="inlineCode"><span class="koboSpan" id="kobo.429.1">coupon_id</span></code><span class="koboSpan" id="kobo.430.1"> session key from the current session and store its value in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.431.1">Cart</span></code><span class="koboSpan" id="kobo.432.1"> object. </span><span class="koboSpan" id="kobo.432.2">Add</span><a id="_idIndexMarker932"/><span class="koboSpan" id="kobo.433.1"> the following methods highlighted in bold to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.434.1">Cart</span></code><span class="koboSpan" id="kobo.435.1"> object:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.436.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.437.1">Cart</span></span><span class="koboSpan" id="kobo.438.1">:
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.439.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-meta-slc"><span class="koboSpan" id="kobo.440.1">    @property</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.441.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.442.1">coupon</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.443.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.444.1">self</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.445.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.446.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.447.1"> self.coupon_id:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.448.1">try</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.449.1">:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.450.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.451.1"> Coupon.objects.get(</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.452.1">id</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.453.1">=self.coupon_id)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.454.1">except</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.455.1"> Coupon.DoesNotExist:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.456.1">pass</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.457.1">return</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.458.1">None</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.459.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.460.1">get_discount</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.461.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.462.1">self</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.463.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.464.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.465.1"> self.coupon:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.466.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.467.1"> (</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.468.1">                self.coupon.discount / Decimal(</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.469.1">100</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.470.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.471.1">            ) * self.get_total_price()</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.472.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.473.1"> Decimal(</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.474.1">0</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.475.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.476.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.477.1">get_total_price_after_discount</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.478.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.479.1">self</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.480.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.481.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.482.1"> self.get_total_price() - self.get_discount()</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.483.1">These methods are as follows:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.484.1">coupon()</span></code><span class="koboSpan" id="kobo.485.1">: You define this method as a </span><code class="inlineCode"><span class="koboSpan" id="kobo.486.1">property</span></code><span class="koboSpan" id="kobo.487.1">. </span><span class="koboSpan" id="kobo.487.2">If the cart contains a </span><code class="inlineCode"><span class="koboSpan" id="kobo.488.1">coupon_id</span></code><span class="koboSpan" id="kobo.489.1"> attribute, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.490.1">Coupon</span></code><span class="koboSpan" id="kobo.491.1"> object with the given ID is returned.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.492.1">get_discount()</span></code><span class="koboSpan" id="kobo.493.1">: If the cart contains a coupon, you retrieve its discount rate and return the amount to be deducted from the total amount of the cart.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.494.1">get_total_price_after_discount()</span></code><span class="koboSpan" id="kobo.495.1">: You return the total amount of the cart after deducting the amount returned by the </span><code class="inlineCode"><span class="koboSpan" id="kobo.496.1">get_discount()</span></code><span class="koboSpan" id="kobo.497.1"> method.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.498.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.499.1">Cart</span></code><span class="koboSpan" id="kobo.500.1"> class is now prepared to handle a coupon applied to the current session and apply the corresponding discount.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.501.1">Let’s include the coupon system in the cart’s detail view. </span><span class="koboSpan" id="kobo.501.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.502.1">views.py</span></code><span class="koboSpan" id="kobo.503.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.504.1">cart</span></code><span class="koboSpan" id="kobo.505.1"> application and add the following import to the top of the file:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.506.1">from</span></span><span class="koboSpan" id="kobo.507.1"> coupons.forms </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.508.1">import</span></span><span class="koboSpan" id="kobo.509.1"> CouponApplyForm
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.510.1">Further down, edit</span><a id="_idIndexMarker933"/><span class="koboSpan" id="kobo.511.1"> the </span><code class="inlineCode"><span class="koboSpan" id="kobo.512.1">cart_detail</span></code><span class="koboSpan" id="kobo.513.1"> view and add the new form to it, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.514.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.515.1">cart_detail</span></span><span class="koboSpan" id="kobo.516.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.517.1">request</span></span><span class="koboSpan" id="kobo.518.1">):
    cart = Cart(request)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.519.1">for</span></span><span class="koboSpan" id="kobo.520.1"> item </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.521.1">in</span></span><span class="koboSpan" id="kobo.522.1"> cart:
        item[</span><span class="hljs-string"><span class="koboSpan" id="kobo.523.1">'update_quantity_form'</span></span><span class="koboSpan" id="kobo.524.1">] = CartAddProductForm(
            initial={</span><span class="hljs-string"><span class="koboSpan" id="kobo.525.1">'quantity'</span></span><span class="koboSpan" id="kobo.526.1">: item[</span><span class="hljs-string"><span class="koboSpan" id="kobo.527.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.528.1">quantity'</span></span><span class="koboSpan" id="kobo.529.1">], </span><span class="hljs-string"><span class="koboSpan" id="kobo.530.1">'override'</span></span><span class="koboSpan" id="kobo.531.1">: </span><span class="hljs-literal"><span class="koboSpan" id="kobo.532.1">True</span></span><span class="koboSpan" id="kobo.533.1">}
        )
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.534.1">    coupon_apply_form = CouponApplyForm()</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.535.1">return</span></span><span class="koboSpan" id="kobo.536.1"> render(
        request,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.537.1">'cart/detail.html'</span></span><span class="koboSpan" id="kobo.538.1">,
        {
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.539.1">'cart'</span></span><span class="koboSpan" id="kobo.540.1">: cart</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.541.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.542.1">'coupon_apply_form'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.543.1">: coupon_apply_form</span></strong></span><span class="koboSpan" id="kobo.544.1">
        }
    )
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.545.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.546.1">cart/detail.html</span></code><span class="koboSpan" id="kobo.547.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.548.1">cart</span></code><span class="koboSpan" id="kobo.549.1"> application and locate the following lines:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.550.1">&lt;tr </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.551.1">class</span></span><span class="koboSpan" id="kobo.552.1">=</span><span class="hljs-string"><span class="koboSpan" id="kobo.553.1">"total"</span></span><span class="koboSpan" id="kobo.554.1">&gt;
  &lt;td&gt;Total&lt;/td&gt;
  &lt;td colspan=</span><span class="hljs-string"><span class="koboSpan" id="kobo.555.1">"4"</span></span><span class="koboSpan" id="kobo.556.1">&gt;&lt;/td&gt;
  &lt;td </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.557.1">class</span></span><span class="koboSpan" id="kobo.558.1">=</span><span class="hljs-string"><span class="koboSpan" id="kobo.559.1">"num"</span></span><span class="koboSpan" id="kobo.560.1">&gt;${{ cart.get_total_price }}&lt;/td&gt;
&lt;/tr&gt;
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.561.1">Replace them with the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.562.1">{% if cart.coupon %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.563.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.564.1">tr</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.565.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.566.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.567.1">"subtotal"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.568.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.569.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.570.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.571.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.572.1">Subtotal</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.573.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.574.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.575.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.576.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.577.1">td</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.578.1">colspan</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.579.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.580.1">"4"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.581.1">&gt;&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.582.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.583.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.584.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.585.1">td</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.586.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.587.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.588.1">"num"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.589.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.590.1">${{ cart.get_total_price|floatformat:2 }}</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.591.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.592.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.593.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.594.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.595.1">tr</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.596.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.597.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.598.1">tr</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.599.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.600.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.601.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.602.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.603.1">      "{{ cart.coupon.code }}" coupon</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.604.1">      ({{ cart.coupon.discount }}% off)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.605.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.606.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.607.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.608.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.609.1">td</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.610.1">colspan</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.611.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.612.1">"4"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.613.1">&gt;&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.614.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.615.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.616.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.617.1">td</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.618.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.619.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.620.1">"num neg"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.621.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.622.1">      - ${{ cart.get_discount|floatformat:2 }}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.623.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.624.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.625.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.626.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.627.1">tr</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.628.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.629.1">{% endif %}</span></strong></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.630.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.631.1">tr</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.632.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.633.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.634.1">"total"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.635.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.636.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.637.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.638.1">&gt;</span></span><span class="koboSpan" id="kobo.639.1">Total</span><span class="hljs-tag"><span class="koboSpan" id="kobo.640.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.641.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.642.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.643.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.644.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.645.1">colspan</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.646.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.647.1">"4"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.648.1">&gt;&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.649.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.650.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.651.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.652.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.653.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.654.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.655.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.656.1">&gt;</span></span><span class="koboSpan" id="kobo.657.1">
    ${{ cart.</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.658.1">get_total_price_after_discount|floatformat:2</span></strong></span><span class="koboSpan" id="kobo.659.1"> }}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.660.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.661.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.662.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.663.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.664.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.665.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.666.1">This is the code for displaying an optional coupon and its discount rate. </span><span class="koboSpan" id="kobo.666.2">If the cart contains a coupon, you</span><a id="_idIndexMarker934"/><span class="koboSpan" id="kobo.667.1"> display the first row, including the total amount of the cart as the subtotal. </span><span class="koboSpan" id="kobo.667.2">Then, you use a second row to display the current coupon applied to the cart. </span><span class="koboSpan" id="kobo.667.3">Finally, you display the total price, including any discount, by calling the </span><code class="inlineCode"><span class="koboSpan" id="kobo.668.1">get_total_price_after_discount()</span></code><span class="koboSpan" id="kobo.669.1"> method of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.670.1">cart</span></code><span class="koboSpan" id="kobo.671.1"> object.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.672.1">In the same file, include the following code after the </span><code class="inlineCode"><span class="koboSpan" id="kobo.673.1">&lt;/table&gt;</span></code><span class="koboSpan" id="kobo.674.1"> HTML tag:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.675.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.676.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.677.1">&gt;</span></span><span class="koboSpan" id="kobo.678.1">Apply a coupon:</span><span class="hljs-tag"><span class="koboSpan" id="kobo.679.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.680.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.681.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.682.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.683.1">form</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.684.1">action</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.685.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.686.1">"{% url "</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.687.1">coupons:apply</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.688.1">" %}"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.689.1">method</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.690.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.691.1">"post"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.692.1">&gt;</span></span><span class="koboSpan" id="kobo.693.1">
  {{ coupon_apply_form }}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.694.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.695.1">input</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.696.1">type</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.697.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.698.1">"submit"</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.699.1">value</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.700.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.701.1">"Apply"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.702.1">&gt;</span></span><span class="koboSpan" id="kobo.703.1">
  {% csrf_token %}
</span><span class="hljs-tag"><span class="koboSpan" id="kobo.704.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.705.1">form</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.706.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.707.1">This will display the form to enter a coupon code and apply it to the current cart.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.708.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.709.1">http://127.0.0.1:8000/</span></code><span class="koboSpan" id="kobo.710.1"> in your browser and add a product to the cart. </span><span class="koboSpan" id="kobo.710.2">You will see that the shopping cart page now includes a form to apply a coupon:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.711.1"><img alt="" role="presentation" src="../Images/B21088_10_05.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.712.1">Figure 10.5: The cart detail page, including a form to apply a coupon</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.713.1">Image of </span><em class="italic"><span class="koboSpan" id="kobo.714.1">Tea powder</span></em><span class="koboSpan" id="kobo.715.1">: Photo by Phuong Nguyen on Unsplash</span></p>
</div>
<p class="normal"><span class="koboSpan" id="kobo.716.1">In the </span><strong class="screenText"><span class="koboSpan" id="kobo.717.1">Code</span></strong><span class="koboSpan" id="kobo.718.1"> field, enter</span><a id="_idIndexMarker935"/><span class="koboSpan" id="kobo.719.1"> the coupon code you created using the administration site:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.720.1"><img alt="" role="presentation" src="../Images/B21088_10_06.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.721.1">Figure 10.6: The cart detail page, including a coupon code on the form</span></p>
<p class="normal"><span class="koboSpan" id="kobo.722.1">Click the </span><strong class="screenText"><span class="koboSpan" id="kobo.723.1">Apply</span></strong><span class="koboSpan" id="kobo.724.1"> button. </span><span class="koboSpan" id="kobo.724.2">The coupon will be applied, and the cart will display the coupon discount as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.725.1"><img alt="" role="presentation" src="../Images/B21088_10_07.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.726.1">Figure 10.7: The cart detail page, including the coupon applied</span></p>
<p class="normal"><span class="koboSpan" id="kobo.727.1">Let’s add the </span><a id="_idIndexMarker936"/><span class="koboSpan" id="kobo.728.1">coupon to the next step of the purchase process. </span><span class="koboSpan" id="kobo.728.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.729.1">orders/order/create.html</span></code><span class="koboSpan" id="kobo.730.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.731.1">orders</span></code><span class="koboSpan" id="kobo.732.1"> application and locate the following lines:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.733.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.734.1">ul</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.735.1">&gt;</span></span><span class="koboSpan" id="kobo.736.1">
  {% for item in cart %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.737.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.738.1">li</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.739.1">&gt;</span></span><span class="koboSpan" id="kobo.740.1">
      {{ item.quantity }}x {{ item.product.name }}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.741.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.742.1">span</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.743.1">&gt;</span></span><span class="koboSpan" id="kobo.744.1">${{ item.total_price }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.745.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.746.1">span</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.747.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.748.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.749.1">li</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.750.1">&gt;</span></span><span class="koboSpan" id="kobo.751.1">
  {% endfor %}
</span><span class="hljs-tag"><span class="koboSpan" id="kobo.752.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.753.1">ul</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.754.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.755.1">Replace them with the following code:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.756.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.757.1">ul</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.758.1">&gt;</span></span><span class="koboSpan" id="kobo.759.1">
  {% for item in cart %}
    </span><span class="hljs-tag"><span class="koboSpan" id="kobo.760.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.761.1">li</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.762.1">&gt;</span></span><span class="koboSpan" id="kobo.763.1">
      {{ item.quantity }}x {{ item.product.name }}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.764.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.765.1">span</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.766.1">&gt;</span></span><span class="koboSpan" id="kobo.767.1">${{ item.total_price|floatformat:2 }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.768.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.769.1">span</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.770.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.771.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.772.1">li</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.773.1">&gt;</span></span><span class="koboSpan" id="kobo.774.1">
  {% endfor %}
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.775.1">  {% if cart.coupon %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.776.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.777.1">li</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.778.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.779.1">      "{{ cart.coupon.code }}" ({{ cart.coupon.discount }}% off)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.780.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.781.1">span</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.782.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.783.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.784.1">"neg"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.785.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.786.1">- ${{ cart.get_discount|floatformat:2 }}</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.787.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.788.1">span</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.789.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.790.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.791.1">li</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.792.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.793.1">  {% endif %}</span></strong></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.794.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.795.1">ul</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.796.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.797.1">The order summary </span><a id="_idIndexMarker937"/><span class="koboSpan" id="kobo.798.1">should now include the coupon applied, if there is one. </span><span class="koboSpan" id="kobo.798.2">Now find the following line:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.799.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.800.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.801.1">&gt;</span></span><span class="koboSpan" id="kobo.802.1">Total: ${{ cart.get_total_price }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.803.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.804.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.805.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.806.1">Replace it with the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.807.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.808.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.809.1">&gt;</span></span><span class="koboSpan" id="kobo.810.1">Total: ${{ cart.</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.811.1">get_total_price_after_discount|floatformat:2</span></strong></span><span class="koboSpan" id="kobo.812.1"> }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.813.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.814.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.815.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.816.1">By doing this, the total price will also be calculated by applying the discount of the coupon.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.817.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.818.1">http://127.0.0.1:8000/orders/create/</span></code><span class="koboSpan" id="kobo.819.1"> in your browser. </span><span class="koboSpan" id="kobo.819.2">You should see that the order summary includes the applied coupon, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.820.1"><img alt="" role="presentation" src="../Images/B21088_10_08.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.821.1">Figure 10.8: The order summary, including the coupon applied to the cart</span></p>
<p class="normal"><span class="koboSpan" id="kobo.822.1">Users can now</span><a id="_idIndexMarker938"/><span class="koboSpan" id="kobo.823.1"> apply coupons to their shopping carts. </span><span class="koboSpan" id="kobo.823.2">However, you still need to store coupon information in the order that it is created when users check out the cart.</span></p>
<h2 class="heading-2" id="_idParaDest-288"><span class="koboSpan" id="kobo.824.1">Applying coupons to orders</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.825.1">You are going to</span><a id="_idIndexMarker939"/><span class="koboSpan" id="kobo.826.1"> store the coupon that was applied to each order. </span><span class="koboSpan" id="kobo.826.2">First, you need to modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.827.1">Order</span></code><span class="koboSpan" id="kobo.828.1"> model to store the related </span><code class="inlineCode"><span class="koboSpan" id="kobo.829.1">Coupon</span></code><span class="koboSpan" id="kobo.830.1"> object, if there is one.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.831.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.832.1">models.py</span></code><span class="koboSpan" id="kobo.833.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.834.1">orders</span></code><span class="koboSpan" id="kobo.835.1"> application and add the following imports to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.836.1">from</span></span><span class="koboSpan" id="kobo.837.1"> decimal </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.838.1">import</span></span><span class="koboSpan" id="kobo.839.1"> Decimal
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.840.1">from</span></span><span class="koboSpan" id="kobo.841.1"> django.core.validators </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.842.1">import</span></span><span class="koboSpan" id="kobo.843.1"> MaxValueValidator, MinValueValidator
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.844.1">from</span></span><span class="koboSpan" id="kobo.845.1"> coupons.models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.846.1">import</span></span><span class="koboSpan" id="kobo.847.1"> Coupon
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.848.1">Then, add the following fields to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.849.1">Order</span></code><span class="koboSpan" id="kobo.850.1"> model:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.851.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.852.1">Order</span></span><span class="koboSpan" id="kobo.853.1">(models.Model):
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.854.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.855.1">coupon = models.ForeignKey(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.856.1">        Coupon,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.857.1">        related_name=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.858.1">'orders'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.859.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.860.1">        null=</span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.861.1">True</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.862.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.863.1">        blank=</span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.864.1">True</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.865.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.866.1">        on_delete=models.SET_NULL</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.867.1">    )</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.868.1">    discount = models.IntegerField(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.869.1">        default=</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.870.1">0</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.871.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.872.1">        validators=[MinValueValidator(</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.873.1">0</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.874.1">), MaxValueValidator(</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.875.1">100</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.876.1">)]</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.877.1">    )</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.878.1">These fields allow you to store an optional coupon for the order and the discount percentage applied with the coupon. </span><span class="koboSpan" id="kobo.878.2">The discount is stored in the related </span><code class="inlineCode"><span class="koboSpan" id="kobo.879.1">Coupon</span></code><span class="koboSpan" id="kobo.880.1"> object, but you can include it in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.881.1">Order</span></code><span class="koboSpan" id="kobo.882.1"> model to preserve it if the coupon has been modified or deleted. </span><span class="koboSpan" id="kobo.882.2">You set </span><code class="inlineCode"><span class="koboSpan" id="kobo.883.1">on_delete</span></code><span class="koboSpan" id="kobo.884.1"> to </span><code class="inlineCode"><span class="koboSpan" id="kobo.885.1">models.SET_NULL</span></code><span class="koboSpan" id="kobo.886.1"> so that if the coupon gets deleted, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.887.1">coupon</span></code><span class="koboSpan" id="kobo.888.1"> field is set to </span><code class="inlineCode"><span class="koboSpan" id="kobo.889.1">Null</span></code><span class="koboSpan" id="kobo.890.1">, but the discount is preserved.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.891.1">You need to create a migration to include the new fields of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.892.1">Order</span></code><span class="koboSpan" id="kobo.893.1"> model. </span><span class="koboSpan" id="kobo.893.2">Run the following command from the command line:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.894.1">python manage.py makemigrations
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.895.1">You should see an output like the following:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.896.1">Migrations for 'orders':
  orders/migrations/0003_order_coupon_order_discount.py
    - Add field coupon to order
    - Add field discount to order
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.897.1">Apply the new migration with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.898.1">python manage.py migrate orders
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.899.1">You should see the</span><a id="_idIndexMarker940"/><span class="koboSpan" id="kobo.900.1"> following confirmation indicating that the new migration has been applied:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.901.1">Applying orders.0003_order_coupon_order_discount... </span><span class="koboSpan" id="kobo.901.2">OK
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.902.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.903.1">Order</span></code><span class="koboSpan" id="kobo.904.1"> model field changes are now synced with the database.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.905.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.906.1">models.py</span></code><span class="koboSpan" id="kobo.907.1"> file, and add two new methods, </span><code class="inlineCode"><span class="koboSpan" id="kobo.908.1">get_total_cost_before_discount()</span></code><span class="koboSpan" id="kobo.909.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.910.1">get_discount()</span></code><span class="koboSpan" id="kobo.911.1">, to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.912.1">Order</span></code><span class="koboSpan" id="kobo.913.1"> model like this. </span><span class="koboSpan" id="kobo.913.2">The new code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.914.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.915.1">Order</span></span><span class="koboSpan" id="kobo.916.1">(models.Model):
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.917.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.918.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.919.1">get_total_cost_before_discount</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.920.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.921.1">self</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.922.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.923.1">return</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.924.1">sum</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.925.1">(item.get_cost() </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.926.1">for</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.927.1"> item </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.928.1">in</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.929.1"> self.items.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.930.1">all</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.931.1">())</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.932.1">def</span></strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc"><span class="koboSpan" id="kobo.933.1">get_discount</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.934.1">(</span></strong><strong class="hljs-params-slc"><span class="koboSpan" id="kobo.935.1">self</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.936.1">):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.937.1">        total_cost = self.get_total_cost_before_discount()</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.938.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.939.1"> self.discount:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.940.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.941.1"> total_cost * (self.discount / Decimal(</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.942.1">100</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.943.1">))</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.944.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.945.1"> Decimal(</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.946.1">0</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.947.1">)</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.948.1">Then, edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.949.1">get_total_cost()</span></code><span class="koboSpan" id="kobo.950.1"> method of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.951.1">Order</span></code><span class="koboSpan" id="kobo.952.1"> model as follows. </span><span class="koboSpan" id="kobo.952.2">The new code is highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.953.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.954.1">get_total_cost</span></span><span class="koboSpan" id="kobo.955.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.956.1">self</span></span><span class="koboSpan" id="kobo.957.1">):
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.958.1">        total_cost = self.get_total_cost_before_discount()</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.959.1">return</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.960.1"> total_cost - self.get_discount()</span></strong></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.961.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.962.1">get_total_cost()</span></code><span class="koboSpan" id="kobo.963.1"> method of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.964.1">Order</span></code><span class="koboSpan" id="kobo.965.1"> model will now take into account the discount applied, if there is one.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.966.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.967.1">views.py</span></code><span class="koboSpan" id="kobo.968.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.969.1">orders</span></code><span class="koboSpan" id="kobo.970.1"> application and modify the </span><code class="inlineCode"><span class="koboSpan" id="kobo.971.1">order_create</span></code><span class="koboSpan" id="kobo.972.1"> view to save the related coupon and its discount when creating a new order. </span><span class="koboSpan" id="kobo.972.2">Add the following code highlighted in</span><a id="_idIndexMarker941"/><span class="koboSpan" id="kobo.973.1"> bold to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.974.1">order_create</span></code><span class="koboSpan" id="kobo.975.1"> view:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.976.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.977.1">order_create</span></span><span class="koboSpan" id="kobo.978.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.979.1">request</span></span><span class="koboSpan" id="kobo.980.1">):
    cart = Cart(request)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.981.1">if</span></span><span class="koboSpan" id="kobo.982.1"> request.method == </span><span class="hljs-string"><span class="koboSpan" id="kobo.983.1">'POST'</span></span><span class="koboSpan" id="kobo.984.1">:
        form = OrderCreateForm(request.POST)
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.985.1">if</span></span><span class="koboSpan" id="kobo.986.1"> form.is_valid():
            order = form.save(</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.987.1">commit=</span></strong><strong class="hljs-literal-slc"><span class="koboSpan" id="kobo.988.1">False</span></strong></span><span class="koboSpan" id="kobo.989.1">)
            </span><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.990.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.991.1"> cart.coupon:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.992.1">                order.coupon = cart.coupon</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.993.1">                order.discount = cart.coupon.discount</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.994.1">            order.save()</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.995.1">for</span></span><span class="koboSpan" id="kobo.996.1"> item </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.997.1">in</span></span><span class="koboSpan" id="kobo.998.1"> cart:
                OrderItem.objects.create(
                    order=order,
                    product=item[</span><span class="hljs-string"><span class="koboSpan" id="kobo.999.1">'product'</span></span><span class="koboSpan" id="kobo.1000.1">],
                    price=item[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1001.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1002.1">price'</span></span><span class="koboSpan" id="kobo.1003.1">],
                    quantity=item[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1004.1">'quantity'</span></span><span class="koboSpan" id="kobo.1005.1">]
                )
            </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1006.1"># clear the cart</span></span><span class="koboSpan" id="kobo.1007.1">
            cart.clear()
            </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1008.1"># launch asynchronous task</span></span><span class="koboSpan" id="kobo.1009.1">
            order_created.delay(order.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1010.1">id</span></span><span class="koboSpan" id="kobo.1011.1">)
            </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1012.1"># set the order in the session</span></span><span class="koboSpan" id="kobo.1013.1">
            request.session[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1014.1">'order_id'</span></span><span class="koboSpan" id="kobo.1015.1">] = order.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1016.1">id</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1017.1"># redirect for payment</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1018.1">return</span></span><span class="koboSpan" id="kobo.1019.1"> redirect(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1020.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1021.1">payment:process'</span></span><span class="koboSpan" id="kobo.1022.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1023.1">else</span></span><span class="koboSpan" id="kobo.1024.1">:
        form = OrderCreateForm()
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1025.1">return</span></span><span class="koboSpan" id="kobo.1026.1"> render(
        request,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1027.1">'orders/order/create.html'</span></span><span class="koboSpan" id="kobo.1028.1">,
        {</span><span class="hljs-string"><span class="koboSpan" id="kobo.1029.1">'cart'</span></span><span class="koboSpan" id="kobo.1030.1">: cart, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1031.1">'form'</span></span><span class="koboSpan" id="kobo.1032.1">: form}
    )
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1033.1">In the new code, you create an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1034.1">Order</span></code><span class="koboSpan" id="kobo.1035.1"> object using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1036.1">save()</span></code><span class="koboSpan" id="kobo.1037.1"> method of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1038.1">OrderCreateForm</span></code><span class="koboSpan" id="kobo.1039.1"> form. </span><span class="koboSpan" id="kobo.1039.2">You avoid saving it to the database yet by using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1040.1">commit=False</span></code><span class="koboSpan" id="kobo.1041.1">. </span><span class="koboSpan" id="kobo.1041.2">If the cart contains a coupon, you store the related coupon and the discount that was applied. </span><span class="koboSpan" id="kobo.1041.3">Then, you save the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1042.1">order</span></code><span class="koboSpan" id="kobo.1043.1"> object to the database.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1044.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1045.1">payment/process.html</span></code><span class="koboSpan" id="kobo.1046.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1047.1">payment</span></code><span class="koboSpan" id="kobo.1048.1"> application and locate the following lines:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-tag"><span class="koboSpan" id="kobo.1049.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1050.1">tr</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1051.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1052.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1053.1">"total"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1054.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1055.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1056.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1057.1">&gt;</span></span><span class="koboSpan" id="kobo.1058.1">Total</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1059.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1060.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1061.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1062.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1063.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1064.1">colspan</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1065.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1066.1">"4"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1067.1">&gt;&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1068.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1069.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1070.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1071.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1072.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1073.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1074.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1075.1">&gt;</span></span><span class="koboSpan" id="kobo.1076.1">${{ order.get_total_cost }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1077.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1078.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1079.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1080.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1081.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1082.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1083.1">Replace them with</span><a id="_idIndexMarker942"/><span class="koboSpan" id="kobo.1084.1"> the following code. </span><span class="koboSpan" id="kobo.1084.2">New lines are highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1085.1">{% if order.coupon %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1086.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1087.1">tr</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1088.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1089.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1090.1">"subtotal"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1091.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1092.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1093.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1094.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1095.1">Subtotal</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1096.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1097.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1098.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1099.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1100.1">td</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1101.1">colspan</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1102.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1103.1">"3"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1104.1">&gt;&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1105.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1106.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1107.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1108.1">td</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1109.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1110.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1111.1">"num"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1112.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1113.1">      ${{ order.get_total_cost_before_discount|floatformat:2 }}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1114.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1115.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1116.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1117.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1118.1">tr</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1119.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1120.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1121.1">tr</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1122.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1123.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1124.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1125.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1126.1">      "{{ order.coupon.code }}" coupon</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1127.1">      ({{ order.discount }}% off)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1128.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1129.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1130.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1131.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1132.1">td</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1133.1">colspan</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1134.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1135.1">"3"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1136.1">&gt;&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1137.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1138.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1139.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1140.1">td</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1141.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1142.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1143.1">"</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1144.1">num neg"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1145.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1146.1">      - ${{ order.get_discount|floatformat:2 }}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1147.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1148.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1149.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1150.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1151.1">tr</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1152.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1153.1">{% endif %}</span></strong></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1154.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1155.1">tr</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1156.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1157.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1158.1">"total"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1159.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1160.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1161.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1162.1">&gt;</span></span><span class="koboSpan" id="kobo.1163.1">Total</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1164.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1165.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1166.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1167.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1168.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1169.1">colspan</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1170.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1171.1">"3"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1172.1">&gt;&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1173.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1174.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1175.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1176.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1177.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1178.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1179.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1180.1">&gt;</span></span><span class="koboSpan" id="kobo.1181.1">
    ${{ order.get_total_cost</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1182.1">|floatformat:2</span></strong></span><span class="koboSpan" id="kobo.1183.1"> }}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1184.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1185.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1186.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1187.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1188.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1189.1">&gt;</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1190.1">We have updated the order summary before payment.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1191.1">Make sure that the development server is running with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1192.1">python manage.py runserver
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1193.1">Make sure Docker is running, and execute the following command in another shell to start the RabbitMQ server with Docker:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1194.1">docker run -it --rm --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3.13.1-management
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1195.1">Open another shell </span><a id="_idIndexMarker943"/><span class="koboSpan" id="kobo.1196.1">and start the Celery worker from your project directory with the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1197.1">celery -A myshop worker -l info
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1198.1">Open an additional shell and execute the following command to forward Stripe events to your local webhook URL:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1199.1">stripe listen --forward-to localhost:8000/payment/webhook/
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1200.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.1201.1">http://127.0.0.1:8000/</span></code><span class="koboSpan" id="kobo.1202.1"> in your browser and create an order using the coupon you created. </span><span class="koboSpan" id="kobo.1202.2">After validating the items in the shopping cart, on the </span><strong class="screenText"><span class="koboSpan" id="kobo.1203.1">Order summary</span></strong><span class="koboSpan" id="kobo.1204.1"> page, you will see the coupon applied to the order:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1205.1"><img alt="" role="presentation" src="../Images/B21088_10_09.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1206.1">Figure 10.9: The Order summary page, including the coupon applied to the order</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1207.1">If you click on </span><strong class="screenText"><span class="koboSpan" id="kobo.1208.1">Pay now</span></strong><span class="koboSpan" id="kobo.1209.1">, you will see that Stripe is not aware of the discount applied, as displayed in </span><em class="italic"><span class="koboSpan" id="kobo.1210.1">Figure 10.10</span></em><span class="koboSpan" id="kobo.1211.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1212.1"><img alt="" role="presentation" src="../Images/B21088_10_10.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1213.1">Figure 10.10: The item details of the Stripe Checkout page, including no discount coupon</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1214.1">Stripe shows the </span><a id="_idIndexMarker944"/><span class="koboSpan" id="kobo.1215.1">full amount to be paid without any deduction. </span><span class="koboSpan" id="kobo.1215.2">This is because we are not passing on the discount to Stripe. </span><span class="koboSpan" id="kobo.1215.3">Remember that in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1216.1">payment_process</span></code><span class="koboSpan" id="kobo.1217.1"> view, we pass the order items as </span><code class="inlineCode"><span class="koboSpan" id="kobo.1218.1">line_items</span></code><span class="koboSpan" id="kobo.1219.1"> to Stripe, including the cost and quantity of each order item.</span></p>
<h2 class="heading-2" id="_idParaDest-289"><span class="koboSpan" id="kobo.1220.1">Creating coupons for Stripe Checkout</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1221.1">Stripe allows</span><a id="_idIndexMarker945"/><span class="koboSpan" id="kobo.1222.1"> you to define discount coupons and link them to one-time payments. </span><span class="koboSpan" id="kobo.1222.2">You can find more information about creating discounts for Stripe Checkout at </span><a href="https://stripe.com/docs/payments/checkout/discounts"><span class="url"><span class="koboSpan" id="kobo.1223.1">https://stripe.com/docs/payments/checkout/discounts</span></span></a><span class="koboSpan" id="kobo.1224.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1225.1">Let’s edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1226.1">payment_process</span></code><span class="koboSpan" id="kobo.1227.1"> view to create a coupon for Stripe Checkout. </span><span class="koboSpan" id="kobo.1227.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1228.1">views.py</span></code><span class="koboSpan" id="kobo.1229.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1230.1">payment</span></code><span class="koboSpan" id="kobo.1231.1"> application and add the following code highlighted in bold to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1232.1">payment_process</span></code><span class="koboSpan" id="kobo.1233.1"> view:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1234.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1235.1">payment_process</span></span><span class="koboSpan" id="kobo.1236.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1237.1">request</span></span><span class="koboSpan" id="kobo.1238.1">):
    order_id = request.session.get(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1239.1">'order_id'</span></span><span class="koboSpan" id="kobo.1240.1">)
    order = get_object_or_404(Order, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1241.1">id</span></span><span class="koboSpan" id="kobo.1242.1">=order_id)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1243.1">if</span></span><span class="koboSpan" id="kobo.1244.1"> request.method == </span><span class="hljs-string"><span class="koboSpan" id="kobo.1245.1">'POST'</span></span><span class="koboSpan" id="kobo.1246.1">:
        success_url = request.build_absolute_uri(
            reverse(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1247.1">'payment:completed'</span></span><span class="koboSpan" id="kobo.1248.1">)
        )
        cancel_url = request.build_absolute_uri(
            reverse(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1249.1">'payment:canceled'</span></span><span class="koboSpan" id="kobo.1250.1">)
        )
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1251.1"># Stripe checkout session data</span></span><span class="koboSpan" id="kobo.1252.1">
        session_data = {
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.1253.1">'mode'</span></span><span class="koboSpan" id="kobo.1254.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1255.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1256.1">payment'</span></span><span class="koboSpan" id="kobo.1257.1">,
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.1258.1">'client_reference_id'</span></span><span class="koboSpan" id="kobo.1259.1">: order.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1260.1">id</span></span><span class="koboSpan" id="kobo.1261.1">,
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.1262.1">'success_url'</span></span><span class="koboSpan" id="kobo.1263.1">: success_url,
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.1264.1">'cancel_url'</span></span><span class="koboSpan" id="kobo.1265.1">: cancel_url,
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.1266.1">'line_items'</span></span><span class="koboSpan" id="kobo.1267.1">: []
        }
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1268.1"># add order items to the Stripe checkout session</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1269.1">for</span></span><span class="koboSpan" id="kobo.1270.1"> item </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1271.1">in</span></span><span class="koboSpan" id="kobo.1272.1"> order.items.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1273.1">all</span></span><span class="koboSpan" id="kobo.1274.1">():
            session_data[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1275.1">'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1276.1">line_items'</span></span><span class="koboSpan" id="kobo.1277.1">].append(
                {
                    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1278.1">'price_data'</span></span><span class="koboSpan" id="kobo.1279.1">: {
                        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1280.1">'unit_amount'</span></span><span class="koboSpan" id="kobo.1281.1">: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1282.1">int</span></span><span class="koboSpan" id="kobo.1283.1">(item.price * Decimal(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1284.1">'100'</span></span><span class="koboSpan" id="kobo.1285.1">)),
                        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1286.1">'currency'</span></span><span class="koboSpan" id="kobo.1287.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1288.1">'usd'</span></span><span class="koboSpan" id="kobo.1289.1">,
                        </span><span class="hljs-string"><span class="koboSpan" id="kobo.1290.1">'product_data'</span></span><span class="koboSpan" id="kobo.1291.1">: {
                            </span><span class="hljs-string"><span class="koboSpan" id="kobo.1292.1">'name'</span></span><span class="koboSpan" id="kobo.1293.1">: item.product.name,
                        },
                    },
                    </span><span class="hljs-string"><span class="koboSpan" id="kobo.1294.1">'quantity'</span></span><span class="koboSpan" id="kobo.1295.1">: item.quantity,
                }
            )
</span><span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.1296.1"># Stripe coupon</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.1297.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1298.1"> order.coupon:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1299.1">            stripe_coupon = stripe.Coupon.create(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1300.1">                name=order.coupon.code,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1301.1">                percent_off=order.discount,</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1302.1">                duration=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1303.1">'once'</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1304.1">            )</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1305.1">            session_data[</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1306.1">'discounts'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1307.1">] = [{</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1308.1">'coupon'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1309.1">: stripe_coupon.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.1310.1">id</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1311.1">}]</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1312.1"># create Stripe checkout session</span></span><span class="koboSpan" id="kobo.1313.1">
        session = stripe.checkout.Session.create(**session_data)
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1314.1"># redirect to Stripe payment form</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1315.1">return</span></span><span class="koboSpan" id="kobo.1316.1"> redirect(session.url, code=</span><span class="hljs-number"><span class="koboSpan" id="kobo.1317.1">303</span></span><span class="koboSpan" id="kobo.1318.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1319.1">else</span></span><span class="koboSpan" id="kobo.1320.1">:
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1321.1">return</span></span><span class="koboSpan" id="kobo.1322.1"> render(request, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1323.1">'payment/process.html'</span></span><span class="koboSpan" id="kobo.1324.1">, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1325.1">locals</span></span><span class="koboSpan" id="kobo.1326.1">())
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1327.1">In the new code, you check if the order has a related coupon. </span><span class="koboSpan" id="kobo.1327.2">In that case, you use the Stripe SDK to create </span><a id="_idIndexMarker946"/><span class="koboSpan" id="kobo.1328.1">a Stripe coupon using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1329.1">stripe.Coupon.create()</span></code><span class="koboSpan" id="kobo.1330.1">. </span><span class="koboSpan" id="kobo.1330.2">You use the following attributes for the coupon:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1331.1">name</span></code><span class="koboSpan" id="kobo.1332.1">: The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1333.1">code</span></code><span class="koboSpan" id="kobo.1334.1"> of the coupon related to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1335.1">order</span></code><span class="koboSpan" id="kobo.1336.1"> object is used.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1337.1">percent_off</span></code><span class="koboSpan" id="kobo.1338.1">: The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1339.1">discount</span></code><span class="koboSpan" id="kobo.1340.1"> of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1341.1">order</span></code><span class="koboSpan" id="kobo.1342.1"> object is issued.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1343.1">duration</span></code><span class="koboSpan" id="kobo.1344.1">: The value </span><code class="inlineCode"><span class="koboSpan" id="kobo.1345.1">once</span></code><span class="koboSpan" id="kobo.1346.1"> is used. </span><span class="koboSpan" id="kobo.1346.2">This indicates to Stripe that this is a coupon for a one-time payment.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1347.1">After creating the coupon, its </span><code class="inlineCode"><span class="koboSpan" id="kobo.1348.1">id</span></code><span class="koboSpan" id="kobo.1349.1"> is added to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1350.1">session_data</span></code><span class="koboSpan" id="kobo.1351.1"> dictionary used to create the Stripe Checkout session. </span><span class="koboSpan" id="kobo.1351.2">This links the coupon to the checkout session.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1352.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.1353.1">http://127.0.0.1:8000/</span></code><span class="koboSpan" id="kobo.1354.1"> in your browser and complete a purchase using the coupon you created. </span><span class="koboSpan" id="kobo.1354.2">When redirected to the Stripe Checkout page, you will see the coupon applied:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1355.1"><img alt="" role="presentation" src="../Images/B21088_10_11.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1356.1">Figure 10.11: The item details of the Stripe Checkout page, including a discount coupon named SUMMER</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1357.1">The Stripe Checkout </span><a id="_idIndexMarker947"/><span class="koboSpan" id="kobo.1358.1">page now includes the order coupon, and the total amount to pay now includes the amount deducted using the coupon.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1359.1">Complete the purchase and then open </span><code class="inlineCode"><span class="koboSpan" id="kobo.1360.1">http://127.0.0.1:8000/admin/orders/order/</span></code><span class="koboSpan" id="kobo.1361.1"> in your browser. </span><span class="koboSpan" id="kobo.1361.2">Click on the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1362.1">order</span></code><span class="koboSpan" id="kobo.1363.1"> object for which the coupon was used. </span><span class="koboSpan" id="kobo.1363.2">The edit form will display the discount applied, as shown in </span><em class="italic"><span class="koboSpan" id="kobo.1364.1">Figure 10.12</span></em><span class="koboSpan" id="kobo.1365.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1366.1"><img alt="" role="presentation" src="../Images/B21088_10_12.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1367.1">Figure 10.12: The order edit form, including the coupon and discount applied</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1368.1">You have successfully stored coupons for orders and processed payments with discounts. </span><span class="koboSpan" id="kobo.1368.2">Next, you </span><a id="_idIndexMarker948"/><span class="koboSpan" id="kobo.1369.1">will add coupons to the order detail view of the administration site and to PDF invoices for orders.</span></p>
<h2 class="heading-2" id="_idParaDest-290"><span class="koboSpan" id="kobo.1370.1">Adding coupons to orders on the administration site and to PDF invoices</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1371.1">Let’s add </span><a id="_idIndexMarker949"/><span class="koboSpan" id="kobo.1372.1">the coupon to</span><a id="_idIndexMarker950"/><span class="koboSpan" id="kobo.1373.1"> the order detail page on the administration site. </span><span class="koboSpan" id="kobo.1373.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1374.1">admin/orders/order/detail.html</span></code><span class="koboSpan" id="kobo.1375.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1376.1">orders</span></code><span class="koboSpan" id="kobo.1377.1"> application and add the following code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1378.1">...</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1379.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1380.1">table</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1381.1">style</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1382.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1383.1">"width:100%"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1384.1">&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1385.1">...</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1386.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1387.1">tbody</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1388.1">&gt;</span></span><span class="koboSpan" id="kobo.1389.1">
    {% for item in order.items.all %}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1390.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1391.1">tr</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1392.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1393.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1394.1">"row{% cycle "1" "2"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1395.1"> %}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1396.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1397.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1398.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1399.1">&gt;</span></span><span class="koboSpan" id="kobo.1400.1">{{ item.product.name }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1401.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1402.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1403.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1404.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1405.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1406.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1407.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1408.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1409.1">&gt;</span></span><span class="koboSpan" id="kobo.1410.1">${{ item.price }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1411.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1412.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1413.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1414.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1415.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1416.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1417.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1418.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1419.1">&gt;</span></span><span class="koboSpan" id="kobo.1420.1">{{ item.quantity }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1421.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1422.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1423.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1424.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1425.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1426.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1427.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1428.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1429.1">&gt;</span></span><span class="koboSpan" id="kobo.1430.1">${{ item.get_cost }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1431.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1432.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1433.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1434.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1435.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1436.1">&gt;</span></span><span class="koboSpan" id="kobo.1437.1">
    {% endfor %}
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1438.1">    {% if order.coupon %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1439.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1440.1">tr</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1441.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1442.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1443.1">"subtotal"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1444.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1445.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1446.1">td</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1447.1">colspan</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1448.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1449.1">"3"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1450.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1451.1">Subtotal</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1452.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1453.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1454.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1455.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1456.1">td</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1457.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1458.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1459.1">"num"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1460.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1461.1">          ${{ order.get_total_cost_before_discount|floatformat:2 }}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1462.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1463.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1464.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1465.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1466.1">tr</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1467.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1468.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1469.1">tr</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1470.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1471.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1472.1">td</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1473.1">colspan</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1474.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1475.1">"3"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1476.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1477.1">          "{{ order.coupon.code }}" coupon</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1478.1">          ({{ order.discount }}% off)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1479.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1480.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1481.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1482.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1483.1">td</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1484.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1485.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1486.1">"num neg"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1487.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1488.1">          - ${{ order.get_discount|floatformat:2 }}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1489.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1490.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1491.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1492.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1493.1">tr</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1494.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1495.1">    {% endif %}</span></strong></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1496.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1497.1">tr</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1498.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1499.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1500.1">"total"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1501.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1502.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1503.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1504.1">colspan</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1505.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1506.1">"3"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1507.1">&gt;</span></span><span class="koboSpan" id="kobo.1508.1">Total</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1509.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1510.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1511.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1512.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1513.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1514.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1515.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1516.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1517.1">&gt;</span></span><span class="koboSpan" id="kobo.1518.1">
        ${{ order.get_total_cost</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1519.1">|floatformat:2</span></strong></span><span class="koboSpan" id="kobo.1520.1"> }}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1521.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1522.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1523.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1524.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1525.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1526.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1527.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1528.1">tbody</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1529.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1530.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1531.1">table</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1532.1">&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1533.1">...</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1534.1">Access </span><code class="inlineCode"><span class="koboSpan" id="kobo.1535.1">http://127.0.0.1:8000/admin/orders/order/</span></code><span class="koboSpan" id="kobo.1536.1"> with your browser, and click on the </span><strong class="screenText"><span class="koboSpan" id="kobo.1537.1">View</span></strong><span class="koboSpan" id="kobo.1538.1"> link of</span><a id="_idIndexMarker951"/><span class="koboSpan" id="kobo.1539.1"> the </span><a id="_idIndexMarker952"/><span class="koboSpan" id="kobo.1540.1">latest order. </span><span class="koboSpan" id="kobo.1540.2">The </span><strong class="screenText"><span class="koboSpan" id="kobo.1541.1">Items bought</span></strong><span class="koboSpan" id="kobo.1542.1"> table will now include the coupon used, as shown in </span><em class="italic"><span class="koboSpan" id="kobo.1543.1">Figure 10.13</span></em><span class="koboSpan" id="kobo.1544.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1545.1"><img alt="" role="presentation" src="../Images/B21088_10_13.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1546.1">Figure 10.13: The product detail page on the administration site, including the coupon used</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1547.1">Now, let’s modify the order invoice template to include the coupon used for the order. </span><span class="koboSpan" id="kobo.1547.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1548.1">orders/order/pdf.html</span></code><span class="koboSpan" id="kobo.1549.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1550.1">orders</span></code><span class="koboSpan" id="kobo.1551.1"> application and add the following</span><a id="_idIndexMarker953"/><span class="koboSpan" id="kobo.1552.1"> code </span><a id="_idIndexMarker954"/><span class="koboSpan" id="kobo.1553.1">highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1554.1">...</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1555.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1556.1">table</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1557.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1558.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1559.1">thead</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1560.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1561.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1562.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1563.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1564.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1565.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1566.1">&gt;</span></span><span class="koboSpan" id="kobo.1567.1">Product</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1568.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1569.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1570.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1571.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1572.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1573.1">&gt;</span></span><span class="koboSpan" id="kobo.1574.1">Price</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1575.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1576.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1577.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1578.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1579.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1580.1">&gt;</span></span><span class="koboSpan" id="kobo.1581.1">Quantity</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1582.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1583.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1584.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1585.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1586.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1587.1">&gt;</span></span><span class="koboSpan" id="kobo.1588.1">Cost</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1589.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1590.1">th</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1591.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1592.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1593.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1594.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1595.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1596.1">thead</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1597.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1598.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1599.1">tbody</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1600.1">&gt;</span></span><span class="koboSpan" id="kobo.1601.1">
    {% for item in order.items.all %}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.1602.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1603.1">tr</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1604.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1605.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1606.1">"row{% cycle "1" "2" %}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1607.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1608.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1609.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1610.1">&gt;</span></span><span class="koboSpan" id="kobo.1611.1">{{ item.product.name }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1612.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1613.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1614.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1615.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1616.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1617.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1618.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1619.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1620.1">&gt;</span></span><span class="koboSpan" id="kobo.1621.1">${{ item.price }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1622.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1623.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1624.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1625.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1626.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1627.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1628.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1629.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1630.1">&gt;</span></span><span class="koboSpan" id="kobo.1631.1">{{ item.quantity }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1632.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1633.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1634.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1635.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1636.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1637.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1638.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1639.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1640.1">&gt;</span></span><span class="koboSpan" id="kobo.1641.1">${{ item.get_cost }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1642.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1643.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1644.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1645.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1646.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1647.1">&gt;</span></span><span class="koboSpan" id="kobo.1648.1">
    {% endfor %}
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1649.1">    {% if order.coupon %}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1650.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1651.1">tr</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1652.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1653.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1654.1">"subtotal"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1655.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1656.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1657.1">td</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1658.1">colspan</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1659.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1660.1">"3"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1661.1">&gt;</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.1662.1">Subtotal</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1663.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1664.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1665.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1666.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1667.1">td</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1668.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1669.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1670.1">"num"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1671.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1672.1">          ${{ order.get_total_cost_before_discount|floatformat:2 }}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1673.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1674.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1675.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1676.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1677.1">tr</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1678.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1679.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1680.1">tr</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1681.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1682.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1683.1">td</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1684.1">colspan</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1685.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1686.1">"3"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1687.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1688.1">          "{{ order.coupon.code }}" coupon</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1689.1">          ({{ order.discount }}% off)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1690.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1691.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1692.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1693.1">&lt;</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1694.1">td</span></strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc"><span class="koboSpan" id="kobo.1695.1">class</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1696.1">=</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.1697.1">"num neg"</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1698.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1699.1">          - ${{ order.get_discount|floatformat:2 }}</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1700.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1701.1">td</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1702.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1703.1">&lt;/</span></strong><strong class="hljs-name-slc"><span class="koboSpan" id="kobo.1704.1">tr</span></strong><strong class="hljs-tag-slc"><span class="koboSpan" id="kobo.1705.1">&gt;</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1706.1">    {% endif %}</span></strong></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1707.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1708.1">tr</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1709.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1710.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1711.1">"total"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1712.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1713.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1714.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1715.1">colspan</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1716.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1717.1">"3"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1718.1">&gt;</span></span><span class="koboSpan" id="kobo.1719.1">Total</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1720.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1721.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1722.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1723.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1724.1">td</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.1725.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1726.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1727.1">"num"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1728.1">&gt;</span></span><span class="koboSpan" id="kobo.1729.1">${{ order.get_total_cost</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.1730.1">|floatformat:2</span></strong></span><span class="koboSpan" id="kobo.1731.1"> }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.1732.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1733.1">td</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1734.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1735.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1736.1">tr</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1737.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1738.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1739.1">tbody</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1740.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.1741.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.1742.1">table</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.1743.1">&gt;</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1744.1">...</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1745.1">Access </span><code class="inlineCode"><span class="koboSpan" id="kobo.1746.1">http://127.0.0.1:8000/admin/orders/order/</span></code><span class="koboSpan" id="kobo.1747.1"> with your browser, and click on the </span><strong class="screenText"><span class="koboSpan" id="kobo.1748.1">PDF</span></strong><span class="koboSpan" id="kobo.1749.1"> link of the </span><a id="_idIndexMarker955"/><span class="koboSpan" id="kobo.1750.1">latest </span><a id="_idIndexMarker956"/><span class="koboSpan" id="kobo.1751.1">order. </span><span class="koboSpan" id="kobo.1751.2">The </span><strong class="screenText"><span class="koboSpan" id="kobo.1752.1">Items bought</span></strong><span class="koboSpan" id="kobo.1753.1"> table will now include the coupon used, as shown in </span><em class="italic"><span class="koboSpan" id="kobo.1754.1">Figure 10.14</span></em><span class="koboSpan" id="kobo.1755.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1756.1"><img alt="" role="presentation" src="../Images/B21088_10_14.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1757.1">Figure 10.14: The PDF order invoice, including the coupon used</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1758.1">You successfully added a coupon system to your shop. </span><span class="koboSpan" id="kobo.1758.2">Next, you are going to build a product recommendation engine.</span></p>
<h1 class="heading-1" id="_idParaDest-291"><span class="koboSpan" id="kobo.1759.1">Building a recommendation engine</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1760.1">A recommendation </span><a id="_idIndexMarker957"/><span class="koboSpan" id="kobo.1761.1">engine is a system that predicts the preference or rating that a user would give to an item. </span><span class="koboSpan" id="kobo.1761.2">The system selects relevant items for a user based on their behavior and the knowledge it has about them. </span><span class="koboSpan" id="kobo.1761.3">Nowadays, recommendation systems are used in many online services. </span><span class="koboSpan" id="kobo.1761.4">They help users by selecting the stuff they might be interested in from the vast amount of available data that is irrelevant to them. </span><span class="koboSpan" id="kobo.1761.5">Offering good recommendations enhances user engagement. </span><span class="koboSpan" id="kobo.1761.6">E-commerce sites also benefit from offering relevant product recommendations by increasing their average revenue per user.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1762.1">You are going to create a simple yet powerful recommendation engine that suggests products that are usually bought together. </span><span class="koboSpan" id="kobo.1762.2">You will suggest products based on historical sales, thus identifying products that are usually bought together. </span><span class="koboSpan" id="kobo.1762.3">You are going to suggest complementary products in two different scenarios:</span></p>
<ul>
<li class="bulletList"><strong class="screenText"><span class="koboSpan" id="kobo.1763.1">Product detail page</span></strong><span class="koboSpan" id="kobo.1764.1">: You will display a list of products that are usually bought with the given product. </span><span class="koboSpan" id="kobo.1764.2">This will be displayed as </span><em class="italic"><span class="koboSpan" id="kobo.1765.1">users who bought this also bought X, Y, and Z</span></em><span class="koboSpan" id="kobo.1766.1">. </span><span class="koboSpan" id="kobo.1766.2">You need a data structure that allows you to store the number of times each product has been bought together with the product being displayed.</span></li>
<li class="bulletList"><strong class="screenText"><span class="koboSpan" id="kobo.1767.1">Cart detail page</span></strong><span class="koboSpan" id="kobo.1768.1">: Based on the products that users add to the cart, you are going to suggest products that are usually bought together with these ones. </span><span class="koboSpan" id="kobo.1768.2">In this case, the score you calculate to obtain related products has to be aggregated.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1769.1">You are going to use Redis to store products that are usually purchased together. </span><span class="koboSpan" id="kobo.1769.2">Remember that you already used Redis in </span><em class="italic"><span class="koboSpan" id="kobo.1770.1">Chapter 7</span></em><span class="koboSpan" id="kobo.1771.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1772.1">Tracking User Actions</span></em><span class="koboSpan" id="kobo.1773.1">. </span><span class="koboSpan" id="kobo.1773.2">If you haven’t installed Redis yet, you can find installation instructions in that chapter.</span></p>
<h2 class="heading-2" id="_idParaDest-292"><span class="koboSpan" id="kobo.1774.1">Recommending products based on previous purchases</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1775.1">We will </span><a id="_idIndexMarker958"/><span class="koboSpan" id="kobo.1776.1">recommend products to users based on items that are frequently bought together. </span><span class="koboSpan" id="kobo.1776.2">For that, we are going to use Redis sorted sets. </span><span class="koboSpan" id="kobo.1776.3">Remember that you used sorted sets in </span><em class="chapterRef"><span class="koboSpan" id="kobo.1777.1">Chapter 7</span></em><span class="koboSpan" id="kobo.1778.1">, </span><em class="italic"><span class="koboSpan" id="kobo.1779.1">Tracking User Actions</span></em><span class="koboSpan" id="kobo.1780.1">, to create a ranking of the most viewed images on your site.</span></p>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.1781.1">Figure 10.15</span></em><span class="koboSpan" id="kobo.1782.1"> shows a representation of a sorted set, where set members are strings associated with a score:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1783.1"><img alt="" role="presentation" src="../Images/B21088_10_15.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1784.1">Figure 10.15: Redis sorted set representation</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1785.1">We are going to store a key in Redis for each product bought on the site. </span><span class="koboSpan" id="kobo.1785.2">The product key will contain a Redis sorted set with scores. </span><span class="koboSpan" id="kobo.1785.3">Every time a new purchase is completed, we will increment the score by 1 for each product bought together. </span><span class="koboSpan" id="kobo.1785.4">The sorted set will allow you to give scores to products that are bought together. </span><span class="koboSpan" id="kobo.1785.5">We will use the number of times the product is bought with another product as the score for that item.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1786.1">Remember to </span><a id="_idIndexMarker959"/><span class="koboSpan" id="kobo.1787.1">install </span><code class="inlineCode"><span class="koboSpan" id="kobo.1788.1">redis-py</span></code><span class="koboSpan" id="kobo.1789.1"> in your environment using the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.1790.1">python -m pip install redis==5.0.4
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1791.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1792.1">settings.py</span></code><span class="koboSpan" id="kobo.1793.1"> file of your project and add the following settings to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.1794.1"># Redis settings</span></span><span class="koboSpan" id="kobo.1795.1">
REDIS_HOST = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1796.1">'localhost'</span></span><span class="koboSpan" id="kobo.1797.1">
REDIS_PORT = </span><span class="hljs-number"><span class="koboSpan" id="kobo.1798.1">6379</span></span><span class="koboSpan" id="kobo.1799.1">
REDIS_DB = </span><span class="hljs-number"><span class="koboSpan" id="kobo.1800.1">1</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1801.1">These are the settings required to establish a connection with the Redis server. </span><span class="koboSpan" id="kobo.1801.2">Create a new file inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1802.1">shop</span></code><span class="koboSpan" id="kobo.1803.1"> application directory and name it </span><code class="inlineCode"><span class="koboSpan" id="kobo.1804.1">recommender.py</span></code><span class="koboSpan" id="kobo.1805.1">. </span><span class="koboSpan" id="kobo.1805.2">Add the following code to it:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1806.1">import</span></span><span class="koboSpan" id="kobo.1807.1"> redis
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1808.1">from</span></span><span class="koboSpan" id="kobo.1809.1"> django.conf </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1810.1">import</span></span><span class="koboSpan" id="kobo.1811.1"> settings
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1812.1">from</span></span><span class="koboSpan" id="kobo.1813.1"> .models </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1814.1">import</span></span><span class="koboSpan" id="kobo.1815.1"> Product
</span><span class="hljs-comment"><span class="koboSpan" id="kobo.1816.1"># connect to redis</span></span><span class="koboSpan" id="kobo.1817.1">
r = redis.Redis(
    host=settings.REDIS_HOST,
    port=settings.REDIS_PORT,
    db=settings.REDIS_DB
)
</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1818.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1819.1">Recommender</span></span><span class="koboSpan" id="kobo.1820.1">:
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1821.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1822.1">get_product_key</span></span><span class="koboSpan" id="kobo.1823.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1824.1">self, </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1825.1">id</span></span><span class="koboSpan" id="kobo.1826.1">):
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1827.1">return</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1828.1">f'product:</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1829.1">{</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1830.1">id</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1831.1">}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1832.1">:purchased_with'</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1833.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1834.1">products_bought</span></span><span class="koboSpan" id="kobo.1835.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1836.1">self, products</span></span><span class="koboSpan" id="kobo.1837.1">):
        product_ids = [p.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1838.1">id</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1839.1">for</span></span><span class="koboSpan" id="kobo.1840.1"> p </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1841.1">in</span></span><span class="koboSpan" id="kobo.1842.1"> products]
        </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1843.1">for</span></span><span class="koboSpan" id="kobo.1844.1"> product_id </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1845.1">in</span></span><span class="koboSpan" id="kobo.1846.1"> product_ids:
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1847.1">for</span></span><span class="koboSpan" id="kobo.1848.1"> with_id </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1849.1">in</span></span><span class="koboSpan" id="kobo.1850.1"> product_ids:
                </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1851.1"># get the other products bought with each product</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.1852.1">if</span></span><span class="koboSpan" id="kobo.1853.1"> product_id != with_id:
                    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1854.1"># increment score for product purchased together</span></span><span class="koboSpan" id="kobo.1855.1">
                    r.zincrby(
                        self.get_product_key(product_id), </span><span class="hljs-number"><span class="koboSpan" id="kobo.1856.1">1</span></span><span class="koboSpan" id="kobo.1857.1">, with_id
                    )
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1858.1">This is the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1859.1">Recommender</span></code><span class="koboSpan" id="kobo.1860.1"> class, which will allow you to store product purchases and retrieve product </span><a id="_idIndexMarker960"/><span class="koboSpan" id="kobo.1861.1">suggestions for a given product or products.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1862.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1863.1">get_product_key()</span></code><span class="koboSpan" id="kobo.1864.1"> method receives the ID of a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1865.1">Product</span></code><span class="koboSpan" id="kobo.1866.1"> object and builds the Redis key for the sorted set where related products are stored, which looks like </span><code class="inlineCode"><span class="koboSpan" id="kobo.1867.1">product:[id]:purchased_with</span></code><span class="koboSpan" id="kobo.1868.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1869.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1870.1">products_bought()</span></code><span class="koboSpan" id="kobo.1871.1"> method receives a list of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1872.1">Product</span></code><span class="koboSpan" id="kobo.1873.1"> objects that have been bought together (that is, belong to the same order).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1874.1">In this method, you perform the following tasks:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.1875.1">You get the product IDs for the given </span><code class="inlineCode"><span class="koboSpan" id="kobo.1876.1">Product</span></code><span class="koboSpan" id="kobo.1877.1"> objects.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1878.1">You iterate over the product IDs. </span><span class="koboSpan" id="kobo.1878.2">For each ID, you iterate again over the product IDs and skip the same product so that you get the products that are bought together with each product.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1879.1">You get the Redis product key for each product bought using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1880.1">get_product_id()</span></code><span class="koboSpan" id="kobo.1881.1"> method. </span><span class="koboSpan" id="kobo.1881.2">For a product with an ID of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1882.1">33</span></code><span class="koboSpan" id="kobo.1883.1">, this method returns the key </span><code class="inlineCode"><span class="koboSpan" id="kobo.1884.1">product:33:purchased_with</span></code><span class="koboSpan" id="kobo.1885.1">. </span><span class="koboSpan" id="kobo.1885.2">This is the key for the sorted set that contains the product IDs of products that were bought together with this one.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.1886.1">You increment the score of each product ID contained in the sorted set by 1 using the Redis </span><code class="inlineCode"><span class="koboSpan" id="kobo.1887.1">ZINCRBY</span></code><span class="koboSpan" id="kobo.1888.1"> operation. </span><span class="koboSpan" id="kobo.1888.2">The score represents the number of times another product has been bought together with the given product.</span></li>
</ol>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.1889.1">Figure 10.16</span></em><span class="koboSpan" id="kobo.1890.1"> shows an example of five different products with IDs 1 to 5 and five purchase orders </span><a id="_idIndexMarker961"/><span class="koboSpan" id="kobo.1891.1">of different combinations of products:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.1892.1"><img alt="" role="presentation" src="../Images/B21088_10_16.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.1893.1">Figure 10.16: Five products with respective IDs and purchase order combinations</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1894.1">In the figure, you can see a sorted set created in Redis for each product, with the key </span><code class="inlineCode"><span class="koboSpan" id="kobo.1895.1">product:&lt;id&gt;:purchased_with</span></code><span class="koboSpan" id="kobo.1896.1">, where </span><code class="inlineCode"><span class="koboSpan" id="kobo.1897.1">&lt;id&gt;</span></code><span class="koboSpan" id="kobo.1898.1"> is the product’s unique identifier. </span><span class="koboSpan" id="kobo.1898.2">The sorted set members are the IDs of the products that have been purchased alongside the principal product. </span><span class="koboSpan" id="kobo.1898.3">The score for each member reflects the cumulative count of joint purchases. </span><span class="koboSpan" id="kobo.1898.4">The figure shows the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1899.1">ZINCRBY</span></code><span class="koboSpan" id="kobo.1900.1"> Redis operation to increment by 1 the score of products purchased together in one order.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1901.1">You now have a method to store and score the products that were bought together. </span><span class="koboSpan" id="kobo.1901.2">Next, you need a method to retrieve the products that were bought together for a list of given products. </span><span class="koboSpan" id="kobo.1901.3">Add the </span><a id="_idIndexMarker962"/><span class="koboSpan" id="kobo.1902.1">following </span><code class="inlineCode"><span class="koboSpan" id="kobo.1903.1">suggest_products_for()</span></code><span class="koboSpan" id="kobo.1904.1"> method to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1905.1">Recommender</span></code><span class="koboSpan" id="kobo.1906.1"> class:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1907.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1908.1">suggest_products_for</span></span><span class="koboSpan" id="kobo.1909.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1910.1">self, products, max_results=</span></span><span class="hljs-number"><span class="koboSpan" id="kobo.1911.1">6</span></span><span class="koboSpan" id="kobo.1912.1">):
    product_ids = [p.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1913.1">id</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1914.1">for</span></span><span class="koboSpan" id="kobo.1915.1"> p </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1916.1">in</span></span><span class="koboSpan" id="kobo.1917.1"> products]
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1918.1">if</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1919.1">len</span></span><span class="koboSpan" id="kobo.1920.1">(products) == </span><span class="hljs-number"><span class="koboSpan" id="kobo.1921.1">1</span></span><span class="koboSpan" id="kobo.1922.1">:
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1923.1"># only 1 product</span></span><span class="koboSpan" id="kobo.1924.1">
        suggestions = r.zrange(
            self.get_product_key(product_ids[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1925.1">0</span></span><span class="koboSpan" id="kobo.1926.1">]), </span><span class="hljs-number"><span class="koboSpan" id="kobo.1927.1">0</span></span><span class="koboSpan" id="kobo.1928.1">, -</span><span class="hljs-number"><span class="koboSpan" id="kobo.1929.1">1</span></span><span class="koboSpan" id="kobo.1930.1">, desc=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.1931.1">True</span></span>
<span class="hljs-literal"> </span><span class="koboSpan" id="kobo.1932.1">)[:max_results]
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1933.1">else</span></span><span class="koboSpan" id="kobo.1934.1">:
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1935.1"># generate a temporary key</span></span><span class="koboSpan" id="kobo.1936.1">
        flat_ids = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1937.1">''</span></span><span class="koboSpan" id="kobo.1938.1">.join([</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1939.1">str</span></span><span class="koboSpan" id="kobo.1940.1">(</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1941.1">id</span></span><span class="koboSpan" id="kobo.1942.1">) </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1943.1">for</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1944.1">id</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1945.1">in</span></span><span class="koboSpan" id="kobo.1946.1"> product_ids])
        tmp_key = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1947.1">f'tmp_</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1948.1">{flat_ids}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1949.1">'</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1950.1"># multiple products, combine scores of all products</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.1951.1"># store the resulting sorted set in a temporary key</span></span><span class="koboSpan" id="kobo.1952.1">
        keys = [self.get_product_key(</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1953.1">id</span></span><span class="koboSpan" id="kobo.1954.1">) </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1955.1">for</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1956.1">id</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1957.1">in</span></span><span class="koboSpan" id="kobo.1958.1"> product_ids]
        r.zunionstore(tmp_key, keys)
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1959.1"># remove ids for the products the recommendation is for</span></span><span class="koboSpan" id="kobo.1960.1">
        r.zrem(tmp_key, *product_ids)
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1961.1"># get the product ids by their score, descendant sort</span></span><span class="koboSpan" id="kobo.1962.1">
        suggestions = r.zrange(
            tmp_key, </span><span class="hljs-number"><span class="koboSpan" id="kobo.1963.1">0</span></span><span class="koboSpan" id="kobo.1964.1">, -</span><span class="hljs-number"><span class="koboSpan" id="kobo.1965.1">1</span></span><span class="koboSpan" id="kobo.1966.1">, desc=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.1967.1">True</span></span>
<span class="hljs-literal"> </span><span class="koboSpan" id="kobo.1968.1">)[:max_results]
        </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1969.1"># remove the temporary key</span></span><span class="koboSpan" id="kobo.1970.1">
        r.delete(tmp_key)
    suggested_products_ids = [</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1971.1">int</span></span><span class="koboSpan" id="kobo.1972.1">(</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1973.1">id</span></span><span class="koboSpan" id="kobo.1974.1">) </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1975.1">for</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1976.1">id</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1977.1">in</span></span><span class="koboSpan" id="kobo.1978.1"> suggestions]
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1979.1"># get suggested products and sort by order of appearance</span></span><span class="koboSpan" id="kobo.1980.1">
    suggested_products = </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1981.1">list</span></span><span class="koboSpan" id="kobo.1982.1">(
        Product.objects.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1983.1">filter</span></span><span class="koboSpan" id="kobo.1984.1">(id__in=suggested_products_ids)
    )
    suggested_products.sort(
        key=</span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1985.1">lambda</span></span><span class="koboSpan" id="kobo.1986.1"> x: suggested_products_ids.index(x.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1987.1">id</span></span><span class="koboSpan" id="kobo.1988.1">)
    )
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1989.1">return</span></span><span class="koboSpan" id="kobo.1990.1"> suggested_products
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.1991.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1992.1">suggest_products_for()</span></code><span class="koboSpan" id="kobo.1993.1"> method receives the following parameters:</span></p>
<ul>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1994.1">products</span></code><span class="koboSpan" id="kobo.1995.1">: This is a list of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1996.1">Product</span></code><span class="koboSpan" id="kobo.1997.1"> objects to get recommendations for. </span><span class="koboSpan" id="kobo.1997.2">It can contain one or more products.</span></li>
<li class="bulletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1998.1">max_results</span></code><span class="koboSpan" id="kobo.1999.1">: This is an integer that represents the maximum number of recommendations to return.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.2000.1">In this method, you perform the following actions:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2001.1">You get the product IDs for the given </span><code class="inlineCode"><span class="koboSpan" id="kobo.2002.1">Product</span></code><span class="koboSpan" id="kobo.2003.1"> objects.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2004.1">If only one product is given, you retrieve the ID of the products that were bought together with the given product, ordered by the total number of times that they were bought together. </span><span class="koboSpan" id="kobo.2004.2">To do so, you use Redis’ </span><code class="inlineCode"><span class="koboSpan" id="kobo.2005.1">ZRANGE</span></code><span class="koboSpan" id="kobo.2006.1"> command. </span><span class="koboSpan" id="kobo.2006.2">You limit the number of results to the number specified in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2007.1">max_results</span></code><span class="koboSpan" id="kobo.2008.1"> attribute (</span><code class="inlineCode"><span class="koboSpan" id="kobo.2009.1">6</span></code><span class="koboSpan" id="kobo.2010.1"> by default). </span><span class="koboSpan" id="kobo.2010.2">You can read more about the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2011.1">ZRANGE</span></code><span class="koboSpan" id="kobo.2012.1"> command at </span><a href="https://redis.io/commands/zrange/"><span class="url"><span class="koboSpan" id="kobo.2013.1">https://redis.io/commands/zrange/</span></span></a><span class="koboSpan" id="kobo.2014.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2015.1">If more than one product is given, you generate a temporary Redis key built with the IDs of the products.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2016.1">Combine and sum all scores for the items contained in the sorted set of each of the given products. </span><span class="koboSpan" id="kobo.2016.2">This is done using the Redis </span><code class="inlineCode"><span class="koboSpan" id="kobo.2017.1">ZUNIONSTORE</span></code><span class="koboSpan" id="kobo.2018.1"> command. </span><span class="koboSpan" id="kobo.2018.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2019.1">ZUNIONSTORE</span></code><span class="koboSpan" id="kobo.2020.1"> command</span><a id="_idIndexMarker963"/><span class="koboSpan" id="kobo.2021.1"> performs a union of the sorted sets with the given keys and stores the aggregated sum of scores of the elements in a new Redis key. </span><span class="koboSpan" id="kobo.2021.2">You can read more about this command at </span><a href="https://redis.io/commands/zunionstore/"><span class="url"><span class="koboSpan" id="kobo.2022.1">https://redis.io/commands/zunionstore/</span></span></a><span class="koboSpan" id="kobo.2023.1">. </span><span class="koboSpan" id="kobo.2023.2">You save the aggregated scores in the temporary key.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2024.1">Since you are aggregating scores, you might obtain the same products you are getting recommendations for. </span><span class="koboSpan" id="kobo.2024.2">You remove them from the generated sorted set using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2025.1">ZREM</span></code><span class="koboSpan" id="kobo.2026.1"> command. </span><span class="koboSpan" id="kobo.2026.2">You can read more about the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2027.1">ZREM</span></code><span class="koboSpan" id="kobo.2028.1"> command at </span><a href="https://redis.io/commands/zrem/"><span class="url"><span class="koboSpan" id="kobo.2029.1">https://redis.io/commands/zrem/</span></span></a><span class="koboSpan" id="kobo.2030.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2031.1">You retrieve the IDs of the products from the temporary key, ordered by their scores using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2032.1">ZRANGE</span></code><span class="koboSpan" id="kobo.2033.1"> command. </span><span class="koboSpan" id="kobo.2033.2">You limit the number of results to the number specified in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2034.1">max_results</span></code><span class="koboSpan" id="kobo.2035.1"> attribute.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2036.1">Then, you remove the temporary key using the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2037.1">redis-py delete()</span></code><span class="koboSpan" id="kobo.2038.1"> method that executes the Redis </span><code class="inlineCode"><span class="koboSpan" id="kobo.2039.1">DEL</span></code><span class="koboSpan" id="kobo.2040.1"> command. </span><span class="koboSpan" id="kobo.2040.2">You can read more about the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2041.1">DEL</span></code><span class="koboSpan" id="kobo.2042.1"> command at </span><a href="https://redis.io/commands/del/"><span class="url"><span class="koboSpan" id="kobo.2043.1">https://redis.io/commands/del/</span></span></a><span class="koboSpan" id="kobo.2044.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2045.1">Finally, you get the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2046.1">Product</span></code><span class="koboSpan" id="kobo.2047.1"> objects with the given IDs, and you order the products in the same order as the sorted set members.</span></li>
</ol>
<p class="normal"><em class="italic"><span class="koboSpan" id="kobo.2048.1">Figure 10.17</span></em><span class="koboSpan" id="kobo.2049.1"> shows an example of a session where two products have been added to the shopping cart and the Redis operations performed to obtain related product recommendations:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2050.1"><img alt="" role="presentation" src="../Images/B21088_10_17.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2051.1">Figure 10.17: Product recommendation system</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2052.1">In the figure, you </span><a id="_idIndexMarker964"/><span class="koboSpan" id="kobo.2053.1">can see the four steps to generate product recommendations for the items in the cart:</span></p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2054.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2055.1">ZUNIONSTORE</span></code><span class="koboSpan" id="kobo.2056.1"> Redis command is used to aggregate the scores of products purchased frequently with the products in the shopping cart. </span><span class="koboSpan" id="kobo.2056.2">The resulting sorted set of this operation is stored in a new Redis key named after the IDs of the products in the shopping cart, </span><code class="inlineCode"><span class="koboSpan" id="kobo.2057.1">tmp_34</span></code><span class="koboSpan" id="kobo.2058.1"> for IDs </span><code class="inlineCode"><span class="koboSpan" id="kobo.2059.1">3</span></code><span class="koboSpan" id="kobo.2060.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2061.1">4</span></code><span class="koboSpan" id="kobo.2062.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2063.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2064.1">ZREM</span></code><span class="koboSpan" id="kobo.2065.1"> command is used to remove the products being purchased from the sorted set, to avoid recommending products that are already in the shopping cart.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2066.1">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.2067.1">ZRANGE</span></code><span class="koboSpan" id="kobo.2068.1"> command is used to return the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2069.1">tmp_34</span></code><span class="koboSpan" id="kobo.2070.1"> sorted set members ordered by score.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2071.1">Finally, the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2072.1">DEL</span></code><span class="koboSpan" id="kobo.2073.1"> command is used to delete the Redis key </span><code class="inlineCode"><span class="koboSpan" id="kobo.2074.1">tmp_34</span></code><span class="koboSpan" id="kobo.2075.1">.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.2076.1">For practical purposes, let’s also add a method to clear the recommendations. </span><span class="koboSpan" id="kobo.2076.2">Add the following method to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2077.1">Recommender</span></code><span class="koboSpan" id="kobo.2078.1"> class:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2079.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2080.1">clear_purchases</span></span><span class="koboSpan" id="kobo.2081.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2082.1">self</span></span><span class="koboSpan" id="kobo.2083.1">):
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2084.1">for</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.2085.1">id</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2086.1">in</span></span><span class="koboSpan" id="kobo.2087.1"> Product.objects.values_list(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2088.1">'id'</span></span><span class="koboSpan" id="kobo.2089.1">, flat=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.2090.1">True</span></span><span class="koboSpan" id="kobo.2091.1">):
        r.delete(self.get_product_key(</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2092.1">id</span></span><span class="koboSpan" id="kobo.2093.1">))
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2094.1">Let’s try the recommendation engine. </span><span class="koboSpan" id="kobo.2094.2">Make sure you include several </span><code class="inlineCode"><span class="koboSpan" id="kobo.2095.1">Product</span></code><span class="koboSpan" id="kobo.2096.1"> objects in the database and initialize the Redis Docker container using the following command:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2097.1">docker run -it --rm --name redis -p 6379:6379 redis:7.2.4
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2098.1">Open another shell and run the following command to open the Python shell:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2099.1">python manage.py shell
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2100.1">Make sure that you have at least four different products in your database. </span><span class="koboSpan" id="kobo.2100.2">Retrieve four different products </span><a id="_idIndexMarker965"/><span class="koboSpan" id="kobo.2101.1">by their names:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2102.1">&gt;&gt;&gt;</span></span> <span class="hljs-con-keyword"><span class="koboSpan" id="kobo.2103.1">from</span></span><span class="language-python"><span class="koboSpan" id="kobo.2104.1"> shop.models </span></span><span class="hljs-con-keyword"><span class="koboSpan" id="kobo.2105.1">import</span></span><span class="language-python"><span class="koboSpan" id="kobo.2106.1"> Product</span></span>
<span class="hljs-con-meta"><span class="koboSpan" id="kobo.2107.1">&gt;&gt;&gt;</span></span> <span class="language-python"><span class="koboSpan" id="kobo.2108.1">black_tea = Product.objects.get(name=</span></span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2109.1">'Black tea'</span></span><span class="language-python"><span class="koboSpan" id="kobo.2110.1">)</span></span>
<span class="hljs-con-meta"><span class="koboSpan" id="kobo.2111.1">&gt;&gt;&gt;</span></span> <span class="language-python"><span class="koboSpan" id="kobo.2112.1">red_tea = Product.objects.get(name=</span></span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2113.1">'Red tea'</span></span><span class="language-python"><span class="koboSpan" id="kobo.2114.1">)</span></span>
<span class="hljs-con-meta"><span class="koboSpan" id="kobo.2115.1">&gt;&gt;&gt;</span></span> <span class="language-python"><span class="koboSpan" id="kobo.2116.1">green_tea = Product.objects.get(name=</span></span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2117.1">'Green tea'</span></span><span class="language-python"><span class="koboSpan" id="kobo.2118.1">)</span></span>
<span class="hljs-con-meta"><span class="koboSpan" id="kobo.2119.1">&gt;&gt;&gt;</span></span> <span class="language-python"><span class="koboSpan" id="kobo.2120.1">tea_powder = Product.objects.get(name=</span></span><span class="hljs-con-string"><span class="koboSpan" id="kobo.2121.1">'Tea powder'</span></span><span class="language-python"><span class="koboSpan" id="kobo.2122.1">)</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2123.1">Then, add some test purchases to the recommendation engine:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2124.1">&gt;&gt;&gt;</span></span> <span class="hljs-con-keyword"><span class="koboSpan" id="kobo.2125.1">from</span></span><span class="language-python"><span class="koboSpan" id="kobo.2126.1"> shop.recommender </span></span><span class="hljs-con-keyword"><span class="koboSpan" id="kobo.2127.1">import</span></span><span class="language-python"><span class="koboSpan" id="kobo.2128.1"> Recommender</span></span>
<span class="hljs-con-meta"><span class="koboSpan" id="kobo.2129.1">&gt;&gt;&gt;</span></span> <span class="language-python"><span class="koboSpan" id="kobo.2130.1">r = Recommender()</span></span>
<span class="hljs-con-meta"><span class="koboSpan" id="kobo.2131.1">&gt;&gt;&gt;</span></span> <span class="language-python"><span class="koboSpan" id="kobo.2132.1">r.products_bought([black_tea, red_tea])</span></span>
<span class="hljs-con-meta"><span class="koboSpan" id="kobo.2133.1">&gt;&gt;&gt;</span></span> <span class="language-python"><span class="koboSpan" id="kobo.2134.1">r.products_bought([black_tea, green_tea])</span></span>
<span class="hljs-con-meta"><span class="koboSpan" id="kobo.2135.1">&gt;&gt;&gt;</span></span> <span class="language-python"><span class="koboSpan" id="kobo.2136.1">r.products_bought([red_tea, black_tea, tea_powder])</span></span>
<span class="hljs-con-meta"><span class="koboSpan" id="kobo.2137.1">&gt;&gt;&gt;</span></span> <span class="language-python"><span class="koboSpan" id="kobo.2138.1">r.products_bought([green_tea, tea_powder])</span></span>
<span class="hljs-con-meta"><span class="koboSpan" id="kobo.2139.1">&gt;&gt;&gt;</span></span> <span class="language-python"><span class="koboSpan" id="kobo.2140.1">r.products_bought([black_tea, tea_powder])</span></span>
<span class="hljs-con-meta"><span class="koboSpan" id="kobo.2141.1">&gt;&gt;&gt;</span></span> <span class="language-python"><span class="koboSpan" id="kobo.2142.1">r.products_bought([red_tea, green_tea])</span></span>
</code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2143.1">You have stored the following scores:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="koboSpan" id="kobo.2144.1">black_tea:  red_tea (2), tea_powder (2), green_tea (1)
red_tea:    black_tea (2), tea_powder (1), green_tea (1)
green_tea:  black_tea (1), tea_powder (1), red_tea(1)
tea_powder: black_tea (2), red_tea (1), green_tea (1)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2145.1">This is a representation of products that have been bought together with each of the products, including how many times they have been bought together.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2146.1">Let’s retrieve product recommendations for a single product:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2147.1">&gt;&gt;&gt;</span></span> <span class="language-python"><span class="koboSpan" id="kobo.2148.1">r.suggest_products_for([black_tea])</span></span><span class="koboSpan" id="kobo.2149.1">
[&lt;Product: Tea powder&gt;, &lt;Product: Red tea&gt;, &lt;Product: Green tea&gt;]
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2150.1">&gt;&gt;&gt;</span></span> <span class="language-python"><span class="koboSpan" id="kobo.2151.1">r.suggest_products_for([red_tea])</span></span><span class="koboSpan" id="kobo.2152.1">
[&lt;Product: Black tea&gt;, &lt;Product: Tea powder&gt;, &lt;Product: Green tea&gt;]
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2153.1">&gt;&gt;&gt;</span></span> <span class="language-python"><span class="koboSpan" id="kobo.2154.1">r.suggest_products_for([green_tea])</span></span><span class="koboSpan" id="kobo.2155.1">
[&lt;Product: Black tea&gt;, &lt;Product: Tea powder&gt;, &lt;Product: Red tea&gt;]
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2156.1">&gt;&gt;&gt;</span></span> <span class="language-python"><span class="koboSpan" id="kobo.2157.1">r.suggest_products_for([tea_powder])</span></span><span class="koboSpan" id="kobo.2158.1">
[&lt;Product: Black tea&gt;, &lt;Product: Red tea&gt;, &lt;Product: Green tea&gt;]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2159.1">You can see that the order for recommended products is based on their score. </span><span class="koboSpan" id="kobo.2159.2">Let’s get recommendations for multiple products with aggregated scores:</span></p>
<pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2160.1">&gt;</span></span><span class="language-bash"><span class="koboSpan" id="kobo.2161.1">&gt;&gt; r.suggest_products_for([black_tea, red_tea])</span></span><span class="koboSpan" id="kobo.2162.1">
[&lt;Product: Tea powder&gt;, &lt;Product: Green tea&gt;]
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2163.1">&gt;</span></span><span class="language-bash"><span class="koboSpan" id="kobo.2164.1">&gt;&gt; r.suggest_products_for([green_tea, red_tea])</span></span><span class="koboSpan" id="kobo.2165.1">
[&lt;Product: Black tea&gt;, &lt;Product: Tea powder&gt;]
</span><span class="hljs-con-meta"><span class="koboSpan" id="kobo.2166.1">&gt;</span></span><span class="language-bash"><span class="koboSpan" id="kobo.2167.1">&gt;&gt; r.suggest_products_for([tea_powder, black_tea])</span></span><span class="koboSpan" id="kobo.2168.1">
[&lt;Product: Red tea&gt;, &lt;Product: Green tea&gt;]
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2169.1">You can see</span><a id="_idIndexMarker966"/><span class="koboSpan" id="kobo.2170.1"> that the order of the suggested products matches the aggregated scores. </span><span class="koboSpan" id="kobo.2170.2">For example, products suggested for </span><code class="inlineCode"><span class="koboSpan" id="kobo.2171.1">black_tea</span></code><span class="koboSpan" id="kobo.2172.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2173.1">red_tea</span></code><span class="koboSpan" id="kobo.2174.1"> are </span><code class="inlineCode"><span class="koboSpan" id="kobo.2175.1">tea_powder</span></code><span class="koboSpan" id="kobo.2176.1"> (</span><code class="inlineCode"><span class="koboSpan" id="kobo.2177.1">2+1</span></code><span class="koboSpan" id="kobo.2178.1">) and </span><code class="inlineCode"><span class="koboSpan" id="kobo.2179.1">green_tea</span></code><span class="koboSpan" id="kobo.2180.1"> (</span><code class="inlineCode"><span class="koboSpan" id="kobo.2181.1">1+1</span></code><span class="koboSpan" id="kobo.2182.1">).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2183.1">You have verified that your recommendation algorithm works as expected.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2184.1">Let’s store the products that are bought together every time a payment is confirmed. </span><span class="koboSpan" id="kobo.2184.2">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2185.1">webhooks.py</span></code><span class="koboSpan" id="kobo.2186.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2187.1">payment</span></code><span class="koboSpan" id="kobo.2188.1"> application and add the following code highlighted in bold:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="hljs-comment"><span class="koboSpan" id="kobo.2189.1"># ...</span></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2190.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2191.1"> shop.models </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2192.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2193.1"> Product</span></strong></span>
<span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2194.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2195.1"> shop.recommender </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2196.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2197.1"> Recommender</span></strong></span>
<span class="hljs-meta"><span class="koboSpan" id="kobo.2198.1">@csrf_exempt</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2199.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2200.1">stripe_webhook</span></span><span class="koboSpan" id="kobo.2201.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2202.1">request</span></span><span class="koboSpan" id="kobo.2203.1">):
    </span><span class="hljs-comment"><span class="koboSpan" id="kobo.2204.1"># ...</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2205.1">if</span></span><span class="koboSpan" id="kobo.2206.1"> event.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2207.1">type</span></span><span class="koboSpan" id="kobo.2208.1"> == </span><span class="hljs-string"><span class="koboSpan" id="kobo.2209.1">'checkout.session.completed'</span></span><span class="koboSpan" id="kobo.2210.1">:
        session = event.data.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2211.1">object</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2212.1">if</span></span><span class="koboSpan" id="kobo.2213.1"> (
            session.mode == </span><span class="hljs-string"><span class="koboSpan" id="kobo.2214.1">'payment'</span></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2215.1">and</span></span><span class="koboSpan" id="kobo.2216.1"> session.payment_status == </span><span class="hljs-string"><span class="koboSpan" id="kobo.2217.1">'paid'</span></span><span class="koboSpan" id="kobo.2218.1">
        ):
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2219.1">try</span></span><span class="koboSpan" id="kobo.2220.1">:
                order = Order.objects.get(
                    </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2221.1">id</span></span><span class="koboSpan" id="kobo.2222.1">=session.client_reference_id
                )
            </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2223.1">except</span></span><span class="koboSpan" id="kobo.2224.1"> Order.DoesNotExist:
                </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2225.1">return</span></span><span class="koboSpan" id="kobo.2226.1"> HttpResponse(status=</span><span class="hljs-number"><span class="koboSpan" id="kobo.2227.1">404</span></span><span class="koboSpan" id="kobo.2228.1">)
            </span><span class="hljs-comment"><span class="koboSpan" id="kobo.2229.1"># mark order as paid</span></span><span class="koboSpan" id="kobo.2230.1">
            order.paid = </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2231.1">True</span></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.2232.1"># store Stripe payment ID</span></span><span class="koboSpan" id="kobo.2233.1">
            order.stripe_id = session.payment_intent
            order.save()
            </span><span class="code-highlight"><strong class="hljs-comment-slc"><span class="koboSpan" id="kobo.2234.1"># save items bought for product recommendations</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2235.1">            product_ids = order.items.values_list(</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2236.1">'product_id'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2237.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2238.1">            products = Product.objects.</span></strong><strong class="hljs-built_in-slc"><span class="koboSpan" id="kobo.2239.1">filter</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2240.1">(id__in=product_ids)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2241.1">            r = Recommender()</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2242.1">            r.products_bought(products)</span></strong></span>
<span class="hljs-comment"><span class="koboSpan" id="kobo.2243.1"># launch asynchronous task</span></span><span class="koboSpan" id="kobo.2244.1">
            payment_completed.delay(order.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2245.1">id</span></span><span class="koboSpan" id="kobo.2246.1">)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2247.1">return</span></span><span class="koboSpan" id="kobo.2248.1"> HttpResponse(status=</span><span class="hljs-number"><span class="koboSpan" id="kobo.2249.1">200</span></span><span class="koboSpan" id="kobo.2250.1">)
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2251.1">In the new code, when a</span><a id="_idIndexMarker967"/><span class="koboSpan" id="kobo.2252.1"> new order payment is confirmed, you retrieve the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2253.1">Product</span></code><span class="koboSpan" id="kobo.2254.1"> objects associated with the order items. </span><span class="koboSpan" id="kobo.2254.2">Then, you create an instance of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2255.1">Recommender</span></code><span class="koboSpan" id="kobo.2256.1"> class and call the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2257.1">products_bought()</span></code><span class="koboSpan" id="kobo.2258.1"> method to store the products bought together in Redis.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2259.1">You are now storing the related products that are bought together when orders are paid. </span><span class="koboSpan" id="kobo.2259.2">Let’s now display recommendations for products on your site.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2260.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2261.1">views.py</span></code><span class="koboSpan" id="kobo.2262.1"> file of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2263.1">shop</span></code><span class="koboSpan" id="kobo.2264.1"> application. </span><span class="koboSpan" id="kobo.2264.2">Add the functionality to retrieve a maximum of four recommended products into the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2265.1">product_detail</span></code><span class="koboSpan" id="kobo.2266.1"> view, as follows:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2267.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2268.1"> .recommender </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2269.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2270.1"> Recommender</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2271.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2272.1">product_detail</span></span><span class="koboSpan" id="kobo.2273.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2274.1">request, </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2275.1">id</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.2276.1">, slug</span></span><span class="koboSpan" id="kobo.2277.1">):
    product = get_object_or_404(
        Product, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2278.1">id</span></span><span class="koboSpan" id="kobo.2279.1">=</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2280.1">id</span></span><span class="koboSpan" id="kobo.2281.1">, slug=slug, available=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.2282.1">True</span></span>
<span class="hljs-literal"> </span><span class="koboSpan" id="kobo.2283.1">)
    cart_product_form = CartAddProductForm()
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2284.1">    r = Recommender()</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2285.1">    recommended_products = r.suggest_products_for([product], </span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.2286.1">4</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2287.1">)</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2288.1">return</span></span><span class="koboSpan" id="kobo.2289.1"> render(
        request,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2290.1">'shop/product/detail.html'</span></span><span class="koboSpan" id="kobo.2291.1">,
        {
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.2292.1">'product'</span></span><span class="koboSpan" id="kobo.2293.1">: product,
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.2294.1">'cart_product_form'</span></span><span class="koboSpan" id="kobo.2295.1">: cart_product_form</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2296.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2297.1">           'recommended_products'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2298.1">: recommended_products</span></strong></span><span class="koboSpan" id="kobo.2299.1">
        }
    )
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2300.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2301.1">shop/product/detail.html</span></code><span class="koboSpan" id="kobo.2302.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2303.1">shop</span></code><span class="koboSpan" id="kobo.2304.1"> application and add the following code</span><a id="_idIndexMarker968"/><span class="koboSpan" id="kobo.2305.1"> after </span><code class="inlineCode"><span class="koboSpan" id="kobo.2306.1">{{ product.description|linebreaks }}</span></code><span class="koboSpan" id="kobo.2307.1">:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2308.1">{% if recommended_products %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2309.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2310.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2311.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2312.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2313.1">"recommendations"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2314.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2315.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2316.1">h3</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2317.1">&gt;</span></span><span class="koboSpan" id="kobo.2318.1">People who bought this also bought</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2319.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2320.1">h3</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2321.1">&gt;</span></span><span class="koboSpan" id="kobo.2322.1">
    {% for p in recommended_products %}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2323.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2324.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2325.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2326.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2327.1">"item"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2328.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2329.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2330.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2331.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2332.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2333.1">"{{ p.get_absolute_url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2334.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2335.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2336.1">img</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2337.1">src</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2338.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2339.1">"{% if p.image %}{{ p.image.url }}{% else %}</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.2340.1">          {% static  "img/no_image.png" %}{% endif %}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2341.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2342.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2343.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2344.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2345.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2346.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2347.1">&gt;&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2348.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2349.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2350.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2351.1">"{{ p.get_absolute_url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2352.1">&gt;</span></span><span class="koboSpan" id="kobo.2353.1">{{ p.name }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2354.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2355.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2356.1">&gt;&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2357.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2358.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2359.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2360.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2361.1">&gt;</span></span><span class="koboSpan" id="kobo.2362.1">
    {% endfor %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2363.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2364.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2365.1">&gt;</span></span><span class="koboSpan" id="kobo.2366.1">
{% endif %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2367.1">Run the development server, and open </span><code class="inlineCode"><span class="koboSpan" id="kobo.2368.1">http://127.0.0.1:8000/</span></code><span class="koboSpan" id="kobo.2369.1"> in your browser. </span><span class="koboSpan" id="kobo.2369.2">Click on any product to view its details. </span><span class="koboSpan" id="kobo.2369.3">You should see that recommended products are displayed below the</span><a id="_idIndexMarker969"/><span class="koboSpan" id="kobo.2370.1"> product, as shown in </span><em class="italic"><span class="koboSpan" id="kobo.2371.1">Figure 10.18</span></em><span class="koboSpan" id="kobo.2372.1">:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2373.1"><img alt="" role="presentation" src="../Images/B21088_10_18.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2374.1">Figure 10.18: The product detail page, including recommended products</span></p>
<div class="note">
<p class="normal"><span class="koboSpan" id="kobo.2375.1">Images in this chapter:</span></p>
<ul>
<li class="bulletList"><em class="italic"><span class="koboSpan" id="kobo.2376.1">Green tea</span></em><span class="koboSpan" id="kobo.2377.1">: Photo by Jia Ye on Unsplash</span></li>
<li class="bulletList"><em class="italic"><span class="koboSpan" id="kobo.2378.1">Red tea</span></em><span class="koboSpan" id="kobo.2379.1">: Photo by Manki Kim on Unsplash</span></li>
<li class="bulletList"><em class="italic"><span class="koboSpan" id="kobo.2380.1">Tea powder</span></em><span class="koboSpan" id="kobo.2381.1">: Photo by Phuong Nguyen on Unsplash</span></li>
</ul>
</div>
<p class="normal"><span class="koboSpan" id="kobo.2382.1">You are also going to include product recommendations in the cart. </span><span class="koboSpan" id="kobo.2382.2">The recommendations will be based on the products that the user has added to the cart.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2383.1">Edit </span><code class="inlineCode"><span class="koboSpan" id="kobo.2384.1">views.py</span></code><span class="koboSpan" id="kobo.2385.1"> inside the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2386.1">cart</span></code><span class="koboSpan" id="kobo.2387.1"> application, import the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2388.1">Recommender</span></code><span class="koboSpan" id="kobo.2389.1"> class, and edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2390.1">cart_detail</span></code><span class="koboSpan" id="kobo.2391.1"> view to </span><a id="_idIndexMarker970"/><span class="koboSpan" id="kobo.2392.1">make it look like the following:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="code-highlight"><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2393.1">from</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2394.1"> shop.recommender </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2395.1">import</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2396.1"> Recommender</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2397.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2398.1">cart_detail</span></span><span class="koboSpan" id="kobo.2399.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2400.1">request</span></span><span class="koboSpan" id="kobo.2401.1">):
    cart = Cart(request)
    </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2402.1">for</span></span><span class="koboSpan" id="kobo.2403.1"> item </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2404.1">in</span></span><span class="koboSpan" id="kobo.2405.1"> cart:
        item[</span><span class="hljs-string"><span class="koboSpan" id="kobo.2406.1">'update_quantity_form'</span></span><span class="koboSpan" id="kobo.2407.1">] = CartAddProductForm(
            initial={</span><span class="hljs-string"><span class="koboSpan" id="kobo.2408.1">'quantity'</span></span><span class="koboSpan" id="kobo.2409.1">: item[</span><span class="hljs-string"><span class="koboSpan" id="kobo.2410.1">'quantity'</span></span><span class="koboSpan" id="kobo.2411.1">], </span><span class="hljs-string"><span class="koboSpan" id="kobo.2412.1">'override'</span></span><span class="koboSpan" id="kobo.2413.1">: </span><span class="hljs-literal"><span class="koboSpan" id="kobo.2414.1">True</span></span><span class="koboSpan" id="kobo.2415.1">}
        )
    coupon_apply_form = CouponApplyForm()
</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2416.1">    r = Recommender()</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2417.1">    cart_products = [item[</span></strong><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2418.1">'product'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2419.1">] </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2420.1">for</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2421.1"> item </span></strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2422.1">in</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2423.1"> cart]</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2424.1">if</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2425.1">(cart_products):</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2426.1">        recommended_products = r.suggest_products_for(</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2427.1">            cart_products, max_results=</span></strong><strong class="hljs-number-slc"><span class="koboSpan" id="kobo.2428.1">4</span></strong></span>
<span class="code-highlight"><strong class="hljs-number-slc"> </strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2429.1">)</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc"><span class="koboSpan" id="kobo.2430.1">else</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2431.1">:</span></strong></span>
<span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2432.1">        recommended_products = []</span></strong></span>
<span class="hljs-keyword"><span class="koboSpan" id="kobo.2433.1">return</span></span><span class="koboSpan" id="kobo.2434.1"> render(
        request,
        </span><span class="hljs-string"><span class="koboSpan" id="kobo.2435.1">'cart/detail.html'</span></span><span class="koboSpan" id="kobo.2436.1">,
        {
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.2437.1">'cart'</span></span><span class="koboSpan" id="kobo.2438.1">: cart,
            </span><span class="hljs-string"><span class="koboSpan" id="kobo.2439.1">'coupon_apply_form'</span></span><span class="koboSpan" id="kobo.2440.1">: coupon_apply_form</span><span class="code-highlight"><strong class="hljs-slc"><span class="koboSpan" id="kobo.2441.1">,</span></strong></span>
<span class="code-highlight"><strong class="hljs-string-slc"><span class="koboSpan" id="kobo.2442.1">           'recommended_products'</span></strong><strong class="hljs-slc"><span class="koboSpan" id="kobo.2443.1">: recommended_products})</span></strong></span><span class="koboSpan" id="kobo.2444.1">
        }
    )
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2445.1">Edit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2446.1">cart/detail.html</span></code><span class="koboSpan" id="kobo.2447.1"> template of the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2448.1">cart</span></code><span class="koboSpan" id="kobo.2449.1"> application and add the following code just after the </span><code class="inlineCode"><span class="koboSpan" id="kobo.2450.1">&lt;/table&gt;</span></code><span class="koboSpan" id="kobo.2451.1"> HTML tag:</span></p>
<pre class="programlisting code"><code class="hljs-code"><span class="koboSpan" id="kobo.2452.1">{% if recommended_products %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2453.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2454.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2455.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2456.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2457.1">"recommendations cart"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2458.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2459.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2460.1">h3</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2461.1">&gt;</span></span><span class="koboSpan" id="kobo.2462.1">People who bought this also bought</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2463.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2464.1">h3</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2465.1">&gt;</span></span><span class="koboSpan" id="kobo.2466.1">
    {% for p in recommended_products %}
      </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2467.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2468.1">div</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2469.1">class</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2470.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2471.1">"item"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2472.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2473.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2474.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2475.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2476.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2477.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2478.1">{{ p.get_absolute_url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2479.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2480.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2481.1">img</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2482.1">src</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2483.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2484.1">"{% if p.image %}{{ p.image.url }}{% else %}</span></span>
<span class="hljs-string"><span class="koboSpan" id="kobo.2485.1">          {% static "</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.2486.1">img</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2487.1">/</span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.2488.1">no_image.png</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2489.1">" %}{% </span></span><span class="hljs-attr"><span class="koboSpan" id="kobo.2490.1">endif</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2491.1"> %}"&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2492.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2493.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2494.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2495.1">&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2496.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2497.1">&gt;&lt;</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2498.1">a</span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="koboSpan" id="kobo.2499.1">href</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2500.1">=</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.2501.1">"{{ p.get_absolute_url }}"</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2502.1">&gt;</span></span><span class="koboSpan" id="kobo.2503.1">{{ p.name }}</span><span class="hljs-tag"><span class="koboSpan" id="kobo.2504.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2505.1">a</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2506.1">&gt;&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2507.1">p</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2508.1">&gt;</span></span>
<span class="hljs-tag"><span class="koboSpan" id="kobo.2509.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2510.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2511.1">&gt;</span></span><span class="koboSpan" id="kobo.2512.1">
    {% endfor %}
  </span><span class="hljs-tag"><span class="koboSpan" id="kobo.2513.1">&lt;/</span></span><span class="hljs-name"><span class="koboSpan" id="kobo.2514.1">div</span></span><span class="hljs-tag"><span class="koboSpan" id="kobo.2515.1">&gt;</span></span><span class="koboSpan" id="kobo.2516.1">
{% endif %}
</span></code></pre>
<p class="normal"><span class="koboSpan" id="kobo.2517.1">Open </span><code class="inlineCode"><span class="koboSpan" id="kobo.2518.1">http://127.0.0.1:8000/en/</span></code><span class="koboSpan" id="kobo.2519.1"> in your browser and add a couple of products to your cart. </span><span class="koboSpan" id="kobo.2519.2">When you navigate to </span><code class="inlineCode"><span class="koboSpan" id="kobo.2520.1">http://127.0.0.1:8000/en/cart/</span></code><span class="koboSpan" id="kobo.2521.1">, you should see the aggregated product</span><a id="_idIndexMarker971"/><span class="koboSpan" id="kobo.2522.1"> recommendations for the items in the cart, as follows:</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2523.1"><img alt="" role="presentation" src="../Images/B21088_10_19.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2524.1">Figure 10.19: The shopping cart details page, including recommended products</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2525.1">Congratulations! </span><span class="koboSpan" id="kobo.2525.2">You</span><a id="_idIndexMarker972"/><span class="koboSpan" id="kobo.2526.1"> have built a complete recommendation engine using Django and Redis.</span></p>
<h1 class="heading-1" id="_idParaDest-293"><span class="koboSpan" id="kobo.2527.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2528.1">In this chapter, you created a coupon system using Django sessions and integrated it with Stripe. </span><span class="koboSpan" id="kobo.2528.2">You also built a recommendation engine using Redis to recommend products that are usually purchased together.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2529.1">The next chapter will give you an insight into the internationalization and localization of Django projects. </span><span class="koboSpan" id="kobo.2529.2">You will learn how to translate code and manage translations with Rosetta. </span><span class="koboSpan" id="kobo.2529.3">You will implement URLs for translations and build a language selector. </span><span class="koboSpan" id="kobo.2529.4">You will also implement model translations using </span><code class="inlineCode"><span class="koboSpan" id="kobo.2530.1">django-parler</span></code><span class="koboSpan" id="kobo.2531.1"> and you will validate localized form fields using </span><code class="inlineCode"><span class="koboSpan" id="kobo.2532.1">django-localflavor</span></code><span class="koboSpan" id="kobo.2533.1">.</span></p>
<h1 class="heading-1" id="_idParaDest-294"><span class="koboSpan" id="kobo.2534.1">Additional resources</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2535.1">The following resources provide additional information related to the topics covered in this chapter:</span></p>
<ul>
<li class="bulletList"><span class="koboSpan" id="kobo.2536.1">Source code for this chapter: </span><a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter10"><span class="url"><span class="koboSpan" id="kobo.2537.1">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter10</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2538.1">Discounts for Stripe Checkout: </span><a href="https://stripe.com/docs/payments/checkout/discounts"><span class="url"><span class="koboSpan" id="kobo.2539.1">https://stripe.com/docs/payments/checkout/discounts</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2540.1">The Redis </span><code class="inlineCode"><span class="koboSpan" id="kobo.2541.1">ZRANGE</span></code><span class="koboSpan" id="kobo.2542.1"> command: </span><a href="https://redis.io/commands/zrange/"><span class="url"><span class="koboSpan" id="kobo.2543.1">https://redis.io/commands/zrange/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2544.1">The Redis </span><code class="inlineCode"><span class="koboSpan" id="kobo.2545.1">ZUNIONSTORE</span></code><span class="koboSpan" id="kobo.2546.1"> command: </span><a href="https://redis.io/commands/zunionstore/"><span class="url"><span class="koboSpan" id="kobo.2547.1">https://redis.io/commands/zunionstore/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2548.1">The Redis </span><code class="inlineCode"><span class="koboSpan" id="kobo.2549.1">ZREM</span></code><span class="koboSpan" id="kobo.2550.1"> command: </span><a href="https://redis.io/commands/zrem/"><span class="url"><span class="koboSpan" id="kobo.2551.1">https://redis.io/commands/zrem/</span></span></a></li>
<li class="bulletList"><span class="koboSpan" id="kobo.2552.1">The Redis </span><code class="inlineCode"><span class="koboSpan" id="kobo.2553.1">DEL</span></code><span class="koboSpan" id="kobo.2554.1"> command: </span><a href="https://redis.io/commands/del/"><span class="url"><span class="koboSpan" id="kobo.2555.1">https://redis.io/commands/del/</span></span></a></li>
</ul>
</div>
</body></html>