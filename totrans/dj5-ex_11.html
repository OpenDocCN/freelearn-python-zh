<html><head></head><body>
<div><h1 class="chapterNumber">11</h1>
<h1 class="chapterTitle" id="_idParaDest-295">Adding Internationalization to Your Shop</h1>
<p class="normal">In the previous chapter, you added a coupon system to your shop and built a product recommendation engine.</p>
<p class="normal">In this chapter, you will learn how internationalization and localization work. By making your application accessible in multiple languages, you can serve a wider range of users. Additionally, by adapting your application to local formatting conventions such as date or number formatting, you improve its usability. By translating and localizing your application, you will make it more intuitive for users from different cultural backgrounds and increase user engagement.</p>
<p class="normal">This chapter will cover the following topics:</p>
<ul>
<li class="bulletList">Preparing your project for internationalization</li>
<li class="bulletList">Managing translation files</li>
<li class="bulletList">Translating Python code</li>
<li class="bulletList">Translating templates</li>
<li class="bulletList">Using Rosetta to manage translations</li>
<li class="bulletList">Translating URL patterns and using a language prefix in URLs</li>
<li class="bulletList">Allowing users to switch language</li>
<li class="bulletList">Translating models using <code class="inlineCode">django-parler</code></li>
<li class="bulletList">Using model translations with the ORM</li>
<li class="bulletList">Adapting views to use translations</li>
<li class="bulletList">Using the localized form fields of <code class="inlineCode">django-localflavor</code></li>
</ul>
<h1 class="heading-1" id="_idParaDest-296">Functional overview</h1>
<p class="normal"><em class="italic">Figure 11.1</em> shows a representation of the views, templates, and functionalities that will be built in this chapter:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_11_01.png"/></figure>
<p class="packt_figref">Figure 11.1: Diagram of the functionalities built in Chapter 11</p>
<p class="normal">In this chapter, you will implement internationalization in your project and translate templates, URLs, and models. You will add language selection links to the header of your site and create language-specific URLs. You will modify the <code class="inlineCode">product_list</code> and <code class="inlineCode">product_detail</code> views of the <code class="inlineCode">shop</code> application to retrieve <code class="inlineCode">Category</code> and <code class="inlineCode">Product</code> objects by their translated slugs. You will also add a localized postal code field to the form used in the <code class="inlineCode">order_create</code> view.</p>
<p class="normal">The source code for this chapter can be found at <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter11">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter11</a>.</p>
<p class="normal">All the Python modules used in this chapter are included in the <code class="inlineCode">requirements.txt</code> file in the source code that comes with this chapter. You can follow the instructions to install each Python module below, or you can install all the requirements at once with the command <code class="inlineCode">python -m pip install -r requirements.txt</code>.</p>
<h1 class="heading-1" id="_idParaDest-297">Internationalization with Django</h1>
<p class="normal">Django offers full internationalization<a id="_idIndexMarker973"/> and<a id="_idIndexMarker974"/> localization support. It allows you to translate your application into multiple languages, and it handles locale-specific formatting for dates, times, numbers, and time zones. Let’s clarify the difference between internationalization and localization:</p>
<ul>
<li class="bulletList"><strong class="keyWord">Internationalization</strong> (frequently abbreviated to <strong class="keyWord">i18n</strong>) is the process of adapting software for<a id="_idIndexMarker975"/> the potential use of different languages and locales so that it isn’t hardwired to a specific language or locale.</li>
<li class="bulletList"><strong class="keyWord">Localization</strong> (abbreviated to <strong class="keyWord">l10n</strong>) is the<a id="_idIndexMarker976"/> process of actually translating the software and adapting it to a particular locale. Django itself is translated into more than 50 languages using its internationalization framework.</li>
</ul>
<p class="normal">The internationalization framework allows you to easily mark strings for translation, both in Python code and in your templates. It relies on the GNU <code class="inlineCode">gettext</code> toolset to generate and manage message files. A <strong class="keyWord">message file</strong> is<a id="_idIndexMarker977"/> a plain text file that represents a language. It contains a part, or all, of the translation strings found in your application and their respective translations for a single language. Message files have the <code class="inlineCode">.po</code> extension. Once the translation is done, message files are compiled to offer rapid access to translated strings. The compiled translation files have the <code class="inlineCode">.mo</code> extension.</p>
<p class="normal">Let’s review the settings that Django provides for internationalization and localization.</p>
<h2 class="heading-2" id="_idParaDest-298">Internationalization and localization settings</h2>
<p class="normal">Django <a id="_idIndexMarker978"/>provides several settings for internationalization. The following <a id="_idIndexMarker979"/>settings are the most relevant ones:</p>
<ul>
<li class="bulletList"><code class="inlineCode">USE_I18N</code>: A Boolean that specifies whether Django’s translation system is enabled. This is <code class="inlineCode">True</code> by default.</li>
<li class="bulletList"><code class="inlineCode">USE_TZ</code>: A Boolean that specifies whether datetimes are time-zone-aware. When you create a project with the <code class="inlineCode">startproject</code> command, this is set to <code class="inlineCode">True</code>.</li>
<li class="bulletList"><code class="inlineCode">LANGUAGE_CODE</code>: The default language code for the project. This is in the standard language ID format, for example, <code class="inlineCode">en-us</code> for American English or <code class="inlineCode">en-gb</code> for British English. This setting requires <code class="inlineCode">USE_I18N</code> to be set to <code class="inlineCode">True</code> in order to take effect. You can find a list of<a id="_idIndexMarker980"/> valid language IDs at <code class="inlineCode">http://www.i18nguy.com/unicode/language-identifiers.html</code>.</li>
<li class="bulletList"><code class="inlineCode">LANGUAGES</code>: A tuple that contains available languages for the project. They come in two tuples with a <strong class="keyWord">language code</strong> and a <strong class="keyWord">language name</strong>. You can see the list of available languages at <code class="inlineCode">django.conf.global_settings</code>. When you choose which languages your site will be available in, you set <code class="inlineCode">LANGUAGES</code> to a subset of that list.</li>
<li class="bulletList"><code class="inlineCode">LOCALE_PATHS</code>: A list of directories where Django looks for message files containing translations for the project.</li>
<li class="bulletList"><code class="inlineCode">TIME_ZONE</code>: A string that represents the time zone for the project. This is set to <code class="inlineCode">'UTC'</code> when you create a new project using the <code class="inlineCode">startproject</code> command. You can set it to any other time zone, such as <code class="inlineCode">'Europe/Madrid'</code>.</li>
</ul>
<p class="normal">These are some of the internationalization and localization settings available. You can find the full list at <a href="https://docs.djangoproject.com/en/5.0/ref/settings/#globalization-i18n-l10n">https://docs.djangoproject.com/en/5.0/ref/settings/#globalization-i18n-l10n</a>.</p>
<p class="normal">After reviewing the most important settings for internationalization and localization, let’s learn how we can create translations for our application.</p>
<h2 class="heading-2" id="_idParaDest-299">Internationalization management commands</h2>
<p class="normal">Django<a id="_idIndexMarker981"/> includes the following management commands to manage translations:</p>
<ul>
<li class="bulletList"><code class="inlineCode">makemessages</code>: This runs over the source tree to find all the strings marked for translation and creates or updates the <code class="inlineCode">.po</code> message files in the <code class="inlineCode">locale</code> directory. A single <code class="inlineCode">.po</code> file is created for each language.</li>
<li class="bulletList"><code class="inlineCode">compilemessages</code>: This compiles the existing <code class="inlineCode">.po</code> message files to <code class="inlineCode">.mo</code> files, which are used to retrieve translations.</li>
</ul>
<p class="normal">Django relies on the <code class="inlineCode">gettext</code> toolkit to generate and compile translation files. Let’s review how to install it.</p>
<h2 class="heading-2" id="_idParaDest-300">Installing the gettext toolkit</h2>
<p class="normal">You will need the<a id="_idIndexMarker982"/> <code class="inlineCode">gettext</code> toolkit to be able to create, update, and compile message files. Most Linux distributions include the <code class="inlineCode">gettext</code> toolkit. If you are using macOS, the simplest way to install it is via<a id="_idIndexMarker983"/> Homebrew, at <a href="https://brew.sh/">https://brew.sh/</a>, with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">brew install gettext
</code></pre>
<p class="normal">You might also need to force-link it with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">brew link --force gettext
</code></pre>
<p class="normal">If you are using Windows, follow the steps at <a href="https://docs.djangoproject.com/en/5.0/topics/i18n/translation/#gettext-on-windows">https://docs.djangoproject.com/en/5.0/topics/i18n/translation/#gettext-on-windows</a>. You can download a precompiled <code class="inlineCode">gettext</code> binary installer for Windows from <a href="https://mlocati.github.io/articles/gettext-iconv-windows.html">https://mlocati.github.io/articles/gettext-iconv-windows.html</a>.</p>
<p class="normal">Once you have installed the <code class="inlineCode">gettext</code> toolkit, you are all set to start translating your project. First, you need to understand the steps needed to translate your project and how Django determines the user’s language.</p>
<h2 class="heading-2" id="_idParaDest-301">How to add translations to a Django project</h2>
<p class="normal">Let’s<a id="_idIndexMarker984"/> explore the process of internationalizing your<a id="_idIndexMarker985"/> project. Here are the steps needed to translate a Django project:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">Mark the strings for translation in your Python code and your templates.</li>
<li class="numberedList">Run the <code class="inlineCode">makemessages</code> command to create or update message files that include all the translation strings from your code.</li>
<li class="numberedList">Translate the strings contained in the message files.</li>
<li class="numberedList">Compile the message files using the <code class="inlineCode">compilemessages</code> management command.</li>
</ol>
<p class="normal">We will follow this process to add translations to our project throughout this chapter.</p>
<p class="normal">Next, you are going to learn how Django determines the language of the current user.</p>
<h2 class="heading-2" id="_idParaDest-302">How Django determines the current language</h2>
<p class="normal">Django comes with a <a id="_idIndexMarker986"/>middleware that determines the current language based on the request data. This is the <code class="inlineCode">LocaleMiddleware</code> middleware that resides in <code class="inlineCode">django.middleware.locale.LocaleMiddleware</code>, which performs the following tasks:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">If you are using <code class="inlineCode">i18n_patterns</code>, that is, you are using translated URL patterns, it looks for a language prefix in the requested URL to determine the current language. You will learn to translate URL patterns in the <em class="italic">Translating URL patterns section</em>.</li>
<li class="numberedList">If no language prefix is found, it looks for an existing <code class="inlineCode">LANGUAGE_SESSION_KEY</code> in the current user’s session.</li>
<li class="numberedList">If the language is not set in the session, it looks for an existing cookie with the current language. A custom name for this cookie can be provided in the <code class="inlineCode">LANGUAGE_COOKIE_NAME</code> setting. By default, the name for this cookie is <code class="inlineCode">django_language</code>.</li>
<li class="numberedList">If no cookie is found, it looks for the <code class="inlineCode">Accept-Language</code> HTTP header of the request.</li>
<li class="numberedList">If the <code class="inlineCode">Accept-Language</code> header does not specify a language, Django uses the language defined in the <code class="inlineCode">LANGUAGE_CODE</code> setting.</li>
</ol>
<p class="normal">By default, Django will <a id="_idIndexMarker987"/>use the language defined in the <code class="inlineCode">LANGUAGE_CODE</code> setting unless you are using <code class="inlineCode">LocaleMiddleware</code>. The process described here only applies when using this middleware.</p>
<p class="normal">We can also let users change their language. You will learn about how to implement a language selector in the section <em class="italic">Allowing users to switch language</em>.</p>
<p class="normal">Let’s start by configuring our project for internationalization.</p>
<h1 class="heading-1" id="_idParaDest-303">Preparing your project for internationalization</h1>
<p class="normal">We will prepare our <a id="_idIndexMarker988"/>project to use different languages. We are going to create an English and a Spanish version for the online shop:</p>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of your project and add the following <code class="inlineCode">LANGUAGES</code> setting to it. Place it next to the <code class="inlineCode">LANGUAGE_CODE</code> setting:</p>
<pre class="programlisting code"><code class="hljs-code">LANGUAGES = [
    ('en', 'English'),
    ('es', 'Spanish'),
]
</code></pre>
<p class="normal">The <code class="inlineCode">LANGUAGES</code> setting contains two tuples that consist of a language code and a name. Language codes can be locale-specific, such as <code class="inlineCode">en-us</code> or <code class="inlineCode">en-gb</code>, or generic, such as <code class="inlineCode">en</code>. With this setting, you specify that your application will only be available in English and Spanish. If you don’t define a custom <code class="inlineCode">LANGUAGES</code> setting, the site will be available in all the languages that Django is translated into.</p>
<p class="normal">Make your <code class="inlineCode">LANGUAGE_CODE</code> setting look like the following:</p>
<pre class="programlisting code"><code class="hljs-code">LANGUAGE_CODE = <strong class="hljs-string-slc">'</strong><strong class="hljs-string-slc">en'</strong>
</code></pre>
<p class="normal">Add <code class="inlineCode">'django.middleware.locale.LocaleMiddleware'</code> to the <code class="inlineCode">MIDDLEWARE</code> setting. Make sure that this middleware comes after <code class="inlineCode">SessionMiddleware</code> because <code class="inlineCode">LocaleMiddleware</code> needs to use session data. It also has to be placed before <code class="inlineCode">CommonMiddleware</code> because the latter needs an active language to resolve the requested URL. The <code class="inlineCode">MIDDLEWARE</code> setting should now look like the following:</p>
<pre class="programlisting code"><code class="hljs-code">MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'django.middleware.locale.LocaleMiddleware'</strong><strong class="hljs-slc">,</strong>
'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]
</code></pre>
<div><p class="normal">The order of middleware classes is very important because each middleware can depend on data set by another middleware that was executed previously. Middleware is applied for requests in order of appearance in <code class="inlineCode">MIDDLEWARE</code>, and in reverse order for responses.</p>
</div>
<p class="normal">Create the <a id="_idIndexMarker989"/>following directory structure inside the main project directory, next to the <code class="inlineCode">manage.py</code> file:</p>
<pre class="programlisting con"><code class="hljs-con">locale/
    en/
    es/
</code></pre>
<p class="normal">The <code class="inlineCode">locale</code> directory is the place where message files for your application will reside.</p>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file again and add the following setting to it:</p>
<pre class="programlisting code"><code class="hljs-code">LOCALE_PATHS = [
    BASE_DIR / 'locale',
]
</code></pre>
<p class="normal">The <code class="inlineCode">LOCALE_PATHS</code> setting specifies the directories where Django has to look for translation files. Locale paths that appear first have the highest precedence.</p>
<p class="normal">When you use the <code class="inlineCode">makemessages</code> command from your project directory, message files will be generated in the <code class="inlineCode">locale/</code> path you created. However, for applications that contain a <code class="inlineCode">locale/</code> directory, message files will be<a id="_idIndexMarker990"/> generated in that directory.</p>
<p class="normal">Your project is now configured for internationalization. Next, you will learn how to translate strings in your Python code.</p>
<h1 class="heading-1" id="_idParaDest-304">Translating Python code</h1>
<p class="normal">We will explore various methods to handle <a id="_idIndexMarker991"/>translations within Python code. We <a id="_idIndexMarker992"/>will cover<a id="_idIndexMarker993"/> the following methods:</p>
<ul>
<li class="bulletList"><strong class="keyWord">Standard translations</strong></li>
<li class="bulletList"><strong class="keyWord">Lazy translations</strong>: Executed <a id="_idIndexMarker994"/>when the value is accessed rather than when the<a id="_idIndexMarker995"/> function is called.</li>
<li class="bulletList"><strong class="keyWord">Translations including variables</strong>: Used to interpolate variables within strings that are to be<a id="_idIndexMarker996"/> translated.</li>
<li class="bulletList"><strong class="keyWord">Plural forms in translations</strong>: Techniques to manage translations that depend on <a id="_idIndexMarker997"/>numerical quantities that might affect the<a id="_idIndexMarker998"/> string being translated.</li>
</ul>
<p class="normal">For translating literals in your Python code, you can mark strings for translation using the <code class="inlineCode">gettext()</code> function included in <code class="inlineCode">django.utils.translation</code>. This function translates the message and returns a string. The convention is to import this function as a shorter alias named <code class="inlineCode">_</code> (the underscore character).</p>
<p class="normal">You can find all the documentation about translations<a id="_idIndexMarker999"/> at <a href="https://docs.djangoproject.com/en/5.0/topics/i18n/translation/">https://docs.djangoproject.com/en/5.0/topics/i18n/translation/</a>.</p>
<p class="normal">Let’s review the different translation methods for Python strings.</p>
<h2 class="heading-2" id="_idParaDest-305">Standard translations</h2>
<p class="normal">The following code<a id="_idIndexMarker1000"/> shows how to <a id="_idIndexMarker1001"/>mark a string for translation:</p>
<pre class="programlisting code"><code class="hljs-code">from django.utils.translation import gettext as _
output = _('Text to be translated.')
</code></pre>
<p class="normal">This method <a id="_idIndexMarker1002"/>allows you to apply translations to most strings within your Python code by<a id="_idIndexMarker1003"/> using the <code class="inlineCode">gettext()</code> function, aliased as <code class="inlineCode">_</code> for convenience.</p>
<h2 class="heading-2" id="_idParaDest-306">Lazy translations</h2>
<p class="normal">Django includes <strong class="keyWord">lazy</strong> versions for all of its <a id="_idIndexMarker1004"/>translation functions, which have the suffix <code class="inlineCode">_lazy()</code>. When <a id="_idIndexMarker1005"/>using the lazy functions, strings are translated when the value is accessed, rather than when the function is called (this is why they are translated <strong class="keyWord">lazily</strong>). The lazy translation functions come in handy when the strings marked for translation are in paths that are executed when modules are loaded.</p>
<p class="normal">A common example where lazy translations are beneficial is in the <code class="inlineCode">settings.py</code> file of your project, where immediate translation is not practical because the settings must be defined before the translation system is fully ready.</p>
<div><p class="normal">Using <code class="inlineCode">gettext_lazy()</code> instead of <code class="inlineCode">gettext()</code> means that strings are translated when the value is accessed. Django offers a lazy version for all translation functions.</p>
</div>
<h2 class="heading-2" id="_idParaDest-307">Translations including variables</h2>
<p class="normal">The <a id="_idIndexMarker1006"/>strings marked for translation can include placeholders to include variables in the translations. The following code is an example of a translation string with a placeholder:</p>
<pre class="programlisting code"><code class="hljs-code">from django.utils.translation import gettext as _
month = _('April')
day = '14'
output = _('Today is %(month)s %(day)s') % {'month': month, 'day': day}
</code></pre>
<p class="normal">By using placeholders, you can reorder the text variables. For example, an English translation of the previous example might be <em class="italic">today is April 14</em>, while the Spanish one might be <em class="italic">hoy es 14 de Abril</em>. Always use string interpolation instead of positional interpolation when you have more than one parameter for the translation string. By doing so, you will be able to reorder the placeholder text.</p>
<h2 class="heading-2" id="_idParaDest-308">Plural forms in translations</h2>
<p class="normal">For plural forms, Django <a id="_idIndexMarker1007"/>provides <code class="inlineCode">ngettext()</code> and <code class="inlineCode">ngettext_lazy()</code>. These<a id="_idIndexMarker1008"/> functions translate singular and plural forms, depending on an argument that indicates the number of objects. The following example shows how to use them:</p>
<pre class="programlisting code"><code class="hljs-code">output = ngettext(
    'there is %(count)d product',    # Singular form
'there are %(count)d products',  # Plural form
    count                            # Numeric value to determine form
) % {'count': count}
</code></pre>
<p class="normal">In this example, if <code class="inlineCode">count</code> is <code class="inlineCode">1</code>, <code class="inlineCode">ngettext()</code> will use the first string and output <code class="inlineCode">there is 1 product</code>. For any other number, it will use the second string, appropriately outputting, for example, <code class="inlineCode">there are 5 products</code>. This allows for more accurate and grammatically correct <a id="_idIndexMarker1009"/>translations in languages where pluralization rules are<a id="_idIndexMarker1010"/> essential.</p>
<p class="normal">Now that you know the basics of translating literals in your Python code, it’s time to apply translations to your project.</p>
<h2 class="heading-2" id="_idParaDest-309">Translating your own code</h2>
<p class="normal">First, we will <a id="_idIndexMarker1011"/>translate the language names. To do this, you can follow these instructions:</p>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of your project, import the <code class="inlineCode">gettext_lazy()</code> function, and change the <code class="inlineCode">LANGUAGES</code> setting, as follows:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.utils.translation </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> gettext_lazy </strong><strong class="hljs-keyword-slc">as</strong><strong class="hljs-slc"> _</strong>
# ...
LANGUAGES = [
    ('en', <strong class="hljs-slc">_(</strong>'English'<strong class="hljs-slc">)</strong>),
    ('es', <strong class="hljs-slc">_(</strong>'Spanish'<strong class="hljs-slc">)</strong>),
]
</code></pre>
<p class="normal">Here, you use the <code class="inlineCode">gettext_lazy()</code> function instead of <code class="inlineCode">gettext()</code> to avoid a circular import, thus translating the languages’ names when they are accessed.</p>
<p class="normal">Open the shell and run the following command from your project directory:</p>
<pre class="programlisting con"><code class="hljs-con">django-admin makemessages --all
</code></pre>
<p class="normal">You should see the following output:</p>
<pre class="programlisting con"><code class="hljs-con">processing locale es
processing locale en
</code></pre>
<p class="normal">Take a look at the <code class="inlineCode">locale/</code> directory. You should see a file structure like the following:</p>
<pre class="programlisting con"><code class="hljs-con">en/
    LC_MESSAGES/
        django.po
es/
    LC_MESSAGES/
        django.po
</code></pre>
<p class="normal">A <code class="inlineCode">.po</code> message file has been created for each language.</p>
<p class="normal">Open <code class="inlineCode">es/LC_MESSAGES/django.po</code> with a text editor. At the end of the file, you should be able to see the following:</p>
<pre class="programlisting code"><code class="hljs-code">#: myshop/settings.py:118
msgid "English"
msgstr ""
#: myshop/settings.py:119
msgid "Spanish"
msgstr ""
</code></pre>
<p class="normal">Each <a id="_idIndexMarker1012"/>translation string is preceded by a comment showing details about the file and the line where it was found. Each translation includes two strings:</p>
<ul>
<li class="bulletList"><code class="inlineCode">msgid</code>: The translation string as it appears in the source code.</li>
<li class="bulletList"><code class="inlineCode">msgstr</code>: The language translation, which is empty by default. This is where you have to enter the actual translation for the given string.</li>
</ul>
<p class="normal">Fill in the <code class="inlineCode">msgstr</code> translations for the given <code class="inlineCode">msgid</code> string, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">#: myshop/settings.py:118
msgid "English"
msgstr <strong class="hljs-string-slc">"Inglés"</strong>
#: myshop/settings.py:119
msgid "Spanish"
msgstr <strong class="hljs-string-slc">"Español"</strong>
</code></pre>
<p class="normal">Save the modified message file, open the shell, and run the following command:</p>
<pre class="programlisting con"><code class="hljs-con">django-admin compilemessages
</code></pre>
<p class="normal">If everything goes well, you should see an output like the following:</p>
<pre class="programlisting con"><code class="hljs-con">processing file django.po in myshop/locale/en/LC_MESSAGES
processing file django.po in myshop/locale/es/LC_MESSAGES
</code></pre>
<p class="normal">The output gives<a id="_idIndexMarker1013"/> you information about the message files that are being compiled. Take a look at the <code class="inlineCode">locale</code> directory of the <code class="inlineCode">myshop</code> project again. You should see the following files:</p>
<pre class="programlisting con"><code class="hljs-con">en/
    LC_MESSAGES/
        django.mo
        django.po
es/
    LC_MESSAGES/
        django.mo
        django.po
</code></pre>
<p class="normal">You can see that a <code class="inlineCode">.mo</code> compiled message file has been generated for each language.</p>
<p class="normal">Now that you have translated the language names, let’s translate the model field names that are displayed on the site:</p>
<p class="normal">Edit the <code class="inlineCode">models.py</code> file of the <code class="inlineCode">orders</code> application, and add names marked for translation to the <code class="inlineCode">Order</code> model fields, as follows:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.utils.translation </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> gettext_lazy </strong><strong class="hljs-keyword-slc">as</strong><strong class="hljs-slc"> _</strong>
class Order(models.Model):
    first_name = models.CharField(<strong class="hljs-slc">_(</strong><strong class="hljs-string-slc">'first name'</strong><strong class="hljs-slc">)</strong>, max_length=50)
    last_name = models.CharField(<strong class="hljs-slc">_(</strong><strong class="hljs-string-slc">'last name'</strong><strong class="hljs-slc">)</strong>, max_length=50)
    email = models.EmailField(<strong class="hljs-slc">_(</strong><strong class="hljs-string-slc">'e-mail'</strong><strong class="hljs-slc">)</strong>)
    address = models.CharField(<strong class="hljs-slc">_(</strong><strong class="hljs-string-slc">'address'</strong><strong class="hljs-slc">)</strong>, max_length=250)
    postal_code = models.CharField(<strong class="hljs-slc">_(</strong><strong class="hljs-string-slc">'postal code'</strong><strong class="hljs-slc">)</strong>, max_length=20)
    city = models.CharField(<strong class="hljs-slc">_(</strong><strong class="hljs-string-slc">'city'</strong><strong class="hljs-slc">)</strong>, max_length=100)
    # ...
</code></pre>
<p class="normal">You have added names for the fields that are displayed when a user places a new order. These are <code class="inlineCode">first_name</code>, <code class="inlineCode">last_name</code>, <code class="inlineCode">email</code>, <code class="inlineCode">address</code>, <code class="inlineCode">postal_code</code>, and <code class="inlineCode">city</code>. Remember that you can also use the <code class="inlineCode">verbose_name</code> attribute to name the fields.</p>
<p class="normal">Create the following directory structure inside the <code class="inlineCode">orders</code> application directory:</p>
<pre class="programlisting con"><code class="hljs-con">locale/
    en/
    es/
</code></pre>
<p class="normal">By creating a <code class="inlineCode">locale</code> directory, the translation strings of this application will be stored in a message file in this directory instead of the main messages file. In this way, you can generate separate translation files for each application.</p>
<p class="normal">Open the shell <a id="_idIndexMarker1014"/>from the project directory and run the following command:</p>
<pre class="programlisting con"><code class="hljs-con">django-admin makemessages --all
</code></pre>
<p class="normal">You should see the following output:</p>
<pre class="programlisting con"><code class="hljs-con">processing locale es
processing locale en
</code></pre>
<p class="normal">Open the <code class="inlineCode">locale/es/LC_MESSAGES/django.po</code> file of the <code class="inlineCode">order</code> application using a text editor. You will see the translation strings for the <code class="inlineCode">Order</code> model. Fill in the following <code class="inlineCode">msgstr</code> translations for the given <code class="inlineCode">msgid</code> strings:</p>
<pre class="programlisting code"><code class="hljs-code">#: orders/models.py:12
msgid "first name"
msgstr <strong class="hljs-string-slc">"nombre"</strong>
#: orders/models.py:14
msgid "last name"
msgstr <strong class="hljs-string-slc">"apellidos"</strong>
#: orders/models.py:16
msgid "e-mail"
msgstr <strong class="hljs-string-slc">"e-mail"</strong>
#: orders/models.py:17
msgid "address"
msgstr <strong class="hljs-string-slc">"dirección"</strong>
#: orders/models.py:19
msgid "postal code"
msgstr <strong class="hljs-string-slc">"código postal"</strong>
#: orders/models.py:21
msgid "city"
msgstr <strong class="hljs-string-slc">"ciudad"</strong>
</code></pre>
<p class="normal">After you<a id="_idIndexMarker1015"/> have finished adding the translations, save the file.</p>
<p class="normal">Besides a text editor, you can use Poedit to edit translations. Poedit is a piece of software for editing translations that uses <code class="inlineCode">gettext</code>. It is available for Linux, Windows, and macOS. You can download Poedit<a id="_idIndexMarker1016"/> from <a href="https://poedit.net/">https://poedit.net/</a>.</p>
<p class="normal">Let’s also translate the forms of your project. The <code class="inlineCode">OrderCreateForm</code> of the <code class="inlineCode">orders</code> application does not have to be translated. That’s because it is a <code class="inlineCode">ModelForm</code> and uses the <code class="inlineCode">verbose_name</code> attribute of the <code class="inlineCode">Order</code> model fields for the form field labels. You are going to translate the forms of the <code class="inlineCode">cart</code> and <code class="inlineCode">coupons</code> applications:</p>
<p class="normal">Edit the <code class="inlineCode">forms.py</code> file inside the <code class="inlineCode">cart</code> application directory and add a <code class="inlineCode">label</code> attribute to the <code class="inlineCode">quantity</code> field of the <code class="inlineCode">CartAddProductForm</code>. Then, mark this field for translation, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">from django import forms
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.utils.translation </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> gettext_lazy </strong><strong class="hljs-keyword-slc">as</strong><strong class="hljs-slc"> _</strong>
PRODUCT_QUANTITY_CHOICES = [(i, str(i)) for i in range(1, 21)]
class CartAddProductForm(forms.Form):
    quantity = forms.TypedChoiceField(
        choices=PRODUCT_QUANTITY_CHOICES,
        coerce=int<strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        label=_(</strong><strong class="hljs-string-slc">'Quantity'</strong><strong class="hljs-slc">)</strong>
    )
    override = forms.BooleanField(
        required=False,
        initial=False,
        widget=forms.HiddenInput
    )
</code></pre>
<p class="normal">Edit the <code class="inlineCode">forms.py</code> file of the <code class="inlineCode">coupons</code> application and translate the <code class="inlineCode">CouponApplyForm</code> form, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">from django import forms
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.utils.translation </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> gettext_lazy </strong><strong class="hljs-keyword-slc">as</strong><strong class="hljs-slc"> _</strong>
class CouponApplyForm(forms.Form):
    code = forms.CharField(<strong class="hljs-slc">label=_(</strong><strong class="hljs-string-slc">'Coupon'</strong><strong class="hljs-slc">)</strong>)
</code></pre>
<p class="normal">You have added<a id="_idIndexMarker1017"/> a label to the <code class="inlineCode">code</code> field and marked it for translation.</p>
<p class="normal">You have finished marking Python strings for translation. Next, you will learn how to mark text for translation in templates.</p>
<h1 class="heading-1" id="_idParaDest-310">Translating templates</h1>
<p class="normal">Django offers <a id="_idIndexMarker1018"/>the <code class="inlineCode">{% translate %}</code> and <code class="inlineCode">{% blocktranslate %}</code> template tags to translate the strings using templates. In order to use the translation template tags, you have to add <code class="inlineCode">{% load i18n %}</code> to the top of your template to load them.</p>
<h2 class="heading-2" id="_idParaDest-311">The {% translate %} template tag</h2>
<p class="normal">The <code class="inlineCode">{% translate %}</code> template tag allows<a id="_idIndexMarker1019"/> you to mark a literal for translation. Internally, Django executes <code class="inlineCode">gettext()</code> on the given text. This is how to mark a string for translation in a template:</p>
<pre class="programlisting code"><code class="hljs-code">{% translate "Text to be translated" %}
</code></pre>
<p class="normal">You can use <code class="inlineCode">as</code> to store the translated content in a variable that you can use throughout your template. The following example stores the translated text in a variable called <code class="inlineCode">greeting</code>:</p>
<pre class="programlisting code"><code class="hljs-code">{% translate "Hello!" as greeting %}
&lt;h1&gt;{{ greeting }}&lt;/h1&gt;
</code></pre>
<p class="normal">The <code class="inlineCode">{% translate %}</code> tag is useful for simple translation strings, but it can’t handle content for translation that includes <a id="_idIndexMarker1020"/>variables.</p>
<h2 class="heading-2" id="_idParaDest-312">The {% blocktranslate %} template tag</h2>
<p class="normal">The <code class="inlineCode">{% blocktranslate %}</code> template tag allows you<a id="_idIndexMarker1021"/> to mark content that includes literals and variable content, using placeholders. The following example shows you how to use the <code class="inlineCode">{% blocktranslate %}</code> tag, including a <code class="inlineCode">name</code> variable in the content for translation:</p>
<pre class="programlisting code"><code class="hljs-code">{% blocktranslate %}Hello {{ name }}!{% endblocktranslate %}
</code></pre>
<p class="normal">You can use <code class="inlineCode">with</code> to include template expressions, such as accessing object attributes or applying template filters to variables. You always have to use placeholders for these. You can’t access expressions or object attributes inside the <code class="inlineCode">blocktrans</code> block. The following example shows you how to use <code class="inlineCode">with</code> to include an object attribute to which the <code class="inlineCode">capfirst</code> filter has been applied:</p>
<pre class="programlisting code"><code class="hljs-code">{% blocktranslate with name=user.name|capfirst %}
  Hello {{ name }}!
{% endblocktranslate %}
</code></pre>
<div><p class="normal"> Use the <code class="inlineCode">{% blocktranslate %}</code> tag instead of <code class="inlineCode">{% translate %}</code> when you need to include variable content in your translation string.</p>
</div>
<p class="normal">Now that you are familiar with the translation template tags, let’s put them to use.</p>
<h2 class="heading-2" id="_idParaDest-313">Translating the shop templates</h2>
<p class="normal">Edit the <code class="inlineCode">shop/base.html</code> template <a id="_idIndexMarker1022"/>of the <code class="inlineCode">shop</code> application. Make sure that you load the <code class="inlineCode">i18n</code> tag at the top of the template and mark the strings for translation, as follows. The new code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">{% load <strong class="hljs-slc">i18n </strong>static %}
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta charset="utf-8" /&gt;
&lt;title&gt;
    {% block title %}<strong class="hljs-slc">{% translate "My shop" %}</strong>{% endblock %}
  &lt;/title&gt;
&lt;link href="{% static "css/base.css" %}" rel="stylesheet"&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div id="header"&gt;
&lt;a href="/" class="logo"&gt;<strong class="hljs-slc">{% translate "My shop" %}</strong>&lt;/a&gt;
&lt;/div&gt;
&lt;div id="subheader"&gt;
&lt;div class="cart"&gt;
      {% with total_items=cart|length %}
        {% if total_items &gt; 0 %}
          <strong class="hljs-slc">{% translate "Your cart" %}</strong>:
          &lt;a href="{% url "cart:cart_detail" %}"&gt;
<strong class="hljs-slc">{% blocktranslate with total=cart.get_total_price count items=total_items %}</strong>
<strong class="hljs-slc">              {{ items }} item, ${{ total }}</strong>
<strong class="hljs-slc">            {% plural %}</strong>
<strong class="hljs-slc">              {{ items }} items, ${{ total }}</strong>
<strong class="hljs-slc">            {% endblocktranslate %}</strong>
&lt;/a&gt;
        {% elif not order %}
          <strong class="hljs-slc">{% translate "Your cart is empty." %}</strong>
        {% endif %}
      {% endwith %}
    &lt;/div&gt;
&lt;/div&gt;
&lt;div id="content"&gt;
    {% block content %}
    {% endblock %}
  &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p class="normal">Make <a id="_idIndexMarker1023"/>sure that no template tag is split across multiple lines.</p>
<p class="normal">Notice the <code class="inlineCode">{% blocktranslate %}</code> tag to display the cart’s summary. The cart’s summary was previously as follows:</p>
<pre class="programlisting code"><code class="hljs-code">{{ total_items }} item{{ total_items|pluralize }},
${{ cart.get_total_price }}
</code></pre>
<p class="normal">You changed it, and now you use <code class="inlineCode">{% blocktranslate with ... %}</code> to set up the placeholder <code class="inlineCode">total</code> with the value of <code class="inlineCode">cart.get_total_price</code> (the object method called here). You also use <code class="inlineCode">count</code>, which allows you to set a variable for counting objects for Django to<a id="_idIndexMarker1024"/> select the right plural form. You set the <code class="inlineCode">items</code> variable to count objects with the value of <code class="inlineCode">total_items</code>.</p>
<p class="normal">This allows you to set a translation for the singular and plural forms, which you separate with the <code class="inlineCode">{% plural %}</code> tag within the <code class="inlineCode">{% blocktranslate %}</code> block. The resulting code is:</p>
<pre class="programlisting code"><code class="hljs-code">{% blocktranslate with total=cart.get_total_price count items=total_items %}
  {{ items }} item, ${{ total }}
{% plural %}
  {{ items }} items, ${{ total }}
{% endblocktranslate %}
</code></pre>
<p class="normal">Next, edit the <code class="inlineCode">shop/product/detail.html</code> template of the <code class="inlineCode">shop</code> application and add <code class="inlineCode">i18n</code> to the <code class="inlineCode">{% load %}</code> tag:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "shop/base.html" %}
{% load <strong class="hljs-slc">i18n </strong>static %}
...
</code></pre>
<p class="normal">Note that <code class="inlineCode">{% load %}</code> allows you to load all template tags at once by including the modules separated by spaces. In this case, we load the <code class="inlineCode">i18n</code> and <code class="inlineCode">static</code> modules that contain template tags.</p>
<p class="normal">Then, find the following line:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;input type="submit" value="Add to cart"&gt;
</code></pre>
<p class="normal">Replace it with the following:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;input type="submit" value="<strong class="hljs-string-slc">{% translate "</strong><strong class="hljs-attr-slc">Add</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">to</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">cart</strong><strong class="hljs-tag-slc">" %}</strong>"&gt;
</code></pre>
<p class="normal">Then, find the following line:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;h3&gt;People who bought this also bought&lt;/h3&gt;
</code></pre>
<p class="normal">Replace it with the following:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;h3&gt;<strong class="hljs-slc">{% translate "People who bought this also bought" %}</strong>&lt;/h3&gt;
</code></pre>
<p class="normal">Now, translate the <code class="inlineCode">orders</code> application template. Edit the <code class="inlineCode">orders/order/create.html</code> template of the <code class="inlineCode">orders</code> application <a id="_idIndexMarker1025"/>and mark the text for translation, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">{% extends "shop/base.html" %}
<strong class="hljs-slc">{% load i18n %}</strong>
{% block title %}
<strong class="hljs-slc">  {% translate </strong><strong class="hljs-string-slc">"Checkout"</strong><strong class="hljs-slc"> %}</strong>
{% endblock %}
{% block content %}
  &lt;h1&gt;<strong class="hljs-slc">{% translate </strong><strong class="hljs-string-slc">"Checkout"</strong><strong class="hljs-slc"> %}</strong>&lt;/h1&gt;
  &lt;div class="order-info"&gt;
    &lt;h3&gt;<strong class="hljs-slc">{% translate </strong><strong class="hljs-string-slc">"Your order"</strong><strong class="hljs-slc"> %}</strong>&lt;/h3&gt;
    &lt;ul&gt;
      {% for item in cart %}
        &lt;li&gt;
          {{ item.quantity }}x {{ item.product.name }}
          &lt;span&gt;${{ item.total_price }}&lt;/span&gt;
        &lt;/li&gt;
      {% endfor %}
      {% if cart.coupon %}
        &lt;li&gt;
          <strong class="hljs-slc">{% blocktranslate with code=cart.coupon.code discount=cart.coupon.discount %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">"</strong><strong class="hljs-string-slc">{{ code }}"</strong><strong class="hljs-slc"> ({{ discount }}% off)</strong>
<strong class="hljs-slc">          {% endblocktranslate %}</strong>
          &lt;span class="neg"&gt;- ${{ cart.get_discount|floatformat:2 }}&lt;/span&gt;
        &lt;/li&gt;
      {% endif %}
    &lt;/ul&gt;
    &lt;p&gt;<strong class="hljs-slc">{% translate </strong><strong class="hljs-string-slc">"Total"</strong><strong class="hljs-slc"> %}</strong>: ${{
    cart.get_total_price_after_discount|floatformat:2 }}&lt;/p&gt;
  &lt;/div&gt;
  &lt;form method="post" class="order-form"&gt;
    {{ form.as_p }}
    &lt;p&gt;&lt;input type="submit" value="<strong class="hljs-string-slc">{% translate "</strong><strong class="hljs-slc">Place order</strong><strong class="hljs-string-slc">" %}</strong>"&gt;&lt;/p&gt;
    {% csrf_token %}
  &lt;/form&gt;
{% endblock %}
</code></pre>
<p class="normal">Make sure that <a id="_idIndexMarker1026"/>no template tag is split across multiple lines. Take a look at the following files in the code that accompanies this chapter to see how the strings have been marked for translation:</p>
<ul>
<li class="bulletList">The <code class="inlineCode">shop</code> application: Template <code class="inlineCode">shop/product/list.html</code></li>
<li class="bulletList">The <code class="inlineCode">orders</code> application: Template <code class="inlineCode">orders/order/pdf.html</code></li>
<li class="bulletList">The <code class="inlineCode">cart</code> application: Template <code class="inlineCode">cart/detail.html</code></li>
<li class="bulletList">The <code class="inlineCode">payments</code> application: Templates <code class="inlineCode">payment/process.html</code>, <code class="inlineCode">payment/completed.html</code>, and <code class="inlineCode">payment/canceled.html</code></li>
</ul>
<div><p class="normal">Remember that you can find the source code for this chapter at <a href="https://github.com/PacktPublishing/Django-5-by-Example/tree/master/Chapter11">https://github.com/PacktPublishing/Django-5-by-Example/tree/master/Chapter11</a>.</p>
</div>
<p class="normal">Let’s update the message files to include the new translation strings:</p>
<p class="normal">Open the shell and run the following command:</p>
<pre class="programlisting con"><code class="hljs-con">django-admin makemessages --all
</code></pre>
<p class="normal">The <code class="inlineCode">.po</code> files are inside the <code class="inlineCode">locale</code> directory of the <code class="inlineCode">myshop</code> project, and you’ll see that the <code class="inlineCode">orders</code> application now contains all the strings that you marked for translation.</p>
<p class="normal">Edit the <code class="inlineCode">.po</code> translation files of the project and the <code class="inlineCode">orders</code> application, and include Spanish translations in <code class="inlineCode">msgstr</code>. You can also use the translated <code class="inlineCode">.po</code> files in the source code that accompanies this chapter.</p>
<p class="normal">Run the following command to compile the translation files:</p>
<pre class="programlisting con"><code class="hljs-con">django-admin compilemessages
</code></pre>
<p class="normal">You will see the following output:</p>
<pre class="programlisting con"><code class="hljs-con">processing file django.po in myshop/locale/en/LC_MESSAGES
processing file django.po in myshop/locale/es/LC_MESSAGES
processing file django.po in myshop/orders/locale/en/LC_MESSAGES
processing file django.po in myshop/orders/locale/es/LC_MESSAGES
</code></pre>
<p class="normal">A <code class="inlineCode">.mo</code> file<a id="_idIndexMarker1027"/> containing compiled translations has been generated for each <code class="inlineCode">.po</code> translation file.</p>
<p class="normal">Now, you have edited <code class="inlineCode">.po</code> files with a text editor or by using Poedit. Next, we are going to use a Django application to edit translations directly within the browser.</p>
<h1 class="heading-1" id="_idParaDest-314">Using the Rosetta translation interface</h1>
<p class="normal">Rosetta<a id="_idIndexMarker1028"/> is a third-party application that allows you to edit translations directly in the browser, using the same interface as the Django administration site. Rosetta makes it easy to edit <code class="inlineCode">.po</code> files, and it updates compiled translation files. This eliminates the need to download and upload translation files, and it supports collaborative editing by multiple users. </p>
<p class="normal">Let’s integrate Rosetta into your project:</p>
<p class="normal">Install <a id="_idIndexMarker1029"/>Rosetta via <code class="inlineCode">pip</code> using this command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install django-rosetta==0.10.0
</code></pre>
<p class="normal">Then, add <code class="inlineCode">'rosetta'</code> to the <code class="inlineCode">INSTALLED_APPS</code> setting in your project’s <code class="inlineCode">settings.py</code> file, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">INSTALLED_APPS = [
    # ...
<strong class="hljs-string-slc">'rosetta'</strong><strong class="hljs-slc">,</strong>
]
</code></pre>
<p class="normal">You need to add Rosetta’s URLs to your main URL configuration. Edit the main <code class="inlineCode">urls.py</code> file of your project and add the following URL pattern highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    path('admin/', admin.site.urls),
    path('cart/', include('cart.urls', namespace='cart')),
    path('orders/', include('orders.urls', namespace='orders')),
    path('payment/', include('payment.urls', namespace='payment')),
    path('coupons/', include('coupons.urls', namespace='coupons')),
<strong class="hljs-slc">    path(</strong><strong class="hljs-string-slc">'rosetta/'</strong><strong class="hljs-slc">, include(</strong><strong class="hljs-string-slc">'rosetta.urls'</strong><strong class="hljs-slc">)),</strong>
    path('', include('shop.urls', namespace='shop')),
]
</code></pre>
<p class="normal">Make sure you place it before the <code class="inlineCode">shop.urls</code> pattern to prevent an undesired pattern match.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/admin/</code> and log in as a superuser. Then, navigate to <code class="inlineCode">http://127.0.0.1:8000/rosetta/</code> in your browser. In the <strong class="screenText">Filter</strong> menu, click <strong class="screenText">THIRD PARTY</strong> to display all the available message files, including those that belong to the <code class="inlineCode">orders</code> application.</p>
<p class="normal">You<a id="_idIndexMarker1030"/> should see a list of existing languages, as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_11_02.png"/></figure>
<p class="packt_figref">Figure 11.2: The Rosetta administration interface</p>
<p class="normal">Click the <strong class="screenText">Myshop</strong> link in the <strong class="screenText">Spanish</strong> section to edit the Spanish translations. You should see a list of translation strings, as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_11_03.png"/></figure>
<p class="packt_figref">Figure 11.3: Editing Spanish translations using Rosetta</p>
<p class="normal">You can<a id="_idIndexMarker1031"/> enter the translations in the <strong class="screenText">SPANISH</strong> column. The <strong class="screenText">OCCURRENCE(S)</strong> column displays the files and lines of code where each translation string was found.</p>
<p class="normal">Translations that include placeholders will appear as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_11_04.png"/></figure>
<p class="packt_figref">Figure 11.4: Translations including placeholders</p>
<p class="normal">Rosetta uses a different background color to display placeholders. When you translate content, make sure that you keep placeholders untranslated. For example, take the following string:</p>
<pre class="programlisting code"><code class="hljs-code">%(items)s items, $%(total)s
</code></pre>
<p class="normal">It can be translated into Spanish as follows:</p>
<pre class="programlisting code"><code class="hljs-code">%(items)s productos, $%(total)s
</code></pre>
<p class="normal">You can take a look at the source code that comes with this chapter to use the same Spanish translations for your project.</p>
<p class="normal">When you<a id="_idIndexMarker1032"/> finish editing translations, click the <strong class="screenText">Save and translate next block</strong> button to save the translations to the <code class="inlineCode">.po</code> file. Rosetta compiles the message file when you save translations, so there is no need for you to run the <code class="inlineCode">compilemessages</code> command. However, Rosetta requires write access to the <code class="inlineCode">locale</code> directories to write the message files. Make sure that the directories have valid permissions.</p>
<p class="normal">If you want other users to be able to edit translations, open <code class="inlineCode">http://127.0.0.1:8000/admin/auth/group/add/</code> in your browser and create a new group named <code class="inlineCode">translators</code>. Then, access <code class="inlineCode">http://127.0.0.1:8000/admin/auth/user/</code> to edit the users to whom you want to grant permissions so that they can edit translations. When editing a user, under the <strong class="screenText">Permissions</strong> section, add the <code class="inlineCode">translators</code> group to the <strong class="screenText">Chosen Groups</strong> for each user. Rosetta is only available to superusers or users who belong to the <code class="inlineCode">translators</code> group.</p>
<p class="normal">You can read Rosetta’s documentation <a id="_idIndexMarker1033"/>at <a href="https://django-rosetta.readthedocs.io/">https://django-rosetta.readthedocs.io/</a>.</p>
<div><p class="normal">When you add new translations to your production environment, if you serve Django with a real web server, you will have to reload your server after running the <code class="inlineCode">compilemessages</code> command, or after saving the translations with Rosetta, for any changes to take effect.</p>
</div>
<p class="normal">When editing translations, a translation can be marked as <em class="italic">fuzzy</em>. Let’s review what fuzzy translations are.</p>
<h1 class="heading-1" id="_idParaDest-315">Fuzzy translations</h1>
<p class="normal">When editing <a id="_idIndexMarker1034"/>translations in Rosetta, you can see a <strong class="screenText">FUZZY</strong> column. This is not a Rosetta<a id="_idIndexMarker1035"/> feature; it is provided by <code class="inlineCode">gettext</code>. If the <strong class="screenText">FUZZY</strong> flag is active for a translation, it will not be included in the compiled message files. This flag marks translation strings that need to be reviewed by a translator. When <code class="inlineCode">.po</code> files are updated with new translation strings, it is possible that some translation strings will automatically be flagged as fuzzy. This happens when <code class="inlineCode">gettext</code> finds some <code class="inlineCode">msgid</code> that has been slightly modified. <code class="inlineCode">gettext</code> pairs it with what it thinks was the old translation and flags it as fuzzy for review. The translator should then review the fuzzy translations, remove the <strong class="screenText">FUZZY</strong> flag, and compile the translation file again.</p>
<p class="normal">You have translated your project’s interface, but internationalization doesn’t stop there. You can also translate URL patterns, offering custom URLs tailored for each supported language.</p>
<h1 class="heading-1" id="_idParaDest-316">URL patterns for internationalization</h1>
<p class="normal">Django offers <a id="_idIndexMarker1036"/>internationalization capabilities for URLs. It includes<a id="_idIndexMarker1037"/> two main features for internationalized URLs:</p>
<ul>
<li class="bulletList"><strong class="keyWord">A language prefix in URL patterns</strong>: Adding a language prefix to URLs to serve each language version under a different base URL</li>
<li class="bulletList"><strong class="keyWord">Translated URL patterns</strong>: Translating URL patterns so that every URL is different for each language</li>
</ul>
<p class="normal">One reason for translating URLs is to optimize your site for search engines. By adding a language prefix to your patterns, you will be able to index a URL for each language instead of a single URL for all of them. Furthermore, by translating URLs into each language, you will provide search engines with URLs that will rank better for each language.</p>
<h2 class="heading-2" id="_idParaDest-317">Adding a language prefix to URL patterns</h2>
<p class="normal">Django<a id="_idIndexMarker1038"/> allows you to add a language prefix to your URL<a id="_idIndexMarker1039"/> patterns. For example, the English version of your site can be served by a path starting with <code class="inlineCode">/en/</code>, and the Spanish version under <code class="inlineCode">/es/</code>. To use languages in URL patterns, you have to use the <code class="inlineCode">LocaleMiddleware</code> provided by Django. The framework will use it to identify the current language from the requested URL. Previously, you added it to the <code class="inlineCode">MIDDLEWARE</code> setting of your project, so you don’t need to do it now.</p>
<p class="normal">Let’s add a<a id="_idIndexMarker1040"/> language <a id="_idIndexMarker1041"/>prefix to your URL patterns:</p>
<p class="normal">Edit the main <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">myshop</code> project and add <code class="inlineCode">i18n_patterns()</code>, as follows:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.conf.urls.i18n </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> i18n_patterns</strong>
urlpatterns = <strong class="hljs-slc">i18n_patterns(</strong>
    path('admin/', admin.site.urls),
    path('cart/', include('cart.urls', namespace='cart')),
    path('orders/', include('orders.urls', namespace='orders')),
    path('payment/', include('payment.urls', namespace='payment')),
    path('coupons/', include('coupons.urls', namespace='coupons')),
    path('rosetta/', include('rosetta.urls')),
    path('', include('shop.urls', namespace='shop')),
<strong class="hljs-slc">)</strong>
</code></pre>
<p class="normal">You can combine non-translatable standard URL patterns and patterns under <code class="inlineCode">i18n_patterns</code> so that some patterns include a language prefix and others don’t. However, it’s better to use translated URLs only to avoid the possibility that a carelessly translated URL matches a non-translated URL pattern.</p>
<p class="normal">Run the development server and open <code class="inlineCode">http://127.0.0.1:8000/</code> in your browser. Django will perform the steps described in the <em class="italic">How Django determines the current language</em> section to determine the current language, and it will redirect you to the requested URL, including the language prefix. Take a look at the URL in your browser; it should now look like <code class="inlineCode">http://127.0.0.1:8000/en/</code>. The current language is the one set by the <code class="inlineCode">Accept-Language</code> header of your browser if it is Spanish or English; otherwise, it is the default <code class="inlineCode">LANGUAGE_CODE</code> (English) defined in your settings.</p>
<p class="normal">You have <a id="_idIndexMarker1042"/>added a language prefix to your URLs, generating <a id="_idIndexMarker1043"/>a different URL for each language available. This helps you to index different versions in search engines.</p>
<p class="normal">Next, we are going to translate URL patterns so that we can add fully translated URLs to our site.</p>
<h2 class="heading-2" id="_idParaDest-318">Translating URL patterns</h2>
<p class="normal">Django supports translated<a id="_idIndexMarker1044"/> strings in URL patterns. You can use a different translation for each language for a single URL pattern. You can mark URL patterns for translation in the same way you would with literals, using the <code class="inlineCode">gettext_lazy()</code> function. To do this, follow these steps:</p>
<p class="normal">Edit the main <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">myshop</code> project and add translation strings to the regular expressions of the URL patterns for the <code class="inlineCode">cart</code>, <code class="inlineCode">orders</code>, <code class="inlineCode">payment</code>, and <code class="inlineCode">coupons</code> applications, as follows:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.utils.translation </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> gettext_lazy </strong><strong class="hljs-keyword-slc">as</strong><strong class="hljs-slc"> _</strong>
urlpatterns = i18n_patterns(
    path('admin/', admin.site.urls),
    path(<strong class="hljs-slc">_(</strong>'cart/'<strong class="hljs-slc">)</strong>, include('cart.urls', namespace='cart')),
    path(<strong class="hljs-slc">_(</strong>'orders/'<strong class="hljs-slc">)</strong>, include('orders.urls', namespace='orders')),
    path(<strong class="hljs-slc">_(</strong>'payment/'<strong class="hljs-slc">)</strong>, include('payment.urls', namespace='payment')),
    path(<strong class="hljs-slc">_(</strong>'coupons/'<strong class="hljs-slc">)</strong>, include('coupons.urls', namespace='coupons')),
    path('rosetta/', include('rosetta.urls')),
    path('', include('shop.urls', namespace='shop')),
)
</code></pre>
<p class="normal">Edit the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">orders</code> application and mark the <code class="inlineCode">order_create</code> URL pattern for translation, as follows:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.utils.translation </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> gettext_lazy </strong><strong class="hljs-keyword-slc">as</strong><strong class="hljs-slc"> _</strong>
urlpatterns = [
    path(<strong class="hljs-slc">_(</strong>'create/'<strong class="hljs-slc">)</strong>, views.order_create, name='order_create'),
    # ...
]
</code></pre>
<p class="normal">Edit the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">payment</code> application and change the code to the following:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.utils.translation </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> gettext_lazy </strong><strong class="hljs-keyword-slc">as</strong><strong class="hljs-slc"> _</strong>
urlpatterns = [
    path(<strong class="hljs-slc">_(</strong>'process/'<strong class="hljs-slc">)</strong>, views.payment_process, name='process'),
    path(<strong class="hljs-slc">_(</strong><strong class="hljs-string-slc">'</strong>completed/'<strong class="hljs-slc">)</strong>, views.payment_completed, name='completed'),
    path(<strong class="hljs-slc">_(</strong>'canceled/'<strong class="hljs-slc">)</strong>, views.payment_canceled, name='canceled'),
    path('webhook/', webhooks.stripe_webhook, name='stripe-webhook'),
]
</code></pre>
<p class="normal">Note that these<a id="_idIndexMarker1045"/> URL patterns will include a language prefix because they are included under <code class="inlineCode">i18n_patterns()</code> in the main <code class="inlineCode">urls.py</code> file of the project. This will make each URL pattern have a different URI for each available language, one starting with <code class="inlineCode">/en/</code>, another one with <code class="inlineCode">/es/</code>, and so on. However, we need a single URL for Stripe to notify events, and we need to avoid language prefixes in the <code class="inlineCode">webhook</code> URL.</p>
<p class="normal">Remove the <code class="inlineCode">webhook</code> URL pattern from the <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">payment</code> application. The file should now look like the following:</p>
<pre class="programlisting code"><code class="hljs-code">from django.utils.translation import gettext_lazy as _
urlpatterns = [
    path(_('process/'), views.payment_process, name='process'),
    path(_('completed/'), views.payment_completed, name='completed'),
    path(_('canceled/'), views.payment_canceled, name='canceled'),
]
</code></pre>
<p class="normal">Then, add the following <code class="inlineCode">webhook</code> URL pattern to the main <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">myshop</code> project. The new code is highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django.utils.translation import gettext_lazy as _
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> payment </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> webhooks</strong>
urlpatterns = i18n_patterns(
    path('admin/', admin.site.urls),
    path(_('cart/'), include('cart.urls', namespace='cart')),
    path(_('orders/'), include('orders.urls', namespace='orders')),
    path(_('payment/'), include('payment.urls', namespace='payment')),
    path(_('coupons/'), include('coupons.urls', namespace='coupons')),
    path('rosetta/', include('rosetta.urls')),
    path('', include('shop.urls', namespace='shop')),
)
<strong class="hljs-slc">urlpatterns += [</strong>
<strong class="hljs-slc">    path(</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'payment/webhook/'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        webhooks.stripe_webhook,</strong>
<strong class="hljs-slc">        name=</strong><strong class="hljs-string-slc">'stripe-webhook'</strong>
<strong class="hljs-slc">    ),</strong>
<strong class="hljs-slc">]</strong>
if settings.DEBUG:
    urlpatterns += static(
        settings.MEDIA_URL, document_root=settings.MEDIA_ROOT
    )
</code></pre>
<p class="normal">We have added the <code class="inlineCode">webhook</code> URL pattern to <code class="inlineCode">urlpatterns</code> outside of <code class="inlineCode">i18n_patterns()</code> to ensure we maintain a single URL for Stripe event notifications.</p>
<p class="normal">You don’t need to translate the URL patterns of the <code class="inlineCode">shop</code> application, as they are built with variables and do not include any other literals.</p>
<p class="normal">Open the shell and <a id="_idIndexMarker1046"/>run the next command to update the message files with the new translations:</p>
<pre class="programlisting con"><code class="hljs-con">django-admin makemessages --all
</code></pre>
<p class="normal">Make sure the development server is running with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/en/rosetta/</code> in your browser and click the <strong class="screenText">Myshop</strong> link under<a id="_idIndexMarker1047"/> the <strong class="screenText">Spanish</strong> section. Click on <strong class="screenText">UNTRANSLATED ONLY</strong> to only see the strings that have not been translated yet. Now, you will see the URL patterns for translation, as shown in <em class="italic">Figure 11.5</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_11_05.png"/></figure>
<p class="packt_figref">Figure 11.5: URL patterns for translation in the Rosetta interface</p>
<p class="normal">Add a different translation string for each URL. Don’t forget to include a slash character, <code class="inlineCode">/</code>, at the end of each URL, as shown in <em class="italic">Figure 11.6</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_11_06.png"/></figure>
<p class="packt_figref">Figure 11.6: Spanish translations for URL patterns in the Rosetta interface</p>
<p class="normal">When you have finished, click <strong class="screenText">SAVE AND TRANSLATE NEXT BLOCK</strong>.</p>
<p class="normal">Then, click on <strong class="screenText">FUZZY ONLY</strong>. You will see translations that have been flagged as fuzzy because they were paired with the old translation of a similar original string. In the<a id="_idIndexMarker1048"/> case displayed in <em class="italic">Figure 11.7</em>, the translations are incorrect and need to be corrected:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_11_07.png"/></figure>
<p class="packt_figref">Figure 11.7: Fuzzy translations in the Rosetta interface</p>
<p class="normal">Enter the correct text for the fuzzy translations. Rosetta will automatically uncheck the <strong class="screenText">FUZZY</strong> select box when you enter new text for a translation. When you have finished, click <strong class="screenText">SAVE AND TRANSLATE NEXT BLOCK</strong>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_11_08.png"/></figure>
<p class="packt_figref">Figure 11.8: Correcting fuzzy translations in the Rosetta interface</p>
<p class="normal">You can now go back to <code class="inlineCode">http://127.0.0.1:8000/en/rosetta/files/third-party/</code> and edit the<a id="_idIndexMarker1049"/> Spanish translation for the <code class="inlineCode">orders</code> application as well.</p>
<p class="normal">After translating the strings into Spanish, our site will be available in two languages. You have already learned how Django determines the current language. However, users may wish to switch languages. Let’s create the functionality that allows users to change their language preference.</p>
<h1 class="heading-1" id="_idParaDest-319">Allowing users to switch language</h1>
<p class="normal">Since you are serving<a id="_idIndexMarker1050"/> content that is available in multiple languages, you should let your users switch the site’s language. You are going to add a language selector to your site. The language selector will consist of a list of available languages displayed using links.</p>
<p class="normal">Edit the <code class="inlineCode">shop/base.html</code> template of the <code class="inlineCode">shop</code> application and locate the following lines:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;div id="header"&gt;
&lt;a href="/" class="logo"&gt;{% translate "My shop" %}&lt;/a&gt;
&lt;/div&gt;
</code></pre>
<p class="normal">Replace<a id="_idIndexMarker1051"/> them with the following code:</p>
<pre class="programlisting code"><code class="hljs-code">&lt;div id="header"&gt;
&lt;a href="/" class="logo"&gt;{% translate "My shop" %}&lt;/a&gt;
<strong class="hljs-slc">  {% get_current_language as LANGUAGE_CODE %}</strong>
<strong class="hljs-slc">  {% get_available_languages as LANGUAGES %}</strong>
<strong class="hljs-slc">  {% get_language_info_list for LANGUAGES as languages %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">div</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"languages"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">p</strong><strong class="hljs-tag-slc">&gt;</strong><strong class="hljs-slc">{% translate "Language" %}:</strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">p</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">ul</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"languages"</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">      {% for language in languages %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">li</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">href</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"/{{ language.code }}/"</strong>
<strong class="hljs-tag-slc">          {% </strong><strong class="hljs-attr-slc">if</strong><strong class="hljs-tag-slc"> </strong><strong class="hljs-attr-slc">language.code</strong><strong class="hljs-tag-slc"> == </strong><strong class="hljs-string-slc">LANGUAGE_CODE</strong><strong class="hljs-tag-slc"> %} </strong><strong class="hljs-attr-slc">class</strong><strong class="hljs-tag-slc">=</strong><strong class="hljs-string-slc">"selected"</strong><strong class="hljs-tag-slc">{% </strong><strong class="hljs-attr-slc">endif</strong><strong class="hljs-tag-slc"> %}&gt;</strong>
<strong class="hljs-slc">            {{ language.name_local }}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">a</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">li</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc">      {% endfor %}</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">ul</strong><strong class="hljs-tag-slc">&gt;</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-tag-slc">&lt;/</strong><strong class="hljs-name-slc">div</strong><strong class="hljs-tag-slc">&gt;</strong>
&lt;/div&gt;
</code></pre>
<p class="normal">Make sure that no template tag is split into multiple lines.</p>
<p class="normal">This is how you build your language selector:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">You load the internationalization tags using <code class="inlineCode">{% load i18n %}</code>.</li>
<li class="numberedList">You use the <code class="inlineCode">{% get_current_language %}</code> tag to retrieve the current language.</li>
<li class="numberedList">You get the languages defined in the <code class="inlineCode">LANGUAGES</code> setting using the <code class="inlineCode">{% get_available_languages %}</code> template tag.</li>
<li class="numberedList">You use the tag <code class="inlineCode">{% get_language_info_list %}</code> to provide easy access to the language attributes.</li>
<li class="numberedList">You build an HTML list to display all available languages, and you add a <code class="inlineCode">selected</code> class attribute to the currently active language.</li>
</ol>
<p class="normal">In the code for the language selector, you used the template tags provided by <code class="inlineCode">i18n</code>, based on the languages available in the settings of your project. Now, open <code class="inlineCode">http://127.0.0.1:8000/</code> in your browser and take a look. You should see the language selector in the top <a id="_idIndexMarker1052"/>right-hand corner of the site, as follows:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_11_09.png"/></figure>
<p class="packt_figref">Figure 11.9: The product list page, including a language selector in the site header</p>
<div><p class="normal">Images in this chapter:</p>
<p class="normal"><em class="italic">Green tea</em>: Photo by Jia Ye on Unsplash</p>
<p class="normal"><em class="italic">Red tea</em>: Photo by Manki Kim on Unsplash</p>
<p class="normal"><em class="italic">Tea powder</em>: Photo by Phuong Nguyen on Unsplash</p>
</div>
<p class="normal">Users can now <a id="_idIndexMarker1053"/>effortlessly switch to their preferred language by selecting from the options available in the language selector.</p>
<h1 class="heading-1" id="_idParaDest-320">Translating models with django-parler</h1>
<p class="normal">Django does <a id="_idIndexMarker1054"/>not include built-in support to translate models. To manage content in multiple languages, you can either develop a custom solution or opt for a third-party module that facilitates model translation. There are several third-party applications available, each employing a unique method for storing and retrieving translations. One of these applications is <code class="inlineCode">django-parler</code>. This module provides a very effective approach for translating models and integrates smoothly with Django’s administration site.</p>
<p class="normal"><code class="inlineCode">django-parler</code> generates a separate database table for each model that contains translations. This table<a id="_idIndexMarker1055"/> includes all the translated fields and a foreign key for the original object that the translation belongs to. It also contains a language field, since each row stores the content for a single language.</p>
<div><p class="normal">The <code class="inlineCode">django-parler</code> package has not received updates for several years. Despite this, many developers continue to use it because of its proven effectiveness in facilitating model translations.</p>
</div>
<h2 class="heading-2" id="_idParaDest-321">Installing django-parler</h2>
<p class="normal">Install <code class="inlineCode">django-parler</code> via <code class="inlineCode">pip</code> using the<a id="_idIndexMarker1056"/> following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install django-parler==2.3
</code></pre>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of your project and add <code class="inlineCode">'parler'</code> to the <code class="inlineCode">INSTALLED_APPS</code> setting, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">INSTALLED_APPS = [
    # ...
<strong class="hljs-string-slc">'parler'</strong><strong class="hljs-slc">,</strong>
]
</code></pre>
<p class="normal">Also, add the following code to your settings:</p>
<pre class="programlisting code"><code class="hljs-code"># django-parler settings
PARLER_LANGUAGES = {
    None: (
        {'code': 'en'},
        {'code': 'es'},
    ),
    'default': {
        'fallback': 'en',
        'hide_untranslated': False,
    }
}
</code></pre>
<p class="normal">This setting <a id="_idIndexMarker1057"/>defines the available languages, <code class="inlineCode">en</code> and <code class="inlineCode">es</code>, for <code class="inlineCode">django-parler</code>. You specify the default language, <code class="inlineCode">en</code>, and indicate that <code class="inlineCode">django-parler</code> should not hide untranslated content.</p>
<p class="normal">Parler is now activated in our project. Let’s add translation capabilities to our model fields.</p>
<h2 class="heading-2" id="_idParaDest-322">Translating model fields</h2>
<p class="normal">Let’s add translations <a id="_idIndexMarker1058"/>to your product catalog. <code class="inlineCode">django-parler</code> provides a <code class="inlineCode">TranslatableModel</code> model class and a <code class="inlineCode">TranslatedFields</code> wrapper to translate model fields. You can follow these instructions:</p>
<p class="normal">Edit the <code class="inlineCode">models.py</code> file inside the <code class="inlineCode">shop</code> application directory and add the following import:</p>
<pre class="programlisting code"><code class="hljs-code">from parler.models import TranslatableModel, TranslatedFields
</code></pre>
<p class="normal">Then, modify the <code class="inlineCode">Category</code> model to make the <code class="inlineCode">name</code> and <code class="inlineCode">slug</code> fields translatable, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">class Category(<strong class="hljs-title-slc">TranslatableModel</strong>):
<strong class="hljs-slc">    translations = TranslatedFields(</strong>
<strong class="hljs-slc"> </strong>       name = models.CharField(max_length=200)<strong class="hljs-slc">,</strong>
        slug = models.SlugField(max_length=200, unique=True)<strong class="hljs-slc">,</strong>
<strong class="hljs-slc">    )</strong>
</code></pre>
<p class="normal">The <code class="inlineCode">Category</code> model now inherits from <code class="inlineCode">TranslatableModel</code> instead of <code class="inlineCode">models.Model</code>, and both the <code class="inlineCode">name</code> and <code class="inlineCode">slug</code> fields are included in the <code class="inlineCode">TranslatedFields</code> wrapper.</p>
<p class="normal">Edit the <code class="inlineCode">Product</code> model to add translations for the <code class="inlineCode">name</code>, <code class="inlineCode">slug</code>, and <code class="inlineCode">description</code> fields, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">class Product(<strong class="hljs-title-slc">TranslatableModel</strong>):
<strong class="hljs-slc">    translations = TranslatedFields(</strong>
        name = models.CharField(max_length=200)<strong class="hljs-slc">,</strong>
        slug = models.SlugField(max_length=200)<strong class="hljs-slc">,</strong>
        description = models.TextField(blank=True)
<strong class="hljs-slc">    )</strong>
    category = models.ForeignKey(
        Category,
        related_name='products',
        on_delete=models.CASCADE
    )
    image = models.ImageField(
        upload_to='products/%Y/%m/%d',
        blank=True
    )
    price = models.DecimalField(max_digits=10, decimal_places=2)
    available = models.BooleanField(default=True)
    created = models.DateTimeField(auto_now_add=True)
    updated = models.DateTimeField(auto_now=True)
</code></pre>
<p class="normal"><code class="inlineCode">django-parler</code> manages <a id="_idIndexMarker1059"/>translations by generating another model for each translatable model. In the following schema, you can see the fields of the <code class="inlineCode">Product</code> model and what the generated <code class="inlineCode">ProductTranslation</code> model will look like:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_11_10.png"/></figure>
<p class="packt_figref">Figure 11.10: The Product model and related ProductTranslation model generated by django-parler</p>
<p class="normal">The <code class="inlineCode">ProductTranslation</code> model generated by <code class="inlineCode">django-parler</code> includes the <code class="inlineCode">name</code>, <code class="inlineCode">slug</code>, and <code class="inlineCode">description</code> translatable fields, a <code class="inlineCode">language_code</code> field, and a <code class="inlineCode">ForeignKey</code> for the master <code class="inlineCode">Product</code> object. There is a one-to-many relationship from <code class="inlineCode">Product</code> to <code class="inlineCode">ProductTranslation</code>. A <code class="inlineCode">ProductTranslation</code> object will exist for each available language of each <code class="inlineCode">Product</code> object.</p>
<p class="normal">Since <a id="_idIndexMarker1060"/>Django uses a separate table for translations, there are some Django features that you can’t use. It is not possible to use a default order with a translated field. You can filter by translated fields in queries, but you can’t include a translatable field in the <code class="inlineCode">ordering Meta</code> options. Also, you can’t use indexes for the fields that are translated, as these fields will not exist in the original model because they will reside in the translation model.</p>
<p class="normal">Edit the <code class="inlineCode">models.py</code> file of the <code class="inlineCode">shop</code> application and comment out the <code class="inlineCode">ordering</code> and <code class="inlineCode">indexes</code> attributes of the <code class="inlineCode">Category Meta</code> class:</p>
<pre class="programlisting code"><code class="hljs-code">class Category(TranslatableModel):
    # ...
class Meta:
        <strong class="hljs-comment-slc">#</strong> ordering = ['name']
<strong class="hljs-comment-slc">#</strong> indexes = [
<strong class="hljs-comment-slc">#</strong>     models.Index(fields=['name']),
<strong class="hljs-comment-slc">#</strong> ]
        verbose_name = 'category'
        verbose_name_plural = 'categories'
</code></pre>
<p class="normal">You also have to comment out the <code class="inlineCode">ordering</code> and attribute of the <code class="inlineCode">Product Meta</code> class and the indexes that refer to the translated fields. Comment out the following lines of the <code class="inlineCode">Product Meta</code> class:</p>
<pre class="programlisting code"><code class="hljs-code">class Product(TranslatableModel):
    # ...
class Meta:
        <strong class="hljs-comment-slc">#</strong> ordering = ['name']
        indexes = [
            <strong class="hljs-comment-slc">#</strong> models.Index(fields=['id', 'slug']),
<strong class="hljs-comment-slc">#</strong> models.Index(fields=['name']),
            models.Index(fields=['-created']),
        ]
</code></pre>
<p class="normal">You can read more about the <code class="inlineCode">django-parler</code> module’s compatibility <a id="_idIndexMarker1061"/>with Django at <a href="https://django-parler.readthedocs.io/en/latest/compatibility.html">https://django-parler.readthedocs.io/en/latest/compatibility.html</a>.</p>
<p class="normal">Let’s continue by integrating the translatable models into the administration site.</p>
<h2 class="heading-2" id="_idParaDest-323">Integrating translations into the administration site</h2>
<p class="normal"><code class="inlineCode">django-parler</code> integrates <a id="_idIndexMarker1062"/>seamlessly with the Django administration site. This allows you to easily edit different translations of your objects through the user-friendly admin interface. It includes a <code class="inlineCode">TranslatableAdmin</code> class that overrides the <code class="inlineCode">ModelAdmin</code> class provided by Django to manage model translations.</p>
<p class="normal">Edit the <code class="inlineCode">admin.py</code> file of the <code class="inlineCode">shop</code> application and add the following import to it:</p>
<pre class="programlisting code"><code class="hljs-code">from parler.admin import TranslatableAdmin
</code></pre>
<p class="normal">Modify the <code class="inlineCode">CategoryAdmin</code> and <code class="inlineCode">ProductAdmin</code> classes to inherit from <code class="inlineCode">TranslatableAdmin</code> instead of <code class="inlineCode">ModelAdmin</code>. The <code class="inlineCode">django-parler</code> module doesn’t support the <code class="inlineCode">prepopulated_fields</code> attribute, but it does support the <code class="inlineCode">get_prepopulated_fields()</code> method that provides the same functionality. Let’s change this accordingly. Edit the <code class="inlineCode">admin.py</code> file to make it look like the following:</p>
<pre class="programlisting code"><code class="hljs-code">from django.contrib import admin
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> parler.admin </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> TranslatableAdmin</strong>
from .models import Category, Product
@admin.register(Category)
class CategoryAdmin(<strong class="hljs-title-slc">TranslatableAdmin</strong>):
    list_display = ['name', 'slug']
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">get_prepopulated_fields</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self, request, obj=</strong><strong class="hljs-literal-slc">None</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> {</strong><strong class="hljs-string-slc">'slug'</strong><strong class="hljs-slc">: (</strong><strong class="hljs-string-slc">'name'</strong><strong class="hljs-slc">,)}</strong>
@admin.register(Product)
class ProductAdmin(<strong class="hljs-title-slc">TranslatableAdmin</strong>):
    list_display = [
        'name',
        'slug',
        'price',
        'available',
        'created',
        'updated'
    ]
    list_filter = ['available', 'created', 'updated']
    list_editable = ['price', 'available']
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">get_prepopulated_fields</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self, request, obj=</strong><strong class="hljs-literal-slc">None</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> {</strong><strong class="hljs-string-slc">'slug'</strong><strong class="hljs-slc">: (</strong><strong class="hljs-string-slc">'name'</strong><strong class="hljs-slc">,)}</strong>
</code></pre>
<p class="normal">You have adapted<a id="_idIndexMarker1063"/> the administration site to work with the new translated models. You can now sync the database with the model changes that you made.</p>
<h2 class="heading-2" id="_idParaDest-324">Creating migrations for model translations</h2>
<p class="normal">To create<a id="_idIndexMarker1064"/> migrations, follow these instructions:</p>
<p class="normal">Open the shell and run the following command to create a new migration for the model translations:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py makemigrations shop --name "translations"
</code></pre>
<p class="normal">You will see the following output:</p>
<pre class="programlisting con"><code class="hljs-con">Migrations for 'shop':
  shop/migrations/0002_translations.py
    - Create model CategoryTranslation
    - Create model ProductTranslation
    - Change Meta options on category
    - Change Meta options on product
    - Remove index shop_catego_name_289c7e_idx from category
    - Remove index shop_produc_id_f21274_idx from product
    - Remove index shop_produc_name_a2070e_idx from product
    - Remove field name from category
    - Remove field slug from category
    - Remove field description from product
    - Remove field name from product
    - Remove field slug from product
    - Add field master to producttranslation
    - Add field master to categorytranslation
    - Alter unique_together for producttranslation (1 constraint(s))
    - Alter unique_together for categorytranslation (1 constraint(s))
</code></pre>
<p class="normal">This migration automatically includes the <code class="inlineCode">CategoryTranslation</code> and <code class="inlineCode">ProductTranslation</code> models created dynamically by <code class="inlineCode">django-parler</code>. It’s important to note that this migration deletes the previous existing fields from your models. </p>
<p class="normal">This means that you will lose that data and need to set your categories and products again on the administration site after running it.</p>
<p class="normal">Edit the <a id="_idIndexMarker1065"/>file <code class="inlineCode">migrations/0002_translations.py</code> of the <code class="inlineCode">shop</code> application and identify the two occurrences of the following line:</p>
<pre class="programlisting code"><code class="hljs-code">bases=(parler.models.TranslatedFieldsModelMixin, models.Model),
</code></pre>
<p class="normal">Replace those occurrences with the following:</p>
<pre class="programlisting code"><code class="hljs-code">bases=(parler.models.<strong class="hljs-slc">TranslatableModel</strong>, models.Model),
</code></pre>
<p class="normal">This is a fix for a minor issue found in the <code class="inlineCode">django-parler</code> version you are using. This change is necessary to prevent the migration from failing when applying it. This issue is related to creating translations for existing fields in the model and shall be fixed in newer <code class="inlineCode">django-parler</code> versions.</p>
<p class="normal">Run the following command to apply the migration:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py migrate shop
</code></pre>
<p class="normal">You will see an output that ends with the following line:</p>
<pre class="programlisting con"><code class="hljs-con">Applying shop.0002_ categorytranslation_producttranslation_and_more... OK
</code></pre>
<p class="normal">Your models are now synchronized with the database.</p>
<p class="normal">Run the development server using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/en/admin/shop/category/</code> in your browser. You will see that existing categories lost their name and slug, due to deleting those fields and using the translatable models generated by <code class="inlineCode">django-parler</code> instead. You will just see a dash under each column, like in <em class="italic">Figure 11.11</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_11_11.png"/></figure>
<p class="packt_figref">Figure 11.11: The category list on the Django administration site after creating the translation models</p>
<p class="normal">Click on the <a id="_idIndexMarker1066"/>dash under the category name to edit it. You will see that the <strong class="screenText">Change category</strong> page includes two different tabs, one for English and one for Spanish translations:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_11_12.png"/></figure>
<p class="packt_figref">Figure 11.12: The category edit form, including the language tabs added by django-parler</p>
<p class="normal">Make sure that you fill in a name and slug for all existing categories. When you edit a category, enter the English details and click on <strong class="screenText">Save and continue editing</strong>. Then, click on <strong class="screenText">Spanish</strong>, add the Spanish translation for the fields, and click on <strong class="screenText">SAVE</strong>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_11_13.png"/></figure>
<p class="packt_figref">Figure 11.13: The Spanish translation of the category edit form</p>
<p class="normal">Make sure to save the changes before switching between the language tabs.</p>
<p class="normal">After you<a id="_idIndexMarker1067"/> complete the data for existing categories, open <code class="inlineCode">http://127.0.0.1:8000/en/admin/shop/product/</code> and edit each of the products, providing an English and Spanish name, a slug, and a description.</p>
<p class="normal">Once the translations are in place, the next step will be to explore how to interact with the translated fields through the Django ORM.</p>
<h2 class="heading-2" id="_idParaDest-325">Using translations in QuerySets</h2>
<p class="normal">Let’s<a id="_idIndexMarker1068"/> take a look at how to work with translations in QuerySets. Run<a id="_idIndexMarker1069"/> the following command to open the Python shell:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py shell
</code></pre>
<p class="normal">Let’s take a look at how you can retrieve and query translation fields. To get the object with translatable fields translated into a specific language, you can use Django’s <code class="inlineCode">activate()</code> function, as follows:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; from shop.models import Product
&gt;&gt;&gt; from django.utils.translation import activate
&gt;&gt;&gt; activate('es')
&gt;&gt;&gt; product=Product.objects.first()
&gt;&gt;&gt; product.name
'Té verde'
</code></pre>
<p class="normal">Another way to do this is by using the <code class="inlineCode">language()</code> manager provided by <code class="inlineCode">django-parler</code>, as follows:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; product=Product.objects.language('en').first()
&gt;&gt;&gt; product.name
'Green tea'
</code></pre>
<p class="normal">When you <a id="_idIndexMarker1070"/>access translated fields, they are resolved using the<a id="_idIndexMarker1071"/> current language. You can set a different current language for an object to access that specific translation, as follows:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; product.set_current_language('es')
&gt;&gt;&gt; product.name
'Té verde'
&gt;&gt;&gt; product.get_current_language()
'es'
</code></pre>
<p class="normal">When performing a QuerySet using <code class="inlineCode">filter()</code>, you can filter using the related translation objects with the <code class="inlineCode">translations__</code> syntax, as follows:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; Product.objects.filter(translations__name='Green tea')
&lt;TranslatableQuerySet [&lt;Product: Té verde&gt;]&gt;	
</code></pre>
<p class="normal">Let’s apply what we have learned to our views.</p>
<h2 class="heading-2" id="_idParaDest-326">Adapting views for translations</h2>
<p class="normal">Let’s <a id="_idIndexMarker1072"/>adapt the<a id="_idIndexMarker1073"/> product catalog views:</p>
<p class="normal">Edit the <code class="inlineCode">views.py</code> file of the <code class="inlineCode">shop</code> application and add the following code highlighted<a id="_idIndexMarker1074"/> in bold<a id="_idIndexMarker1075"/> to the <code class="inlineCode">product_list</code> view:</p>
<pre class="programlisting code"><code class="hljs-code">def product_list(request, category_slug=None):
    category = None
    categories = Category.objects.all()
    products = Product.objects.filter(available=True)
    if category_slug:
<strong class="hljs-slc">        language = request.LANGUAGE_CODE</strong>
        category = get_object_or_404(
            Category,
<strong class="hljs-slc">            translations__language_code=language,</strong>
<strong class="hljs-slc">            translations__</strong>slug=category_slug
        )
        products = products.filter(category=category)
    return render(
        request,
        'shop/product/list.html',
        {
            'category': category,
            'categories': categories,
            'products': products
        }
    )
</code></pre>
<p class="normal">Then, edit the <code class="inlineCode">product_detail</code> view and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">def product_detail(request, id, slug):
<strong class="hljs-slc">    language = request.LANGUAGE_CODE</strong>
    product = get_object_or_404(
        Product,
        id=id,
        <strong class="hljs-slc">translations__language_code=language,</strong>
<strong class="hljs-slc">        translations__</strong>slug=slug,
        available=True
    )
    cart_product_form = CartAddProductForm()
    r = Recommender()
    recommended_products = r.suggest_products_for([product], 4)
    return render(
        request,
        'shop/product/detail.html',
        {
            'product': product,
            'cart_product_form': cart_product_form,
            'recommended_products': recommended_products
        }
    )
</code></pre>
<p class="normal">The <code class="inlineCode">product_list</code> and <code class="inlineCode">product_detail</code> views are now adapted to retrieve objects using translated fields.</p>
<p class="normal">Run the <a id="_idIndexMarker1076"/>development <a id="_idIndexMarker1077"/>server with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/es/</code> in your browser. You should see the product list page, including all products translated into Spanish:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_11_14.png"/></figure>
<p class="packt_figref">Figure 11.14: The Spanish version of the product list page</p>
<p class="normal">Now, each<a id="_idIndexMarker1078"/> product’s<a id="_idIndexMarker1079"/> URL is built using the <code class="inlineCode">slug</code> field translated into the current language. For example, the URL for a product in Spanish is <code class="inlineCode">http://127.0.0.1:8000/es/2/te-rojo/</code>, whereas, in English, the URL is <code class="inlineCode">http://127.0.0.1:8000/en/2/red-tea/</code>. If you navigate to a product details page, you will see the translated URL and the contents of the selected language, as shown in the following example:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_11_15.png"/></figure>
<p class="packt_figref">Figure 11.15: The Spanish version of the product details page</p>
<p class="normal">If you want to know more <a id="_idIndexMarker1080"/>about <code class="inlineCode">django-parler</code>, you can find the full documentation at <a href="https://django-parler.readthedocs.io/en/latest/">https://django-parler.readthedocs.io/en/latest/</a>.</p>
<p class="normal">You have learned how to translate Python code, templates, URL patterns, and model fields. To complete the internationalization and localization process, you need to use localized formatting for dates, times, and numbers as well.</p>
<h1 class="heading-1" id="_idParaDest-327">Format localization</h1>
<p class="normal">To enhance user experience, it’s <a id="_idIndexMarker1081"/>important to present dates, times, and numbers in formats that align with the user’s locale. Adapting your site to the data formats familiar to users in various regions significantly improves its accessibility. Since Django 5.0, localized formatting of data is always enabled. Django displays numbers and dates using the format of the current locale.</p>
<p class="normal">Django tries to use a locale-specific format whenever it outputs a value in a template. <em class="italic">Figure 11.16</em> shows the format localization for decimal numbers in the English and Spanish versions of the site:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_11_16.png"/></figure>
<p class="packt_figref">Figure 11.16: Format localization in English and Spanish</p>
<p class="normal">Decimal numbers in the English version are displayed with a dot separator for decimal places, while in the Spanish version, a comma is used as the separator. This is due to the locale formats specified for<a id="_idIndexMarker1082"/> the <code class="inlineCode">en</code> and <code class="inlineCode">es</code> locales by Django. You can take a look at the English formatting configuration at <a href="https://github.com/django/django/blob/stable/5.0.x/django/conf/locale/en/formats.py">https://github.com/django/django/blob/stable/5.0.x/django/conf/locale/en/formats.py</a> and the Spanish formatting configuration at <a href="https://github.com/django/django/blob/stable/5.0.x/django/conf/locale/es/formats.py">https://github.com/django/django/blob/stable/5.0.x/django/conf/locale/es/formats.py</a>.</p>
<p class="normal">By default, Django applies the format localization for each locale. However, there might be cases for which you don’t want to use localized values. This is especially relevant when outputting JavaScript or JSON, which has to provide a machine-readable format.</p>
<p class="normal">Django offers a <code class="inlineCode">{% localize %}</code> template tag that allows you to turn on/off localization for template fragments. This gives you control over localized formatting. You will have to load the <code class="inlineCode">l10n</code> (localization) tags to be able to use this template tag. The following is an example of how to turn localization on and off in a template:</p>
<pre class="programlisting code"><code class="hljs-code">{% load l10n %}
{% localize on %}
  {{ value }}
{% endlocalize %}
{% localize off %}
  {{ value }}
{% endlocalize %}
</code></pre>
<p class="normal">Django also offers the <code class="inlineCode">localize</code> and <code class="inlineCode">unlocalize</code> template filters to force or avoid the localization of a value. These filters can be applied as follows:</p>
<pre class="programlisting code"><code class="hljs-code">{{ value|localize }}
{{ value|unlocalize }}
</code></pre>
<p class="normal">You can also create custom<a id="_idIndexMarker1083"/> format files to specify locale formatting. You can find further information about format localization at <a href="https://docs.djangoproject.com/en/5.0/topics/i18n/formatting/">https://docs.djangoproject.com/en/5.0/topics/i18n/formatting/</a>.</p>
<p class="normal">Next, you will learn how to create localized form fields.</p>
<h1 class="heading-1" id="_idParaDest-328">Using django-localflavor to validate form fields</h1>
<p class="normal"><code class="inlineCode">django-localflavor</code> is a <a id="_idIndexMarker1084"/>third-party module that contains a collection of utilities, such as form fields or model fields, that are specific for each country. It’s very useful for validating local regions, local phone numbers, identity card numbers, social security numbers, and so on. The package is organized into a series of modules named after ISO 3166 <a id="_idIndexMarker1085"/>country codes. Follow these instructions to set it up:</p>
<p class="normal">Install <code class="inlineCode">django-localflavor</code> using the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install django-localflavor==4.0
</code></pre>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of your project and add <code class="inlineCode">localflavor</code> to the <code class="inlineCode">INSTALLED_APPS</code> setting, as follows:</p>
<pre class="programlisting con"><code class="hljs-con">INSTALLED_APPS = [
    # ...
<strong class="hljs-string-slc">'localflavor'</strong><strong class="hljs-slc">,</strong>
]
</code></pre>
<p class="normal">You are going to add the United States zip code field so that a valid United States zip code is required to create a new order. Edit the <code class="inlineCode">forms.py</code> file of the <code class="inlineCode">orders</code> application and make it look like the following:</p>
<pre class="programlisting code"><code class="hljs-code">from django import forms
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> localflavor.us.forms </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> USZipCodeField</strong>
from .models import Order
class OrderCreateForm(forms.ModelForm):
<strong class="hljs-slc">    postal_code = USZipCodeField()</strong>
class Meta:
        model = Order
        fields = [
            'first_name',
            'last_name',
            'email',
            'address',
            'postal_code',
            'city'
        ]
</code></pre>
<p class="normal">You import the <code class="inlineCode">USZipCodeField</code> field from the <code class="inlineCode">us</code> package of <code class="inlineCode">localflavor</code> and use it for the <code class="inlineCode">postal_code</code> field of the <code class="inlineCode">OrderCreateForm</code> form.</p>
<p class="normal">Run the<a id="_idIndexMarker1086"/> development server with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/en/orders/create/</code> in your browser. Fill in all the fields, enter a three-letter zip code, and then submit the form. You will get the following validation error, which is raised by <code class="inlineCode">USZipCodeField</code>:</p>
<pre class="programlisting con"><code class="hljs-con">Enter a zip code in the format XXXXX or XXXXX-XXXX.
</code></pre>
<p class="normal"><em class="italic">Figure 11.17</em> shows the form validation error:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_11_17.png"/></figure>
<p class="packt_figref">Figure 11.17: The validation error for an invalid US zip code</p>
<p class="normal">This is <a id="_idIndexMarker1087"/>just a brief example of how to use a custom field from <code class="inlineCode">localflavor</code> in your own project for validation purposes. The local components provided by <code class="inlineCode">localflavor</code> are very useful for adapting your application to specific countries. You can read the <code class="inlineCode">django-localflavor</code> documentation and see all the <a id="_idIndexMarker1088"/>available local components for each country at <a href="https://django-localflavor.readthedocs.io/en/latest/">https://django-localflavor.readthedocs.io/en/latest/</a>.</p>
<h1 class="heading-1" id="_idParaDest-329">Expanding your project using AI</h1>
<p class="normal">In this section, you are <a id="_idIndexMarker1089"/>presented with a task to extend your project, accompanied by a sample prompt for ChatGPT to assist you. To engage with <a id="_idIndexMarker1090"/>ChatGPT, visit <a href="https://chat.openai.com/">https://chat.openai.com/</a>. If this is your first interaction with ChatGPT, you can revisit the <em class="italic">Expanding your project using AI</em> section in <em class="italic">Chapter 3, Extending Your Blog Application</em>.</p>
<p class="normal">In this project example, we have implemented an online shop. We have added orders, payments, and a coupon system. Now, another typical feature of e-commerce platforms is managing shipping costs. Let’s consider adding a weight attribute to products and implementing shipping costs based on the total weight of the items shipped. Use ChatGPT to help you implement shipping costs for products, making them dependent on the product’s weight. Ensure that Stripe charges the correct amount, including the calculated shipping costs. You can use the prompt provided at <a href="https://github.com/PacktPublishing/Django-5-by-example/blob/main/Chapter11/prompts/task.md">https://github.com/PacktPublishing/Django-5-by-example/blob/main/Chapter11/prompts/task.md</a>.</p>
<div><p class="normal">Use ChatGPT as a debugging companion. If you find yourself stuck on a particularly stubborn bug, describe the problem and the context. It can provide a fresh perspective, often prompting you to consider angles you might have overlooked, leading to quicker problem resolution.</p>
</div>
<h1 class="heading-1" id="_idParaDest-330">Summary</h1>
<p class="normal">In this chapter, you learned the basics of the internationalization and localization of Django projects. You marked code and template strings for translation, and you discovered how to generate and compile translation files. You also installed Rosetta in your project to manage translations through a web interface. You translated URL patterns, and you created a language selector to allow users to switch the language of the site. Then, you used <code class="inlineCode">django-parler</code> to translate models, and you used <code class="inlineCode">django-localflavor</code> to validate localized form fields.</p>
<p class="normal">In the next chapter, you will start a new Django project that will consist of an e-learning platform. You will learn how to use model inheritance to implement polymorphism, and you will lay the foundations for a flexible content management system. You will create the application models, and you will learn how to create and apply fixtures to provide initial data for the models. You will build a custom model field and use it in your models. You will also build authentication views for your new application.</p>
<h1 class="heading-1" id="_idParaDest-331">Additional resources</h1>
<p class="normal">The following resources provide additional information related to the topics covered in this chapter:</p>
<ul>
<li class="bulletList">The source code for this chapter: <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter11">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter11</a></li>
<li class="bulletList">A list of valid language IDs: <a href="http://www.i18nguy.com/unicode/language-identifiers.html">http://www.i18nguy.com/unicode/language-identifiers.html</a></li>
<li class="bulletList">A list of internationalization and localization settings: <a href="https://docs.djangoproject.com/en/5.0/ref/settings/#globalization-i18n-l10n">https://docs.djangoproject.com/en/5.0/ref/settings/#globalization-i18n-l10n</a></li>
<li class="bulletList">Homebrew package manager: <a href="https://brew.sh/">https://brew.sh/</a></li>
<li class="bulletList">Installing <code class="inlineCode">gettext</code> on Windows: <a href="https://docs.djangoproject.com/en/5.0/topics/i18n/translation/#gettext-on-windows">https://docs.djangoproject.com/en/5.0/topics/i18n/translation/#gettext-on-windows</a></li>
<li class="bulletList">Precompiled <code class="inlineCode">gettext</code> binary installer for Windows: <a href="https://mlocati.github.io/articles/gettext-iconv-windows.html">https://mlocati.github.io/articles/gettext-iconv-windows.html</a></li>
<li class="bulletList">Documentation about translations: <a href="https://docs.djangoproject.com/en/5.0/topics/i18n/translation/">https://docs.djangoproject.com/en/5.0/topics/i18n/translation/</a></li>
<li class="bulletList">Poedit translation file editor: <a href="https://poedit.net/">https://poedit.net/</a></li>
<li class="bulletList">Documentation for Django Rosetta: <a href="https://django-rosetta.readthedocs.io/">https://django-rosetta.readthedocs.io/</a></li>
<li class="bulletList">The <code class="inlineCode">django-parler</code> module’s compatibility with Django: <a href="https://django-parler.readthedocs.io/en/latest/compatibility.html">https://django-parler.readthedocs.io/en/latest/compatibility.html</a></li>
<li class="bulletList">Documentation for <code class="inlineCode">django-parler</code>: <a href="https://django-parler.readthedocs.io/en/latest/">https://django-parler.readthedocs.io/en/latest/</a></li>
<li class="bulletList">Django formatting configuration for the English locale: <a href="https://github.com/django/django/blob/stable/5.0.x/django/conf/locale/en/formats.py">https://github.com/django/django/blob/stable/5.0.x/django/conf/locale/en/formats.py</a></li>
<li class="bulletList">Django formatting configuration for the Spanish locale: <a href="https://github.com/django/django/blob/stable/5.0.x/django/conf/locale/es/formats.py">https://github.com/django/django/blob/stable/5.0.x/django/conf/locale/es/formats.py</a></li>
<li class="bulletList">Django format localization: <a href="https://docs.djangoproject.com/en/5.0/topics/i18n/formatting/">https://docs.djangoproject.com/en/5.0/topics/i18n/formatting/</a></li>
<li class="bulletList">Documentation for <code class="inlineCode">django-localflavor</code>: <a href="https://django-localflavor.readthedocs.io/en/latest/">https://django-localflavor.readthedocs.io/en/latest/</a></li>
</ul>
</div>
</body></html>