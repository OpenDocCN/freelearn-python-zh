<html><head></head><body>
		<div><div></div>
		</div>
		<div><h1 id="_idParaDest-418"><a id="_idTextAnchor435"/>15. Django Third-Party Libraries</h1>
		</div>
		<div><p class="callout-heading">Overview</p>
			<p class="callout">This chapter introduces you to Django third-party libraries. You will configure your database connection using URLs with <code>dj-database-urls</code> and inspect and debug your application with the <code>django-crispy-forms</code>, you will enhance the look of your forms, as well as reduce the amount of code you have to write by using the <code>crispy</code> template tag. We will also cover the <code>django-allauth</code> library, which lets you authenticate users against third-party providers. In the final activity, we will enhance Bookr's forms with the use of <code>django-crispy-forms</code>.</p>
			<h1 id="_idParaDest-419"><a id="_idTextAnchor436"/>Introduction</h1>
			<p>Because Django has been around since 2007, there is a rich ecosystem of third-party libraries that can be plugged into an application to give it extra features. So far, we have learned a lot about Django and used many of its features, including database models, URL routing, templating, forms, and more. We used these Django tools directly to build a web app, but now we will look at how to leverage the work of others to quickly add even more advanced features to our own apps. We have alluded to apps for storing files, (in <em class="italic">Chapter 5</em>, <em class="italic">Serving Static Files</em>, we mentioned an app, <code>django-storages</code>, that can store our static files in a CDN), but in addition to file storage, we can also use them to plug into third-party authentication systems, integrate with payment gateways, customize how our settings are built, modify images, build forms more easily, debug our site, use different types of databases, and much more. Chances are, if you want to add a certain feature, an app exists for it.</p>
			<p>We don't have space to cover every app in this chapter, so we'll just focus on four that provide useful features across many different types of apps. <code>django-configurations</code> allows you to configure your Django settings using classes and take advantage of inheritance to simplify settings for different environments. This works in tandem with <code>dj-database-urls</code> to specify your database connection setting using just a URL. The <em class="italic">Django Debug Toolbar</em> lets you get extra information to help with debugging, right in your browser. The last app we'll look at is <code>django-crispy-forms</code>, which provides extra CSS classes to make forms look nicer, as well as making them easier to configure using just Python code.</p>
			<p>For each of these libraries, we will cover installation and basic setup and use, mostly as they apply to Bookr. They also have more configuration options to further customize to fit your application. Each of these apps can be installed with <code>pip</code>.</p>
			<p>We will also briefly introduce <code>django-allauth</code>, which allows a Django application to authenticate users against third-party providers (such as Google, GitHub, Facebook, and Twitter). We won't cover its installation and setup in detail but will provide some examples to help you configure it. </p>
			<h2 id="_idParaDest-420"><a id="_idTextAnchor437"/>Environment Variables</h2>
			<p>When we create a program, we often want the user to be able to configure some of its behavior. For example, say you have a program that connects to a database and saves all the records it finds into a file. Normally it would probably print out just a <em class="italic">success</em> message to the terminal, but you might also want to run it in <em class="italic">debug mode</em>, which makes it also print out all the SQL statements it is executing.</p>
			<p>There are many ways of configuring a program like this. For example, you could have it read from a configuration file. But in some cases, the user may quickly want to run the Django server with a particular setting on (say, debug mode), and then run the server again with the same setting off. Having to change the configuration file each time can be inconvenient. In this case, we can read from an <em class="italic">environment variable</em>. Environment variables are key/value pairs that can be set in your operating system and then read by a program. There are several ways they can be set:</p>
			<ul>
				<li>Your shell (terminal) can read variables from a profile script when it starts, then each program will have access to these variables.</li>
				<li>You can set a variable inside a terminal and it will be made available to any programs that start subsequently. In Linux and macOS, this is done with the <code>export</code> command; Windows uses the <code>set</code> command. Any variables you set in this way override those in the profile script, but only for the current session. When you close the terminal, the variables are lost.</li>
				<li>You can set environment variables at the same time as running a command in a terminal. These will only persist for the program being run, and they override exported environment variables and those read from a profile script.</li>
				<li>You can set environment variables inside a running program, and they will be available only inside the program (or to programs your program starts). Environment variables set in this way will override all the other methods we have just set.</li>
			</ul>
			<p>These might sound complicated, but we will explain them with a short Python script and show how variables can be set in the last three ways (the first method depends on what shell you use). The script will also show how environment variables are read.</p>
			<p>Environment variables are available in Python using the <code>os.environ</code> variable. This is a dictionary-like object that can be used to access environment variables by name. It is safest to access values using the <code>get</code> method just in case they are not set. It also provides a <code>setdefault</code> method, which allows setting a value only if it is not set (that is, it doesn't overwrite an existing key).</p>
			<p>Here is the example Python script that reads environment variables:</p>
			<pre>import os
# This will set the value since it's not already set
os.environ.setdefault('UNSET_VAR', 'UNSET_VAR_VALUE')
# This value will not be set since it's already passed
# in from the command line
os.environ.setdefault('SET_VAR', 'SET_VAR_VALUE')
print('UNSET_VAR:' + os.environ.get('UNSET_VAR', ''))
print('SET_VAR:' + os.environ.get('SET_VAR', ''))
# All these values were provided from the shell in some way
print('HOME:' + os.environ.get('HOME', ''))
print('VAR1:' + os.environ.get('VAR1', ''))
print('VAR2:' + os.environ.get('VAR2', ''))
print('VAR3:' + os.environ.get('VAR3', ''))
print('VAR4:' + os.environ.get('VAR4', ''))</pre>
			<p>We then set up our shell by setting some variables. In Linux or macOS, we use <code>export</code> (note there is no output from these commands):</p>
			<pre>$ export SET_VAR="Set Using Export"
$ export VAR1="Set Using Export"
$ export VAR2="Set Using Export"</pre>
			<p>In Windows, we would use the <code>set</code> command in the command line as follows:</p>
			<pre>set SET_VAR="Set Using Export"
set VAR1="Set Using Export"
set VAR2="Set Using Export"</pre>
			<p>In Linux and macOS, we can also provide environment variables by setting them before the command (the actual command is just <code>python3 env_example.py</code>):</p>
			<pre>$ VAR2="Set From Command Line" VAR3="Also Set From Command Line" python3 env_example.py </pre>
			<p class="callout-heading">Note</p>
			<p class="callout">Note that the above command will not work on Windows. For Windows, the environment variables must be set before execution and cannot be passed in at the same time.</p>
			<p>The output from this command is:</p>
			<pre>UNSET_VAR:UNSET_VAR_VALUE
SET_VAR:Set Using Export
HOME:/Users/ben
VAR1:Set Using Export
VAR2:Set From Command Line
VAR3:Also Set From Command Line
VAR4:</pre>
			<ul>
				<li>When the script runs <code>os.environ.setdefault('UNSET_VAR', 'UNSET_VAR_VALUE')</code>, the value is set inside the script, since no value for <code>UNSET_VAR</code> was set by the shell. The value that is output is the one set by the script itself.</li>
				<li>When <code>os.environ.setdefault('SET_VAR', 'SET_VAR_VALUE')</code> is executed, the value is not set since one was provided by the shell. This was set with the <code>export SET_VAR="Set Using Export"</code> command.</li>
				<li>The value for <code>HOME</code> was not set by any of the commands that were run – this is one provided by the shell. It is the user's home directory. This is just an example of an environment variable that a shell normally provides.</li>
				<li><code>VAR1</code> was set by <code>export</code> and was not overridden when executing the script.</li>
				<li><code>VAR2</code> was set by <code>export</code> but was subsequently overridden when executing the script.</li>
				<li><code>VAR3</code> was only set when executing the script.</li>
				<li><code>VAR4</code> was never set – we use the <code>get</code> method to access it to avoid a <code>KeyError</code>.</li>
			</ul>
			<p>Now that environment variables have been covered, we can return to discussing the changes that need to be made to <code>manage.py</code> to support <code>django-configurations</code>.</p>
			<h2 id="_idParaDest-421"><a id="_idTextAnchor438"/>django-configurations</h2>
			<p>One of the main considerations when deploying a Django application to production is how to configure it. As you have seen throughout this book, the <code>settings.py</code> file is where all your Django configuration is defined. Even third-party apps have their configuration in this file. You have already seen this in <em class="italic">Chapter 12</em>, <em class="italic">Building a REST API</em>, when working with the Django REST framework.</p>
			<p>There are many ways to provide different configurations and switch between them in Django. If you have begun working on an existing application that already has a specific method of switching between configurations in development and production environments, then you should probably keep using that method.</p>
			<p>When we release Bookr onto a product web server, in <em class="italic">Chapter 17</em>, <em class="italic">Deployment of a Django Application (Part 1 – Server Setup)</em>, we will need to switch to a production configuration, and that's when we will use <code>django-configurations</code>.</p>
			<p>To install <code>django-configurations</code>, use <code>pip3</code> as follows:</p>
			<pre><strong class="bold">pip3</strong> install django-configurations</pre>
			<p class="callout-heading">Note</p>
			<p class="callout">For Windows, you can use <code>pip</code> instead of <code>pip3</code> in the preceding command.</p>
			<p>The output will be as follows:</p>
			<pre>Collecting django-configurations
  Using cached https://files.pythonhosted.org/packages/96/ef/bddcce16f3cd36f03c9874d8ce1e5d35f3cedea27b7d8455265e79a77c3d/django_configurations-2.2-py2.py3-none-any.whl
Requirement already satisfied: six in /Users/ben/.virtualenvs/bookr/lib/python3.6/site-packages (from django-configurations) (1.14.0)
Installing collected packages: django-configurations
Successfully installed django-configurations-2.2</pre>
			<p><code>django-configurations</code> changes your <code>settings.py</code> file so that all the settings are read from a class you define, which will be a subclass of <code>configurations.Configuration</code>. Instead of the settings being global variables inside <code>settings.py</code>, they will be attributes on the class you define. By using this class-based method, we can take advantage of object-oriented paradigms, most notably inheritance. Settings, defined in a class, can inherit settings in another class. For example, the production settings class can inherit the development settings class and just override some specific settings – such as forcing <code>DEBUG</code> to <code>False</code> in production.</p>
			<p>We can illustrate what needs to be done to the settings file by just showing the first few settings in the file. A standard Django <code>settings.py</code> file normally starts like this (comment lines have been removed):</p>
			<pre>import os
BASE_DIR =os.path.dirname\
          (os.path.dirname(os.path.abspath(__file__)))
SECRET_KEY =\
'y%ux@_^+#eahu3!^i2w71qtgidwpvs^o=w2*$=xy+2-y4r_!fw'
DEBUG = True
…
# The rest of the settings are not shown</pre>
			<p>To convert the settings to <code>django-configurations</code>, first import <code>Configuration</code> from <code>configurations</code>. Then define a <code>Configuration</code> subclass. Finally, indent all the settings to be under the class. In PyCharm, this is as simple as selecting all the settings and pressing <em class="italic">Tab</em> to indent them all.</p>
			<p>After doing this, your <code>settings.py</code> file will look like this:</p>
			<pre>import os
<a id="_idTextAnchor439"/>
from configurations import Configuration
class Dev(Configuration):
    BASE_DIR = os.path.dirname\
               (os.path.dirname(os.path.abspath(__file__)))
    SECRET_KEY = \
    'y%ux@_^+#eahu3!^i2w71qtgidwpvs^o=w2*$=xy+2-y4r_!fw'
    DEBUG = True
    …
    # All other settings indented in the same manner</pre>
			<p>To have different configurations (different sets of settings), you can just extend your configuration classes and override the settings that should differ.</p>
			<p>For example, one variable that needs overriding in production is <code>DEBUG</code>: it should be <code>False</code> (for security and performance reasons). A <code>Prod</code> class can be defined that extends <code>Dev</code> and sets <code>DEBUG</code>, like this:</p>
			<pre>class Dev(Configuration):
    DEBUG = True
    …
    # Other settings truncated
<a id="_idTextAnchor440"/>
class Prod(Dev):
    DEBUG = False
    # no other settings defined since we're only overriding DEBUG</pre>
			<p>Of course, you can override other production settings too, not just <code>DEBUG</code>. Usually, for security, you would also redefine <code>SECRET_KEY</code> and <code>ALLOWED_HOSTS</code>; and to configure Django to use your production database, you'd set the <code>DATABASES</code> value too. Any Django setting can be configured as you choose.</p>
			<p>If you try to execute runserver (or other management commands) now, you will get an error because Django doesn't know how to find the <code>settings.py</code> file when the settings files are laid out like this:</p>
			<pre>django.core.exceptions.ImproperlyConfigured: django-configurations settings importer wasn't correctly installed. Please use one of the starter functions to install it as mentioned in the docs: https://django-configurations.readthedocs.io/</pre>
			<p>We need to make some changes to the <code>manage.py</code> file before it starts to work again. But before we make them, we'll briefly discuss environment variables, in case you haven't used them before.</p>
			<h2 id="_idParaDest-422"><a id="_idTextAnchor441"/>manage.py changes</h2>
			<p>There are two lines that need to be added/changed in <code>manage.py</code> to enable <code>django-configurations</code>. First, we need to define a default environment variable that tells Django Configuration which <code>Configuration</code> class it should load.</p>
			<p>This line should be added in the <code>main()</code> function to set the default value for the <code>DJANGO_CONFIGURATION</code> environment variable:</p>
			<pre><a id="_idTextAnchor442"/>os.environ.setdefault('DJANGO_CONFIGURATION', 'Dev')</pre>
			<p>This sets the default to <code>Dev</code> – the name of the class we defined. As we saw in our example script, if this value is already defined, it won't be overwritten. This will allow us to switch between configurations using an environment variable.</p>
			<p>The second change is to swap the <code>execute_from_command_line</code> function with one that <code>django-configurations</code> provides. Consider the following line:</p>
			<pre>from django.core.management import execute_from_command_line</pre>
			<p>This line is changed as follows:</p>
			<pre><a id="_idTextAnchor443"/>from configurations.management import execute_from_command_line</pre>
			<p>From now on, <code>manage.py</code> will work as it did before, except it now prints out which <code>Configuration</code> class it's using when it starts (<em class="italic">Figure 15.1</em>):</p>
			<div><div><img src="img/B15509_15_01.jpg" alt="Figure 15.1: django-configurations is using the configuration Dev&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.1: django-configurations is using the configuration Dev</p>
			<p>In the second line, you can see <code>django-configurations</code> output that is using the <code>Dev</code> class for settings.</p>
			<h2 id="_idParaDest-423"><a id="_idTextAnchor444"/>Configuration from Environment Variables</h2>
			<p>As well as switching between <code>Configuration</code> classes using environment variables, <code>django-configurations</code> allows us to give values for individual settings using environment variables. It provides <code>Value</code> classes that will automatically read values from the environment. We can define defaults if no values are provided. Since environment variables are always strings, the different <code>Value</code> classes are used to convert from a string to the specified type.</p>
			<p>Let's look at this in practice with a few examples. We will allow <code>DEBUG</code>, <code>ALLOWED_HOSTS</code>,  <code>TIME_ZONE</code>, and <code>SECRET_KEY</code> to be set with environment variables as follows:</p>
			<pre>from configurations import Configuration, values
class Dev(Configuration):
    DEBUG = values.BooleanValue(True)
    ALLOWED_HOSTS = values.ListValue([])
    TIME_ZONE = values.Value('UTC')
    SECRET_KEY =\
    'y%ux@_^+#eahu3!^i2w71qtgidwpvs^o=w2*$=xy+2-y4r_!fw'
    …
    # Other settings truncated
class Prod(Dev):
    DEBUG = False
    SECRET_KEY = values.SecretValue()
    # no other settings are present</pre>
			<p>We'll explain the settings one at a time:</p>
			<ul>
				<li>In <code>Dev</code>, <code>DEBUG</code> is read from an environment variable and cast to a Boolean value. The values <code>yes</code>, <code>y</code>, <code>true</code>, and <code>1</code> become <code>True</code>; the values <code>no</code>, <code>n</code>, <code>false</code>, and <code>0</code> become <code>False</code>. This allows us to run with <code>DEBUG</code> off even on a development machine, which can be useful in some cases (for example, testing a custom exception page rather than Django's default one). In the <code>Prod</code> configuration, we don't want <code>DEBUG</code> to accidentally become <code>True</code>, so we set it statically.</li>
				<li><code>ALLOWED_HOSTS</code> is required in production. It is a list of hosts for which Django should accept requests.</li>
				<li>The <code>ListValue</code> class will convert a comma-separated string into a Python list. </li>
				<li>For example, the string <code>www.example.com,example.com</code> is converted to <code>["www.example.com", "example.com"]</code></li>
				<li><code>TIME_ZONE</code> accepts just a string value, so it is set using the <code>Value</code> class. This class just reads the environment variable and does not transform it at all.</li>
				<li><code>SECRET_KEY</code> is statically defined in the <code>Dev</code> configuration; it can't be changed with an environment variable. In the <code>Prod</code> configuration, it is set with <code>SecretValue</code>. This is like <code>Value</code> in that it is just a string setting; however, it does not allow a default. If a default is set, then an exception is raised. This is to ensure you don't ever put a secret value into <code>settings.py</code>, since it might be accidentally shared (for example, uploaded to GitHub). Note that since we do not use <code>SECRET_KEY</code> for <code>Dev</code> in production, we don't care if it's leaked.</li>
			</ul>
			<p>By default, <code>django-configurations</code> expects the <code>DJANGO_</code> prefix for each environment variable. For example, to set <code>DEBUG</code>, use the <code>DJANGO_DEBUG</code> environment variable; to set <code>ALLOWED_HOSTS</code>, use <code>DJANGO_ALLOWED_HOSTS</code>, and so on.</p>
			<p>Now that we've introduced <code>django-configurations</code> and the changes that need to be made to the project to support it, let's add it to Bookr and make those changes. In the next exercise, you will install and set up <code>django-configurations</code> in Bookr.</p>
			<h2 id="_idParaDest-424"><a id="_idTextAnchor445"/>Exercise 15.01: Django Configurations Setup</h2>
			<p>In this exercise, you will install <code>django-configurations</code> using <code>pip</code>, then update <code>settings.py</code> to add a <code>Dev</code> and <code>Prod</code> configuration. You'll then make the necessary changes to <code>manage.py</code> to support the new configuration style, and test that everything is still working:</p>
			<ol>
				<li>In a terminal, make sure you have activated the <code>bookr</code> virtual environment, then run this command to install <code>django-configurations</code> using <code>pip3</code>:<pre>pip3 install django-configurations</pre><p class="callout-heading">Note</p><p class="callout">For Windows, you can use <code>pip</code> instead of <code>pip3</code> in the preceding command.</p><p>The install process will run, and you should have output like <em class="italic">Figure 15.2</em>:</p><div><img src="img/B15509_15_02.jpg" alt="Figure 15.2: django-configurations installation with pip&#13;&#10;"/></div><p class="figure-caption">Figure 15.2: django-configurations installation with pip</p></li>
				<li>In PyCharm, open <code>settings.py</code> inside the <code>bookr</code> package. Underneath the existing <code>os</code> import, import <code>Configuration</code> and <code>values</code> from <code>configurations</code>, like this:<pre>fr<a id="_idTextAnchor446"/>om configurations import Configuration, values</pre></li>
				<li>After the imports but before your first setting definition (the line that sets the <code>BASE_DIR</code> value), add a new <code>Configuration</code> subclass, called <code>Dev</code>:<pre>class Dev(Configuration):</pre></li>
				<li>Now we need to move all the existing settings, so they are attributes of the <code>Dev</code> class rather than global variables. In PyCharm, this is as simple as selecting all the settings, and then pressing the <em class="italic">Tab</em> key to indent them. After doing this, your settings should look as follows:<div><img src="img/B15509_15_03.jpg" alt="Figure 15.3: New Dev configuration&#13;&#10;"/></div><p class="figure-caption">Figure 15.3: New Dev configuration</p></li>
				<li>After indenting the settings, we will change some of the settings to be read from environment variables. First, change <code>DEBUG</code> to be read as <code>BooleanValue</code>. It should default to <code>True</code>. Consider this line:<pre>    DEBUG = True</pre><p>And then change it to this:</p><pre>    DEBUG = values.BooleanValue(True)</pre><p>This will automatically read <code>DEBUG</code> from the <code>DJANGO_DEBUG</code> environment variable and convert it to a Boolean. If the environment variable is not set, then it will default to <code>True</code>.</p></li>
				<li>Also convert <code>ALLOWED_HOSTS</code> to be read from an environment variable, using the <code>values.ListValue</code> class. It should default to <code>[]</code> (empty list). Consider the following line:<pre>    ALLOWED_HOSTS = []</pre><p>And change it to this:</p><pre>    ALLOWED_HOSTS = values.ListValue([])</pre><p><code>ALLOWED_HOSTS</code> will be read from the <code>DJANGO_ALLOWED_HOSTS</code> environment variable, and default to an empty list. </p></li>
				<li>Everything you have done so far has been adding/changing attributes on the <code>Dev</code> class. Now, at the end of the same file, add a <code>Prod</code> class that inherits from <code>Dev</code>. It should define two attributes, <code>DEBUG = True</code> and <code>SECRET_KEY = values.SecretValue()</code>. The completed class should look like this:<pre>class Prod(Dev):
    DEBUG = False
    SECRET_KEY = values.SecretValue()</pre><p>Save <code>settings.py</code>.</p></li>
				<li>If we try to run any management command now, we will receive an error that <code>django-configurations</code> is not set up properly. We need to make some changes to <code>manage.py</code> to make it work again. Open <code>manage.py</code> in the <code>bookr</code> project directory.<p>Consider the line that reads as follows:</p><pre>os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'bookr.settings')</pre><p>Under it, add this line:</p><pre>os.environ.setdefault('DJANGO_CONFIGURATION', 'Dev')</pre><p>This will set the default configuration to the <code>Dev</code> class. It can be overridden by setting the <code>DJANGO_CONFIGURATION</code> environment variable (for example, to <code>Prod</code>). </p></li>
				<li>Two lines below the line from the previous step, you must already have the following <code>import</code> statement:<pre>from django.core.management import execute_from_command_line</pre><p>Change this to:</p><pre>from <code>manage.py</code> script use Django Configuration's <code>execute_from_command_line</code> function, instead of the Django built-in one.</p><p>Save <code>manage.py</code>.</p></li>
				<li>Start the Django dev server. If it begins without error, you can be confident that the changes you made have worked. To be sure, check that the pages load in your browser. Open <code>http://127.0.0.1:8000/</code> and try browsing around the site. Everything should look and feel as it did before:<div><img src="img/B15509_15_04.jpg" alt="Figure 15.4: The Bookr site should look and feel as it did before&#13;&#10;"/></div></li>
			</ol>
			<p class="figure-caption">Figure 15.4: The Bookr site should look and feel as it did before</p>
			<p>In this exercise, we installed <code>django-configurations</code> and refactored our <code>settings.py</code> file to use its <code>Configuration</code> class to define our settings. We added <code>Dev</code> and <code>Prod</code> configurations and made <code>DEBUG</code>, <code>ALLOWED_HOSTS</code>, and <code>SECRET_KEY</code> settable with environment variables. Finally, we updated <code>manage.py</code> to use Django Configuration's <code>execute_from_command_line</code> function, which enabled the use of this new settings.py format.</p>
			<p>In the next section, we will cover <code>dj-database-url</code>, a package that makes it possible to configure your Django database settings using URLs.</p>
			<h2 id="_idParaDest-425"><a id="_idTextAnchor447"/>dj-database-url</h2>
			<p><code>dj-database-url</code> is another app that helps with the configuration of your Django application. Specifically, it allows you to set the database (your Django app connects to) using a URL instead of a dictionary of configuration values. As you can see in your existing <code>settings.py</code> file, the <code>DATABASES</code> setting contains a couple of items and gets more verbose when using a different database that has more configuration options (for username, password, and so on). We can instead set these from a URL, which can contain all these values.</p>
			<p>The URL's format will differ slightly depending on whether you are using a local SQLite database or a remote database server. To use SQLite on disk (as Bookr is currently), the URL is like this:</p>
			<pre>sqlite:///&lt;path&gt;</pre>
			<p>Note there are three slashes present. This is because SQLite doesn't have a hostname, so this is like a URL being like this:</p>
			<pre>&lt;protocol&gt;://&lt;hostname&gt;/&lt;path&gt;</pre>
			<p>That is, the URL has a blank hostname. All three slashes are therefore together.</p>
			<p>To build a URL for a remote database server, the format is usually like this:</p>
			<pre>&lt;protocol&gt;://&lt;username&gt;:&lt;password&gt;@&lt;hostname&gt;:&lt;port&gt;/&lt;database_name&gt;</pre>
			<p>For example, to connect to a PostgreSQL database called <code>bookr_django</code> on the host, <code>db.example.com</code>, on port <code>5432</code>, with username <code>bookr</code> and password <code>b00ks</code>, the URL would be like this:</p>
			<pre>postgres://bookr:b00ks@db.example.com:5432/bookr_django</pre>
			<p>Now that we've seen the format for URLs, let's look at how we can actually use them in our <code>settings.py</code> file. First, <code>dj-database-url</code> must be installed using <code>pip3</code>:</p>
			<pre>pip3 install dj-database-url</pre>
			<p class="callout-heading">Note</p>
			<p class="callout">For Windows, you can use <code>pip</code> instead of <code>pip3</code> in the preceding command.</p>
			<p>The output is as follows:</p>
			<pre>Collecting dj-database-url
  Downloading https://files.pythonhosted.org/packages/d4/a6/4b8578c1848690d0c307c7c0596af2077536c9ef2a04d42b00fabaa7e49d/dj_database_url-0.5.0-py2.py3-none-any.whl
Installing collected packages: dj-database-url
Successfully installed dj-database-url-0.5.0</pre>
			<p>Now <code>dj_database_url</code> can be imported into <code>settings.py</code>, and the <code>dj_database_url.parse</code> method can be used to transform the URL into a dictionary that Django can use. We can use its return value to set the <code>default</code> (or other) item in the <code>DATABASES</code> dictionary:</p>
			<pre>import dj_database_url
DATABASES = {'default':dj_database_url.parse\
             ('postgres://bookr:b00ks@db.example.com:5432/\
               bookr_django')}</pre>
			<p>Or, for our SQLite database, we can utilize the <code>BASE_DIR</code> setting as we are already, and include it in the URL:</p>
			<pre>import dj_database_url
DATABASES = {'default': dj_database_url.parse\
             ('sqlite:///{}/db.sqlite3'.format(BASE_DIR))}</pre>
			<p>After parsing, the <code>DATABASES</code> dictionary is similar to what we had defined before. It includes some redundant items that do not apply to an SQLite database (<code>USER</code>, <code>PASSWORD</code>, <code>HOST</code>, and so on), but Django will ignore them:</p>
			<pre>DATABASES = {'default': \
             {'NAME': '/Users/ben/bookr/bookr/db.sqlite3',\
              'USER': '',\
              'PASSWORD': '',\
              'HOST': '',\
              'PORT': '',\
              'CONN_MAX_AGE': 0,\
              'ENGINE': 'django.db.backends.sqlite3'}}</pre>
			<p>This method of setting the database connection information is not that useful since we are still statically defining the data in <code>settings.py</code>. The only difference is we are using a URL instead of a dictionary. <code>dj-database-url</code> can also automatically read the URL from an environment variable. This will allow us to override these values by setting them in the environment.</p>
			<p>To read the data from the environment, use the dj_database_url.config function, like this:</p>
			<pre>import dj_database_url
DATABASES = {'default': dj_database_url.config()}</pre>
			<p>The URL is automatically read from the <code>DATABASE_URL</code> environment variable.</p>
			<p>We can improve on this by also providing a <code>default</code> argument to the <code>config</code> function. This is the URL that will be used by default if one is not specified in an environment variable:</p>
			<pre>import dj_database_url
DATABASES = {'default':dj_database_url.config\
             (default='sqlite:///{}/db.sqlite3'\
              .format(BASE_DIR))}</pre>
			<p>In this way, we can specify a default URL that can be overridden by an environment variable in production.</p>
			<p>We can also specify the environment variable that the URL is read from by passing in the <code>env</code> argument – this is the first positional argument. In this way, you could read multiple URLs for different database settings:</p>
			<pre>import dj_database_url
DATABASES = {'default':dj_database_url.config\
             (default='sqlite:///{}/db.sqlite3'\
                      .format(BASE_DIR)),\
             'secondary':dj_database_url.config\
                         ('DATABASE_URL_SECONDARY'\
                          default=\
                          'sqlite:///{}/db-secondary.sqlite3'\
                          .format(BASE_DIR)),}</pre>
			<p>In this example, the <code>default</code> item's URL is read from the <code>DATABASE_URL</code> environment variable, and <code>secondary</code> is read from <code>DATABASE_URL_SECONDARY</code>.</p>
			<p><code>django-configurations</code> also provides a config class that works in tandem with <code>dj_database_url: DatabaseURLValue</code>. This differs slightly from <code>dj_database_url.config</code> in that it generates the entire <code>DATABASES</code> dictionary including the <code>default</code> item. For example, consider the following code:</p>
			<pre>import dj_database_url
DATABASES = {'default': dj_database_url.config()}</pre>
			<p>This code is the equivalent to the following:</p>
			<pre>from configurations import values
DATABASES = values.DatabaseURLValue()</pre>
			<p>Do not write <code>DATABASES['default'] = values.DatabaseURLValue()</code> as your dictionary will be doubly nested.</p>
			<p>If you need to specify multiple databases, you will need to fall back to <code>dj_database_url.config</code> directly rather than using <code>DatabaseURLValue</code>.</p>
			<p>Like other <code>values</code> classes, <code>DatabaseURLValue</code> takes a default value as its first argument. You might also want to use the <code>environment_prefix</code> argument and set it to <code>DJANGO</code> so that its environment variable being read is consistent in naming to the others. A full example of using <code>DatabaseURLValue</code> would therefore be like this:</p>
			<pre>DATABASES = values.DatabaseURLValue\
            ('sqlite:///{}/db.sqlite3'.format(BASE_DIR),\
              environment_prefix='DJANGO')</pre>
			<p>By setting the <code>environment_prefix</code> like this, we can set the database URL using the <code>DJANGO_DATABASE_URL</code> environment variable (rather than just <code>DATABASE_URL</code>). This means it is consistent with other environment variable settings that also start with <code>DJANGO</code>_, such as <code>DJANGO_DEBUG</code> or <code>DJANGO_ALLOWED_HOSTS</code>.</p>
			<p>Note that even though we are not importing <code>dj-database-url</code> in <code>settings.py</code>, <code>django-configurations</code> uses it internally, so it still must be installed.</p>
			<p>In the next exercise, we will configure Bookr to use DatabaseURLValue to set its database configuration. It will be able to read from an environment variable and fall back to a default we specify.</p>
			<h2 id="_idParaDest-426"><a id="_idTextAnchor448"/>Exercise 15.02: dj-database-url and Setup</h2>
			<p>In this exercise, we will install <code>dj-database-url</code> using <code>pip3</code>. Then we will update Bookr's <code>settings.py</code> to configure the <code>DATABASE</code> setting using a URL, which is read from an environment variable:</p>
			<ol>
				<li value="1">In a terminal, make sure you have activated the <code>bookr</code> virtual environment, then run this command to install <code>dj-database-url</code> using <code>pip3</code>:<pre>pip3 install dj-database-url</pre><p>The install process will run, and you should have output similar to this:</p><div><img src="img/B15509_15_05.jpg" alt="Figure 15.5: dj-database-url installation with pip&#13;&#10;"/></div><p class="figure-caption">Figure 15.5: dj-database-url installation with pip</p></li>
				<li>In PyCharm, open <code>settings.py</code> in the <code>bookr</code> package directory. Scroll down to find where the <code>DATABASES</code> attribute is being defined. Replace it with the <code>values.DatabaseURLValue</code> class. The first argument (default value) should be the URL to the SQLite database: <code>'sqlite:///{}/db.sqlite3'.format(BASE_DIR)</code>. Also pass in <code>environ_prefix</code>, set to <code>DJANGO</code>. After completing this step, you should be setting the attribute like this:<pre>DATAB<a id="_idTextAnchor449"/>ASES = values.DatabaseURLValue\
            ('sqlite:///{}/db.sqlite3'.format(BASE_DIR),\
              environ_prefix='DJANGO')</pre><p>Save <code>settings.py</code>.</p></li>
				<li>Start the Django dev server. As with <em class="italic">Exercise 15.01</em>, <em class="italic">Django Configurations Setup</em>, if it starts fine, you can be confident that your change was successful. To be sure, open <code>http://127.0.0.1:8000/</code> in a browser and check that everything looks and behaves as it did before. You should visit a page that queries from the database (such as the <code>Books List</code> page) and check that a list of books is displayed:<div><img src="img/B15509_15_06.jpg" alt="Figure 15.6: Bookr pages with database queries still work&#13;&#10;"/></div></li>
			</ol>
			<p class="figure-caption">Figure 15.6: Bookr pages with database queries still work</p>
			<p>In this exercise, we updated our <code>settings.py</code> to determine its <code>DATABASES</code> setting from a URL specified in an environment variable. We used the <code>values.DatabaseURLValue</code> class to automatically read the value, and provided a default URL. We also set the <code>environ_prefix</code> argument to <code>DJANGO</code> so that the environment variable name is <code>DJANGO_DATABASE_URL</code>, which is consistent with other settings.</p>
			<p>In the next section, we will take a tour of the Django Debug Toolbar, an app that helps you debug your Django applications through the browser.</p>
			<h2 id="_idParaDest-427"><a id="_idTextAnchor450"/>The Django Debug Toolbar</h2>
			<p>The Django Debug Toolbar is an app that displays debug information about a web page right in your browser. It includes information about what SQL commands were run to generate the page, the request and response headers, how long the page took to render, and more. These can be useful if:</p>
			<ul>
				<li><em class="italic">A page is taking a long time to load – maybe it is running too many database queries.</em> You can see if the same queries are being run multiple times, in which case you could consider caching. Otherwise, some queries may be sped up by adding an index to the database.</li>
				<li><em class="italic">You want to determine why a page is returning the wrong information.</em> Your browser may have sent headers you did not expect, or maybe some headers from Django are incorrect.</li>
				<li><em class="italic">Your page is slow because it is spending time in non-database code</em> – you can profile the page to see what functions are taking the longest.</li>
				<li><em class="italic">The page looks incorrect.</em> You can see what templates Django rendered. There might be a third-party template that is being rendered unexpectedly. You can also check all the settings that are being used (including the built-in Django ones that we are not setting). This can help to pinpoint a setting that is incorrect and causing the page to not behave correctly.</li>
			</ul>
			<p>We'll explain how to use the Django Debug Toolbar to see this information. Before diving into how to set up the Django Debug Toolbar and how to use it, let's take a quick look at it. The toolbar is shown on the right of the browser window and can be toggled open and closed to display information:</p>
			<div><div><img src="img/B15509_15_07.jpg" alt="Figure 15.7: The Django Debug Toolbar closed&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.7: The Django Debug Toolbar closed</p>
			<p>The preceding figure shows the Django Debug Toolbar in its closed state. Notice the toggle bar in the top-right corner of the window. Clicking the toolbar opens it:</p>
			<div><div><img src="img/B15509_15_08.jpg" alt="Figure 15.8: The Django Debug Toolbar open&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.8: The Django Debug Toolbar open</p>
			<p><em class="italic">Figure 15.8</em> shows the Django Debug Toolbar open.</p>
			<p>Installing the Django Debug Toolbar is done using <code>pip</code>:</p>
			<pre>pip3 install django-debug-toolbar</pre>
			<p class="callout-heading">Note</p>
			<p class="callout">F<a id="_idTextAnchor451"/>or Windows, you can use <code>pip</code> instead of <code>pip3</code> in the preceding command.</p>
			<p>Then there are a few steps to set it up, mostly by making changes to <code>settings.py</code>:</p>
			<ol>
				<li value="1">Add <code>debug_to<a id="_idTextAnchor452"/>olbar</code> to the <code>INSTALLED_APPS</code> settings list.</li>
				<li>Add <code>debug_to<a id="_idTextAnchor453"/>olbar.middleware.DebugToolbarMiddleware</code> to the <code>MIDDLEWARE</code> settings list. It should be done as early as possible; for Bookr, it can be the first item in this list. This is the middleware that all requests and responses pass through.</li>
				<li>Add <code>'127.0.0<a id="_idTextAnchor454"/>.1'</code> to the <code>INTERNAL<a id="_idTextAnchor455"/>_IPS</code> settings list (this setting may have to be created). The Django Debug Toolbar will only show for IP addresses listed here.</li>
				<li>Add the Django Debug Toolbar URLs to the base <code>urls.py</code> file. We want to add this mapping only if we are in <code>DEBUG</code> mode:<pre>path('__<a id="_idTextAnchor456"/>debug__/', include(debug_toolbar.urls))</pre></li>
			</ol>
			<p>In the next exercise, we will go through these steps in detail. </p>
			<p>Once the Django Debug Toolbar is installed and set up, any page you visit will show the DjDT sidebar (you can open or close it using the DjDT menu). When it's open, you'll be able to see another set of sections that you can click on to get more information.</p>
			<p>Each panel has a checkbox next to it, this allows you to enable or disable the collection of that metric. Each metric that is collected will slightly slow down the page load (although, usually, this is not noticeable). If you find that one metric collection is slow, you can turn it off here:</p>
			<ol>
				<li value="1">We'll go through each panel. The first is <code>Versions</code>, which shows the version of Django running. You can click it to open a large <code>Versions</code> display, which will also show the version of Python and the Django Debug Toolbar (<em class="italic">Figure 15.9</em>):<div><img src="img/B15509_15_09.jpg" alt="Figure 15.9: DjDT Versions panel (screenshot cropped for brevity)&#13;&#10;"/></div><p class="figure-caption">Figure 15.9: DjDT Versions panel (screenshot cropped for brevity)</p></li>
				<li>The second panel is <code>Time</code>, which shows how long it took to process the request. It is broken down into system time and user time as well (<em class="italic">Figure 15.10</em>):<div><img src="img/B15509_15_10.jpg" alt="Figure 15.10: DjDT Time panel&#13;&#10;"/></div><p class="figure-caption">Figure 15.10: DjDT Time panel</p><p>The differences between these are beyond the scope of this book but, basically, system time is time spent in the kernel (for example, doing network or file reading/writing) and user time is code that is outside the operating system kernel (this includes the code you've written in Django, Python, and so on). </p><p>Also shown is time spent in the browser, such as the time taken to get the request and how long it took to render the page.</p></li>
				<li>The third panel, <code>Settings</code>, shows all the settings your application is using (<em class="italic">Figure 15.11</em>): <div><img src="img/B15509_15_11.jpg" alt="Figure 15.11: DjDT Settings panel&#13;&#10;"/></div><p class="figure-caption">Figure 15.11: DjDT Settings panel</p><p>This is useful because it shows both your settings from <code>settings.py</code> and the default Django settings.</p></li>
				<li>The fourth panel is <code>Headers</code> (<em class="italic">Figure 15.12</em>). It shows the headers of the request the browser made, and the response headers that Django has sent:<div><img src="img/B15509_15_12.jpg" alt="Figure 15.12: DjDT Headers panel&#13;&#10;"/></div><p class="figure-caption">Figure 15.12: DjDT Headers panel</p></li>
				<li>The fifth panel, <code>Request</code>, shows the view that generated the response, and the args and kwargs it was called with (<em class="italic">Figure 15.13</em>). You can also see the name of the URL used in its URL map:<div><img src="img/B15509_15_13.jpg" alt="Figure 15.13: DjDT Request panel (some panels not shown for brevity)&#13;&#10;"/></div><p class="figure-caption">Figure 15.13: DjDT Request panel (some panels not shown for brevity)</p><p>It also shows the request's cookies, information stored in the session (sessions were introduced in <em class="italic">Chapter 8</em>, <em class="italic">Media Serving and File Upload</em>) as well as the <code>request.GET</code> and <code>request.POST</code> data.</p></li>
				<li>The sixth panel, <code>SQL</code>, shows all the SQL database queries that were executing when building the response (Figure 15.14): <div><img src="img/B15509_15_14.jpg" alt="Figure 15.14: DjDT SQL panel&#13;&#10;"/></div><p class="figure-caption">Figure 15.14: DjDT SQL panel</p><p>You can see how long each query took to execute and in what order they were executed. It also flags similar and duplicate queries so you can potentially refactor your code to remove them.</p><p>Each <code>SELECT</code> query displays two action buttons, <code>Sel</code>, short for select, and <code>Expl</code>, short for explain. These do not show up for <code>INSERT</code>, <code>UDPATE</code>, or <code>DELETE</code> queries.</p><p>The <code>Sel</code> button shows the <code>SELECT</code> statement that was executed and all the data that was retrieved for the query (<em class="italic">Figure 15.15</em>):</p><div><img src="img/B15509_15_15.jpg" alt="Figure 15.15: DjDT SQL Select panel&#13;&#10;"/></div><p class="figure-caption">Figure 15.15: DjDT SQL Select panel</p><p>The <code>Expl</code> button shows the <code>EXPLAIN</code> query for the <code>SELECT</code> query (<em class="italic">Figure 15.16</em>):</p><div><img src="img/B15509_15_16.jpg" alt="Figure 15.16: DjDT SQL Explain panel (some panels not shown for brevity)&#13;&#10;"/></div><p class="figure-caption">Figure 15.16: DjDT SQL Explain panel (some panels not shown for brevity)</p><p><code>EXPLAIN</code> queries are beyond the scope of the book, but they basically show how the database tried to execute the <code>SELECT</code> query, for example, what database indexes were used. You might find that a query does not use an index and you can therefore get faster performance by adding one.</p></li>
				<li>The seventh panel is <code>Static files</code>, and it shows you which static files were loaded in this request (<em class="italic">Figure 15.17</em>). It also shows you all the static files that are available and how they would be loaded (that is, which static file finder found them). The <code>Static files</code> panel's information is like the information you can get from the <code>findstatic</code> management command:<div><img src="img/B15509_15_17.jpg" alt="Figure 15.17: DjDT Static panel&#13;&#10;"/></div><p class="figure-caption">Figure 15.17: DjDT Static panel</p></li>
				<li>The eighth panel, <code>Templates</code>, shows information about the templates that were rendered (<em class="italic">Figure 15.18</em>): <div><img src="img/B15509_15_18.jpg" alt="Figure 15.18: DjDT Templates panel&#13;&#10;"/></div><p class="figure-caption">Figure 15.18: DjDT Templates panel</p><p>It shows the paths the templates were loaded from and the inheritance chain.</p></li>
				<li>The ninth panel, <code>Cache</code>, shows information about data fetched from Django's cache:<div><img src="img/B15509_15_19.jpg" alt="Figure 15.19: DjDT Cache panel (some panels not shown for brevity)&#13;&#10;"/></div><p class="figure-caption">Figure 15.19: DjDT Cache panel (some panels not shown for brevity)</p><p>Since we aren't using caching in Bookr, this section is blank. If we were, we would be able to see how many requests to the cache had been made, and how many of those requests were successful in retrieving items. We would also see how many items had been added to the cache. This can give you an idea about whether you are using the cache effectively or not. If you are adding a lot of items to the cache but not retrieving any, then you should reconsider what data you are caching. On the contrary, if you have a lot of <code>Cache misses</code> (a miss is when you request data that is not in the cache), then you should be caching more data than you are already.</p></li>
				<li>The tenth panel is <code>Signals</code>, which shows information about Django signals (<em class="italic">Figure 15.20</em>): <div><img src="img/B15509_15_20.jpg" alt="Figure 15.20: DjDT Signals panel (some panels not shown for brevity)&#13;&#10;"/></div><p class="figure-caption">Figure 15.20: DjDT Signals panel (some panels not shown for brevity)</p><p>While we don't cover signals in this book, they are like events that you can hook into to execute functions when Django does something; for example, if a user is created, send them a welcome email. This section shows which signals were sent and which functions received them.</p></li>
				<li>The eleventh panel, <code>Logging</code>, shows log messages that were generated by your Django app (<em class="italic">Figure 15.21</em>): <div><img src="img/B15509_15_21.jpg" alt="Figure 15.21: DjDT Logging panel&#13;&#10;"/></div><p class="figure-caption">Figure 15.21: DjDT Logging panel</p><p>Since no log messages were generated in this request, this panel is empty.</p><p>The next option, <code>Intercept redirects</code>, is not a section with data. Instead, it lets you toggle redirect interception. If your view returns a redirect, it will not be followed. Instead, a page like <em class="italic">Figure 15.22</em> is displayed:</p><div><img src="img/B15509_15_22.jpg" alt="Figure 15.22: A redirect that DjDT has intercepted&#13;&#10;"/></div><p class="figure-caption">Figure 15.22: A redirect that DjDT has intercepted</p><p>This allows you to open the Django Debug Toolbar for the view that generated the redirect – otherwise, you'd only be able to see the information for the view that you were redirected to.</p></li>
				<li>The final panel is <code>Profiling</code>. This is off by default as profiling can slow down your response quite a lot. Once it is turned on, you must refresh the page to generate the profiling information (shown in <em class="italic">Figure 15.23</em>):<div><img src="img/B15509_15_23.jpg" alt="Figure 15.23: DjDT Profiling panel&#13;&#10;"/></div></li>
			</ol>
			<p class="figure-caption">Figure 15.23: DjDT Profiling panel</p>
			<p>The information shown here is a breakdown of how long each function call in your response took. The left of the page shows a stack trace of all the calls performed. On the right are columns with timing data. The columns are:</p>
			<ul>
				<li><strong class="bold">CumTime</strong>: The cumulative amount of time spent in the function and any sub-functions it calls</li>
				<li><code>Count</code>)</li>
				<li><strong class="bold">TotTime</strong>: The amount of time spent in this function but not in any sub-function it calls</li>
				<li><code>Count</code>)</li>
				<li><strong class="bold">Calls</strong>: The number of calls of this function</li>
			</ul>
			<p>This information can help you determine where to speed up your app. For example, it can be easier to speed up a function that is called 1,000 times by a small fraction, than to optimize a large function that is only called once. Any more in-depth tips on how to speed up your code are beyond the scope of this book.</p>
			<h2 id="_idParaDest-428"><a id="_idTextAnchor457"/>Exercise 15.03: Setting Up the Django Debug Toolbar</h2>
			<p>In this exercise, you will add the Django Debug Toolbar settings by modifying the <code>INSTALLED_APPS</code>, <code>MIDDLEWARE</code>, and <code>INTERNAL_IPS</code> settings. Then you'll add the <code>debug_toolbar.urls</code> map to the <code>bookr</code> package's <code>urls.py</code>. Then you will load a page with the Django Debug Toolbar in a browser and use it:</p>
			<ol>
				<li value="1">In a terminal, make sure you have activated the <code>bookr</code> virtual environment, then run this command to install the Django Debug Toolbar using <code>pip3</code>:<pre>pip3 install django-debug-toolbar
INSTALLED_APPS = […\
                  'debug_toolbar']</pre><p>This will allow Django to find the Django Debug Toolbar's static files.</p></li>
				<li>Add <code>debug_toolbar.middleware.DebugToolbarMiddleware</code> to the <code>MIDDLEWARE</code> setting – it should be the first item in the list:<pre>MIDDLEWARE = ['debug_toolbar.middleware.DebugToolbarMiddleware',\
              …]</pre><p>This will route requests and responses through <code>DebugToolbarMiddleware</code>, allowing the Django Debug Toolbar to inspect the request and insert its HTML into the response.</p></li>
				<li>The final setting to add is to add the address <code>127.0.0.1</code> to <code>INTERNAL_IPS</code>. You will not yet have an <code>INTERNAL_IPS</code> setting defined, so add this as a setting:<pre>INTERNAL_IPS = ['127.0.0.1']</pre><p>This will make the Django Debug Toolbar only show up on the developer's computer. You can now save <code>settings.py</code>.</p></li>
				<li>We now need to add the Django Debug Toolbar URLs. Open <code>urls.py</code> in the <code>bookr</code> package directory. We already have an <code>if</code> condition that checks for <code>DEBUG</code> mode then adds the media URL like so:<pre>if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL,\
                          document_root=settings.MEDIA_ROOT)</pre><p>We will also add an <code>include</code> of <code>debug_toolbar.urls</code> inside this <code>if</code> statement, however, we will add it to the start of <code>urlpatterns</code> rather than appending it to the end. Add this code inside the <code>if</code> statement:</p><pre>    import debug_toolbar
    urlpatterns = [path\
                   ('__debug__/',\
                    include(debug_toolbar.urls)),] + urlpatterns</pre><p>Save <code>urls.py</code>.</p></li>
				<li>Start the Django dev server if it is not already running and navigate to <code>http://127.0.0.1:8000</code>. You should see the Django Debug Toolbar open. If it is not open, click the <code>DjDT</code> toggle button at the top-right to open it:<div><img src="img/B15509_15_25.jpg" alt="Figure 15.25: DjDT toggle shown in the corner&#13;&#10;"/></div><p class="figure-caption">Figure 15.25: DjDT toggle shown in the corner</p></li>
				<li>Try going through some of the panels and visiting different pages to see what information you can find out. Try also turning on <code>Intercept redirects</code> and then create a new book review. After submitting the form, you should see the intercepted page rather than being redirected to the new review (<em class="italic">Figure 15.26</em>):<div><img src="img/B15509_15_26.jpg" alt="Figure 15.26: The redirect intercept page after submitting a new review&#13;&#10;"/></div><p class="figure-caption">Figure 15.26: The redirect intercept page after submitting a new review</p><p>You can then click the <code>Location</code> link to go to the page that it was being redirected to.</p></li>
				<li>You can also try turning on <code>Profiling</code> and see which functions are being called a lot and which are taking up most of the rendering time.</li>
				<li>Once you are finished experimenting with the Django Debug Toolbar, turn off <code>Intercept redirects</code> and <code>Profiling</code>.</li>
			</ol>
			<p>In this exercise, we installed and set up the Django Debug Toolbar by adding settings and URL maps. We then saw it in action and examined the useful information it can give us, including how to work with redirects and see profiling information.</p>
			<p>In the next section, we will look at the <code>django-crispy-forms</code> app, which will let us reduce the amount of code needed to write forms.</p>
			<h1 id="_idParaDest-429"><a id="_idTextAnchor458"/>django-crispy-forms</h1>
			<p>In Bookr, we are using the Bootstrap CSS framework. It provides styles that can be applied to forms using CSS classes. Since Django is independent of Bootstrap, when we use Django forms, it does not even know that we are using Bootstrap and so has no idea of what classes to apply to form widgets.</p>
			<p><code>django-crispy-forms</code> acts as an intermediary between Django Forms and Bootstrap forms. It can take a Django form and render it with the correct Bootstrap elements and classes. It not only supports Bootstrap but also other frameworks such as <code>crispy-forms-foundation</code>).</p>
			<p>Its installation and setup are quite simple. Once again, it is installed with <code>pip3</code>:</p>
			<pre>pip3 install django-crispy-forms </pre>
			<p class="callout-heading">Note</p>
			<p class="callout">For Windows, you ca<a id="_idTextAnchor459"/>n use <code>pip</code> instead of <code>pip3</code> in the preceding command.</p>
			<p>Then there are just a couple of settings changes. First, add <code>crispy_forms</code> to your <code>INSTALLED_APPS</code>. Then, you need to tell <code>django-crispy-forms</code>  what framework you are using, so it loads the correct templates. This is done with the <code>CRISPY_TEMPLATE_PACK</code> setting. In our case, it should be set to <code>bootstrap4</code>:</p>
			<pre>CRISPY_TEMPLATE_PACK = 'bootstrap4'</pre>
			<p><code>django-crispy-forms</code> has two main modes of operation, either as a filter or a template tag. The former is easier to drop into an existing template. The latter allows more configuration options and moves more of the HTML generation into the <code>Form</code> class. We'll look at both of these in order.</p>
			<h2 id="_idParaDest-430"><a id="_idTextAnchor460"/>The crispy Filter</h2>
			<p>The first method of rendering a form with <code>django-crispy-forms</code>  is by using the <code>crispy</code> template. First, the filter must be loaded in the template. The library name is <code>crispy_forms_tags</code>:</p>
			<pre>{% load crispy_forms_tags %}</pre>
			<p>Then, instead of rendering a form with the <code>as_p</code> method (or another method), use the <code>crispy</code> filter. Consider the following line:</p>
			<pre>{{ form.as_p }}</pre>
			<p>And replace it with this:</p>
			<pre>{{ form|crispy }}</pre>
			<p>Here's a quick <em class="italic">before and after</em> showing the <code>Review Create</code> form. None of the rest of the HTML has been changed apart from the form rendering. <em class="italic">Figure 15.27</em> shows the standard Django form:</p>
			<div><div><img src="img/B15509_15_27.jpg" alt="Figure 15.27: The Review Create form with default styling&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.27: The Review Create form with default styling</p>
			<p><em class="italic">Figure 15.28</em> shows the form after <code>django-crispy-forms</code> has added the Bootstrap classes:</p>
			<div><div><img src="img/B15509_15_28.jpg" alt="Figure 15.28: Review Create form with Bootstrap classes added by django-crispy-forms&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.28: Review Create form with Bootstrap classes added by django-crispy-forms</p>
			<p>When we integrate <code>django-crispy-forms</code> into Bookr, we will not use this method, however, it is worth knowing about because of how easy it is to drop it into your existing templates.</p>
			<h2 id="_idParaDest-431"><a id="_idTextAnchor461"/>The crispy Template Tag</h2>
			<p>The other method of rendering a form with <code>django-crispy-forms</code> is with the use of the <code>crispy</code> template tag. To use it, the <code>crispy_forms_tags</code> library must first be loaded into the template (as we did in the previous section). Then, the form is rendered like this:</p>
			<pre>{% crispy form %}</pre>
			<p>How does this differ from the <code>crispy</code> filter? The <code>crispy</code> template tag will also render the <code>&lt;form&gt;</code> element and <code>{% csrf_token %}</code> template tag for you. So, consider for example that you used it like this:</p>
			<pre>&lt;form method="post"&gt;
  {% csrf_token %}
  {% crispy form %}
&lt;/form&gt;</pre>
			<p>The output for this would be as follows:</p>
			<pre>&lt;form method="post" &gt;
&lt;input type="hidden" name="csrfmiddlewaretoken" value="…"&gt;
&lt;form method="post"&gt;
&lt;input type="hidden" name="csrfmiddlewaretoken" value="…"&gt;
    … form fields …
&lt;/form&gt;
&lt;/form&gt;</pre>
			<p>That is, the form and CSRF token fields are duplicated. In order to customize the <code>&lt;form&gt;</code> element that is generated, <code>django-crispy-forms</code> provides a <code>FormHelper</code> class that can be set as a <code>Form</code> instance's <code>helper</code> attribute. It is the <code>FormHelper</code> instance that the <code>crispy</code> template tag uses to determine what attributes the <code>&lt;form&gt;</code> should have.</p>
			<p>Let us look at an <code>ExampleForm</code> with a helper added. First, import the required modules:</p>
			<pre>from django import forms
from crispy_forms.helper import FormHelper</pre>
			<p>Next, define a form:</p>
			<pre>class ExampleForm(forms.Form):
example_field = forms.CharField()</pre>
			<p>We could instantiate a <code>FormHelper</code> instance and then set it to the <code>form.helper</code> attribute (for example, in a view), but it's usually more useful to just create and assign it inside the form's <code>__init__</code> method. We haven't created a form with an <code>__init__</code> method yet, but it's no different from any other Python class:</p>
			<pre>    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)</pre>
			<p>Next, we set the helper and the form_method for the helper (which is then rendered in the form HTML):</p>
			<pre>self.helper = FormHelper()
self.helper.form_method = 'post'</pre>
			<p>Other attributes can be set on the helper, such as <code>form_action</code>, <code>form_id</code>, and <code>form_class</code>. We don't need to use these in Bookr though. We also do not need to manually set the <code>enctype</code> on the form or its helper, as the <code>crispy</code> form tag will automatically set this to <code>multipart/form-data</code> if the form contains file upload fields.</p>
			<p>If we tried to render the form now, we wouldn't be able to submit it as there's no submit button (remember we added submit buttons to our forms manually, they are not part of the Django form). <code>django-crispy-forms</code> also includes layout helpers that can be added to the form. They will be rendered after the other fields. We can add a submit button like this – first, import the <code>Submit</code> class:</p>
			<pre>from crispy_forms.layout import Submit</pre>
			<p class="callout-heading">Note</p>
			<p class="callout"><code>django-crispy-forms</code> does not properly support using a <code>&lt;button&gt;</code> input to submit a form, but for our purposes, an <code>&lt;input type="submit"&gt;</code> is functionally identical.</p>
			<p>We then instantiate it and add it to the helper's inputs in a single line:</p>
			<pre>self.helper.add_input(Submit("submit", "Submit"))</pre>
			<p>The first argument to the <code>Submit</code> constructor is its <em class="italic">name</em>, and the second is its <em class="italic">label</em>.</p>
			<p><code>django-crispy-forms</code>  is aware that we are using Bootstrap and will automatically render the button with the <code>btn btn-primary</code> classes.</p>
			<p>The advantage of using a crispy template tag and <code>FormHelper</code> is that it means there is only one place where attributes and the behavior of the form are defined. We are already defining all the form fields in a <code>Form</code> class; this allows us to define the other attributes of the form in the same place. We could change a form from a <code>GET</code> submission to a <code>POST</code> submission easily here. The <code>FormHelper</code> instance will then automatically know that it needs to add a CSRF token to its HTML output when rendered. </p>
			<p>We'll put all this into practice in the next exercise, where you will install <code>django-crispy-forms</code> and then update <code>SearchForm</code> to utilize a form helper, then render it using the <code>crispy</code> template tag.</p>
			<h2 id="_idParaDest-432">Exercise 15.04: Using Django Crispy Forms wi<a id="_idTextAnchor462"/>th the SearchForm</h2>
			<p>In this exercise, you will install <code>django-crispy-forms</code>, then convert the <code>SearchForm</code> to be usable with the <code>crispy</code> template tag. This will be done by adding an <code>__init__</code> method and building a <code>FormHelper</code> instance inside it:</p>
			<ol>
				<li value="1">In a terminal, make sure you have activated the <code>bookr</code> virtual environment, then run this command to install <code>django-crispy-forms</code>  using <code>pip3</code>:<pre>pip3 install django-crispy-forms
INSTALLED_APPS = […\
                  'reviews',\
                  'debug_toolbar',\
                  <strong class="bold">'crispy_forms'</strong>\]</pre><p>This will allow Django to find the required templates.</p></li>
				<li>While in <code>settings.py</code>, add a new setting for <code>CRISPY_TEMPLATE_PACK</code> – its value should be <code>bootstrap4</code>. This should be added as an attribute on the <code>Dev</code> class:<pre>CRISPY_TEMPLATE_PACK = 'bootstrap4'</pre><p>This lets <code>django-crispy-forms</code> know that it should be using the templates designed for Bootstrap version 4 when rendering forms. You can now save and close <code>settings.py</code>.</p></li>
				<li>Open the <code>reviews</code> app's <code>forms.py</code> file. First, we need to add two imports to the top of the file: <code>FormHelper</code> from <code>crispy_forms.helper</code>, and <code>Submit</code> from <code>crispy_forms.layout</code>:<pre>from crispy_forms.helper import FormHelper
from crispy_forms.layout import Submit</pre></li>
				<li>Next, add an <code>__init__</code> method to <code>SearchForm</code>. It should accept <code>*args</code> and <code>**kwargs</code> as arguments, then call the super <code>__init__</code> method with them:<pre>class SearchForm(forms.Form):
…
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)</pre><p>This will simply pass through whatever arguments are provided to the superclass constructor.</p></li>
				<li>Still inside the <code>__init__</code> method, set <code>self.helper</code> to an instance of <code>FormHelper</code>. Then set the helper's <code>form_method</code> to <code>get</code>. Finally, create an instance of <code>Submit</code>, passing in an empty string as the name (first argument), and <code>Search</code> as the button label (second argument). Add this to the helper with the <code>add_input</code> method:<pre>self.helper = FormHelper()
self.helper.form_method = "get"
self.helper.add_input(Submit("", "Search"))</pre><p>You can save and close <code>forms.py</code>.</p></li>
				<li>In the <code>reviews</code> app's <code>templates</code> directory, open <code>search-results.html</code>. At the start of the file, after the <code>extends</code> template tag, use a <code>load</code> template tag to load <code>crispy_forms_tags</code>:<pre>{% load crispy_forms_tags %}</pre></li>
				<li>Locate the existing <code>&lt;form&gt;</code> in the template. It should look like this:<pre>&lt;form&gt;
    {{ form.as_p }}
&lt;button type="submit" class="btn btn-primary"&gt;Search&lt;/button&gt;
&lt;/form&gt;</pre><p>You can delete the entered <code>&lt;form&gt;</code> element and replace it with a <code>crispy</code> template tag:</p><pre>{% crispy form %}</pre><p>This will use the <code>django-crispy-forms</code> library to render the form, including the <code>&lt;form&gt;</code> element and submit button. After making this change, this portion of the template should look like <em class="italic">Figure 15.30</em>:</p><div><img src="img/B15509_15_30.jpg" alt="Figure 15.30: search-results.html after replacing &lt;form&gt; with crispy form renderer&#13;&#10;"/></div><p class="figure-caption">Figure 15.30: search-results.html after replacing &lt;form&gt; with crispy form renderer</p><p>You can now save <code>search-results.html</code>.</p></li>
				<li>Start the Django dev server if it is not already running and go to <code>http://127.0.0.1:8000/book-search/</code>. You should see the book search form like in <em class="italic">Figure 15.31</em>:<div><img src="img/B15509_15_31.jpg" alt="Figure 15.31: Book search form rendered with django-crispy-forms&#13;&#10;"/></div></li>
			</ol>
			<p class="figure-caption">Figure 15.31: Book search form rendered with django-crispy-forms</p>
			<p>You should be able to use the form in the same manner as you did before (<em class="italic">Figure 15.32</em>):</p>
			<div><div><img src="img/B15509_15_32.jpg" alt="Figure 15.32: Performing a search with the updated search form&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.32: Performing a search with the updated search form</p>
			<p>Try viewing the source of the page in your web browser to see the rendered output. You will see that the <code>&lt;form&gt;</code> element has been rendered with the <code>method="get"</code> attribute, as we specified to the <code>FormHelper</code> in <em class="italic">step 5</em>. Notice also that <code>django-crispy-forms</code> has not inserted a CSRF token field – it knows that one is not required for a form submitted using <code>GET</code>.</p>
			<p>In this exercise, we installed <code>django-crispy-forms</code> using <code>pip3</code> (<code>pip</code> for Windows) and then configured it in <code>settings.py</code> by adding it to <code>INSTALLED_APPS</code> and defining the <code>CRISPY_TEMPLATE_PACK</code> we wanted to use (in our case, <code>bootstrap4</code>). We then updated the <code>SearchForm</code> class to use a <code>FormHelper</code> instance to control the attributes on the form and added a submit button using the <code>Submit</code> class. Finally, we changed the <code>search-results.html</code> template to use the <code>crispy</code> template tag to render the form, which allowed us to remove the <code>&lt;form&gt;</code> element we were using before and simplify form generation by moving all the form-related code into Python code (instead of being partially in HTML and partially in Python).</p>
			<h2 id="_idParaDest-433"><a id="_idTextAnchor463"/>django-allauth</h2>
			<p>When browsing websites, you have probably seen buttons that allow you to log in using another website's credentials. For example, using your GitHub login:</p>
			<div><div><img src="img/B15509_15_33.jpg" alt="Figure 15.33: Sign In form with options to log in with Google or GitHub&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.33: Sign In form with options to log in with Google or GitHub</p>
			<p>Before we explain the process, let us introduce the terminology we will be using:</p>
			<ul>
				<li><strong class="bold">Requesting site</strong>: The site the user is trying to log in to.</li>
				<li><strong class="bold">Authentication provider</strong>: The third-party provider that the user is authenticating to (for example, Google, GitHub, and so on).</li>
				<li><strong class="bold">Authentication application</strong>: This is something the creators of the requesting site set up at the authentication provider. It determines what permissions the requesting site will have with the authentication provider. For example, the requesting application can get access to your GitHub username, but won't have permission to write to your repositories. The user can stop the requesting site from accessing your information at the authentication provider by disabling access to the authentication application.</li>
			</ul>
			<p>The process is generally the same regardless of which third-party sign-in option you choose. First, you will be redirected to the authentication provider site and be asked to allow the authentication application to access your account (<em class="italic">Figure 15.34</em>):</p>
			<div><div><img src="img/B15509_15_34.jpg" alt="Figure 15.34: Authentication provider authorization screen&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.34: Authentication provider authorization screen</p>
			<p>After you authorize the authentication application, the authentication provider will redirect back to the requesting site. The URL that you are redirected to will contain a secret token that the requesting site can use to request your user information in the backend. This allows the requesting site to verify who you are by communicating directly with the authentication provider. After validating your identity using a token, the requesting site can redirect you to your content. This flow is illustrated in a sequence diagram in <em class="italic">Figure 15.35</em>:</p>
			<div><div><img src="img/B15509_15_35.jpg" alt="Figure 15.35: Third-party authentication flow&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.35: Third-party authentication flow</p>
			<p>Now that we have introduced authenticating using a third-party service, we can discuss <code>django-allauth</code>. <code>django-allauth</code> is an app that easily plugs your Django application into a third-party authentication service, including Google, GitHub, Facebook, Twitter, and others. In fact, at the time of writing, <code>django-allauth</code> supports over 75 authentication providers.</p>
			<p>The first time a user authenticates to your site, <code>django-allauth</code> will create a standard Django <code>User</code> instance for you. It also knows how to parse the callback/redirect URL that the authentication provider loads after the end user authorizes the authentication application.</p>
			<p><code>django-allauth</code> adds three models to your application:</p>
			<ul>
				<li><code>SocialApplication</code>: This stores the information used to identify your authentication application. The information you enter will depend on the provider, who will give you a <em class="italic">client</em> ID, <em class="italic">secret</em> key, and (optionally) a <em class="italic">key</em>. Note that these are the names that <code>django-allauth</code> uses for these values and they will differ based on the provider. We will give some examples of these values later in this section. <code>SocialApplication</code> is the only one of the <code>django-allauth</code> models that you will create yourself, the others <code>django-allauth</code> creates automatically when a user authenticates.</li>
				<li><code>SocialApplicationToken</code>: This contains the values needed to identify a Django user to the authentication provider. It contains a <em class="italic">token</em> and (optionally) a <em class="italic">token secret</em>. It also contains a reference to the <code>SocialApplication</code> that created it and the <code>SocialAccount</code> to which it applies.</li>
				<li><code>SocialAccount</code>: This links a Django user to the provider (for example, Google or GitHub) and stores extra information that the provider may have given.</li>
			</ul>
			<p>Since there are so many authentication providers, we will not cover how to set them all up, but we will give a short instruction on setup and how to map the auth tokens from the providers to the right fields in a <code>SocialApplication</code>. We will do this for the two auth providers we have been mentioning throughout the chapter: Google and GitHub.</p>
			<h3 id="_idParaDest-434"><a id="_idTextAnchor464"/>django-allauth Installation and Setup</h3>
			<p>Like the other apps in this chapter, <code>django-allauth</code> is installed with <code>pip3</code>:</p>
			<pre>pip3 install django-allauth</pre>
			<p class="callout-heading">Note</p>
			<p class="callout">For Windows, you can use <code>pip</code> instead of <code>pip3</code> in the preceding command.</p>
			<p>We then need a few settings changes. <code>django-allauth</code> requires the <code>django.contrib.sites</code> app to run, so it needs to be added to <code>INSTALLED_APPS</code>. Then a new setting needs to be added to define a <code>SITE_ID</code> for our site. We can just set this to <code>1</code> in our <code>settings.py</code> file:</p>
			<pre>INSTALLED_APPS = [# this entry added
                  'django.contrib.sites',\
                  'django.contrib.admin',\
                  'django.contrib.auth',\
                  # the rest of the values are truncated]
SITE_ID = 1</pre>
			<p class="callout-heading">Note</p>
			<p class="callout">It is possible to have a single Django project hosted on multiple hostnames and have it behave differently on each – but also have content shared across all the sites. We don't need to use the <code>SITE_ID</code> anywhere else in our project but one must be set here. You can read more about the <code>SITE_ID</code> settings at <a href="https://docs.djangoproject.com/en/3.0/ref/contrib/sites/">https://docs.djangoproject.com/en/3.0/ref/contrib/sites/</a>.</p>
			<p>We also need to add <code>allauth</code> and <code>allauth.socialaccount</code> to <code>INSTALLED_APPS</code>:</p>
			<pre>INSTALLED_APPS = [# the rest of the values are truncated
                  'allauth',\
                  'allauth.socialaccount',]</pre>
			<p>Then, each provider we want to support must also be added in the list of <code>INSTALLED_APPS</code>; for example, consider the following snippet:</p>
			<pre>INSTALLED_APPS = [# the rest of the values are truncated
                  'allauth.socialaccount.providers.github',\
                  'allauth.socialaccount.providers.google',]</pre>
			<p>After all this is done, we need to run the <code>migrate</code> management command, to create the <code>django-allauth</code> models:</p>
			<pre>python3 manage.py migrate</pre>
			<p>Once this is done, new social applications can be added through the Django Admin interface (<em class="italic">Figure 15.36</em>): </p>
			<div><div><img src="img/B15509_15_36.jpg" alt="Figure 15.36: Adding a social application&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.36: Adding a social application</p>
			<p>To add a social application, select a <code>Provider</code> (this list will only show those in the <code>INSTALLED_APPS</code> list), enter a name (it can just be the same as the <code>Provider</code>), and enter the <code>Client ID</code> from the provider's website (we will go into detail on this soon). You may also need a <code>Secret key</code> and <code>Key</code>. Select the site it should apply to. (If you only have one <code>Site</code> instance, then its name does not matter, just select it. The site name can be updated in the <code>Sites</code> section of Django admin. You can also add more sites there.)</p>
			<p>We will now look at the tokens used by our three example providers.</p>
			<h3 id="_idParaDest-435"><a id="_idTextAnchor465"/>GitHub Auth Setup</h3>
			<p>A new GitHub application can be set up under your GitHub profile. During development, your callback URL for the application should be set to <code>http://127.0.0.1:8000/accounts/github/login/callback/</code> and updated with the real hostname when you deploy to production. After creating the app, it will provide a <code>Client ID</code> and <code>Client Secret</code>. These are your <code>Client id</code> and <code>Secret key</code>, respectively, in <code>django-allauth</code>. </p>
			<h3 id="_idParaDest-436"><a id="_idTextAnchor466"/>Google Auth Setup</h3>
			<p>The creation of a Google application is done through your Google Developers console. The authorized redirect URI should be set to <code>http://127.0.0.1:8000/accounts/google/login/callback/</code> during development and updated after production deployment. The app's <code>Client ID</code> is also Client id in <code>django-allauth</code>, and the app's <code>Client secret</code> is the <code>Secret key</code>.</p>
			<h2 id="_idParaDest-437"><a id="_idTextAnchor467"/>Initiating Authentication with django-allauth</h2>
			<p>To initiate authentication through a third-party provider, you first need to add the <code>django-allauth</code> URLs in your URL maps. Somewhere inside your <code>urlpatterns</code> is one of your <code>urls.py</code> files, include <code>allauth.urls</code>:</p>
			<pre>urlpatterns = [path('allauth', include('allauth.urls')),]</pre>
			<p>You will then be able to initiate a login using URLs like <code>http://127.0.0.1:8000/allauth/github/login/?process=login</code> or <code>http://127.0.0.1:8000/allauth/google/login/?process=login</code>, and so on. django-allauth will handle all the redirects for you, then create/authenticate the Django user when they return to the site. You can have buttons on your login page with text such as Login with GitHub or Login with Google that link to these URLs.</p>
			<h3 id="_idParaDest-438"><a id="_idTextAnchor468"/>Other django-allauth Features</h3>
			<p>Other than authentication with third-party providers, <code>django-allauth</code> can also add some useful features that Django does not have built in. For example, you can configure it to require an email address for a user, and have the user verify their email address by clicking a confirmation link they receive before they log in, <code>django-allauth</code> can also handle generating a URL for a password reset that is emailed to the user. You can find the documentation for <code>django-allauth</code> that explains these features, and more, at <a href="https://django-allauth.readthedocs.io/en/stable/overview.html">https://django-allauth.readthedocs.io/en/stable/overview.html</a>.</p>
			<p>Now that we have covered the first four third-party apps in depth and given a brief overview of <code>django-allauth</code>, you can undertake the activity for this chapter. In this activity, you will refactor the <code>ModelForm</code> instances we are using to use the <code>CrispyFormHelper</code> class.</p>
			<h2 id="_idParaDest-439">Activity 15.01: Using FormHelper to <a id="_idTextAnchor469"/>Update Forms</h2>
			<p>In this activity, we will update the <code>ModelForm</code> instances (<code>PublisherForm</code>, <code>ReviewForm</code>, and <code>BookMediaForm</code>) to use the <code>CrispyFormHelper</code> class. Using <code>FormHelper</code>, we can define the text of the <code>Submit</code> button inside the <code>Form</code> class itself. We can then move the <code>&lt;form&gt;</code> rendering logic out of the <code>instance-form.html</code> template and replace it with a <code>crispy</code> template tag.</p>
			<p>These steps will help you complete the activity:</p>
			<ol>
				<li value="1">Create an <code>InstanceForm</code> class that subclasses <code>forms.ModelForm</code>. This will be the base of the existing <code>ModelForm</code> classes.</li>
				<li>In the <code>__init__</code> method of <code>InstanceForm</code>, set a <code>FormHelper</code> instance on <code>self</code>.</li>
				<li>Add a <code>Submit</code> button to <code>FormHelper</code>. If the form is instantiated with an <code>instance</code>, then the button text should be <code>Save</code>, otherwise, it should be <code>Create</code>.</li>
				<li>Update PublisherForm, ReviewForm, and BookMediaForm to extend from <code>InstanceForm</code>.</li>
				<li>Update the <code>instance-form.html</code> template so that <code>form</code> is rendered using the <code>crispy</code> template tag. The rest of the <code>&lt;form&gt;</code> can be removed.</li>
				<li>In the <code>book_media</code> view, the <code>is_file_upload</code> context item is no longer required.</li>
			</ol>
			<p>When you are finished, you should see the forms rendered with Bootstrap themes. <em class="italic">Figure 15.37</em> shows the <code>New Publisher</code> page:</p>
			<div><div><img src="img/B15509_15_37.jpg" alt="Figure 15.37: New Publisher page&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.37: New Publisher page</p>
			<p><em class="italic">Figure 15.38</em> shows the <code>New Review</code> page:</p>
			<div><div><img src="img/B15509_15_38.jpg" alt="Figure 15.38: New Review form&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.38: New Review form</p>
			<p>Finally, the book media page is displayed in <em class="italic">Figure 15.39</em>:</p>
			<div><div><img src="img/B15509_15_39.jpg" alt="Figure 15.39: Book media page&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.39: Book media page</p>
			<p>You should notice the form still behaves fine and allows file uploads. <code>django-crispy-forms</code>  has automatically added the <code>enctype="multipart/form-data"</code> attribute to <code>&lt;form&gt;</code>. You can verify this by viewing the page source.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">The solution to this activity can be found at <a href="http://packt.live/2Nh1NTJ">http://packt.live/2Nh1NTJ</a>.</p>
			<h1 id="_idParaDest-440"><a id="_idTextAnchor470"/>Summary</h1>
			<p>In this chapter, we introduced five third-party Django apps that can enhance your website. We installed and set up <code>django-configurations</code>, which allowed us to easily switch between different settings and change them using environment variables. <code>dj-database-url</code> also helped with settings, allowing us to make database settings changes using URLs. We saw how the Django Debug Toolbar could help us see what our app was doing and help us debug problems we were having with it. <code>django-crispy-forms</code> can not only render our forms using the Bootstrap CSS but also lets us save code by defining their behavior as part of the form class itself. We briefly looked at <code>django-allauth</code> and saw how it can be integrated into third-party authentication providers. In the activity for this chapter, we updated our <code>ModelForm</code> instances to use the <code>django-crispy-forms</code> <code>FormHelper</code> and remove some logic from the template by using the <code>crispy</code> template tag.</p>
			<p>In the next chapter, we will look at how to integrate the React JavaScript framework into a Django application.</p>
		</div>
		<div><div></div>
		</div>
	</body></html>