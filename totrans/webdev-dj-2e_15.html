<html><head></head><body>
		<div>
			<div id="_idContainer403" class="Content">
			</div>
		</div>
		<div id="_idContainer404" class="Content">
			<h1 id="_idParaDest-418"><a id="_idTextAnchor435"/>15. Django Third-Party Libraries</h1>
		</div>
		<div id="_idContainer444" class="Content">
			<p class="callout-heading">Overview</p>
			<p class="callout">This chapter introduces you to Django third-party libraries. You will configure your database connection using URLs with <strong class="source-inline">dj-database-urls</strong> and inspect and debug your application with the <strong class="bold">Django Debug Toolbar</strong>. Using <strong class="source-inline">django-crispy-forms</strong>, you will enhance the look of your forms, as well as reduce the amount of code you have to write by using the <strong class="source-inline">crispy</strong> template tag. We will also cover the <strong class="source-inline">django-allauth</strong> library, which lets you authenticate users against third-party providers. In the final activity, we will enhance Bookr's forms with the use of <strong class="source-inline">django-crispy-forms</strong>.</p>
			<h1 id="_idParaDest-419"><a id="_idTextAnchor436"/>Introduction</h1>
			<p>Because Django has been around since 2007, there is a rich ecosystem of third-party libraries that can be plugged into an application to give it extra features. So far, we have learned a lot about Django and used many of its features, including database models, URL routing, templating, forms, and more. We used these Django tools directly to build a web app, but now we will look at how to leverage the work of others to quickly add even more advanced features to our own apps. We have alluded to apps for storing files, (in <em class="italic">Chapter 5</em>, <em class="italic">Serving Static Files</em>, we mentioned an app, <strong class="source-inline">django-storages</strong>, that can store our static files in a CDN), but in addition to file storage, we can also use them to plug into third-party authentication systems, integrate with payment gateways, customize how our settings are built, modify images, build forms more easily, debug our site, use different types of databases, and much more. Chances are, if you want to add a certain feature, an app exists for it.</p>
			<p>We don't have space to cover every app in this chapter, so we'll just focus on four that provide useful features across many different types of apps. <strong class="source-inline">django-configurations</strong> allows you to configure your Django settings using classes and take advantage of inheritance to simplify settings for different environments. This works in tandem with <strong class="source-inline">dj-database-urls</strong> to specify your database connection setting using just a URL. The <em class="italic">Django Debug Toolbar</em> lets you get extra information to help with debugging, right in your browser. The last app we'll look at is <strong class="source-inline">django-crispy-forms</strong>, which provides extra CSS classes to make forms look nicer, as well as making them easier to configure using just Python code.</p>
			<p>For each of these libraries, we will cover installation and basic setup and use, mostly as they apply to Bookr. They also have more configuration options to further customize to fit your application. Each of these apps can be installed with <strong class="source-inline">pip</strong>.</p>
			<p>We will also briefly introduce <strong class="source-inline">django-allauth</strong>, which allows a Django application to authenticate users against third-party providers (such as Google, GitHub, Facebook, and Twitter). We won't cover its installation and setup in detail but will provide some examples to help you configure it. </p>
			<h2 id="_idParaDest-420"><a id="_idTextAnchor437"/>Environment Variables</h2>
			<p>When we create a program, we often want the user to be able to configure some of its behavior. For example, say you have a program that connects to a database and saves all the records it finds into a file. Normally it would probably print out just a <em class="italic">success</em> message to the terminal, but you might also want to run it in <em class="italic">debug mode</em>, which makes it also print out all the SQL statements it is executing.</p>
			<p>There are many ways of configuring a program like this. For example, you could have it read from a configuration file. But in some cases, the user may quickly want to run the Django server with a particular setting on (say, debug mode), and then run the server again with the same setting off. Having to change the configuration file each time can be inconvenient. In this case, we can read from an <em class="italic">environment variable</em>. Environment variables are key/value pairs that can be set in your operating system and then read by a program. There are several ways they can be set:</p>
			<ul>
				<li>Your shell (terminal) can read variables from a profile script when it starts, then each program will have access to these variables.</li>
				<li>You can set a variable inside a terminal and it will be made available to any programs that start subsequently. In Linux and macOS, this is done with the <strong class="source-inline">export</strong> command; Windows uses the <strong class="source-inline">set</strong> command. Any variables you set in this way override those in the profile script, but only for the current session. When you close the terminal, the variables are lost.</li>
				<li>You can set environment variables at the same time as running a command in a terminal. These will only persist for the program being run, and they override exported environment variables and those read from a profile script.</li>
				<li>You can set environment variables inside a running program, and they will be available only inside the program (or to programs your program starts). Environment variables set in this way will override all the other methods we have just set.</li>
			</ul>
			<p>These might sound complicated, but we will explain them with a short Python script and show how variables can be set in the last three ways (the first method depends on what shell you use). The script will also show how environment variables are read.</p>
			<p>Environment variables are available in Python using the <strong class="source-inline">os.environ</strong> variable. This is a dictionary-like object that can be used to access environment variables by name. It is safest to access values using the <strong class="source-inline">get</strong> method just in case they are not set. It also provides a <strong class="source-inline">setdefault</strong> method, which allows setting a value only if it is not set (that is, it doesn't overwrite an existing key).</p>
			<p>Here is the example Python script that reads environment variables:</p>
			<p class="source-code">import os</p>
			<p class="source-code"># This will set the value since it's not already set</p>
			<p class="source-code">os.environ.setdefault('UNSET_VAR', 'UNSET_VAR_VALUE')</p>
			<p class="source-code"># This value will not be set since it's already passed</p>
			<p class="source-code"># in from the command line</p>
			<p class="source-code">os.environ.setdefault('SET_VAR', 'SET_VAR_VALUE')</p>
			<p class="source-code">print('UNSET_VAR:' + os.environ.get('UNSET_VAR', ''))</p>
			<p class="source-code">print('SET_VAR:' + os.environ.get('SET_VAR', ''))</p>
			<p class="source-code"># All these values were provided from the shell in some way</p>
			<p class="source-code">print('HOME:' + os.environ.get('HOME', ''))</p>
			<p class="source-code">print('VAR1:' + os.environ.get('VAR1', ''))</p>
			<p class="source-code">print('VAR2:' + os.environ.get('VAR2', ''))</p>
			<p class="source-code">print('VAR3:' + os.environ.get('VAR3', ''))</p>
			<p class="source-code">print('VAR4:' + os.environ.get('VAR4', ''))</p>
			<p>We then set up our shell by setting some variables. In Linux or macOS, we use <strong class="source-inline">export</strong> (note there is no output from these commands):</p>
			<p class="source-code">$ export SET_VAR="Set Using Export"</p>
			<p class="source-code">$ export VAR1="Set Using Export"</p>
			<p class="source-code">$ export VAR2="Set Using Export"</p>
			<p>In Windows, we would use the <strong class="source-inline">set</strong> command in the command line as follows:</p>
			<p class="source-code">set SET_VAR="Set Using Export"</p>
			<p class="source-code">set VAR1="Set Using Export"</p>
			<p class="source-code">set VAR2="Set Using Export"</p>
			<p>In Linux and macOS, we can also provide environment variables by setting them before the command (the actual command is just <strong class="source-inline">python3 env_example.py</strong>):</p>
			<p class="source-code">$ VAR2="Set From Command Line" VAR3="Also Set From Command Line" python3 env_example.py </p>
			<p class="callout-heading">Note</p>
			<p class="callout">Note that the above command will not work on Windows. For Windows, the environment variables must be set before execution and cannot be passed in at the same time.</p>
			<p>The output from this command is:</p>
			<p class="source-code">UNSET_VAR:UNSET_VAR_VALUE</p>
			<p class="source-code">SET_VAR:Set Using Export</p>
			<p class="source-code">HOME:/Users/ben</p>
			<p class="source-code">VAR1:Set Using Export</p>
			<p class="source-code">VAR2:Set From Command Line</p>
			<p class="source-code">VAR3:Also Set From Command Line</p>
			<p class="source-code">VAR4:</p>
			<ul>
				<li>When the script runs <strong class="source-inline">os.environ.setdefault('UNSET_VAR', 'UNSET_VAR_VALUE')</strong>, the value is set inside the script, since no value for <strong class="source-inline">UNSET_VAR</strong> was set by the shell. The value that is output is the one set by the script itself.</li>
				<li>When <strong class="source-inline">os.environ.setdefault('SET_VAR', 'SET_VAR_VALUE')</strong> is executed, the value is not set since one was provided by the shell. This was set with the <strong class="source-inline">export SET_VAR="Set Using Export"</strong> command.</li>
				<li>The value for <strong class="source-inline">HOME</strong> was not set by any of the commands that were run – this is one provided by the shell. It is the user's home directory. This is just an example of an environment variable that a shell normally provides.</li>
				<li><strong class="source-inline">VAR1</strong> was set by <strong class="source-inline">export</strong> and was not overridden when executing the script.</li>
				<li><strong class="source-inline">VAR2</strong> was set by <strong class="source-inline">export</strong> but was subsequently overridden when executing the script.</li>
				<li><strong class="source-inline">VAR3</strong> was only set when executing the script.</li>
				<li><strong class="source-inline">VAR4</strong> was never set – we use the <strong class="source-inline">get</strong> method to access it to avoid a <strong class="source-inline">KeyError</strong>.</li>
			</ul>
			<p>Now that environment variables have been covered, we can return to discussing the changes that need to be made to <strong class="source-inline">manage.py</strong> to support <strong class="source-inline">django-configurations</strong>.</p>
			<h2 id="_idParaDest-421"><a id="_idTextAnchor438"/>django-configurations</h2>
			<p>One of the main considerations when deploying a Django application to production is how to configure it. As you have seen throughout this book, the <strong class="source-inline">settings.py</strong> file is where all your Django configuration is defined. Even third-party apps have their configuration in this file. You have already seen this in <em class="italic">Chapter 12</em>, <em class="italic">Building a REST API</em>, when working with the Django REST framework.</p>
			<p>There are many ways to provide different configurations and switch between them in Django. If you have begun working on an existing application that already has a specific method of switching between configurations in development and production environments, then you should probably keep using that method.</p>
			<p>When we release Bookr onto a product web server, in <em class="italic">Chapter 17</em>, <em class="italic">Deployment of a Django Application (Part 1 – Server Setup)</em>, we will need to switch to a production configuration, and that's when we will use <strong class="source-inline">django-configurations</strong>.</p>
			<p>To install <strong class="source-inline">django-configurations</strong>, use <strong class="source-inline">pip3</strong> as follows:</p>
			<p class="source-code"><strong class="bold">pip3</strong> install django-configurations</p>
			<p class="callout-heading">Note</p>
			<p class="callout">For Windows, you can use <strong class="source-inline">pip</strong> instead of <strong class="source-inline">pip3</strong> in the preceding command.</p>
			<p>The output will be as follows:</p>
			<p class="source-code">Collecting django-configurations</p>
			<p class="source-code">  Using cached https://files.pythonhosted.org/packages/96/ef/bddcce16f3cd36f03c9874d8ce1e5d35f3cedea27b7d8455265e79a77c3d/django_configurations-2.2-py2.py3-none-any.whl</p>
			<p class="source-code">Requirement already satisfied: six in /Users/ben/.virtualenvs/bookr/lib/python3.6/site-packages (from django-configurations) (1.14.0)</p>
			<p class="source-code">Installing collected packages: django-configurations</p>
			<p class="source-code">Successfully installed django-configurations-2.2</p>
			<p><strong class="source-inline">django-configurations</strong> changes your <strong class="source-inline">settings.py</strong> file so that all the settings are read from a class you define, which will be a subclass of <strong class="source-inline">configurations.Configuration</strong>. Instead of the settings being global variables inside <strong class="source-inline">settings.py</strong>, they will be attributes on the class you define. By using this class-based method, we can take advantage of object-oriented paradigms, most notably inheritance. Settings, defined in a class, can inherit settings in another class. For example, the production settings class can inherit the development settings class and just override some specific settings – such as forcing <strong class="source-inline">DEBUG</strong> to <strong class="source-inline">False</strong> in production.</p>
			<p>We can illustrate what needs to be done to the settings file by just showing the first few settings in the file. A standard Django <strong class="source-inline">settings.py</strong> file normally starts like this (comment lines have been removed):</p>
			<p class="source-code">import os</p>
			<p class="source-code">BASE_DIR =os.path.dirname\</p>
			<p class="source-code">          (os.path.dirname(os.path.abspath(__file__)))</p>
			<p class="source-code">SECRET_KEY =\</p>
			<p class="source-code">'y%ux@_^+#eahu3!^i2w71qtgidwpvs^o=w2*$=xy+2-y4r_!fw'</p>
			<p class="source-code">DEBUG = True</p>
			<p class="source-code">…</p>
			<p class="source-code"># The rest of the settings are not shown</p>
			<p>To convert the settings to <strong class="source-inline">django-configurations</strong>, first import <strong class="source-inline">Configuration</strong> from <strong class="source-inline">configurations</strong>. Then define a <strong class="source-inline">Configuration</strong> subclass. Finally, indent all the settings to be under the class. In PyCharm, this is as simple as selecting all the settings and pressing <em class="italic">Tab</em> to indent them all.</p>
			<p>After doing this, your <strong class="source-inline">settings.py</strong> file will look like this:</p>
			<p class="source-code">import os</p>
			<p class="source-code"><a id="_idTextAnchor439"/></p>
			<p class="source-code">from configurations import Configuration</p>
			<p class="source-code">class Dev(Configuration):</p>
			<p class="source-code">    BASE_DIR = os.path.dirname\</p>
			<p class="source-code">               (os.path.dirname(os.path.abspath(__file__)))</p>
			<p class="source-code">    SECRET_KEY = \</p>
			<p class="source-code">    'y%ux@_^+#eahu3!^i2w71qtgidwpvs^o=w2*$=xy+2-y4r_!fw'</p>
			<p class="source-code">    DEBUG = True</p>
			<p class="source-code">    …</p>
			<p class="source-code">    # All other settings indented in the same manner</p>
			<p>To have different configurations (different sets of settings), you can just extend your configuration classes and override the settings that should differ.</p>
			<p>For example, one variable that needs overriding in production is <strong class="source-inline">DEBUG</strong>: it should be <strong class="source-inline">False</strong> (for security and performance reasons). A <strong class="source-inline">Prod</strong> class can be defined that extends <strong class="source-inline">Dev</strong> and sets <strong class="source-inline">DEBUG</strong>, like this:</p>
			<p class="source-code">class Dev(Configuration):</p>
			<p class="source-code">    DEBUG = True</p>
			<p class="source-code">    …</p>
			<p class="source-code">    # Other settings truncated</p>
			<p class="source-code"><a id="_idTextAnchor440"/></p>
			<p class="source-code">class Prod(Dev):</p>
			<p class="source-code">    DEBUG = False</p>
			<p class="source-code">    # no other settings defined since we're only overriding DEBUG</p>
			<p>Of course, you can override other production settings too, not just <strong class="source-inline">DEBUG</strong>. Usually, for security, you would also redefine <strong class="source-inline">SECRET_KEY</strong> and <strong class="source-inline">ALLOWED_HOSTS</strong>; and to configure Django to use your production database, you'd set the <strong class="source-inline">DATABASES</strong> value too. Any Django setting can be configured as you choose.</p>
			<p>If you try to execute runserver (or other management commands) now, you will get an error because Django doesn't know how to find the <strong class="source-inline">settings.py</strong> file when the settings files are laid out like this:</p>
			<p class="source-code">django.core.exceptions.ImproperlyConfigured: django-configurations settings importer wasn't correctly installed. Please use one of the starter functions to install it as mentioned in the docs: https://django-configurations.readthedocs.io/</p>
			<p>We need to make some changes to the <strong class="source-inline">manage.py</strong> file before it starts to work again. But before we make them, we'll briefly discuss environment variables, in case you haven't used them before.</p>
			<h2 id="_idParaDest-422"><a id="_idTextAnchor441"/>manage.py changes</h2>
			<p>There are two lines that need to be added/changed in <strong class="source-inline">manage.py</strong> to enable <strong class="source-inline">django-configurations</strong>. First, we need to define a default environment variable that tells Django Configuration which <strong class="source-inline">Configuration</strong> class it should load.</p>
			<p>This line should be added in the <strong class="source-inline">main()</strong> function to set the default value for the <strong class="source-inline">DJANGO_CONFIGURATION</strong> environment variable:</p>
			<p class="source-code"><a id="_idTextAnchor442"/>os.environ.setdefault('DJANGO_CONFIGURATION', 'Dev')</p>
			<p>This sets the default to <strong class="source-inline">Dev</strong> – the name of the class we defined. As we saw in our example script, if this value is already defined, it won't be overwritten. This will allow us to switch between configurations using an environment variable.</p>
			<p>The second change is to swap the <strong class="source-inline">execute_from_command_line</strong> function with one that <strong class="source-inline">django-configurations</strong> provides. Consider the following line:</p>
			<p class="source-code">from django.core.management import execute_from_command_line</p>
			<p>This line is changed as follows:</p>
			<p class="source-code"><a id="_idTextAnchor443"/>from configurations.management import execute_from_command_line</p>
			<p>From now on, <strong class="source-inline">manage.py</strong> will work as it did before, except it now prints out which <strong class="source-inline">Configuration</strong> class it's using when it starts (<em class="italic">Figure 15.1</em>):</p>
			<div>
				<div id="_idContainer405" class="IMG---Figure">
					<img src="image/B15509_15_01.jpg" alt="Figure 15.1: django-configurations is using the configuration Dev&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.1: django-configurations is using the configuration Dev</p>
			<p>In the second line, you can see <strong class="source-inline">django-configurations</strong> output that is using the <strong class="source-inline">Dev</strong> class for settings.</p>
			<h2 id="_idParaDest-423"><a id="_idTextAnchor444"/>Configuration from Environment Variables</h2>
			<p>As well as switching between <strong class="source-inline">Configuration</strong> classes using environment variables, <strong class="source-inline">django-configurations</strong> allows us to give values for individual settings using environment variables. It provides <strong class="source-inline">Value</strong> classes that will automatically read values from the environment. We can define defaults if no values are provided. Since environment variables are always strings, the different <strong class="source-inline">Value</strong> classes are used to convert from a string to the specified type.</p>
			<p>Let's look at this in practice with a few examples. We will allow <strong class="source-inline">DEBUG</strong>, <strong class="source-inline">ALLOWED_HOSTS</strong>,  <strong class="source-inline">TIME_ZONE</strong>, and <strong class="source-inline">SECRET_KEY</strong> to be set with environment variables as follows:</p>
			<p class="source-code">from configurations import Configuration, values</p>
			<p class="source-code">class Dev(Configuration):</p>
			<p class="source-code">    DEBUG = values.BooleanValue(True)</p>
			<p class="source-code">    ALLOWED_HOSTS = values.ListValue([])</p>
			<p class="source-code">    TIME_ZONE = values.Value('UTC')</p>
			<p class="source-code">    SECRET_KEY =\</p>
			<p class="source-code">    'y%ux@_^+#eahu3!^i2w71qtgidwpvs^o=w2*$=xy+2-y4r_!fw'</p>
			<p class="source-code">    …</p>
			<p class="source-code">    # Other settings truncated</p>
			<p class="source-code">class Prod(Dev):</p>
			<p class="source-code">    DEBUG = False</p>
			<p class="source-code">    SECRET_KEY = values.SecretValue()</p>
			<p class="source-code">    # no other settings are present</p>
			<p>We'll explain the settings one at a time:</p>
			<ul>
				<li>In <strong class="source-inline">Dev</strong>, <strong class="source-inline">DEBUG</strong> is read from an environment variable and cast to a Boolean value. The values <strong class="source-inline">yes</strong>, <strong class="source-inline">y</strong>, <strong class="source-inline">true</strong>, and <strong class="source-inline">1</strong> become <strong class="source-inline">True</strong>; the values <strong class="source-inline">no</strong>, <strong class="source-inline">n</strong>, <strong class="source-inline">false</strong>, and <strong class="source-inline">0</strong> become <strong class="source-inline">False</strong>. This allows us to run with <strong class="source-inline">DEBUG</strong> off even on a development machine, which can be useful in some cases (for example, testing a custom exception page rather than Django's default one). In the <strong class="source-inline">Prod</strong> configuration, we don't want <strong class="source-inline">DEBUG</strong> to accidentally become <strong class="source-inline">True</strong>, so we set it statically.</li>
				<li><strong class="source-inline">ALLOWED_HOSTS</strong> is required in production. It is a list of hosts for which Django should accept requests.</li>
				<li>The <strong class="source-inline">ListValue</strong> class will convert a comma-separated string into a Python list. </li>
				<li>For example, the string <strong class="source-inline">www.example.com,example.com</strong> is converted to <strong class="source-inline">["www.example.com", "example.com"]</strong></li>
				<li><strong class="source-inline">TIME_ZONE</strong> accepts just a string value, so it is set using the <strong class="source-inline">Value</strong> class. This class just reads the environment variable and does not transform it at all.</li>
				<li><strong class="source-inline">SECRET_KEY</strong> is statically defined in the <strong class="source-inline">Dev</strong> configuration; it can't be changed with an environment variable. In the <strong class="source-inline">Prod</strong> configuration, it is set with <strong class="source-inline">SecretValue</strong>. This is like <strong class="source-inline">Value</strong> in that it is just a string setting; however, it does not allow a default. If a default is set, then an exception is raised. This is to ensure you don't ever put a secret value into <strong class="source-inline">settings.py</strong>, since it might be accidentally shared (for example, uploaded to GitHub). Note that since we do not use <strong class="source-inline">SECRET_KEY</strong> for <strong class="source-inline">Dev</strong> in production, we don't care if it's leaked.</li>
			</ul>
			<p>By default, <strong class="source-inline">django-configurations</strong> expects the <strong class="source-inline">DJANGO_</strong> prefix for each environment variable. For example, to set <strong class="source-inline">DEBUG</strong>, use the <strong class="source-inline">DJANGO_DEBUG</strong> environment variable; to set <strong class="source-inline">ALLOWED_HOSTS</strong>, use <strong class="source-inline">DJANGO_ALLOWED_HOSTS</strong>, and so on.</p>
			<p>Now that we've introduced <strong class="source-inline">django-configurations</strong> and the changes that need to be made to the project to support it, let's add it to Bookr and make those changes. In the next exercise, you will install and set up <strong class="source-inline">django-configurations</strong> in Bookr.</p>
			<h2 id="_idParaDest-424"><a id="_idTextAnchor445"/>Exercise 15.01: Django Configurations Setup</h2>
			<p>In this exercise, you will install <strong class="source-inline">django-configurations</strong> using <strong class="source-inline">pip</strong>, then update <strong class="source-inline">settings.py</strong> to add a <strong class="source-inline">Dev</strong> and <strong class="source-inline">Prod</strong> configuration. You'll then make the necessary changes to <strong class="source-inline">manage.py</strong> to support the new configuration style, and test that everything is still working:</p>
			<ol>
				<li>In a terminal, make sure you have activated the <strong class="source-inline">bookr</strong> virtual environment, then run this command to install <strong class="source-inline">django-configurations</strong> using <strong class="source-inline">pip3</strong>:<p class="source-code">pip3 install django-configurations</p><p class="callout-heading">Note</p><p class="callout">For Windows, you can use <strong class="source-inline">pip</strong> instead of <strong class="source-inline">pip3</strong> in the preceding command.</p><p>The install process will run, and you should have output like <em class="italic">Figure 15.2</em>:</p><div id="_idContainer406" class="IMG---Figure"><img src="image/B15509_15_02.jpg" alt="Figure 15.2: django-configurations installation with pip&#13;&#10;"/></div><p class="figure-caption">Figure 15.2: django-configurations installation with pip</p></li>
				<li>In PyCharm, open <strong class="source-inline">settings.py</strong> inside the <strong class="source-inline">bookr</strong> package. Underneath the existing <strong class="source-inline">os</strong> import, import <strong class="source-inline">Configuration</strong> and <strong class="source-inline">values</strong> from <strong class="source-inline">configurations</strong>, like this:<p class="source-code">fr<a id="_idTextAnchor446"/>om configurations import Configuration, values</p></li>
				<li>After the imports but before your first setting definition (the line that sets the <strong class="source-inline">BASE_DIR</strong> value), add a new <strong class="source-inline">Configuration</strong> subclass, called <strong class="source-inline">Dev</strong>:<p class="source-code">class Dev(Configuration):</p></li>
				<li>Now we need to move all the existing settings, so they are attributes of the <strong class="source-inline">Dev</strong> class rather than global variables. In PyCharm, this is as simple as selecting all the settings, and then pressing the <em class="italic">Tab</em> key to indent them. After doing this, your settings should look as follows:<div id="_idContainer407" class="IMG---Figure"><img src="image/B15509_15_03.jpg" alt="Figure 15.3: New Dev configuration&#13;&#10;"/></div><p class="figure-caption">Figure 15.3: New Dev configuration</p></li>
				<li>After indenting the settings, we will change some of the settings to be read from environment variables. First, change <strong class="source-inline">DEBUG</strong> to be read as <strong class="source-inline">BooleanValue</strong>. It should default to <strong class="source-inline">True</strong>. Consider this line:<p class="source-code">    DEBUG = True</p><p>And then change it to this:</p><p class="source-code">    DEBUG = values.BooleanValue(True)</p><p>This will automatically read <strong class="source-inline">DEBUG</strong> from the <strong class="source-inline">DJANGO_DEBUG</strong> environment variable and convert it to a Boolean. If the environment variable is not set, then it will default to <strong class="source-inline">True</strong>.</p></li>
				<li>Also convert <strong class="source-inline">ALLOWED_HOSTS</strong> to be read from an environment variable, using the <strong class="source-inline">values.ListValue</strong> class. It should default to <strong class="source-inline">[]</strong> (empty list). Consider the following line:<p class="source-code">    ALLOWED_HOSTS = []</p><p>And change it to this:</p><p class="source-code">    ALLOWED_HOSTS = values.ListValue([])</p><p><strong class="source-inline">ALLOWED_HOSTS</strong> will be read from the <strong class="source-inline">DJANGO_ALLOWED_HOSTS</strong> environment variable, and default to an empty list. </p></li>
				<li>Everything you have done so far has been adding/changing attributes on the <strong class="source-inline">Dev</strong> class. Now, at the end of the same file, add a <strong class="source-inline">Prod</strong> class that inherits from <strong class="source-inline">Dev</strong>. It should define two attributes, <strong class="source-inline">DEBUG = True</strong> and <strong class="source-inline">SECRET_KEY = values.SecretValue()</strong>. The completed class should look like this:<p class="source-code">class Prod(Dev):</p><p class="source-code">    DEBUG = False</p><p class="source-code">    SECRET_KEY = values.SecretValue()</p><p>Save <strong class="source-inline">settings.py</strong>.</p></li>
				<li>If we try to run any management command now, we will receive an error that <strong class="source-inline">django-configurations</strong> is not set up properly. We need to make some changes to <strong class="source-inline">manage.py</strong> to make it work again. Open <strong class="source-inline">manage.py</strong> in the <strong class="source-inline">bookr</strong> project directory.<p>Consider the line that reads as follows:</p><p class="source-code">os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'bookr.settings')</p><p>Under it, add this line:</p><p class="source-code">os.environ.setdefault('DJANGO_CONFIGURATION', 'Dev')</p><p>This will set the default configuration to the <strong class="source-inline">Dev</strong> class. It can be overridden by setting the <strong class="source-inline">DJANGO_CONFIGURATION</strong> environment variable (for example, to <strong class="source-inline">Prod</strong>). </p></li>
				<li>Two lines below the line from the previous step, you must already have the following <strong class="source-inline">import</strong> statement:<p class="source-code">from django.core.management import execute_from_command_line</p><p>Change this to:</p><p class="source-code">from <strong class="bold">configurations</strong>.management import execute_from_command_line</p><p>This will make the <strong class="source-inline">manage.py</strong> script use Django Configuration's <strong class="source-inline">execute_from_command_line</strong> function, instead of the Django built-in one.</p><p>Save <strong class="source-inline">manage.py</strong>.</p></li>
				<li>Start the Django dev server. If it begins without error, you can be confident that the changes you made have worked. To be sure, check that the pages load in your browser. Open <strong class="source-inline">http://127.0.0.1:8000/</strong> and try browsing around the site. Everything should look and feel as it did before:<div id="_idContainer408" class="IMG---Figure"><img src="image/B15509_15_04.jpg" alt="Figure 15.4: The Bookr site should look and feel as it did before&#13;&#10;"/></div></li>
			</ol>
			<p class="figure-caption">Figure 15.4: The Bookr site should look and feel as it did before</p>
			<p>In this exercise, we installed <strong class="source-inline">django-configurations</strong> and refactored our <strong class="source-inline">settings.py</strong> file to use its <strong class="source-inline">Configuration</strong> class to define our settings. We added <strong class="source-inline">Dev</strong> and <strong class="source-inline">Prod</strong> configurations and made <strong class="source-inline">DEBUG</strong>, <strong class="source-inline">ALLOWED_HOSTS</strong>, and <strong class="source-inline">SECRET_KEY</strong> settable with environment variables. Finally, we updated <strong class="source-inline">manage.py</strong> to use Django Configuration's <strong class="source-inline">execute_from_command_line</strong> function, which enabled the use of this new settings.py format.</p>
			<p>In the next section, we will cover <strong class="source-inline">dj-database-url</strong>, a package that makes it possible to configure your Django database settings using URLs.</p>
			<h2 id="_idParaDest-425"><a id="_idTextAnchor447"/>dj-database-url</h2>
			<p><strong class="source-inline">dj-database-url</strong> is another app that helps with the configuration of your Django application. Specifically, it allows you to set the database (your Django app connects to) using a URL instead of a dictionary of configuration values. As you can see in your existing <strong class="source-inline">settings.py</strong> file, the <strong class="source-inline">DATABASES</strong> setting contains a couple of items and gets more verbose when using a different database that has more configuration options (for username, password, and so on). We can instead set these from a URL, which can contain all these values.</p>
			<p>The URL's format will differ slightly depending on whether you are using a local SQLite database or a remote database server. To use SQLite on disk (as Bookr is currently), the URL is like this:</p>
			<p class="source-code">sqlite:///&lt;path&gt;</p>
			<p>Note there are three slashes present. This is because SQLite doesn't have a hostname, so this is like a URL being like this:</p>
			<p class="source-code">&lt;protocol&gt;://&lt;hostname&gt;/&lt;path&gt;</p>
			<p>That is, the URL has a blank hostname. All three slashes are therefore together.</p>
			<p>To build a URL for a remote database server, the format is usually like this:</p>
			<p class="source-code">&lt;protocol&gt;://&lt;username&gt;:&lt;password&gt;@&lt;hostname&gt;:&lt;port&gt;/&lt;database_name&gt;</p>
			<p>For example, to connect to a PostgreSQL database called <strong class="source-inline">bookr_django</strong> on the host, <strong class="source-inline">db.example.com</strong>, on port <strong class="source-inline">5432</strong>, with username <strong class="source-inline">bookr</strong> and password <strong class="source-inline">b00ks</strong>, the URL would be like this:</p>
			<p class="source-code">postgres://bookr:b00ks@db.example.com:5432/bookr_django</p>
			<p>Now that we've seen the format for URLs, let's look at how we can actually use them in our <strong class="source-inline">settings.py</strong> file. First, <strong class="source-inline">dj-database-url</strong> must be installed using <strong class="source-inline">pip3</strong>:</p>
			<p class="source-code">pip3 install dj-database-url</p>
			<p class="callout-heading">Note</p>
			<p class="callout">For Windows, you can use <strong class="source-inline">pip</strong> instead of <strong class="source-inline">pip3</strong> in the preceding command.</p>
			<p>The output is as follows:</p>
			<p class="source-code">Collecting dj-database-url</p>
			<p class="source-code">  Downloading https://files.pythonhosted.org/packages/d4/a6/4b8578c1848690d0c307c7c0596af2077536c9ef2a04d42b00fabaa7e49d/dj_database_url-0.5.0-py2.py3-none-any.whl</p>
			<p class="source-code">Installing collected packages: dj-database-url</p>
			<p class="source-code">Successfully installed dj-database-url-0.5.0</p>
			<p>Now <strong class="source-inline">dj_database_url</strong> can be imported into <strong class="source-inline">settings.py</strong>, and the <strong class="source-inline">dj_database_url.parse</strong> method can be used to transform the URL into a dictionary that Django can use. We can use its return value to set the <strong class="source-inline">default</strong> (or other) item in the <strong class="source-inline">DATABASES</strong> dictionary:</p>
			<p class="source-code">import dj_database_url</p>
			<p class="source-code">DATABASES = {'default':dj_database_url.parse\</p>
			<p class="source-code">             ('postgres://bookr:b00ks@db.example.com:5432/\</p>
			<p class="source-code">               bookr_django')}</p>
			<p>Or, for our SQLite database, we can utilize the <strong class="source-inline">BASE_DIR</strong> setting as we are already, and include it in the URL:</p>
			<p class="source-code">import dj_database_url</p>
			<p class="source-code">DATABASES = {'default': dj_database_url.parse\</p>
			<p class="source-code">             ('sqlite:///{}/db.sqlite3'.format(BASE_DIR))}</p>
			<p>After parsing, the <strong class="source-inline">DATABASES</strong> dictionary is similar to what we had defined before. It includes some redundant items that do not apply to an SQLite database (<strong class="source-inline">USER</strong>, <strong class="source-inline">PASSWORD</strong>, <strong class="source-inline">HOST</strong>, and so on), but Django will ignore them:</p>
			<p class="source-code">DATABASES = {'default': \</p>
			<p class="source-code">             {'NAME': '/Users/ben/bookr/bookr/db.sqlite3',\</p>
			<p class="source-code">              'USER': '',\</p>
			<p class="source-code">              'PASSWORD': '',\</p>
			<p class="source-code">              'HOST': '',\</p>
			<p class="source-code">              'PORT': '',\</p>
			<p class="source-code">              'CONN_MAX_AGE': 0,\</p>
			<p class="source-code">              'ENGINE': 'django.db.backends.sqlite3'}}</p>
			<p>This method of setting the database connection information is not that useful since we are still statically defining the data in <strong class="source-inline">settings.py</strong>. The only difference is we are using a URL instead of a dictionary. <strong class="source-inline">dj-database-url</strong> can also automatically read the URL from an environment variable. This will allow us to override these values by setting them in the environment.</p>
			<p>To read the data from the environment, use the dj_database_url.config function, like this:</p>
			<p class="source-code">import dj_database_url</p>
			<p class="source-code">DATABASES = {'default': dj_database_url.config()}</p>
			<p>The URL is automatically read from the <strong class="source-inline">DATABASE_URL</strong> environment variable.</p>
			<p>We can improve on this by also providing a <strong class="source-inline">default</strong> argument to the <strong class="source-inline">config</strong> function. This is the URL that will be used by default if one is not specified in an environment variable:</p>
			<p class="source-code">import dj_database_url</p>
			<p class="source-code">DATABASES = {'default':dj_database_url.config\</p>
			<p class="source-code">             (default='sqlite:///{}/db.sqlite3'\</p>
			<p class="source-code">              .format(BASE_DIR))}</p>
			<p>In this way, we can specify a default URL that can be overridden by an environment variable in production.</p>
			<p>We can also specify the environment variable that the URL is read from by passing in the <strong class="source-inline">env</strong> argument – this is the first positional argument. In this way, you could read multiple URLs for different database settings:</p>
			<p class="source-code">import dj_database_url</p>
			<p class="source-code">DATABASES = {'default':dj_database_url.config\</p>
			<p class="source-code">             (default='sqlite:///{}/db.sqlite3'\</p>
			<p class="source-code">                      .format(BASE_DIR)),\</p>
			<p class="source-code">             'secondary':dj_database_url.config\</p>
			<p class="source-code">                         ('DATABASE_URL_SECONDARY'\</p>
			<p class="source-code">                          default=\</p>
			<p class="source-code">                          'sqlite:///{}/db-secondary.sqlite3'\</p>
			<p class="source-code">                          .format(BASE_DIR)),}</p>
			<p>In this example, the <strong class="source-inline">default</strong> item's URL is read from the <strong class="source-inline">DATABASE_URL</strong> environment variable, and <strong class="source-inline">secondary</strong> is read from <strong class="source-inline">DATABASE_URL_SECONDARY</strong>.</p>
			<p><strong class="source-inline">django-configurations</strong> also provides a config class that works in tandem with <strong class="source-inline">dj_database_url: DatabaseURLValue</strong>. This differs slightly from <strong class="source-inline">dj_database_url.config</strong> in that it generates the entire <strong class="source-inline">DATABASES</strong> dictionary including the <strong class="source-inline">default</strong> item. For example, consider the following code:</p>
			<p class="source-code">import dj_database_url</p>
			<p class="source-code">DATABASES = {'default': dj_database_url.config()}</p>
			<p>This code is the equivalent to the following:</p>
			<p class="source-code">from configurations import values</p>
			<p class="source-code">DATABASES = values.DatabaseURLValue()</p>
			<p>Do not write <strong class="source-inline">DATABASES['default'] = values.DatabaseURLValue()</strong> as your dictionary will be doubly nested.</p>
			<p>If you need to specify multiple databases, you will need to fall back to <strong class="source-inline">dj_database_url.config</strong> directly rather than using <strong class="source-inline">DatabaseURLValue</strong>.</p>
			<p>Like other <strong class="source-inline">values</strong> classes, <strong class="source-inline">DatabaseURLValue</strong> takes a default value as its first argument. You might also want to use the <strong class="source-inline">environment_prefix</strong> argument and set it to <strong class="source-inline">DJANGO</strong> so that its environment variable being read is consistent in naming to the others. A full example of using <strong class="source-inline">DatabaseURLValue</strong> would therefore be like this:</p>
			<p class="source-code">DATABASES = values.DatabaseURLValue\</p>
			<p class="source-code">            ('sqlite:///{}/db.sqlite3'.format(BASE_DIR),\</p>
			<p class="source-code">              environment_prefix='DJANGO')</p>
			<p>By setting the <strong class="source-inline">environment_prefix</strong> like this, we can set the database URL using the <strong class="source-inline">DJANGO_DATABASE_URL</strong> environment variable (rather than just <strong class="source-inline">DATABASE_URL</strong>). This means it is consistent with other environment variable settings that also start with <strong class="source-inline">DJANGO</strong>_, such as <strong class="source-inline">DJANGO_DEBUG</strong> or <strong class="source-inline">DJANGO_ALLOWED_HOSTS</strong>.</p>
			<p>Note that even though we are not importing <strong class="source-inline">dj-database-url</strong> in <strong class="source-inline">settings.py</strong>, <strong class="source-inline">django-configurations</strong> uses it internally, so it still must be installed.</p>
			<p>In the next exercise, we will configure Bookr to use DatabaseURLValue to set its database configuration. It will be able to read from an environment variable and fall back to a default we specify.</p>
			<h2 id="_idParaDest-426"><a id="_idTextAnchor448"/>Exercise 15.02: dj-database-url and Setup</h2>
			<p>In this exercise, we will install <strong class="source-inline">dj-database-url</strong> using <strong class="source-inline">pip3</strong>. Then we will update Bookr's <strong class="source-inline">settings.py</strong> to configure the <strong class="source-inline">DATABASE</strong> setting using a URL, which is read from an environment variable:</p>
			<ol>
				<li value="1">In a terminal, make sure you have activated the <strong class="source-inline">bookr</strong> virtual environment, then run this command to install <strong class="source-inline">dj-database-url</strong> using <strong class="source-inline">pip3</strong>:<p class="source-code">pip3 install dj-database-url</p><p>The install process will run, and you should have output similar to this:</p><div id="_idContainer409" class="IMG---Figure"><img src="image/B15509_15_05.jpg" alt="Figure 15.5: dj-database-url installation with pip&#13;&#10;"/></div><p class="figure-caption">Figure 15.5: dj-database-url installation with pip</p></li>
				<li>In PyCharm, open <strong class="source-inline">settings.py</strong> in the <strong class="source-inline">bookr</strong> package directory. Scroll down to find where the <strong class="source-inline">DATABASES</strong> attribute is being defined. Replace it with the <strong class="source-inline">values.DatabaseURLValue</strong> class. The first argument (default value) should be the URL to the SQLite database: <strong class="source-inline">'sqlite:///{}/db.sqlite3'.format(BASE_DIR)</strong>. Also pass in <strong class="source-inline">environ_prefix</strong>, set to <strong class="source-inline">DJANGO</strong>. After completing this step, you should be setting the attribute like this:<p class="source-code">DATAB<a id="_idTextAnchor449"/>ASES = values.DatabaseURLValue\</p><p class="source-code">            ('sqlite:///{}/db.sqlite3'.format(BASE_DIR),\</p><p class="source-code">              environ_prefix='DJANGO')</p><p>Save <strong class="source-inline">settings.py</strong>.</p></li>
				<li>Start the Django dev server. As with <em class="italic">Exercise 15.01</em>, <em class="italic">Django Configurations Setup</em>, if it starts fine, you can be confident that your change was successful. To be sure, open <strong class="source-inline">http://127.0.0.1:8000/</strong> in a browser and check that everything looks and behaves as it did before. You should visit a page that queries from the database (such as the <strong class="source-inline">Books List</strong> page) and check that a list of books is displayed:<div id="_idContainer410" class="IMG---Figure"><img src="image/B15509_15_06.jpg" alt="Figure 15.6: Bookr pages with database queries still work&#13;&#10;"/></div></li>
			</ol>
			<p class="figure-caption">Figure 15.6: Bookr pages with database queries still work</p>
			<p>In this exercise, we updated our <strong class="source-inline">settings.py</strong> to determine its <strong class="source-inline">DATABASES</strong> setting from a URL specified in an environment variable. We used the <strong class="source-inline">values.DatabaseURLValue</strong> class to automatically read the value, and provided a default URL. We also set the <strong class="source-inline">environ_prefix</strong> argument to <strong class="source-inline">DJANGO</strong> so that the environment variable name is <strong class="source-inline">DJANGO_DATABASE_URL</strong>, which is consistent with other settings.</p>
			<p>In the next section, we will take a tour of the Django Debug Toolbar, an app that helps you debug your Django applications through the browser.</p>
			<h2 id="_idParaDest-427"><a id="_idTextAnchor450"/>The Django Debug Toolbar</h2>
			<p>The Django Debug Toolbar is an app that displays debug information about a web page right in your browser. It includes information about what SQL commands were run to generate the page, the request and response headers, how long the page took to render, and more. These can be useful if:</p>
			<ul>
				<li><em class="italic">A page is taking a long time to load – maybe it is running too many database queries.</em> You can see if the same queries are being run multiple times, in which case you could consider caching. Otherwise, some queries may be sped up by adding an index to the database.</li>
				<li><em class="italic">You want to determine why a page is returning the wrong information.</em> Your browser may have sent headers you did not expect, or maybe some headers from Django are incorrect.</li>
				<li><em class="italic">Your page is slow because it is spending time in non-database code</em> – you can profile the page to see what functions are taking the longest.</li>
				<li><em class="italic">The page looks incorrect.</em> You can see what templates Django rendered. There might be a third-party template that is being rendered unexpectedly. You can also check all the settings that are being used (including the built-in Django ones that we are not setting). This can help to pinpoint a setting that is incorrect and causing the page to not behave correctly.</li>
			</ul>
			<p>We'll explain how to use the Django Debug Toolbar to see this information. Before diving into how to set up the Django Debug Toolbar and how to use it, let's take a quick look at it. The toolbar is shown on the right of the browser window and can be toggled open and closed to display information:</p>
			<div>
				<div id="_idContainer411" class="IMG---Figure">
					<img src="image/B15509_15_07.jpg" alt="Figure 15.7: The Django Debug Toolbar closed&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.7: The Django Debug Toolbar closed</p>
			<p>The preceding figure shows the Django Debug Toolbar in its closed state. Notice the toggle bar in the top-right corner of the window. Clicking the toolbar opens it:</p>
			<div>
				<div id="_idContainer412" class="IMG---Figure">
					<img src="image/B15509_15_08.jpg" alt="Figure 15.8: The Django Debug Toolbar open&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.8: The Django Debug Toolbar open</p>
			<p><em class="italic">Figure 15.8</em> shows the Django Debug Toolbar open.</p>
			<p>Installing the Django Debug Toolbar is done using <strong class="source-inline">pip</strong>:</p>
			<p class="source-code">pip3 install django-debug-toolbar</p>
			<p class="callout-heading">Note</p>
			<p class="callout">F<a id="_idTextAnchor451"/>or Windows, you can use <strong class="source-inline">pip</strong> instead of <strong class="source-inline">pip3</strong> in the preceding command.</p>
			<p>Then there are a few steps to set it up, mostly by making changes to <strong class="source-inline">settings.py</strong>:</p>
			<ol>
				<li value="1">Add <strong class="source-inline">debug_to<a id="_idTextAnchor452"/>olbar</strong> to the <strong class="source-inline">INSTALLED_APPS</strong> settings list.</li>
				<li>Add <strong class="source-inline">debug_to<a id="_idTextAnchor453"/>olbar.middleware.DebugToolbarMiddleware</strong> to the <strong class="source-inline">MIDDLEWARE</strong> settings list. It should be done as early as possible; for Bookr, it can be the first item in this list. This is the middleware that all requests and responses pass through.</li>
				<li>Add <strong class="source-inline">'127.0.0<a id="_idTextAnchor454"/>.1'</strong> to the <strong class="source-inline">INTERNAL<a id="_idTextAnchor455"/>_IPS</strong> settings list (this setting may have to be created). The Django Debug Toolbar will only show for IP addresses listed here.</li>
				<li>Add the Django Debug Toolbar URLs to the base <strong class="source-inline">urls.py</strong> file. We want to add this mapping only if we are in <strong class="source-inline">DEBUG</strong> mode:<p class="source-code">path('__<a id="_idTextAnchor456"/>debug__/', include(debug_toolbar.urls))</p></li>
			</ol>
			<p>In the next exercise, we will go through these steps in detail. </p>
			<p>Once the Django Debug Toolbar is installed and set up, any page you visit will show the DjDT sidebar (you can open or close it using the DjDT menu). When it's open, you'll be able to see another set of sections that you can click on to get more information.</p>
			<p>Each panel has a checkbox next to it, this allows you to enable or disable the collection of that metric. Each metric that is collected will slightly slow down the page load (although, usually, this is not noticeable). If you find that one metric collection is slow, you can turn it off here:</p>
			<ol>
				<li value="1">We'll go through each panel. The first is <strong class="source-inline">Versions</strong>, which shows the version of Django running. You can click it to open a large <strong class="source-inline">Versions</strong> display, which will also show the version of Python and the Django Debug Toolbar (<em class="italic">Figure 15.9</em>):<div id="_idContainer413" class="IMG---Figure"><img src="image/B15509_15_09.jpg" alt="Figure 15.9: DjDT Versions panel (screenshot cropped for brevity)&#13;&#10;"/></div><p class="figure-caption">Figure 15.9: DjDT Versions panel (screenshot cropped for brevity)</p></li>
				<li>The second panel is <strong class="source-inline">Time</strong>, which shows how long it took to process the request. It is broken down into system time and user time as well (<em class="italic">Figure 15.10</em>):<div id="_idContainer414" class="IMG---Figure"><img src="image/B15509_15_10.jpg" alt="Figure 15.10: DjDT Time panel&#13;&#10;"/></div><p class="figure-caption">Figure 15.10: DjDT Time panel</p><p>The differences between these are beyond the scope of this book but, basically, system time is time spent in the kernel (for example, doing network or file reading/writing) and user time is code that is outside the operating system kernel (this includes the code you've written in Django, Python, and so on). </p><p>Also shown is time spent in the browser, such as the time taken to get the request and how long it took to render the page.</p></li>
				<li>The third panel, <strong class="source-inline">Settings</strong>, shows all the settings your application is using (<em class="italic">Figure 15.11</em>): <div id="_idContainer415" class="IMG---Figure"><img src="image/B15509_15_11.jpg" alt="Figure 15.11: DjDT Settings panel&#13;&#10;"/></div><p class="figure-caption">Figure 15.11: DjDT Settings panel</p><p>This is useful because it shows both your settings from <strong class="source-inline">settings.py</strong> and the default Django settings.</p></li>
				<li>The fourth panel is <strong class="source-inline">Headers</strong> (<em class="italic">Figure 15.12</em>). It shows the headers of the request the browser made, and the response headers that Django has sent:<div id="_idContainer416" class="IMG---Figure"><img src="image/B15509_15_12.jpg" alt="Figure 15.12: DjDT Headers panel&#13;&#10;"/></div><p class="figure-caption">Figure 15.12: DjDT Headers panel</p></li>
				<li>The fifth panel, <strong class="source-inline">Request</strong>, shows the view that generated the response, and the args and kwargs it was called with (<em class="italic">Figure 15.13</em>). You can also see the name of the URL used in its URL map:<div id="_idContainer417" class="IMG---Figure"><img src="image/B15509_15_13.jpg" alt="Figure 15.13: DjDT Request panel (some panels not shown for brevity)&#13;&#10;"/></div><p class="figure-caption">Figure 15.13: DjDT Request panel (some panels not shown for brevity)</p><p>It also shows the request's cookies, information stored in the session (sessions were introduced in <em class="italic">Chapter 8</em>, <em class="italic">Media Serving and File Upload</em>) as well as the <strong class="source-inline">request.GET</strong> and <strong class="source-inline">request.POST</strong> data.</p></li>
				<li>The sixth panel, <strong class="source-inline">SQL</strong>, shows all the SQL database queries that were executing when building the response (Figure 15.14): <div id="_idContainer418" class="IMG---Figure"><img src="image/B15509_15_14.jpg" alt="Figure 15.14: DjDT SQL panel&#13;&#10;"/></div><p class="figure-caption">Figure 15.14: DjDT SQL panel</p><p>You can see how long each query took to execute and in what order they were executed. It also flags similar and duplicate queries so you can potentially refactor your code to remove them.</p><p>Each <strong class="source-inline">SELECT</strong> query displays two action buttons, <strong class="source-inline">Sel</strong>, short for select, and <strong class="source-inline">Expl</strong>, short for explain. These do not show up for <strong class="source-inline">INSERT</strong>, <strong class="source-inline">UDPATE</strong>, or <strong class="source-inline">DELETE</strong> queries.</p><p>The <strong class="source-inline">Sel</strong> button shows the <strong class="source-inline">SELECT</strong> statement that was executed and all the data that was retrieved for the query (<em class="italic">Figure 15.15</em>):</p><div id="_idContainer419" class="IMG---Figure"><img src="image/B15509_15_15.jpg" alt="Figure 15.15: DjDT SQL Select panel&#13;&#10;"/></div><p class="figure-caption">Figure 15.15: DjDT SQL Select panel</p><p>The <strong class="source-inline">Expl</strong> button shows the <strong class="source-inline">EXPLAIN</strong> query for the <strong class="source-inline">SELECT</strong> query (<em class="italic">Figure 15.16</em>):</p><div id="_idContainer420" class="IMG---Figure"><img src="image/B15509_15_16.jpg" alt="Figure 15.16: DjDT SQL Explain panel (some panels not shown for brevity)&#13;&#10;"/></div><p class="figure-caption">Figure 15.16: DjDT SQL Explain panel (some panels not shown for brevity)</p><p><strong class="source-inline">EXPLAIN</strong> queries are beyond the scope of the book, but they basically show how the database tried to execute the <strong class="source-inline">SELECT</strong> query, for example, what database indexes were used. You might find that a query does not use an index and you can therefore get faster performance by adding one.</p></li>
				<li>The seventh panel is <strong class="source-inline">Static files</strong>, and it shows you which static files were loaded in this request (<em class="italic">Figure 15.17</em>). It also shows you all the static files that are available and how they would be loaded (that is, which static file finder found them). The <strong class="source-inline">Static files</strong> panel's information is like the information you can get from the <strong class="source-inline">findstatic</strong> management command:<div id="_idContainer421" class="IMG---Figure"><img src="image/B15509_15_17.jpg" alt="Figure 15.17: DjDT Static panel&#13;&#10;"/></div><p class="figure-caption">Figure 15.17: DjDT Static panel</p></li>
				<li>The eighth panel, <strong class="source-inline">Templates</strong>, shows information about the templates that were rendered (<em class="italic">Figure 15.18</em>): <div id="_idContainer422" class="IMG---Figure"><img src="image/B15509_15_18.jpg" alt="Figure 15.18: DjDT Templates panel&#13;&#10;"/></div><p class="figure-caption">Figure 15.18: DjDT Templates panel</p><p>It shows the paths the templates were loaded from and the inheritance chain.</p></li>
				<li>The ninth panel, <strong class="source-inline">Cache</strong>, shows information about data fetched from Django's cache:<div id="_idContainer423" class="IMG---Figure"><img src="image/B15509_15_19.jpg" alt="Figure 15.19: DjDT Cache panel (some panels not shown for brevity)&#13;&#10;"/></div><p class="figure-caption">Figure 15.19: DjDT Cache panel (some panels not shown for brevity)</p><p>Since we aren't using caching in Bookr, this section is blank. If we were, we would be able to see how many requests to the cache had been made, and how many of those requests were successful in retrieving items. We would also see how many items had been added to the cache. This can give you an idea about whether you are using the cache effectively or not. If you are adding a lot of items to the cache but not retrieving any, then you should reconsider what data you are caching. On the contrary, if you have a lot of <strong class="source-inline">Cache misses</strong> (a miss is when you request data that is not in the cache), then you should be caching more data than you are already.</p></li>
				<li>The tenth panel is <strong class="source-inline">Signals</strong>, which shows information about Django signals (<em class="italic">Figure 15.20</em>): <div id="_idContainer424" class="IMG---Figure"><img src="image/B15509_15_20.jpg" alt="Figure 15.20: DjDT Signals panel (some panels not shown for brevity)&#13;&#10;"/></div><p class="figure-caption">Figure 15.20: DjDT Signals panel (some panels not shown for brevity)</p><p>While we don't cover signals in this book, they are like events that you can hook into to execute functions when Django does something; for example, if a user is created, send them a welcome email. This section shows which signals were sent and which functions received them.</p></li>
				<li>The eleventh panel, <strong class="source-inline">Logging</strong>, shows log messages that were generated by your Django app (<em class="italic">Figure 15.21</em>): <div id="_idContainer425" class="IMG---Figure"><img src="image/B15509_15_21.jpg" alt="Figure 15.21: DjDT Logging panel&#13;&#10;"/></div><p class="figure-caption">Figure 15.21: DjDT Logging panel</p><p>Since no log messages were generated in this request, this panel is empty.</p><p>The next option, <strong class="source-inline">Intercept redirects</strong>, is not a section with data. Instead, it lets you toggle redirect interception. If your view returns a redirect, it will not be followed. Instead, a page like <em class="italic">Figure 15.22</em> is displayed:</p><div id="_idContainer426" class="IMG---Figure"><img src="image/B15509_15_22.jpg" alt="Figure 15.22: A redirect that DjDT has intercepted&#13;&#10;"/></div><p class="figure-caption">Figure 15.22: A redirect that DjDT has intercepted</p><p>This allows you to open the Django Debug Toolbar for the view that generated the redirect – otherwise, you'd only be able to see the information for the view that you were redirected to.</p></li>
				<li>The final panel is <strong class="source-inline">Profiling</strong>. This is off by default as profiling can slow down your response quite a lot. Once it is turned on, you must refresh the page to generate the profiling information (shown in <em class="italic">Figure 15.23</em>):<div id="_idContainer427" class="IMG---Figure"><img src="image/B15509_15_23.jpg" alt="Figure 15.23: DjDT Profiling panel&#13;&#10;"/></div></li>
			</ol>
			<p class="figure-caption">Figure 15.23: DjDT Profiling panel</p>
			<p>The information shown here is a breakdown of how long each function call in your response took. The left of the page shows a stack trace of all the calls performed. On the right are columns with timing data. The columns are:</p>
			<ul>
				<li><strong class="bold">CumTime</strong>: The cumulative amount of time spent in the function and any sub-functions it calls</li>
				<li><strong class="bold">Per</strong>: The cumulative time divided by the number of calls (<strong class="source-inline">Count</strong>)</li>
				<li><strong class="bold">TotTime</strong>: The amount of time spent in this function but not in any sub-function it calls</li>
				<li><strong class="bold">Per</strong> (<strong class="bold">second per</strong>): The total time divided by the number of calls (<strong class="source-inline">Count</strong>)</li>
				<li><strong class="bold">Calls</strong>: The number of calls of this function</li>
			</ul>
			<p>This information can help you determine where to speed up your app. For example, it can be easier to speed up a function that is called 1,000 times by a small fraction, than to optimize a large function that is only called once. Any more in-depth tips on how to speed up your code are beyond the scope of this book.</p>
			<h2 id="_idParaDest-428"><a id="_idTextAnchor457"/>Exercise 15.03: Setting Up the Django Debug Toolbar</h2>
			<p>In this exercise, you will add the Django Debug Toolbar settings by modifying the <strong class="source-inline">INSTALLED_APPS</strong>, <strong class="source-inline">MIDDLEWARE</strong>, and <strong class="source-inline">INTERNAL_IPS</strong> settings. Then you'll add the <strong class="source-inline">debug_toolbar.urls</strong> map to the <strong class="source-inline">bookr</strong> package's <strong class="source-inline">urls.py</strong>. Then you will load a page with the Django Debug Toolbar in a browser and use it:</p>
			<ol>
				<li value="1">In a terminal, make sure you have activated the <strong class="source-inline">bookr</strong> virtual environment, then run this command to install the Django Debug Toolbar using <strong class="source-inline">pip3</strong>:<p class="source-code">pip3 install django-debug-toolbar</p><p class="callout-heading">Note</p><p class="callout">For Windows, you can use <strong class="source-inline">pip</strong> instead of <strong class="source-inline">pip3</strong> in the preceding command.</p><p>The install process will run, and you should have output similar to <em class="italic">Figure 15.24</em>:</p><div id="_idContainer428" class="IMG---Figure"><img src="image/B15509_15_24.jpg" alt="Figure 15.24: django-debug-toolbar installation with pip&#13;&#10;"/></div><p class="figure-caption">Figure 15.24: django-debug-toolbar installation with pip</p><p>Open <strong class="source-inline">settings.py</strong> in the <strong class="source-inline">bookr</strong> package directory. Add <strong class="source-inline">debug_toolbar</strong> to the <strong class="source-inline">INSTALLED_APPS</strong> setting:</p><p class="source-code">INSTALLED_APPS = […\</p><p class="source-code">                  'debug_toolbar']</p><p>This will allow Django to find the Django Debug Toolbar's static files.</p></li>
				<li>Add <strong class="source-inline">debug_toolbar.middleware.DebugToolbarMiddleware</strong> to the <strong class="source-inline">MIDDLEWARE</strong> setting – it should be the first item in the list:<p class="source-code">MIDDLEWARE = ['debug_toolbar.middleware.DebugToolbarMiddleware',\</p><p class="source-code">              …]</p><p>This will route requests and responses through <strong class="source-inline">DebugToolbarMiddleware</strong>, allowing the Django Debug Toolbar to inspect the request and insert its HTML into the response.</p></li>
				<li>The final setting to add is to add the address <strong class="source-inline">127.0.0.1</strong> to <strong class="source-inline">INTERNAL_IPS</strong>. You will not yet have an <strong class="source-inline">INTERNAL_IPS</strong> setting defined, so add this as a setting:<p class="source-code">INTERNAL_IPS = ['127.0.0.1']</p><p>This will make the Django Debug Toolbar only show up on the developer's computer. You can now save <strong class="source-inline">settings.py</strong>.</p></li>
				<li>We now need to add the Django Debug Toolbar URLs. Open <strong class="source-inline">urls.py</strong> in the <strong class="source-inline">bookr</strong> package directory. We already have an <strong class="source-inline">if</strong> condition that checks for <strong class="source-inline">DEBUG</strong> mode then adds the media URL like so:<p class="source-code">if settings.DEBUG:</p><p class="source-code">    urlpatterns += static(settings.MEDIA_URL,\</p><p class="source-code">                          document_root=settings.MEDIA_ROOT)</p><p>We will also add an <strong class="source-inline">include</strong> of <strong class="source-inline">debug_toolbar.urls</strong> inside this <strong class="source-inline">if</strong> statement, however, we will add it to the start of <strong class="source-inline">urlpatterns</strong> rather than appending it to the end. Add this code inside the <strong class="source-inline">if</strong> statement:</p><p class="source-code">    import debug_toolbar</p><p class="source-code">    urlpatterns = [path\</p><p class="source-code">                   ('__debug__/',\</p><p class="source-code">                    include(debug_toolbar.urls)),] + urlpatterns</p><p>Save <strong class="source-inline">urls.py</strong>.</p></li>
				<li>Start the Django dev server if it is not already running and navigate to <strong class="source-inline">http://127.0.0.1:8000</strong>. You should see the Django Debug Toolbar open. If it is not open, click the <strong class="source-inline">DjDT</strong> toggle button at the top-right to open it:<div id="_idContainer429" class="IMG---Figure"><img src="image/B15509_15_25.jpg" alt="Figure 15.25: DjDT toggle shown in the corner&#13;&#10;"/></div><p class="figure-caption">Figure 15.25: DjDT toggle shown in the corner</p></li>
				<li>Try going through some of the panels and visiting different pages to see what information you can find out. Try also turning on <strong class="source-inline">Intercept redirects</strong> and then create a new book review. After submitting the form, you should see the intercepted page rather than being redirected to the new review (<em class="italic">Figure 15.26</em>):<div id="_idContainer430" class="IMG---Figure"><img src="image/B15509_15_26.jpg" alt="Figure 15.26: The redirect intercept page after submitting a new review&#13;&#10;"/></div><p class="figure-caption">Figure 15.26: The redirect intercept page after submitting a new review</p><p>You can then click the <strong class="source-inline">Location</strong> link to go to the page that it was being redirected to.</p></li>
				<li>You can also try turning on <strong class="source-inline">Profiling</strong> and see which functions are being called a lot and which are taking up most of the rendering time.</li>
				<li>Once you are finished experimenting with the Django Debug Toolbar, turn off <strong class="source-inline">Intercept redirects</strong> and <strong class="source-inline">Profiling</strong>.</li>
			</ol>
			<p>In this exercise, we installed and set up the Django Debug Toolbar by adding settings and URL maps. We then saw it in action and examined the useful information it can give us, including how to work with redirects and see profiling information.</p>
			<p>In the next section, we will look at the <strong class="source-inline">django-crispy-forms</strong> app, which will let us reduce the amount of code needed to write forms.</p>
			<h1 id="_idParaDest-429"><a id="_idTextAnchor458"/>django-crispy-forms</h1>
			<p>In Bookr, we are using the Bootstrap CSS framework. It provides styles that can be applied to forms using CSS classes. Since Django is independent of Bootstrap, when we use Django forms, it does not even know that we are using Bootstrap and so has no idea of what classes to apply to form widgets.</p>
			<p><strong class="source-inline">django-crispy-forms</strong> acts as an intermediary between Django Forms and Bootstrap forms. It can take a Django form and render it with the correct Bootstrap elements and classes. It not only supports Bootstrap but also other frameworks such as <strong class="bold">Uni-Form</strong> and <strong class="bold">Foundation</strong> (although Foundation support must be added through a separate package, <strong class="source-inline">crispy-forms-foundation</strong>).</p>
			<p>Its installation and setup are quite simple. Once again, it is installed with <strong class="source-inline">pip3</strong>:</p>
			<p class="source-code">pip3 install django-crispy-forms </p>
			<p class="callout-heading">Note</p>
			<p class="callout">For Windows, you ca<a id="_idTextAnchor459"/>n use <strong class="source-inline">pip</strong> instead of <strong class="source-inline">pip3</strong> in the preceding command.</p>
			<p>Then there are just a couple of settings changes. First, add <strong class="source-inline">crispy_forms</strong> to your <strong class="source-inline">INSTALLED_APPS</strong>. Then, you need to tell <strong class="source-inline">django-crispy-forms</strong>  what framework you are using, so it loads the correct templates. This is done with the <strong class="source-inline">CRISPY_TEMPLATE_PACK</strong> setting. In our case, it should be set to <strong class="source-inline">bootstrap4</strong>:</p>
			<p class="source-code">CRISPY_TEMPLATE_PACK = 'bootstrap4'</p>
			<p><strong class="source-inline">django-crispy-forms</strong> has two main modes of operation, either as a filter or a template tag. The former is easier to drop into an existing template. The latter allows more configuration options and moves more of the HTML generation into the <strong class="source-inline">Form</strong> class. We'll look at both of these in order.</p>
			<h2 id="_idParaDest-430"><a id="_idTextAnchor460"/>The crispy Filter</h2>
			<p>The first method of rendering a form with <strong class="source-inline">django-crispy-forms</strong>  is by using the <strong class="source-inline">crispy</strong> template. First, the filter must be loaded in the template. The library name is <strong class="source-inline">crispy_forms_tags</strong>:</p>
			<p class="source-code">{% load crispy_forms_tags %}</p>
			<p>Then, instead of rendering a form with the <strong class="source-inline">as_p</strong> method (or another method), use the <strong class="source-inline">crispy</strong> filter. Consider the following line:</p>
			<p class="source-code">{{ form.as_p }}</p>
			<p>And replace it with this:</p>
			<p class="source-code">{{ form|crispy }}</p>
			<p>Here's a quick <em class="italic">before and after</em> showing the <strong class="source-inline">Review Create</strong> form. None of the rest of the HTML has been changed apart from the form rendering. <em class="italic">Figure 15.27</em> shows the standard Django form:</p>
			<div>
				<div id="_idContainer431" class="IMG---Figure">
					<img src="image/B15509_15_27.jpg" alt="Figure 15.27: The Review Create form with default styling&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.27: The Review Create form with default styling</p>
			<p><em class="italic">Figure 15.28</em> shows the form after <strong class="source-inline">django-crispy-forms</strong> has added the Bootstrap classes:</p>
			<div>
				<div id="_idContainer432" class="IMG---Figure">
					<img src="image/B15509_15_28.jpg" alt="Figure 15.28: Review Create form with Bootstrap classes added by django-crispy-forms&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.28: Review Create form with Bootstrap classes added by django-crispy-forms</p>
			<p>When we integrate <strong class="source-inline">django-crispy-forms</strong> into Bookr, we will not use this method, however, it is worth knowing about because of how easy it is to drop it into your existing templates.</p>
			<h2 id="_idParaDest-431"><a id="_idTextAnchor461"/>The crispy Template Tag</h2>
			<p>The other method of rendering a form with <strong class="source-inline">django-crispy-forms</strong> is with the use of the <strong class="source-inline">crispy</strong> template tag. To use it, the <strong class="source-inline">crispy_forms_tags</strong> library must first be loaded into the template (as we did in the previous section). Then, the form is rendered like this:</p>
			<p class="source-code">{% crispy form %}</p>
			<p>How does this differ from the <strong class="source-inline">crispy</strong> filter? The <strong class="source-inline">crispy</strong> template tag will also render the <strong class="source-inline">&lt;form&gt;</strong> element and <strong class="source-inline">{% csrf_token %}</strong> template tag for you. So, consider for example that you used it like this:</p>
			<p class="source-code">&lt;form method="post"&gt;</p>
			<p class="source-code">  {% csrf_token %}</p>
			<p class="source-code">  {% crispy form %}</p>
			<p class="source-code">&lt;/form&gt;</p>
			<p>The output for this would be as follows:</p>
			<p class="source-code">&lt;form method="post" &gt;</p>
			<p class="source-code">&lt;input type="hidden" name="csrfmiddlewaretoken" value="…"&gt;</p>
			<p class="source-code">&lt;form method="post"&gt;</p>
			<p class="source-code">&lt;input type="hidden" name="csrfmiddlewaretoken" value="…"&gt;</p>
			<p class="source-code">    … form fields …</p>
			<p class="source-code">&lt;/form&gt;</p>
			<p class="source-code">&lt;/form&gt;</p>
			<p>That is, the form and CSRF token fields are duplicated. In order to customize the <strong class="source-inline">&lt;form&gt;</strong> element that is generated, <strong class="source-inline">django-crispy-forms</strong> provides a <strong class="source-inline">FormHelper</strong> class that can be set as a <strong class="source-inline">Form</strong> instance's <strong class="source-inline">helper</strong> attribute. It is the <strong class="source-inline">FormHelper</strong> instance that the <strong class="source-inline">crispy</strong> template tag uses to determine what attributes the <strong class="source-inline">&lt;form&gt;</strong> should have.</p>
			<p>Let us look at an <strong class="source-inline">ExampleForm</strong> with a helper added. First, import the required modules:</p>
			<p class="source-code">from django import forms</p>
			<p class="source-code">from crispy_forms.helper import FormHelper</p>
			<p>Next, define a form:</p>
			<p class="source-code">class ExampleForm(forms.Form):</p>
			<p class="source-code">example_field = forms.CharField()</p>
			<p>We could instantiate a <strong class="source-inline">FormHelper</strong> instance and then set it to the <strong class="source-inline">form.helper</strong> attribute (for example, in a view), but it's usually more useful to just create and assign it inside the form's <strong class="source-inline">__init__</strong> method. We haven't created a form with an <strong class="source-inline">__init__</strong> method yet, but it's no different from any other Python class:</p>
			<p class="source-code">    def __init__(self, *args, **kwargs):</p>
			<p class="source-code">        super().__init__(*args, **kwargs)</p>
			<p>Next, we set the helper and the form_method for the helper (which is then rendered in the form HTML):</p>
			<p class="source-code">self.helper = FormHelper()</p>
			<p class="source-code">self.helper.form_method = 'post'</p>
			<p>Other attributes can be set on the helper, such as <strong class="source-inline">form_action</strong>, <strong class="source-inline">form_id</strong>, and <strong class="source-inline">form_class</strong>. We don't need to use these in Bookr though. We also do not need to manually set the <strong class="source-inline">enctype</strong> on the form or its helper, as the <strong class="source-inline">crispy</strong> form tag will automatically set this to <strong class="source-inline">multipart/form-data</strong> if the form contains file upload fields.</p>
			<p>If we tried to render the form now, we wouldn't be able to submit it as there's no submit button (remember we added submit buttons to our forms manually, they are not part of the Django form). <strong class="source-inline">django-crispy-forms</strong> also includes layout helpers that can be added to the form. They will be rendered after the other fields. We can add a submit button like this – first, import the <strong class="source-inline">Submit</strong> class:</p>
			<p class="source-code">from crispy_forms.layout import Submit</p>
			<p class="callout-heading">Note</p>
			<p class="callout"><strong class="source-inline">django-crispy-forms</strong> does not properly support using a <strong class="source-inline">&lt;button&gt;</strong> input to submit a form, but for our purposes, an <strong class="source-inline">&lt;input type="submit"&gt;</strong> is functionally identical.</p>
			<p>We then instantiate it and add it to the helper's inputs in a single line:</p>
			<p class="source-code">self.helper.add_input(Submit("submit", "Submit"))</p>
			<p>The first argument to the <strong class="source-inline">Submit</strong> constructor is its <em class="italic">name</em>, and the second is its <em class="italic">label</em>.</p>
			<p><strong class="source-inline">django-crispy-forms</strong>  is aware that we are using Bootstrap and will automatically render the button with the <strong class="source-inline">btn btn-primary</strong> classes.</p>
			<p>The advantage of using a crispy template tag and <strong class="source-inline">FormHelper</strong> is that it means there is only one place where attributes and the behavior of the form are defined. We are already defining all the form fields in a <strong class="source-inline">Form</strong> class; this allows us to define the other attributes of the form in the same place. We could change a form from a <strong class="source-inline">GET</strong> submission to a <strong class="source-inline">POST</strong> submission easily here. The <strong class="source-inline">FormHelper</strong> instance will then automatically know that it needs to add a CSRF token to its HTML output when rendered. </p>
			<p>We'll put all this into practice in the next exercise, where you will install <strong class="source-inline">django-crispy-forms</strong> and then update <strong class="source-inline">SearchForm</strong> to utilize a form helper, then render it using the <strong class="source-inline">crispy</strong> template tag.</p>
			<h2 id="_idParaDest-432">Exercise 15.04: Using Django Crispy Forms wi<a id="_idTextAnchor462"/>th the SearchForm</h2>
			<p>In this exercise, you will install <strong class="source-inline">django-crispy-forms</strong>, then convert the <strong class="source-inline">SearchForm</strong> to be usable with the <strong class="source-inline">crispy</strong> template tag. This will be done by adding an <strong class="source-inline">__init__</strong> method and building a <strong class="source-inline">FormHelper</strong> instance inside it:</p>
			<ol>
				<li value="1">In a terminal, make sure you have activated the <strong class="source-inline">bookr</strong> virtual environment, then run this command to install <strong class="source-inline">django-crispy-forms</strong>  using <strong class="source-inline">pip3</strong>:<p class="source-code">pip3 install django-crispy-forms</p><p class="callout-heading">Note</p><p class="callout">For Windows, you can use <strong class="source-inline">pip</strong> instead of <strong class="source-inline">pip3</strong> in the preceding command.</p><p>The installation process will run, and you should have output similar to <em class="italic">Figure 15.29</em>:</p><div id="_idContainer433" class="IMG---Figure"><img src="image/B15509_15_29.jpg" alt="Figure 15.29: django-crispy-forms installation with pip&#13;&#10;"/></div><p class="figure-caption">Figure 15.29: django-crispy-forms installation with pip</p><p>Open <strong class="source-inline">settings.py</strong> in the <strong class="source-inline">bookr</strong> package directory, then add <strong class="source-inline">crispy_forms</strong> to your <strong class="source-inline">INSTALLED_APPS</strong> setting:</p><p class="source-code">INSTALLED_APPS = […\</p><p class="source-code">                  'reviews',\</p><p class="source-code">                  'debug_toolbar',\</p><p class="source-code">                  <strong class="bold">'crispy_forms'</strong>\]</p><p>This will allow Django to find the required templates.</p></li>
				<li>While in <strong class="source-inline">settings.py</strong>, add a new setting for <strong class="source-inline">CRISPY_TEMPLATE_PACK</strong> – its value should be <strong class="source-inline">bootstrap4</strong>. This should be added as an attribute on the <strong class="source-inline">Dev</strong> class:<p class="source-code">CRISPY_TEMPLATE_PACK = 'bootstrap4'</p><p>This lets <strong class="source-inline">django-crispy-forms</strong> know that it should be using the templates designed for Bootstrap version 4 when rendering forms. You can now save and close <strong class="source-inline">settings.py</strong>.</p></li>
				<li>Open the <strong class="source-inline">reviews</strong> app's <strong class="source-inline">forms.py</strong> file. First, we need to add two imports to the top of the file: <strong class="source-inline">FormHelper</strong> from <strong class="source-inline">crispy_forms.helper</strong>, and <strong class="source-inline">Submit</strong> from <strong class="source-inline">crispy_forms.layout</strong>:<p class="source-code">from crispy_forms.helper import FormHelper</p><p class="source-code">from crispy_forms.layout import Submit</p></li>
				<li>Next, add an <strong class="source-inline">__init__</strong> method to <strong class="source-inline">SearchForm</strong>. It should accept <strong class="source-inline">*args</strong> and <strong class="source-inline">**kwargs</strong> as arguments, then call the super <strong class="source-inline">__init__</strong> method with them:<p class="source-code">class SearchForm(forms.Form):</p><p class="source-code">…</p><p class="source-code">    def __init__(self, *args, **kwargs):</p><p class="source-code">        super().__init__(*args, **kwargs)</p><p>This will simply pass through whatever arguments are provided to the superclass constructor.</p></li>
				<li>Still inside the <strong class="source-inline">__init__</strong> method, set <strong class="source-inline">self.helper</strong> to an instance of <strong class="source-inline">FormHelper</strong>. Then set the helper's <strong class="source-inline">form_method</strong> to <strong class="source-inline">get</strong>. Finally, create an instance of <strong class="source-inline">Submit</strong>, passing in an empty string as the name (first argument), and <strong class="source-inline">Search</strong> as the button label (second argument). Add this to the helper with the <strong class="source-inline">add_input</strong> method:<p class="source-code">self.helper = FormHelper()</p><p class="source-code">self.helper.form_method = "get"</p><p class="source-code">self.helper.add_input(Submit("", "Search"))</p><p>You can save and close <strong class="source-inline">forms.py</strong>.</p></li>
				<li>In the <strong class="source-inline">reviews</strong> app's <strong class="source-inline">templates</strong> directory, open <strong class="source-inline">search-results.html</strong>. At the start of the file, after the <strong class="source-inline">extends</strong> template tag, use a <strong class="source-inline">load</strong> template tag to load <strong class="source-inline">crispy_forms_tags</strong>:<p class="source-code">{% load crispy_forms_tags %}</p></li>
				<li>Locate the existing <strong class="source-inline">&lt;form&gt;</strong> in the template. It should look like this:<p class="source-code">&lt;form&gt;</p><p class="source-code">    {{ form.as_p }}</p><p class="source-code">&lt;button type="submit" class="btn btn-primary"&gt;Search&lt;/button&gt;</p><p class="source-code">&lt;/form&gt;</p><p>You can delete the entered <strong class="source-inline">&lt;form&gt;</strong> element and replace it with a <strong class="source-inline">crispy</strong> template tag:</p><p class="source-code">{% crispy form %}</p><p>This will use the <strong class="source-inline">django-crispy-forms</strong> library to render the form, including the <strong class="source-inline">&lt;form&gt;</strong> element and submit button. After making this change, this portion of the template should look like <em class="italic">Figure 15.30</em>:</p><div id="_idContainer434" class="IMG---Figure"><img src="image/B15509_15_30.jpg" alt="Figure 15.30: search-results.html after replacing &lt;form&gt; with crispy form renderer&#13;&#10;"/></div><p class="figure-caption">Figure 15.30: search-results.html after replacing &lt;form&gt; with crispy form renderer</p><p>You can now save <strong class="source-inline">search-results.html</strong>.</p></li>
				<li>Start the Django dev server if it is not already running and go to <strong class="source-inline">http://127.0.0.1:8000/book-search/</strong>. You should see the book search form like in <em class="italic">Figure 15.31</em>:<div id="_idContainer435" class="IMG---Figure"><img src="image/B15509_15_31.jpg" alt="Figure 15.31: Book search form rendered with django-crispy-forms&#13;&#10;"/></div></li>
			</ol>
			<p class="figure-caption">Figure 15.31: Book search form rendered with django-crispy-forms</p>
			<p>You should be able to use the form in the same manner as you did before (<em class="italic">Figure 15.32</em>):</p>
			<div>
				<div id="_idContainer436" class="IMG---Figure">
					<img src="image/B15509_15_32.jpg" alt="Figure 15.32: Performing a search with the updated search form&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.32: Performing a search with the updated search form</p>
			<p>Try viewing the source of the page in your web browser to see the rendered output. You will see that the <strong class="source-inline">&lt;form&gt;</strong> element has been rendered with the <strong class="source-inline">method="get"</strong> attribute, as we specified to the <strong class="source-inline">FormHelper</strong> in <em class="italic">step 5</em>. Notice also that <strong class="source-inline">django-crispy-forms</strong> has not inserted a CSRF token field – it knows that one is not required for a form submitted using <strong class="source-inline">GET</strong>.</p>
			<p>In this exercise, we installed <strong class="source-inline">django-crispy-forms</strong> using <strong class="source-inline">pip3</strong> (<strong class="source-inline">pip</strong> for Windows) and then configured it in <strong class="source-inline">settings.py</strong> by adding it to <strong class="source-inline">INSTALLED_APPS</strong> and defining the <strong class="source-inline">CRISPY_TEMPLATE_PACK</strong> we wanted to use (in our case, <strong class="source-inline">bootstrap4</strong>). We then updated the <strong class="source-inline">SearchForm</strong> class to use a <strong class="source-inline">FormHelper</strong> instance to control the attributes on the form and added a submit button using the <strong class="source-inline">Submit</strong> class. Finally, we changed the <strong class="source-inline">search-results.html</strong> template to use the <strong class="source-inline">crispy</strong> template tag to render the form, which allowed us to remove the <strong class="source-inline">&lt;form&gt;</strong> element we were using before and simplify form generation by moving all the form-related code into Python code (instead of being partially in HTML and partially in Python).</p>
			<h2 id="_idParaDest-433"><a id="_idTextAnchor463"/>django-allauth</h2>
			<p>When browsing websites, you have probably seen buttons that allow you to log in using another website's credentials. For example, using your GitHub login:</p>
			<div>
				<div id="_idContainer437" class="IMG---Figure">
					<img src="image/B15509_15_33.jpg" alt="Figure 15.33: Sign In form with options to log in with Google or GitHub&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.33: Sign In form with options to log in with Google or GitHub</p>
			<p>Before we explain the process, let us introduce the terminology we will be using:</p>
			<ul>
				<li><strong class="bold">Requesting site</strong>: The site the user is trying to log in to.</li>
				<li><strong class="bold">Authentication provider</strong>: The third-party provider that the user is authenticating to (for example, Google, GitHub, and so on).</li>
				<li><strong class="bold">Authentication application</strong>: This is something the creators of the requesting site set up at the authentication provider. It determines what permissions the requesting site will have with the authentication provider. For example, the requesting application can get access to your GitHub username, but won't have permission to write to your repositories. The user can stop the requesting site from accessing your information at the authentication provider by disabling access to the authentication application.</li>
			</ul>
			<p>The process is generally the same regardless of which third-party sign-in option you choose. First, you will be redirected to the authentication provider site and be asked to allow the authentication application to access your account (<em class="italic">Figure 15.34</em>):</p>
			<div>
				<div id="_idContainer438" class="IMG---Figure">
					<img src="image/B15509_15_34.jpg" alt="Figure 15.34: Authentication provider authorization screen&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.34: Authentication provider authorization screen</p>
			<p>After you authorize the authentication application, the authentication provider will redirect back to the requesting site. The URL that you are redirected to will contain a secret token that the requesting site can use to request your user information in the backend. This allows the requesting site to verify who you are by communicating directly with the authentication provider. After validating your identity using a token, the requesting site can redirect you to your content. This flow is illustrated in a sequence diagram in <em class="italic">Figure 15.35</em>:</p>
			<div>
				<div id="_idContainer439" class="IMG---Figure">
					<img src="image/B15509_15_35.jpg" alt="Figure 15.35: Third-party authentication flow&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.35: Third-party authentication flow</p>
			<p>Now that we have introduced authenticating using a third-party service, we can discuss <strong class="source-inline">django-allauth</strong>. <strong class="source-inline">django-allauth</strong> is an app that easily plugs your Django application into a third-party authentication service, including Google, GitHub, Facebook, Twitter, and others. In fact, at the time of writing, <strong class="source-inline">django-allauth</strong> supports over 75 authentication providers.</p>
			<p>The first time a user authenticates to your site, <strong class="source-inline">django-allauth</strong> will create a standard Django <strong class="source-inline">User</strong> instance for you. It also knows how to parse the callback/redirect URL that the authentication provider loads after the end user authorizes the authentication application.</p>
			<p><strong class="source-inline">django-allauth</strong> adds three models to your application:</p>
			<ul>
				<li><strong class="source-inline">SocialApplication</strong>: This stores the information used to identify your authentication application. The information you enter will depend on the provider, who will give you a <em class="italic">client</em> ID, <em class="italic">secret</em> key, and (optionally) a <em class="italic">key</em>. Note that these are the names that <strong class="source-inline">django-allauth</strong> uses for these values and they will differ based on the provider. We will give some examples of these values later in this section. <strong class="source-inline">SocialApplication</strong> is the only one of the <strong class="source-inline">django-allauth</strong> models that you will create yourself, the others <strong class="source-inline">django-allauth</strong> creates automatically when a user authenticates.</li>
				<li><strong class="source-inline">SocialApplicationToken</strong>: This contains the values needed to identify a Django user to the authentication provider. It contains a <em class="italic">token</em> and (optionally) a <em class="italic">token secret</em>. It also contains a reference to the <strong class="source-inline">SocialApplication</strong> that created it and the <strong class="source-inline">SocialAccount</strong> to which it applies.</li>
				<li><strong class="source-inline">SocialAccount</strong>: This links a Django user to the provider (for example, Google or GitHub) and stores extra information that the provider may have given.</li>
			</ul>
			<p>Since there are so many authentication providers, we will not cover how to set them all up, but we will give a short instruction on setup and how to map the auth tokens from the providers to the right fields in a <strong class="source-inline">SocialApplication</strong>. We will do this for the two auth providers we have been mentioning throughout the chapter: Google and GitHub.</p>
			<h3 id="_idParaDest-434"><a id="_idTextAnchor464"/>django-allauth Installation and Setup</h3>
			<p>Like the other apps in this chapter, <strong class="source-inline">django-allauth</strong> is installed with <strong class="source-inline">pip3</strong>:</p>
			<p class="source-code">pip3 install django-allauth</p>
			<p class="callout-heading">Note</p>
			<p class="callout">For Windows, you can use <strong class="source-inline">pip</strong> instead of <strong class="source-inline">pip3</strong> in the preceding command.</p>
			<p>We then need a few settings changes. <strong class="source-inline">django-allauth</strong> requires the <strong class="source-inline">django.contrib.sites</strong> app to run, so it needs to be added to <strong class="source-inline">INSTALLED_APPS</strong>. Then a new setting needs to be added to define a <strong class="source-inline">SITE_ID</strong> for our site. We can just set this to <strong class="source-inline">1</strong> in our <strong class="source-inline">settings.py</strong> file:</p>
			<p class="source-code">INSTALLED_APPS = [# this entry added</p>
			<p class="source-code">                  'django.contrib.sites',\</p>
			<p class="source-code">                  'django.contrib.admin',\</p>
			<p class="source-code">                  'django.contrib.auth',\</p>
			<p class="source-code">                  # the rest of the values are truncated]</p>
			<p class="source-code">SITE_ID = 1</p>
			<p class="callout-heading">Note</p>
			<p class="callout">It is possible to have a single Django project hosted on multiple hostnames and have it behave differently on each – but also have content shared across all the sites. We don't need to use the <strong class="source-inline">SITE_ID</strong> anywhere else in our project but one must be set here. You can read more about the <strong class="source-inline">SITE_ID</strong> settings at <a href="https://docs.djangoproject.com/en/3.0/ref/contrib/sites/">https://docs.djangoproject.com/en/3.0/ref/contrib/sites/</a>.</p>
			<p>We also need to add <strong class="source-inline">allauth</strong> and <strong class="source-inline">allauth.socialaccount</strong> to <strong class="source-inline">INSTALLED_APPS</strong>:</p>
			<p class="source-code">INSTALLED_APPS = [# the rest of the values are truncated</p>
			<p class="source-code">                  'allauth',\</p>
			<p class="source-code">                  'allauth.socialaccount',]</p>
			<p>Then, each provider we want to support must also be added in the list of <strong class="source-inline">INSTALLED_APPS</strong>; for example, consider the following snippet:</p>
			<p class="source-code">INSTALLED_APPS = [# the rest of the values are truncated</p>
			<p class="source-code">                  'allauth.socialaccount.providers.github',\</p>
			<p class="source-code">                  'allauth.socialaccount.providers.google',]</p>
			<p>After all this is done, we need to run the <strong class="source-inline">migrate</strong> management command, to create the <strong class="source-inline">django-allauth</strong> models:</p>
			<p class="source-code">python3 manage.py migrate</p>
			<p>Once this is done, new social applications can be added through the Django Admin interface (<em class="italic">Figure 15.36</em>): </p>
			<div>
				<div id="_idContainer440" class="IMG---Figure">
					<img src="image/B15509_15_36.jpg" alt="Figure 15.36: Adding a social application&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.36: Adding a social application</p>
			<p>To add a social application, select a <strong class="source-inline">Provider</strong> (this list will only show those in the <strong class="source-inline">INSTALLED_APPS</strong> list), enter a name (it can just be the same as the <strong class="source-inline">Provider</strong>), and enter the <strong class="source-inline">Client ID</strong> from the provider's website (we will go into detail on this soon). You may also need a <strong class="source-inline">Secret key</strong> and <strong class="source-inline">Key</strong>. Select the site it should apply to. (If you only have one <strong class="source-inline">Site</strong> instance, then its name does not matter, just select it. The site name can be updated in the <strong class="source-inline">Sites</strong> section of Django admin. You can also add more sites there.)</p>
			<p>We will now look at the tokens used by our three example providers.</p>
			<h3 id="_idParaDest-435"><a id="_idTextAnchor465"/>GitHub Auth Setup</h3>
			<p>A new GitHub application can be set up under your GitHub profile. During development, your callback URL for the application should be set to <strong class="source-inline">http://127.0.0.1:8000/accounts/github/login/callback/</strong> and updated with the real hostname when you deploy to production. After creating the app, it will provide a <strong class="source-inline">Client ID</strong> and <strong class="source-inline">Client Secret</strong>. These are your <strong class="source-inline">Client id</strong> and <strong class="source-inline">Secret key</strong>, respectively, in <strong class="source-inline">django-allauth</strong>. </p>
			<h3 id="_idParaDest-436"><a id="_idTextAnchor466"/>Google Auth Setup</h3>
			<p>The creation of a Google application is done through your Google Developers console. The authorized redirect URI should be set to <strong class="source-inline">http://127.0.0.1:8000/accounts/google/login/callback/</strong> during development and updated after production deployment. The app's <strong class="source-inline">Client ID</strong> is also Client id in <strong class="source-inline">django-allauth</strong>, and the app's <strong class="source-inline">Client secret</strong> is the <strong class="source-inline">Secret key</strong>.</p>
			<h2 id="_idParaDest-437"><a id="_idTextAnchor467"/>Initiating Authentication with django-allauth</h2>
			<p>To initiate authentication through a third-party provider, you first need to add the <strong class="source-inline">django-allauth</strong> URLs in your URL maps. Somewhere inside your <strong class="source-inline">urlpatterns</strong> is one of your <strong class="source-inline">urls.py</strong> files, include <strong class="source-inline">allauth.urls</strong>:</p>
			<p class="source-code">urlpatterns = [path('allauth', include('allauth.urls')),]</p>
			<p>You will then be able to initiate a login using URLs like <strong class="source-inline">http://127.0.0.1:8000/allauth/github/login/?process=login</strong> or <strong class="source-inline">http://127.0.0.1:8000/allauth/google/login/?process=login</strong>, and so on. django-allauth will handle all the redirects for you, then create/authenticate the Django user when they return to the site. You can have buttons on your login page with text such as Login with GitHub or Login with Google that link to these URLs.</p>
			<h3 id="_idParaDest-438"><a id="_idTextAnchor468"/>Other django-allauth Features</h3>
			<p>Other than authentication with third-party providers, <strong class="source-inline">django-allauth</strong> can also add some useful features that Django does not have built in. For example, you can configure it to require an email address for a user, and have the user verify their email address by clicking a confirmation link they receive before they log in, <strong class="source-inline">django-allauth</strong> can also handle generating a URL for a password reset that is emailed to the user. You can find the documentation for <strong class="source-inline">django-allauth</strong> that explains these features, and more, at <a href="https://django-allauth.readthedocs.io/en/stable/overview.html">https://django-allauth.readthedocs.io/en/stable/overview.html</a>.</p>
			<p>Now that we have covered the first four third-party apps in depth and given a brief overview of <strong class="source-inline">django-allauth</strong>, you can undertake the activity for this chapter. In this activity, you will refactor the <strong class="source-inline">ModelForm</strong> instances we are using to use the <strong class="source-inline">CrispyFormHelper</strong> class.</p>
			<h2 id="_idParaDest-439">Activity 15.01: Using FormHelper to <a id="_idTextAnchor469"/>Update Forms</h2>
			<p>In this activity, we will update the <strong class="source-inline">ModelForm</strong> instances (<strong class="source-inline">PublisherForm</strong>, <strong class="source-inline">ReviewForm</strong>, and <strong class="source-inline">BookMediaForm</strong>) to use the <strong class="source-inline">CrispyFormHelper</strong> class. Using <strong class="source-inline">FormHelper</strong>, we can define the text of the <strong class="source-inline">Submit</strong> button inside the <strong class="source-inline">Form</strong> class itself. We can then move the <strong class="source-inline">&lt;form&gt;</strong> rendering logic out of the <strong class="source-inline">instance-form.html</strong> template and replace it with a <strong class="source-inline">crispy</strong> template tag.</p>
			<p>These steps will help you complete the activity:</p>
			<ol>
				<li value="1">Create an <strong class="source-inline">InstanceForm</strong> class that subclasses <strong class="source-inline">forms.ModelForm</strong>. This will be the base of the existing <strong class="source-inline">ModelForm</strong> classes.</li>
				<li>In the <strong class="source-inline">__init__</strong> method of <strong class="source-inline">InstanceForm</strong>, set a <strong class="source-inline">FormHelper</strong> instance on <strong class="source-inline">self</strong>.</li>
				<li>Add a <strong class="source-inline">Submit</strong> button to <strong class="source-inline">FormHelper</strong>. If the form is instantiated with an <strong class="source-inline">instance</strong>, then the button text should be <strong class="source-inline">Save</strong>, otherwise, it should be <strong class="source-inline">Create</strong>.</li>
				<li>Update PublisherForm, ReviewForm, and BookMediaForm to extend from <strong class="source-inline">InstanceForm</strong>.</li>
				<li>Update the <strong class="source-inline">instance-form.html</strong> template so that <strong class="source-inline">form</strong> is rendered using the <strong class="source-inline">crispy</strong> template tag. The rest of the <strong class="source-inline">&lt;form&gt;</strong> can be removed.</li>
				<li>In the <strong class="source-inline">book_media</strong> view, the <strong class="source-inline">is_file_upload</strong> context item is no longer required.</li>
			</ol>
			<p>When you are finished, you should see the forms rendered with Bootstrap themes. <em class="italic">Figure 15.37</em> shows the <strong class="source-inline">New Publisher</strong> page:</p>
			<div>
				<div id="_idContainer441" class="IMG---Figure">
					<img src="image/B15509_15_37.jpg" alt="Figure 15.37: New Publisher page&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.37: New Publisher page</p>
			<p><em class="italic">Figure 15.38</em> shows the <strong class="source-inline">New Review</strong> page:</p>
			<div>
				<div id="_idContainer442" class="IMG---Figure">
					<img src="image/B15509_15_38.jpg" alt="Figure 15.38: New Review form&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.38: New Review form</p>
			<p>Finally, the book media page is displayed in <em class="italic">Figure 15.39</em>:</p>
			<div>
				<div id="_idContainer443" class="IMG---Figure">
					<img src="image/B15509_15_39.jpg" alt="Figure 15.39: Book media page&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 15.39: Book media page</p>
			<p>You should notice the form still behaves fine and allows file uploads. <strong class="source-inline">django-crispy-forms</strong>  has automatically added the <strong class="source-inline">enctype="multipart/form-data"</strong> attribute to <strong class="source-inline">&lt;form&gt;</strong>. You can verify this by viewing the page source.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">The solution to this activity can be found at <a href="http://packt.live/2Nh1NTJ">http://packt.live/2Nh1NTJ</a>.</p>
			<h1 id="_idParaDest-440"><a id="_idTextAnchor470"/>Summary</h1>
			<p>In this chapter, we introduced five third-party Django apps that can enhance your website. We installed and set up <strong class="source-inline">django-configurations</strong>, which allowed us to easily switch between different settings and change them using environment variables. <strong class="source-inline">dj-database-url</strong> also helped with settings, allowing us to make database settings changes using URLs. We saw how the Django Debug Toolbar could help us see what our app was doing and help us debug problems we were having with it. <strong class="source-inline">django-crispy-forms</strong> can not only render our forms using the Bootstrap CSS but also lets us save code by defining their behavior as part of the form class itself. We briefly looked at <strong class="source-inline">django-allauth</strong> and saw how it can be integrated into third-party authentication providers. In the activity for this chapter, we updated our <strong class="source-inline">ModelForm</strong> instances to use the <strong class="source-inline">django-crispy-forms</strong> <strong class="source-inline">FormHelper</strong> and remove some logic from the template by using the <strong class="source-inline">crispy</strong> template tag.</p>
			<p>In the next chapter, we will look at how to integrate the React JavaScript framework into a Django application.</p>
		</div>
		<div>
			<div id="_idContainer445" class="Content">
			</div>
		</div>
	</body></html>