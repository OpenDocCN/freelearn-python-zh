<html><head></head><body>
<section data-number="0.17" id="chapter-14-application-integration-combination">
<h2 class="likechapterhead" data-number="0.17"><span><span class="kobospan" id="kobo.1.1">14</span></span><br class="tipbox1"/> <span id="x1-75800014"/><span class="kobospan" id="kobo.2.1">Application Integration: Combination</span></h2>
<p class="normal"><span class="kobospan" id="kobo.3.1">The Python language is designed to permit extensibility. </span><span class="kobospan" id="kobo.3.2">We can create sophisticated programs by combining a number of smaller components. </span><span class="kobospan" id="kobo.3.3">In this chapter, we’ll look at ways to combine modules and scripts.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.4.1">We’ll look at the complications that can arise from composite applications and the need to centralize some features, like command-line parsing. </span><span class="kobospan" id="kobo.4.2">This will enable us to create uniform interfaces for a variety of closely related programs.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.5.1">We’ll extend some of the concepts from </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.6.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.7.1"> </span></span><a href="ch011_split_000.xhtml#x1-3760007" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.8.1">7</span></span></a><span class="kobospan" id="kobo.9.1"> and </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.10.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.11.1"> </span></span><a href="ch012.xhtml#x1-4520008" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.12.1">8</span></span></a><span class="kobospan" id="kobo.13.1">, and apply the idea of the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.14.1">Command </span></span><span class="kobospan" id="kobo.15.1">design pattern to Python</span><span id="dx1-758001"/><span class="kobospan" id="kobo.16.1"> programs. </span><span class="kobospan" id="kobo.16.2">By encapsulating features in class definitions, we’ll find it easier to combine and extend programs.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.17.1">In this chapter, we’ll look at the following recipes:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><a href="ch018.xhtml#x1-7590001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.18.1">Combining two applications into one</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch018.xhtml#x1-7670002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.19.1">Combining many applications using the </span></span><span class="cmbxti-10x-x"><span class="kobospan" id="kobo.20.1">Command </span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.21.1">design pattern</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch018.xhtml#x1-7730003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.22.1">Managing arguments and configuration in composite applications</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch018.xhtml#x1-7790004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.23.1">Wrapping and combining CLI applications</span></span></a></p></li>
<li class="calibre7"><p class="normal2"><a href="ch018.xhtml#x1-7850005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.24.1">Wrapping a program and checking the output</span></span></a></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.25.1">We’ll start with a direct approach to combining multiple Python applications into a single, more sophisticated application. </span><span class="kobospan" id="kobo.25.2">We’ll expand this to apply object-oriented design techniques and create an even more flexible composite. </span><span class="kobospan" id="kobo.25.3">Then, we’ll apply uniform command-line argument parsing for composite applications. </span><span id="x1-758002r1620"/></p>
<section data-number="0.17.1" id="combining-two-applications-into-one">
<h1 class="unnumbered" data-number="0.17.1"><span><span class="kobospan" id="kobo.26.1">14.1 </span></span> <span id="x1-7590001"/><span class="kobospan" id="kobo.27.1">Combining two applications into one</span></h1>
<p class="normal"><span class="kobospan" id="kobo.28.1">For this recipe, we’ll look at two scripts</span><span id="dx1-759001"/><span class="kobospan" id="kobo.29.1"> that need to be combined. </span><span class="kobospan" id="kobo.29.2">One script emits data from a Markov chain process, and the second script summarizes those results.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.30.1">What’s important here is the Markov chain application is (intentionally) a bit mysterious. </span><span class="kobospan" id="kobo.30.2">For the purposes of several recipes, we’ll treat this as opaque software, possibly written in another language.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.31.1">(The GitHub repository for this book has the Markov chain written in Pascal to be reasonably opaque.)</span></p>
<p class="normal1"><span class="kobospan" id="kobo.32.1">For reference, here’s a depiction of the Markov</span><span id="dx1-759002"/><span class="kobospan" id="kobo.33.1"> chain state changes:</span></p>
<div class="center">
<p class="normal1"><span class="kobospan" id="kobo.34.1"><img alt="SSFGp””””””tuaro00000nacioi.....orclwn21610tteUt21668en21773(dte””””—faist0ila.lb1 o(l1rpi1oshpine—otd0i).n1t3)”9 ” " src="../media/file78.png" class="calibre9"/></span> <span id="x1-759003r1"/> <span id="x1-759004"/></p>
<span><span class="kobospan" id="kobo.35.1">Figure 14.1: </span></span><span><span class="kobospan" id="kobo.36.1">Markov chain states </span></span>
</div>
<p class="normal1"><span class="kobospan" id="kobo.37.1">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.38.1">Start </span></span><span class="kobospan" id="kobo.39.1">state will either succeed, fail, or generate</span><span id="dx1-759005"/><span class="kobospan" id="kobo.40.1"> a ”point” value. </span><span class="kobospan" id="kobo.40.2">There are a number of values, each with distinct probabilities that sum to </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.41.1">P </span></span><span class="kobospan" id="kobo.42.1">= 0</span><span class="cmti-10x-x"><span class="kobospan" id="kobo.43.1">.</span></span><span class="kobospan" id="kobo.44.1">667. </span><span class="kobospan" id="kobo.44.2">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.45.1">GrowUntil </span></span><span class="kobospan" id="kobo.46.1">state generates values that may match the point, not match the point, or indicate failure. </span><span class="kobospan" id="kobo.46.2">In the cases of a non-match and non-failure, the chain transitions back to this state. </span><span class="kobospan" id="kobo.46.3">The exact probability of a match depends on the starting-point value, which is why the state transition is labeled with three probabilities.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.47.1">The generator application emits a TOML-format file with some configuration details and a collection of individual samples. </span><span class="kobospan" id="kobo.47.2">The file looks like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.48.1"># file = "../../data/ch14/data.csv" 
 
# samples = 10 
 
# randomize = 0 
 
# ----- 
 
outcome,length,chain 
 
"Success",1,"7" 
 
"Success",2,"10;10"</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.49.1">A summary application reads all of these generated files to create some simple statistics to describe the raw data. </span><span class="kobospan" id="kobo.49.2">This summary was originally done with Jupyter Notebook. </span><span class="kobospan" id="kobo.49.3">While these can be executed with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.50.1">jupyter</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.51.1"> execute</span></span></span></span><span class="kobospan" id="kobo.52.1"> command, an alternative approach is to save the notebook as a script and then execute the script.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.53.1">We want to be able to combine</span><span id="dx1-759014"/><span class="kobospan" id="kobo.54.1"> this generator and the summary applications to reduce the manual steps in using the generator. </span><span class="kobospan" id="kobo.54.2">There are several common approaches to combining multiple applications:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.55.1">A shell script can run the generator application and then run the summary application.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.56.1">A Python program can implement the high-level operation, using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.57.1">runpy</span></span></span></span><span class="kobospan" id="kobo.58.1"> module to run each of the two applications.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.59.1">We can build a composite application from the essential components of each application.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.60.1">In this recipe, we’ll look at the third path of combining the essential components of each application by writing a new composite application. </span><span id="x1-759015r1618"/></p>
<section data-number="0.17.1.1" id="getting-ready-105">
<h2 class="likechapterhead" data-number="0.17.1.1"><span><span class="kobospan" id="kobo.61.1">14.1.1 </span></span> <span id="x1-7600001"/><span class="kobospan" id="kobo.62.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.63.1">In the </span><a href="ch017.xhtml#x1-7410005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.64.1">Designing scripts for composition</span></span></a><span class="kobospan" id="kobo.65.1"> and </span><a href="ch017.xhtml#x1-7470006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.66.1">Using logging for control</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.67.1">and audit output</span></span></a><span class="kobospan" id="kobo.68.1"> recipes in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.69.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.70.1"> </span></span><a href="ch017.xhtml#x1-71500013" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.71.1">13</span></span></a><span class="kobospan" id="kobo.72.1">, we followed a design pattern that separated the input gathering, the essential processing, and the production of output. </span><span class="kobospan" id="kobo.72.2">The objective of that design pattern was to gather the interesting pieces together to combine and recombine them into higher-level constructs.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.73.1">Note that we have a tiny mismatch between the two applications. </span><span class="kobospan" id="kobo.73.2">We can borrow a phrase from database engineering (and also electrical engineering) and call this an ”impedance mismatch.”</span></p>
<p class="normal1"><span class="kobospan" id="kobo.74.1">When building this composite application, the impedance mismatch is a cardinality problem. </span><span class="kobospan" id="kobo.74.2">The data generator process is designed to run more frequently than the statistical summary process. </span><span class="kobospan" id="kobo.74.3">We have a couple of choices for addressing issues</span><span id="dx1-760001"/><span class="kobospan" id="kobo.75.1"> such as this one:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.76.1">Total redesign</span></span><span class="kobospan" id="kobo.77.1">: We can rewrite the generator to an iterator as desired, producing multiple sets of samples.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.78.1">Add the iterator</span></span><span class="kobospan" id="kobo.79.1">: We can build the composite application to do bulk data generation processing. </span><span class="kobospan" id="kobo.79.2">After all the data is produced, the composite application can then summarize it.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.80.1">The choice between these design</span><span id="dx1-760002"/><span class="kobospan" id="kobo.81.1"> alternatives depends on the user stories for this application. </span><span class="kobospan" id="kobo.81.2">It may also depend on the established base of users. </span><span class="kobospan" id="kobo.81.3">For this recipe, the users would like to follow the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.82.1">Add the iterator </span></span><span class="kobospan" id="kobo.83.1">design to create a composite process without touching the underlying generator.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.84.1">Looking inside the two module implementation choices, we see two distinct design patterns for top-level applications:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.85.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.86.1">markov_gen</span></span></span></span><span class="kobospan" id="kobo.87.1"> module has the following </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.88.1">main()</span></span></span></span><span class="kobospan" id="kobo.89.1"> function definition:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.90.1">def main(argv: list[str] = sys.argv[1:]) -&gt; None:</span></code></pre></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.91.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.92.1">markov_summ</span></span></span></span><span class="kobospan" id="kobo.93.1"> module, on the other hand, is a script, exported from a notebook. </span><span class="kobospan" id="kobo.93.2">A direct </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.94.1">Command-Line Interface </span></span><span class="kobospan" id="kobo.95.1">(</span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.96.1">CLI</span></span><span class="kobospan" id="kobo.97.1">) is not part of this script, and some</span><span id="dx1-760005"/><span class="kobospan" id="kobo.98.1"> rewriting is required. </span><span class="kobospan" id="kobo.98.2">See the </span><a href="ch017.xhtml#x1-7410005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.99.1">Designing</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.100.1">scripts for composition</span></span></a><span class="kobospan" id="kobo.101.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.102.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.103.1"> </span></span><a href="ch017.xhtml#x1-71500013" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.104.1">13</span></span></a><span class="kobospan" id="kobo.105.1"> for details on this.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.106.1">To create a more useful script, we need to add a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.107.1">def</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.108.1"> main():</span></span></span></span><span class="kobospan" id="kobo.109.1"> line and indent the entire script inside the body of this function. </span><span class="kobospan" id="kobo.109.2">At the end of the indented </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.110.1">main()</span></span></span></span><span class="kobospan" id="kobo.111.1"> function, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.112.1">if</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.113.1"> __name__</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.114.1"> ==</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.115.1"> "__main__":</span></span></span></span><span class="kobospan" id="kobo.116.1"> block can be added. </span><span class="kobospan" id="kobo.116.2">Without creating a function that can be imported, the script is very difficult to test and integrate. </span><span id="x1-760006r1626"/></p>
</section>
<section data-number="0.17.1.2" id="how-to-do-it...-106">
<h2 class="likechapterhead" data-number="0.17.1.2"><span><span class="kobospan" id="kobo.117.1">14.1.2 </span></span> <span id="x1-7610002"/><span class="kobospan" id="kobo.118.1">How to do it...</span></h2>
<ol class="calibre2">
<li class="calibre7"><div id="x1-761002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.119.1">Import the other modules required:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.120.1">import argparse 
 
import contextlib 
 
import logging 
 
from pathlib import Path 
 
import sys</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-761010x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.121.1">Import the modules</span><span id="dx1-761011"/><span class="kobospan" id="kobo.122.1"> with the constituent applications. </span><span class="kobospan" id="kobo.122.2">This is generally done after all standard library modules:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.123.1">import markov_gen 
 
import markov_summ                                                                

                                                                     
     </span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-761016x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.124.1">Create a new function to combine the existing functions from the other applications. </span><span class="kobospan" id="kobo.124.2">We’re including the iteration in this function to meet the expectation of generating 1,000 sample files. </span><span class="kobospan" id="kobo.124.3">It looks like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.125.1">def gen_and_summ(iterations: int, samples: int) -&gt; None: 
 
    for i in range(iterations): 
 
        markov_gen.main( 
 
            [ 
 
                "--samples", str(samples), 
 
                "--randomize", str(i + 1), 
 
                "--output", f"data/ch14/markov_{i}.csv", 
 
            ] 
 
        ) 
 
    markov_summ.main()</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-761029x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.126.1">The overall problem statement has two parameters, with fixed values: the users would like 1,000 iterations of 1,000 samples. </span><span class="kobospan" id="kobo.126.2">This provides a large collection of large files to work with. </span><span class="kobospan" id="kobo.126.3">We can define command-line arguments with these values as defaults:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.127.1">def get_options(argv: list[str]) -&gt; argparse.Namespace: 
 
    parser = argparse.ArgumentParser(description="Markov Chain Generator and Summary") 
 
    parser.add_argument("-s", "--samples", type=int, default=1_000) 
 
    parser.add_argument("-i", "--iterations", type=int, default=10) 
 
    return parser.parse_args(argv)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.128.1">For more on how to use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.129.1">argparse</span></span></span></span><span class="kobospan" id="kobo.130.1"> module, see the recipes in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.131.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.132.1"> </span></span><a href="ch010.xhtml#x1-3300006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.133.1">6</span></span></a><span class="kobospan" id="kobo.134.1">.</span></p>
</div></li>
<li class="calibre7"><div id="x1-761037x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.135.1">The final report is sent to standard output, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.136.1">sys.stdout</span></span></span></span><span class="kobospan" id="kobo.137.1">, by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.138.1">print()</span></span></span></span><span class="kobospan" id="kobo.139.1"> function in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.140.1">markov_summ</span></span></span></span><span class="kobospan" id="kobo.141.1"> application. </span><span class="kobospan" id="kobo.141.2">This isn’t ideal, so we’ll use a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.142.1">contextlib</span></span></span></span><span class="kobospan" id="kobo.143.1"> context manager to redirect the output to a file:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.144.1">def main(argv: list[str] = sys.argv[1:]) -&gt; None: 
 
    options = get_options(argv) 
 
    target = Path.cwd() / "summary.md" 
 
    with target.open("w") as target_file: 
 
        with contextlib.redirect_stdout(target_file): 
 
            gen_and_summ(options.iterations, options.samples)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-761046x6" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.145.1">The combined functionality is now a new module with a function, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.146.1">main()</span></span></span></span><span class="kobospan" id="kobo.147.1">, that we can invoke from a block of code like the following:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.148.1">if __name__ == "__main__": 
 
    logging.basicConfig(stream=sys.stderr, level=logging.INFO) 
 
    main()</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.149.1">This gives us a combined</span><span id="dx1-761051"/><span class="kobospan" id="kobo.150.1"> application written entirely in Python. </span><span class="kobospan" id="kobo.150.2">We can write unit tests for this composite, as well as for each of the two steps that make up the overall application. </span><span id="x1-761052r1628"/></p>
</section>
<section data-number="0.17.1.3" id="how-it-works...-106">
<h2 class="likechapterhead" data-number="0.17.1.3"><span><span class="kobospan" id="kobo.151.1">14.1.3 </span></span> <span id="x1-7620003"/><span class="kobospan" id="kobo.152.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.153.1">The central feature of this design is importing useful functionality from existing, working, and tested modules. </span><span class="kobospan" id="kobo.153.2">This avoids the problems with copy-and-paste programming. </span><span class="kobospan" id="kobo.153.3">Copying code from one file and pasting it into another means that any change made to one is unlikely to be made to any of the copies. </span><span class="kobospan" id="kobo.153.4">As the various copies of a function slowly diverge, problems fixed in one place surface in another. </span><span class="kobospan" id="kobo.153.5">This phenomenon</span><span id="dx1-762001"/><span class="kobospan" id="kobo.154.1"> is sometimes called </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.155.1">code</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.156.1">rot</span></span><span class="kobospan" id="kobo.157.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.158.1">The copy-and-paste approach is made more complicated when a class or function does several things. </span><span class="kobospan" id="kobo.158.2">Too many features reduces the potential for reuse. </span><span class="kobospan" id="kobo.158.3">We summarize this as the Inverse Power Law of Reuse – the reusability of a class</span><span id="dx1-762002"/><span class="kobospan" id="kobo.159.1"> or function, </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.160.1">R</span></span><span class="kobospan" id="kobo.161.1">(</span><span class="cmti-10x-x"><span class="kobospan" id="kobo.162.1">c</span></span><span class="kobospan" id="kobo.163.1">), is related to the inverse of the number of features in that class or function, </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.164.1">F</span></span><span class="kobospan" id="kobo.165.1">(</span><span class="cmti-10x-x"><span class="kobospan" id="kobo.166.1">c</span></span><span class="kobospan" id="kobo.167.1">):</span></p>
<div class="math-display">
<span class="kobospan" id="kobo.168.1"><img alt=" 1 R (c) ∝ F-(c) " class="calibre9" src="../media/file79.png"/></span>
</div>
<p class="normal1"><span class="kobospan" id="kobo.169.1">The idea of counting features depends, of course, on the level of abstraction. </span><span class="kobospan" id="kobo.169.2">It can help to consider the processing that maps inputs to outputs. </span><span class="kobospan" id="kobo.169.3">Too many input-process-output mappings will limit reuse.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.170.1">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.171.1">SOLID </span></span><span class="kobospan" id="kobo.172.1">design principles provide guidance</span><span id="dx1-762003"/><span class="kobospan" id="kobo.173.1"> for keeping components small and narrowly focused. </span><span class="kobospan" id="kobo.173.2">These principles apply to applications as well as components. </span><span class="kobospan" id="kobo.173.3">In particular, the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.174.1">Single Responsibility Principle </span></span><span class="kobospan" id="kobo.175.1">suggests that an application</span><span id="dx1-762004"/><span class="kobospan" id="kobo.176.1"> should do one thing. </span><span class="kobospan" id="kobo.176.2">It’s better to have many small applications – like bricks – that can easily be combined than to have one large application</span><span id="dx1-762005"/><span class="kobospan" id="kobo.177.1"> that’s an imponderable big ball of mud. </span><span id="x1-762006r1635"/></p>
</section>
<section data-number="0.17.1.4" id="theres-more...-97">
<h2 class="likechapterhead" data-number="0.17.1.4"><span><span class="kobospan" id="kobo.178.1">14.1.4 </span></span> <span id="x1-7630004"/><span class="kobospan" id="kobo.179.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.180.1">We’ll look at two additional areas of rework of the application:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.181.1">Structure</span></span><span class="kobospan" id="kobo.182.1">: Using the top-level </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.183.1">main()</span></span></span></span><span class="kobospan" id="kobo.184.1"> function treats</span><span id="dx1-763001"/><span class="kobospan" id="kobo.185.1"> each component as an opaque container. </span><span class="kobospan" id="kobo.185.2">When trying to create a composite application, we may need to refactor the component modules to look for better organization of the features.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="cmbx-10x-x"><span class="kobospan" id="kobo.186.1">Logging</span></span><span class="kobospan" id="kobo.187.1">: When multiple applications</span><span id="dx1-763002"/><span class="kobospan" id="kobo.188.1"> are combined, the combined logging can become complicated. </span><span class="kobospan" id="kobo.188.2">To improve observability, we may need to refactor the logging.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.189.1">We’ll go through these in turn.</span></p>
<section data-number="0.17.1.4.1" id="structure">
<h3 class="likesubsubsectionhead" data-number="0.17.1.4.1"><span id="x1-7640004"/><span class="kobospan" id="kobo.190.1">Structure</span></h3>
<p class="normal"><span class="kobospan" id="kobo.191.1">In some cases, it becomes necessary</span><span id="dx1-764001"/><span class="kobospan" id="kobo.192.1"> to rearrange software to expose useful features. </span><span class="kobospan" id="kobo.192.2">For example, the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.193.1">main()</span></span></span></span><span class="kobospan" id="kobo.194.1"> function inside the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.195.1">markov_gen.py</span></span></span></span><span class="kobospan" id="kobo.196.1"> module relies on a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.197.1">write_samples()</span></span></span></span><span class="kobospan" id="kobo.198.1"> function. </span><span class="kobospan" id="kobo.198.2">This function creates a single file with the required number of samples, which are </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.199.1">(outcome,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.200.1"> chain)</span></span></span></span><span class="kobospan" id="kobo.201.1"> two-tuples.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.202.1">The input to the summary processing is a sequence of these </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.203.1">(outcome,</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.204.1"> chain)</span></span></span></span><span class="kobospan" id="kobo.205.1"> two-tuples. </span><span class="kobospan" id="kobo.205.2">The composite application doesn’t really need to process 1,000 separate files. </span><span class="kobospan" id="kobo.205.3">It needs to process 1,000 collections of 1,000 two-tuples.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.206.1">Doing the refactoring to expose this detail will make this feature available for the composite application. </span><span class="kobospan" id="kobo.206.2">This can make the composite easier to understand and maintain.</span></p>
</section>
<section data-number="0.17.1.4.2" id="logging">
<h3 class="likesubsubsectionhead" data-number="0.17.1.4.2"><span id="x1-7650004"/><span class="kobospan" id="kobo.207.1">Logging</span></h3>
<p class="normal"><span class="kobospan" id="kobo.208.1">In the </span><a href="ch017.xhtml#x1-7470006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.209.1">Using logging for control and audit output</span></span></a><span class="kobospan" id="kobo.210.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.211.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.212.1"> </span></span><a href="ch017.xhtml#x1-71500013" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.213.1">13</span></span></a><span class="kobospan" id="kobo.214.1">, we looked</span><span id="dx1-765001"/><span class="kobospan" id="kobo.215.1"> at how to use the logging module for control, audit, and error outputs. </span><span class="kobospan" id="kobo.215.2">When we build a composite application, we’ll have to combine the logging features from each of the original applications.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.216.1">The logging configuration for a composite application needs to be examined carefully. </span><span class="kobospan" id="kobo.216.2">If we don’t ensure that the logging configuration is done only once in the top-level application, then combining applications can lead to multiple, conflicting logging configurations. </span><span class="kobospan" id="kobo.216.3">There are two approaches that a composite application can follow:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.217.1">The composite application manages the logging configuration. </span><span class="kobospan" id="kobo.217.2">This may mean overwriting all previously defined loggers. </span><span class="kobospan" id="kobo.217.3">This is the default behavior and can be stated explicitly via </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.218.1">incremental</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.219.1"> =</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.220.1"> false</span></span></span></span><span class="kobospan" id="kobo.221.1"> in a TOML configuration document.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.222.1">The composite application can preserve other application loggers and merely modify the configuration. </span><span class="kobospan" id="kobo.222.2">This is not the default behavior and requires including </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.223.1">incremental</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.224.1"> =</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.225.1"> true</span></span></span></span><span class="kobospan" id="kobo.226.1"> in the TOML configuration document.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.227.1">The use of incremental configuration can be helpful when combining Python applications that don’t properly isolate the logging configuration into the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.228.1">__name__</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.229.1"> ==</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.230.1"> "__main__"</span></span></span></span><span class="kobospan" id="kobo.231.1"> block of code. </span><span class="kobospan" id="kobo.231.2">It’s often easier to refactor logging configuration to put it into the top-level block of code; this permits the composite</span><span id="dx1-765002"/><span class="kobospan" id="kobo.232.1"> application to more simply configure logging for all of the components. </span><span id="x1-765003r1636"/></p>
</section>
</section>
<section data-number="0.17.1.5" id="see-also-104">
<h2 class="likechapterhead" data-number="0.17.1.5"><span><span class="kobospan" id="kobo.233.1">14.1.5 </span></span> <span id="x1-7660005"/><span class="kobospan" id="kobo.234.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.235.1">In the </span><a href="ch017.xhtml#x1-7410005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.236.1">Designing scripts for composition</span></span></a><span class="kobospan" id="kobo.237.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.238.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.239.1"> </span></span><a href="ch017.xhtml#x1-71500013" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.240.1">13</span></span></a><span class="kobospan" id="kobo.241.1">, we looked at the core design pattern for a composable application.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.242.1">Books and articles on </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.243.1">Clean Architecture </span></span><span class="kobospan" id="kobo.244.1">and </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.245.1">Hexagonal</span></span> <span class="cmbx-10x-x"><span class="kobospan" id="kobo.246.1">Architecture </span></span><span class="kobospan" id="kobo.247.1">can be very helpful. </span><span class="kobospan" id="kobo.247.2">Titles on design patterns are also helpful, such as </span><a href="https://www.packtpub.com/en-de/product/mastering-python-design-patterns-9781837639618" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.248.1">Mastering Python Design Patterns – Third Edition</span></span></a><span class="kobospan" id="kobo.249.1">.</span></p></li>
</ul>
<p class="normal1"><span id="x1-766001r1623"/></p>
</section>
</section>
<section data-number="0.17.2" id="combining-many-applications-using-the-command-design-pattern">
<h1 class="unnumbered" data-number="0.17.2"><span><span class="kobospan" id="kobo.250.1">14.2 </span></span> <span id="x1-7670002"/><span class="kobospan" id="kobo.251.1">Combining many applications using the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.252.1">Command </span></span><span class="kobospan" id="kobo.253.1">design pattern</span></h1>
<p class="normal"><span class="kobospan" id="kobo.254.1">Many complex suites</span><span id="dx1-767001"/><span class="kobospan" id="kobo.255.1"> of applications follow a design</span><span id="dx1-767002"/><span class="kobospan" id="kobo.256.1"> pattern similar to the one used by the Git program. </span><span class="kobospan" id="kobo.256.2">There’s a base command, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.257.1">git</span></span></span></span><span class="kobospan" id="kobo.258.1">, with a number of subcommands. </span><span class="kobospan" id="kobo.258.2">These include </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.259.1">git</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.260.1"> pull</span></span></span></span><span class="kobospan" id="kobo.261.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.262.1">git</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.263.1"> commit</span></span></span></span><span class="kobospan" id="kobo.264.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.265.1">git</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.266.1"> push</span></span></span></span><span class="kobospan" id="kobo.267.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.268.1">What’s central to this design is the idea of a collection of individual commands under a common parent command. </span><span class="kobospan" id="kobo.268.2">Each of the various features of Git can be thought of as a separate subclass definition that performs a given function. </span><span id="x1-767003r1639"/></p>
<section data-number="0.17.2.1" id="getting-ready-106">
<h2 class="likechapterhead" data-number="0.17.2.1"><span><span class="kobospan" id="kobo.269.1">14.2.1 </span></span> <span id="x1-7680001"/><span class="kobospan" id="kobo.270.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.271.1">We’ll build a composite application from two commands. </span><span class="kobospan" id="kobo.271.2">This is based on the </span><a href="ch018.xhtml#x1-7590001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.272.1">Combining two applications into one</span></span></a><span class="kobospan" id="kobo.273.1"> recipe from earlier in this chapter.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.274.1">These features are based on modules with names such as </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.275.1">markov_gen</span></span></span></span><span class="kobospan" id="kobo.276.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.277.1">markov_summ</span></span></span></span><span class="kobospan" id="kobo.278.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.279.1">markov_analysis</span></span></span></span><span class="kobospan" id="kobo.280.1">. </span><span class="kobospan" id="kobo.280.2">The idea is that we can restructure separate modules into a single class hierarchy following the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.281.1">Command </span></span><span class="kobospan" id="kobo.282.1">design pattern.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.283.1">There are two key ingredients to this design pattern:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-768002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.284.1">A client class depends only on the methods of the abstract superclass, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.285.1">Command</span></span></span></span><span class="kobospan" id="kobo.286.1">.</span></p>
</div></li>
<li class="calibre7"><div id="x1-768004x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.287.1">Each individual subclass of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.288.1">Command</span></span></span></span><span class="kobospan" id="kobo.289.1"> superclass has an identical interface. </span><span class="kobospan" id="kobo.289.2">We can substitute any one of them for any other.</span></p>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.290.1">An overall application script can then create and execute any one of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.291.1">Command</span></span></span></span><span class="kobospan" id="kobo.292.1"> subclasses.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.293.1">Note that </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.294.1">any </span></span><span class="kobospan" id="kobo.295.1">feature that can be wrapped into a class is a candidate for this design. </span><span class="kobospan" id="kobo.295.2">Consequently, some rework to create a single </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.296.1">Facade </span></span><span class="kobospan" id="kobo.297.1">class is sometimes</span><span id="dx1-768005"/><span class="kobospan" id="kobo.298.1"> required for sprawling, poorly designed applications. </span><span id="x1-768006r1641"/></p>
</section>
<section data-number="0.17.2.2" id="how-to-do-it...-107">
<h2 class="likechapterhead" data-number="0.17.2.2"><span><span class="kobospan" id="kobo.299.1">14.2.2 </span></span> <span id="x1-7690002"/><span class="kobospan" id="kobo.300.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.301.1">We’ll start by creating a superclass</span><span id="dx1-769001"/><span class="kobospan" id="kobo.302.1"> for all of the related</span><span id="dx1-769002"/><span class="kobospan" id="kobo.303.1"> commands. </span><span class="kobospan" id="kobo.303.2">We’ll then extend that superclass for the subcommands that are part of the overall application.</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-769004x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.304.1">Here’s the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.305.1">Command</span></span></span></span><span class="kobospan" id="kobo.306.1"> superclass:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.307.1">import argparse 
 
 
 
class Command: 
 
    def __init__(self) -&gt; None: 
 
        pass 
 
 
 
    def execute(self, options: argparse.Namespace) -&gt; None: 
 
        pass                                                                

                                                                     
     </span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.308.1">It helps to rely on </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.309.1">argparse.Namespace</span></span></span></span><span class="kobospan" id="kobo.310.1"> to provide a very flexible collection of options and arguments to each subclass.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.311.1">We’ll use this also in the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.312.1">Managing arguments and configuration in</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.313.1">composite applications </span></span><span class="kobospan" id="kobo.314.1">recipe in this chapter.</span></p>
</div></li>
<li class="calibre7"><div id="x1-769015x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.315.1">Create a subclass of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.316.1">Command</span></span></span></span><span class="kobospan" id="kobo.317.1"> superclass for the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.318.1">Generate</span></span></span></span><span class="kobospan" id="kobo.319.1"> class. </span><span class="kobospan" id="kobo.319.2">This will wrap the processing and output from the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.320.1">example</span></span></span></span><span class="kobospan" id="kobo.321.1"> module in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.322.1">execute()</span></span></span></span><span class="kobospan" id="kobo.323.1"> method of this class:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.324.1">from pathlib import Path 
 
from typing import Any 
 
import markov_gen 
 
 
 
class Generate(Command): 
 
    def __init__(self) -&gt; None: 
 
        super().__init__() 
 
        self.seed: Any | None = None 
 
        self.output: Path 
 
 
 
    def execute(self, options: argparse.Namespace) -&gt; None: 
 
        self.output = Path(options.output) 
 
        with self.output.open("w") as target: 
 
            markov_gen.write_samples(target, options) 
 
        print(f"Created {str(self.output)}")</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-769033x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.325.1">Create a subclass</span><span id="dx1-769034"/><span class="kobospan" id="kobo.326.1"> of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.327.1">Command</span></span></span></span><span class="kobospan" id="kobo.328.1"> superclass</span><span id="dx1-769035"/><span class="kobospan" id="kobo.329.1"> for the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.330.1">Summarize</span></span></span></span><span class="kobospan" id="kobo.331.1"> class. </span><span class="kobospan" id="kobo.331.2">For this class, we’ve wrapped the file creation and file processing into the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.332.1">execute()</span></span></span></span><span class="kobospan" id="kobo.333.1"> method of the class:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.334.1">import contextlib 
 
import markov_summ_2 
 
 
 
class Summarize(Command): 
 
    def execute(self, options: argparse.Namespace) -&gt; None: 
 
        self.summary_path = Path(options.summary_file) 
 
        with self.summary_path.open("w") as result_file: 
 
            output_paths = [Path(f) for f in options.output_files] 
 
            outcomes, lengths = markov_summ_2.process_files(output_paths) 
 
            with contextlib.redirect_stdout(result_file): 
 
                markov_summ_2.write_report(outcomes, lengths)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-769049x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.335.1">The overall composite processing can be performed by the following </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.336.1">main()</span></span></span></span><span class="kobospan" id="kobo.337.1"> function:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.338.1">def main() -&gt; None: 
 
    options_1 = argparse.Namespace(samples=1000, output="data/x.csv") 
 
    command1 = Generate() 
 
    command1.execute(options_1) 
 
 
 
    options_2 = argparse.Namespace( 
 
        summary_file="data/report.md", output_files=["data/x.csv"] 
 
    ) 
 
    command2 = Summarize() 
 
    command2.execute(options_2)</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.339.1">We’ve created two commands: one is an instance of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.340.1">Generate</span></span></span></span><span class="kobospan" id="kobo.341.1"> class, and the other is an instance of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.342.1">Summarize</span></span></span></span><span class="kobospan" id="kobo.343.1"> class. </span><span class="kobospan" id="kobo.343.2">These commands can be executed to provide a combined feature that both generates and summarizes data. </span><span id="x1-769061r1642"/></p>
</section>
<section data-number="0.17.2.3" id="how-it-works...-107">
<h2 class="likechapterhead" data-number="0.17.2.3"><span><span class="kobospan" id="kobo.344.1">14.2.3 </span></span> <span id="x1-7700003"/><span class="kobospan" id="kobo.345.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.346.1">Creating interchangeable, polymorphic classes</span><span id="dx1-770001"/><span class="kobospan" id="kobo.347.1"> for the various subcommands</span><span id="dx1-770002"/><span class="kobospan" id="kobo.348.1"> is a handy way to provide an extensible design. </span><span class="kobospan" id="kobo.348.2">The </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.349.1">Command </span></span><span class="kobospan" id="kobo.350.1">design pattern strongly encourages each individual subclass to have an identical signature. </span><span class="kobospan" id="kobo.350.2">Doing this makes it easier for the command subclasses to be created and executed. </span><span class="kobospan" id="kobo.350.3">Also, new commands can be added that fit this pattern.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.351.1">One of the SOLID design</span><span id="dx1-770003"/><span class="kobospan" id="kobo.352.1"> principles is the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.353.1">Liskov Substitution Principle</span></span><span class="kobospan" id="kobo.354.1"> (</span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.355.1">LSP</span></span><span class="kobospan" id="kobo.356.1">). </span><span class="kobospan" id="kobo.356.2">It suggests any of the subclasses of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.357.1">Command</span></span></span></span><span class="kobospan" id="kobo.358.1"> abstract class can be used in place of the parent class.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.359.1">Each </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.360.1">Command</span></span></span></span><span class="kobospan" id="kobo.361.1"> instance has a consistent interface. </span><span class="kobospan" id="kobo.361.2">The use of the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.362.1">Command</span></span><span class="kobospan" id="kobo.363.1"> design pattern makes it easy to be sure that </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.364.1">Command</span></span></span></span><span class="kobospan" id="kobo.365.1"> subclasses can be interchanged with each other. </span><span class="kobospan" id="kobo.365.2">The overall </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.366.1">main()</span></span></span></span><span class="kobospan" id="kobo.367.1"> script can create instances of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.368.1">Generate</span></span></span></span><span class="kobospan" id="kobo.369.1"> or </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.370.1">Summarize</span></span></span></span><span class="kobospan" id="kobo.371.1"> classes. </span><span class="kobospan" id="kobo.371.2">The substitution principle means that either instance can be executed because the interfaces are the same. </span><span class="kobospan" id="kobo.371.3">This flexibility makes it easy to parse the command-line options and create an instance of either of the available classes. </span><span class="kobospan" id="kobo.371.4">We can extend this idea and create sequences of individual command instances. </span><span id="x1-770004r1647"/></p>
</section>
<section data-number="0.17.2.4" id="theres-more...-98">
<h2 class="likechapterhead" data-number="0.17.2.4"><span><span class="kobospan" id="kobo.372.1">14.2.4 </span></span> <span id="x1-7710004"/><span class="kobospan" id="kobo.373.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.374.1">One of the more common extensions to this design pattern is to provide for composite commands. </span><span class="kobospan" id="kobo.374.2">In the </span><a href="ch018.xhtml#x1-7590001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.375.1">Combining two applications into one</span></span></a><span class="kobospan" id="kobo.376.1"> recipe, we showed one way to create composites. </span><span class="kobospan" id="kobo.376.2">This is another</span><span id="dx1-771001"/><span class="kobospan" id="kobo.377.1"> way, based on defining a new </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.378.1">Command</span></span></span></span><span class="kobospan" id="kobo.379.1"> class that implements a combination of existing </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.380.1">Command</span></span></span></span><span class="kobospan" id="kobo.381.1"> class instances:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.382.1">class CmdSequence(Command): 
 
    def __init__(self, *commands: type[Command]) -&gt; None: 
 
        super().__init__() 
 
        self.commands = [command() for command in commands] 
 
 
 
    def execute(self, options: argparse.Namespace) -&gt; None: 
 
        for command in self.commands: 
 
            command.execute(options)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.383.1">This class will accept other </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.384.1">Command</span></span></span></span><span class="kobospan" id="kobo.385.1"> classes via the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.386.1">*commands</span></span></span></span><span class="kobospan" id="kobo.387.1"> parameter. </span><span class="kobospan" id="kobo.387.2">From the classes, it will build the individual class instances.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.388.1">We might use this </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.389.1">CmdSequence</span></span></span></span><span class="kobospan" id="kobo.390.1"> class like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.391.1">&gt;&gt;&gt; from argparse import Namespace 
 
&gt;&gt;&gt; options = Namespace( 
 
... </span><span class="kobospan" id="kobo.391.2">    samples=1_000, 
 
... </span><span class="kobospan" id="kobo.391.3">    randomize=42, 
 
... </span><span class="kobospan" id="kobo.391.4">    output="data/x.csv", 
 
... </span><span class="kobospan" id="kobo.391.5">    summary_file="data/y.md", 
 
... </span><span class="kobospan" id="kobo.391.6">    output_files=["data/x.csv"] 
 
... </span><span class="kobospan" id="kobo.391.7">) 
 
 
 
&gt;&gt;&gt; both_command = CmdSequence(Generate, Summarize) 
 
&gt;&gt;&gt; both_command.execute(options) 
 
Created data/x.csv</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.392.1">This design exposes some implementation</span><span id="dx1-771024"/><span class="kobospan" id="kobo.393.1"> details. </span><span class="kobospan" id="kobo.393.2">In particular, the two class names and the intermediate </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.394.1">x.csv</span></span></span></span><span class="kobospan" id="kobo.395.1"> file are details that seem superfluous.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.396.1">We can create a slightly nicer subclass of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.397.1">CmdSequence</span></span></span></span><span class="kobospan" id="kobo.398.1"> argument if we focus specifically on the two commands being combined. </span><span class="kobospan" id="kobo.398.2">This will have an </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.399.1">__init__()</span></span></span></span><span class="kobospan" id="kobo.400.1"> method that follows the pattern of other </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.401.1">Command</span></span></span></span><span class="kobospan" id="kobo.402.1"> subclasses:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.403.1">class GenSumm(CmdSequence): 
 
    def __init__(self) -&gt; None: 
 
        super().__init__(Generate, Summarize) 
 
 
 
    def execute(self, options: argparse.Namespace) -&gt; None: 
 
        self.intermediate = Path("data") / "ch14_r02_temporary.toml" 
 
        new_namespace = argparse.Namespace( 
 
            output=str(self.intermediate), 
 
            output_files=[str(self.intermediate)], 
 
            **vars(options), 
 
        ) 
 
        super().execute(new_namespace)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.404.1">This class definition incorporates two other classes into the already defined </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.405.1">CmdSequence</span></span></span></span><span class="kobospan" id="kobo.406.1"> class structure. </span><span class="kobospan" id="kobo.406.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.407.1">super().__init__()</span></span></span></span><span class="kobospan" id="kobo.408.1"> expression invokes the parent class initialization with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.409.1">Generate</span></span></span></span><span class="kobospan" id="kobo.410.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.411.1">Summarize</span></span></span></span><span class="kobospan" id="kobo.412.1"> classes as argument values.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.413.1">This provides a composite application</span><span id="dx1-771038"/><span class="kobospan" id="kobo.414.1"> definition that conceals the details of how a file is used to pass data from the first step to a subsequent step. </span><span class="kobospan" id="kobo.414.2">This is purely a feature of the composite integration and doesn’t lead to any changes in either of the original applications that form the composite. </span><span id="x1-771039r1648"/></p>
</section>
<section data-number="0.17.2.5" id="see-also-105">
<h2 class="likechapterhead" data-number="0.17.2.5"><span><span class="kobospan" id="kobo.415.1">14.2.5 </span></span> <span id="x1-7720005"/><span class="kobospan" id="kobo.416.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.417.1">In the </span><a href="ch017.xhtml#x1-7410005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.418.1">Designing scripts for composition</span></span></a><span class="kobospan" id="kobo.419.1"> and </span><a href="ch017.xhtml#x1-7470006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.420.1">Using logging for control</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.421.1">and audit output</span></span></a><span class="kobospan" id="kobo.422.1"> recipes in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.423.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.424.1"> </span></span><a href="ch017.xhtml#x1-71500013" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.425.1">13</span></span></a><span class="kobospan" id="kobo.426.1">, we looked at the constituent parts of this composite application.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.427.1">In the </span><a href="ch018.xhtml#x1-7590001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.428.1">Combining two applications into one</span></span></a><span class="kobospan" id="kobo.429.1"> recipe earlier in this chapter, we looked at the constituent parts of this composite application. </span><span class="kobospan" id="kobo.429.2">In most cases, we’ll need to combine elements of all of these recipes to create a useful application.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.430.1">We’ll often need to follow the </span><a href="ch018.xhtml#x1-7730003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.431.1">Managing arguments and configuration</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.432.1">in composite applications</span></span></a><span class="kobospan" id="kobo.433.1"> recipe, which comes next in this chapter.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.434.1">For other advanced design patterns, see </span><a href="https://www.packtpub.com/en-de/product/mastering-python-design-patterns-9781837639618" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.435.1">Mastering Python Design</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.436.1">Patterns – Third Edition</span></span></a><span class="kobospan" id="kobo.437.1">.</span></p></li>
</ul>
<p class="normal1"><span id="x1-772001r1640"/></p>
</section>
</section>
<section data-number="0.17.3" id="managing-arguments-and-configuration-in-composite-applications">
<h1 class="unnumbered" data-number="0.17.3"><span><span class="kobospan" id="kobo.438.1">14.3 </span></span> <span id="x1-7730003"/><span class="kobospan" id="kobo.439.1">Managing arguments and configuration in composite applications</span></h1>
<p class="normal"><span class="kobospan" id="kobo.440.1">When we have a complex</span><span id="dx1-773001"/><span class="kobospan" id="kobo.441.1"> suite (or system) of individual</span><span id="dx1-773002"/><span class="kobospan" id="kobo.442.1"> applications, they</span><span id="dx1-773003"/><span class="kobospan" id="kobo.443.1"> may share</span><span id="dx1-773004"/><span class="kobospan" id="kobo.444.1"> common features. </span><span class="kobospan" id="kobo.444.2">The coordination of common features among many applications can become awkward. </span><span class="kobospan" id="kobo.444.3">As a concrete example, imagine defining the various one-letter abbreviated options for command-line arguments. </span><span class="kobospan" id="kobo.444.4">We might want all of our applications to use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.445.1">-v</span></span></span></span><span class="kobospan" id="kobo.446.1"> option for verbose output. </span><span class="kobospan" id="kobo.446.2">Ensuring that there are no conflicts among all the applications might require keeping some kind of master list of all options.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.447.1">This kind of common configuration should be kept in only one place. </span><span class="kobospan" id="kobo.447.2">Ideally, it would be in a common module, used throughout a family of applications.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.448.1">Additionally, we often want to divorce the modules that perform useful work from the CLI. </span><span class="kobospan" id="kobo.448.2">This lets us refactor the internal software design without changing the user’s understanding of how to use the application.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.449.1">In this recipe, we’ll look at ways to ensure that a suite of applications can be refactored without creating unexpected changes to the CLI. </span><span id="x1-773005r1652"/></p>
<section data-number="0.17.3.1" id="getting-ready-107">
<h2 class="likechapterhead" data-number="0.17.3.1"><span><span class="kobospan" id="kobo.450.1">14.3.1 </span></span> <span id="x1-7740001"/><span class="kobospan" id="kobo.451.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.452.1">We’ll imagine an application suite built from three commands. </span><span class="kobospan" id="kobo.452.2">This is based on the applications shown in the </span><a href="ch018.xhtml#x1-7590001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.453.1">Combining two applications into one</span></span></a><span class="kobospan" id="kobo.454.1"> recipe earlier in this chapter. </span><span class="kobospan" id="kobo.454.2">We’ll have a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.455.1">markov</span></span></span></span><span class="kobospan" id="kobo.456.1"> application with three subcommands: </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.457.1">markov</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.458.1"> generate</span></span></span></span><span class="kobospan" id="kobo.459.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.460.1">markov</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.461.1"> summarize</span></span></span></span><span class="kobospan" id="kobo.462.1">, and the combined application, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.463.1">markov</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.464.1"> gensumm</span></span></span></span><span class="kobospan" id="kobo.465.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.466.1">We’ll rely on the subcommand design from the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.467.1">Combining many applications</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.468.1">using the Command design pattern </span></span><span class="kobospan" id="kobo.469.1">recipe earlier in this chapter. </span><span class="kobospan" id="kobo.469.2">This will provide a handy hierarchy of </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.470.1">Command</span></span></span></span><span class="kobospan" id="kobo.471.1"> subclasses:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.472.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.473.1">Command</span></span></span></span><span class="kobospan" id="kobo.474.1"> class is an abstract superclass.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.475.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.476.1">Generate</span></span></span></span><span class="kobospan" id="kobo.477.1"> subclass performs the chain-generating functions from </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.478.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.479.1"> </span></span><a href="ch017.xhtml#x1-71500013" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.480.1">13</span></span></a><span class="kobospan" id="kobo.481.1"> recipe the </span><a href="ch017.xhtml#x1-7410005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.482.1">Designing scripts for composition</span></span></a><span class="kobospan" id="kobo.483.1"> recipe.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.484.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.485.1">Summarize</span></span></span></span><span class="kobospan" id="kobo.486.1"> subclass performs summarizing functions from </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.487.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.488.1"> </span></span><a href="ch017.xhtml#x1-71500013" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.489.1">13</span></span></a><span class="kobospan" id="kobo.490.1"> recipe the </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.491.1">Using logging for control and audit output</span></span><span class="kobospan" id="kobo.492.1"> recipe.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.493.1">A </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.494.1">GenSumm</span></span></span></span><span class="kobospan" id="kobo.495.1"> subclass can perform combined chain generation and summarization, following the ideas of the </span><a href="ch018.xhtml#x1-7670002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.496.1">Combining many</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.497.1">applications using the </span></span><span class="cmbxti-10x-x"><span class="kobospan" id="kobo.498.1">Command </span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.499.1">design pattern</span></span></a><span class="kobospan" id="kobo.500.1"> recipe.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.501.1">In order to create a simple command-line application, we’ll need appropriate argument parsing. </span><span class="kobospan" id="kobo.501.2">For more on argument parsing, see </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.502.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.503.1"> </span></span><a href="ch010.xhtml#x1-3300006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.504.1">6</span></span></a><span class="kobospan" id="kobo.505.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.506.1">This argument parsing</span><span id="dx1-774001"/><span class="kobospan" id="kobo.507.1"> will rely</span><span id="dx1-774002"/><span class="kobospan" id="kobo.508.1"> on the subcommand-parsing capability</span><span id="dx1-774003"/><span class="kobospan" id="kobo.509.1"> of the</span><span id="dx1-774004"/><span class="kobospan" id="kobo.510.1"> built-in </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.511.1">argparse</span></span></span></span><span class="kobospan" id="kobo.512.1"> module. </span><span class="kobospan" id="kobo.512.2">We can create a common set of command options that apply to all subcommands. </span><span class="kobospan" id="kobo.512.3">We can also create unique options for each of the distinct subcommands. </span><span id="x1-774005r1654"/></p>
</section>
<section data-number="0.17.3.2" id="how-to-do-it...-108">
<h2 class="likechapterhead" data-number="0.17.3.2"><span><span class="kobospan" id="kobo.513.1">14.3.2 </span></span> <span id="x1-7750002"/><span class="kobospan" id="kobo.514.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.515.1">This recipe will start with a consideration of what the CLI commands need to look like. </span><span class="kobospan" id="kobo.515.2">A first release often involves some prototypes or examples to be sure that the commands are truly useful to the user. </span><span class="kobospan" id="kobo.515.3">After learning the user’s preferences, we can change how we implement the argument definitions in each of the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.516.1">Command </span></span><span class="kobospan" id="kobo.517.1">subclasses.</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-775002x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.518.1">Define the CLI. </span><span class="kobospan" id="kobo.518.2">This is</span><span id="dx1-775003"/><span class="kobospan" id="kobo.519.1"> an exercise in </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.520.1">User Experience </span></span><span class="kobospan" id="kobo.521.1">(</span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.522.1">UX</span></span><span class="kobospan" id="kobo.523.1">) design. </span><span class="kobospan" id="kobo.523.2">While a great deal of UX design is focused on web and mobile device applications, the core principles are appropriate for CLI applications as well. </span><span class="kobospan" id="kobo.523.3">Earlier, we noted that the root application will be called </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.524.1">markov</span></span></span></span><span class="kobospan" id="kobo.525.1">. </span><span class="kobospan" id="kobo.525.2">It will have the following three subcommands:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.526.1">markov generate -o detail_file.csv -s samples 
 
markov summarize -o summary_file.md detail_file.csv ... 
 
 
 
markov gensumm -g samples</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.527.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.528.1">gensumm</span></span></span></span><span class="kobospan" id="kobo.529.1"> command combines the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.530.1">generate</span></span></span></span><span class="kobospan" id="kobo.531.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.532.1">summarize</span></span></span></span><span class="kobospan" id="kobo.533.1"> commands into a single operation that does both.</span></p>
</div></li>
<li class="calibre7"><div id="x1-775010x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.534.1">Define the root Python application. </span><span class="kobospan" id="kobo.534.2">We’ll call it </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.535.1">markov.py</span></span></span></span><span class="kobospan" id="kobo.536.1">. </span><span class="kobospan" id="kobo.536.2">It’s common to have a package </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.537.1">__main__.py</span></span></span></span><span class="kobospan" id="kobo.538.1"> file that contains the application. </span><span class="kobospan" id="kobo.538.2">It’s often simpler to use an OS alias to provide the UX name.</span></p>
</div></li>
<li class="calibre7"><div id="x1-775012x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.539.1">We’ll import the class definitions from the </span><a href="ch018.xhtml#x1-7670002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.540.1">Combining many</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.541.1">applications using the </span></span><span class="cmbxti-10x-x"><span class="kobospan" id="kobo.542.1">Command </span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.543.1">design pattern</span></span></a><span class="kobospan" id="kobo.544.1"> recipe. </span><span class="kobospan" id="kobo.544.2">This will include the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.545.1">Command</span></span></span></span><span class="kobospan" id="kobo.546.1"> superclass and the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.547.1">Generate</span></span></span></span><span class="kobospan" id="kobo.548.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.549.1">Summarize</span></span></span></span><span class="kobospan" id="kobo.550.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.551.1">GenSumm</span></span></span></span><span class="kobospan" id="kobo.552.1"> subclasses. </span><span class="kobospan" id="kobo.552.2">We’ll extend the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.553.1">Command</span></span></span></span><span class="kobospan" id="kobo.554.1"> class with an additional method, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.555.1">arguments()</span></span></span></span><span class="kobospan" id="kobo.556.1">, to set the unique options in the argument parser for this command. </span><span class="kobospan" id="kobo.556.2">This is a class method and is called on the class as a whole, not an instance of the class:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.557.1">class Command: 
 
    @classmethod 
 
    def arguments( 
 
            cls, 
 
            sub_parser: argparse.ArgumentParser 
 
    ) -&gt; None: 
 
        pass 
 
 
 
    def __init__(self) -&gt; None: 
 
        pass 
 
 
 
    def execute(self, options: argparse.Namespace) -&gt; None: 
 
        pass</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-775028x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.558.1">Here are the unique options</span><span id="dx1-775029"/><span class="kobospan" id="kobo.559.1"> for the generate</span><span id="dx1-775030"/><span class="kobospan" id="kobo.560.1"> subcommand. </span><span class="kobospan" id="kobo.560.2">We won’t repeat</span><span id="dx1-775031"/><span class="kobospan" id="kobo.561.1"> the entire class</span><span id="dx1-775032"/><span class="kobospan" id="kobo.562.1"> definition, only the new </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.563.1">arguments()</span></span></span></span><span class="kobospan" id="kobo.564.1"> method. </span><span class="kobospan" id="kobo.564.2">This creates arguments that are unique to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.565.1">markov</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.566.1"> generate</span></span></span></span><span class="kobospan" id="kobo.567.1"> subcommand:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.568.1">class Generate(Command): 
 
    @classmethod 
 
    def arguments( 
 
            cls, 
 
            generate_parser: argparse.ArgumentParser 
 
    ) -&gt; None: 
 
        default_seed = os.environ.get("RANDOMSEED", "0") 
 
        generate_parser.add_argument( 
 
            "-s", "--samples", type=int, default=1_000) 
 
        generate_parser.add_argument( 
 
            "-o", "--output", dest="output") 
 
        generate_parser.add_argument( 
 
            "-r", "--randomize", default=default_seed) 
 
        generate_parser.set_defaults(command=cls)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-775049x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.569.1">Here is the new </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.570.1">arguments()</span></span></span></span><span class="kobospan" id="kobo.571.1"> method of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.572.1">Summarize</span></span></span></span><span class="kobospan" id="kobo.573.1"> subcommand:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.574.1">class Summarize(Command): 
 
    @classmethod 
 
    def arguments( 
 
            cls, 
 
            summarize_parser: argparse.ArgumentParser 
 
    ) -&gt; None: 
 
        summarize_parser.add_argument( 
 
            "-o", "--output", dest="summary_file") 
 
        summarize_parser.add_argument( 
 
            "output_files", nargs="*", type=Path) 
 
        summarize_parser.set_defaults(command=cls)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-775063x6" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.575.1">Here is</span><span id="dx1-775064"/><span class="kobospan" id="kobo.576.1"> the new </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.577.1">arguments()</span></span></span></span><span class="kobospan" id="kobo.578.1"> method</span><span id="dx1-775065"/><span class="kobospan" id="kobo.579.1"> for the composite</span><span id="dx1-775066"/><span class="kobospan" id="kobo.580.1"> command, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.581.1">GenSumm</span></span></span></span><span class="kobospan" id="kobo.582.1">:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.583.1">class GenSumm(Command): 
 
    @classmethod 
 
    def arguments( 
 
            cls, 
 
            gensumm_parser: argparse.ArgumentParser 
 
    ) -&gt; None: 
 
        default_seed = os.environ.get("RANDOMSEED", "0") 
 
        gensumm_parser.add_argument( 
 
            "-s", "--samples", type=int, default=1_000) 
 
        gensumm_parser.add_argument( 
 
            "-o", "--output", dest="summary_file.md") 
 
        gensumm_parser.add_argument( 
 
            "-r", "--randomize", default=default_seed) 
 
        gensumm_parser.set_defaults(command=cls)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-775083x7" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.584.1">Create the overall argument parser. </span><span class="kobospan" id="kobo.584.2">Use this to create a subparser builder. </span><span class="kobospan" id="kobo.584.3">For each subcommand, create a subparser and add arguments that are unique to that command:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.585.1">import argparse 
 
 
 
def get_options( 
 
        argv: list[str] 
 
) -&gt; argparse.Namespace: 
 
    parser = argparse.ArgumentParser(prog="Markov") 
 
    subparsers = parser.add_subparsers() 
 
    generate_parser = subparsers.add_parser("generate") 
 
    Generate.arguments(generate_parser) 
 
 
 
    summarize_parser = subparsers.add_parser("summarize") 
 
    Summarize.arguments(summarize_parser) 
 
    gensumm_parser = subparsers.add_parser("gensumm") 
 
    GenSumm.arguments(gensumm_parser)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-775100x8" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.586.1">Parse the command-line values. </span><span class="kobospan" id="kobo.586.2">In most</span><span id="dx1-775101"/><span class="kobospan" id="kobo.587.1"> cases, the argument</span><span id="dx1-775102"/><span class="kobospan" id="kobo.588.1"> definitions</span><span id="dx1-775103"/><span class="kobospan" id="kobo.589.1"> include validation rules. </span><span class="kobospan" id="kobo.589.2">In this case, there’s an additional validation check to make sure a command was provided. </span><span class="kobospan" id="kobo.589.3">Here are the final parsing and validating steps:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.590.1">    options = parser.parse_args(argv) 
 
    if "command" not in options: 
 
        parser.error("No command selected") 
 
    return options</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.591.1">The overall parser includes three subcommand parsers. </span><span class="kobospan" id="kobo.591.2">One will handle the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.592.1">markov</span></span></span></span> <span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.593.1">generate</span></span></span></span><span class="kobospan" id="kobo.594.1"> command, another handles </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.595.1">markov</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.596.1"> summarize</span></span></span></span><span class="kobospan" id="kobo.597.1">, and the third handles a combined </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.598.1">markov</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.599.1"> gensumm</span></span></span></span><span class="kobospan" id="kobo.600.1">. </span><span class="kobospan" id="kobo.600.2">Each subcommand has slightly different combinations of options.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.601.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.602.1">command</span></span></span></span><span class="kobospan" id="kobo.603.1"> option is set via the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.604.1">set_defaults()</span></span></span></span><span class="kobospan" id="kobo.605.1"> method. </span><span class="kobospan" id="kobo.605.2">This also provides useful additional information about the command to be executed. </span><span class="kobospan" id="kobo.605.3">In this case, we’ve provided the class that must be instantiated.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.606.1">The overall application is defined by the following </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.607.1">main()</span></span></span></span><span class="kobospan" id="kobo.608.1"> function:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.609.1">from typing import cast 
 
def main(argv: list[str] = sys.argv[1:]) -&gt; None: 
 
    options = get_options(argv) 
 
    command = cast(type[Command], options.command)() 
 
    command.execute(options)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.610.1">The resulting object will have an </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.611.1">execute()</span></span></span></span><span class="kobospan" id="kobo.612.1"> method that does the real work of this command. </span><span id="x1-775117r1655"/></p>
</section>
<section data-number="0.17.3.3" id="how-it-works...-108">
<h2 class="likechapterhead" data-number="0.17.3.3"><span><span class="kobospan" id="kobo.613.1">14.3.3 </span></span> <span id="x1-7760003"/><span class="kobospan" id="kobo.614.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.615.1">There are</span><span id="dx1-776001"/><span class="kobospan" id="kobo.616.1"> two parts</span><span id="dx1-776002"/><span class="kobospan" id="kobo.617.1"> to this</span><span id="dx1-776003"/><span class="kobospan" id="kobo.618.1"> recipe:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.619.1">Using the </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.620.1">Command </span></span><span class="kobospan" id="kobo.621.1">design pattern to define a related set</span><span id="dx1-776004"/><span class="kobospan" id="kobo.622.1"> of classes that</span><span id="dx1-776005"/><span class="kobospan" id="kobo.623.1"> are polymorphic. </span><span class="kobospan" id="kobo.623.2">For more information on this, see the </span><a href="ch018.xhtml#x1-7670002" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.624.1">Combining</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.625.1">many applications using the </span></span><span class="cmbxti-10x-x"><span class="kobospan" id="kobo.626.1">Command </span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.627.1">design pattern</span></span></a><span class="kobospan" id="kobo.628.1"> recipe.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.629.1">Using features of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.630.1">argparse</span></span></span></span><span class="kobospan" id="kobo.631.1"> module to handle subcommands.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.632.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.633.1">argparse</span></span></span></span><span class="kobospan" id="kobo.634.1"> module feature that’s important here is the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.635.1">add_subparsers()</span></span></span></span><span class="kobospan" id="kobo.636.1"> method of a parser. </span><span class="kobospan" id="kobo.636.2">This method returns an object to build each distinct subcommand parser. </span><span class="kobospan" id="kobo.636.3">We assigned this object to the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.637.1">subparsers</span></span></span></span><span class="kobospan" id="kobo.638.1"> variable.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.639.1">We also used the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.640.1">set_defaults()</span></span></span></span><span class="kobospan" id="kobo.641.1"> method of a parser to add a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.642.1">command</span></span></span></span><span class="kobospan" id="kobo.643.1"> argument to each of the subparsers. </span><span class="kobospan" id="kobo.643.2">This argument will be populated by the defaults defined for one of the subparsers. </span><span class="kobospan" id="kobo.643.3">The value assigned by the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.644.1">set_defaults()</span></span></span></span><span class="kobospan" id="kobo.645.1"> method actually used will show which of the subcommands was invoked.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.646.1">Consider the following OS command:</span></p>
<pre class="programlisting" id="listing-85"><code class="calibre13"><span class="kobospan" id="kobo.647.1">(cookbook3) % markov generate -s 100 -o x.csv</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.648.1">This command will be parsed to create a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.649.1">Namespace</span></span></span></span><span class="kobospan" id="kobo.650.1"> object that looks like this:</span></p>
<pre class="programlisting" id="listing-86"><code class="calibre13"><span class="kobospan" id="kobo.651.1">Namespace(command=&lt;class ’__main__.Generate’&gt;, output=’x.csv’, samples=100)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.652.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.653.1">command</span></span></span></span><span class="kobospan" id="kobo.654.1"> attribute in the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.655.1">Namespace</span></span></span></span><span class="kobospan" id="kobo.656.1"> object is the default value provided as part of the subcommand</span><span id="dx1-776008"/><span class="kobospan" id="kobo.657.1"> definition. </span><span class="kobospan" id="kobo.657.2">The values</span><span id="dx1-776009"/><span class="kobospan" id="kobo.658.1"> for </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.659.1">output</span></span></span></span><span class="kobospan" id="kobo.660.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.661.1">samples</span></span></span></span><span class="kobospan" id="kobo.662.1"> come</span><span id="dx1-776010"/><span class="kobospan" id="kobo.663.1"> from the</span><span id="dx1-776011"/> <span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.664.1">-o</span></span></span></span><span class="kobospan" id="kobo.665.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.666.1">-g</span></span></span></span><span class="kobospan" id="kobo.667.1"> options. </span><span id="x1-776012r1664"/></p>
</section>
<section data-number="0.17.3.4" id="theres-more...-99">
<h2 class="likechapterhead" data-number="0.17.3.4"><span><span class="kobospan" id="kobo.668.1">14.3.4 </span></span> <span id="x1-7770004"/><span class="kobospan" id="kobo.669.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.670.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.671.1">get_options()</span></span></span></span><span class="kobospan" id="kobo.672.1"> function has an explicit</span><span id="dx1-777001"/><span class="kobospan" id="kobo.673.1"> list of classes that it incorporates into the overall command. </span><span class="kobospan" id="kobo.673.2">As shown, a number of lines of code are repeated, and this could be optimized. </span><span class="kobospan" id="kobo.673.3">We can provide a data structure that replaces a number of lines of code:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.674.1">def get_options_2(argv: list[str] = sys.argv[1:]) -&gt; argparse.Namespace: 
 
    parser = argparse.ArgumentParser(prog="markov") 
 
    subparsers = parser.add_subparsers() 
 
    sub_commands = [ 
 
        ("generate", Generate), 
 
        ("summarize", Summarize), 
 
        ("gensumm", GenSumm), 
 
    ] 
 
 
 
    for name, subc in sub_commands: 
 
        cmd_parser = subparsers.add_parser(name) 
 
        subc.arguments(cmd_parser) 
 
    # The parsing and validating remains the same...</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.675.1">This variation on the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.676.1">get_options()</span></span></span></span><span class="kobospan" id="kobo.677.1"> function uses a sequence of two-tuples to provide the command name and the relevant class to implement the command. </span><span class="kobospan" id="kobo.677.2">Iterating through this list ensures that all of the various subclasses of the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.678.1">Command</span></span></span></span><span class="kobospan" id="kobo.679.1"> class are processed in a perfectly uniform manner. </span><span id="x1-777016r1665"/></p>
</section>
<section data-number="0.17.3.5" id="see-also-106">
<h2 class="likechapterhead" data-number="0.17.3.5"><span><span class="kobospan" id="kobo.680.1">14.3.5 </span></span> <span id="x1-7780005"/><span class="kobospan" id="kobo.681.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.682.1">See the </span><a href="ch017.xhtml#x1-7410005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.683.1">Designing scripts for composition</span></span></a><span class="kobospan" id="kobo.684.1"> and </span><a href="ch017.xhtml#x1-7470006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.685.1">Using logging for control</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.686.1">and audit output</span></span></a><span class="kobospan" id="kobo.687.1"> recipes in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.688.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.689.1"> </span></span><a href="ch017.xhtml#x1-71500013" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.690.1">13</span></span></a><span class="kobospan" id="kobo.691.1"> for the basics of building applications focused on being composable.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.692.1">See the </span><a href="ch018.xhtml#x1-7590001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.693.1">Combining two applications into one</span></span></a><span class="kobospan" id="kobo.694.1"> recipe from earlier in this chapter for the background on the components used in this recipe.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.695.1">See the </span><a href="ch010.xhtml#x1-3490004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.696.1">Using argparse to get command-line input</span></span></a><span class="kobospan" id="kobo.697.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.698.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.699.1"> </span></span><a href="ch010.xhtml#x1-3300006" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.700.1">6</span></span></a><span class="kobospan" id="kobo.701.1"> for more on the background of argument parsing.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.702.1">Other tools for creating CLIs include </span><a href="https://click.palletsprojects.com/en/8.1.x/" class="url"><span class="kobospan" id="kobo.703.1">click</span></a><span class="kobospan" id="kobo.704.1">, </span><a href="https://hydra.cc/docs/intro/" class="url"><span class="kobospan" id="kobo.705.1">hydra</span></a><span class="kobospan" id="kobo.706.1">, and </span><a href="https://www.pyinvoke.org" class="url"><span class="kobospan" id="kobo.707.1">invoke</span></a><span class="kobospan" id="kobo.708.1">.</span></p></li>
</ul>
<p class="normal1"><span id="x1-778001r1653"/></p>
</section>
</section>
<section data-number="0.17.4" id="wrapping-and-combining-cli-applications">
<h1 class="unnumbered" data-number="0.17.4"><span><span class="kobospan" id="kobo.709.1">14.4 </span></span> <span id="x1-7790004"/><span class="kobospan" id="kobo.710.1">Wrapping and combining CLI applications</span></h1>
<p class="normal"><span class="kobospan" id="kobo.711.1">One common kind of automation</span><span id="dx1-779001"/><span class="kobospan" id="kobo.712.1"> involves running</span><span id="dx1-779002"/><span class="kobospan" id="kobo.713.1"> several programs, some of which are not Python applications. </span><span class="kobospan" id="kobo.713.2">This commonly arises when integrating multiple tools, which are often applications used to build applications or documents. </span><span class="kobospan" id="kobo.713.3">Since the programs aren’t written in Python, it’s impossible to refactor each program to create a composite Python application. </span><span class="kobospan" id="kobo.713.4">When using a non-Python application, we can’t follow the </span><a href="ch018.xhtml#x1-7590001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.714.1">Combining two applications into one</span></span></a><span class="kobospan" id="kobo.715.1"> recipe shown earlier in this chapter.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.716.1">Instead of aggregating the Python components, an alternative is to wrap the other programs in Python, creating a composite application. </span><span class="kobospan" id="kobo.716.2">The use case is very similar to the use case for writing a shell script. </span><span class="kobospan" id="kobo.716.3">The difference is that Python is used instead of a shell language. </span><span class="kobospan" id="kobo.716.4">Using Python has some advantages:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.717.1">Python has a rich collection of data structures. </span><span class="kobospan" id="kobo.717.2">Most shell languages are limited to strings and arrays of strings.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.718.1">Python has several outstanding unit test frameworks. </span><span class="kobospan" id="kobo.718.2">Rigorous unit testing gives us confidence that the combined application will work as expected.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.719.1">In this recipe, we’ll look at how we can run other applications from within Python. </span><span id="x1-779003r1667"/></p>
<section data-number="0.17.4.1" id="getting-ready-108">
<h2 class="likechapterhead" data-number="0.17.4.1"><span><span class="kobospan" id="kobo.720.1">14.4.1 </span></span> <span id="x1-7800001"/><span class="kobospan" id="kobo.721.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.722.1">In the </span><a href="ch017.xhtml#x1-7410005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.723.1">Designing scripts for composition</span></span></a><span class="kobospan" id="kobo.724.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.725.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.726.1"> </span></span><a href="ch017.xhtml#x1-71500013" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.727.1">13</span></span></a><span class="kobospan" id="kobo.728.1">, we identified an application that did some processing that led to the creation of a rather complex result. </span><span class="kobospan" id="kobo.728.2">For the purposes of this recipe, we’ll assume that the application is not written in Python.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.729.1">We’d like to run this program several thousand times, but we don’t want to copy and paste the necessary commands into a script. </span><span class="kobospan" id="kobo.729.2">Also, because the shell is difficult to test and has so few data structures, we’d like to avoid using the shell.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.730.1">For this recipe, we’ll work with an application as if it were a native binary application, written in Rust, Go, or Pascal. </span><span class="kobospan" id="kobo.730.2">There are two ways to explore this:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.731.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.732.1">markov_gen.pas</span></span></span></span><span class="kobospan" id="kobo.733.1"> file in this book’s Git repository can be used to build a working, native binary application. </span><span class="kobospan" id="kobo.733.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.734.1">Free</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.735.1"> Pascal</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.736.1"> Compiler</span></span></span></span><span class="kobospan" id="kobo.737.1"> project ( </span><a class="url" href="https://www.freepascal.org"><span class="url1"><span class="kobospan" id="kobo.738.1">https://www.freepascal.org</span></span></a><span class="kobospan" id="kobo.739.1">) has compilers for a large number of platforms.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.740.1">Another common situation is the need to execute a Jupyter notebook using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.741.1">jupyter</span></span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.742.1"> execute</span></span></span></span><span class="kobospan" id="kobo.743.1"> command. </span><span class="kobospan" id="kobo.743.2">We can’t directly import a notebook, but must execute it via a separate command.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.744.1">Another alternative</span><span id="dx1-780001"/><span class="kobospan" id="kobo.745.1"> that can help</span><span id="dx1-780002"/><span class="kobospan" id="kobo.746.1"> with exploring these design alternatives is to make a Python application behave like a binary executable by adding a </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.747.1">shebang</span></span><span class="kobospan" id="kobo.748.1"> line as the first line in the file. </span><span class="kobospan" id="kobo.748.2">In many cases, the following can be used as the first line of a Python script:</span></p>
<pre class="programlisting" id="listing-87"><code class="calibre13"><span class="kobospan" id="kobo.749.1">#!/usr/bin/env python</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.750.1">For macOS and Linux, use the following to change the mode of the file to executable:</span></p>
<pre class="programlisting" id="listing-88"><code class="calibre13"><span class="kobospan" id="kobo.751.1">% chmod +x your_application_file.py</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.752.1">Working with a native binary application means that we can’t import a Python module that comprises the application. </span><span class="kobospan" id="kobo.752.2">Instead, the application is run as a separate OS process</span><span id="dx1-780005"/><span class="kobospan" id="kobo.753.1">. </span><span class="kobospan" id="kobo.753.2">This limits interaction to command-line argument values and OS environment variables.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.754.1">To run a native binary application, we use the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.755.1">subprocess</span></span></span></span><span class="kobospan" id="kobo.756.1"> module. </span><span class="kobospan" id="kobo.756.2">There are two common design patterns for running another program from within Python:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.757.1">The other program doesn’t produce any output, or we don’t want to gather the output in our Python program. </span><span class="kobospan" id="kobo.757.2">The first situation is typical of OS utilities that return a status code when they succeed or fail. </span><span class="kobospan" id="kobo.757.3">The second situation is typical of programs that update files and produce logs.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.758.1">The other program produces the output; the Python wrapper needs to capture and process it. </span><span class="kobospan" id="kobo.758.2">This may happen when the Python wrapper needs to take extra actions to clean up or retry in the event of failure.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.759.1">In this recipe, we’ll look at the first case: the output isn’t something we need to capture. </span><span class="kobospan" id="kobo.759.2">In the </span><a href="ch018.xhtml#x1-7850005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.760.1">Wrapping a program and checking the output</span></span></a><span class="kobospan" id="kobo.761.1"> recipe, we’ll look at the second case, where the output will be scrutinized by the Python wrapper program.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.762.1">In many cases, one benefit of wrapping an existing application with Python is the ability to dramatically rethink the UX. </span><span class="kobospan" id="kobo.762.2">This lets us redesign the CLI to better fit the user’s needs.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.763.1">Let’s look at wrapping a program</span><span id="dx1-780006"/><span class="kobospan" id="kobo.764.1"> that’s normally</span><span id="dx1-780007"/><span class="kobospan" id="kobo.765.1"> started with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.766.1">src/ch14/markov_gen</span></span></span></span><span class="kobospan" id="kobo.767.1"> command. </span><span class="kobospan" id="kobo.767.2">Here’s an example:</span></p>
<pre class="programlisting" id="listing-89"><code class="calibre13"><span class="kobospan" id="kobo.768.1">(cookbook3) % src/ch14/markov_gen -o data/ch14_r04.csv -s 100 -r 42 
 
# file = "data/ch14_r04.csv" 
 
# samples = 100 
 
# randomize = 42</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.769.1">The output filename needs to be flexible so that we can run the program hundreds of times. </span><span class="kobospan" id="kobo.769.2">This is often done by interpolating a sequence number into the filename. </span><span class="kobospan" id="kobo.769.3">For example, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.770.1">f"data/ch14/samples_{n}.csv"</span></span></span></span><span class="kobospan" id="kobo.771.1"> would be used in Python to create unique filenames. </span><span id="x1-780012r1669"/></p>
</section>
<section data-number="0.17.4.2" id="how-to-do-it...-109">
<h2 class="likechapterhead" data-number="0.17.4.2"><span><span class="kobospan" id="kobo.772.1">14.4.2 </span></span> <span id="x1-7810002"/><span class="kobospan" id="kobo.773.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.774.1">In this recipe, we’ll start by creating a small demonstration application. </span><span class="kobospan" id="kobo.774.2">This is</span><span id="dx1-781001"/><span class="kobospan" id="kobo.775.1"> a </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.776.1">spike solution </span></span><span class="kobospan" id="kobo.777.1">( </span><a class="url" href="https://wiki.c2.com/?SpikeSolution"><span class="url1"><span class="kobospan" id="kobo.778.1">https://wiki.c2.com/?SpikeSolution</span></span></a><span class="kobospan" id="kobo.779.1">). </span><span class="kobospan" id="kobo.779.2">This will be used to be sure we understand how the other application works. </span><span class="kobospan" id="kobo.779.3">Once we have the correct OS command, we can wrap this in a function call to make it easier to use:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-781003x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.780.1">Import the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.781.1">argparse</span></span></span></span><span class="kobospan" id="kobo.782.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.783.1">subprocess</span></span></span></span><span class="kobospan" id="kobo.784.1"> modules and the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.785.1">Path</span></span></span></span><span class="kobospan" id="kobo.786.1"> class. </span><span class="kobospan" id="kobo.786.2">We’ll also need the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.787.1">sys</span></span></span></span><span class="kobospan" id="kobo.788.1"> module:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.789.1">import argparse 
 
import subprocess 
 
from pathlib import Path 
 
import sys</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-781010x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.790.1">Write the core processing using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.791.1">subprocess</span></span></span></span><span class="kobospan" id="kobo.792.1"> module to invoke the target application. </span><span class="kobospan" id="kobo.792.2">This can be tested separately to ensure it can execute the application. </span><span class="kobospan" id="kobo.792.3">In this case, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.793.1">subprocess.run()</span></span></span></span><span class="kobospan" id="kobo.794.1"> will execute the given command, and the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.795.1">check=True</span></span></span></span><span class="kobospan" id="kobo.796.1"> option will raise an exception if the status is non-zero. </span><span class="kobospan" id="kobo.796.2">Here’s the spike solution that demonstrates the essential processing:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.797.1">
    directory, n = Path("/tmp"), 42 
 
    filename = directory / f"sample_{n}.csv" 
 
    command = [ 
 
        "markov_gen", 
 
        "--samples", "10", 
 
        "--output", str(filename), 
 
    ] 
 
    subprocess.run(command, check=True)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.798.1">This minimal spike</span><span id="dx1-781020"/><span class="kobospan" id="kobo.799.1"> can be run to make sure things</span><span id="dx1-781021"/><span class="kobospan" id="kobo.800.1"> work before proceeding to refactor the spike into something more useful.</span></p>
</div></li>
<li class="calibre7"><div id="x1-781023x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.801.1">Wrap the spike solution in a function that reflects the desired behavior. </span><span class="kobospan" id="kobo.801.2">The processing looks like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.802.1">                                                                    def make_files(directory: Path, files: int = 100) -&gt; None: 
 
    for n in range(files): 
 
        filename = directory / f"sample_{n}.csv" 
 
        command = [ 
 
            "markov_gen", 
 
            "--samples", "10", 
 
            "--output", str(filename), 
 
        ] 
 
        subprocess.run(command, check=True)</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-781035x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.803.1">Write a function to parse the command-line options. </span><span class="kobospan" id="kobo.803.2">In this case, there are two positional parameters: a directory and a number of chain samples to generate. </span><span class="kobospan" id="kobo.803.3">The function looks like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.804.1">def get_options(argv: list[str]) -&gt; argparse.Namespace: 
 
    parser = argparse.ArgumentParser() 
 
    parser.add_argument("directory", type=Path) 
 
    parser.add_argument("samples", type=int) 
 
    options = parser.parse_args(argv) 
 
    return options</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-781044x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.805.1">Write a main function to do the parsing and processing:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.806.1">def main(argv: list[str] = sys.argv[1:]) -&gt; None: 
 
    options = get_options(argv) 
 
    make_files(options.directory, options.samples)</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.807.1">We now have a function that’s testable using any of the Python unit-testing frameworks. </span><span class="kobospan" id="kobo.807.2">This can give us real confidence that we have a reliable application built around an existing non-Python application. </span><span id="x1-781049r1670"/></p>
</section>
<section data-number="0.17.4.3" id="how-it-works...-109">
<h2 class="likechapterhead" data-number="0.17.4.3"><span><span class="kobospan" id="kobo.808.1">14.4.3 </span></span> <span id="x1-7820003"/><span class="kobospan" id="kobo.809.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.810.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.811.1">subprocess</span></span></span></span><span class="kobospan" id="kobo.812.1"> module</span><span id="dx1-782001"/><span class="kobospan" id="kobo.813.1"> is how Python</span><span id="dx1-782002"/><span class="kobospan" id="kobo.814.1"> runs other programs. </span><span class="kobospan" id="kobo.814.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.815.1">run()</span></span></span></span><span class="kobospan" id="kobo.816.1"> function does a number of things for us.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.817.1">In a POSIX (such as Linux or macOS) context, the steps are similar to the following sequence:</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-782004x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.818.1">Prepare the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.819.1">stdin</span></span></span></span><span class="kobospan" id="kobo.820.1">, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.821.1">stdout</span></span></span></span><span class="kobospan" id="kobo.822.1">, and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.823.1">stderr</span></span></span></span><span class="kobospan" id="kobo.824.1"> file descriptors for the child process.</span></p>
</div></li>
<li class="calibre7"><div id="x1-782006x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.825.1">Invoke a function like the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.826.1">os.execve()</span></span></span></span><span class="kobospan" id="kobo.827.1"> function to start the child process.</span></p>
</div></li>
<li class="calibre7"><div id="x1-782008x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.828.1">Wait for the child process to finish and collect the final status.</span></p>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.829.1">An OS shell, such as </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.830.1">bash</span></span></span></span><span class="kobospan" id="kobo.831.1">, conceals these details from application developers and users. </span><span class="kobospan" id="kobo.831.2">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.832.1">subprocess.run()</span></span></span></span><span class="kobospan" id="kobo.833.1"> function, similarly, hides the details of creating and waiting for a child process.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.834.1">Using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.835.1">subprocess</span></span></span></span><span class="kobospan" id="kobo.836.1"> module to run a separate executable allows Python to integrate a wide variety of software components into a unified whole. </span><span class="kobospan" id="kobo.836.2">Using Python offers a much richer collection of data structures than the shell, proper exception handling instead of checking the final status code, and a way to unit test. </span><span id="x1-782009r1676"/></p>
</section>
<section data-number="0.17.4.4" id="theres-more...-100">
<h2 class="likechapterhead" data-number="0.17.4.4"><span><span class="kobospan" id="kobo.837.1">14.4.4 </span></span> <span id="x1-7830004"/><span class="kobospan" id="kobo.838.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.839.1">We’ll add a simple clean-up feature</span><span id="dx1-783001"/><span class="kobospan" id="kobo.840.1"> to this script. </span><span class="kobospan" id="kobo.840.2">The idea is that all of the output files should be created as an atomic operation.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.841.1">In order to clean up, we’ll need to wrap the core processing in a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.842.1">try:</span></span></span></span><span class="kobospan" id="kobo.843.1"> block. </span><span class="kobospan" id="kobo.843.2">We’ll write a second function, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.844.1">make_files_clean()</span></span></span></span><span class="kobospan" id="kobo.845.1">, that uses the original </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.846.1">make_files()</span></span></span></span><span class="kobospan" id="kobo.847.1"> function to include a clean-up feature. </span><span class="kobospan" id="kobo.847.2">A new overall function, </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.848.1">make_files_clean()</span></span></span></span><span class="kobospan" id="kobo.849.1">, would look like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.850.1">def make_files_clean(directory: Path, files: int = 100) -&gt; None: 
 
    """Create sample data files, with cleanup after a failure.""" 
 
    try: 
 
        make_files(directory, files) 
 
    except subprocess.CalledProcessError as ex: 
 
        # Remove any files. 
 
        for partial in directory.glob("sample_*.csv"): 
 
            partial.unlink() 
 
        raise</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.851.1">The exception-handling block does two things. </span><span class="kobospan" id="kobo.851.2">First, it removes any incomplete files from the current working directory. </span><span class="kobospan" id="kobo.851.3">Second, it re-raises the original exception so that the failure will propagate to the client application.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.852.1">Any test cases for this application would need to make use of mock objects. </span><span class="kobospan" id="kobo.852.2">See the </span><a href="ch019_split_001.xhtml#x1-85500010" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.853.1">Mocking external resources</span></span></a><span class="kobospan" id="kobo.854.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.855.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.856.1"> </span></span><a href="ch019_split_000.xhtml#x1-79400015" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.857.1">15</span></span></a><span class="kobospan" id="kobo.858.1">. </span><span id="x1-783012r1677"/></p>
</section>
<section data-number="0.17.4.5" id="see-also-107">
<h2 class="likechapterhead" data-number="0.17.4.5"><span><span class="kobospan" id="kobo.859.1">14.4.5 </span></span> <span id="x1-7840005"/><span class="kobospan" id="kobo.860.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.861.1">This kind of automation is often combined with other Python processing. </span><span class="kobospan" id="kobo.861.2">See the </span><a href="ch017.xhtml#x1-7410005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.862.1">Designing scripts for composition</span></span></a><span class="kobospan" id="kobo.863.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.864.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.865.1"> </span></span><a href="ch017.xhtml#x1-71500013" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.866.1">13</span></span></a><span class="kobospan" id="kobo.867.1">.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.868.1">The goal is often to create a composite application; see the </span><a href="ch018.xhtml#x1-7730003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.869.1">Managing</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.870.1">arguments and configuration in composite applications</span></span></a><span class="kobospan" id="kobo.871.1"> recipe earlier in this chapter.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.872.1">For a variation on this recipe, see the </span><a href="ch018.xhtml#x1-7850005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.873.1">Wrapping a program and checking</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.874.1">the output</span></span></a><span class="kobospan" id="kobo.875.1"> recipe, which is up next in this chapter.</span></p></li>
</ul>
<p class="normal1"><span id="x1-784001r1668"/></p>
</section>
</section>
<section data-number="0.17.5" id="wrapping-a-program-and-checking-the-output">
<h1 class="unnumbered" data-number="0.17.5"><span><span class="kobospan" id="kobo.876.1">14.5 </span></span> <span id="x1-7850005"/><span class="kobospan" id="kobo.877.1">Wrapping a program and checking the output</span></h1>
<p class="normal"><span class="kobospan" id="kobo.878.1">One common kind of automation</span><span id="dx1-785001"/><span class="kobospan" id="kobo.879.1"> involves wrapping</span><span id="dx1-785002"/><span class="kobospan" id="kobo.880.1"> a program. </span><span class="kobospan" id="kobo.880.2">The advantage of a Python wrapper is the ability to perform detailed aggregation and analysis of the output files. </span><span class="kobospan" id="kobo.880.3">A Python program might transform, filter, or summarize the output from a subprocess.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.881.1">In this recipe, we’ll see how to run other applications from within Python, and collect and process the output. </span><span id="x1-785003r1679"/></p>
<section data-number="0.17.5.1" id="getting-ready-109">
<h2 class="likechapterhead" data-number="0.17.5.1"><span><span class="kobospan" id="kobo.882.1">14.5.1 </span></span> <span id="x1-7860001"/><span class="kobospan" id="kobo.883.1">Getting ready</span></h2>
<p class="normal"><span class="kobospan" id="kobo.884.1">In the </span><a href="ch017.xhtml#x1-7410005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.885.1">Designing scripts for composition</span></span></a><span class="kobospan" id="kobo.886.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.887.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.888.1"> </span></span><a href="ch017.xhtml#x1-71500013" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.889.1">13</span></span></a><span class="kobospan" id="kobo.890.1">, we identified an application that did some processing, leading to the creation of a rather complex result. </span><span class="kobospan" id="kobo.890.2">We’d like to run this program several hundred times, but we don’t want to copy and paste the necessary commands into a script. </span><span class="kobospan" id="kobo.890.3">Also, because the shell is difficult to test and has so few data structures, we’d like to avoid using the shell.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.891.1">For this recipe, we’ll work with a native binary application written in some compiled language like Ada, Fortran, or Pascal. </span><span class="kobospan" id="kobo.891.2">This means that we can’t simply import</span><span id="dx1-786001"/><span class="kobospan" id="kobo.892.1"> the Python module that</span><span id="dx1-786002"/><span class="kobospan" id="kobo.893.1"> comprises the application. </span><span class="kobospan" id="kobo.893.2">Instead, we’ll have to execute this application by running a separate OS process with the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.894.1">subprocess</span></span></span></span><span class="kobospan" id="kobo.895.1"> module. </span><span class="kobospan" id="kobo.895.2">There are two common use cases for running another binary program from within Python:</span></p>
<ul class="calibre11">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.896.1">Either there isn’t any output, or we don’t want to process the output file in our Python program.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.897.1">We need to capture and possibly analyze the output to retrieve information or ascertain the level of success. </span><span class="kobospan" id="kobo.897.2">We might need to transform, filter, or summarize the log output.</span></p></li>
</ul>
<p class="normal1"><span class="kobospan" id="kobo.898.1">In this recipe, we’ll look at the second case: the output must be captured and summarized. </span><span class="kobospan" id="kobo.898.2">In the </span><a href="ch018.xhtml#x1-7790004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.899.1">Wrapping and combining CLI applications</span></span></a><span class="kobospan" id="kobo.900.1"> recipe in this chapter, we looked at the first case, where the output is simply ignored.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.901.1">Here’s an example of running the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.902.1">markov_gen</span></span></span></span><span class="kobospan" id="kobo.903.1"> application:</span></p>
<pre class="programlisting" id="listing-90"><code class="calibre13"><span class="kobospan" id="kobo.904.1">(cookbook3) % RANDOMSEED=42 src/ch14/markov_gen --samples 5 --output t.csv 
 
# file = "t.csv" 
 
# samples = 5 
 
# randomize = 42</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.905.1">There were three lines of output written to the OS standard output file, all starting with </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.906.1">#</span></span></span></span><span class="kobospan" id="kobo.907.1">. </span><span class="kobospan" id="kobo.907.2">These show the file being created, the number of samples, and the random number generator seed being used. </span><span class="kobospan" id="kobo.907.3">This output is confirmation the data was correctly created.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.908.1">We want to capture the details</span><span id="dx1-786007"/><span class="kobospan" id="kobo.909.1"> of these lines</span><span id="dx1-786008"/><span class="kobospan" id="kobo.910.1"> from this application and summarize them. </span><span class="kobospan" id="kobo.910.2">The total of all the generated samples should match the number of samples summarized, confirming that all of the data was processed. </span><span id="x1-786009r1681"/></p>
</section>
<section data-number="0.17.5.2" id="how-to-do-it...-110">
<h2 class="likechapterhead" data-number="0.17.5.2"><span><span class="kobospan" id="kobo.911.1">14.5.2 </span></span> <span id="x1-7870002"/><span class="kobospan" id="kobo.912.1">How to do it...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.913.1">We’ll start by creating</span><span id="dx1-787001"/><span class="kobospan" id="kobo.914.1"> a </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.915.1">spike solution </span></span><span class="kobospan" id="kobo.916.1">( </span><a class="url" href="https://wiki.c2.com/?SpikeSolution"><span class="url1"><span class="kobospan" id="kobo.917.1">https://wiki.c2.com/?SpikeSolution</span></span></a><span class="kobospan" id="kobo.918.1">) to confirm the command and arguments needed to run another application. </span><span class="kobospan" id="kobo.918.2">We’ll transform the spike solution into a function that captures output for further analysis.</span></p>
<ol class="calibre4">
<li class="calibre7"><div id="x1-787003x1" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.919.1">Import the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.920.1">argparse</span></span></span></span><span class="kobospan" id="kobo.921.1"> and </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.922.1">subprocess</span></span></span></span><span class="kobospan" id="kobo.923.1"> modules and the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.924.1">Path</span></span></span></span><span class="kobospan" id="kobo.925.1"> class. </span><span class="kobospan" id="kobo.925.2">We’ll also need the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.926.1">sys</span></span></span></span><span class="kobospan" id="kobo.927.1"> module and the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.928.1">Any</span></span></span></span><span class="kobospan" id="kobo.929.1"> type hint:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.930.1">import argparse 
 
from collections.abc import Iterable, Iterator 
 
from pathlib import Path 
 
import subprocess 
 
import sys 
 
from typing import Any</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-787012x2" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.931.1">Write the core processing, using the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.932.1">subprocess</span></span></span></span><span class="kobospan" id="kobo.933.1"> module to invoke the target application. </span><span class="kobospan" id="kobo.933.2">Here’s a spike solution that demonstrates the essential processing:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.934.1">
    directory, n = Path("/tmp"), 42 
 
    filename = directory / f"sample_{n}.toml" 
 
    temp_path = directory / "stdout.txt" 
 
    command = [ 
 
        "src/ch14/markov_gen", 
 
        "--samples", "10", 
 
        "--output", str(filename), 
 
    ] 
 
    with temp_path.open("w") as temp_file: 
 
        process = subprocess.run( 
 
            command, 
 
            stdout=temp_file, check=True, text=True 
 
        ) 
 
    output_text = temp_path.read_text()</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.935.1">This spike does two things: it builds a complicated command line for a subprocess and it also collects the output from the subprocess. </span><span class="kobospan" id="kobo.935.2">A temporary file allows the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.936.1">subprocess</span></span></span></span><span class="kobospan" id="kobo.937.1"> module to run a process that creates a very large file.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.938.1">The idea is to create a script</span><span id="dx1-787028"/><span class="kobospan" id="kobo.939.1"> with this minimal spike</span><span id="dx1-787029"/><span class="kobospan" id="kobo.940.1"> and be sure things work before proceeding to refactor the spike into something more useful.</span></p>
</div></li>
<li class="calibre7"><div id="x1-787031x3" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.941.1">Refactor the spike to create a function that runs a command and collects the output. </span><span class="kobospan" id="kobo.941.2">Here’s a </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.942.1">command_output()</span></span></span></span><span class="kobospan" id="kobo.943.1"> function:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.944.1">def command_output( 
 
    temporary: Path, command: list[str] 
 
) -&gt; str: 
 
    temp_path = temporary / "stdout" 
 
    with temp_path.open("w") as temp_file: 
 
        subprocess.run( 
 
            command, 
 
            stdout=temp_file, check=True, text=True 
 
        ) 
 
    output_text = temp_path.read_text() 
 
    temp_path.unlink() 
 
    return output_text</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-787046x4" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.945.1">Refactor the rest of the spike into a function to generate the commands. </span><span class="kobospan" id="kobo.945.2">It makes sense for this function to be a generator so it can create a collection of similar commands.</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.946.1">def command_iter(options: argparse.Namespace) -&gt; Iterable[list[str]]: 
 
    for n in range(options.iterations): 
 
        filename = options.directory / f"sample_{n}.csv" 
 
        command = [ 
 
            "src/ch14/markov_gen", 
 
            "--samples", str(options.samples), 
 
            "--output", str(filename), 
 
            "--randomize", str(n+1), 
 
        ] 
 
        yield command</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-787059x5" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.947.1">Define a function to parse the expected output from a command. </span><span class="kobospan" id="kobo.947.2">We’ll decompose the parsing into a sequence of generators that create regular expression </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.948.1">Match</span></span></span></span><span class="kobospan" id="kobo.949.1"> objects, extract the matched groups, and build a final dictionary reflecting the content. </span><span class="kobospan" id="kobo.949.2">The function can look like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.950.1">def parse_output(result: str) -&gt; dict[str, Any]: 
 
    matches = ( 
 
        re.match(r"^#\s*([^\s=]+)\s*=\s*(.*?)\s*$", line) 
 
        for line in result.splitlines() 
 
    ) 
 
    match_groups = ( 
 
        match.groups() 
 
        for match in matches 
 
        if match 
 
    ) 
 
    summary = { 
 
        name: value 
 
        for name, value in match_groups 
 
    } 
 
    return summary</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-787077x6" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.951.1">Here’s the high-level function</span><span id="dx1-787078"/><span class="kobospan" id="kobo.952.1"> to extract useful information</span><span id="dx1-787079"/><span class="kobospan" id="kobo.953.1"> from the command output. </span><span class="kobospan" id="kobo.953.2">The generator function looks like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.954.1">def summary_iter(options: argparse.Namespace) -&gt; Iterator[dict[str, Any]]: 
 
    commands = command_iter(options) 
 
    with tempfile.TemporaryDirectory() as tempdir: 
 
        results = ( 
 
            command_output(Path(tempdir), cmd) 
 
            for cmd in commands 
 
        ) 
 
        for text in results: 
 
            yield parse_output(text)</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.955.1">This function will use a stack of generator expressions. </span><span class="kobospan" id="kobo.955.2">For more background, see the </span><a href="ch013_split_000.xhtml#x1-5180003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.956.1">Using stacked generator expressions</span></span></a><span class="kobospan" id="kobo.957.1">recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.958.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.959.1"> </span></span><a href="ch013_split_000.xhtml#x1-5020009" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.960.1">9</span></span></a><span class="kobospan" id="kobo.961.1">. </span><span class="kobospan" id="kobo.961.2">Since these are all generator expressions, each individual result is processed separately. </span><span class="kobospan" id="kobo.961.3">This can allow large files to be digested as small summaries one at a time.</span></p>
</div></li>
<li class="calibre7"><div id="x1-787093x7" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.962.1">Write a function to parse</span><span id="dx1-787094"/><span class="kobospan" id="kobo.963.1"> the command-line options. </span><span class="kobospan" id="kobo.963.2">In this</span><span id="dx1-787095"/><span class="kobospan" id="kobo.964.1"> case, the target directory is a positional parameter, and the number of samples in each file and the number of files to generate are options. </span><span class="kobospan" id="kobo.964.2">The function looks like this:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.965.1">def get_options(argv: list[str]) -&gt; argparse.Namespace: 
 
    parser = argparse.ArgumentParser() 
 
    parser.add_argument("directory", type=Path) 
 
    parser.add_argument("-s", "--samples", type=int, default=1_000) 
 
    parser.add_argument("-i", "--iterations", type=int, default=10) 
 
    options = parser.parse_args(argv) 
 
    return options</span></code></pre>
</div></li>
<li class="calibre7"><div id="x1-787105x8" class="calibre14">
<p class="normal2"><span class="kobospan" id="kobo.966.1">Combine the parsing and execution into a main function:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.967.1">def main(argv: list[str] = sys.argv[1:]) -&gt; None: 
 
    options = get_options(argv) 
 
    parsed_results = list(summary_iter(options)) 
 
    print(f"Built {len(parsed_results)} files") 
 
    # print(parsed_results) 
 
    total = sum( 
 
        int(rslt[’samples’]) for rslt in parsed_results 
 
    ) 
 
    print(f"Total {total} samples")</span></code></pre>
</div></li>
</ol>
<p class="normal1"><span class="kobospan" id="kobo.968.1">Now we can run this new application and have it execute the underlying application and also gather the output, producing a helpful summary. </span><span class="kobospan" id="kobo.968.2">We’ve built this using</span><span id="dx1-787116"/><span class="kobospan" id="kobo.969.1"> Python instead of a </span><span class="cmbx-10x-x"><span class="kobospan" id="kobo.970.1">bash </span></span><span class="kobospan" id="kobo.971.1">(or other shell) script. </span><span class="kobospan" id="kobo.971.2">We can make use of Python’s data structures and unit testing. </span><span id="x1-787117r1682"/></p>
</section>
<section data-number="0.17.5.3" id="how-it-works...-110">
<h2 class="likechapterhead" data-number="0.17.5.3"><span><span class="kobospan" id="kobo.972.1">14.5.3 </span></span> <span id="x1-7880003"/><span class="kobospan" id="kobo.973.1">How it works...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.974.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.975.1">subprocess</span></span></span></span><span class="kobospan" id="kobo.976.1"> module</span><span id="dx1-788001"/><span class="kobospan" id="kobo.977.1"> is how Python</span><span id="dx1-788002"/><span class="kobospan" id="kobo.978.1"> programs run other programs available on a given computer. </span><span class="kobospan" id="kobo.978.2">For more background, see the </span><a href="ch018.xhtml#x1-7790004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.979.1">Wrapping and combining CLI</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.980.1">applications</span></span></a><span class="kobospan" id="kobo.981.1"> recipe in this chapter.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.982.1">The </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.983.1">subprocess</span></span></span></span><span class="kobospan" id="kobo.984.1"> module gives us access to one of the most important parts of the operating system: launching a subprocess and collecting the output. </span><span class="kobospan" id="kobo.984.2">The underlying OS can direct output to the console, or files, or through ”pipes” to another process. </span><span class="kobospan" id="kobo.984.3">The default behavior when launching a subprocess is to inherit the parent process definitions for the three standard files, stdin, stdout, and stderr. </span><span class="kobospan" id="kobo.984.4">In this recipe, we’ve replaced the default stdout assignment with a file that permits us to gather (and analyze) output that would have gone to the console. </span><span id="x1-788003r1691"/></p>
</section>
<section data-number="0.17.5.4" id="theres-more...-101">
<h2 class="likechapterhead" data-number="0.17.5.4"><span><span class="kobospan" id="kobo.985.1">14.5.4 </span></span> <span id="x1-7890004"/><span class="kobospan" id="kobo.986.1">There’s more...</span></h2>
<p class="normal"><span class="kobospan" id="kobo.987.1">Once we’ve wrapped the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.988.1">markov_gen</span></span></span></span><span class="kobospan" id="kobo.989.1"> binary application within a Python application, we have a number of alternatives available to us for improving the output.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.990.1">Because we’ve wrapped the underlying application, we don’t need to change this code to change the results it produces. </span><span class="kobospan" id="kobo.990.2">We can modify our wrapper program, leaving the original data generator intact.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.991.1">We can refactor the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.992.1">main()</span></span></span></span><span class="kobospan" id="kobo.993.1"> function to replace the </span><span class="obeylines-h"><span><span class="cmtt-10x-x"><span class="kobospan" id="kobo.994.1">print()</span></span></span></span><span class="kobospan" id="kobo.995.1"> functions with processing to create a more useful format. </span><span class="kobospan" id="kobo.995.2">A possible rewrite would emit a CSV file with the detailed generator information:</span></p>
<pre class="programlisting"><code class="calibre13"><span class="kobospan" id="kobo.996.1">import csv 
 
 
 
def main_2(argv: list[str] = sys.argv[1:]) -&gt; None: 
 
    options = get_options(argv) 
 
 
 
    total_counter = 0 
 
    wtr = csv.DictWriter(sys.stdout, ["file", "samples", "randomize"]) 
 
    wtr.writeheader() 
 
    for summary in summary_iter(options): 
 
        wtr.writerow(summary) 
 
        total_counter += int(summary["samples"]) 
 
    wtr.writerow({"file": "TOTAL", "samples": total_counter})</span></code></pre>
<p class="normal1"><span class="kobospan" id="kobo.997.1">The list of files and numbers of samples can be used to partition the data for model training purposes.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.998.1">We are able to build useful features separately by creating layers of features. </span><span class="kobospan" id="kobo.998.2">Leaving the underlying application untouched can help us to perform regression tests to be sure the core statistical validity has not been harmed by adding new features. </span><span id="x1-789014r1692"/></p>
</section>
<section data-number="0.17.5.5" id="see-also-108">
<h2 class="likechapterhead" data-number="0.17.5.5"><span><span class="kobospan" id="kobo.999.1">14.5.5 </span></span> <span id="x1-7900005"/><span class="kobospan" id="kobo.1000.1">See also</span></h2>
<ul class="calibre16">
<li class="calibre12"><p class="normal2"><span class="kobospan" id="kobo.1001.1">See the </span><a href="ch018.xhtml#x1-7790004" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1002.1">Wrapping and combining CLI applications</span></span></a><span class="kobospan" id="kobo.1003.1"> recipe from earlier in this chapter for another approach to this recipe.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1004.1">This kind of automation is often combined with other Python processing. </span><span class="kobospan" id="kobo.1004.2">See the </span><a href="ch017.xhtml#x1-7410005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1005.1">Designing scripts for composition</span></span></a><span class="kobospan" id="kobo.1006.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1007.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1008.1"> </span></span><a href="ch017.xhtml#x1-71500013" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1009.1">13</span></span></a><span class="kobospan" id="kobo.1010.1">.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1011.1">The goal is often to create a composite application; see the </span><a href="ch018.xhtml#x1-7730003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1012.1">Managing</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1013.1">arguments and configuration in composite applications</span></span></a><span class="kobospan" id="kobo.1014.1"> recipe from earlier in this chapter.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1015.1">Many practical applications will work with more complex output formats. </span><span class="kobospan" id="kobo.1015.2">For information on processing complex line formats, see the </span><a href="ch005_split_000.xhtml#x1-350003" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1016.1">String parsing with regular expressions</span></span></a><span class="kobospan" id="kobo.1017.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1018.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1019.1"> </span></span><a href="ch005_split_000.xhtml#x1-170001" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1020.1">1</span></span></a><span class="kobospan" id="kobo.1021.1"> and the </span><a href="ch015_split_001.xhtml#x1-6440005" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1022.1">Reading complex formats using regular expressions</span></span></a><span class="kobospan" id="kobo.1023.1"> recipe in </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1024.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1025.1"> </span></span><a href="ch015_split_000.xhtml#x1-61500011" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1026.1">11</span></span></a><span class="kobospan" id="kobo.1027.1">. </span><span class="kobospan" id="kobo.1027.2">Much of </span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1028.1">Chapter</span></span><span class="cmti-10x-x"><span class="kobospan" id="kobo.1029.1"> </span></span><a href="ch015_split_000.xhtml#x1-61500011" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1030.1">11</span></span></a><span class="kobospan" id="kobo.1031.1">, relates to the details of parsing input files.</span></p></li>
<li class="calibre7"><p class="normal2"><span class="kobospan" id="kobo.1032.1">For more information on interprocess communication, see </span><a href="https://tldp.org/LDP/tlk/ipc/ipc.html" class="url"><span class="cmti-10x-x"><span class="kobospan" id="kobo.1033.1">The Linux</span></span> <span class="cmti-10x-x"><span class="kobospan" id="kobo.1034.1">Documentation Project: Interprocess Communication Mechanisms</span></span></a><span class="kobospan" id="kobo.1035.1">.</span></p></li>
</ul>
<p class="normal1"><span id="x1-790001r1680"/></p>
</section>
</section>
<section data-number="0.17.8" id="join-our-community-discord-space-14">
<h1 class="unnumbered" data-number="0.17.8"><span id="x1-7930007"/><span class="kobospan" id="kobo.1036.1">Join our community Discord space</span></h1>
<p class="normal"><span class="kobospan" id="kobo.1037.1">Join our Python Discord workspace to discuss and find out more about the book: </span><a class="url" href="https://packt.link/dHrHU"><span class="url1"><span class="kobospan" id="kobo.1038.1">https://packt.link/dHrHU</span></span></a><span class="kobospan" id="kobo.1039.1">.</span></p>
<p class="normal1"><span class="kobospan" id="kobo.1040.1"><img alt="PIC" src="../media/file1.png" class="calibre9"/></span> <span id="x1-793001r1622"/></p>
</section>
</section>
</body></html>