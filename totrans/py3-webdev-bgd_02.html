<html><head></head><body>
  <div><div><div><div><div><h1 class="title"><a id="ch02"/>Chapter 2. Creating a Simple Spreadsheet</h1></div></div></div><div><blockquote class="blockquote"><p>In this chapter, we will develop a simple spreadsheet application. The spreadsheet functionality will be entirely implemented in JavaScript plus jQuery UI, but we will configure CherryPy to deliver the page that contains the spreadsheet application dynamically.</p></blockquote></div><div><blockquote class="blockquote"><p>On the presentation side, we will encounter our first jQuery UI widgets (buttons) and will see how we can design other elements to adhere to jQuery UI standards to fit seamlessly in jQuery UI's theme framework. We will also see how to find and use publically available jQuery plugins and integrate the jEditable plugin into our application.</p></blockquote></div><div><blockquote class="blockquote"><p>That is a lot to grasp in one go, but don't worry if every detail is not clear the first time. We will encounter many variants of the issues first encountered here in the other chapters and will explain all relevant details again in their context.</p></blockquote></div><p>In this chapter, we will be:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating an environment to develop and deliver our applications</li><li class="listitem" style="list-style-type: disc">Designing a simple spreadsheet application</li><li class="listitem" style="list-style-type: disc">Learning how to configure CherryPy to deliver this application</li><li class="listitem" style="list-style-type: disc">Encountering our first jQuery UI widgets</li><li class="listitem" style="list-style-type: disc">And designing our own jQuery plugins</li></ul></div><p>There is a lot of ground to cover so let's go...</p><div><div><div><div><h1 class="title"><a id="ch02lvl1sec01"/>Python 3</h1></div></div></div><p>Python 3 is the language we will use to develop the server-side parts of our applications. At the time of writing, the current stable version is 3.2. Installers and source archives are available for various platforms (including Windows, Mac OS, and Linux distributions) and may be downloaded from<a class="ulink" href="http://www.python.org/download/"> http://www.python.org/download/</a>.<a id="id64" class="indexterm"/>
</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec02"/>Time for action installing Python 3</h1></div></div></div><p>Downloading and installing Python is not difficult. The installers for many platforms can be downloaded from<a class="ulink" href="http://www.python.org/download/"> http://www.python.org/download/</a>.<a id="id65" class="indexterm"/>
</p><div><ol class="orderedlist"><li class="listitem">Download the installer for your platform and follow the installation instructions.</li><li class="listitem">Verify that you correctly installed Python by typing the following command on the command line (for example, inside a Windows command prompt or a Linux xterm):</li></ol></div><div><pre class="programlisting"><strong>
&gt;python -version</strong>
</pre></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">The response will be the version:</li></ul></div><div><pre class="programlisting"><strong>
Python 3.2</strong>
</pre></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec01"/>What just happened?</h2></div></div></div><p>On a UNIX-like system (like Ubuntu Linux, or Mac OS), Python might very well be already installed, so it might be a good idea to verify that first by trying the instructions in step 2. If the version returned is lower than 3, you should update your Python distribution. Note that it is perfectly possible to install version 3.x of Python alongside a 2.x version in order to not break applications depending on version 2.x (Python 3 is not backward compatible with version 2).</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec03"/>CherryPy</h1></div></div></div><p>Writing an HTTP server in Python isn't that difficult, but writing and maintaining a robust and fully fledged web server that can act as an application server is quite something else. As we explained in<a class="link" href="ch01.html" title="Chapter 1. Choosing Your Tools"> Chapter 1</a>,<em> Choosing Your Tools</em>, we will use CherryPy as our application server. At the time of writing, CherryPy's latest stable version for Python 3 is version 3.2.0 and can be downloaded from<a class="ulink" href="http://download.cherrypy.org/cherrypy/3.2.0/"> http://download.cherrypy.org/cherrypy/3.2.0/</a>.<a id="id66" class="indexterm"/>
</p><div><h3 class="title"><a id="note04"/>Note</h3><p>Windows users should use the zip archive and unpack it before proceeding to the instructions in the next section. There is also a<code class="literal"> msi</code> installer available at the indicated location, but this installer might not be able to find the correct Python installation in the Windows registry and will only work on 32-bit versions of Windows. Unpacking the zip archive and following the setup instructions next is therefore a safer bet and also identical on both Windows and Unix-like platforms.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec04"/>Time for action installing CherryPy</h1></div></div></div><p>The one thing to be careful with when you install CherryPy is that you have to make sure you install it in the right directory if you have more than one Python version on your system. CherryPy uses a setup script to install itself and one way to make sure the CherryPy modules end up in the correct place is by invoking Python explicitly with a full path, for example:<a id="id67" class="indexterm"/>
</p><div><pre class="programlisting"><strong>
cd C:\CherryPy-3.2.0rc1
c:\Python32\python.exe setup.py install</strong>
</pre></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec02"/>What just happened?</h2></div></div></div><p>Running CherryPy's<code class="literal"> setup.py</code> script installs a number of modules in Python's<code class="literal"> Lib\site-packages</code> directory. You may verify this was successful by typing the following on the command line:<a id="id68" class="indexterm"/>
</p><div><pre class="programlisting"><strong>
python -c "import cherrypy"</strong>
</pre></div><p>This checks whether we can import the<code class="literal"> cherrypy</code> module. If everything is installed correctly, there will be no output produced by this command. However, if CherryPy isn't installed, this may be signaled by an error message:</p><div><pre class="programlisting"><strong>
Traceback (most recent call last):
	File "&lt;string&gt;", line 1, in &lt;module&gt;
ImportError: No module named cherrypy</strong>
</pre></div><p>When you have more than one version of Python installed, be careful to enter the complete path of the Python executable to select the correct version, for example:</p><div><pre class="programlisting"><strong>
C:\python32\python c "import cherrypy"</strong>
</pre></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec05"/>Installing jQuery and jQuery UI</h1></div></div></div><p>The applications we will design and implement in this chapter and the following chapters depend heavily on the jQuery and jQuery UI libraries. These libraries consist mainly of JavaScript files and some cascading style sheets, and images to style the widgets.<a id="id69" class="indexterm"/>
</p><p>These files are served to the web browser as part of the application, and in general, there are two locations where they may be served from:<a id="id70" class="indexterm"/>
</p><div><ol class="orderedlist"><li class="listitem">A (sub)directory on the server that runs CherryPy together with the other files that make up our application.</li><li class="listitem">Or from an external web location like Google's or Microsoft's content delivery networks.</li></ol></div><p>The latter option might be the best choice if your application gets a lot of traffic as these publicly available resources are designed for high availability and can cope with an enormous number of requests. This might seriously reduce the load on your server and thus reduce costs. More information on this can be found on jQuery's download section<a class="ulink" href="http://docs.jquery.com/Downloading_jQuery#CDN_Hosted_jQuery"> http://docs.jquery.com/Downloading_jQuery#CDN_Hosted_jQuery</a>.</p><p>For development purposes it is often better to download the necessary files and serve them from the web server that serves the rest of the application as well. This way we can inspect those files easily when some error occurs or even decide to tweak the contents. If we choose to theme our application in a customized way (see the info box on jQuery UI's themeroller), the cascading style sheets will differ from the standard ones so we will have to serve them from our web server anyway.</p><p>In the example code provided with this book, we include both the jQuery and jQuery UI libraries in the<code class="literal"> static</code> subdirectory of the directory for each chapter. There is also a<code class="literal"> css</code> subdirectory that contains a set of customized style sheets that are optimized to deliver a visual style that is well readable both in print and onscreen. The version of the jQuery library used in this book is downloaded from<a class="ulink" href="http://code.jquery.com/jquery-1.4.2.js"> http://code.jquery.com/jquery-1.4.2.js</a>. Information on downloading a (possible themed) version of jQuery UI can be found on<a class="ulink" href="http://jqueryui.com/download"> http://jqueryui.com/download</a>.<a id="id71" class="indexterm"/>
</p><div><h3 class="title"><a id="tip02"/>Tip</h3><p>
<strong>Using jQuery UI's themeroller</strong>
</p><p>The theme used throughout this book is called<em> smoothness</em> and can be downloaded from<a class="ulink" href="http://jqueryui.com/themeroller/"> http://jqueryui.com/themeroller/</a> by choosing the<strong> Gallery</strong> tab and clicking the<strong> Download</strong> button below the<strong> Smoothness</strong> example. It is even possible to create a completely customized theme based on one of the standard themes by selecting one of the themes from the gallery and then tweaking it in the<strong> Roll Your Own</strong> tab. Once you're satisfied with the look you can download the result. Check the online documentation at<a class="ulink" href="http://jqueryui.com/docs/Getting_Started"> http://jqueryui.com/docs/Getting_Started</a> for all details.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec06"/>Serving an application</h1></div></div></div><p>The first task we set ourselves is serving content to the end user. In the end this should be useful content, of course, but let us first make certain that we can write a tiny web application that delivers some content at all.<a id="id72" class="indexterm"/>
</p></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec07"/>Time for action serving a dummy application</h1></div></div></div><p>Now that we have the necessary building blocks in place, we can start developing our application. Let's start with a very simple application:<a id="id73" class="indexterm"/>
</p><div><ol class="orderedlist"><li class="listitem">Go to the directory where you unpacked the example code.</li><li class="listitem">Go to the directory<code class="literal"> Chapter 2</code>.</li><li class="listitem">Double-click the file<code class="literal"> nocontent.py</code>, a text window will open (alternatively you can enter the command<code class="literal"> python nocontent.py</code> from the command line):<div><img src="img/3746_2_1.jpg" height="169" alt="Time for action serving a dummy application"/></div></li><li class="listitem">Open your favorite browser and enter<code class="literal"> http://localhost:8080</code> in the address bar. You will be presented with a rather dull page:<a id="id74" class="indexterm"/><div><img src="img/3746_2_2.jpg" height="42" alt="Time for action serving a dummy application"/></div></li></ol></div><div><h3 class="title"><a id="tip04"/>Tip</h3><p>If your browser is unable to connect to<code class="literal"> http://localhost:8080</code>, this might be because your local name server is not configured to resolve the name<a class="ulink" href="http://localhost"> localhost</a>. If you do not have the means to correct this, it is equally valid, though less convenient, to enter<code class="literal"> http://127.0.0.1:8080</code> in the address bar of your browser.</p><p>It is also possible that the default port that the application will be listening on (8080) is already in use, in which case, Python will raise an exception:<strong> IOError: Port 8080 not free on '127.0.0.1'</strong>. If that is the case, we can configure CherryPy to listen on a different port (see the info box in the next section).</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec03"/>What just happened?</h2></div></div></div><p>Double-clicking<code class="literal"> nocontent.py</code> caused the Python interpreter to start and execute the script. This opened up a console window where the CherryPy framework logged the fact that it started and that it will be listening on port<code class="literal"> 8080</code> at<code class="literal"> 127.0.0.1</code> (the so called loop back IP-address of the local machine, an address present on the machine even if it is not connected to the Internet).<a id="id75" class="indexterm"/>
</p><p>This address and port are the ones we point our browser to, after which the HTTP server provides us with an HTML file, and a couple of JavaScript files to serve the application. Each file that is retrieved by the browser is logged in the console window together with a status. This will be convenient for spotting the missing files, for example.</p><p>Our script can be stopped from serving requests by closing the console window or by pressing<em> Ctrl</em> +<em> Break</em> (on Windows) or<em> Ctrl</em> +<em> C</em> (on Windows and most other platforms).</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec08"/>Time for action serving HTML as dynamic content</h1></div></div></div><p>We have seen how to run an application and access it with a web browser, now let's have a look at the Python code needed to accomplish this. We will need to serve static files but in addition to those static files we want to generate the main HTML content dynamically. This isn't strictly necessary as we could have served it as a static file just as easily but it serves as a simple example of how to generate dynamic content:<a id="id76" class="indexterm"/>
</p><p>
<strong>Chapter2/nocontent.py</strong>
</p><div><pre class="programlisting">
import cherrypy
import os.path<strong>
current_dir = os.path.dirname(os.path.abspath(__file__))</strong>
</pre></div><p>You can download the example code files for all Packt books you have purchased from your account at<a class="ulink" href="http://www.PacktPub.com"> http://www.PacktPub.com</a>. If you purchased this book elsewhere, you can visit<a class="ulink" href="http://www.PacktPub.com/support"> http://www.PacktPub.com/support</a> and register to have the files e-mailed directly to you.</p><p>
<code class="literal">nocontent.py</code> starts off with importing the<code class="literal"> cherrypy</code> and<code class="literal"> os.path</code> modules. The latter is needed to determine the directory that<code class="literal"> nocontent.py</code> resides in (highlighted), so that we may refer to other static files and directories relative to<code class="literal"> nocontent.py</code>. This way, we make life a lot easier once we want to move this application to its final destination on a production server.</p><p>
<strong>Chapter2/nocontent.py</strong>
</p><div><pre class="programlisting">
class Root(object): ... &lt;omitted&gt; ...
if __name__ == "__main__":<strong>
	cherrypy.quickstart(Root(),config={</strong>
		'/static':
		{ 'tools.staticdir.on':True,
			'tools.staticdir.dir':os.path.join(current_dir,"static")
		}
	})
</pre></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec04"/>What just happened?</h2></div></div></div><p>The next step is to start the CherryPy server with the<code class="literal"> quickstart()</code> function (highlighted). We pass two arguments: the first one is an object instance of a class that exposes some methods to CherryPy that may deliver dynamic content. We will look at that one in a minute.<a id="id77" class="indexterm"/>
</p><p>The second (named) argument is a dictionary containing a number of configuration items. In this case, we configure just a static directory, but in other situations, additional configuration items may appear here. The URL component<code class="literal"> /static</code> is made to refer to a location on the file-system relative to<code class="literal"> nocontent.py</code> by concatenating to the<code class="literal"> current_dir</code> determined earlier. Again we use a function from Python's<code class="literal"> os.path</code> module,<code class="literal"> os.path.join()</code>, to create a file path in a platform-independent manner.</p><p>The<code class="literal"> static</code> directory contains all jQuery and jQuery UI files we will need for this application along with all CSS files and images to style the application. In this example, without real content there are no additional files besides the ones belonging to the jQuery and jQuery UI libraries, but if we needed them, we could have placed them here.</p><div><h3 class="title"><a id="note05"/>Note</h3><p>If we would like CherryPy to listen on a different port, we should indicate this in the global configuration. This can be done by preceding the call to<code class="literal"> cherrypy.quickstart()</code> with<code class="literal"> cherrypy.config.update({'server.socket_port':8088})</code>. CherryPy has a rich palette of configuration options and can even be instructed to read its configuration from files. A good starting point for all the possibilities is<a class="ulink" href="http://www.cherrypy.org/wiki/ConfigAPI"> http://www.cherrypy.org/wiki/ConfigAPI</a>.</p></div><p>We still have to implement a<code class="literal"> Root</code> class to provide CherryPy with an object instance that may act as the root of the document hierarchy that CherryPy may serve. This class should actually be defined before we can create an instance to pass to the<code class="literal"> quickstart()</code> method, but I wanted to concentrate on how to start the server first before concentrating on producing content:</p><p>
<strong>Chapter2/nocontent.py</strong>
</p><div><pre class="programlisting">
class Root(object):
	content = '''... &lt;omitted&gt; ...'''<strong>
	@cherrypy.expose</strong>
	def index(self):
			return Root.content
</pre></div><p>This<code class="literal"> Root</code> class contains a single class variable<code class="literal"> content</code> that holds the HTML code we will serve. We will examine it in detail in the next section. This HTML is generated by the<code class="literal"> index()</code> method and passed to the HTTP server that in its turn will pass it on to the requesting browser.</p><p>It is<strong> exposed</strong> to CherryPy by the<code class="literal"> @cherrypy.expose</code> decorator (highlighted). Only exposed methods will be called by CherryPy to produce content. In the default configuration, CherryPy will map a URL of the form<code class="literal"> /name</code> to a method called<code class="literal"> name()</code>. A URL containing just a forward slash<em> /</em> will map to a method called<code class="literal"> index()</code>, just like the one we defined here. This means we have now configured CherryPy to deliver dynamic content when the user directs his browser to<code class="literal"> http://127.0.0.1:8080/</code> (and he may even omit the final slash as CherryPy effectively ignores a trailing slash by default).<a id="id78" class="indexterm"/>
</p><p>Note that we let<code class="literal"> index()</code> return the contents of a single string variable but we could have returned just about anything, making this a truly dynamic way of producing content.</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec05"/>Who serves what: an overview</h2></div></div></div><p>Serving an application from a mixture of dynamic and static content may quickly become confusing. It might help to form a clear picture early on of the relations between components, of data streams, and directory structures used. This builds on the general picture sketched in<a class="link" href="ch01.html" title="Chapter 1. Choosing Your Tools"> Chapter 1</a> and will get extended in each chapter.</p><p>Almost all applications in this book are served from the same directory structure:</p><div><img src="img/3746OS_02_08.jpg" height="153" alt="Who serves what: an overview"/></div><p>The top-level directory contains one or more Python files that you can execute and that will start a CherryPy server. Those Python files implement the server-side of an application. They may import additional modules from the same top-level directory.<a id="id79" class="indexterm"/>
</p><p>The top-level directory also contains a subdirectory called<code class="literal"> static</code>. It holds several JavaScript files, including the jQuery and jQuery UI libraries and any additional plugins. It also contains a directory called<code class="literal"> css</code> that contains one or more subdirectories with additional CSS stylesheets and images for jQuery UI themes.</p><p>Note that although our applications are served by a web server, there are no HTML files to be seen because all HTML content is generated dynamically.</p><p>From an application point of view, the best way to comprehend a web application is to see the application as distributed. Some of its code (in our case Python) runs on the server, while other code (JavaScript) runs in the browser. Together, they make up the complete application as visualized in the following image:</p><div><img src="img/3746OS_02_07.jpg" width="220" alt="Who serves what: an overview"/></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec06"/>Pop quiz serving content with CherryPy</h2></div></div></div><p>We made the choice to serve our content from the<code class="literal"> index()</code> method so users could get the content by referring to the URL ending in just a slash (/). But what if we would like our content to be accessed by referring to a URL like<a class="ulink" href="http://127.0.0.1/content?"> http://127.0.0.1/content?</a> What would have to change?<a id="id80" class="indexterm"/>
</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec07"/>HTML: separating form and content</h2></div></div></div><p>Almost always, it is a good idea to separate form and content. This enables us to concentrate on the logical structure of the information we want to present and makes it easier to change the appearance of the data later. This even allows for applying themes in a maintainable way.<a id="id81" class="indexterm"/>
</p><p>The structure of our data is laid down in the HTML we deliver to the browser. To be more precise, the structural data can be found within the<code class="literal">&lt;body&gt;</code> element, but the<code class="literal">&lt;head&gt;</code> element of the HTML contains important information as well. For example, references to stylesheets and JavaScript libraries that will be used to style the appearance of the data and enhance the user interaction.<a id="id82" class="indexterm"/>
</p><p>In the following code, we use a<code class="literal">&lt;link&gt;</code> element to refer to a CSS stylesheet from a theme we downloaded from the jQuery UI website (highlighted). In this example, we do not actually use this stylesheet and nor are the jQuery and jQuery UI libraries included in the<code class="literal">&lt;script&gt;</code> elements, but this example shows how to refer to those libraries from the HTML we produce, and in the following examples, we will see that this is also the spot where we refer to any additional JavaScript libraries that we will create ourselves. The actual content is enclosed in the highlighted<code class="literal">&lt;div&gt;</code> element.<a id="id83" class="indexterm"/>
</p><div><pre class="programlisting">
&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"&gt;
&lt;html&gt;
&lt;head&gt;<strong>
&lt;link rel="stylesheet"
href="static/css/redmond/jquery-ui-1.8.1.custom.css"
type="text/css" media="screen, projection" /&gt;</strong>
&lt;script type="text/javascript"
	src="img/jquery-1.4.2.js" &gt;&lt;/script&gt;
&lt;script type="text/javascript"
	src="img/jquery-ui-1.8.1.custom.min.js" &gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body id="spreadsheet_example"&gt;<strong>
&lt;div id="example"&gt;an empty div&lt;/div&gt;</strong>
&lt;/body&gt;
&lt;/html&gt;
</pre></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec09"/>Time for action a unit convertor</h1></div></div></div><p>Serving just a piece of text isn't very useful, so our next step is to add some HTML content and enhance the display and functionality with JavaScript:<a id="id84" class="indexterm"/>
</p><div><ol class="orderedlist"><li class="listitem">Go to the same directory where<code class="literal"> nocontent.py</code> could be found.</li><li class="listitem">Double-click the file<code class="literal"> unitconvertor.py</code>, CherryPy console will again open in a text window.</li><li class="listitem">Enter<code class="literal"> http://localhost:8080</code> in the address bar of your browser (or click refresh if it is still open on that address). You will now see a small unit convertor:<div><img src="img/3746_2_3.jpg" height="47" alt="Time for action a unit convertor"/></div></li></ol></div><p>You can enter any number (with an optional fraction) in the text input on the left and after selecting the units to convert from and to, pressing the<strong> convert</strong> button will present you with the converted number on the right.</p><div><div><div><div><h2 class="title"><a id="ch02lvl2sec08"/>What just happened?</h2></div></div></div><p>The basic structure of our web application hasn't changed. The content we deliver is different but that hardly changes the Python code we need to deliver it. The actual content, that is the HTML we deliver when the<code class="literal"> index()</code> function is invoked, does differ as it has to define the<code class="literal">&lt;form&gt;</code> elements that our unit convertor consists of and we want to execute some JavaScript as well.<a id="id85" class="indexterm"/>
</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec09"/>HTML: form-based interaction</h2></div></div></div><p>The<code class="literal">&lt;head&gt;</code> portion of the HTML doesn't have to be changed as it already refers to the stylesheet and JavaScript libraries we want to use. However, we do have to change the<code class="literal">&lt;body&gt;</code> element to contain the structural elements that make up our unit convertor.<a id="id86" class="indexterm"/>
</p><p>The unit convertor is structured as a<code class="literal">&lt;form&gt;</code> element (highlighted). It contains two drop-down lists to select the units to convert, both implemented with<code class="literal">&lt;select&gt;</code> elements, and a text<code class="literal">&lt;input&gt;</code> element where the user can enter a number. A second text<code class="literal">&lt;input&gt;</code> element is used to display the result of the conversion. This one is set to read only as it is not meant to receive input from the user. The final element is a<code class="literal">&lt;button&gt;</code> that the user may click to initiate the conversion.</p><p>You may have noticed that the<code class="literal">&lt;form&gt;</code> element lacks an<code class="literal"> action</code> attribute. This is intentional as there is no interaction with a server. The conversion that happens when the user clicks the button is completely implemented in JavaScript. This JavaScript is included (and executed) in the final script element (highlighted). We will examine this script in the next section.</p><div><pre class="programlisting">
&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/
TR/html4/strict.dtd"&gt;
&lt;html&gt;
&lt;head&gt;
&lt;link rel="stylesheet" href="static/css/redmond/jquery-ui-
1.8.1.custom.css" type="text/css" media="screen, projection" /&gt;
&lt;script type="text/javascript" src="img/jquery-1.4.2.js" &gt;&lt;/script&gt;
&lt;script type="text/javascript" src="static/jquery-ui-1.8.1.custom.min.
js" &gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body id="spreadsheet_example"&gt;
&lt;div id="example"&gt;
	&lt;form id="unitconversion"&gt;
	&lt;input name="from" type="text" value="1" /&gt;
	&lt;select name="fromunit"&gt;
		&lt;option selected="true"&gt;inch&lt;/option&gt;
		&lt;option&gt;cm&lt;/option&gt;
	&lt;/select&gt;
	&lt;label for="to"&gt;=&lt;/label&gt;
	&lt;input name="to" type="text" readonly="true" /&gt;
	&lt;select name="tounit"&gt;
		&lt;option&gt;inch&lt;/option&gt;
		&lt;option selected="true"&gt;cm&lt;/option&gt;
	&lt;/select&gt;
	&lt;button name="convert" type="button"&gt;convert&lt;/button&gt;
	&lt;/form&gt;
&lt;/div&gt;<strong>
&lt;script type="text/javascript" src="img/unitconverter.js" &gt;&lt;/script&gt;</strong>
HTMLHTMLform based interaction&lt;/body&gt;
&lt;/html&gt;
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec10"/>JavaScript: using jQuery UI widgets</h2></div></div></div><p>Screen elements or<strong> widgets</strong> are essential to let the end user interact with you application. These widgets might be simple buttons that initiate some action when the user clicks them or more complex widgets like drop-down boxes, radio buttons, or even little calendars that let you pick a date. The jQuery UI library provides a large number of predefined and easy to configure widgets, and so our next step is to use jQuery UI to let the button in our conversion application react to a click of the mouse and initiate the unit conversion.<a id="id88" class="indexterm"/>
</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec10"/>Time for action conversion using unitconverter.js</h1></div></div></div><p>
<code class="literal">unitconverter.js</code> contains the necessary JavaScript code to do the actual conversion. It starts with the definition of a conversion map, a dictionary holding the conversion factors for any conversion we want to define. We restrict ourselves to conversions from inches to centimeters and vice versa, but additional conversion factors can easily be added.<a id="id89" class="indexterm"/>
</p><div><pre class="programlisting">
conversion_map = {
	"inch cm":1.0/2.54,
	"cm inch":2.54
};<strong>
$("button").button().click(function(){</strong>
		value=$("input[name='from']").val();
		f=$("select[name='tounit'] option:selected").val();
		t=$("select[name='fromunit'] option:selected").val();
		if(f != t){
			c=conversion_map[f+' '+t];
			result=parseFloat(value)*c;
		}else{
			result = value;
		}
		$("input[name='to']").val(result);
	}
);
$("form *").addClass("ui-widget");
</pre></div><p>The highlighted line in the previous code is our first encounter with the jQuery and jQuery UI libraries and deserves some close attention. The<code class="literal"> $("button")</code> part selects all<code class="literal">&lt;button&gt;</code> elements on the page. In this case, it will be just a single one. This<code class="literal">&lt;button&gt;</code> element is converted to a button widget from the jQuery UI library with the<code class="literal"> button()</code> method. This is a simple widget that styles an element as a recognizable button that will be easy to theme and customize.</p><div><div><div><div><h2 class="title"><a id="ch02lvl2sec11"/>What just happened?</h2></div></div></div><p>What actually happens once the user clicks the button is defined by the anonymous function we pass as a<strong> click handler</strong> to the button element with the<code class="literal"> click()</code> method. This anonymous function is called each time the user clicks the button.</p><p>The first thing this handler does is retrieve the contents of the text<code class="literal">&lt;input&gt;</code> element with a<code class="literal"> name</code> attribute equal to<strong> from</strong> with<code class="literal"> $("input[name='from']").val()</code>. Next, it retrieves the currently selected units from both<code class="literal">&lt;select&gt;</code> elements.</p><p>If those units are not the same, it fetches the conversion factor from the conversion map with the concatenated units as a key. The result of the conversion is calculated by multiplying the conversion factor and the contents of the<code class="literal">&lt;input&gt;</code> element. The content we retrieve of any<code class="literal">&lt;input&gt;</code> element is always returned as a string, therefore we have to use the built-in JavaScript function<code class="literal"> parseFloat()</code> to interpret it as a floating point number. If both units are equal, the result is simply the same as the input value.</p><p>The calculated result is stored in the text<code class="literal">&lt;input&gt;</code> element with a<code class="literal"> name</code> attribute of<code class="literal"> to</code>. Note that even though this element has a read-only attribute to prevent the user from entering any text, we can still alter its content within a script.</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec12"/>Pop quiz adding an icon to a button</h2></div></div></div><p>A button with just simple text might be appropriate for many applications but it would look much better, if it showed an appropriate icon as well. Knowing that the button widget is highly configurable, how would you add an icon to your button?</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec13"/>Have a go hero adding a dynamic title</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The HTML we served in the<code class="literal"> nocontent.py</code> example was simply the contents of a class variable, so not really dynamic! What all would we have to do if we wanted to serve HTML containing a<code class="literal">&lt;title&gt;</code> element that shows the current date?<a id="id90" class="indexterm"/></li><li class="listitem" style="list-style-type: disc">Hint: A<code class="literal">&lt;title&gt;</code> element should be contained inside the<code class="literal">&lt;head&gt;</code> element. So instead of returning all the HTML in one go, you could rewrite the Python code to return HTML composed of three parts: The first and last parts are pieces of static HTML and the middle part is a dynamically generated string representing a<code class="literal">&lt;title&gt;</code> element containing a date. That date could be obtained from Python's<code class="literal"> asctime()</code> function found in the standard<code class="literal"> time</code> module.</li><li class="listitem" style="list-style-type: disc">A possible implementation can be found in the file<code class="literal"> nocontenttitle.py</code>.</li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec14"/>jQuery selectors</h2></div></div></div><p>jQuery selectors pop up in many locations and in a sense they are the focus of any JavaScript program that uses the jQuery library. A complete overview is out of the scope of this book (for that, refer to the appendix for some books on jQuery with extensive examples or check jQuery's documentation section on<a class="ulink" href="http://docs.jquery.com/Main_Page"> http://docs.jquery.com/Main_Page</a>, especially the part on selectors) but basically jQuery allows us to select any element or set of elements in a CSS 3-compliant fashion in a cross browser compatible way. In other words, it works even in browsers that do not yet support CSS 3.<a id="id91" class="indexterm"/>
</p><p>To give some idea of what is possible, some examples are given next, all of them assume an HTML document containing the following markup:</p><div><pre class="programlisting">
&lt;div id="main"&gt;
&lt;ul&gt;
&lt;li&gt;one&lt;/li&gt;
&lt;li class="highlight"&gt;two&lt;/li&gt;
&lt;li&gt;three&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div id="footer"&gt;footer text&lt;/div&gt;
</pre></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">To select all<code class="literal">&lt;li&gt;</code> elements:<code class="literal"> $("li")</code></li><li class="listitem" style="list-style-type: disc">To select just the first<code class="literal">&lt;li&gt;</code> element:<code class="literal"> $("li:first")</code></li><li class="listitem" style="list-style-type: disc">To select the<code class="literal">&lt;li&gt;</code> element with the class<code class="literal"> highlight: $(".highlight")</code></li><li class="listitem" style="list-style-type: disc">To select the<code class="literal">&lt;div&gt;</code> with an id equal to<code class="literal"> footer: $("#footer")</code></li></ul></div><p>The jQuery function (often represented by the alias<code class="literal"> $)</code> returns a jQuery object that refers to the collection of matched elements. A jQuery object has many methods to manipulate the elements in this collection. For example,<code class="literal"> $("li").addClass("red-background")</code> adds the red-background class to all<code class="literal">&lt;li&gt;</code> elements.</p><p>The jQuery UI library extends the available methods even further by adding functionality to change elements to standardized widgets. That is why in our example<code class="literal"> $("button").button()</code> alters the appearance of our button element to the stylized button widget that jQuery UI provides.<a id="id92" class="indexterm"/>
</p><p>Our example application also shows another important jQuery concept:<strong> chaining</strong>. Most jQuery and jQuery UI methods return the selection they operated on. That way, it is easy to call multiple methods on the same selection. In our example,<code class="literal"> $("button").button()</code> returns the selected button elements after transforming them into button widgets, which allows us to chain the click method to define mouse-click behavior by writing<code class="literal"> $("button").button().click(…)</code>.<a id="id93" class="indexterm"/>
</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec15"/>CSS: applying a jQuery UI theme to other elements</h2></div></div></div><p>The last line in<code class="literal"> unitconverter.js</code> shows how we can style any element in the same manner as the standard jQuery UI widgets. This is accomplished, in this case, by selecting all elements contained in the<code class="literal">&lt;form&gt;</code> element with<code class="literal"> $("form *")</code> and then adding the<code class="literal"> ui-widget</code> class with the<code class="literal"> addClass()</code> method.<a id="id94" class="indexterm"/>
</p><p>Any element adorned with the<code class="literal"> ui-widget</code> class will receive the same styling as any jQuery UI widget. In our case, this is visible in the font and colors used in the<code class="literal"> input</code> and<code class="literal"> select</code> elements. Even if we change the theme this change will be uniformly applied. There are more predefined classes available to allow for a more fine grained control and we will encounter those when we create our own jQuery UI plugin in the next section.</p><p>It is important to grasp the effect of one of the predefined jQuery UI classes to an element. Classes in themselves don't change the way elements are displayed but the jQuery UI framework associates various CSS style elements with the predefined classes. When the classes associated with an element change, the browser checks again which style elements to apply, effecting an immediate style change.</p><p>It is also possible to directly alter CSS styles associated with an element. However, defining styles for a certain class and altering the class makes it easier to maintain a consistent look without having to resort to individual style components for each and every element that you want to change.<a id="id95" class="indexterm"/>
</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec16"/>Have a go hero adding zebra stripes to a table</h2></div></div></div><p>An often required feature when styling HTML tables is to render the rows of tables with an alternating background color.<a id="id96" class="indexterm"/>
</p><p>Because jQuery allows us to use CSS 3-compliant selectors and add to an elements<code class="literal"> class</code> attribute with the<code class="literal"> .addClass()</code> method, this is now accomplished easily even in the browsers that do not support CSS 3.</p><p>Given the following sample HTML, what JavaScript should be added to the last<code class="literal">&lt;script&gt;</code> element to render the background of all even rows in light gray? (Hints: CSS 3 has an<code class="literal"> :even</code> selector and when you add a class to an element with jQuery, any CSS styles applicable to that class are re-evaluated).</p><p>Check<code class="literal"> zebra.html</code> to see a solution (It is included with the sample code for<a class="link" href="ch02.html" title="Chapter 2. Creating a Simple Spreadsheet"> Chapter 2</a>. Open the file in your browser to see the effect):</p><div><pre class="programlisting">
&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"&gt;
&lt;html&gt;
&lt;head&gt;
	&lt;script type="text/javascript" src="img/jquery-1.4.2.js" &gt;
	&lt;/script&gt;
	&lt;style&gt;
		.light-grey { background-color: #e0e0e0; }
	&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
	&lt;table&gt;
		&lt;tr&gt;&lt;td&gt;one&lt;/td&gt;&lt;td&gt;line 1&lt;/td&gt;&lt;/tr&gt;
		&lt;tr&gt;&lt;td&gt;two&lt;/td&gt;&lt;td&gt;line 2&lt;/td&gt;&lt;/tr&gt;
		&lt;tr&gt;&lt;td&gt;three&lt;/td&gt;&lt;td&gt;line 3&lt;/td&gt;&lt;/tr&gt;
		&lt;tr&gt;&lt;td&gt;four&lt;/td&gt;&lt;td&gt;line 4&lt;/td&gt;&lt;/tr&gt;
		&lt;tr&gt;&lt;td&gt;five&lt;/td&gt;&lt;td&gt;line 5&lt;/td&gt;&lt;/tr&gt;
		&lt;tr&gt;&lt;td&gt;siz&lt;/td&gt;&lt;td&gt;line 6&lt;/td&gt;&lt;/tr&gt;
	&lt;/table&gt;
	&lt;script type="text/javascript"&gt;
	/* insert some JavaScript here to color even rows grey */
	&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div><p>The result will look something like this in the browser (note that elements are numbered starting at zero, so maybe the result is not what you expected):<a id="id97" class="indexterm"/>
</p><div><img src="img/3746_2_4.jpg" height="96" alt="Have a go hero adding zebra stripes to a table"/></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec11"/>Time for action converting a unit convertor into a plugin</h1></div></div></div><p>Re-using one of the many well designed jQuery UI widgets is good as it saves us development and maintenance time but the true power of the jQuery UI framework is the manner in which it enables us to devise completely new widgets that merge seamlessly with the rest of the framework and are indistinguishable in their use from the standard widgets. To illustrate what is possible, let's implement our unit converter again, but this time as a jQuery plugin:<a id="id98" class="indexterm"/>
</p><div><ol class="orderedlist"><li class="listitem">Go to the directory containing the example code for<a class="link" href="ch02.html" title="Chapter 2. Creating a Simple Spreadsheet"> Chapter 2</a>.</li><li class="listitem">Double-click the file<code class="literal"> unitconverter2.py</code>, the CherryPy console will again open in a window.</li><li class="listitem">Enter<code class="literal"> http://localhost:8080</code> in the address bar of your browser (or click refresh if it is still open on that address). You will now see a slightly restyled unit converter:<div><img src="img/3746_2_5.jpg" height="53" alt="Time for action converting a unit convertor into a plugin"/></div></li></ol></div><p>The interaction with this new unit converter is exactly the same as our previous one.</p><div><div><div><div><h2 class="title"><a id="ch02lvl2sec17"/>What just happened?</h2></div></div></div><p>Instead of structuring a widget with a<code class="literal">&lt;form&gt;</code> element containing a number of additional elements, we now take a simpler approach. We will design a reusable unit converter widget that can be inserted into any<code class="literal">&lt;div&gt;</code> element. Our HTML backbone becomes much simpler now, as its body will just contain a single<code class="literal">&lt;div&gt;</code> element:<a id="id99" class="indexterm"/>
</p><div><pre class="programlisting">
&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/
TR/html4/strict.dtd"&gt;
&lt;html&gt;
&lt;head&gt;
&lt;link rel="stylesheet" href="static/css/redmond/jquery-ui-
1.8.1.custom.css" type="text/css" media="screen, projection" /&gt;
&lt;script type="text/javascript" src="img/jquery-1.4.2.js" &gt;&lt;/script&gt;
&lt;script type="text/javascript" src="static/jquery-ui-1.8.1.custom.min.
js" &gt;&lt;/script&gt;<strong>
&lt;script type="text/javascript" src="img/unitconverter2.js" &gt;&lt;/script&gt;</strong>
&lt;/head&gt;
&lt;body id="spreadsheet_example"&gt;
&lt;div id="example"&gt;&lt;/div&gt;
&lt;script type="text/javascript"&gt;<strong>
$("#example").unitconverter(
{
'km_mile':1.0/0.621371192,
'mile_km':0.621371192
});</strong>
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div><p>The first highlighted line includes the JavaScript file that contains the new implementation of the unit converter. We refer to the plugin defined in this file in the JavaScript code near the end of the<code class="literal">&lt;body&gt;</code> element (last highlighted line). This script refers to the<code class="literal">&lt;div&gt;</code> element to which we want to add a unit converter by its id (in this case<code class="literal"> #example)</code> and apply the<code class="literal"> unitconvertor()</code> method.</p><p>As we will see when we look at the JavaScript code that implements our converter plugin,<code class="literal"> unitconverter()</code> takes an option object as its single argument. This option object may contain any number of keys defining additional conversion factors for this instance of the plugin. In this case, we pass additional information to allow for conversion from miles to kilometers, and vice versa.<a id="id100" class="indexterm"/>
</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec18"/>Pop quiz adding conversions to a unitconverter instance</h2></div></div></div><p>What would the JavaScript look like when we want to add a unit converter plugin with the possibility of converting from cubic feet to liters?</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec19"/>JavaScript: creating a jQuery UI plugin</h2></div></div></div><p>All jQuery UI plugins are defined in the same way by adding a new function to the<code class="literal"> fn</code> attribute of the<code class="literal"> jQuery</code> object (the object we mostly refer to by its alias<code class="literal"> $)</code>. In<code class="literal"> unitconverter2.js</code>, this is exactly what we do, as it is seen in the first line of the following code.<a id="id101" class="indexterm"/>
</p><p>The next thing we do is merge any options passed to the plugin with defaults (highlighted). jQuery provides an<code class="literal"> extend()</code> method that merges the attributes of any number of objects and returns the first one. As we do not want to overwrite the default options that we have defined in<code class="literal"> $.fn.unitconverter.conversion_map</code>, we pass it an empty object. This object will receive the default attributes and any attributes defined in the<code class="literal"> options</code> object, overwriting the ones with a name that is the same. This set of merged attributes is stored in the<code class="literal"> cmap</code> variable:</p><div><pre class="programlisting">
jQuery.fn.unitconverter = function(options){<strong>
	var cmap = $.extend({},$.fn.unitconverter.conversion_map,options);</strong>
</pre></div><p>The conversion factors are referred to by keys of the form<code class="literal"> unit1_unit2</code>. To construct two drop-down selectors from the keys, we iterate over all these keys and use JavaScript's<code class="literal"> split()</code> method to retrieve the individual units (highlighted). These are then stored in the<code class="literal"> from</code> and<code class="literal"> to</code> arrays:</p><div><pre class="programlisting">
var from = new Array();
var to = new Array();<strong>
for (var key in cmap){</strong>
	var units = key.split("_");
	from.push(units[0]);
	to.push(units[1]);
}
</pre></div><p>The next step is to construct the HTML needed by the plugin to present to the user. The structure is similar to the handcrafted one used in the previous example, a<code class="literal">&lt;form&gt;</code> with<code class="literal">&lt;input&gt;</code> and<code class="literal">&lt;select&gt;</code> elements, and a<code class="literal">&lt;button&gt;</code>. The<code class="literal">&lt;form&gt;</code> element is adorned with a random id attribute. This way we may refer to it later even if there is more than one unit converter present on the page.</p><p>The<code class="literal">&lt;select&gt;</code> elements contain a number of<code class="literal">&lt;option&gt;</code> elements that are created by retrieving the unit names stored in the<code class="literal"> from</code> and<code class="literal"> to</code> arrays one-by-one with the<code class="literal"> pop()</code> method. The first of these options is selected by default (highlighted). The HTML code is then passed to the<code class="literal"> append()</code> method of<code class="literal"> this. this</code> is a variable that is available to the function implementing the plugin that contains the selected elements the plugin is applied to, in our example the<code class="literal">&lt;div&gt;</code> element with the<code class="literal"> #example</code> id:</p><div><pre class="programlisting">
	var id = "unitconverter" + new String(Math.floor(Math.random() 
* 255 * 255));
	var html = '&lt;form id="' + id + '"&gt;&lt;input name="from" type="text" 
value="1" /&gt;';
	html += '&lt;select name="fromunit"&gt;';<strong>
	html += '&lt;option selected="true"&gt;'+from.pop()+'&lt;/option&gt;';</strong>
	var len = from.length;
	for (var i=0; i&lt;len; i++){
html += '&lt;option&gt;' + from.pop() + '&lt;/option&gt;' };
	html += '&lt;/select&gt; = ';
	html += '&lt;input name="to" type="text" readonly="true" /&gt;';
	html += '&lt;select name="tounit"&gt;';
	html += '&lt;option selected="true"&gt;' + to.pop() + '&lt;/option&gt;';
	var len = to.length;
	for (var i=0; i&lt;len; i++){
html += '&lt;option&gt;' + to.pop() + '&lt;/option&gt;'};
	html += '&lt;/select&gt;';
	html += '&lt;button name="convert" type="button"&gt;convert&lt;/button&gt;'
html += '&lt;/form&gt;';
	this.append(html);
</pre></div><p>The randomly generated id for the form element now comes in handy to select just the<code class="literal">&lt;button&gt;</code> element within the form we are currently constructing and convert it to a button: we construct a suitable selector by concatenating relevant parts with<code class="literal"> "#"+id+" button</code>".<a id="id102" class="indexterm"/>
</p><p>Note that it is perfectly valid to include other plugins or widgets within a custom plugin. This time we choose to construct a slightly different looking button with just an icon and no text by passing an appropriate options object. From the numerous icons shipped with jQuery UI, we choose the one that represents the function of the button best:<code class="literal"> ui-icon-refresh</code> (highlighted).</p><p>The conversion that happens when the user clicks the button is implemented by a function that we will encounter shortly and that is passed by the button object (available to the<code class="literal"> click()</code> method as the<code class="literal"> this</code> variable) and the merged map of conversion factors:</p><div><pre class="programlisting">
$("#"+id+" button").button({
			icons: {<strong>
					primary: 'ui-icon-refresh'</strong>
			},
			text: false
	}).click(function(){return convert(this,cmap);});
</pre></div><p>The finishing touch is to style our widget in a consistent manner. jQuery provides us with a<code class="literal"> css()</code> method that allows us to directly manipulate the style attributes of any element. We first deal with a layout matter: we apply a<code class="literal"> float:left</code> style to the<code class="literal">&lt;form&gt;</code> element to make sure it doesn't fill the page completely, but shrink/wraps itself around the elements it contains:</p><div><pre class="programlisting">
$("#"+id).css('float','left');
</pre></div><p>We then copy a number of background style attributes from the<code class="literal">&lt;button&gt;</code> element to the<code class="literal">&lt;form&gt;</code> element to give the<code class="literal">&lt;form&gt;</code> element a look that is consistent with the theme applied to the standard button widget. Other style elements from the theme like font face and font size are applied to the form element by adding the<code class="literal"> ui-widget</code> class (highlighted). We end by returning the<code class="literal"> this</code> variable (which in our example contains the<code class="literal">&lt;div&gt;</code> element we selected, but now with the<code class="literal">&lt;form&gt;</code> element we just added to it). This allows for chaining additional jQuery methods:</p><div><pre class="programlisting">
	$("#"+id).css('background-color',
$("#"+id+" button").css('background-color'));
	$("#"+id).css('background-image',
$("#"+id+" button").css('background-image'));
	$("#"+id).css('background-repeat',
$("#"+id+" button").css('background-repeat'));<strong>
	$("#"+id).addClass("ui-widget");</strong>
	return this;
};
</pre></div><p>Of course, we still need to define a function that does the actual conversion when the button of the unit converter is clicked. It differs slightly from the previous implementation.<a id="id103" class="indexterm"/>
</p><p>The<code class="literal"> convert()</code> function is passed both the<code class="literal">&lt;button&gt;</code> element that is clicked and a map with conversion factors. The<code class="literal">&lt;form&gt;</code> element enclosing the button is determined with the<code class="literal"> parent()</code> method and stored in the<code class="literal"> form</code> variable.</p><p>The input value we want to convert is retrieved from the<code class="literal">&lt;input&gt;</code> element with a<code class="literal"> name</code> attribute equal to<code class="literal"> from</code>. We can find this specific element by selecting all children of the<code class="literal">&lt;form&gt;</code> element stored in<code class="literal"> form</code> and filtering these children by passing a suitable selector to the<code class="literal"> .children()</code> method (highlighted).</p><p>In a similar way, we determine which option is selected in the two<code class="literal">&lt;select&gt;</code> elements:</p><div><pre class="programlisting">
function convert(button,cmap){
	var form = $(button).parent();<strong>
	var value = form.children("input[name='from']").val();</strong>
	var f = form.children("select[name='tounit']").
children("option:selected").val();
	var t = form.children("select[name='fromunit']").
children("option:selected").val();
</pre></div><p>What is left is the actual conversion. If the conversion units are not equal, we retrieve the conversion factor from the map (highlighted) and then multiply it by the contents of the<code class="literal">&lt;input&gt;</code> element interpreted as a floating point number. If the input can't be interpreted as a floating point number or there wasn't a suitable conversion factor in the map, the result of the multiplication is a<code class="literal"> NaN</code> (Not a Number) and we signal that fact by placing an error text in the result. However, we convert the result to a number with four decimal digits with JavaScript's<code class="literal"> toFixed()</code> method if everything goes well:</p><div><pre class="programlisting">
var result = value;
	if(f != t){<strong>
		var c=cmap[f+'_'+t];</strong>
		result=parseFloat(value)*c;
		if (isNaN(result)){
				result = "unknown conversion factor";
		}else{
				result = result.toFixed(4);
		}
	}
	form.children("input[name='to']").val(result);
};
</pre></div><p>
<code class="literal">unitconverter2.py</code> concludes by defining an object with defaults:</p><div><pre class="programlisting">
jQuery.fn.unitconverter.conversion_map = {
	inch_cm":1.0/2.54,
	"cm_inch":2.54
}
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec20"/>Pop quiz changing option defaults</h2></div></div></div><p>If we would:</p><div><ol class="orderedlist"><li class="listitem">Add a unitconvertor to a &lt;div&gt; element with an ID #first.</li><li class="listitem">Add the possibility of converting from cubic feet to liters to the default conversion map.</li><li class="listitem">And finally, add a unitconverter to a &lt;div&gt; element with an id #last.</li></ol></div><p>The code would look something like this:</p><div><pre class="programlisting">
$("#first").unitconverter();
$.extend($.fn.unitconverter.conversion_map, {'cubic feet_
litres':1.0/28.3168466});
$("#last").unitconverter();
</pre></div><p>If we would execute the preceding code, which &lt;div&gt; element(s) would get a unitconverter with the added conversion possibility?</p><div><ol class="orderedlist"><li class="listitem">The div with the #first ID</li><li class="listitem">The div with the #last ID</li><li class="listitem"> Both</li></ol></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec12"/>Designing a spreadsheet application</h1></div></div></div><p>Our goal for this chapter was to be able to present the user with a simple spreadsheet application and we are nearly there. We know how to serve HTML and we saw how we can implement a custom jQuery UI widget, so let's apply that knowledge to designing a spreadsheet plugin. First let's see how it will look:<a id="id105" class="indexterm"/>
</p></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec13"/>Time for action serving a spreadsheet application</h1></div></div></div><p>Go to the directory containing the example code for<a class="link" href="ch02.html" title="Chapter 2. Creating a Simple Spreadsheet"> Chapter 2:</a>
<a id="id106" class="indexterm"/>
</p><div><ol class="orderedlist"><li class="listitem">Double-click the file<code class="literal"> spreadsheet.py</code>, the now familiar CherryPy console will open in a text window.</li><li class="listitem">Enter<code class="literal"> http://localhost:8080</code> in the address bar of your browser (or click refresh if it is still open on that address). You will now see a simple spreadsheet application:<div><img src="img/3746_2_6.jpg" height="144" alt="Time for action serving a spreadsheet application"/></div></li><li class="listitem">You can click on any cell to edit its formula. You should not start a formula with an equal sign:<strong> 42, D2+19</strong> and<strong> "text</strong>" (including the double quote marks) are examples of valid formulas. In fact, any JavaScript expression is valid.</li></ol></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec21"/>What just happened?</h2></div></div></div><p>The spreadsheet application served to the end user consists of two major parts, HTML to structure the spreadsheet and some JavaScript to provide interaction. We look at each of these in turn.<a id="id107" class="indexterm"/>
</p></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec22"/>HTML: keeping it simple</h2></div></div></div><p>The HTML we need for our spreadsheet is nearly identical to the one for the unit converter. The highlighted lines in the following code show the differences.<code class="literal"> spreadsheet.js</code> contains the definition of the plugin and the final<code class="literal">&lt;script&gt;</code> element inserts an 8x10 spreadsheet into the<code class="literal"> #example</code> div. Converting a<code class="literal">&lt;div&gt;</code> element to a fully functional spreadsheet widget is just as simple as converting to the standard button widget!<a id="id108" class="indexterm"/>
</p><div><pre class="programlisting">
&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/
TR/html4/strict.dtd"&gt;
&lt;html&gt;
&lt;head&gt;
&lt;link rel="stylesheet"
href="static/css/redmond/jquery-ui-1.8.1.custom.css" type="text/css" media="screen, projection" /&gt;
&lt;script type="text/javascript"
src="img/jquery-1.4.2.js" &gt;&lt;/script&gt;
&lt;script type="text/javascript"
src="img/jquery-ui-1.8.1.custom.min.js" &gt;&lt;/script&gt;
&lt;script type="text/javascript"
src="img/jeditable.js" &gt;&lt;/script&gt;<strong>
&lt;script type="text/javascript"
src="img/spreadsheet.js" &gt;&lt;/script&gt;</strong>
&lt;/head&gt;
&lt;body id="spreadsheet_example"&gt;
&lt;div id="example"&gt;&lt;/div&gt;
&lt;script type="text/javascript"&gt;<strong>
$("#example").sheet({cols:8,rows:10});</strong>
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec23"/>JavaScript: creating a spreadsheet plugin</h2></div></div></div><p>The file<code class="literal"> spreadsheet.js</code> contains all JavaScript code needed to implement a reusable spreadsheet widget. The spreadsheet is very similar to our unit converter from a jQuery perspective although the actual JavaScript to implement the user interaction is somewhat more involved. Again our plugin is a function that is associated with jQuery's<code class="literal"> fn</code> attribute as it can be seen in the very first line in the following code, where we define our widget with the name<code class="literal"> sheet</code>.</p><p>Next we merge the default options for the sheet plugin (defined at the end of the file) with the options passed to the function:<a id="id109" class="indexterm"/>
</p><div><pre class="programlisting">
jQuery.fn.sheet = function(options){
	var opts = $.extend({}, $.fn.sheet.defaults, options);
</pre></div><p>The next step is to create a table that will represent our spreadsheet. We create this<code class="literal">&lt;table&gt;</code> element with a number of associated classes: its very own<code class="literal"> sheet</code> class to make it easily recognizable as a sheet plugin once created, a<code class="literal"> ui-helper-reset</code> class that will cause suitable CSS to be applied by jQuery to reset any unwanted default styling added by the browser and finally a<code class="literal"> ui-widget</code> class that will cause the selected theme to be applied. Then we create the table contents step-by-step by adding the needed HTML to a variable<code class="literal"> t</code> in incremental steps:</p><div><pre class="programlisting">
/* create a cols x rows grid */
var t='&lt;table class="sheet ui-helper-reset ui-widget"
cellspacing="0"&gt;';
</pre></div><p>The table contains a<code class="literal">&lt;thead&gt;</code> element that will be styled as a<code class="literal"> ui-widget-header</code>. It contains a single row of<code class="literal">&lt;th&gt;</code> elements. These<code class="literal">&lt;th&gt;</code> elements contain the column label, a capital letter that we construct from the column index with the<code class="literal"> fromCharCode()</code> method (highlighted):</p><div><pre class="programlisting">
	t=t+'&lt;thead class="ui-widget-header"&gt;
&lt;tr class="ui-helper-reset"&gt;&lt;th&gt;&lt;/th&gt;';
	for(i=0;i&lt;opts.cols;i=i+1){<strong>
	t=t+'&lt;th class="ui-helper-reset"&gt;' +
String.fromCharCode(65+i)+"&lt;/th&gt;";</strong>
	}
</pre></div><p>The body of the table consists of a<code class="literal">&lt;tbody&gt;</code> element containing a number of rows with<code class="literal">&lt;td&gt;</code> elements. The first<code class="literal">&lt;td&gt;</code> element of each row contains the row label (a number) and will be styled as a<code class="literal"> ui-widget-header</code> just like the column labels. The regular cells, that is the ones that will contain our formulas and values, will belong to the class<code class="literal"> ui-widget-content</code> to style them in an appropriate manner. These cells will also belong to a class<code class="literal"> cell</code> to make them easy to distinguish when we add additional functionality to them (highlighted).</p><p>There is initially no content in such a cell except for a<code class="literal">&lt;span&gt;</code> element that will contain the formula and that will be styled as<code class="literal"> ui-helper-hidden</code>, rendering the formula invisible. The value of the evaluated formula will be stored both as text content in the<code class="literal">&lt;td&gt;</code> element (side-by-side with the<code class="literal">&lt;span&gt;</code> element) and as a global variable with a name equal to the name of the cell. A global variable in this context is a named attribute of the top-level<code class="literal"> window</code> object defined by the browser that may be accessed as<code class="literal"> window[name]</code>.</p><p>Storing the value of a cell in a global variable as well allows us to use any JavaScript expression as the formula in a cell because we can now refer to the value of any other cell by name.<code class="literal"> A1+B3*9</code>, for example will be a perfectly valid expression because<code class="literal"> A1</code> and<code class="literal"> B3</code> will be defined as global variables:</p><div><pre class="programlisting">
t=t+'&lt;/tr&gt;&lt;/thead&gt;&lt;tbody class="ui-widget-content" &gt;';
for(i=0;i&lt;opts.rows;i=i+1){
		t=t+'&lt;tr class="ui-helper-reset"&gt;
		&lt;td class="rowindex ui-helper-reset ui-widget-header"&gt;'
				+ (i+1)+"&lt;/td&gt;";
		for(j=0;j&lt;opts.cols;j=j+1){
			id=String.fromCharCode(65+j)+(i+1)<strong>
			t=t+'&lt;td class="cell ui-helper-reset ui-widget-content" 
			id="'+id+'"&gt;
				&lt;span class="formula ui-helper-hidden"&gt;
				&lt;/span&gt;&lt;/td&gt;';</strong>
				/* create a global variable */
				window[id]=0
		}
		t=t+"&lt;/tr&gt;";
}
t=t+"&lt;/tbody&gt;&lt;/table&gt;";
this.append(t);
</pre></div><p>The HTML for the table we created in the<code class="literal"> t</code> variable is then inserted into the jQuery selection that we applied the<code class="literal"> sheet()</code> method with the<code class="literal"> .append()</code> method of the<code class="literal"> this</code> object. The<code class="literal"> this</code> object is available to any function defining a plugin and holds the current jQuery selection.<a id="id110" class="indexterm"/>
</p><p>To edit a cell, we will employ the jEditable plugin. This plugin will take care of the user interaction when the user clicks a cell to edit its content. To do this it needs functions to get and set the contents of a cell.</p><div><h3 class="title"><a id="note06"/>Note</h3><p>The jEditable plugin we use here is included in the example code distributed with this chapter. The latest version can be obtained from Mika Tuupola's website:<a class="ulink" href="http://www.appelsiini.net/projects/jeditable"> http://www.appelsiini.net/projects/jeditable</a>. It comes with a pretty comprehensive set of documentation. Turning a<code class="literal">&lt;td&gt;</code> element into something that changes into an editable textbox when the user clicks on it with a mouse, is as simple as selecting the element and invoking the<code class="literal"> editable()</code> method. For example,<code class="literal"> $(".editable").editable("<a class="ulink" href="http://www.example.com/save">http://www.example.com/save</a>")</code> will render any element with the<code class="literal"> editable</code> class into an editable textbox once clicked and will send the edited contents to the URL passed as the first parameter to the<code class="literal"> editable()</code> method. The jEditable plugin comes with a host of options and we will encounter a few of them when we employ the jEditable plugin to do the editing of the spreadsheet cells.</p></div><p>We need to define a function that will be invoked by jEditable for extracting the content of the element. This function will require two arguments:</p><div><ol class="orderedlist"><li class="listitem">The element we are editing (a<code class="literal">&lt;td&gt;</code> element in our example).</li><li class="listitem">The original settings passed to the jEditable plugin. Those settings we ignore for now.</li></ol></div><p>The<code class="literal">&lt;td&gt;</code> elements are structured in such a way that the formula itself is stored in a (hidden) span element. The<code class="literal"> getvalue()</code> function then must get access to this<code class="literal">&lt;span&gt;</code> element first before it can obtain the formula.<a id="id111" class="indexterm"/>
</p><p>Therefore, we convert the<code class="literal">&lt;td&gt;</code> element first to a jQuery object (highlighted) and then filter the elements it contains to just elements with a class of<code class="literal"> formula</code>. This amounts to just the<code class="literal">&lt;span&gt;</code> element whose text is the formula we are after:</p><div><pre class="programlisting">
function getvalue(org, settings){<strong>
	d=$(org)</strong>
	return d.filter(".formula").text()
}
</pre></div><p>The corresponding<code class="literal"> setvalue()</code> function is used by jEditable to store the edited formula again in the<code class="literal">&lt;td&gt;</code> element. When called this function is passed two arguments:</p><div><ol class="orderedlist"><li class="listitem">The edited content of the element.</li><li class="listitem">The original settings passed to the jEditable plugin and its code is quite complicated because storing the formula is not the only thing it has to do. It must also calculate the result of the formula and update any cells that depend on the updated cell.</li></ol></div><p>The cell we are editing (that is the<code class="literal">&lt;td&gt;</code> element) is available as the<code class="literal"> this</code> variable. We stored the cell index as its<code class="literal"> id</code> attribute so we retrieve that one first (highlighted). The<code class="literal"> value</code> argument that was passed to the<code class="literal"> setvalue()</code> function is the edited formula.</p><p>As we use JavaScript syntax for these formulas, we can simply call JavaScript's<code class="literal"> eval()</code> function to calculate the value of the formula. We have to store the result in global variables with the name of the cell as well to make it reusable by other cells. Note that these global variables are just attributes of the<code class="literal"> window</code> object in the context of the browser so assigning a value to such an attribute is just what we do inside the<code class="literal"> if … else …</code> clause. If the result of evaluating the formula was undefined in some way (for example, because of an error) we set the result to the string<code class="literal">'#undef'</code> to signal that situation to the user:</p><div><pre class="programlisting">
function setvalue(value, settings) {
	/* determine cell index and update global var */<strong>
	currentcell=$(this).attr( 'id');</strong>
	currentresult=eval(value);
	if (typeof(currentresult) == 'undefined'){
			currentresult='#undef';
			window[currentcell]=0;
		}else{
			window[currentcell]=currentresult;
		}
</pre></div><p>After we have evaluated the formula of the current cell and stored its result we must now recalculate all other cells because they may depend on the contents of the cell we just changed.</p><p>We do affect this by selecting all cells in the sheet and applying a function to each of them (highlighted). If we are looking at a different cell than the one just changed (something we determine by comparing their<code class="literal"> id</code> attributes), we recalculate the formula contained in its<code class="literal">&lt;span&gt;</code> element. If the result is different from the previous value stored for a cell we set the change variable to true. We repeat the whole procedure until nothing is changed or we repeated ourselves more often than there are cells in the sheet, at which point we must have a circular reference somewhere, something we indicate to the user by setting the value of the cell to a suitable text. This is certainly not the most efficient method to recalculate a spreadsheet, nor is it a failsafe method to detect all circular references but it works well enough:<a id="id112" class="indexterm"/>
</p><div><pre class="programlisting">
/* update all other cells */
var changed;
var depth = 0;
do{
		depth++;
		changed = false;<strong>
		$('.sheet').find('.cell').
			each(function (index,element){</strong>
			cell=$(element).attr('id');
			if(currentcell != cell){
				span=$(element).
							children('span').first();
				orig = window[cell];
				window[cell]=0;
				formula=span.text();
				if(formula.length &gt; 0){
						result=eval(formula);
						if (result != orig) {
								changed = true;
						}
						if(typeof(result)=='undefined'){
								result='#undef';
						}else{
							window[cell]=result;
						}
					}else{
						result = ' ';
					}
					$(element).empty().
append('&lt;span class="formula ui-helper-hidden replaced"&gt;' + 
formula+'&lt;/span&gt;'+result);
					}
				});
		}while(changed &amp;&amp; (depth &lt;opts.cols*opts.rows));
		if ( depth &gt;= opts.cols*opts.rows){
				currentresult = '#Circular!';
		}
		return('&lt;span
				class="formula ui-helper-hidden"&gt;'
						+value+'&lt;/span&gt;'+currentresult);
}
</pre></div><p>The purpose of defining functions to set and get a value from a<code class="literal">&lt;td&gt;</code> element was to be able to apply the jEditable plugin to every cell. This we do in the final lines of our<code class="literal"> sheet</code> plugin. We find all children with a<code class="literal"> cell</code> class (highlighted) and invoke an anonymous function on each of them.<a id="id113" class="indexterm"/>
</p><p>This function first applies the jEditable plugin on the element by invoking the<code class="literal"> editable()</code> method with a reference to our<code class="literal"> setvalue()</code> function as the first argument and an options object as the second argument. The<code class="literal"> type</code> attribute marks this editable element as a text element (and not, for example, a multiline text area element), whereas setting<code class="literal"> onblur</code> to<code class="literal"> cancel</code> indicates that on clicking outside the cell when editing will revert the content to its original. The<code class="literal"> data</code> attribute points to our<code class="literal"> getvalue()</code> function to indicate to the plugin how to get the value that we want to edit.</p><p>The second thing the function does is applies CSS style attributes to each cell. In this case a fixed<code class="literal"> width</code> and the<code class="literal"> border-collapse</code> attribute will make sure that the border between cells is just as wide as the border on outlying cells:</p><div><pre class="programlisting">
	/* make every cell editable with the jEditable plugin */<strong>
	this.find(".cell").each(function (index,element) {</strong>
	$(this).
	editable(setvalue,{type:'text',onblur:'cancel',data:getvalue})
	});
	$(".cell").css({'width':opts.width,'border-collapse':'collapse'});
	return this;
}
</pre></div><p>
<code class="literal">spreadsheet.js</code> is completed with the definition of a default options object:</p><div><pre class="programlisting">
jQuery.fn.sheet.defaults = {
	rows : 4,
	cols : 4,
	width: '100px',
	logging: false
}
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch02lvl2sec24"/>Have a go hero adding math functions</h2></div></div></div><p>In the spreadsheet we designed, the user may use any JavaScript expression as the cell formula. That's fine if we want to use operators like addition (+) or multiplication (*), but what if we would like to use, for example, trigonometric functions like<code class="literal"> sin()</code> or<code class="literal"> cos()?</code>
<a id="id114" class="indexterm"/>
</p><p>This is possible by referring to the methods of the built-in JavaScript object<code class="literal"> Math</code> (an example would be<code class="literal"> Math.sin(A1)+Math.cos(B1))</code> but prefixing every function with<code class="literal"> Math</code> is awkward. Devise a way to make these functions available without the<code class="literal"> Math</code> prefix. (Hint: we already saw how to create names in the global namespace by assigning to<code class="literal"> window[&lt;name&gt;])</code>.</p><p>A solution can be found in<code class="literal"> spreadsheet2.js</code>. Its effects can be tested by running<code class="literal"> spreadsheet2.py</code>.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec14"/>The missing parts</h1></div></div></div><p>In designing and building a spreadsheet application we saw that it is relatively simple to implement quite sophisticated user interaction by making full use of the jQuery and jQuery UI libraries and choosing wisely from the wide array of available additional plugins like jEditable.</p><p>However, although our spreadsheet application was served from the CherryPy server, the functionality of the application was limited to client-side activity only. For example, there is no possibility to save or load a spreadsheet on the server, and neither is there a way to limit the access to our spreadsheet to authorized users only. Both requirements depend on ways to store data in a persistent manner and dealing with persistence will be the next step on our road to developing web applications.</p></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch02lvl1sec15"/>Summary</h1></div></div></div><p>We have learned a lot in this chapter. Specifically, we covered:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">How to create an environment to develop and deliver our applications. We saw how to install Python, CherryPy, and the jQuery and jQuery UI frameworks.</li><li class="listitem" style="list-style-type: disc">The design of a simple spreadsheet application.</li><li class="listitem" style="list-style-type: disc">How to configure CherryPy to deliver static and dynamic content.</li><li class="listitem" style="list-style-type: disc">How to use standard jQuery UI widgets and third party plugins; specifically, the button widget and the jEditable plugin.</li><li class="listitem" style="list-style-type: disc">The implementation of our own jQuery plugin.</li></ul></div><p>We also discussed how to reuse jQuery UI's concept of<code class="literal"> ui-widget</code> classes to style our own widget components in a way that blends seamlessly with jQuery UI's themes.</p><p>Now that we've learned about the client-side of web applications, we're ready to tackle server-side issues which is the topic of the next chapter.</p></div></div>
</body></html>