<html><head></head><body>
<div id="_idContainer049">
<h1 class="chapter-number" id="_idParaDest-175"><a id="_idTextAnchor328"/><a id="_idTextAnchor329"/><span class="koboSpan" id="kobo.1.1">6</span></h1>
<h1 id="_idParaDest-176"><a id="_idTextAnchor330"/><span class="koboSpan" id="kobo.2.1">Authenticating in Flask</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Authentication is an important part of any application, be it web-based, desktop, or mobile. </span><span class="koboSpan" id="kobo.3.2">Each kind of application has certain best practices when it comes to handling user authentication. </span><span class="koboSpan" id="kobo.3.3">In web-based applications, especially </span><strong class="bold"><span class="koboSpan" id="kobo.4.1">Software-as-a-Service </span></strong><span class="koboSpan" id="kobo.5.1">(</span><strong class="bold"><span class="koboSpan" id="kobo.6.1">SaaS</span></strong><span class="koboSpan" id="kobo.7.1">) applications, this process is of utmost importance, as it acts as the thin red line between the application being secure </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">and insecure.</span></span></p>
<p><span class="koboSpan" id="kobo.9.1">To keep things simple and flexible, Flask, by default, does not provide any mechanism for authentication. </span><span class="koboSpan" id="kobo.9.2">It always has to be implemented by us, the developers, as per our requirements and the </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">application’s requirements.</span></span></p>
<p><span class="koboSpan" id="kobo.11.1">Authenticating users for your application can be done in multiple ways. </span><span class="koboSpan" id="kobo.11.2">It can be a simple session-based implementation or a more secure approach using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.12.1">Flask-Login</span></strong><span class="koboSpan" id="kobo.13.1"> extension. </span><span class="koboSpan" id="kobo.13.2">We can also implement authentication by integrating popular third-party services such as the </span><strong class="bold"><span class="koboSpan" id="kobo.14.1">Lightweight Directory Access Protocol</span></strong><span class="koboSpan" id="kobo.15.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.16.1">LDAP</span></strong><span class="koboSpan" id="kobo.17.1">) or social logins such as Facebook, Google, and so on. </span><span class="koboSpan" id="kobo.17.2">In this chapter, we will go through all of </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">these methods.</span></span></p>
<p><span class="koboSpan" id="kobo.19.1">In this chapter, we will cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1">following recipes:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.21.1">Creating a simple </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">session-based authentication</span></span></li>
<li><span class="koboSpan" id="kobo.23.1">Authenticating using the </span><span class="No-Break"><span class="koboSpan" id="kobo.24.1">Flask-Login extension</span></span></li>
<li><span class="koboSpan" id="kobo.25.1">Using Facebook </span><span class="No-Break"><span class="koboSpan" id="kobo.26.1">for authentication</span></span></li>
<li><span class="koboSpan" id="kobo.27.1">Using Google </span><span class="No-Break"><span class="koboSpan" id="kobo.28.1">for authentication</span></span></li>
<li><span class="koboSpan" id="kobo.29.1">Using Twitter </span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">for authentication</span></span></li>
<li><span class="koboSpan" id="kobo.31.1">Authenticating </span><span class="No-Break"><span class="koboSpan" id="kobo.32.1">with LDAP</span></span></li>
</ul>
<h1 id="_idParaDest-177"><a id="_idTextAnchor331"/><span class="koboSpan" id="kobo.33.1">Creating a simple session-based authentication</span></h1>
<p><span class="koboSpan" id="kobo.34.1">In session-based </span><a id="_idIndexMarker228"/><span class="koboSpan" id="kobo.35.1">authentication, when the user logs in for the first time, the user details are set in the session of the application’s server side and stored in a cookie on </span><span class="No-Break"><span class="koboSpan" id="kobo.36.1">the browser.</span></span></p>
<p><span class="koboSpan" id="kobo.37.1">After that, when the user opens the application, the details stored in the cookie are used to check against the session, and the user is automatically logged in if the session </span><span class="No-Break"><span class="koboSpan" id="kobo.38.1">is alive.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.39.1">Info</span></p>
<p class="callout"><strong class="source-inline"><span class="koboSpan" id="kobo.40.1">SECRET_KEY</span></strong><span class="koboSpan" id="kobo.41.1"> is an application configuration setting that should always be specified in your application’s configuration; otherwise, the data stored in the cookie, as well as the session on the server side, will be in plain text, which is </span><span class="No-Break"><span class="koboSpan" id="kobo.42.1">highly insecure.</span></span></p>
<p><span class="koboSpan" id="kobo.43.1">We will implement a simple mechanism to do </span><span class="No-Break"><span class="koboSpan" id="kobo.44.1">this ourselves.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.45.1">Tip</span></p>
<p class="callout"><span class="koboSpan" id="kobo.46.1">The implementation done in this recipe is designed to explain how authentication works at a lower level. </span><span class="koboSpan" id="kobo.46.2">This approach should </span><em class="italic"><span class="koboSpan" id="kobo.47.1">not</span></em><span class="koboSpan" id="kobo.48.1"> be adopted in any </span><span class="No-Break"><span class="koboSpan" id="kobo.49.1">production-level application.</span></span><a id="_idTextAnchor332"/></p>
<h2 id="_idParaDest-178"><a id="_idTextAnchor333"/><span class="koboSpan" id="kobo.50.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.51.1">We will start with a Flask app configuration, as seen in </span><a href="B19111_05.xhtml#_idTextAnchor273"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.52.1">Chapter 5</span></em></span></a><span class="koboSpan" id="kobo.53.1">, </span><em class="italic"><span class="koboSpan" id="kobo.54.1">Web Forms</span></em><em class="italic"> </em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.55.1">with WTForms</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.56.1">.</span></span><a id="_idTextAnchor334"/></p>
<h2 id="_idParaDest-179"><a id="_idTextAnchor335"/><span class="koboSpan" id="kobo.57.1">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.58.1">Configure the application to use the SQLAlchemy and WTForms extensions (refer to the previous chapter for details). </span><span class="koboSpan" id="kobo.58.2">Follow these steps to </span><span class="No-Break"><span class="koboSpan" id="kobo.59.1">understand how:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.60.1">Before starting with authentication, first, create a model to store the user details. </span><span class="koboSpan" id="kobo.60.2">This is achieved by creating models in </span><strong class="source-inline"><span class="koboSpan" id="kobo.61.1">flask_authentication/my_app/auth/models.py</span></strong><span class="koboSpan" id="kobo.62.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.63.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.64.1">
from werkzeug.security import generate_password_hash, check_password_hash</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.65.1">
from flask_wtf import FlaskForm</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.66.1">
from wtforms import StringField, PasswordField</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.67.1">
from wtforms.validators import InputRequired, EqualTo</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.68.1">
from my_app import db</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.69.1">
class User(db.Model):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.70.1">
    id = db.Column(db.Integer, primary_key=True)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.71.1">
    username = db.Column(db.String(100))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.72.1">
    pwdhash = db.Column(db.String())</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.73.1">
    def __init__(self, username, password):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.74.1">
        self.username = username</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.75.1">
        self.pwdhash = generate_password_hash(password)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.76.1">
    def check_password(self, password):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.77.1">
        return check_password_hash(self.pwdhash, password)</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.78.1">The preceding </span><a id="_idIndexMarker229"/><span class="koboSpan" id="kobo.79.1">code is the </span><strong class="source-inline"><span class="koboSpan" id="kobo.80.1">User</span></strong><span class="koboSpan" id="kobo.81.1"> model, which has two fields: </span><strong class="source-inline"><span class="koboSpan" id="kobo.82.1">username</span></strong><span class="koboSpan" id="kobo.83.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.84.1">pwdhash</span></strong><span class="koboSpan" id="kobo.85.1">. </span><span class="koboSpan" id="kobo.85.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.86.1">username</span></strong><span class="koboSpan" id="kobo.87.1"> field works as its name suggests. </span><span class="koboSpan" id="kobo.87.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.88.1">pwdhash</span></strong><span class="koboSpan" id="kobo.89.1"> field stores the salted hash of the password because it is not recommended that you store passwords directly in databases.</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.90.1">Then, create two forms in f</span><strong class="source-inline"><span class="koboSpan" id="kobo.91.1">lask_authentication/my_app/auth/models.py</span></strong><span class="koboSpan" id="kobo.92.1"> – one for user registration and the other for login. </span><span class="koboSpan" id="kobo.92.2">In </span><strong class="source-inline"><span class="koboSpan" id="kobo.93.1">RegistrationForm</span></strong><span class="koboSpan" id="kobo.94.1">, create two fields of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.95.1">PasswordField</span></strong><span class="koboSpan" id="kobo.96.1"> type, just like any other website’s registration; this is to make sure that the user enters the same password in both fields, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.97.1">following</span></span><span class="No-Break"><a id="_idIndexMarker230"/></span><span class="No-Break"><span class="koboSpan" id="kobo.98.1"> snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.99.1">
class RegistrationForm(FlaskForm):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.100.1">
    username = StringField('Username', [InputRequired()])</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.101.1">
    password = PasswordField(</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.102.1">
        'Password', [</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.103.1">
            InputRequired(), EqualTo('confirm', </span></pre><pre class="source-code"><span class="koboSpan" id="kobo.104.1">
            message='Passwords must match')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.105.1">
        ]</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.106.1">
    )</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.107.1">
    confirm = PasswordField('Confirm Password', </span></pre><pre class="source-code"><span class="koboSpan" id="kobo.108.1">
      [InputRequired()])</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.109.1">
class LoginForm(FlaskForm):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.110.1">
    username = StringField('Username', [InputRequired()])</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.111.1">
    password = PasswordField('Password', [InputRequired()])</span></pre></li>
<li><span class="koboSpan" id="kobo.112.1">Next, create views in </span><strong class="source-inline"><span class="koboSpan" id="kobo.113.1">flask_authentication/my_app/auth/views.py</span></strong><span class="koboSpan" id="kobo.114.1"> to handle the user requests for registration and login, </span><span class="No-Break"><span class="koboSpan" id="kobo.115.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.116.1">
from flask import request, render_template, flash, redirect, url_for, session, Blueprint</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.117.1">
from my_app import app, db</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.118.1">
from my_app.auth.models import User, RegistrationForm, LoginForm</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.119.1">
auth = Blueprint('auth', __name__)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.120.1">
@auth.route('/')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.121.1">
@auth.route('/home')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.122.1">
def home():</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.123.1">
    return render_template('home.html')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.124.1">
@auth.route('/register', methods=['GET', 'POST'])</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.125.1">
def register():</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.126.1">
    if session.get('username'):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.127.1">
        flash('Your are already logged in.', 'info')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.128.1">
        return redirect(url_for('auth.home'))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.129.1">
    form = RegistrationForm()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.130.1">
    if form.validate_on_submit():</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.131.1">
        username = request.form.get('username')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.132.1">
        password = request.form.get('password')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.133.1">
        existing_username = User.query.filter(</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.134.1">
            User.username.like('%' + username + '%')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.135.1">
        ).first()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.136.1">
        if existing_username:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.137.1">
            flash(</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.138.1">
                'This username has been already taken. </span><span class="koboSpan" id="kobo.138.2">Try </span></pre><pre class="source-code"><span class="koboSpan" id="kobo.139.1">
                another one.',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.140.1">
                'warning'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.141.1">
            )</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.142.1">
            return render_template('register.html', form=form)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.143.1">
        user = User(username, password)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.144.1">
        db.session.add(user)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.145.1">
        db.session.commit()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.146.1">
        flash('You are now registered. </span><span class="koboSpan" id="kobo.146.2">Please login.', </span></pre><pre class="source-code"><span class="koboSpan" id="kobo.147.1">
        'success')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.148.1">
        return redirect(url_for('auth.login'))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.149.1">
    if form.errors:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.150.1">
        flash(form.errors, 'danger')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.151.1">
    return render_template('register.html', form=form)</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.152.1">The preceding method handles user registration. </span><span class="koboSpan" id="kobo.152.2">On a </span><strong class="source-inline"><span class="koboSpan" id="kobo.153.1">GET</span></strong><span class="koboSpan" id="kobo.154.1"> request, the registration form is shown to the user; this form asks for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.155.1">username</span></strong><span class="koboSpan" id="kobo.156.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.157.1">password</span></strong><span class="koboSpan" id="kobo.158.1">. </span><span class="koboSpan" id="kobo.158.2">Then, on a </span><strong class="source-inline"><span class="koboSpan" id="kobo.159.1">POST</span></strong><span class="koboSpan" id="kobo.160.1"> request, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.161.1">username</span></strong><span class="koboSpan" id="kobo.162.1"> is checked for its uniqueness after the form validation is complete. </span><span class="koboSpan" id="kobo.162.2">If the </span><strong class="source-inline"><span class="koboSpan" id="kobo.163.1">username</span></strong><span class="koboSpan" id="kobo.164.1"> is not unique, the user is asked to choose a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.165.1">username</span></strong><span class="koboSpan" id="kobo.166.1">; otherwise, a new user is created in the database and redirected to the login page.</span></p>
<p><span class="koboSpan" id="kobo.167.1">After</span><a id="_idIndexMarker231"/><span class="koboSpan" id="kobo.168.1"> successful registration, the user is redirected to log in, which is handled as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.169.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.170.1">
@auth.route('/login', methods=['GET', 'POST'])
def login():
    form = LoginForm()
    if form.validate_on_submit():
        username = request.form.get('username')
        password = request.form.get('password')
        existing_user = User.query.filter_by(username=username).
</span><span class="koboSpan" id="kobo.170.2">        first()
        if not (existing_user and existing_user.check_
        password(password)):
            flash('Invalid username or password. </span><span class="koboSpan" id="kobo.170.3">Please try again.', 
            'danger')
            return render_template('login.html', form=form)
        session['username'] = username
        flash('You have successfully logged in.', 'success')
        return redirect(url_for('auth.home'))
    if form.errors:
        flash(form.errors, 'danger')
    return render_template('login.html', form=form)</span></pre>
<p><span class="koboSpan" id="kobo.171.1">The preceding method</span><a id="_idIndexMarker232"/><span class="koboSpan" id="kobo.172.1"> handles the user login. </span><span class="koboSpan" id="kobo.172.2">After form validation, it first checks whether the </span><strong class="source-inline"><span class="koboSpan" id="kobo.173.1">username</span></strong><span class="koboSpan" id="kobo.174.1"> exists in the database. </span><span class="koboSpan" id="kobo.174.2">If not, it asks the user to enter the correct username. </span><span class="koboSpan" id="kobo.174.3">Similarly, it checks whether the </span><strong class="source-inline"><span class="koboSpan" id="kobo.175.1">password</span></strong><span class="koboSpan" id="kobo.176.1"> is correct. </span><span class="koboSpan" id="kobo.176.2">If not, it asks the user for the correct password. </span><span class="koboSpan" id="kobo.176.3">If all the checks pass, the session is populated with a </span><strong class="source-inline"><span class="koboSpan" id="kobo.177.1">username</span></strong><span class="koboSpan" id="kobo.178.1"> key, which holds the username of the user. </span><span class="koboSpan" id="kobo.178.2">The presence of this key on the session indicates that the user is logged in. </span><span class="koboSpan" id="kobo.178.3">Consider the </span><span class="No-Break"><span class="koboSpan" id="kobo.179.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.180.1">
@auth.route('/logout')
def logout():
    if 'username' in session:
        session.pop('username')
        flash('You have successfully logged out.', 'success')
    return redirect(url_for('auth.home'))</span></pre>
<p><span class="koboSpan" id="kobo.181.1">The preceding method becomes self-implied once we’ve understood the </span><strong class="source-inline"><span class="koboSpan" id="kobo.182.1">login() </span></strong><span class="koboSpan" id="kobo.183.1">method. </span><span class="koboSpan" id="kobo.183.2">Here, we just popped out the </span><strong class="source-inline"><span class="koboSpan" id="kobo.184.1">username</span></strong><span class="koboSpan" id="kobo.185.1"> key from the session, and the user got logged </span><span class="No-Break"><span class="koboSpan" id="kobo.186.1">out automatically.</span></span></p>
<p><span class="koboSpan" id="kobo.187.1">Next, create the templates that are rendered by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.188.1">register()</span></strong><span class="koboSpan" id="kobo.189.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.190.1">login()</span></strong><span class="koboSpan" id="kobo.191.1"> handlers for the registration and login, respectively, </span><span class="No-Break"><span class="koboSpan" id="kobo.192.1">created previously.</span></span></p>
<p><span class="koboSpan" id="kobo.193.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.194.1">flask_authentication/my_app/templates/base.html</span></strong><span class="koboSpan" id="kobo.195.1"> template remains almost the same as it was in </span><a href="B19111_05.xhtml#_idTextAnchor273"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.196.1">Chapter 5</span></em></span></a><span class="koboSpan" id="kobo.197.1">, </span><em class="italic"><span class="koboSpan" id="kobo.198.1">Web Forms</span></em><em class="italic"><span class="koboSpan" id="kobo.199.1"> with WTForms</span></em><span class="koboSpan" id="kobo.200.1">. </span><span class="koboSpan" id="kobo.200.2">The only change will be with the routing, where </span><strong class="source-inline"><span class="koboSpan" id="kobo.201.1">catalog</span></strong><span class="koboSpan" id="kobo.202.1"> will be replaced </span><span class="No-Break"><span class="koboSpan" id="kobo.203.1">by </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.204.1">auth</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.205.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.206.1">First, create a simple home page, </span><strong class="source-inline"><span class="koboSpan" id="kobo.207.1">flask_authentication/my_app/templates/home.html</span></strong><span class="koboSpan" id="kobo.208.1">, as shown in the following code. </span><span class="koboSpan" id="kobo.208.2">This reflects whether the user is logged in or not and also shows links for registration and</span><a id="_idIndexMarker233"/><span class="koboSpan" id="kobo.209.1"> login if the user is not </span><span class="No-Break"><span class="koboSpan" id="kobo.210.1">logged in:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.211.1">
{% extends 'base.html' %}
{% block container %}
  &lt;h1&gt;Welcome to the Authentication Demo&lt;/h1&gt;
  {% if session.username %}
    &lt;h3&gt;Hey {{ session.username }}!!&lt;/h3&gt;
    &lt;a href="{{ url_for('auth.logout') }}"&gt;Click here to logout&lt;/a&gt;
  {% else %}
  Click here to &lt;a href="{{ url_for('auth.login') }}"&gt;login&lt;/a&gt; or &lt;a 
  href="{{ url_for('auth.register') }}"&gt;register&lt;/a&gt;
  {% endif %}
{% endblock %}</span></pre>
<p><span class="koboSpan" id="kobo.212.1">Now create a registration page, </span><strong class="source-inline"><span class="koboSpan" id="kobo.213.1">flask_authentication/my_app/templates/register.html</span></strong><span class="koboSpan" id="kobo.214.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.215.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.216.1">
{% extends 'home.html' %}
{% block container %}
  &lt;div class="top-pad"&gt;
    &lt;form
        method="POST"
        action="{{ url_for('auth.register') }}"
        role="form"&gt;
      {{ form.csrf_token }}
      &lt;div class="form-group"&gt;{{ form.username.label }}: {{ form.
</span><span class="koboSpan" id="kobo.216.2">      username() }}&lt;/div&gt;
      &lt;div class="form-group"&gt;{{ form.password.label }}: {{ form.
</span><span class="koboSpan" id="kobo.216.3">      password() }}&lt;/div&gt;
      &lt;div class="form-group"&gt;{{ form.confirm.label }}: {{ form.
</span><span class="koboSpan" id="kobo.216.4">      confirm() }}&lt;/div&gt;
      &lt;button type="submit" class="btn btn-default"&gt;Submit&lt;/button&gt;
    &lt;/form&gt;
  &lt;/div&gt;
{% endblock %}</span></pre>
<p><span class="koboSpan" id="kobo.217.1">Finally, create</span><a id="_idIndexMarker234"/><span class="koboSpan" id="kobo.218.1"> a simple login page, </span><strong class="source-inline"><span class="koboSpan" id="kobo.219.1">flask_authentication/my_app/templates/login.html</span></strong><span class="koboSpan" id="kobo.220.1">, with the </span><span class="No-Break"><span class="koboSpan" id="kobo.221.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.222.1">
{% extends 'home.html' %}
{% block container %}
  &lt;div class="top-pad"&gt;
    &lt;form
        method="POST"
        action="{{ url_for('auth.login') }}"
        role="form"&gt;
      {{ form.csrf_token }}
      &lt;div class="form-group"&gt;{{ form.username.label }}: {{ form.
</span><span class="koboSpan" id="kobo.222.2">      username() }}&lt;/div&gt;
      &lt;div class="form-group"&gt;{{ form.password.label }}: {{ form.
</span><span class="koboSpan" id="kobo.222.3">      password() }}&lt;/div&gt;
      &lt;button type="submit" class="btn btn-default"&gt;Submit&lt;/button&gt;
    &lt;/form&gt;
  &lt;/div&gt;
{% endbl</span><a id="_idTextAnchor336"/><span class="koboSpan" id="kobo.223.1">ock %}</span></pre>
<h2 id="_idParaDest-180"><a id="_idTextAnchor337"/><span class="koboSpan" id="kobo.224.1">How it works...</span></h2>
<p><span class="koboSpan" id="kobo.225.1">The working of this</span><a id="_idIndexMarker235"/><span class="koboSpan" id="kobo.226.1"> application is demonstrated with the help of the screenshots in </span><span class="No-Break"><span class="koboSpan" id="kobo.227.1">this section.</span></span></p>
<p><span class="koboSpan" id="kobo.228.1">The following screenshot displays the home page that comes up on </span><span class="No-Break"><span class="koboSpan" id="kobo.229.1">opening </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.230.1">http://127.0.0.1:5000/home</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.231.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer038">
<span class="koboSpan" id="kobo.232.1"><img alt="Figure 6.1 – Home page visible to a user who is not logged in" src="image/B19111_06_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.233.1">Figure 6.1 – Home page visible to a user who is not logged in</span></p>
<p><span class="koboSpan" id="kobo.234.1">The registration page that comes up on opening </span><strong class="source-inline"><span class="koboSpan" id="kobo.235.1">http://127.0.0.1:5000/register</span></strong><span class="koboSpan" id="kobo.236.1"> looks like the </span><span class="No-Break"><span class="koboSpan" id="kobo.237.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer039">
<span class="koboSpan" id="kobo.238.1"><img alt="Figure 6.2 – The registration form" src="image/B19111_06_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.239.1">Figure 6.2 – The registration form</span></p>
<p><span class="koboSpan" id="kobo.240.1">After </span><a id="_idIndexMarker236"/><span class="koboSpan" id="kobo.241.1">registration, the login page will be shown on opening </span><strong class="source-inline"><span class="koboSpan" id="kobo.242.1">http://127.0.0.1:5000/login</span></strong><span class="koboSpan" id="kobo.243.1">, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.244.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer040">
<span class="koboSpan" id="kobo.245.1"><img alt="Figure 6.3 – Login page rendered after successful registration" src="image/B19111_06_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.246.1">Figure 6.3 – Login page rendered after successful registration</span></p>
<p><span class="koboSpan" id="kobo.247.1">Finally, the home page is shown to the logged-in user at </span><strong class="source-inline"><span class="koboSpan" id="kobo.248.1">http://127.0.0.1:5000/home</span></strong><span class="koboSpan" id="kobo.249.1">, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.250.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer041">
<span class="koboSpan" id="kobo.251.1"><img alt="Figure 6.4 – Home page as shown to a logged-in ﻿user" src="image/B19111_06_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.252.1">Figure 6.4 – Home page as shown to a logged-in </span><a id="_idTextAnchor338"/><span class="koboSpan" id="kobo.253.1">user</span></p>
<h2 id="_idParaDest-181"><a id="_idTextAnchor339"/><span class="koboSpan" id="kobo.254.1">See also</span></h2>
<p><span class="koboSpan" id="kobo.255.1">The next recipe, </span><em class="italic"><span class="koboSpan" id="kobo.256.1">Authenticating using the Flask-Login extension</span></em><span class="koboSpan" id="kobo.257.1">, will cover a more secure and </span><a id="_idIndexMarker237"/><span class="koboSpan" id="kobo.258.1">production-ready method of performing </span><span class="No-Break"><span class="koboSpan" id="kobo.259.1">user authentica</span><a id="_idTextAnchor340"/><span class="koboSpan" id="kobo.260.1">tion.</span></span></p>
<h1 id="_idParaDest-182"><a id="_idTextAnchor341"/><span class="koboSpan" id="kobo.261.1">Authenticating using the Flask-Login extension</span></h1>
<p><span class="koboSpan" id="kobo.262.1">In our previous </span><a id="_idIndexMarker238"/><span class="koboSpan" id="kobo.263.1">recipe, we learned how to</span><a id="_idIndexMarker239"/><span class="koboSpan" id="kobo.264.1"> implement session-based authentication ourselves. </span><strong class="source-inline"><span class="koboSpan" id="kobo.265.1">Flask-Login</span></strong><span class="koboSpan" id="kobo.266.1"> is a popular extension that handles a lot of the same stuff in a helpful and efficient way and thus saves us from reinventing the wheel all over again. </span><span class="koboSpan" id="kobo.266.2">In addition, </span><strong class="source-inline"><span class="koboSpan" id="kobo.267.1">Flask-Login</span></strong><span class="koboSpan" id="kobo.268.1"> will not bind us to any specific database or limit us to using any specific fields or methods for authentication. </span><span class="koboSpan" id="kobo.268.2">It can also handle the </span><strong class="bold"><span class="koboSpan" id="kobo.269.1">Remember me</span></strong><strong class="bold"> </strong><span class="koboSpan" id="kobo.270.1">feature, account recovery features, and so on. </span><span class="koboSpan" id="kobo.270.2">In this recipe, we will understand how to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.271.1">Flask-Login</span></strong><span class="koboSpan" id="kobo.272.1"> with </span><span class="No-Break"><span class="koboSpan" id="kobo.273.1">our appli</span><a id="_idTextAnchor342"/><span class="koboSpan" id="kobo.274.1">cation.</span></span></p>
<h2 id="_idParaDest-183"><a id="_idTextAnchor343"/><span class="koboSpan" id="kobo.275.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.276.1">Modify the application created in the previous recipe to accommodate the changes to be done by the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.277.1">Flask-Login</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.278.1"> extension.</span></span></p>
<p><span class="koboSpan" id="kobo.279.1">Before that, we have to install the extension itself with the </span><span class="No-Break"><span class="koboSpan" id="kobo.280.1">following command:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.281.1">
$ pip install Flas</span><a id="_idTextAnchor344"/><span class="koboSpan" id="kobo.282.1">k-Login</span></pre>
<h2 id="_idParaDest-184"><a id="_idTextAnchor345"/><span class="koboSpan" id="kobo.283.1">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.284.1">Follow these steps to understand how </span><strong class="source-inline"><span class="koboSpan" id="kobo.285.1">Flask-Login</span></strong><span class="koboSpan" id="kobo.286.1"> can be integrated with a </span><span class="No-Break"><span class="koboSpan" id="kobo.287.1">Flask application:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.288.1">To use </span><strong class="source-inline"><span class="koboSpan" id="kobo.289.1">Flask-Login</span></strong><span class="koboSpan" id="kobo.290.1">, first, modify the application’s configuration, which is in </span><strong class="source-inline"><span class="koboSpan" id="kobo.291.1">flask_authentication/my_app/__init__.py</span></strong><span class="koboSpan" id="kobo.292.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.293.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.294.1">
from flask_login import LoginManager</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.295.1">
#</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.296.1">
# Do other application configurations</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.297.1">
#</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.298.1">
login_manager = LoginManager()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.299.1">
login_manager.init_app(app)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.300.1">
login_manager.login_view = 'auth.login'</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.301.1">In the </span><a id="_idIndexMarker240"/><span class="koboSpan" id="kobo.302.1">preceding</span><a id="_idIndexMarker241"/><span class="koboSpan" id="kobo.303.1"> code snippet, after importing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.304.1">LoginManager</span></strong><span class="koboSpan" id="kobo.305.1"> class from the extension, we created an object of this class. </span><span class="koboSpan" id="kobo.305.2">Then, we configured the </span><strong class="source-inline"><span class="koboSpan" id="kobo.306.1">app</span></strong><span class="koboSpan" id="kobo.307.1"> object for use with </span><strong class="source-inline"><span class="koboSpan" id="kobo.308.1">LoginManager</span></strong><span class="koboSpan" id="kobo.309.1"> using </span><strong class="source-inline"><span class="koboSpan" id="kobo.310.1">init_app()</span></strong><span class="koboSpan" id="kobo.311.1">. </span><span class="koboSpan" id="kobo.311.2">There are then multiple configurations that can be done in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.312.1">login_manager</span></strong><span class="koboSpan" id="kobo.313.1"> object, as and when needed. </span><span class="koboSpan" id="kobo.313.2">Here, we have just demonstrated one basic and compulsory configuration, that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.314.1">login_view</span></strong><span class="koboSpan" id="kobo.315.1">, which points to the view handler for login requests. </span><span class="koboSpan" id="kobo.315.2">In addition, we can also configure messages to be shown to the users, such as how long a session will last, handling logins using request headers, and so on. </span><span class="koboSpan" id="kobo.315.3">Refer to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.316.1">Flask-Login</span></strong><span class="koboSpan" id="kobo.317.1"> documentation at </span><a href="https://flask-login.readthedocs.org/en/latest/#customizing-the-login-process"><span class="koboSpan" id="kobo.318.1">https://flask-login.readthedocs.org/en/latest/#customizing-the-login-process</span></a><span class="koboSpan" id="kobo.319.1"> for more details.</span></p>
<ol>
<li value="2"><strong class="source-inline"><span class="koboSpan" id="kobo.320.1">Flask-Login</span></strong><span class="koboSpan" id="kobo.321.1"> calls for some additional methods to be added to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.322.1">User</span></strong><span class="koboSpan" id="kobo.323.1"> model/class in </span><strong class="source-inline"><span class="koboSpan" id="kobo.324.1">my_app/auth/models.py</span></strong><span class="koboSpan" id="kobo.325.1">, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.326.1">following snippet:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.327.1">
    @property</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.328.1">
    def is_authenticated(self):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.329.1">
        return True</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.330.1">
    @property</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.331.1">
    def is_active(self):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.332.1">
        return True</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.333.1">
    @property</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.334.1">
    def is_anonymous(self):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.335.1">
        return False</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.336.1">
    def get_id(self):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.337.1">
        return str(self.id)</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.338.1">In the </span><a id="_idIndexMarker242"/><span class="koboSpan" id="kobo.339.1">preceding </span><a id="_idIndexMarker243"/><span class="koboSpan" id="kobo.340.1">code, we added four methods, which are explained as follows:</span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.341.1">is_authenticated()</span></strong><span class="koboSpan" id="kobo.342.1">: This property returns </span><strong class="source-inline"><span class="koboSpan" id="kobo.343.1">True</span></strong><span class="koboSpan" id="kobo.344.1">. </span><span class="koboSpan" id="kobo.344.2">This should return </span><strong class="source-inline"><span class="koboSpan" id="kobo.345.1">False</span></strong><span class="koboSpan" id="kobo.346.1"> only in cases where we do not want a user to </span><span class="No-Break"><span class="koboSpan" id="kobo.347.1">be authenticated.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.348.1">is_active()</span></strong><span class="koboSpan" id="kobo.349.1">: This property returns </span><strong class="source-inline"><span class="koboSpan" id="kobo.350.1">True</span></strong><span class="koboSpan" id="kobo.351.1">. </span><span class="koboSpan" id="kobo.351.2">This should return </span><strong class="source-inline"><span class="koboSpan" id="kobo.352.1">False</span></strong><span class="koboSpan" id="kobo.353.1"> only in cases where we have blocked or banned </span><span class="No-Break"><span class="koboSpan" id="kobo.354.1">a user.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.355.1">is_anonymous()</span></strong><span class="koboSpan" id="kobo.356.1">: This property is used to indicate a user who is not supposed to be logged in to the system and should access the application as anonymous. </span><span class="koboSpan" id="kobo.356.2">This should return </span><strong class="source-inline"><span class="koboSpan" id="kobo.357.1">False</span></strong><span class="koboSpan" id="kobo.358.1"> for regular </span><span class="No-Break"><span class="koboSpan" id="kobo.359.1">logged-in users.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.360.1">get_id()</span></strong><span class="koboSpan" id="kobo.361.1">: This method represents the unique </span><strong class="source-inline"><span class="koboSpan" id="kobo.362.1">ID</span></strong><span class="koboSpan" id="kobo.363.1"> used to identify the user. </span><span class="koboSpan" id="kobo.363.2">This should be a </span><span class="No-Break"><span class="koboSpan" id="kobo.364.1">Unicode value.</span></span></li>
</ul>
<p class="callout-heading"><span class="koboSpan" id="kobo.365.1">Information</span></p>
<p class="callout"><span class="koboSpan" id="kobo.366.1">It is not necessary to implement all of the methods and properties discussed while implementing a </span><strong class="source-inline"><span class="koboSpan" id="kobo.367.1">user</span></strong><span class="koboSpan" id="kobo.368.1"> class. </span><span class="koboSpan" id="kobo.368.2">To make things easier, you can always subclass the </span><strong class="source-inline"><span class="koboSpan" id="kobo.369.1">UserMixin</span></strong><span class="koboSpan" id="kobo.370.1"> class from </span><strong class="source-inline"><span class="koboSpan" id="kobo.371.1">flask_login</span></strong><span class="koboSpan" id="kobo.372.1">, which has default implementations already done for the methods and properties we mentioned. </span><span class="koboSpan" id="kobo.372.2">For more information on this, </span><span class="No-Break"><span class="koboSpan" id="kobo.373.1">visit </span></span><a href="https://flask-login.readthedocs.io/en/latest/#flask_login.UserMixin"><span class="No-Break"><span class="koboSpan" id="kobo.374.1">https://flask-login.readthedocs.io/en/latest/#flask_login.UserMixin</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.375.1">.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.376.1">Next, make </span><a id="_idIndexMarker244"/><span class="koboSpan" id="kobo.377.1">the</span><a id="_idIndexMarker245"/><span class="koboSpan" id="kobo.378.1"> following changes to the views </span><span class="No-Break"><span class="koboSpan" id="kobo.379.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.380.1">my_app/auth/views.py</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.381.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.382.1">
from flask import g</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.383.1">
from flask_login import current_user, login_user, logout_user, \</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.384.1">
    login_required</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.385.1">
from my_app import login_manager</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.386.1">
@login_manager.user_loader</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.387.1">
def load_user(id):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.388.1">
    return User.query.get(int(id))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.389.1">
@auth.before_request</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.390.1">
def get_current_user():</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.391.1">
    g.user = current_user</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.392.1">In the preceding method, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.393.1">@auth.before_request</span></strong><span class="koboSpan" id="kobo.394.1"> decorator implies that the method will be called before the view function whenever a request is received.</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.395.1">In the</span><a id="_idIndexMarker246"/><span class="koboSpan" id="kobo.396.1"> following </span><a id="_idIndexMarker247"/><span class="koboSpan" id="kobo.397.1">snippet, we have memorized our </span><span class="No-Break"><span class="koboSpan" id="kobo.398.1">logged-in user:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.399.1">
@auth.route('/login', methods=['GET', 'POST'])</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.400.1">
def login():</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.401.1">
    if current_user.is_authenticated:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.402.1">
        flash('You are already logged in.', 'info')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.403.1">
        return redirect(url_for('auth.home'))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.404.1">
    form = LoginForm()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.405.1">
    if form.validate_on_submit():</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.406.1">
        username = request.form.get('username')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.407.1">
        password = request.form.get('password')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.408.1">
        existing_user = User.query.filter_by(username=username).</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.409.1">
        first()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.410.1">
        if not (existing_user and existing_user.check_</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.411.1">
        password(password)):</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.412.1">
            flash('Invalid username or password. </span><span class="koboSpan" id="kobo.412.2">Please try </span></pre><pre class="source-code"><span class="koboSpan" id="kobo.413.1">
            again.', 'danger')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.414.1">
            return render_template('login.html', form=form)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.415.1">
        login_user(existing_user)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.416.1">
        flash('You have successfully logged in.', 'success')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.417.1">
        return redirect(url_for('auth.home'))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.418.1">
    if form.errors:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.419.1">
        flash(form.errors, 'danger')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.420.1">
    return render_template('login.html', form=form)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.421.1">
@auth.route('/logout')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.422.1">
@login_required</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.423.1">
def logout():</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.424.1">
    logout_user()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.425.1">
    return redirect(url_for('auth.home'))</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.426.1">Notice that now, in </span><strong class="source-inline"><span class="koboSpan" id="kobo.427.1">login()</span></strong><span class="koboSpan" id="kobo.428.1">, we check whether the </span><strong class="source-inline"><span class="koboSpan" id="kobo.429.1">current_user</span></strong><span class="koboSpan" id="kobo.430.1"> is authenticated before doing anything else. </span><span class="koboSpan" id="kobo.430.2">Here, </span><strong class="source-inline"><span class="koboSpan" id="kobo.431.1">current_user</span></strong><span class="koboSpan" id="kobo.432.1"> is a proxy that represents the object for the currently logged-in </span><strong class="source-inline"><span class="koboSpan" id="kobo.433.1">User</span></strong><span class="koboSpan" id="kobo.434.1"> record. </span><span class="koboSpan" id="kobo.434.2">After all validations and checks are done, the user is then logged in using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.435.1">login_user()</span></strong><span class="koboSpan" id="kobo.436.1"> method. </span><span class="koboSpan" id="kobo.436.2">This method accepts the </span><strong class="source-inline"><span class="koboSpan" id="kobo.437.1">user</span></strong><span class="koboSpan" id="kobo.438.1"> object and handles all of the session-related activities required to log in a user.</span></p>
<p><span class="koboSpan" id="kobo.439.1">Now, if we move on </span><a id="_idIndexMarker248"/><span class="koboSpan" id="kobo.440.1">to</span><a id="_idIndexMarker249"/><span class="koboSpan" id="kobo.441.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.442.1">logout()</span></strong><span class="koboSpan" id="kobo.443.1"> method, we can see that a decorator has been added for </span><strong class="source-inline"><span class="koboSpan" id="kobo.444.1">login_required()</span></strong><span class="koboSpan" id="kobo.445.1">. </span><span class="koboSpan" id="kobo.445.2">This decorator makes sure that the user is logged in before this method is executed. </span><span class="koboSpan" id="kobo.445.3">It can be used for any view method in our application. </span><span class="koboSpan" id="kobo.445.4">To log a user out, we just have to call </span><strong class="source-inline"><span class="koboSpan" id="kobo.446.1">logout_user()</span></strong><span class="koboSpan" id="kobo.447.1">, which will clean up the session for the currently logged-in user and, in turn, log the user out of </span><span class="No-Break"><span class="koboSpan" id="kobo.448.1">the application.</span></span></p>
<p><span class="koboSpan" id="kobo.449.1">As we do not handle sessions ourselves, a minor change in the templates is required, as shown in the following snippet. </span><span class="koboSpan" id="kobo.449.2">This happens whenever we want to check whether a user is logged in and whether particular content needs to be shown </span><span class="No-Break"><span class="koboSpan" id="kobo.450.1">to them:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.451.1">
{% if current_user.is_authenticated %}
...do somethi</span><a id="_idTextAnchor346"/><span class="koboSpan" id="kobo.452.1">ng...
</span><span class="koboSpan" id="kobo.452.2">{% endif %}</span></pre>
<h2 id="_idParaDest-185"><a id="_idTextAnchor347"/><span class="koboSpan" id="kobo.453.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.454.1">The demonstration in this recipe works exactly as it did in the previous recipe, </span><em class="italic"><span class="koboSpan" id="kobo.455.1">Creating a simple session-based authentication</span></em><span class="koboSpan" id="kobo.456.1">. </span><span class="koboSpan" id="kobo.456.2">Only the implementation differs, but the end result </span><a id="_idTextAnchor348"/><span class="koboSpan" id="kobo.457.1">remains </span><span class="No-Break"><span class="koboSpan" id="kobo.458.1">the same.</span></span></p>
<h2 id="_idParaDest-186"><a id="_idTextAnchor349"/><span class="koboSpan" id="kobo.459.1">There’s more…</span></h2>
<p><span class="koboSpan" id="kobo.460.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.461.1">Flask-Login</span></strong><span class="koboSpan" id="kobo.462.1"> extension makes the implementation of the </span><strong class="bold"><span class="koboSpan" id="kobo.463.1">Remember me</span></strong><span class="koboSpan" id="kobo.464.1"> feature pretty simple. </span><span class="koboSpan" id="kobo.464.2">To do so, just pass </span><strong class="source-inline"><span class="koboSpan" id="kobo.465.1">remember=True</span></strong><span class="koboSpan" id="kobo.466.1"> to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.467.1">login_user()</span></strong><span class="koboSpan" id="kobo.468.1"> method. </span><span class="koboSpan" id="kobo.468.2">This will save a cookie on the user’s computer, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.469.1">Flask-Login</span></strong><span class="koboSpan" id="kobo.470.1"> will use this to log the </span><a id="_idIndexMarker250"/><span class="koboSpan" id="kobo.471.1">user </span><a id="_idIndexMarker251"/><span class="koboSpan" id="kobo.472.1">in automatically if the session is active. </span><span class="koboSpan" id="kobo.472.2">You should try implementin</span><a id="_idTextAnchor350"/><span class="koboSpan" id="kobo.473.1">g this on </span><span class="No-Break"><span class="koboSpan" id="kobo.474.1">your own.</span></span></p>
<h2 id="_idParaDest-187"><a id="_idTextAnchor351"/><span class="koboSpan" id="kobo.475.1">See also</span></h2>
<p><span class="koboSpan" id="kobo.476.1">See the previous recipe, </span><em class="italic"><span class="koboSpan" id="kobo.477.1">Creating a simple session-based authentication</span></em><span class="koboSpan" id="kobo.478.1">, to understand the complete working of </span><span class="No-Break"><span class="koboSpan" id="kobo.479.1">this recipe.</span></span></p>
<p><span class="koboSpan" id="kobo.480.1">Flask provides a special object called </span><strong class="source-inline"><span class="koboSpan" id="kobo.481.1">g</span></strong><span class="koboSpan" id="kobo.482.1">. </span><span class="koboSpan" id="kobo.482.2">You can read more about this </span><span class="No-Break"><span class="koboSpan" id="kobo.483.1">at </span></span><a href="https://flask.palletsprojects.com/en/2.2.x/api/#flask.g"><span class="No-Break"><span class="koboSpan" id="kobo.484.1">https://flask.palletsprojects.com/en/2.2.x/api/#flask.g</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.485.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.486.1">Another interesting way of authentication is using JWT tokens, which work in a way that is very similar to </span><strong class="source-inline"><span class="koboSpan" id="kobo.487.1">Flask-Login</span></strong><span class="koboSpan" id="kobo.488.1">. </span><span class="koboSpan" id="kobo.488.2">See more</span><a id="_idIndexMarker252"/><span class="koboSpan" id="kobo.489.1"> details </span><span class="No-Break"><span class="koboSpan" id="kobo.490.1">at </span></span><a href="https://flask-jwt-extended.readthedocs.io/en/stable/"><span class="No-Break"><span class="koboSpan" id="kobo.491.1">https://flask-jwt-extended.readth</span><span id="_idTextAnchor352"/><span class="koboSpan" id="kobo.492.1">edocs.io/en/stable/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.493.1">.</span></span></p>
<h1 id="_idParaDest-188"><a id="_idTextAnchor353"/><span class="koboSpan" id="kobo.494.1">Using Facebook for authentication</span></h1>
<p><span class="koboSpan" id="kobo.495.1">You will have </span><a id="_idIndexMarker253"/><span class="koboSpan" id="kobo.496.1">noticed that many websites provide an</span><a id="_idIndexMarker254"/><span class="koboSpan" id="kobo.497.1"> option to log in to their own site using third-party authentication, such as Facebook, Google, Twitter, LinkedIn, and so on. </span><span class="koboSpan" id="kobo.497.2">This has been made possible by </span><strong class="bold"><span class="koboSpan" id="kobo.498.1">OAuth 2</span></strong><span class="koboSpan" id="kobo.499.1">, which is an open standard for authorization. </span><span class="koboSpan" id="kobo.499.2">It allows the client site to use an access token to access the protected information and resources provided by the resource server. </span><span class="koboSpan" id="kobo.499.3">In this recipe, we will show you how to implement OAuth-based authorization via Facebook. </span><span class="koboSpan" id="kobo.499.4">In later recipes, we will do the same using </span><span class="No-Break"><span class="koboSpan" id="kobo.500.1">other providers.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.501.1">Information</span></p>
<p class="callout"><span class="koboSpan" id="kobo.502.1">OAuth is a mechanism that allows users to grant websites or applications access to their information on other websites (such as Google, Facebook, Twitter, etc.) without sharing the password. </span><span class="koboSpan" id="kobo.502.2">It essentially means that the third-party client application (your Flask application) gets access to data stored on the resource server (Google, Facebook, etc.) by means of an access token, which is issued by the resource server’s authentication engine on approval of the reso</span><a id="_idTextAnchor354"/><span class="koboSpan" id="kobo.503.1">urce owner (</span><span class="No-Break"><span class="koboSpan" id="kobo.504.1">the user).</span></span></p>
<h2 id="_idParaDest-189"><a id="_idTextAnchor355"/><span class="koboSpan" id="kobo.505.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.506.1">OAuth 2 only </span><a id="_idIndexMarker255"/><span class="koboSpan" id="kobo.507.1">works</span><a id="_idIndexMarker256"/><span class="koboSpan" id="kobo.508.1"> with SSL, so the application should run with HTTPS. </span><span class="koboSpan" id="kobo.508.2">To do this on a local machine, please follow </span><span class="No-Break"><span class="koboSpan" id="kobo.509.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.510.1">Install </span><strong class="source-inline"><span class="koboSpan" id="kobo.511.1">pyopenssl</span></strong><span class="koboSpan" id="kobo.512.1"> using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.513.1">$ pip3 install </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.514.1">pyopenssl</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.515.1"> command.</span></span></li>
<li><span class="koboSpan" id="kobo.516.1">Add additional options to </span><strong class="source-inline"><span class="koboSpan" id="kobo.517.1">app.run()</span></strong><span class="koboSpan" id="kobo.518.1">, including </span><strong class="source-inline"><span class="koboSpan" id="kobo.519.1">ssl_context</span></strong><span class="koboSpan" id="kobo.520.1"> with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.521.1">adhoc</span></strong><span class="koboSpan" id="kobo.522.1"> value. </span><span class="koboSpan" id="kobo.522.2">The completed </span><strong class="source-inline"><span class="koboSpan" id="kobo.523.1">app.run</span></strong><span class="koboSpan" id="kobo.524.1"> should look as follows: </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.525.1">app.run(debug=True, ssl_context='adhoc')</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.526.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.527.1">Once these changes have been made, run the application using the URL </span><strong class="source-inline"><span class="koboSpan" id="kobo.528.1">https://localhost:5000/</span></strong><span class="koboSpan" id="kobo.529.1">. </span><span class="koboSpan" id="kobo.529.2">Before the app loads, your browser will display warnings about the certificate not being safe. </span><span class="koboSpan" id="kobo.529.3">Just accept the warning </span><span class="No-Break"><span class="koboSpan" id="kobo.530.1">and proceed.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.531.1">Tip</span></p>
<p class="callout"><span class="koboSpan" id="kobo.532.1">This is not a recommended method. </span><span class="koboSpan" id="kobo.532.2">In production systems, SSL certificates should be obtained from a proper </span><span class="No-Break"><span class="koboSpan" id="kobo.533.1">certifying authority.</span></span></p>
<p><span class="koboSpan" id="kobo.534.1">To install </span><strong class="source-inline"><span class="koboSpan" id="kobo.535.1">Flask-Dance</span></strong><span class="koboSpan" id="kobo.536.1"> and generate Facebook credentials, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.537.1">these step:.</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.538.1">First, install the </span><strong class="source-inline"><span class="koboSpan" id="kobo.539.1">Flask-Dance</span></strong><span class="koboSpan" id="kobo.540.1"> extension and its dependencies with the </span><span class="No-Break"><span class="koboSpan" id="kobo.541.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.542.1">$ pip3 install Flask-Dance</span></strong></pre></li>
<li><span class="koboSpan" id="kobo.543.1">Next, register for a Facebook application that will be used for login. </span><span class="koboSpan" id="kobo.543.2">Although the process for registration on the Facebook app is pretty straightforward and self-explanatory, in this case, we are only concerned with the </span><strong class="bold"><span class="koboSpan" id="kobo.544.1">App ID</span></strong><span class="koboSpan" id="kobo.545.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.546.1">App secret</span></strong><span class="koboSpan" id="kobo.547.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.548.1">Site URL</span></strong><span class="koboSpan" id="kobo.549.1"> options, as shown in the following screenshot (more information on this can</span><a id="_idIndexMarker257"/><span class="koboSpan" id="kobo.550.1"> be</span><a id="_idIndexMarker258"/><span class="koboSpan" id="kobo.551.1"> found on the Facebook developer pages </span><span class="No-Break"><span class="koboSpan" id="kobo.552.1">at </span></span><a href="https://developers.facebook.com/"><span class="No-Break"><span class="koboSpan" id="kobo.553.1">https://developers.facebook.com/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.554.1">):</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer042">
<span class="koboSpan" id="kobo.555.1"><img alt="Figure 6.5 – Facebook app credentials" src="image/B19111_06_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.556.1">Figure 6.5 – Facebook app credentials</span></p>
<p><span class="koboSpan" id="kobo.557.1">While configuring Facebook, make sure to configure the site URL to </span><strong class="source-inline"><span class="koboSpan" id="kobo.558.1">https://localhost:5000/</span></strong><span class="koboSpan" id="kobo.559.1"> for the purpose of this recipe, and the valid OAuth redirect URIs, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.560.1">following screenshots:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer043">
<span class="koboSpan" id="kobo.561.1"><img alt="Figure 6.6 – Facebook site URL config" src="image/B19111_06_06.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.562.1">Figure 6.6 – Facebook site URL config</span></p>
<div>
<div class="IMG---Figure" id="_idContainer044">
<span class="koboSpan" id="kobo.563.1"><img alt="Figure 6.7 – Facebook OAu﻿th Redirect URIs config" src="image/B19111_06_07.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.564.1">Figure 6.7 – Facebook OAu</span><a id="_idTextAnchor356"/><span class="koboSpan" id="kobo.565.1">th Redirect URIs config</span></p>
<h2 id="_idParaDest-190"><a id="_idTextAnchor357"/><span class="koboSpan" id="kobo.566.1">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.567.1">To enable Facebook authentication for your application, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.568.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.569.1">As always, start with the configuration part in </span><strong class="source-inline"><span class="koboSpan" id="kobo.570.1">my_app/__init__.py</span></strong><span class="koboSpan" id="kobo.571.1">. </span><span class="koboSpan" id="kobo.571.2">Add the following lines of code; do not remove or edit anything else unless you are confident of </span><span class="No-Break"><span class="koboSpan" id="kobo.572.1">the change:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.573.1">
app.config["FACEBOOK_OAUTH_CLIENT_ID"] = 'my facebook APP ID'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.574.1">
app.config["FACEBOOK_OAUTH_CLIENT_SECRET"] = 'my facebook app secret'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.575.1">
from my_app.auth.views import facebook_blueprint</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.576.1">
app.register_blueprint(auth)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.577.1">
app.register_blueprint(facebook_blueprint)</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.578.1">In the</span><a id="_idIndexMarker259"/><span class="koboSpan" id="kobo.579.1"> preceding</span><a id="_idIndexMarker260"/><span class="koboSpan" id="kobo.580.1"> code snippet, we used Flask-Dance with our application for authentication. </span><span class="koboSpan" id="kobo.580.2">This blueprint will be created in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.581.1">views</span></strong><span class="koboSpan" id="kobo.582.1"> file, which we will cover next.</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.583.1">Now modify the views, that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.584.1">my_app/auth/views.py</span></strong><span class="koboSpan" id="kobo.585.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.586.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.587.1">
    from flask_dance.contrib.facebook import</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.588.1">
      make_facebook_blueprint, facebook</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.589.1">
    facebook_blueprint =</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.590.1">
      make_facebook_blueprint(scope='email',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.591.1">
      redirect_to='auth.facebook_login')</span></pre></li>
</ol>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.592.1">make_facebook_blueprint</span></strong><span class="koboSpan" id="kobo.593.1"> reads </span><strong class="source-inline"><span class="koboSpan" id="kobo.594.1">FACEBOOK_OAUTH_CLIENT_ID</span></strong><span class="koboSpan" id="kobo.595.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.596.1">FACEBOOK_OAUTH_CLIENT_SECRET</span></strong><span class="koboSpan" id="kobo.597.1"> from the application configuration and takes care of all the OAuth-related handling in the background. </span><span class="koboSpan" id="kobo.597.2">While making the Facebook blueprint, we set </span><strong class="source-inline"><span class="koboSpan" id="kobo.598.1">scope</span></strong><span class="koboSpan" id="kobo.599.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.600.1">email</span></strong><span class="koboSpan" id="kobo.601.1">, so that an email address can be used as a unique username. </span><span class="koboSpan" id="kobo.601.2">We also set </span><strong class="source-inline"><span class="koboSpan" id="kobo.602.1">redirect_to</span></strong><span class="koboSpan" id="kobo.603.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.604.1">auth.facebook_login</span></strong><span class="koboSpan" id="kobo.605.1">, so Facebook routes the application back to this URL once authentication succeeds. </span><span class="koboSpan" id="kobo.605.2">If this option is not set, the application will be automatically redirected to the home page, that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.606.1">/</span></strong><span class="koboSpan" id="kobo.607.1">.</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.608.1">Now, create a</span><a id="_idIndexMarker261"/><span class="koboSpan" id="kobo.609.1"> new</span><a id="_idIndexMarker262"/><span class="koboSpan" id="kobo.610.1"> route handler to handle the login using Facebook, </span><span class="No-Break"><span class="koboSpan" id="kobo.611.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.612.1">
@auth.route("/facebook-login")</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.613.1">
def facebook_login():</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.614.1">
    if not facebook.authorized:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.615.1">
        return redirect(url_for("facebook.login"))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.616.1">
    resp = facebook.get("/me?fields=name,email")</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.617.1">
    user = User.query.filter_by(username</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.618.1">
      =resp.json()["email"]).first()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.619.1">
    if not user:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.620.1">
        user = User(resp.json()["email"], '')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.621.1">
        db.session.add(user)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.622.1">
        db.session.commit()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.623.1">
    login_user(user)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.624.1">
    flash(</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.625.1">
        'Logged in as name=%s using Facebook login' % (</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.626.1">
            resp.json()['name']), 'success' )</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.627.1">
    return redirect(request.args.get('next',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.628.1">
      url_for('auth.home')))</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.629.1">This method first checks whether a user is already authorized with Facebook. </span><span class="koboSpan" id="kobo.629.2">If not, it redirects the app to Facebook’s login handler, where the user will need to follow the steps outlined by Facebook and give the necessary permissions to our application in order to access the requested user details, as per the settings in </span><strong class="source-inline"><span class="koboSpan" id="kobo.630.1">make_facebook_blueprint</span></strong><span class="koboSpan" id="kobo.631.1">. </span><span class="koboSpan" id="kobo.631.2">Once the user is authorized with Facebook, the method then requests a user’s details, such as their name and email address, from Facebook. </span><span class="koboSpan" id="kobo.631.3">Using these user details, it is determined whether a user already exists with the email entered or not. </span><span class="koboSpan" id="kobo.631.4">If not, a new user is created and logged in; otherwise, the existing user is directly logged in.</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.632.1">Finally, modify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.633.1">login.html</span></strong><span class="koboSpan" id="kobo.634.1"> template to allow for broader social login functionality. </span><span class="koboSpan" id="kobo.634.2">This will act as a placeholder for the Facebook login, as well as a number of </span><a id="_idIndexMarker263"/><span class="koboSpan" id="kobo.635.1">alternative </span><a id="_idIndexMarker264"/><span class="koboSpan" id="kobo.636.1">social logins, which we will cover later. </span><span class="koboSpan" id="kobo.636.2">The code for the updated </span><strong class="source-inline"><span class="koboSpan" id="kobo.637.1">login.html</span></strong><span class="koboSpan" id="kobo.638.1"> template is </span><span class="No-Break"><span class="koboSpan" id="kobo.639.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.640.1">
    {% extends 'home.html' %}</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.641.1">
{% block container %}</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.642.1">
  &lt;div class="top-pad"&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.643.1">
    &lt;ul class="nav nav-tabs"&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.644.1">
     &lt;li class="active"&gt;&lt;a href="#simple-form" data-</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.645.1">
       toggle="tab"&gt;Old Style Login&lt;/a&gt;&lt;/li&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.646.1">
     &lt;li&gt;&lt;a href="#social-logins" data-</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.647.1">
       toggle="tab"&gt;Social Logins&lt;/a&gt;&lt;/li&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.648.1">
    &lt;/ul&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.649.1">
    &lt;div class="tab-content"&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.650.1">
      &lt;div class="tab-pane active" id="simple-form"&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.651.1">
        &lt;form</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.652.1">
            method="POST"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.653.1">
            action="{{ url_for('auth.login') }}"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.654.1">
            role="form"&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.655.1">
          {{ form.csrf_token }}</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.656.1">
          &lt;div class="form-group"&gt;{{ form.username</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.657.1">
            .label }}: {{ form.username() }}&lt;/div&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.658.1">
          &lt;div class="form-group"&gt;{{ form.password</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.659.1">
            .label }}: {{ form.password() }}&lt;/div&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.660.1">
          &lt;button type="submit" class="btn btn-</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.661.1">
            default"&gt;Submit&lt;/button&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.662.1">
        &lt;/form&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.663.1">
      &lt;/div&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.664.1">
      &lt;div class="tab-pane" id="social-logins"&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.665.1">
        &lt;a href="{{ url_for('auth.facebook_login',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.666.1">
          next=url_for('auth.home')) }}"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.667.1">
          &gt;Login via Facebook&lt;/a&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.668.1">
      &lt;/div&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.669.1">
    &lt;/div&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.670.1">
  &lt;/div&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.671.1">
{% endblock %}</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.672.1">In the</span><a id="_idIndexMarker265"/><span class="koboSpan" id="kobo.673.1"> preceding</span><a id="_idIndexMarker266"/><span class="koboSpan" id="kobo.674.1"> code, we created a tabbed structure in which the first tab is our conventional login and the second tab corresponds to social logins.</span></p>
<p><span class="koboSpan" id="kobo.675.1">Currently, there is just one option for Facebook available. </span><span class="koboSpan" id="kobo.675.2">More options will be added in upcoming recipes. </span><span class="koboSpan" id="kobo.675.3">Note that the link is currently simple; we can always add styles </span><a id="_idTextAnchor358"/><span class="koboSpan" id="kobo.676.1">and buttons as needed </span><span class="No-Break"><span class="koboSpan" id="kobo.677.1">later on.</span></span></p>
<h2 id="_idParaDest-191"><a id="_idTextAnchor359"/><span class="koboSpan" id="kobo.678.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.679.1">The login page has a new tab that provides an option for the user to log in using </span><strong class="bold"><span class="koboSpan" id="kobo.680.1">Social Logins</span></strong><span class="koboSpan" id="kobo.681.1">, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.682.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer045">
<span class="koboSpan" id="kobo.683.1"><img alt="Figure 6.8 – Social Logins page" src="image/B19111_06_08.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.684.1">Figure 6.8 – Social Logins page</span></p>
<p><span class="koboSpan" id="kobo.685.1">When we click on the </span><strong class="bold"><span class="koboSpan" id="kobo.686.1">Login via Facebook</span></strong><span class="koboSpan" id="kobo.687.1"> link, the application is taken to Facebook, where the </span><a id="_idIndexMarker267"/><span class="koboSpan" id="kobo.688.1">user </span><a id="_idIndexMarker268"/><span class="koboSpan" id="kobo.689.1">will be asked for their login details and permission. </span><span class="koboSpan" id="kobo.689.2">Once the permission is granted, the user will </span><a id="_idTextAnchor360"/><span class="koboSpan" id="kobo.690.1">be logged in to </span><span class="No-Break"><span class="koboSpan" id="kobo.691.1">the application.</span></span></p>
<h1 id="_idParaDest-192"><a id="_idTextAnchor361"/><span class="koboSpan" id="kobo.692.1">Using Google for authentication</span></h1>
<p><span class="koboSpan" id="kobo.693.1">Just like we </span><a id="_idIndexMarker269"/><span class="koboSpan" id="kobo.694.1">did for Facebook, we can integrate our applicat</span><a id="_idTextAnchor362"/><span class="koboSpan" id="kobo.695.1">ion </span><a id="_idIndexMarker270"/><span class="koboSpan" id="kobo.696.1">to enable login </span><span class="No-Break"><span class="koboSpan" id="kobo.697.1">using Google.</span></span></p>
<h2 id="_idParaDest-193"><a id="_idTextAnchor363"/><span class="koboSpan" id="kobo.698.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.699.1">Start by building over the last recipe. </span><span class="koboSpan" id="kobo.699.2">It is easy to implement Google authentication by simply leaving out the Facebook-specific elements as </span><span class="No-Break"><span class="koboSpan" id="kobo.700.1">it is.</span></span></p>
<p><span class="koboSpan" id="kobo.701.1">Now, create a new project from the Google developer console (</span><a href="https://console.developers.google.com"><span class="koboSpan" id="kobo.702.1">https://console.developers.google.com</span></a><span class="koboSpan" id="kobo.703.1">). </span><span class="koboSpan" id="kobo.703.2">In the </span><strong class="bold"><span class="koboSpan" id="kobo.704.1">APIs and Services</span></strong><span class="koboSpan" id="kobo.705.1"> section, click on </span><strong class="bold"><span class="koboSpan" id="kobo.706.1">Credentials</span></strong><span class="koboSpan" id="kobo.707.1">. </span><span class="koboSpan" id="kobo.707.2">Then, create a new client ID for the web application; this ID will provide the credentials needed for OAuth 2 to work. </span><span class="koboSpan" id="kobo.707.3">You will also need to configure the OAuth consent screen before a client ID can be created, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.708.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer046">
<span class="koboSpan" id="kobo.709.1"><img alt="Figu﻿re 6.9 – Google app configuration" src="image/B19111_06_09.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.710.1">Figu</span><a id="_idTextAnchor364"/><span class="koboSpan" id="kobo.711.1">re 6.9 – Google app configuration</span></p>
<h2 id="_idParaDest-194"><a id="_idTextAnchor365"/><span class="koboSpan" id="kobo.712.1">How to do it…</span></h2>
<p><span class="koboSpan" id="kobo.713.1">To enable </span><a id="_idIndexMarker271"/><span class="koboSpan" id="kobo.714.1">Google </span><a id="_idIndexMarker272"/><span class="koboSpan" id="kobo.715.1">authentication in your application, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.716.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.717.1">As always, start with the configuration part in </span><strong class="source-inline"><span class="koboSpan" id="kobo.718.1">my_app/__init__.py</span></strong><span class="koboSpan" id="kobo.719.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.720.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.721.1">
app.config["GOOGLE_OAUTH_CLIENT_ID"] = "my Google</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.722.1">
  OAuth client ID"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.723.1">
app.config["GOOGLE_OAUTH_CLIENT_SECRET"] = "my Google</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.724.1">
  OAuth client secret"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.725.1">
app.config["OAUTHLIB_RELAX_TOKEN_SCOPE"] = True</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.726.1">
from my_app.auth.views import auth,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.727.1">
  facebook_blueprint, google_blueprint</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.728.1">
app.register_blueprint(google_blueprint)</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.729.1">In the preceding code snippet, we registered the Google blueprint provided by Flask-Dance with our application for authentication. </span><span class="koboSpan" id="kobo.729.2">This blueprint will be created in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.730.1">views</span></strong><span class="koboSpan" id="kobo.731.1"> file, which we will take a look at next. </span><span class="koboSpan" id="kobo.731.2">Note the additional configuration option, </span><strong class="source-inline"><span class="koboSpan" id="kobo.732.1">OAUTHLIB_RELAX_TOKEN_SCOPE</span></strong><span class="koboSpan" id="kobo.733.1">. </span><span class="koboSpan" id="kobo.733.2">This is suggested for use when implementing Google authentication because Google tends to provide data that sometimes diverges from the scope mentioned.</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.734.1">Next, modify </span><a id="_idIndexMarker273"/><span class="koboSpan" id="kobo.735.1">the </span><a id="_idIndexMarker274"/><span class="koboSpan" id="kobo.736.1">views, that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.737.1">my_app/auth/views.py</span></strong><span class="koboSpan" id="kobo.738.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.739.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.740.1">
from flask_dance.contrib.google import</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.741.1">
  make_google_blueprint, google</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.742.1">
google_blueprint = make_google_blueprint(</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.743.1">
    scope=[</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.744.1">
        "openid",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.745.1">
        "https://www.googleapis.com</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.746.1">
          /auth/userinfo.email",</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.747.1">
        "https://www.googleapis.com</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.748.1">
          /auth/userinfo.profile"],</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.749.1">
    redirect_to='auth.google_login')</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.750.1">In the preceding code snippet, </span><strong class="source-inline"><span class="koboSpan" id="kobo.751.1">make_google_blueprint</span></strong><span class="koboSpan" id="kobo.752.1"> reads </span><strong class="source-inline"><span class="koboSpan" id="kobo.753.1">GOOGLE_OAUTH_CLIENT_ID</span></strong><span class="koboSpan" id="kobo.754.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.755.1">GOOGLE_OAUTH_CLIENT_SECRET</span></strong><span class="koboSpan" id="kobo.756.1"> from the application configuration and takes care of all the OAuth-related handling in the background. </span><span class="koboSpan" id="kobo.756.2">While making the Google blueprint, we set </span><strong class="source-inline"><span class="koboSpan" id="kobo.757.1">scope</span></strong><span class="koboSpan" id="kobo.758.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.759.1">openid</span></strong><span class="koboSpan" id="kobo.760.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.761.1">https://www.googleapis.com/auth/userinfo.email</span></strong><span class="koboSpan" id="kobo.762.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.763.1">https://www.googleapis.com/auth/userinfo.profile</span></strong><span class="koboSpan" id="kobo.764.1">, because we want to use a user’s email address as their unique username and display name after login. </span><strong class="source-inline"><span class="koboSpan" id="kobo.765.1">openid</span></strong><span class="koboSpan" id="kobo.766.1"> is required in </span><strong class="source-inline"><span class="koboSpan" id="kobo.767.1">scope</span></strong><span class="koboSpan" id="kobo.768.1"> because Google prefers it.</span></p>
<p><span class="koboSpan" id="kobo.769.1">We also set </span><strong class="source-inline"><span class="koboSpan" id="kobo.770.1">redirect_to</span></strong><span class="koboSpan" id="kobo.771.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.772.1">auth.google_login</span></strong><span class="koboSpan" id="kobo.773.1"> so Google is able to route the application back to this URL after authentication has succeeded. </span><span class="koboSpan" id="kobo.773.2">If this option is not set, the application will be automatically redirected to the home page, that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.774.1">/</span></strong><span class="koboSpan" id="kobo.775.1">.</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.776.1">Next, create a </span><a id="_idIndexMarker275"/><span class="koboSpan" id="kobo.777.1">new</span><a id="_idIndexMarker276"/><span class="koboSpan" id="kobo.778.1"> route handler that handles the login using Google with the </span><span class="No-Break"><span class="koboSpan" id="kobo.779.1">following code:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.780.1">
@auth.route("/google-login")</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.781.1">
def google_login():</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.782.1">
    if not google.authorized:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.783.1">
        return redirect(url_for("google.login"))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.784.1">
    resp = google.get("/oauth2/v1/userinfo")</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.785.1">
    user = User.query.filter_by(username=resp.json()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.786.1">
      ["email"]).first()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.787.1">
    if not user:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.788.1">
        user = User(resp.json()["email"], '')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.789.1">
        db.session.add(user)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.790.1">
        db.session.commit()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.791.1">
    login_user(user)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.792.1">
    flash(</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.793.1">
        'Logged in as name=%s using Google login' % (</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.794.1">
            resp.json()['name']), 'success' )</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.795.1">
    return redirect(request.args.get('next',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.796.1">
      url_for('auth.home')))</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.797.1">Here, the method first checks whether the user is already authorized with Google. </span><span class="koboSpan" id="kobo.797.2">If not, it redirects the app to the Google login handler, where the user will need to follow the steps outlined by Google and give permission to our application so it can access the requested user details. </span><span class="koboSpan" id="kobo.797.3">Once the user is authorized with Google, the method requests the user’s details, including their name and email address, from Google. </span><span class="koboSpan" id="kobo.797.4">Using these user details, it is determined whether a user already exists with this email or not. </span><span class="koboSpan" id="kobo.797.5">If not, a new user is created and logged in; otherwise, the existing user is directly logged in.</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.798.1">Finally, modify </span><a id="_idIndexMarker277"/><span class="koboSpan" id="kobo.799.1">the</span><a id="_idIndexMarker278"/><span class="koboSpan" id="kobo.800.1"> login template, </span><strong class="source-inline"><span class="koboSpan" id="kobo.801.1">login.html</span></strong><span class="koboSpan" id="kobo.802.1">, to allow the Google login. </span><span class="koboSpan" id="kobo.802.2">Add the following line inside the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.803.1">social-logins</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.804.1"> tab:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.805.1">
&lt;a href="{{ url_for('auth.google_login',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.806.1">
  next=url_f</span><a id="_idTextAnchor366"/><span class="koboSpan" id="kobo.807.1">or('auth.home'))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.808.1">
}}"&gt;Login via Google&lt;/a&gt;</span></pre></li>
</ol>
<h2 id="_idParaDest-195"><a id="_idTextAnchor367"/><span class="koboSpan" id="kobo.809.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.810.1">The Google login works in a manner similar to the</span><a id="_idTextAnchor368"/><span class="koboSpan" id="kobo.811.1"> Facebook login from the </span><span class="No-Break"><span class="koboSpan" id="kobo.812.1">previous recipe.</span></span></p>
<h1 id="_idParaDest-196"><a id="_idTextAnchor369"/><span class="koboSpan" id="kobo.813.1">Using Twitter for authentication</span></h1>
<p><span class="koboSpan" id="kobo.814.1">OAuth was </span><a id="_idIndexMarker279"/><span class="koboSpan" id="kobo.815.1">actually</span><a id="_idIndexMarker280"/><span class="koboSpan" id="kobo.816.1"> born while writing the OpenID API for Twitter. </span><span class="koboSpan" id="kobo.816.2">In this recipe, we will in</span><a id="_idTextAnchor370"/><span class="koboSpan" id="kobo.817.1">tegrate Twitter login with </span><span class="No-Break"><span class="koboSpan" id="kobo.818.1">our application.</span></span></p>
<h2 id="_idParaDest-197"><a id="_idTextAnchor371"/><span class="koboSpan" id="kobo.819.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.820.1">We will continue by building over the </span><em class="italic"><span class="koboSpan" id="kobo.821.1">Using Google for authentication</span></em><span class="koboSpan" id="kobo.822.1"> recipe. </span><span class="koboSpan" id="kobo.822.2">It is easy to implement Twitter authentication – simply leave out the Facebook or Google-specific parts from the previous </span><span class="No-Break"><span class="koboSpan" id="kobo.823.1">authentication recipes.</span></span></p>
<p><span class="koboSpan" id="kobo.824.1">First, we have to create an application from the Twitter </span><strong class="bold"><span class="koboSpan" id="kobo.825.1">Application Management</span></strong><strong class="bold"> </strong><span class="koboSpan" id="kobo.826.1">page (</span><a href="https://developer.twitter.com/en/portal/dashboard"><span class="koboSpan" id="kobo.827.1">https://developer.twitter.com/en/portal/dashboard</span></a><span class="koboSpan" id="kobo.828.1">). </span><span class="koboSpan" id="kobo.828.2">It will automatically create consumer API keys (</span><strong class="bold"><span class="koboSpan" id="kobo.829.1">API Key</span></strong><span class="koboSpan" id="kobo.830.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.831.1">API Key Secret</span></strong><span class="koboSpan" id="kobo.832.1">) for us to use, as shown in</span><a id="_idIndexMarker281"/><span class="koboSpan" id="kobo.833.1"> the </span><a id="_idIndexMarker282"/><span class="No-Break"><span class="koboSpan" id="kobo.834.1">following screensho</span><a id="_idTextAnchor372"/><span class="koboSpan" id="kobo.835.1">t:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer047">
<span class="koboSpan" id="kobo.836.1"><img alt="Figure 6.10 – Twitter app configuration" src="image/B19111_06_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.837.1">Figure 6.10 – Twitter app configuration</span></p>
<h2 id="_idParaDest-198"><a id="_idTextAnchor373"/><span class="koboSpan" id="kobo.838.1">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.839.1">To enable Twitter authentication for your application, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.840.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.841.1">First, start with the configuration part in </span><strong class="source-inline"><span class="koboSpan" id="kobo.842.1">my_app/__init__.py</span></strong><span class="koboSpan" id="kobo.843.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.844.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.845.1">
app.config["TWITTER_OAUTH_CLIENT_KEY"] = "my Twitter</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.846.1">
  app ID"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.847.1">
app.config["TWITTER_OAUTH_CLIENT_SECRET"] = "my</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.848.1">
  Twitter app secret"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.849.1">
from my_app.auth.views import twitter_blueprint</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.850.1">
app.register_blueprint(twitter_blueprint)</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.851.1">In the preceding code snippet, we registered the Twitter blueprint provided by Flask-Dance with our application for authentication. </span><span class="koboSpan" id="kobo.851.2">This blueprint will be created in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.852.1">views</span></strong><span class="koboSpan" id="kobo.853.1"> file, which we will take a look at next.</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.854.1">Next, modify the views, that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.855.1">my_app/auth/views.py</span></strong><span class="koboSpan" id="kobo.856.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.857.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.858.1">
from flask_dance.contrib.twitter import</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.859.1">
  make_twitter_blueprint, twitter</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.860.1">
twitter_blueprint = make_twitter_blueprint</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.861.1">
  (redirect_to='auth.twitter_login')</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.862.1">In the</span><a id="_idIndexMarker283"/><span class="koboSpan" id="kobo.863.1"> preceding </span><a id="_idIndexMarker284"/><span class="koboSpan" id="kobo.864.1">code, </span><strong class="source-inline"><span class="koboSpan" id="kobo.865.1">make_twitter_blueprint</span></strong><span class="koboSpan" id="kobo.866.1"> reads </span><strong class="source-inline"><span class="koboSpan" id="kobo.867.1">TWITTER_OAUTH_CLIENT_KEY</span></strong><span class="koboSpan" id="kobo.868.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.869.1">TWITTER_OAUTH_CLIENT_SECRET</span></strong><span class="koboSpan" id="kobo.870.1"> from the application configuration and takes care of all the OAuth-related handling in the background. </span><span class="koboSpan" id="kobo.870.2">There is no need to set </span><strong class="source-inline"><span class="koboSpan" id="kobo.871.1">scope</span></strong><span class="koboSpan" id="kobo.872.1">, as we did during Facebook and Google authentication, as this recipe will use a Twitter handle as the username, which is provided by default.</span></p>
<p><span class="koboSpan" id="kobo.873.1">We also set </span><strong class="source-inline"><span class="koboSpan" id="kobo.874.1">redirect_to</span></strong><span class="koboSpan" id="kobo.875.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.876.1">auth.twitter_login</span></strong><span class="koboSpan" id="kobo.877.1"> so that Twitter can route the application back to this URL after authentication has succeeded. </span><span class="koboSpan" id="kobo.877.2">If this option is not set, the application will be automatically redirected to the home page, that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.878.1">/</span></strong><span class="koboSpan" id="kobo.879.1">.</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.880.1">Next, create a new route handler that handles the login using Twitter, </span><span class="No-Break"><span class="koboSpan" id="kobo.881.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.882.1">
@auth.route("/twitter-login")</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.883.1">
def twitter_login():</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.884.1">
    if not twitter.authorized:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.885.1">
        return redirect(url_for("twitter.login"))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.886.1">
    resp = twitter.get("account/verify_credentials</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.887.1">
      .json")</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.888.1">
    user = User.query.filter_by(username=resp</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.889.1">
      .json()["screen_name"]).first()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.890.1">
    if not user:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.891.1">
        user = User(resp.json()["screen_name"], '')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.892.1">
        db.session.add(user)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.893.1">
        db.session.commit()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.894.1">
    login_user(user)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.895.1">
    flash(</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.896.1">
        'Logged in as name=%s using Twitter login' % (</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.897.1">
            resp.json()['name']), 'success' )</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.898.1">
    return redirect(request.args.get('next',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.899.1">
      url_for('auth.home')))</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.900.1">The preceding</span><a id="_idIndexMarker285"/><span class="koboSpan" id="kobo.901.1"> method</span><a id="_idIndexMarker286"/><span class="koboSpan" id="kobo.902.1"> first checks whether the user is already authorized with Twitter. </span><span class="koboSpan" id="kobo.902.2">If not, it redirects the app to the Twitter login handler, where the user will need to follow the steps outlined by Twitter and give permission to our application so it can access the requested user details. </span><span class="koboSpan" id="kobo.902.3">Once the user is authorized with Twitter, the method requests the user’s details, including their screen name or handle from Twitter. </span><span class="koboSpan" id="kobo.902.4">Using these user details, it is determined whether a user already exists with this Twitter handle or not. </span><span class="koboSpan" id="kobo.902.5">If not, a new user is created and logged in; otherwise, the existing user is directly logged in.</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.903.1">Finally, modify the login template, </span><strong class="source-inline"><span class="koboSpan" id="kobo.904.1">login.html</span></strong><span class="koboSpan" id="kobo.905.1">, to allow the Twitter login. </span><span class="koboSpan" id="kobo.905.2">Add the following line inside the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.906.1">social-logins</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.907.1"> tab:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.908.1">
&lt;a href="{{ url_for('auth.twitter_login',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.909.1">
next</span><a id="_idTextAnchor374"/><span class="koboSpan" id="kobo.910.1">=url_for('auth.home')) }}"&gt;Login via Twitter&lt;/a&gt;</span></pre></li>
</ol>
<h2 id="_idParaDest-199"><a id="_idTextAnchor375"/><span class="koboSpan" id="kobo.911.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.912.1">This recipe </span><a id="_idIndexMarker287"/><span class="koboSpan" id="kobo.913.1">works in </span><a id="_idIndexMarker288"/><span class="koboSpan" id="kobo.914.1">a manner similar to the Facebook and Google logins from </span><span class="No-Break"><span class="koboSpan" id="kobo.915.1">previous recipes.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.916.1">Information</span></p>
<p class="callout"><span class="koboSpan" id="kobo.917.1">Similarly, we can integrate LinkedIn, GitHub, and scores of other third-party providers that provide support for login and authentication using OAuth. </span><span class="koboSpan" id="kobo.917.2">It’s up to you to implement any more integrations. </span><span class="koboSpan" id="kobo.917.3">The following links have been added for </span><span class="No-Break"><span class="koboSpan" id="kobo.918.1">your reference:</span></span></p>
<p class="callout"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.919.1">LinkedIn</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.920.1">: </span></span><a href="https://learn.microsoft.com/en-us/linkedin/shared/authentication/authentication"><span class="No-Break"><span class="koboSpan" id="kobo.921.1">https://learn.microsoft.com/en-us/linkedin/shared/authentication/authentication</span></span></a></p>
<p class="callout"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.922.1">GitHub</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.923.1">: </span></span><a href="https://docs.github.com/en/developers/apps/building-oauth-apps"><span class="No-Break"><span class="koboSpan" id="kobo.924.1">https://docs.</span><span id="_idTextAnchor376"/><span class="koboSpan" id="kobo.925.1">github.com/en/developers/apps/building-oauth-apps</span></span></a></p>
<h1 id="_idParaDest-200"><a id="_idTextAnchor377"/><span class="koboSpan" id="kobo.926.1">Authenticating with LDAP</span></h1>
<p><span class="koboSpan" id="kobo.927.1">LDAP is </span><a id="_idIndexMarker289"/><span class="koboSpan" id="kobo.928.1">essentially </span><a id="_idIndexMarker290"/><span class="koboSpan" id="kobo.929.1">an internet protocol for looking up contact information about users, certificates, network pointers, and more from a server, where the data is stored in a directory-style structure. </span><span class="koboSpan" id="kobo.929.2">Of LDAP’s multiple use cases, the most popular is the single sign-on functionality, where a user can access multiple services by logging in to just o</span><a id="_idTextAnchor378"/><span class="koboSpan" id="kobo.930.1">ne, as the credentials are shared across </span><span class="No-Break"><span class="koboSpan" id="kobo.931.1">the system.</span></span></p>
<h2 id="_idParaDest-201"><a id="_idTextAnchor379"/><span class="koboSpan" id="kobo.932.1">Getting ready</span></h2>
<p><span class="koboSpan" id="kobo.933.1">In this recipe, we will create a login page similar to the one we created in the first recipe of this chapter, </span><em class="italic"><span class="koboSpan" id="kobo.934.1">Creating a simple session-based authentication</span></em><span class="koboSpan" id="kobo.935.1">. </span><span class="koboSpan" id="kobo.935.2">The user can log in using their LDAP credentials. </span><span class="koboSpan" id="kobo.935.3">If the credentials are successfully authenticated on the provided LDAP server, the user is </span><span class="No-Break"><span class="koboSpan" id="kobo.936.1">logged in.</span></span></p>
<p><span class="koboSpan" id="kobo.937.1">If you already have an LDAP server that you can access, feel free to skip the LDAP setup instructions explained in </span><span class="No-Break"><span class="koboSpan" id="kobo.938.1">this section.</span></span></p>
<p><span class="koboSpan" id="kobo.939.1">The first step is to get access to an LDAP server. </span><span class="koboSpan" id="kobo.939.2">This can be a server already hosted somewhere, or you can create your own local LDAP server. </span><span class="koboSpan" id="kobo.939.3">The easiest way to spawn a demo </span><a id="_idIndexMarker291"/><span class="koboSpan" id="kobo.940.1">LDAP </span><a id="_idIndexMarker292"/><span class="koboSpan" id="kobo.941.1">server is by </span><span class="No-Break"><span class="koboSpan" id="kobo.942.1">using Docker.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.943.1">Important</span></p>
<p class="callout"><span class="koboSpan" id="kobo.944.1">Here, we are assuming that you have prior experience in Docker and have Docker installed on your machine. </span><span class="koboSpan" id="kobo.944.2">If not, please refer </span><span class="No-Break"><span class="koboSpan" id="kobo.945.1">to </span></span><a href="https://docs.docker.com/get-started/"><span class="No-Break"><span class="koboSpan" id="kobo.946.1">https://docs.docker.com/</span></span><span class="No-Break"><span class="koboSpan" id="kobo.947.1">get-started/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.948.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.949.1">To create an LDAP server using Docker, run the following command on </span><span class="No-Break"><span class="koboSpan" id="kobo.950.1">the terminal:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.951.1">
$ docker run -p 389:389 -p 636:636 --name my-openldap-container --detach osixia/openldap:1.5.0</span></pre>
<p><span class="koboSpan" id="kobo.952.1">Once the preceding command has successfully executed, test the server by searching for an example user with the username and password </span><strong class="source-inline"><span class="koboSpan" id="kobo.953.1">admin</span></strong><span class="koboSpan" id="kobo.954.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.955.1">admin</span></strong><span class="koboSpan" id="kobo.956.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.957.1">as follows:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.958.1">
$ docker exec my-openldap-container ldapsearch -x -H ldap://localhost -b dc=example,dc=org -D "cn=admin,dc=example,dc=org" -w admin</span></pre>
<p><span class="koboSpan" id="kobo.959.1">The successful execution of the preceding command indicates that the LDAP server is running and is ready </span><span class="No-Break"><span class="koboSpan" id="kobo.960.1">for use.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.961.1">Tip</span></p>
<p class="callout"><span class="koboSpan" id="kobo.962.1">Refer to </span><strong class="source-inline"><span class="koboSpan" id="kobo.963.1">https:/</span></strong><strong class="source-inline"><span class="koboSpan" id="kobo.964.1">/</span></strong><strong class="source-inline"><span class="koboSpan" id="kobo.965.1">github.</span></strong><strong class="source-inline"><span class="koboSpan" id="kobo.966.1">com/</span></strong><strong class="source-inline"><span class="koboSpan" id="kobo.967.1">osixia/</span></strong><strong class="source-inline"><span class="koboSpan" id="kobo.968.1">docker-</span></strong><strong class="source-inline"><span class="koboSpan" id="kobo.969.1">openldap</span></strong><span class="koboSpan" id="kobo.970.1"> for more information on the OpenLDAP </span><span class="No-Break"><span class="koboSpan" id="kobo.971.1">Docker image.</span></span></p>
<p><span class="koboSpan" id="kobo.972.1">Now, install the Python library that will help our application talk to the LDAP server </span><a id="_idTextAnchor380"/><span class="koboSpan" id="kobo.973.1">with the </span><span class="No-Break"><span class="koboSpan" id="kobo.974.1">following code:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.975.1">
    $ pip install python-ldap</span></pre>
<h2 id="_idParaDest-202"><a id="_idTextAnchor381"/><span class="koboSpan" id="kobo.976.1">How to do it...</span></h2>
<p><span class="koboSpan" id="kobo.977.1">To enable LDAP authentication for your application, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.978.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.979.1">As always, start </span><a id="_idIndexMarker293"/><span class="koboSpan" id="kobo.980.1">with</span><a id="_idIndexMarker294"/><span class="koboSpan" id="kobo.981.1"> the configuration part in </span><strong class="source-inline"><span class="koboSpan" id="kobo.982.1">my_app/__init__.py</span></strong><span class="koboSpan" id="kobo.983.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.984.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.985.1">
import ldap</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.986.1">
app.config['LDAP_PROVIDER_URL'] = 'ldap://localhost'</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.987.1">
def get_ldap_connection():</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.988.1">
    conn = ldap.initialize(app.config</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.989.1">
      ['LDAP_PROVIDER_URL'])</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.990.1">
    return conn</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.991.1">In the preceding code snippet, we imported </span><strong class="source-inline"><span class="koboSpan" id="kobo.992.1">ldap</span></strong><span class="koboSpan" id="kobo.993.1">, then created an app configuration option that points to the LDAP server address. </span><span class="koboSpan" id="kobo.993.2">This is followed by the creation of a simple function, </span><strong class="source-inline"><span class="koboSpan" id="kobo.994.1">get_ldap_connection</span></strong><span class="koboSpan" id="kobo.995.1">, which creates the LDAP connection object on the server and then returns that connection object.</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.996.1">Next, modify the views, that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.997.1">my_app/auth/views.py</span></strong><span class="koboSpan" id="kobo.998.1">, where a new route, </span><strong class="source-inline"><span class="koboSpan" id="kobo.999.1">ldap_login</span></strong><span class="koboSpan" id="kobo.1000.1">, is</span><a id="_idIndexMarker295"/><span class="koboSpan" id="kobo.1001.1"> created </span><a id="_idIndexMarker296"/><span class="koboSpan" id="kobo.1002.1">to facilitate login via LDAP, </span><span class="No-Break"><span class="koboSpan" id="kobo.1003.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1004.1">
import ldap</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1005.1">
from my_app import db, login_manager,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1006.1">
  get_ldap_connection</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1007.1">
@auth.route("/ldap-login", methods=['GET', 'POST'])</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1008.1">
def ldap_login():</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1009.1">
    if current_user.is_authenticated:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1010.1">
        flash('Your are already logged in.', 'info')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1011.1">
        return redirect(url_for('auth.home'))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1012.1">
    form = LoginForm()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1013.1">
    if form.validate_on_submit():</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1014.1">
        username = request.form.get('username')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1015.1">
        password = request.form.get('password')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1016.1">
        try:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1017.1">
            conn = get_ldap_connection()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1018.1">
            conn.simple_bind_s(</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1019.1">
                'cn=%s,dc=example,dc=org' % username,</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1020.1">
                password</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1021.1">
            )</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1022.1">
        except ldap.INVALID_CREDENTIALS:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1023.1">
            flash('Invalid username or password.</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1024.1">
              Please try again.', 'danger')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1025.1">
            return render_template('login.html',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1026.1">
              form=form)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1027.1">
        user = User.query.filter_by(username=username)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1028.1">
          .first()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1029.1">
        if not user:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1030.1">
            user = User(username, password)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1031.1">
            db.session.add(user)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1032.1">
            db.session.commit()</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1033.1">
        login_user(user)</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1034.1">
        flash('You have successfully logged in.',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1035.1">
          'success')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1036.1">
        return redirect(url_for('auth.home'))</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1037.1">
    if form.errors:</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1038.1">
        flash(form.errors, 'danger')</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1039.1">
    return render_template('login.html', form=form)</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.1040.1">Here, we first</span><a id="_idIndexMarker297"/><span class="koboSpan" id="kobo.1041.1"> checked </span><a id="_idIndexMarker298"/><span class="koboSpan" id="kobo.1042.1">whether the user is already authenticated. </span><span class="koboSpan" id="kobo.1042.2">If they were, we redirected them to the home page; otherwise, we moved ahead. </span><span class="koboSpan" id="kobo.1042.3">We then used </span><strong class="source-inline"><span class="koboSpan" id="kobo.1043.1">LoginForm</span></strong><span class="koboSpan" id="kobo.1044.1">, which we created in the </span><em class="italic"><span class="koboSpan" id="kobo.1045.1">Creating a simple session-based authentication</span></em><span class="koboSpan" id="kobo.1046.1"> recipe, as we also require a username and password. </span><span class="koboSpan" id="kobo.1046.2">Next, we validated the form and then fetched the connection object using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1047.1">get_ldap_connection</span></strong><span class="koboSpan" id="kobo.1048.1">. </span><span class="koboSpan" id="kobo.1048.2">After, the application tried to authenticate the user from the LDAP server using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1049.1">simple_bind_s</span></strong><span class="koboSpan" id="kobo.1050.1">. </span><span class="koboSpan" id="kobo.1050.2">Notice the string inside this method, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1051.1">'cn=%s,dc=example,dc=org'</span></strong><span class="koboSpan" id="kobo.1052.1"> – this string might vary for each LDAP server depending on the configurations internal to the server. </span><span class="koboSpan" id="kobo.1052.2">You are urged to contact your LDAP server admin if these details are not known.</span></p>
<p><span class="koboSpan" id="kobo.1053.1">If the user is successfully authenticated, then a new user record is created in our local database and the user is logged in. </span><span class="koboSpan" id="kobo.1053.2">Otherwise, the LDAP connection fails and throws the error </span><strong class="source-inline"><span class="koboSpan" id="kobo.1054.1">INVALID_CREDENTIALS</span></strong><span class="koboSpan" id="kobo.1055.1">, which is then caught and the user is notified accordingly.</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1056.1">Tip</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1057.1">We just witnessed the power of reusable components! </span><span class="koboSpan" id="kobo.1057.2">As you can see, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1058.1">LoginForm</span></strong><span class="koboSpan" id="kobo.1059.1"> has now been used for two different purposes. </span><span class="koboSpan" id="kobo.1059.2">This is a good </span><span class="No-Break"><span class="koboSpan" id="kobo.1060.1">coding practice.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.1061.1">Finally, modify </span><a id="_idIndexMarker299"/><span class="koboSpan" id="kobo.1062.1">the login template, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1063.1">login.html</span></strong><span class="koboSpan" id="kobo.1064.1">, to </span><a id="_idIndexMarker300"/><span class="koboSpan" id="kobo.1065.1">allow the LDAP login, </span><span class="No-Break"><span class="koboSpan" id="kobo.1066.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1067.1">
{% extends 'home.html' %}</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1068.1">
{% block container %}</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1069.1">
  &lt;div class="top-pad"&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1070.1">
    &lt;ul class="nav nav-tabs"&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1071.1">
     &lt;li class="active"&gt;&lt;a href="#simple-form" data-</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1072.1">
       toggle="tab"&gt;Old Style Login&lt;/a&gt;&lt;/li&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1073.1">
     &lt;li&gt;&lt;a href="#social-logins" data-</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1074.1">
       toggle="tab"&gt;Social Logins&lt;/a&gt;&lt;/li&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1075.1">
     &lt;li&gt;&lt;a href="#ldap-form" data-toggle="tab"&gt;LDAP</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1076.1">
       Login&lt;/a&gt;&lt;/li&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1077.1">
    &lt;/ul&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1078.1">
    &lt;div class="tab-content"&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1079.1">
      &lt;div class="tab-pane active" id="simple-form"&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1080.1">
        &lt;br/&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1081.1">
        &lt;form</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1082.1">
            method="POST"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1083.1">
            action="{{ url_for('auth.login') }}"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1084.1">
            role="form"&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1085.1">
          {{ form.csrf_token }}</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1086.1">
          &lt;div class="form-group"&gt;{{ form.username</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1087.1">
            .label }}: {{ form.username() }}&lt;/div&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1088.1">
          &lt;div class="form-group"&gt;{{ form.password</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1089.1">
            .label }}: {{ form.password() }}&lt;/div&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1090.1">
          &lt;button type="submit" class="btn btn-</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1091.1">
            default"&gt;Submit&lt;/button&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1092.1">
        &lt;/form&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1093.1">
      &lt;/div&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1094.1">
      &lt;div class="tab-pane" id="social-logins"&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1095.1">
        &lt;a href="{{ url_for('auth.facebook_login',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1096.1">
          next=url_for('auth.home')) }}"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1097.1">
          &gt;Login via Facebook&lt;/a&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1098.1">
        &lt;br/&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1099.1">
        &lt;a href="{{ url_for('auth.google_login',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1100.1">
          next=url_for('auth.home')) }}"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1101.1">
          &gt;Login via Google&lt;/a&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1102.1">
        &lt;br/&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1103.1">
        &lt;a href="{{ url_for('auth.twitter_login',</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1104.1">
          next=url_for('auth.home')) }}"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1105.1">
          &gt;Login via Twitter&lt;/a&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1106.1">
      &lt;/div&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1107.1">
      &lt;div class="tab-pane" id="ldap-form"&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1108.1">
        &lt;br/&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1109.1">
        &lt;form</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1110.1">
            method="POST"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1111.1">
            action="{{ url_for('auth.ldap_login') }}"</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1112.1">
            role="form"&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1113.1">
          {{ form.csrf_token }}</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1114.1">
          &lt;div class="form-group"&gt;{{ form.username</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1115.1">
            .label }}: {{ form.username() }}&lt;/div&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1116.1">
          &lt;div class="form-group"&gt;{{ form.password</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1117.1">
            .label }}: {{ form.password() }}&lt;/div&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1118.1">
          &lt;button type="submit" class="btn btn-</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1119.1">
            default"&gt;Submit&lt;/button&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1120.1">
        &lt;/form&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1121.1">
      &lt;/div&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1122.1">
    &lt;/div&gt;</span></pre><pre class="source-code"><span class="koboSpan" id="kobo.1123.1">
  &lt;/div&gt;</span></pre><pre class="source-code">
<strong class="source-inline"><span class="koboSpan" id="kobo.1124.1">{% endblock %}</span></strong></pre></li>
</ol>
<h2 id="_idParaDest-203"><a id="_idTextAnchor382"/><span class="koboSpan" id="kobo.1125.1">How it works…</span></h2>
<p><span class="koboSpan" id="kobo.1126.1">The new login</span><a id="_idIndexMarker301"/><span class="koboSpan" id="kobo.1127.1"> screen</span><a id="_idIndexMarker302"/><span class="koboSpan" id="kobo.1128.1"> with the LDAP tab should look like the </span><span class="No-Break"><span class="koboSpan" id="kobo.1129.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer048">
<span class="koboSpan" id="kobo.1130.1"><img alt="Figure 6.11 – LDAP Login screen" src="image/B19111_06_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1131.1">Figure 6.11 – LDAP Login screen</span></p>
<p><span class="koboSpan" id="kobo.1132.1">Here, the user simply needs to enter their username and password. </span><span class="koboSpan" id="kobo.1132.2">If the credentials are correct, the </span><a id="_idIndexMarker303"/><span class="koboSpan" id="kobo.1133.1">user </span><a id="_idIndexMarker304"/><span class="koboSpan" id="kobo.1134.1">will be logged</span><a id="_idTextAnchor383"/><span class="koboSpan" id="kobo.1135.1"> in and taken to the home screen; otherwise, an error </span><span class="No-Break"><span class="koboSpan" id="kobo.1136.1">will occur.</span></span></p>
<h2 id="_idParaDest-204"><a id="_idTextAnchor384"/><span class="koboSpan" id="kobo.1137.1">See also</span></h2>
<p><span class="koboSpan" id="kobo.1138.1">You can read more about LDAP at </span><a href="https://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol"><span class="koboSpan" id="kobo.1139.1">https://en.wikipedia.org/wiki/Lightweight_ Directory_Access_Protocol</span></a> <span class="No-Break"><span class="koboSpan" id="kobo.1140.1">and </span></span><a href="https://www.python-ldap.org"><span class="No-Break"><span class="koboSpan" id="kobo.1141.1">https://www.python-ldap.org</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1142.1">.</span></span></p>
</div>
</body></html>