<html xml:lang="en-US" xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<meta charset="utf-8"/>
<meta content="pandoc" name="generator"/>
<title>ch009.xhtml</title>
<link href="../styles/stylesheet1.css" rel="stylesheet" type="text/css"/>
<!-- kobo-style -->
<style id="koboSpanStyle" type="text/css" xmlns="http://www.w3.org/1999/xhtml">.koboSpan { -webkit-text-combine: inherit; }</style>
</head>
<body epub:type="bodymatter">
<section class="level1" data-number="9" id="chapter-5-data-acquisition-features-sql-database">
<h1 data-number="9"><span class="titlemark"><span class="koboSpan" id="kobo.1.1" xmlns="http://www.w3.org/1999/xhtml">Chapter 5</span></span><br/>
<span id="x1-1140005"/><span class="koboSpan" id="kobo.2.1" xmlns="http://www.w3.org/1999/xhtml">Data Acquisition Features: SQL Database</span></h1>
<p><span class="koboSpan" id="kobo.3.1" xmlns="http://www.w3.org/1999/xhtml">In this chapter, you will be guided through two projects that demonstrate how to work with SQL databases as a source of data for analysis. </span><span class="koboSpan" id="kobo.3.2" xmlns="http://www.w3.org/1999/xhtml">This will build on the foundational application built in the previous two chapters.</span></p>
<p><span class="koboSpan" id="kobo.4.1" xmlns="http://www.w3.org/1999/xhtml">This chapter will focus on SQL extracts. </span><span class="koboSpan" id="kobo.4.2" xmlns="http://www.w3.org/1999/xhtml">Since enterprise SQL databases tend to be very private, we’ll guide the reader through creating an SQLite database first. </span><span class="koboSpan" id="kobo.4.3" xmlns="http://www.w3.org/1999/xhtml">This database will be a stand-in for a private enterprise database. </span><span class="koboSpan" id="kobo.4.4" xmlns="http://www.w3.org/1999/xhtml">Once there’s a database available, we will look at extracting data from the database.</span></p>
<p><span class="koboSpan" id="kobo.5.1" xmlns="http://www.w3.org/1999/xhtml">This chapter’s projects cover the following essential skills:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.6.1" xmlns="http://www.w3.org/1999/xhtml">Building SQL databases.</span></p></li>
<li><p><span class="koboSpan" id="kobo.7.1" xmlns="http://www.w3.org/1999/xhtml">Extracting data from SQL databases.</span></p></li>
</ul>
<div class="tcolorbox tipbox" id="tcolobox-66">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.8.1" xmlns="http://www.w3.org/1999/xhtml">The first project will build a SQL database for use by the second project.</span></p>
<p><span class="koboSpan" id="kobo.9.1" xmlns="http://www.w3.org/1999/xhtml">In an enterprise environment, the source databases will already exist.</span></p>
<p><span class="koboSpan" id="kobo.10.1" xmlns="http://www.w3.org/1999/xhtml">On our own personal computers, these databases don’t exist. </span><span class="koboSpan" id="kobo.10.2" xmlns="http://www.w3.org/1999/xhtml">For this reason, we’ll build a database in the first project, and extract from the database in the second project.</span></p>
</div>
</div>
<p><span class="koboSpan" id="kobo.11.1" xmlns="http://www.w3.org/1999/xhtml">We’ll start by looking at getting data into a SQL database. </span><span class="koboSpan" id="kobo.11.2" xmlns="http://www.w3.org/1999/xhtml">This will be a very small and simple database; the project will steer clear of the numerous sophisticated design complications for SQL data.</span></p>
<p><span class="koboSpan" id="kobo.12.1" xmlns="http://www.w3.org/1999/xhtml">The second project will use SQL queries to extract data from the database. </span><span class="koboSpan" id="kobo.12.2" xmlns="http://www.w3.org/1999/xhtml">The objective is to produce data that is consistent with the projects in the previous chapters. </span><span id="x1-114001r117"/></p>
<section class="level2" data-number="9.1" id="project-1.4-a-local-sql-database">
<h2 data-number="9.1"><span class="titlemark"><span class="koboSpan" id="kobo.13.1" xmlns="http://www.w3.org/1999/xhtml">5.1 </span></span> <span id="x1-1150001"/><span class="koboSpan" id="kobo.14.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.4: A local SQL database</span></h2>
<p><span class="koboSpan" id="kobo.15.1" xmlns="http://www.w3.org/1999/xhtml">We’ll often need data stored in a database that’s accessed via the SQL query language. </span><span class="koboSpan" id="kobo.15.2" xmlns="http://www.w3.org/1999/xhtml">Use a search string like “SQL is the lingua franca” to find numerous articles offering more insight into the ubiquity of SQL. </span><span class="koboSpan" id="kobo.15.3" xmlns="http://www.w3.org/1999/xhtml">This seems to be </span><span id="dx1-115001"/><span class="koboSpan" id="kobo.16.1" xmlns="http://www.w3.org/1999/xhtml">one of the primary ways to acquire enterprise data for further analysis.</span></p>
<p><span class="koboSpan" id="kobo.17.1" xmlns="http://www.w3.org/1999/xhtml">In the previous chapter, </span><a href="ch008.xhtml#x1-780004"><em><span class="koboSpan" id="kobo.18.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.19.1" xmlns="http://www.w3.org/1999/xhtml"> 4</span></em></a><span class="koboSpan" id="kobo.20.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch008.xhtml#x1-780004"><em><span class="koboSpan" id="kobo.21.1" xmlns="http://www.w3.org/1999/xhtml">Data Acquisition Features: Web APIs and</span></em> <em><span class="koboSpan" id="kobo.22.1" xmlns="http://www.w3.org/1999/xhtml">Scraping</span></em></a><span class="koboSpan" id="kobo.23.1" xmlns="http://www.w3.org/1999/xhtml">, the projects acquired data from publicly available APIs and web pages. </span><span class="koboSpan" id="kobo.23.2" xmlns="http://www.w3.org/1999/xhtml">There aren’t many publicly available SQL data sources. </span><span class="koboSpan" id="kobo.23.3" xmlns="http://www.w3.org/1999/xhtml">In many cases, there are dumps (or exports) of SQLite databases that can be used to build a local copy of the database. </span><span class="koboSpan" id="kobo.23.4" xmlns="http://www.w3.org/1999/xhtml">Direct access to a remote SQL database is not widely available. </span><span class="koboSpan" id="kobo.23.5" xmlns="http://www.w3.org/1999/xhtml">Rather than try to find access to a remote SQL database, it’s simpler to create a local SQL database. </span><span class="koboSpan" id="kobo.23.6" xmlns="http://www.w3.org/1999/xhtml">The SQLite database is provided with Python as part of the standard library, making it an easy choice.</span></p>
<p><span class="koboSpan" id="kobo.24.1" xmlns="http://www.w3.org/1999/xhtml">You may want to examine other databases and compare their features with SQLite. </span><span class="koboSpan" id="kobo.24.2" xmlns="http://www.w3.org/1999/xhtml">While some databases offer numerous capabilities, doing SQL extracts rarely seems to rely on anything more sophisticated than a basic </span><code><span class="koboSpan" id="kobo.25.1" xmlns="http://www.w3.org/1999/xhtml">SELECT</span></code><span class="koboSpan" id="kobo.26.1" xmlns="http://www.w3.org/1999/xhtml"> statement. </span><span class="koboSpan" id="kobo.26.2" xmlns="http://www.w3.org/1999/xhtml">Using another database may require some changes to reflect that database’s connections and SQL statement execution. </span><span class="koboSpan" id="kobo.26.3" xmlns="http://www.w3.org/1999/xhtml">For the most part, the DB-API interface in Python is widely used; there may be unique features for databases other than SQLite.</span></p>
<p><span class="koboSpan" id="kobo.27.1" xmlns="http://www.w3.org/1999/xhtml">We’ll start with a project to </span><span id="dx1-115002"/><span class="koboSpan" id="kobo.28.1" xmlns="http://www.w3.org/1999/xhtml">populate the database. </span><span class="koboSpan" id="kobo.28.2" xmlns="http://www.w3.org/1999/xhtml">Once a database is available, you can then move on to a more interesting project to extract the data using SQL statements. </span><span id="x1-115003r124"/></p>
<section class="level3" data-number="9.1.1" id="description-4">
<h3 data-number="9.1.1"><span class="titlemark"><span class="koboSpan" id="kobo.29.1" xmlns="http://www.w3.org/1999/xhtml">5.1.1 </span></span> <span id="x1-1160001"/><span class="koboSpan" id="kobo.30.1" xmlns="http://www.w3.org/1999/xhtml">Description</span></h3>
<p><span class="koboSpan" id="kobo.31.1" xmlns="http://www.w3.org/1999/xhtml">The first project for this chapter </span><span id="dx1-116001"/><span class="koboSpan" id="kobo.32.1" xmlns="http://www.w3.org/1999/xhtml">will prepare a SQL database with data to analyze. </span><span class="koboSpan" id="kobo.32.2" xmlns="http://www.w3.org/1999/xhtml">This is a necessary preparation step for readers working outside an enterprise environment with accessible SQL databases.</span></p>
<p><span class="koboSpan" id="kobo.33.1" xmlns="http://www.w3.org/1999/xhtml">One of the most fun small data sets to work with is Anscombe’s Quartet.</span></p>
<p><a class="url" href="https://www.kaggle.com/datasets/carlmcbrideellis/data-anscombes-quartet"><span class="koboSpan" id="kobo.34.1" xmlns="http://www.w3.org/1999/xhtml">https://www.kaggle.com/datasets/carlmcbrideellis/data-anscombes-quartet</span></a></p>
<p><span class="koboSpan" id="kobo.35.1" xmlns="http://www.w3.org/1999/xhtml">The URL given above presents a page with information about the CSV format file. </span><span class="koboSpan" id="kobo.35.2" xmlns="http://www.w3.org/1999/xhtml">Clicking the </span><strong><span class="koboSpan" id="kobo.36.1" xmlns="http://www.w3.org/1999/xhtml">Download </span></strong><span class="koboSpan" id="kobo.37.1" xmlns="http://www.w3.org/1999/xhtml">button will download the small file of data to your local computer.</span></p>
<p><span class="koboSpan" id="kobo.38.1" xmlns="http://www.w3.org/1999/xhtml">The data is available in this book’s GitHub repository’s </span><code><span class="koboSpan" id="kobo.39.1" xmlns="http://www.w3.org/1999/xhtml">data</span></code><span class="koboSpan" id="kobo.40.1" xmlns="http://www.w3.org/1999/xhtml"> folder, also.</span></p>
<p><span class="koboSpan" id="kobo.41.1" xmlns="http://www.w3.org/1999/xhtml">In order to load a database, the first step is designing the database. </span><span class="koboSpan" id="kobo.41.2" xmlns="http://www.w3.org/1999/xhtml">We’ll start with a look at some table definitions.</span></p>
<section class="level4 likesubsubsectionHead" data-number="9.1.1.1" id="database-design">
<h4 class="likesubsubsectionHead" data-number="9.1.1.1"><span id="x1-1170001"/><span class="koboSpan" id="kobo.42.1" xmlns="http://www.w3.org/1999/xhtml">Database design</span></h4>
<p><span class="koboSpan" id="kobo.43.1" xmlns="http://www.w3.org/1999/xhtml">A SQL database is organized as </span><span id="dx1-117001"/><span class="koboSpan" id="kobo.44.1" xmlns="http://www.w3.org/1999/xhtml">tables of data. </span><span class="koboSpan" id="kobo.44.2" xmlns="http://www.w3.org/1999/xhtml">Each table has a fixed set of columns, defined as part of the overall database schema. </span><span class="koboSpan" id="kobo.44.3" xmlns="http://www.w3.org/1999/xhtml">A table can have an indefinite number of rows of data.</span></p>
<p><span class="koboSpan" id="kobo.45.1" xmlns="http://www.w3.org/1999/xhtml">For more information on SQL databases, see </span><a class="url" href="https://www.packtpub.com/product/learn-sql-database-programming/9781838984762"><span class="koboSpan" id="kobo.46.1" xmlns="http://www.w3.org/1999/xhtml">https://www.packtpub.com/product/learn-sql-database-programming/9781838984762</span></a><span class="koboSpan" id="kobo.47.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><a class="url" href="https://courses.packtpub.com/courses/sql"><span class="koboSpan" id="kobo.48.1" xmlns="http://www.w3.org/1999/xhtml">https://courses.packtpub.com/courses/sql</span></a><span class="koboSpan" id="kobo.49.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.50.1" xmlns="http://www.w3.org/1999/xhtml">Anscombe’s Quartet consists of four series of (</span><em><span class="koboSpan" id="kobo.51.1" xmlns="http://www.w3.org/1999/xhtml">x,y</span></em><span class="koboSpan" id="kobo.52.1" xmlns="http://www.w3.org/1999/xhtml">) pairs. </span><span class="koboSpan" id="kobo.52.2" xmlns="http://www.w3.org/1999/xhtml">In one commonly used source file, three of the series share common </span><em><span class="koboSpan" id="kobo.53.1" xmlns="http://www.w3.org/1999/xhtml">x </span></em><span class="koboSpan" id="kobo.54.1" xmlns="http://www.w3.org/1999/xhtml">values, whereas the fourth series has distinct </span><em><span class="koboSpan" id="kobo.55.1" xmlns="http://www.w3.org/1999/xhtml">x </span></em><span class="koboSpan" id="kobo.56.1" xmlns="http://www.w3.org/1999/xhtml">values.</span></p>
<p><span class="koboSpan" id="kobo.57.1" xmlns="http://www.w3.org/1999/xhtml">A relational database often decomposes complicated entities into a collection of simpler entities. </span><span class="koboSpan" id="kobo.57.2" xmlns="http://www.w3.org/1999/xhtml">The objective is to minimize the repetitions of association types. </span><span class="koboSpan" id="kobo.57.3" xmlns="http://www.w3.org/1999/xhtml">The Anscombe’s Quartet information has four distinct series of data values, which can be represented as the following two types of entities:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.58.1" xmlns="http://www.w3.org/1999/xhtml">The series is composed of a number of individual values. </span><span class="koboSpan" id="kobo.58.2" xmlns="http://www.w3.org/1999/xhtml">A table named </span><code><span class="koboSpan" id="kobo.59.1" xmlns="http://www.w3.org/1999/xhtml">series_value</span></code><span class="koboSpan" id="kobo.60.1" xmlns="http://www.w3.org/1999/xhtml"> can store the individual values that are part of a series.</span></p></li>
<li><p><span class="koboSpan" id="kobo.61.1" xmlns="http://www.w3.org/1999/xhtml">A separate entity has identifying information for the series as a whole. </span><span class="koboSpan" id="kobo.61.2" xmlns="http://www.w3.org/1999/xhtml">A table named </span><code><span class="koboSpan" id="kobo.62.1" xmlns="http://www.w3.org/1999/xhtml">sources</span></code><span class="koboSpan" id="kobo.63.1" xmlns="http://www.w3.org/1999/xhtml"> can store identifying information.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.64.1" xmlns="http://www.w3.org/1999/xhtml">This design requires the introduction of </span><span id="dx1-117002"/><span class="koboSpan" id="kobo.65.1" xmlns="http://www.w3.org/1999/xhtml">key values to uniquely identify the series, and connect each value of a series with the summary information for the series.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-67">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.66.1" xmlns="http://www.w3.org/1999/xhtml">For Anscombe’s Quartet data, the summary information for a series is little more than a name.</span></p>
<p><span class="koboSpan" id="kobo.67.1" xmlns="http://www.w3.org/1999/xhtml">This design pattern of an overall summary and supporting details is so common that it is essential for this project to reflect that common pattern.</span></p>
</div>
</div>
<p><span class="koboSpan" id="kobo.68.1" xmlns="http://www.w3.org/1999/xhtml">See </span><a href="#5.1"><em><span class="koboSpan" id="kobo.69.1" xmlns="http://www.w3.org/1999/xhtml">Figure 5.1</span></em></a><span class="koboSpan" id="kobo.70.1" xmlns="http://www.w3.org/1999/xhtml"> for an ERD that shows the two tables that implement these entities and their relationships.</span></p>
<figure class="IMG---Figure">
<span class="koboSpan" id="kobo.71.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 5.1: The Database Schema " src="../media/file24.jpg"/></span>
<figcaption class="IMG---Caption"><span class="id" id="5.1"><span class="koboSpan" id="kobo.72.1" xmlns="http://www.w3.org/1999/xhtml">Figure 5.1: </span></span><span class="content"><span class="koboSpan" id="kobo.73.1" xmlns="http://www.w3.org/1999/xhtml">The Database Schema </span></span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.74.1" xmlns="http://www.w3.org/1999/xhtml">This project will create a small application to build this schema of two tables. </span><span class="koboSpan" id="kobo.74.2" xmlns="http://www.w3.org/1999/xhtml">This application will can then load data into these tables.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="9.1.1.2" id="data-loading">
<h4 class="likesubsubsectionHead" data-number="9.1.1.2"><span id="x1-1180001"/><span class="koboSpan" id="kobo.75.1" xmlns="http://www.w3.org/1999/xhtml">Data loading</span></h4>
<p><span class="koboSpan" id="kobo.76.1" xmlns="http://www.w3.org/1999/xhtml">The process of loading </span><span id="dx1-118001"/><span class="koboSpan" id="kobo.77.1" xmlns="http://www.w3.org/1999/xhtml">data involves three separate operations:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.78.1" xmlns="http://www.w3.org/1999/xhtml">Reading the source data from a CSV (or other format) file.</span></p></li>
<li><p><span class="koboSpan" id="kobo.79.1" xmlns="http://www.w3.org/1999/xhtml">Executing SQL </span><code><span class="koboSpan" id="kobo.80.1" xmlns="http://www.w3.org/1999/xhtml">INSERT</span></code><span class="koboSpan" id="kobo.81.1" xmlns="http://www.w3.org/1999/xhtml"> statements to create rows in tables.</span></p></li>
<li><p><span class="koboSpan" id="kobo.82.1" xmlns="http://www.w3.org/1999/xhtml">Executing a </span><code><span class="koboSpan" id="kobo.83.1" xmlns="http://www.w3.org/1999/xhtml">COMMIT</span></code><span class="koboSpan" id="kobo.84.1" xmlns="http://www.w3.org/1999/xhtml"> to finalize the transaction and write data to the underlying database files.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.85.1" xmlns="http://www.w3.org/1999/xhtml">Prior to any of these steps, the schema </span><span id="dx1-118002"/><span class="koboSpan" id="kobo.86.1" xmlns="http://www.w3.org/1999/xhtml">must be defined using </span><code><span class="koboSpan" id="kobo.87.1" xmlns="http://www.w3.org/1999/xhtml">CREATE</span></code><code><span class="koboSpan" id="kobo.88.1" xmlns="http://www.w3.org/1999/xhtml"> TABLE</span></code><span class="koboSpan" id="kobo.89.1" xmlns="http://www.w3.org/1999/xhtml"> statements.</span></p>
<p><span class="koboSpan" id="kobo.90.1" xmlns="http://www.w3.org/1999/xhtml">In a practical application, it’s also common to offer a composite operation to drop the tables, recreate the schema, and then load the data. </span><span class="koboSpan" id="kobo.90.2" xmlns="http://www.w3.org/1999/xhtml">The rebuilding often happens when exploring or experimenting with database designs. </span><span class="koboSpan" id="kobo.90.3" xmlns="http://www.w3.org/1999/xhtml">Many times, an initial design will prove unsatisfactory, and changes are needed. </span><span class="koboSpan" id="kobo.90.4" xmlns="http://www.w3.org/1999/xhtml">Additionally, the idea of building (and rebuilding) a small database will also be part of the acceptance test for any data acquisition application.</span></p>
<p><span class="koboSpan" id="kobo.91.1" xmlns="http://www.w3.org/1999/xhtml">In the next section, we’ll look at how to create a SQL database that can serve as a surrogate for a production database in a large enterprise. </span><span id="x1-118003r127"/></p>
</section>
</section>
<section class="level3" data-number="9.1.2" id="approach-3">
<h3 data-number="9.1.2"><span class="titlemark"><span class="koboSpan" id="kobo.92.1" xmlns="http://www.w3.org/1999/xhtml">5.1.2 </span></span> <span id="x1-1190002"/><span class="koboSpan" id="kobo.93.1" xmlns="http://www.w3.org/1999/xhtml">Approach</span></h3>
<p><span class="koboSpan" id="kobo.94.1" xmlns="http://www.w3.org/1999/xhtml">There are two </span><span id="dx1-119001"/><span class="koboSpan" id="kobo.95.1" xmlns="http://www.w3.org/1999/xhtml">general approaches to working with SQL databases for this kind of test or demonstration application:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.96.1" xmlns="http://www.w3.org/1999/xhtml">Create a small application to build and populate a database.</span></p></li>
<li><p><span class="koboSpan" id="kobo.97.1" xmlns="http://www.w3.org/1999/xhtml">Create a SQL script via text formatting and run this through the database’s CLI application. </span><span class="koboSpan" id="kobo.97.2" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://sqlite.org/cli.html"><span class="koboSpan" id="kobo.98.1" xmlns="http://www.w3.org/1999/xhtml">https://sqlite.org/cli.html</span></a><span class="koboSpan" id="kobo.99.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.100.1" xmlns="http://www.w3.org/1999/xhtml">The small application will make use of the database client connection to execute SQL statements. </span><span class="koboSpan" id="kobo.100.2" xmlns="http://www.w3.org/1999/xhtml">In this case, a single, generic </span><code><span class="koboSpan" id="kobo.101.1" xmlns="http://www.w3.org/1999/xhtml">INSERT</span></code><span class="koboSpan" id="kobo.102.1" xmlns="http://www.w3.org/1999/xhtml"> statement template with placeholders can be used. </span><span class="koboSpan" id="kobo.102.2" xmlns="http://www.w3.org/1999/xhtml">The client connection can provide values for the placeholders. </span><span class="koboSpan" id="kobo.102.3" xmlns="http://www.w3.org/1999/xhtml">While the application isn’t complex, it will require unit and acceptance test cases.</span></p>
<p><span class="koboSpan" id="kobo.103.1" xmlns="http://www.w3.org/1999/xhtml">The SQL script alternative uses a small application to transform data rows into valid </span><code><span class="koboSpan" id="kobo.104.1" xmlns="http://www.w3.org/1999/xhtml">INSERT</span></code><span class="koboSpan" id="kobo.105.1" xmlns="http://www.w3.org/1999/xhtml"> statements. </span><span class="koboSpan" id="kobo.105.2" xmlns="http://www.w3.org/1999/xhtml">In many cases, a text editor search-and-replace can transform data text into </span><code><span class="koboSpan" id="kobo.106.1" xmlns="http://www.w3.org/1999/xhtml">INSERT</span></code><span class="koboSpan" id="kobo.107.1" xmlns="http://www.w3.org/1999/xhtml"> statements. </span><span class="koboSpan" id="kobo.107.2" xmlns="http://www.w3.org/1999/xhtml">For more complex cases, Python f-strings can be used. </span><span class="koboSpan" id="kobo.107.3" xmlns="http://www.w3.org/1999/xhtml">The f-string might look like the following:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-68">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.108.1" xmlns="http://www.w3.org/1999/xhtml">print(
    f"INSERT INTO SSAMPLES(SERIES, SEQUENCE, X, Y)"
    f"VALUES({series}, {sequence}, ’{x}’, ’{y}’)"
)</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.109.1" xmlns="http://www.w3.org/1999/xhtml">This is often successful but suffers from a potentially severe problem: a </span><em><span class="koboSpan" id="kobo.110.1" xmlns="http://www.w3.org/1999/xhtml">SQL</span></em> <em><span class="koboSpan" id="kobo.111.1" xmlns="http://www.w3.org/1999/xhtml">injection exploit</span></em><span class="koboSpan" id="kobo.112.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.113.1" xmlns="http://www.w3.org/1999/xhtml">The SQL injection exploit works by including an end-of-string-literal apostrophe </span><code><span class="koboSpan" id="kobo.114.1" xmlns="http://www.w3.org/1999/xhtml">’</span></code><span class="koboSpan" id="kobo.115.1" xmlns="http://www.w3.org/1999/xhtml"> in a data value. </span><span class="koboSpan" id="kobo.115.2" xmlns="http://www.w3.org/1999/xhtml">This can lead to an invalid SQL statement. </span><span class="koboSpan" id="kobo.115.3" xmlns="http://www.w3.org/1999/xhtml">In extreme cases, it can allow injecting additional SQL statements to transform the </span><code><span class="koboSpan" id="kobo.116.1" xmlns="http://www.w3.org/1999/xhtml">INSERT</span></code><span class="koboSpan" id="kobo.117.1" xmlns="http://www.w3.org/1999/xhtml"> statement into a script. </span><span class="koboSpan" id="kobo.117.2" xmlns="http://www.w3.org/1999/xhtml">For more information, see </span><a class="url" href="https://owasp.org/www-community/attacks/SQL_Injection"><span class="koboSpan" id="kobo.118.1" xmlns="http://www.w3.org/1999/xhtml">https://owasp.org/www-community/attacks/SQL_Injection</span></a><span class="koboSpan" id="kobo.119.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.119.2" xmlns="http://www.w3.org/1999/xhtml">Also, see </span><a class="url" href="https://xkcd.com/327/"><span class="koboSpan" id="kobo.120.1" xmlns="http://www.w3.org/1999/xhtml">https://xkcd.com/327/</span></a><span class="koboSpan" id="kobo.121.1" xmlns="http://www.w3.org/1999/xhtml"> for another example of a SQL injection exploit.</span></p>
<p><span class="koboSpan" id="kobo.122.1" xmlns="http://www.w3.org/1999/xhtml">While SQL injection can be </span><span id="dx1-119006"/><span class="koboSpan" id="kobo.123.1" xmlns="http://www.w3.org/1999/xhtml">used maliciously, it can also be a distressingly common accident. </span><span class="koboSpan" id="kobo.123.2" xmlns="http://www.w3.org/1999/xhtml">If a text data value happens to have </span><code><span class="koboSpan" id="kobo.124.1" xmlns="http://www.w3.org/1999/xhtml">’</span></code><span class="koboSpan" id="kobo.125.1" xmlns="http://www.w3.org/1999/xhtml"> in it, then this can create a statement in the SQL script file that has invalid syntax. </span><span class="koboSpan" id="kobo.125.2" xmlns="http://www.w3.org/1999/xhtml">SQL cleansing only defers the problem to the potentially complicated SQL cleansing function.</span></p>
<p><span class="koboSpan" id="kobo.126.1" xmlns="http://www.w3.org/1999/xhtml">It’s simpler to avoid building SQL text in the first place. </span><span class="koboSpan" id="kobo.126.2" xmlns="http://www.w3.org/1999/xhtml">A small application can be free from the complications of building SQL text.</span></p>
<p><span class="koboSpan" id="kobo.127.1" xmlns="http://www.w3.org/1999/xhtml">We’ll start by looking at the data definition for this small schema. </span><span class="koboSpan" id="kobo.127.2" xmlns="http://www.w3.org/1999/xhtml">Then we’ll look at the data manipulation statements. </span><span class="koboSpan" id="kobo.127.3" xmlns="http://www.w3.org/1999/xhtml">This will set the stage for designing the small application to build the schema and load the data.</span></p>
<section class="level4 likesubsubsectionHead" data-number="9.1.2.1" id="sql-data-definitions">
<h4 class="likesubsubsectionHead" data-number="9.1.2.1"><span id="x1-1200002"/><span class="koboSpan" id="kobo.128.1" xmlns="http://www.w3.org/1999/xhtml">SQL Data Definitions</span></h4>
<p><span class="koboSpan" id="kobo.129.1" xmlns="http://www.w3.org/1999/xhtml">The essential data definition in SQL is a table </span><span id="dx1-120001"/><span class="koboSpan" id="kobo.130.1" xmlns="http://www.w3.org/1999/xhtml">with a number of columns (also called </span><em><span class="koboSpan" id="kobo.131.1" xmlns="http://www.w3.org/1999/xhtml">attributes</span></em><span class="koboSpan" id="kobo.132.1" xmlns="http://www.w3.org/1999/xhtml">). </span><span class="koboSpan" id="kobo.132.2" xmlns="http://www.w3.org/1999/xhtml">This is </span><span id="dx1-120002"/><span class="koboSpan" id="kobo.133.1" xmlns="http://www.w3.org/1999/xhtml">defined by a </span><code><span class="koboSpan" id="kobo.134.1" xmlns="http://www.w3.org/1999/xhtml">CREATE</span></code><code><span class="koboSpan" id="kobo.135.1" xmlns="http://www.w3.org/1999/xhtml"> TABLE</span></code><span class="koboSpan" id="kobo.136.1" xmlns="http://www.w3.org/1999/xhtml"> statement. </span><span class="koboSpan" id="kobo.136.2" xmlns="http://www.w3.org/1999/xhtml">The list of columns is provided in this statement. </span><span class="koboSpan" id="kobo.136.3" xmlns="http://www.w3.org/1999/xhtml">In addition to the columns, the language permits table constraints to further refine how a table may be used. </span><span class="koboSpan" id="kobo.136.4" xmlns="http://www.w3.org/1999/xhtml">For our purposes, the two tables can be defined as follows:</span></p>
<p><span class="koboSpan" id="kobo.137.1" xmlns="http://www.w3.org/1999/xhtml">-</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-69">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.138.1" xmlns="http://www.w3.org/1999/xhtml">CREATE TABLE IF NOT EXISTS series(
  series_id INTEGER,
  name TEXT,

  PRIMARY KEY (series_id)
);

CREATE TABLE IF NOT EXISTS series_sample(
  series_id INTEGER,
  sequence INTEGER,
  x TEXT,
  y TEXT,

  PRIMARY KEY (series_id, sequence),
  FOREIGN KEY (series_id) REFERENCES series(series_id)
);</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.139.1" xmlns="http://www.w3.org/1999/xhtml">To remove a schema, the </span><code><span class="koboSpan" id="kobo.140.1" xmlns="http://www.w3.org/1999/xhtml">DROP</span></code><code><span class="koboSpan" id="kobo.141.1" xmlns="http://www.w3.org/1999/xhtml"> TABLE</span></code><code><span class="koboSpan" id="kobo.142.1" xmlns="http://www.w3.org/1999/xhtml"> IF</span></code><code><span class="koboSpan" id="kobo.143.1" xmlns="http://www.w3.org/1999/xhtml"> EXISTS</span></code><code><span class="koboSpan" id="kobo.144.1" xmlns="http://www.w3.org/1999/xhtml"> series_sample</span></code><span class="koboSpan" id="kobo.145.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.146.1" xmlns="http://www.w3.org/1999/xhtml">DROP</span></code><code><span class="koboSpan" id="kobo.147.1" xmlns="http://www.w3.org/1999/xhtml"> TABLE</span></code> <code><span class="koboSpan" id="kobo.148.1" xmlns="http://www.w3.org/1999/xhtml">IF</span></code><code><span class="koboSpan" id="kobo.149.1" xmlns="http://www.w3.org/1999/xhtml"> EXISTS</span></code><code><span class="koboSpan" id="kobo.150.1" xmlns="http://www.w3.org/1999/xhtml"> series</span></code><span class="koboSpan" id="kobo.151.1" xmlns="http://www.w3.org/1999/xhtml"> statements will do what’s needed. </span><span class="koboSpan" id="kobo.151.2" xmlns="http://www.w3.org/1999/xhtml">Because of the </span><span id="dx1-120019"/><span class="koboSpan" id="kobo.152.1" xmlns="http://www.w3.org/1999/xhtml">foreign key reference, some databases make it necessary to </span><span id="dx1-120020"/><span class="koboSpan" id="kobo.153.1" xmlns="http://www.w3.org/1999/xhtml">remove all of the related </span><code><span class="koboSpan" id="kobo.154.1" xmlns="http://www.w3.org/1999/xhtml">series_sample</span></code><span class="koboSpan" id="kobo.155.1" xmlns="http://www.w3.org/1999/xhtml"> rows before a </span><code><span class="koboSpan" id="kobo.156.1" xmlns="http://www.w3.org/1999/xhtml">series</span></code><span class="koboSpan" id="kobo.157.1" xmlns="http://www.w3.org/1999/xhtml"> row can be removed.</span></p>
<p><span class="koboSpan" id="kobo.158.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.159.1" xmlns="http://www.w3.org/1999/xhtml">IF</span></code><code><span class="koboSpan" id="kobo.160.1" xmlns="http://www.w3.org/1999/xhtml"> EXISTS</span></code><span class="koboSpan" id="kobo.161.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.162.1" xmlns="http://www.w3.org/1999/xhtml">IF</span></code><code><span class="koboSpan" id="kobo.163.1" xmlns="http://www.w3.org/1999/xhtml"> NOT</span></code><code><span class="koboSpan" id="kobo.164.1" xmlns="http://www.w3.org/1999/xhtml"> EXISTS</span></code><span class="koboSpan" id="kobo.165.1" xmlns="http://www.w3.org/1999/xhtml"> clauses are handy when debugging. </span><span class="koboSpan" id="kobo.165.2" xmlns="http://www.w3.org/1999/xhtml">We may, for example, change the SQL and introduce a syntax error into one of the </span><code><span class="koboSpan" id="kobo.166.1" xmlns="http://www.w3.org/1999/xhtml">CREATE</span></code><code><span class="koboSpan" id="kobo.167.1" xmlns="http://www.w3.org/1999/xhtml"> TABLE</span></code><span class="koboSpan" id="kobo.168.1" xmlns="http://www.w3.org/1999/xhtml"> statements. </span><span class="koboSpan" id="kobo.168.2" xmlns="http://www.w3.org/1999/xhtml">This can leave an incomplete schema. </span><span class="koboSpan" id="kobo.168.3" xmlns="http://www.w3.org/1999/xhtml">After fixing the problem, simply rerunning the entire sequence of </span><code><span class="koboSpan" id="kobo.169.1" xmlns="http://www.w3.org/1999/xhtml">CREATE</span></code><code><span class="koboSpan" id="kobo.170.1" xmlns="http://www.w3.org/1999/xhtml"> TABLE</span></code><span class="koboSpan" id="kobo.171.1" xmlns="http://www.w3.org/1999/xhtml"> statements will create only the tables that were missing.</span></p>
<p><span class="koboSpan" id="kobo.172.1" xmlns="http://www.w3.org/1999/xhtml">An essential feature of this example SQL data model is a simplification of the data types involved. </span><span class="koboSpan" id="kobo.172.2" xmlns="http://www.w3.org/1999/xhtml">Two columns of data in the </span><code><span class="koboSpan" id="kobo.173.1" xmlns="http://www.w3.org/1999/xhtml">series_sample</span></code><span class="koboSpan" id="kobo.174.1" xmlns="http://www.w3.org/1999/xhtml"> table are both defined as </span><code><span class="koboSpan" id="kobo.175.1" xmlns="http://www.w3.org/1999/xhtml">TEXT</span></code><span class="koboSpan" id="kobo.176.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.176.2" xmlns="http://www.w3.org/1999/xhtml">This is a rarity; most SQL databases will use one of the available numeric types.</span></p>
<p><span class="koboSpan" id="kobo.177.1" xmlns="http://www.w3.org/1999/xhtml">While SQL data has a variety of useful types, the raw data from other applications, however, isn’t numeric. </span><span class="koboSpan" id="kobo.177.2" xmlns="http://www.w3.org/1999/xhtml">CSV files </span><span id="dx1-120021"/><span class="koboSpan" id="kobo.178.1" xmlns="http://www.w3.org/1999/xhtml">and HTML pages </span><span id="dx1-120022"/><span class="koboSpan" id="kobo.179.1" xmlns="http://www.w3.org/1999/xhtml">only provide text. </span><span class="koboSpan" id="kobo.179.2" xmlns="http://www.w3.org/1999/xhtml">For this reason, the results from this application need to be text, also. </span><span class="koboSpan" id="kobo.179.3" xmlns="http://www.w3.org/1999/xhtml">Once the tables are defined, an application can insert rows.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="9.1.2.2" id="sql-data-manipulations">
<h4 class="likesubsubsectionHead" data-number="9.1.2.2"><span id="x1-1210002"/><span class="koboSpan" id="kobo.180.1" xmlns="http://www.w3.org/1999/xhtml">SQL Data Manipulations</span></h4>
<p><span class="koboSpan" id="kobo.181.1" xmlns="http://www.w3.org/1999/xhtml">New rows are created with the </span><code><span class="koboSpan" id="kobo.182.1" xmlns="http://www.w3.org/1999/xhtml">INSERT</span></code><span class="koboSpan" id="kobo.183.1" xmlns="http://www.w3.org/1999/xhtml"> statement. </span><span class="koboSpan" id="kobo.183.2" xmlns="http://www.w3.org/1999/xhtml">While SQLite allows some details to be omitted, we’ll stick with a </span><span id="dx1-121001"/><span class="koboSpan" id="kobo.184.1" xmlns="http://www.w3.org/1999/xhtml">slightly wordier but more explicit statement. </span><span class="koboSpan" id="kobo.184.2" xmlns="http://www.w3.org/1999/xhtml">Rows are created in the two tables as follows:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-70">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.185.1" xmlns="http://www.w3.org/1999/xhtml">INSERT INTO series(series_id, name) VALUES(:series_id, :name)

INSERT INTO series_sample(series_id, sequence, x, y)
  VALUES(:series_id, :sequence, :x, :y)</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.186.1" xmlns="http://www.w3.org/1999/xhtml">The identifiers with a colon prefix, </span><code><span class="koboSpan" id="kobo.187.1" xmlns="http://www.w3.org/1999/xhtml">:x</span></code><span class="koboSpan" id="kobo.188.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.189.1" xmlns="http://www.w3.org/1999/xhtml">:y</span></code><span class="koboSpan" id="kobo.190.1" xmlns="http://www.w3.org/1999/xhtml">, </span><code><span class="koboSpan" id="kobo.191.1" xmlns="http://www.w3.org/1999/xhtml">:series_id</span></code><span class="koboSpan" id="kobo.192.1" xmlns="http://www.w3.org/1999/xhtml">, etc., are parameters that will be replaced when </span><span id="dx1-121006"/><span class="koboSpan" id="kobo.193.1" xmlns="http://www.w3.org/1999/xhtml">the statement is executed. </span><span class="koboSpan" id="kobo.193.2" xmlns="http://www.w3.org/1999/xhtml">Since these replacements don’t rely on SQL text rules — like the use of apostrophes to end a string — any value can be used.</span></p>
<p><span class="koboSpan" id="kobo.194.1" xmlns="http://www.w3.org/1999/xhtml">It’s rare to need to delete rows from these tables. </span><span class="koboSpan" id="kobo.194.2" xmlns="http://www.w3.org/1999/xhtml">It’s easier (and sometimes faster) to drop and recreate the tables when replacing the data.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="9.1.2.3" id="sql-execution">
<h4 class="likesubsubsectionHead" data-number="9.1.2.3"><span id="x1-1220002"/><span class="koboSpan" id="kobo.195.1" xmlns="http://www.w3.org/1999/xhtml">SQL Execution</span></h4>
<p><span class="koboSpan" id="kobo.196.1" xmlns="http://www.w3.org/1999/xhtml">Python’s SQLite interface is the </span><code><span class="koboSpan" id="kobo.197.1" xmlns="http://www.w3.org/1999/xhtml">sqlite3</span></code><span class="koboSpan" id="kobo.198.1" xmlns="http://www.w3.org/1999/xhtml"> module. </span><span class="koboSpan" id="kobo.198.2" xmlns="http://www.w3.org/1999/xhtml">This conforms to the PEP-249 standard ( </span><a class="url" href="https://peps.python.org/pep-0249/"><span class="koboSpan" id="kobo.199.1" xmlns="http://www.w3.org/1999/xhtml">https://peps.python.org/pep-0249/</span></a><span class="koboSpan" id="kobo.200.1" xmlns="http://www.w3.org/1999/xhtml">) for database access. </span><span class="koboSpan" id="kobo.200.2" xmlns="http://www.w3.org/1999/xhtml">An application will create a database connection in general. </span><span class="koboSpan" id="kobo.200.3" xmlns="http://www.w3.org/1999/xhtml">It will use </span><span id="dx1-122001"/><span class="koboSpan" id="kobo.201.1" xmlns="http://www.w3.org/1999/xhtml">the connection to create a </span><em><span class="koboSpan" id="kobo.202.1" xmlns="http://www.w3.org/1999/xhtml">cursor</span></em><span class="koboSpan" id="kobo.203.1" xmlns="http://www.w3.org/1999/xhtml">, which can query or update the database.</span></p>
<p><span class="koboSpan" id="kobo.204.1" xmlns="http://www.w3.org/1999/xhtml">The connection is made </span><span id="dx1-122002"/><span class="koboSpan" id="kobo.205.1" xmlns="http://www.w3.org/1999/xhtml">with a connection string. </span><span class="koboSpan" id="kobo.205.2" xmlns="http://www.w3.org/1999/xhtml">For many databases, the connection string will include the server hosting the database, and the database name; it may also include security credentials or other options. </span><span class="koboSpan" id="kobo.205.3" xmlns="http://www.w3.org/1999/xhtml">For SQLite, the connection string can be a complete URI with the form </span><code><span class="koboSpan" id="kobo.206.1" xmlns="http://www.w3.org/1999/xhtml">file:filename.db</span></code><span class="koboSpan" id="kobo.207.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.207.2" xmlns="http://www.w3.org/1999/xhtml">This has a scheme, </span><code><span class="koboSpan" id="kobo.208.1" xmlns="http://www.w3.org/1999/xhtml">file:</span></code><span class="koboSpan" id="kobo.209.1" xmlns="http://www.w3.org/1999/xhtml"> and a path to the database file.</span></p>
<p><span class="koboSpan" id="kobo.210.1" xmlns="http://www.w3.org/1999/xhtml">It’s not required by this application, but a common practice is to sequester the SQL statements into a configuration file. </span><span class="koboSpan" id="kobo.210.2" xmlns="http://www.w3.org/1999/xhtml">Using a TOML format can be a handy way to separate the processing from the SQL statements that implement the processing. </span><span class="koboSpan" id="kobo.210.3" xmlns="http://www.w3.org/1999/xhtml">This separation permits small SQL changes without having to </span><span id="dx1-122003"/><span class="koboSpan" id="kobo.211.1" xmlns="http://www.w3.org/1999/xhtml">change the source files. </span><span class="koboSpan" id="kobo.211.2" xmlns="http://www.w3.org/1999/xhtml">For compiled languages, this is essential. </span><span class="koboSpan" id="kobo.211.3" xmlns="http://www.w3.org/1999/xhtml">For Python, it’s a helpful way to </span><span id="dx1-122004"/><span class="koboSpan" id="kobo.212.1" xmlns="http://www.w3.org/1999/xhtml">make SQL easier to find when making database changes.</span></p>
<p><span class="koboSpan" id="kobo.213.1" xmlns="http://www.w3.org/1999/xhtml">A function to create the schema might look like this:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-71">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.214.1" xmlns="http://www.w3.org/1999/xhtml">CREATE_SERIES = """
CREATE TABLE IF NOT EXISTS series(
-- rest of the SQL shown above...
</span><span class="koboSpan" id="kobo.214.2" xmlns="http://www.w3.org/1999/xhtml">"""

CREATE_VALUES = """
CREATE TABLE IF NOT EXISTS series_sample(
-- rest of the SQL shown above...
</span><span class="koboSpan" id="kobo.214.3" xmlns="http://www.w3.org/1999/xhtml">"""

CREATE_SCHEMA = [
    CREATE_SERIES,
    CREATE_VALUES
]

def execute_statements(
        connection: sqlite3.Connection,
        statements: list[str]
) -&gt; None:
    for statement in statements:
        connection.execute(statement)
    connection.commit()</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.215.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.216.1" xmlns="http://www.w3.org/1999/xhtml">CREATE_SCHEMA</span></code><span class="koboSpan" id="kobo.217.1" xmlns="http://www.w3.org/1999/xhtml"> is the sequence of statements required to build the schema. </span><span class="koboSpan" id="kobo.217.2" xmlns="http://www.w3.org/1999/xhtml">A similar sequence of statements can be defined to drop the schema. </span><span class="koboSpan" id="kobo.217.3" xmlns="http://www.w3.org/1999/xhtml">The two sequences can be combined to drop and recreate the schema as part of ordinary database design and experimentation.</span></p>
<p><span class="koboSpan" id="kobo.218.1" xmlns="http://www.w3.org/1999/xhtml">A main program can create the </span><span id="dx1-122027"/><span class="koboSpan" id="kobo.219.1" xmlns="http://www.w3.org/1999/xhtml">database with code similar to the following:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-72">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.220.1" xmlns="http://www.w3.org/1999/xhtml">with sqlite3.connect("file:example.db", uri=True) as connection:
    schema_build_load(connection, config, data_path)</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.221.1" xmlns="http://www.w3.org/1999/xhtml">This requires a function, </span><code><span class="koboSpan" id="kobo.222.1" xmlns="http://www.w3.org/1999/xhtml">schema_build_load()</span></code><span class="koboSpan" id="kobo.223.1" xmlns="http://www.w3.org/1999/xhtml">, to drop and </span><span id="dx1-122030"/><span class="koboSpan" id="kobo.224.1" xmlns="http://www.w3.org/1999/xhtml">recreate the schema and then load the individual rows of data.</span></p>
<p><span class="koboSpan" id="kobo.225.1" xmlns="http://www.w3.org/1999/xhtml">We’ll turn to the next step, loading the data. </span><span class="koboSpan" id="kobo.225.2" xmlns="http://www.w3.org/1999/xhtml">This begins with loading the series definitions, then follows this with populating the data values for each series.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="9.1.2.4" id="loading-the-series-table">
<h4 class="likesubsubsectionHead" data-number="9.1.2.4"><span id="x1-1230002"/><span class="koboSpan" id="kobo.226.1" xmlns="http://www.w3.org/1999/xhtml">Loading the SERIES table</span></h4>
<p><span class="koboSpan" id="kobo.227.1" xmlns="http://www.w3.org/1999/xhtml">The values in the </span><code><span class="koboSpan" id="kobo.228.1" xmlns="http://www.w3.org/1999/xhtml">SERIES</span></code><span class="koboSpan" id="kobo.229.1" xmlns="http://www.w3.org/1999/xhtml"> table are </span><span id="dx1-123001"/><span class="koboSpan" id="kobo.230.1" xmlns="http://www.w3.org/1999/xhtml">essentially fixed. </span><span class="koboSpan" id="kobo.230.2" xmlns="http://www.w3.org/1999/xhtml">There are four rows to define the four series.</span></p>
<p><span class="koboSpan" id="kobo.231.1" xmlns="http://www.w3.org/1999/xhtml">Executing a SQL data manipulation </span><span id="dx1-123002"/><span class="koboSpan" id="kobo.232.1" xmlns="http://www.w3.org/1999/xhtml">statement requires two things: the statement and a dictionary of values for the placeholders in the statement.</span></p>
<p><span class="koboSpan" id="kobo.233.1" xmlns="http://www.w3.org/1999/xhtml">In the following code sample, we’ll define the statement, as well as four dictionaries with values for placeholders:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-73">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.234.1" xmlns="http://www.w3.org/1999/xhtml">INSERT_SERIES = """
    INSERT INTO series(series_id, name)
        VALUES(:series_id, :name)
"""

SERIES_ROWS = [
    {"series_id": 1, "name": "Series I"},
    {"series_id": 2, "name": "Series II"},
    {"series_id": 3, "name": "Series III"},
    {"series_id": 4, "name": "Series IV"},
]

def load_series(connection: sqlite3.Connection) -&gt; None:
    for series in SERIES_ROWS:
        connection.execute(INSERT_SERIES, series)
    connection.commit()</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.235.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.236.1" xmlns="http://www.w3.org/1999/xhtml">execute()</span></code><span class="koboSpan" id="kobo.237.1" xmlns="http://www.w3.org/1999/xhtml"> method of a connection object is given the SQL statement with placeholders and a dictionary of values to </span><span id="dx1-123019"/><span class="koboSpan" id="kobo.238.1" xmlns="http://www.w3.org/1999/xhtml">use for the placeholders. </span><span class="koboSpan" id="kobo.238.2" xmlns="http://www.w3.org/1999/xhtml">The SQL template and the values are provided to the database to insert rows into the table.</span></p>
<p><span class="koboSpan" id="kobo.239.1" xmlns="http://www.w3.org/1999/xhtml">For the individual data values, however, something </span><span id="dx1-123020"/><span class="koboSpan" id="kobo.240.1" xmlns="http://www.w3.org/1999/xhtml">more is required. </span><span class="koboSpan" id="kobo.240.2" xmlns="http://www.w3.org/1999/xhtml">In the next section, we’ll look at a transformation from source CSV data into a dictionary of parameter values for a SQL statement.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="9.1.2.5" id="loading-the-series_value-table">
<h4 class="likesubsubsectionHead" data-number="9.1.2.5"><span id="x1-1240002"/><span class="koboSpan" id="kobo.241.1" xmlns="http://www.w3.org/1999/xhtml">Loading the SERIES_VALUE table</span></h4>
<p><span class="koboSpan" id="kobo.242.1" xmlns="http://www.w3.org/1999/xhtml">It can help to refer </span><span id="dx1-124001"/><span class="koboSpan" id="kobo.243.1" xmlns="http://www.w3.org/1999/xhtml">back to the project in </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.244.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.245.1" xmlns="http://www.w3.org/1999/xhtml"> 3</span></em></a><span class="koboSpan" id="kobo.246.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.247.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.1: Data</span></em> <em><span class="koboSpan" id="kobo.248.1" xmlns="http://www.w3.org/1999/xhtml">Acquisition Base Application</span></em></a><span class="koboSpan" id="kobo.249.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.249.2" xmlns="http://www.w3.org/1999/xhtml">In this chapter, we </span><span id="dx1-124002"/><span class="koboSpan" id="kobo.250.1" xmlns="http://www.w3.org/1999/xhtml">defined a dataclass for the (</span><em><span class="koboSpan" id="kobo.251.1" xmlns="http://www.w3.org/1999/xhtml">x,y</span></em><span class="koboSpan" id="kobo.252.1" xmlns="http://www.w3.org/1999/xhtml">) pairs, and called it </span><code><span class="koboSpan" id="kobo.253.1" xmlns="http://www.w3.org/1999/xhtml">XYPair</span></code><span class="koboSpan" id="kobo.254.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.254.2" xmlns="http://www.w3.org/1999/xhtml">We also defined a class hierarchy of </span><code><span class="koboSpan" id="kobo.255.1" xmlns="http://www.w3.org/1999/xhtml">PairBuilder</span></code><span class="koboSpan" id="kobo.256.1" xmlns="http://www.w3.org/1999/xhtml"> to create </span><code><span class="koboSpan" id="kobo.257.1" xmlns="http://www.w3.org/1999/xhtml">XYPair</span></code><span class="koboSpan" id="kobo.258.1" xmlns="http://www.w3.org/1999/xhtml"> objects from the CSV row objects.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-74">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.259.1" xmlns="http://www.w3.org/1999/xhtml">It can be confusing to load data using application software that is suspiciously similar to the software for extracting data.</span></p>
<p><span class="koboSpan" id="kobo.260.1" xmlns="http://www.w3.org/1999/xhtml">This confusion often arises in cases like this where we’re forced to build a demonstration database.</span></p>
<p><span class="koboSpan" id="kobo.261.1" xmlns="http://www.w3.org/1999/xhtml">It can also arise in cases where a test database is needed for complex analytic applications.</span></p>
<p><span class="koboSpan" id="kobo.262.1" xmlns="http://www.w3.org/1999/xhtml">In most enterprise environments, the databases already exist and are already full of data. </span><span class="koboSpan" id="kobo.262.2" xmlns="http://www.w3.org/1999/xhtml">Test databases are still needed to confirm that analytic applications work.</span></p>
</div>
</div>
<p><span class="koboSpan" id="kobo.263.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.264.1" xmlns="http://www.w3.org/1999/xhtml">INSERT</span></code><span class="koboSpan" id="kobo.265.1" xmlns="http://www.w3.org/1999/xhtml"> statement, shown above in </span><a href="#x1-1210002"><em><span class="koboSpan" id="kobo.266.1" xmlns="http://www.w3.org/1999/xhtml">SQL Data Manipulations</span></em></a><span class="koboSpan" id="kobo.267.1" xmlns="http://www.w3.org/1999/xhtml"> has four placeholders. </span><span class="koboSpan" id="kobo.267.2" xmlns="http://www.w3.org/1999/xhtml">This means a dictionary with four parameters is required by the </span><code><span class="koboSpan" id="kobo.268.1" xmlns="http://www.w3.org/1999/xhtml">execute()</span></code><span class="koboSpan" id="kobo.269.1" xmlns="http://www.w3.org/1999/xhtml"> method of a connection.</span></p>
<p><span class="koboSpan" id="kobo.270.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.271.1" xmlns="http://www.w3.org/1999/xhtml">dataclasses</span></code><span class="koboSpan" id="kobo.272.1" xmlns="http://www.w3.org/1999/xhtml"> module includes a function, </span><code><span class="koboSpan" id="kobo.273.1" xmlns="http://www.w3.org/1999/xhtml">asdict()</span></code><span class="koboSpan" id="kobo.274.1" xmlns="http://www.w3.org/1999/xhtml">, to transform the object of the </span><code><span class="koboSpan" id="kobo.275.1" xmlns="http://www.w3.org/1999/xhtml">XYPair</span></code><span class="koboSpan" id="kobo.276.1" xmlns="http://www.w3.org/1999/xhtml"> into a dictionary. </span><span class="koboSpan" id="kobo.276.2" xmlns="http://www.w3.org/1999/xhtml">This has </span><span id="dx1-124003"/><span class="koboSpan" id="kobo.277.1" xmlns="http://www.w3.org/1999/xhtml">two of the parameters required, </span><code><span class="koboSpan" id="kobo.278.1" xmlns="http://www.w3.org/1999/xhtml">:x</span></code><span class="koboSpan" id="kobo.279.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.280.1" xmlns="http://www.w3.org/1999/xhtml">:y</span></code><span class="koboSpan" id="kobo.281.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.282.1" xmlns="http://www.w3.org/1999/xhtml">We can use the </span><code><span class="koboSpan" id="kobo.283.1" xmlns="http://www.w3.org/1999/xhtml">|</span></code><span class="koboSpan" id="kobo.284.1" xmlns="http://www.w3.org/1999/xhtml"> operator to </span><span id="dx1-124004"/><span class="koboSpan" id="kobo.285.1" xmlns="http://www.w3.org/1999/xhtml">merge two dictionaries together. </span><span class="koboSpan" id="kobo.285.2" xmlns="http://www.w3.org/1999/xhtml">One dictionary has the essential attributes of the object, created by </span><code><span class="koboSpan" id="kobo.286.1" xmlns="http://www.w3.org/1999/xhtml">asdict()</span></code><span class="koboSpan" id="kobo.287.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.287.2" xmlns="http://www.w3.org/1999/xhtml">The other dictionary is the SQL overheads, including a value for </span><code><span class="koboSpan" id="kobo.288.1" xmlns="http://www.w3.org/1999/xhtml">:series_id</span></code><span class="koboSpan" id="kobo.289.1" xmlns="http://www.w3.org/1999/xhtml">, and a value for </span><code><span class="koboSpan" id="kobo.290.1" xmlns="http://www.w3.org/1999/xhtml">:sequence</span></code><span class="koboSpan" id="kobo.291.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.292.1" xmlns="http://www.w3.org/1999/xhtml">Here’s a fragment of code that shows how this might work:</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.293.1" xmlns="http://www.w3.org/1999/xhtml">for sequence, row in enumerate(reader):
    for series_id, extractor in SERIES_BUILDERS:
        param_values = (
            asdict(extractor(row)) |
            {"series_id": series_id, "sequence": sequence}
        )
        connection.execute(insert_values_SQL, param_values)</span></pre>
<p><span class="koboSpan" id="kobo.294.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.295.1" xmlns="http://www.w3.org/1999/xhtml">reader</span></code><span class="koboSpan" id="kobo.296.1" xmlns="http://www.w3.org/1999/xhtml"> object is a </span><code><span class="koboSpan" id="kobo.297.1" xmlns="http://www.w3.org/1999/xhtml">csv.DictReader</span></code><span class="koboSpan" id="kobo.298.1" xmlns="http://www.w3.org/1999/xhtml"> for the source CSV data. </span><span class="koboSpan" id="kobo.298.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.299.1" xmlns="http://www.w3.org/1999/xhtml">SERIES_BUILDERS</span></code><span class="koboSpan" id="kobo.300.1" xmlns="http://www.w3.org/1999/xhtml"> object is a sequence of two-tuples with the series number and a function (or callable object) to extract the appropriate columns and build an instance of </span><code><span class="koboSpan" id="kobo.301.1" xmlns="http://www.w3.org/1999/xhtml">XYPair</span></code><span class="koboSpan" id="kobo.302.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.303.1" xmlns="http://www.w3.org/1999/xhtml">For completeness, here’s the value of the </span><code><span class="koboSpan" id="kobo.304.1" xmlns="http://www.w3.org/1999/xhtml">SERIES_BUILDERS</span></code><span class="koboSpan" id="kobo.305.1" xmlns="http://www.w3.org/1999/xhtml"> object:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-75">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.306.1" xmlns="http://www.w3.org/1999/xhtml">    SERIES_BUILDERS = [
    (1, series_1),
    (2, series_2),
    (3, series_3),
    (4, series_4)
]</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.307.1" xmlns="http://www.w3.org/1999/xhtml">In this case, individual functions have been defined to extract the required columns from the CSV source dictionary and build an instance of </span><code><span class="koboSpan" id="kobo.308.1" xmlns="http://www.w3.org/1999/xhtml">XYPair</span></code><span class="koboSpan" id="kobo.309.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.310.1" xmlns="http://www.w3.org/1999/xhtml">The above code snippets </span><span id="dx1-124018"/><span class="koboSpan" id="kobo.311.1" xmlns="http://www.w3.org/1999/xhtml">need to be built as </span><span id="dx1-124019"/><span class="koboSpan" id="kobo.312.1" xmlns="http://www.w3.org/1999/xhtml">proper functions and used by an overall </span><code><span class="koboSpan" id="kobo.313.1" xmlns="http://www.w3.org/1999/xhtml">main()</span></code><span class="koboSpan" id="kobo.314.1" xmlns="http://www.w3.org/1999/xhtml"> function to drop the schema, build the schema, insert the values for the </span><code><span class="koboSpan" id="kobo.315.1" xmlns="http://www.w3.org/1999/xhtml">SERIES</span></code><span class="koboSpan" id="kobo.316.1" xmlns="http://www.w3.org/1999/xhtml"> table, and then insert the </span><code><span class="koboSpan" id="kobo.317.1" xmlns="http://www.w3.org/1999/xhtml">SERIES_VALUE</span></code><span class="koboSpan" id="kobo.318.1" xmlns="http://www.w3.org/1999/xhtml"> rows.</span></p>
<p><span class="koboSpan" id="kobo.319.1" xmlns="http://www.w3.org/1999/xhtml">A helpful final step is a query to confirm the data was loaded. </span><span class="koboSpan" id="kobo.319.2" xmlns="http://www.w3.org/1999/xhtml">Consider something like this:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-76">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.320.1" xmlns="http://www.w3.org/1999/xhtml">SELECT s.name, COUNT(*)
  FROM series s JOIN series_sample sv
    ON s.series_id = sv.series_id
  GROUP BY s.series_id</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.321.1" xmlns="http://www.w3.org/1999/xhtml">This should report the names of the four series and the presence of 11 rows of data. </span><span id="x1-124024r131"/></p>
</section>
</section>
<section class="level3" data-number="9.1.3" id="deliverables-4">
<h3 data-number="9.1.3"><span class="titlemark"><span class="koboSpan" id="kobo.322.1" xmlns="http://www.w3.org/1999/xhtml">5.1.3 </span></span> <span id="x1-1250003"/><span class="koboSpan" id="kobo.323.1" xmlns="http://www.w3.org/1999/xhtml">Deliverables</span></h3>
<p><span class="koboSpan" id="kobo.324.1" xmlns="http://www.w3.org/1999/xhtml">There are two deliverables for this mini-project:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.325.1" xmlns="http://www.w3.org/1999/xhtml">A database for use in </span><span id="dx1-125001"/><span class="koboSpan" id="kobo.326.1" xmlns="http://www.w3.org/1999/xhtml">the next project. </span><span class="koboSpan" id="kobo.326.2" xmlns="http://www.w3.org/1999/xhtml">The primary goal is to create a database that is a surrogate for a production database in use by an enterprise.</span></p></li>
<li><p><span class="koboSpan" id="kobo.327.1" xmlns="http://www.w3.org/1999/xhtml">An application that can build (and rebuild) this database. </span><span class="koboSpan" id="kobo.327.2" xmlns="http://www.w3.org/1999/xhtml">This secondary goal is the means to achieve the primary goal.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.328.1" xmlns="http://www.w3.org/1999/xhtml">Additionally, of course, unit tests are strongly encouraged. </span><span class="koboSpan" id="kobo.328.2" xmlns="http://www.w3.org/1999/xhtml">This works out well when the application is designed for testability. </span><span class="koboSpan" id="kobo.328.3" xmlns="http://www.w3.org/1999/xhtml">This means two features are essential:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.329.1" xmlns="http://www.w3.org/1999/xhtml">The database connection object is created in the </span><code><span class="koboSpan" id="kobo.330.1" xmlns="http://www.w3.org/1999/xhtml">main()</span></code><span class="koboSpan" id="kobo.331.1" xmlns="http://www.w3.org/1999/xhtml"> function.</span></p></li>
<li><p><span class="koboSpan" id="kobo.332.1" xmlns="http://www.w3.org/1999/xhtml">The connection object is passed as an argument value to all the other functions that interact with the database.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.333.1" xmlns="http://www.w3.org/1999/xhtml">Providing the connection as a parameter value makes it possible to test the various functions isolated from the overhead of a database connection. </span><span class="koboSpan" id="kobo.333.2" xmlns="http://www.w3.org/1999/xhtml">The tests for each application function that interacts with the database are given a mock connection object. </span><span class="koboSpan" id="kobo.333.3" xmlns="http://www.w3.org/1999/xhtml">Most mock connection objects have a mock </span><code><span class="koboSpan" id="kobo.334.1" xmlns="http://www.w3.org/1999/xhtml">execute()</span></code><span class="koboSpan" id="kobo.335.1" xmlns="http://www.w3.org/1999/xhtml"> method, which returns a mock cursor with no rows. </span><span class="koboSpan" id="kobo.335.2" xmlns="http://www.w3.org/1999/xhtml">For queries, the mock </span><code><span class="koboSpan" id="kobo.336.1" xmlns="http://www.w3.org/1999/xhtml">execute()</span></code><span class="koboSpan" id="kobo.337.1" xmlns="http://www.w3.org/1999/xhtml"> method can return mocked data rows, often something as simple as a </span><code><span class="koboSpan" id="kobo.338.1" xmlns="http://www.w3.org/1999/xhtml">sentinel</span></code><span class="koboSpan" id="kobo.339.1" xmlns="http://www.w3.org/1999/xhtml"> object.</span></p>
<p><span class="koboSpan" id="kobo.340.1" xmlns="http://www.w3.org/1999/xhtml">After exercising a function, the mock </span><code><span class="koboSpan" id="kobo.341.1" xmlns="http://www.w3.org/1999/xhtml">execute()</span></code><span class="koboSpan" id="kobo.342.1" xmlns="http://www.w3.org/1999/xhtml"> method can then be examined to be sure the statement and parameters were provided to the database by the application.</span></p>
<p><span class="koboSpan" id="kobo.343.1" xmlns="http://www.w3.org/1999/xhtml">A formal acceptance test for this </span><span id="dx1-125002"/><span class="koboSpan" id="kobo.344.1" xmlns="http://www.w3.org/1999/xhtml">kind of one-use-only application seems excessive. </span><span class="koboSpan" id="kobo.344.2" xmlns="http://www.w3.org/1999/xhtml">It seems easier to run the application and look at the results with a SQL </span><code><span class="koboSpan" id="kobo.345.1" xmlns="http://www.w3.org/1999/xhtml">SELECT</span></code><span class="koboSpan" id="kobo.346.1" xmlns="http://www.w3.org/1999/xhtml"> query. </span><span class="koboSpan" id="kobo.346.2" xmlns="http://www.w3.org/1999/xhtml">Since the application drops and recreates the schema, it can be re-run until the results are acceptable. </span><span id="x1-125003r126"/></p>
</section>
</section>
<section class="level2" data-number="9.2" id="project-1.5-acquire-data-from-a-sql-extract">
<h2 data-number="9.2"><span class="titlemark"><span class="koboSpan" id="kobo.347.1" xmlns="http://www.w3.org/1999/xhtml">5.2 </span></span> <span id="x1-1260002"/><span class="koboSpan" id="kobo.348.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.5: Acquire data from a SQL extract</span></h2>
<p><span class="koboSpan" id="kobo.349.1" xmlns="http://www.w3.org/1999/xhtml">At this point, you now have a useful SQL database with schema and data. </span><span class="koboSpan" id="kobo.349.2" xmlns="http://www.w3.org/1999/xhtml">The next step is to write applications to </span><span id="dx1-126001"/><span class="koboSpan" id="kobo.350.1" xmlns="http://www.w3.org/1999/xhtml">extract data from this </span><span id="dx1-126002"/><span class="koboSpan" id="kobo.351.1" xmlns="http://www.w3.org/1999/xhtml">database into a useful format. </span><span id="x1-126003r137"/></p>
<section class="level3" data-number="9.2.1" id="description-5">
<h3 data-number="9.2.1"><span class="titlemark"><span class="koboSpan" id="kobo.352.1" xmlns="http://www.w3.org/1999/xhtml">5.2.1 </span></span> <span id="x1-1270001"/><span class="koboSpan" id="kobo.353.1" xmlns="http://www.w3.org/1999/xhtml">Description</span></h3>
<p><span class="koboSpan" id="kobo.354.1" xmlns="http://www.w3.org/1999/xhtml">It can be difficult to use an operational database for analytic processing. </span><span class="koboSpan" id="kobo.354.2" xmlns="http://www.w3.org/1999/xhtml">During normal operations, locking is used to assure </span><span id="dx1-127001"/><span class="koboSpan" id="kobo.355.1" xmlns="http://www.w3.org/1999/xhtml">that database changes don’t conflict with or overwrite each other. </span><span class="koboSpan" id="kobo.355.2" xmlns="http://www.w3.org/1999/xhtml">This locking can interfere with gathering data from the database for analytic purposes.</span></p>
<p><span class="koboSpan" id="kobo.356.1" xmlns="http://www.w3.org/1999/xhtml">There are a number of strategies for extracting data from an operational database. </span><span class="koboSpan" id="kobo.356.2" xmlns="http://www.w3.org/1999/xhtml">One technique is to make a backup of the operational database and restore it into a temporary clone database for analytic purposes. </span><span class="koboSpan" id="kobo.356.3" xmlns="http://www.w3.org/1999/xhtml">Another technique is to use any replication features and do analytical work in the replicated database.</span></p>
<p><span class="koboSpan" id="kobo.357.1" xmlns="http://www.w3.org/1999/xhtml">The strategy we’ll pursue here is the “table-scan” approach. </span><span class="koboSpan" id="kobo.357.2" xmlns="http://www.w3.org/1999/xhtml">It’s often possible to do rapid queries without taking out any database locks. </span><span class="koboSpan" id="kobo.357.3" xmlns="http://www.w3.org/1999/xhtml">The data may be inconsistent because of in-process transactions taking place at the time the query was running. </span><span class="koboSpan" id="kobo.357.4" xmlns="http://www.w3.org/1999/xhtml">In most cases, the number of inconsistent entities is a tiny fraction of the available data.</span></p>
<p><span class="koboSpan" id="kobo.358.1" xmlns="http://www.w3.org/1999/xhtml">If it’s necessary to have a </span><em><span class="koboSpan" id="kobo.359.1" xmlns="http://www.w3.org/1999/xhtml">complete and consistent </span></em><span class="koboSpan" id="kobo.360.1" xmlns="http://www.w3.org/1999/xhtml">snapshot at a specific point in time, the applications need to have been designed with this idea in mind. </span><span class="koboSpan" id="kobo.360.2" xmlns="http://www.w3.org/1999/xhtml">It can be very difficult to establish the state of a busy database with updates being performed by poorly designed applications. </span><span class="koboSpan" id="kobo.360.3" xmlns="http://www.w3.org/1999/xhtml">In some cases, the definitions of </span><em><span class="koboSpan" id="kobo.361.1" xmlns="http://www.w3.org/1999/xhtml">complete </span></em><span class="koboSpan" id="kobo.362.1" xmlns="http://www.w3.org/1999/xhtml">and </span><em><span class="koboSpan" id="kobo.363.1" xmlns="http://www.w3.org/1999/xhtml">consistent </span></em><span class="koboSpan" id="kobo.364.1" xmlns="http://www.w3.org/1999/xhtml">may be difficult to articulate because the domain of </span><span id="dx1-127002"/><span class="koboSpan" id="kobo.365.1" xmlns="http://www.w3.org/1999/xhtml">state changes isn’t known in enough detail.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-77">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.366.1" xmlns="http://www.w3.org/1999/xhtml">It can be frustrating to work with poorly designed databases.</span></p>
<p><span class="koboSpan" id="kobo.367.1" xmlns="http://www.w3.org/1999/xhtml">It’s often important to educate potential users of analytic software on the complexities of acquiring the data. </span><span class="koboSpan" id="kobo.367.2" xmlns="http://www.w3.org/1999/xhtml">This education needs to translate the database complications into the effect on the decisions they’re trying to make and the data that supports those decisions.</span></p>
</div>
</div>
<p><span class="koboSpan" id="kobo.368.1" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.369.1" xmlns="http://www.w3.org/1999/xhtml">User Experience </span></strong><span class="koboSpan" id="kobo.370.1" xmlns="http://www.w3.org/1999/xhtml">(</span><strong><span class="koboSpan" id="kobo.371.1" xmlns="http://www.w3.org/1999/xhtml">UX</span></strong><span class="koboSpan" id="kobo.372.1" xmlns="http://www.w3.org/1999/xhtml">) will be a command-line application. </span><span class="koboSpan" id="kobo.372.2" xmlns="http://www.w3.org/1999/xhtml">Our expected command line should </span><span id="dx1-127003"/><span class="koboSpan" id="kobo.373.1" xmlns="http://www.w3.org/1999/xhtml">look something like the following:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-78">
<div class="tcolorbox-content">
<pre class="console"><span class="koboSpan" id="kobo.374.1" xmlns="http://www.w3.org/1999/xhtml">% python src/acquire.py -o quartet --schema extract.toml \
  --db_uri file:example.db -u username

Enter your password:</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.375.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.376.1" xmlns="http://www.w3.org/1999/xhtml">-o</span></code><code><span class="koboSpan" id="kobo.377.1" xmlns="http://www.w3.org/1999/xhtml"> quartet</span></code><span class="koboSpan" id="kobo.378.1" xmlns="http://www.w3.org/1999/xhtml"> argument specifies a directory into which four results are written. </span><span class="koboSpan" id="kobo.378.2" xmlns="http://www.w3.org/1999/xhtml">These will have names like </span><code><span class="koboSpan" id="kobo.379.1" xmlns="http://www.w3.org/1999/xhtml">quartet/series_1.json</span></code><span class="koboSpan" id="kobo.380.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.381.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.382.1" xmlns="http://www.w3.org/1999/xhtml">--schema</span></code><code><span class="koboSpan" id="kobo.383.1" xmlns="http://www.w3.org/1999/xhtml"> extract.toml</span></code><span class="koboSpan" id="kobo.384.1" xmlns="http://www.w3.org/1999/xhtml"> argument is the name of a file with the SQL statements that form the basis for the database queries. </span><span class="koboSpan" id="kobo.384.2" xmlns="http://www.w3.org/1999/xhtml">These are kept separate from the application to make it slightly easier to respond to the database structure changes without rewriting the application program.</span></p>
<p><span class="koboSpan" id="kobo.385.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.386.1" xmlns="http://www.w3.org/1999/xhtml">--db_uri</span></code><code><span class="koboSpan" id="kobo.387.1" xmlns="http://www.w3.org/1999/xhtml"> file:example.db</span></code><span class="koboSpan" id="kobo.388.1" xmlns="http://www.w3.org/1999/xhtml"> argument provides the URI for the database. </span><span class="koboSpan" id="kobo.388.2" xmlns="http://www.w3.org/1999/xhtml">For SQLite, the URIs have a scheme of </span><code><span class="koboSpan" id="kobo.389.1" xmlns="http://www.w3.org/1999/xhtml">file:</span></code><span class="koboSpan" id="kobo.390.1" xmlns="http://www.w3.org/1999/xhtml"> and a path to the database file. </span><span class="koboSpan" id="kobo.390.2" xmlns="http://www.w3.org/1999/xhtml">For other database engines, the URI may be more complicated.</span></p>
<p><span class="koboSpan" id="kobo.391.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.392.1" xmlns="http://www.w3.org/1999/xhtml">-u</span></code><span class="koboSpan" id="kobo.393.1" xmlns="http://www.w3.org/1999/xhtml"> argument provides a username for connecting to the database. </span><span class="koboSpan" id="kobo.393.2" xmlns="http://www.w3.org/1999/xhtml">The password is requested by an interactive prompt. </span><span class="koboSpan" id="kobo.393.3" xmlns="http://www.w3.org/1999/xhtml">This </span><span id="dx1-127008"/><span class="koboSpan" id="kobo.394.1" xmlns="http://www.w3.org/1999/xhtml">keeps the password hidden.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-79">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.395.1" xmlns="http://www.w3.org/1999/xhtml">The UX shown above includes a username and password.</span></p>
<p><span class="koboSpan" id="kobo.396.1" xmlns="http://www.w3.org/1999/xhtml">While it won’t actually be needed for SQLite, it will be needed for other databases.</span></p>
</div>
</div>
<p><span id="x1-127009r139"/></p>
</section>
<section class="level3" data-number="9.2.2" id="the-object-relational-mapping-orm-problem">
<h3 data-number="9.2.2"><span class="titlemark"><span class="koboSpan" id="kobo.397.1" xmlns="http://www.w3.org/1999/xhtml">5.2.2 </span></span> <span id="x1-1280002"/><span class="koboSpan" id="kobo.398.1" xmlns="http://www.w3.org/1999/xhtml">The Object-Relational Mapping (ORM) problem</span></h3>
<p><span class="koboSpan" id="kobo.399.1" xmlns="http://www.w3.org/1999/xhtml">A relational database design decomposes complicated data structures into a number of simpler entity types, which are represented as tables. </span><span class="koboSpan" id="kobo.399.2" xmlns="http://www.w3.org/1999/xhtml">The process of decomposing a data structure into </span><span id="dx1-128001"/><span class="koboSpan" id="kobo.400.1" xmlns="http://www.w3.org/1999/xhtml">entities is called </span><em><span class="koboSpan" id="kobo.401.1" xmlns="http://www.w3.org/1999/xhtml">normalization</span></em><span class="koboSpan" id="kobo.402.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.402.2" xmlns="http://www.w3.org/1999/xhtml">Many database designs fit a pattern called </span><em><span class="koboSpan" id="kobo.403.1" xmlns="http://www.w3.org/1999/xhtml">Third Normal Form</span></em><span class="koboSpan" id="kobo.404.1" xmlns="http://www.w3.org/1999/xhtml">; but there are additional normalization forms. </span><span class="koboSpan" id="kobo.404.2" xmlns="http://www.w3.org/1999/xhtml">Additionally, there are compelling reasons to break </span><span id="dx1-128002"/><span class="koboSpan" id="kobo.405.1" xmlns="http://www.w3.org/1999/xhtml">some of the normalization rules to improve performance.</span></p>
<p><span class="koboSpan" id="kobo.406.1" xmlns="http://www.w3.org/1999/xhtml">The relational normalization leads to a consistent representation of data via simple tables and columns. </span><span class="koboSpan" id="kobo.406.2" xmlns="http://www.w3.org/1999/xhtml">Each column will have an </span><span id="dx1-128003"/><span class="koboSpan" id="kobo.407.1" xmlns="http://www.w3.org/1999/xhtml">atomic value that cannot be further decomposed. </span><span class="koboSpan" id="kobo.407.2" xmlns="http://www.w3.org/1999/xhtml">Data of arbitrary complexity can be represented in related collections of flat, normalized tables.</span></p>
<p><span class="koboSpan" id="kobo.408.1" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://www.packtpub.com/product/basic-relational-database-design-video/9781838557201"><span class="koboSpan" id="kobo.409.1" xmlns="http://www.w3.org/1999/xhtml">https://www.packtpub.com/product/basic-relational-database-design-video/9781838557201</span></a><span class="koboSpan" id="kobo.410.1" xmlns="http://www.w3.org/1999/xhtml"> for some more insights into the database design activity.</span></p>
<p><span class="koboSpan" id="kobo.411.1" xmlns="http://www.w3.org/1999/xhtml">The process of retrieving a complex structure is done via a relational </span><em><span class="koboSpan" id="kobo.412.1" xmlns="http://www.w3.org/1999/xhtml">join </span></em><span class="koboSpan" id="kobo.413.1" xmlns="http://www.w3.org/1999/xhtml">operation. </span><span class="koboSpan" id="kobo.413.2" xmlns="http://www.w3.org/1999/xhtml">Rows from different tables and joined into a result set from which Plain Old Python Objects can be constructed. </span><span class="koboSpan" id="kobo.413.3" xmlns="http://www.w3.org/1999/xhtml">This join operation is part of the </span><code><span class="koboSpan" id="kobo.414.1" xmlns="http://www.w3.org/1999/xhtml">SELECT</span></code><span class="koboSpan" id="kobo.415.1" xmlns="http://www.w3.org/1999/xhtml"> statement. </span><span class="koboSpan" id="kobo.415.2" xmlns="http://www.w3.org/1999/xhtml">It appears in the </span><code><span class="koboSpan" id="kobo.416.1" xmlns="http://www.w3.org/1999/xhtml">FROM</span></code><span class="koboSpan" id="kobo.417.1" xmlns="http://www.w3.org/1999/xhtml"> clause as a rule that states how to match rows in one table with rows from another table.</span></p>
<p><span class="koboSpan" id="kobo.418.1" xmlns="http://www.w3.org/1999/xhtml">This distinction </span><span id="dx1-128004"/><span class="koboSpan" id="kobo.419.1" xmlns="http://www.w3.org/1999/xhtml">between relational design and object-oriented design is sometimes called the </span><em><span class="koboSpan" id="kobo.420.1" xmlns="http://www.w3.org/1999/xhtml">Object-Relational Impedance Mismatch</span></em><span class="koboSpan" id="kobo.421.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.421.2" xmlns="http://www.w3.org/1999/xhtml">For more background, see </span><a class="url" href="https://wiki.c2.com/?ObjectRelationalImpedanceMismatch"><span class="koboSpan" id="kobo.422.1" xmlns="http://www.w3.org/1999/xhtml">https://wiki.c2.com/?ObjectRelationalImpedanceMismatch</span></a><span class="koboSpan" id="kobo.423.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.424.1" xmlns="http://www.w3.org/1999/xhtml">One general approach to reading complex data from a relational database is to create to an ORM layer. </span><span class="koboSpan" id="kobo.424.2" xmlns="http://www.w3.org/1999/xhtml">This layer uses SQL SELECT statements to extract data from multiple tables to build a useful object instance. </span><span class="koboSpan" id="kobo.424.3" xmlns="http://www.w3.org/1999/xhtml">The ORM layer may use a separate package, or it may be part of the application. </span><span class="koboSpan" id="kobo.424.4" xmlns="http://www.w3.org/1999/xhtml">While an ORM design can be designed poorly — i.e. </span><span class="koboSpan" id="kobo.424.5" xmlns="http://www.w3.org/1999/xhtml">the ORM-related operations may be scattered around haphazardly — the layer is always present in any application.</span></p>
<p><span class="koboSpan" id="kobo.425.1" xmlns="http://www.w3.org/1999/xhtml">There are many </span><span id="dx1-128005"/><span class="koboSpan" id="kobo.426.1" xmlns="http://www.w3.org/1999/xhtml">packages in the </span><strong><span class="koboSpan" id="kobo.427.1" xmlns="http://www.w3.org/1999/xhtml">Python Package Index</span></strong><span class="koboSpan" id="kobo.428.1" xmlns="http://www.w3.org/1999/xhtml">(</span><strong><span class="koboSpan" id="kobo.429.1" xmlns="http://www.w3.org/1999/xhtml">PyPI</span></strong><span class="koboSpan" id="kobo.430.1" xmlns="http://www.w3.org/1999/xhtml">) that offer elegant, generalized ORM solutions. </span><span class="koboSpan" id="kobo.430.2" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.431.1" xmlns="http://www.w3.org/1999/xhtml">SQLAlchemy </span></strong><span class="koboSpan" id="kobo.432.1" xmlns="http://www.w3.org/1999/xhtml">( </span><a class="url" href="https://www.sqlalchemy.org"><span class="koboSpan" id="kobo.433.1" xmlns="http://www.w3.org/1999/xhtml">https://www.sqlalchemy.org</span></a><span class="koboSpan" id="kobo.434.1" xmlns="http://www.w3.org/1999/xhtml">) package is very popular. </span><span class="koboSpan" id="kobo.434.2" xmlns="http://www.w3.org/1999/xhtml">This </span><span id="dx1-128006"/><span class="koboSpan" id="kobo.435.1" xmlns="http://www.w3.org/1999/xhtml">provides a comprehensive </span><span id="dx1-128007"/><span class="koboSpan" id="kobo.436.1" xmlns="http://www.w3.org/1999/xhtml">approach to the entire suite of </span><strong><span class="koboSpan" id="kobo.437.1" xmlns="http://www.w3.org/1999/xhtml">Create, Retrieve, Update, and Delete</span></strong><span class="koboSpan" id="kobo.438.1" xmlns="http://www.w3.org/1999/xhtml">(</span><strong><span class="koboSpan" id="kobo.439.1" xmlns="http://www.w3.org/1999/xhtml">CRUD</span></strong><span class="koboSpan" id="kobo.440.1" xmlns="http://www.w3.org/1999/xhtml">) operations.</span></p>
<p><span class="koboSpan" id="kobo.441.1" xmlns="http://www.w3.org/1999/xhtml">There are two conditions </span><span id="dx1-128008"/><span class="koboSpan" id="kobo.442.1" xmlns="http://www.w3.org/1999/xhtml">that suggest creating the ORM layer manually:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.443.1" xmlns="http://www.w3.org/1999/xhtml">Read-only access to a database. </span><span class="koboSpan" id="kobo.443.2" xmlns="http://www.w3.org/1999/xhtml">A full ORM will include features for operations that won’t be used.</span></p></li>
<li><p><span class="koboSpan" id="kobo.444.1" xmlns="http://www.w3.org/1999/xhtml">An oddly designed schema. </span><span class="koboSpan" id="kobo.444.2" xmlns="http://www.w3.org/1999/xhtml">It can sometimes be difficult to work out an ORM definition for an existing schema with a design that doesn’t fit the ORM’s built-in assumptions.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.445.1" xmlns="http://www.w3.org/1999/xhtml">There’s a fine line between a bad database design </span><span id="dx1-128009"/><span class="koboSpan" id="kobo.446.1" xmlns="http://www.w3.org/1999/xhtml">and a confusing database design. </span><span class="koboSpan" id="kobo.446.2" xmlns="http://www.w3.org/1999/xhtml">A bad design has quirky features that </span><span id="dx1-128010"/><span class="koboSpan" id="kobo.447.1" xmlns="http://www.w3.org/1999/xhtml">cannot be successfully described through an ORM layer. </span><span class="koboSpan" id="kobo.447.2" xmlns="http://www.w3.org/1999/xhtml">A confusing design can be described, but it may require using “advanced” features of the ORM package. </span><span class="koboSpan" id="kobo.447.3" xmlns="http://www.w3.org/1999/xhtml">In many cases, building the ORM mapping requires learning enough about the ORM’s capabilities to see the difference between bad and confusing.</span></p>
<p><span class="koboSpan" id="kobo.448.1" xmlns="http://www.w3.org/1999/xhtml">In many cases, a relational schema may involve a vast number of interrelated tables, sometimes from a wide variety of subject areas. </span><span class="koboSpan" id="kobo.448.2" xmlns="http://www.w3.org/1999/xhtml">For example, there may be products and a product catalog, sales records for products, and inventory information about products. </span><span class="koboSpan" id="kobo.448.3" xmlns="http://www.w3.org/1999/xhtml">What is the proper boundary for a “product” class? </span><span class="koboSpan" id="kobo.448.4" xmlns="http://www.w3.org/1999/xhtml">Should it include everything in the database related to a product? </span><span class="koboSpan" id="kobo.448.5" xmlns="http://www.w3.org/1999/xhtml">Or should it be limited by some bounded context or problem domain?</span></p>
<p><span class="koboSpan" id="kobo.449.1" xmlns="http://www.w3.org/1999/xhtml">Considerations of existing databases should lead to extensive conversations with users on the problem domain and context. </span><span class="koboSpan" id="kobo.449.2" xmlns="http://www.w3.org/1999/xhtml">It also leads to further conversations with the owners of the applications creating the data. </span><span class="koboSpan" id="kobo.449.3" xmlns="http://www.w3.org/1999/xhtml">All of the conversations are aimed at understanding how a user’s concept </span><span id="dx1-128011"/><span class="koboSpan" id="kobo.450.1" xmlns="http://www.w3.org/1999/xhtml">may overlap with </span><span id="dx1-128012"/><span class="koboSpan" id="kobo.451.1" xmlns="http://www.w3.org/1999/xhtml">existing data sources.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-80">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.452.1" xmlns="http://www.w3.org/1999/xhtml">Acquiring data from relational databases can be a challenge.</span></p>
<p><span class="koboSpan" id="kobo.453.1" xmlns="http://www.w3.org/1999/xhtml">The relational normalization will lead to complications. </span><span class="koboSpan" id="kobo.453.2" xmlns="http://www.w3.org/1999/xhtml">The presence of overlapping contexts can lead to further complications.</span></p>
<p><span class="koboSpan" id="kobo.454.1" xmlns="http://www.w3.org/1999/xhtml">What seems to be helpful is providing a clear translation from the technical world of the database to the kinds of information and decisions users want to make.</span></p>
</div>
</div>
<p><span id="x1-128013r140"/></p>
</section>
<section class="level3" data-number="9.2.3" id="about-the-source-data-3">
<h3 data-number="9.2.3"><span class="titlemark"><span class="koboSpan" id="kobo.455.1" xmlns="http://www.w3.org/1999/xhtml">5.2.3 </span></span> <span id="x1-1290003"/><span class="koboSpan" id="kobo.456.1" xmlns="http://www.w3.org/1999/xhtml">About the source data</span></h3>
<p><span class="koboSpan" id="kobo.457.1" xmlns="http://www.w3.org/1999/xhtml">See </span><a href="#5.2"><em><span class="koboSpan" id="kobo.458.1" xmlns="http://www.w3.org/1999/xhtml">Figure 5.2</span></em></a><span class="koboSpan" id="kobo.459.1" xmlns="http://www.w3.org/1999/xhtml"> for an ERD that shows </span><span id="dx1-129001"/><span class="koboSpan" id="kobo.460.1" xmlns="http://www.w3.org/1999/xhtml">the two tables that provide the desired entities:</span></p>
<figure class="IMG---Figure">
<span class="koboSpan" id="kobo.461.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 5.2: The Database Schema " src="../media/file27.jpg"/></span>
<figcaption class="IMG---Caption"><span class="id" id="5.2"><span class="koboSpan" id="kobo.462.1" xmlns="http://www.w3.org/1999/xhtml">Figure 5.2: </span></span><span class="content"><span class="koboSpan" id="kobo.463.1" xmlns="http://www.w3.org/1999/xhtml">The Database Schema </span></span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.464.1" xmlns="http://www.w3.org/1999/xhtml">In the design shown above, two tables decompose instances of the </span><code><span class="koboSpan" id="kobo.465.1" xmlns="http://www.w3.org/1999/xhtml">Series</span></code><span class="koboSpan" id="kobo.466.1" xmlns="http://www.w3.org/1999/xhtml"> class. </span><span class="koboSpan" id="kobo.466.2" xmlns="http://www.w3.org/1999/xhtml">Here are the Python class definitions:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-81">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.467.1" xmlns="http://www.w3.org/1999/xhtml">from dataclasses import dataclass

@dataclass
class SeriesSample:
    x: str
    y: str

@dataclass
class Series:
    name: str
    samples: list[SeriesSample]</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.468.1" xmlns="http://www.w3.org/1999/xhtml">The idea here is that a collection of </span><code><span class="koboSpan" id="kobo.469.1" xmlns="http://www.w3.org/1999/xhtml">SeriesSample</span></code><span class="koboSpan" id="kobo.470.1" xmlns="http://www.w3.org/1999/xhtml"> objects are part of a single composite </span><code><span class="koboSpan" id="kobo.471.1" xmlns="http://www.w3.org/1999/xhtml">Series</span></code><span class="koboSpan" id="kobo.472.1" xmlns="http://www.w3.org/1999/xhtml"> object. </span><span class="koboSpan" id="kobo.472.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.473.1" xmlns="http://www.w3.org/1999/xhtml">SeriesSample</span></code><span class="koboSpan" id="kobo.474.1" xmlns="http://www.w3.org/1999/xhtml"> objects, separated from the containing </span><code><span class="koboSpan" id="kobo.475.1" xmlns="http://www.w3.org/1999/xhtml">Series</span></code><span class="koboSpan" id="kobo.476.1" xmlns="http://www.w3.org/1999/xhtml">, aren’t useful in isolation. </span><span class="koboSpan" id="kobo.476.2" xmlns="http://www.w3.org/1999/xhtml">A number of </span><code><span class="koboSpan" id="kobo.477.1" xmlns="http://www.w3.org/1999/xhtml">SeriesSample</span></code><span class="koboSpan" id="kobo.478.1" xmlns="http://www.w3.org/1999/xhtml"> instances depend on a </span><code><span class="koboSpan" id="kobo.479.1" xmlns="http://www.w3.org/1999/xhtml">Series</span></code><span class="koboSpan" id="kobo.480.1" xmlns="http://www.w3.org/1999/xhtml"> object.</span></p>
<p><span class="koboSpan" id="kobo.481.1" xmlns="http://www.w3.org/1999/xhtml">There are three general </span><span id="dx1-129015"/><span class="koboSpan" id="kobo.482.1" xmlns="http://www.w3.org/1999/xhtml">approaches to retrieving information from a normalized collection of tables:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.483.1" xmlns="http://www.w3.org/1999/xhtml">A single SQL query. </span><span class="koboSpan" id="kobo.483.2" xmlns="http://www.w3.org/1999/xhtml">This forces the database server to </span><strong><span class="koboSpan" id="kobo.484.1" xmlns="http://www.w3.org/1999/xhtml">join </span></strong><span class="koboSpan" id="kobo.485.1" xmlns="http://www.w3.org/1999/xhtml">rows from multiple tables, providing a single result set.</span></p></li>
<li><p><span class="koboSpan" id="kobo.486.1" xmlns="http://www.w3.org/1999/xhtml">A series of queries to extract data from separate tables and then do lookups using Python dictionaries.</span></p></li>
<li><p><span class="koboSpan" id="kobo.487.1" xmlns="http://www.w3.org/1999/xhtml">Nested SQL queries. </span><span class="koboSpan" id="kobo.487.2" xmlns="http://www.w3.org/1999/xhtml">These use simpler SQL but can make for a large number of database requests.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.488.1" xmlns="http://www.w3.org/1999/xhtml">Neither alternative is a perfect solution in all cases. </span><span class="koboSpan" id="kobo.488.2" xmlns="http://www.w3.org/1999/xhtml">Many database designers will insist that database join operations are magically the fastest. </span><span class="koboSpan" id="kobo.488.3" xmlns="http://www.w3.org/1999/xhtml">Some actual timing information suggests that Python dictionary lookups can be much faster. </span><span class="koboSpan" id="kobo.488.4" xmlns="http://www.w3.org/1999/xhtml">Numerous factors impact query performance and the prudent design is to implement alternatives and compare performance.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-82">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.489.1" xmlns="http://www.w3.org/1999/xhtml">The number of factors influencing performance is large. </span><span class="koboSpan" id="kobo.489.2" xmlns="http://www.w3.org/1999/xhtml">No simple “best practice” exists. </span><span class="koboSpan" id="kobo.489.3" xmlns="http://www.w3.org/1999/xhtml">Only actual measurements can help to make a design decision.</span></p>
</div>
</div>
<p><span class="koboSpan" id="kobo.490.1" xmlns="http://www.w3.org/1999/xhtml">The join query to retrieve the data might look this:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-83">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.491.1" xmlns="http://www.w3.org/1999/xhtml">SELECT s.name, sv.x, sv.y
  FROM series s JOIN series_sample sv ON s.series_id = sv.series_id</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.492.1" xmlns="http://www.w3.org/1999/xhtml">Each distinct value of </span><code><span class="koboSpan" id="kobo.493.1" xmlns="http://www.w3.org/1999/xhtml">s.name</span></code><span class="koboSpan" id="kobo.494.1" xmlns="http://www.w3.org/1999/xhtml"> will lead to the creation of a distinct </span><code><span class="koboSpan" id="kobo.495.1" xmlns="http://www.w3.org/1999/xhtml">Series</span></code><span class="koboSpan" id="kobo.496.1" xmlns="http://www.w3.org/1999/xhtml"> object. </span><span class="koboSpan" id="kobo.496.2" xmlns="http://www.w3.org/1999/xhtml">Each row of </span><code><span class="koboSpan" id="kobo.497.1" xmlns="http://www.w3.org/1999/xhtml">sv.x</span></code><span class="koboSpan" id="kobo.498.1" xmlns="http://www.w3.org/1999/xhtml">, and </span><code><span class="koboSpan" id="kobo.499.1" xmlns="http://www.w3.org/1999/xhtml">sv.y</span></code><span class="koboSpan" id="kobo.500.1" xmlns="http://www.w3.org/1999/xhtml"> values becomes a </span><code><span class="koboSpan" id="kobo.501.1" xmlns="http://www.w3.org/1999/xhtml">SeriesSample</span></code><span class="koboSpan" id="kobo.502.1" xmlns="http://www.w3.org/1999/xhtml"> instance within the </span><code><span class="koboSpan" id="kobo.503.1" xmlns="http://www.w3.org/1999/xhtml">Series</span></code><span class="koboSpan" id="kobo.504.1" xmlns="http://www.w3.org/1999/xhtml"> object.</span></p>
<p><span class="koboSpan" id="kobo.505.1" xmlns="http://www.w3.org/1999/xhtml">Building objects with two separate </span><code><span class="koboSpan" id="kobo.506.1" xmlns="http://www.w3.org/1999/xhtml">SELECT</span></code><span class="koboSpan" id="kobo.507.1" xmlns="http://www.w3.org/1999/xhtml"> statements involves two simpler queries. </span><span class="koboSpan" id="kobo.507.2" xmlns="http://www.w3.org/1999/xhtml">Here’s the “outer loop” query to get the individual series:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-84">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.508.1" xmlns="http://www.w3.org/1999/xhtml">SELECT s.name, s.series_id
  FROM series s</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.509.1" xmlns="http://www.w3.org/1999/xhtml">Here’s the “inner loop” query to get rows from a specific series:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-85">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.510.1" xmlns="http://www.w3.org/1999/xhtml">SELECT sv.x, sv.y
  FROM series_sample sv
  WHERE sv.series_id = :series_id
  ORDER BY sv.sequence</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.511.1" xmlns="http://www.w3.org/1999/xhtml">The second </span><code><span class="koboSpan" id="kobo.512.1" xmlns="http://www.w3.org/1999/xhtml">SELECT</span></code><span class="koboSpan" id="kobo.513.1" xmlns="http://www.w3.org/1999/xhtml"> statement has a placeholder that depends on the results of the first query. </span><span class="koboSpan" id="kobo.513.2" xmlns="http://www.w3.org/1999/xhtml">The application must </span><span id="dx1-129024"/><span class="koboSpan" id="kobo.514.1" xmlns="http://www.w3.org/1999/xhtml">provide this parameter when making a nested request for a series-specific subset of rows from the </span><code><span class="koboSpan" id="kobo.515.1" xmlns="http://www.w3.org/1999/xhtml">series_sample</span></code><span class="koboSpan" id="kobo.516.1" xmlns="http://www.w3.org/1999/xhtml"> table.</span></p>
<p><span class="koboSpan" id="kobo.517.1" xmlns="http://www.w3.org/1999/xhtml">It’s also important to note the output is expected to be pure text, which will be saved in ND JSON files. </span><span class="koboSpan" id="kobo.517.2" xmlns="http://www.w3.org/1999/xhtml">This means the sophisticated structure of the SQL database will be erased.</span></p>
<p><span class="koboSpan" id="kobo.518.1" xmlns="http://www.w3.org/1999/xhtml">This will also make the interim results consistent with CSV files and HTML pages, where the data is only text. </span><span class="koboSpan" id="kobo.518.2" xmlns="http://www.w3.org/1999/xhtml">The output should be similar to the output from the CSV extract in </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.519.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.520.1" xmlns="http://www.w3.org/1999/xhtml"> 3</span></em></a><span class="koboSpan" id="kobo.521.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.522.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.1: Data Acquisition Base</span></em> <em><span class="koboSpan" id="kobo.523.1" xmlns="http://www.w3.org/1999/xhtml">Application</span></em></a><span class="koboSpan" id="kobo.524.1" xmlns="http://www.w3.org/1999/xhtml">: a file of small JSON documents that have the keys </span><code><span class="koboSpan" id="kobo.525.1" xmlns="http://www.w3.org/1999/xhtml">"x"</span></code><span class="koboSpan" id="kobo.526.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.527.1" xmlns="http://www.w3.org/1999/xhtml">"y"</span></code><span class="koboSpan" id="kobo.528.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.528.2" xmlns="http://www.w3.org/1999/xhtml">The goal is to strip away structure that may have been imposed by the data persistence mechanism — a SQL database for this project. </span><span class="koboSpan" id="kobo.528.3" xmlns="http://www.w3.org/1999/xhtml">The data is reduced into a common base of text.</span></p>
<p><span class="koboSpan" id="kobo.529.1" xmlns="http://www.w3.org/1999/xhtml">In the next section, we’ll look more closely at the technical approach to acquiring data from a SQL database. </span><span id="x1-129025r141"/></p>
</section>
<section class="level3" data-number="9.2.4" id="approach-4">
<h3 data-number="9.2.4"><span class="titlemark"><span class="koboSpan" id="kobo.530.1" xmlns="http://www.w3.org/1999/xhtml">5.2.4 </span></span> <span id="x1-1300004"/><span class="koboSpan" id="kobo.531.1" xmlns="http://www.w3.org/1999/xhtml">Approach</span></h3>
<p><span class="koboSpan" id="kobo.532.1" xmlns="http://www.w3.org/1999/xhtml">We’ll take some guidance from the C4 model ( </span><a class="url" href="https://c4model.com"><span class="koboSpan" id="kobo.533.1" xmlns="http://www.w3.org/1999/xhtml">https://c4model.com</span></a><span class="koboSpan" id="kobo.534.1" xmlns="http://www.w3.org/1999/xhtml">) when looking at our approach.</span></p>
<ul>
<li><p><strong><span class="koboSpan" id="kobo.535.1" xmlns="http://www.w3.org/1999/xhtml">Context</span></strong><span class="koboSpan" id="kobo.536.1" xmlns="http://www.w3.org/1999/xhtml">: For this project, a context diagram would show a user extracting data from a source. </span><span class="koboSpan" id="kobo.536.2" xmlns="http://www.w3.org/1999/xhtml">The reader may find it helpful to draw this diagram.</span></p></li>
<li><p><strong><span class="koboSpan" id="kobo.537.1" xmlns="http://www.w3.org/1999/xhtml">Containers</span></strong><span class="koboSpan" id="kobo.538.1" xmlns="http://www.w3.org/1999/xhtml">: One container is the user’s personal computer. </span><span class="koboSpan" id="kobo.538.2" xmlns="http://www.w3.org/1999/xhtml">The other container is the database server, which is running on the same computer.</span></p></li>
<li><p><strong><span class="koboSpan" id="kobo.539.1" xmlns="http://www.w3.org/1999/xhtml">Components</span></strong><span class="koboSpan" id="kobo.540.1" xmlns="http://www.w3.org/1999/xhtml">: We’ll address the components below.</span></p></li>
<li><p><strong><span class="koboSpan" id="kobo.541.1" xmlns="http://www.w3.org/1999/xhtml">Code</span></strong><span class="koboSpan" id="kobo.542.1" xmlns="http://www.w3.org/1999/xhtml">: We’ll touch on this to provide some suggested directions.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.543.1" xmlns="http://www.w3.org/1999/xhtml">This project adds a new </span><code><span class="koboSpan" id="kobo.544.1" xmlns="http://www.w3.org/1999/xhtml">db_client</span></code><span class="koboSpan" id="kobo.545.1" xmlns="http://www.w3.org/1999/xhtml"> module to extract the data from a database. </span><span class="koboSpan" id="kobo.545.2" xmlns="http://www.w3.org/1999/xhtml">The overall application in the </span><code><span class="koboSpan" id="kobo.546.1" xmlns="http://www.w3.org/1999/xhtml">acquire</span></code><span class="koboSpan" id="kobo.547.1" xmlns="http://www.w3.org/1999/xhtml"> module will </span><span id="dx1-130001"/><span class="koboSpan" id="kobo.548.1" xmlns="http://www.w3.org/1999/xhtml">change to make use of this new module. </span><span class="koboSpan" id="kobo.548.2" xmlns="http://www.w3.org/1999/xhtml">The other modules — for the most part — will remain unchanged.</span></p>
<p><span class="koboSpan" id="kobo.549.1" xmlns="http://www.w3.org/1999/xhtml">The component diagram in </span><a href="#5.3"><em><span class="koboSpan" id="kobo.550.1" xmlns="http://www.w3.org/1999/xhtml">Figure 5.3</span></em></a><span class="koboSpan" id="kobo.551.1" xmlns="http://www.w3.org/1999/xhtml"> shows an approach to this project.</span></p>
<figure class="IMG---Figure">
<span class="koboSpan" id="kobo.552.1" xmlns="http://www.w3.org/1999/xhtml"><img alt="Figure 5.3: Component Diagram " src="../media/file28.jpg"/></span>
<figcaption class="IMG---Caption"><span class="id" id="5.3"><span class="koboSpan" id="kobo.553.1" xmlns="http://www.w3.org/1999/xhtml">Figure 5.3: </span></span><span class="content"><span class="koboSpan" id="kobo.554.1" xmlns="http://www.w3.org/1999/xhtml">Component Diagram </span></span></figcaption>
</figure>
<p><span class="koboSpan" id="kobo.555.1" xmlns="http://www.w3.org/1999/xhtml">This diagram shows a revision to the underlying </span><code><span class="koboSpan" id="kobo.556.1" xmlns="http://www.w3.org/1999/xhtml">model</span></code><span class="koboSpan" id="kobo.557.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.557.2" xmlns="http://www.w3.org/1999/xhtml">This diagram extends the </span><code><span class="koboSpan" id="kobo.558.1" xmlns="http://www.w3.org/1999/xhtml">model</span></code><span class="koboSpan" id="kobo.559.1" xmlns="http://www.w3.org/1999/xhtml"> module to make the distinction between the composite series object and the individual samples within the overall series. </span><span class="koboSpan" id="kobo.559.2" xmlns="http://www.w3.org/1999/xhtml">It also renames the old </span><code><span class="koboSpan" id="kobo.560.1" xmlns="http://www.w3.org/1999/xhtml">XYPair</span></code><span class="koboSpan" id="kobo.561.1" xmlns="http://www.w3.org/1999/xhtml"> class to a more informative </span><code><span class="koboSpan" id="kobo.562.1" xmlns="http://www.w3.org/1999/xhtml">SeriesSample</span></code><span class="koboSpan" id="kobo.563.1" xmlns="http://www.w3.org/1999/xhtml"> class.</span></p>
<p><span class="koboSpan" id="kobo.564.1" xmlns="http://www.w3.org/1999/xhtml">This distinction between series has been an implicit part of the project in the previous chapters. </span><span class="koboSpan" id="kobo.564.2" xmlns="http://www.w3.org/1999/xhtml">At this point, it seems potentially helpful to distinguish a collection of samples from an individual sample.</span></p>
<p><span class="koboSpan" id="kobo.565.1" xmlns="http://www.w3.org/1999/xhtml">Some readers may object to renaming a </span><span id="dx1-130004"/><span class="koboSpan" id="kobo.566.1" xmlns="http://www.w3.org/1999/xhtml">class partway through a series of closely related projects. </span><span class="koboSpan" id="kobo.566.2" xmlns="http://www.w3.org/1999/xhtml">This kind of change is — in the author’s experience — very common. </span><span class="koboSpan" id="kobo.566.3" xmlns="http://www.w3.org/1999/xhtml">We start with an understanding that evolves and grows the more we work the problem domain, the users, and the technology. </span><span class="koboSpan" id="kobo.566.4" xmlns="http://www.w3.org/1999/xhtml">It’s very difficult to pick a great name for a concept. </span><span class="koboSpan" id="kobo.566.5" xmlns="http://www.w3.org/1999/xhtml">It’s more prudent to fix names as we learn.</span></p>
<p><span class="koboSpan" id="kobo.567.1" xmlns="http://www.w3.org/1999/xhtml">The new module will make use of two SQL queries to perform the extract. </span><span class="koboSpan" id="kobo.567.2" xmlns="http://www.w3.org/1999/xhtml">We’ll look at these nested requests in the next section.</span></p>
<section class="level4 likesubsubsectionHead" data-number="9.2.4.1" id="extract-from-a-sql-db">
<h4 class="likesubsubsectionHead" data-number="9.2.4.1"><span id="x1-1310004"/><span class="koboSpan" id="kobo.568.1" xmlns="http://www.w3.org/1999/xhtml">Extract from a SQL DB</span></h4>
<p><span class="koboSpan" id="kobo.569.1" xmlns="http://www.w3.org/1999/xhtml">The extraction from the database constructs a series of two parts. </span><span class="koboSpan" id="kobo.569.2" xmlns="http://www.w3.org/1999/xhtml">The first part is to get the attributes of the </span><code><span class="koboSpan" id="kobo.570.1" xmlns="http://www.w3.org/1999/xhtml">Series</span></code><span class="koboSpan" id="kobo.571.1" xmlns="http://www.w3.org/1999/xhtml"> class. </span><span class="koboSpan" id="kobo.571.2" xmlns="http://www.w3.org/1999/xhtml">The second part is to </span><span id="dx1-131001"/><span class="koboSpan" id="kobo.572.1" xmlns="http://www.w3.org/1999/xhtml">get each of the individual </span><code><span class="koboSpan" id="kobo.573.1" xmlns="http://www.w3.org/1999/xhtml">SeriesSample</span></code><span class="koboSpan" id="kobo.574.1" xmlns="http://www.w3.org/1999/xhtml"> instances.</span></p>
<p><span class="koboSpan" id="kobo.575.1" xmlns="http://www.w3.org/1999/xhtml">Here’s the overview of a potential class design:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-86">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.576.1" xmlns="http://www.w3.org/1999/xhtml">import model
import sqlite3
from typing import Any
from collections.abc import Iterator

class Extract:
    def build_samples(
            self,
            connection: sqlite3.Connection,
            config: dict[str, Any],
            name: str
    ) -&gt; model.Series:
        ...

    </span><span class="koboSpan" id="kobo.576.2" xmlns="http://www.w3.org/1999/xhtml">def series_iter(
            self,
            connection: sqlite3.Connection,
            config: dict[str, Any]
    ) -&gt; Iterator[model.Series]:
        ...</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.577.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.578.1" xmlns="http://www.w3.org/1999/xhtml">series_iter()</span></code><span class="koboSpan" id="kobo.579.1" xmlns="http://www.w3.org/1999/xhtml"> method iterates over the </span><code><span class="koboSpan" id="kobo.580.1" xmlns="http://www.w3.org/1999/xhtml">Series</span></code><span class="koboSpan" id="kobo.581.1" xmlns="http://www.w3.org/1999/xhtml"> instances that can be created from the database. </span><span class="koboSpan" id="kobo.581.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.582.1" xmlns="http://www.w3.org/1999/xhtml">build_samples()</span></code><span class="koboSpan" id="kobo.583.1" xmlns="http://www.w3.org/1999/xhtml"> method creates </span><span id="dx1-131022"/><span class="koboSpan" id="kobo.584.1" xmlns="http://www.w3.org/1999/xhtml">the individual samples that belong to a series.</span></p>
<p><span class="koboSpan" id="kobo.585.1" xmlns="http://www.w3.org/1999/xhtml">Here’s a first draft of an implementation of the </span><code><span class="koboSpan" id="kobo.586.1" xmlns="http://www.w3.org/1999/xhtml">build_samples()</span></code><span class="koboSpan" id="kobo.587.1" xmlns="http://www.w3.org/1999/xhtml"> method:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-87">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.588.1" xmlns="http://www.w3.org/1999/xhtml">def build_samples(
        self,
        connection: sqlite3.Connection,
        config: dict[str, Any],
        name: str
) -&gt; list[model.SeriesSample]:
    samples_cursor = connection.execute(
        config[’query’][’samples’],
        {"name": name}
    )
    samples = [
        model.SeriesSample(
            x=row[0],
            y=row[1])
        for row in samples_cursor
    ]
    return samples</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.589.1" xmlns="http://www.w3.org/1999/xhtml">This method will extract the collection of samples for a series given the name. </span><span class="koboSpan" id="kobo.589.2" xmlns="http://www.w3.org/1999/xhtml">It relies on the SQL query in the </span><code><span class="koboSpan" id="kobo.590.1" xmlns="http://www.w3.org/1999/xhtml">config</span></code><span class="koboSpan" id="kobo.591.1" xmlns="http://www.w3.org/1999/xhtml"> object. </span><span class="koboSpan" id="kobo.591.2" xmlns="http://www.w3.org/1999/xhtml">The list of </span><span id="dx1-131040"/><span class="koboSpan" id="kobo.592.1" xmlns="http://www.w3.org/1999/xhtml">samples is built from the results of the query using a list comprehension.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-88">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.593.1" xmlns="http://www.w3.org/1999/xhtml">This first draft implementation has a dependency on the </span><code><span class="koboSpan" id="kobo.594.1" xmlns="http://www.w3.org/1999/xhtml">SeriesSample</span></code><span class="koboSpan" id="kobo.595.1" xmlns="http://www.w3.org/1999/xhtml"> class name. </span><span class="koboSpan" id="kobo.595.2" xmlns="http://www.w3.org/1999/xhtml">This is another SOLID design issue, similar to the one in </span><a href="ch007.xhtml#x1-620001"><em><span class="koboSpan" id="kobo.596.1" xmlns="http://www.w3.org/1999/xhtml">Class design</span></em></a><span class="koboSpan" id="kobo.597.1" xmlns="http://www.w3.org/1999/xhtml"> of </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.598.1" xmlns="http://www.w3.org/1999/xhtml">Chapter</span></em><em><span class="koboSpan" id="kobo.599.1" xmlns="http://www.w3.org/1999/xhtml"> 3</span></em></a><span class="koboSpan" id="kobo.600.1" xmlns="http://www.w3.org/1999/xhtml">, </span><a href="ch007.xhtml#x1-560003"><em><span class="koboSpan" id="kobo.601.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.1: Data</span></em> <em><span class="koboSpan" id="kobo.602.1" xmlns="http://www.w3.org/1999/xhtml">Acquisition Base Application</span></em></a><span class="koboSpan" id="kobo.603.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.604.1" xmlns="http://www.w3.org/1999/xhtml">A better implementation would replace this direct dependency with a dependency that can be injected at runtime, permitting better isolation for unit testing.</span></p>
</div>
</div>
<p><span class="koboSpan" id="kobo.605.1" xmlns="http://www.w3.org/1999/xhtml">Here’s an implementation of the </span><code><span class="koboSpan" id="kobo.606.1" xmlns="http://www.w3.org/1999/xhtml">series_iter()</span></code><span class="koboSpan" id="kobo.607.1" xmlns="http://www.w3.org/1999/xhtml"> method:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-89">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.608.1" xmlns="http://www.w3.org/1999/xhtml">def series_iter(
        self,
        connection: sqlite3.Connection,
        config: dict[str, Any]
) -&gt; Iterator[model.Series]:
    print(config[’query’][’names’])
    names_cursor = connection.execute(config[’query’][’names’])
    for row in names_cursor:
        name=row[0]
        yield model.Series(
            name=name,
            samples=self.build_samples(connection, config, name)
        )</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.609.1" xmlns="http://www.w3.org/1999/xhtml">This method will extract each of the series from the database. </span><span class="koboSpan" id="kobo.609.2" xmlns="http://www.w3.org/1999/xhtml">It, too, gets the SQL statements from a configuration object, </span><code><span class="koboSpan" id="kobo.610.1" xmlns="http://www.w3.org/1999/xhtml">config</span></code><span class="koboSpan" id="kobo.611.1" xmlns="http://www.w3.org/1999/xhtml">. </span><span class="koboSpan" id="kobo.611.2" xmlns="http://www.w3.org/1999/xhtml">A configuration object is a dictionary of dictionaries. </span><span class="koboSpan" id="kobo.611.3" xmlns="http://www.w3.org/1999/xhtml">This structure is common for TOML files.</span></p>
<p><span class="koboSpan" id="kobo.612.1" xmlns="http://www.w3.org/1999/xhtml">The idea is to have a configuration </span><span id="dx1-131054"/><span class="koboSpan" id="kobo.613.1" xmlns="http://www.w3.org/1999/xhtml">file in TOML notation that looks like this:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-90">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.614.1" xmlns="http://www.w3.org/1999/xhtml">[query]
summary =  """
SELECT s.name, COUNT(*)
  FROM series s JOIN series_sample sv ON s.series_id = sv.series_id
  GROUP BY s.series_id
"""

detail =  """
SELECT s.name, s.series_id, sv.sequence, sv.x, sv.y
  FROM series s JOIN series_value sv ON s.series_id = sv.series_id
"""

names = """
SELECT s.name FROM series s
"""

samples = """
SELECT sv.x, sv.y
  FROM series_sample sv JOIN series s ON s.series_id = sv.series_id
  WHERE s.name = :name
  ORDER BY sv.sequence
"""</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.615.1" xmlns="http://www.w3.org/1999/xhtml">This configuration has a </span><code><span class="koboSpan" id="kobo.616.1" xmlns="http://www.w3.org/1999/xhtml">[query]</span></code><span class="koboSpan" id="kobo.617.1" xmlns="http://www.w3.org/1999/xhtml"> section, with several individual SQL statements used to query the database. </span><span class="koboSpan" id="kobo.617.2" xmlns="http://www.w3.org/1999/xhtml">Because the SQL statements are often quite large, triple quotes are used to delimit them.</span></p>
<p><span class="koboSpan" id="kobo.618.1" xmlns="http://www.w3.org/1999/xhtml">In cases where the SQL statements are very large, it’s can seem helpful to put them in separate files. </span><span class="koboSpan" id="kobo.618.2" xmlns="http://www.w3.org/1999/xhtml">This leads to a more complicated configuration with a number of files, each with a separate SQL statement.</span></p>
<p><span class="koboSpan" id="kobo.619.1" xmlns="http://www.w3.org/1999/xhtml">Before we look at the deliverables, we’ll talk a bit </span><span id="dx1-131077"/><span class="koboSpan" id="kobo.620.1" xmlns="http://www.w3.org/1999/xhtml">about why this data acquisition application is different from the previous projects.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="9.2.4.2" id="sql-related-processing-distinct-from-csv-processing">
<h4 class="likesubsubsectionHead" data-number="9.2.4.2"><span id="x1-1320004"/><span class="koboSpan" id="kobo.621.1" xmlns="http://www.w3.org/1999/xhtml">SQL-related processing distinct from CSV processing</span></h4>
<p><span class="koboSpan" id="kobo.622.1" xmlns="http://www.w3.org/1999/xhtml">It’s helpful to note some important distinctions between working with CSV data and working with SQL data.</span></p>
<p><span class="koboSpan" id="kobo.623.1" xmlns="http://www.w3.org/1999/xhtml">First, CSV data is always text. </span><span class="koboSpan" id="kobo.623.2" xmlns="http://www.w3.org/1999/xhtml">When working with a SQL database, the underlying data often has a data type that maps </span><span id="dx1-132001"/><span class="koboSpan" id="kobo.624.1" xmlns="http://www.w3.org/1999/xhtml">pleasantly to a native Python type. </span><span class="koboSpan" id="kobo.624.2" xmlns="http://www.w3.org/1999/xhtml">SQL databases often have a few numeric types, including integers and floating-point numbers. </span><span class="koboSpan" id="kobo.624.3" xmlns="http://www.w3.org/1999/xhtml">Some databases will handle decimal values that map to Python’s </span><code><span class="koboSpan" id="kobo.625.1" xmlns="http://www.w3.org/1999/xhtml">decimal.Decimal</span></code><span class="koboSpan" id="kobo.626.1" xmlns="http://www.w3.org/1999/xhtml"> class; this isn’t a universal capability, and some databases force the application to convert between </span><code><span class="koboSpan" id="kobo.627.1" xmlns="http://www.w3.org/1999/xhtml">decimal.Decimal</span></code><span class="koboSpan" id="kobo.628.1" xmlns="http://www.w3.org/1999/xhtml"> and text to avoid the truncation problems inherent with floating-point values.</span></p>
<p><span class="koboSpan" id="kobo.629.1" xmlns="http://www.w3.org/1999/xhtml">The second important distinction is the tempo of change. </span><span class="koboSpan" id="kobo.629.2" xmlns="http://www.w3.org/1999/xhtml">A SQL database schema tends to change slowly, and change often involves a review of the impact of the change. </span><span class="koboSpan" id="kobo.629.3" xmlns="http://www.w3.org/1999/xhtml">In some cases, CSV files are built by interactive spreadsheet software, and manual operations are used to create and save the data. </span><span class="koboSpan" id="kobo.629.4" xmlns="http://www.w3.org/1999/xhtml">Unsurprisingly, the interactive use of spreadsheets leads to small changes and inconsistencies over short periods of time. </span><span class="koboSpan" id="kobo.629.5" xmlns="http://www.w3.org/1999/xhtml">While some CSV files are produced by highly automated tools, there may be less scrutiny applied to the order or names of columns.</span></p>
<p><span class="koboSpan" id="kobo.630.1" xmlns="http://www.w3.org/1999/xhtml">A third important distinction relates to the design of spreadsheets contrasted with the design of a database. </span><span class="koboSpan" id="kobo.630.2" xmlns="http://www.w3.org/1999/xhtml">A relational database is often highly normalized; this is an attempt to avoid redundancy. </span><span class="koboSpan" id="kobo.630.3" xmlns="http://www.w3.org/1999/xhtml">Rather than repeat a group of related values, an entity is assigned to a separate table with a primary key. </span><span class="koboSpan" id="kobo.630.4" xmlns="http://www.w3.org/1999/xhtml">References to the group of values via the primary key are used to avoid repetition of the values themselves. </span><span class="koboSpan" id="kobo.630.5" xmlns="http://www.w3.org/1999/xhtml">It’s less common to apply normalization rules to a spreadsheet.</span></p>
<p><span class="koboSpan" id="kobo.631.1" xmlns="http://www.w3.org/1999/xhtml">Because spreadsheet data may not be fully normalized, extracting meaningful data from a spreadsheet often becomes a rather complicated problem. </span><span class="koboSpan" id="kobo.631.2" xmlns="http://www.w3.org/1999/xhtml">This can be exacerbated when spreadsheets are tweaked manually or the design of the spreadsheet changes suddenly. </span><span class="koboSpan" id="kobo.631.3" xmlns="http://www.w3.org/1999/xhtml">To reflect this, the designs in this book suggest using a hierarchy of classes — or collection of related functions — to build a useful Python object from a spreadsheet row. </span><span class="koboSpan" id="kobo.631.4" xmlns="http://www.w3.org/1999/xhtml">It is often necessary to keep a large pool of builders available to handle variant spreadsheet data as part of historical analysis.</span></p>
<p><span class="koboSpan" id="kobo.632.1" xmlns="http://www.w3.org/1999/xhtml">The designs shown earlier had a </span><code><span class="koboSpan" id="kobo.633.1" xmlns="http://www.w3.org/1999/xhtml">PairBuilder</span></code><span class="koboSpan" id="kobo.634.1" xmlns="http://www.w3.org/1999/xhtml"> subclass to create individual sample objects. </span><span class="koboSpan" id="kobo.634.2" xmlns="http://www.w3.org/1999/xhtml">These designs used an </span><code><span class="koboSpan" id="kobo.635.1" xmlns="http://www.w3.org/1999/xhtml">Extract</span></code><span class="koboSpan" id="kobo.636.1" xmlns="http://www.w3.org/1999/xhtml"> class to manage the overall construction of samples from the source file. </span><span class="koboSpan" id="kobo.636.2" xmlns="http://www.w3.org/1999/xhtml">This provided flexibility to handle spreadsheet data.</span></p>
<p><span class="koboSpan" id="kobo.637.1" xmlns="http://www.w3.org/1999/xhtml">A database extract is somewhat </span><span id="dx1-132002"/><span class="koboSpan" id="kobo.638.1" xmlns="http://www.w3.org/1999/xhtml">less likely to need a flexible hierarchy of objects to create useful Python objects. </span><span class="koboSpan" id="kobo.638.2" xmlns="http://www.w3.org/1999/xhtml">Instead, the needed flexibility is often implemented by changing SQL statements to reflect schema changes or a deeper understanding of the available data. </span><span class="koboSpan" id="kobo.638.3" xmlns="http://www.w3.org/1999/xhtml">For this reason, we encourage the use of a TOML-format file to keep the SQL statements, permitting some changes without having to add more subclasses to the Python application. </span><span class="koboSpan" id="kobo.638.4" xmlns="http://www.w3.org/1999/xhtml">The TOML-format configuration files can have version numbers in the file name (and in the comments) to make it clear which database schema they are designed against.</span></p>
<p><span class="koboSpan" id="kobo.639.1" xmlns="http://www.w3.org/1999/xhtml">Now that we have a design approach, it’s important to make sure we have a list of deliverables that serve as a definition of “Done.” </span><span id="x1-132003r143"/></p>
</section>
</section>
<section class="level3" data-number="9.2.5" id="deliverables-5">
<h3 data-number="9.2.5"><span class="titlemark"><span class="koboSpan" id="kobo.640.1" xmlns="http://www.w3.org/1999/xhtml">5.2.5 </span></span> <span id="x1-1330005"/><span class="koboSpan" id="kobo.641.1" xmlns="http://www.w3.org/1999/xhtml">Deliverables</span></h3>
<p><span class="koboSpan" id="kobo.642.1" xmlns="http://www.w3.org/1999/xhtml">This project has </span><span id="dx1-133001"/><span class="koboSpan" id="kobo.643.1" xmlns="http://www.w3.org/1999/xhtml">the following deliverables:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.644.1" xmlns="http://www.w3.org/1999/xhtml">Documentation in the </span><code><span class="koboSpan" id="kobo.645.1" xmlns="http://www.w3.org/1999/xhtml">docs</span></code><span class="koboSpan" id="kobo.646.1" xmlns="http://www.w3.org/1999/xhtml"> folder.</span></p></li>
<li><p><span class="koboSpan" id="kobo.647.1" xmlns="http://www.w3.org/1999/xhtml">Acceptance tests in the </span><code><span class="koboSpan" id="kobo.648.1" xmlns="http://www.w3.org/1999/xhtml">tests/features</span></code><span class="koboSpan" id="kobo.649.1" xmlns="http://www.w3.org/1999/xhtml"> and </span><code><span class="koboSpan" id="kobo.650.1" xmlns="http://www.w3.org/1999/xhtml">tests/steps</span></code><span class="koboSpan" id="kobo.651.1" xmlns="http://www.w3.org/1999/xhtml"> folders.</span></p></li>
<li><p><span class="koboSpan" id="kobo.652.1" xmlns="http://www.w3.org/1999/xhtml">The acceptance tests will involve creating and destroying example databases as test fixtures.</span></p></li>
<li><p><span class="koboSpan" id="kobo.653.1" xmlns="http://www.w3.org/1999/xhtml">Unit tests for application modules in the </span><code><span class="koboSpan" id="kobo.654.1" xmlns="http://www.w3.org/1999/xhtml">tests</span></code><span class="koboSpan" id="kobo.655.1" xmlns="http://www.w3.org/1999/xhtml"> folder.</span></p></li>
<li><p><span class="koboSpan" id="kobo.656.1" xmlns="http://www.w3.org/1999/xhtml">Mock objects for the database connection will be part of the unit tests.</span></p></li>
<li><p><span class="koboSpan" id="kobo.657.1" xmlns="http://www.w3.org/1999/xhtml">Application to acquire data from a SQL database.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.658.1" xmlns="http://www.w3.org/1999/xhtml">We’ll look at a few of these deliverables in a little more detail.</span></p>
<section class="level4 likesubsubsectionHead" data-number="9.2.5.1" id="mock-database-connection-and-cursor-objects-for-testing">
<h4 class="likesubsubsectionHead" data-number="9.2.5.1"><span id="x1-1340005"/><span class="koboSpan" id="kobo.659.1" xmlns="http://www.w3.org/1999/xhtml">Mock database connection and cursor objects for testing</span></h4>
<p><span class="koboSpan" id="kobo.660.1" xmlns="http://www.w3.org/1999/xhtml">For the data acquisition application, it’s essential to provide a mock connection object to expose the SQL and the parameters </span><span id="dx1-134001"/><span class="koboSpan" id="kobo.661.1" xmlns="http://www.w3.org/1999/xhtml">that are being provided to the database. </span><span class="koboSpan" id="kobo.661.2" xmlns="http://www.w3.org/1999/xhtml">This mock object can also provide a mock cursor as a query result.</span></p>
<p><span class="koboSpan" id="kobo.662.1" xmlns="http://www.w3.org/1999/xhtml">As noted earlier in </span><a href="#x1-1250003"><em><span class="koboSpan" id="kobo.663.1" xmlns="http://www.w3.org/1999/xhtml">Deliverables</span></em></a><span class="koboSpan" id="kobo.664.1" xmlns="http://www.w3.org/1999/xhtml">, this means the </span><span id="dx1-134002"/><span class="koboSpan" id="kobo.665.1" xmlns="http://www.w3.org/1999/xhtml">connection object should be created only in the </span><code><span class="koboSpan" id="kobo.666.1" xmlns="http://www.w3.org/1999/xhtml">main()</span></code><span class="koboSpan" id="kobo.667.1" xmlns="http://www.w3.org/1999/xhtml"> function. </span><span class="koboSpan" id="kobo.667.2" xmlns="http://www.w3.org/1999/xhtml">It also means the connection object should be a parameter to any other functions or methods that perform database operations. </span><span class="koboSpan" id="kobo.667.3" xmlns="http://www.w3.org/1999/xhtml">If the connection object is referenced consistently, it becomes easier to test by providing a mock connection object.</span></p>
<p><span class="koboSpan" id="kobo.668.1" xmlns="http://www.w3.org/1999/xhtml">We’ll look at this in two parts: first, the conceptual Given and When steps; after that, we’ll look at the Then steps. </span><span class="koboSpan" id="kobo.668.2" xmlns="http://www.w3.org/1999/xhtml">This is sometimes called “arrange-act-assert”. </span><span class="koboSpan" id="kobo.668.3" xmlns="http://www.w3.org/1999/xhtml">Here’s the start of the </span><strong><span class="koboSpan" id="kobo.669.1" xmlns="http://www.w3.org/1999/xhtml">PyTest </span></strong><span class="koboSpan" id="kobo.670.1" xmlns="http://www.w3.org/1999/xhtml">test case:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-91">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.671.1" xmlns="http://www.w3.org/1999/xhtml">import sqlite3
from typing import Any, cast
from unittest.mock import Mock, call, sentinel
from pytest import fixture
import db_extract
import model

def test_build_sample(
        mock_connection: sqlite3.Connection,
        mock_config: dict[str, Any]
):
    extract = db_extract.Extract()
    results = list(
        extract.series_iter(mock_connection, mock_config)
    )</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.672.1" xmlns="http://www.w3.org/1999/xhtml">The assertions confirm the results come from the mock objects without being transformed, dropped, or corrupted by some error in the code under test. </span><span class="koboSpan" id="kobo.672.2" xmlns="http://www.w3.org/1999/xhtml">The assertions look like this example:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-92">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.673.1" xmlns="http://www.w3.org/1999/xhtml">    assert results == [
        model.Series(
            name=sentinel.Name,
            samples=[
               model.SeriesSample(sentinel.X, sentinel.Y)
            ]
        )
    ]
    assert cast(Mock, mock_connection).execute.mock_calls == [
        call(sentinel.Names_Query),
        call(sentinel.Samples_Query, {’name’: sentinel.Name})
    ]</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.674.1" xmlns="http://www.w3.org/1999/xhtml">A mock connection object must </span><span id="dx1-134030"/><span class="koboSpan" id="kobo.675.1" xmlns="http://www.w3.org/1999/xhtml">provide results with </span><span id="dx1-134031"/><span class="koboSpan" id="kobo.676.1" xmlns="http://www.w3.org/1999/xhtml">sentinel objects that have the proper structure to look like the iterable </span><code><span class="koboSpan" id="kobo.677.1" xmlns="http://www.w3.org/1999/xhtml">Cursor</span></code><span class="koboSpan" id="kobo.678.1" xmlns="http://www.w3.org/1999/xhtml"> object that is returned by SQLite3 when executing a database query.</span></p>
<p><span class="koboSpan" id="kobo.679.1" xmlns="http://www.w3.org/1999/xhtml">The mock connection seems rather complicated because it involves two separate mock cursors and a mock connection. </span><span class="koboSpan" id="kobo.679.2" xmlns="http://www.w3.org/1999/xhtml">Here’s some typical code for a mock connection:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-93">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.680.1" xmlns="http://www.w3.org/1999/xhtml">@fixture
def mock_connection() -&gt; sqlite3.Connection:
    names_cursor: list[tuple[Any, ...]] = [
        (sentinel.Name,)
    ]
    samples_cursor: list[tuple[Any, ...]]  = [
        (sentinel.X, sentinel.Y)
    ]
    query_to_cursor: dict[sentinel, list[tuple[Any, ...]]] = {
        sentinel.Names_Query: names_cursor,
        sentinel.Samples_Query: samples_cursor
    }

    connection = Mock(
        execute=Mock(
            side_effect=lambda query, param=None: query_to_cursor[query]
        )
    )
    return cast(sqlite3.Connection, connection)</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.681.1" xmlns="http://www.w3.org/1999/xhtml">The mocked cursors are provided as simple lists. </span><span class="koboSpan" id="kobo.681.2" xmlns="http://www.w3.org/1999/xhtml">If the code under test used other features of a cursor, a more elaborate </span><code><span class="koboSpan" id="kobo.682.1" xmlns="http://www.w3.org/1999/xhtml">Mock</span></code><span class="koboSpan" id="kobo.683.1" xmlns="http://www.w3.org/1999/xhtml"> object would be required. </span><span class="koboSpan" id="kobo.683.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.684.1" xmlns="http://www.w3.org/1999/xhtml">query_to_cursor</span></code><span class="koboSpan" id="kobo.685.1" xmlns="http://www.w3.org/1999/xhtml"> mapping associates a result with a particular query. </span><span class="koboSpan" id="kobo.685.2" xmlns="http://www.w3.org/1999/xhtml">The idea here is the queries will be </span><code><span class="koboSpan" id="kobo.686.1" xmlns="http://www.w3.org/1999/xhtml">sentinel</span></code><span class="koboSpan" id="kobo.687.1" xmlns="http://www.w3.org/1999/xhtml"> objects, not long SQL strings.</span></p>
<p><span class="koboSpan" id="kobo.688.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.689.1" xmlns="http://www.w3.org/1999/xhtml">connection</span></code><span class="koboSpan" id="kobo.690.1" xmlns="http://www.w3.org/1999/xhtml"> object uses the side-effect feature of </span><code><span class="koboSpan" id="kobo.691.1" xmlns="http://www.w3.org/1999/xhtml">Mock</span></code><span class="koboSpan" id="kobo.692.1" xmlns="http://www.w3.org/1999/xhtml"> objects. </span><span class="koboSpan" id="kobo.692.2" xmlns="http://www.w3.org/1999/xhtml">When the </span><code><span class="koboSpan" id="kobo.693.1" xmlns="http://www.w3.org/1999/xhtml">execute()</span></code><span class="koboSpan" id="kobo.694.1" xmlns="http://www.w3.org/1999/xhtml"> method is evaluated, the call is recorded, and the result </span><span id="dx1-134051"/><span class="koboSpan" id="kobo.695.1" xmlns="http://www.w3.org/1999/xhtml">comes from the side-effect function. </span><span class="koboSpan" id="kobo.695.2" xmlns="http://www.w3.org/1999/xhtml">In this case, it’s a lambda </span><span id="dx1-134052"/><span class="koboSpan" id="kobo.696.1" xmlns="http://www.w3.org/1999/xhtml">object that uses the </span><code><span class="koboSpan" id="kobo.697.1" xmlns="http://www.w3.org/1999/xhtml">query_to_cursor</span></code><span class="koboSpan" id="kobo.698.1" xmlns="http://www.w3.org/1999/xhtml"> mapping to locate an appropriate cursor result.</span></p>
<p><span class="koboSpan" id="kobo.699.1" xmlns="http://www.w3.org/1999/xhtml">This use of the side-effect feature avoids making too many assumptions about the internal workings of the unit under test. </span><span class="koboSpan" id="kobo.699.2" xmlns="http://www.w3.org/1999/xhtml">The SQL will be a </span><code><span class="koboSpan" id="kobo.700.1" xmlns="http://www.w3.org/1999/xhtml">sentinel</span></code><span class="koboSpan" id="kobo.701.1" xmlns="http://www.w3.org/1999/xhtml"> object and the results will contain </span><code><span class="koboSpan" id="kobo.702.1" xmlns="http://www.w3.org/1999/xhtml">sentinel</span></code><span class="koboSpan" id="kobo.703.1" xmlns="http://www.w3.org/1999/xhtml"> objects.</span></p>
<p><span class="koboSpan" id="kobo.704.1" xmlns="http://www.w3.org/1999/xhtml">In this case, we’re insisting the unit under test does no additional processing on the values retrieved from the database. </span><span class="koboSpan" id="kobo.704.2" xmlns="http://www.w3.org/1999/xhtml">In other applications, where additional processing is being done, more sophisticated mock objects or test literals may be required.</span></p>
<p><span class="koboSpan" id="kobo.705.1" xmlns="http://www.w3.org/1999/xhtml">It’s not unusual to use something like </span><code><span class="koboSpan" id="kobo.706.1" xmlns="http://www.w3.org/1999/xhtml">(11,</span></code><code><span class="koboSpan" id="kobo.707.1" xmlns="http://www.w3.org/1999/xhtml"> 13)</span></code><span class="koboSpan" id="kobo.708.1" xmlns="http://www.w3.org/1999/xhtml"> instead of </span><code><span class="koboSpan" id="kobo.709.1" xmlns="http://www.w3.org/1999/xhtml">(sentinel.X,</span></code><code><span class="koboSpan" id="kobo.710.1" xmlns="http://www.w3.org/1999/xhtml"> sentinel.Y)</span></code><span class="koboSpan" id="kobo.711.1" xmlns="http://www.w3.org/1999/xhtml"> to check that a computation is being performed correctly. </span><span class="koboSpan" id="kobo.711.2" xmlns="http://www.w3.org/1999/xhtml">However, it’s more desirable to isolate the computations performed on SQL results into separate functions. </span><span class="koboSpan" id="kobo.711.3" xmlns="http://www.w3.org/1999/xhtml">This allows testing these functions as separate units. </span><span class="koboSpan" id="kobo.711.4" xmlns="http://www.w3.org/1999/xhtml">The SQL retrieval processing can be tested using mock functions for these additional computations.</span></p>
<p><span class="koboSpan" id="kobo.712.1" xmlns="http://www.w3.org/1999/xhtml">Also, note the use of the </span><code><span class="koboSpan" id="kobo.713.1" xmlns="http://www.w3.org/1999/xhtml">cast()</span></code><span class="koboSpan" id="kobo.714.1" xmlns="http://www.w3.org/1999/xhtml"> function from the </span><code><span class="koboSpan" id="kobo.715.1" xmlns="http://www.w3.org/1999/xhtml">typing</span></code><span class="koboSpan" id="kobo.716.1" xmlns="http://www.w3.org/1999/xhtml"> module to tell tools like </span><strong><span class="koboSpan" id="kobo.717.1" xmlns="http://www.w3.org/1999/xhtml">mypy </span></strong><span class="koboSpan" id="kobo.718.1" xmlns="http://www.w3.org/1999/xhtml">this object can be used like a </span><code><span class="koboSpan" id="kobo.719.1" xmlns="http://www.w3.org/1999/xhtml">Connection</span></code><span class="koboSpan" id="kobo.720.1" xmlns="http://www.w3.org/1999/xhtml"> object.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="9.2.5.2" id="unit-test-for-a-new-acquisition-module">
<h4 class="likesubsubsectionHead" data-number="9.2.5.2"><span id="x1-1350005"/><span class="koboSpan" id="kobo.721.1" xmlns="http://www.w3.org/1999/xhtml">Unit test for a new acquisition module</span></h4>
<p><span class="koboSpan" id="kobo.722.1" xmlns="http://www.w3.org/1999/xhtml">Throughout this sequence of chapters, the overall </span><code><span class="koboSpan" id="kobo.723.1" xmlns="http://www.w3.org/1999/xhtml">acquisition</span></code><span class="koboSpan" id="kobo.724.1" xmlns="http://www.w3.org/1999/xhtml"> module has grown more flexible. </span><span class="koboSpan" id="kobo.724.2" xmlns="http://www.w3.org/1999/xhtml">The idea is to permit a wide variety of data sources for an analysis project.</span></p>
<p><span class="koboSpan" id="kobo.725.1" xmlns="http://www.w3.org/1999/xhtml">Pragmatically, it is more likely to </span><span id="dx1-135001"/><span class="koboSpan" id="kobo.726.1" xmlns="http://www.w3.org/1999/xhtml">modify an application to work with a number of distinct CSV formats, or a number of distinct database schemas. </span><span class="koboSpan" id="kobo.726.2" xmlns="http://www.w3.org/1999/xhtml">When a RESTful API changes, it’s often a good strategy to introduce new classes for the changed API as an alternatives to existing classes. </span><span class="koboSpan" id="kobo.726.3" xmlns="http://www.w3.org/1999/xhtml">Simply modifying or replacing the old definition — in a way — erases useful history on why and how an API is expected to work. </span><span class="koboSpan" id="kobo.726.4" xmlns="http://www.w3.org/1999/xhtml">This is the Open/Closed principle from the SOLID design principles: the design is open to extension but closed to modification.</span></p>
<p><span class="koboSpan" id="kobo.727.1" xmlns="http://www.w3.org/1999/xhtml">Acquiring data from a wide variety of data sources — as shown in these projects — is less likely than variations in a single source. </span><span class="koboSpan" id="kobo.727.2" xmlns="http://www.w3.org/1999/xhtml">As an enterprise moves from spreadsheets to central databases and APIs, then the analytical tools should follow the data sources.</span></p>
<p><span class="koboSpan" id="kobo.728.1" xmlns="http://www.w3.org/1999/xhtml">The need for flexible data acquisition drives the need to write unit tests for the acquisition module to both cover the expected cases and cover the potential domain of errors and mistakes in use.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="9.2.5.3" id="acceptance-tests-using-a-sqlite-database">
<h4 class="likesubsubsectionHead" data-number="9.2.5.3"><span id="x1-1360005"/><span class="koboSpan" id="kobo.729.1" xmlns="http://www.w3.org/1999/xhtml">Acceptance tests using a SQLite database</span></h4>
<p><span class="koboSpan" id="kobo.730.1" xmlns="http://www.w3.org/1999/xhtml">The acceptance tests need to create (and destroy) a test database. </span><span class="koboSpan" id="kobo.730.2" xmlns="http://www.w3.org/1999/xhtml">The tests often need to create, retrieve, update, and delete </span><span id="dx1-136001"/><span class="koboSpan" id="kobo.731.1" xmlns="http://www.w3.org/1999/xhtml">data in the test database to arrange data for the given step or assert the results in the Then step.</span></p>
<p><span class="koboSpan" id="kobo.732.1" xmlns="http://www.w3.org/1999/xhtml">In the context of this book, we started with the </span><a href="#x1-1150001"><em><span class="koboSpan" id="kobo.733.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.4: A local SQL database</span></em></a><span class="koboSpan" id="kobo.734.1" xmlns="http://www.w3.org/1999/xhtml"> project to build a test database. </span><span class="koboSpan" id="kobo.734.2" xmlns="http://www.w3.org/1999/xhtml">There aren’t many readily accessible, public, relational databases with extractable data. </span><span class="koboSpan" id="kobo.734.3" xmlns="http://www.w3.org/1999/xhtml">In most cases, these databases are wrapped with a RESTful API.</span></p>
<p><span class="koboSpan" id="kobo.735.1" xmlns="http://www.w3.org/1999/xhtml">The database built in the previous project has two opposing use cases:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.736.1" xmlns="http://www.w3.org/1999/xhtml">It is for test purposes and can be deleted and rebuilt freely.</span></p></li>
<li><p><span class="koboSpan" id="kobo.737.1" xmlns="http://www.w3.org/1999/xhtml">This database must be treated as if it’s precious enterprise data, and should not be deleted or updated.</span></p></li>
</ul>
<div class="tcolorbox tipbox" id="tcolobox-94">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.738.1" xmlns="http://www.w3.org/1999/xhtml">When we think of the database created in </span><a href="#x1-1150001"><em><span class="koboSpan" id="kobo.739.1" xmlns="http://www.w3.org/1999/xhtml">Project 1.4: A local SQL</span></em> <em><span class="koboSpan" id="kobo.740.1" xmlns="http://www.w3.org/1999/xhtml">database</span></em></a><span class="koboSpan" id="kobo.741.1" xmlns="http://www.w3.org/1999/xhtml"> as if it were production data, we need to protect it from unexpected changes.</span></p>
<p><span class="koboSpan" id="kobo.742.1" xmlns="http://www.w3.org/1999/xhtml">This means our acceptance tests must build a separate, small, test database, separate from the “production” database created by the previous project.</span></p>
<p><span class="koboSpan" id="kobo.743.1" xmlns="http://www.w3.org/1999/xhtml">The test database must not collide with precious enterprise data.</span></p>
</div>
</div>
<p><span class="koboSpan" id="kobo.744.1" xmlns="http://www.w3.org/1999/xhtml">There are two common strategies to </span><span id="dx1-136002"/><span class="koboSpan" id="kobo.745.1" xmlns="http://www.w3.org/1999/xhtml">avoid collisions between test databases and enterprise databases:</span></p>
<ol>
<li><div id="x1-136004x1">
<p><span class="koboSpan" id="kobo.746.1" xmlns="http://www.w3.org/1999/xhtml">Use OS-level security in the file system to make it difficult to damage the files that comprise a shared database. </span><span class="koboSpan" id="kobo.746.2" xmlns="http://www.w3.org/1999/xhtml">Also, using strict naming conventions can put a test database into a separate namespace that won’t collide with production databases.</span></p>
</div></li>
<li><div id="x1-136006x2">
<p><span class="koboSpan" id="kobo.747.1" xmlns="http://www.w3.org/1999/xhtml">Run the tests in a </span><strong><span class="koboSpan" id="kobo.748.1" xmlns="http://www.w3.org/1999/xhtml">Docker container </span></strong><span class="koboSpan" id="kobo.749.1" xmlns="http://www.w3.org/1999/xhtml">to create a </span><span id="dx1-136007"/><span class="koboSpan" id="kobo.750.1" xmlns="http://www.w3.org/1999/xhtml">virtual environment in which production data cannot be touched.</span></p>
</div></li>
</ol>
<p><span class="koboSpan" id="kobo.751.1" xmlns="http://www.w3.org/1999/xhtml">As we noted above in </span><a href="#x1-1300004"><em><span class="koboSpan" id="kobo.752.1" xmlns="http://www.w3.org/1999/xhtml">Approach</span></em></a><span class="koboSpan" id="kobo.753.1" xmlns="http://www.w3.org/1999/xhtml">, the idea behind a database involves two containers:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.754.1" xmlns="http://www.w3.org/1999/xhtml">A container for the application components that extract the data.</span></p></li>
<li><p><span class="koboSpan" id="kobo.755.1" xmlns="http://www.w3.org/1999/xhtml">A container for the database components that provide the data. </span><span class="koboSpan" id="kobo.755.2" xmlns="http://www.w3.org/1999/xhtml">An acceptance test can create an ephemeral database service.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.756.1" xmlns="http://www.w3.org/1999/xhtml">With SQLite, however, there is no distinct database service container. </span><span class="koboSpan" id="kobo.756.2" xmlns="http://www.w3.org/1999/xhtml">The database components become part of the application’s components and run in the application’s container. </span><span class="koboSpan" id="kobo.756.3" xmlns="http://www.w3.org/1999/xhtml">The lack of a separate service container means SQLite breaks the conceptual two-container model that applies to large, enterprise databases. </span><span class="koboSpan" id="kobo.756.4" xmlns="http://www.w3.org/1999/xhtml">We can’t create a temporary, mock database </span><strong><span class="koboSpan" id="kobo.757.1" xmlns="http://www.w3.org/1999/xhtml">service </span></strong><span class="koboSpan" id="kobo.758.1" xmlns="http://www.w3.org/1999/xhtml">for testing purposes.</span></p>
<p><span class="koboSpan" id="kobo.759.1" xmlns="http://www.w3.org/1999/xhtml">Because the SQLite database is nothing more than a file, we must focus on OS-level permissions, file-system paths, and naming conventions to keep our test database separate from the production database created in an earlier project. </span><span class="koboSpan" id="kobo.759.2" xmlns="http://www.w3.org/1999/xhtml">We emphasize this because working with a more complicated database engine (like MySQL or PostgreSQL) will also involve the same consideration of permissions, file paths, and naming conventions. </span><span class="koboSpan" id="kobo.759.3" xmlns="http://www.w3.org/1999/xhtml">Larger databases will add more considerations, but the foundations will be similar.</span></p>
<div class="tcolorbox tipbox" id="tcolobox-95">
<div class="tcolorbox-content">
<p><span class="koboSpan" id="kobo.760.1" xmlns="http://www.w3.org/1999/xhtml">It’s imperative to avoid disrupting production operations while creating data analytic applications.</span></p>
</div>
</div>
<p><span class="koboSpan" id="kobo.761.1" xmlns="http://www.w3.org/1999/xhtml">Building and destroying a temporary SQLite database file suggests the use of a </span><code><span class="koboSpan" id="kobo.762.1" xmlns="http://www.w3.org/1999/xhtml">@fixture</span></code><span class="koboSpan" id="kobo.763.1" xmlns="http://www.w3.org/1999/xhtml"> to create a database and populate the </span><span id="dx1-136008"/><span class="koboSpan" id="kobo.764.1" xmlns="http://www.w3.org/1999/xhtml">needed schema of tables, views, indexes, etc. </span><span class="koboSpan" id="kobo.764.2" xmlns="http://www.w3.org/1999/xhtml">The Given steps of individual scenarios can provide a summary of the data arrangement required by the test.</span></p>
<p><span class="koboSpan" id="kobo.765.1" xmlns="http://www.w3.org/1999/xhtml">We’ll look at how to define this as a feature. </span><span class="koboSpan" id="kobo.765.2" xmlns="http://www.w3.org/1999/xhtml">Then, we can look at the steps required for the implementation of the fixture, and the step definitions.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="9.2.5.4" id="the-feature-file-1">
<h4 class="likesubsubsectionHead" data-number="9.2.5.4"><span id="x1-1370005"/><span class="koboSpan" id="kobo.766.1" xmlns="http://www.w3.org/1999/xhtml">The feature file</span></h4>
<p><span class="koboSpan" id="kobo.767.1" xmlns="http://www.w3.org/1999/xhtml">Here’s the kind of scenario that </span><span id="dx1-137001"/><span class="koboSpan" id="kobo.768.1" xmlns="http://www.w3.org/1999/xhtml">seems to capture the essence of a SQL extract application:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-96">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.769.1" xmlns="http://www.w3.org/1999/xhtml">@fixture.sqlite
Scenario: Extract data from the enterprise database

  Given a series named "test1"
  And sample values "[(11, 13), (17, 19)]"
  When we run the database extract command with the test fixture database
  Then log has INFO line with "series: test1"
  And log has INFO line with "count: 2"
  And output directory has file named "quartet/test1.csv"</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.770.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.771.1" xmlns="http://www.w3.org/1999/xhtml">@fixture.</span></code><span class="koboSpan" id="kobo.772.1" xmlns="http://www.w3.org/1999/xhtml"> tag follows the common naming convention for associating specific, reusable fixtures with scenarios. </span><span class="koboSpan" id="kobo.772.2" xmlns="http://www.w3.org/1999/xhtml">There are many other purposes for tagging scenarios in addition to specifying the fixture to use. </span><span class="koboSpan" id="kobo.772.3" xmlns="http://www.w3.org/1999/xhtml">In this case, the fixture information is used to build an SQLite database with an empty schema.</span></p>
<p><span class="koboSpan" id="kobo.773.1" xmlns="http://www.w3.org/1999/xhtml">The Given steps provide some </span><span id="dx1-137011"/><span class="koboSpan" id="kobo.774.1" xmlns="http://www.w3.org/1999/xhtml">data to load into the database. </span><span class="koboSpan" id="kobo.774.2" xmlns="http://www.w3.org/1999/xhtml">For this acceptance test, a single series with only a few samples is used.</span></p>
<p><span class="koboSpan" id="kobo.775.1" xmlns="http://www.w3.org/1999/xhtml">The tag information can be used by the </span><strong><span class="koboSpan" id="kobo.776.1" xmlns="http://www.w3.org/1999/xhtml">behave </span></strong><span class="koboSpan" id="kobo.777.1" xmlns="http://www.w3.org/1999/xhtml">tool. </span><span class="koboSpan" id="kobo.777.2" xmlns="http://www.w3.org/1999/xhtml">We’ll look at how to write a </span><code><span class="koboSpan" id="kobo.778.1" xmlns="http://www.w3.org/1999/xhtml">before_tag()</span></code><span class="koboSpan" id="kobo.779.1" xmlns="http://www.w3.org/1999/xhtml"> function to create (and destroy) the temporary database for any scenario that needs it.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="9.2.5.5" id="the-sqlite-fixture">
<h4 class="likesubsubsectionHead" data-number="9.2.5.5"><span id="x1-1380005"/><span class="koboSpan" id="kobo.780.1" xmlns="http://www.w3.org/1999/xhtml">The sqlite fixture</span></h4>
<p><span class="koboSpan" id="kobo.781.1" xmlns="http://www.w3.org/1999/xhtml">The fixture is generally defined in the </span><code><span class="koboSpan" id="kobo.782.1" xmlns="http://www.w3.org/1999/xhtml">environment.py</span></code><span class="koboSpan" id="kobo.783.1" xmlns="http://www.w3.org/1999/xhtml"> module that the </span><strong><span class="koboSpan" id="kobo.784.1" xmlns="http://www.w3.org/1999/xhtml">behave</span></strong><span class="koboSpan" id="kobo.785.1" xmlns="http://www.w3.org/1999/xhtml"> tool uses. </span><span class="koboSpan" id="kobo.785.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.786.1" xmlns="http://www.w3.org/1999/xhtml">before_tag()</span></code><span class="koboSpan" id="kobo.787.1" xmlns="http://www.w3.org/1999/xhtml"> function is used to </span><span id="dx1-138001"/><span class="koboSpan" id="kobo.788.1" xmlns="http://www.w3.org/1999/xhtml">process the tags for a feature or a scenario within a feature. </span><span class="koboSpan" id="kobo.788.2" xmlns="http://www.w3.org/1999/xhtml">This function lets us then associate a specific feature function with the scenario:</span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.789.1" xmlns="http://www.w3.org/1999/xhtml">from behave import fixture, use_fixture
from behave.runner import Context

def before_tag(context: Context, tag: str) -&gt; None:
    if tag == "fixture.sqlite":
        use_fixture(sqlite_database, context)</span></pre>
<p><span class="koboSpan" id="kobo.790.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.791.1" xmlns="http://www.w3.org/1999/xhtml">use_fixture()</span></code><span class="koboSpan" id="kobo.792.1" xmlns="http://www.w3.org/1999/xhtml"> function tells the </span><strong><span class="koboSpan" id="kobo.793.1" xmlns="http://www.w3.org/1999/xhtml">behave </span></strong><span class="koboSpan" id="kobo.794.1" xmlns="http://www.w3.org/1999/xhtml">runner to invoke the given function, </span><code><span class="koboSpan" id="kobo.795.1" xmlns="http://www.w3.org/1999/xhtml">sqlite_database()</span></code><span class="koboSpan" id="kobo.796.1" xmlns="http://www.w3.org/1999/xhtml">, with a given argument value – in this case, the </span><code><span class="koboSpan" id="kobo.797.1" xmlns="http://www.w3.org/1999/xhtml">context</span></code><span class="koboSpan" id="kobo.798.1" xmlns="http://www.w3.org/1999/xhtml"> object. </span><span class="koboSpan" id="kobo.798.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.799.1" xmlns="http://www.w3.org/1999/xhtml">sqlite_database()</span></code><span class="koboSpan" id="kobo.800.1" xmlns="http://www.w3.org/1999/xhtml"> function should be a generator: it can prepare the database, execute a </span><code><span class="koboSpan" id="kobo.801.1" xmlns="http://www.w3.org/1999/xhtml">yield</span></code><span class="koboSpan" id="kobo.802.1" xmlns="http://www.w3.org/1999/xhtml"> statement, and then destroy the database. </span><span class="koboSpan" id="kobo.802.2" xmlns="http://www.w3.org/1999/xhtml">The </span><strong><span class="koboSpan" id="kobo.803.1" xmlns="http://www.w3.org/1999/xhtml">behave </span></strong><span class="koboSpan" id="kobo.804.1" xmlns="http://www.w3.org/1999/xhtml">runner will consume the yielded value as part of setting up the test, and the consume one more value when it’s time to tear down the test.</span></p>
<p><span class="koboSpan" id="kobo.805.1" xmlns="http://www.w3.org/1999/xhtml">The function to create (and destroy) the database has the following outline:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-97">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.806.1" xmlns="http://www.w3.org/1999/xhtml">from collections.abc import Iterator
from pathlib import Path
import shutil
import sqlite3
from tempfile import mkdtemp
import tomllib

from behave import fixture, use_fixture
from behave.runner import Context

@fixture
def sqlite_database(context: Context) -&gt; Iterator[str]:
    # Setup: Build the database files (shown later).

    </span><span class="koboSpan" id="kobo.806.2" xmlns="http://www.w3.org/1999/xhtml">yield context.db_uri

    # Teardown: Delete the database files (shown later).</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.807.1" xmlns="http://www.w3.org/1999/xhtml">We’ve decomposed this function </span><span id="dx1-138025"/><span class="koboSpan" id="kobo.808.1" xmlns="http://www.w3.org/1999/xhtml">into three parts: the setup, the </span><code><span class="koboSpan" id="kobo.809.1" xmlns="http://www.w3.org/1999/xhtml">yield</span></code><span class="koboSpan" id="kobo.810.1" xmlns="http://www.w3.org/1999/xhtml"> to allow the test scenario to proceed, and the teardown. </span><span class="koboSpan" id="kobo.810.2" xmlns="http://www.w3.org/1999/xhtml">We’ll look at the </span><em><span class="koboSpan" id="kobo.811.1" xmlns="http://www.w3.org/1999/xhtml">Set up: Build</span></em> <em><span class="koboSpan" id="kobo.812.1" xmlns="http://www.w3.org/1999/xhtml">the database files </span></em><span class="koboSpan" id="kobo.813.1" xmlns="http://www.w3.org/1999/xhtml">and the </span><em><span class="koboSpan" id="kobo.814.1" xmlns="http://www.w3.org/1999/xhtml">Teardown: Delete the database files </span></em><span class="koboSpan" id="kobo.815.1" xmlns="http://www.w3.org/1999/xhtml">sections separately.</span></p>
<p><span class="koboSpan" id="kobo.816.1" xmlns="http://www.w3.org/1999/xhtml">The setup processing of the </span><code><span class="koboSpan" id="kobo.817.1" xmlns="http://www.w3.org/1999/xhtml">sqlite_database()</span></code><span class="koboSpan" id="kobo.818.1" xmlns="http://www.w3.org/1999/xhtml"> function is shown in the following snippet:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-98">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.819.1" xmlns="http://www.w3.org/1999/xhtml">    # Get Config with SQL to build schema.
    </span><span class="koboSpan" id="kobo.819.2" xmlns="http://www.w3.org/1999/xhtml">config_path = Path.cwd() / "schema.toml"
    with config_path.open() as config_file:
        config = tomllib.load(config_file)
        create_sql = config[’definition’][’create’]
        context.manipulation_sql = config[’manipulation’]
    # Build database file.
    </span><span class="koboSpan" id="kobo.819.3" xmlns="http://www.w3.org/1999/xhtml">context.working_path = Path(mkdtemp())
    context.db_path =  context.working_path / "test_example.db"
    context.db_uri = f"file:{context.db_path}"
    context.connection = sqlite3.connect(context.db_uri, uri=True)
    for stmt in create_sql:
        context.connection.execute(stmt)
    context.connection.commit()</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.820.1" xmlns="http://www.w3.org/1999/xhtml">The configuration file is read from the current working directory. </span><span class="koboSpan" id="kobo.820.2" xmlns="http://www.w3.org/1999/xhtml">The SQL statements to create the database and perform data manipulations are extracted from the schema. </span><span class="koboSpan" id="kobo.820.3" xmlns="http://www.w3.org/1999/xhtml">The database creation SQL will be executed </span><span id="dx1-138040"/><span class="koboSpan" id="kobo.821.1" xmlns="http://www.w3.org/1999/xhtml">during the tag discovery. </span><span class="koboSpan" id="kobo.821.2" xmlns="http://www.w3.org/1999/xhtml">The manipulation SQL will be put into the context for use by the Given steps executed later.</span></p>
<p><span class="koboSpan" id="kobo.822.1" xmlns="http://www.w3.org/1999/xhtml">Additionally, the context is loaded up with a working path, which will be used for the database file as well as the output files. </span><span class="koboSpan" id="kobo.822.2" xmlns="http://www.w3.org/1999/xhtml">The context will have a </span><code><span class="koboSpan" id="kobo.823.1" xmlns="http://www.w3.org/1999/xhtml">db_uri</span></code><span class="koboSpan" id="kobo.824.1" xmlns="http://www.w3.org/1999/xhtml"> string, which can be used by the data extract application to locate the test database.</span></p>
<p><span class="koboSpan" id="kobo.825.1" xmlns="http://www.w3.org/1999/xhtml">Once the context has been filled, the individual SQL statements can be executed to build the empty database.</span></p>
<p><span class="koboSpan" id="kobo.826.1" xmlns="http://www.w3.org/1999/xhtml">After the </span><code><span class="koboSpan" id="kobo.827.1" xmlns="http://www.w3.org/1999/xhtml">yield</span></code><span class="koboSpan" id="kobo.828.1" xmlns="http://www.w3.org/1999/xhtml"> statement, the teardown processing of the </span><code><span class="koboSpan" id="kobo.829.1" xmlns="http://www.w3.org/1999/xhtml">sqlite_database()</span></code><span class="koboSpan" id="kobo.830.1" xmlns="http://www.w3.org/1999/xhtml"> function is shown in the following snippet:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-99">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.831.1" xmlns="http://www.w3.org/1999/xhtml">    context.connection.close()
    shutil.rmtree(context.working_path)</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.832.1" xmlns="http://www.w3.org/1999/xhtml">The SQLite3 database must be closed before the files can be removed. </span><span class="koboSpan" id="kobo.832.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.833.1" xmlns="http://www.w3.org/1999/xhtml">shutil</span></code><span class="koboSpan" id="kobo.834.1" xmlns="http://www.w3.org/1999/xhtml"> package includes functions that work at a higher level on files and directories. </span><span class="koboSpan" id="kobo.834.2" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.835.1" xmlns="http://www.w3.org/1999/xhtml">rmtree()</span></code><span class="koboSpan" id="kobo.836.1" xmlns="http://www.w3.org/1999/xhtml"> function removes the entire directory tree and all of the files within the tree.</span></p>
<p><span class="koboSpan" id="kobo.837.1" xmlns="http://www.w3.org/1999/xhtml">This fixture creates a working database. </span><span class="koboSpan" id="kobo.837.2" xmlns="http://www.w3.org/1999/xhtml">We can now write step definitions that depend on this fixture.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="9.2.5.6" id="the-step-definitions">
<h4 class="likesubsubsectionHead" data-number="9.2.5.6"><span id="x1-1390005"/><span class="koboSpan" id="kobo.838.1" xmlns="http://www.w3.org/1999/xhtml">The step definitions</span></h4>
<p><span class="koboSpan" id="kobo.839.1" xmlns="http://www.w3.org/1999/xhtml">We’ll show two-step definitions to </span><span id="dx1-139001"/><span class="koboSpan" id="kobo.840.1" xmlns="http://www.w3.org/1999/xhtml">insert series and samples into the database. </span><span class="koboSpan" id="kobo.840.2" xmlns="http://www.w3.org/1999/xhtml">The following example shows the implementation of one of the </span><code><span class="koboSpan" id="kobo.841.1" xmlns="http://www.w3.org/1999/xhtml">Given</span></code><span class="koboSpan" id="kobo.842.1" xmlns="http://www.w3.org/1999/xhtml"> steps:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-100">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.843.1" xmlns="http://www.w3.org/1999/xhtml">@given(u’a series named "{name}"’)
def step_impl(context, name):
    insert_series = context.manipulation_sql[’insert_series’]
    cursor = context.connection.execute(
        insert_series,
        {’series_id’: 99, ’name’: name}
    )
    context.connection.commit()</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.844.1" xmlns="http://www.w3.org/1999/xhtml">The step definition shown above uses SQL to create a new row in the </span><code><span class="koboSpan" id="kobo.845.1" xmlns="http://www.w3.org/1999/xhtml">series</span></code><span class="koboSpan" id="kobo.846.1" xmlns="http://www.w3.org/1999/xhtml"> table. </span><span class="koboSpan" id="kobo.846.2" xmlns="http://www.w3.org/1999/xhtml">It uses the connection from the context; this was created by the </span><code><span class="koboSpan" id="kobo.847.1" xmlns="http://www.w3.org/1999/xhtml">sqlite_database()</span></code><span class="koboSpan" id="kobo.848.1" xmlns="http://www.w3.org/1999/xhtml"> function that was made part of the testing sequence by the </span><code><span class="koboSpan" id="kobo.849.1" xmlns="http://www.w3.org/1999/xhtml">before_tag()</span></code><span class="koboSpan" id="kobo.850.1" xmlns="http://www.w3.org/1999/xhtml"> function.</span></p>
<p><span class="koboSpan" id="kobo.851.1" xmlns="http://www.w3.org/1999/xhtml">The following example shows </span><span id="dx1-139010"/><span class="koboSpan" id="kobo.852.1" xmlns="http://www.w3.org/1999/xhtml">the implementation of the other </span><code><span class="koboSpan" id="kobo.853.1" xmlns="http://www.w3.org/1999/xhtml">Given</span></code><span class="koboSpan" id="kobo.854.1" xmlns="http://www.w3.org/1999/xhtml"> step:</span></p>
<div class="tcolorbox tcolorbox" id="tcolobox-101">
<div class="tcolorbox-content">
<pre class="source-code"><span class="koboSpan" id="kobo.855.1" xmlns="http://www.w3.org/1999/xhtml">@given(u’sample values "{list_of_pairs}"’)
def step_impl(context, list_of_pairs):
    pairs = literal_eval(list_of_pairs)
    insert_values = context.manipulation_sql[’insert_values’]
    for seq, row in enumerate(pairs):
        cursor = context.connection.execute(
            insert_values,
            {’series_id’: 99, ’sequence’: seq, ’x’: row[0], ’y’: row[1]}
        )
    context.connection.commit()</span></pre>
</div>
</div>
<p><span class="koboSpan" id="kobo.856.1" xmlns="http://www.w3.org/1999/xhtml">The step definition shown above uses SQL to create a new row in the </span><code><span class="koboSpan" id="kobo.857.1" xmlns="http://www.w3.org/1999/xhtml">series_sample</span></code><span class="koboSpan" id="kobo.858.1" xmlns="http://www.w3.org/1999/xhtml"> table. </span><span class="koboSpan" id="kobo.858.2" xmlns="http://www.w3.org/1999/xhtml">It uses the connection from the context, also.</span></p>
<p><span class="koboSpan" id="kobo.859.1" xmlns="http://www.w3.org/1999/xhtml">Once the series and samples have been inserted into the database, the </span><code><span class="koboSpan" id="kobo.860.1" xmlns="http://www.w3.org/1999/xhtml">When</span></code><span class="koboSpan" id="kobo.861.1" xmlns="http://www.w3.org/1999/xhtml"> step can run the data acquisition application using the database URI information from the context.</span></p>
<p><span class="koboSpan" id="kobo.862.1" xmlns="http://www.w3.org/1999/xhtml">The </span><code><span class="koboSpan" id="kobo.863.1" xmlns="http://www.w3.org/1999/xhtml">Then</span></code><span class="koboSpan" id="kobo.864.1" xmlns="http://www.w3.org/1999/xhtml"> steps can confirm the results from running the application match the database seeded by the fixture and the </span><code><span class="koboSpan" id="kobo.865.1" xmlns="http://www.w3.org/1999/xhtml">Given</span></code><span class="koboSpan" id="kobo.866.1" xmlns="http://www.w3.org/1999/xhtml"> steps.</span></p>
<p><span class="koboSpan" id="kobo.867.1" xmlns="http://www.w3.org/1999/xhtml">With this testing framework in place, you can run the acceptance test suite. </span><span class="koboSpan" id="kobo.867.2" xmlns="http://www.w3.org/1999/xhtml">It’s common to run the acceptance tests before making any of the programming changes; this reveals the </span><code><span class="koboSpan" id="kobo.868.1" xmlns="http://www.w3.org/1999/xhtml">acquire</span></code><span class="koboSpan" id="kobo.869.1" xmlns="http://www.w3.org/1999/xhtml"> application doesn’t pass all of the tests.</span></p>
<p><span class="koboSpan" id="kobo.870.1" xmlns="http://www.w3.org/1999/xhtml">In the next section, we’ll look at the database extract module and rewrite the main application.</span></p>
</section>
<section class="level4 likesubsubsectionHead" data-number="9.2.5.7" id="the-database-extract-module-and-refactoring">
<h4 class="likesubsubsectionHead" data-number="9.2.5.7"><span id="x1-1400005"/><span class="koboSpan" id="kobo.871.1" xmlns="http://www.w3.org/1999/xhtml">The Database extract module, and refactoring</span></h4>
<p><span class="koboSpan" id="kobo.872.1" xmlns="http://www.w3.org/1999/xhtml">This project suggests three kinds of changes to the code written for the previous projects:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.873.1" xmlns="http://www.w3.org/1999/xhtml">Revise the </span><code><span class="koboSpan" id="kobo.874.1" xmlns="http://www.w3.org/1999/xhtml">model</span></code><span class="koboSpan" id="kobo.875.1" xmlns="http://www.w3.org/1999/xhtml"> module to expand on what a “series” is: it’s a parent object with a name and a list of subsidiary objects.</span></p></li>
<li><p><span class="koboSpan" id="kobo.876.1" xmlns="http://www.w3.org/1999/xhtml">Add the </span><code><span class="koboSpan" id="kobo.877.1" xmlns="http://www.w3.org/1999/xhtml">db_extract</span></code><span class="koboSpan" id="kobo.878.1" xmlns="http://www.w3.org/1999/xhtml"> module to grab data from a SQL database.</span></p></li>
<li><p><span class="koboSpan" id="kobo.879.1" xmlns="http://www.w3.org/1999/xhtml">Update the </span><code><span class="koboSpan" id="kobo.880.1" xmlns="http://www.w3.org/1999/xhtml">acquire</span></code><span class="koboSpan" id="kobo.881.1" xmlns="http://www.w3.org/1999/xhtml"> module to gather data from any of the available sources and create CSV files.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.882.1" xmlns="http://www.w3.org/1999/xhtml">Refactoring the </span><code><span class="koboSpan" id="kobo.883.1" xmlns="http://www.w3.org/1999/xhtml">model</span></code><span class="koboSpan" id="kobo.884.1" xmlns="http://www.w3.org/1999/xhtml"> module has a ripple </span><span id="dx1-140001"/><span class="koboSpan" id="kobo.885.1" xmlns="http://www.w3.org/1999/xhtml">effect on other projects, requiring changes to those modules to alter the data structure names.</span></p>
<p><span class="koboSpan" id="kobo.886.1" xmlns="http://www.w3.org/1999/xhtml">As we noted in </span><a href="#x1-1300004"><em><span class="koboSpan" id="kobo.887.1" xmlns="http://www.w3.org/1999/xhtml">Approach</span></em></a><span class="koboSpan" id="kobo.888.1" xmlns="http://www.w3.org/1999/xhtml">, it’s common to start a </span><span id="dx1-140002"/><span class="koboSpan" id="kobo.889.1" xmlns="http://www.w3.org/1999/xhtml">project with an understanding that evolves and grows. </span><span class="koboSpan" id="kobo.889.2" xmlns="http://www.w3.org/1999/xhtml">More exposure to the problem domain, the users, and the technology shifts our understanding. </span><span class="koboSpan" id="kobo.889.3" xmlns="http://www.w3.org/1999/xhtml">This project reflects a shift in understanding and leads to a need to change the implementation of previously completed projects.</span></p>
<p><span class="koboSpan" id="kobo.890.1" xmlns="http://www.w3.org/1999/xhtml">One consequence of this is exposing the series’ name. </span><span class="koboSpan" id="kobo.890.2" xmlns="http://www.w3.org/1999/xhtml">In projects from previous chapters, the four series had names that were arbitrarily imposed by the application program. </span><span class="koboSpan" id="kobo.890.3" xmlns="http://www.w3.org/1999/xhtml">Perhaps a file name might have been </span><code><span class="koboSpan" id="kobo.891.1" xmlns="http://www.w3.org/1999/xhtml">"series_1.csv"</span></code><span class="koboSpan" id="kobo.892.1" xmlns="http://www.w3.org/1999/xhtml"> or something similar.</span></p>
<p><span class="koboSpan" id="kobo.893.1" xmlns="http://www.w3.org/1999/xhtml">Working with the SQL data exposed a new attribute, the name of a series. </span><span class="koboSpan" id="kobo.893.2" xmlns="http://www.w3.org/1999/xhtml">This leads to two profound choices for dealing with this new attribute:</span></p>
<ol>
<li><div id="x1-140004x1">
<p><span class="koboSpan" id="kobo.894.1" xmlns="http://www.w3.org/1999/xhtml">Ignore the new attribute.</span></p>
</div></li>
<li><div id="x1-140006x2">
<p><span class="koboSpan" id="kobo.895.1" xmlns="http://www.w3.org/1999/xhtml">Alter the previous projects to introduce a series name.</span></p>
</div></li>
</ol>
<p><span class="koboSpan" id="kobo.896.1" xmlns="http://www.w3.org/1999/xhtml">Should the series name be the file name? </span><span class="koboSpan" id="kobo.896.2" xmlns="http://www.w3.org/1999/xhtml">This seems to be a bad idea because the series name may have spaces or other awkward punctuation.</span></p>
<p><span class="koboSpan" id="kobo.897.1" xmlns="http://www.w3.org/1999/xhtml">It seems as though some additional metadata is required to preserve the series name and associate series names with file names. </span><span class="koboSpan" id="kobo.897.2" xmlns="http://www.w3.org/1999/xhtml">This would be an extra file, perhaps in JSON or TOML format, created as part of the extract operation. </span><span id="x1-140007r138"/></p>
</section>
</section>
</section>
<section class="level2" data-number="9.3" id="summary-4">
<h2 data-number="9.3"><span class="titlemark"><span class="koboSpan" id="kobo.898.1" xmlns="http://www.w3.org/1999/xhtml">5.3 </span></span> <span id="x1-1410003"/><span class="koboSpan" id="kobo.899.1" xmlns="http://www.w3.org/1999/xhtml">Summary</span></h2>
<p><span class="koboSpan" id="kobo.900.1" xmlns="http://www.w3.org/1999/xhtml">This chapter’s projects covered two following essential skills:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.901.1" xmlns="http://www.w3.org/1999/xhtml">Building SQL databases. </span><span class="koboSpan" id="kobo.901.2" xmlns="http://www.w3.org/1999/xhtml">This includes building a representative of a production database, as well as building a test database.</span></p></li>
<li><p><span class="koboSpan" id="kobo.902.1" xmlns="http://www.w3.org/1999/xhtml">Extracting data from SQL databases.</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.903.1" xmlns="http://www.w3.org/1999/xhtml">This requires learning some SQL, of course. </span><span class="koboSpan" id="kobo.903.2" xmlns="http://www.w3.org/1999/xhtml">SQL is sometimes called the </span><em><span class="koboSpan" id="kobo.904.1" xmlns="http://www.w3.org/1999/xhtml">lingua</span></em> <em><span class="koboSpan" id="kobo.905.1" xmlns="http://www.w3.org/1999/xhtml">franca </span></em><span class="koboSpan" id="kobo.906.1" xmlns="http://www.w3.org/1999/xhtml">of data processing. </span><span class="koboSpan" id="kobo.906.2" xmlns="http://www.w3.org/1999/xhtml">Many organizations have SQL databases, and the data must be extracted for analysis.</span></p>
<p><span class="koboSpan" id="kobo.907.1" xmlns="http://www.w3.org/1999/xhtml">Also important is learning to work in the presence of precious production data. </span><span class="koboSpan" id="kobo.907.2" xmlns="http://www.w3.org/1999/xhtml">It’s important to consider the naming conventions, file system paths, and permissions associated with database servers and the files in use. </span><span class="koboSpan" id="kobo.907.3" xmlns="http://www.w3.org/1999/xhtml">Attempting to extract analytic data is not a good reason for colliding with production operations.</span></p>
<p><span class="koboSpan" id="kobo.908.1" xmlns="http://www.w3.org/1999/xhtml">The effort required to write an acceptance test that uses an ephemeral database is an important additional skill. </span><span class="koboSpan" id="kobo.908.2" xmlns="http://www.w3.org/1999/xhtml">Being able to create databases for test purposes permits debugging by identifying problematic data, creating a test case around it, and then working in an isolated development environment. </span><span class="koboSpan" id="kobo.908.3" xmlns="http://www.w3.org/1999/xhtml">Further, having ephemeral databases permits examining changes to a production database that might facilitate analysis or resolve uncertainty in production data.</span></p>
<p><span class="koboSpan" id="kobo.909.1" xmlns="http://www.w3.org/1999/xhtml">In the next chapter, we’ll transition from the bulk acquisition of data to understanding the relative completeness and usefulness of the data. </span><span class="koboSpan" id="kobo.909.2" xmlns="http://www.w3.org/1999/xhtml">We’ll build some tools to inspect the raw data that we’ve acquired. </span><span id="x1-141001r155"/></p>
</section>
<section class="level2" data-number="9.4" id="extras-3">
<h2 data-number="9.4"><span class="titlemark"><span class="koboSpan" id="kobo.910.1" xmlns="http://www.w3.org/1999/xhtml">5.4 </span></span> <span id="x1-1420004"/><span class="koboSpan" id="kobo.911.1" xmlns="http://www.w3.org/1999/xhtml">Extras</span></h2>
<p><span class="koboSpan" id="kobo.912.1" xmlns="http://www.w3.org/1999/xhtml">Here are some ideas for the reader to add to this project. </span><span id="x1-142001r147"/></p>
<section class="level3" data-number="9.4.1" id="consider-using-another-database">
<h3 data-number="9.4.1"><span class="titlemark"><span class="koboSpan" id="kobo.913.1" xmlns="http://www.w3.org/1999/xhtml">5.4.1 </span></span> <span id="x1-1430001"/><span class="koboSpan" id="kobo.914.1" xmlns="http://www.w3.org/1999/xhtml">Consider using another database</span></h3>
<p><span class="koboSpan" id="kobo.915.1" xmlns="http://www.w3.org/1999/xhtml">For example, MySQL or PostgreSQL are good choices. </span><span class="koboSpan" id="kobo.915.2" xmlns="http://www.w3.org/1999/xhtml">These can be downloaded and installed on a personal computer for non-commercial purposes. </span><span class="koboSpan" id="kobo.915.3" xmlns="http://www.w3.org/1999/xhtml">The administrative overheads are not overly burdensome.</span></p>
<p><span class="koboSpan" id="kobo.916.1" xmlns="http://www.w3.org/1999/xhtml">It is essential to recognize these are rather large, complex tools. </span><span class="koboSpan" id="kobo.916.2" xmlns="http://www.w3.org/1999/xhtml">For readers new to SQL, there is a lot to learn when trying to install, configure, and use one of these databases.</span></p>
<p><span class="koboSpan" id="kobo.917.1" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://dev.mysql.com/doc/mysql-getting-started/en/"><span class="koboSpan" id="kobo.918.1" xmlns="http://www.w3.org/1999/xhtml">https://dev.mysql.com/doc/mysql-getting-started/en/</span></a><span class="koboSpan" id="kobo.919.1" xmlns="http://www.w3.org/1999/xhtml"> for some advice on installing and using MySQL.</span></p>
<p><span class="koboSpan" id="kobo.920.1" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://www.postgresql.org/docs/current/tutorial-start.html"><span class="koboSpan" id="kobo.921.1" xmlns="http://www.w3.org/1999/xhtml">https://www.postgresql.org/docs/current/tutorial-start.html</span></a><span class="koboSpan" id="kobo.922.1" xmlns="http://www.w3.org/1999/xhtml"> for advice on installing and using PostgreSQL.</span></p>
<p><span class="koboSpan" id="kobo.923.1" xmlns="http://www.w3.org/1999/xhtml">In some cases, it makes sense to explore using a Docker container to run a database server on a virtual machine. </span><span class="koboSpan" id="kobo.923.2" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://www.packtpub.com/product/docker-for-developers/9781789536058"><span class="koboSpan" id="kobo.924.1" xmlns="http://www.w3.org/1999/xhtml">https://www.packtpub.com/product/docker-for-developers/9781789536058</span></a><span class="koboSpan" id="kobo.925.1" xmlns="http://www.w3.org/1999/xhtml"> for more about using Docker as a way to run complex services in isolated environments.</span></p>
<p><span class="koboSpan" id="kobo.926.1" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://dev.mysql.com/doc/refman/8.0/en/docker-mysql-getting-started.html"><span class="koboSpan" id="kobo.927.1" xmlns="http://www.w3.org/1999/xhtml">https://dev.mysql.com/doc/refman/8.0/en/docker-mysql-getting-started.html</span></a><span class="koboSpan" id="kobo.928.1" xmlns="http://www.w3.org/1999/xhtml"> for ways to use MySQL in a Docker container.</span></p>
<p><span class="koboSpan" id="kobo.929.1" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://www.docker.com/blog/how-to-use-the-postgres-docker-official-image/"><span class="koboSpan" id="kobo.930.1" xmlns="http://www.w3.org/1999/xhtml">https://www.docker.com/blog/how-to-use-the-postgres-docker-official-image/</span></a><span class="koboSpan" id="kobo.931.1" xmlns="http://www.w3.org/1999/xhtml"> for information on running PostgreSQL in a Docker container. </span><span id="x1-143001r157"/></p>
</section>
<section class="level3" data-number="9.4.2" id="consider-using-a-nosql-database">
<h3 data-number="9.4.2"><span class="titlemark"><span class="koboSpan" id="kobo.932.1" xmlns="http://www.w3.org/1999/xhtml">5.4.2 </span></span> <span id="x1-1440002"/><span class="koboSpan" id="kobo.933.1" xmlns="http://www.w3.org/1999/xhtml">Consider using a NoSQL database</span></h3>
<p><span class="koboSpan" id="kobo.934.1" xmlns="http://www.w3.org/1999/xhtml">A NoSQL database offers many database features — including reliably persistent data and shared access — but avoids (or extends) the relational data model and replaces the SQL language.</span></p>
<p><span class="koboSpan" id="kobo.935.1" xmlns="http://www.w3.org/1999/xhtml">This leads to data acquisition applications that are somewhat like the examples in this chapter. </span><span class="koboSpan" id="kobo.935.2" xmlns="http://www.w3.org/1999/xhtml">There’s a connection to a server and requests to extract data from the server. </span><span class="koboSpan" id="kobo.935.3" xmlns="http://www.w3.org/1999/xhtml">The requests aren’t SQL </span><code><span class="koboSpan" id="kobo.936.1" xmlns="http://www.w3.org/1999/xhtml">SELECT</span></code><span class="koboSpan" id="kobo.937.1" xmlns="http://www.w3.org/1999/xhtml"> statements. </span><span class="koboSpan" id="kobo.937.2" xmlns="http://www.w3.org/1999/xhtml">Nor is the result necessarily rows of data in a completely normalized structure.</span></p>
<p><span class="koboSpan" id="kobo.938.1" xmlns="http://www.w3.org/1999/xhtml">For example, MongoDB. </span><span class="koboSpan" id="kobo.938.2" xmlns="http://www.w3.org/1999/xhtml">Instead of rows and tables, the data structure is JSON documents. </span><span class="koboSpan" id="kobo.938.3" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://www.packtpub.com/product/mastering-mongodb-4x-second-edition/9781789617870"><span class="koboSpan" id="kobo.939.1" xmlns="http://www.w3.org/1999/xhtml">https://www.packtpub.com/product/mastering-mongodb-4x-second-edition/9781789617870</span></a><span class="koboSpan" id="kobo.940.1" xmlns="http://www.w3.org/1999/xhtml">.</span></p>
<p><span class="koboSpan" id="kobo.941.1" xmlns="http://www.w3.org/1999/xhtml">The use of MongoDB changes data acquisition to a matter of locating the JSON documents and then building the desired document from the source data in the database.</span></p>
<p><span class="koboSpan" id="kobo.942.1" xmlns="http://www.w3.org/1999/xhtml">This would lead to two projects, similar to the two described in this chapter, to populate the “production” Mongo database with some data to extract, and then writing the acquisition program to extract the data from the database.</span></p>
<p><span class="koboSpan" id="kobo.943.1" xmlns="http://www.w3.org/1999/xhtml">Another alternative is to use the PostgreSQL database with JSON objects for the data column values. </span><span class="koboSpan" id="kobo.943.2" xmlns="http://www.w3.org/1999/xhtml">This provides a MongoDB-like capability using the PostgreSQL engine. </span><span class="koboSpan" id="kobo.943.3" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://www.postgresql.org/docs/9.3/functions-json.html"><span class="koboSpan" id="kobo.944.1" xmlns="http://www.w3.org/1999/xhtml">https://www.postgresql.org/docs/9.3/functions-json.html</span></a><span class="koboSpan" id="kobo.945.1" xmlns="http://www.w3.org/1999/xhtml"> for more information on this approach.</span></p>
<p><span class="koboSpan" id="kobo.946.1" xmlns="http://www.w3.org/1999/xhtml">Here are some common categories of NoSQL databases:</span></p>
<ul>
<li><p><span class="koboSpan" id="kobo.947.1" xmlns="http://www.w3.org/1999/xhtml">Document databases</span></p></li>
<li><p><span class="koboSpan" id="kobo.948.1" xmlns="http://www.w3.org/1999/xhtml">Key-value stores</span></p></li>
<li><p><span class="koboSpan" id="kobo.949.1" xmlns="http://www.w3.org/1999/xhtml">Column-oriented databases</span></p></li>
<li><p><span class="koboSpan" id="kobo.950.1" xmlns="http://www.w3.org/1999/xhtml">Graph databases</span></p></li>
</ul>
<p><span class="koboSpan" id="kobo.951.1" xmlns="http://www.w3.org/1999/xhtml">The reader is encouraged to search for representative products in these categories and consider the two parts of this chapter: loading a database and acquiring data from the database. </span><span id="x1-144001r158"/></p>
</section>
<section class="level3" data-number="9.4.3" id="consider-using-sqlalchemy-to-define-an-orm-layer">
<h3 data-number="9.4.3"><span class="titlemark"><span class="koboSpan" id="kobo.952.1" xmlns="http://www.w3.org/1999/xhtml">5.4.3 </span></span> <span id="x1-1450003"/><span class="koboSpan" id="kobo.953.1" xmlns="http://www.w3.org/1999/xhtml">Consider using SQLAlchemy to define an ORM layer</span></h3>
<p><span class="koboSpan" id="kobo.954.1" xmlns="http://www.w3.org/1999/xhtml">In </span><a href="#x1-1280002"><em><span class="koboSpan" id="kobo.955.1" xmlns="http://www.w3.org/1999/xhtml">The Object-Relational Mapping (ORM) problem</span></em></a><span class="koboSpan" id="kobo.956.1" xmlns="http://www.w3.org/1999/xhtml"> we talked about the ORM problem. </span><span class="koboSpan" id="kobo.956.2" xmlns="http://www.w3.org/1999/xhtml">In that section, we made the case that using a tool to configure an ORM package for an existing database can sometimes turn out badly.</span></p>
<p><span class="koboSpan" id="kobo.957.1" xmlns="http://www.w3.org/1999/xhtml">This database, however, is very small. </span><span class="koboSpan" id="kobo.957.2" xmlns="http://www.w3.org/1999/xhtml">It’s an ideal candidate for learning about simple ORM configuration.</span></p>
<p><span class="koboSpan" id="kobo.958.1" xmlns="http://www.w3.org/1999/xhtml">We suggest starting with the SQLAlchemy ORM layer. </span><span class="koboSpan" id="kobo.958.2" xmlns="http://www.w3.org/1999/xhtml">See </span><a class="url" href="https://docs.sqlalchemy.org/en/20/orm/quickstart.html"><span class="koboSpan" id="kobo.959.1" xmlns="http://www.w3.org/1999/xhtml">https://docs.sqlalchemy.org/en/20/orm/quickstart.html</span></a><span class="koboSpan" id="kobo.960.1" xmlns="http://www.w3.org/1999/xhtml"> for advice on configuring class definitions that can be mapped to tables. </span><span class="koboSpan" id="kobo.960.2" xmlns="http://www.w3.org/1999/xhtml">This will eliminate the need to write SQL when doing extracts from the database.</span></p>
<p><span class="koboSpan" id="kobo.961.1" xmlns="http://www.w3.org/1999/xhtml">There are other ORM packages available for Python, also. </span><span class="koboSpan" id="kobo.961.2" xmlns="http://www.w3.org/1999/xhtml">The reader should feel free to locate an ORM package and build the extraction project in this chapter using the ORM data model. </span><span id="x1-145001r125"/></p>
</section>
</section>
</section>
</body>
</html>
