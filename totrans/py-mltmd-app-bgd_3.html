<html><head></head><body>
  <div><div><div><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Enhancing Images</h1></div></div></div><div><blockquote class="blockquote"><p>In the previous chapter, we learned a lot about day-to-day image processing. We accomplished the learning objective of performing basic image manipulation by working on several examples and small projects. In this chapter, we will move a step further by learning how to add special effects to an image. The special effects added to the image serve several purposes. These not only give a pleasing appearance to the image but may also help you to understand important information presented by the image.<a id="id86" class="indexterm"/>
</p></blockquote></div><p>In this chapter, we shall:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Learn how to adjust brightness and contrast levels of an image</li><li class="listitem" style="list-style-type: disc">Add code to selectively modify the color of an image and create gray scale images and negatives</li><li class="listitem" style="list-style-type: disc">Use PIL functionality to combine two images together and add transparency effects to the image</li><li class="listitem" style="list-style-type: disc">Apply various image-enhancement filters to an image to achieve effects such as smoothing, sharpening, embossing, and so on</li></ul></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Undertake a project to develop a tool to add a watermark or text or a date stamp to an image</li></ul></div><p>So let's get on with it.</p><div><div><div><div><h1 class="title"><a id="ch03lvl1sec01"/>Installation and download prerequisites</h1></div></div></div><p>The installation prerequisites for this chapter are same as the ones in<a class="link" href="ch02.html" title="Chapter 2. Working with Images"> Chapter 2</a>,<em> Working with Images</em>. Please refer to that chapter for further details.<a id="id87" class="indexterm"/>
</p><p>It is important to download all the images required for this chapter from the Packt website at<a class="ulink" href="http://www.packtpub.com/"> http://www.packtpub.com/</a>. We will be using these images throughout this chapter in the image processing code. Additionally, please download the PDF file,<code class="literal"> Chapter 3 Supplementary Material.pdf</code> from Packt website. This is very important if you are reading a hard copy of this book which is printed in black and white. In the upcoming sections such as "Tweaking Colors", we compare the images before and after processing. In the black and white edition, you won't be able to see the difference between the compared images. For example, the effects such as changed image color, modified contrast, and so on, won't be noticeable. The PDF file contains all these image comparisons. So please keep this file handy while working on the examples in this chapter!</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec02"/>Adjusting brightness and contrast</h1></div></div></div><p>One often needs to tweak the brightness and contrast level of an image. For example, you may have a photograph that was taken with a basic camera, when there was insufficient light. How would you correct that digitally? The brightness adjustment helps make the image brighter or darker whereas the contrast adjustments emphasize differences between the color and brightness level within the image data. The image can be made lighter or darker using the<code class="literal"> ImageEnhance</code> module in PIL. The same module provides a class that can auto-contrast an image.<a id="id88" class="indexterm"/>
</p></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec03"/>Time for action -  adjusting brightness and contrast</h1></div></div></div><p>Let's learn how to modify the image brightness and contrast. First, we will write code to adjust brightness. The<code class="literal"> ImageEnhance</code> module makes our job easier by providing<code class="literal"> Brightness</code> class.</p><div><ol class="orderedlist arabic"><li class="listitem">Download image<code class="literal"> 0165_3_12_Before_BRIGHTENING.png</code> and rename it to<code class="literal"> Before_BRIGHTENING.png</code>.</li><li class="listitem">Use the following code:<div><pre class="programlisting">1 import Image
2 import ImageEnhance
3
4 brightness = 3.0
5 peak = Image.open( "C:\\images\\Before_BRIGHTENING.png ")
6 enhancer = ImageEnhance.Brightness(peak)
7 bright = enhancer.enhance(brightness)
8 bright.save( "C:\\images\\BRIGHTENED.png ")
9 bright.show()
</pre></div></li><li class="listitem">On line 6 in the code snippet, we created an instance of the class<code class="literal"> Brightness</code>. It takes<code class="literal"> Image</code> instance as an argument.</li><li class="listitem">Line 7 creates a new image<code class="literal"> bright</code> by using the specified<code class="literal"> brightness</code> value. A value between<code class="literal"> 0.0</code> and less than<code class="literal"> 1.0</code> gives a darker image, whereas a value greater than<code class="literal"> 1.0</code> makes it brighter. A value of<code class="literal"> 1.0</code> keeps the brightness of the image unchanged.</li><li class="listitem">The original and resultant image are shown in the next illustration.<p>Comparison of images before and after brightening.
</p><div><img src="img/0165_3_1.jpg" alt="Time for action - adjusting brightness and contrast"/></div><div><img src="img/0165_3_2.jpg" alt="Time for action - adjusting brightness and contrast"/></div></li><li class="listitem">Let's move on and adjust the contrast of the brightened image. We will append the following lines of code to the code snippet that brightened the image.<a id="id89" class="indexterm"/><div><pre class="programlisting">10 contrast = 1.3
11 enhancer = ImageEnhance.Contrast(bright)
12 con = enhancer.enhance(contrast)
13 con.save( "C:\\images\\CONTRAST.png ")
14 con.show()
</pre></div></li><li class="listitem">Thus, similar to what we did to brighten the image, the image contrast was tweaked by using the<code class="literal"> ImageEnhance.Contrast</code> class. A contrast value of<code class="literal"> 0.0</code> creates a black image. A value of<code class="literal"> 1.0</code> keeps the current contrast.</li><li class="listitem">The resultant image is compared with the original in the following illustration.<div><div><h3 class="title"><a id="tip05"/>Tip</h3><p>NOTE: As mentioned in the<em> Installation and Download Prerequisites</em> section, the images compared in the following illustration will appear identical if you are reading a hard copy of this book. Please download and refer to the supplementary PDF file<code class="literal"> Chapter 3 Supplementary Material.pdf</code>. Here, the color images are provided, which will help you see the difference.</p></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">The original image with the image displaying the increasing contrast.</li></ul></div><div><img src="img/0165_3_3.jpg" alt="Time for action - adjusting brightness and contrast"/></div><div><img src="img/0165_3_4.jpg" alt="Time for action - adjusting brightness and contrast"/></div></li><li class="listitem">In the preceding code snippet, we were required to specify a contrast value. If you prefer PIL for deciding an appropriate contrast level, there is a way to do this. The<code class="literal"> ImageOps.autocontrast</code> functionality sets an appropriate contrast level. This function normalizes the image contrast. Let's use this functionality now.<a id="id90" class="indexterm"/></li><li class="listitem">Use the following code:<div><pre class="programlisting">import ImageOps
bright = Image.open( "C:\\images\\BRIGHTENED.png ")
con = ImageOps.autocontrast(bright, cutoff = 0)
con.show()
</pre></div></li><li class="listitem">The highlighted line in the code is where contrast is automatically set. The<code class="literal"> autocontrast</code> function computes histogram of the input image. The<code class="literal"> cutoff</code> argument represents the percentage of lightest and darkest pixels to be trimmed from this histogram. The image is then remapped.</li></ol></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec01"/>What just happened?</h2></div></div></div><p>Using the classes and functionality in<code class="literal"> ImageEnhance</code> module, we learned how to increase or decrease the brightness and the contrast of the image. We also wrote code to auto-contrast an image using functionality provided in the<code class="literal"> ImageOps</code> module. The things we learned here will be useful in the upcoming sections in this chapter.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec04"/>Tweaking colors</h1></div></div></div><p>Another useful operation performed on the image is adjusting the colors within an image. The image may contain one or more bands, containing image data. The<code class="literal"> image</code> mode contains information about the depth and type of the image pixel data. The most common modes we will use in this chapter are<code class="literal"> RGB</code> (true color, 3x8 bit pixel data),<code class="literal"> RGBA</code> (true color with transparency mask, 4x8 bit) and<code class="literal"> L</code> (black and white, 8 bit).<a id="id91" class="indexterm"/>
</p><p>In PIL, you can easily get the information about the bands data within an image. To get the name and number of bands, the<code class="literal"> getbands()</code> method of the class<code class="literal"> Image</code> can be used. Here,<code class="literal"> img</code> is an instance of class<code class="literal"> Image</code>.</p><div><pre class="programlisting">&gt;&gt;&gt; img.getbands()
('R', 'G', 'B', 'A')
</pre></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec05"/>Time for action -  swap colors within an image!</h1></div></div></div><p>To understand some basic concepts, let's write code that just swaps the image band data.<a id="id92" class="indexterm"/>
</p><div><ol class="orderedlist arabic"><li class="listitem">Download the image<code class="literal"> 0165_3_15_COLOR_TWEAK.png</code> and rename it as<code class="literal"> COLOR_TWEAK.png</code>.</li><li class="listitem">Type the following code:<div><pre class="programlisting">1 import Image
2
3 img = Image.open( "C:\\images\\COLOR_TWEAK.png ")
4 img = img.convert('RGBA')
5 r, g, b, alpha = img.split()
6 img = Image.merge( "RGBA ", (g, r, b, alpha))
7 img.show()
</pre></div></li><li class="listitem">Let's analyze this code now. On line 2, the<code class="literal"> Image</code> instance is created as usual. Then, we change the<code class="literal"> mode</code> of the image to<code class="literal"> RGBA</code>.<div><div><h3 class="title"><a id="tip06"/>Tip</h3><p>Here we should check if the image already has that mode or if this conversion is possible. You can add that check as an exercise!</p></div></div></li><li class="listitem">Next, the call to<code class="literal"> Image.split()</code> creates separate instances of<code class="literal"> Image</code> class, each containing a single band data. Thus, we have four<code class="literal"> Image</code> instances<code class="literal"> r, g, b</code>, and<code class="literal"> alpha</code> corresponding to red, green, and blue bands, and the alpha channel respectively.</li><li class="listitem">The code in line 6 does the main image processing. The first argument that<code class="literal"> Image.merge</code> takes<code class="literal"> mode</code> as the first argument whereas the second argument is a tuple of image instances containing band information. It is required to have same size for all the bands. As you can notice, we have swapped the order of band data in<code class="literal"> Image</code> instances<code class="literal"> r</code> and<code class="literal"> g</code> while specifying the second argument.</li><li class="listitem">The original and resultant image thus obtained are compared in the next illustration. The color of the flower now has a shade of green and the grass behind the flower is rendered with a shade of red.<a id="id93" class="indexterm"/><div><div><h3 class="title"><a id="tip07"/>Tip</h3><p>As mentioned in the<em> Installation and Download Prerequisites</em> section, the images compared in the following illustration will appear identical if you are reading a hard copy of this book. Please download and refer to the supplementary PDF file<code class="literal"> Chapter 3 Supplementary Material.pdf</code>. Here, the color images are provided that will help you see the difference.</p></div></div><p>Original (left) and the color swapped image (right).</p><div><img src="img/0165_3_6.jpg" alt="Time for action - swap colors within an image!"/></div><div><img src="img/0165_3_5.jpg" alt="Time for action - swap colors within an image!"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec02"/>What just happened?</h2></div></div></div><p>We accomplished creating an image with its band data swapped. We learned how to use PIL's<code class="literal"> Image.split()</code> and<code class="literal"> Image.merge()</code> to achieve this. However, this operation was performed on the whole image. In the next section, we will learn how to apply color changes to a specific color region.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec03"/>Changing individual image band</h2></div></div></div><p>In the previous section, we saw how to change the data represented by the whole band. As a result of this band swapping, the color of the flower was changed to a shade of green and the grass color was rendered as a shade of red. What if we just want to change the color of the flower and keep the color of the grass unchanged? To do this, we will make use of<code class="literal"> Image.point</code> functionality along with<code class="literal"> Image.paste</code> operation discussed in depth in the previous chapter.<a id="id94" class="indexterm"/>
</p><p>However, note that we need to be careful in specifying the color region that needs to be changed. It may also depend on the image. Sometimes, it will select some other regions matching the specified color range, which we don't want.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec06"/>Time for action -  change the color of a flower</h1></div></div></div><p>We will make use of the same flower image used in the previous section. As mentioned earlier, our task is to change the color of the flower while keeping the grass color unchanged.<a id="id95" class="indexterm"/>
</p><div><ol class="orderedlist arabic"><li class="listitem">Add this code in a Python source file.<div><pre class="programlisting">1 import Image
2
3 img = Image.open( "C:\\images\\COLOR_TWEAK.png ")
4 img = img.convert('RGBA')
5 r, g, b, alpha = img.split()
6 selection = r.point(lambda i: i &gt; 120 and 150)
7 selection.save( "C:\\images\\COLOR_BAND_MASK.png ")
8 r.paste(g, None, selection)
9 img = Image.merge( "RGBA ", (r, g, b, alpha))
10 img.save( "C:\\images\\COLOR_CHANGE_BAND.png ")
11 img.show()
</pre></div></li><li class="listitem">Lines 1 to 5 remain the same as seen earlier. On line 5, we split the original image, creating four<code class="literal"> Image</code> instances, each holding a single band data.</li><li class="listitem">A new<code class="literal"> Image</code> instance 'selection' is created on line 6. This is an important operation that holds the key to selectively modify color! So let's see what this line of code does. If you observe the original image, the flower region (well, most of it) is rendered with a shade of red color. So, we have called the<code class="literal"> point(function)</code> method on<code class="literal"> Image</code> instance<code class="literal"> r</code>. The<code class="literal"> point</code> method takes a single function and an argument maps the image through this function. It returns a new<code class="literal"> Image</code> instance.</li><li class="listitem">What does this lambda function on line 6 do? Internally, PIL's<code class="literal"> point</code> function does something of this sort:<a id="id96" class="indexterm"/><div><pre class="programlisting">lst = map(function, range(256)) * no_of_bands
</pre></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">In this example, function is nothing but the lambda function. The no_of_bands for the image is 1. Thus, line 6 is used to select a region where the red value is greater than 120. The lst is a list which, in this case has the first 120 values as False whereas the remaining values as 150. The value of 150 plays a role in determining the final color when we perform the paste operation.</li></ul></div></li><li class="listitem">The image mask thus created after the application of<code class="literal"> point</code> operation is shown in the following illustration. The white region in this image represents the region captured by the<code class="literal"> point</code> operation that we just performed. Only the white region will undergo change when we perform<code class="literal"> paste</code> operation next.<div><img src="img/0165_3_7.jpg" alt="Time for action - change the color of a flower"/></div></li><li class="listitem">On line 8, we perform a<code class="literal"> paste</code> operation discussed in the last chapter. Here, the image<code class="literal"> g</code> is pasted onto image<code class="literal"> r</code> using mask<code class="literal"> selection</code>. As a result, the band data of image<code class="literal"> r</code> is modified.</li><li class="listitem">Finally, a new<code class="literal"> Image</code> instance is created using the<code class="literal"> merge</code> operation, by making use of the individual<code class="literal"> r, g, b</code>, and<code class="literal"> alpha</code> image instances containing the new band information.</li><li class="listitem">The original and final processed images are compared in the next illustration. The new flower color looks as cool as the original color, doesn't it?<a id="id97" class="indexterm"/><div><div><h3 class="title"><a id="tip08"/>Tip</h3><p>As mentioned in the<em> Installation and download prerequisites</em> section, the images compared in the following illustration will appear identical if you are reading a hard copy of this book. Please download and refer to the supplementary PDF file<code class="literal"> Chapter 3 Supplementary Material.pdf</code>. The color images are provided that will help you see the difference.</p></div></div><div><img src="img/0165_3_8.jpg" alt="Time for action - change the color of a flower"/></div><div><img src="img/0165_3_9.jpg" alt="Time for action - change the color of a flower"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec04"/>What just happened?</h2></div></div></div><p>We worked out an example that modified a selective color region. Individual image band data was processed to accomplish this task. With the help of<code class="literal"> point, paste</code>, and<code class="literal"> merge</code> operations in PIL's<code class="literal"> Image</code> module, we accomplished changing the color of the flower in the provided image.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec05"/>Gray scale images</h2></div></div></div><p>If you want to give a nostalgic effect to an image, one of the many things that you can do is to convert it to gray scale. There is more than one way to create a gray scale image in PIL. When the mode is specified as<code class="literal"> L</code>, the resultant image is gray scale. The basic syntax to convert color images to black and white is:<a id="id98" class="indexterm"/>
</p><div><pre class="programlisting">img = img.convert('L')
</pre></div><p>Alternatively, we can use functionality provided in the<code class="literal"> ImageOps</code> module.</p><div><pre class="programlisting">img = ImageOps.grayscale(img)
</pre></div><p>If you are creating the image from scratch, the syntax is:</p><div><pre class="programlisting">img = Image.new('L', size)
</pre></div><p>The following illustration shows the original and the converted gray scale images created using one of these techniques.</p><div><div><h3 class="title"><a id="tip09"/>Tip</h3><p>Please download and refer to the supplementary PDF file<code class="literal"> Chapter 3 Supplementary Material.pdf</code>. The color images are provided that will help you see the difference between the following images.</p></div></div><p>Original and gray scale images of a bridge:</p><div><img src="img/0165_3_11.jpg" alt="Gray scale images"/></div><div><img src="img/0165_3_10.jpg" alt="Gray scale images"/></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec06"/>Cook up negatives</h2></div></div></div><p>Creating a negative of an image is straightforward. We just need to invert each color pixel. Therefore, if you have a color<code class="literal"> x</code> at a pixel, the negative image will have (255<code class="literal"> x)</code> at that pixel. The<code class="literal"> ImageOps</code> module makes it very simple. The following line of code creates a negative of an image.<a id="id99" class="indexterm"/>
</p><div><pre class="programlisting">img = ImageOps.invert(img)
</pre></div><p>Here is the result of this operation:</p><p>Original image (left) and its negative (right).<a id="id100" class="indexterm"/>
</p><div><img src="img/0165_3_12.jpg" alt="Cook up negatives"/></div><div><img src="img/0165_3_13.jpg" alt="Cook up negatives"/></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec07"/>Blending</h1></div></div></div><p>Have you ever wished to see yourself in a family photo, taken at a time when you were not around? Or what if you just want to see yourself at the top of Mount Everest at least in a picture? Well, it is possible to do this digitally, using the functionality provided in PIL such as blending, composite image processing, and so on.<a id="id101" class="indexterm"/>
</p><p>In this section, we will learn how to blend images together. As the name suggests, blending means mixing two compatible images to create a new image. The<code class="literal"> blend</code> functionality in PIL creates a new image using two input images of the same<code class="literal"> size</code> and<code class="literal"> mode</code>. Internally, the two input images are interpolated using a constant value of alpha.</p><p>In the PIL documentation, it is formulated as:</p><div><pre class="programlisting">blended_image = in_image1 * (1.0 - alpha) + in_image2 * alpha
</pre></div><p>Looking at this formula, it is clear that<code class="literal"> alpha = 1.0</code> will make the blended image the same as 'n_image2 whereas<code class="literal"> alpha = 0.0</code> returns<code class="literal"> in_image1</code> as the blended image.</p></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec08"/>Time for action -  blending two images</h1></div></div></div><p>Sometimes, the combined effect of two images mixed together makes a big impact compared to viewing the same images differently. Now it's time to give way to your imagination by blending two pictures together. In this example, our resultant image shows birds flying over the Mackinac bridge in Michigan. However, where did they come from? The birds were not there in the original image of the bridge.<a id="id102" class="indexterm"/>
</p><div><ol class="orderedlist arabic"><li class="listitem">Download the following files from Packt website:<code class="literal"> 0165_3_28_BRIDGE2.png</code> and<code class="literal"> 0165_3_29_BIRDS2.png</code>. Rename these files as<code class="literal"> BRIDGE2.png</code> and<code class="literal"> BIRDS2.png</code> respectively.</li><li class="listitem">Add the following code in a Python source file.<div><pre class="programlisting">1 import Image
2
3 img1 = Image.open( "C:\\images\\BRIDGE2.png ")
4 img1 = img1.convert('RGBA')
5
6 img2 = Image.open( "C:\\images\\BIRDS2.png ")
7 img2 = img2.convert('RGBA')
8
9 img = Image.blend(img1, img2, 0.3)
10 img.show()
11 img.save( "C:\\images\\BLEND.png")
</pre></div></li><li class="listitem">The next illustration shows the two images before blending, represented by<code class="literal"> img1</code> and<code class="literal"> img2</code> in the code.<p>Individual images of a bridge and flying birds, before blending.
</p><div><img src="img/0165_3_14.jpg" alt="Time for action - blending two images"/></div><div><img src="img/0165_3_15.jpg" alt="Time for action - blending two images"/></div></li><li class="listitem">The lines 3 to 7 open the two input images to be blended. Notice that we have converted both the images<code class="literal"> RGBA</code>. It need not be necessarily<code class="literal"> RGBA</code> mode. We can specify the modes such as 'RGB' or 'L'. However, it is required to have both the images with same<code class="literal"> size</code> and<code class="literal"> mode</code>.<a id="id103" class="indexterm"/></li><li class="listitem">The images are blended on line 9 using the<code class="literal"> Image.blend</code> method in PIL. The first two arguments in the<code class="literal"> blend</code> method are two<code class="literal"> Image</code> objects representing the two images to be blended. The third argument defines the transparency factor<code class="literal"> alpha</code>. In this example, the image of the bridge is the main image we want to focus on. Thus, the factor<code class="literal"> alpha</code> is defined such that more transparency is applied to the image of the flying birds while creating the final image. The<code class="literal"> alpha</code> factor can have a value between<code class="literal"> 0.0</code> to<code class="literal"> 1.0</code>. Note that, while rendering the output image, the second image,<code class="literal"> img2</code>, is multiplied by this<code class="literal"> alpha</code> value whereas the first image is multiplied by<code class="literal"> 1 - alpha</code>. This can be represented by the following equation.<div><pre class="programlisting">blended_img = img1 * (1 alpha) + img2* alpha
</pre></div></li><li class="listitem">Thus, if we select an alpha factor of, for instance, 0.8, it means that the birds will appear more opaque compared to the bridge. Try changing the alpha factor to see how it changes the resultant image. The resultant image with alpha = 0.3 is:<p>Blended image showing birds flying over a bridge.
</p><div><img src="img/0165_3_16.jpg" alt="Time for action - blending two images"/></div><p>
</p></li><li class="listitem">The picture appears a bit dull due to the transparency effect applied while creating the image. If you convert the input images to<code class="literal"> mode L</code>, the resultant image will look better however, it will be rendered as gray scale. This is shown in the next illustration.<a id="id104" class="indexterm"/><p>Blended gray scale image when both the input images have mode L.
</p><div><img src="img/0165_3_17.jpg" alt="Time for action - blending two images"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec07"/>What just happened?</h2></div></div></div><p>Blending is an important image enhancement feature. With the help of examples, we accomplished creating blended images. We learned using the<code class="literal"> Image.blend</code> method and applied the transparency factor<code class="literal"> alpha</code> to achieve this task. The technique learned in this chapter will be very useful throughout this chapter. In the next section, we will apply the blending technique to create a transparent image.<a id="id105" class="indexterm"/>
</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec09"/>Creating transparent images</h1></div></div></div><p>In the previous section, we learned how to blend two images together. In this section, we will go one step further and see how the same<code class="literal"> blend</code> functionality can be used to create a transparent image! The images with mode RGBA define an<code class="literal"> alpha</code> band. The transparency of the image can be changed by tweaking this band data.<code class="literal"> Image.putalpha()</code> method allows defining new data for the<code class="literal"> alpha</code> band of an image. We will see how to perform point operation to achieve the same effect.<a id="id106" class="indexterm"/>
</p></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec10"/>Time for action -  create transparency</h1></div></div></div><p>Let's write a few lines of code that add the transparency effects to an input image.</p><div><ol class="orderedlist arabic"><li class="listitem">We will use one of the images used in<a class="link" href="ch02.html" title="Chapter 2. Working with Images"> Chapter 2</a>. Download<code class="literal"> 0165_3_25_SMILEY.png</code> and rename it to<code class="literal"> SMILEY.png</code>.</li><li class="listitem">Use the following code:<div><pre class="programlisting">1 import Image
2
3 def addTransparency(img, factor = 0.7 ):
4 img = img.convert('RGBA')
5 img_blender = Image.new('RGBA', img.size, (0,0,0,0))
6 img = Image.blend(img_blender, img, factor)
7 return img
8
9 img = Image.open( "C:\\images\\SMILEY.png ")
10
11 img = addTransparency(img, factor =0.7)
</pre></div></li><li class="listitem">In this example, the<code class="literal"> addTransparency()</code> function takes the<code class="literal"> img</code> instance as input and returns a new image instance with the desired level of transparency.</li><li class="listitem">Now let's see how this function works. On line 4, we first convert the image mode to<code class="literal"> RGBA</code>. As discussed in an earlier section, you can add a conditional here to see if the image is already in the<code class="literal"> RGBA</code> mode.</li><li class="listitem">Next, we create a new<code class="literal"> Image</code> class instance,<code class="literal"> image_blender</code>, using the<code class="literal"> Image.new</code> method. It has the same size and mode as the input image. The third argument represents the color. Here, we specify the transparency as<code class="literal"> 0</code>.</li><li class="listitem">On line 6, two images,<code class="literal"> img</code> (input image) and<code class="literal"> img_blender</code>, are blended together by applying a constant<code class="literal"> alpha</code> value. The function then returns this modified<code class="literal"> Image</code> instance.</li><li class="listitem">The original image and the one with the transparency effect are compared. The images are the screenshots of the images opened in the GIMP editor. This is done so that you clearly understand the effect of transparency. The checkered pattern in these images represents the canvas. Notice how the canvas appears in the transparent image.</li><li class="listitem">There is another simple way to add transparency to an image, using the<code class="literal"> Image.point</code> functionality! Enter the following code in a Python source file and execute it.<div><pre class="programlisting">1 import Image
2 img = Image.open( "C:\\images\\SMILEY.png ")
3 r, g, b, alpha = img.split()
4 alpha = alpha.point(lambda i: i&gt;0 and 178)
5 img.putalpha(alpha)
6 img.save( "C:\\images\\Transparent_SMILEY.png ")
</pre></div></li><li class="listitem">In this new code, we split the original image into four new image instance, each having one of the image band data (r,<code class="literal"> g, b</code>, or<code class="literal"> alpha)</code>. Note that we are assuming here that the mode of the image is<code class="literal"> RGBA</code>. If it is not, you need to convert this image to RGBA! As an exercise, you can add that check in the code.<a id="id107" class="indexterm"/></li><li class="listitem">Next, on line 4, the<code class="literal"> Image.point</code> method is called. The<code class="literal"> lambda</code> function operates on the<code class="literal"> alpha</code> band data. It sets the value as<code class="literal"> 178</code>. This is roughly equal to the<code class="literal"> alpha</code> factor of 0.7 that we set earlier. It is computed here as<code class="literal"> int(255*0.7) )</code>. In the<em> Changing individual image band</em> section, where we learned modifying colors within images, the point operation was thoroughly discussed.</li><li class="listitem">On line 5, we put back the new<code class="literal"> alpha</code> band data in<code class="literal"> img</code>. The resultant images using<code class="literal"> blend</code> and<code class="literal"> point</code> functionality are shown in the next illustration.<p>Image before and after adding transparency.
</p><div><img src="img/0165_3_18.jpg" alt="Time for action - create transparency"/></div><div><img src="img/0165_3_19.jpg" alt="Time for action - create transparency"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec08"/>What just happened?</h2></div></div></div><p>We accomplished adding transparency effect to an image. This is a very useful image enhancement that we need from time to time. We learned how to create a transparent image using two different techniques, namely, using<code class="literal"> Image.blend</code> functionality and<code class="literal"> Image.point</code> operation. The knowledge gained in this section will be applied later in this chapter.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec11"/>Making composites with image mask</h1></div></div></div><p>So far, we have already seen how to blend two images together. It was done using the<code class="literal"> Image.blend</code> operation where the two input images were blended by using a constant<code class="literal"> alpha</code> transparency factor. In this section, we will learn another technique to combine two images together. Here, instead of a constant<code class="literal"> alpha</code> factor, an image instance that defines the transparency mask is used as the third argument. Another difference is that the input images need not have the same<code class="literal"> mode</code>. For instance, the first image can be with mode<code class="literal"> L</code> and the second with mode<code class="literal"> RGBA</code>. The syntax to create composite images is:<a id="id108" class="indexterm"/>
</p><div><pre class="programlisting">outImage = Image.composite(img1, img2, mask)
</pre></div><p>Here, the arguments to the composite method are<code class="literal"> Image</code> instances. The mask is specified as<code class="literal"> alpha</code>. The mode for mask image instance can be<code class="literal"> 1, L</code>, or<code class="literal"> RGBA</code>.</p></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec12"/>Time for action -  making composites with image mask</h1></div></div></div><p>We will mix the same two images blended in another section. Just to try out something different, in the composite image, we will focus on the flying birds instead of the bridge.</p><div><ol class="orderedlist arabic"><li class="listitem">We will use the same set of input images as used in the<em> Blending</em> section.<div><pre class="programlisting">1 import Image
2
3 img1 = Image.open( "C:\\images\\BRIDGE2.png ")
4 img1 = img1.convert('RGBA')
5
6 img2 = Image.open( "C:\\images\\BIRDS2.png ")
7 img2 = img2.convert('RGBA')
8
9 r, g, b, alpha = img2.split()
10 alpha = alpha.point(lambda i: i&gt;0 and 204)
11
12 img = Image.composite(img2, img1, alpha)
13 img.show()
</pre></div></li><li class="listitem">The code until line 7 is identical to the one illustrated in the blending example. Note that the two input images need not have the same<code class="literal"> mode</code>. On line 10, the<code class="literal"> Image.point</code> method is called. The<code class="literal"> lambda</code> function operates on the<code class="literal"> alpha</code> band data. The code on lines 9 and 10 is similar to that illustrated in the section<em> Creating Transparent Images</em>. Please refer to that section for further details. The only difference is that the pixel value is set as<code class="literal"> 204</code>. This modifies the band data in the image instance<code class="literal"> alpha</code>. This value of<code class="literal"> 204</code> is roughly equivalent to the<code class="literal"> alpha</code> factor of<code class="literal"> 0.7</code> if the image were to be blended. What this implies is the bridge will have a fading effect and the flying birds will appear prominently in the composite image.<a id="id109" class="indexterm"/></li><li class="listitem">One thing you will notice here is we are not putting the modified<code class="literal"> alpha</code> band data back in<code class="literal"> img2</code>. Instead, on line 12, the composite image is created using the mask as<code class="literal"> alpha</code>.</li><li class="listitem">The resultant composite image is shown in the next illustration with emphasis on the image of the flying birds.<div><img src="img/0165_3_20.jpg" alt="Time for action - making composites with image mask"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec09"/>What just happened?</h2></div></div></div><p>We learned how to create an image combining two images, using an<code class="literal"> alpha</code> mask. This was accomplished by using<code class="literal"> Image.composite</code> functionality.<a id="id110" class="indexterm"/>
</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec13"/>Project: Watermark Maker Tool</h1></div></div></div><p>We have now learned enough image enhancement techniques to take up a simple project applying these techniques. Let's create a simple command line utility, a "Watermark Maker Tool". Although we call it a "Watermark Maker ", it actually provides some more useful features. Using this utility, you can add the date stamp to the image (the date on which the image was enhanced using this tool). It also enables embedding custom text within an image. The tool can be run on the command line using the following syntax:<a id="id111" class="indexterm"/>
</p><div><pre class="programlisting">python WaterMarkMaker.py [options]
</pre></div><p>Where, the<code class="literal"> [options]</code> are as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">--image1:</code> The file path of the main image that provides canvas.</li><li class="listitem" style="list-style-type: disc"><code class="literal">--waterMark:</code> The file path of the watermark image (if any).</li><li class="listitem" style="list-style-type: disc"><code class="literal">--mark_pos:</code> The coordinates of top-left corner of the watermark image to be embedded. The values should be specified in double quotes, like<strong> 100, 50</strong>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">--text:</code> The text that should appear in the output image.</li><li class="listitem" style="list-style-type: disc"><code class="literal">--text_pos:</code> The coordinates of top-left corner of the TEXT to be embedded. The values should be specified in double quotes, like<strong> 100, 50</strong>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">--transparency:</code> The transparency factor for the watermark (if any)</li><li class="listitem" style="list-style-type: disc"><code class="literal">--dateStamp:</code> Flag (True or<code class="literal"> False)</code> that determines whether to insert date stamp in the image. If<code class="literal"> True</code>, the date stamp at the time this image was processed will be inserted.</li></ul></div><p>The following is an example that shows how to run this tool with all the options specified.<a id="id112" class="indexterm"/>
</p><div><pre class="programlisting">python WaterMarkMaker.py --image1= "C:\foo.png "
--watermark= "C:\watermark.png "
--mark_pos= "200, 200 "
--text= "My Text "
-text_pos= "10, 10 "
--transparency=0.4
--dateStamp=True
</pre></div><p>This creates an output image file<code class="literal"> WATERMARK.png</code>, with a watermark and text at the specified anchor point within the image.</p></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec14"/>Time for action -  Watermark Maker Tool</h1></div></div></div><p>Think about all the methods we would need to accomplish this. The first thing that comes to mind is a function that will process the command-line arguments mentioned earlier. Next, we need to write code that can add a watermark image to the main image. Let's call this<code class="literal"> addWaterMark().</code> On similar lines, we will need methods that add text and date stamp to the image. We will call this<code class="literal"> addText()</code> and<code class="literal"> addDateStamp()</code> respectively. With this information, we will develop code to make this work. In this project, we will encapsulate this functionality in a class, but it is not necessary. We do so to make this tool extensible for future use.</p><div><ol class="orderedlist arabic"><li class="listitem">Download the file<code class="literal"> WaterMarkMaker.py</code>. This has the code required in this project. Just keep it for further use. Some of the methods will not be discussed in this section. If you encounter difficulties while developing those methods, you can always go back and refer to this file.</li><li class="listitem">Open a new Python source file and declare the following class and its methods. Just create empty methods for now. We will expand these in as we proceed along.<div><pre class="programlisting">import Image, ImageDraw, ImageFont
import os, sys
import getopt
from datetime import date
class WaterMarkMaker:
def __init__(self):
pass
def addText(self):
pass
def addDateStamp(self):
pass
def _addTextWorker(self, txt, dateStamp = False):
pass
def addWaterMark(self):
pass
def addTransparency(self, img):
pass
def createImageObjects(self):
pass
def _getMarkPosition(self, canvasImage, markImage):
return
def processArgs(self):
pass
def printUsage(self):
pass
</pre></div></li><li class="listitem">Next, we will write code in the constructor of this class.<a id="id113" class="indexterm"/><div><pre class="programlisting">def __init__(self):
# Image paths
self.waterMarkPath = ''
self.mainImgPath = ''
# Text to be embedded
self.text = ''
# Transparency Factor
self.t_factor = 0.5
# Anchor point for embedded text
self.text_pos = (0, 0)
# Anchor point for watermark.
self.mark_pos = None
# Date stamp
self.dateStamp = False
# Image objects
self.waterMark = None
self.mainImage = None
self.processArgs()
self.createImageObjects()
self.addText()
self.addWaterMark()
if self.dateStamp:
self.addDateStamp()
self.mainImage.save( "C:\\images\\WATERMARK.png ")
self.mainImage.show()
</pre></div></li><li class="listitem">The code is self-explanatory. First, all the necessary attributes are initialized and then the relevant methods are called to create the image with watermark and/or the embedded text. Let's write the methods in the order in which they are called in the constructor.</li><li class="listitem">The<code class="literal"> processArgs()</code> method processes the command-line arguments. You can write this method as an exercise. Alternatively, you can use code in the<code class="literal"> WaterMarkMaker.py</code> file from the Packt website. The process arguments method should take the assignments as shown in the following table. In the reference files,<code class="literal"> getopt</code> module is used to process these arguments. Alternatively, you can use<code class="literal"> OptionParser</code> in the<code class="literal"> optparse</code> module of Python.<a id="id114" class="indexterm"/><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Argument</p>
</th><th style="text-align: left" valign="bottom">
<p>Value</p>
</th><th style="text-align: left" valign="bottom">
<p>Argument</p>
</th><th style="text-align: left" valign="bottom">
<p>Value</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">image1</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">self.mainImgPath</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">text_pos</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">self.text_pos</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">waterMark</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">self.waterMarkPath</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">transparency</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">self.t_factor</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">mark_pos</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">self.mark_pos</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">dateStamp</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">self.dateStamp</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">text</code>
</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">self.text</code>
</p>
</td><td style="text-align: left" valign="top"> </td><td style="text-align: left" valign="top"> </td></tr></tbody></table></div></li><li class="listitem">The<code class="literal"> printUsage()</code> method just prints how to run this tool. You can easily write that method.</li><li class="listitem">Let's review the<code class="literal"> addText()and _addTextWorker()</code> methods now. Note that some of the code comments are removed from the code samples for clarity. You can refer to the code in<code class="literal"> WaterMarkMaker.py</code> for detailed comments.<div><pre class="programlisting">def addText(self):
if not self.text:
return
if self.mainImage is None:
print "\n Main Image not defined.Returning. "
return
txt = self.text
self._addTextWorker(txt)
</pre></div></li><li class="listitem">The addText() method simply calls _addTextWorker() by providing the self.text argument received from the command line.</li><li class="listitem">The<code class="literal"> _addTextWorker()</code> does the main processing that embeds the text within the image. This method is used in the following code:<a id="id115" class="indexterm"/><div><pre class="programlisting">1 def _addTextWorker(self, txt, dateStamp = False):
2 size = self.mainImage.size
3 color = (0, 0, 0)
4 textFont = ImageFont.truetype( "arial.ttf ", 50)
5
6 # Create an ImageDraw instance to draw the text.
7 imgDrawer = ImageDraw.Draw(self.mainImage)
8 textSize = imgDrawer.textsize(txt, textFont)
9
10 if dateStamp:
11 pos_x = min(10, size[0])
12 pos_y = size[1] - textSize[0]
13 pos = (pos_x, pos_y)
14 else:
15 # We need to add text. Use self.text_pos
16 pos = self.text_pos
17 #finally add the text
18 imgDrawer.text(pos, txt, font=textFont)
19
20 if ( textSize[0] &gt; size[0]
21 or textSize[1] &gt; size[1] ):
22 print ( "\n Warning, the specified text "
23 "going out of bounds. " )
</pre></div></li><li class="listitem">In Chapter 2, we created a new image containing a text string. It read "Not really a fancy text ". Do you remember? Here, we have written similar code with some improvements. The function ImageDraw.Draw takes the self.mainImage (an Image instance) as an argument to create a Draw instance, imgDrawer.<p>On line 18, the text is embedded onto the given position using a given font. The text() method of Draw instance takes three arguments, namely, position, text, and the font. In the previous chapter, we already made use of the first two arguments. The third argument font is an instance of class ImageFont in PIL.
</p><p>On line 4, we create this instance specifying a font type (arial.ttf) and the font size (=50). The given text string is now added on to the main image!
</p></li><li class="listitem">The next method we will discuss is<code class="literal"> addDateStamp()</code>. It calls the same<code class="literal"> _addTextWorker()</code> in the end. However, the placement of this date stamp is fixed at the bottom left corner of the image and of course we create our date string by using Python's<code class="literal"> datetime</code> module. The code is illustrated below along with the import statement declared earlier.<div><pre class="programlisting">from datetime import date
def addDateStamp(self):
today = date.today()
time_tpl = today.timetuple()
year, month, day = map(str, time_tpl)
datestamp = "%s/%s/%s "%(year,month, day)
self._addTextWorker(datestamp, dateStamp = True)
</pre></div></li><li class="listitem">The first line of the code in this method creates a date instance<code class="literal"> today</code> with today's date provided as a<code class="literal"> 3-tuple</code>. Something like this:<code class="literal"> datetime.date(2010, 1, 20)</code>. Next, we call the<code class="literal"> timetuple</code> method of<code class="literal"> date</code> instance. The first three values in this<code class="literal"> tuple</code> are<code class="literal"> year, month</code>, and<code class="literal"> day</code> respectively.</li><li class="listitem">The rest of the code is just the processing of the date stamp as a text string and then calling the main worker method just discussed.<a id="id116" class="indexterm"/></li><li class="listitem">Now we will review the code in the<code class="literal"> addWaterMark()</code> method. A<strong> watermark</strong> is typically a semi-transparent image that appears in the main image. There are two different approaches to accomplish creating a watermark. The following code considers both these approaches.<a id="id117" class="indexterm"/><div><pre class="programlisting">1 def addWaterMark(self):
2 # There are more than one way to achieve creating a
3 # watermark. The following flag,if True, will use
4 # Image.composite to create the watermark instead of a
5 # simple Image.paste
6 using_composite = False
7
8 if self.waterMark is None:
9 return
10 # Add Transparency
11 self.waterMark = self.addTransparency(self.waterMark)
12 # Get the anchor point
13 pos_x, pos_y = self._getMarkPosition(self.mainImage,
14 self.waterMark)
15 # Create the watermark
16 if not using_composite:
17 # Paste the image using the transparent
18 # watermark image as the mask.
19 self.mainImage.paste(self.waterMark,
20 (pos_x, pos_y),
21 self.waterMark)
22 else:
23 # Alternate method to create water mark.
24 # using Image.composite create a new canvas
25 canvas = Image.new('RGBA',
26 self.mainImage.size,
27 (0,0,0,0))
28 # Paste the watermark on the canvas
29 canvas.paste(self.waterMark, (pos_x, pos_y))
30 # Create a composite image
31 self.mainImage = Image.composite(canvas,
32 self.mainImage,
33 canvas)
</pre></div></li><li class="listitem">To add a watermark, first we make the image transparent. This is accomplished by calling the<code class="literal"> addTransparency()</code> method. This method also changes the<code class="literal"> mode</code> of the image to<code class="literal"> RGBA</code>. This method is shown here. It is almost identical to the one we developed in an earlier section where an image was made transparent using blending functionality of PIL.<a id="id118" class="indexterm"/><div><pre class="programlisting">def addTransparency(self, img):
img = img.convert('RGBA')
img_blender = Image.new('RGBA',
img.size,
(0,0,0,0))
img = Image.blend(img_blender,
img,
self.t_factor)
return img
</pre></div></li><li class="listitem">Next, on line 13, we determine the anchor point on the main image, where the top-left corner of the watermark will appear. By default, we will match the bottom-left corner of the watermark with the main image. You can review the code for method _getMarkPosition() in the file WaterMarkMaker.py to see how this is done. Moving forward, the code block between lines 16-21 creates the watermark using the paste functionality. This is one way to create the image with a watermark. The arguments provided in the Image.paste function are image to be pasted, anchor point, and mask. The mask is selected as the watermark image itself so as to consider the transparency. Otherwise, the watermark image will appear opaque. The resultant image with and without image mask specification is compared in the following illustration.<p>Resultant images using Image.paste operation created with and without mask.
</p><div><img src="img/0165_3_21.jpg" alt="Time for action - Watermark Maker Tool"/></div><div><img src="img/0165_3_22.jpg" alt="Time for action - Watermark Maker Tool"/></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: none">Next, in the else condition block (lines 22 to 33), we use Image.composite functionality in PIL to embed the watermark. The dimensions of the example watermark image used here are 200x200 pixels, whereas the dimensions of the main image are 800x600 pixels. To use the composite() method, we need to make these images of the same size, and yet, make sure to paste the watermark at the specified position. How to achieve this? The first thing to do is to create a canvas image to hold the watermark. The canvas image is of the same size as that of the main image. The code block 25-29 creates the canvas and pastes the watermark at an appropriate location.<a id="id119" class="indexterm"/><p>Finally, on line 31, the composite image is created using the canvas image instance as the alpha mask.
</p></li></ul></div></li><li class="listitem">Now lets run this tool! You can use your own image files for main image or the watermark. Alternatively, you can use the image<code class="literal"> 0165_3_34_KokanPeak_for_WATERMARK.png</code> as the main image and<code class="literal"> 0165_3_38_SMILEY_small.png</code> as the watermark image. The command-line arguments for this run are:<div><pre class="programlisting">python WaterMarkMaker.py
--image1= "C:\images\KokanPeak_for_WATERMARK.png "
--text= "Peak "
--text_pos= "10, 10 "
--waterMark= "C:\\images\\SMILEY_small.png "
--dateStamp=True
</pre></div></li><li class="listitem">The resultant image with text, date stamp, and the watermark is shown in the next illustration.<p>Final processed image with text, date stamp, and a watermark.
</p><div><img src="img/0165_3_23.jpg" alt="Time for action - Watermark Maker Tool"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec10"/>What just happened?</h2></div></div></div><p>We created a very useful utility that can add a watermark and/or a text string and/or a date stamp to an input image. We used several of the image processing techniques learned in this as well as in an earlier chapter on image processing. Especially, image enhancement features such as blending, creating composite images, and adding transparency were applied to accomplish this task. Additionally we made use of common functionality such as pasting an image, drawing text onto the image, and so on.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec11"/>Have a go hero do more with Watermark Maker Tool</h2></div></div></div><p>Our Watermark Maker tool needs an upgrade. Extend this application so that it supports following the features:<a id="id120" class="indexterm"/>
</p><div><ol class="orderedlist arabic"><li class="listitem">The text or the date stamp color is currently hardcoded. Add a new command-line argument so that a text color can be specified as an optional argument.</li><li class="listitem">Add some standard default options for specifying anchor position for text, date stamp, and the watermark image. These options can be<code class="literal"> TOP_RIGHT, TOP_LEFT, BOTTOM_RIGHT</code>, and<code class="literal"> BOTTOM_LEFT</code>.</li><li class="listitem">The command-line options list is too long. Add code so that all arguments can be read from a text file.</li><li class="listitem">Add support so that it can batch-process images to create desired effect.</li></ol></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec15"/>Applying image filters</h1></div></div></div><p>In the previous chapter,<code class="literal"> filter</code> argument was used while performing the image resize operation. This<code class="literal"> filter</code> determined the quality of the output image. However, there were only four<code class="literal"> filter</code> options available and the scope was limited to a resize operation. In this section, some additional image enhancement filters will be introduced. These are predefined filters and can be directly used on any input image. Following is a basic syntax used for applying a filter.<a id="id121" class="indexterm"/>
</p><div><pre class="programlisting">img = Image.open('foo.jpg')
filtered_image = img.filter(FILTER)
</pre></div><p>Here, we created a new image<code class="literal"> filtered_image</code> by filtering image<code class="literal"> img</code> . The<code class="literal"> FILTER</code> argument can be one of the predefined filters in the<code class="literal"> ImageFilter</code> module of PIL for filtering the image data. PIL offers several predefined image enhancement filters. These can be broadly classified into the following categories. With the help of examples, we will learn some of these in the coming sections.</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Blurring and sharpening:<code class="literal"> BLUR, SHARPEN, SMOOTH, SMOOTH_MORE</code></li><li class="listitem" style="list-style-type: disc">Edge detection and enhancement:<code class="literal"> EDGE_ENHANCE, EDGE_ENHANCE_MORE, FIND_EDGES, CONTOUR</code></li><li class="listitem" style="list-style-type: disc">Distortion/special effects:<code class="literal"> EMBOSS</code></li></ul></div><p>The file<code class="literal"> ImageFilter.py</code> in the PIL source code defines the-mentioned filter classes. You can create your own custom filter by tweaking various arguments in these filter classes.</p><div><pre class="programlisting">filterargs = size, scale, offset, kernel
</pre></div><p>Where,<code class="literal"> kernel</code> is the convolution kernel. Here, the 'convolution' is a mathematical operation, on the image matrix by the 'kernel' matrix to produce a resultant matrix.</p><p>The size of matrix is specified by the size argument. It is specified in the form (width, height). This can either be (3, 3) or (5, 5) size in the current PIL version. The result of each pixel is divided by<code class="literal"> scale</code> argument. This is an optional argument. The<code class="literal"> offset</code> value, if specified, has its value is added to the result after dividing it by the scale argument.</p><p>In some of the image enhancement filter examples, we will create our own custom filter.</p><div><div><div><div><h2 class="title"><a id="ch03lvl2sec12"/>Smoothing</h2></div></div></div><p>
<strong>Smoothing</strong> an image means reducing the noise within the image data. For this, certain mathematical approximation is applied on the image data to recognize the important patterns within the image. The<code class="literal"> ImageFilter</code> module defines<code class="literal"> class SMOOTH</code> for smoothing an image. PIL specifies the following default filter arguments for the image-smoothing filter.<a id="id122" class="indexterm"/>
</p><div><pre class="programlisting">filterargs = (3, 3),
13,
0,
(1, 1, 1,
1, 5, 1,
1, 1, 1)
</pre></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec16"/>Time for action -  smoothing an image</h1></div></div></div><p>Let's work out an example where a smoothing filter will be applied to an image.</p><div><ol class="orderedlist arabic"><li class="listitem">Download the image file<code class="literal"> 0165_3_Before_SMOOTHING.png</code> from the Packt website and save it as<code class="literal"> Before_SMOOTHING.png</code>.</li><li class="listitem">This is a low-resolution image scanned from a developed photograph. As you can see, there is a lot of salt-and-pepper noise in the image. We will apply smoothing filter to reduce some of this noise in the image data.</li><li class="listitem">Add the following code in a Python file.<div><pre class="programlisting">import ImageFilter
import Image
img = Image.open( "C:\\images\\Before_SMOOTH.png ")
img = img.filter(ImageFilter.SMOOTH)
img.save( "C:\\images\\ch3\\After_SMOOTH.png")
img.show()
</pre></div></li><li class="listitem">The highlighted line in the code is where the smoothing filter is applied to the image. The results are shown in the next illustration.<p>Picture before and after smoothing:
<a id="id123" class="indexterm"/>
</p><div><img src="img/0165_3_24.jpg" alt="Time for action - smoothing an image"/></div><div><img src="img/0165_3_25.jpg" alt="Time for action - smoothing an image"/></div></li><li class="listitem">To reduce the noise further down, you can use<code class="literal"> ImageFilter.SMOOTH_MORE</code> or try reapplying the<code class="literal"> ImageFilter.SMOOTH</code> multiple times until you get the desired effect.<div><pre class="programlisting">import ImageFilter
import Image
img = Image.open( "C:\\images\\0165_3_2_Before_SMOOTH.png ")
i = 0
while i &lt; 5:
img = img.filter(ImageFilter.SMOOTH)
i += 1
img.save( "C:\\images\\0165_3_3_After_SMOOTH_5X.png")
img.show()
</pre></div></li><li class="listitem">As you can observe in the illustration, the noise is further reduced but the image appears a little bit hazy. Thus, one has to determine an appropriate level of smoothness.<p>Comparison of the resultant image with single and multiple smoothing filters.
</p><div><img src="img/0165_3_26.jpg" alt="Time for action - smoothing an image"/></div><div><img src="img/0165_3_27.jpg" alt="Time for action - smoothing an image"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec13"/>What just happened?</h2></div></div></div><p>We learned how to reduce high-level noise from the image data using the smoothing filter in the<code class="literal"> ImageFilter</code> module.<a id="id124" class="indexterm"/>
</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec14"/>Sharpening</h2></div></div></div><p>In the earlier section, we learned image-smoothing techniques. If you want to view the finer details within an image, a sharpening filter can be applied over the image. Like image-smoothing filters, PIL provides predefined filters for sharpening called<code class="literal"> ImageFilter.SHARPEN</code>. The basic syntax to sharpen an image is as follows:<a id="id125" class="indexterm"/>
</p><div><pre class="programlisting">img = img.filter(ImageFilter.SHARPEN)
</pre></div><p>You can try this filter on the image that was smoothed multiple times in the earlier section.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec15"/>Blurring</h2></div></div></div><p>In general, blurring makes an image lose its focus. In PIL, the predefined filter for this is<code class="literal"> ImageFilter.BLUR</code>. This is typically useful if you want to fade out the background to highlight some object in the foreground. The syntax is similar to the one used for other filters.<a id="id126" class="indexterm"/>
</p><div><pre class="programlisting">img = img.filter(ImageFilter.BLUR)
</pre></div><p>The following illustration shows the effect of this filter.</p><p>Image before and after application of blurring filter:</p><div><img src="img/0165_3_28.jpg" alt="Blurring"/></div><div><img src="img/0165_3_29.jpg" alt="Blurring"/></div></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec16"/>Edge detection and enhancements</h2></div></div></div><p>In this section, we will learn some general edge detection and enhancement filters. The edge enhance filter improves the edge contrast. It increases the contrast of the region very close to the edge. This makes the edge stand out. The edge detection algorithm looks for discontinuities within the pixel data of the image. For example, it looks for sharp change in the brightness to identify an edge.<a id="id127" class="indexterm"/>
</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec17"/>Time for action -  detecting and enhancing edges</h1></div></div></div><p>Let's see how the edge detection and enhancement filters modify the data of a picture. The photograph that we will use is a close-up of a leaf. The original photo is shown in the next illustration. Applying an edge detection filter on this image creates a cool effect where only edges are highlighted and the remaining portion of the image is rendered as black.<a id="id128" class="indexterm"/>
</p><div><ol class="orderedlist arabic"><li class="listitem">Download the image<code class="literal"> 0165_3_6_Before_EDGE_ENHANCE.png</code> from the Packt website and save it as<code class="literal"> Before_EDGE_ENHANCE.png</code>.</li><li class="listitem">Add the following code in a Python file.<div><pre class="programlisting">1 import Image
2 import ImageFilter
3 import os
4 paths = [ "C:\images\Before_EDGE_ENHANCE.png ",
5 "C:\images\After_EDGE_ENHANCE.png ",
6 "C:\images\EDGE_DETECTION_1.png ",
7 "C:\images\EDGE_DETECTION_2.png "
8 ]
9 paths = map(os.path.normpath, paths)
10
11 ( imgPath ,outImgPath1,
12 outImgPath2, outImgPath3) = paths
13 img = Image.open(imgPath)
14 img1 = img.filter(ImageFilter.FIND_EDGES)
15 img1.save(outImgPath1)
16
17 img2 = img.filter(ImageFilter.EDGE_ENHANCE)
18 img2.save(outImgPath2)
19
20 img3 = img2.filter(ImageFilter.FIND_EDGES)
21 img3.save(outImgPath3)
</pre></div></li><li class="listitem">Line 14 modifies the image data using the<code class="literal"> FIND_EDGES</code> filter and then the resulting image is saved.<a id="id129" class="indexterm"/></li><li class="listitem">Next, we modify the original image data, so that more veins within the leaf become visible. This is accomplished by the application of<code class="literal"> ENHANCE_EDGES</code> filter (line 17).</li><li class="listitem">On line 20, the<code class="literal"> FIND_EDGES</code> filter is applied on the edge-enhanced image. The resultant images are compared in the next illustration.<p>a) First row: Images before and after application of edge enhancement filter b) Second row: The edges detected by ImageFilter.FIND_EDGES filter.
</p><div><img src="img/0165_3_30.jpg" alt="Time for action - detecting and enhancing edges"/></div><div><img src="img/0165_3_31.jpg" alt="Time for action - detecting and enhancing edges"/></div><div><img src="img/0165_3_32.jpg" alt="Time for action - detecting and enhancing edges"/></div><div><img src="img/0165_3_33.jpg" alt="Time for action - detecting and enhancing edges"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec17"/>What just happened?</h2></div></div></div><p>We created an image with enhanced edges by applying the<code class="literal"> EDGE_ENHANCE</code> filter in the<code class="literal"> ImageFilter</code> module. We also learned how to detect edges within the image using the edge detection filter. In the next section, we will apply a special form of the edge filter that highlights or darkens the detected edges within an image. It is called an embossing filter.</p></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec18"/>Embossing</h2></div></div></div><p>In image processing, embossing is a process that gives an image a 3-D appearance. The edges within the image appear raised above the image surface. This optical illusion is accomplished by highlighting or darkening edges within the image. The following illustration shows original and embossed images. Notice how the edges along the characters in the embossed image are either highlighted or darkened to give the desired effect.<a id="id130" class="indexterm"/>
</p><div><img src="img/0165_3_34.jpg" alt="Embossing"/></div><div><img src="img/0165_3_35.jpg" alt="Embossing"/></div><p>The<code class="literal"> ImageFiltermodule</code> provides a predefined filter,<code class="literal"> ImageFilter.EMBOSS</code>, to achieve the embossing effect for an image. The convolution kernel of this filter is of a (3, 3) size and the default filter arguments are:<a id="id131" class="indexterm"/>
</p><div><pre class="programlisting">filterargs = (3, 3), 1, 128, (
-1, 0, 0,
0, 1, 0,
0, 0, 0
)
</pre></div></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec18"/>Time for action -  embossing</h1></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Download the image<code class="literal"> 0165_3_4_Bird_EMBOSS.png</code> from the Packt website and save it as<code class="literal"> Bird_EMBOSS.png</code>.</li><li class="listitem">Add the following code in a Python file:<div><pre class="programlisting">1 import os, sys
2 import Image
3 import ImageFilter
4 imgPath = "C:\images\Bird_EMBOSS.png "
5 outImgPath = "C:\images\Bird_EMBOSSED.png "
6 imgPath = os.path.normpath(imgPath)
6 outImgPath = os.path.normpath(outImgPath)
7 bird = Image.open(imgPath)
8 bird = bird.filter(ImageFilter.EMBOSS)
9 bird.save(outImgPath)
10 bird.show()
</pre></div></li><li class="listitem">On line 9, the embossing filter<code class="literal"> ImageFilter.EMBOSS</code> is applied to the image object<code class="literal"> bird</code>. The resultant embossed image of the bird is shown in the next illustration.<p>Original and embossed images of a bird using ImageFilter.EMBOSS.
</p><div><img src="img/0165_3_36.jpg" alt="Time for action - embossing"/></div><div><img src="img/0165_3_37.jpg" alt="Time for action - embossing"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec19"/>What just happened?</h2></div></div></div><p>We applied an embossing filter on an image and created an embossed image. As seen in previous section, the filter modified the brightness of various edges to make them appear highlighted or darkened. This created an optical illusion where the image appeared raised above the surface.<a id="id132" class="indexterm"/>
</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec19"/>Adding a border</h1></div></div></div><p>How would you prefer viewing a family photo? As a bare picture or enclosed in a nice photo frame? In<code class="literal"> ImageOps</code> module, PIL provides a preliminary functionality to add a plain border around the image. Here is the syntax to achieve this:<a id="id133" class="indexterm"/>
</p><div><pre class="programlisting">img = ImageOps.expand(img, border, fill)
</pre></div><p>This code creates a border around the image. Internally, PIL just creates an image that has dimesions such that:</p><div><pre class="programlisting">new_width = ( right_border_thickness + image_width +
left_border_thickness )
new_height = ( top_border_thickness + image_height +
bottom_border_thickness )
</pre></div><p>Then, the original image is pasted onto this new image to create the border effect. The<code class="literal"> border</code> argument in the preceding code suggests border thickness in pixels. It is uniform in this example and is set to 20 pixels for left, right, top, and bottom borders. The<code class="literal"> fill</code> argument specifies the border color. It can be a number in the range<code class="literal"> 0</code> to<code class="literal"> 255</code> indicating the pixel color, where<code class="literal"> 0</code> is for 'black' and<code class="literal"> 255</code> for 'white' border. Alternatively, you can specify a string representing a color, such as 'red' for red color, and so on.</p></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec20"/>Time for action -  enclosing a picture in a photoframe</h1></div></div></div><p>Let's develop code that adds a frame around a picture.<a id="id134" class="indexterm"/>
</p><div><ol class="orderedlist arabic"><li class="listitem">Download the image<code class="literal"> 0165_3_15_COLOR_TWEAK.png</code> and rename it to<code class="literal"> FLOWER.png</code>.</li><li class="listitem">Add the following code in a Python source file. Make sure to modify the code to specify in the input and output paths appropriately.<div><pre class="programlisting">1 import Image, ImageOps
2 img = Image.open( "C:\\images\\FLOWER.png ")
3 img = ImageOps.expand(img, border=20, fill='black')
4 img = ImageOps.expand(img, border=40, fill='silver')
5 img = ImageOps.expand(img, border=2, fill='black')
6 img.save( "C:\\images\\PHOTOFRAME.png ")
7 img.show()
</pre></div></li><li class="listitem">In this code snippet, three stacked borders are created. The innermost border layer is rendered with black color. This is intentionally chosen darker.</li><li class="listitem">Next, there is a middle layer of border, rendered with a lighter color (silver color in this case). This is done by the code on line 4. It is thicker than the innermost border.</li><li class="listitem">The outermost border is created by code on line 5. It is a very thin layer rendered as black.<a id="id135" class="indexterm"/></li><li class="listitem">Together, these three layers of borders create an optical illusion of a photo frame, by making the border appear raised above the original image.</li><li class="listitem">The following image shows the result of adding this border to the specified input image it shows the image before and after enclosing in a 'photo frame'.<div><img src="img/0165_3_38.jpg" alt="Time for action - enclosing a picture in a photoframe"/></div><div><img src="img/0165_3_39.jpg" alt="Time for action - enclosing a picture in a photoframe"/></div></li></ol></div><div><div><div><div><h2 class="title"><a id="ch03lvl2sec20"/>What just happened?</h2></div></div></div><p>We learned how to create a simple border around an image. By calling<code class="literal"> ImageOps.expand</code> multiple times, we created a multi-layered border having each layer of variable thickness and color. With this, we accomplished creating an optical illusion where the picture appears to be enclosed within a simple photo frame.</p></div></div></div>


  <div><div><div><div><div><h1 class="title"><a id="ch03lvl1sec21"/>Summary</h1></div></div></div><p>This chapter taught us several important image enhancement techniques, specifically:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">With the help of ample examples, we learned how to adjust the color, brightness, and contrast of an image.</li><li class="listitem" style="list-style-type: disc">We learned how to blend images together create composites using image mask and how to add transparency.</li><li class="listitem" style="list-style-type: disc">We applied blending, pasting, and other techniques learned to develop an interesting tool. We implemented features in this tool that enabled inserting a watermark, text, or date stamp to an image.</li><li class="listitem" style="list-style-type: disc">A number of image enhancement filters were discussed. Using code snippets we learned how to reduce high-level noise from image, enhance edges, add sharpening or blurring effects, emboss an image, and so on.</li><li class="listitem" style="list-style-type: disc">We learned miscellaneous other useful image enhancements such as creating negatives and adding border effects to the image.</li></ul></div></div></div>
</body></html>