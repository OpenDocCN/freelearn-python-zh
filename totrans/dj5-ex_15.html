<html><head></head><body>
<div><h1 class="chapterNumber">15</h1>
<h1 class="chapterTitle" id="_idParaDest-395">Building an API</h1>
<p class="normal">In the previous chapter, you built a system for student registration and enrollment in courses. You created views to display course contents and learned how to use Django’s cache framework.</p>
<p class="normal">In this chapter, you will create a RESTful API for your e-learning platform. An API is a common programmable interface that can be used on multiple platforms like websites, mobile applications, plugins, and so on. For example, you can create an API to be consumed by a mobile application for your e-learning platform. If you provide an API to third parties, they will be able to consume information and operate with your application programmatically. An API allows developers to automate actions on your platform and integrate your service with other applications or online services. You will build a fully featured API for your e-learning platform.</p>
<p class="normal">In this chapter, you will:</p>
<ul>
<li class="bulletList">Install Django REST framework</li>
<li class="bulletList">Create serializers for your models</li>
<li class="bulletList">Build a RESTful API</li>
<li class="bulletList">Implement serializer method fields</li>
<li class="bulletList">Create nested serializers</li>
<li class="bulletList">Implement ViewSet views and routers</li>
<li class="bulletList">Build custom API views</li>
<li class="bulletList">Handle API authentication</li>
<li class="bulletList">Add permissions to API views</li>
<li class="bulletList">Create custom permissions</li>
<li class="bulletList">Use the Requests library to consume the API</li>
</ul>
<h1 class="heading-1" id="_idParaDest-396">Functional overview</h1>
<p class="normal"><em class="italic">Figure 15.1</em> shows a representation of the views and API endpoints that will be built in this chapter:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_15_01.png"/></figure>
<p class="packt_figref">Figure 15.1: Diagram of API views and endpoints to be built in Chapter 15</p>
<p class="normal">In this chapter, you will create two different sets of API views, <code class="inlineCode">SubjectViewSet</code> and <code class="inlineCode">CourseViewSet</code>. The former will include the list and detail views for subjects. The latter will include the list and detail views for courses. You will also implement the <code class="inlineCode">enroll</code> action in <code class="inlineCode">CourseViewSet</code> to enroll students in courses. This action will be only available to authenticated users, by using the <code class="inlineCode">IsAuthenticated</code> permission. You will create the <code class="inlineCode">contents</code> action in <code class="inlineCode">CourseViewSet</code> to access a course’s content. To access course contents, users have to be authenticated and enrolled in the given course. You will implement the custom <code class="inlineCode">IsEnrolled</code> permission to limit access to contents to the users enrolled in the course.</p>
<p class="normal">If you are not familiar with API endpoints, you just need to know that they are the specific locations within an API that accept and respond to requests. Each endpoint corresponds to a URL that may accept one or more HTTP methods, like <code class="inlineCode">GET</code>, <code class="inlineCode">POST</code>, <code class="inlineCode">PUT</code>, or <code class="inlineCode">DELETE</code>.</p>
<p class="normal">The source code for this chapter can be found at <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter15">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter15</a>.</p>
<p class="normal">All Python modules used in this chapter are included in the <code class="inlineCode">requirements.txt</code> file in the source code that accompanies this chapter. You can follow the instructions to install each Python module below, or you can install all requirements at once with the command <code class="inlineCode">python -m pip install -r requirements.txt</code>.</p>
<h1 class="heading-1" id="_idParaDest-397">Building a RESTful API</h1>
<p class="normal">When building an API, there are several ways you can structure its endpoints and actions, but following REST principles is encouraged.</p>
<p class="normal">The <strong class="keyWord">REST</strong> architecture <a id="_idIndexMarker1344"/>comes from <strong class="keyWord">Representational State Transfer</strong>. RESTful APIs are resource-based; your models <a id="_idIndexMarker1345"/>represent resources, and HTTP methods such as <code class="inlineCode">GET</code>, <code class="inlineCode">POST</code>, <code class="inlineCode">PUT</code>, or <code class="inlineCode">DELETE</code> are used to retrieve, create, update, or delete objects. HTTP response codes are also used in this context. Different HTTP response codes are returned to indicate the result of the HTTP request, for example, <code class="inlineCode">2XX</code> response codes for success, <code class="inlineCode">4XX</code> for errors, and so on.</p>
<p class="normal">The most common formats to exchange data in RESTful APIs are JSON and XML. You will build a RESTful API with JSON serialization for your project. Your API will provide the following functionalities:</p>
<ul>
<li class="bulletList">Retrieving subjects</li>
<li class="bulletList">Retrieving available courses</li>
<li class="bulletList">Retrieving course contents</li>
<li class="bulletList">Enrolling in a course</li>
</ul>
<p class="normal">You can build an API from scratch with Django by creating custom views. However, there are several third-party modules<a id="_idIndexMarker1346"/> that simplify creating an API for your project; the most popular among them is <strong class="keyWord">Django REST framework</strong> (<strong class="keyWord">DRF</strong>).</p>
<p class="normal">DRF provides a comprehensive set of tools to build RESTful APIs for your projects. The following are some of the most relevant components that we will use to build our API:</p>
<ul>
<li class="bulletList"><strong class="keyWord">Serializers</strong>: To transform data into a standardized format that other programs can<a id="_idIndexMarker1347"/> understand, or to <em class="italic">deserialize</em> data, by converting data into a format that your program can process.</li>
<li class="bulletList"><strong class="keyWord">Parsers and renderers</strong>: To render (or format) serialized data appropriately before it is <a id="_idIndexMarker1348"/>returned in <a id="_idIndexMarker1349"/>an HTTP response. Similarly, to parse incoming data to ensure that it’s in the<a id="_idIndexMarker1350"/> correct form.</li>
<li class="bulletList"><strong class="keyWord">API views</strong>: To implement the<a id="_idIndexMarker1351"/> application logic.</li>
<li class="bulletList"><strong class="keyWord">URLs</strong>: To define<a id="_idIndexMarker1352"/> the API endpoints that will be available.</li>
<li class="bulletList"><strong class="keyWord">Authentication and permissions</strong>: To define authentication methods for the API and the permissions required for each view.</li>
</ul>
<p class="normal">We will start by installing DRF and, after that, we will learn more about these components to build our first API.</p>
<h2 class="heading-2" id="_idParaDest-398">Installing Django REST framework</h2>
<p class="normal">You can find all the information<a id="_idIndexMarker1353"/> about <strong class="keyWord">DRF</strong> at <a href="https://www.django-rest-framework.org/">https://www.django-rest-framework.org/</a>.</p>
<p class="normal">Open the shell and<a id="_idIndexMarker1354"/> install the framework with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install djangorestframework==3.15.1
</code></pre>
<p class="normal">Edit the <code class="inlineCode">settings.py</code> file of the <code class="inlineCode">educa</code> project and add <code class="inlineCode">rest_framework</code> to the <code class="inlineCode">INSTALLED_APPS</code> setting to activate the application, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">INSTALLED_APPS = [
    # ...
<strong class="hljs-string-slc">'rest_framework'</strong><strong class="hljs-slc">,</strong>
]
</code></pre>
<p class="normal">Then, add the following code to the <code class="inlineCode">settings.py</code> file:</p>
<pre class="programlisting code"><code class="hljs-code">REST_FRAMEWORK = {
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.DjangoModelPermissionsOrAnonReadOnly'
    ]
}
</code></pre>
<p class="normal">You can provide a specific configuration for your API using the <code class="inlineCode">REST_FRAMEWORK</code> setting. DRF offers a wide range of settings to configure default behaviors. The <code class="inlineCode">DEFAULT_PERMISSION_CLASSES</code> setting specifies the default permissions to read, create, update, or delete objects. You set <code class="inlineCode">DjangoModelPermissionsOrAnonReadOnly</code> as the only default permission class. This class relies on Django’s permissions system to allow users to create, update, or delete <a id="_idIndexMarker1355"/>objects while providing read-only access for anonymous users. You will learn more about permissions later, in the <em class="italic">Adding permissions to views</em> section.</p>
<p class="normal">For a complete list of available settings for DRF, you can visit <a href="https://www.django-rest-framework.org/api-guide/settings/">https://www.django-rest-framework.org/api-guide/settings/</a>.</p>
<h2 class="heading-2" id="_idParaDest-399">Defining serializers</h2>
<p class="normal">After setting up DRF, you need to specify<a id="_idIndexMarker1356"/> how your data will be serialized. Output data has to be serialized in a specific format, and input data will be deserialized for <a id="_idIndexMarker1357"/>processing. The framework provides the following classes to build serializers for single objects:</p>
<ul>
<li class="bulletList"><code class="inlineCode">Serializer</code>: Provides serialization for normal Python class instances</li>
<li class="bulletList"><code class="inlineCode">ModelSerializer</code>: Provides serialization for model instances</li>
<li class="bulletList"><code class="inlineCode">HyperlinkedModelSerializer</code>: The same as <code class="inlineCode">ModelSerializer</code>, but it represents object relationships with links rather than primary keys</li>
</ul>
<p class="normal">Let’s build our first serializer. Create the following file structure inside the <code class="inlineCode">courses</code> application directory:</p>
<pre class="programlisting con"><code class="hljs-con">api/
    __init__.py
    serializers.py
</code></pre>
<p class="normal">You will build all the API functionality inside the <code class="inlineCode">api</code> directory to keep everything well organized. Edit the <code class="inlineCode">api/serializers.py</code> file and add the following code:</p>
<pre class="programlisting code"><code class="hljs-code">from rest_framework import serializers
from courses.models import Subject
class SubjectSerializer(serializers.ModelSerializer):
    class Meta:
        model = Subject
        fields = ['id', 'title', 'slug']
</code></pre>
<p class="normal">This is the serializer for the <code class="inlineCode">Subject</code> model. Serializers<a id="_idIndexMarker1358"/> are defined in a similar fashion to Django’s <code class="inlineCode">Form</code> and <code class="inlineCode">ModelForm</code> classes. The <code class="inlineCode">Meta</code> class allows you to specify the model to serialize and the fields to be included for serialization. All model fields will be included if you don’t set a <code class="inlineCode">fields</code> attribute.</p>
<p class="normal">Let’s try the serializer. Open the command line and start the Django shell with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py shell
</code></pre>
<p class="normal">Run the following code:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; from courses.models import Subject
&gt;&gt;&gt; from courses.api.serializers import SubjectSerializer
&gt;&gt;&gt; subject = Subject.objects.latest('id')
&gt;&gt;&gt; serializer = SubjectSerializer(subject)
&gt;&gt;&gt; serializer.data
{'id': 4, 'title': 'Programming', 'slug': 'programming'}
</code></pre>
<p class="normal">In this example, you get a <code class="inlineCode">Subject</code> object, create an instance of <code class="inlineCode">SubjectSerializer</code>, and access the serialized data. You can see that the model data is translated into Python native data types.</p>
<p class="normal">You can read more about serializers at <a href="https://www.django-rest-framework.org/api-guide/serializers/">https://www.django-rest-framework.org/api-guide/serializers/</a>.</p>
<h2 class="heading-2" id="_idParaDest-400">Understanding parsers and renderers</h2>
<p class="normal">The serialized<a id="_idIndexMarker1359"/> data has to be <a id="_idIndexMarker1360"/>rendered in a specific format before<a id="_idIndexMarker1361"/> you return it in an HTTP <a id="_idIndexMarker1362"/>response. Likewise, when you get an HTTP request, you have to parse the incoming data and deserialize it before you can operate with it. DRF includes renderers and parsers to handle that.</p>
<p class="normal">Let’s see how to parse<a id="_idIndexMarker1363"/> incoming data. Execute the following code in the Python shell:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; from io import BytesIO
&gt;&gt;&gt; from rest_framework.parsers import JSONParser
&gt;&gt;&gt; data = b'{"id":4,"title":"Programming","slug":"programming"}'
&gt;&gt;&gt; JSONParser().parse(BytesIO(data))
{'id': 4, 'title': 'Programming', 'slug': 'programming'}
</code></pre>
<p class="normal">Given a JSON string input, you can use the <code class="inlineCode">JSONParser</code> class provided by DRF to convert it to a Python object.</p>
<p class="normal">DRF also includes <code class="inlineCode">Renderer</code> classes that allow you to format API responses. The framework determines<a id="_idIndexMarker1364"/> which renderer to use through content negotiation by inspecting <a id="_idIndexMarker1365"/>the request’s <code class="inlineCode">Accept</code> header to determine the expected content type for the response. Optionally, the renderer is determined by the format suffix of the URL. For example, the URL <code class="inlineCode">http://127.0.0.1:8000/api/data.json</code> might be an endpoint that triggers the <code class="inlineCode">JSONRenderer</code> in order to return a JSON response.</p>
<p class="normal">Go back to the shell and <a id="_idIndexMarker1366"/>execute the following code to render the <code class="inlineCode">serializer</code> object from the previous serializer example:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; from rest_framework.renderers import JSONRenderer
&gt;&gt;&gt; JSONRenderer().render(serializer.data)
</code></pre>
<p class="normal">You will see the following output:</p>
<pre class="programlisting con"><code class="hljs-con">b'{"id":4,"title":"Programming","slug":"programming"}'
</code></pre>
<p class="normal">You use the <code class="inlineCode">JSONRenderer</code> to render the serialized data into JSON. By default, DRF uses two different renderers: <code class="inlineCode">JSONRenderer</code> and <code class="inlineCode">BrowsableAPIRenderer</code>. The latter provides a web interface to easily browse your API. You can change the default renderer classes with the <code class="inlineCode">DEFAULT_RENDERER_CLASSES</code> option of the <code class="inlineCode">REST_FRAMEWORK</code> setting.</p>
<p class="normal">You can find more information about renderers and parsers at <a href="https://www.django-rest-framework.org/api-guide/renderers/">https://www.django-rest-framework.org/api-guide/renderers/</a> and <a href="https://www.django-rest-framework.org/api-guide/parsers/">https://www.django-rest-framework.org/api-guide/parsers/</a>, respectively.</p>
<p class="normal">Next, you are going to learn <a id="_idIndexMarker1367"/>how to build API views<a id="_idIndexMarker1368"/> and use serializers in views.</p>
<h2 class="heading-2" id="_idParaDest-401">Building list and detail views</h2>
<p class="normal">DRF comes with a set of <a id="_idIndexMarker1369"/>generic views and mixins that you can use to build your API views. You have been using generic views throughout this book since <em class="italic">Chapter 2</em>, <em class="italic">Enhancing Your Blog and Adding Social Features</em>,<em class="italic"> </em>and you learned about mixins in <em class="italic">Chapter 13</em>, <em class="italic">Creating a Content Management System</em>.</p>
<p class="normal">The base views and mixins provide the functionality to retrieve, create, update, or delete model objects. You can see all the generic mixins and views provided by DRF at <a href="https://www.django-rest-framework.org/api-guide/generic-views/">https://www.django-rest-framework.org/api-guide/generic-views/</a>.</p>
<p class="normal">Let’s create list and detail views to retrieve <code class="inlineCode">Subject</code> objects. Create a new file inside the <code class="inlineCode">courses/api/</code> directory and name it <code class="inlineCode">views.py</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from rest_framework import generics
from courses.api.serializers import SubjectSerializer
from courses.models import Subject
class SubjectListView(generics.ListAPIView):
    queryset = Subject.objects.all()
    serializer_class = SubjectSerializer
class SubjectDetailView(generics.RetrieveAPIView):
    queryset = Subject.objects.all()
    serializer_class = SubjectSerializer
</code></pre>
<p class="normal">In this code, you use the generic <code class="inlineCode">ListAPIView</code> and <code class="inlineCode">RetrieveAPIView</code> views of DRF. Both views have the following attributes:</p>
<ul>
<li class="bulletList"><code class="inlineCode">queryset</code>: The base QuerySet to use to retrieve objects</li>
<li class="bulletList"><code class="inlineCode">serializer_class</code>: The class to serialize objects</li>
</ul>
<p class="normal">Let’s add URL patterns for your views. Create a new file inside the <code class="inlineCode">courses/api/</code> directory, name it <code class="inlineCode">urls.py</code>, and make it look as follows:</p>
<pre class="programlisting code"><code class="hljs-code">from django.urls import path
from . import views
app_name = 'courses'
urlpatterns = [
    path(
        'subjects/',
        views.SubjectListView.as_view(),
        name='subject_list'
    ),
    path(
        'subjects/&lt;pk&gt;/',
        views.SubjectDetailView.as_view(),
        name='subject_detail'
    ),
]
</code></pre>
<p class="normal">In the URL pattern for the <code class="inlineCode">SubjectDetailView</code> view, you include a <code class="inlineCode">pk</code> URL parameter to retrieve the object with the<a id="_idIndexMarker1370"/> given primary key of the <code class="inlineCode">Subject</code> model, which is the <code class="inlineCode">id</code> field. Edit the main <code class="inlineCode">urls.py</code> file of the <code class="inlineCode">educa</code> project and include the API patterns, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">urlpatterns = [
    # ...
<strong class="hljs-slc">    path(</strong><strong class="hljs-string-slc">'api/'</strong><strong class="hljs-slc">, include(</strong><strong class="hljs-string-slc">'courses.api.urls'</strong><strong class="hljs-slc">, namespace=</strong><strong class="hljs-string-slc">'api'</strong><strong class="hljs-slc">)),</strong>
]
</code></pre>
<p class="normal">You use the <code class="inlineCode">api</code> namespace for your API URLs. Our initial API endpoints are ready to be used.</p>
<h1 class="heading-1" id="_idParaDest-402">Consuming the API</h1>
<p class="normal">By making our views <a id="_idIndexMarker1371"/>available via URLs, we have created our first API endpoints. Let’s now try our own API. Ensure that your server is running with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">We are going to use <code class="inlineCode">curl</code> to consume the API. <code class="inlineCode">curl</code> is a command-line tool that allows you to transfer data to and from a server. If you are using Linux, macOS, or Windows 10/11, <code class="inlineCode">curl</code> is very likely included in your system. However, you can download <code class="inlineCode">curl</code> from <a href="https://curl.se/download.html">https://curl.se/download.html</a>.</p>
<p class="normal">Open the shell and retrieve the URL <code class="inlineCode">http://127.0.0.1:8000/api/subjects/</code> with <code class="inlineCode">curl</code>, as follows:</p>
<pre class="programlisting con"><code class="hljs-con">curl http://127.0.0.1:8000/api/subjects/
</code></pre>
<p class="normal">You will get a response similar to the following one:</p>
<pre class="programlisting con"><code class="hljs-con">[
    {
        "id":1,
        "title":"Mathematics",
        "slug":"mathematics"
    },
    {
        "id":2,
        "title":"Music",
        "slug":"music"
    },
    {
        "id":3,
        "title":"Physics",
        "slug":"physics"
    },
    {
        "id":4,
        "title":"Programming",
        "slug":"programming"
    }
]
</code></pre>
<p class="normal">To obtain a more readable, well-indented JSON response, you can use <code class="inlineCode">curl</code> with the <code class="inlineCode">json_pp</code> utility, as follows:</p>
<pre class="programlisting con"><code class="hljs-con">curl http://127.0.0.1:8000/api/subjects/ | json_pp
</code></pre>
<p class="normal">The HTTP response contains a<a id="_idIndexMarker1372"/> list of <code class="inlineCode">Subject</code> objects in the JSON format.</p>
<p class="normal">Instead of <code class="inlineCode">curl</code>, you can also use any other tool to send custom HTTP requests, including a browser extension <a id="_idIndexMarker1373"/>such as Postman, which you can get at <a href="https://www.getpostman.com/">https://www.getpostman.com/</a>.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/api/subjects/</code> in your browser. You will see DRF’s browsable API, as follows:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text  Description automatically generated" src="img/B21088_15_02.png"/></figure>
<p class="packt_figref">Figure 15.2: The Subject List page in the REST framework browsable API</p>
<p class="normal">This HTML interface is provided by the <code class="inlineCode">BrowsableAPIRenderer</code> renderer. It displays the result headers and <a id="_idIndexMarker1374"/>content, and it allows you to perform requests. You can also access the API detail view for a <code class="inlineCode">Subject</code> object by including its ID in the URL.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/api/subjects/1/</code> in your browser. You will see a single <code class="inlineCode">Subject</code> object rendered in the JSON format.</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="img/B21088_15_03.png"/></figure>
<p class="packt_figref">Figure 15.3: The Subject Detail page in the REST framework browsable API</p>
<p class="normal">This is the response for the <code class="inlineCode">SubjectDetailView</code>. Let’s learn how to enrich the content returned for each subject. In the <a id="_idIndexMarker1375"/>next section, we are going to dive into extending serializers with additional fields and methods.</p>
<h1 class="heading-1" id="_idParaDest-403">Extending serializers</h1>
<p class="normal">You have learned how to serialize<a id="_idIndexMarker1376"/> your model objects; however, often, you may want to enrich the response with additional relevant data or calculated fields. Let’s take a look at some of the options to extend serializers.</p>
<h2 class="heading-2" id="_idParaDest-404">Adding additional fields to serializers</h2>
<p class="normal">Let’s edit the subject views to include the<a id="_idIndexMarker1377"/> number of courses available for each subject. You will use the Django aggregation functions to annotate the count of related courses for each subject.</p>
<p class="normal">Edit the <code class="inlineCode">api/views.py</code> file of the <code class="inlineCode">courses</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.db.models </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> Count</strong>
# ...
class SubjectListView(generics.ListAPIView):
    queryset = Subject.objects.<strong class="hljs-slc">annotate(total_courses=Count(</strong><strong class="hljs-string-slc">'courses'</strong><strong class="hljs-slc">))</strong>
    serializer_class = SubjectSerializer
class SubjectDetailView(generics.RetrieveAPIView):
    queryset = Subject.objects.<strong class="hljs-slc">annotate(total_courses=Count(</strong><strong class="hljs-string-slc">'courses'</strong><strong class="hljs-slc">))</strong>
    serializer_class = SubjectSerializer
</code></pre>
<p class="normal">You are now using a QuerySet for the <code class="inlineCode">SubjectListView</code> and <code class="inlineCode">SubjectDetailView</code> that uses the <code class="inlineCode">Count</code> aggregation<a id="_idIndexMarker1378"/> function to annotate the related course count.</p>
<p class="normal">Edit the <code class="inlineCode">api/serializers.py</code> file of the <code class="inlineCode">courses</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from rest_framework import serializers
from courses.models import Subject
class SubjectSerializer(serializers.ModelSerializer):
<strong class="hljs-slc">    total_courses = seralizers.IntegerField()</strong>
class Meta:
        model = Subject
        fields = ['id', 'title', 'slug'<strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'total_courses'</strong>]
</code></pre>
<p class="normal">You have added the <code class="inlineCode">total_courses</code> field to the <code class="inlineCode">SubjectSerializer</code> class. This field is an <code class="inlineCode">IntegerField</code> to represent integers. This field will automatically get its value from the <code class="inlineCode">total_courses</code> attribute of the object being serialized. By using <code class="inlineCode">annotate()</code>, we added the <code class="inlineCode">total_courses</code> attribute to the resulting objects of the <code class="inlineCode">QuerySet</code>.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/api/subjects/1/</code> in your browser. The serialized JSON object now includes the <code class="inlineCode">total_courses</code> attribute, as shown in <em class="italic">Figure 15.4</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_15_04.png"/></figure>
<p class="packt_figref">Figure 15.4: The Subject Detail page, including the total_courses attribute</p>
<p class="normal">You have successfully added the <code class="inlineCode">total_courses</code> attribute to the subject list and detail views. Now, let’s look<a id="_idIndexMarker1379"/> into adding additional attributes using custom serializer methods.</p>
<h2 class="heading-2" id="_idParaDest-405">Implementing serializer method fields</h2>
<p class="normal">DRF provides <code class="inlineCode">SerializerMethodField</code>, which allows you to implement read-only fields that get their value by calling a <a id="_idIndexMarker1380"/>method of the serializer class. This can be particularly useful when you want to include some custom formatted data in your serialized object or perform complex calculations that are not directly a part of your model instances.</p>
<p class="normal">We will create a method that serializes the top 3 popular courses for a subject. We will rank courses by the number of students enrolled in them. Edit the <code class="inlineCode">api/serializers.py</code> file of the <code class="inlineCode">courses</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.db.models </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> Count</strong>
from rest_framework import serializers
from courses.models import Subject
class SubjectSerializer(serializers.ModelSerializer):
    total_courses = serializers.IntegerField()
<strong class="hljs-slc">    popular_courses = seralizers.SerializerMethodField()</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">get_popular_courses</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self, obj</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc">        courses = obj.courses.annotate(</strong>
<strong class="hljs-slc">            total_students=Count(</strong><strong class="hljs-string-slc">'students'</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">        ).order_by(</strong><strong class="hljs-string-slc">'</strong><strong class="hljs-string-slc">total_students'</strong><strong class="hljs-slc">)[:</strong><strong class="hljs-number-slc">3</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> [</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">f'</strong><strong class="hljs-subst-slc">{c.title}</strong><strong class="hljs-string-slc"> (</strong><strong class="hljs-subst-slc">{c.total_students}</strong><strong class="hljs-string-slc">)'</strong><strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">for</strong><strong class="hljs-slc"> c </strong><strong class="hljs-keyword-slc">in</strong><strong class="hljs-slc"> courses</strong>
<strong class="hljs-slc">        ]</strong>
class Meta:
        model = Subject
        fields = [
            'id',
            'title',
            'slug',
            'total_courses'<strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'popular_courses'</strong>
        ]
</code></pre>
<p class="normal">In the new code, you add the new <code class="inlineCode">popular_courses</code> serializer method field to <code class="inlineCode">SubjectSerializer</code>. The field gets its value from the <code class="inlineCode">get_popular_courses()</code> method. You can provide the name of the <a id="_idIndexMarker1381"/>serializer method to call with the <code class="inlineCode">method_field</code> argument of <code class="inlineCode">SerializerMethodField</code>. If not included, this defaults to <code class="inlineCode">get_&lt;field_name&gt;</code>.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/api/subjects/1/</code> in your browser. The serialized JSON object now includes the <code class="inlineCode">total_courses</code> attribute, as shown in <em class="italic">Figure 15.5</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_15_05.png"/></figure>
<p class="packt_figref">Figure 15.5: The subject detail page, including the popular_courses attribute</p>
<p class="normal">You have successfully implemented a <code class="inlineCode">SerializerMethodField</code>. Note that, now, an additional SQL query is generated for each of the results returned by <code class="inlineCode">SubjectListView</code>. Next, you are going to learn how to<a id="_idIndexMarker1382"/> control the number of results returned by adding pagination to <code class="inlineCode">SubjectListView</code>.</p>
<h1 class="heading-1" id="_idParaDest-406">Adding pagination to views</h1>
<p class="normal">DRF includes built-in pagination<a id="_idIndexMarker1383"/> capabilities to control how many objects are sent over in your API responses. When the content of your site starts to grow, you might end up with a large number of subjects and courses. Pagination can be particularly <a id="_idIndexMarker1384"/>useful to improve performance and the user experience when dealing with large datasets.</p>
<p class="normal">Let’s update the <code class="inlineCode">SubjectListView</code> view to include pagination. First, we will define a pagination class.</p>
<p class="normal">Create a new file inside the <code class="inlineCode">courses/api/</code> directory and name it <code class="inlineCode">pagination.py</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from rest_framework.pagination import PageNumberPagination
class StandardPagination(PageNumberPagination):
    page_size = 10
    page_size_query_param = 'page_size'
    max_page_size = 50
</code></pre>
<p class="normal">In this class, we inherit from <code class="inlineCode">PageNumberPagination</code>. This class provides support for pagination based on page numbers. We set the following attributes:</p>
<ul>
<li class="bulletList"><code class="inlineCode">page_size</code>: Determines the default page size (the number of items returned per page) when no page size is provided in the request</li>
<li class="bulletList"><code class="inlineCode">page_size_query_params</code>: Defines the name for the query parameter to use for the page size</li>
<li class="bulletList"><code class="inlineCode">max_page_size</code>: Indicates the maximum requested page size allowed</li>
</ul>
<p class="normal">Now, edit the <code class="inlineCode">api/views.py</code> file of the <code class="inlineCode">courses</code> application and add the following lines highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django.db.models import Count
from rest_framework import generics
from courses.models import Subject
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> courses.api.pagination </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> StandardPagination</strong>
from courses.api.serializers import SubjectSerializer
class SubjectListView(generics.ListAPIView):
    queryset = Subject.objects.annotate(total_courses=Count('courses'))
    serializer_class = SubjectSerializer
<strong class="hljs-slc">    pagination_class = StandardPagination</strong>
# ...
</code></pre>
<p class="normal">You can now paginate the <a id="_idIndexMarker1385"/>objects returned by <code class="inlineCode">SubjectListView</code>. Open <code class="inlineCode">http://127.0.0.1:8000/api/subjects/</code> in your browser. You can see that the JSON structure <a id="_idIndexMarker1386"/>returned by the view is now different due to the pagination. You will see the following structure:</p>
<pre class="programlisting code"><code class="hljs-code">{
"count": 4,
"next": null,
"previous": null,
"results": [
{
"id": 1,
"title": "Mathematics",
            ...
        },
        ...
    ]
}
</code></pre>
<p class="normal">The following items are now part of the JSON returned:</p>
<ul>
<li class="bulletList"><code class="inlineCode">count</code>: The total number of results.</li>
<li class="bulletList"><code class="inlineCode">next</code>: The URL to retrieve the next page. The value is <code class="inlineCode">null</code> when there are no following pages.</li>
<li class="bulletList"><code class="inlineCode">previous</code>: The URL to retrieve the previous page. The value is <code class="inlineCode">null</code> when there are no previous pages.</li>
<li class="bulletList"><code class="inlineCode">results</code>: A list with the serialized objects returned on this page.</li>
</ul>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/api/subjects/?page_size=2&amp;page=1</code> in your browser. This will paginate results by two items<a id="_idIndexMarker1387"/> per page and retrieve the first page of <a id="_idIndexMarker1388"/>results, as shown in <em class="italic">Figure 15.6</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_15_06.png"/></figure>
<p class="packt_figref">Figure 15.6: First page of results for the subject list pagination, with a page size of 2</p>
<p class="normal">We have implemented pagination based on the page number, but DRF also provides a class to implement limit/offset and cursor-based pagination. You can read more about pagination at <a href="https://www.django-rest-framework.org/api-guide/pagination/">https://www.django-rest-framework.org/api-guide/pagination/</a>.</p>
<p class="normal">You have created the API endpoints for the subject views. Next, you will add course endpoints to your API.</p>
<h1 class="heading-1" id="_idParaDest-407">Building the course serializer</h1>
<p class="normal">We are going to create a <a id="_idIndexMarker1389"/>serializer for the <code class="inlineCode">Course</code> model. Edit the <code class="inlineCode">api/serializers.py</code> file of the <code class="inlineCode">courses</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"># ...
from courses.models import <strong class="hljs-slc">Course, </strong>Subject
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">CourseSerializer</strong><strong class="hljs-slc">(serializers.ModelSerializer):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Meta</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">        model = Course</strong>
<strong class="hljs-slc">        fields = [</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'id'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'subject'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'</strong><strong class="hljs-string-slc">title'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'slug'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'overview'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'created'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'owner'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">'modules'</strong>
<strong class="hljs-slc">        ]</strong>
</code></pre>
<p class="normal">Let’s take a look at how a <code class="inlineCode">Course</code> object is serialized. Open the shell and execute the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py shell
</code></pre>
<p class="normal">Run the following code:</p>
<pre class="programlisting con"><code class="hljs-con">&gt;&gt;&gt; from rest_framework.renderers import JSONRenderer
&gt;&gt;&gt; from courses.models import Course
&gt;&gt;&gt; from courses.api.serializers import CourseSerializer
&gt;&gt;&gt; course = Course.objects.latest('id')
&gt;&gt;&gt; serializer = CourseSerializer(course)
&gt;&gt;&gt; JSONRenderer().render(serializer.data)
</code></pre>
<p class="normal">You will get a JSON object with the fields that you included in <code class="inlineCode">CourseSerializer</code>. You can see that the related objects of the <code class="inlineCode">modules</code> manager are serialized as a list of primary keys, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">"modules": [6, 7, 9, 10]
</code></pre>
<p class="normal">These are the IDs of the <a id="_idIndexMarker1390"/>related <code class="inlineCode">Module</code> objects. Next, you are going to learn different methods to serialize related objects.</p>
<h2 class="heading-2" id="_idParaDest-408">Serializing relations</h2>
<p class="normal">DRF comes with different types of related<a id="_idIndexMarker1391"/> fields to represent model relationships. This works for <code class="inlineCode">ForeignKey</code>, <code class="inlineCode">ManyToManyField</code>, and <code class="inlineCode">OneToOneField</code> relationships, as well as generic model relations.</p>
<p class="normal">We are going to use <code class="inlineCode">StringRelatedField</code> to change how related <code class="inlineCode">Module</code> objects are serialized. <code class="inlineCode">StringRelatedField</code> represents the related object using its <code class="inlineCode">__str__()</code> method.</p>
<p class="normal">Edit the <code class="inlineCode">api/serializers.py</code> file of the <code class="inlineCode">courses</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"># ...
class CourseSerializer(serializers.ModelSerializer):
<strong class="hljs-slc">    modules = serializers.StringRelatedField(many=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">, read_only=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">)</strong>
class Meta:
        # ...
</code></pre>
<p class="normal">In the new code, you define the <code class="inlineCode">modules</code> field that provides serialization for the related <code class="inlineCode">Module</code> objects. You use <code class="inlineCode">many=True</code> to indicate that you are serializing multiple related objects. The <code class="inlineCode">read_only</code> parameter indicates that this field is read-only and should not be included in any input to create or update objects.</p>
<p class="normal">Open the shell and create an instance of <code class="inlineCode">CourseSerializer</code> again. Render the serializer’s <code class="inlineCode">data</code> attribute with <code class="inlineCode">JSONRenderer</code>. This time, the listed modules are serialized using their <code class="inlineCode">__str__()</code> method, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">"modules": ["0. Installing Django", "1. Configuring Django"]
</code></pre>
<p class="normal">Note that DRF does not optimize QuerySets. When serializing a list of courses, a SQL query will be generated for each course result to retrieve the related <code class="inlineCode">Module</code> objects. You can reduce the number of additional SQL requests by using <code class="inlineCode">prefetch_related()</code> in your QuerySet, like <code class="inlineCode">Course.objects.prefetch_related('modules')</code>. We will cover this later in the section <em class="italic">Creating ViewSets and routers</em>.</p>
<p class="normal">You can read more about serializer relations at <a href="https://www.django-rest-framework.org/api-guide/relations/">https://www.django-rest-framework.org/api-guide/relations/</a>.</p>
<p class="normal">Let’s advance further and <a id="_idIndexMarker1392"/>define the serialization of related objects with a nested serializer.</p>
<h1 class="heading-1" id="_idParaDest-409">Creating nested serializers</h1>
<p class="normal">If we want to include more <a id="_idIndexMarker1393"/>information about each module, we need to serialize <code class="inlineCode">Module</code> objects and nest them. Modify the previous code of the <code class="inlineCode">api/serializers.py</code> file of the <code class="inlineCode">courses</code> application to make it look as follows:</p>
<pre class="programlisting code"><code class="hljs-code">from django.db.models import Count
from rest_framework import serializers
from courses.models import Course, <strong class="hljs-slc">Module, </strong>Subject
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">ModuleSerializer</strong><strong class="hljs-slc">(serializers.ModelSerializer):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Meta</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">        model = Module</strong>
<strong class="hljs-slc">        fields = [</strong><strong class="hljs-string-slc">'order'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'title'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'description'</strong><strong class="hljs-slc">]</strong>
class CourseSerializer(serializers.ModelSerializer):
    modules = <strong class="hljs-slc">ModuleSerializer</strong>(many=True, read_only=True)
    class Meta:
        # ...
</code></pre>
<p class="normal">In the new code, you define <code class="inlineCode">ModuleSerializer</code> to provide serialization for the <code class="inlineCode">Module</code> model. Then, you modify the <code class="inlineCode">modules</code> attribute of <code class="inlineCode">CourseSerializer</code> to nest the <code class="inlineCode">ModuleSerializer</code> serializer. You keep <code class="inlineCode">many=True</code> to indicate that you are serializing multiple objects and <code class="inlineCode">read_only=True</code> to keep this field read-only.</p>
<p class="normal">Open the shell and create an instance of <code class="inlineCode">CourseSerializer</code> again. Render the serializer’s <code class="inlineCode">data</code> attribute<a id="_idIndexMarker1394"/> with <code class="inlineCode">JSONRenderer</code>. This time, the listed modules are serialized with the nested <code class="inlineCode">ModuleSerializer</code> serializer, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">"modules": [
{
"order": 0,
"title": "Introduction to overview",
"description": "A brief overview about the Web Framework."
},
{
"order": 1,
"title": "Configuring Django",
"description": "How to install Django."
},
    ...
]
</code></pre>
<h1 class="heading-1" id="_idParaDest-410">Creating ViewSets and routers</h1>
<p class="normal">ViewSets allow you to define the<a id="_idIndexMarker1395"/> interactions of your API and let DRF build URLs dynamically with<a id="_idIndexMarker1396"/> a <code class="inlineCode">Router</code> object. By using ViewSets, you can avoid repeating logic for multiple views. ViewSets include actions for the following standard operations:</p>
<ul>
<li class="bulletList">Create operation: <code class="inlineCode">create()</code></li>
<li class="bulletList">Retrieve operation: <code class="inlineCode">list()</code> and <code class="inlineCode">retrieve()</code></li>
<li class="bulletList">Update operation: <code class="inlineCode">update()</code> and <code class="inlineCode">partial_update()</code></li>
<li class="bulletList">Delete operation: <code class="inlineCode">destroy()</code></li>
</ul>
<p class="normal">Let’s create a ViewSet for the <code class="inlineCode">Course</code> model. Edit the <code class="inlineCode">api/views.py</code> file and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django.db.models import Count
from rest_framework import generics
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> rest_framework </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> viewsets</strong>
from courses.api.pagination import StandardPagination
from courses.api.serializers import<strong class="hljs-slc"> CourseSerializer,</strong> SubjectSerializer
from courses.models import <strong class="hljs-slc">Course, </strong>Subject
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">CourseViewSet</strong><strong class="hljs-slc">(viewsets.ReadOnlyModelViewSet):</strong>
<strong class="hljs-slc">    queryset = Course.objects.prefetch_related(</strong><strong class="hljs-string-slc">'modules'</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-slc">    serializer_class = CourseSerializer</strong>
<strong class="hljs-slc">    pagination_class = StandardPagination</strong>
</code></pre>
<p class="normal">The new <code class="inlineCode">CourseViewSet</code> class inherits from <code class="inlineCode">ReadOnlyModelViewSet</code>, which provides the read-only actions <code class="inlineCode">list()</code> and <code class="inlineCode">retrieve()</code> to list objects or retrieve a single object, respectively. You specify the base QuerySet to retrieve <a id="_idIndexMarker1397"/>objects. You use <code class="inlineCode">prefetch_related('modules')</code> to fetch the related <code class="inlineCode">Module</code> objects in an efficient manner. This will avoid additional SQL queries <a id="_idIndexMarker1398"/>when serializing nested modules for each course. In this class, you also define the serializer and pagination classes to use for the ViewSet.</p>
<p class="normal">Edit the <code class="inlineCode">api/urls.py</code> file and create a router for your ViewSet, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">from django.urls import <strong class="hljs-slc">include, </strong>path
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> rest_framework </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> routers</strong>
from . import views
app_name = 'courses'
<strong class="hljs-slc">router = routers.DefaultRouter()</strong>
<strong class="hljs-slc">router.register(</strong><strong class="hljs-string-slc">'</strong><strong class="hljs-string-slc">courses'</strong><strong class="hljs-slc">, views.CourseViewSet)</strong>
urlpatterns = [
    # ...
<strong class="hljs-slc">path(</strong><strong class="hljs-string-slc">''</strong><strong class="hljs-slc">, include(router.urls)),</strong>
]
</code></pre>
<p class="normal">You create a <code class="inlineCode">DefaultRouter</code> object and register <code class="inlineCode">CourseViewSet</code> with the <code class="inlineCode">courses</code> prefix. The router takes charge of generating URLs automatically for your <code class="inlineCode">ViewSet</code>.</p>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/api/</code> in your browser. You will see that the router lists the <code class="inlineCode">courses</code> ViewSet in its base URL, as shown in <em class="italic">Figure 15.7</em>:</p>
<figure class="mediaobject"><img alt="Graphical user interface, text, application, email  Description automatically generated" src="img/B21088_15_07.png"/></figure>
<p class="packt_figref">Figure 15.7: The API Root page of the REST framework browsable API</p>
<p class="normal">You can access <code class="inlineCode">http://127.0.0.1:8000/api/courses/</code> to retrieve<a id="_idIndexMarker1399"/> the list of courses, as <a id="_idIndexMarker1400"/>shown in <em class="italic">Figure 15.8</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_15_08.png"/></figure>
<p class="packt_figref">Figure 15.8: The Course List page in the REST framework browsable API</p>
<p class="normal">Let’s convert the <code class="inlineCode">SubjectListView</code> and <code class="inlineCode">SubjectDetailView</code> views into a single ViewSet. Edit the <code class="inlineCode">api/views.py</code> file, and remove <a id="_idIndexMarker1401"/>or comment out the <code class="inlineCode">SubjectListView</code> and <code class="inlineCode">SubjectDetailView</code> classes. Then, add<a id="_idIndexMarker1402"/> the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code"># ...
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">SubjectViewSet</strong><strong class="hljs-slc">(viewsets.ReadOnlyModelViewSet):</strong>
<strong class="hljs-slc">    queryset = Subject.objects.annotate(total_courses=Count(</strong><strong class="hljs-string-slc">'courses'</strong><strong class="hljs-slc">))</strong>
<strong class="hljs-slc">    serializer_class = SubjectSerializer</strong>
<strong class="hljs-slc">    pagination_class = StandardPagination</strong>
</code></pre>
<p class="normal">Edit the <code class="inlineCode">api/urls.py</code> file and<a id="_idIndexMarker1403"/> remove or comment out the following URLs, since you don’t need <a id="_idIndexMarker1404"/>them anymore:</p>
<pre class="programlisting code"><code class="hljs-code"><strong class="hljs-comment-slc"># </strong>path(
<strong class="hljs-comment-slc"># </strong>    subjects/',
<strong class="hljs-comment-slc"># </strong>    views.SubjectListView.as_view(),
<strong class="hljs-comment-slc"># </strong>    name=subject_list'
<strong class="hljs-comment-slc"># </strong>),
<strong class="hljs-comment-slc"># </strong>path(
<strong class="hljs-comment-slc"># </strong>    subjects/&lt;pk&gt;/ ',
<strong class="hljs-comment-slc"># </strong>     views.SubjectDetailView.as_view(),
<strong class="hljs-comment-slc"># </strong>     name='subject_detail'
<strong class="hljs-comment-slc">#</strong>),
</code></pre>
<p class="normal">In the same file, add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django.urls import include, path
from rest_framework import routers
from . import views
app_name = 'courses'
router = routers.DefaultRouter()
router.register('courses', views.CourseViewSet)
<strong class="hljs-slc">router.register(</strong><strong class="hljs-string-slc">'subjects'</strong><strong class="hljs-slc">, views.SubjectViewSet)</strong>
urlpatterns = [
    path('', include(router.urls)),
]
</code></pre>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/api/</code> in your browser. You will see that the router now includes URLs for both the <code class="inlineCode">courses</code> and <code class="inlineCode">subjects</code> ViewSets, as shown in <em class="italic">Figure 15.9</em>:</p>
<figure class="mediaobject"><img alt="" role="presentation" src="img/B21088_15_09.png"/></figure>
<p class="packt_figref">Figure 15.9: The API Root page of the REST framework browsable API</p>
<p class="normal">You can learn more about ViewSets at <a href="https://www.django-rest-framework.org/api-guide/viewsets/">https://www.django-rest-framework.org/api-guide/viewsets/</a>. You can also find more information about routers at <a href="https://www.django-rest-framework.org/api-guide/routers/">https://www.django-rest-framework.org/api-guide/routers/</a>.</p>
<p class="normal">Generic API views and ViewSets are<a id="_idIndexMarker1405"/> very useful to build REST APIs based on your models and serializers. However, you<a id="_idIndexMarker1406"/> might also need to implement your own views with custom logic. Let’s learn how to create a custom API view.</p>
<h1 class="heading-1" id="_idParaDest-411">Building custom API views</h1>
<p class="normal">DRF provides an <code class="inlineCode">APIView</code> class that<a id="_idIndexMarker1407"/> builds API functionality on top of Django’s <code class="inlineCode">View</code> class. The <code class="inlineCode">APIView</code> class differs from <code class="inlineCode">View</code> by using DRF’s custom <code class="inlineCode">Request</code> and <code class="inlineCode">Response</code> objects and handling <code class="inlineCode">APIException</code> exceptions to return the appropriate HTTP responses. It also has a built-in authentication and authorization system to manage access to views.</p>
<p class="normal">You are going to create a view for users to enroll in courses. Edit the <code class="inlineCode">api/views.py</code> file of the <code class="inlineCode">courses</code> application and add the following code highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">from django.db.models import Count
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> django.shortcuts </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> get_object_or_404</strong>
from rest_framework import generics
from rest_framework import viewsets
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> rest_framework.response </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> Response</strong>
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> rest_framework.views </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> APIView</strong>
from courses.api.pagination import StandardPagination
from courses.api.serializers import CourseSerializer, SubjectSerializer
from courses.models import Course, Subject
# ...
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">CourseEnrollView</strong><strong class="hljs-slc">(</strong><strong class="hljs-title-slc">APIView</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">post</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self, request, pk, </strong><strong class="hljs-built_in-slc">format</strong><strong class="hljs-params-slc">=</strong><strong class="hljs-literal-slc">None</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc">        course = get_object_or_404(Course, pk=pk)</strong>
<strong class="hljs-slc">        course.students.add(request.user)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> Response({</strong><strong class="hljs-string-slc">'enrolled'</strong><strong class="hljs-slc">: </strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">})</strong>
</code></pre>
<p class="normal">The <code class="inlineCode">CourseEnrollView</code> view <a id="_idIndexMarker1408"/>handles user enrollment in courses. The preceding code is as follows:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">You create a custom view that subclasses <code class="inlineCode">APIView</code>.</li>
<li class="numberedList">You define a <code class="inlineCode">post()</code> method for <code class="inlineCode">POST</code> actions. No other HTTP method will be allowed for this view.</li>
<li class="numberedList">You expect a <code class="inlineCode">pk</code> URL parameter containing the ID of a course. You retrieve the course by the given <code class="inlineCode">pk</code> parameter and raise a <code class="inlineCode">404</code> exception if it’s not found.</li>
<li class="numberedList">You add the current user to the <code class="inlineCode">students</code> many-to-many relationship of the <code class="inlineCode">Course</code> object and return a successful response.</li>
</ol>
<p class="normal">Edit the <code class="inlineCode">api/urls.py</code> file and add the following URL pattern to the <code class="inlineCode">CourseEnrollView</code> view:</p>
<pre class="programlisting code"><code class="hljs-code">path(
    'courses/&lt;pk&gt;/enroll/',
    views.CourseEnrollView.as_view(),
    name='course_enroll'
),
</code></pre>
<p class="normal">Theoretically, you could now perform a <code class="inlineCode">POST</code> request to enroll the current user in a course. However, you need to be able to identify the user and prevent unauthenticated users from accessing this view. Let’s<a id="_idIndexMarker1409"/> see how API authentication and permissions work.</p>
<h1 class="heading-1" id="_idParaDest-412">Handling authentication</h1>
<p class="normal">DRF provides authentication classes to identify the user performing the request. If authentication is successful, the framework sets the authenticated <code class="inlineCode">User</code> object in <code class="inlineCode">request.user</code>. If no user is <a id="_idIndexMarker1410"/>authenticated, an instance of Django’s <code class="inlineCode">AnonymousUser</code> is set instead.</p>
<p class="normal">DRF provides the following authentication backends:</p>
<ul>
<li class="bulletList"><code class="inlineCode">BasicAuthentication</code>: This is HTTP basic authentication. The user and password are sent by the client in the <code class="inlineCode">Authorization</code> HTTP header, encoded with Base64. You can learn more about it at <a href="https://en.wikipedia.org/wiki/Basic_access_authentication">https://en.wikipedia.org/wiki/Basic_access_authentication</a>.</li>
<li class="bulletList"><code class="inlineCode">TokenAuthentication</code>: This is token-based authentication. A <code class="inlineCode">Token</code> model is used to store user tokens. Users include the token in the <code class="inlineCode">Authorization</code> HTTP header for authentication.</li>
<li class="bulletList"><code class="inlineCode">SessionAuthentication</code>: This uses Django’s session backend for authentication. This backend is useful for performing authenticated AJAX requests to the API from your website’s frontend.</li>
<li class="bulletList"><code class="inlineCode">RemoteUserAuthentication</code>: This allows you to delegate authentication to your web server, which sets a <code class="inlineCode">REMOTE_USER</code> environment variable.</li>
</ul>
<p class="normal">You can build a custom authentication backend by subclassing the <code class="inlineCode">BaseAuthentication</code> class provided by DRF and overriding the <code class="inlineCode">authenticate()</code> method.</p>
<h2 class="heading-2" id="_idParaDest-413">Implementing basic authentication</h2>
<p class="normal">You can set authentication on a per-view <a id="_idIndexMarker1411"/>basis or set it globally with the <code class="inlineCode">DEFAULT_AUTHENTICATION_CLASSES</code> setting.</p>
<div><p class="normal">Authentication only identifies the user performing the request. It won’t allow or deny access to views. You have to use permissions to restrict access to views.</p>
</div>
<p class="normal">You can find all the information about authentication at <a href="https://www.django-rest-framework.org/api-guide/authentication/">https://www.django-rest-framework.org/api-guide/authentication/</a>.</p>
<p class="normal">Let’s add <code class="inlineCode">BasicAuthentication</code> to your view. Edit the <code class="inlineCode">api/views.py</code> file of the <code class="inlineCode">courses</code> application and add an <code class="inlineCode">authentication_classes</code> attribute to <code class="inlineCode">CourseEnrollView</code>, as follows:</p>
<pre class="programlisting code"><code class="hljs-code"># ...
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> rest_framework.authentication </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> BasicAuthentication</strong>
class CourseEnrollView(APIView):
<strong class="hljs-slc">    authentication_classes = [BasicAuthentication]</strong>
# ...
</code></pre>
<p class="normal">Users will be identified by<a id="_idIndexMarker1412"/> the credentials set in the <code class="inlineCode">Authorization</code> header of the HTTP request.</p>
<h1 class="heading-1" id="_idParaDest-414">Adding permissions to views</h1>
<p class="normal">DRF includes a permission <a id="_idIndexMarker1413"/>system to restrict access to views. Some of the built-in permissions of DRF are:</p>
<ul>
<li class="bulletList"><code class="inlineCode">AllowAny</code>: Unrestricted access, regardless of whether a user is authenticated or not.</li>
<li class="bulletList"><code class="inlineCode">IsAuthenticated</code>: Allows access to authenticated users only.</li>
<li class="bulletList"><code class="inlineCode">IsAuthenticatedOrReadOnly</code>: Complete access to authenticated users. Anonymous users are only allowed to execute read methods such as <code class="inlineCode">GET</code>, <code class="inlineCode">HEAD</code>, or <code class="inlineCode">OPTIONS</code>.</li>
<li class="bulletList"><code class="inlineCode">DjangoModelPermissions</code>: Permissions tied to <code class="inlineCode">django.contrib.auth</code>. The view requires a <code class="inlineCode">queryset</code> attribute. Only authenticated users with model permissions assigned are granted permission.</li>
<li class="bulletList"><code class="inlineCode">DjangoObjectPermissions</code>: Django permissions on a per-object basis.</li>
</ul>
<p class="normal">If users are denied permission, they will usually get one of the following HTTP error codes:</p>
<ul>
<li class="bulletList"><code class="inlineCode">HTTP 401</code>: Unauthorized</li>
<li class="bulletList"><code class="inlineCode">HTTP 403</code>: Permission denied</li>
</ul>
<p class="normal">You can read more information about permissions at <a href="https://www.django-rest-framework.org/api-guide/permissions/">https://www.django-rest-framework.org/api-guide/permissions/</a>.</p>
<p class="normal">Edit the <code class="inlineCode">api/views.py</code> file of the <code class="inlineCode">courses</code> application and add a <code class="inlineCode">permission_classes</code> attribute to <code class="inlineCode">CourseEnrollView</code>, as<a id="_idIndexMarker1414"/> follows:</p>
<pre class="programlisting code"><code class="hljs-code"># ...
from rest_framework.authentication import BasicAuthentication
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> rest_framework.permissions </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> IsAuthenticated</strong>
class CourseEnrollView(APIView):
    authentication_classes = [BasicAuthentication]
<strong class="hljs-slc">    permission_classes = [IsAuthenticated]</strong>
# ...
</code></pre>
<p class="normal">You include the <code class="inlineCode">IsAuthenticated</code> permission. This will prevent anonymous users from accessing the view. Now, you can perform a <code class="inlineCode">POST</code> request to your new API method.</p>
<p class="normal">Make sure the development server is running. Open the shell and run the following command:</p>
<pre class="programlisting con"><code class="hljs-con">curl -i -X POST http://127.0.0.1:8000/api/courses/1/enroll/
</code></pre>
<p class="normal">You will get the following response:</p>
<pre class="programlisting con"><code class="hljs-con">HTTP/1.1 401 Unauthorized
...
{"detail": "Authentication credentials were not provided."}
</code></pre>
<p class="normal">You got a <code class="inlineCode">401</code> HTTP code as expected, since you are not authenticated. Let’s use basic authentication with one of your users. Run the following command, replacing <code class="inlineCode">student:password</code> with the credentials of an existing user:</p>
<pre class="programlisting con"><code class="hljs-con">curl -i -X POST -u student:password http://127.0.0.1:8000/api/courses/1/enroll/
</code></pre>
<p class="normal">You will get the following response:</p>
<pre class="programlisting con"><code class="hljs-con">HTTP/1.1 200 OK
...
{"enrolled": true}
</code></pre>
<p class="normal">You can access the administration site and check that the user is now enrolled in the course.</p>
<h1 class="heading-1" id="_idParaDest-415">Adding additional actions to ViewSets</h1>
<p class="normal">You can add extra actions to <code class="inlineCode">ViewSets</code>. Let’s change the <code class="inlineCode">CourseEnrollView</code> view into a custom <code class="inlineCode">ViewSet</code> action. Edit<a id="_idIndexMarker1415"/> the <code class="inlineCode">api/views.py</code> file and modify the <code class="inlineCode">CourseViewSet</code> class to look as follows:</p>
<pre class="programlisting code"><code class="hljs-code"># ...
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> rest_framework.decorators </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> action</strong>
class CourseViewSet(viewsets.ReadOnlyModelViewSet):
    queryset = Course.objects.prefetch_related('modules')
    serializer_class = CourseSerializer
<strong class="hljs-meta-slc">    @action(</strong>
<strong class="hljs-meta-slc"> </strong><strong class="hljs-params-slc">detail=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-params-slc">,</strong>
<strong class="hljs-params-slc"> </strong><strong class="hljs-meta-slc"> </strong><strong class="hljs-params-slc">methods=[</strong><strong class="hljs-string-slc">'post'</strong><strong class="hljs-params-slc">],</strong>
<strong class="hljs-params-slc"> </strong><strong class="hljs-meta-slc"> </strong><strong class="hljs-params-slc">authentication_classes=[BasicAuthentication],</strong>
<strong class="hljs-params-slc"> </strong><strong class="hljs-meta-slc"> </strong><strong class="hljs-params-slc">permission_classes=[IsAuthenticated]</strong>
<strong class="hljs-params-slc"> </strong><strong class="hljs-meta-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">enroll</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self, request, *args, **kwargs</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc">        course = self.get_object()</strong>
<strong class="hljs-slc">        course.students.add(request.user)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> Response({</strong><strong class="hljs-string-slc">'enrolled'</strong><strong class="hljs-slc">: </strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">})</strong>
</code></pre>
<p class="normal">In the preceding code, you add a custom <code class="inlineCode">enroll()</code> method that represents an additional action for this <code class="inlineCode">ViewSet</code>. The preceding code is as follows:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">You use the <code class="inlineCode">action</code> decorator of the framework with the parameter <code class="inlineCode">detail=True</code> to specify that this is an action to be performed on a single object.</li>
<li class="numberedList">The decorator allows you to add custom attributes for the action. You specify that only the <code class="inlineCode">post()</code> method is allowed for this view and set the authentication and permission classes.</li>
<li class="numberedList">You use <code class="inlineCode">self.get_object()</code> to retrieve the <code class="inlineCode">Course</code> object.</li>
<li class="numberedList">You add the current user to the <code class="inlineCode">students</code> many-to-many relationship and return a custom success response.</li>
</ol>
<p class="normal">Edit the <code class="inlineCode">api/urls.py</code> file and remove or comment out the following URL, since you don’t need it anymore:</p>
<pre class="programlisting code"><code class="hljs-code">path(
    'courses/&lt;pk&gt;/enroll/',
    views.CourseEnrollView.as_view(),
    name='course_enroll'
),
</code></pre>
<p class="normal">Then, edit the <code class="inlineCode">api/views.py</code> file and remove or comment out the <code class="inlineCode">CourseEnrollView</code> class.</p>
<p class="normal">The URL to enroll on courses is now automatically generated by the router. The URL remains the same, since it’s built dynamically using the action name <code class="inlineCode">enroll</code>.</p>
<p class="normal">After students are enrolled in a<a id="_idIndexMarker1416"/> course, they need to access the course’s content. Next, you are going to learn how to ensure only students who have enrolled can access the course.</p>
<h1 class="heading-1" id="_idParaDest-416">Creating custom permissions</h1>
<p class="normal">You want students to be able to access the contents of the courses they are enrolled on. Only students enrolled on a course <a id="_idIndexMarker1417"/>should be able to access its contents. The best way to do this is with a custom permission class. DRF provides a <code class="inlineCode">BasePermission</code> class that allows you to define the following methods:</p>
<ul>
<li class="bulletList"><code class="inlineCode">has_permission()</code>: A view-level permission check</li>
<li class="bulletList"><code class="inlineCode">has_object_permission()</code>: An instance-level permission check</li>
</ul>
<p class="normal">These methods should return <code class="inlineCode">True</code> to grant access, or <code class="inlineCode">False</code> otherwise.</p>
<p class="normal">Create a new file inside the <code class="inlineCode">courses/api/</code> directory and name it <code class="inlineCode">permissions.py</code>. Add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from rest_framework.permissions import BasePermission
class IsEnrolled(BasePermission):
    def has_object_permission(self, request, view, obj):
        return obj.students.filter(id=request.user.id).exists()
</code></pre>
<p class="normal">You subclass the <code class="inlineCode">BasePermission</code> class and override the <code class="inlineCode">has_object_permission()</code>. You check that the user performing the request is present in the <code class="inlineCode">students</code> relationship of the <code class="inlineCode">Course</code> object. You are going to use the <code class="inlineCode">IsEnrolled</code> permission next.</p>
<h1 class="heading-1" id="_idParaDest-417">Serializing course contents</h1>
<p class="normal">You need to serialize course contents. The <code class="inlineCode">Content</code> model includes a generic foreign key that allows you to associate<a id="_idIndexMarker1418"/> objects of different content models. Yet, you added a common <code class="inlineCode">render()</code> method for all content models in the previous chapter. You can use this method to provide rendered content to your API.</p>
<p class="normal">Edit the <code class="inlineCode">api/serializers.py</code> file of the <code class="inlineCode">courses</code> application and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">from courses.models import <strong class="hljs-slc">Content, </strong>Course, Module, Subject
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">ItemRelatedField</strong><strong class="hljs-slc">(serializers.RelatedField):</strong>
<strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">to_representation</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self, value</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> value.render()</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">ContentSerializer</strong><strong class="hljs-slc">(serializers.ModelSerializer):</strong>
<strong class="hljs-slc">item = ItemRelatedField(read_only=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-slc">)</strong>
<strong class="hljs-keyword-slc">class</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">Meta</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc">model = Content</strong>
<strong class="hljs-slc">fields = [</strong><strong class="hljs-string-slc">'order'</strong><strong class="hljs-slc">, </strong><strong class="hljs-string-slc">'item'</strong><strong class="hljs-slc">]</strong>
</code></pre>
<p class="normal">In this code, you define a custom field by subclassing the <code class="inlineCode">RelatedField</code> serializer field provided by DRF and overriding the <code class="inlineCode">to_representation()</code> method. You define the <code class="inlineCode">ContentSerializer</code> serializer for the <code class="inlineCode">Content</code> model and use the custom field for the <code class="inlineCode">item</code> generic foreign key.</p>
<p class="normal">You need an alternative serializer for the <code class="inlineCode">Module</code> model that includes its contents, as well as an extended <code class="inlineCode">Course</code> serializer. Edit the <code class="inlineCode">api/serializers.py</code> file and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">class ModuleWithContentsSerializer(serializers.ModelSerializer):
    contents = ContentSerializer(many=True)
    class Meta:
        model = Module
        fields = ['order', 'title', 'description', 'contents']
class CourseWithContentsSerializer(serializers.ModelSerializer):
    modules = ModuleWithContentsSerializer(many=True)
    class Meta:
        model = Course
        fields = [
            'id',
            'subject',
            'title',
            'slug',
            'overview',
            'created',
            'owner',
            'modules'
        ]
</code></pre>
<p class="normal">Let’s create a view that mimics<a id="_idIndexMarker1419"/> the behavior of the <code class="inlineCode">retrieve()</code> action but includes the course contents. Edit the <code class="inlineCode">api/views.py</code> file and add the following method to the <code class="inlineCode">CourseViewSet</code> class:</p>
<pre class="programlisting code"><code class="hljs-code"># ...
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> courses.api.permissions </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> IsEnrolled</strong>
<strong class="hljs-keyword-slc">from</strong><strong class="hljs-slc"> courses.api.serializers </strong><strong class="hljs-keyword-slc">import</strong><strong class="hljs-slc"> CourseWithContentsSerializer</strong>
class CourseViewSet(viewsets.ReadOnlyModelViewSet):
    # ...
<strong class="hljs-meta-slc">    @action(</strong>
<strong class="hljs-meta-slc"> </strong><strong class="hljs-params-slc">detail=</strong><strong class="hljs-literal-slc">True</strong><strong class="hljs-params-slc">,</strong>
<strong class="hljs-params-slc"> </strong><strong class="hljs-meta-slc"> </strong><strong class="hljs-params-slc">methods=[</strong><strong class="hljs-string-slc">'get'</strong><strong class="hljs-params-slc">],</strong>
<strong class="hljs-params-slc"> </strong><strong class="hljs-meta-slc"> </strong><strong class="hljs-params-slc">serializer_class=CourseWithContentsSerializer,</strong>
<strong class="hljs-params-slc"> </strong><strong class="hljs-meta-slc"> </strong><strong class="hljs-params-slc">authentication_classes=[BasicAuthentication],</strong>
<strong class="hljs-params-slc"> </strong><strong class="hljs-meta-slc"> </strong><strong class="hljs-params-slc">permission_classes=[IsAuthenticated, IsEnrolled]</strong>
<strong class="hljs-params-slc"> </strong><strong class="hljs-meta-slc">)</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">def</strong><strong class="hljs-slc"> </strong><strong class="hljs-title-slc">contents</strong><strong class="hljs-slc">(</strong><strong class="hljs-params-slc">self, request, *args, **kwargs</strong><strong class="hljs-slc">):</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">return</strong><strong class="hljs-slc"> self.retrieve(request, *args, **kwargs)</strong>
</code></pre>
<p class="normal">The description of this method is as follows:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">You use the <code class="inlineCode">action</code> decorator with the parameter <code class="inlineCode">detail=True</code> to specify an action that is performed on a single object.</li>
<li class="numberedList">You specify that only the <code class="inlineCode">GET</code> method is allowed for this action.</li>
<li class="numberedList">You use the new <code class="inlineCode">CourseWithContentsSerializer</code> serializer class that includes rendered course contents.</li>
<li class="numberedList">You use both <code class="inlineCode">IsAuthenticated</code> and your custom <code class="inlineCode">IsEnrolled</code> permissions. By doing so, you make sure that only users enrolled in the course are able to access its contents.</li>
<li class="numberedList">You use the existing <code class="inlineCode">retrieve()</code> action to return the <code class="inlineCode">Course</code> object.</li>
</ol>
<p class="normal">Open <code class="inlineCode">http://127.0.0.1:8000/api/courses/1/contents/</code> in your browser. If you access the view with the right credentials, you will see that each module of the course includes the rendered HTML<a id="_idIndexMarker1420"/> for course contents, as follows:</p>
<pre class="programlisting code"><code class="hljs-code">{
"order": 0,
"title": "Introduction to Django",
"description": "Brief introduction to the Django Web Framework.",
"contents": [
{
"order": 0,
"item": "&lt;p&gt;Meet Django. Django is a high-level
            Python Web framework
            ...&lt;/p&gt;"
},
{
"order": 1,
"item": "\n&lt;iframe width=\"480\" height=\"360\"
            src=\"http://www.youtube.com/embed/bgV39DlmZ2U?
            wmode=opaque\"
            frameborder=\"0\" allowfullscreen&gt;&lt;/iframe&gt;\n"
}
]
}
</code></pre>
<p class="normal">You have built a simple API that allows other services to access the course application programmatically. DRF also allows you to handle creating and editing objects with the <code class="inlineCode">ModelViewSet</code> class. We have covered the main aspects of DRF, but you will find further information about its features in its extensive documentation at <a href="https://www.django-rest-framework.org/">https://www.django-rest-framework.org/</a>.</p>
<h1 class="heading-1" id="_idParaDest-418">Consuming the RESTful API</h1>
<p class="normal">Now that you have<a id="_idIndexMarker1421"/> implemented an API, you can consume it in a programmatic manner from other applications. You can interact with the API using the JavaScript Fetch API in the frontend of your application, in a similar fashion to the functionalities you built in <em class="italic">Chapter 6</em>, <em class="italic">Sharing Content on Your Website</em>. You can also consume the API from applications built with Python or any other programming language.</p>
<p class="normal">You are going to create a simple Python application that uses the RESTful API to retrieve all available courses and then enroll a student in all of them. You will learn how to authenticate against the API using HTTP basic authentication and perform <code class="inlineCode">GET</code> and <code class="inlineCode">POST</code> requests.</p>
<p class="normal">We will use the Python Requests library to<a id="_idIndexMarker1422"/> consume the API. We used Requests in <em class="italic">Chapter 6</em>, <em class="italic">Sharing Content on Your Website</em>, to retrieve images by their URL. Requests abstracts the complexity of dealing with HTTP requests and provides a very simple interface to consume HTTP services. You can find the documentation for the Requests library at <a href="https://requests.readthedocs.io/en/master/">https://requests.readthedocs.io/en/master/</a>.</p>
<p class="normal">Open the shell and install the Requests library with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python -m pip install requests==2.31.0
</code></pre>
<p class="normal">Create a new directory next to the <code class="inlineCode">educa</code> project directory and name it <code class="inlineCode">api_examples</code>. Create a new file inside the <code class="inlineCode">api_examples/</code> directory and name it <code class="inlineCode">enroll_all.py</code>. The file structure should now look like this:</p>
<pre class="programlisting con"><code class="hljs-con">api_examples/
    enroll_all.py
educa/
    ...
</code></pre>
<p class="normal">Edit the <code class="inlineCode">enroll_all.py</code> file and add the following code to it:</p>
<pre class="programlisting code"><code class="hljs-code">import requests
base_url = 'http://127.0.0.1:8000/api/'
url = f'{base_url}courses/'
available_courses = []
while url is not None:
    print(f'Loading courses from {url}')
    r = requests.get(url)
    response = r.json()
    url = response['next']
    courses = response['results']
    available_courses += [course['title'] for course in courses]
print(f'Available courses: {", ".join(available_courses)}')
</code></pre>
<p class="normal">In this code, you perform the following actions:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">You import the Requests library and define the base URL for the API and the URL for the course list API endpoint.</li>
<li class="numberedList">You define the <code class="inlineCode">available_courses</code> empty list.</li>
<li class="numberedList">You use a <code class="inlineCode">while</code> statement to <a id="_idIndexMarker1423"/>paginate over all result pages.</li>
<li class="numberedList">You use <code class="inlineCode">requests.get()</code> to retrieve data from the API by sending a <code class="inlineCode">GET</code> request to the URL <code class="inlineCode">http://127.0.0.1:8000/api/courses/</code>. This API endpoint is publicly accessible, so it does not require any authentication.</li>
<li class="numberedList">You use the <code class="inlineCode">json()</code> method of the response object to decode the JSON data returned by the API.</li>
<li class="numberedList">You store the <code class="inlineCode">next</code> attribute in the <code class="inlineCode">url</code> variable to retrieve the next page of results in the <code class="inlineCode">while</code> statement.</li>
<li class="numberedList">You add the <code class="inlineCode">title</code> attribute of each course to the <code class="inlineCode">available_courses</code> list.</li>
<li class="numberedList">When the <code class="inlineCode">url</code> variable is <code class="inlineCode">None</code>, you go to the latest page of results and you don’t retrieve any additional pages.</li>
<li class="numberedList">You print the list of available courses.</li>
</ol>
<p class="normal">Start the development server from the <code class="inlineCode">educa</code> project directory with the following command:</p>
<pre class="programlisting con"><code class="hljs-con">python manage.py runserver
</code></pre>
<p class="normal">In another shell, run the following command from the <code class="inlineCode">api_examples/</code> directory:</p>
<pre class="programlisting con"><code class="hljs-con">python enroll_all.py
</code></pre>
<p class="normal">You will see output with a list of all course titles, like this:</p>
<pre class="programlisting con"><code class="hljs-con">Available courses: Introduction to Django, Python for beginners, Algebra basics
</code></pre>
<p class="normal">This is the first automated call to your API.</p>
<p class="normal">Edit the <code class="inlineCode">enroll_all.py</code> file and add the following lines highlighted in bold:</p>
<pre class="programlisting code"><code class="hljs-code">import requests
<strong class="hljs-slc">username = </strong><strong class="hljs-string-slc">''</strong>
<strong class="hljs-slc">password = </strong><strong class="hljs-string-slc">''</strong>
base_url = 'http://127.0.0.1:8000/api/'
url = f'{base_url}courses/'
available_courses = []
while url is not None:
    print(f'Loading courses from {url}')
    r = requests.get(url)
    response = r.json()
    url = response['next']
    courses = response['results']
    available_courses += [course['title'] for course in courses]
print(f'Available courses: {", ".join(available_courses)}')
<strong class="hljs-keyword-slc">for</strong><strong class="hljs-slc"> course </strong><strong class="hljs-keyword-slc">in</strong><strong class="hljs-slc"> courses:</strong>
<strong class="hljs-slc">    course_id = course[</strong><strong class="hljs-string-slc">'id'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">    course_title = course[</strong><strong class="hljs-string-slc">'title'</strong><strong class="hljs-slc">]</strong>
<strong class="hljs-slc">    r = requests.post(</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-string-slc">f'</strong><strong class="hljs-subst-slc">{base_url}</strong><strong class="hljs-string-slc">courses/</strong><strong class="hljs-subst-slc">{course_id}</strong><strong class="hljs-string-slc">/enroll/'</strong><strong class="hljs-slc">,</strong>
<strong class="hljs-slc">        auth=(username, password)</strong>
<strong class="hljs-slc">    )</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-keyword-slc">if</strong><strong class="hljs-slc"> r.status_code == </strong><strong class="hljs-number-slc">200</strong><strong class="hljs-slc">:</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-comment-slc"># successful request</strong>
<strong class="hljs-slc"> </strong><strong class="hljs-built_in-slc">print</strong><strong class="hljs-slc">(</strong><strong class="hljs-string-slc">f'Successfully enrolled in </strong><strong class="hljs-subst-slc">{course_title}</strong><strong class="hljs-string-slc">'</strong><strong class="hljs-slc">)</strong>
</code></pre>
<p class="normal">Replace the values for the <code class="inlineCode">username</code> and <code class="inlineCode">password</code> variables with the credentials of an existing user, or load the values <a id="_idIndexMarker1424"/>from environment variables. You can use <code class="inlineCode">python-decouple</code>, as we did in the <em class="italic">Working with environment variables</em> section in <em class="italic">Chapter 2</em>, <em class="italic">Enhancing Your Blog and Adding Social Features</em>, to load credentials from environment variables.</p>
<p class="normal">With the new code, you perform the following actions:</p>
<ol class="numberedList" style="list-style-type: decimal;">
<li class="numberedList" value="1">You define the username and password of the student you want to enroll in courses.</li>
<li class="numberedList">You iterate over the available courses retrieved from the API.</li>
<li class="numberedList">You store the course ID attribute in the <code class="inlineCode">course_id</code> variable and the <code class="inlineCode">title</code> attribute in the <code class="inlineCode">course_title</code> variable.</li>
<li class="numberedList">You use <code class="inlineCode">requests.post()</code> to send a <code class="inlineCode">POST</code> request to the URL <code class="inlineCode">http://127.0.0.1:8000/api/courses/[id]/enroll/</code> for each course. This URL corresponds to the <code class="inlineCode">CourseEnrollView</code> API view, which allows you to enroll a user in a course. You build the URL for each course using the <code class="inlineCode">course_id</code> variable. The <code class="inlineCode">CourseEnrollView</code> view requires authentication. It uses the <code class="inlineCode">IsAuthenticated</code> permission and the <code class="inlineCode">BasicAuthentication</code> authentication class. The Requests library supports HTTP basic authentication out of the box. You use the <code class="inlineCode">auth</code> parameter to pass a tuple with the username and password to authenticate the user, using HTTP basic authentication.</li>
<li class="numberedList">If the status code of the response is <code class="inlineCode">200 OK</code>, you print a message to indicate that the user has been successfully enrolled in the course.</li>
</ol>
<p class="normal">You can use different kinds <a id="_idIndexMarker1425"/>of authentication with Requests. You can find more information on authentication with Requests at <a href="https://requests.readthedocs.io/en/master/user/authentication/">https://requests.readthedocs.io/en/master/user/authentication/</a>.</p>
<p class="normal">Run the following command from the <code class="inlineCode">api_examples/</code> directory:</p>
<pre class="programlisting con"><code class="hljs-con">python enroll_all.py
</code></pre>
<p class="normal">You will now see output like this:</p>
<pre class="programlisting con"><code class="hljs-con">Available courses: Introduction to Django, Python for beginners, Algebra basics
Successfully enrolled in Introduction to Django
Successfully enrolled in Python for beginners
Successfully enrolled in Algebra basics
</code></pre>
<p class="normal">Great! You have successfully enrolled the user in all available courses using the API. You will see a <code class="inlineCode">Successfully enrolled</code> message for each course on the platform. As you can see, it’s very easy to consume the API from any other application.</p>
<h1 class="heading-1" id="_idParaDest-419">Summary</h1>
<p class="normal">In this chapter, you learned how to use DRF to build a RESTful API for your project. You created serializers and views for models, and you built custom API views. You also added authentication to your API and restricted access to API views using permissions. Next, you discovered how to create custom permissions, and you implemented <code class="inlineCode">ViewSets</code> and routers. Finally, you used the Requests library to consume the API from an external Python script.</p>
<p class="normal">The next chapter will teach you how to build a chat server using Django Channels. You will implement asynchronous communication using WebSockets, and you will use Redis to set up a channel layer.</p>
<h1 class="heading-1" id="_idParaDest-420">Additional resources</h1>
<p class="normal">The following resources provide additional information related to the topics covered in this chapter:</p>
<ul>
<li class="bulletList">Source code for this chapter: <a href="https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter15">https://github.com/PacktPublishing/Django-5-by-example/tree/main/Chapter15</a></li>
<li class="bulletList">REST framework website: <a href="https://www.django-rest-framework.org/">https://www.django-rest-framework.org/</a></li>
<li class="bulletList">REST framework settings: <a href="https://www.django-rest-framework.org/api-guide/settings/">https://www.django-rest-framework.org/api-guide/settings/</a></li>
<li class="bulletList">REST framework serializers: <a href="https://www.django-rest-framework.org/api-guide/serializers/">https://www.django-rest-framework.org/api-guide/serializers/</a></li>
<li class="bulletList">REST framework renderers: <a href="https://www.django-rest-framework.org/api-guide/renderers/">https://www.django-rest-framework.org/api-guide/renderers/</a></li>
<li class="bulletList">REST framework parsers: <a href="https://www.django-rest-framework.org/api-guide/parsers/">https://www.django-rest-framework.org/api-guide/parsers/</a></li>
<li class="bulletList">REST framework generic mixins and views – <a href="https://www.django-rest-framework.org/api-guide/generic-views/ ">https://www.django-rest-framework.org/api-guide/generic-views/</a></li>
<li class="bulletList">Download <code class="inlineCode">curl</code>: <a href="https://curl.se/download.html">https://curl.se/download.html</a></li>
<li class="bulletList">Postman API platform: <a href="https://www.getpostman.com/">https://www.getpostman.com/</a></li>
<li class="bulletList">REST framework pagination: <a href="https://www.django-rest-framework.org/api-guide/pagination/ ">https://www.django-rest-framework.org/api-guide/pagination/</a></li>
<li class="bulletList">REST framework serializer relations: <a href="https://www.django-rest-framework.org/api-guide/relations/">https://www.django-rest-framework.org/api-guide/relations/</a></li>
<li class="bulletList">HTTP basic authentication: <a href="https://en.wikipedia.org/wiki/Basic_access_authentication">https://en.wikipedia.org/wiki/Basic_access_authentication</a></li>
<li class="bulletList">REST framework authentication: <a href="https://www.django-rest-framework.org/api-guide/authentication/">https://www.django-rest-framework.org/api-guide/authentication/</a></li>
<li class="bulletList">REST framework permissions: <a href="https://www.django-rest-framework.org/api-guide/permissions/">https://www.django-rest-framework.org/api-guide/permissions/</a></li>
<li class="bulletList">REST framework <code class="inlineCode">ViewSets</code>: <a href="https://www.django-rest-framework.org/api-guide/viewsets/">https://www.django-rest-framework.org/api-guide/viewsets/</a></li>
<li class="bulletList">REST framework routers: <a href="https://www.django-rest-framework.org/api-guide/routers/">https://www.django-rest-framework.org/api-guide/routers/</a></li>
<li class="bulletList">Python Requests library documentation: <a href="https://requests.readthedocs.io/en/master/">https://requests.readthedocs.io/en/master/</a></li>
<li class="bulletList">Authentication with the Requests library: <a href="https://requests.readthedocs.io/en/master/user/authentication/">https://requests.readthedocs.io/en/master/user/authentication/</a></li>
</ul>
</div>
</body></html>