<html><head></head><body>
<div id="sbo-rt-content"><div id="_idContainer157">
<h1 class="chapter-number" id="_idParaDest-199"><a id="_idTextAnchor206"/>8</h1>
<h1 id="_idParaDest-200"><a id="_idTextAnchor207"/>Animation Modifiers</h1>
<p>Animation curves, or F-Curves, can be altered by modifiers without having their keyframes changed. This way, cinematic or motion effects can replace the initial curve completely or add to its <span class="No-Break">original value.</span></p>
<p>The output of a modifier can be the input of another modifier, which, when combined, allows us to build complex results on top of <span class="No-Break">simple animations.</span></p>
<p>Python scripts can be used to help automate this and streamline <span class="No-Break">the workflow.</span></p>
<p>Changing a parameter affects the modifier’s result, while its overall <strong class="bold">Influence </strong>can be reduced using the slider in the <span class="No-Break">modifier interface.</span></p>
<p>In this chapter, you will learn how to add modifiers to animation F-Curves with your scripts and how to change <span class="No-Break">their parameters.</span></p>
<p>This chapter will cover the <span class="No-Break">following topics:</span></p>
<ul>
<li>Understanding F-Curve Modifiers in the <span class="No-Break">Blender UI</span></li>
<li>Adding F-Curve Modifiers <span class="No-Break">via Python</span></li>
<li>Using F-Curve Modifiers in <span class="No-Break">our add-ons</span></li>
</ul>
<h1 id="_idParaDest-201"><a id="_idTextAnchor208"/>Technical requirements</h1>
<p>We will use Blender and Visual Studio Code in this chapter. The examples created in this chapter can be found <span class="No-Break">at </span><a href="https://github.com/PacktPublishing/Python-Scripting-in-Blender/tree/main/ch8"><span class="No-Break">https://github.com/PacktPublishing/Python-Scripting-in-Blender/tree/main/ch8</span></a><span class="No-Break">.</span></p>
<h1 id="_idParaDest-202"><a id="_idTextAnchor209"/>Using F-Curve Modifiers</h1>
<p>Modifiers for <a id="_idIndexMarker565"/>animation curves, called <strong class="bold">F-Curve Modifiers</strong> or <strong class="bold">F-Modifiers</strong>, add <a id="_idIndexMarker566"/>non-destructive changes to animations <a id="_idIndexMarker567"/>while preserving their original data. We examined similar functionality in <strong class="bold">Object Constraints</strong> in <a href="B18375_04.xhtml#_idTextAnchor075"><span class="No-Break"><em class="italic">Chapter 4</em></span></a>, where we learned how to affect an object’s position without changing the values stored in <span class="No-Break">its channels.</span></p>
<p>Like object <a id="_idIndexMarker568"/>constraints, F-Modifiers are exposed to Python scripts through a <span class="No-Break">collection property.</span></p>
<p>Before we delve into how F-Modifiers are scripted, we will have a look at how to create them in the <span class="No-Break"><strong class="bold">Graph Editor</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-203"><a id="_idTextAnchor210"/>Adding F-Curve Modifiers in the Graph Editor</h2>
<p>We will now <a id="_idIndexMarker569"/>look at how to add variation <a id="_idIndexMarker570"/>to an animated object using <span class="No-Break">F-Curve Modifiers.</span></p>
<p>For this example, we will use the <strong class="source-inline">ani_loop.blend</strong> scene, from the accompanying <strong class="source-inline">PythonScriptingBlender/ch8/_scenes_</strong> folder, but you can use <span class="No-Break">any scene.</span></p>
<p>The animation along the <em class="italic">8</em>-shaped path in <strong class="source-inline">ani_loop.blend</strong> wasn’t created by hand: it was generated using the <strong class="bold">Vert Runner</strong> add-on developed in <a href="B18375_07.xhtml#_idTextAnchor171"><span class="No-Break"><em class="italic">Chapter 7</em></span></a><span class="No-Break">.</span></p>
<p>We will add some variation to the path of an animated object by creating an F-Curve Modifier in <span class="No-Break"><strong class="bold">Graph Editor</strong></span><span class="No-Break">:</span></p>
<ol>
<li>Select an <span class="No-Break">animated object.</span></li>
<li>Change one of the UI areas to <strong class="bold">Graph Editor</strong>. A good place is the left Viewport in the <span class="No-Break"><strong class="bold">Animation Workspace</strong></span><span class="No-Break">.</span></li>
<li>In the <strong class="bold">Graph Editor</strong> left panel, select the <strong class="bold">X </strong><span class="No-Break"><strong class="bold">Location</strong></span><span class="No-Break"> channel.</span></li>
<li>Press <em class="italic">N</em> to display the property tabs. Make sure that the <strong class="bold">Graph Editor</strong> has focus and is large enough, or the tabs will not <span class="No-Break">show up.</span></li>
<li>In the right panel of the<strong class="bold"> Graph Editor</strong>, select the <span class="No-Break"><strong class="bold">Modifiers</strong></span><span class="No-Break"> tab.</span></li>
<li>From the <strong class="bold">Modifiers</strong> tab, select a modifier from the <strong class="bold">Add Modifier</strong> menu. In this example, we will use the <strong class="bold">Stepped </strong><span class="No-Break"><strong class="bold">Interpolation </strong></span><span class="No-Break">modifier.</span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer155">
<img alt="Figure 8.1: Adding curve modifiers in the Graph Editor" height="516" src="image/Figure_8.01_B18375.jpg" width="1096"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.1: Adding curve modifiers in the Graph Editor</p>
<p>The animation <a id="_idIndexMarker571"/>curve for <strong class="bold">Z Location</strong> changes <a id="_idIndexMarker572"/>to a stepped graph. If we play the animation now, we will see the object proceeding in little jumps rather than smoothly, <span class="No-Break">as before.</span></p>
<div>
<div class="IMG---Figure" id="_idContainer156">
<img alt="Figure 8.2: Stepped modifier applied on a smooth curve" height="516" src="image/Figure_8.02_B18375.jpg" width="1096"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 8.2: Stepped modifier applied on a smooth curve</p>
<p>The Blender manual describes modifiers in detail on the <strong class="bold">F-Curve </strong><span class="No-Break"><strong class="bold">Modifiers</strong></span><span class="No-Break"> page:</span></p>
<p><a href="https://docs.blender.org/manual/en/3.2/editors/graph_editor/fcurves/modifiers.xhtml%0D"><span class="No-Break">docs.blender.org/manual/en/3.2/editors/graph_editor/fcurves/modifiers.xhtml</span></a></p>
<p>There are seven available types. The first two generate curves based on <span class="No-Break">mathematical formulas:</span></p>
<ul>
<li><strong class="bold">Generator</strong>: Expressions for lines, parabolas, and curves of <span class="No-Break">higher degrees</span></li>
<li><strong class="bold">Built-in</strong>: Trigonometric and <span class="No-Break">logarithmic formulas</span></li>
</ul>
<p>The other five cover some basic <span class="No-Break">animation tasks:</span></p>
<ul>
<li><strong class="bold">Envelope</strong>: Control points for editing the overall shape of <span class="No-Break">the curve</span></li>
<li><strong class="bold">Cyclic</strong>: To repeat animations in loops after their <span class="No-Break">last frame</span></li>
<li><strong class="bold">Noise</strong>: Adds random jitter to <span class="No-Break">the animation</span></li>
<li><strong class="bold">Limits</strong>: Limits the animation values to <span class="No-Break">a range</span></li>
<li><strong class="bold">Stepped Interpolation</strong>: Converts smooth animation to <span class="No-Break">jerky motion</span></li>
</ul>
<p>Like constraints, modifiers <a id="_idIndexMarker573"/>of an F-Curve are exposed <a id="_idIndexMarker574"/>to Python as a collection. We can use the <strong class="source-inline">fcurve.modifiers.new</strong> method to add new modifiers <span class="No-Break">via scripting.</span></p>
<h2 id="_idParaDest-204"><a id="_idTextAnchor211"/>Adding F-Curve Modifiers in Python</h2>
<p>The <strong class="source-inline">fcurve.modifiers.new(type)</strong> method creates a new modifier according to the type <a id="_idIndexMarker575"/>provided in the argument. It returns the <span class="No-Break">new modifier.</span></p>
<p>With the <a id="_idIndexMarker576"/>exception of <strong class="bold">Built-in</strong> and <strong class="bold">Stepped Interpolation</strong>, the respective keywords for which are <strong class="source-inline">FNGENERATOR</strong> and <strong class="source-inline">STEPPED</strong>, modifiers of a given type are created using the type name in <span class="No-Break">uppercase letters:</span></p>
<pre class="source-code">
type <a id="_idTextAnchor212"/>(enum in ['GENERATOR', 'FNGENERATOR', 'ENVELOPE', 'CYCLES', 'NOISE', 'LIMITS', 'STEPPED'])</pre>
<p>So, to add a <strong class="source-inline">'STEPPED'</strong> modifier to the <strong class="bold">Z Location</strong> curve, that is, the third F-Curve of an animated object (index <strong class="source-inline">2</strong>), we use <span class="No-Break">the following:</span></p>
<pre class="source-code">
&gt;&gt;&gt; import bpy
&gt;&gt;&gt; anim_data = bpy.context.object.animation_data
&gt;&gt;&gt; m = anim_data.action.fcurves[<strong class="bold">2</strong>].modifiers.<strong class="bold">new</strong>('STEPPED')</pre>
<p>Likewise, a modifier can be removed using the <strong class="source-inline">fcurve.modifiers.remove</strong> method. This time, the Python instance of the modifier must be used as <span class="No-Break">an argument:</span></p>
<pre class="source-code">
&gt;&gt;&gt; anim_data.action.fcurves[2].modifiers.remove(m)</pre>
<p>Now that <a id="_idIndexMarker577"/>we have learned where F-Modifiers can <a id="_idIndexMarker578"/>be found, how they work, and how to add more of them, both in the user interface and the Python Console, we can use this knowledge in <span class="No-Break">our scripts.</span></p>
<p>The add-on we will write in the next section allows us to create shaky animations <span class="No-Break">using F-Modifiers.</span></p>
<h1 id="_idParaDest-205"><a id="_idTextAnchor213"/>Writing the Shaker add-on</h1>
<p>The <strong class="bold">Shaker</strong> add-on <a id="_idIndexMarker579"/>creates a shaky effect on the active object by adding noise modifiers to its <span class="No-Break">animation curves.</span></p>
<p>There are cases when we want to add some shaking to a motion. For instance, directors often use a <em class="italic">camera shake</em> to suggest an object being bumped or hit. Another use case is the bumpy motion of a vehicle, or hairs and feathers in a windy environment. The Python script we are going to write will contain an operator and a menu function for <span class="No-Break">quick execution.</span></p>
<h2 id="_idParaDest-206"><a id="_idTextAnchor214"/>Setting up the environment</h2>
<p>We first create <a id="_idIndexMarker580"/>a Python script for <span class="No-Break">our add-on:</span></p>
<ol>
<li>Create the <strong class="source-inline">PythonScriptingBlender/ch8/addons</strong> folder. We can use the file manager or the <strong class="bold">File</strong> tab of our code editor, such as <span class="No-Break"><strong class="bold">VS Code</strong></span><span class="No-Break">.</span></li>
<li>Create a new file in that folder and name it <strong class="source-inline">object_shaker.py</strong>. We can use the file manager or the <strong class="bold">New File</strong> button of our <span class="No-Break">code editor.</span></li>
<li>Open the file in your editor <span class="No-Break">of choice.</span></li>
<li>Set the <strong class="bold">Scripts</strong> path to <strong class="source-inline">PythonScriptingBlender/ch8</strong> in the Blender <strong class="bold">File </strong><span class="No-Break"><strong class="bold">Paths</strong></span><span class="No-Break"> preferences.</span></li>
</ol>
<p>Now, we will start writing the add-on code <span class="No-Break">as usual.</span></p>
<h2 id="_idParaDest-207"><a id="_idTextAnchor215"/>Writing the Shaker add-on info</h2>
<p>We will add <a id="_idIndexMarker581"/>our new operator, <strong class="bold">Object Shaker</strong>, to the right-click object menu. We can write the instructions on how to run the operator in the <strong class="source-inline">location</strong> attribute of the <span class="No-Break">add-on info:</span></p>
<pre class="source-code">
bl_info = {
    "name": "<strong class="source-inline">Object Shaker</strong>",
    "author": "Packt Man",
    "version": (1, 0),
    "blender": (3, 00, 0),
    "description": "Add Shaky motion to active object",
    "location": "<strong class="source-inline">Object Right Click -&gt; Add Object Shake</strong>",
    "category": "Learning",
}</pre>
<h2 id="_idParaDest-208"><a id="_idTextAnchor216"/>Writing the Add Object Shake operator class</h2>
<p>We import <a id="_idIndexMarker582"/>the <strong class="source-inline">bpy</strong> module, then write the <strong class="source-inline">bl_*</strong> identifiers of <span class="No-Break"><strong class="source-inline">Object Shaker</strong></span><span class="No-Break">:</span></p>
<pre class="source-code">
import bpy
class <strong class="source-inline">ObjectShaker</strong>(bpy.types.Operator):
    """Set Playback range to current action Start/End"""
    bl_idname = "object.shaker_animation"
    bl_label = "Add Object Shake"
    bl_description = "Add Shake Motion to Active Object"
    bl_options = {'REGISTER', 'UNDO'}</pre>
<p>This operator needs two <span class="No-Break">float parameters:</span></p>
<ul>
<li>Noise <strong class="source-inline">duration</strong> <span class="No-Break">in seconds</span></li>
<li>Noise <strong class="source-inline">strength</strong>, that is, how much this modifier contributes to <span class="No-Break">the animation</span></li>
</ul>
<p><strong class="source-inline">duration</strong> should be a positive number: there is no such thing as a negative amount of time. So, we set <strong class="source-inline">0.0</strong> as the property minimum. The amount of shaking, on the other hand, could <a id="_idIndexMarker583"/>benefit from values below <strong class="source-inline">0.0</strong> or above <strong class="source-inline">1.0</strong>. It’s a more peculiar circumstance in which we still want to set the range of values from <strong class="source-inline">0.0</strong> to <strong class="source-inline">1.0</strong> as the ordinary condition, but we don’t want to prevent the user from going beyond those limits if they want to. We can set limits that apply to the slider but accept an out-of-range numerical input using the <strong class="source-inline">soft_min</strong> and <span class="No-Break"><strong class="source-inline">soft_max</strong></span><span class="No-Break"> parameters.</span></p>
<h3>Adding limits and soft limits to properties</h3>
<p>Normally, the influence, or <strong class="source-inline">strength</strong>, of the modifier, should range between <strong class="source-inline">0.0</strong> and <strong class="source-inline">1.0</strong> (meaning no influence and full influence, respectively) but using values outside that range has <a id="_idIndexMarker584"/>a multiplicative effect. For instance, an influence of <strong class="source-inline">2.0</strong> doubles the <span class="No-Break">modifier’s contribution.</span></p>
<p>Soft limits for Blender properties are useful in this case: <strong class="source-inline">min</strong>, <strong class="source-inline">max</strong>, <strong class="source-inline">soft_min</strong>, and <strong class="source-inline">soft_max</strong> limit the range of the slider in the interface, but while <strong class="source-inline">min</strong> and <strong class="source-inline">max</strong> never accept any number exceeding their range, <strong class="source-inline">soft_min</strong> and <strong class="source-inline">soft_max</strong> allow the user to click on the slider and type any value they wish using <span class="No-Break">the keyboard.</span></p>
<p>Values exceeding the initial <strong class="source-inline">soft_min</strong> and <strong class="source-inline">soft_max</strong> parameters are considered valid input and become the new range of <span class="No-Break">the slider:</span></p>
<pre class="source-code">
    duration: bpy.props.FloatProperty(default=1.0, <strong class="source-inline">min=0</strong>)
    strenght: bpy.props.FloatProperty(default=1.0,
                                      <strong class="source-inline">soft_min=0</strong>,
                                      <strong class="source-inline">soft_max=1.0</strong>)</pre>
<p>Now, we can write the <strong class="source-inline">poll</strong> method for verifying the conditions and the <strong class="source-inline">execute</strong> method to perform the action of <span class="No-Break">adding noise.</span></p>
<h2 id="_idParaDest-209"><a id="_idTextAnchor217"/>Writing the operator methods</h2>
<p>Besides the <a id="_idIndexMarker585"/>usual <strong class="source-inline">poll</strong> and <strong class="source-inline">execute</strong> methods, we will write a utility function for finding the F-Curve of a <span class="No-Break">given property.</span></p>
<h3>Writing the poll method</h3>
<p>The condition <a id="_idIndexMarker586"/>for the <strong class="source-inline">poll</strong> method is very simple – the operator can be invoked if there is an <span class="No-Break">active object:</span></p>
<pre class="source-code">
    @classmethod
    def poll(cls, context):
        return bool(context.object)</pre>
<p>We need an <a id="_idIndexMarker587"/>animated property to add a noise modifier. If it is already animated, we pick the existing animation curve, otherwise, we create a new one. This operation can be implemented as a separate function, named <strong class="source-inline">get_fcurve</strong>, which takes <strong class="source-inline">data_path</strong> as an argument and returns its animation curve. It creates a new curve if it doesn’t <span class="No-Break">exist yet.</span></p>
<h3>Writing the get_fcurve method</h3>
<p>We delegate <a id="_idIndexMarker588"/>the task of finding or creating a property animation curve to the <strong class="source-inline">get_fcurve</strong> function. Since it will be <a id="_idIndexMarker589"/>used by the <strong class="source-inline">ObjectShaker</strong> operator alone, we write it as a class method, with <strong class="source-inline">self</strong> as its first argument. We might want to use it on more than one property and object, so we also pass the object to inspect and <strong class="source-inline">data_path</strong> of the property to animate. In case of vector properties, we pass the <strong class="source-inline">index</strong> component as well. We use <strong class="source-inline">obj</strong> rather than <strong class="source-inline">object</strong> as a parameter name because the latter represents the Python basic class, a term we don’t want <span class="No-Break">to override.</span></p>
<p>We know from <a href="B18375_07.xhtml#_idTextAnchor171"><span class="No-Break"><em class="italic">Chapter 7</em></span></a>, that F-Curves belong to an action, and our operator adds noise to the current action, so this function will look for the <strong class="source-inline">action</strong> attribute of the object’s animation data. Before we run <strong class="source-inline">get_fcurve</strong>, we should make sure that such an action exists, so, in line with the <em class="italic">Defensive Programming</em> practice learned in <a href="B18375_06.xhtml#_idTextAnchor129"><span class="No-Break"><em class="italic">Chapter 6</em></span></a>, we use <strong class="source-inline">assert</strong> to halt the script if, for unforeseen reasons, no current action <span class="No-Break">is found:</span></p>
<pre class="source-code">
    def get_fcurve(self, <strong class="source-inline">obj</strong>, <strong class="source-inline">data_path</strong>, <strong class="source-inline">index</strong>):
        """Returns F-Curve of given data_path/index"""
        action = obj.animation_data.action
        <strong class="source-inline">assert action</strong></pre>
<p>Now we <a id="_idIndexMarker590"/>need to return the F-Curve that animates the <strong class="source-inline">data_path</strong> instance provided as an argument, and create <a id="_idIndexMarker591"/>it if it doesn’t exist. We can attempt its creation using <strong class="source-inline">try</strong>, a statement learned in the <em class="italic">Improving our code</em> section of <a href="B18375_03.xhtml#_idTextAnchor049"><span class="No-Break"><em class="italic">Chapter 3</em></span></a><span class="No-Break">.</span></p>
<p>Trying to create two F-Curves with the same path causes a <strong class="source-inline">RuntimeError</strong> error, which, in a <strong class="source-inline">try</strong> statement, triggers the <strong class="source-inline">except</strong> clause. By looking for existing curves only if we need to, our code will be leaner and <span class="No-Break">slightly faster.</span></p>
<p>Under the <strong class="source-inline">except</strong> statement, we use the <strong class="source-inline">next</strong> function on a conditional <em class="italic">iterator</em>, that is, a sequence of objects that satisfy our criteria, in this case, a matching <strong class="source-inline">data_path</strong> <span class="No-Break">and </span><span class="No-Break"><strong class="source-inline">index</strong></span><span class="No-Break">:</span></p>
<pre class="source-code">
        <strong class="source-inline">try</strong>:
            crv = action.fcurves.new(data_path,index=index)
        <strong class="source-inline">except RuntimeError</strong>:
            crv = <strong class="source-inline">next</strong>(fc for fc in action.fcurves
                       if fc.data_path == <strong class="source-inline">data_path</strong> and
                          fc.array_index == <strong class="source-inline">index</strong>)</pre>
<p>In either case, we will end up with the <strong class="source-inline">crv</strong> variable containing the F-Curve we are looking for. We could have used a <strong class="source-inline">for</strong> loop to iterate <strong class="source-inline">action.fcurves</strong>, but the <strong class="source-inline">next</strong> function provides a valid and <span class="No-Break">compact alternative.</span></p>
<h4>Scrolling through collections efficiently</h4>
<p>The <strong class="source-inline">next</strong> function <a id="_idIndexMarker592"/>returns the first valid element of a sequence. For example, typing <strong class="source-inline">next(action.fcurves)</strong> simply gives the first curve of an action. The argument of <strong class="source-inline">next</strong> can be any iterator, though, not just a list or a collection. Since iterators can contain conditional statements such as <strong class="source-inline">if</strong>, <strong class="source-inline">next</strong> can be a concise and performant alternative to <span class="No-Break"><strong class="source-inline">for</strong></span><span class="No-Break"> loops.</span></p>
<p>While <strong class="source-inline">fc for fc in action.fcurves</strong> scrolls all the elements of <strong class="source-inline">fcurves</strong>, the conditions on <strong class="source-inline">fc.data_path</strong> and <strong class="source-inline">fc.array_index</strong> ensure that the first curve that complies with those requirements <span class="No-Break">is returned.</span></p>
<p>If no curve <a id="_idIndexMarker593"/>is found, <strong class="source-inline">next</strong> fails with a <strong class="source-inline">StopIteration</strong> error, but we know that it will not happen: an existing curve brought us to the <strong class="source-inline">except</strong> block of this <strong class="source-inline">try</strong> statement in the first place. So, either under the <strong class="source-inline">try</strong> block or under <strong class="source-inline">except</strong>, the <strong class="source-inline">crv</strong> variable now contains the F-Curve we are looking for. Before we add a modifier to it, we must make sure that it contains at least <span class="No-Break">one keyframe.</span></p>
<h4>Ensuring the presence of keyframes</h4>
<p>At this point, we have stored an animation curve in the <strong class="source-inline">crv</strong> variable, but we must look for its keyframe points, or it will not be evaluated. If the <strong class="source-inline">keyframe_points</strong> collection is empty, we add <a id="_idIndexMarker594"/>keyframes to it by using <strong class="source-inline">keyframe_points.insert</strong>. We will use the current frame and value <span class="No-Break">as arguments:</span></p>
<pre class="source-code">
        if <strong class="source-inline">not</strong> crv.<strong class="source-inline">keyframe_points</strong>:
            crv.keyframe_points.<strong class="source-inline">insert</strong>(
                         frame=context.scene.<strong class="source-inline">frame_current</strong>,
                         value=<strong class="source-inline">getattr</strong>(obj,
                                       <strong class="source-inline">data_path</strong>)<strong class="source-inline">[index]</strong>)</pre>
<p>Now that we have an animation curve and it is guaranteed to support modifiers, we can return the <strong class="source-inline">crv</strong> variable and exit the <span class="No-Break"><strong class="source-inline">get_fcurve</strong></span><span class="No-Break"> function:</span></p>
<pre class="source-code">
        return crv</pre>
<p>This function will be called in the <strong class="source-inline">execute</strong> method, the last missing piece of <span class="No-Break">the operator.</span></p>
<h3>Writing the execute method</h3>
<p>If our object <a id="_idIndexMarker595"/>has not been animated yet, we create new <strong class="source-inline">animation_data</strong>, otherwise, we <a id="_idIndexMarker596"/>store the existing data in the <span class="No-Break"><strong class="source-inline">anim</strong></span><span class="No-Break"> variable:</span></p>
<pre class="source-code">
    def execute(self, context):
        <strong class="source-inline">if not</strong> context.object.animation_data:
            anim = context.object.animation_data_create()
        <strong class="source-inline">else</strong>:
            anim = context.object.animation_data</pre>
<p>Likewise, we <a id="_idIndexMarker597"/>should create a <a id="_idIndexMarker598"/>new action if there isn’t one yet or get the current one. In either case, it is going to be stored in the <span class="No-Break"><strong class="source-inline">action</strong></span><span class="No-Break"> variable:</span></p>
<pre class="source-code">
        if not anim.action:
            action = bpy.data.actions.new('ShakeMotion')
            anim.action = action
        else:
            action = anim_data.action</pre>
<p>Now, it’s finally time to add some shaking motion. First, we need to express the duration of the effect in frames, rather than seconds. To do that, we multiply the <strong class="source-inline">duration</strong> parameter by the frames-per-second of the scene. Once we have the duration in frames, we divide it by half to center the object shake around the current frame; half of the frames will be played before it, while the second half will be <span class="No-Break">played afterward:</span></p>
<pre class="source-code">
        fps = context.scene.render.fps
        duration_frames = <strong class="source-inline">self.duration * fps / 2</strong>
        current = context.scene.frame_current
        start = current – duration_frames
        end = current + duration_frames</pre>
<p>The next step is looking for the animation curves that we want to alter: <strong class="source-inline">location</strong> Z, <strong class="source-inline">rotation_euler</strong> X, and <strong class="source-inline">rotation_euler</strong> Y. We need these ones specifically as they represent the up-down shake, yaw shake, and pitch shake of a <span class="No-Break">camera, respectively.</span></p>
<p>If they don’t exist, our <strong class="source-inline">get_fcurve</strong> method creates and <span class="No-Break">returns them:</span></p>
<pre class="source-code">
        <strong class="source-inline">z</strong>_loc_crv = self.<strong class="source-inline">get_fcurve</strong>(context,
                                    'location',
                                    index=<strong class="source-inline">2</strong>)
        <strong class="source-inline">x</strong>_rot_crv = self.<strong class="source-inline">get_fcurve</strong>(context,
                                    'rotation_euler',
                                    index=<strong class="source-inline">0</strong>)
        <strong class="source-inline">y</strong>_rot_crv = self.<strong class="source-inline">get_fcurve</strong>(context,
                                    'rotation_euler',
                                    index=<strong class="source-inline">1</strong>)</pre>
<p>Since F-Modifiers are specific to each curve, we create a <strong class="source-inline">NOISE</strong> modifier for each of them. We <a id="_idIndexMarker599"/>use a <strong class="source-inline">for</strong> loop to create all three at once. The noise <strong class="source-inline">strength</strong> value, a float attribute, can be set directly from the <strong class="source-inline">strength</strong> parameter <a id="_idIndexMarker600"/>of the operator, while we computed the <strong class="source-inline">start</strong> and <strong class="source-inline">end</strong> values for the <span class="No-Break">noise earlier:</span></p>
<pre class="source-code">
        <strong class="source-inline">for crv</strong> in z_loc_crv, y_rot_crv, x_rot_crv:
            noise = crv.modifiers.new(<strong class="source-inline">'NOISE'</strong>)
            noise.<strong class="source-inline">strength</strong> = self.<strong class="source-inline">strenght</strong>
            noise.<strong class="source-inline">use_restricted_range</strong> = True
            noise.frame_start = start
            noise.frame_end = end
        return {'FINISHED'}</pre>
<p>We have turned <strong class="source-inline">use_restricted_range</strong> on to limit the noise in our <strong class="source-inline">start</strong> and <strong class="source-inline">end</strong> frames: the <strong class="source-inline">frame_start</strong> and <strong class="source-inline">frame_end</strong> attributes would have no effect otherwise. Once we have set F-Modifiers for the three curves, we can finally exit <span class="No-Break">the method.</span></p>
<p>Now that our operator is complete, we can add a menu item to the interface and the <span class="No-Break"><strong class="source-inline">register</strong></span><span class="No-Break">/</span><span class="No-Break"><strong class="source-inline">unregister</strong></span><span class="No-Break"> functions.</span></p>
<h2 id="_idParaDest-210"><a id="_idTextAnchor218"/>Adding menu items</h2>
<p>As we learned <a id="_idIndexMarker601"/>when writing interfaces, a menu function takes <strong class="source-inline">self</strong> and <strong class="source-inline">context</strong> <span class="No-Break">as arguments.</span></p>
<p>Inside the menu function, we add a separator and the <strong class="source-inline">ObjectShaker</strong> operator <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">self.layout</strong></span><span class="No-Break">:</span></p>
<pre class="source-code">
def m_items(self, context):
    self.layout.separator()
    <strong class="source-inline">self.layout.operator</strong>(ObjectShaker.<strong class="source-inline">bl_idname</strong>)</pre>
<p>This function can then be added to any menu, but since our operator affects the animation of object transforms, we can use the right-click menu displayed by the Viewport in <span class="No-Break"><strong class="bold">Object Mode</strong></span><span class="No-Break">.</span></p>
<h2 id="_idParaDest-211"><a id="_idTextAnchor219"/>Finding the class names of context menus</h2>
<p>The API <a id="_idIndexMarker602"/>documentation doesn’t contain a list of all menus. We can look for them in <strong class="source-inline">bpy.types</strong>, which contains all the Blender classes, and keep in mind that the class name we are looking for starts with <strong class="source-inline">VIEW3D_MT</strong> and ends <span class="No-Break">with </span><span class="No-Break"><strong class="source-inline">_context_menu</strong></span><span class="No-Break">.</span></p>
<p>We can use these criteria in a <em class="italic">list comprehension</em>, that is, a list-like object delimited by square brackets that, like the <strong class="source-inline">next</strong> function we have met earlier in this section, is built with a conditional iterator. We can run it in Blender’s <span class="No-Break"><strong class="bold">Python Console</strong></span><span class="No-Break">:</span></p>
<pre class="source-code">
&gt;&gt;&gt; [c for c in dir(bpy.types) if
     c.endswith('context_menu')]</pre>
<p>Among the listed context menus, we <span class="No-Break">find </span><span class="No-Break"><strong class="source-inline">VIEW3D_MT_object_context_menu</strong></span><span class="No-Break">:</span></p>
<pre class="source-code">
['ASSETBROWSER_MT_context_menu',
...
['VIEW3D_MT_edit_metaball_context_menu', 'VIEW3D_MT_gpencil_edit_context_menu', 'VIEW3D_MT_object_context_menu', 'VIEW3D_MT_particle_context_menu',
...</pre>
<p>In returning the results that match the <strong class="source-inline">context_menu</strong> suffix, our list comprehension acted <a id="_idIndexMarker603"/>almost like a small search engine. To filter the result even further, we can add an <strong class="source-inline">"object"</strong> string as a requirement to filter the output to <span class="No-Break">one result:</span></p>
<pre class="source-code">
[c for c in dir(bpy.types)if c.endswith('context_menu')
                          and 'object' in c]</pre>
<p>This list comprehension narrows the results down to the object context <span class="No-Break">menu only:</span></p>
<pre class="source-code">
&gt;&gt;&gt; [c for c in dir(bpy.types)if c.endswith('context_menu')
...                           and 'object' in c]
['VIEW3D_MT_object_context_menu']</pre>
<p>Now that we know which menu class to use, we can move to registering <span class="No-Break">the add-on.</span></p>
<h2 id="_idParaDest-212"><a id="_idTextAnchor220"/>Registering the Shaker add-on</h2>
<p>Enabling the <a id="_idIndexMarker604"/>add-on produces these <span class="No-Break">two results:</span></p>
<ul>
<li>Adds the <strong class="source-inline">ObjectShaker</strong> class <span class="No-Break">to Blender</span></li>
<li>Adds the <strong class="source-inline">m_items</strong> function to the object <span class="No-Break">right-click menu</span></li>
</ul>
<p>Each of those tasks happen in the <span class="No-Break"><strong class="source-inline">register</strong></span><span class="No-Break"> function:</span></p>
<pre class="source-code">
def register():
    bpy.utils.register_class(<strong class="source-inline">ObjectShaker</strong>)
    bpy.types.<strong class="source-inline">VIEW3D_MT_object_context_menu</strong>.append(m_items)</pre>
<p>Following the same logic, when the add-on is disabled, its code is purged from Blender, upon which <strong class="source-inline">m_items</strong> should be removed from the menu and <strong class="source-inline">ObjectShaker</strong> from the registered classes. Failing to do so would leave orphan entities in Blender. The <strong class="source-inline">unregister</strong> function takes care <span class="No-Break">of that:</span></p>
<pre class="source-code">
def unregister():
    bpy.types.VIEW3D_MT_object_context_menu.remove(m_items)
    bpy.utils.unregister_class(ObjectShaker)</pre>
<p>We can refresh <a id="_idIndexMarker605"/>the add-ons using the <strong class="bold">Refresh</strong> button in the <strong class="bold">Add-ons</strong> preferences and enable <strong class="bold">Object Shaker</strong> from the <strong class="bold">Learning</strong> category. When the add-on is enabled, the <strong class="bold">Add Object Shake</strong> option appears in the given object’s <span class="No-Break">right-click menu.</span></p>
<h2 id="_idParaDest-213"><a id="_idTextAnchor221"/>Using the Shaker add-on</h2>
<p>Using our <a id="_idIndexMarker606"/>add-on, we can add a shaking motion to any object by following <span class="No-Break">these steps:</span></p>
<ol>
<li>Make the <span class="No-Break">object active.</span></li>
<li>Right-click (or press <strong class="source-inline">W</strong> if <strong class="bold">Select with Mouse Button</strong> was set to<a id="_idTextAnchor222"/> <strong class="bold">Right</strong> in <strong class="bold">Preferences</strong> | <span class="No-Break"><strong class="bold">Keymap</strong></span><span class="No-Break">).</span></li>
<li>Select <strong class="bold">Add Object Shake</strong> from <span class="No-Break">the menu.</span></li>
<li>Adjust the <strong class="bold">duration</strong> and <strong class="bold">strength</strong> values in the <span class="No-Break"><strong class="bold">Execution </strong></span><span class="No-Break">panel.</span></li>
</ol>
<p>Like with the <em class="italic">Action Range add-on</em> from <a href="B18375_07.xhtml#_idTextAnchor171"><span class="No-Break"><em class="italic">Chapter 7</em></span></a>, the selected amount of <strong class="bold">duration</strong> and <a id="_idTextAnchor223"/><strong class="bold">strength</strong> can be changed after execution using <strong class="bold">Edit</strong> | <strong class="bold">Adjust Last Operation</strong> from the <span class="No-Break">top bar.</span></p>
<p>We have created a tool that adds a procedural behavior to an object using animation modifiers. This is a valuable shortcut when animating with Python. Moreover, it introduces us to the concept of a non-destructive modifier, that is, adding parametric changes that can be removed or edited <span class="No-Break">at will.</span></p>
<h1 id="_idParaDest-214"><a id="_idTextAnchor224"/>Summary</h1>
<p>We have learned how to create animation effects for our scenes and have seen how we can convert an idea into a procedural tool. Artists and technical animators can come up with convoluted conceptual configurations, which we can turn into quick-setup operators following the process outlined in <span class="No-Break">this chapter.</span></p>
<p>Using the animation system is a convenient way to implement parametric behaviors, as it relies on the application update logic and produces fast, <span class="No-Break">reliable outputs.</span></p>
<p>We will explore a similar but more powerful technique in <a href="B18375_09.xhtml#_idTextAnchor226"><span class="No-Break"><em class="italic">Chapter 9</em></span></a>, thus completing our overview of the <span class="No-Break">animation system.</span></p>
<h1 id="_idParaDest-215"><a id="_idTextAnchor225"/>Questions</h1>
<ol>
<li>What do we mean by <span class="No-Break">non-destructive modifiers?</span></li>
<li>Do modifiers change the keyframe points of <span class="No-Break">a curve?</span></li>
<li>Can we add animation modifiers to <span class="No-Break">non-animated objects?</span></li>
<li>How do we make sure that a property <span class="No-Break">is animated?</span></li>
<li>What is a parameter <span class="No-Break">soft limit?</span></li>
<li>In which cases do we use soft rather than <span class="No-Break">strong limits?</span></li>
<li>How can we look for a class name <span class="No-Break">in Python?</span></li>
</ol>
</div>
</div></body></html>